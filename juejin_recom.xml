<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[开源7天Github斩获4.5万Stars！阿里2026版高并发设计实录鲨疯了]]></title>    <link>https://juejin.cn/post/7579892222609719331</link>    <guid>https://juejin.cn/post/7579892222609719331</guid>    <pubDate>2025-12-05T06:17:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579892222609719331" data-draft-id="7579892134817579043" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="开源7天Github斩获4.5万Stars！阿里2026版高并发设计实录鲨疯了"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-05T06:17:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java水解"/> <meta itemprop="url" content="https://juejin.cn/user/2441349519143037"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            开源7天Github斩获4.5万Stars！阿里2026版高并发设计实录鲨疯了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2441349519143037/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java水解
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T06:17:29.000Z" title="Fri Dec 05 2025 06:17:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">如何获得高并发经验？</h2>
<p>这是我今天逛知乎的时候系统邀请我回答的一个问题，由此也引发了我的一些思考：为什么人人都想要获得高并发经验；想拥有高并发系统设计技能？</p>
<p><strong>其原因LZ认为主要有以下三点：</strong></p>
<ol>
<li><strong>涨薪</strong>：有高并发系统设计的技能后可以获得更加可观的收入。</li>
<li><strong>晋升</strong>：高并发系统设计是一个初中级开发晋升成为一个高开乃至系统架构师必不可少的技能之一。</li>
<li><strong>面试</strong>：基本一些高级开发岗以及大厂招聘，面试的时候都会对高并发系统设计进行深入考察，甚至可以说这是100%会被面试官提问的点，只有拥有相关技能才能顺利的通过面试，获取到心仪的Offer。</li>
</ol>
<p><strong>搞清楚为什么之后接下来我们回到正题来说说普通的程序员该如何获得高并发经验：</strong></p>
<p>对于身处互联网公司，后续还能参与到公司一些分布式微服务项目搭建的小伙伴来说，想要获取高并发经验，只需要跟在公司的大佬后面好好学习就行。难搞的恰恰是<strong>这类人</strong>：<strong>一直处于传统行业，接触的技术栈都太过陈旧，简历上也没什么亮眼的项目（LZ很多粉丝就是这类人群）。</strong>  从现在面试个Java初级基本都会被问到分布式高并发，多线程之类的问题来看，不提前储备直接出去面试肯定过不了，更别说后续面高级开发岗以及冲大厂了。所以为了更好的帮助一直以来支持我的粉丝朋友学习提升/应对之后的面试,LZ今天就为大家带来了一套来自阿里&amp;京东出品的2023最新高并发系统设计实录，大家且往下看：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49140a5cf1da485a94a0f6675ab0723c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765521363&amp;x-signature=ADC9S38vKMUZ4gbjFP4FqbavPF4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">2023大厂最新高并发系统设计实录</h2>
<blockquote>
<p>对于我们互联网人来说，站在巨人的肩膀上学习才是最高效的一种学习方式，本篇为大家带来的三份架构设计实录合计近千页，篇幅限制就不全部细细地将每一个章节展示出来了，伙伴只需要点赞+转发，~下面我们来看第一份，来自阿里的高并发小册：</p>
</blockquote>
<blockquote>
<blockquote>
<p><strong>需要全套笔记及答案【扫一扫】</strong>                       即可免费获取**</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/410f6476f9cd41a0ae1d3c2c0f0f90bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765521363&amp;x-signature=boYvUt5I6B6GBQqM0CbxWE5PDl8%3D" alt="8fbf1ef8b61e2dbbb33b7690a41d12e.png" loading="lazy"/></p>
</blockquote>
<ul>
<li><strong>百亿级并发系统设计</strong></li>
</ul>

<ul>
<li>基础篇</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff3f21cf94ee48ed968919a73bd02984~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765521363&amp;x-signature=E4XHQ2r2qQaDwd%2FtvJTTCd6z8uc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f5deecf635e45818c7cc0cb724f2e62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765521363&amp;x-signature=gK85wj3jOsYJkUXc9Ay0Dda7wOI%3D" alt="" loading="lazy"/></p>
<p>高并发的性能优化</p>
<ul>
<li>数据库篇</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6264cde6a6624c32b9529df7cbe115cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765521363&amp;x-signature=KMSy1S7tToQzAYGL6lidtQXjvfs%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bdec68e629e4b2eab06fd01ef174e21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765521363&amp;x-signature=JjAWR56g5hOCwWvrLFNuhq5lSqw%3D" alt="" loading="lazy"/></p>
<p>数据库垂直拆分</p>
<ul>
<li>缓存篇</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f2d0f2e9c974ec5bfec0727d5227a04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765521363&amp;x-signature=x5p6qEWGxEEaL7Xx0K6hwuiXZq8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd103a7ebd1e4f24b14150c1b556f8ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765521363&amp;x-signature=FVWlyBw3BnYhNg656lqgyK4m7Xg%3D" alt="" loading="lazy"/></p>
<p>缓存读写策略</p>
<ul>
<li>消息队列篇</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/697ca87b470343058a43fbadd6a24d29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765521363&amp;x-signature=0i1vsUgKgaYNE4NAWb7g8wbdDq0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96b398cd90a046fdb60fe3cba864a1f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765521363&amp;x-signature=XxlGOf6IHpPsfRYbWO2oh4JJf2w%3D" alt="" loading="lazy"/></p>
<p>减少消息言延迟的正确姿势</p>
<ul>
<li>分布式服务篇</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8b1f808058d4e7fa915ba290fa94e5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765521363&amp;x-signature=jmDVajb8FyXuggVS%2FogxUqJ7%2Fo8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38615da6a8e94fccb0e79c63a7777ef9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765521363&amp;x-signature=V%2FHhqEyKl9S6pt9FKKCXfjZXags%3D" alt="" loading="lazy"/></p>
<p>服务化部署</p>
<ul>
<li>维护篇</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f5f35fa9ff941fca33c66be2226ba98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765521363&amp;x-signature=bJtVmvzEgoX3hW9L5E%2BGswuBOwc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97b7b648eaa54cd7a3e3b022bc40ae7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765521363&amp;x-signature=P3WnNmqCq45K1i1OMpvrMGp1U%2BA%3D" alt="" loading="lazy"/></p>
<p>限流算法</p>
<ul>
<li>实战篇</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77626dc0658e4db98a68dea61fbd5025~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765521363&amp;x-signature=Fuj6zCrIf4ifc7%2BKt6KRkxpanYw%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5130f4217c9e4301bc6eeb615729e25a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765521363&amp;x-signature=xL%2FfIFI8Uw89OroZicNWboPTfSI%3D" alt="" loading="lazy"/></p>
<p>推拉结合方案</p>
<ul>
<li><strong>京东亿级流量网站架构核心技术</strong></li>
</ul>
<blockquote>
<p>第二份京东架构核心技术分为4部分分别是系统设计概述，高可用，高并发，以及系统设计实战案例，共21个章节：</p>
</blockquote>
<ul>
<li>目录总览</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/292251b1e14641269f703281c8fc1968~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765521363&amp;x-signature=q5%2BR9XQPhVJQ%2Flcjfy9Zibj%2FFzo%3D" alt="" loading="lazy"/></p>
<blockquote>
<blockquote>
<p><strong>需要全套笔记及答案【扫一扫】</strong>                       即可免费获取**</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/410f6476f9cd41a0ae1d3c2c0f0f90bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765521363&amp;x-signature=boYvUt5I6B6GBQqM0CbxWE5PDl8%3D" alt="8fbf1ef8b61e2dbbb33b7690a41d12e.png" loading="lazy"/></p>
</blockquote>
<ul>
<li>内容节选</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/589a2d1750e845f29bf47ff4d14654a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765521363&amp;x-signature=PJ3D2JuRd3sa1B99KPu%2F5TWyaxc%3D" alt="" loading="lazy"/></p>
<p>应用级限流</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/206359f73f38484ab200ee441c9921a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765521363&amp;x-signature=S%2BdLy1P2e0nPRB%2BW9M7QPyXe2xw%3D" alt="" loading="lazy"/></p>
<p>应用级缓存</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98e5ca951b2c4fcb8d91b606be6c3b65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765521363&amp;x-signature=rILoTDHR65TmK4JO8T%2FHnWD1MZs%3D" alt="" loading="lazy"/></p>
<p>商品详情页架构设计原则</p>
<ul>
<li><strong>淘宝微服务架构实战</strong></li>
</ul>
<blockquote>
<p>此文档一共有8个章节，主要记录淘宝双十一抢购项目搭建流程以及具体实现细节</p>
</blockquote>
<ul>
<li>目录总览</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d47daae7abd40ea9f83b4f705319b50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765521363&amp;x-signature=wWkmXB%2BcYf6I5%2BI6nwUa86PlrLY%3D" alt="" loading="lazy"/></p>
<ul>
<li>内容节选</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7284c4d9ac3a42d7aa7dc7ed515aa027~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765521363&amp;x-signature=qyOWN2etHyhoV6hb2V7SwmXI27U%3D" alt="" loading="lazy"/></p>
<p>Dubbo运行原理</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbc8d887d7df43238f27bf91e7c6b667~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765521363&amp;x-signature=5tbPPqWGabM0ys%2BRyWO75%2Bgq90k%3D" alt="" loading="lazy"/></p>
<p>缓存抢购请求</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d3876cf0e69483b95889fb7a388dc1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2YeawtOinow==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765521363&amp;x-signature=n6v7TatwIyBwDa4EtOehTBoEx8s%3D" alt="" loading="lazy"/></p>
<p>分布式下的支付功能</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浏览器缓存完全指南：从原理到实践]]></title>    <link>https://juejin.cn/post/7579886397075341312</link>    <guid>https://juejin.cn/post/7579886397075341312</guid>    <pubDate>2025-12-05T06:08:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579886397075341312" data-draft-id="7579892134817546275" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浏览器缓存完全指南：从原理到实践"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-05T06:08:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="建南教你种道德之花"/> <meta itemprop="url" content="https://juejin.cn/user/1028798615656301"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浏览器缓存完全指南：从原理到实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1028798615656301/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    建南教你种道德之花
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T06:08:27.000Z" title="Fri Dec 05 2025 06:08:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在Web性能优化领域，浏览器缓存是提升用户体验、减少服务器压力、降低带宽成本的关键技术。理解浏览器缓存机制不仅是前端工程师的基本功，更是构建高性能Web应用的必备知识。本文将系统性地探讨浏览器缓存的各个方面，包括缓存策略、缓存位置、工作原理以及实际应用。</p>
<h2 data-id="heading-1">一、缓存基础概念</h2>
<p>1.1 什么是浏览器缓存？</p>
<p>浏览器缓存是浏览器存储Web资源副本（如HTML、CSS、JavaScript、图片等）的机制，以便后续请求可以直接从本地获取，而无需再次从服务器下载。</p>
<p>我们可以使用浏览器的F12来看下我们平时使用的网站是如何获取资源的，从下图就可以看出其实很多资源是直接使用缓存的，而不是从服务器上下载</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/366b577467534752882d53587a48cc16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bu65Y2X5pWZ5L2g56eN6YGT5b635LmL6Iqx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765519707&amp;x-signature=oVTij%2F9hNBboC88fNo7zayjAzXk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">1.2 缓存的价值</h3>
<ul>
<li>性能提升：本地读取速度远快于网络请求</li>
<li>带宽节省：减少重复数据传输</li>
<li>服务器减压：降低服务器负载</li>
<li>离线体验：支持部分离线功能</li>
</ul>
<h2 data-id="heading-3">二、缓存策略：强制缓存 vs 协商缓存</h2>
<h3 data-id="heading-4">2.1 强制缓存</h3>
<p>强制缓存的核心思想是：在一定时间内，直接使用本地缓存，不向服务器发送请求。</p>
<h4 data-id="heading-5">2.1.1 控制字段</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># HTTP/1.0</span>
<span class="hljs-attr">Expires:</span> <span class="hljs-string">Wed,</span> <span class="hljs-number">21</span> <span class="hljs-string">Oct</span> <span class="hljs-number">2020 07:28:00 </span><span class="hljs-string">GMT</span>

<span class="hljs-comment"># HTTP/1.1+（优先级更高）</span>
<span class="hljs-attr">Cache-Control:</span> <span class="hljs-string">max-age=3600,</span> <span class="hljs-string">public</span>
</code></pre>
<h4 data-id="heading-6">2.1.2 Cache-Control常用指令</h4>













































<table><thead><tr><th>指令</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td>max-age</td><td>缓存有效期（秒）</td><td><code>max-age=3600</code></td></tr><tr><td>public</td><td>允许任何缓存存储</td><td><code>public</code></td></tr><tr><td>private</td><td>仅允许客户端缓存</td><td><code>private</code></td></tr><tr><td>no-cache</td><td>强制协商缓存</td><td><code>no-cache</code></td></tr><tr><td>no-store</td><td>禁止任何缓存</td><td><code>no-store</code></td></tr><tr><td>immutable</td><td>资源永不变</td><td><code>immutable</code></td></tr><tr><td>must-revalidate</td><td>过期必须验证</td><td><code>must-revalidate</code></td></tr></tbody></table>
<h4 data-id="heading-7">2.1.3 状态码与行为</h4>
<pre><code class="hljs language-markdown" lang="markdown"> // 强缓存命中流程1. 浏览器检查缓存
<span class="hljs-bullet">2.</span> 发现有效缓存 → 直接使用
<span class="hljs-bullet">3.</span> 状态码：200 (from memory/disk cache)
<span class="hljs-bullet">4.</span> Network面板显示：Time: 0ms, Size: (cache)
</code></pre>
<p>关键点：强缓存命中时，浏览器根本不会发送网络请求。</p>
<h3 data-id="heading-8">2.2 协商缓存</h3>
<p>协商缓存的核心思想是：每次都需要向服务器验证缓存是否有效。</p>
<h5 data-id="heading-9">2.2.1 控制机制</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 基于时间验证</span>
<span class="hljs-attr">Last-Modified:</span> <span class="hljs-string">Wed,</span> <span class="hljs-number">21</span> <span class="hljs-string">Oct</span> <span class="hljs-number">2020 07:28:00 </span><span class="hljs-string">GMT</span>
<span class="hljs-attr">If-Modified-Since:</span> <span class="hljs-string">Wed,</span> <span class="hljs-number">21</span> <span class="hljs-string">Oct</span> <span class="hljs-number">2020 07:28:00 </span><span class="hljs-string">GMT</span>

<span class="hljs-comment"># 基于内容标识验证（优先级更高）</span>
<span class="hljs-attr">ETag:</span> <span class="hljs-string">"abc123"</span>
<span class="hljs-attr">If-None-Match:</span> <span class="hljs-string">"abc123"</span>
</code></pre>
<h5 data-id="heading-10">2.2.2 状态码与行为</h5>
<pre><code class="hljs language-markdown" lang="markdown">// 协商缓存流程
<span class="hljs-bullet">1.</span> 浏览器发送验证请求（携带If-None-Match/If-Modified-Since）
<span class="hljs-bullet">2.</span> 服务器验证：
<span class="hljs-bullet">   -</span> 资源未变 → 返回304 Not Modified（空响应体）
<span class="hljs-bullet">   -</span> 资源已变 → 返回200 + 新资源
<span class="hljs-bullet">3.</span> 浏览器：304则用缓存，200则用新资源
</code></pre>
<p>关键点：协商缓存总会发送请求，只是响应体可能为空。</p>
<h3 data-id="heading-11">2.3 强制缓存 vs 协商缓存对比</h3>








































<table><thead><tr><th>方面</th><th>强制缓存</th><th>协商缓存</th></tr></thead><tbody><tr><td>网络请求</td><td>无</td><td>有</td></tr><tr><td>状态码</td><td>200 (from cache)</td><td>304 或 200</td></tr><tr><td>响应体</td><td>有（从缓存读取）</td><td>304时为空</td></tr><tr><td>速度</td><td>最快（0网络延迟）</td><td>有网络往返延迟</td></tr><tr><td>更新</td><td>过期才更新</td><td>每次验证</td></tr><tr><td>适用场景</td><td>静态不变资源</td><td>可能变化资源</td></tr></tbody></table>
<h2 data-id="heading-12">三、缓存位置：数据存储在哪里</h2>
<h3 data-id="heading-13">3.1 缓存位置体系对比</h3>
<p>浏览器采用多层缓存结构，不同位置有不同的特性和用途：</p>






















































<table><thead><tr><th>缓存位置</th><th>Memory Cache</th><th>Disk Cache</th><th>Service Worker Cache</th><th>Push Cache</th></tr></thead><tbody><tr><td>特点</td><td>速度快，容量小，临时性，读取无需I/O</td><td>速度中，容量大，持久化，需要磁盘I/O</td><td>完全可控，支持离线，灵活性强</td><td>服务器主动推送，优先级高，临时存储</td></tr><tr><td>生命周期</td><td>页面/会话级别（关闭标签页或浏览器可能丢失）</td><td>长期持久化（直到手动清理或缓存过期）</td><td>由开发者控制，可设置过期时间或手动清理</td><td>HTTP/2会话期间（会话结束即失效）</td></tr><tr><td>典型大小/限制</td><td>&lt; 100KB的小资源，总容量有限（几十MB）</td><td>&gt; 100KB的大资源，容量大（几百MB到GB）</td><td>受同源存储限制（通常为站点存储配额）</td><td>容量很小，不能跨会话复用</td></tr><tr><td>控制方式</td><td>浏览器自动管理，开发者无法直接控制</td><td>由HTTP缓存头（Cache-Control、Expires等）控制</td><td>通过JavaScript API（Cache Storage）完全控制</td><td>由服务器控制推送，浏览器被动接收</td></tr><tr><td>主要使用场景</td><td>当前页面频繁使用的小资源（CSS、JS、小图标）、Base64图片</td><td>大图片、字体文件、不常变化的静态资源、视频音频文件</td><td>PWA应用、离线功能、精细缓存策略、网络降级处理</td><td>关键资源预推送（如首屏CSS/JS），HTTP/2服务器推送场景</td></tr><tr><td>Network面板显示</td><td>(memory cache)</td><td>(disk cache)</td><td>显示正常请求，响应来自Service Worker</td><td>通常不单独显示，可能合并到其他缓存显示中</td></tr></tbody></table>
<h3 data-id="heading-14">3.2 典型资源存储建议</h3>



































<table><thead><tr><th>资源类型</th><th>推荐缓存位置</th><th>理由</th></tr></thead><tbody><tr><td>小图标/雪碧图</td><td>Memory Cache</td><td>使用频繁，读取速度快</td></tr><tr><td>大尺寸背景图</td><td>Disk Cache</td><td>体积大，适合持久化存储</td></tr><tr><td>关键首屏CSS/JS</td><td>Service Worker + Memory</td><td>确保快速加载和离线可用</td></tr><tr><td>用户头像</td><td>Disk Cache + 协商缓存</td><td>可能更新，需要验证</td></tr><tr><td>视频/音频文件</td><td>Disk Cache</td><td>文件体积大，适合磁盘存储</td></tr></tbody></table>
<h3 data-id="heading-15">3.3 实际开发注意事项</h3>
<ol>
<li>Memory Cache不稳定：内存紧张时会被优先清理，不能依赖其持久性</li>
<li>Disk Cache依赖HTTP头：没有正确缓存头的资源不会被持久化缓存</li>
<li>Service Worker需要HTTPS：生产环境必须使用HTTPS协议</li>
<li>Push Cache局限性：只对当前会话有效，刷新页面后失效</li>
</ol>
<h2 data-id="heading-16">四、缓存生命周期管理</h2>
<h3 data-id="heading-17">4.1 缓存策略</h3>
<pre><code class="hljs language-scss" lang="scss">浏览器请求资源
    ↓
检查Service Worker → 有缓存 → 返回
    ↓
检查Memory Cache → 有且有效 → 返回 (memory cache)
    ↓
检查Disk Cache
    ├── 有且强缓存有效 → 返回 (disk cache)
    ├── 有但需要验证 → 协商请求 → <span class="hljs-number">304</span>/<span class="hljs-number">200</span>
    └── 无 → 网络请求
</code></pre>
<h3 data-id="heading-18">4.2 缓存更新策略</h3>
<h4 data-id="heading-19">4.2.1 版本化文件名</h4>
<pre><code class="hljs language-xml" lang="xml"> <span class="hljs-comment">&lt;!-- 最佳实践：文件名包含哈希值 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/app.abc123.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/style.def456.css"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span>&gt;</span>
<span class="hljs-comment">&lt;!-- 服务器配置：长期缓存 --&gt;</span>
Cache-Control: max-age=31536000, immutable
</code></pre>
<h4 data-id="heading-20">4.2.2 缓存破坏模式（前端如何控制不适用缓存）</h4>
<pre><code class="hljs language-ini" lang="ini">// 1. 查询参数（不推荐）
&lt;img <span class="hljs-attr">src</span>=<span class="hljs-string">"image.jpg?v=2"</span>&gt;

// 2. 文件名哈希（推荐）
&lt;img <span class="hljs-attr">src</span>=<span class="hljs-string">"image.abc123.jpg"</span>&gt;

// 3. 路径版本
&lt;img <span class="hljs-attr">src</span>=<span class="hljs-string">"/v2/images/logo.png"</span>&gt;
</code></pre>
<h3 data-id="heading-21">4.3 混合缓存策略</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 常见组合策略</span>
Cache-Control: <span class="hljs-attr">max-age</span>=<span class="hljs-number">604800</span>, must-revalidate, public

<span class="hljs-comment"># 含义：</span>
<span class="hljs-comment"># 1. 7天内直接使用缓存（强缓存）</span>
<span class="hljs-comment"># 2. 7天后必须验证（协商缓存）</span>
<span class="hljs-comment"># 3. 允许所有缓存存储</span>
</code></pre>
<h2 data-id="heading-22">五、实际使用场景</h2>
<h3 data-id="heading-23">5.1 图片预加载与缓存</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ImagePreloader</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">pending</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    }
    
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">preload</span>(<span class="hljs-params">url</span>) {
        <span class="hljs-comment">// 避免重复预加载</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pending</span>.<span class="hljs-title function_">has</span>(url)) {
            <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">pending</span>.<span class="hljs-title function_">get</span>(url);
        }
        
        <span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
            <span class="hljs-keyword">const</span> img = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Image</span>();
            
            img.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`预加载完成: <span class="hljs-subst">${url}</span>`</span>);
                <span class="hljs-title function_">resolve</span>(img);
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">pending</span>.<span class="hljs-title function_">delete</span>(url);
            };
            
            img.<span class="hljs-property">onerror</span> = reject;
            img.<span class="hljs-property">src</span> = url;
        });
        
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">pending</span>.<span class="hljs-title function_">set</span>(url, promise);
        <span class="hljs-keyword">return</span> promise;
    }
    
    <span class="hljs-comment">// 批量预加载</span>
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">preloadAll</span>(<span class="hljs-params">urls</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(
            urls.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">url</span> =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">preload</span>(url))
        );
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> preloader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImagePreloader</span>();
preloader.<span class="hljs-title function_">preloadAll</span>([
    <span class="hljs-string">'/hero-image.jpg'</span>,
    <span class="hljs-string">'/user-avatar.png'</span>,
    <span class="hljs-string">'/product-gallery-1.jpg'</span>
]).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'所有图片预加载完成'</span>);
});
</code></pre>
<h3 data-id="heading-24">5.2 Service Worker缓存策略</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// service-worker.js</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CACHE_NAME</span> = <span class="hljs-string">'v1'</span>;
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CACHE_POLICIES</span> = {
    <span class="hljs-attr">critical</span>: {
        <span class="hljs-attr">cacheName</span>: <span class="hljs-string">'critical'</span>,
        <span class="hljs-attr">strategy</span>: <span class="hljs-string">'CacheFirst'</span>,
        <span class="hljs-attr">patterns</span>: [<span class="hljs-regexp">/.css$/</span>, <span class="hljs-regexp">/.js$/</span>]
    },
    <span class="hljs-attr">images</span>: {
        <span class="hljs-attr">cacheName</span>: <span class="hljs-string">'images'</span>,
        <span class="hljs-attr">strategy</span>: <span class="hljs-string">'StaleWhileRevalidate'</span>,
        <span class="hljs-attr">patterns</span>: [<span class="hljs-regexp">/.(jpg|png|webp)$/</span>]
    },
    <span class="hljs-attr">api</span>: {
        <span class="hljs-attr">cacheName</span>: <span class="hljs-string">'api'</span>,
        <span class="hljs-attr">strategy</span>: <span class="hljs-string">'NetworkFirst'</span>,
        <span class="hljs-attr">patterns</span>: [<span class="hljs-comment">//api//]</span>
    }
};

<span class="hljs-comment">// 安装阶段：预缓存关键资源</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'install'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
    event.<span class="hljs-title function_">waitUntil</span>(
        caches.<span class="hljs-title function_">open</span>(<span class="hljs-variable constant_">CACHE_POLICIES</span>.<span class="hljs-property">critical</span>.<span class="hljs-property">cacheName</span>)
            .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> cache.<span class="hljs-title function_">addAll</span>([
                <span class="hljs-string">'/'</span>,
                <span class="hljs-string">'/index.html'</span>,
                <span class="hljs-string">'/main.css'</span>,
                <span class="hljs-string">'/app.js'</span>
            ]))
    );
});

<span class="hljs-comment">// 请求拦截</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'fetch'</span>, <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> url = event.<span class="hljs-property">request</span>.<span class="hljs-property">url</span>;
    
    <span class="hljs-comment">// 图片：StaleWhileRevalidate</span>
    <span class="hljs-keyword">if</span> (url.<span class="hljs-title function_">match</span>(<span class="hljs-variable constant_">CACHE_POLICIES</span>.<span class="hljs-property">images</span>.<span class="hljs-property">patterns</span>[<span class="hljs-number">0</span>])) {
        event.<span class="hljs-title function_">respondWith</span>(<span class="hljs-title function_">staleWhileRevalidate</span>(event));
    }
    <span class="hljs-comment">// API：NetworkFirst</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (url.<span class="hljs-title function_">match</span>(<span class="hljs-variable constant_">CACHE_POLICIES</span>.<span class="hljs-property">api</span>.<span class="hljs-property">patterns</span>[<span class="hljs-number">0</span>])) {
        event.<span class="hljs-title function_">respondWith</span>(<span class="hljs-title function_">networkFirst</span>(event));
    }
    <span class="hljs-comment">// 其他：CacheFirst</span>
    <span class="hljs-keyword">else</span> {
        event.<span class="hljs-title function_">respondWith</span>(<span class="hljs-title function_">cacheFirst</span>(event));
    }
});

<span class="hljs-comment">// 策略实现：StaleWhileRevalidate</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">staleWhileRevalidate</span>(<span class="hljs-params">event</span>) {
    <span class="hljs-keyword">const</span> cache = <span class="hljs-keyword">await</span> caches.<span class="hljs-title function_">open</span>(<span class="hljs-variable constant_">CACHE_POLICIES</span>.<span class="hljs-property">images</span>.<span class="hljs-property">cacheName</span>);
    <span class="hljs-keyword">const</span> cached = <span class="hljs-keyword">await</span> cache.<span class="hljs-title function_">match</span>(event.<span class="hljs-property">request</span>);
    
    <span class="hljs-comment">// 立即返回缓存（可能过时）</span>
    <span class="hljs-keyword">const</span> fetchPromise = <span class="hljs-title function_">fetch</span>(event.<span class="hljs-property">request</span>)
        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
            <span class="hljs-comment">// 更新缓存</span>
            cache.<span class="hljs-title function_">put</span>(event.<span class="hljs-property">request</span>, response.<span class="hljs-title function_">clone</span>());
            <span class="hljs-keyword">return</span> response;
        });
    
    <span class="hljs-keyword">return</span> cached || fetchPromise;
}
</code></pre>
<h2 data-id="heading-25">六 、常见问题与解决方案</h2>
<h3 data-id="heading-26">6.1 常见资源缓存配置</h3>








































<table><thead><tr><th>资源类型</th><th>缓存策略</th><th>示例配置</th></tr></thead><tbody><tr><td>版本化静态资源</td><td>强缓存+永久</td><td><code>max-age=31536000, immutable</code></td></tr><tr><td>非版本化静态资源</td><td>协商缓存</td><td><code>no-cache</code> 或短<code>max-age</code></td></tr><tr><td>HTML文档</td><td>不缓存/短缓存</td><td><code>no-cache, max-age=0</code></td></tr><tr><td>API响应</td><td>按需缓存</td><td><code>private, max-age=60</code></td></tr><tr><td>用户内容</td><td>协商缓存</td><td><code>no-cache</code></td></tr><tr><td>第三方资源</td><td>尊重源站</td><td>通常不修改</td></tr></tbody></table>
<h3 data-id="heading-27">6.2 缓存导致更新不及时</h3>
<p>问题：用户看到的是旧版本资源</p>
<p>解决方案：</p>
<ol>
<li>文件名哈希：<code>app.abc123.js</code></li>
<li>查询参数：<code>?v=版本号</code>（不推荐）</li>
<li>正确设置缓存头：</li>
</ol>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># Nginx配置</span>
location ~* .(css|js)$ {
    <span class="hljs-comment"># 版本化资源：永久缓存</span>
    if ($request_uri ~* .<span class="hljs-section">[a-f0-9]</span>{8}.(css|js)$) {
        expires max<span class="hljs-comment">;</span>
        add_header Cache-Control "public, immutable"<span class="hljs-comment">;</span>
    }
    <span class="hljs-comment"># 非版本化：不缓存或短缓存</span>
    expires 0<span class="hljs-comment">;</span>
    add_header Cache-Control "no-cache, must-revalidate"<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-28">6.3 预加载竞争条件</h3>
<p>问题：预加载未完成时显示图片，导致重复请求</p>
<p>解决方案：</p>
<pre><code class="hljs language-ini" lang="ini">// 使用Promise保证预加载完成
const <span class="hljs-attr">imageCache</span> = new Map()<span class="hljs-comment">;</span>

async function getImage(url) {
    if (imageCache.has(url)) {
        return imageCache.get(url)<span class="hljs-comment">;</span>
    }
    
    const <span class="hljs-attr">promise</span> = fetch(url)
        .then(<span class="hljs-attr">response</span> =&gt; response.blob())
        .then(<span class="hljs-attr">blob</span> =&gt; URL.createObjectURL(blob))<span class="hljs-comment">;</span>
    
    imageCache.set(url, promise)<span class="hljs-comment">;</span>
    return promise<span class="hljs-comment">;</span>
}

// 使用
getImage('photo.jpg').then(<span class="hljs-attr">objectURL</span> =&gt; {
    <span class="hljs-attr">imgElement.src</span> = objectURL<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-29">深层探究该问题</h4>
<p>这是一个典型的“竞态条件”场景，在实际场景中预加载大多数情况下会生效，并不需要我们通过代码来控制该行为，但是确实存在一个短暂的“竞争窗口期”。在最坏的情况下，可能会出现两个并行的请求。</p>
<h4 data-id="heading-30">核心机制：浏览器缓存与请求去重</h4>
<p>现代浏览器有非常智能的缓存和网络请求管理机制：</p>
<ol>
<li>对相同URL的请求排队与合并： 当浏览器发现对完全相同的图片URL同时有多个未完成的请求时，它不会立即发出多个网络请求。第一个请求会被正常发出，后续的请求会被“挂起”或“加入队列”，等待第一个请求的响应。</li>
<li>缓存即时生效： 一旦第一个请求（无论是预加载的还是正式显示的）的响应开始返回，数据会被流式地填充到缓存中。如果此时第二个请求正在等待，它会立即开始从已到达的缓存数据中读取，而不会重新发起网络请求。</li>
</ol>
<h3 data-id="heading-31">6.4 缓存大小限制</h3>
<p>问题：缓存超过限制被清除</p>
<p>解决方案：</p>
<ol>
<li>关键资源优先缓存</li>
<li>使用Service Worker管理缓存</li>
<li>监控缓存使用情况：</li>
</ol>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 检查缓存配额</span>
<span class="hljs-keyword">if</span> (<span class="hljs-string">'storage'</span> <span class="hljs-keyword">in</span> navigator &amp;&amp; <span class="hljs-string">'estimate'</span> <span class="hljs-keyword">in</span> navigator.<span class="hljs-property">storage</span>) {
    navigator.<span class="hljs-property">storage</span>.<span class="hljs-title function_">estimate</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">{ usage, quota }</span>) =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`已使用: <span class="hljs-subst">${usage}</span> / <span class="hljs-subst">${quota}</span> (<span class="hljs-subst">${(usage / quota * <span class="hljs-number">100</span>).toFixed(<span class="hljs-number">1</span>)}</span>%)`</span>);
    });
}
</code></pre>
<h2 data-id="heading-32">结语</h2>
<p>浏览器缓存是一个多层次、多维度的复杂系统。理解缓存机制需要从HTTP协议、浏览器实现、网络传输等多个角度综合考虑。正确的缓存策略可以极大提升Web应用性能，而错误的配置则可能导致各种问题。</p>
<p>记住几个核心原则：</p>
<ol>
<li>缓存是性能优化的第一要务</li>
<li>不同的资源需要不同的缓存策略</li>
<li>版本控制是长期缓存的关键</li>
<li>监控和测试是缓存优化的基础</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[swiftui中view分为几种类型？各有什么特点]]></title>    <link>https://juejin.cn/post/7579846221168672822</link>    <guid>https://juejin.cn/post/7579846221168672822</guid>    <pubDate>2025-12-05T05:53:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579846221168672822" data-draft-id="7579932196463493174" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="swiftui中view分为几种类型？各有什么特点"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-05T05:53:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="1024小神"/> <meta itemprop="url" content="https://juejin.cn/user/70007368988926"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            swiftui中view分为几种类型？各有什么特点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/70007368988926/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    1024小神
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T05:53:54.000Z" title="Fri Dec 05 2025 05:53:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我的开源项目PakePlus可以将网页/Vue/React项目打包为桌面/手机应用并且小于5M只需几分钟，官网地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpakeplus.com" target="_blank" title="https://pakeplus.com" ref="nofollow noopener noreferrer">pakeplus.com</a></p><p><img alt="" src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8df94b147fee459aaf5e54d29d4e2542~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp" width="2176" loading="lazy"/></p><p/>
<p>在 SwiftUI 中，View 是构建界面的核心抽象，其分类方式可从<strong>功能特性、渲染逻辑、组合方式</strong>等维度划分，核心可归纳为以下几类（并非官方强定义分类，而是基于实际开发场景的通用归纳），每类都有明确的设计目标和使用场景：</p>
<h3 data-id="heading-0">一、基础容器型 View（布局与组合核心）</h3>
<p>这类 View 本身不承载可视化内容，核心作用是<strong>组织、布局子 View</strong>，是构建界面结构的基础。</p>
<h4 data-id="heading-1">核心特点：</h4>
<ul>
	<li>无自有视觉样式，仅提供布局规则；</li>
	<li>支持嵌套组合，可多层嵌套构建复杂结构；</li>
	<li>遵循 SwiftUI 布局系统（父 View 提议尺寸 → 子 View 响应 → 父 View 最终布局）。</li>
</ul>
<h4 data-id="heading-2">典型代表：</h4>
<table>
	<thead>
		<tr>
			<th>View 名称</th>
			<th>核心特点</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td><code>VStack</code></td>
			<td>垂直方向排列子 View，可设置间距、对齐方式（leading/trailing/center 等）</td>
		</tr>
		<tr>
			<td><code>HStack</code></td>
			<td>水平方向排列子 View，支持分布方式（如 <code>spacing</code>、<code>alignment</code>）</td>
		</tr>
		<tr>
			<td><code>ZStack</code></td>
			<td>层叠排列子 View（Z 轴），可设置对齐方式，用于叠加视图（如文字盖在图片上）</td>
		</tr>
		<tr>
			<td><code>List</code>/<code>LazyVStack</code>/<code>LazyHStack</code></td>
			<td>懒加载容器，仅渲染可视区域内的子 View，优化大量数据列表性能（List 是更高层封装，含滚动、分割线等）</td>
		</tr>
		<tr>
			<td><code>Grid</code>/<code>LazyVGrid</code>/<code>LazyHGrid</code></td>
			<td>网格布局，通过 <code>GridItem</code> 定义列 / 行规则，支持自适应、固定尺寸、比例尺寸</td>
		</tr>
		<tr>
			<td><code>Group</code></td>
			<td>仅用于组合多个 View（无布局逻辑），突破 <code>body</code> 单 View 限制，不影响布局</td>
		</tr>
		<tr>
			<td><code>ScrollView</code></td>
			<td>可滚动容器，包裹超出屏幕的 View，支持垂直 / 水平滚动、是否显示滚动指示器</td>
		</tr>
	</tbody>
</table>
<h3 data-id="heading-3">二、基础展示型 View（静态内容呈现）</h3>
<p>这类 View 是界面的 “原子组件”，用于展示<strong>静态文本、图像、形状</strong>等基础内容，自带可视化样式，无交互逻辑（需结合 modifier 扩展）。</p>
<h4 data-id="heading-4">核心特点：</h4>
<ul>
	<li>专注内容呈现，样式可通过 modifier 定制（颜色、大小、圆角等）；</li>
	<li>大部分为 “无状态”，仅依赖传入的数据源渲染；</li>
	<li>轻量、高性能，无额外性能开销。</li>
</ul>
<h4 data-id="heading-5">典型代表：</h4>
<table>
	<thead>
		<tr>
			<th>View 名称</th>
			<th>核心特点</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td><code>Text</code></td>
			<td>文本展示，支持富文本（字体、颜色、行间距、截断方式）、本地化、动态字体</td>
		</tr>
		<tr>
			<td><code>Image</code></td>
			<td>图片展示，支持本地资源、网络图片（需结合 <code>AsyncImage</code>）、系统 SF Symbols，可缩放、裁剪、设置渲染模式</td>
		</tr>
		<tr>
			<td><code>Shape</code>（协议）</td>
			<td>形状绘制基类，如 <code>Rectangle</code>/<code>Circle</code>/<code>Capsule</code>/<code>Path</code>，可填充、描边、设置阴影</td>
		</tr>
		<tr>
			<td><code>Divider</code></td>
			<td>分隔线，默认水平 / 垂直，可定制颜色、厚度，用于分隔列表 / 布局元素</td>
		</tr>
		<tr>
			<td><code>Spacer</code></td>
			<td>占位空白，自动填充布局剩余空间，用于调整子 View 位置（如推挤元素到两端）</td>
		</tr>
	</tbody>
</table>
<h3 data-id="heading-6">三、交互型 View（用户操作响应）</h3>
<p>这类 View 核心作用是<strong>响应用户操作</strong>（点击、输入、选择等），自带交互逻辑，部分包含内置状态管理。</p>
<h4 data-id="heading-7">核心特点：</h4>
<ul>
	<li>内置交互事件处理（如点击、拖拽、输入）；</li>
	<li>部分持有内部状态（如 <code>Toggle</code> 的开关状态、<code>TextField</code> 的输入文本）；</li>
	<li>可通过绑定（<code>@Binding</code>）与外部状态联动。</li>
</ul>
<h4 data-id="heading-8">典型代表：</h4>
<table>
	<thead>
		<tr>
			<th>View 名称</th>
			<th>核心特点</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td><code>Button</code></td>
			<td>点击响应，支持自定义样式（文字、图标、背景），绑定 <code>action</code> 处理逻辑</td>
		</tr>
		<tr>
			<td><code>TextField</code>/<code>SecureField</code></td>
			<td>文本输入，绑定 <code>@Binding</code> 接收输入内容，支持键盘类型、占位符、输入限制</td>
		</tr>
		<tr>
			<td><code>Toggle</code></td>
			<td>开关控件，绑定布尔值，支持自定义样式（如开关 / 复选框）</td>
		</tr>
		<tr>
			<td><code>Picker</code>/<code>DatePicker</code></td>
			<td>选择器，支持下拉、滚轮、日历等样式，绑定选中值，适配多平台样式</td>
		</tr>
		<tr>
			<td><code>Slider</code>/<code>Stepper</code></td>
			<td>数值调整控件，绑定数值，支持范围限制、步长设置</td>
		</tr>
		<tr>
			<td><code>Menu</code></td>
			<td>下拉菜单，支持多级菜单、自定义触发视图，适配 iOS/macOS 样式</td>
		</tr>
		<tr>
			<td><code>Link</code></td>
			<td>跳转链接，支持打开 URL、应用内跳转，适配系统样式</td>
		</tr>
	</tbody>
</table>
<h3 data-id="heading-9">四、容器修饰型 View（功能增强）</h3>
<p>这类 View 本身是 “包装器”，为子 View 增加<strong>特定功能</strong>（如滚动、弹窗、条件渲染），不改变子 View 的核心样式。</p>
<h4 data-id="heading-10">核心特点：</h4>
<ul>
	<li>仅包裹一个子 View（或一组），提供附加功能；</li>
	<li>功能可通过参数配置，不侵入子 View 逻辑；</li>
	<li>部分支持动态切换（如条件渲染、动画）。</li>
</ul>
<h4 data-id="heading-11">典型代表：</h4>
<table>
	<thead>
		<tr>
			<th>View 名称</th>
			<th>核心特点</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td><code>NavigationStack</code>/<code>NavigationSplitView</code></td>
			<td>导航容器，支持页面跳转、导航栏定制、分栏布局（iPad/macOS）</td>
		</tr>
		<tr>
			<td><code>Sheet</code>/<code>FullScreenCover</code></td>
			<td>弹窗容器，以模态方式展示子 View，支持动画、背景交互控制</td>
		</tr>
		<tr>
			<td><code>Alert</code>/<code>ConfirmationDialog</code></td>
			<td>提示弹窗，支持按钮操作、文本提示，绑定触发条件</td>
		</tr>
		<tr>
			<td><code>ScrollViewReader</code></td>
			<td>滚动控制容器，支持滚动到指定位置、监听滚动位置</td>
		</tr>
		<tr>
			<td><code>ForEach</code></td>
			<td>动态列表渲染，基于数据源生成多个子 View，支持标识（<code>id</code>）管理复用</td>
		</tr>
		<tr>
			<td><code>if/else</code>/<code>switch</code>（条件渲染）</td>
			<td>语法级容器，根据条件渲染不同 View，无额外性能开销</td>
		</tr>
		<tr>
			<td><code>Animation</code>（动画容器）</td>
			<td>为子 View 变化添加动画，支持时长、曲线、延迟配置</td>
		</tr>
	</tbody>
</table>
<h3 data-id="heading-12">五、平台适配型 View（多端兼容）</h3>
<p>这类 View 针对<strong>不同平台</strong>（iOS/macOS/tvOS/watchOS）做了样式和交互适配，核心逻辑统一，但展示形态随平台变化。</p>
<h4 data-id="heading-13">核心特点：</h4>
<ul>
	<li>跨平台 API 统一，样式自动适配平台规范；</li>
	<li>可通过 <code>#if os(...)</code> 定制平台特有逻辑；</li>
	<li>部分仅在特定平台可用（如 <code>MacOSWindow</code>）。</li>
</ul>
<h4 data-id="heading-14">典型代表：</h4>
<table>
	<thead>
		<tr>
			<th>View 名称</th>
			<th>核心特点</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td><code>List</code></td>
			<td>iOS 为滚动列表，macOS 为表格，tvOS 为焦点列表，watchOS 为小型列表</td>
		</tr>
		<tr>
			<td><code>Form</code></td>
			<td>表单容器，iOS 为分组列表，macOS 为表单布局，自动适配平台表单样式</td>
		</tr>
		<tr>
			<td><code>TabView</code></td>
			<td>标签页容器，iOS 为底部标签，macOS 为顶部标签，tvOS 为焦点标签</td>
		</tr>
		<tr>
			<td><code>SidebarList</code></td>
			<td>侧边栏列表（macOS/iPadOS），适配系统侧边栏样式、交互</td>
		</tr>
	</tbody>
</table>
<h3 data-id="heading-15">六、自定义 View（业务封装）</h3>
<p>开发者基于 <code>View</code> 协议自定义的 View，是 SwiftUI 组件化的核心，可封装复用逻辑。</p>
<h4 data-id="heading-16">核心特点：</h4>
<ul>
	<li>遵循 <code>View</code> 协议，实现 <code>body</code> 属性返回子 View；</li>
	<li>可通过 <code>@State</code>/<code>@Binding</code>/<code>@ObservedObject</code> 管理状态；</li>
	<li>支持 modifier 扩展，可组合内置 View 实现复杂功能；</li>
	<li>可封装业务逻辑，对外暴露简洁接口。</li>
</ul>
<h4 data-id="heading-17">示例：</h4>
<p>swift</p>
<pre><code class="hljs language-scss" lang="scss">struct CustomButton: View {
    let title: String
    let action: () -&gt; Void
    
    var body: some View {
        <span class="hljs-selector-tag">Button</span>(action: action) {
            Text(title)
                <span class="hljs-selector-class">.padding</span>()
                <span class="hljs-selector-class">.background</span>(Color.blue)
                <span class="hljs-selector-class">.foregroundColor</span>(.white)
                <span class="hljs-selector-class">.cornerRadius</span>(<span class="hljs-number">8</span>)
        }
    }
}
</code></pre>
<h3 data-id="heading-18">核心总结</h3>
<table>
	<thead>
		<tr>
			<th>类型</th>
			<th>核心目标</th>
			<th>典型特征</th>
		</tr>
	</thead>
	<tbody>
		<tr>
			<td>基础容器型</td>
			<td>布局与组合子 View</td>
			<td>无视觉样式，仅提供布局规则</td>
		</tr>
		<tr>
			<td>基础展示型</td>
			<td>呈现静态内容</td>
			<td>轻量、无状态、样式可定制</td>
		</tr>
		<tr>
			<td>交互型</td>
			<td>响应用户操作</td>
			<td>内置交互逻辑，支持状态绑定</td>
		</tr>
		<tr>
			<td>容器修饰型</td>
			<td>增强子 View 功能</td>
			<td>包装器模式，附加特定功能</td>
		</tr>
		<tr>
			<td>平台适配型</td>
			<td>跨平台兼容</td>
			<td>样式自动适配，API 统一</td>
		</tr>
		<tr>
			<td>自定义 View</td>
			<td>业务逻辑封装与复用</td>
			<td>遵循 View 协议，组合内置 View</td>
		</tr>
	</tbody>
</table>
<p>SwiftUI 的 View 设计核心是<strong>组合优于继承</strong>，所有 View 都是值类型（<code>struct</code>），通过 modifier 链式调用扩展功能，不同类型的 View 可灵活嵌套，构建复杂且高性能的界面。</p>
大家好，我是1024小神，技术群 / 私活群 / 股票群 或 交朋友 都可以私信我。
如果你觉得本文有用，一键三连 (点赞、评论、关注)，就是对我最大的支持~</div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[后台计时器罢工？我改用visibilitychange监听，代码从此‘永不停机’！]]></title>    <link>https://juejin.cn/post/7579886397075374080</link>    <guid>https://juejin.cn/post/7579886397075374080</guid>    <pubDate>2025-12-05T06:15:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579886397075374080" data-draft-id="7527109047814144000" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="后台计时器罢工？我改用visibilitychange监听，代码从此‘永不停机’！"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-12-05T06:15:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南游"/> <meta itemprop="url" content="https://juejin.cn/user/1728872003943688"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            后台计时器罢工？我改用visibilitychange监听，代码从此‘永不停机’！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1728872003943688/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南游
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T06:15:51.000Z" title="Fri Dec 05 2025 06:15:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>该问题的核心是浏览器对后台标签页的资源优化机制，现代浏览器（尤其是Chrome）为了节省电量、内存，会降低后台标签页的JavaScript执行频率，甚至冻结定时器。</p>
<h2 data-id="heading-0">一. 使用Visibility API 监听页面状态</h2>
<h3 data-id="heading-1">1. 使用setInterval</h3>
<ul>
<li>浏览器提供了<code>visibilitychange</code>事件和<code>document.visibilityState</code>属性来检测页面是否可见</li>
<li>当页面切换到后台时，我们停止计时器并记录已运行时间</li>
<li>当页面回到前台时，我们重新启动计时器，并调整开始时间以保持计时连续性</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 定义计时器相关变量</span>
<span class="hljs-keyword">let</span> startTime          <span class="hljs-comment">// 记录计时器开始时间（用于计算总运行时长）</span>
<span class="hljs-keyword">let</span> elapsedTime = <span class="hljs-number">0</span>    <span class="hljs-comment">// 记录暂停时已经运行的时间（用于恢复时保持计时连续性）</span>
<span class="hljs-keyword">let</span> timerId              <span class="hljs-comment">// 保存计时器ID（用于后续清除计时器）</span>

<span class="hljs-comment">// 启动计时器函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">startTimer</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 计算新的开始时间：当前时间减去已暂停的时间</span>
  <span class="hljs-comment">// 这样计时器恢复时看起来像是连续运行的，不会出现时间跳跃</span>
  startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - elapsedTime
  <span class="hljs-comment">// 清除之前的计时器（如果有）</span>
  <span class="hljs-keyword">if</span> (timerId) <span class="hljs-built_in">clearInterval</span>(timerId)
  <span class="hljs-comment">// 启动新的计时器，每100毫秒执行一次updateTimer函数（你的具体逻辑函数）</span>
  timerId = <span class="hljs-built_in">setInterval</span>(updateTimer, <span class="hljs-number">100</span>)
}

<span class="hljs-comment">// 停止计时器函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">stopTimer</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 清除当前运行的计时器</span>
  <span class="hljs-built_in">clearInterval</span>(timerId)
  <span class="hljs-comment">// 记录暂停时已运行的时间：当前时间减去计时器开始时间</span>
  <span class="hljs-comment">// 这样下次重启时可以知道已经运行了多久，保持计时连续性</span>
  elapsedTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - startTime
}

<span class="hljs-comment">// 监听页面可见性变化事件</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'visibilitychange'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">visibilityState</span> === <span class="hljs-string">'visible'</span>) {
    <span class="hljs-comment">// 页面从后台回到前台：重启计时器</span>
    <span class="hljs-title function_">startTimer</span>()
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 页面进入后台：停止计时器以节省资源</span>
    <span class="hljs-title function_">stopTimer</span>()
  }
})
</code></pre>
<h3 data-id="heading-2">2. 使用requestAnimationFrame</h3>
<p><code>requestAnimationFrame</code>是浏览器提供的专门用于优化动画效果的API，其核心原理是与屏幕刷新率同步执行回调函数，从而实现更流畅的动画效果‌。</p>
<p>‌<strong>工作原理</strong>‌</p>
<ul>
<li>以系统刷新频率（通常60Hz/16.7ms）为周期调用回调函数‌</li>
<li>回调函数在浏览器重绘前执行，确保动画帧同步‌</li>
<li>后台标签页中自动暂停执行以节省资源‌</li>
</ul>
<p>‌<strong>对比setTimeout/setInterval</strong>‌</p>
<ul>
<li>定时器存在时间间隔不稳定问题（受JS单线程影响）‌</li>
<li>无法保证与屏幕刷新同步，可能导致丢帧‌</li>
<li>持续消耗资源（即使页面不可见）‌</li>
</ul>
<p><strong>使用方法</strong>‌</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">animate</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 动画逻辑</span>
  <span class="hljs-title function_">requestAnimationFrame</span>(animate) <span class="hljs-comment">// 递归调用</span>
}
<span class="hljs-title function_">requestAnimationFrame</span>(animate) <span class="hljs-comment">// 启动动画</span>
</code></pre>
<p><strong>优势总结</strong></p>
<ul>
<li><code>requestAnimationFrame</code>比<code>setInterval</code>更高效，因为它与浏览器渲染周期同步</li>
<li>浏览器会自动优化后台页面的<code>requestAnimationFrame</code>调用，进一步节省资源</li>
<li>这种实现方式更精确，因为它是基于浏览器的重绘周期而非固定时间间隔</li>
<li>同样保持了计时连续性，确保页面切换前后计时准确</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()      <span class="hljs-comment">// 记录计时器开始时间</span>
<span class="hljs-keyword">let</span> accumulatedTime = <span class="hljs-number">0</span>         <span class="hljs-comment">// 累计运行时间（用于处理暂停）</span>
<span class="hljs-keyword">let</span> frameId = <span class="hljs-literal">null</span>              <span class="hljs-comment">// 保存动画帧ID（用于取消请求）</span>

<span class="hljs-comment">// 计时器核心逻辑</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">tick</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 计算总运行时间：当前时间减去开始时间加上之前累计的时间</span>
  <span class="hljs-keyword">const</span> elapsed = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - startTime + accumulatedTime
  
  <span class="hljs-comment">// 如果运行时间达到1秒（1000毫秒）</span>
  <span class="hljs-keyword">if</span> (elapsed &gt;= <span class="hljs-number">1000</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Timer tick'</span>)    <span class="hljs-comment">// 执行定时任务</span>
    accumulatedTime = elapsed - <span class="hljs-number">1000</span> <span class="hljs-comment">// 重置累计时间（减去已完成的一个周期）</span>
    startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()       <span class="hljs-comment">// 重置开始时间为当前时间</span>
  }
  
  <span class="hljs-comment">// 请求下一帧继续执行</span>
  frameId = <span class="hljs-title function_">requestAnimationFrame</span>(tick)
}

<span class="hljs-comment">// 监听页面可见性变化</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'visibilitychange'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">visibilityState</span> === <span class="hljs-string">'visible'</span>) {
    <span class="hljs-comment">// 页面变为可见</span>
    <span class="hljs-keyword">if</span> (!frameId) {
      <span class="hljs-comment">// 如果计时器未运行，则重新启动</span>
      startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - accumulatedTime <span class="hljs-comment">// 调整开始时间保持连续性</span>
      frameId = <span class="hljs-title function_">requestAnimationFrame</span>(tick)    <span class="hljs-comment">// 启动计时器</span>
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 页面变为不可见</span>
    accumulatedTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() - startTime <span class="hljs-comment">// 记录已运行时间</span>
    <span class="hljs-title function_">cancelAnimationFrame</span>(frameId)            <span class="hljs-comment">// 取消动画帧请求</span>
    frameId = <span class="hljs-literal">null</span>                           <span class="hljs-comment">// 重置ID</span>
  }
})

<span class="hljs-comment">// 初始启动计时器</span>
frameId = <span class="hljs-title function_">requestAnimationFrame</span>(tick)
</code></pre>
<h2 data-id="heading-3">二. Web Workers 后台线程</h2>
<ul>
<li>Web Workers运行在独立线程中，不受主页面可见性状态影响</li>
<li>计时逻辑在Worker线程中执行，即使页面在后台也能保持精确计时</li>
<li>Worker通过<code>postMessage</code>与主线程通信，主线程只在收到消息时才需要处理</li>
<li>这种方式适合需要精确后台计时的场景，但会消耗更多资源</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// ========== 主线程代码 (main.js) ==========</span>
<span class="hljs-comment">// 创建一个Web Worker，指定worker脚本文件</span>
<span class="hljs-comment">// Web Worker是在独立线程中运行的JavaScript，不受主页面可见性影响</span>
<span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">'timer-worker.js'</span>)

<span class="hljs-comment">// 向worker发送消息，告诉它启动计时器，间隔1000毫秒</span>
worker.<span class="hljs-title function_">postMessage</span>({ 
  <span class="hljs-attr">action</span>: <span class="hljs-string">'start'</span>,      <span class="hljs-comment">// 操作类型：启动计时器</span>
  <span class="hljs-attr">interval</span>: <span class="hljs-number">1000</span>        <span class="hljs-comment">// 时间间隔(ms)：1秒</span>
});

<span class="hljs-comment">// 监听worker发来的消息</span>
worker.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">data</span>.<span class="hljs-property">tick</span>) {
    <span class="hljs-comment">// 收到tick消息时的处理逻辑</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Timer tick from worker'</span>)
    <span class="hljs-comment">// 这里可以更新UI或执行其他需要主线程处理的任务</span>
  }
})

<span class="hljs-comment">// ========== Worker线程代码 (timer-worker.js) ==========</span>
<span class="hljs-comment">// 监听来自主线程的消息</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">data</span>.<span class="hljs-property">action</span> === <span class="hljs-string">'start'</span>) {
    <span class="hljs-comment">// 在worker中启动计时器</span>
    <span class="hljs-comment">// 注意：Worker中的setInterval不受页面可见性影响</span>
    <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 每隔指定间隔向主线程发送tick消息</span>
      self.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">tick</span>: <span class="hljs-literal">true</span> })
    }, e.<span class="hljs-property">data</span>.<span class="hljs-property">interval</span>)
  }
})
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java循环：让代码重复工作的"魔法"]]></title>    <link>https://juejin.cn/post/7579846221168623670</link>    <guid>https://juejin.cn/post/7579846221168623670</guid>    <pubDate>2025-12-05T05:45:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579846221168623670" data-draft-id="7579932196463460406" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java循环：让代码重复工作的&quot;魔法&quot;"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-05T05:45:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃西红柿长大的番茄"/> <meta itemprop="url" content="https://juejin.cn/user/3097787706900985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java循环：让代码重复工作的"魔法"
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097787706900985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃西红柿长大的番茄
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T05:45:14.000Z" title="Fri Dec 05 2025 05:45:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><p><strong>循环</strong>就是让计算机重复执行一段代码的能力</p>
<h2 data-id="heading-0">三种循环</h2>
<h3 data-id="heading-1">1. for循环：知道要做多少次</h3>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-comment">// for循环结构：for(初始化; 条件; 更新) { 循环体 }</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ForLoopSimple</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== for循环示例 ==="</span>);
        
        <span class="hljs-comment">// 示例1：打印1到5</span>
        System.out.println(<span class="hljs-string">"1. 打印1到5:"</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">5</span>; i++) {
            System.out.println(<span class="hljs-string">"数字: "</span> + i);
        }
        
        <span class="hljs-comment">// 示例2：计算1到10的和</span>
        System.out.println(<span class="hljs-string">"\n2. 计算1到10的和:"</span>);
        <span class="hljs-type">int</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">10</span>; i++) {
            sum = sum + i;  <span class="hljs-comment">// 累加</span>
        }
        System.out.println(<span class="hljs-string">"和是: "</span> + sum);
        
        <span class="hljs-comment">// 示例3：打印乘法表</span>
        System.out.println(<span class="hljs-string">"\n3. 5×5乘法表:"</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">5</span>; i++) {
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; j &lt;= <span class="hljs-number">5</span>; j++) {
                System.out.print(i * j + <span class="hljs-string">"\t"</span>);
            }
            System.out.println();  <span class="hljs-comment">// 换行</span>
        }
    }
}
</code></pre>
<h3 data-id="heading-2">2. while循环：不确定要做多少次</h3>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-comment">// while循环结构：while(条件) { 循环体 }</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WhileLoopSimple</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== while循环示例 ==="</span>);
        
        <span class="hljs-comment">// 示例1：计数器</span>
        System.out.println(<span class="hljs-string">"1. 倒计时:"</span>);
        <span class="hljs-type">int</span> <span class="hljs-variable">countdown</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;
        <span class="hljs-keyword">while</span> (countdown &gt; <span class="hljs-number">0</span>) {
            System.out.println(<span class="hljs-string">"倒计时: "</span> + countdown);
            countdown--;  <span class="hljs-comment">// 减1</span>
        }
        System.out.println(<span class="hljs-string">"发射！"</span>);
        
        <span class="hljs-comment">// 示例2：猜数字游戏</span>
        System.out.println(<span class="hljs-string">"\n2. 猜数字游戏:"</span>);
        <span class="hljs-type">int</span> <span class="hljs-variable">secretNumber</span> <span class="hljs-operator">=</span> <span class="hljs-number">42</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">guess</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-keyword">while</span> (guess != secretNumber) {
            guess = <span class="hljs-number">30</span> + (<span class="hljs-type">int</span>)(Math.random() * <span class="hljs-number">20</span>);  <span class="hljs-comment">// 随机猜30-50</span>
            System.out.println(<span class="hljs-string">"猜: "</span> + guess);
        }
        System.out.println(<span class="hljs-string">"猜对了！数字是 "</span> + secretNumber);
    }
}
</code></pre>
<h3 data-id="heading-3">3. do-while循环：至少做一次</h3>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-comment">// do-while循环结构：do { 循环体 } while(条件);</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DoWhileLoopSimple</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== do-while循环示例 ==="</span>);
        
        <span class="hljs-comment">// 示例1：至少执行一次</span>
        System.out.println(<span class="hljs-string">"1. 用户确认:"</span>);
        String answer;
        
        <span class="hljs-keyword">do</span> {
            System.out.print(<span class="hljs-string">"你喜欢Java吗？(yes/no): "</span>);
            <span class="hljs-comment">// 假设用户输入"yes"</span>
            answer = <span class="hljs-string">"yes"</span>;
            System.out.println(<span class="hljs-string">"你的回答: "</span> + answer);
        } <span class="hljs-keyword">while</span> (answer.equals(<span class="hljs-string">"no"</span>));  <span class="hljs-comment">// 如果回答"no"就继续问</span>
        
        System.out.println(<span class="hljs-string">"太好了！"</span>);
        
        <span class="hljs-comment">// 示例2：菜单选择</span>
        System.out.println(<span class="hljs-string">"\n2. 菜单选择:"</span>);
        <span class="hljs-type">int</span> choice;
        
        <span class="hljs-keyword">do</span> {
            System.out.println(<span class="hljs-string">"1. 开始游戏"</span>);
            System.out.println(<span class="hljs-string">"2. 查看帮助"</span>);
            System.out.println(<span class="hljs-string">"3. 退出"</span>);
            choice = <span class="hljs-number">1</span>;  <span class="hljs-comment">// 假设用户选择了1</span>
            System.out.println(<span class="hljs-string">"你选择了: "</span> + choice);
        } <span class="hljs-keyword">while</span> (choice != <span class="hljs-number">3</span>);  <span class="hljs-comment">// 只要不是3就继续显示菜单</span>
        
        System.out.println(<span class="hljs-string">"再见！"</span>);
    }
}
</code></pre>
<h2 data-id="heading-4">循环控制：break和continue</h2>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoopControl</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 循环控制 ==="</span>);
        
        <span class="hljs-comment">// 1. break：立即结束整个循环</span>
        System.out.println(<span class="hljs-string">"1. break示例（找到7就停止）:"</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">10</span>; i++) {
            <span class="hljs-keyword">if</span> (i == <span class="hljs-number">7</span>) {
                System.out.println(<span class="hljs-string">"找到7了，停止！"</span>);
                <span class="hljs-keyword">break</span>;  <span class="hljs-comment">// 立即跳出循环</span>
            }
            System.out.println(<span class="hljs-string">"当前数字: "</span> + i);
        }
        
        <span class="hljs-comment">// 2. continue：跳过本次循环的剩余部分</span>
        System.out.println(<span class="hljs-string">"\n2. continue示例（跳过偶数）:"</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">10</span>; i++) {
            <span class="hljs-keyword">if</span> (i % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) {  <span class="hljs-comment">// 如果是偶数</span>
                <span class="hljs-keyword">continue</span>;  <span class="hljs-comment">// 跳过这次循环，继续下一次</span>
            }
            System.out.println(<span class="hljs-string">"奇数: "</span> + i);
        }
        
        <span class="hljs-comment">// 3. 综合示例：计算及格人数</span>
        System.out.println(<span class="hljs-string">"\n3. 计算及格人数:"</span>);
        <span class="hljs-type">int</span>[] scores = {<span class="hljs-number">85</span>, <span class="hljs-number">42</span>, <span class="hljs-number">90</span>, <span class="hljs-number">56</span>, <span class="hljs-number">78</span>, <span class="hljs-number">30</span>, <span class="hljs-number">95</span>};
        <span class="hljs-type">int</span> <span class="hljs-variable">passCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> score : scores) {
            <span class="hljs-keyword">if</span> (score &lt; <span class="hljs-number">60</span>) {
                <span class="hljs-keyword">continue</span>;  <span class="hljs-comment">// 不及格，跳过</span>
            }
            passCount++;  <span class="hljs-comment">// 只有及格才计数</span>
            System.out.println(<span class="hljs-string">"及格分数: "</span> + score);
        }
        
        System.out.println(<span class="hljs-string">"及格人数: "</span> + passCount);
    }
}
</code></pre>
<h2 data-id="heading-5">实际应用：学生成绩统计</h2>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StudentScoreSystem</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 学生成绩统计系统 ==="</span>);
        
        <span class="hljs-comment">// 学生成绩数组</span>
        <span class="hljs-type">int</span>[] scores = {<span class="hljs-number">85</span>, <span class="hljs-number">92</span>, <span class="hljs-number">78</span>, <span class="hljs-number">90</span>, <span class="hljs-number">88</span>, <span class="hljs-number">65</span>, <span class="hljs-number">95</span>, <span class="hljs-number">72</span>, <span class="hljs-number">84</span>, <span class="hljs-number">60</span>};
        
        <span class="hljs-comment">// 统计</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">maxScore</span> <span class="hljs-operator">=</span> scores[<span class="hljs-number">0</span>];
        <span class="hljs-type">int</span> <span class="hljs-variable">minScore</span> <span class="hljs-operator">=</span> scores[<span class="hljs-number">0</span>];
        <span class="hljs-type">int</span> <span class="hljs-variable">passCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> score : scores) {
            <span class="hljs-comment">// 累加总分</span>
            total += score;
            
            <span class="hljs-comment">// 找最高分</span>
            <span class="hljs-keyword">if</span> (score &gt; maxScore) {
                maxScore = score;
            }
            
            <span class="hljs-comment">// 找最低分</span>
            <span class="hljs-keyword">if</span> (score &lt; minScore) {
                minScore = score;
            }
            
            <span class="hljs-comment">// 统计及格人数</span>
            <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">60</span>) {
                passCount++;
            }
        }
        
        <span class="hljs-comment">// 计算结果</span>
        <span class="hljs-type">double</span> <span class="hljs-variable">average</span> <span class="hljs-operator">=</span> (<span class="hljs-type">double</span>) total / scores.length;
        
        <span class="hljs-comment">// 输出结果</span>
        System.out.println(<span class="hljs-string">"学生人数: "</span> + scores.length);
        System.out.println(<span class="hljs-string">"总分: "</span> + total);
        System.out.println(<span class="hljs-string">"平均分: "</span> + String.format(<span class="hljs-string">"%.2f"</span>, average));
        System.out.println(<span class="hljs-string">"最高分: "</span> + maxScore);
        System.out.println(<span class="hljs-string">"最低分: "</span> + minScore);
        System.out.println(<span class="hljs-string">"及格人数: "</span> + passCount);
        System.out.println(<span class="hljs-string">"不及格人数: "</span> + (scores.length - passCount));
        
        <span class="hljs-comment">// 成绩分布</span>
        System.out.println(<span class="hljs-string">"\n=== 成绩分布 ==="</span>);
        System.out.println(<span class="hljs-string">"优秀(90-100):"</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> score : scores) {
            <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">90</span>) {
                System.out.print(score + <span class="hljs-string">" "</span>);
            }
        }
        
        System.out.println(<span class="hljs-string">"\n良好(80-89):"</span>);
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> score : scores) {
            <span class="hljs-keyword">if</span> (score &gt;= <span class="hljs-number">80</span> &amp;&amp; score &lt; <span class="hljs-number">90</span>) {
                System.out.print(score + <span class="hljs-string">" "</span>);
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-6">无限循环：小心这个"陷阱"！</h2>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InfiniteLoop</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"=== 无限循环（不要这样做！）==="</span>);
        
        <span class="hljs-comment">// ❌ 错误的例子：忘记更新循环变量</span>
        <span class="hljs-comment">// int i = 1;</span>
        <span class="hljs-comment">// while (i &lt;= 5) {</span>
        <span class="hljs-comment">//     System.out.println(i);</span>
        <span class="hljs-comment">//     // 忘记写 i++，会无限循环！</span>
        <span class="hljs-comment">// }</span>
        
        <span class="hljs-comment">// ❌ 错误的例子：条件永远为真</span>
        <span class="hljs-comment">// while (true) {</span>
        <span class="hljs-comment">//     System.out.println("永远执行");</span>
        <span class="hljs-comment">// }</span>
        
        <span class="hljs-comment">// ✅ 正确的做法：确保循环能结束</span>
        System.out.println(<span class="hljs-string">"正确的循环:"</span>);
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
        <span class="hljs-keyword">while</span> (i &lt;= <span class="hljs-number">5</span>) {
            System.out.println(i);
            i++;  <span class="hljs-comment">// 不要忘记这个！</span>
        }
    }
}
</code></pre>
<h2 data-id="heading-7">对比总结</h2>

























<table><thead><tr><th>循环类型</th><th>适用场景</th><th>特点</th></tr></thead><tbody><tr><td><code>for</code></td><td>知道循环次数</td><td>结构紧凑，最常用</td></tr><tr><td><code>while</code></td><td>不确定循环次数</td><td>先判断，后执行</td></tr><tr><td><code>do-while</code></td><td>至少执行一次</td><td>先执行，后判断</td></tr></tbody></table>
<h2 data-id="heading-8">记住这三点就够了：</h2>
<ol>
<li><strong>for循环</strong> → 当你知道要重复多少次时用</li>
<li><strong>while循环</strong> → 当你不知道要重复多少次时用</li>
<li><strong>注意退出条件</strong> → 确保循环能正常结束</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Advent of Code 2025 挑战全手写代码 Day 5 - 餐厅]]></title>    <link>https://juejin.cn/post/7579851956212432948</link>    <guid>https://juejin.cn/post/7579851956212432948</guid>    <pubDate>2025-12-05T06:20:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579851956212432948" data-draft-id="7579851956212416564" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Advent of Code 2025 挑战全手写代码 Day 5 - 餐厅"/> <meta itemprop="keywords" content="后端,Python"/> <meta itemprop="datePublished" content="2025-12-05T06:20:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="linzeyang"/> <meta itemprop="url" content="https://juejin.cn/user/897656724654199"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Advent of Code 2025 挑战全手写代码 Day 5 - 餐厅
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/897656724654199/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    linzeyang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T06:20:03.000Z" title="Fri Dec 05 2025 06:20:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🎄Advent of Code 2025 挑战全手写代码 Day 5 - 餐厅</h2>
<hr/>
<p>Welcom back! 今天题目 <code>Cafeteria</code> 难度简单（一星 ⭐），主要考察<strong>排序</strong>、<strong>集合</strong>、<strong>区间合并</strong>等知识点。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca1aab0c07994be1b85bd1a245d056b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGluemV5YW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765520402&amp;x-signature=36icU%2BKdyWmXSYwgUtbnYTzzGwA%3D" alt="advent-of-code-2025-day-5" loading="lazy"/></p>
<p><strong>📖 题目速览</strong></p>
<p>题目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fadventofcode.com%2F2025%2Fday%2F5" target="_blank" title="https://adventofcode.com/2025/day/5" ref="nofollow noopener noreferrer">adventofcode.com/2025/day/5</a></p>
<p>我们终于进入了传说中的“秘密餐厅”！但是，因为新的库存管理系统崩溃了，精灵大厨们分不清哪些食材是<strong>新鲜</strong>（Fresh）的，哪些是<strong>变质</strong>（Spoiled）的。为了吃上饭，我们得帮他们修 Bug。</p>
<h4 data-id="heading-1">Part 1：点在区间内（Point in Interval）</h4>
<p>输入包含两部分：</p>
<ol>
<li>一组<strong>新鲜食材的 ID 区间</strong>（例如 <code>3-5</code>, <code>10-14</code>）。</li>
<li>一组<strong>现有库存的 ID</strong>（例如 <code>1</code>, <code>5</code>, <code>8</code>）。</li>
</ol>
<p>规则很简单：如果一个库存 ID 落在<strong>任何一个</strong>新鲜区间内，它就是新鲜的。
任务：统计现有库存中有多少个 ID 是新鲜的。</p>
<p><strong>💡 Part 1 优化思路</strong>：</p>
<p>最直接的做法是双重循环：遍历每个 ID，再遍历每个区间检查。复杂度是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mo>×</mo><mi>M</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N \times M)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mclose">)</span></span></span></span></span>。</p>
<p>但其实我们可以预先对区间进行<strong>排序</strong>（按起始位置升序排列），然后对每个 ID 使用<strong>二分查找</strong>或者将区间合并后查找。这样可以将时间复杂度从线性降到对数！</p>
<p>不过对于 Part 1 的数据量其实很小，暴力法也没问题。</p>
<hr/>
<h4 data-id="heading-2">Part 2：区间并集的长度（Length of Union of Intervals）</h4>
<p>精灵们为了省事，想知道<strong>总共有多少个整数 ID</strong>被认为是新鲜的。
也就是说，我们要计算所有给定的新鲜区间的<strong>并集</strong>包含了多少个整数。
在这一部分，<strong>现有库存的 ID</strong>就没有用了，我们只需要（已经排好序的）<strong>新鲜食材的 ID 区间</strong>。</p>
<p>例如：
<code>[3, 5]</code> 和 <code>[4, 6]</code> 合并后是 <code>[3, 6]</code>，包含 3, 4, 5, 6 共 4 个数。</p>
<p><strong>🚫 我的踩坑时刻</strong>
这题我一开始写了个 Bug，在合并区间时：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> start - target[<span class="hljs-number">1</span>] &lt;= <span class="hljs-number">1</span>:
    target = target[<span class="hljs-number">0</span>], end  <span class="hljs-comment"># ❌ 错误写法！</span>
</code></pre>
<p>我直接把当前区间的 <code>end</code> 赋给了合并后的终点。
但这忽略了一种情况：如果当前区间<strong>完全被包含</strong>在目标区间内（例如 target=<code>[1, 10]</code>, current=<code>[3, 5]</code>），这样做会导致合并后的区间反而变小了（变成了 <code>[1, 5]</code>）！这导致得到的结果比正确结果要小很多！</p>
<p><strong>✅ 正确写法</strong>应该是取最大值：</p>
<pre><code class="hljs language-python" lang="python">target = target[<span class="hljs-number">0</span>], <span class="hljs-built_in">max</span>(target[<span class="hljs-number">1</span>], end)
</code></pre>
<p>就差这一个 <code>max</code>，让我调试了好半天... 😅</p>
<hr/>
<h3 data-id="heading-3">💻 为什么不用 Set？</h3>
<p>为什么不直接把所有区间里的数都塞进一个 <code>set</code> 里去重，最后求 <code>len(set)</code>？
对于小数据量这当然没问题。但如果区间范围非常大（例如 <code>1-1000000000</code>），用 Set 会造成极大的内存空间浪费，因为我们实际上并不需要知道每个ID的具体数值。</p>
<p><strong>区间合并算法</strong>的优势在于：
它只处理区间的“端点”，与区间内的具体数值跨度无关。
无论区间是 <code>1-5</code> 还是 <code>1-100亿</code>，对算法来说都只是处理两个数字。</p>
<ul>
<li><strong>时间复杂度</strong>：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mi>log</mi><mo>⁡</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N \log N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></span>，主要花在排序上。</li>
<li><strong>空间复杂度</strong>：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span> 。</li>
</ul>
<h3 data-id="heading-4">✨ 核心代码 (Python)</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">solve_part2</span>(<span class="hljs-params">ranges</span>):
    <span class="hljs-comment"># 1. 必须按起始位置排序！</span>
    ranges.sort(key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">0</span>])
    
    out = <span class="hljs-number">0</span>
    target = ranges[<span class="hljs-number">0</span>]

    <span class="hljs-keyword">for</span> idx <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, <span class="hljs-built_in">len</span>(ranges)):
        start, end = ranges[idx]

        <span class="hljs-comment"># 2. 判断是否重叠或相连（离散整数，差1也算连着）</span>
        <span class="hljs-keyword">if</span> start - target[<span class="hljs-number">1</span>] &lt;= <span class="hljs-number">1</span>:
            <span class="hljs-comment"># 3. 核心：取最大的结束位置</span>
            target = target[<span class="hljs-number">0</span>], <span class="hljs-built_in">max</span>(target[<span class="hljs-number">1</span>], end)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># 4. 结算上一段区间长度</span>
            out += target[<span class="hljs-number">1</span>] - target[<span class="hljs-number">0</span>] + <span class="hljs-number">1</span>
            target = start, end

    <span class="hljs-comment"># ‼️别忘了加上最后一段</span>
    out += target[<span class="hljs-number">1</span>] - target[<span class="hljs-number">0</span>] + <span class="hljs-number">1</span>
    <span class="hljs-keyword">return</span> out
</code></pre>
<p>今天这题虽然也是 1 星难度，但很好地考察了<strong>贪心</strong>和<strong>排序</strong>的思想，是 LeetCode 56 (Merge Intervals) 的变种。</p>
<p>完整代码：访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flinzeyang%2Fadvent-of-code%2Fblob%2Fmain%2F2025%2Fday_05.py" target="_blank" title="https://github.com/linzeyang/advent-of-code/blob/main/2025/day_05.py" ref="nofollow noopener noreferrer">github</a></p>
<p>Happy Coding! 今天也要继续冲榜！🚀</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f37c04cde54c444b8e91d3d8a3e45908~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbGluemV5YW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765520402&amp;x-signature=UUv723P7faV0OBYbKjS0YGdknd8%3D" alt="day-5-ranking" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 误区粉碎：useEffectEvent 是“非响应式”的，所以它不会触发重渲染？]]></title>    <link>https://juejin.cn/post/7579892134817710115</link>    <guid>https://juejin.cn/post/7579892134817710115</guid>    <pubDate>2025-12-05T06:42:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579892134817710115" data-draft-id="7579961957222039579" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 误区粉碎：useEffectEvent 是“非响应式”的，所以它不会触发重渲染？"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-12-05T06:42:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮蛋小精灵"/> <meta itemprop="url" content="https://juejin.cn/user/219558056559278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 误区粉碎：useEffectEvent 是“非响应式”的，所以它不会触发重渲染？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558056559278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮蛋小精灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T06:42:39.000Z" title="Fri Dec 05 2025 06:42:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：一个概念引发的“血案”</h2>
<p>随着 React 官方文档提出 <code>useEffectEvent</code>（目前作为实验性 API <code>experimental_useEffectEvent</code> 存在），社区里出现了一个非常普遍的误解。</p>
<p>我们都知道 <code>useEffectEvent</code> 的核心特性是 <strong>“非响应式 (Non-reactive)”</strong> 。</p>
<p>很多开发者看到这个词，下意识地会认为：“哦，它是非响应式的，那意味着它里面的代码执行时，React 应该是‘无感’的吧？如果我在里面写了 <code>setState</code>，是不是也不会触发组件的 Rerender（重渲染）？”</p>
<p><strong>答案是：大错特错。</strong></p>
<p>本文将通过一个精准的实验，带你彻底厘清 <strong>“Effect 的响应式”</strong> 与 <strong>“组件的重渲染”</strong> 这一对容易混淆的概念。</p>
<h2 data-id="heading-1">1. 直接上结论</h2>
<p>在 <code>useEffectEvent</code> 内部调用 <code>setState</code>：</p>
<ol>
<li><strong>绝对会</strong> 触发组件的重新渲染 (Re-render)。</li>
<li><strong>绝对不会</strong> 触发调用它的那个 <code>useEffect</code> 重新运行。</li>
</ol>
<p>简而言之：<strong>它会更新 UI，但不会打断副作用的生命周期。</strong> 这正是它设计的精妙之处。</p>
<h2 data-id="heading-2">2. 现场实验：定时器计数器</h2>
<p>口说无凭，我们看代码。假设我们有一个组件，每秒钟自动增加计数，同时打印当前的主题色（Theme）。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">import</span> { useState, useEffect, useEffectEvent } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Timer</span>(<span class="hljs-params">{ theme }</span>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-comment">// 1. 定义一个 Event</span>
  <span class="hljs-comment">// 它的逻辑包含：更新状态(setState) + 读取最新 Props</span>
  <span class="hljs-keyword">const</span> onTick = <span class="hljs-title function_">useEffectEvent</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">c</span> =&gt;</span> c + <span class="hljs-number">1</span>); <span class="hljs-comment">// &lt;--- 关键点：这里调用了 setState</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Tick! Current theme:'</span>, theme);
  });

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 2. 在 Effect 中调用 Event</span>
      <span class="hljs-title function_">onTick</span>();
    }, <span class="hljs-number">1000</span>);
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(id);
  }, []); <span class="hljs-comment">// ✅ 依赖数组为空，定时器永远不会被重置</span>

  <span class="hljs-comment">// 3. 渲染日志</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Component Rerendered. Count:'</span>, count);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">color:</span> <span class="hljs-attr">theme</span> }}&gt;</span>
      Timer: {count}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-3">运行结果分析</h3>
<p>当你运行这段代码时，你会观察到以下现象：</p>
<ol>
<li>
<p><strong>控制台疯狂打印 "Component Rerendered..."</strong></p>
<ul>
<li>这证明了：<code>useEffectEvent</code> 里的 <code>setCount</code> 依然生效了，React 响应了状态变化，并更新了 DOM。</li>
</ul>
</li>
<li>
<p><strong>定时器 ID 没有变，没有发生“清除重设”</strong></p>
<ul>
<li>这证明了：尽管组件在疯狂重渲染，尽管 <code>theme</code> 可能在变，但 <code>useEffect</code> <strong>并没有</strong> 重新运行。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-4">3. 深度解析：为什么会混淆？</h2>
<p>大家之所以困惑，是因为混淆了 React 中两个维度的“响应”：</p>
<h3 data-id="heading-5">维度 A：Effect 的响应式 (Dependency Chain)</h3>
<p>这是 <code>useEffect</code> 的规则。</p>
<ul>
<li><strong>规则：</strong> 如果依赖变了，我要销毁旧副作用，建立新副作用。</li>
<li><strong>useEffectEvent 的作用：</strong> 它像一个“隔板”。它告诉 <code>useEffect</code>：“你别管我内部用了什么数据，我的引用是稳定的。”</li>
<li><strong>结果：</strong> <code>useEffect</code> 保持安静，<strong>不响应</strong>数据的变化。</li>
</ul>
<h3 data-id="heading-6">维度 B：UI 的响应式 (Rendering Cycle)</h3>
<p>这是 <code>setState</code> 的规则。</p>
<ul>
<li><strong>规则：</strong> 只要状态变了，我要生成新的 Virtual DOM，和旧的比对，然后更新屏幕。</li>
<li><strong>useEffectEvent 的作用：</strong> 在这里，它只是一个普通的函数容器。当它执行 <code>setCount</code> 时，React 的调度机制立刻接管：“有人改了状态！安排更新！”</li>
<li><strong>结果：</strong> 组件 <strong>响应</strong> 状态的变化，刷新 UI。</li>
</ul>
<h2 data-id="heading-7">4. 最佳实践场景：聊天室的红点</h2>
<p>理解了“既会 Rerender，又不会重启 Effect”，我们就能完美处理复杂业务场景。</p>
<p><strong>场景：</strong> 聊天室长连接。</p>
<ol>
<li>收到消息时，需要增加“未读消息数”（需要更新 UI）。</li>
<li>收到消息时，需要根据当前的 <code>isMuted</code>（是否静音）状态决定是否响铃。</li>
</ol>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ChatRoom</span>(<span class="hljs-params">{ roomId, isMuted }</span>) {
  <span class="hljs-keyword">const</span> [unread, setUnread] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">const</span> onMessage = <span class="hljs-title function_">useEffectEvent</span>(<span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> {
    <span class="hljs-comment">// 1. 触发 Rerender：为了显示红点</span>
    <span class="hljs-title function_">setUnread</span>(<span class="hljs-function"><span class="hljs-params">n</span> =&gt;</span> n + <span class="hljs-number">1</span>);
    
    <span class="hljs-comment">// 2. 读取最新 Props：为了逻辑判断</span>
    <span class="hljs-keyword">if</span> (!isMuted) {
      <span class="hljs-title function_">playSound</span>();
    }
  });

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> connection = <span class="hljs-title function_">createConnection</span>(roomId);
    connection.<span class="hljs-title function_">on</span>(<span class="hljs-string">'message'</span>, onMessage);
    connection.<span class="hljs-title function_">connect</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> connection.<span class="hljs-title function_">disconnect</span>();
  }, [roomId]); <span class="hljs-comment">// ✅ 只有换房间才断网重连，静音设置的变化不会引起断网重连</span>
}
</code></pre>
<p>在这个例子中，<code>useEffectEvent</code> 完美扮演了双重角色：</p>
<ul>
<li>对 <strong>UI</strong> 来说，它是<strong>活跃的</strong>（更新未读数）。</li>
<li>对 <strong>连接</strong> 来说，它是<strong>隐形的</strong>（不干扰连接稳定性）。</li>
</ul>
<h2 data-id="heading-8">5. 总结</h2>
<p>不要被 <strong>“非响应式 (Non-reactive)”</strong> 这个词吓倒。</p>
<p>在 React 的语境下，它特指 <strong>“不进入依赖数组，不触发 Effect 重启”</strong> 。它绝不是指“冻结 UI 更新”。</p>
<p><code>useEffectEvent</code> 是 React 团队为了解决“既要读取最新数据，又要保持副作用稳定”这一千古难题给出的标准答案。放心在里面使用 <code>setState</code> 吧，这正是它的用武之地。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS的clamp()函数：一行代码让网页自适应如此简单]]></title>    <link>https://juejin.cn/post/7579995569688510498</link>    <guid>https://juejin.cn/post/7579995569688510498</guid>    <pubDate>2025-12-05T06:46:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579995569688510498" data-draft-id="7572455881029877769" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS的clamp()函数：一行代码让网页自适应如此简单"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2025-12-05T06:46:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刘大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS的clamp()函数：一行代码让网页自适应如此简单
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刘大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T06:46:17.000Z" title="Fri Dec 05 2025 06:46:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前端开发中，实现响应式设计一直是个挑战。今天介绍一个能够大大简化响应式开发的CSS函数——<code>clamp()</code>。</p>
<h2 data-id="heading-0">什么是clamp()？</h2>
<p>简单来说，<code>clamp()</code>就像给CSS值设置了一个安全范围：无论屏幕怎么变化，这个值都不会超出你设定的最小和最大边界。</p>
<p><strong>基本语法：</strong></p>
<pre><code class="hljs language-css" lang="css">clamp(最小值, 理想值, 最大值)
</code></pre>
<p>假设调节空调温度：你设定了最低18℃、最高26℃，理想温度24℃。无论外面多热多冷，室内温度都会在这个舒适范围内——这就是<code>clamp()</code>的工作原理。</p>
<h2 data-id="heading-1">为什么需要clamp()？</h2>
<h3 data-id="heading-2">传统方式的痛点</h3>
<p>以前我们要实现响应式文字大小，得这样写：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.title</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
}

<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">768px</span>) {
  <span class="hljs-selector-class">.title</span> {
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">18px</span>;
  }
}

<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">min-width</span>: <span class="hljs-number">1024px</span>) {
  <span class="hljs-selector-class">.title</span> {
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">20px</span>;
  }
}
</code></pre>
<p><strong>问题：</strong></p>
<ul>
<li>要写很多媒体查询</li>
<li>尺寸在断点处突然跳跃，不够平滑</li>
<li>维护困难，改个尺寸要到处找</li>
</ul>
<h3 data-id="heading-3">clamp()的解决方案</h3>
<p>用<code>clamp()</code>只需要一行：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.title</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-built_in">clamp</span>(<span class="hljs-number">16px</span>, <span class="hljs-number">4vw</span>, <span class="hljs-number">20px</span>);
}
</code></pre>
<p><strong>意思是：</strong></p>
<ul>
<li>最小不会小于16px</li>
<li>最大不会超过20px</li>
<li>理想大小是视口宽度的4%</li>
</ul>
<h2 data-id="heading-4">案例</h2>
<h3 data-id="heading-5">1. 响应式文字大小（最常用）</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 标题响应式系统 */</span>
<span class="hljs-selector-tag">h1</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-built_in">clamp</span>(<span class="hljs-number">2rem</span>, <span class="hljs-number">5vw</span>, <span class="hljs-number">4rem</span>);
  <span class="hljs-comment">/* 手机上看是2rem，平板上逐渐变大，桌面端最大到4rem */</span>
}

<span class="hljs-selector-tag">h2</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-built_in">clamp</span>(<span class="hljs-number">1.5rem</span>, <span class="hljs-number">4vw</span>, <span class="hljs-number">3rem</span>);
}

<span class="hljs-selector-tag">p</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-built_in">clamp</span>(<span class="hljs-number">1rem</span>, <span class="hljs-number">2.5vw</span>, <span class="hljs-number">1.25rem</span>);
}
</code></pre>
<p><strong>效果对比：</strong></p>
<ul>
<li>手机（375px宽）：h1 ≈ 2.5rem</li>
<li>平板（768px宽）：h1 ≈ 3.2rem</li>
<li>桌面（1200px宽）：h1 = 4rem</li>
</ul>
<h3 data-id="heading-6">2. 容器宽度</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-built_in">clamp</span>(<span class="hljs-number">300px</span>, <span class="hljs-number">80%</span>, <span class="hljs-number">1200px</span>);
  <span class="hljs-comment">/* 最小300px，最大1200px，平时占父元素80%宽度 */</span>
}

<span class="hljs-selector-class">.card</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-built_in">clamp</span>(<span class="hljs-number">280px</span>, <span class="hljs-number">90vw</span>, <span class="hljs-number">400px</span>);
  <span class="hljs-comment">/* 在小屏幕上几乎全宽，大屏幕上固定400px */</span>
}
</code></pre>
<h3 data-id="heading-7">3. 灵活的间距控制</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.section</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-built_in">clamp</span>(<span class="hljs-number">1rem</span>, <span class="hljs-number">5%</span>, <span class="hljs-number">3rem</span>);
  <span class="hljs-comment">/* 内边距在1rem到3rem之间，平时是父元素宽度的5% */</span>
  
  <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-built_in">clamp</span>(<span class="hljs-number">2rem</span>, <span class="hljs-number">8vh</span>, <span class="hljs-number">5rem</span>);
  <span class="hljs-comment">/* 下边距在2rem到5rem之间，与视口高度相关 */</span>
}
</code></pre>
<h3 data-id="heading-8">4. 图片自适应</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.hero-image</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-built_in">clamp</span>(<span class="hljs-number">300px</span>, <span class="hljs-number">60vw</span>, <span class="hljs-number">800px</span>);
  <span class="hljs-attribute">height</span>: <span class="hljs-built_in">clamp</span>(<span class="hljs-number">200px</span>, <span class="hljs-number">40vh</span>, <span class="hljs-number">500px</span>);
  <span class="hljs-comment">/* 宽高都随视口变化，但有合理的限制 */</span>
}
</code></pre>
<h2 data-id="heading-9">更多案例</h2>
<h3 data-id="heading-10">打造完美响应式卡片</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.product-card</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-built_in">clamp</span>(<span class="hljs-number">280px</span>, <span class="hljs-number">30vw</span>, <span class="hljs-number">350px</span>);
  <span class="hljs-attribute">padding</span>: <span class="hljs-built_in">clamp</span>(<span class="hljs-number">1rem</span>, <span class="hljs-number">3vw</span>, <span class="hljs-number">2rem</span>);
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-built_in">clamp</span>(<span class="hljs-number">0.5rem</span>, <span class="hljs-number">1.5vw</span>, <span class="hljs-number">1rem</span>);
  <span class="hljs-attribute">gap</span>: <span class="hljs-built_in">clamp</span>(<span class="hljs-number">0.75rem</span>, <span class="hljs-number">2vw</span>, <span class="hljs-number">1.5rem</span>);
}

<span class="hljs-selector-class">.product-card</span> <span class="hljs-selector-tag">h3</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-built_in">clamp</span>(<span class="hljs-number">1.25rem</span>, <span class="hljs-number">3vw</span>, <span class="hljs-number">1.75rem</span>);
}

<span class="hljs-selector-class">.product-card</span> <span class="hljs-selector-class">.price</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-built_in">clamp</span>(<span class="hljs-number">1.1rem</span>, <span class="hljs-number">2.5vw</span>, <span class="hljs-number">1.5rem</span>);
}
</code></pre>
<h3 data-id="heading-11">现代化导航栏</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.navbar</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-built_in">clamp</span>(<span class="hljs-number">60px</span>, <span class="hljs-number">10vh</span>, <span class="hljs-number">80px</span>);
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-built_in">clamp</span>(<span class="hljs-number">1rem</span>, <span class="hljs-number">5vw</span>, <span class="hljs-number">4rem</span>);
}

<span class="hljs-selector-class">.nav-links</span> {
  <span class="hljs-attribute">gap</span>: <span class="hljs-built_in">clamp</span>(<span class="hljs-number">1rem</span>, <span class="hljs-number">3vw</span>, <span class="hljs-number">3rem</span>);
  <span class="hljs-attribute">font-size</span>: <span class="hljs-built_in">clamp</span>(<span class="hljs-number">0.9rem</span>, <span class="hljs-number">2vw</span>, <span class="hljs-number">1.1rem</span>);
}
</code></pre>
<h2 data-id="heading-12">为什么clamp()如此强大？</h2>
<h3 data-id="heading-13">1. 代码量大幅减少</h3>
<p>原来需要几十行的媒体查询，现在可能只需要几行<code>clamp()</code>。</p>
<h3 data-id="heading-14">2. 真正的流体响应</h3>
<p>尺寸在不同屏幕间平滑过渡，没有突兀的跳跃感。</p>
<h3 data-id="heading-15">3. 更好的用户体验</h3>
<p>元素尺寸根据视口智能调整，在任何设备上都有良好的可读性。</p>
<h3 data-id="heading-16">4. 维护性极佳</h3>
<p>修改响应式行为只需要调整一个<code>clamp()</code>值。</p>
<h2 data-id="heading-17">注意事项</h2>
<h3 data-id="heading-18">选择合适的单位</h3>
<ul>
<li><strong>相对单位</strong>：vw、vh、%、rem（推荐）</li>
<li><strong>绝对单位</strong>：px（用于设置明确的边界）</li>
</ul>
<h3 data-id="heading-19">合理设置范围</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 推荐：合理的范围设置 */</span>
good-example {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-built_in">clamp</span>(<span class="hljs-number">1rem</span>, <span class="hljs-number">2.5vw</span>, <span class="hljs-number">2rem</span>);
}

<span class="hljs-comment">/* 不推荐：范围设置不合理 */</span>
bad-example {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-built_in">clamp</span>(<span class="hljs-number">0.5rem</span>, <span class="hljs-number">2.5vw</span>, <span class="hljs-number">5rem</span>); <span class="hljs-comment">/* 最小和最大差距太大 */</span>
}
</code></pre>
<h3 data-id="heading-20">浏览器兼容性</h3>
<ul>
<li>现代浏览器（Chrome、Firefox、Safari、Edge）都支持</li>
<li>如果需要支持老浏览器，记得准备回退方案：</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.title</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">18px</span>; <span class="hljs-comment">/* 回退值 */</span>
  <span class="hljs-attribute">font-size</span>: <span class="hljs-built_in">clamp</span>(<span class="hljs-number">16px</span>, <span class="hljs-number">4vw</span>, <span class="hljs-number">20px</span>);
}
</code></pre>
<h2 data-id="heading-21">什么时候不该用clamp()？</h2>
<p>虽然<code>clamp()</code>很强大，但并不是万能的：</p>
<ol>
<li><strong>需要精确断点控制时</strong>——媒体查询更合适</li>
<li><strong>复杂的布局变化</strong>——比如移动端和桌面端完全不同的布局</li>
<li><strong>性能敏感的场景</strong>——复杂的计算可能影响性能</li>
</ol>
<h2 data-id="heading-22">总结</h2>
<p><code>clamp()</code>是CSS中一个革命性的功能，它让我们能够用更少的代码实现更流畅的响应式设计。特别适合：</p>
<ul>
<li>字体大小响应式</li>
<li>间距和内边距</li>
<li>容器尺寸限制</li>
<li>图片和媒体元素</li>
</ul>
<blockquote>
<p>本文首发于公众号：程序员刘大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote>
<h4 data-id="heading-23">📌往期精彩</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fmaq_p_m5vd7KS-xyXt5rcA" target="_blank" title="https://mp.weixin.qq.com/s/maq_p_m5vd7KS-xyXt5rcA" ref="nofollow noopener noreferrer">《SpringBoot+MySQL+Vue实现文件共享系统》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FP7SMincYFKERZbNKAFtzGQ" target="_blank" title="https://mp.weixin.qq.com/s/P7SMincYFKERZbNKAFtzGQ" ref="nofollow noopener noreferrer">《这20条SQL优化方案，让你的数据库查询速度提升10倍》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FgQK9L1TxKL50FUVMcgh6JQ" target="_blank" title="https://mp.weixin.qq.com/s/gQK9L1TxKL50FUVMcgh6JQ" ref="nofollow noopener noreferrer">《SpringBoot 动态菜单权限系统设计的企业级解决方案》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FPQ_w7CDVoIZPn-CVH2DKJg" target="_blank" title="https://mp.weixin.qq.com/s/PQ_w7CDVoIZPn-CVH2DKJg" ref="nofollow noopener noreferrer">《Vue3和Vue2的核心区别？很多开发者都没完全搞懂的10个细节》</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JsonUtils：打造企业级的序列化与反序列化瑞士军刀]]></title>    <link>https://juejin.cn/post/7579887768228593698</link>    <guid>https://juejin.cn/post/7579887768228593698</guid>    <pubDate>2025-12-05T06:41:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579887768228593698" data-draft-id="7579945518344699919" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JsonUtils：打造企业级的序列化与反序列化瑞士军刀"/> <meta itemprop="keywords" content="后端,开源"/> <meta itemprop="datePublished" content="2025-12-05T06:41:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="白衣鸽子"/> <meta itemprop="url" content="https://juejin.cn/user/3072451409619223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JsonUtils：打造企业级的序列化与反序列化瑞士军刀
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3072451409619223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    白衣鸽子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T06:41:11.000Z" title="Fri Dec 05 2025 06:41:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 前言</h2>
<p>在Java的世界里，我们无时无刻不在处理对象与字符串之间的形态转换。对象是内存中结构化的数据载体，而字符串则是数据持久化与网络传输的通用媒介。将对象<strong>序列化（Serialization）</strong> 为特定格式的字符串，或从字符串中<strong>反序列化（Deserialization）</strong> 还原出对象，是连接内存世界与外部世界的核心桥梁。</p>
<p>然而，这座桥梁的构建并非总是一帆风顺。你可能面临多种挑战：</p>
<ul>
<li><strong>格式多样性</strong>：外部数据源可能采用<strong>蛇形命名（snake_case）</strong>，而你的系统内部规范是<strong>驼峰命名（camelCase）</strong>。</li>
<li><strong>特殊字符处理</strong>：生成的字符串是否需要转义非ASCII字符（如中文）以保证兼容性，还是保留原样以增强可读性？</li>
<li><strong>数据容错性</strong>：能否解析那些不太规范但实际存在的<strong>单引号JSON字符串</strong>？</li>
<li><strong>灵活性与复杂度</strong>：如何轻松地处理复杂的嵌套对象、泛型集合（如 <code>List&lt;Order&gt;</code>）？</li>
</ul>
<p>面对这些纷繁复杂的需求，一个强大而精巧的 <code>JsonUtils</code> 工具类不仅能准确无误地在对象与字符串间进行转换，更能理解并适应各种业务场景。</p>
<p><strong>让我们看看它是如何化繁为简的：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 场景1：将对象转换为蛇形命名的JSON字符串（用于对接外部API）</span>
<span class="hljs-type">OrderDTO</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderDTO</span>(...);
<span class="hljs-type">String</span> <span class="hljs-variable">jsonForExternal</span> <span class="hljs-operator">=</span> JsonUtils.toJson(order); <span class="hljs-comment">// 输出: {"order_id": 123, "user_name": "张三"}</span>

<span class="hljs-comment">// 场景2：从驼峰命名的JSON字符串中还原对象（用于解析内部消息）</span>
<span class="hljs-type">String</span> <span class="hljs-variable">internalMessage</span> <span class="hljs-operator">=</span> <span class="hljs-string">"{\"orderId\":123,\"userName\":\"李四\"}"</span>;
<span class="hljs-type">OrderDTO</span> <span class="hljs-variable">orderObj</span> <span class="hljs-operator">=</span> JsonUtils.fromCamelJson(internalMessage, OrderDTO.class);

<span class="hljs-comment">// 场景3：生成不转义中文的JSON字符串，便于日志阅读</span>
<span class="hljs-type">String</span> <span class="hljs-variable">readableLog</span> <span class="hljs-operator">=</span> JsonUtils.toNonAsciiJson(order); <span class="hljs-comment">// 输出: {"order_id": 123, "user_name": "张三"}</span>

<span class="hljs-comment">// 场景4：解析非标准的单引号JSON字符串</span>
<span class="hljs-type">String</span> <span class="hljs-variable">quirkyJson</span> <span class="hljs-operator">=</span> <span class="hljs-string">"{'order_id': 123, 'user_name': '王五'}"</span>;
<span class="hljs-type">OrderDTO</span> <span class="hljs-variable">orderFromQuirky</span> <span class="hljs-operator">=</span> JsonUtils.fromSingleQuoteJson(quirkyJson, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;OrderDTO&gt;() {});

<span class="hljs-comment">// 场景5：处理复杂类型，如泛型集合</span>
<span class="hljs-type">String</span> <span class="hljs-variable">listJson</span> <span class="hljs-operator">=</span> <span class="hljs-string">"[{...}, {...}]"</span>;
List&lt;OrderDTO&gt; orderList = JsonUtils.fromJson(listJson, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;List&lt;OrderDTO&gt;&gt;() {});
</code></pre>
<p>本文将深入解析这样一个企业级的 <code>JsonUtils</code> 实现，揭秘其如何通过精心的设计，成为你处理对象与字符串转换问题的“瑞士军刀”，从而显著提升开发效率与代码的健壮性。</p>
<h2 data-id="heading-1">2. 核心实现</h2>
<blockquote>
<p>由于暂时没有发现比较好用的JsonUtils开源工具，这里提供一个自研的实现供大家参考</p>
</blockquote>
<h3 data-id="heading-2">2.1 导入声明与类定义</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonInclude;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.core.JsonGenerator;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.core.JsonParser;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.core.type.TypeReference;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.DeserializationFeature;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.JavaType;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.PropertyNamingStrategy;
<span class="hljs-keyword">import</span> org.slf4j.Logger;
<span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;

<span class="hljs-keyword">import</span> java.io.IOException;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JsonUtils</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(JsonUtils.class);
}
</code></pre>
<p><strong>解析：</strong></p>
<ul>
<li>主要依赖Jackson库（2.x版本）提供核心序列化能力</li>
<li>集成了SLF4J日志框架，确保异常情况可追踪</li>
</ul>
<h3 data-id="heading-3">2.2 多配置ObjectMapper实例</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">camelObjectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">nonAsciiObjectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">singleQuotesObjectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();
</code></pre>
<p><strong>解析：</strong></p>
<ul>
<li><code>objectMapper</code>：默认配置，处理标准JSON</li>
<li><code>camelObjectMapper</code>：专用于驼峰命名格式</li>
<li><code>nonAsciiObjectMapper</code>：处理非ASCII字符</li>
<li><code>singleQuotesObjectMapper</code>：支持单引号JSON</li>
</ul>
<h4 data-id="heading-4">2.2.1 默认ObjectMapper配置（蛇形命名）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> {
    objectMapper.disable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES);
    objectMapper.setSerializationInclusion(JsonInclude.Include.NON_NULL);
    objectMapper.getFactory().configure(JsonGenerator.Feature.ESCAPE_NON_ASCII, <span class="hljs-literal">true</span>);
    objectMapper.setPropertyNamingStrategy(PropertyNamingStrategy.SNAKE_CASE);
}
</code></pre>
<p><strong>配置详解：</strong></p>
<ul>
<li><code>FAIL_ON_UNKNOWN_PROPERTIES(false)</code>：忽略未知字段，增强兼容性</li>
<li><code>NON_NULL</code>：序列化时排除null值，精简输出</li>
<li><code>ESCAPE_NON_ASCII(true)</code>：转义非ASCII字符，确保编码安全</li>
<li><code>SNAKE_CASE</code>：采用蛇形命名策略，适配多数API规范</li>
</ul>
<h4 data-id="heading-5">2.2.2 驼峰命名ObjectMapper配置</h4>
<pre><code class="hljs language-java" lang="java">camelObjectMapper.disable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES);
camelObjectMapper.setSerializationInclusion(JsonInclude.Include.NON_NULL);
camelObjectMapper.getFactory().configure(JsonGenerator.Feature.ESCAPE_NON_ASCII, <span class="hljs-literal">true</span>);
camelObjectMapper.setPropertyNamingStrategy(PropertyNamingStrategy.LOWER_CAMEL_CASE);
</code></pre>
<p><strong>特色功能：</strong> 专为Java内部通信设计，保持字段名的原生驼峰格式</p>
<h4 data-id="heading-6">2.2.3 包含非ASCII字符的ObjectMapper配置</h4>
<pre><code class="hljs language-java" lang="java">nonAsciiObjectMapper.disable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES);
nonAsciiObjectMapper.enable(DeserializationFeature.ACCEPT_EMPTY_STRING_AS_NULL_OBJECT);
nonAsciiObjectMapper.setSerializationInclusion(JsonInclude.Include.NON_NULL);
</code></pre>
<p><strong>配置详解：</strong></p>
<ul>
<li>移除ASCII转义，保留原生Unicode字符</li>
<li>支持空字符串转为null对象，增强数据清洗能力</li>
</ul>
<h4 data-id="heading-7">2.2.4 单引号JSON支持配置</h4>
<pre><code class="hljs language-java" lang="java">singleQuotesObjectMapper.disable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES);
singleQuotesObjectMapper.setSerializationInclusion(JsonInclude.Include.NON_NULL);
singleQuotesObjectMapper.getFactory().configure(JsonGenerator.Feature.ESCAPE_NON_ASCII, <span class="hljs-literal">true</span>);
singleQuotesObjectMapper.setPropertyNamingStrategy(PropertyNamingStrategy.SNAKE_CASE);
singleQuotesObjectMapper.configure(JsonParser.Feature.ALLOW_SINGLE_QUOTES, <span class="hljs-literal">true</span>);
</code></pre>
<p><strong>配置详解：</strong></p>
<ul>
<li>反序列化时忽略未知字段，避免因多余字段而失败。</li>
<li>序列化时忽略null值，减少JSON字符串的大小。</li>
<li>序列化时转义非ASCII字符，确保JSON字符串的ASCII兼容性。</li>
<li>使用蛇形命名策略进行属性名映射。</li>
<li>允许解析单引号的JSON字符串。</li>
</ul>
<p>在完成多配置ObjectMapper实例的初始化后，JsonUtils工具类提供了丰富的方法来支持各种序列化和反序列化场景。这些方法根据不同的配置需求进行了精心设计，确保开发者能够针对具体场景选择最合适的工具。</p>
<h3 data-id="heading-8">2.3 核心工具方法</h3>
<h4 data-id="heading-9">2.3.1 序列化工具方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">toJson</span><span class="hljs-params">(Object object)</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> objectMapper.writeValueAsString(object);
    } <span class="hljs-keyword">catch</span> (IOException e) {
        logger.error(e.getMessage(), e);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">toCamelJson</span><span class="hljs-params">(Object object)</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> camelObjectMapper.writeValueAsString(object);
    } <span class="hljs-keyword">catch</span> (IOException e) {
        logger.error(e.getMessage(), e);
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JsonParseException</span>(e);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">toNonAsciiJson</span><span class="hljs-params">(Object object)</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> nonAsciiObjectMapper.writeValueAsString(object);
    } <span class="hljs-keyword">catch</span> (IOException e) {
        logger.error(e.getMessage(), e);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p><strong>方法说明：</strong></p>
<ul>
<li><code>toJson()</code>: 使用默认配置（蛇形命名 + ASCII转义）进行序列化</li>
<li><code>toCamelJson()</code>: 使用驼峰命名配置进行序列化</li>
<li><code>toNonAsciiJson()</code>: 使用非ASCII字符保留配置进行序列化</li>
</ul>
<p><strong>使用场景对比：</strong></p>





























<table><thead><tr><th>方法</th><th>命名策略</th><th>字符处理</th><th>适用场景</th></tr></thead><tbody><tr><td><code>toJson()</code></td><td>蛇形命名</td><td>ASCII转义</td><td>对外API、数据存储</td></tr><tr><td><code>toCamelJson()</code></td><td>驼峰命名</td><td>ASCII转义</td><td>Java内部服务通信</td></tr><tr><td><code>toNonAsciiJson()</code></td><td>默认命名</td><td>保留原字符</td><td>日志输出、调试信息</td></tr></tbody></table>
<p><strong>使用示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 创建测试对象</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {
    <span class="hljs-keyword">private</span> String productName;
    <span class="hljs-keyword">private</span> Double price;
    <span class="hljs-keyword">private</span> String category;
    
    <span class="hljs-comment">// 构造方法、getter、setter省略</span>
}

<span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(<span class="hljs-string">"笔记本电脑"</span>, <span class="hljs-number">5999.99</span>, <span class="hljs-string">"电子产品"</span>);

<span class="hljs-comment">// 标准序列化（蛇形命名 + ASCII转义）- 适合API接口</span>
<span class="hljs-type">String</span> <span class="hljs-variable">standardJson</span> <span class="hljs-operator">=</span> JsonUtils.toJson(product);
<span class="hljs-comment">// 实际输出: {"product_name":"\u7B14\u8BB0\u672C\u7535\u8111","price":5999.99,"category":"\u7535\u5B50\u4EA7\u54C1"}</span>
<span class="hljs-comment">// 注意：中文字符被转义为Unicode序列</span>

<span class="hljs-comment">// 驼峰命名序列化 - 适合Java内部通信</span>
<span class="hljs-type">String</span> <span class="hljs-variable">camelJson</span> <span class="hljs-operator">=</span> JsonUtils.toCamelJson(product);
<span class="hljs-comment">// 实际输出: {"productName":"\u7B14\u8BB0\u672C\u7535\u8111","price":5999.99,"category":"\u7535\u5B50\u4EA7\u54C1"}</span>
<span class="hljs-comment">// 字段名保持驼峰格式，字符仍然转义</span>

<span class="hljs-comment">// 非ASCII字符保留序列化 - 适合日志和调试</span>
<span class="hljs-type">String</span> <span class="hljs-variable">readableJson</span> <span class="hljs-operator">=</span> JsonUtils.toNonAsciiJson(product);
<span class="hljs-comment">// 实际输出: {"product_name":"笔记本电脑","price":5999.99,"category":"电子产品"}</span>
<span class="hljs-comment">// 中文字符保持原样，便于阅读</span>
</code></pre>
<h4 data-id="heading-10">2.3.2 反序列化工具方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">fromJson</span><span class="hljs-params">(String json, Class&lt;T&gt; clazz)</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> (T) objectMapper.readValue(json, clazz);
    } <span class="hljs-keyword">catch</span> (IOException e) {
        logger.error(e.getMessage(), e);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">fromCamelJson</span><span class="hljs-params">(String json, Class&lt;T&gt; clazz)</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> (T) camelObjectMapper.readValue(json, clazz);
    } <span class="hljs-keyword">catch</span> (IOException e) {
        logger.error(e.getMessage(), e);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">fromNonAsciiJson</span><span class="hljs-params">(String json, Class&lt;T&gt; clazz)</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> (T) nonAsciiObjectMapper.readValue(json, clazz);
    } <span class="hljs-keyword">catch</span> (IOException e) {
        logger.error(e.getMessage(), e);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p><strong>方法说明：</strong></p>
<ul>
<li><code>fromJson()</code>: 使用默认配置解析标准JSON字符串</li>
<li><code>fromCamelJson()</code>: 使用驼峰命名配置解析JSON字符串</li>
<li><code>fromNonAsciiJson()</code>: 使用非ASCII配置解析包含原生字符的JSON</li>
</ul>
<p><strong>使用示例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 解析标准蛇形命名JSON（来自外部系统）</span>
<span class="hljs-type">String</span> <span class="hljs-variable">snakeCaseJson</span> <span class="hljs-operator">=</span> <span class="hljs-string">"{\"user_name\":\"李四\",\"user_age\":30}"</span>;
<span class="hljs-type">User</span> <span class="hljs-variable">user1</span> <span class="hljs-operator">=</span> JsonUtils.fromJson(snakeCaseJson, User.class);
<span class="hljs-comment">// 成功解析，user对象的userName属性值为"李四"，userAge属性值为30</span>

<span class="hljs-comment">// 解析驼峰命名JSON（来自Java内部服务）</span>
<span class="hljs-type">String</span> <span class="hljs-variable">camelCaseJson</span> <span class="hljs-operator">=</span> <span class="hljs-string">"{\"userName\":\"王五\",\"userAge\":28}"</span>;
<span class="hljs-type">User</span> <span class="hljs-variable">user2</span> <span class="hljs-operator">=</span> JsonUtils.fromCamelJson(camelCaseJson, User.class);
<span class="hljs-comment">// 成功解析，使用驼峰命名映射器</span>

<span class="hljs-comment">// 解析包含中文的JSON（无需转义，来自日志或配置）</span>
<span class="hljs-type">String</span> <span class="hljs-variable">chineseJson</span> <span class="hljs-operator">=</span> <span class="hljs-string">"{\"user_name\":\"赵六\",\"user_age\":35}"</span>;
<span class="hljs-type">User</span> <span class="hljs-variable">user3</span> <span class="hljs-operator">=</span> JsonUtils.fromNonAsciiJson(chineseJson, User.class);
<span class="hljs-comment">// 成功解析，使用非ASCII映射器处理原生中文字符</span>
</code></pre>
<h4 data-id="heading-11">2.3.3 对象与Map转换方法解析</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map&lt;String, Object&gt; <span class="hljs-title function_">toMap</span><span class="hljs-params">(Object object)</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> objectMapper.convertValue(object, Map.class);
    } <span class="hljs-keyword">catch</span> (IllegalArgumentException e) {
        logger.error(<span class="hljs-string">"JsonUtils.toMap error: {}"</span>, e.getMessage(), e);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map&lt;String, Object&gt; <span class="hljs-title function_">toCamelMap</span><span class="hljs-params">(Object object)</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> camelObjectMapper.convertValue(object, Map.class);
    } <span class="hljs-keyword">catch</span> (IllegalArgumentException e) {
        logger.error(<span class="hljs-string">"JsonUtils.toCamelMap error: {}"</span>, e.getMessage(), e);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p><strong>关键区别：<code>convertValue</code> vs <code>toJson</code> + <code>fromJson</code></strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 方式1：使用convertValue（推荐）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map&lt;String, Object&gt; <span class="hljs-title function_">toMap</span><span class="hljs-params">(Object object)</span> {
    <span class="hljs-keyword">return</span> objectMapper.convertValue(object, Map.class);
}

<span class="hljs-comment">// 方式2：使用toJson + fromJson（不推荐）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map&lt;String, Object&gt; <span class="hljs-title function_">toMapInefficient</span><span class="hljs-params">(Object object)</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> objectMapper.writeValueAsString(object); <span class="hljs-comment">// 序列化为JSON字符串</span>
        <span class="hljs-keyword">return</span> objectMapper.readValue(json, Map.class);        <span class="hljs-comment">// 反序列化为Map</span>
    } <span class="hljs-keyword">catch</span> (IOException e) {
        logger.error(<span class="hljs-string">"Error: {}"</span>, e.getMessage(), e);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<hr/>
<p><strong>实际转换过程对比:</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 性能测试示例</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceTest</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">"张三"</span>, <span class="hljs-number">25</span>, <span class="hljs-string">"zhangsan@example.com"</span>);
        
        <span class="hljs-comment">// 测试convertValue方式</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">start1</span> <span class="hljs-operator">=</span> System.nanoTime();
        Map&lt;String, Object&gt; map1 = JsonUtils.toMap(user);
        <span class="hljs-type">long</span> <span class="hljs-variable">end1</span> <span class="hljs-operator">=</span> System.nanoTime();
        
        <span class="hljs-comment">// 测试toJson+fromJson方式</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">start2</span> <span class="hljs-operator">=</span> System.nanoTime();
        Map&lt;String, Object&gt; map2 = JsonUtils.toMapInefficient(user);
        <span class="hljs-type">long</span> <span class="hljs-variable">end2</span> <span class="hljs-operator">=</span> System.nanoTime();
        
        System.out.println(<span class="hljs-string">"convertValue耗时: "</span> + (end1 - start1) + <span class="hljs-string">" ns"</span>);
        System.out.println(<span class="hljs-string">"toJson+fromJson耗时: "</span> + (end2 - start2) + <span class="hljs-string">" ns"</span>);
    }
}
</code></pre>
<p><strong>预期结果：</strong></p>
<ol>
<li><code>convertValue</code> 方式比 <code>toJson+fromJson</code> 方式快2-3倍，因为避免了不必要的字符串转换。
2. <strong>内存使用差异</strong>
<ul>
<li><code>convertValue</code>: 直接在内存中转换，不生成中间字符串</li>
<li><code>toJson+fromJson</code>: 需要先序列化为字符串，再解析字符串，产生额外内存开销</li>
</ul>
</li>
</ol>
<h2 data-id="heading-12">3. 高级反序列化方法</h2>
<h3 data-id="heading-13">3.1 问题背景：Java的类型擦除机制</h3>
<ul>
<li>Java在编译后会擦除泛型类型信息，这导致在运行时无法直接获取泛型的具体类型参数。</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 编译时：List&lt;User&gt;</span>
<span class="hljs-comment">// 运行时：只是List，丢失了User类型信息</span>
List&lt;User&gt; userList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
</code></pre>
<ul>
<li>基础反序列化（使用Class）的局限性</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 基础方法声明</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">fromJson</span><span class="hljs-params">(String json, Class&lt;T&gt; clazz)</span>

<span class="hljs-comment">// 使用示例 - 简单对象</span>
<span class="hljs-type">String</span> <span class="hljs-variable">userJson</span> <span class="hljs-operator">=</span> <span class="hljs-string">"{\"user_name\":\"张三\"}"</span>;
<span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> JsonUtils.fromJson(userJson, User.class); <span class="hljs-comment">// ✅ 正常工作</span>

<span class="hljs-comment">// 使用示例 - 尝试反序列化List&lt;User&gt;</span>
<span class="hljs-type">String</span> <span class="hljs-variable">listJson</span> <span class="hljs-operator">=</span> <span class="hljs-string">"[{\"user_name\":\"张三\"},{\"user_name\":\"李四\"}]"</span>;
List&lt;User&gt; users = JsonUtils.fromJson(listJson, List.class); <span class="hljs-comment">// ⚠️ 有问题！</span>
</code></pre>
<p><strong>问题分析：</strong></p>
<ul>
<li>编译时类型：<code>List&lt;User&gt;</code></li>
<li>运行时实际：<code>List&lt;Object&gt;</code>（User类型信息丢失）</li>
<li>结果：Jackson不知道应该将数组元素反序列化成什么类型</li>
</ul>
<h3 data-id="heading-14">3.2 高级反序列化（使用TypeReference）</h3>
<p>TypeReference通过创建匿名子类的方式，在运行时保留泛型类型信息。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 高级方法声明</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">fromJson</span><span class="hljs-params">(String json, TypeReference&lt;T&gt; type)</span>

<span class="hljs-comment">// 使用示例 - 正确反序列化泛型集合</span>
List&lt;User&gt; users = JsonUtils.fromJson(listJson, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;List&lt;User&gt;&gt;() {});
</code></pre>
<p><strong>底层机制：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// TypeReference的匿名子类在运行时保留了泛型信息</span>
TypeReference&lt;List&lt;User&gt;&gt; typeRef = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;List&lt;User&gt;&gt;() {};
<span class="hljs-comment">// 通过getType()方法可以获取到完整的ParameterizedType</span>
<span class="hljs-type">Type</span> <span class="hljs-variable">type</span> <span class="hljs-operator">=</span> typeRef.getType(); <span class="hljs-comment">// 返回的是List&lt;User&gt;的完整类型信息</span>
</code></pre>
<p><strong>在JsonUtils内的使用：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">fromJson</span><span class="hljs-params">(String json, TypeReference&lt;T&gt; type)</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> (T) objectMapper.readValue(json, type);
    } <span class="hljs-keyword">catch</span> (IOException e) {
        logger.error(e.getMessage(), e);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">fromSingleQuoteJson</span><span class="hljs-params">(String json, TypeReference&lt;T&gt; type)</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> (T) singleQuotesObjectMapper.readValue(json, type);
    } <span class="hljs-keyword">catch</span> (IOException e) {
        logger.error(e.getMessage(), e);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}
</code></pre>
<p><strong>方法说明：</strong></p>
<ul>
<li><code>fromJson(TypeReference)</code>: 处理复杂泛型类型的反序列化</li>
<li><code>fromSingleQuoteJson()</code>: 专门处理非标准单引号JSON格式</li>
</ul>
<p><strong>使用场景：</strong></p>
<ul>
<li>处理集合、映射等复杂数据结构</li>
<li>解析前端或第三方系统生成的非标准JSON</li>
</ul>
<h3 data-id="heading-15">3.3 使用示例</h3>
<h4 data-id="heading-16">3.3.1 场景1：反序列化简单集合</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误方式 - 使用Class</span>
<span class="hljs-type">String</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> <span class="hljs-string">"[{\"user_name\":\"张三\"},{\"user_name\":\"李四\"}]"</span>;

<span class="hljs-comment">// 方式1：直接使用List.class - 失败</span>
List&lt;User&gt; users1 = JsonUtils.fromJson(json, List.class);
<span class="hljs-comment">// 运行时异常：无法将LinkedHashMap转换为User</span>
<span class="hljs-comment">// 实际上得到的是List&lt;LinkedHashMap&gt;，需要手动转换</span>

<span class="hljs-comment">// 方式2：使用TypeReference - 成功</span>
List&lt;User&gt; users2 = JsonUtils.fromJson(json, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;List&lt;User&gt;&gt;() {});
<span class="hljs-comment">// 正确得到List&lt;User&gt;，每个元素都是User对象</span>
</code></pre>
<h4 data-id="heading-17">3.3.2 场景2：反序列化嵌套泛型</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 复杂嵌套泛型结构</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiResponse</span>&lt;T&gt; {
    <span class="hljs-keyword">private</span> T data;
    <span class="hljs-keyword">private</span> Integer totalCount;
    <span class="hljs-keyword">private</span> Boolean success;
    <span class="hljs-comment">// getter/setter</span>
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PageResult</span>&lt;User&gt; {
    <span class="hljs-keyword">private</span> List&lt;User&gt; items;
    <span class="hljs-keyword">private</span> Integer pageSize;
    <span class="hljs-keyword">private</span> Integer pageNum;
    <span class="hljs-comment">// getter/setter</span>
}

<span class="hljs-type">String</span> <span class="hljs-variable">complexJson</span> <span class="hljs-operator">=</span> <span class="hljs-string">"{"</span> +
    <span class="hljs-string">"\"data\": {"</span> +
    <span class="hljs-string">"   \"items\": [{\"user_name\":\"张三\"},{\"user_name\":\"李四\"}],"</span> +
    <span class="hljs-string">"   \"page_size\": 10,"</span> +
    <span class="hljs-string">"   \"page_num\": 1"</span> +
    <span class="hljs-string">"},"</span> +
    <span class="hljs-string">"\"total_count\": 2,"</span> +
    <span class="hljs-string">"\"success\": true"</span> +
<span class="hljs-string">"}"</span>;

<span class="hljs-comment">// 使用Class无法处理这种嵌套泛型</span>
<span class="hljs-comment">// ApiResponse&lt;PageResult&lt;User&gt;&gt; response = ? // 无法用Class表达</span>

<span class="hljs-comment">// 使用TypeReference轻松处理</span>
ApiResponse&lt;PageResult&lt;User&gt;&gt; response = JsonUtils.fromJson(
    complexJson, 
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;ApiResponse&lt;PageResult&lt;User&gt;&gt;&gt;() {}
);
</code></pre>
<h4 data-id="heading-18">3.3.3 场景3：反序列化Map结构</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Map&lt;String, User&gt; 反序列化</span>
<span class="hljs-type">String</span> <span class="hljs-variable">mapJson</span> <span class="hljs-operator">=</span> <span class="hljs-string">"{"</span> +
    <span class="hljs-string">"\"user1\": {\"user_name\":\"张三\",\"user_age\":25},"</span> +
    <span class="hljs-string">"\"user2\": {\"user_name\":\"李四\",\"user_age\":30}"</span> +
<span class="hljs-string">"}"</span>;

<span class="hljs-comment">// 使用Class只能得到Map&lt;String, Object&gt;</span>
Map&lt;String, Object&gt; map1 = JsonUtils.fromJson(mapJson, Map.class);
<span class="hljs-type">User</span> <span class="hljs-variable">user1</span> <span class="hljs-operator">=</span> (User) map1.get(<span class="hljs-string">"user1"</span>); <span class="hljs-comment">// 需要强制类型转换，不安全</span>

<span class="hljs-comment">// 使用TypeReference得到类型安全的Map</span>
Map&lt;String, User&gt; map2 = JsonUtils.fromJson(mapJson, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;Map&lt;String, User&gt;&gt;() {});
<span class="hljs-type">User</span> <span class="hljs-variable">user2</span> <span class="hljs-operator">=</span> map2.get(<span class="hljs-string">"user1"</span>); <span class="hljs-comment">// 直接得到User对象，类型安全</span>
</code></pre>
<h2 data-id="heading-19">4. 异常处理策略分析</h2>
<p>工具类采用了两种不同的异常处理策略，体现了不同的设计考量：</p>
<h3 data-id="heading-20">4.1 宽容策略（多数方法）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">toJson</span><span class="hljs-params">(Object object)</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> objectMapper.writeValueAsString(object);
    } <span class="hljs-keyword">catch</span> (IOException e) {
        logger.error(e.getMessage(), e);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <span class="hljs-comment">// 返回null，保证业务流程不中断</span>
}
</code></pre>
<ul>
<li><strong>适用场景</strong>：数据转换失败不应中断主流程的情况</li>
<li><strong>优势</strong>：提高系统容错性，避免因非关键数据问题导致服务不可用</li>
</ul>
<h3 data-id="heading-21">4.2 严格策略（关键操作）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">toCamelJson</span><span class="hljs-params">(Object object)</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">return</span> camelObjectMapper.writeValueAsString(object);
    } <span class="hljs-keyword">catch</span> (IOException e) {
        logger.error(e.getMessage(), e);
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JsonParseException</span>(e);  <span class="hljs-comment">// 抛出运行时异常</span>
    }
}
</code></pre>
<ul>
<li><strong>适用场景</strong>：关键业务操作，数据准确性至关重要</li>
<li><strong>优势</strong>：确保问题能够被上层统一处理，避免静默失败</li>
</ul>
<h2 data-id="heading-22">5. 总结</h2>
<p>本文提供的JsonUtils工具类通过精心设计的多配置ObjectMapper实例和丰富的工具方法，成功解决了Java开发中对象序列化与反序列化的核心痛点，当然在不同的业务研发过程中需要做差异化实现。</p>
<p><strong>核心价值体现在：</strong></p>
<ul>
<li><strong>场景化适配</strong>：针对不同使用场景提供专用配置，避免"一刀切"的局限性</li>
<li><strong>性能优化</strong>：通过<code>convertValue</code>等方法避免不必要的字符串转换，提升效率</li>
<li><strong>类型安全</strong>：利用TypeReference解决Java泛型擦除问题，保证复杂结构的正确解析</li>
<li><strong>容错性强</strong>：支持非标准JSON格式，增强系统鲁棒性</li>
</ul>
<p><strong>另外给出一个适用场景分析，仅供参考：</strong></p>















































<table><thead><tr><th>场景分类</th><th>推荐方法</th><th>配置特点</th><th>优势</th></tr></thead><tbody><tr><td><strong>对外API接口</strong></td><td><code>toJson()</code> / <code>fromJson()</code></td><td>蛇形命名 + ASCII转义</td><td>兼容性强，符合行业标准</td></tr><tr><td><strong>内部服务通信</strong></td><td><code>toCamelJson()</code> / <code>fromCamelJson()</code></td><td>驼峰命名 + ASCII转义</td><td>保持Java命名一致性</td></tr><tr><td><strong>日志记录调试</strong></td><td><code>toNonAsciiJson()</code></td><td>保留原生字符</td><td>可读性强，便于排查</td></tr><tr><td><strong>第三方数据集成</strong></td><td><code>fromSingleQuoteJson()</code></td><td>支持单引号JSON</td><td>容错性好，适应非标数据</td></tr><tr><td><strong>复杂数据结构</strong></td><td><code>fromJson(TypeReference)</code></td><td>完整泛型支持</td><td>类型安全，避免运行时错误</td></tr><tr><td><strong>动态字段处理</strong></td><td><code>toMap()</code> / <code>fromJson(Map)</code></td><td>对象Map互转</td><td>灵活性高，便于动态操作</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[async/await：异步编程的优雅解决方案]]></title>    <link>https://juejin.cn/post/7579887768228642850</link>    <guid>https://juejin.cn/post/7579887768228642850</guid>    <pubDate>2025-12-05T06:44:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579887768228642850" data-draft-id="7579851956212236340" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="async/await：异步编程的优雅解决方案"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-05T06:44:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="少寒"/> <meta itemprop="url" content="https://juejin.cn/user/976811508112392"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            async/await：异步编程的优雅解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/976811508112392/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    少寒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T06:44:29.000Z" title="Fri Dec 05 2025 06:44:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在JavaScript异步编程的发展历程中，从回调函数到Promise，再到如今广泛使用的async/await，每一次迭代都让代码的可读性和可维护性得到了显著提升。async/await作为Promise的语法糖，以同步代码的形式实现异步操作，彻底解决了"回调地狱"的痛点。本文将从概念解析、基础用法、进阶技巧到常见问题，全面介绍async/await的使用方法。</p>
<h2 data-id="heading-0">一、async/await的核心概念</h2>
<p>async/await并非独立的异步机制，而是基于Promise的上层封装，其核心由两个关键字构成：</p>
<ul>
<li><strong>async</strong>：用于声明一个函数为异步函数。异步函数的核心特性是：其返回值会自动封装为一个Promise对象。如果函数内部直接返回一个非Promise值，会被包装为resolved状态的Promise；如果抛出错误，则会被包装为rejected状态的Promise。</li>
<li><strong>await</strong>：仅能在async函数内部使用，用于等待一个Promise对象的状态变更。它会暂停当前async函数的执行，直到Promise完成（resolved）或失败（rejected），然后继续执行函数后续代码，并返回Promise的 resolved 值。如果等待的不是Promise对象，会直接返回该值本身。</li>
</ul>
<p>简单来说，async负责"开启异步上下文"，await负责"暂停并等待异步结果"，二者配合实现了"同步写法做异步事"的效果。</p>
<h2 data-id="heading-1">二、基础使用步骤：从Promise到async/await</h2>
<p>在学习async/await之前，我们先回顾一个Promise的基础案例——模拟接口请求获取用户数据：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟接口请求的Promise函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-params">id</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (id &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-title function_">resolve</span>({ id, <span class="hljs-attr">name</span>: <span class="hljs-string">`用户<span class="hljs-subst">${id}</span>`</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">20</span> + id }); <span class="hljs-comment">// 成功返回用户数据</span>
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"无效的用户ID"</span>)); <span class="hljs-comment">// 失败返回错误</span>
      }
    }, <span class="hljs-number">1000</span>);
  });
}

<span class="hljs-comment">// 使用Promise链式调用</span>
<span class="hljs-title function_">fetchUser</span>(<span class="hljs-number">1</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"用户信息："</span>, user);
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetchUser</span>(user.<span class="hljs-property">id</span> + <span class="hljs-number">1</span>); <span class="hljs-comment">// 链式请求下一个用户</span>
  })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">nextUser</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"下一个用户信息："</span>, nextUser);
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"错误："</span>, error.<span class="hljs-property">message</span>);
  });
</code></pre>
<p>虽然Promise链式调用比回调地狱清晰，但多层链式仍显繁琐。下面用async/await重构，感受其简洁性：</p>
<h3 data-id="heading-2">步骤1：用async声明异步函数</h3>
<p>所有使用await的代码，必须包裹在被async声明的函数内部，否则会报错。我们创建一个async函数来执行异步操作：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">async</span> function <span class="hljs-title">getUserInfo</span>()</span> {
  <span class="hljs-comment">// 内部可使用await</span>
}
</code></pre>
<h3 data-id="heading-3">步骤2：用await等待Promise结果</h3>
<p>在async函数内部，用await修饰Promise函数，即可直接获取resolved的值，无需使用then方法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserInfo</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 等待fetchUser(1)完成，并获取结果</span>
  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-number">1</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"用户信息："</span>, user);
  
  <span class="hljs-comment">// 基于第一个结果，发起第二个请求</span>
  <span class="hljs-keyword">const</span> nextUser = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>(user.<span class="hljs-property">id</span> + <span class="hljs-number">1</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"下一个用户信息："</span>, nextUser);
  
  <span class="hljs-keyword">return</span> { user, nextUser }; <span class="hljs-comment">// 返回值会被包装为Promise</span>
}
</code></pre>
<h3 data-id="heading-4">步骤3：处理错误与调用异步函数</h3>
<p>await无法直接捕获Promise的rejected状态，需配合try/catch语句处理错误。调用async函数时，可像使用Promise一样用then/catch，也可在另一个async函数中用await：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 方式1：用then/catch调用</span>
<span class="hljs-title function_">getUserInfo</span>()
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"最终结果："</span>, result);
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"错误："</span>, error.<span class="hljs-property">message</span>);
  });

<span class="hljs-comment">// 方式2：在另一个async函数中用await（更推荐）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUserInfo</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"最终结果："</span>, result);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"错误："</span>, error.<span class="hljs-property">message</span>);
  }
}

<span class="hljs-title function_">main</span>();
</code></pre>
<p>对比Promise链式调用，async/await的代码结构更接近同步逻辑，层级清晰，可读性大幅提升。</p>
<h2 data-id="heading-5">三、进阶使用技巧</h2>
<p>掌握基础用法后，结合以下技巧可应对更复杂的异步场景：</p>
<h3 data-id="heading-6">1. 并行执行多个异步操作</h3>
<p>需注意：<strong>单独使用await会导致异步操作串行执行</strong>，如果多个异步操作之间无依赖关系，串行执行会浪费时间。此时应结合<code>Promise.all()</code>实现并行执行，再用await等待所有结果：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 串行执行：总耗时约3秒（1+1+1）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">serialRequest</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> user1 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-number">1</span>);
  <span class="hljs-keyword">const</span> user2 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-number">2</span>);
  <span class="hljs-keyword">const</span> user3 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-number">3</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"串行结果："</span>, [user1, user2, user3]);
}

<span class="hljs-comment">// 并行执行：总耗时约1秒（同时发起3个请求）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">parallelRequest</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 先同时发起所有请求，获取Promise数组</span>
  <span class="hljs-keyword">const</span> promise1 = <span class="hljs-title function_">fetchUser</span>(<span class="hljs-number">1</span>);
  <span class="hljs-keyword">const</span> promise2 = <span class="hljs-title function_">fetchUser</span>(<span class="hljs-number">2</span>);
  <span class="hljs-keyword">const</span> promise3 = <span class="hljs-title function_">fetchUser</span>(<span class="hljs-number">3</span>);
  
  <span class="hljs-comment">// 等待所有Promise完成</span>
  <span class="hljs-keyword">const</span> [user1, user2, user3] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([promise1, promise2, promise3]);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"并行结果："</span>, [user1, user2, user3]);
}
</code></pre>
<p>Promise.all()的特性：所有Promise都resolved时，返回resolved结果数组；只要有一个Promise rejected，立即返回该错误，其他结果会被忽略。如果需要"即使部分失败，也要获取所有结果"，可使用Promise.allSettled()。</p>
<h3 data-id="heading-7">2. 处理多个异步操作的竞争关系</h3>
<p>如果需要"多个异步操作中，只要有一个先完成就使用其结果"，可结合<code>Promise.race()</code>与await：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模拟两个不同速度的接口</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchFromServerA</span>(<span class="hljs-params">id</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-string">`A服务器：用户<span class="hljs-subst">${id}</span>`</span>), <span class="hljs-number">800</span>));
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchFromServerB</span>(<span class="hljs-params">id</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-string">`B服务器：用户<span class="hljs-subst">${id}</span>`</span>), <span class="hljs-number">1200</span>));
}

<span class="hljs-comment">// 竞争获取最快的结果</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getFastestResult</span>(<span class="hljs-params">id</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> fastestResult = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([
      <span class="hljs-title function_">fetchFromServerA</span>(id),
      <span class="hljs-title function_">fetchFromServerB</span>(id)
    ]);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"最快结果："</span>, fastestResult); <span class="hljs-comment">// 输出"A服务器：用户1"</span>
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"错误："</span>, error.<span class="hljs-property">message</span>);
  }
}

<span class="hljs-title function_">getFastestResult</span>(<span class="hljs-number">1</span>);
</code></pre>
<h3 data-id="heading-8">3. 异步函数的错误边界处理</h3>
<p>如果有多个独立的await操作，不想因一个错误导致整个函数中断，可给单个await操作单独添加try/catch：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getMultipleUsers</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 单独处理每个请求的错误</span>
  <span class="hljs-keyword">const</span> user1 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-number">1</span>).<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"获取用户1失败："</span>, err.<span class="hljs-property">message</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; <span class="hljs-comment">// 返回默认值，避免后续代码报错</span>
  });
  
  <span class="hljs-keyword">const</span> user2 = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-number">2</span>).<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"获取用户2失败："</span>, err.<span class="hljs-property">message</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
  });
  
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"用户数据："</span>, { user1, user2 }); <span class="hljs-comment">// 即使user2失败，仍能获取user1</span>
}
</code></pre>
<h2 data-id="heading-9">四、常见问题与注意事项</h2>
<h3 data-id="heading-10">1. await只能在async函数中使用</h3>
<p>这是最基础的规则，若在非async函数中使用await，会直接抛出语法错误。例如：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 错误用法：非async函数中使用await</span>
<span class="hljs-function">function <span class="hljs-title">wrongUsage</span>()</span> {
  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> fetchUser(<span class="hljs-number">1</span>); <span class="hljs-comment">// SyntaxError: await is only valid in async functions</span>
}

<span class="hljs-comment">// 正确用法：声明为async函数</span>
<span class="hljs-function"><span class="hljs-keyword">async</span> function <span class="hljs-title">correctUsage</span>()</span> {
  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> fetchUser(<span class="hljs-number">1</span>);
}
</code></pre>
<h3 data-id="heading-11">2. async函数返回值一定是Promise</h3>
<p>无论async函数内部返回什么值，最终都会被包装为Promise对象。即使返回原始值，也需要用then或await获取：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">returnPrimitive</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">"hello async"</span>; <span class="hljs-comment">// 等价于return Promise.resolve("hello async")</span>
}

<span class="hljs-comment">// 必须用then或await获取结果</span>
<span class="hljs-title function_">returnPrimitive</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)); <span class="hljs-comment">// 输出"hello async"</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getResult</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">returnPrimitive</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res); <span class="hljs-comment">// 输出"hello async"</span>
}
</code></pre>
<h3 data-id="heading-12">3. 避免无意识的串行执行</h3>
<p>如前文所述，多个无依赖的await操作若单独书写，会默认串行执行。需记住：<strong>先创建所有Promise实例，再用await等待聚合结果</strong>，避免性能浪费。</p>
<h3 data-id="heading-13">4. 处理未捕获的Promise错误</h3>
<p>如果async函数中的await操作抛出错误，且未被try/catch或.catch()捕获，会导致"未捕获的Promise拒绝"错误。在浏览器中可能触发window的unhandledrejection事件，在Node.js中可能触发process的unhandledRejection事件，严重时会导致程序退出。因此，<strong>所有await操作都必须做好错误处理</strong>。</p>
<h2 data-id="heading-14">五、总结</h2>
<p>async/await作为Promise的语法糖，并非替代Promise，而是让Promise的使用更简洁、更符合人类的同步思维习惯。其核心优势在于：</p>
<ul>
<li>代码结构更清晰，消除了链式调用的嵌套层级；</li>
<li>错误处理更直观，可使用传统的try/catch机制；</li>
<li>调试更方便，断点可直接停留在await处，查看同步执行流程。</li>
</ul>
<p>在实际开发中，我们应熟练掌握async/await的基础用法，并结合Promise.all()、Promise.race()等方法应对不同的异步场景，同时重视错误处理，确保代码的健壮性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 25 个概念彻底看懂SQL多维分析的底层逻辑]]></title>    <link>https://juejin.cn/post/7579934463589629988</link>    <guid>https://juejin.cn/post/7579934463589629988</guid>    <pubDate>2025-12-05T06:53:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579934463589629988" data-draft-id="7579926120096464959" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 25 个概念彻底看懂SQL多维分析的底层逻辑"/> <meta itemprop="keywords" content="后端,SQL,MySQL"/> <meta itemprop="datePublished" content="2025-12-05T06:53:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="却尘"/> <meta itemprop="url" content="https://juejin.cn/user/3389172758899188"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 25 个概念彻底看懂SQL多维分析的底层逻辑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3389172758899188/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    却尘
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T06:53:54.000Z" title="Fri Dec 05 2025 06:53:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;color:#282d36}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px;color:#2f845e}.markdown-body h2{font-size:22px;display:inline-block;font-weight:700;background:#2f845e;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(47,132,194,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 32px);border-bottom:3px solid #2f845e}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%;box-shadow:6px 6px 6px #888}.markdown-body hr{border:none;border-top:1px solid rgba(66,185,131,.15);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:16px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#262626;border:1px solid #2f845e;border-top:8px solid #2f845e;background:linear-gradient(180deg,rgba(66,185,131,.1),transparent)!important}.markdown-body pre&gt;code.hljs[lang]:before{top:8px!important;color:#2f845e!important}.markdown-body pre&gt;code.language-awesome_error{border:1px solid #ff4d4f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ff4d4f!important;background:#fff2f0!important}.markdown-body pre&gt;code.language-awesome_error:before{content:"!"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ff4d4f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_warn{border:1px solid #ffc46f!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#ffc46f!important;background:#fffbe6!important}.markdown-body pre&gt;code.language-awesome_warn:before{content:"☂"!important;position:absolute;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#ffc46f!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_success{border:1px solid #52c41a!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#52c41a!important;background:#f6ffed!important}.markdown-body pre&gt;code.language-awesome_success:before{content:"✓"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#52c41a!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body pre&gt;code.language-awesome_info{border:1px solid #1890ff!important;border-left-width:8px;font-size:14px;font-weight:700;padding:15px 12px 15px 16px;margin:0;word-break:normal;white-space:break-spaces;display:block;overflow-x:auto;color:#1890ff!important;background:#e6f7ff!important}.markdown-body pre&gt;code.language-awesome_info:before{content:"i"!important;position:absolute!important;top:50%!important;left:-9px!important;transform:translateY(-14px)!important;background:#1890ff!important;color:#fff!important;border:2px solid #fff!important;display:flex;align-items:center;justify-content:center;width:22px;height:22px;border-radius:100%;font-weight:700;font-family:Dosis,Source Sans Pro,Helvetica Neue,Arial,sans-serif;font-size:16px}.markdown-body strong{background-color:inherit;color:#2f845e}.markdown-body em{background-color:inherit;color:#949415}.markdown-body a{text-decoration:none;color:#2f8e54;border-bottom:1px solid #3f9e64}.markdown-body a:active,.markdown-body a:hover{color:#3f9e64}.markdown-body a[class^=footnote]{margin-left:4px}.markdown-body a:before{content:"➤ "}.markdown-body table{font-size:12px;width:100%;max-width:100%;overflow:auto;border:2px solid #2f8e54}.markdown-body thead{background:#2f8e54;color:#fff;text-align:left;font-weight:700}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:22px}.markdown-body td{min-width:120px}.markdown-body blockquote{padding:1px 22px;margin:22px 0;border-left:6px solid #2f845e;background-color:rgba(66,185,131,.1);border-radius:2px}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#2f845e}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px;color:#282d36}.markdown-body del{color:#2f845e}.markdown-body input[type=checkbox]:checked:before{content:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAA/klEQVQ4T72TMU7DQBBF318XdFR06egQEnAXRINEGlqgowoIR8AF4AZOZ4JEGq5AC5EixBU4A55BNrEVHAcSBTHlaubt37/zxZKlcn7n6mDPXJvz8IJ89HzWu8t7C8D2dfsY52ae4apHnLx0ktsCsHXZjiUuFgG40x2eJ/H/AhztB+zDUTpLwWj8jGkzxSHiHaMPrDQC8sMoilKzLAUqiKQjmb+ZuAdW80tmelCHODoNgSfP7AFprTTaRTzsJN1GEyuIZ7uW6TEEHwCtyV/6EVBKJHhfzgC0Xv/iXwEFBF4FG0378bd7sPQq5xK/hSnk6sdlX3mZrKkwLZKBeu8n9XuWEUE7X+YAAAAASUVORK5CYII=);position:relative;top:-1px;left:-1px}.markdown-body .math .katex{font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#f6ffed;color:#52c41a;font-size:.87em;padding:.065em .4em}@media (max-width:720px){.markdown-body h1{font-size:22px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当你第一次写 SQL 时，你可能觉得它不过是“查数据的工具”。<br/>
但当你第一次要面对真实业务里的报表需求，比如：</p>
<ul>
<li>用户维度统计</li>
<li>产品维度统计</li>
<li>日期维度统计</li>
<li>层级汇总（天 → 月 → 年）</li>
<li>多维交叉分析（如按照区域 × 产品统计收入）</li>
<li>行级趋势分析（环比、同比、累计、排名）</li>
<li>与维度表拼接构建完整事实</li>
<li>多张结果集合并</li>
<li>一条 SQL 逻辑拆成模块化结构</li>
<li>以及最后的性能优化……</li>
</ul>
<p>你才会意识到一件事：</p>
<blockquote>
<p><strong>GG，我的SQL没学好</strong></p>
</blockquote>
<h2 data-id="heading-0">一、问题起点：从一张简单的 orders 表开始</h2>
<p>假设你有一张订单表：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">orders</span>(order_id, user_id, product, amount, date)
</code></pre>
<p>老板问你一个最简单的问题：</p>
<blockquote>
<p>“每个用户一共花了多少钱？”</p>
</blockquote>
<p>于是你写下 SQL 世界的第一条聚合：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> user_id, <span class="hljs-built_in">SUM</span>(amount)
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> user_id;
</code></pre>
<p>恭喜，<strong>Group By</strong> 出现了。</p>
<p>但这只是开始。</p>
<h2 data-id="heading-1">二、当用户维度不够，你开始进入“多维度聚合”世界</h2>
<p>老板继续问：</p>
<blockquote>
<p>“那按日期算呢？比如每天收入多少？”</p>
</blockquote>
<p>于是你又写：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-type">date</span>, <span class="hljs-built_in">SUM</span>(amount)
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-type">date</span>;
</code></pre>
<p>看起来很正常，对吧？<br/>
但是你的脑子里出现一个念头：</p>
<blockquote>
<p>“为什么我要写两条 SQL？能不能一次搞定？”</p>
</blockquote>
<p>很好，这就是进入“多维聚合”的契机。</p>
<h2 data-id="heading-2">三、当你想「一次聚合多个维度」，GROUPING SETS 就出现了</h2>
<p>你想把这三种结果一次性算出来：</p>
<ol>
<li>按 user 聚合</li>
<li>按 product 聚合</li>
<li>全表总额</li>
</ol>
<p>如果用传统写法，你需要 3 条 SQL。<br/>
但 SQL 提供了更优雅的写法：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> user_id, product, <span class="hljs-built_in">SUM</span>(amount)
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">GROUPING</span> SETS (
    (user_id),
    (product),
    ()
);
</code></pre>
<p>这里出现了几个重要的知识点：</p>
<h4 data-id="heading-3"><strong>✔ 什么是 "()"？</strong></h4>
<p>表示“无维度聚合”，也就是全表总和。</p>
<h4 data-id="heading-4"><strong>✔ 为什么 GROUPING SETS 重要？</strong></h4>
<p>因为任何 BI 系统的核心，就是对数据做多维切片。<br/>
GROUPING SETS 正是 SQL 世界里实现多维切片的原语。</p>
<p>你会逐渐理解：</p>
<blockquote>
<p><strong>只要聚合维度不止一个，就进入多维分析领域。</strong></p>
</blockquote>
<h2 data-id="heading-5">四、当维度有层级关系，你需要 ROLLUP</h2>
<p>老板提出新需求了：</p>
<blockquote>
<p>“给我看每个月的销售额。<br/>
再给我看每年的总额。<br/>
最后给我一个所有数据的总结。”</p>
</blockquote>
<p>你可能会写三层 GROUP BY，但是，不优雅、容易出错、重复逻辑</p>
<p>幸亏，SQL 已经有现成的解决方案：<strong>ROLLUP</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">year</span>, <span class="hljs-keyword">month</span>, <span class="hljs-built_in">SUM</span>(amount)
<span class="hljs-keyword">FROM</span> sales
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">ROLLUP</span> (<span class="hljs-keyword">year</span>, <span class="hljs-keyword">month</span>);
</code></pre>
<p>ROLLUP 会自动生成三类行：</p>
<ol>
<li>(年, 月) → 明细</li>
<li>(年, NULL) → 年度总额</li>
<li>(NULL, NULL) → 全局总额</li>
</ol>
<p>也就是说：</p>
<blockquote>
<p><strong>ROLLUP = 顺着层级逐层往上汇总。</strong></p>
</blockquote>
<p>这个能力在：</p>
<ul>
<li>日期层级（天 → 月 → 季 → 年）</li>
<li>地区层级（城市 → 省份 → 国家）</li>
<li>组织层级（部门 → BU → 公司）</li>
</ul>
<h2 data-id="heading-6">五、当维度不仅有层级还有组合，你需要 CUBE</h2>
<p>老板说：</p>
<blockquote>
<p>“按区域 + 产品看销量，同时还要：<br/>
区域汇总、产品汇总、全部汇总。”</p>
</blockquote>
<p>这就是典型的二维分析表。</p>
<p>SQL 里一句话：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> region, product, <span class="hljs-built_in">SUM</span>(amount)
<span class="hljs-keyword">FROM</span> sales
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">CUBE</span>(region, product);
</code></pre>
<p>CUBE 会生成：</p>
<ul>
<li>(region, product)</li>
<li>(region, NULL)</li>
<li>(NULL, product)</li>
<li>(NULL, NULL)</li>
</ul>
<p>换句话说：</p>
<blockquote>
<p><strong>CUBE = 构建一个完整的 OLAP 多维立方体。</strong></p>
</blockquote>
<h2 data-id="heading-7">六、当 SQL 越写越长，你必须学会 CTE（WITH）</h2>
<p>你发现三件事：</p>
<ol>
<li>多维聚合越来越多</li>
<li>中间逻辑必须拆步骤</li>
<li>代码如果不拆，会像屎山一样越堆越乱</li>
</ol>
<p>于是 CTE 出现了：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">WITH</span> user_sum <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span> user_id, <span class="hljs-built_in">SUM</span>(amount) <span class="hljs-keyword">AS</span> total
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> user_id
),
product_sum <span class="hljs-keyword">AS</span> (
    <span class="hljs-keyword">SELECT</span> product, <span class="hljs-built_in">SUM</span>(amount) <span class="hljs-keyword">AS</span> total
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> product
)
<span class="hljs-keyword">SELECT</span> ...
</code></pre>
<p>CTE 的真正意义不是“功能”，而是：</p>
<blockquote>
<p><strong>把不可读的 SQL 拆成可读的结构化模块。</strong></p>
</blockquote>
<p>它让：</p>
<ul>
<li>复杂 SQL 更好维护</li>
<li>逻辑更清晰</li>
<li>难度降低一个量级</li>
</ul>
<h2 data-id="heading-8">七、当你需要补全信息，JOIN 是必修课</h2>
<p>比如订单表里只有 user_id，想知道用户名称：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> o.<span class="hljs-operator">*</span>, u.name
<span class="hljs-keyword">FROM</span> orders o
<span class="hljs-keyword">JOIN</span> users u <span class="hljs-keyword">ON</span> o.user_id <span class="hljs-operator">=</span> u.id;
</code></pre>
<p>JOIN 的意义是什么？</p>
<blockquote>
<p><strong>事实表（orders）只记录“发生了什么”，维度表（users）补充“是谁”。</strong></p>
</blockquote>
<p>如果想保留所有用户（即使没订单）：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span>
</code></pre>
<p>如果要表达自身内部关系（例如员工 → 上级）：</p>
<pre><code class="hljs language-sql" lang="sql">employees e1 <span class="hljs-keyword">JOIN</span> employees e2
</code></pre>
<p>JOIN 本质就是构建：</p>
<blockquote>
<p><strong>一个完整的业务语义模型。</strong></p>
</blockquote>
<p>没有 JOIN，就没有可理解的数据世界。</p>
<h2 data-id="heading-9">八、当你需要“每一行都继续分析”，窗口函数是最强的武器</h2>
<p>窗口函数是 SQL 的进阶门槛。<br/>
当 GROUP BY 解决不了问题时，就是它出场的时候。</p>
<p>例如：<br/>
老板问：</p>
<blockquote>
<p>“用户内部按订单金额排序。”</p>
</blockquote>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-built_in">ROW_NUMBER</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> user_id <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> amount <span class="hljs-keyword">DESC</span>)
</code></pre>
<p>想看每天销售额的累计曲线：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-built_in">SUM</span>(amount) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-type">date</span>)
</code></pre>
<p>想做环比分析：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-built_in">LAG</span>(amount) <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-type">date</span>)
</code></pre>
<p>窗口函数的核心特性：</p>
<blockquote>
<p><strong>不改变行数，但为每行增加分析能力。</strong></p>
</blockquote>
<p>这是做趋势分析、排名分析、同比/环比的必备工具。</p>
<h2 data-id="heading-10">九、当你开始构建报表体系，你会遇到数据建模</h2>
<p>到这里你会自然感受到：</p>
<ul>
<li>orders 是事实表</li>
<li>users/products/date 是维度表</li>
<li>JOIN 是事实和维度的桥梁</li>
<li>ROLLUP/CUBE 是 OLAP 的 SQL 实现</li>
</ul>
<p>而星型模型长这样：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-code">        dim_user
            │
dim_product ─── fact_order ─── dim_date
            │
        dim_region
</span></code></pre>
<p>这不是“技术概念”，而是你每天写 SQL 的真实结构。</p>
<p>你可能会突然明白：</p>
<blockquote>
<p>原来我的 SQL 一直在做 OLAP，只是我不知道。</p>
</blockquote>
<h2 data-id="heading-11">十、优化</h2>
<p>最基本的优化手段只有三件：</p>
<h4 data-id="heading-12"><strong>1. 用 EXPLAIN 看数据库是怎么执行的</strong></h4>
<pre><code class="hljs language-sql" lang="sql">EXPLAIN <span class="hljs-keyword">SELECT</span> ...
</code></pre>
<p>它告诉你：</p>
<ul>
<li>是否走索引</li>
<li>是否做全表扫描</li>
<li>是否正确过滤</li>
</ul>
<h4 data-id="heading-13"><strong>2. 给常用字段建立索引</strong></h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> INDEX idx_user <span class="hljs-keyword">ON</span> orders(user_id);
</code></pre>
<p>JOIN、WHERE、GROUP BY 都依赖索引。</p>
<h4 data-id="heading-14"><strong>3. 理解过滤下推（Predicate Pushdown）</strong></h4>
<p>即使你这么写：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders
) t
<span class="hljs-keyword">WHERE</span> amount <span class="hljs-operator">&gt;</span> <span class="hljs-number">100</span>;
</code></pre>
<p>数据库依然会优化为：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> amount <span class="hljs-operator">&gt;</span> <span class="hljs-number">100</span>;
</code></pre>
<p>你知道数据库的这层智能，就能写得更放心。</p>
<h2 data-id="heading-15">结语</h2>
<p>如果你把整个逻辑压缩成一条线，会是这样的：</p>
<ol>
<li>GROUP BY</li>
<li>多维聚合</li>
<li>GROUPING SETS</li>
<li>ROLLUP</li>
<li>CUBE</li>
<li>CTE 做结构化</li>
<li>JOIN 建语义</li>
<li>窗口函数做分析</li>
<li>事实表/维度表做建模</li>
<li>EXPLAIN + 索引做性能</li>
</ol>
<p>SQL学好对于后端来说还是很重要的，因为：</p>
<blockquote>
<p><strong>真实业务分析 SQL 从简单到复杂的自然演化规律。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue3+vite+electron 构建项目实例]]></title>    <link>https://juejin.cn/post/7579946275435888650</link>    <guid>https://juejin.cn/post/7579946275435888650</guid>    <pubDate>2025-12-05T06:49:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579946275435888650" data-draft-id="7579921879973363758" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue3+vite+electron 构建项目实例"/> <meta itemprop="keywords" content="Electron"/> <meta itemprop="datePublished" content="2025-12-05T06:49:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="晚灯映花正开"/> <meta itemprop="url" content="https://juejin.cn/user/2911162523463351"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue3+vite+electron 构建项目实例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2911162523463351/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    晚灯映花正开
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T06:49:05.000Z" title="Fri Dec 05 2025 06:49:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、创建项目</h2>
<p>打开Powershell窗口输入
npm create vite@latest electron-app</p>
<h2 data-id="heading-1">二、添加依赖</h2>
<p>依赖安装的时候可能超时而中断可以用以下方法进行解决。</p>
<blockquote>
<p>在创建好的文件electron-app下建立一个 .npmrc 的文件（注：.npmrc文件可用vscode创建，在当前项目打开vscode中端输入code .npmrc）</p>
</blockquote>
<p>然后再npmrc文件里输入</p>
<blockquote>
<p>strict-ssl=false
registry=<a href="https://link.juejin.cn?target=https%3A%2F%2Fregistry.npmmirror.com%2F" target="_blank" title="https://registry.npmmirror.com/" ref="nofollow noopener noreferrer">registry.npmmirror.com/</a>
electron_mirror=<a href="https://link.juejin.cn?target=https%3A%2F%2Fregistry.npmmirror.com%2F-%2Fbinary%2Felectron%2F" target="_blank" title="https://registry.npmmirror.com/-/binary/electron/" ref="nofollow noopener noreferrer">registry.npmmirror.com/-/binary/el…</a>
electron_builder_binaries_mirror=<a href="https://link.juejin.cn?target=https%3A%2F%2Fregistry.npmmirror.com%2F-%2Fbinary%2Felectron-builder-binaries%2F" target="_blank" title="https://registry.npmmirror.com/-/binary/electron-builder-binaries/" ref="nofollow noopener noreferrer">registry.npmmirror.com/-/binary/el…</a></p>
<p>#ELECTRON_BUILDER_BINARIES_MIRROR=<a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.huaweicloud.com%2Felectron-builder-binaries%2F" target="_blank" title="https://mirrors.huaweicloud.com/electron-builder-binaries/" ref="nofollow noopener noreferrer">mirrors.huaweicloud.com/electron-bu…</a></p>
</blockquote>
<p>然后开始安装下面的依赖</p>
<blockquote>
<p>npm install -D electron    #主依赖</p>
<p>npm install -D electron-builder #打包依赖(打包为可安装的exe或免安装exe)</p>
<p>npm install -D electron-devtools-installer #开发调试</p>
<p>npm install -D vite-plugin-electron #vite构建electron应用</p>
</blockquote>
<h2 data-id="heading-2">三、创建主进程</h2>
<p>在当前目录下创建创建 src-electron文件夹，在src-electron文件夹下创建main.js文件。输入以下内容</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// src-electron/main.js</span>
<span class="hljs-keyword">const</span> { app, <span class="hljs-title class_">BrowserWindow</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'electron'</span>)
<span class="hljs-keyword">const</span> { join } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
<span class="hljs-comment">// 屏蔽安全警告</span>
<span class="hljs-comment">// ectron Security Warning (Insecure Content-Security-Policy)</span>
process.<span class="hljs-property">env</span>[<span class="hljs-string">'ELECTRON_DISABLE_SECURITY_WARNINGS'</span>] = <span class="hljs-string">'true'</span>

<span class="hljs-comment">// 创建浏览器窗口时，调用这个函数。</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">createWindow</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> win = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BrowserWindow</span>({
        <span class="hljs-attr">width</span>: <span class="hljs-number">800</span>,
        <span class="hljs-attr">height</span>: <span class="hljs-number">600</span>,
        <span class="hljs-comment">//如果不添加，则使用的是默认的图标</span>
        <span class="hljs-attr">icon</span>: <span class="hljs-title function_">join</span>(__dirname,<span class="hljs-string">'../public/favicon.ico'</span>),
        <span class="hljs-attr">title</span>:<span class="hljs-string">'lvmabna'</span>
    })

    <span class="hljs-comment">// win.loadURL('http://localhost:3000')</span>
    <span class="hljs-comment">// development模式</span>
    <span class="hljs-keyword">if</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_DEV_SERVER_URL</span>) {
        win.<span class="hljs-title function_">loadURL</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_DEV_SERVER_URL</span>)
        <span class="hljs-comment">// 开启调试台</span>
        win.<span class="hljs-property">webContents</span>.<span class="hljs-title function_">openDevTools</span>()
    }<span class="hljs-keyword">else</span> {
        win.<span class="hljs-title function_">loadFile</span>(<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">'../dist/index.html'</span>))
    }
}

<span class="hljs-comment">// Electron 会在初始化后并准备</span>
app.<span class="hljs-title function_">whenReady</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">createWindow</span>()
    app.<span class="hljs-title function_">on</span>(<span class="hljs-string">'activate'</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">BrowserWindow</span>.<span class="hljs-title function_">getAllWindows</span>().<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) <span class="hljs-title function_">createWindow</span>()
    })
})

app.<span class="hljs-title function_">on</span>(<span class="hljs-string">'window-all-closed'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (process.<span class="hljs-property">platform</span> !== <span class="hljs-string">'darwin'</span>) app.<span class="hljs-title function_">quit</span>()
})
</code></pre>
<h2 data-id="heading-3">四、配置入口文件</h2>
<p>在vite.config.ts 文件中</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { fileURLToPath, <span class="hljs-variable constant_">URL</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:url'</span>

<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>
<span class="hljs-keyword">import</span> vueJsx <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue-jsx'</span>
<span class="hljs-keyword">import</span> electron <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-electron'</span>   <span class="hljs-comment">//增加</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">vue</span>(),
    <span class="hljs-title function_">vueJsx</span>(),
    <span class="hljs-comment">//增加electron</span>
    <span class="hljs-title function_">electron</span>({ 
      <span class="hljs-comment">// 主进程入口文件</span>
      <span class="hljs-attr">entry</span>: <span class="hljs-string">'./src-electron/main.js'</span>
  })
  ],
  <span class="hljs-comment">//配置端口</span>
  <span class="hljs-attr">server</span>:{
    <span class="hljs-attr">port</span>:<span class="hljs-number">3000</span>,
  },
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-attr">alias</span>: {
      <span class="hljs-string">'@'</span>: <span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">'./src'</span>, <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>))
    }
  }
})

</code></pre>
<h2 data-id="heading-4">五、配置package.json</h2>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-comment">/*
  界面的 title设置三种方法
  1、默认使用的是项目的入口文件index.html中的title，可以在这里修改。
  2、也可以把index.html中的title给删除掉，则读取是下面的name值。
  3、也可以在src-electron/main.js中 new BrowserWindow(...title:'lvmabna')这个函数中添加
  */</span>
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"electron-desktop-tool"</span>,
  <span class="hljs-string">"version"</span>: <span class="hljs-string">"0.0.0"</span>,
  <span class="hljs-string">"private"</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-comment">//"type": "module",   //把这行删除掉，新增下面一行</span>
  <span class="hljs-string">"main"</span>: <span class="hljs-string">"./src-electron/main.js"</span>,  <span class="hljs-comment">//新增</span>
  ...
}
</code></pre>
<h2 data-id="heading-5">六、启动项目</h2>
<p>npm run dev</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e645da059ed41a78bd185b4466fb6c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pma54Gv5pig6Iqx5q2j5byA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765522144&amp;x-signature=trML9OZ0GGjxyYBnsvuWarJavYA%3D" alt="aaa.png" loading="lazy"/></p>
<h2 data-id="heading-6">七、打包</h2>
<h3 data-id="heading-7">1、配置 package.json</h3>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"dev"</span>: <span class="hljs-string">"vite"</span>,
    <span class="hljs-string">"build"</span>: <span class="hljs-string">"run-p type-check \"build-only {@}\" --"</span>,
    <span class="hljs-string">"preview"</span>: <span class="hljs-string">"vite preview"</span>,
    <span class="hljs-string">"build-only"</span>: <span class="hljs-string">"vite build"</span>,
    <span class="hljs-string">"type-check"</span>: <span class="hljs-string">"vue-tsc --build --force"</span>,
    <span class="hljs-string">"electron:build"</span>: <span class="hljs-string">"vite build &amp;&amp; electron-builder"</span>   <span class="hljs-comment">//新增</span>
  },
....
  <span class="hljs-comment">//新增一个 build属性对象,里面主要配置打包的信息</span>
  <span class="hljs-string">"build"</span>: {
    <span class="hljs-string">"productName"</span>: <span class="hljs-string">"ElectronDeskTopTool"</span>,
    <span class="hljs-string">"appId"</span>: <span class="hljs-string">"dyy.dongyuanwai"</span>,
    <span class="hljs-string">"copyright"</span>: <span class="hljs-string">"dyy.dongyuanwai © 2024"</span>,
    <span class="hljs-string">"compression"</span>: <span class="hljs-string">"maximum"</span>,
    <span class="hljs-string">"asar"</span>: <span class="hljs-literal">true</span>, 
    <span class="hljs-string">"directories"</span>: {
      <span class="hljs-string">"output"</span>: <span class="hljs-string">"release/"</span> <span class="hljs-comment">// 输出目录</span>
    },
    <span class="hljs-string">"nsis"</span>: {
      <span class="hljs-string">"oneClick"</span>: <span class="hljs-literal">false</span>,<span class="hljs-comment">// 是否一键安装</span>
      <span class="hljs-string">"allowToChangeInstallationDirectory"</span>: <span class="hljs-literal">true</span>,<span class="hljs-comment">// 允许修改安装目录</span>
      <span class="hljs-string">"perMachine"</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-string">"deleteAppDataOnUninstall"</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-string">"createDesktopShortcut"</span>: <span class="hljs-literal">true</span>,<span class="hljs-comment">// 创建桌面图标</span>
      <span class="hljs-string">"createStartMenuShortcut"</span>: <span class="hljs-literal">true</span>,<span class="hljs-comment">// 创建开始菜单图标</span>
      <span class="hljs-string">"shortcutName"</span>: <span class="hljs-string">"ElectronDeskTopTool"</span>
    },
    <span class="hljs-string">"win"</span>: {
      <span class="hljs-string">"icon"</span>: <span class="hljs-string">"./public/logo.ico"</span>,<span class="hljs-comment">// 安装图标</span>
      <span class="hljs-string">"artifactName"</span>: <span class="hljs-string">"${productName}-v${version}-${platform}-setup.${ext}"</span>,<span class="hljs-comment">//安装包名称</span>
      <span class="hljs-string">"target"</span>: [
        {
          <span class="hljs-string">"target"</span>: <span class="hljs-string">"nsis"</span>
        }
      ]
    },
    <span class="hljs-string">"mac"</span>: {
      <span class="hljs-string">"icon"</span>: <span class="hljs-string">"./public/logo.ico"</span>,
      <span class="hljs-string">"artifactName"</span>: <span class="hljs-string">"${productName}-v${version}-${platform}-setup.${ext}"</span>
    },
    <span class="hljs-string">"linux"</span>: {
      <span class="hljs-string">"icon"</span>: <span class="hljs-string">"./public/logo.ico"</span>,
      <span class="hljs-string">"artifactName"</span>: <span class="hljs-string">"${productName}-v${version}-${platform}-setup.${ext}"</span>
    }
  },
}

</code></pre>
<p>build更多设置</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 打包的配置都放到 build里</span>
<span class="hljs-string">"build"</span>: {  
    <span class="hljs-string">"productName"</span>:<span class="hljs-string">"ElectronDeskTopTool"</span>,<span class="hljs-comment">//项目名 这也是生成的exe文件的前缀名，也可以在每个环境中自行配置</span>
    <span class="hljs-string">"appId"</span>: <span class="hljs-string">"com.dyy.dongyuanwai"</span>,<span class="hljs-comment">//应用程序的唯一标识符，通常是反转的域名格式 </span>
    <span class="hljs-string">"copyright"</span>:<span class="hljs-string">"dyy.dongyuanwai © 2024"</span>,<span class="hljs-comment">//版权信息，显示在应用程序中说明版权归属的地方</span>
    <span class="hljs-string">"compression"</span>: <span class="hljs-string">"maximum"</span>, <span class="hljs-comment">//压缩级别，指定打包时使用的压缩级别。这里设置为"maximum"表示最大压缩</span>
    <span class="hljs-string">"asar"</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否启用 asar 打包，asar 是 Electron 提供的一种文件打包方式，能够提高应用程序的性能和安全性。</span>
    <span class="hljs-string">"directories"</span>: { <span class="hljs-comment">//指定输出目录，打包完成后的文件会放置在该目录下。</span>
      <span class="hljs-string">"output"</span>: <span class="hljs-string">"release"</span>
    }, 
    <span class="hljs-comment">// windows相关的配置</span>
    <span class="hljs-string">"win"</span>: {  
      <span class="hljs-string">"icon"</span>: <span class="hljs-string">"xxx/icon.ico"</span>, <span class="hljs-comment">//图标路径 </span>
      <span class="hljs-string">"artifactName"</span>: <span class="hljs-string">"${productName}-v${version}-${platform}-setup.${ext}"</span> <span class="hljs-comment">// 安装包名称</span>
    }，
     <span class="hljs-comment">// 这个意思是打出来32 bit + 64 bit的包，但是要注意：这样打包出来的安装包体积比较大，所以建议直接打32的安装包。</span>
      <span class="hljs-string">"arch"</span>: [
          <span class="hljs-string">"x64"</span>,
          <span class="hljs-string">"ia32"</span>
        ]
  }

</code></pre>
<h3 data-id="heading-8">2、win打包</h3>
<p>npm run electron:build</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d96a6bfbd4d54f318785846896dd082d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pma54Gv5pig6Iqx5q2j5byA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765522144&amp;x-signature=r4K4gGVMXf8KUD5I2c8GfBVgB1M%3D" alt="bbb.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift中Package Manager的使用]]></title>    <link>https://juejin.cn/post/7579920818870861866</link>    <guid>https://juejin.cn/post/7579920818870861866</guid>    <pubDate>2025-12-05T06:53:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579920818870861866" data-draft-id="7579849892614930468" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift中Package Manager的使用"/> <meta itemprop="keywords" content="Swift"/> <meta itemprop="datePublished" content="2025-12-05T06:53:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="崽崽长肉肉"/> <meta itemprop="url" content="https://juejin.cn/user/993614240687117"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift中Package Manager的使用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614240687117/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    崽崽长肉肉
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T06:53:00.000Z" title="Fri Dec 05 2025 06:53:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">Swift中Package Manager的使用</h3>
<h4 data-id="heading-1">一、Package文件构成</h4>
<p>Swift Package Manager简称SPM是苹果官方为swift语言提供的强大的依赖管理工具。能够自动化地处理包的依赖下载、编译、链接和管理。</p>
<p><strong>Products</strong>：在包中的每个target最终都可能构建成一个Library或者一个execute作为product，这是package编译后的产物，</p>
<p><strong>Target</strong>：构建单元，包含一组源代码文件，可以是一个库，可执行文件等。可依赖其他目标，如library、executable。一个package可以包含多个target</p>
<p><strong>Dependencies</strong>：package所依赖的其他package，SPM会自动下载并解析这些依赖，确保项目的所有库都能正确构建。</p>
<p><strong>Tool Version</strong>：最低支持的Swift工具链版本。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89bf05c8a1524e87bd5d6a2b856b29a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bS95bS96ZW_6IKJ6IKJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765522379&amp;x-signature=GtFBLTY0f%2BiZ6%2FtA%2FH1sIBKg15o%3D" alt="img" loading="lazy"/></p>
<h4 data-id="heading-2">二、<strong>SPM的优点</strong></h4>
<p>对比Cocoapods，SPM具有以下优点。</p>
<ul>
<li>无需安装，Xcode11以上版本自带</li>
<li>苹果官方维护，不用担心和Cocoapods一样停止维护</li>
<li>安装第三方库的时候比Cocoapods快(依赖源在github，有些要翻墙)</li>
<li>使用SPM构建时比Cocoapods快</li>
</ul>
<h4 data-id="heading-3">三、<strong>SPM缺点</strong></h4>
<ul>
<li>每次打开App 都会重新拉取 所有依赖的库</li>
<li>更新时间长(访问github 还需要进行科学上网)</li>
<li>支持文档少，</li>
<li>远端仓库对网络要求高</li>
</ul>
<h4 data-id="heading-4">四、创建Package的两种方式：</h4>
<h5 data-id="heading-5">1、常用命令：</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> SwiftPackageTest <span class="hljs-comment"># 生成的Package的名称</span>
<span class="hljs-built_in">cd</span> SwiftPackageTest
swift package init --<span class="hljs-built_in">type</span> library       <span class="hljs-comment"># 初始化库包</span>
swift build                              <span class="hljs-comment"># 构建</span>
swift <span class="hljs-built_in">test</span>                               <span class="hljs-comment"># 运行测试</span>
swift run &lt;executable-target&gt;            <span class="hljs-comment"># 运行可执行目标</span>
swift package resolve                    <span class="hljs-comment"># 解析依赖</span>
swift package update                     <span class="hljs-comment"># 更新依赖</span>
</code></pre>
<h5 data-id="heading-6">基本使用</h5>
<p>通过命令可以快速</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建一个库包</span>
swift package init --name MyLib --<span class="hljs-built_in">type</span> library
​
<span class="hljs-comment"># 创建一个可执行包</span>
swift package init --name MyLib --<span class="hljs-built_in">type</span> executable
​
</code></pre>
<p>这将在当前目录生成一个标准的库包结构：</p>
<pre><code class="hljs">MyLib/
├── Sources/
│   └── MyLib/
│       └── MyLib.swift
├── Tests/
│   └── MyLibTests/
│       └── MyLibTests.swift
└── Package.swift
​
</code></pre>
<p><code>Package.swift</code>清单文件的内容通常如下：</p>
<pre><code class="hljs">​
</code></pre>
<h5 data-id="heading-7">MyLib.swift文件</h5>
<p>Sources目录是实现代码的存放位置，<code>MyLib.swift</code>一般作为程序的入口，用于处理命令行参数并调用核心功能。</p>
<p>构建和测试</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编译包</span>
swift build
​
<span class="hljs-comment"># 运行测试</span>
swift <span class="hljs-built_in">test</span>
​
<span class="hljs-comment"># 运行包</span>
swift run
​
</code></pre>
<h5 data-id="heading-8">2、使用Xcode界面创建</h5>
<p>Xcode—&gt; 工具栏File—&gt;New—&gt;Package—&gt;Libary</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b47f87e4bc0a45a29bad0dd48cae467b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bS95bS96ZW_6IKJ6IKJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765522379&amp;x-signature=31aoiVE1RrzIylhckuF9saBakME%3D" alt="QQ_1764917428650.png" loading="lazy"/></p>
<h4 data-id="heading-9">五、Package的配置</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// swift-tools-version:6.0</span>
<span class="hljs-comment">// The swift-tools-version declares the minimum version of Swift required to build this package.</span>
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">PackageDescription</span>
​
<span class="hljs-selector-tag">let</span> <span class="hljs-selector-tag">package</span> = <span class="hljs-selector-tag">Package</span>(
    <span class="hljs-attribute">name</span>: <span class="hljs-string">"MyLib"</span>,
    <span class="hljs-attribute">platforms</span>: [.<span class="hljs-built_in">iOS</span>(.v18), .<span class="hljs-built_in">macOS</span>(.v15)], <span class="hljs-comment">// 指定包所支持的平台和最低版本</span>
    <span class="hljs-attribute">products</span>: [
        .<span class="hljs-built_in">library</span>(<span class="hljs-attribute">name</span>: <span class="hljs-string">"MyLib"</span>, <span class="hljs-attribute">targets</span>: [<span class="hljs-string">"MyLib"</span>]) <span class="hljs-comment">// 指编译后的包，对外提供</span>
    ],
    <span class="hljs-attribute">dependencies</span>: [ <span class="hljs-comment">// 声明此包所依赖的外部包</span>
        .<span class="hljs-built_in">package</span>(<span class="hljs-attribute">url</span>: <span class="hljs-string">"https://github.com/Alamofire/Alamofire.git"</span>, <span class="hljs-attribute">from</span>: <span class="hljs-string">"5.8.0"</span>)
    ],
    <span class="hljs-attribute">targets</span>: [ <span class="hljs-comment">// 定义包的相关信息</span>
        .<span class="hljs-built_in">target</span>(
            <span class="hljs-attribute">name</span>: <span class="hljs-string">"MyLib"</span>,
            <span class="hljs-attribute">dependencies</span>: [<span class="hljs-string">"Alamofire"</span>],
            <span class="hljs-attribute">resources</span>: [.<span class="hljs-built_in">process</span>(<span class="hljs-string">"Resources"</span>)]
        ),
        .<span class="hljs-built_in">testTarget</span>(
            <span class="hljs-attribute">name</span>: <span class="hljs-string">"MyLibTests"</span>,
            <span class="hljs-attribute">dependencies</span>: [<span class="hljs-string">"MyLib"</span>]
        )
    ]
)
​
</code></pre>
<ul>
<li>
<p>name: Swift包的名字，或者‘ nil ’使用包的Git URL来推断名字。</p>
</li>
<li>
<p>defaultLocalization：资源的默认本地化。</p>
</li>
<li>
<p>platforms：具有自定义部署目标的受支持平台列表。</p>
<ul>
<li>支持的平台和对应的系统版本</li>
</ul>

<ul>
<li>platforms:[</li>
</ul>

<ul>
<li>.macOS(.v11), .iOS(.v12),.tvOS(.v12)</li>
</ul>

<ul>
<li>]</li>
</ul>
</li>
</ul>

<ul>
<li>
<p>pkgConfig: C模块的名称。如果存在，Swift包管理器会搜索 &lt;名称&gt;。获取系统目标所需的附加标志。</p>
</li>
<li>
<p>providers：系统目标的包提供程序。</p>
</li>
<li>
<p>products：此包提供给客户使用的产品列表。</p>
<p>编译后的产物一般分为两种 可执行文件 静态库或动态库</p>
</li>
</ul>

<ul>
<li>dependencies：包依赖列表。</li>
</ul>

<ul>
<li>
<p>添加依赖的包，一般指向包源的git路径和版本环境，或者包依赖的本地路径</p>
</li>
<li>
<p>依赖包的添加支持以下五种方式</p>
<ul>
<li>git源 + 确定的版本号</li>
<li>git源 + 版本区间</li>
<li>git源 + commit号</li>
<li>git源 + 分支名</li>
<li>本地路径</li>
</ul>
</li>
</ul>

<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-class">.package</span>(<span class="hljs-attribute">url</span>: <span class="hljs-string">"https://github.com/Alamofire/Alamofire.git"</span>, .<span class="hljs-built_in">exact</span>(<span class="hljs-string">"1.2.3"</span>)),
<span class="hljs-selector-class">.package</span>(<span class="hljs-attribute">url</span>:<span class="hljs-string">"https://github.com/Alamofire/Alamofire.git"</span>, .<span class="hljs-built_in">branch</span>(<span class="hljs-string">"master"</span>)),
<span class="hljs-selector-class">.package</span>(<span class="hljs-attribute">url</span>:<span class="hljs-string">"https://github.com/Alamofire/Alamofire.git"</span>, <span class="hljs-attribute">from</span>: <span class="hljs-string">"1.2.3"</span>),
<span class="hljs-selector-class">.package</span>(<span class="hljs-attribute">url</span>:<span class="hljs-string">"https://github.com/Alamofire/Alamofire.git"</span>,.<span class="hljs-built_in">revision</span>(<span class="hljs-string">"e74b07278b926c9ec6f9643455ea00d1ce04a021"</span>),
.<span class="hljs-built_in">package</span>(<span class="hljs-attribute">url</span>: <span class="hljs-string">"https://github.com/Alamofire/Alamofire.git"</span>, <span class="hljs-string">"1.2.3"</span>...<span class="hljs-string">"4.1.3"</span>),
.<span class="hljs-built_in">package</span>(<span class="hljs-attribute">path</span>: <span class="hljs-string">"../Foo"</span>),
</code></pre>
<ul>
<li>targets：作为这个包的一部分的目标列表。</li>
</ul>

<ul>
<li>
<p>target是Package的基本构建，和xcodeproject一样，Package可以有多个target</p>
</li>
<li>
<p>target分为三种类型</p>
<ul>
<li>常规性 .regular</li>
</ul>

<ul>
<li>测试类型 .test</li>
</ul>

<ul>
<li>系统库类型 .system</li>
</ul>
</li>
</ul>

<ul>
<li>swiftLanguageModes：此包兼容的Swift语言模式列表。</li>
</ul>
<h4 data-id="heading-10"><strong>六、在Xcode中导入包</strong></h4>
<ol>
<li>在Xcode中打开你的项目。</li>
<li>选择菜单栏的File &gt; Add Packages...。</li>
<li>在弹出的窗口中，选择Add Local添加本地的package，或输入包存在的网址。</li>
<li>选择完成后，点击Add Package，Xcode会自动解析并下载该包及其所有依赖项。</li>
<li>依赖的包会出现在项目导航器的Package Dependencies部分，然后可以在代码中直接import使用。</li>
</ol>
<p><strong>在Xcode中删除包</strong> 如果在Xcode中导入包后，无法在Package Dependencies部分删除包，可以在项目.xcodeproj包内内容下的project.pbxproj里进行包的删除，删除后保存文件即可。</p>
<p>参考：<a href="https://juejin.cn/post/7436934215834566691" target="_blank" title="https://juejin.cn/post/7436934215834566691">juejin.cn/post/743693…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[喂饭级教程 —— 基于 OceanBase seekdb 构建 RAG 应用]]></title>    <link>https://juejin.cn/post/7579949847395024896</link>    <guid>https://juejin.cn/post/7579949847395024896</guid>    <pubDate>2025-12-05T06:48:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579949847395024896" data-draft-id="7579892134817726499" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="喂饭级教程 —— 基于 OceanBase seekdb 构建 RAG 应用"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2025-12-05T06:48:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="老纪的技术唠嗑局"/> <meta itemprop="url" content="https://juejin.cn/user/2394058441104739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            喂饭级教程 —— 基于 OceanBase seekdb 构建 RAG 应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2394058441104739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    老纪的技术唠嗑局
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T06:48:18.000Z" title="Fri Dec 05 2025 06:48:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文又是一篇喂饭级教程，为大家展示通过 OceanBase seekdb 构建 RAG（检索增强生成）系统的详细步骤。</p>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/jpeg/32756313/1764916240382-bc5a4d09-7881-4796-a152-8593916947fc.jpeg" alt="" loading="lazy"/></p>
<p>RAG 系统结合了检索系统和生成模型，可根据给定提示生成新文本。系统首先使用 seekdb 的原生向量搜索功能从语料库中检索相关文档，然后使用生成模型根据检索到的文档生成新文本。</p>
<h2 data-id="heading-0"><strong>前提条件</strong></h2>
<ul>
<li>已安装 Python 3.11 或以上版本</li>
<li>已安装 uv</li>
<li>已准备好 LLM API Key</li>
</ul>
<h2 data-id="heading-1"><strong>准备工作</strong></h2>
<h3 data-id="heading-2"><strong>克隆代码</strong></h3>
<pre><code class="hljs language-plain" lang="plain">git clone https://github.com/oceanbase/pyseekdb.git
cd pyseekdb/demo/rag
</code></pre>
<h3 data-id="heading-3"><strong>设置环境</strong></h3>
<h4 data-id="heading-4"><strong>安装依赖</strong></h4>
<p>基础安装（适用于 <code>default</code> 或 <code>api</code> embedding 类型）：</p>
<pre><code class="hljs language-plain" lang="plain">uv sync
</code></pre>
<p>本地模型（适用于 <code>local</code> embedding 类型）：</p>
<pre><code class="hljs language-plain" lang="plain">uv sync --extra local
</code></pre>
<p>提示：</p>
<ul>
<li><code>local</code> 额外依赖包含 <code>sentence-transformers</code> 及相关依赖（约 2-3 GB）。</li>
<li>如果您在中国大陆，可以使用国内镜像源加速下载：
<ul>
<li>基础安装（清华源）：<code>uv sync --index-url https://pypi.tuna.tsinghua.edu.cn/simple</code></li>
<li>基础安装（阿里源）：<code>uv sync --index-url https://mirrors.aliyun.com/pypi/simple</code></li>
<li>本地模型（清华源）：<code>uv sync --extra local --index-url https://pypi.tuna.tsinghua.edu.cn/simple</code></li>
<li>本地模型（阿里源）：<code>uv sync --extra local --index-url https://mirrors.aliyun.com/pypi/simple</code></li>
</ul>
</li>
</ul>
<h4 data-id="heading-5"><strong>设置环境变量</strong></h4>
<p>步骤一：复制环境变量模板</p>
<p>cp .env.example .env</p>
<p>步骤二：编辑 <code>.env</code> 文件，设置环境变量</p>
<p>本系统支持三种 Embedding 函数类型，您可以根据需求选择：</p>
<ol>
<li><code>default</code>（默认，推荐新手使用）</li>
</ol>
<ul>
<li>使用 pyseekdb 自带的 <code>DefaultEmbeddingFunction</code>（基于 ONNX）</li>
<li>首次使用会自动下载模型，无需配置 API Key</li>
<li>适合本地开发和测试</li>
</ul>
<ol>
<li><code>local</code>（本地模型）</li>
</ol>
<ul>
<li>使用自定义的 <code>sentence-transformers</code> 模型</li>
<li>需要安装 <code>sentence-transformers</code> 库</li>
<li>可配置模型名称和设备（CPU/GPU）</li>
</ul>
<ol>
<li><code>api</code>（API 服务）</li>
</ol>
<ul>
<li>使用 OpenAI 兼容的 Embedding API（如 DashScope、OpenAI 等）</li>
<li>需要配置 API Key 和模型名称</li>
<li>适合生产环境</li>
</ul>
<p>以下使用通义千问作为示例（使用 <code>api</code> 类型）：</p>
<pre><code class="hljs language-plain" lang="plain"># Embedding Function 类型：api, local, default
EMBEDDING_FUNCTION_TYPE=api

# LLM 配置（用于生成答案）
OPENAI_API_KEY=sk-your-dashscope-key
OPENAI_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
OPENAI_MODEL_NAME=qwen-plus

# Embedding API 配置（仅在 EMBEDDING_FUNCTION_TYPE=api 时需要）
EMBEDDING_API_KEY=sk-your-dashscope-key
EMBEDDING_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
EMBEDDING_MODEL_NAME=text-embedding-v4

# 本地模型配置（仅在 EMBEDDING_FUNCTION_TYPE=local 时需要）
SENTENCE_TRANSFORMERS_MODEL_NAME=all-mpnet-base-v2
SENTENCE_TRANSFORMERS_DEVICE=cpu

# seekdb 配置
SEEKDB_DIR=./data/seekdb_rag
SEEKDB_NAME=test
COLLECTION_NAME=embeddings
</code></pre>
<p>环境变量说明：</p>



















































































<table><thead><tr><th align="left"><strong>变量名</strong></th><th align="left"><strong>说明</strong></th><th align="left"><strong>默认值/示例值</strong></th><th align="left"><strong>必需条件</strong></th></tr></thead><tbody><tr><td align="left">EMBEDDING_FUNCTION_TYPE</td><td align="left">Embedding 函数类型</td><td align="left"><code>default</code>   （可选：<code>api</code>   , <code>local</code>   , <code>default</code>   ）</td><td align="left">必须设置</td></tr><tr><td align="left">OPENAI_API_KEY</td><td align="left">LLM API Key（支持 OpenAI、通义千问等兼容服务）</td><td align="left">必须设置</td><td align="left">必须设置（用于生成答案）</td></tr><tr><td align="left">OPENAI_BASE_URL</td><td align="left">LLM API 基础 URL</td><td align="left"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdashscope.aliyuncs.com%2Fcompatible-mode%2Fv1%255B1" target="_blank" title="https://dashscope.aliyuncs.com/compatible-mode/v1%5B1" ref="nofollow noopener noreferrer">dashscope.aliyuncs.com/compatible-…</a>]</td><td align="left">可选</td></tr><tr><td align="left">OPENAI_MODEL_NAME</td><td align="left">语言模型名称</td><td align="left">qwen-plus</td><td align="left">可选</td></tr><tr><td align="left">EMBEDDING_API_KEY</td><td align="left">Embedding API Key</td><td align="left">-</td><td align="left"><code>EMBEDDING_FUNCTION_TYPE=api</code>    时必需</td></tr><tr><td align="left">EMBEDDING_BASE_URL</td><td align="left">Embedding API 基础 URL</td><td align="left"><a href="https://link.juejin.cn?target=https%3A%2F%2Fdashscope.aliyuncs.com%2Fcompatible-mode%2Fv1%255B2" target="_blank" title="https://dashscope.aliyuncs.com/compatible-mode/v1%5B2" ref="nofollow noopener noreferrer">dashscope.aliyuncs.com/compatible-…</a>]</td><td align="left"><code>EMBEDDING_FUNCTION_TYPE=api</code>    时可选</td></tr><tr><td align="left">EMBEDDING_MODEL_NAME</td><td align="left">Embedding 模型名称</td><td align="left">text-embedding-v4</td><td align="left"><code>EMBEDDING_FUNCTION_TYPE=api</code>    时必需</td></tr><tr><td align="left">SENTENCE_TRANSFORMERS_MODEL_NAME</td><td align="left">本地模型名称</td><td align="left">all-mpnet-base-v2</td><td align="left"><code>EMBEDDING_FUNCTION_TYPE=local</code>    时可选</td></tr><tr><td align="left">SENTENCE_TRANSFORMERS_DEVICE</td><td align="left">运行设备</td><td align="left">cpu</td><td align="left"><code>EMBEDDING_FUNCTION_TYPE=local</code>    时可选</td></tr><tr><td align="left">SEEKDB_DIR</td><td align="left">seekdb 数据库目录</td><td align="left">./data/seekdb_rag</td><td align="left">可选</td></tr><tr><td align="left">SEEKDB_NAME</td><td align="left">数据库名称</td><td align="left">test</td><td align="left">可选</td></tr><tr><td align="left">COLLECTION_NAME</td><td align="left">嵌入表名称</td><td align="left">embeddings</td><td align="left">可选</td></tr></tbody></table>
<p>提示：</p>
<ul>
<li>如果使用 <code>default</code> 类型，只需配置 <code>EMBEDDING_FUNCTION_TYPE=default</code> 和 LLM 相关变量即可。</li>
<li>如果使用 <code>api</code> 类型，需要额外配置 Embedding API 相关变量。</li>
<li>如果使用 <code>local</code> 类型，需要安装 <code>sentence-transformers</code> 库，并可选择配置模型名称。</li>
</ul>
<h2 data-id="heading-6"><strong>主要使用的模块</strong></h2>
<h3 data-id="heading-7"><strong>初始化 LLM 客户端</strong></h3>
<p>我们通过加载环境变量来初始化 LLM 客户端：</p>
<pre><code class="hljs language-plain" lang="plain">def get_llm_client() -&gt; OpenAI:
    """Initialize LLM client using OpenAI-compatible API."""
    return OpenAI(
        api_key=os.getenv("OPENAI_API_KEY"),
        base_url=os.getenv("OPENAI_BASE_URL"),
    )
</code></pre>
<h3 data-id="heading-8"><strong>创建数据库连接</strong></h3>
<pre><code class="hljs language-plain" lang="plain">def get_seekdb_client(db_dir: str = "./seekdb_rag", db_name: str = "test"):
    """Initialize seekdb client (embedded mode)."""
    cache_key = (db_dir, db_name)
    if cache_key not in _client_cache:
        print(f"Connecting to seekdb: path={db_dir}, database={db_name}")
        _client_cache[cache_key] = Client(path=db_dir, database=db_name)
        print("seekdb client connected successfully")
    return _client_cache[cache_key]
</code></pre>
<h3 data-id="heading-9"><strong>自定义嵌入模型的工厂模式</strong></h3>
<p>在 <code>.env</code> 文件中可以通过配置 <code>EMBEDDING_FUNCTION_TYPE</code> 使用不同的 <code>embedding_function</code>。您也可以参考这个例子自定义您的 <code>embedding_function</code>。</p>
<pre><code class="hljs language-plain" lang="plain">from pyseekdb import EmbeddingFunction, DefaultEmbeddingFunction
from typing import List, Union
import os
from openai import OpenAI

Documents = Union[str, List[str]]
Embeddings = List[List[float]]

class SentenceTransformerCustomEmbeddingFunction(EmbeddingFunction[Documents]):
    """
    A custom embedding function using sentence-transformers with a specific model.
    """
    
    def __init__(self, model_name: str = "all-mpnet-base-v2", device: str = "cpu"):# TODO: your own model name and device
        """
        Initialize the sentence-transformer embedding function.
        
        Args:
            model_name: Name of the sentence-transformers model to use
            device: Device to run the model on ('cpu' or 'cuda')
        """
        self.model_name = model_name or os.environ.get('SENTENCE_TRANSFORMERS_MODEL_NAME')
        self.device = device or os.environ.get('SENTENCE_TRANSFORMERS_DEVICE')
        self._model = None
        self._dimension = None
    
    def _ensure_model_loaded(self):
        """Lazy load the embedding model"""
        if self._model isNone:
            try:
                from sentence_transformers import SentenceTransformer
                self._model = SentenceTransformer(self.model_name, device=self.device)
                # Get dimension from model
                test_embedding = self._model.encode(["test"], convert_to_numpy=True)
                self._dimension = len(test_embedding[0])
            except ImportError:
                raise ImportError(
                    "sentence-transformers is not installed. "
                    "Please install it with: pip install sentence-transformers"
                )
    
    @property
    def dimension(self) -&gt; int:
        """Get the dimension of embeddings produced by this function"""
        self._ensure_model_loaded()
        return self._dimension
    
    def __call__(self, input: Documents) -&gt; Embeddings:
        """
        Generate embeddings for the given documents.
        
        Args:
            input: Single document (str) or list of documents (List[str])
            
        Returns:
            List of embedding vectors
        """
        self._ensure_model_loaded()
        
        # Handle single string input
        if isinstance(input, str):
            input = [input]
        
        # Handle empty input
        ifnot input:
            return []
        
        # Generate embeddings
        embeddings = self._model.encode(
            input,
            convert_to_numpy=True,
            show_progress_bar=False
        )
        
        # Convert numpy arrays to lists
        return [embedding.tolist() for embedding in embeddings]



class OpenAIEmbeddingFunction(EmbeddingFunction[Documents]):
    """
    A custom embedding function using Embedding API.
    """
    
    def __init__(self, model_name: str = "", api_key: str = "", base_url: str = ""):
        """
        Initialize the Embedding API embedding function.
        
        Args:
            model_name: Name of the Embedding API embedding model
            api_key: Embedding API key (if not provided, uses EMBEDDING_API_KEY env var)
        """
        self.model_name = model_name or os.environ.get('EMBEDDING_MODEL_NAME')
        self.api_key = api_key or os.environ.get('EMBEDDING_API_KEY')
        self.base_url = base_url or os.environ.get('EMBEDDING_BASE_URL')
        self._dimension = None
        ifnot self.api_key:
            raise ValueError("Embedding API key is required")


    def _ensure_model_loaded(self):
        """Lazy load the Embedding API model"""
        try:
            client = OpenAI(
                api_key=self.api_key,
                base_url=self.base_url
            )
            response = client.embeddings.create(
                model=self.model_name,
                input=["test"]
            )
            self._dimension = len(response.data[0].embedding)
        except Exception as e:
            raise ValueError(f"Failed to load Embedding API model: {e}")

    @property
    def dimension(self) -&gt; int:
        """Get the dimension of embeddings produced by this function"""
        self._ensure_model_loaded()
        return self._dimension
    
    def __call__(self, input: Documents) -&gt; Embeddings:
        """
        Generate embeddings using Embedding API.
        
        Args:
            input: Single document (str) or list of documents (List[str])
            
        Returns:
            List of embedding vectors
        """
        # Handle single string input
        if isinstance(input, str):
            input = [input]
        
        # Handle empty input
        ifnot input:
            return []
        
        # Call Embedding API
        client = OpenAI(
            api_key=self.api_key,  
            base_url=self.base_url
        )
        response = client.embeddings.create(
            model=self.model_name,
            input=input
        )
        
        # Extract Embedding API embeddings
        embeddings = [item.embedding for item in response.data]
        return embeddings


def create_embedding_function() -&gt; EmbeddingFunction:
    embedding_function_type = os.environ.get('EMBEDDING_FUNCTION_TYPE')
    if embedding_function_type == "api":
        print("Using OpenAI Embedding API embedding function")
        return OpenAIEmbeddingFunction()
    elif embedding_function_type == "local":
        print("Using SentenceTransformer embedding function")
        return SentenceTransformerCustomEmbeddingFunction()
    elif embedding_function_type == "default":
        print("Using Default embedding function")
        return DefaultEmbeddingFunction()
    else:
        raise ValueError(f"Unsupported embedding function type: {embedding_function_type}")
</code></pre>
<h3 data-id="heading-10"><strong>创建 Collection</strong></h3>
<p>在 <code>get_or_create_collection()</code> 方法中我们传入了 <code>embedding_function</code>，之后使用这个 collection 的 <code>add()</code> 和 <code>query()</code> 方法的时候就不需要传入向量了，只需传入文本，向量会由 <code>embedding_function</code> 自动生成。</p>
<pre><code class="hljs language-plain" lang="plain">def get_seekdb_collection(client, collection_name: str = "embeddings", 
                  embedding_function: Optional[EmbeddingFunction] = DefaultEmbeddingFunction(),
                  drop_if_exists: bool = True):
    """
    Get or create a collection using pyseekdb's get_or_create_collection.
    
    Args:
        client: seekdb client instance
        collection_name: Name of the collection
        embedding_function: Embedding function (required for automatic embedding generation)
        drop_if_exists: Whether to drop existing collection if it exists
    
    Returns:
        Collection object
    """
    if drop_if_exists and client.has_collection(collection_name):
        print(f"Collection '{collection_name}' already exists, deleting old data...")
        client.delete_collection(collection_name)
    
    if embedding_function isNone:
        raise ValueError("embedding_function is required")
    
    # Use pyseekdb's native get_or_create_collection
    collection = client.get_or_create_collection(
        name=collection_name,
        embedding_function=embedding_function
    )
    
    print(f"Collection '{collection_name}' ready!")
    return collection
</code></pre>
<h3 data-id="heading-11"><strong>核心插入数据函数</strong></h3>
<pre><code class="hljs language-plain" lang="plain">def insert_embeddings(collection, data: List[Dict[str, Any]]):
    """
    Insert data into collection. Embeddings are automatically generated by collection's embedding_function.

    Args:
        collection: Collection object (must have embedding_function configured)
        data: List of data dictionaries containing 'text', 'source_file', 'chunk_index'
    """
    try:
        ids = [f"{item['source_file']}_{item.get('chunk_index', 0)}"for item in data]
        documents = [item['text'] for item in data]
        metadatas = [{'source_file': item['source_file'],
                     'chunk_index': item.get('chunk_index', 0)} for item in data]

        # Collection's embedding_function will automatically generate embeddings from documents
        collection.add(
            ids=ids,
            documents=documents,
            metadatas=metadatas
        )

        print(f"Inserted {len(data)} items successfully")
    except Exception as e:
        print(f"Error inserting data: {e}")
        raise
</code></pre>
<h3 data-id="heading-12"><strong>向量相似度搜索</strong></h3>
<pre><code class="hljs language-plain" lang="plain">results = collection.query(
                    query_texts=[question],
                    n_results=3,
                    include=["documents", "metadatas", "distances"]
                )
</code></pre>
<h3 data-id="heading-13"><strong>统计 Collection 中的数据情况</strong></h3>
<pre><code class="hljs language-plain" lang="plain">def get_database_stats(collection) -&gt; Dict[str, Any]:
    """Get statistics about the collection."""
    try:
        results = collection.get(limit=10000, include=["metadatas"])
        ids = results.get('ids', []) if isinstance(results, dict) else []
        metadatas = results.get('metadatas', []) if isinstance(results, dict) else []
        
        unique_files = {m.get('source_file') for m in metadatas if m and m.get('source_file')}
        
        return {
            "total_embeddings": len(ids),
            "unique_source_files": len(unique_files)
        }
    except Exception as e:
        print(f"Error getting database stats: {e}")
        return {"total_embeddings": 0, "unique_source_files": 0}
</code></pre>
<h2 data-id="heading-14"><strong>构建 RAG 系统</strong></h2>
<p>本模块实现了 RAG 系统的检索功能。通过将用户提出的问题转换为嵌入向量，利用 seekdb 提供的原生向量搜索能力，快速检索出与问题最相关的文档片段，为后续的生成模型提供必要的上下文信息。</p>
<h3 data-id="heading-15"><strong>导入数据</strong></h3>
<p>我们使用 pyseekdb 的 SDK 文档作为示例，您也可以使用自己的 Markdown 文档或者目录。</p>
<p>运行数据导入脚本：</p>
<pre><code class="hljs language-plain" lang="plain"># 导入单个文档
uv run python seekdb_insert.py ../../README.md

# 或导入目录下的所有 Markdown 文档
uv run python seekdb_insert.py path/to/your_dir
</code></pre>
<h3 data-id="heading-16"><strong>启动应用</strong></h3>
<p>在 <code>pyseekdb/demo/rag</code> 路径下执行如下命令，通过 Streamlit 启动应用：</p>
<pre><code class="hljs language-plain" lang="plain">uv run streamlit run seekdb_app.py --server.port your_port
</code></pre>
<p>使用 IP 和端口号（默认为 <code>8501</code>，可通过 <code>--server.port</code> 选项自定义）即可在浏览器中打开 RAG 界面。</p>
<p>提示： 如果使用 <code>uv</code> 作为包管理器，请在命令前加上 <code>uv run</code> 前缀，以确保使用正确的 Python 环境和依赖。</p>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/png/32756313/1764916291371-80e85a3a-4863-47e3-b6cf-3e96af5cf528.png" alt="" loading="lazy"/></p>
<h2 data-id="heading-17"><strong>实际运行示例</strong></h2>
<p>以下是一个真实的查询示例，展示了 seekdb RAG 系统的实际效果：</p>
<p>用户问题：“What is seekdb's vector search?”</p>
<p>检索到的相关文档：</p>
<pre><code class="hljs language-plain" lang="plain">1. 30.experience-vector-retrieval.md
   Vector search overview In today's era of information explosion, users often need to quickly retrieve the information they need from massive amounts o...

2. 20.using-seekdb-in-python-mode.md
   Experience vector search SeekDB supports up to 16,000 dimensions of float-type dense vectors, sparse vectors, and various types of vector distance ca...

3. 70.experience-hybrid-vector-index.md
   Summary Through this tutorial, you have mastered the core features of SeekDB's hybrid vector index: Simplified usage process: Achieve semantic ret...
</code></pre>
<p>使用 LLM 生成的答案：</p>
<p>SeekDB's vector search is a powerful feature that enables efficient and accurate retrieval of data by encoding various types of data—such as text, images, and audio—into mathematical vectors and performing searches in a vector space. This approach captures deep semantic relationships within the data, going beyond traditional keyword-based search methods to deliver more relevant results.</p>
<p>Key capabilities of SeekDB's vector search include:</p>
<ul>
<li>High-dimensional vector support: It supports up to 16,000 dimensions for float-type dense vectors and sparse vectors.</li>
<li>Multiple distance metrics: It supports various similarity or distance calculations, including Manhattan distance, Euclidean distance, inner product, and cosine distance.</li>
<li>Advanced indexing methods: Vector indexes can be created using HNSW (Hierarchical Navigable Small World) or IVF (Iterative Virtual File), enabling fast approximate nearest neighbor searches.</li>
<li>Incremental updates: The system allows for real-time insertion and deletion of vectors without compromising search accuracy or recall.</li>
<li>Hybrid search with scalar filtering: Users can combine vector similarity search with traditional attribute-based (scalar) filtering for more precise results.</li>
<li>Flexible access interfaces: SeekDB supports SQL access via MySQL protocol clients in multiple programming languages, as well as a Python SDK.</li>
<li>Automatic embedding and hybrid indexing: With hybrid vector index features, users can store raw text directly—the system automatically converts it into vectors and builds indexes.</li>
</ul>
<p>In summary, SeekDB's vector search provides a comprehensive, high-performance solution for semantic search, particularly valuable in AI applications involving large-scale unstructured data.</p>
<p>这个示例展示了：</p>
<ul>
<li>✅ 准确的信息检索：系统成功从文档中找到了相关信息</li>
<li>✅ 多文档整合：从 3 个不同文档中提取和整合信息</li>
<li>✅ 语义匹配：准确匹配了“vector search”相关的文档</li>
<li>✅ 结构化回答：AI 将检索到的信息整理成清晰的结构</li>
<li>✅ 完整性：涵盖了 seekdb 向量搜索的主要特性</li>
<li>✅ 专业性：回答包含了技术细节和实际应用价值</li>
</ul>
<p>检索质量分析：</p>
<ul>
<li>最相关文档 : <code>experience-vector-retrieval.md</code> - 向量搜索概览</li>
<li>技术细节 : <code>using-seekdb-in-python-mode.md</code> - 具体的技术规格</li>
<li>高级特性 : <code>experience-hybrid-vector-index.md</code> - 混合向量索引功能</li>
</ul>
<h2 data-id="heading-18"><strong>快速体验</strong></h2>
<p>如需快速体验 seekdb RAG 系统，请参考 <strong>快速部署[3]</strong>。</p>
<p><strong>参考资料</strong></p>
<p>[1]</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdashscope.aliyuncs.com%2Fcompatible-mode%2Fv1" target="_blank" title="https://dashscope.aliyuncs.com/compatible-mode/v1" ref="nofollow noopener noreferrer">dashscope.aliyuncs.com/compatible-…</a>: <em><a href="https://link.juejin.cn?target=https%3A%2F%2Fdashscope.aliyuncs.com%2Fcompatible-mode%2Fv1" target="_blank" title="https://dashscope.aliyuncs.com/compatible-mode/v1" ref="nofollow noopener noreferrer">dashscope.aliyuncs.com/compatible-…</a></em></p>
<p>[2]</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdashscope.aliyuncs.com%2Fcompatible-mode%2Fv1" target="_blank" title="https://dashscope.aliyuncs.com/compatible-mode/v1" ref="nofollow noopener noreferrer">dashscope.aliyuncs.com/compatible-…</a>: <em><a href="https://link.juejin.cn?target=https%3A%2F%2Fdashscope.aliyuncs.com%2Fcompatible-mode%2Fv1" target="_blank" title="https://dashscope.aliyuncs.com/compatible-mode/v1" ref="nofollow noopener noreferrer">dashscope.aliyuncs.com/compatible-…</a></em></p>
<p>[3]
快速部署: <em><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Foceanbase%2Fpyseekdb%2Fblob%2Fmain%2Fdemo%2Frag%2FREADME_CN.md" target="_blank" title="https://github.com/oceanbase/pyseekdb/blob/main/demo/rag/README_CN.md" ref="nofollow noopener noreferrer">github.com/oceanbase/p…</a></em></p>
<p>[4]
seekdb 项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Foceanbase%2Fseekdb%3Fsessionid%3D" target="_blank" title="https://github.com/oceanbase/seekdb?sessionid=" ref="nofollow noopener noreferrer">github.com/oceanbase/s…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[windows服务器mysql数据库备份脚本]]></title>    <link>https://juejin.cn/post/7579935414422487086</link>    <guid>https://juejin.cn/post/7579935414422487086</guid>    <pubDate>2025-12-05T06:35:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579935414422487086" data-draft-id="7579935414422454318" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="windows服务器mysql数据库备份脚本"/> <meta itemprop="keywords" content="后端,Java,MySQL"/> <meta itemprop="datePublished" content="2025-12-05T06:35:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT界Tony哥"/> <meta itemprop="url" content="https://juejin.cn/user/3157453122578087"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            windows服务器mysql数据库备份脚本
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3157453122578087/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT界Tony哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T06:35:02.000Z" title="Fri Dec 05 2025 06:35:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>根据MySQL 5.7版本，我为您提供专门优化的备份脚本：</p>
<h2 data-id="heading-0">1. MySQL 5.7专用备份脚本</h2>
<p>创建 <code>mysql57_backup.bat</code>：</p>
<pre><code class="hljs language-perl" lang="perl">@echo off
chcp <span class="hljs-number">65001</span> &gt;nul
cls
echo ============================================
echo    MySQL <span class="hljs-number">5.7</span> 数据库备份工具
echo    Database: jfdzyl
echo ============================================
echo.

REM ============ 配置区域 ============
REM <span class="hljs-number">1</span>. MySQL <span class="hljs-number">5.7</span> 路径（默认安装路径）
set <span class="hljs-string">"MYSQL_PATH=C:\Program Files\MySQL\MySQL Server 5.7\bin"</span>
<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> exist <span class="hljs-string">"%MYSQL_PATH%\mysqldump.exe"</span> (
    echo [错误] 未找到 MySQL <span class="hljs-number">5.7</span>
    echo 请修改 MYSQL_PATH 为正确的安装路径
    pause
    <span class="hljs-keyword">exit</span> /b <span class="hljs-number">1</span>
)

REM <span class="hljs-number">2</span>. 数据库连接信息
set DB_HOST=localhost
set DB_PORT=<span class="hljs-number">3306</span>
set DB_USER=root
set DB_PASS=mysql
set DB_NAME=xxxx

REM <span class="hljs-number">3</span>. 备份设置
set BACKUP_ROOT=<span class="hljs-string">"D:\MySQL_Backups\MySQL5.7"</span>
set KEEP_DAYS=<span class="hljs-number">7</span>           REM 保留最近<span class="hljs-number">7</span>天备份
set MAX_BACKUPS=<span class="hljs-number">20</span>        REM 最大保留备份文件数
set COMPRESS=true         REM 是否启用压缩

echo [信息] MySQL <span class="hljs-number">5.7</span> 路径: %MYSQL_PATH%
echo [信息] 数据库: %DB_NAME%@%DB_HOST%:%DB_PORT%

REM ============ 创建备份目录 ============
<span class="hljs-keyword">for</span> /f <span class="hljs-string">"tokens=1-3 delims=/ "</span> %%a in (<span class="hljs-string">'date /t'</span>) <span class="hljs-keyword">do</span> (
    set YEAR=%%c
    set MONTH=%%a
    set DAY=%%b
)

REM 处理日期格式（如果日期是yyyy/MM/dd格式）
<span class="hljs-keyword">if</span> <span class="hljs-string">"%YEAR:~0,2%"=="</span><span class="hljs-number">20</span><span class="hljs-string">" (
    set DATE_STRING=%YEAR%%MONTH%%DAY%
) else (
    set DATE_STRING=%DAY%%MONTH%%YEAR%
    set YEAR=%DATE_STRING:~4,4%
    set MONTH=%DATE_STRING:~2,2%
    set DAY=%DATE_STRING:~0,2%
)

set TIMESTAMP=%TIME: =0%
set TIMESTAMP=%TIMESTAMP::=-%
set BACKUP_DIR=%BACKUP_ROOT%%YEAR%-%MONTH%-%DAY%
set LOG_FILE=%BACKUP_DIR%%DB_NAME%_backup.log

if not exist %BACKUP_ROOT% (
    mkdir %BACKUP_ROOT%
    echo [信息] 创建备份根目录: %BACKUP_ROOT%
)

if not exist "</span>%BACKUP_DIR%" (
    <span class="hljs-keyword">mkdir</span> <span class="hljs-string">"%BACKUP_DIR%"
    echo [信息] 创建备份目录: %BACKUP_DIR%
)

echo ============================================
echo 开始备份时间: %DATE% %TIME%
echo 备份目录: %BACKUP_DIR%
echo ============================================
echo.

REM ============ 执行备份 ============
set BACKUP_FILE=%DB_NAME%_%DATE_STRING%_%TIMESTAMP%.sql
set BACKUP_FILE_FULL=%BACKUP_DIR%%BACKUP_FILE%

echo [步骤1] 检查MySQL连接...
cd /d "</span>%MYSQL_PATH%"
mysql.exe -h%DB_HOST% -P%DB_PORT% -u%DB_USER% -p%DB_PASS% -e <span class="hljs-string">"SELECT 1"</span> &gt;nul <span class="hljs-number">2</span>&gt;&amp;<span class="hljs-number">1</span>
<span class="hljs-keyword">if</span> errorlevel <span class="hljs-number">1</span> (
    echo [错误] MySQL连接失败！
    echo 请检查:
    echo <span class="hljs-number">1</span>. MySQL <span class="hljs-number">5.7</span>服务是否运行
    echo <span class="hljs-number">2</span>. 用户名/密码是否正确
    echo <span class="hljs-number">3</span>. 端口号是否正确(默认:<span class="hljs-number">3306</span>)
    pause
    <span class="hljs-keyword">exit</span> /b <span class="hljs-number">1</span>
)
echo [成功] MySQL连接正常

echo.
echo [步骤<span class="hljs-number">2</span>] 获取数据库信息...
mysql.exe -h%DB_HOST% -P%DB_PORT% -u%DB_USER% -p%DB_PASS% -N -B -e <span class="hljs-string">"SELECT table_schema 'Database', ROUND(SUM(data_length+index_length)/1024/1024,2) 'Size_MB' FROM information_schema.tables WHERE table_schema='%DB_NAME%' GROUP BY table_schema"</span> <span class="hljs-number">2</span>&gt;nul

echo.
echo [步骤<span class="hljs-number">3</span>] 执行备份...
echo 开始时间: %TIME%
echo 备份文件: %BACKUP_FILE%

REM MySQL <span class="hljs-number">5.7</span> 优化备份参数
mysqldump.exe ^
    -h%DB_HOST% ^
    -P%DB_PORT% ^
    -u%DB_USER% ^
    -p%DB_PASS% ^
    --databases %DB_NAME% ^
    --default-character-set=utf8mb4 ^
    --single-transaction ^
    --routines ^
    --triggers ^
    --events ^
    --<span class="hljs-keyword">hex</span>-blob ^
    --complete-insert ^
    --add-drop-database ^
    --add-drop-table ^
    --result-file=<span class="hljs-string">"%BACKUP_FILE_FULL%" ^
    --log-error="</span>%BACKUP_DIR%%DB_NAME%_dump_error.log<span class="hljs-string">"

if errorlevel 1 (
    echo [错误] 备份失败！
    if exist "</span>%BACKUP_DIR%%DB_NAME%_dump_error.log<span class="hljs-string">" (
        echo 错误日志:
        type "</span>%BACKUP_DIR%%DB_NAME%_dump_error.log<span class="hljs-string">"
    )
    pause
    exit /b 1
)

echo 结束时间: %TIME%
echo [成功] 数据库备份完成！

REM 获取文件大小
for %%F in ("</span>%BACKUP_FILE_FULL%") <span class="hljs-keyword">do</span> (
    set <span class="hljs-string">"FILE_SIZE=%%~zF"</span>
    set <span class="hljs-string">"SIZE_MB=!FILE_SIZE:/1024/1024=!"</span>
    set /a SIZE_MB=!FILE_SIZE!<span class="hljs-regexp">/1024/</span><span class="hljs-number">1024</span>
    echo 文件大小: !FILE_SIZE! 字节 (!SIZE_MB! MB)
)

echo.
echo [步骤<span class="hljs-number">4</span>] 验证备份文件...
REM 检查备份文件是否包含正确的结束标记
findstr /i <span class="hljs-string">"Dump completed"</span> <span class="hljs-string">"%BACKUP_FILE_FULL%" &gt;nul
if errorlevel 1 (
    findstr /i "</span>-- Dump completed<span class="hljs-string">" "</span>%BACKUP_FILE_FULL%" &gt;nul
    <span class="hljs-keyword">if</span> errorlevel <span class="hljs-number">0</span> (
        echo [验证] 备份文件完整性检查通过
    ) <span class="hljs-keyword">else</span> (
        echo [警告] 未找到标准结束标记，但文件已生成
    )
) <span class="hljs-keyword">else</span> (
    echo [验证] 备份文件完整性检查通过
)

REM ============ 可选：压缩备份 ============
<span class="hljs-keyword">if</span> <span class="hljs-string">"%COMPRESS%"=="</span>true<span class="hljs-string">" (
    echo.
    echo [步骤5] 压缩备份文件...
    
    REM 检查7-Zip
    set "</span>ZIP_PATH=C:\Program Files\<span class="hljs-number">7</span>-Zip\<span class="hljs-number">7</span>z.exe<span class="hljs-string">"
    if not exist "</span>%ZIP_PATH%" (
        set <span class="hljs-string">"ZIP_PATH=%ProgramFiles%\7-Zip\7z.exe"</span>
    )
    
    <span class="hljs-keyword">if</span> exist <span class="hljs-string">"%ZIP_PATH%" (
        "</span>%ZIP_PATH%" a -tzip -mx5 <span class="hljs-string">"%BACKUP_FILE_FULL%.zip"</span> <span class="hljs-string">"%BACKUP_FILE_FULL%" &gt;nul
        if errorlevel 0 (
            del "</span>%BACKUP_FILE_FULL%"
            echo [成功] 压缩完成: %BACKUP_FILE%.zip
            set BACKUP_FILE_FINAL=%BACKUP_FILE_FULL%.zip
        ) <span class="hljs-keyword">else</span> (
            echo [警告] 压缩失败，保留原文件
            set BACKUP_FILE_FINAL=%BACKUP_FILE_FULL%
        )
    ) <span class="hljs-keyword">else</span> (
        echo [信息] 未找到<span class="hljs-number">7</span>-Zip，使用未压缩备份
        set <span class="hljs-string">"COMPRESS=false"</span>
        set BACKUP_FILE_FINAL=%BACKUP_FILE_FULL%
    )
) <span class="hljs-keyword">else</span> (
    set BACKUP_FILE_FINAL=%BACKUP_FILE_FULL%
)

REM ============ 清理旧备份 ============
echo.
echo [步骤<span class="hljs-number">6</span>] 清理旧备份...

REM 方法<span class="hljs-number">1</span>：按天数清理
echo 清理超过%KEEP_DAYS%天的备份...
forfiles /p %BACKUP_ROOT% <span class="hljs-regexp">/s /m</span> *.sql /d -%KEEP_DAYS% <span class="hljs-regexp">/c "cmd /</span>c echo 删除: @path &amp;&amp; del @path<span class="hljs-string">" 2&gt;nul
forfiles /p %BACKUP_ROOT% /s /m *.zip /d -%KEEP_DAYS% /c "</span>cmd /c echo 删除: @path &amp;&amp; del @path<span class="hljs-string">" 2&gt;nul

REM 方法2：按文件数量清理
echo 检查备份文件数量...
cd /d %BACKUP_ROOT%
for /f %%i in ('dir /b /s *.sql *.zip ^| find /c /v "</span><span class="hljs-string">"') do set COUNT=%%i
echo 当前备份文件总数: %COUNT%

if %COUNT% GTR %MAX_BACKUPS% (
    echo 超出最大限制(%MAX_BACKUPS%)，清理最旧的文件...
    dir /b /s *.sql *.zip /o-d /t:c &gt; "</span>%BACKUP_ROOT%\backup_list.txt<span class="hljs-string">"
    
    setlocal enabledelayedexpansion
    set /a DEL_COUNT=%COUNT%-%MAX_BACKUPS%
    echo 需要删除!DEL_COUNT!个文件
    
    for /f "</span>skip=%MAX_BACKUPS% delims=<span class="hljs-string">" %%F in ('dir /b /s *.sql *.zip /o-d /t:c') do (
        if exist "</span>%%F<span class="hljs-string">" (
            echo 删除: %%F
            del "</span>%%F<span class="hljs-string">"
        )
    )
    endlocal
)

REM 清理空目录
for /f "</span>delims=<span class="hljs-string">" %%D in ('dir %BACKUP_ROOT% /ad /b /s ^| sort /r') do (
    dir "</span>%%D<span class="hljs-string">" 2&gt;nul | findstr "</span>^[<span class="hljs-number">0</span>-<span class="hljs-number">9</span>]<span class="hljs-string">" &gt;nul || (
        rmdir "</span>%%D<span class="hljs-string">" 2&gt;nul &amp;&amp; echo 清理空目录: %%D
    )
)

echo.
echo ============================================
echo           备份摘要
echo ============================================
echo 数据库: %DB_NAME%
echo 备份时间: %DATE% %TIME%
echo 备份文件: %BACKUP_FILE_FINAL%
for %%F in ("</span>%BACKUP_FILE_FINAL%") <span class="hljs-keyword">do</span> (
    echo 文件大小: %%~zF 字节
)
echo 备份位置: %BACKUP_DIR%
echo 压缩状态: %COMPRESS%
echo ============================================
echo.

REM 记录日志
echo %DATE% %TIME% - 备份完成: %BACKUP_FILE_FINAL% &gt;&gt; <span class="hljs-string">"%LOG_FILE%"
for %%F in ("</span>%BACKUP_FILE_FINAL%") <span class="hljs-keyword">do</span> (
    echo 文件大小: %%~zF 字节 &gt;&gt; <span class="hljs-string">"%LOG_FILE%"
)

pause
</span></code></pre>
<h2 data-id="heading-1">2. 简易版备份脚本（快速使用）</h2>
<p>创建 <code>backup_simple.bat</code>：</p>
<pre><code class="hljs language-bash" lang="bash">@<span class="hljs-built_in">echo</span> off
chcp 65001 &gt;nul
title MySQL 5.7 备份工具

REM MySQL 5.7 默认安装路径
<span class="hljs-built_in">set</span> MYSQL_PATH=<span class="hljs-string">"C:\Program Files\MySQL\MySQL Server 5.7\bin"</span>
<span class="hljs-built_in">set</span> BACKUP_DIR=<span class="hljs-string">"D:\MySQL_Backup"</span>

REM 数据库配置
<span class="hljs-built_in">set</span> DB_HOST=localhost
<span class="hljs-built_in">set</span> DB_USER=root
<span class="hljs-built_in">set</span> DB_PASS=mysql
<span class="hljs-built_in">set</span> DB_NAME=jfdzyl

REM 创建备份目录
<span class="hljs-keyword">if</span> not exist %BACKUP_DIR% <span class="hljs-built_in">mkdir</span> %BACKUP_DIR%

REM 生成备份文件名
<span class="hljs-built_in">set</span> DATESTAMP=%<span class="hljs-built_in">date</span>:~0,4%%<span class="hljs-built_in">date</span>:~5,2%%<span class="hljs-built_in">date</span>:~8,2%
<span class="hljs-built_in">set</span> TIMESTAMP=%time:~0,2%%time:~3,2%%time:~6,2%
<span class="hljs-built_in">set</span> TIMESTAMP=%TIMESTAMP: =0%
<span class="hljs-built_in">set</span> BACKUP_FILE=%BACKUP_DIR%%DB_NAME%_%DATESTAMP%_%TIMESTAMP%.sql

<span class="hljs-built_in">echo</span> 正在备份数据库 %DB_NAME% ...
<span class="hljs-built_in">echo</span> 请稍候...

<span class="hljs-built_in">cd</span> /d %MYSQL_PATH%
mysqldump -h%DB_HOST% -u%DB_USER% -p%DB_PASS% %DB_NAME% &gt; <span class="hljs-string">"%BACKUP_FILE%"</span>

<span class="hljs-keyword">if</span> errorlevel 1 (
    <span class="hljs-built_in">echo</span> 备份失败！
    pause
    <span class="hljs-built_in">exit</span> /b 1
)

<span class="hljs-built_in">echo</span> 备份成功！
<span class="hljs-built_in">echo</span> 备份文件: %BACKUP_FILE%
<span class="hljs-keyword">for</span> %%F <span class="hljs-keyword">in</span> (<span class="hljs-string">"%BACKUP_FILE%"</span>) <span class="hljs-keyword">do</span> (
    <span class="hljs-built_in">echo</span> 文件大小: %%~zF 字节
)

REM 自动打开备份目录
explorer %BACKUP_DIR%
pause
</code></pre>
<h2 data-id="heading-2">3. 带验证的备份脚本</h2>
<p>创建 <code>backup_with_verify.bat</code>：</p>
<pre><code class="hljs language-ini" lang="ini">@echo off
chcp 65001 &gt;nul
cls

echo MySQL 5.7 数据库备份验证工具
<span class="hljs-attr">echo</span> ==============================
echo.

set <span class="hljs-attr">MYSQL_PATH</span>=<span class="hljs-string">"C:\Program Files\MySQL\MySQL Server 5.7\bin"</span>
set <span class="hljs-attr">BACKUP_DIR</span>=<span class="hljs-string">"D:\MySQL_Backup"</span>
set <span class="hljs-attr">DB_USER</span>=root
set <span class="hljs-attr">DB_PASS</span>=mysql
set <span class="hljs-attr">DB_NAME</span>=jfdzyl

REM 生成备份文件
set <span class="hljs-attr">TIMESTAMP</span>=%date:~<span class="hljs-number">0</span>,<span class="hljs-number">4</span>%%date:~<span class="hljs-number">5</span>,<span class="hljs-number">2</span>%%date:~<span class="hljs-number">8</span>,<span class="hljs-number">2</span>%_%time:~<span class="hljs-number">0</span>,<span class="hljs-number">2</span>%%time:~<span class="hljs-number">3</span>,<span class="hljs-number">2</span>%
set <span class="hljs-attr">TIMESTAMP</span>=%TIMESTAMP: =<span class="hljs-number">0</span>%
set <span class="hljs-attr">TIMESTAMP</span>=%TIMESTAMP::=%
set <span class="hljs-attr">BACKUP_FILE</span>=%BACKUP_DIR%%DB_NAME%_%TIMESTAMP%.sql

echo 步骤1: 执行备份...
cd /d %MYSQL_PATH%
mysqldump -u%DB_USER% -p%DB_PASS^
    --databases %DB_NAME%^
    --single-transaction^
    --routines^
    --triggers^
    --events^
    <span class="hljs-attr">--set-gtid-purged</span>=<span class="hljs-literal">OFF</span>^
    <span class="hljs-attr">--result-file</span>=<span class="hljs-string">"%BACKUP_FILE%"</span>

if errorlevel 1 (
    echo <span class="hljs-section">[错误]</span> 备份失败
    pause
    exit /b 1
)

echo 步骤2: 验证备份文件...
REM 检查文件大小
for %%F in ("%BACKUP_FILE%") do set <span class="hljs-attr">FILESIZE</span>=%%~zF
if %FILESIZE% LSS 1024 (
    echo <span class="hljs-section">[警告]</span> 备份文件可能不完整 (大小: %FILESIZE% 字节)
) else (
    echo <span class="hljs-section">[通过]</span> 文件大小: %FILESIZE% 字节
)

REM 检查文件内容
findstr /i "CREATE TABLE" "%BACKUP_FILE%" &gt;nul
if errorlevel 1 (
    echo <span class="hljs-section">[错误]</span> 备份文件不包含表结构
) else (
    echo <span class="hljs-section">[通过]</span> 包含表结构定义
)

findstr /i "INSERT INTO" "%BACKUP_FILE%" &gt;nul
if errorlevel 1 (
    echo <span class="hljs-section">[警告]</span> 备份文件不包含数据插入语句
) else (
    echo <span class="hljs-section">[通过]</span> 包含数据插入语句
)

REM 快速恢复测试（可选）
echo.
echo 步骤3: 快速完整性测试...
echo 测试表结构语法...
REM 这里可以添加更多验证逻辑

echo.
echo 备份验证完成！
echo 文件: %BACKUP_FILE%
echo 大小: %FILESIZE% 字节
echo.

pause
</code></pre>
<h2 data-id="heading-3">4. 任务计划配置脚本</h2>
<p>创建 <code>setup_scheduled_backup.bat</code>：</p>
<pre><code class="hljs language-bash" lang="bash">@<span class="hljs-built_in">echo</span> off
chcp 65001 &gt;nul
title 设置MySQL 5.7定时备份

<span class="hljs-built_in">echo</span> 正在创建MySQL 5.7自动备份任务...
<span class="hljs-built_in">echo</span>.

REM 创建备份脚本
(
<span class="hljs-built_in">echo</span> @<span class="hljs-built_in">echo</span> off
<span class="hljs-built_in">echo</span> chcp 65001 ^&gt;nul
<span class="hljs-built_in">echo</span> <span class="hljs-built_in">set</span> MYSQL_PATH=<span class="hljs-string">"C:\Program Files\MySQL\MySQL Server 5.7\bin"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-built_in">set</span> BACKUP_DIR=<span class="hljs-string">"D:\MySQL_Backup"</span>
<span class="hljs-built_in">echo</span>.
<span class="hljs-built_in">echo</span> <span class="hljs-built_in">set</span> DB_USER=root
<span class="hljs-built_in">echo</span> <span class="hljs-built_in">set</span> DB_PASS=mysql
<span class="hljs-built_in">echo</span> <span class="hljs-built_in">set</span> DB_NAME=jfdzyl
<span class="hljs-built_in">echo</span>.
<span class="hljs-built_in">echo</span> REM 生成带日期的文件名
<span class="hljs-built_in">echo</span> <span class="hljs-keyword">for</span> /f <span class="hljs-string">"tokens=1-3 delims=/ "</span> %%a <span class="hljs-keyword">in</span> (<span class="hljs-string">'date /t'</span>^) <span class="hljs-keyword">do</span> <span class="hljs-built_in">set</span> DATE=%%a-%%b-%%c
<span class="hljs-built_in">echo</span> <span class="hljs-built_in">set</span> DATE=%%DATE:/=-%%
<span class="hljs-built_in">echo</span> <span class="hljs-built_in">set</span> BACKUP_FILE=%%BACKUP_DIR%%%%DB_NAME%%_%%DATE%%.sql
<span class="hljs-built_in">echo</span>.
<span class="hljs-built_in">echo</span> <span class="hljs-built_in">cd</span> /d %%MYSQL_PATH%%
<span class="hljs-built_in">echo</span> mysqldump -u%%DB_USER%% -p%%DB_PASS%% --databases %%DB_NAME%% --routines --triggers --events --single-transaction ^&gt; <span class="hljs-string">"%%BACKUP_FILE%%"</span>
<span class="hljs-built_in">echo</span>.
<span class="hljs-built_in">echo</span> <span class="hljs-built_in">echo</span> 备份完成: %%DATE%% ^&gt;^&gt; <span class="hljs-string">"%%BACKUP_DIR%%\backup.log"</span>
) &gt; <span class="hljs-string">"%TEMP%\mysql_backup_task.bat"</span>

REM 创建任务计划
schtasks /create /tn <span class="hljs-string">"MySQL5.7_Backup_%DB_NAME%"</span> ^
    /tr <span class="hljs-string">"%TEMP%\mysql_backup_task.bat"</span> ^
    /sc daily /st 02:00 ^
    /ru <span class="hljs-string">"SYSTEM"</span> ^
    /rl HIGHEST ^
    /f

<span class="hljs-keyword">if</span> errorlevel 1 (
    <span class="hljs-built_in">echo</span> 任务创建失败，尝试使用管理员权限...
    <span class="hljs-built_in">echo</span> 请右键以管理员身份重新运行此脚本
) <span class="hljs-keyword">else</span> (
    <span class="hljs-built_in">echo</span> 定时备份任务创建成功！
    <span class="hljs-built_in">echo</span> 任务名称: MySQL5.7_Backup_%DB_NAME%
    <span class="hljs-built_in">echo</span> 执行时间: 每天 02:00
    <span class="hljs-built_in">echo</span> 备份目录: D:\MySQL_Backup
)

<span class="hljs-built_in">echo</span>.
pause
</code></pre>
<h2 data-id="heading-4">5. 使用注意事项</h2>
<h3 data-id="heading-5">MySQL 5.7 特定配置</h3>
<ol>
<li><strong>默认安装路径</strong>：<code>C:\Program Files\MySQL\MySQL Server 5.7\bin</code></li>
<li><strong>字符集设置</strong>：MySQL 5.7 默认使用 <code>utf8</code>，建议备份时指定 <code>--default-character-set=utf8mb4</code></li>
<li><strong>GTID特性</strong>：如果启用了GTID，需要添加 <code>--set-gtid-purged=OFF</code></li>
</ol>
<h3 data-id="heading-6">常见问题解决</h3>
<pre><code class="hljs language-ini" lang="ini">REM 如果遇到权限问题，可以尝试以下方法：

REM 1. 使用MySQL配置文件存储密码
echo <span class="hljs-section">[client]</span> &gt; my.cnf
echo <span class="hljs-attr">host</span>=localhost &gt;&gt; my.cnf
echo <span class="hljs-attr">user</span>=root &gt;&gt; my.cnf
echo <span class="hljs-attr">password</span>=mysql &gt;&gt; my.cnf

REM 2. 然后使用
mysqldump <span class="hljs-attr">--defaults-file</span>=my.cnf jfdzyl &gt; backup.sql

REM 3. 删除配置文件（安全）
del my.cnf
</code></pre>
<h3 data-id="heading-7">备份优化建议</h3>
<ol>
<li>使用 <code>--single-transaction</code>进行一致性备份</li>
<li>使用 <code>--routines</code>备份存储过程和函数</li>
<li>使用 <code>--events</code>备份事件</li>
<li>使用 <code>--triggers</code>备份触发器</li>
<li>大型数据库可以分割备份文件</li>
</ol>
<p>运行前请确保：</p>
<ol>
<li>MySQL 5.7 服务正在运行</li>
<li>备份目录有写入权限</li>
<li>防火墙允许MySQL连接</li>
<li>密码正确无误</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java泛型不变性引发的类型转换问题及解决方案]]></title>    <link>https://juejin.cn/post/7579935414422716462</link>    <guid>https://juejin.cn/post/7579935414422716462</guid>    <pubDate>2025-12-05T06:58:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579935414422716462" data-draft-id="7579961957222105115" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java泛型不变性引发的类型转换问题及解决方案"/> <meta itemprop="keywords" content="Java,C#"/> <meta itemprop="datePublished" content="2025-12-05T06:58:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神奇的板烧"/> <meta itemprop="url" content="https://juejin.cn/user/3843548381983822"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java泛型不变性引发的类型转换问题及解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548381983822/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神奇的板烧
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T06:58:33.000Z" title="Fri Dec 05 2025 06:58:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Java泛型的协变与逆变，及C#对比</h2>
<h3 data-id="heading-1">问题本质</h3>
<p>虽然<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">StudyPoint</a>实现了<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">IAdjIniPoint</a>接口，但<code>List&lt;StudyPoint&gt;</code>和<code>List&lt;IAdjIniPoint&gt;</code>在Java泛型体系中是<strong>完全不同的类型</strong>，不能直接赋值。</p>
<h3 data-id="heading-2">核心概念</h3>
<h4 data-id="heading-3">1. 泛型的不变性(Invariance)</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 这在Java中是不允许的，即使StudyPoint implements IAdjIniPoint</span>
List&lt;IAdjIniPoint&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;StudyPoint&gt;(); <span class="hljs-comment">// 编译错误！</span>
</code></pre>
<h4 data-id="heading-4">2. 协变(Covariance) - 使用extends关键字</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 只读场景，允许子类型赋值给父类型</span>
List&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IAdjIniPoint</span>&gt; readOnlyList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;StudyPoint&gt;();
<span class="hljs-type">IAdjIniPoint</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> readOnlyList.get(<span class="hljs-number">0</span>); <span class="hljs-comment">// 可以读取</span>
<span class="hljs-comment">// readOnlyList.add(new StudyPoint()); // ❌ 不能添加，编译错误</span>
</code></pre>
<h4 data-id="heading-5">3. 逆变(Contravariance) - 使用super关键字</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 只写场景，允许父类型赋值给子类型</span>
List&lt;? <span class="hljs-built_in">super</span> StudyPoint&gt; writeOnlyList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;IAdjIniPoint&gt;();
writeOnlyList.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StudyPoint</span>()); <span class="hljs-comment">// ✅ 可以添加</span>
<span class="hljs-comment">// IAdjIniPoint item = writeOnlyList.get(0); // ❌ 不能读取具体类型</span>
</code></pre>
<h3 data-id="heading-6">解决方案对比</h3>



































<table><thead><tr><th>方案</th><th>代码示例</th><th>适用场景</th><th>优缺点</th></tr></thead><tbody><tr><td><strong>类型转换</strong></td><td><code>List&lt;IAdjIniPoint&gt; list = new ArrayList&lt;&gt;(studyPointList);</code></td><td>最常用</td><td>✅ 简单直观，✅ 类型安全</td></tr><tr><td><strong>修改返回类型</strong></td><td><code>List&lt;IAdjIniPoint&gt; listPointByGroupId(...)</code></td><td>API设计阶段</td><td>✅ 一劳永逸，❌ 可能影响现有代码</td></tr><tr><td><strong>使用通配符</strong></td><td><code>List&lt;? extends IAdjIniPoint&gt; list = ...</code></td><td>只读操作</td><td>✅ 灵活，❌ 限制较多</td></tr><tr><td><strong>强制转换</strong></td><td><code>(List&lt;IAdjIniPoint&gt;)(List&lt;?&gt;)list</code></td><td>不推荐</td><td>❌ 不安全，❌ 难维护</td></tr></tbody></table>
<h3 data-id="heading-7">最佳实践建议</h3>
<ol>
<li><strong>优先使用类型转换</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java">List&lt;StudyPoint&gt; studyPoints = service.getList();
List&lt;IAdjIniPoint&gt; interfaceList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(studyPoints);
</code></pre>
<ol start="2">
<li><strong>在设计API时考虑泛型协变</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 设计时就考虑返回接口类型</span>
<span class="hljs-keyword">public</span> List&lt;IAdjIniPoint&gt; <span class="hljs-title function_">listPointByGroupId</span><span class="hljs-params">(Integer groupId)</span> {
    List&lt;StudyPoint&gt; points = <span class="hljs-comment">// 获取具体实现</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(points); <span class="hljs-comment">// 自动协变</span>
}
</code></pre>
<ol start="3">
<li><strong>理解PECS原则</strong>：
<ul>
<li><strong>Producer Extends</strong>: 只读用<code>? extends T</code></li>
<li><strong>Consumer Super</strong>: 只写用<code>? super T</code></li>
</ul>
</li>
</ol>
<p>是的，C#和Java在继承和泛型方面的处理确实有一些重要区别。让我为你详细对比一下：</p>
<h2 data-id="heading-8">C# vs Java 继承和泛型对比</h2>
<h3 data-id="heading-9">1. 泛型协变/逆变支持</h3>
<h4 data-id="heading-10">Java</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java - 泛型不变性（默认）</span>
List&lt;StudyPoint&gt; studyPoints = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
<span class="hljs-comment">// ❌ 编译错误 - 泛型不变性</span>
List&lt;IAdjIniPoint&gt; interfaceList = studyPoints;  

<span class="hljs-comment">// Java - 需要显式处理协变</span>
List&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IAdjIniPoint</span>&gt; readOnlyList = studyPoints;  <span class="hljs-comment">// ✅ 只读</span>
List&lt;? <span class="hljs-built_in">super</span> StudyPoint&gt; writeOnlyList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;IAdjIniPoint&gt;(); <span class="hljs-comment">// ✅ 只写</span>
</code></pre>
<h4 data-id="heading-11">C#</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// C# - 支持声明性协变（接口和委托）</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title">IEnumerable</span>&lt;<span class="hljs-keyword">out</span> <span class="hljs-title">T</span>&gt;  <span class="hljs-comment">// out关键字表示协变</span>
{
    T Current { <span class="hljs-keyword">get</span>; }
}

IEnumerable&lt;StudyPoint&gt; studyPoints = <span class="hljs-keyword">new</span> List&lt;StudyPoint&gt;();
IEnumerable&lt;IAdjIniPoint&gt; interfaceList = studyPoints;  <span class="hljs-comment">// ✅ 直接赋值</span>
</code></pre>
<h3 data-id="heading-12">2. 数组协变</h3>
<h4 data-id="heading-13">Java</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java - 数组协变（运行时可能出错）</span>
StudyPoint[] studyPoints = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StudyPoint</span>[<span class="hljs-number">10</span>];
IAdjIniPoint[] interfaceArray = studyPoints;  <span class="hljs-comment">// ✅ 编译通过</span>
interfaceArray[<span class="hljs-number">0</span>] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OtherImplementation</span>(); <span class="hljs-comment">// ❌ 运行时ArrayStoreException</span>
</code></pre>
<h4 data-id="heading-14">C#</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// C# - 数组协变（仅限引用类型）</span>
StudyPoint[] studyPoints = <span class="hljs-keyword">new</span> StudyPoint[<span class="hljs-number">10</span>];
IAdjIniPoint[] interfaceArray = studyPoints;  <span class="hljs-comment">// ✅ 编译通过</span>
interfaceArray[<span class="hljs-number">0</span>] = <span class="hljs-keyword">new</span> OtherImplementation(); <span class="hljs-comment">// ❌ 运行时ArrayTypeMismatchException</span>
</code></pre>
<h3 data-id="heading-15">3. 方法重写和泛型</h3>
<h4 data-id="heading-16">Java</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java - 方法签名必须严格匹配</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PointGroupService</span> {
    List&lt;IAdjIniPoint&gt; <span class="hljs-title function_">listPointByGroupId</span><span class="hljs-params">(Integer groupId)</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PointGroupServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PointGroupService</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;IAdjIniPoint&gt; <span class="hljs-title function_">listPointByGroupId</span><span class="hljs-params">(Integer groupId)</span> {  <span class="hljs-comment">// 必须完全匹配</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    }
}
</code></pre>
<h4 data-id="heading-17">C#</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// C# - 支持返回类型协变（C# 9.0+）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PointGroupService</span> 
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-title">List</span>&lt;<span class="hljs-title">IAdjIniPoint</span>&gt; <span class="hljs-title">ListPointByGroupId</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> groupId</span>)</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">PointGroupServiceImpl</span> : <span class="hljs-title">PointGroupService</span> 
{
    <span class="hljs-comment">// C# 9.0+ 支持返回类型协变</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-title">List</span>&lt;<span class="hljs-title">StudyPoint</span>&gt; <span class="hljs-title">ListPointByGroupId</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> groupId</span>)  <span class="hljs-comment">// 返回更具体的类型</span></span>
    {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> List&lt;StudyPoint&gt;();
    }
}
</code></pre>
<h3 data-id="heading-18">4. 类型推断</h3>
<h4 data-id="heading-19">Java</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java - 需要显式类型声明或转换</span>
List&lt;StudyPoint&gt; studyPoints = pointGroupService.listPointByGroupId(groupId);
List&lt;IAdjIniPoint&gt; interfaceList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(studyPoints);  <span class="hljs-comment">// 需要手动转换</span>
</code></pre>
<h4 data-id="heading-20">C#</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// C# - 更强大的类型推断</span>
<span class="hljs-keyword">var</span> studyPoints = pointGroupService.ListPointByGroupId(groupId);  <span class="hljs-comment">// 自动推断类型</span>
IEnumerable&lt;IAdjIniPoint&gt; interfaceList = studyPoints;  <span class="hljs-comment">// 自动协变</span>
</code></pre>
<h3 data-id="heading-21">5. 约束系统</h3>
<h4 data-id="heading-22">Java</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java - 泛型约束</span>
<span class="hljs-keyword">public</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IAdjIniPoint</span>&gt; <span class="hljs-keyword">void</span> <span class="hljs-title function_">processPoints</span><span class="hljs-params">(List&lt;T&gt; points)</span> {
    <span class="hljs-comment">// 处理点列表</span>
}
</code></pre>
<h4 data-id="heading-23">C#</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// C# - 更丰富的约束系统</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProcessPoints</span>&lt;<span class="hljs-title">T</span>&gt;(<span class="hljs-params">List&lt;T&gt; points</span>) <span class="hljs-keyword">where</span> T : IAdjIniPoint, <span class="hljs-keyword">new</span>()</span>
{
    <span class="hljs-comment">// T必须实现IAdjIniPoint且有无参构造函数</span>
}
</code></pre>
<h2 data-id="heading-24">实际应用场景对比</h2>
<h3 data-id="heading-25">场景：获取学习点列表</h3>
<h4 data-id="heading-26">Java方式</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java - 需要显式处理类型转换</span>
<span class="hljs-keyword">public</span> List&lt;IAdjIniPoint&gt; <span class="hljs-title function_">listPointByGroupId</span><span class="hljs-params">(Integer groupId)</span> {
    List&lt;StudyPoint&gt; studyPoints = <span class="hljs-comment">// 获取具体实现</span>
    List&lt;IAdjIniPoint&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    result.addAll(studyPoints);  <span class="hljs-comment">// 显式添加</span>
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<h4 data-id="heading-27">C#方式</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// C# - 更简洁的处理方式</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> IEnumerable&lt;IAdjIniPoint&gt; <span class="hljs-title">ListPointByGroupId</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> groupId</span>)</span> 
{
    <span class="hljs-keyword">var</span> studyPoints = <span class="hljs-comment">// 获取具体实现</span>
    <span class="hljs-keyword">return</span> studyPoints;  <span class="hljs-comment">// 自动协变转换</span>
}
</code></pre>
<h2 data-id="heading-28">总结</h2>



































<table><thead><tr><th>特性</th><th>Java</th><th>C#</th></tr></thead><tbody><tr><td>泛型协变</td><td>需要显式声明(<code>? extends T</code>)</td><td>接口支持声明性协变(<code>out T</code>)</td></tr><tr><td>数组协变</td><td>支持（运行时检查）</td><td>支持（运行时检查）</td></tr><tr><td>返回类型协变</td><td>不支持</td><td>C# 9.0+支持</td></tr><tr><td>类型推断</td><td>较弱</td><td>较强</td></tr><tr><td>约束系统</td><td>基础约束</td><td>丰富约束</td></tr></tbody></table>
<p><strong>关键差异</strong>：C#在设计时就考虑了协变支持，提供了更灵活的类型系统，而Java需要开发者手动处理大部分协变场景，这使得Java在这方面显得更加严格但也更复杂。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GalleryPicker:一个基于 Android 官方 Photo Picker API 封装的现代图片/视频选择库]]></title>    <link>https://juejin.cn/post/7579934463589711908</link>    <guid>https://juejin.cn/post/7579934463589711908</guid>    <pubDate>2025-12-05T07:00:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579934463589711908" data-draft-id="7579945518344880143" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GalleryPicker:一个基于 Android 官方 Photo Picker API 封装的现代图片/视频选择库"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-05T07:00:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Nerve"/> <meta itemprop="url" content="https://juejin.cn/user/3438928101639512"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GalleryPicker:一个基于 Android 官方 Photo Picker API 封装的现代图片/视频选择库
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3438928101639512/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Nerve
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T07:00:47.000Z" title="Fri Dec 05 2025 07:00:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">GalleryPicker</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fopensource.org%2Flicenses%2FApache-2.0" target="_blank" title="https://opensource.org/licenses/Apache-2.0" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f6493fd394c4eeebe80269440208a65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmVydmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765522847&amp;x-signature=wF7fvNtKgVST5nXDpVxtH3UuwnI%3D" alt="License" loading="lazy"/></a>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fjitpack.io%2F%23darryrzhong%2FGalleryPicker" target="_blank" title="https://jitpack.io/#darryrzhong/GalleryPicker" ref="nofollow noopener noreferrer"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b49a93de6b864bd3825d467a0f7a4b75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmVydmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765522847&amp;x-signature=LxR4pr0Fa0UupAuQPAHO296h%2BJQ%3D" alt="" loading="lazy"/></a></p>
<p align="center">
  <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/998fbf1785624439ab56e34967a4def4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmVydmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765522847&amp;x-signature=ygej8MI0RkiHrRuzA32J7SX5v0g%3D" alt="picker" width="206" height="443" loading="lazy"/>
</p>
<p>GalleryPicker 是一个基于 Android 官方 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.google.cn%2Ftraining%2Fdata-storage%2Fshared%2Fphoto-picker" target="_blank" title="https://developer.android.google.cn/training/data-storage/shared/photo-picker" ref="nofollow noopener noreferrer">Photo Picker API</a> 封装的现代图片/视频选择库。它专注于提供<strong>统一、简洁、可兼容多 Android 版本</strong>的媒体选择能力，支持从相册获取图片/视频、拍照、图片裁剪、压缩等功能，且无需获取任何存储权限即可适配 Android 5.0+ 系统。</p>
<p>简体中文 | <a href="https://link.juejin.cn?target=.%2FREADME.md" target="_blank" title="./README.md" ref="nofollow noopener noreferrer">English</a></p>
<h3 data-id="heading-1">功能特性</h3>
<ul>
<li><strong>无需权限</strong>：使用系统标准 Photo Picker，无需申请 <code>READ_EXTERNAL_STORAGE</code> 权限（Android 11+）。</li>
<li><strong>多版本适配</strong>：
<ul>
<li><strong>Android 11 (API 30) +</strong>：使用原生 Photo Picker。</li>
<li><strong>Android 4.4 (API 19) - Android 10 (API 29)</strong>：通过 Google Play 服务自动向后移植 Photo Picker，或回退到系统文件选择器 (<code>ACTION_OPEN_DOCUMENT</code>)。</li>
</ul>
</li>
<li><strong>功能丰富</strong>：
<ul>
<li>支持单选/多选图片和视频。</li>
<li>支持调用相机拍照和录制视频。</li>
<li>支持图片裁剪（仅限单选）。</li>
<li>支持图片压缩（Luban 算法）。</li>
<li>支持混合单选（图片或视频）。</li>
</ul>
</li>
<li><strong>易于使用</strong>：链式调用，回调清晰。</li>
</ul>
<h3 data-id="heading-2">接入指南</h3>
<p>本文档提供了将 GalleryPicker 库集成到您的 Android 应用程序中的详细指南。</p>
<h4 data-id="heading-3">1. 添加依赖</h4>
<p>在您的项目 <code>build.gradle</code> 文件中添加 JitPack 仓库和依赖项。</p>
<p><strong>根目录 <code>build.gradle</code>:</strong></p>
<pre><code class="hljs language-gradle" lang="gradle">allprojects {
    repositories {
        ...
        maven { url 'https://jitpack.io' }
    }
}
</code></pre>
<p><strong>App 模块 <code>build.gradle</code>:</strong></p>
<pre><code class="hljs language-gradle" lang="gradle">dependencies {
    implementation 'com.github.darryrzhong:GalleryPicker:1.0.0' // 请检查最新版本
}
</code></pre>
<h4 data-id="heading-4">2. 初始化全局配置 (可选)</h4>
<p>你可以在 Application 中进行全局配置，如果不设置则使用默认配置。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">GalleryPickerOption.setColorPrimary(R.color.purple_200) <span class="hljs-comment">// 设置app主题色</span>
    .setTextColorPrimary(R.color.white) <span class="hljs-comment">// 设置app主题色搭配字体色</span>
    .maxItems(<span class="hljs-number">1</span>) <span class="hljs-comment">// 设置最大选择数量  1 单选  &gt;1多选</span>
    .isCompress(<span class="hljs-literal">true</span>) <span class="hljs-comment">// 默认图片压缩</span>
    .ignoreSize(<span class="hljs-number">100</span>)  <span class="hljs-comment">// 小于100kb文件不进行压缩</span>
    .quality(<span class="hljs-number">75</span>)  <span class="hljs-comment">// 压缩比例 默认75%</span>
    .isCrop(<span class="hljs-literal">false</span>) <span class="hljs-comment">// 是否进行图片裁剪  默认不裁剪</span>
    .maxVideoSize(<span class="hljs-number">15</span>) <span class="hljs-comment">// 最大选择视频文件大小  默认15Mb</span>
    .debug(<span class="hljs-literal">false</span>)  <span class="hljs-comment">// 日志调试</span>
</code></pre>
<h4 data-id="heading-5">3. 权限配置</h4>
<p><strong>特别提醒</strong>：使用 Photo Picker 选择媒体文件不需要任何存储权限。但是，如果需要使用<strong>相机拍照</strong>或<strong>录制视频</strong>，虽然 Android 11+ 调用系统相机不需要权限，但如果你的应用清单中声明了相机权限，则必须在运行时获取该权限。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.CAMERA"</span> /&gt;</span>
</code></pre>
<h4 data-id="heading-6">4. 配置 FileProvider (仅拍照/录像需要)</h4>
<p>为了让相机应用能够将拍摄的照片/视频保存到你的应用私有目录，需要配置 <code>FileProvider</code>。</p>
<ol>
<li>在 <code>AndroidManifest.xml</code> 中添加 <code>provider</code>：</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">provider</span>
    <span class="hljs-attr">android:name</span>=<span class="hljs-string">"androidx.core.content.FileProvider"</span>
    <span class="hljs-attr">android:authorities</span>=<span class="hljs-string">"${applicationId}.fileprovider"</span>
    <span class="hljs-attr">android:exported</span>=<span class="hljs-string">"false"</span>
    <span class="hljs-attr">android:grantUriPermissions</span>=<span class="hljs-string">"true"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta-data</span>
        <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.support.FILE_PROVIDER_PATHS"</span>
        <span class="hljs-attr">android:resource</span>=<span class="hljs-string">"@xml/file_paths"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">provider</span>&gt;</span>
</code></pre>
<ol start="2">
<li>在 <code>res/xml</code> 目录下创建 <code>file_paths.xml</code>：</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">paths</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">cache-path</span>
            <span class="hljs-attr">name</span>=<span class="hljs-string">"picture_photo"</span>
            <span class="hljs-attr">path</span>=<span class="hljs-string">"picture_photo/"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">paths</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span>
</code></pre>
<h3 data-id="heading-7">进阶使用</h3>
<p>使用 <code>GalleryPickerHelper</code> 进行媒体选择，无需关心页面跳转及生命周期管理。</p>
<h4 data-id="heading-8">1. 启动参数配置</h4>
<p>启动参数的优先级高于全局默认配置。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">GalleryPickerHelper.newInstance()
    .isCompress(<span class="hljs-literal">true</span>)
    .isCrop(<span class="hljs-literal">true</span>)
    .ignoreSize(<span class="hljs-number">100</span>) <span class="hljs-comment">// kb</span>
    .quality(<span class="hljs-number">75</span>) <span class="hljs-comment">// 75%</span>
    .maxItems(<span class="hljs-number">9</span>) <span class="hljs-comment">// 单选 or 多选</span>
    .maxVideoSize(<span class="hljs-number">15</span>) <span class="hljs-comment">// 视频文件大小限制 MB</span>
    .launchMediaPicker(<span class="hljs-keyword">this</span>, MediaType.IMAGE, <span class="hljs-keyword">object</span> : MediaResultCallback {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMediaResult</span><span class="hljs-params">(mediaFiles: <span class="hljs-type">List</span>&lt;<span class="hljs-type">MediaData</span>&gt;)</span></span> {
            <span class="hljs-comment">// 处理结果</span>
        }
    })
</code></pre>
<h4 data-id="heading-9">2. 相册获取 (单选)</h4>
<pre><code class="hljs language-kotlin" lang="kotlin">GalleryPickerHelper.newInstance()
    .launchMediaPicker(
        requireActivity(),
        MediaType.IMAGE, <span class="hljs-keyword">object</span> : MediaResultCallback {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMediaResult</span><span class="hljs-params">(mediaFiles: <span class="hljs-type">List</span>&lt;<span class="hljs-type">MediaData</span>&gt;)</span></span> {
                mediaFiles.firstOrNull()?.let {
                    <span class="hljs-keyword">val</span> paths = arrayListOf&lt;String&gt;()
                    paths.add(it.filePath)
                    <span class="hljs-comment">// 预览图片</span>
                    GalleryPickerHelper.toPreViewImage(requireActivity(), <span class="hljs-number">0</span>, paths)
                }
            }
        })
</code></pre>
<h4 data-id="heading-10">3. 相册获取 (多选)</h4>
<pre><code class="hljs language-kotlin" lang="kotlin">GalleryPickerHelper.newInstance()
    .maxItems(<span class="hljs-number">9</span>)
    .launchMediaPicker(
        requireActivity(),
        MediaType.IMAGE, <span class="hljs-keyword">object</span> : MediaResultCallback {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMediaResult</span><span class="hljs-params">(mediaFiles: <span class="hljs-type">List</span>&lt;<span class="hljs-type">MediaData</span>&gt;)</span></span> {
                <span class="hljs-keyword">if</span> (mediaFiles.isNotEmpty()) {
                    <span class="hljs-keyword">val</span> paths = arrayListOf&lt;String&gt;()
                    mediaFiles.forEach {
                        paths.add(it.filePath)
                    }
                    GalleryPickerHelper.toPreViewImage(requireActivity(), <span class="hljs-number">0</span>, paths)
                }
            }
        })
</code></pre>
<p align="center">
  <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8563b49f4e64b73a521de06dec07b98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmVydmU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765522847&amp;x-signature=eLdgfxAis9BK%2FVhoVFNoXALeXEA%3D" alt="demo" width="206" height="443" loading="lazy"/>
</p>
<h4 data-id="heading-11">4. 相册获取 (带裁剪)</h4>
<p>图片裁剪只支持<strong>单选模式</strong>。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">GalleryPickerHelper.newInstance()
    .isCrop(<span class="hljs-literal">true</span>)
    .launchMediaPicker(
        requireActivity(),
        MediaType.IMAGE, <span class="hljs-keyword">object</span> : MediaResultCallback {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMediaResult</span><span class="hljs-params">(mediaFiles: <span class="hljs-type">List</span>&lt;<span class="hljs-type">MediaData</span>&gt;)</span></span> {
                <span class="hljs-comment">// 返回的是裁剪后的图片路径</span>
                mediaFiles.firstOrNull()?.let {
                    <span class="hljs-keyword">val</span> paths = arrayListOf&lt;String&gt;()
                    paths.add(it.filePath)
                    GalleryPickerHelper.toPreViewImage(requireActivity(), <span class="hljs-number">0</span>, paths)
                }
            }
        })
</code></pre>
<h4 data-id="heading-12">5. 拍照选择</h4>
<p>调用拍照前，请确保已处理好相机权限（如果清单文件中声明了）。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">GalleryPickerHelper.newInstance()
    .launchMediaPicker(
        requireActivity(),
        MediaType.CAMERA, <span class="hljs-keyword">object</span> : MediaResultCallback {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMediaResult</span><span class="hljs-params">(mediaFiles: <span class="hljs-type">List</span>&lt;<span class="hljs-type">MediaData</span>&gt;)</span></span> {
                mediaFiles.firstOrNull()?.let {
                    <span class="hljs-keyword">val</span> paths = arrayListOf&lt;String&gt;()
                    paths.add(it.filePath)
                    GalleryPickerHelper.toPreViewImage(requireActivity(), <span class="hljs-number">0</span>, paths)
                }
            }
        })
</code></pre>
<h4 data-id="heading-13">6. 视频选择</h4>
<p>视频选择支持设置最大文件大小限制（默认 15MB）。目前仅支持单选。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">GalleryPickerHelper.newInstance()
    .launchMediaPicker(
        requireActivity(),
        MediaType.VIDEO, <span class="hljs-keyword">object</span> : MediaResultCallback {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMediaResult</span><span class="hljs-params">(mediaFiles: <span class="hljs-type">List</span>&lt;<span class="hljs-type">MediaData</span>&gt;)</span></span> {
                mediaFiles.firstOrNull()?.let {
                    GalleryPickerHelper.toPreViewVideo(requireActivity(), it.filePath)
                }
            }
        })
</code></pre>
<h4 data-id="heading-14">7. 图片 &amp; 视频混合选择</h4>
<p>支持同时展示图片和视频，但用户只能选择其中一种类型（单选）。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">GalleryPickerHelper.newInstance()
    .launchMediaPicker(
        requireActivity(),
        MediaType.IMAGE_OR_VIDEO, <span class="hljs-keyword">object</span> : MediaResultCallback {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMediaResult</span><span class="hljs-params">(mediaFiles: <span class="hljs-type">List</span>&lt;<span class="hljs-type">MediaData</span>&gt;)</span></span> {
                mediaFiles.firstOrNull()?.let {
                    <span class="hljs-keyword">if</span> (it.mimeType == MimeType.VIDEO) {
                        GalleryPickerHelper.toPreViewVideo(requireActivity(), it.filePath)
                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (it.mimeType == MimeType.IMAGE) {
                        <span class="hljs-keyword">val</span> paths = arrayListOf&lt;String&gt;()
                        paths.add(it.filePath)
                        GalleryPickerHelper.toPreViewImage(requireActivity(), <span class="hljs-number">0</span>, paths)
                    }
                }
            }
        })
</code></pre>
<h4 data-id="heading-15">8. 拍摄视频</h4>
<pre><code class="hljs language-kotlin" lang="kotlin">GalleryPickerHelper.newInstance()
    .launchMediaPicker(
        requireActivity(),
        MediaType.CAPTURE_VIDEO, <span class="hljs-keyword">object</span> : MediaResultCallback {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMediaResult</span><span class="hljs-params">(mediaFiles: <span class="hljs-type">List</span>&lt;<span class="hljs-type">MediaData</span>&gt;)</span></span> {
                mediaFiles.firstOrNull()?.let {
                    GalleryPickerHelper.toPreViewVideo(requireActivity(), it.filePath)
                }
            }
        })
</code></pre>
<h4 data-id="heading-16">9. 辅助功能</h4>
<ul>
<li>
<p><strong>图片预览</strong> (仅支持本地路径):</p>
<pre><code class="hljs language-kotlin" lang="kotlin">GalleryPickerHelper.toPreViewImage(<span class="hljs-keyword">this</span>, <span class="hljs-number">0</span>, arrayListOf(<span class="hljs-string">"path1"</span>, <span class="hljs-string">"path2"</span>))
</code></pre>
</li>
<li>
<p><strong>视频预览</strong> (仅支持本地路径):</p>
<pre><code class="hljs language-kotlin" lang="kotlin">GalleryPickerHelper.toPreViewVideo(<span class="hljs-keyword">this</span>, <span class="hljs-string">"video_path"</span>)
</code></pre>
</li>
<li>
<p><strong>检查设备兼容性</strong>:</p>
<pre><code class="hljs language-kotlin" lang="kotlin">GalleryPickerHelper.isPhotoPickerAvailable(<span class="hljs-keyword">this</span>)
</code></pre>
</li>
</ul>
<h3 data-id="heading-17">设备兼容性说明</h3>
<p>照片选择器适用于符合以下条件的设备：</p>
<ul>
<li>搭载 <strong>Android 11 (API 30)</strong> 或更高版本。</li>
<li>通过 Google 系统更新接收对模块化系统组件的更改。</li>
</ul>
<p>对于搭载 <strong>Android 4.4 (API 19) 到 Android 10 (API 29)</strong> 的设备，以及搭载 Android 11 或 12 且支持 Google Play 服务的 Android Go 设备，Google Play 服务会自动安装向后移植的照片选择器模块。</p>
<p>如需通过 Google Play 服务自动安装向后移植的照片选择器模块，请将以下条目添加到应用清单文件的  标记中:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Trigger Google Play services to install the backported photo picker module. --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">service</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.google.android.gms.metadata.ModuleDependencies"</span>
         <span class="hljs-attr">android:enabled</span>=<span class="hljs-string">"false"</span>
         <span class="hljs-attr">android:exported</span>=<span class="hljs-string">"false"</span>
         <span class="hljs-attr">tools:ignore</span>=<span class="hljs-string">"MissingClass"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">intent-filter</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"com.google.android.gms.metadata.MODULE_DEPENDENCIES"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">intent-filter</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta-data</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"photopicker_activity:0:required"</span> <span class="hljs-attr">android:value</span>=<span class="hljs-string">""</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">service</span>&gt;</span>
</code></pre>
<p>如果照片选择器不可用，本库会自动降级调用 <code>ACTION_OPEN_DOCUMENT</code> intent，以系统文件管理器的方式进行媒体选择（此时系统会忽略最大选择数量限制）。</p>
<h3 data-id="heading-18">demo</h3>
<p><a href="https://link.juejin.cn?target=.%2Fapp-release.apk" target="_blank" title="./app-release.apk" ref="nofollow noopener noreferrer">demo示例</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[对于原型、原型链和继承的理解]]></title>    <link>https://juejin.cn/post/7579926120096645183</link>    <guid>https://juejin.cn/post/7579926120096645183</guid>    <pubDate>2025-12-05T06:58:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579926120096645183" data-draft-id="7579934463589662756" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="对于原型、原型链和继承的理解"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-12-05T06:58:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="夜尽丶"/> <meta itemprop="url" content="https://juejin.cn/user/3263006244342062"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            对于原型、原型链和继承的理解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3263006244342062/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    夜尽丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T06:58:54.000Z" title="Fri Dec 05 2025 06:58:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>原型和原型链是前端老生常谈的问题，以前常常在各种面试题中看到，我自己也背过不少次，但总是感觉磕磕巴巴的，明显没有真正理解这一概念，最近又要面试，再次看到这个问题，突然有些豁然开朗的感觉，因为前阵子参加 game jam 时，做了一个小游戏，不可避免地用到了继承，再次看到原型链时才恍然大悟，原来原型链要解决的其实是 JavaScript 中对象继承的问题。这篇文章主要是结合一下自己以前对面向对象的理解，来理清一下对原型和原型链的认识。</p>
<h2 data-id="heading-0">原型和原型链</h2>
<p>先了解一下面向对象然后明确一些定义：JavaScript 是一种基于原型的语言，而不是基于类的语言，这一点和 Java、C# 这些传统的面向对象编程语言是不同的，但这不意味着 JavaScript 不是面向对象语言，回忆一下上学时学的面向对象的三大特性：封装、继承、多态，JavaScript 均可以实现，但今天我们主要关注的是继承，而继承的实现就是通过原型和原型链。</p>
<h3 data-id="heading-1">原型</h3>
<p>直接说定义未免太过抽象，我们先看一个简单的例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>,
  <span class="hljs-attr">greet</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello, "</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
  },
};
</code></pre>
<p>我们简单创建了一个对象<code>obj</code>，它有一个属性<code>name</code>和一个方法<code>greet</code>，当我们调用<code>obj.greet()</code>时，它会输出<code>Hello, Alice</code>，或者我们可以输出<code>obj.name</code>来获取属性值，但当我们在 obj 后面加上一个点，比如<code>obj.</code>，这时会弹出一个提示框，显示出的属性和方法远不止这两个，这些属性和方法是从哪里来的呢？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30d9eda9c7904c0fbeecd192d590cd7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSc5bC95Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765522734&amp;x-signature=swJsc55v2K4VWk00QU%2FwqIHBcRI%3D" alt="" loading="lazy"/></p>
<p>试着访问其中一个，比如<code>toString</code>方法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-title function_">toString</span>()); <span class="hljs-comment">// [object Object]</span>
</code></pre>
<p>结果不是<code>undefined</code>，<code>toString</code>方法并不是我们在创建<code>obj</code>时定义的，那么它是从哪里来的呢？这就涉及到原型和原型链的概念了，JavaScript 中的数据类型分为值类型和引用类型，而一切引用类型都是对象，原型和原型链正是服务于对象的概念，同时，对象由属性组成，而 js 的每个对象都有一个内部属性<code>__proto__</code>，除此之外，函数对象都有一个属性<code>prototype</code>，<code>__proto__</code>会指向一个<code>prototype</code>对象。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d93e55223664e0284abe33f37b481e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSc5bC95Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765522734&amp;x-signature=yDIfde84q3BBn2DuVyB64KdGRLQ%3D" alt="" loading="lazy"/></p>
<p>具体是如何指向的，我们继续通过代码示例来看：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
}
<span class="hljs-keyword">const</span> person1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"Alice"</span>);
</code></pre>
<p><code>Person</code>是一个函数对象，<code>person1</code>是一个实例对象，两者都有各自的<code>__proto__</code>属性，同时<code>Person</code>函数对象还有一个<code>prototype</code>属性，关系如下：</p>
<ul>
<li><code>Person.__proto__</code>：指向<code>Function.prototype</code>，因为<code>Person</code>是一个函数对象</li>
<li><code>Person.prototype</code>：值是一个对象，包含了通过<code>Person</code>创建的实例对象所共享的属性和方法</li>
<li><code>person1.__proto__</code>：指向<code>Person.prototype</code>，表示<code>person1</code>实例对象继承自<code>Person.prototype</code></li>
</ul>
<p>我们一般说对象的<code>__proto__</code>属性所指向的对象就是它的原型，在这个例子中，<code>person1.__proto__</code>指向<code>Person.prototype</code>，所以<code>Person.prototype</code>就是<code>person1</code>的原型，而<code>Person.__proto__</code>指向<code>Function.prototype</code>，所以<code>Person</code>的原型就是<code>Function.prototype</code>。</p>
<p>也许还不够直观，我们把上面的内容转成图像：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/baadcd4374504f56b96d03df2eb83163~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSc5bC95Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765522734&amp;x-signature=mpLlLrAbzX0WVhyt7I4fjWoVd8g%3D" alt="" loading="lazy"/></p>
<p>我认为这样足够清晰了，而它们的关系形成了一串链条，这就是原型链，所以上面的例子中在调用<code>obj.toString()</code>时，JavaScript 引擎会先在<code>obj</code>对象上查找<code>toString</code>方法，如果没有找到，就会沿着原型链向上查找，最终在<code>Object.prototype</code>上找到了这个方法，原型链的详细过程我们之后再说，关于原型还有一些问题要解决，我们已经知道了<code>__proto__</code>是一个属性，并指向一个<code>prototype</code>对象，而<code>prototype</code>的值是什么呢？</p>
<blockquote>
<p><code>prototype</code>属性的值是一个对象，这个对象包含了通过该函数创建的实例对象所共享的属性和方法。默认情况下，这个对象只有一个<code>constructor</code>属性，指向构造函数本身。</p>
</blockquote>
<p>又出现了一个陌生的概念——构造函数，接下来我们先理解构造函数。</p>
<h3 data-id="heading-2">构造函数</h3>
<p>创建一个对象最常见的方式有两种，上文中的两个例子刚好对应这两种方式：</p>
<ol>
<li>对象字面量</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = { <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span> };
</code></pre>
<ol start="2">
<li>构造函数</li>
</ol>
<p>构造函数是用来创建对象的函数，通常以大写字母开头，以区分普通函数和构造函数，当我们使用<code>new</code>操作符调用一个函数时，这个函数就被当作构造函数来使用。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
}
<span class="hljs-keyword">const</span> person1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"Alice"</span>);
</code></pre>
<p>这两种方式有什么区别呢？对象字面量创建的对象是一个普通对象，而使用构造函数创建的对象是通过<code>new</code>操作符实例化出来的对象，我们前面说过，所有的对象都有<code>__proto__</code>属性，我们可以先比较一下这两种方式创建的对象的<code>__proto__</code>属性：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = { <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span> };
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
}
<span class="hljs-keyword">const</span> person1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"Alice"</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person1.<span class="hljs-property">__proto__</span> === <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>); <span class="hljs-comment">// true</span>
</code></pre>
<p>可以看到，<code>obj</code>的<code>__proto__</code>指向<code>Object.prototype</code>，而<code>person1</code>的<code>__proto__</code>指向<code>Person.prototype</code>，这说明通过对象字面量创建的对象继承自<code>Object.prototype</code>，而通过构造函数创建的对象继承自构造函数的<code>prototype</code>属性。</p>
<h4 data-id="heading-3">构造函数的作用</h4>
<p>说了那么多，我们为什么要通过构造函数来创建对象呢？有两个主要的作用：</p>
<ol>
<li>复用结构</li>
</ol>
<p>使用字面量创建对象时，每个对象都要手动创建，无法复用结构，而使用构造函数可以定义一个模板，通过<code>new</code>操作符创建多个实例对象，复用结构，其实就是面向对象编程中的类的概念。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> person1 = { <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">25</span> };
<span class="hljs-keyword">const</span> person2 = { <span class="hljs-attr">name</span>: <span class="hljs-string">"Bob"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> };
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name, age</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
}
<span class="hljs-keyword">const</span> person1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"Alice"</span>, <span class="hljs-number">25</span>);
<span class="hljs-keyword">const</span> person2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"Bob"</span>, <span class="hljs-number">30</span>);
</code></pre>
<ol start="2">
<li>继承</li>
</ol>
<p>构造函数的另一个重要作用是实现继承，通过构造函数创建的实例对象可以继承构造函数<code>prototype</code>属性上的方法和属性，从而实现代码的复用。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name, age</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
}
<span class="hljs-keyword">const</span> person1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"Alice"</span>, <span class="hljs-number">25</span>);
<span class="hljs-keyword">const</span> person2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"Bob"</span>, <span class="hljs-number">30</span>);
<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayHello</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hello, I'm <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
};
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person1.<span class="hljs-property">__proto__</span>);
person1.<span class="hljs-title function_">sayHello</span>(); <span class="hljs-comment">// "Hello, I'm Alice"</span>
person2.<span class="hljs-title function_">sayHello</span>(); <span class="hljs-comment">// "Hello, I'm Bob"</span>
</code></pre>
<p>这就引出了<code>prototype</code>属性的作用，<code>prototype</code>属性是函数对象特有的属性，它的作用就是为实例对象（person1、person2）提供原型对象，它告诉引擎应该继承哪个对象的属性和方法，实际上就是一个“实例原型指针”。</p>
<p>我们可以在控制台打印<code>Person.prototype</code>看看（这里用的是前面的例子，所以只有一个入参 <code>name</code>）：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6c5e26b7f2a4ef4873c5eccd149c729~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSc5bC95Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765522734&amp;x-signature=evw2V6zrliiDmbjC6o%2FKnInyYJE%3D" alt="" loading="lazy"/></p>
<p>可以看到，<code>Person.prototype</code>默认有一个<code>constructor</code>属性，指向<code>Person</code>函数本身，我们可以在<code>Person.prototype</code>上添加属性和方法，这些属性和方法会被所有通过<code>Person</code>构造函数创建的实例对象继承。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2584cd1ce21449299af1c2b875940435~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSc5bC95Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765522734&amp;x-signature=hwJzCv9ckuupM53P65Qs8DeXO9o%3D" alt="" loading="lazy"/></p>
<p>回忆一下，我们前面说过实例对象的<code>__proto__</code>属性指向构造函数的<code>prototype</code>属性，也就是说，<code>person1.__proto__ === Person.prototype</code>，所以当我们调用<code>person1.sayHello()</code>时，JavaScript 引擎会先在<code>person1</code>对象上查找<code>sayHello</code>方法，如果没有找到，就会沿着原型链向上查找，最终在<code>Person.prototype</code>上找到了这个方法，这就是原型链与继承。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/467745af191b494ca4229734b0da93cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSc5bC95Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765522734&amp;x-signature=tsIapLy6dAf%2Bysuu%2By2Dq2SgOa0%3D" alt="" loading="lazy"/></p>
<p>上图所示，<code>person1</code>对象的<code>__proto__</code>和<code>Person.prototype</code>是同一个对象，值得注意的是打印出来的对象中没有<code>__proto__</code>而是<code>[[Prototype]]</code>，这是因为在控制台打印对象时，浏览器会将<code>__proto__</code>属性显示为<code>[[Prototype]]</code>，但它们实际上是同一个东西，访问对象原型其实也不建议直接使用<code>__proto__</code>，而是使用<code>Object.getPrototypeOf()</code>方法。</p>
<h4 data-id="heading-4">new 操作符的作用</h4>
<p>现在我们说起 <code>new</code> 的作用时，应该也不那么晦涩难懂了，当我们使用<code>new Person("Alice")</code>创建实例对象时，实际上发生了以下几件事：</p>
<ol>
<li>创建一个新的空对象。</li>
<li>将这个新对象的<code>__proto__</code>属性指向构造函数的<code>prototype</code>属性。</li>
<li>将构造函数的<code>this</code>指向这个新对象，并执行构造函数的代码。</li>
<li>如果构造函数没有显式返回一个对象，则返回这个新对象。</li>
</ol>
<p>所以，<code>new</code>操作符的作用就是创建一个新的对象，并将其原型指向构造函数的<code>prototype</code>属性。</p>
<p>常见的<code>new</code>操作符手写题可以参考下面的代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">myNew</span>(<span class="hljs-params">Con, ...args</span>) {
  <span class="hljs-keyword">let</span> obj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Con</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
  <span class="hljs-keyword">let</span> result = <span class="hljs-title class_">Con</span>.<span class="hljs-title function_">apply</span>(obj, args);
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> result === <span class="hljs-string">"object"</span> ? result : obj;
}
</code></pre>
<blockquote>
<p><code>Object.create()</code> 方法创建一个新的对象，并允许你指定一个将被用作新对象原型的对象。</p>
</blockquote>
<h3 data-id="heading-5">原型链</h3>
<p>现在我们可以继续说原型链了，原型链是由对象的<code>__proto__</code>属性和构造函数的<code>prototype</code>属性组成的一条链条，它定义了对象之间的继承关系，当我们访问一个对象的属性或方法时，JavaScript 引擎会沿着这条链条向上查找，直到找到该属性或方法为止，或者到达链条的终点（即<code>null</code>），我们把上面的那张图完善一下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bd6c0837782408d9845a93b91305da4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSc5bC95Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765522734&amp;x-signature=r1hYysSWwpsPsIGZkhKynq4PhoU%3D" alt="" loading="lazy"/></p>
<p>好像复杂很多，不要急，我们还是一步步拆解。</p>
<ol>
<li>包含和指向</li>
</ol>
<p>包含关系比较简单，前面我们说过所有对象都有<code>__proto__</code>属性，而函数对象还有<code>prototype</code>属性，所以图中我用虚线表示，我们不用过多关注。<code>prototype</code>是一个对象，因此它也有<code>__proto__</code>属性，这个前面的图中没有体现，这里加上了。</p>
<ol start="2">
<li>Function.prototype</li>
</ol>
<p><code>Function</code>是 JavaScript 中的一个内置函数对象，所有函数对象的<code>__proto__</code>属性都指向<code>Function.prototype</code>，包括<code>Function</code>本身和<code>Object</code>（图中为了不让线条重叠，<code>Object.__proto__</code>的指向用了折线）。</p>
<ol start="3">
<li>Object.prototype</li>
</ol>
<p><code>Object</code>是 JavaScript 中的另一个内置函数对象，所有普通对象的<code>__proto__</code>属性最终都会指向<code>Object.prototype</code>，包括通过对象字面量创建的对象和通过构造函数创建的实例对象（图中为了不让线条重叠，<code>person1.__proto__</code>的指向用了折线）。</p>
<ol start="4">
<li>终点 null</li>
</ol>
<p><code>Object.prototype</code>的<code>__proto__</code>属性指向<code>null</code>，表示原型链的终点，当 JavaScript 引擎沿着原型链查找属性或方法时，如果到达了<code>null</code>，就会停止查找，并返回<code>undefined</code>。</p>
<p>最后我们可以在控制台中查看一下<code>person1.__proto__</code>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84e375199c6f4c2c956678eb88b46791~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSc5bC95Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765522734&amp;x-signature=lth8PZWCmb3LQzEfEw1yS5oCKyM%3D" alt="" loading="lazy"/></p>
<p>第一个框是<code>person1</code>的构造函数<code>Person</code>的<code>prototype</code>对象，第二个框是<code>Person.__proto__</code>，也就是<code>Function.prototype</code>，第三个框是<code>Function.prototype.__proto__</code>，也就是<code>Object.prototype</code>，最后是<code>person1.__proto__</code>，指向的是<code>Object.prototype</code>，这与我们上面的图是一致的。</p>
<h2 data-id="heading-6">原型和原型链的其他作用</h2>
<p>通过上面的分析，我们已经了解了原型和原型链的基本概念和作用，除了实现继承之外，原型和原型链还有其他一些作用：</p>
<ol>
<li>共享属性和方法，节省内存</li>
</ol>
<p>将多个实例共用的属性或方法挂载到构造函数的 prototype 上，所有实例会通过原型链共享这些资源，避免每个实例都重复创建相同的方法（大幅节省内存），例如上面的<code>Person.prototype.sayHello</code>方法。</p>
<ol start="2">
<li>扩展内置对象的功能</li>
</ol>
<p>通过原型链，我们可以为内置对象（如<code>Array</code>、<code>String</code>、<code>Object</code>等）添加新的方法，从而扩展它们的功能。例如，我们可以为<code>Array.prototype</code>添加一个新的方法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">first</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>[<span class="hljs-number">0</span>];
};
<span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-title function_">first</span>()); <span class="hljs-comment">// 1</span>
</code></pre>
<p>甚至你可以重写内置方法，比如你觉得 JS 原生的数组排序方法不符合你的需求，你可以重写 <code>Array.prototype.sort</code>，但不建议这样做，显然会带来一些严重的问题。其实这就是面向对象中多态的体现，不同的对象可以有不同的实现方式。</p>
<ol start="3">
<li>精准检测对象类型</li>
</ol>
<p>利用 <code>Object.prototype.toString</code> 方法（原型链顶层的方法），可以更精准地判断对象的原生类型（比 <code>typeof</code> 更可靠）—— 因为不同内置对象的原型链上，toString 方法被重写为 “返回自身类型”，而 <code>Object.prototype.toString</code> 能返回最原始的类型标识。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>([])); <span class="hljs-comment">// [object Array]</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>({})); <span class="hljs-comment">// [object Object]</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name, age</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
}
<span class="hljs-keyword">const</span> person1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"Alice"</span>, <span class="hljs-number">25</span>);
<span class="hljs-keyword">const</span> person2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"Bob"</span>, <span class="hljs-number">30</span>);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(<span class="hljs-title class_">Person</span>)); <span class="hljs-comment">// [object Function]</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(person1)); <span class="hljs-comment">// [object Object]</span>
</code></pre>
<h2 data-id="heading-7">JavaScript 中的类</h2>
<p>ES6 引入了类的概念，提供了一种更简洁和直观的方式来创建对象和处理继承。类实际上是基于原型和原型链实现的语法糖，背后仍然使用了构造函数和原型链机制。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, age</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
  }

  <span class="hljs-title function_">sayHello</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Hello, I'm <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
  }
}
<span class="hljs-keyword">const</span> person1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">"Alice"</span>, <span class="hljs-number">25</span>);
person1.<span class="hljs-title function_">sayHello</span>(); <span class="hljs-comment">// "Hello, I'm Alice"</span>
</code></pre>
<p>以上代码与我们之前使用构造函数创建对象的方式是等价的，类的<code>constructor</code>方法相当于构造函数，而类的方法（如<code>sayHello</code>）会被添加到类的<code>prototype</code>属性上，从而实现继承。</p>
<h2 data-id="heading-8">总结</h2>
<p>回想起来，后端的继承知识其实我一直都没有忘，但是在学习 JavaScript 时却没有能融会贯通，这么多年面对原型的问题还是靠死记硬背，实际上完成这篇文章时发现工作中很多时候都能用过与原型有关的知识点，另外，也是靠 AI 的帮助，才让我把这些零散的知识点串联起来，对于一些拿不准的地方，AI 可以给出相对准确的解释，帮助非常大。</p>
<h2 data-id="heading-9">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsegmentfault.com%2Fa%2F1190000042725370" target="_blank" title="https://segmentfault.com/a/1190000042725370" ref="nofollow noopener noreferrer">彻底搞懂 JS 原型与原型链</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FLearn_web_development%2FExtensions%2FAdvanced_JavaScript_objects%2FObject_prototypes" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Learn_web_development/Extensions/Advanced_JavaScript_objects/Object_prototypes" ref="nofollow noopener noreferrer">MDN - 对象原型</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【译】别再想着 Figma 了，AI 才是新的设计工具]]></title>    <link>https://juejin.cn/post/7579999793319264262</link>    <guid>https://juejin.cn/post/7579999793319264262</guid>    <pubDate>2025-12-05T07:01:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579999793319264262" data-draft-id="7579893536106594310" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【译】别再想着 Figma 了，AI 才是新的设计工具"/> <meta itemprop="keywords" content="前端,AI编程,WeUI"/> <meta itemprop="datePublished" content="2025-12-05T07:01:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="去码头整点薯片"/> <meta itemprop="url" content="https://juejin.cn/user/3104676568631917"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【译】别再想着 Figma 了，AI 才是新的设计工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3104676568631917/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    去码头整点薯片
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T07:01:14.000Z" title="Fri Dec 05 2025 07:01:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2Fdesign-bootcamp%2Fforget-figma-ai-is-the-new-design-tool-caa04fab3a35" target="_blank" title="https://medium.com/design-bootcamp/forget-figma-ai-is-the-new-design-tool-caa04fab3a35" ref="nofollow noopener noreferrer">Forget Figma, AI is the new Design tool</a></p>
<p>作者：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2F%40precious-m-e%3Fsource%3Dpost_page---byline--caa04fab3a35---------------------------------------" target="_blank" title="https://medium.com/@precious-m-e?source=post_page---byline--caa04fab3a35---------------------------------------" ref="nofollow noopener noreferrer">Precious Madubuike</a></p>
<h2 data-id="heading-0">小声 BB</h2>
<p><strong>本文在翻译过程中确保意思传达准确的前提下，会加入很多本人的个人解释和一些知识补充(使用引用块&amp;&amp;括号标注)</strong> ，像这样</p>
<blockquote>
<p>（我是一个平平无奇的知识补充块）</p>
</blockquote>
<p>AI 正在快速融入每个开发者的日常，正在逐步模糊每个工种的边界。每个前端开发可以上游摸索，去接触产品、UI 的工作内容；产品和 ui 设计师也能往下游探索，增加自己一点基础的开发能力，更好地去落地自己的天马行空的想法，可以做一些尝试，比如：</p>
<ul>
<li>用 ai 反哺自己的设计</li>
<li>去思考一些 ui 开发的新的合作方式。比如开发定了技术栈之后，ai 直接通过工具生成 component，让开发去接入到项目</li>
<li>直接通过 ai 工具做到自主开发（随着 ai 能力的进一步提升，目前 gemini3 做到的落地页等静态界面已经令人咋舌）</li>
</ul>
<p><strong>🎊如果觉得文章内容有用，交个朋友，点个赞再走~ 🎊</strong></p>
<h2 data-id="heading-1">正文</h2>
<p>当我在 2019 年加入 Booking.com 的时候，会不会写代码对 UX 设计师来说不是“加分项”，而是硬条件。你根本没办法在不会写代码的情况下被 Booking.com 录用。那时候，这在我看来还是一个“异类要求”，甚至有点极端。</p>
<p>六年之后，这件事正在变成常态。像 Linear、Vercel、Cursor 和 XAi 这样的公司，已经悄悄重写了设计师的岗位描述，开始招聘所谓的 “design engineer（设计工程师）”。他们想要的是既能设计、又能动手构建并上线的人，而不是只会在界面上推像素的人。</p>
<p>现在，我们讨论的已经不是那个老掉牙的问题——“设计师到底应不应该写代码”。在那些做出顶级产品的公司里，这艘船早就已经开走了。AI 终于让一项过去几乎不可能学会的技能，变成了真正可行的东西。设计师，甚至任何人，现在都可以去做真正的软件，而不只是画一个 mockup。</p>
<p>接下来，我们设计和构建产品的方式，正在迎来一次大的转变。</p>
<p>以前，我们是在 Photoshop 里设计软件，那本质上是一个为印刷而生的工具。后来 Figma 出现了，这是一款为屏幕而生的工具，一切都随之改变。现在，媒介又在发生变化。屏幕已经不再是最终的产品了，<strong>真正可运行的软件才是</strong>。</p>
<p>这个转变暴露出一件我们谈得还远远不够的事情：我们当前工作流里的瓶颈到底在哪里？</p>
<p>如果 AI 已经让任何人都有能力直接构建产品，那为什么我们还要花大量时间在那些为静态界面设计而生的工具里？这些工具产出的，最终只是 mockup，而不是真货。</p>
<hr/>
<h3 data-id="heading-2"><strong>Figma 的瓶颈，以及用静态工具设计的隐性成本</strong></h3>
<p>我真的非常喜欢 Figma。我曾经发过一条推文，说它是我们这个时代最伟大的发明之一，而且我是认真的。它的性能、像 auto-layout 这样的功能、实时协作能力，再加上它在 Sketch 之后接力、共同推动的那场变革，一起革新了我们设计和构建软件的方式。</p>
<p>而现在，另一场革命正在发生，只不过这一次，主角不再是另一款设计工具，而是 <strong>人工智能</strong>。</p>
<hr/>
<p>我们先实话实说，一般产品设计实际上是怎么走的：</p>
<p>你会在 Figma 里花上好几天时间，打磨一个流程和一堆界面，反复调整 auto-layout 的设置、拆组件、微调像素、制作组件和各种变体。某种程度上，你是在搭一台复杂的“鲁布·戈德堡机器”（Rube Goldberg machine）。</p>
<p>然后你把这些界面串成一些 prototype，连上一些半成品的交互，这些交互从来都不是真的“感觉很对”。</p>
<p>用户在测试时，走的是一条你为他们脚本化好的理想路径，一切都在完美条件下发生：他们不能真正搜索、不能真的登录、不能体验到网络变慢的情况，也看不到当数据加载失败时会发生什么。</p>
<p>做完用户测试之后，你回到 Figma 继续打磨。</p>
<p>接着就到了 handoff（交接）这一步——真正的痛苦从这里开始。</p>
<p>围绕这一环，我们甚至造了一整套流程：设计规格文档（design specs）、developer mode、红线标注（redlines）、设计 token……</p>
<p>我们一厢情愿地认为，只要我们写的文档足够多、标注足够详细、Figma 文件组织得足够干净整齐，这个从设计到实现的“翻译过程”就会变得无比顺畅。</p>
<p>但事实是：<strong>从来没有顺畅过</strong>。</p>
<p>几周以后，你终于看到真正被搭建出来的版本。</p>
<p>但这时候你会发现：间距不太对、交互手感有点笨拙，而且还有几十个你完全没考虑过的边缘场景（edge cases），原因是你一直是在用完美的占位数据（perfect placeholder data）做设计。</p>
<p>于是你开始提各种 ticket，等下一次 sprint。</p>
<p>等你跟工程师来来回回沟通了几轮、各种改动终于落地时，你已经花了好几周时间，去交付一个如果你一开始就直接构建、完全可以在几天内测试并打磨完成的东西。</p>
<hr/>
<p>这不是文档的失败，而是静态设计本身无法回答这些问题；问题也不是 Figma 这个工具本身。真正的问题是：</p>
<p>我们把静态界面和半成品 prototype 当成了设计流程的终点，而它们从根本上不具备回答那些最关键问题的能力——</p>
<p>比如：</p>
<ul>
<li>
<p>这个东西用起来，<strong>真的舒服吗</strong>？</p>
</li>
<li>
<p>这些交互，<strong>真的说得通吗</strong>？</p>
</li>
<li>
<p>当用户做了意料之外的操作，或者当系统出现异常时，流程<strong>会不会直接崩掉</strong>？</p>
</li>
</ul>
<p>静态设计会产出理论化、耗时的文档；</p>
<p>而可运行的软件，给你的是<strong>事实真相</strong>。</p>
<p>Cursor 的设计负责人 Ryo Lu 把这件事讲得特别直接：</p>
<p>用代码设计，“让我们真的可以和 app 互动。比起 Figma 里的一张图，这种感觉真实太多了。”</p>
<p>在一条推文里，一位叫 @aydaoz 的设计师说：</p>
<blockquote>
<p>“我愿意花 1000 美元买 Linear 的 design system 文件，但它大概值不止这些。”</p>
</blockquote>
<p>Linear 的创始设计师 @Griveau 回复说：</p>
<blockquote>
<p>“说实话，我们的 Figma 文件还挺乱的。我们也没有遵循什么严格的 design system。我们更多是把 Figma 当成草图工具，最终的产品都是在代码里做出来的。”</p>
</blockquote>
<hr/>
<h3 data-id="heading-3"><strong>AI 作为新的设计工具</strong></h3>
<p>如果说过去十年是关于设计屏幕、打磨像素、掌握 auto-layout，那接下来十年，就是关于如何把想法几乎瞬间变成产品。</p>
<p>在过去的 6 个月里，我设计并上线了 3 个产品——而且在这之前，我完全没有先在 Figma 里把它们画一遍。</p>
<p>这不是因为 Figma 变糟了，而是因为 AI 让这一步变得<strong>不再必要</strong>。</p>
<hr/>
<h3 data-id="heading-4"><strong>旧的流程要退场了，新的工作流已经在这儿了</strong></h3>
<p>我们现在的工作流，还没有真正跟上今天已经可以做到的事情。</p>
<p>传统的软件设计和构建流程，大概长这样：</p>
<p>研究（Research） &gt; 头脑风暴 / 概念（Ideate） &gt; 在 Figma 里设计 &gt; 做 Prototype &gt; 评审（Review） &gt; Handoff &gt; 工程实现（Engineering） &gt; QA &gt; 调整优化（Refinement） &gt; 更多 QA &gt; 最终交接 &gt; 上线（Deploy）</p>
<p>每一个箭头，都意味着几天甚至几周的时间。</p>
<p>每一次交接，都伴随着上下文信息的丢失、理解的偏差和翻译错误。</p>
<p>而有了 AI 之后，工作流可以变成这样：</p>
<p><strong>Research -&gt; Build -&gt; Test -&gt; Refine -&gt; Deploy</strong>*</p>
<p>你并不是在跳过环节，而是在<strong>把它们折叠起来</strong>。</p>
<p>设计和产品变成同一件事。</p>
<p>你不再是画一个界面然后“希望它能 work”，而是直接把这个界面做出来，并在真实环境里一轮一轮打磨。</p>
<hr/>
<h3 data-id="heading-5"><strong>代码是新的画布</strong></h3>
<p>设计工具在“模拟”产品；</p>
<p>AI 直接把产品“做”出来。</p>
<p>Figma 会帮你“模拟”一个按钮。</p>
<p>Claude Code 会帮你“构建”一个真正的按钮：</p>
<p>有 hover 状态、有点击逻辑（click handler）、有加载状态、有错误处理，还有可访问性（a11y）属性。</p>
<p>在 2025 年，最强的设计工具已经不是视觉编辑器，而是那些能生成代码、能理解上下文的 AI agent，它们让设计师可以从“静态界面思维”转向“结果与系统思维”。</p>
<p>像 v0、Lovable、Replit、Cursor，还有命令行工具形态的 Claude 和 OpenAI 的 Codex，这些工具不是帮你生成 mockup，而是干脆<strong>让 mockup 这一步变得不再需要</strong>。</p>
<p>正如前面提到的，这其实类似于当年 Figma 替代 Photoshop 时发生的事情：</p>
<p>Photoshop 是为印刷而生的，屏幕只是事后的附加场景；</p>
<p>Figma 是为屏幕而生的，实时协作是它的原生能力。</p>
<p>工具和媒介对齐了之后，所有人突然都能干得更快、更好。</p>
<p>现在，<strong>代码就是媒介</strong>，而 AI 正在让代码变得像 Figma 里的像素一样“好上手”。</p>
<p>当你的画布变成代码时，一切都会变：</p>
<ul>
<li>
<p>你的 prototype 不再是“近似”，而是跑在真实设备上的“成品预览”；</p>
</li>
<li>
<p>你的 edge case 不再只是写在注释里的情况，而是真的被处理掉；</p>
</li>
<li>
<p>你的交互不再只是被录成动效，而是实际可用的行为逻辑；</p>
</li>
<li>
<p>你的“设计稿”不再只是实现规范，而是<strong>可以直接部署的软件</strong>。</p>
</li>
</ul>
<p>AI 正在让代码变成新的设计画布。</p>
<hr/>
<h3 data-id="heading-6"><strong>用代码来做设计</strong></h3>
<p>我认识很多设计师是很怕代码的，甚至完全不想碰它。</p>
<p>别怕，这不代表你要变成工程师。</p>
<p>用代码设计，只是把“代码”当成你的设计媒介，就像你现在把 Figma 当成你的设计媒介一样。</p>
<p>你依然是在做设计：你还是在想着用户、在解决问题、在让体验变得自然顺畅、有趣好用。</p>
<p>唯一的区别是：你操纵的东西变了。</p>
<p>在 Figma 里，你操作的是 vectors、frames 和 layers。</p>
<p>在 AI + 代码的世界里，你操作的是 components、states 和 behavior。</p>
<p>只是这一次，你产出的不是静态图片，而是<strong>真正可运行的软件</strong>。</p>
<hr/>
<h3 data-id="heading-7"><strong>实际上到底改变了什么？</strong></h3>
<h4 data-id="heading-8"><strong>你从“画出来”变成“说出来”</strong></h4>
<p>在 Figma 里，你通过摆放矩形和选择颜色来表达你的意图。</p>
<p>在 AI 里，你通过对话来表达你的意图，例如：</p>
<p>“表单验证要做成 inline 的，不要统一显示在顶部。”</p>
<p>“loading 状态用 skeleton，而不是用 spinner。”</p>
<p>两者本质上都是设计；一个使用视觉编辑器，一个使用语言。</p>
<hr/>
<h4 data-id="heading-9"><strong>你开始在真实约束下工作</strong></h4>
<p>Figma 允许你设计出在现实中几乎不可能实现的界面。</p>
<p>当你在代码中做设计时，<strong>现实会立刻给你反馈</strong>。</p>
<p>你不能随便“假装”一个 API 响应是怎样的，你要么真的连上这个 API，要么就得好好地 mock 它。</p>
<p>借助代码，你可以看到各种条件逻辑、边缘场景和状态变化，实际上是如何影响 UI 和整体体验的；这些是 Figma 永远揭示不了的。</p>
<p>这种“阻力”其实是一种特性，而不是缺陷。</p>
<p>它会逼着你在设计阶段就把难点想清楚，而不是在开发阶段再返工。</p>
<hr/>
<h4 data-id="heading-10"><strong>你迭代的节奏，从“天”变成“分钟”</strong></h4>
<p>在 Figma 里：</p>
<p>你做一个改动 → 导出 prototype → 发链接 → 等反馈 → 再改 → 再导出……</p>
<p>用 AI 的时候：</p>
<p>你改一行 → 刷新浏览器 → 直接看到效果。</p>
<p>再改 → 再刷新 → 再看。</p>
<p>整个反馈循环紧到离谱，你可以在原来做完一个 Figma prototype 的时间里，试十套完全不同的方案。</p>
<p>你不用再把时间花在对像素、调整 frame、拖来拖去 node 上，而是可以把更多时间花在：</p>
<p>去找用户验证、发现什么真的有效、解决真实世界的问题上。</p>
<hr/>
<h4 data-id="heading-11"><strong>你上线的，就是你设计的那一个版本</strong></h4>
<p>在我看来，最深刻的变化在于这点：</p>
<p>当你“设计完”的那一刻，其实也基本意味着“已经构建完成”。</p>
<p>没有 handoff，那些你反复考虑过的细节不再需要被别人“翻译”。</p>
<p>如果你花了一个小时调一段 micro-interaction 的时间曲线，这段节奏会以完全相同的方式出现在生产环境里。</p>
<p>你的设计决策不再是“被实现”，而是<strong>直接被部署</strong>。</p>
<hr/>
<h3 data-id="heading-12"><strong>用代码设计所需要打好的基础</strong></h3>
<p>用代码做设计，并不意味着你要变成一个开发者。</p>
<p>设计师不用去理解算法或数据结构，也不用去背一堆语法细节。</p>
<p>如果设计师能搞明白 auto-layout，或者能在 Figma 里把 prototype 串起来，他们其实已经有了很好的基础，可以去理解以下这些概念：</p>
<ul>
<li>
<p><strong>HTML 结构</strong></p>
<p>内容是怎么被组织起来的（标题、段落、列表、按钮）。你可以把它想象成 Figma 的图层结构，只不过它是语义化的“容器套容器”。</p>
</li>
<li>
<p><strong>CSS 基础</strong></p>
<p>东西是怎么被“长相化”的：颜色、尺寸、间距、布局。这是和我们在 Figma 里所做的事情，对应度最高的一块。</p>
</li>
<li>
<p><strong>组件化思维（Component thinking）</strong></p>
<p>界面是由可复用的部分堆起来的。其实设计师早就习惯在 Figma 里用 components 来思考了。</p>
</li>
<li>
<p><strong>状态（State）</strong></p>
<p>界面会根据数据发生变化，例如：loading、error、success、empty 等状态。</p>
</li>
<li>
<p><strong>Tailwind 工具类（utility classes）</strong></p>
<p>这是一套“样式词汇表”。在 Figma 里你拖一拖控制来调整间距，在 Tailwind 里你写 space-y-4；在 Figma 里你调字体大小，在 Tailwind 里你写 text-lg。本质上是一样的，只是一个是拖动控件，一个是写 class。</p>
</li>
<li>
<p><strong>英文，或者你的母语</strong></p>
<p>用 AI 做设计的起点，还是你已经熟悉的东西：语言。英文也好，母语也好，都是你的新工具栏。你就是用它来描述你想要什么，就像你对队友解释你的设计一样。</p>
</li>
</ul>
<p>这些基础完全可以在一个周末里，通过 YouTube 或 Google 的教程学到一个大概。</p>
<p>你不会立刻变成专家，但已经足够去“艺术指导”AI，去告诉它你想要什么。</p>
<p>有点像你学了一点摄影术语之后，就可以更好地指导一个摄影师；你不需要成为 Tyler Mitchell，但至少你要知道 aperture（光圈）是什么意思。</p>
<p>更好的消息是：跟 Figma 不一样，AI 是“对话式”的。</p>
<p>当你错误地使用了一个 class，或者误解了某个概念时，它会用很自然的方式纠正你：</p>
<p>“实际上，space-y-4 控制的是子元素之间的垂直间距。如果你想控制元素内部的内边距，你需要的是 py-4。”</p>
<hr/>
<h3 data-id="heading-13"><strong>现在用 AI 做设计的真实情况</strong></h3>
<p>我们要先把话说清楚：AI 现在擅长什么、不擅长什么。</p>
<p>AI 在结构和功能上的能力非常强。它可以：</p>
<p>构建表单、处理路由、管理 state、连接 API、实现校验逻辑、创建响应式布局——这些过去都需要工程师来做。</p>
<p>但 AI 目前仍然在一些视觉细节上表现一般：</p>
<ul>
<li>
<p>间距可能“还行”，但不够精致；</p>
</li>
<li>
<p>字体层级也许“能用”，但不够有设计感；</p>
</li>
<li>
<p>颜色搭配可能没问题，但会让你觉得“还不够有品牌味儿”。</p>
</li>
</ul>
<p>这就是懂一点 HTML、CSS 和 Tailwind 会显得特别有价值的地方。</p>
<p>你不需要从零写所有代码，但只要知道 space-y-6 会改变垂直间距，或者 text-xl font-semibold 会调整字重与字号，你就能在 AI 生成的基础上加一层“人的判断”，把“AI 糊出来的东西”提升成有意图、有美感的作品。</p>
<p>移动端环境目前还是慢半拍。</p>
<p>今天的 AI 工具在 web 场景表现最佳，还没有很好地深度整合 Xcode 或 Android Studio 这种原生应用环境。</p>
<p>这并不代表设计师不能做移动相关体验——你完全可以，但目前预期应该更多是基于 web 或跨平台框架来做。</p>
<p>虽然今天用 AI 设计还有不少短板，但 AI 在飞快变好。而那些掌握基本原理的设计师，总是能做出比完全不懂这块的人更好的产品。</p>
<hr/>
<h3 data-id="heading-14"><strong>Figma 仍然更适合做什么？</strong></h3>
<p>我们得说清楚一点：代码并不是在所有场景都比 Figma 更好。</p>
<ul>
<li>
<p><strong>早期探索</strong></p>
<p>当你需要在一小时之内尝试十个完全不同的方向时，Figma 会更快。你可以迅速画草图、尝试不同视觉风格，然后把不行的版本扔掉。</p>
</li>
<li>
<p><strong>视觉设计系统工作</strong></p>
<p>比如定义颜色体系、字体层级、组件库等等，这些依然是在视觉编辑器里更直观、更自然。</p>
</li>
<li>
<p><strong>对齐干系人</strong></p>
<p>当你需要给一堆人看二十个选项，好让他们给反馈、拍板时，Figma 比你去构建二十个可运行 prototype 高效得多。</p>
</li>
<li>
<p><strong>纯视觉设计</strong></p>
<p>比如插画、图标集、营销图等，这些场景下用代码根本不是正解。</p>
</li>
</ul>
<p>所以，这个变化不是“从 Figma 切换到代码”，而是从 <strong>“Figma 是最终设计产物”</strong> 转变成 <strong>“Figma 是发散和构思的工具”</strong> 。</p>
<p>Figma 更像是你的 sketchbook，而不是最终的 blueprint（蓝图）。</p>
<hr/>
<h3 data-id="heading-15"><strong>心智模式的转变</strong></h3>
<p>最难的部分，其实不是学习新工具，而是改变你对“设计是什么”的理解方式。</p>
<p>在 Figma 的思维模式里，设计就是把你的意图写成一份尽可能全面的“文档”：</p>
<p>你为每一种状态画界面，为每个交互写注释，精确地标注每一个尺寸。</p>
<p>你的目标是尽可能完美地把你的愿景传达出去，好让别人能够按图施工。</p>
<p>在代码的思维模式里，设计则是直接去塑造那个“东西本身”。</p>
<p>你不是在写一个按钮的说明书，而是在真的构建这个按钮。</p>
<p>你不是在定义一个表单应该如何验证，而是在具体地实现这个验证逻辑。</p>
<p>你的目标，是让<strong>产品本身变好</strong>，而不是让文档完美无缺。</p>
<p>这要求你用一个全新的方式去信任自己。</p>
<p>你不能再躲在“设计稿是这样的”后面。</p>
<p>你无法再把那些真正困难的决策全部推给“实现阶段”。</p>
<p>你必须亲自把它做对。</p>
<p>但回报也非常实在：</p>
<p>当它真的能跑的时候，你知道它是真的行——</p>
<p>不是理论上、不是“希望如此”、也不是“只要工程实现得没问题就没事”。</p>
<p>而是那种：<strong>确确实实、可以测量、无可否认地行得通</strong>。</p>
<p>你开始对“结果”负责，而不是对“产物”负责。</p>
<p>而这，恰恰就是设计本来就应该走向的地方。</p>
<hr/>
<p>在这篇文章的下一部分（第 2 部分）里，我会从“概念”走向“实战”，具体展示我如何用代码来做设计。</p>
<p>我们会一起过一遍我现在用的完整工作流：</p>
<p>从搭建开发环境、使用 Git，到使用像 Claude CLI 这样的 AI 工具，再到通过 Vercel 或 Replit 部署在线 prototype。</p>
<hr/>
<h3 data-id="heading-16"><strong>在开始之前，你需要准备这些东西：</strong></h3>
<p><strong>Git + GitHub</strong>*</p>
<p>用于版本管理和团队协作。如果你还没有 GitHub 账号，先去注册一个，然后下载 GitHub Desktop。你还需要在本地安装 Git。</p>
<p><strong>Node.js + npm</strong>*</p>
<p>Node.js 让你可以在浏览器之外运行 JavaScript，也是大多数现代 web 项目的基础。安装 Node 的同时也会顺带安装 npm（Node 包管理器），你会用它来安装各种框架、库和依赖。去官方站点下载并安装最新版本即可。</p>
<p><strong>VS Code 或 Cursor</strong></p>
<p>这是你的开发工作空间，可以把它当成新的 Figma，只是这里没有图层。</p>
<p>我个人用的是 VS Code，并配合 Claude CLI 的插件一起用。</p>
<p><strong>Claude CLI</strong></p>
<p>这是你在设计和写代码时的 AI 搭档。如果你还没有账号，可以先注册一个 Claude 账号，然后开启 CLI 使用。</p>
<p><strong>Vercel 或 Replit</strong></p>
<p>这是用来部署你作品的托管平台，可以让你一键把项目变成在线可访问的产品，不需要自己管服务器，也不用做复杂配置。注册一个账号，你就可以用一条命令把你的构建部署出去。</p>
<p><strong>Tailwind CSS</strong></p>
<p>一套 utility-first 的 CSS 框架，让你可以用最少的精力做出干净、响应式的界面。</p>
<p>就这些。</p>
<p>有了这套基础，你就可以在一小时之内，从一个想法走到一个真实可用、可在线访问的互动 prototype。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SQL中的CTE用法初步（Common Table Expression公共表表达式）]]></title>    <link>https://juejin.cn/post/7579995569688625186</link>    <guid>https://juejin.cn/post/7579995569688625186</guid>    <pubDate>2025-12-05T06:58:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579995569688625186" data-draft-id="7579892222609932323" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SQL中的CTE用法初步（Common Table Expression公共表表达式） "/> <meta itemprop="keywords" content="SQL"/> <meta itemprop="datePublished" content="2025-12-05T06:58:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户722786812344"/> <meta itemprop="url" content="https://juejin.cn/user/4100515739233513"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SQL中的CTE用法初步（Common Table Expression公共表表达式） 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4100515739233513/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户722786812344
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T06:58:59.000Z" title="Fri Dec 05 2025 06:58:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>CTE，全称 Common Table Expression（公共表表达式），是 SQL 的一个强大特性。</p>
<h2 data-id="heading-0">概念</h2>
<p>CTE是在写 SQL 时临时定义的可复用“虚拟表”，用 <code>WITH</code> 开头。<br/>
可以让复杂 SQL 变得更简洁、可读、可复用，还能实现递归查询（树结构）。</p>
<h3 data-id="heading-1">基本形式</h3>
<pre><code class="hljs language-vbnet" lang="vbnet">	<span class="hljs-keyword">WITH</span> temp <span class="hljs-keyword">AS</span> (

	    <span class="hljs-keyword">SELECT</span> id, price <span class="hljs-keyword">FROM</span> product <span class="hljs-keyword">WHERE</span> price &gt; <span class="hljs-number">100</span>

	)

	<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> temp <span class="hljs-keyword">WHERE</span> id &lt; <span class="hljs-number">1000</span>;
</code></pre>
<p>其中，<code>temp</code> 是临时表，通过CTE让SQL 更清晰，避免重复子查询。</p>
<h3 data-id="heading-2">价值</h3>
<h4 data-id="heading-3">1. 提高代码的可读性和可维护性</h4>
<p>这是 CTE <strong>最直接</strong>的好处。当你的 SQL 逻辑非常复杂，包含多层嵌套的子查询（Subquery）时，代码会变得像“洋葱”一样难以阅读。CTE 允许你将逻辑扁平化，按顺序定义数据处理步骤：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">	<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> (

	    <span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> (

	        <span class="hljs-keyword">SELECT</span> UserID, SUM(Amount) <span class="hljs-keyword">as</span> Total <span class="hljs-keyword">FROM</span> Orders <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> UserID

	    ) <span class="hljs-keyword">AS</span> UserTotals <span class="hljs-keyword">WHERE</span> Total &gt; <span class="hljs-number">1000</span>

	) <span class="hljs-keyword">AS</span> HighValueUsers

	<span class="hljs-keyword">JOIN</span> Users <span class="hljs-keyword">ON</span> HighValueUsers.UserID = Users.ID;
</code></pre>
<p>这种写法需要从最里面往外读，逻辑不仅费劲，而且容易出错。<br/>
如果用CTE：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-code">	WITH UserTotals AS (
</span>
<span class="hljs-code">	    -- 第一步：计算每个用户的总金额
</span>
<span class="hljs-code">	    SELECT UserID, SUM(Amount) as Total 
</span>
<span class="hljs-code">	    FROM Orders 
</span>
<span class="hljs-code">	    GROUP BY UserID
</span>
<span class="hljs-code">	),
</span>
<span class="hljs-code">	HighValueUsers AS (
</span>
<span class="hljs-code">	    -- 第二步：筛选高价值用户
</span>
<span class="hljs-code">	    SELECT * 
</span>
<span class="hljs-code">	    FROM UserTotals 
</span>
<span class="hljs-code">	    WHERE Total &gt; 1000
</span>
<span class="hljs-code">	)
</span>
<span class="hljs-code">	-- 第三步：最终查询
</span>
<span class="hljs-code">	SELECT * 
</span>
<span class="hljs-code">	FROM HighValueUsers
</span>
<span class="hljs-code">	JOIN Users ON HighValueUsers.UserID = Users.ID;
</span></code></pre>
<h4 data-id="heading-4">2. 实现递归查询 (Recursive CTE)</h4>
<p>这是 CTE 的<strong>杀手级</strong>功能。普通的子查询无法引用自身，而 CTE 可以。这在处理层级数据（Hierarchical Data）时非常有用，例如：<br/>
公司组织架构（查找某人的所有下属，或者查找某人的所有上级）。<br/>
菜单/分类树（无限级分类）。<br/>
图结构数据（路径查找）。</p>
<pre><code class="hljs language-sql" lang="sql">	<span class="hljs-comment">-- 生成 1 到 10 的序列</span>

	<span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> NumberSequence <span class="hljs-keyword">AS</span> (

	    <span class="hljs-comment">-- 初始成员 (Anchor Member)</span>

	    <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span> <span class="hljs-keyword">AS</span> n

	    <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>

	    <span class="hljs-comment">-- 递归成员 (Recursive Member)</span>

	    <span class="hljs-keyword">SELECT</span> n <span class="hljs-operator">+</span> <span class="hljs-number">1</span> 

	    <span class="hljs-keyword">FROM</span> NumberSequence 

	    <span class="hljs-keyword">WHERE</span> n <span class="hljs-operator">&lt;</span> <span class="hljs-number">10</span>

	)

	<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> NumberSequence;
</code></pre>
<p>晚点我们再看更实际的例子。</p>
<h4 data-id="heading-5">3. 在同一查询中多次复用</h4>
<p>如果你在一个复杂的查询中需要多次用到同一个中间结果集：</p>
<ul>
<li>使用子查询： 你必须把那段 SQL 代码复制粘贴两遍（或者数据库引擎需要计算两遍）。</li>
<li>使用 CTE： 你只需要定义一次，然后在后面的主查询中可以多次引用它（例如 JOIN 它自己）。</li>
</ul>

<pre><code class="hljs language-vbnet" lang="vbnet">	<span class="hljs-keyword">WITH</span> MonthlySales <span class="hljs-keyword">AS</span> (

	    <span class="hljs-keyword">SELECT</span> Month, SUM(Sales) <span class="hljs-keyword">as</span> TotalSales 

	    <span class="hljs-keyword">FROM</span> Orders 

	    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> Month

	)

	<span class="hljs-keyword">SELECT</span> 

	    CurrentMonth.Month, 

	    CurrentMonth.TotalSales, 

	    CurrentMonth.TotalSales - LastMonth.TotalSales <span class="hljs-keyword">AS</span> Growth

	<span class="hljs-keyword">FROM</span> MonthlySales <span class="hljs-keyword">AS</span> CurrentMonth

	LEFT <span class="hljs-keyword">JOIN</span> MonthlySales <span class="hljs-keyword">AS</span> LastMonth 

	    <span class="hljs-keyword">ON</span> CurrentMonth.Month = LastMonth.Month + <span class="hljs-number">1</span>;
</code></pre>
<h4 data-id="heading-6">4. 配合窗口函数进行数据清洗</h4>
<p>常用于去重或分页场景。例如，删除表中的重复记录（保留 ID 最大的那条）：</p>
<pre><code class="hljs language-sql" lang="sql">	<span class="hljs-keyword">WITH</span> DuplicateRows <span class="hljs-keyword">AS</span> (

	    <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>, 

	           <span class="hljs-built_in">ROW_NUMBER</span>() <span class="hljs-keyword">OVER</span> (<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> Email <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> ID <span class="hljs-keyword">DESC</span>) <span class="hljs-keyword">as</span> rn

	    <span class="hljs-keyword">FROM</span> Users

	)

	<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> DuplicateRows <span class="hljs-keyword">WHERE</span> rn <span class="hljs-operator">&gt;</span> <span class="hljs-number">1</span>;
</code></pre>
<p>虽然这看起来像是从 CTE 删除，但实际上是删除了底层表 Users 对应的数据。</p>
<blockquote>
<p>取决于数据库支持情况，SQL Server 和 PostgreSQL 支持较好</p>
</blockquote>
<h2 data-id="heading-7">性能</h2>
<p>看了上面说的优点，你可能会以为CTE总是一次计算，多次复用。但是实际效果可能让你失望。<br/>
CTE更像是语法糖，而非性能优化器。和普通SQL一样，使用不当也会带来性能问题。</p>
<h4 data-id="heading-8">对于非递归 CTE (Non-Recursive CTEs)：</h4>
<p>它们通常与使用子查询或派生表在性能上相同。虽然有优点，但是不是性能上的：</p>
<ul>
<li>可读性： 复杂的逻辑可以分解成多个命名步骤，使代码更容易理解。</li>
<li>模块化： 同一个 CTE 可以在主查询中多次引用（尽管它通常只执行一次，除非优化器选择重新计算）。</li>
</ul>
<h4 data-id="heading-9">对于递归 CTE (Recursive CTEs)：</h4>
<p>递归 CTE 是一个强大的功能，但在性能上需要注意。不当的递归条件或大量数据可能导致查询时间过长，甚至耗尽资源。它们通常是解决这类问题的唯一 SQL 方式，除非使用存储过程中的循环。</p>
<h4 data-id="heading-10">最大的误解：自动物化</h4>
<p>很多人认为 CTE 会像临时表一样将结果集存储起来，并在后续多次引用时直接使用这个存储的结果。<br/>
这种方式有个专业名词叫“<strong>物化</strong>”（materialization），指数据库先运行 CTE、将结果存到临时存储（内存或磁盘），然后重用。<br/>
相反，会执行多次的方式在CTE 场景中叫做“内联”（inline）；</p>
<p>事实是在大多数主流数据库中，<strong>非递归 CTE</strong> 通常不会自动实现。优化器会将 CTE 的定义合并到主查询中。这意味着如果一个 CTE 被引用了多次，优化器可能会选择：</p>
<ul>
<li>重新计算：<br/>
如果 CTE 被引用多次，数据库可能多次执行其内部逻辑，导致性能浪费（尤其大数据量时）。这在 SQL Server 和早期 MySQL 中特别明显。参考即将死亡的stackoverflow: <a href="https://link.juejin.cn?target=https%3A%2F%2Fstackoverflow.com%2Fquestions%2F62312318%2Fcte-executed-multiple-times" target="_blank" title="https://stackoverflow.com/questions/62312318/cte-executed-multiple-times" ref="nofollow noopener noreferrer">stackoverflow.com/questions/6…</a></li>
<li>计算一次并重用：<br/>
现代优化器（如 PostgreSQL 12+ 或 Oracle）有时会自动物化以避免重复计算，但这依赖查询统计、数据分布和配置，不是 100% 可靠。MySQL 和 SQL Server 更保守，不会默认缓存。</li>
</ul>
<blockquote>
<p>PostgreSQL (12+) <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.falvce.com%2F" target="_blank" title="https://www.falvce.com/" ref="nofollow noopener noreferrer">www.falvce.com/</a> 可以用 <code>WITH ... AS MATERIALIZED</code> 强制物化；<code>NOT MATERIALIZED</code> 强制内联。<br/>
Oracle (19c+)用 <code>/*+ MATERIALIZE */</code> 或 <code>/*+ INLINE */</code> 进行提示。</p>
</blockquote>
<p>虽然 CTE 提高了可读性，但它只是将逻辑前移了。如果 CTE 内部包含了非常耗时的操作（如全表扫描、复杂的连接、大量计算），那么主查询的性能依然会很差。<br/>
要确保 CTE 的定义尽可能高效地返回所需的数据。如果可能，通过 WHERE 子句或 JOIN 条件尽早过滤数据。</p>
<h5 data-id="heading-11">所以，查 EXPLAIN 验证执行计划 —— 这是 CTE 性能的唯一真相。</h5>
<h2 data-id="heading-12">递归CTE例子</h2>
<p>下面我们跑一遍在 PostgreSQL 里执行的示例：<br/>
包括：</p>
<ul>
<li>创建层级表（树结构）</li>
<li>插入测试数据（模拟类目树 / 部门树）</li>
<li>使用 递归 CTE 查询所有子节点、所有父节点</li>
</ul>
<h3 data-id="heading-13">创建层级表</h3>
<pre><code class="hljs language-sql" lang="sql">	<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> category (

	    id          SERIAL <span class="hljs-keyword">PRIMARY</span> KEY,

	    name        TEXT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,

	    parent_id   <span class="hljs-type">INT</span> <span class="hljs-keyword">REFERENCES</span> category(id)

	);
</code></pre>
<h3 data-id="heading-14">插入层级数据（模拟 3 层树）</h3>
<pre><code class="hljs language-sql" lang="sql">	<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> category (id, name, parent_id) <span class="hljs-keyword">VALUES</span>

	    (<span class="hljs-number">1</span>, <span class="hljs-string">'电子产品'</span>, <span class="hljs-keyword">NULL</span>),

	    (<span class="hljs-number">2</span>, <span class="hljs-string">'手机'</span>, <span class="hljs-number">1</span>),

	    (<span class="hljs-number">3</span>, <span class="hljs-string">'安卓手机'</span>, <span class="hljs-number">2</span>),

	    (<span class="hljs-number">4</span>, <span class="hljs-string">'苹果手机'</span>, <span class="hljs-number">2</span>),

	    (<span class="hljs-number">5</span>, <span class="hljs-string">'电脑'</span>, <span class="hljs-number">1</span>),

	    (<span class="hljs-number">6</span>, <span class="hljs-string">'笔记本电脑'</span>, <span class="hljs-number">5</span>),

	    (<span class="hljs-number">7</span>, <span class="hljs-string">'台式机'</span>, <span class="hljs-number">5</span>);
</code></pre>
<h3 data-id="heading-15">使用CTE</h3>
<p>咱们看看插入的数据是啥样的（带缩进）</p>
<pre><code class="hljs language-vbnet" lang="vbnet">	<span class="hljs-keyword">WITH</span> RECURSIVE tree <span class="hljs-keyword">AS</span> (

	    <span class="hljs-keyword">SELECT</span> id, name, parent_id, <span class="hljs-number">1</span> <span class="hljs-keyword">AS</span> level, name <span class="hljs-keyword">AS</span> path

	    <span class="hljs-keyword">FROM</span> category

	    <span class="hljs-keyword">WHERE</span> parent_id <span class="hljs-built_in">IS</span> NULL

	 

	    UNION ALL

	 

	    <span class="hljs-keyword">SELECT</span> c.id, c.name, c.parent_id,

	           t.level + <span class="hljs-number">1</span> <span class="hljs-keyword">AS</span> level,

	           t.path || <span class="hljs-comment">' &gt; ' || c.name</span>

	    <span class="hljs-keyword">FROM</span> category c

	    <span class="hljs-keyword">JOIN</span> tree t <span class="hljs-keyword">ON</span> c.parent_id = t.id

	)

	<span class="hljs-keyword">SELECT</span> id,

	       repeat(<span class="hljs-comment">'  ', level - 1) || name AS display_name,</span>

	       path

	<span class="hljs-keyword">FROM</span> tree

	<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> path;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bca53cc136148a89ab6bed5b071e1be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzIyNzg2ODEyMzQ0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765522739&amp;x-signature=4%2BvxaY5Y4gflYmxCQ2a7kP0iBZs%3D" alt="image" loading="lazy"/></p>
<p>查询 手机(id=2) 下的所有子类目：安卓、苹果</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-code">	WITH RECURSIVE sub_tree AS (
</span>
<span class="hljs-code">	    -- 起点
</span>
<span class="hljs-code">	    SELECT id, name, parent_id
</span>
<span class="hljs-code">	    FROM category
</span>
<span class="hljs-code">	    WHERE id = 2
</span>
<span class="hljs-code">	    
</span>
<span class="hljs-code">	    UNION ALL
</span>
<span class="hljs-code">	 
</span>
<span class="hljs-code">	    -- 向下递归
</span>
<span class="hljs-code">	    SELECT c.id, c.name, c.parent_id
</span>
<span class="hljs-code">	    FROM category c
</span>
<span class="hljs-code">	    JOIN sub_tree st ON c.parent_id = st.id
</span>
<span class="hljs-code">	)https://www.falvce.com/
</span>
<span class="hljs-code">	SELECT * FROM sub_tree;
</span></code></pre>
<p>查询 笔记本电脑(id=6) 的所有上级：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-code">	WITH RECURSIVE parents AS (
</span>
<span class="hljs-code">	    -- 起点
</span>
<span class="hljs-code">	    SELECT id, name, parent_id
</span>
<span class="hljs-code">	    FROM category
</span>
<span class="hljs-code">	    WHERE id = 6
</span>
<span class="hljs-code">	    
</span>
<span class="hljs-code">	    UNION ALL
</span>
<span class="hljs-code">	    
</span>
<span class="hljs-code">	    -- 向上递归到根节点
</span>
<span class="hljs-code">	    SELECT c.id, c.name, c.parent_id
</span>
<span class="hljs-code">	    FROM category c
</span>
<span class="hljs-code">	    JOIN parents p ON c.id = p.parent_id
</span>
<span class="hljs-code">	)
</span>
<span class="hljs-code">	SELECT * FROM parents;
</span></code></pre>
<p>查询所有节点，并附带层级深度（level）</p>
<pre><code class="hljs language-sql" lang="sql">	<span class="hljs-keyword">WITH</span> <span class="hljs-keyword">RECURSIVE</span> tree <span class="hljs-keyword">AS</span> (

	    <span class="hljs-keyword">SELECT</span> id, name, parent_id, <span class="hljs-number">1</span> <span class="hljs-keyword">AS</span> level

	    <span class="hljs-keyword">FROM</span> category

	    <span class="hljs-keyword">WHERE</span> parent_id <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>  <span class="hljs-comment">-- 从根节点开始</span>

	    

	    <span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>

	    

	    <span class="hljs-keyword">SELECT</span> c.id, c.name, c.parent_id, t.level <span class="hljs-operator">+</span> <span class="hljs-number">1</span>

	    <span class="hljs-keyword">FROM</span> category c

	    <span class="hljs-keyword">JOIN</span> tree t <span class="hljs-keyword">ON</span> c.parent_id <span class="hljs-operator">=</span> t.id

	)

	<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span>

	<span class="hljs-keyword">FROM</span> tree

	<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> level, id;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ca303ee736b4526b3b325bf44634019~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NzIyNzg2ODEyMzQ0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765522739&amp;x-signature=ay5mqV71kH6cV%2B%2Bw3VjdO%2B1YPBA%3D" alt="image" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[FastAPI入门实战]]></title>    <link>https://juejin.cn/post/7579887768228085794</link>    <guid>https://juejin.cn/post/7579887768228085794</guid>    <pubDate>2025-12-05T05:09:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579887768228085794" data-draft-id="7579892134817234979" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="FastAPI入门实战"/> <meta itemprop="keywords" content="Python,前端,后端"/> <meta itemprop="datePublished" content="2025-12-05T05:09:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="只与明月听"/> <meta itemprop="url" content="https://juejin.cn/user/386661153249102"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            FastAPI入门实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/386661153249102/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    只与明月听
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T05:09:51.000Z" title="Fri Dec 05 2025 05:09:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h5 data-id="heading-0">一、前言</h5>
<p>准备朝着ai应用开发学习下，python完善的生态就注定必须学习的，相关的web框架有很多， Flask 与 Django 一直是最常见的选择，Django 功能完善、内置 ORM 和管理后台，适合快速构建大型、结构化的项目；Flask 则以极简著称，灵活自由，但需要开发者自行选择和组合扩展。随着项目对性能与类型安全要求的提高，一种更“现代化”的框架需求开始凸显。</p>
<p>FastAPI 正是在这样的背景下受到关注。它基于 Python 类型提示构建，自动生成清晰的 API 文档；内置高性能异步特性，速度可媲美 Node.js 和 Go；搭配 Pydantic 做数据校验，让开发、调试、联调都更高效。相比 Flask 的轻量但需要自己拼装生态、Django 的重量级但偏传统，FastAPI 更适合构建现代、快速迭代的 API 服务。</p>
<h5 data-id="heading-1">二、环境准备</h5>
<p>python常见的开发方式就是通过venv创建一个虚拟环境，这个虚拟环境就是一个独立的mini-python系统，包含一个独立的python解释器，独立的pip和独立的site-package，这样我们可以再不通的项目中使用不通的python版本。和node_modules不一样的是，python env隔离的是整个python环境，而node_modules隔离的只是依赖文件。</p>
<p>接下来就通过venv来创建虚拟环境，前提是已经安装好了python版本，不建议安装最新的，之前<code>llama_index</code>的例子，就出现过不兼容的现象，3.11即可。</p>
<p>首先激活虚拟环境</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 创建虚拟环境（venv 是目录名，可自行修改）</span>
python3 -m venv venv
​
<span class="hljs-comment"># 2. 激活虚拟环境</span>
<span class="hljs-comment"># Windows</span>
venv\Scripts\activate
</code></pre>
<p>然后安装框架和服务器</p>
<pre><code class="hljs language-css" lang="css">pip install fastapi uvicorn<span class="hljs-selector-attr">[standard]</span>
</code></pre>
<p>其中fastapi就是这个博客要学习的东西，<code>uvicorn</code> 是一款轻量级、超高性能的 <strong>ASGI 服务器（Asynchronous Server Gateway Interface）</strong> 。</p>
<p>FastAPI 基于 ASGI 协议构建，因此需要一个 ASGI 服务器来运行它。</p>
<h5 data-id="heading-2">三、FastAPI最小实例</h5>
<p>接下来就开始代码实操</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI
​
app = FastAPI(
    title=<span class="hljs-string">"Hello World API"</span>,
    description=<span class="hljs-string">"Basic demo of FastAPI: app instance, path operation, automatic docs."</span>,
    version=<span class="hljs-string">"0.1.0"</span>,
)
​
​
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/"</span>, summary=<span class="hljs-string">"Root Hello"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">read_root</span>():
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">"Hello World"</span>}
​
​
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/hello/{name}"</span>, summary=<span class="hljs-string">"Personalized Hello"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">read_hello</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">f"Hello <span class="hljs-subst">{name}</span>"</span>}
​
​
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/health"</span>, summary=<span class="hljs-string">"Health Check"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">health</span>():
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"status"</span>: <span class="hljs-string">"ok"</span>}
​
</code></pre>
<p>代码也是比较简单的， <code>FastAPI</code> 是一个为API 提供了所有功能的 Python 类，变量 <code>app</code> 会是 <code>FastAPI</code> 类的一个实例，这个实例将是创建所有 API 的主要交互对象。</p>
<p>运行命令</p>
<pre><code class="hljs language-css" lang="css">uvicorn <span class="hljs-selector-tag">main</span>:app --reload --host <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span> --port <span class="hljs-number">8000</span>
</code></pre>
<ul>
<li>基础根路径: <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">http://localhost:8000/</a></li>
<li>个性问候: <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">http://localhost:8000/hello/张三</a></li>
<li>健康检查: <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">http://localhost:8000/health</a></li>
<li>自动文档 (Swagger UI): <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">http://localhost:8000/docs</a></li>
<li>ReDoc: <a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">http://localhost:8000/redoc</a></li>
</ul>
<h5 data-id="heading-3">四、路径操作</h5>
<p>在 FastAPI 中，所谓“路径操作”指的就是我们常说的 API 接口（如 GET、POST 等）。每个路径操作由一个 URL 路径和一个 HTTP 方法组成。FastAPI 为每一种方法都提供了对应的装饰器，使用非常直观。</p>
<p>FastAPI 支持常见的 RESTful 风格接口，示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/items"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_items</span>():
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">"GET 请求"</span>}
​
<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/items"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_item</span>(<span class="hljs-params">item: <span class="hljs-built_in">dict</span></span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">"POST 请求"</span>, <span class="hljs-string">"item"</span>: item}
​
<span class="hljs-meta">@app.put(<span class="hljs-params"><span class="hljs-string">"/items/{item_id}"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">update_item</span>(<span class="hljs-params">item_id: <span class="hljs-built_in">int</span>, item: <span class="hljs-built_in">dict</span></span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">"PUT 请求"</span>, <span class="hljs-string">"id"</span>: item_id, <span class="hljs-string">"item"</span>: item}
​
<span class="hljs-meta">@app.delete(<span class="hljs-params"><span class="hljs-string">"/items/{item_id}"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">delete_item</span>(<span class="hljs-params">item_id: <span class="hljs-built_in">int</span></span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">"DELETE 请求"</span>, <span class="hljs-string">"id"</span>: item_id}
</code></pre>
<ol start="0">
<li>
<h6 data-id="heading-4">路径参数</h6>
<p>路径参数指 URL 中的一部分，例如 <code>/users/123</code> 中的 <code>123</code></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/users/{user_id}"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">read_user</span>(<span class="hljs-params">user_id: <span class="hljs-built_in">int</span></span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"user_id"</span>: user_id}
</code></pre>
<p>FastAPI 会根据类型自动校验：访问 <code>/users/abc</code> 会报 422 错误。</p>
<p>还可以添加约束，例如：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> Path
​
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/orders/{order_id}"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">read_order</span>(<span class="hljs-params">order_id: <span class="hljs-built_in">int</span> = Path(<span class="hljs-params">gt=<span class="hljs-number">0</span>, description=<span class="hljs-string">"订单 ID 必须大于 0"</span></span>)</span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"order_id"</span>: order_id}
</code></pre>
</li>
<li>
<h6 data-id="heading-5">查询参数</h6>
<p>查询参数是 <code>?key=value</code> 的部分，例如：<code>/search?q=fastapi&amp;page=1</code></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/search"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">search</span>(<span class="hljs-params">q: <span class="hljs-built_in">str</span>, page: <span class="hljs-built_in">int</span> = <span class="hljs-number">1</span></span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"q"</span>: q, <span class="hljs-string">"page"</span>: page}
</code></pre>
<p>可以添加校验：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> Query
​
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/products"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_products</span>(<span class="hljs-params">limit: <span class="hljs-built_in">int</span> = Query(<span class="hljs-params"><span class="hljs-number">10</span>, le=<span class="hljs-number">100</span></span>), keyword: <span class="hljs-built_in">str</span> = Query(<span class="hljs-params"><span class="hljs-literal">None</span>, min_length=<span class="hljs-number">2</span></span>)</span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"limit"</span>: limit, <span class="hljs-string">"keyword"</span>: keyword}
</code></pre>
</li>
<li>
<h6 data-id="heading-6">参数校验</h6>
<p>FastAPI 的校验通过 <code>Query()</code>、<code>Path()</code> 等完成，常用校验包括：</p>
<ul>
<li><strong>最小值/最大值</strong>：<code>ge</code>（&gt;=）、<code>le</code>（&lt;=）、<code>gt</code>（&gt;）、<code>lt</code>（&lt;）</li>
<li><strong>字符串长度</strong>：<code>min_length</code> / <code>max_length</code></li>
<li><strong>正则校验</strong>：<code>regex</code></li>
</ul>
<p>示例：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/validate"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">validate</span>(<span class="hljs-params">
    username: <span class="hljs-built_in">str</span> = Query(<span class="hljs-params">..., min_length=<span class="hljs-number">3</span>, max_length=<span class="hljs-number">20</span>, regex=<span class="hljs-string">"^[a-zA-Z0-9_]+$"</span></span>),
    age: <span class="hljs-built_in">int</span> = Query(<span class="hljs-params">..., ge=<span class="hljs-number">1</span>, le=<span class="hljs-number">120</span></span>)
</span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"username"</span>: username, <span class="hljs-string">"age"</span>: age}
</code></pre>
</li>
</ol>
<h5 data-id="heading-7">五、使用Pydantic模型</h5>
<p>FastAPI 在数据校验和数据转换方面非常强大，这要归功于 <strong>Pydantic</strong>。在接收 JSON 请求体时，我们可以通过 Pydantic 模型来定义结构、类型、默认值以及校验规则，让 API 更健壮、更易维护。</p>
<ol start="0">
<li>
<h6 data-id="heading-8">定义请求模型</h6>
<p>一个典型的请求体（Request Body）使用 Pydantic 的 <code>BaseModel</code> 来定义字段和类型：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel
​
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Item</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    name: <span class="hljs-built_in">str</span>
    description: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>
    price: <span class="hljs-built_in">float</span>
    in_stock: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span>
</code></pre>
<p>FastAPI 会根据这些类型自动验证请求体，并在 Swagger 文档中展示字段结构。</p>
</li>
<li>
<h6 data-id="heading-9">使用模型</h6>
<p>直接将模型作为参数即可：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI
​
app = FastAPI()
​
<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/items"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_item</span>(<span class="hljs-params">item: Item</span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">"商品已创建"</span>, <span class="hljs-string">"item"</span>: item}
</code></pre>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"iPhone 16"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"最新型号"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"price"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">6999.99</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"in_stock"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
<span class="hljs-punctuation">}</span>
​
</code></pre>
<p>FastAPI 会自动把它转换为 <code>Item</code> 实例。如果字段缺失、类型不匹配，会返回 422 错误。</p>
</li>
<li>
<h6 data-id="heading-10">字段校验</h6>
<p>这里需要使用Pydantic 的 <code>Field()</code> ，来添加更精确的校验规则和描述</p>
<pre><code class="hljs language-arduino" lang="arduino">from pydantic <span class="hljs-keyword">import</span> BaseModel, Field
​
<span class="hljs-function"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span><span class="hljs-params">(BaseModel)</span>:
    username: str =</span> <span class="hljs-built_in">Field</span>(..., min_length=<span class="hljs-number">3</span>, max_length=<span class="hljs-number">20</span>, description=<span class="hljs-string">"用户名必须为 3~20 个字符"</span>)
    age: <span class="hljs-type">int</span> = <span class="hljs-built_in">Field</span>(..., ge=<span class="hljs-number">1</span>, le=<span class="hljs-number">120</span>, description=<span class="hljs-string">"年龄必须在 1~120 之间"</span>)
</code></pre>
<p>这里就在<code>Field</code>中定义了<code>username</code>和<code>age</code>两个字段，<code>...</code>表明是必传字段，其中<code>username</code>的长度要在3-20之间，<code>age</code>要在1-120之间</p>
</li>
<li>
<h6 data-id="heading-11">嵌套模型</h6>
<p>当遇到一些复杂的模型时，就需要用到嵌套了</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Address</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    city: <span class="hljs-built_in">str</span>
    street: <span class="hljs-built_in">str</span>
​
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Customer</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    name: <span class="hljs-built_in">str</span>
    address: Address
</code></pre>
<p>对应的请求体就需要这样写了</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Tom"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"address"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"city"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Shanghai"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"street"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Nanjing Road"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
<li>
<h6 data-id="heading-12">相应模型</h6>
<p>上面的是入参的限制，同样也可以限制响应值的类型</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserPublic</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    username: <span class="hljs-built_in">str</span>
​
<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/users"</span>, response_model=UserPublic</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_user</span>(<span class="hljs-params">user: User</span>):
    <span class="hljs-comment"># 假装保存数据库...</span>
    <span class="hljs-keyword">return</span> user
</code></pre>
</li>
</ol>
<h5 data-id="heading-13">六、高级请求参数和路由模块化</h5>
<p>除了常见的get、post这种<code>JSON</code>请求体，还会处理表单、Cookies、Headers等输入</p>
<ol start="0">
<li>
<h6 data-id="heading-14">表单请求</h6>
<p>就是前端常见的form表单来提交数据</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> Form
​
<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/login"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">login</span>(<span class="hljs-params">username: <span class="hljs-built_in">str</span> = Form(<span class="hljs-params">...</span>), password: <span class="hljs-built_in">str</span> = Form(<span class="hljs-params">...</span>)</span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"username"</span>: username}
</code></pre>
</li>
<li>
<h6 data-id="heading-15">文件上传</h6>
<p>文件上传也是一个很常见的功能</p>
<pre><code class="hljs language-ini" lang="ini">async function upload() {
    const <span class="hljs-attr">fileInput</span> = document.getElementById(<span class="hljs-string">"fileInput"</span>)<span class="hljs-comment">;</span>
    const <span class="hljs-attr">file</span> = fileInput.files[<span class="hljs-number">0</span>]<span class="hljs-comment">;</span>
​
    const <span class="hljs-attr">formData</span> = new FormData()<span class="hljs-comment">;</span>
    formData.append("file", file)<span class="hljs-comment">;</span>
​
    const <span class="hljs-attr">res</span> = await fetch(<span class="hljs-string">"http://127.0.0.1:8000/upload"</span>, {
        method: "POST",
        body: formData
    })<span class="hljs-comment">;</span>
​
    const <span class="hljs-attr">data</span> = await res.json()<span class="hljs-comment">;</span>
    console.log("上传结果:", data)<span class="hljs-comment">;</span>
 }
</code></pre>
<p>对应的后端</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> File, UploadFile
​
<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/upload"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">upload</span>(<span class="hljs-params">file: UploadFile = File(<span class="hljs-params">...</span>)</span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"filename"</span>: file.filename}
</code></pre>
</li>
<li>
<h6 data-id="heading-16">Cookies和headers</h6>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> Cookie
​
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/read-cookie"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">read_cookie</span>(<span class="hljs-params">session_id: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = Cookie(<span class="hljs-params"><span class="hljs-literal">None</span></span>)</span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"session_id"</span>: session_id}
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> Header
​
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/agent"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_agent</span>(<span class="hljs-params">user_agent: <span class="hljs-built_in">str</span> = Header(<span class="hljs-params">...</span>)</span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"User-Agent"</span>: user_agent}
</code></pre>
</li>
</ol>

<ol start="4">
<li>
<h6 data-id="heading-17">路由模块化</h6>
<p>随着项目的变大，所有的路由都写在<code>main.py</code>中就会变得很难维护，可以使用<code>APIRouter</code>将路由拆分成多个模块</p>
<p>定义子路由</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> APIRouter
​
router = APIRouter()
​
<span class="hljs-meta">@router.get(<span class="hljs-params"><span class="hljs-string">"/users"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_users</span>():
    <span class="hljs-keyword">return</span> [{<span class="hljs-string">"name"</span>: <span class="hljs-string">"tom"</span>}]
​
</code></pre>
<p>在<code>main.py</code>中使用</p>
<pre><code class="hljs language-ini" lang="ini">from fastapi import FastAPI
from routers import user_router
​
<span class="hljs-attr">app</span> = FastAPI()
app.include_router(user_router, <span class="hljs-attr">prefix</span>=<span class="hljs-string">"/api"</span>, tags=[<span class="hljs-string">"Users"</span>])
</code></pre>
<p>这里的<code>prefix</code>就是给所有的路由加前缀，<code>tags</code>就是给文档分组显示</p>
</li>
</ol>
<h5 data-id="heading-18">七、依赖注入</h5>
<p>FastAPI 的依赖注入（Dependency Injection, DI）是其最强大的特性之一，主要用来处理权限、数据库连接、配置加载、复用逻辑 。</p>
<p>举一个例子就知道具体的用法了</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_db</span>():
    db = DBSession()
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">yield</span> db
    <span class="hljs-keyword">finally</span>:
        db.close()
​
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_current_user</span>(<span class="hljs-params">db = Depends(<span class="hljs-params">get_db</span>)</span>):
    token = ...  <span class="hljs-comment"># 从请求头拿 token</span>
    user = db.query(User).<span class="hljs-built_in">filter</span>(...).first()
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user:
        <span class="hljs-keyword">raise</span> HTTPException(<span class="hljs-number">401</span>)
    <span class="hljs-keyword">return</span> user
​
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/profile"</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">profile</span>(<span class="hljs-params">user = Depends(<span class="hljs-params">get_current_user</span>)</span>):
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"username"</span>: user.name}
</code></pre>
<p>这里定义了两个，get_db是获取数据库实例，get_current_user是获取当前用户的，在get_current_user方法中通过Depends() 将 get_db方法注入到db参数，这样在get_current_user方法内部就可以直接使用db来做数据路的查询了。</p>
<p>这里将get_current_user方法的执行流程描述下，就可以更加清晰的知道依赖注入的用法了</p>
<ol>
<li>在调用get_current_user方法时，看到db = Depends(get_db)</li>
<li>开始调用get_db方法获取实例，复制给db</li>
<li>执行get_db内部方法，db = DBSession()，遇到yield db，就将yield值传递给db = Depends(get_db)的db</li>
<li>方法执行完成后，会执行finally中的方法关闭连接</li>
</ol>
<p>后续在请求<code>"/profile"</code>中，也是一样的流程，值得一提的是，依赖注入不管请求调用多少次，同一个请求中的依赖注入只会调用一次，这样也是为了避免连接数据库的庞大开销。</p>
<p>开始我以为这里的依赖注入是<code>@app.get("/profile")</code>，后来了解了下才发现是<code>def profile(user = Depends(get_current_user)):</code>中的<code>Depends</code>关键字，<code>@app.get("/profile")</code>这个实际上是装饰器模式，他就是一个语法糖，这两行代码没有本质区别</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@app</span>.<span class="hljs-built_in">get</span>(<span class="hljs-string">"/users"</span>)
def <span class="hljs-built_in">list_users</span>(): ...
</code></pre>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">list_users</span> = app.get(<span class="hljs-string">"/users"</span>)(list_users)
</code></pre>
<h5 data-id="heading-19">八、中间件</h5>
<p>中间件就是处理请求和相应的管道函数，位于客户端请求和路由函数之间，可以在请求到达路由前执行，也可以在相应返回客户端前处理，同样也可以在路由和其他中间件之间传递控制权</p>
<p>FastAPI 中的中间件遵循 <strong>ASGI 规范</strong>，比如下面这个例子</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI, Request
<span class="hljs-keyword">from</span> starlette.middleware.base <span class="hljs-keyword">import</span> BaseHTTPMiddleware
​
app = FastAPI()
​
<span class="hljs-meta">@app.middleware(<span class="hljs-params"><span class="hljs-string">"http"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">simple_middleware</span>(<span class="hljs-params">request: Request, call_next</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"请求到来："</span>, request.url.path)
    response = <span class="hljs-keyword">await</span> call_next(request)  <span class="hljs-comment"># 调用下一个中间件或路由</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"响应返回"</span>)
    <span class="hljs-keyword">return</span> response
</code></pre>
<p>中间件是通过关键字<code>middleware</code>来修饰，中间件的作用于就是全局的，会作用与所有注册的路由，上面代码的执行顺序就是这样的</p>
<pre><code class="hljs language-scss" lang="scss">【请求进来】
<span class="hljs-number">1</span>. <span class="hljs-built_in">print</span>("请求到来")
​
<span class="hljs-number">2</span>. 调用下一个中间件 或 最终的路由函数
   response = await <span class="hljs-built_in">call_next</span>(request)
​
<span class="hljs-number">3</span>. <span class="hljs-built_in">print</span>("响应返回")
​
【响应返回给客户端】
</code></pre>
<p>然后如果注册了多个中间件，他们的注册顺序呢，比如下面这样</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@app</span>.<span class="hljs-built_in">middleware</span>(<span class="hljs-string">"http"</span>)
async def <span class="hljs-built_in">M1</span>(request, call_next): ...
​
<span class="hljs-variable">@app</span>.<span class="hljs-built_in">middleware</span>(<span class="hljs-string">"http"</span>)
async def <span class="hljs-built_in">M2</span>(request, call_next): ...
</code></pre>
<p>这就和koa中的中间件执行顺序一样，就是一个洋葱模型</p>
<pre><code class="hljs language-scss" lang="scss">请求进来 →
  M1<span class="hljs-selector-class">.before</span>
    M2<span class="hljs-selector-class">.before</span>
      <span class="hljs-built_in">ROUTE</span>()（路由函数执行）
    M2<span class="hljs-selector-class">.after</span>
  M1<span class="hljs-selector-class">.after</span>
响应返回
</code></pre>
<p>常见的中间件可以处理token鉴权</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@app.middleware(<span class="hljs-params"><span class="hljs-string">"http"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">auth_middleware</span>(<span class="hljs-params">request: Request, call_next</span>):
    token = request.headers.get(<span class="hljs-string">"Authorization"</span>)
    <span class="hljs-keyword">if</span> token != <span class="hljs-string">"mysecrettoken"</span>:
        <span class="hljs-keyword">from</span> fastapi.responses <span class="hljs-keyword">import</span> JSONResponse
        <span class="hljs-keyword">return</span> JSONResponse({<span class="hljs-string">"error"</span>: <span class="hljs-string">"Unauthorized"</span>}, status_code=<span class="hljs-number">401</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> call_next(request)
</code></pre>
<p>还可以设置<code>CORS</code>跨域</p>
<pre><code class="hljs language-ini" lang="ini">from fastapi.middleware.cors import CORSMiddleware
​
app.add_middleware(
    CORSMiddleware,
    <span class="hljs-attr">allow_origins</span>=[<span class="hljs-string">"*"</span>],
    <span class="hljs-attr">allow_methods</span>=[<span class="hljs-string">"*"</span>],
    <span class="hljs-attr">allow_headers</span>=[<span class="hljs-string">"*"</span>],
)
</code></pre>
<p>上面提到了<code>ASGI</code>，接下来介绍下这个协议：</p>
<p>ASGI （Asynchronous Server Gateway Interface），异步服务器网关接口， Python Web 服务器与 Web 框架之间的 <strong>通信协议标准</strong> ，支持异步和同步的，转为高并发、WebSocket、长连接设计的。</p>
<p>在<code>ASGI</code>出现之前，比如<code>Django</code>、<code>Flask</code>他们都是<code>ASGI</code>， 而<code>ASGI</code>只能处理同步任务，一次只能处理一个请求，也不支持<code>WebSocket</code>，不适合做高并发和长连接，</p>
<h5 data-id="heading-20">九、数据库集成</h5>
<p>接口的实际应用，还是得和数据库做交互，接下来分别介绍下mysql和redis的使用</p>
<ol>
<li>
<h6 data-id="heading-21">mysql使用</h6>
</li>
</ol>
<p>FastAPI 推荐异步方式，需要额外安装两个库</p>
<pre><code class="hljs language-css" lang="css">pip install sqlalchemy<span class="hljs-selector-attr">[asyncio]</span> aiomysql
</code></pre>
<p>创建数据库引擎</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">'''
Author: jinxudong 18751241086@163.com
Date: 2025-12-04 15:44:44
LastEditors: jinxudong 18751241086@163.com
LastEditTime: 2025-12-04 16:44:58
FilePath: \code\FastAPI\database\mysql.py
Description: 这是默认设置,请设置`customMade`, 打开koroFileHeader查看配置 进行设置: https://github.com/OBKoro1/koro1FileHeader/wiki/%E9%85%8D%E7%BD%AE
'''</span>
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span>, <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>, <span class="hljs-type">List</span>
​
<span class="hljs-keyword">from</span> sqlalchemy.ext.asyncio <span class="hljs-keyword">import</span> create_async_engine, async_sessionmaker, AsyncSession
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> text
​
DATABASE_URL = <span class="hljs-string">"mysql+aiomysql://xxx"</span>
​
engine = create_async_engine(
    DATABASE_URL,
    echo=<span class="hljs-literal">False</span>,
    pool_pre_ping=<span class="hljs-literal">True</span>,
)
​
async_session = async_sessionmaker(
    bind=engine,
    expire_on_commit=<span class="hljs-literal">False</span>,
)
​
​
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_session</span>() -&gt; AsyncSession:
    <span class="hljs-keyword">return</span> async_session()
​
​
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_all_students</span>() -&gt; <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]:
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> get_session() <span class="hljs-keyword">as</span> session:
        <span class="hljs-comment"># 直接使用原生 SQL 查询 student_info 全部数据</span>
        result = <span class="hljs-keyword">await</span> session.execute(text(<span class="hljs-string">"SELECT * FROM student_info"</span>))
        rows = result.mappings().<span class="hljs-built_in">all</span>()
        <span class="hljs-keyword">return</span> [<span class="hljs-built_in">dict</span>(row) <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> rows]
​
​
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_student_by_id</span>(<span class="hljs-params">student_id: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Optional</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]:
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> get_session() <span class="hljs-keyword">as</span> session:
        result = <span class="hljs-keyword">await</span> session.execute(
            text(<span class="hljs-string">"SELECT * FROM student_info WHERE student_id = :sid"</span>),
            {<span class="hljs-string">"sid"</span>: student_id},
        )
        row = result.mappings().first()
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">dict</span>(row) <span class="hljs-keyword">if</span> row <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>
</code></pre>
<p>这里定义了两个查询数据库的方法，<code>fetch_all_students</code>是查询所有的<code>student_info</code>表，<code>fetch_student_by_id</code>去根据id查询学生信息，</p>
<p>定义user类型的api</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment">#user.py</span>
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> APIRouter, HTTPException
​
<span class="hljs-comment"># 兼容包内外运行：优先相对导入，失败时回退到绝对导入</span>
​
<span class="hljs-keyword">from</span> database.mysql <span class="hljs-keyword">import</span> fetch_all_students, fetch_student_by_id
​
router = APIRouter(prefix=<span class="hljs-string">"/students"</span>, tags=[<span class="hljs-string">"students"</span>])
​
​
<span class="hljs-meta">@router.get(<span class="hljs-params"><span class="hljs-string">""</span>, summary=<span class="hljs-string">"查询所有学生信息"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">list_students</span>():
    <span class="hljs-keyword">try</span>:
        rows = <span class="hljs-keyword">await</span> fetch_all_students()
        <span class="hljs-keyword">return</span> rows
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">500</span>, detail=<span class="hljs-string">f"查询失败: <span class="hljs-subst">{e}</span>"</span>)
​
​
<span class="hljs-meta">@router.get(<span class="hljs-params"><span class="hljs-string">"/{student_id}"</span>, summary=<span class="hljs-string">"根据学号查询学生信息"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_student</span>(<span class="hljs-params">student_id: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-keyword">try</span>:
        row = <span class="hljs-keyword">await</span> fetch_student_by_id(student_id)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> row:
            <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">404</span>, detail=<span class="hljs-string">"未找到该学生"</span>)
        <span class="hljs-keyword">return</span> row
    <span class="hljs-keyword">except</span> HTTPException:
        <span class="hljs-keyword">raise</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">500</span>, detail=<span class="hljs-string">f"查询失败: <span class="hljs-subst">{e}</span>"</span>)
</code></pre>
<p>然后在<code>main.py</code>中使用<code>user.py</code></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">from</span> user <span class="hljs-keyword">import</span> router <span class="hljs-keyword">as</span> students_router 
...
app.<span class="hljs-title function_">include_router</span>(students_router)
</code></pre>
<p>然后通过浏览器<code>http://localhost:8000/students</code>和<code>http://localhost:8000/students/20180102</code>就可以进行查询了。</p>
<ol>
<li>
<h6 data-id="heading-22">redis使用</h6>
</li>
</ol>
<p>MySQL 是关系型数据库，擅长存储结构化数据，支持复杂的 SQL 查询、事务和持久化，适合存储业务核心数据，如用户信息、订单记录等。而 Redis 则是内存数据库，提供极高的读写性能，支持多种数据结构（字符串、哈希、列表、集合、有序集合等），适合做缓存、排行榜、会话存储或消息队列等场景。简单来说，MySQL 保证数据的可靠性和完整性，而 Redis 提供高速的数据访问能力，两者结合可以在保证数据安全的同时，显著提升系统的响应速度和并发处理能力。</p>
<p>接下来写一个redis查询的小例子</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span>, <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>, <span class="hljs-type">List</span>
​
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> APIRouter, HTTPException
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel
<span class="hljs-keyword">from</span> redis.asyncio <span class="hljs-keyword">import</span> from_url, Redis
​
​
REDIS_URL = <span class="hljs-string">"redis://:xxx"</span>
​
​
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_redis</span>() -&gt; Redis:
    <span class="hljs-keyword">return</span> from_url(REDIS_URL, decode_responses=<span class="hljs-literal">True</span>)
​
​
router = APIRouter(prefix=<span class="hljs-string">"/redis"</span>, tags=[<span class="hljs-string">"redis"</span>])
​
​
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SetRequest</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    key: <span class="hljs-built_in">str</span>
    value: <span class="hljs-built_in">str</span>
    expire_seconds: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">int</span>] = <span class="hljs-literal">None</span>
​
<span class="hljs-meta">@router.get(<span class="hljs-params"><span class="hljs-string">"/keys"</span>, summary=<span class="hljs-string">"扫描匹配的键"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">redis_keys</span>(<span class="hljs-params">pattern: <span class="hljs-built_in">str</span> = <span class="hljs-string">"*"</span></span>) -&gt; <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]:
    r = get_redis()
    <span class="hljs-keyword">try</span>:
        keys: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>] = []
        cursor = <span class="hljs-number">0</span>
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            cursor, batch = <span class="hljs-keyword">await</span> r.scan(cursor=cursor, <span class="hljs-keyword">match</span>=pattern, count=<span class="hljs-number">100</span>)
            keys.extend(batch)
            <span class="hljs-keyword">if</span> cursor == <span class="hljs-number">0</span>:
                <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">return</span> keys
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">500</span>, detail=<span class="hljs-string">f"Redis scan 失败: <span class="hljs-subst">{e}</span>"</span>)
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-keyword">await</span> r.close()
</code></pre>
<p>然后在<code>main.py</code>中导入路由</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">from</span> redis_api <span class="hljs-keyword">import</span> router <span class="hljs-keyword">as</span> redis_router
...
app.<span class="hljs-title function_">include_router</span>(redis_router)
</code></pre>
<p>然后再<code>http://localhost:8000/docs</code>文档中通过swagger直接调用我们写的接口，就可以正常看到返回值了。</p>
<p>上面也只是一些基本知识的梳理，距离企业开发还差的很远，尤其是这个框架以高性能、适合高迸发著称，后续打算做一个网关项目，一个聊天室项目，最后再做一个uniapp+fastapi的即时通讯软件，这一套下来，对于fastapi就应该更加熟练了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别在 vue 中使用公共 less 文件没有提示信息的烦恼]]></title>    <link>https://juejin.cn/post/7579886397074915328</link>    <guid>https://juejin.cn/post/7579886397074915328</guid>    <pubDate>2025-12-05T04:02:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579886397074915328" data-draft-id="7579892222609244195" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别在 vue 中使用公共 less 文件没有提示信息的烦恼"/> <meta itemprop="keywords" content="Vue.js,Less,CSS"/> <meta itemprop="datePublished" content="2025-12-05T04:02:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小书包酱"/> <meta itemprop="url" content="https://juejin.cn/user/184373685008184"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别在 vue 中使用公共 less 文件没有提示信息的烦恼
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/184373685008184/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小书包酱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T04:02:20.000Z" title="Fri Dec 05 2025 04:02:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">痛点：Vue项目中Less开发的困扰</h2>
<p>作为一名Vue开发者，当你同时使用Less作为样式预处理器时，是否经常遇到这些令人抓狂的问题：</p>
<ol>
<li><strong>变量提示缺失</strong>：在Vue单文件组件的<code>&lt;style lang="less"&gt;</code>标签中，输入<code>@</code>想引用Less变量时，VSCode没有任何智能提示</li>
<li><strong>混入函数找不到</strong>：使用<code>.border-radius()</code>这样的Less混入时，需要手动查看定义文件</li>
<li><strong>跳转定义困难</strong>：想查看某个Less变量的定义位置？只能全局搜索</li>
<li><strong>错误难以发现</strong>：拼写错误的变量名要到编译时才报错，打断开发流程</li>
</ol>
<h2 data-id="heading-1">解决方案：easier-less提示增强版</h2>
<p>我fork了原有的easier-less插件，只是在此基础上加了一些细节，新增了一些功能。</p>
<blockquote>
<p>在项目的 .vscode/settings.json 中加上了 less 文件地址后，即可拥有以下支持。</p>
</blockquote>
<h3 data-id="heading-2">🚀 核心特性</h3>
<h4 data-id="heading-3">1. <strong>智能变量提示</strong></h4>
<ul>
<li>在Vue文件的Less样式中输入<code>@</code>，立即显示所有可用变量</li>
<li>支持颜色变量的颜色预览</li>
</ul>
<h4 data-id="heading-4">2. <strong>混入函数支持</strong></h4>
<ul>
<li>输入<code>.</code>即可看到所有可用的混入函数</li>
<li>支持参数提示</li>
</ul>
<h4 data-id="heading-5">3. <strong>定义跳转</strong></h4>
<ul>
<li><code>Ctrl+点击</code>变量名直接跳转到定义位置</li>
<li>支持跨文件的定义跳转</li>
</ul>
<h3 data-id="heading-6">📦 安装方式</h3>
<h4 data-id="heading-7">方法一：VSCode扩展商店（推荐）</h4>
<ol>
<li>打开VSCode</li>
<li>进入扩展商店（Ctrl+Shift+X）</li>
<li>搜索"easy-use-less-vue"</li>
<li>点击安装</li>
</ol>
<h4 data-id="heading-8">方法二：手动安装</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆仓库</span>
git <span class="hljs-built_in">clone</span> https://github.com/dmxiaoshubao/easier-less.git

<span class="hljs-comment"># 进入目录</span>
<span class="hljs-built_in">cd</span> easier-less

<span class="hljs-comment"># 安装依赖</span>
yarn

<span class="hljs-comment"># 打包</span>
npm run compile

<span class="hljs-comment"># 在VSCode中按F5运行测试，然后打包成vsix安装</span>
</code></pre>
<h3 data-id="heading-9">⚙️ 快速配置</h3>
<p>在项目根目录创建或修改<code>.vscode/settings.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"less.suppressNotice"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"less.files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"./src/styles/variables.less"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"./src/styles/mixins.less"</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-10">🎯 使用示例</h3>
<h4 data-id="heading-11">场景一：智能变量提示</h4>
<p>在<code>variables.less</code>中定义：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@primary-color:</span> <span class="hljs-number">#1890ff</span>;
<span class="hljs-variable">@border-radius:</span> <span class="hljs-number">4px</span>;
</code></pre>
<p>在Vue组件中使用时：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;style lang="less"&gt;
.container {
  background-color: @primary-color; // 输入@时会有提示
  border-radius: @border-radius;
}
&lt;/style&gt;
</code></pre>
<h4 data-id="heading-12">场景二：混入函数支持</h4>
<p>在<code>mixins.less</code>中定义：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-class">.flex-center</span>() {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">justify-content</span>: center;
  <span class="hljs-attribute">align-items</span>: center;
}
</code></pre>
<p>使用时获得完整提示：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;style lang="less"&gt;
.card {
  .flex-center(); // 输入.时会有提示
}
&lt;/style&gt;
</code></pre>
<h3 data-id="heading-13">🐛 常见问题解决</h3>
<p><strong>Q: 插件没有生效？</strong>
A: 检查：</p>
<ol>
<li>VSCode已重启</li>
<li>文件语言模式设置为"Vue"</li>
<li>style标签有<code>lang="less"</code>属性</li>
</ol>
<p><strong>Q: 变量提示不完整？</strong>
A: 确保变量文件路径配置正确，文件已保存。</p>
<p><strong>Q: 有提示写了但是报错？</strong>
A: 需要在 <code>&lt;style lang="less"&gt;&lt;/style&gt;</code>中自行引入该公共 less 文件。
eg: <code>@import (reference) from '@/assets/styles/mixin.less'; </code>本插件只作提示信息使用。</p>
<h3 data-id="heading-14">🤝 参与贡献</h3>
<p>如果你发现bug或有改进建议：</p>
<ol>
<li>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdmxiaoshubao%2Feasier-less" target="_blank" title="https://github.com/dmxiaoshubao/easier-less" ref="nofollow noopener noreferrer">GitHub仓库</a></li>
<li>提交Issue或Pull Request</li>
<li>参与功能讨论</li>
</ol>
<h3 data-id="heading-15">🎉 开始使用</h3>
<p>不要再让样式开发成为你的瓶颈！安装easier-less提示增强版，体验流畅的Vue+Less开发流程。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 或者直接通过VSIX安装</span>
code --install-extension easier-less-enhanced.vsix
</code></pre>
<p>提升开发效率，从更好的工具开始。现在就尝试这款专为Vue开发者打造的Less增强插件吧！</p>
<hr/>
<p><em>如果你觉得这个插件有帮助，欢迎在GitHub上给我一个Star⭐，这对我非常重要！</em></p>
<p><em>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdmxiaoshubao%2Feasier-less" target="_blank" title="https://github.com/dmxiaoshubao/easier-less" ref="nofollow noopener noreferrer">github.com/dmxiaoshuba…</a></em></p>
<p><em>有任何问题或建议，欢迎在Issues中讨论！</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[flutter如何实现有登陆权限管理]]></title>    <link>https://juejin.cn/post/7579846221168508982</link>    <guid>https://juejin.cn/post/7579846221168508982</guid>    <pubDate>2025-12-05T04:51:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579846221168508982" data-draft-id="7579843977849061430" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="flutter如何实现有登陆权限管理"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-05T04:51:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="linhuai"/> <meta itemprop="url" content="https://juejin.cn/user/3685218707586839"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            flutter如何实现有登陆权限管理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3685218707586839/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    linhuai
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T04:51:21.000Z" title="Fri Dec 05 2025 04:51:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Flutter 中实现<strong>登录权限管理</strong>，核心是解决「登录状态持久化」「路由权限拦截」「接口鉴权」三大核心问题。以下是一套完整、可落地的实现方案，包含状态管理、路由拦截、持久化、接口鉴权等关键环节：</p>
<p>git: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwinfrise%2Fflutter_login_auth_app" target="_blank" title="https://github.com/winfrise/flutter_login_auth_app" ref="nofollow noopener noreferrer">github.com/winfrise/fl…</a></p>
<p>项目目录：</p>
<pre><code class="hljs language-plaintext" lang="plaintext">lib/
├── main.dart                 # 项目入口
├── pages/                    # 页面（登录页、首页、个人中心等）
│   ├── login/
│   ├── home/
│   └── profile/
├── providers/                # 状态管理（Provider/ChangeNotifier 类）
│   ├── auth_provider.dart    # 登录状态管理（核心文件）
│   └── other_provider.dart   # 其他全局状态（如主题、设置）
├── routes/                   # 路由相关（路由常量、路由拦截）
│   ├── app_routes.dart
│   └── app_router.dart
├── utils/                    # 工具类（网络请求、本地存储、通用方法）
│   ├── http_util.dart
│   └── storage_util.dart
└── models/                   # 数据模型（用户信息、接口返回模型）
    └── user_model.dart
</code></pre>
<h3 data-id="heading-0">一、核心思路梳理</h3>
<ol>
<li><strong>登录状态存储</strong>：用本地持久化（如 <code>SharedPreferences</code>）保存登录凭证（token / 用户信息），APP 启动时读取并初始化状态；</li>
<li><strong>全局状态管理</strong>：用 <code>Provider</code>/<code>GetX</code>/<code>Bloc</code> 管理登录状态，让所有页面能实时感知登录状态变化；</li>
<li><strong>路由权限拦截</strong>：自定义路由守卫，跳转需要登录的页面时，检查登录状态，未登录则跳转到登录页；</li>
<li><strong>接口鉴权</strong>：统一封装网络请求，请求头自动携带 token，token 失效时（401 错误）触发登出逻辑；</li>
<li><strong>登出逻辑</strong>：清除本地凭证 + 重置全局状态 + 跳转登录页。</li>
</ol>
<h3 data-id="heading-1">二、分步实现（以 Provider + SharedPreferences 为例）</h3>
<h4 data-id="heading-2">步骤 1：依赖准备</h4>
<p>添加核心依赖（持久化 + 状态管理）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">dependencies:</span>
  <span class="hljs-attr">flutter:</span>
    <span class="hljs-attr">sdk:</span> <span class="hljs-string">flutter</span>
  <span class="hljs-attr">shared_preferences:</span> <span class="hljs-string">^2.2.2</span>  <span class="hljs-comment"># 本地持久化</span>
  <span class="hljs-attr">provider:</span> <span class="hljs-string">^6.1.1</span>            <span class="hljs-comment"># 状态管理</span>
  <span class="hljs-attr">dio:</span> <span class="hljs-string">^5.4.0</span>                  <span class="hljs-comment"># 网络请求（接口鉴权）</span>
  <span class="hljs-attr">flutter_secure_storage:</span> <span class="hljs-string">^8.0.0</span> <span class="hljs-comment"># 敏感信息加密存储（可选，替代 SharedPreferences 存 token）</span>
</code></pre>
<h4 data-id="heading-3">步骤 2：封装登录状态管理（全局状态）</h4>
<p>创建 <code>AuthProvider</code> 管理登录状态，包含「登录 / 登出 / 状态检查」核心方法：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:shared_preferences/shared_preferences.dart'</span>;

<span class="hljs-comment">// 登录状态模型（可扩展用户信息）</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserModel</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> token;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> username;

  UserModel({<span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.token, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.username});
}

<span class="hljs-comment">// 全局登录状态管理</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ChangeNotifier</span> </span>{
  UserModel? _user; <span class="hljs-comment">// 当前登录用户（null 表示未登录）</span>
  <span class="hljs-built_in">bool</span> _isLoading = <span class="hljs-keyword">false</span>; <span class="hljs-comment">// 登录/登出加载状态</span>

  UserModel? <span class="hljs-keyword">get</span> user =&gt; _user;
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isLogin =&gt; _user != <span class="hljs-keyword">null</span>;
  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isLoading =&gt; _isLoading;

  <span class="hljs-comment">// APP 启动时初始化登录状态（读取本地存储）</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; initAuth() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> sp = <span class="hljs-keyword">await</span> SharedPreferences.getInstance();
    <span class="hljs-keyword">final</span> token = sp.getString(<span class="hljs-string">'token'</span>);
    <span class="hljs-keyword">final</span> username = sp.getString(<span class="hljs-string">'username'</span>);
    <span class="hljs-keyword">if</span> (token != <span class="hljs-keyword">null</span> &amp;&amp; username != <span class="hljs-keyword">null</span>) {
      _user = UserModel(token: token, username: username);
    }
    notifyListeners();
  }

  <span class="hljs-comment">// 登录方法（存储凭证到本地 + 更新状态）</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; login({<span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> username, <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> password}) <span class="hljs-keyword">async</span> {
    _isLoading = <span class="hljs-keyword">true</span>;
    notifyListeners();

    <span class="hljs-comment">// 模拟接口请求（替换为真实登录接口）</span>
    <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">1</span>));
    <span class="hljs-keyword">final</span> token = <span class="hljs-string">'mock_token_<span class="hljs-subst">${DateTime.now().millisecondsSinceEpoch}</span>'</span>;

    <span class="hljs-comment">// 存储到本地</span>
    <span class="hljs-keyword">final</span> sp = <span class="hljs-keyword">await</span> SharedPreferences.getInstance();
    <span class="hljs-keyword">await</span> sp.setString(<span class="hljs-string">'token'</span>, token);
    <span class="hljs-keyword">await</span> sp.setString(<span class="hljs-string">'username'</span>, username);

    <span class="hljs-comment">// 更新全局状态</span>
    _user = UserModel(token: token, username: username);
    _isLoading = <span class="hljs-keyword">false</span>;
    notifyListeners();
  }

  <span class="hljs-comment">// 登出方法（清除本地凭证 + 重置状态）</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; logout() <span class="hljs-keyword">async</span> {
    _isLoading = <span class="hljs-keyword">true</span>;
    notifyListeners();

    <span class="hljs-comment">// 清除本地存储</span>
    <span class="hljs-keyword">final</span> sp = <span class="hljs-keyword">await</span> SharedPreferences.getInstance();
    <span class="hljs-keyword">await</span> sp.remove(<span class="hljs-string">'token'</span>);
    <span class="hljs-keyword">await</span> sp.remove(<span class="hljs-string">'username'</span>);

    <span class="hljs-comment">// 重置状态</span>
    _user = <span class="hljs-keyword">null</span>;
    _isLoading = <span class="hljs-keyword">false</span>;
    notifyListeners();
  }
}
</code></pre>
<h4 data-id="heading-4">步骤 3：路由权限拦截（自定义路由守卫）</h4>
<p>自定义 <code>MaterialApp</code> 的 <code>onGenerateRoute</code>，实现「需要登录的页面拦截」：</p>
<h5 data-id="heading-5">3.1 定义路由常量（区分需要登录的页面）</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 路由常量</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppRoutes</span> </span>{
  <span class="hljs-comment">// 公开页面（无需登录）</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> login = <span class="hljs-string">'/login'</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> splash = <span class="hljs-string">'/splash'</span>;

  <span class="hljs-comment">// 需登录页面</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> home = <span class="hljs-string">'/home'</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> profile = <span class="hljs-string">'/profile'</span>;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> settings = <span class="hljs-string">'/settings'</span>;

  <span class="hljs-comment">// 判断页面是否需要登录</span>
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> needAuth(<span class="hljs-built_in">String</span> routeName) {
    <span class="hljs-keyword">return</span> [home, profile, settings].contains(routeName);
  }
}
</code></pre>
<h5 data-id="heading-6">3.2 自定义路由生成器（拦截逻辑）</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:provider/provider.dart'</span>;

<span class="hljs-comment">// 页面导入（示例）</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'pages/splash_page.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'pages/login_page.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'pages/home_page.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'pages/profile_page.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppRouter</span> </span>{
  <span class="hljs-keyword">static</span> Route&lt;<span class="hljs-built_in">dynamic</span>&gt; generateRoute(RouteSettings settings) {
    <span class="hljs-keyword">final</span> routeName = settings.name ?? AppRoutes.splash;

    <span class="hljs-keyword">return</span> MaterialPageRoute(
      builder: (context) {
        <span class="hljs-comment">// 1. 检查页面是否需要登录</span>
        <span class="hljs-keyword">final</span> needAuth = AppRoutes.needAuth(routeName);
        <span class="hljs-keyword">final</span> authProvider = Provider.of&lt;AuthProvider&gt;(context, listen: <span class="hljs-keyword">false</span>);

        <span class="hljs-comment">// 2. 未登录且页面需要登录 → 跳转到登录页（携带原路由，登录后返回）</span>
        <span class="hljs-keyword">if</span> (needAuth &amp;&amp; !authProvider.isLogin) {
          <span class="hljs-keyword">return</span> LoginPage(
            redirectRoute: routeName, <span class="hljs-comment">// 登录成功后跳转的目标路由</span>
          );
        }

        <span class="hljs-comment">// 3. 路由分发</span>
        <span class="hljs-keyword">switch</span> (routeName) {
          <span class="hljs-keyword">case</span> AppRoutes.splash:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> SplashPage();
          <span class="hljs-keyword">case</span> AppRoutes.login:
            <span class="hljs-keyword">return</span> LoginPage(redirectRoute: settings.arguments <span class="hljs-keyword">as</span> <span class="hljs-built_in">String?</span>);
          <span class="hljs-keyword">case</span> AppRoutes.home:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> HomePage();
          <span class="hljs-keyword">case</span> AppRoutes.profile:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> ProfilePage();
          <span class="hljs-keyword">default</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> Scaffold(body: Center(child: Text(<span class="hljs-string">'404 Page'</span>)));
        }
      },
      settings: settings,
    );
  }
}
</code></pre>
<h4 data-id="heading-7">步骤 4：封装网络请求（接口鉴权）</h4>
<p>统一处理 token 携带、401 失效拦截：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:dio/dio.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:shared_preferences/shared_preferences.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'auth_provider.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HttpUtil</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">late</span> Dio _dio;

  <span class="hljs-comment">// 初始化 Dio</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> init() {
    _dio = Dio(BaseOptions(
      baseUrl: <span class="hljs-string">'https://your-api-domain.com'</span>,
      connectTimeout: <span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">10</span>),
      receiveTimeout: <span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">10</span>),
    ));

    <span class="hljs-comment">// 添加请求拦截器：自动携带 token</span>
    _dio.interceptors.add(InterceptorsWrapper(
      onRequest: (options, handler) <span class="hljs-keyword">async</span> {
        <span class="hljs-keyword">final</span> sp = <span class="hljs-keyword">await</span> SharedPreferences.getInstance();
        <span class="hljs-keyword">final</span> token = sp.getString(<span class="hljs-string">'token'</span>);
        <span class="hljs-keyword">if</span> (token != <span class="hljs-keyword">null</span>) {
          options.headers[<span class="hljs-string">'Authorization'</span>] = <span class="hljs-string">'Bearer <span class="hljs-subst">$token</span>'</span>;
        }
        <span class="hljs-keyword">return</span> handler.next(options);
      },
      onError: (error, handler) <span class="hljs-keyword">async</span> {
        <span class="hljs-comment">// 401 错误：token 失效 → 触发登出</span>
        <span class="hljs-keyword">if</span> (error.response?.statusCode == <span class="hljs-number">401</span>) {
          <span class="hljs-comment">// 获取全局 AuthProvider</span>
          <span class="hljs-keyword">final</span> context = navigatorKey.currentContext!;
          <span class="hljs-keyword">final</span> authProvider = Provider.of&lt;AuthProvider&gt;(context, listen: <span class="hljs-keyword">false</span>);
          <span class="hljs-keyword">await</span> authProvider.logout();
          <span class="hljs-comment">// 跳转到登录页</span>
          Navigator.pushNamedAndRemoveUntil(
            context,
            AppRoutes.login,
            (route) =&gt; <span class="hljs-keyword">false</span>,
          );
        }
        <span class="hljs-keyword">return</span> handler.next(error);
      },
    ));
  }

  <span class="hljs-comment">// 封装 GET 请求</span>
  <span class="hljs-keyword">static</span> Future&lt;Response&gt; <span class="hljs-keyword">get</span>(<span class="hljs-built_in">String</span> path, {<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? params}) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> _dio.<span class="hljs-keyword">get</span>(path, queryParameters: params);
  }

  <span class="hljs-comment">// 封装 POST 请求</span>
  <span class="hljs-keyword">static</span> Future&lt;Response&gt; post(<span class="hljs-built_in">String</span> path, {<span class="hljs-built_in">dynamic</span> data}) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> _dio.post(path, data: data);
  }
}

<span class="hljs-comment">// 全局导航 key（用于无上下文时跳转）</span>
<span class="hljs-keyword">final</span> GlobalKey&lt;NavigatorState&gt; navigatorKey = GlobalKey&lt;NavigatorState&gt;();
</code></pre>
<h4 data-id="heading-8">步骤 5：初始化全局状态 &amp; 路由</h4>
<p>在 <code>main.dart</code> 中初始化状态管理、路由、网络请求：</p>
<p>dart</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:provider/provider.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'auth_provider.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'app_router.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'http_util.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'app_routes.dart'</span>;

<span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>() <span class="hljs-keyword">async</span> {
  <span class="hljs-title class_">WidgetsFlutterBinding</span>.<span class="hljs-title function_">ensureInitialized</span>();
  <span class="hljs-comment">// 初始化网络请求</span>
  <span class="hljs-title class_">HttpUtil</span>.<span class="hljs-title function_">init</span>();

  <span class="hljs-title function_">runApp</span>(
    <span class="hljs-title class_">ChangeNotifierProvider</span>(
      <span class="hljs-attr">create</span>: <span class="hljs-function">(<span class="hljs-params">context</span>) =&gt;</span> <span class="hljs-title class_">AuthProvider</span>()..<span class="hljs-title function_">initAuth</span>(), <span class="hljs-comment">// 启动时初始化登录状态</span>
      <span class="hljs-attr">child</span>: <span class="hljs-keyword">const</span> <span class="hljs-title class_">MyApp</span>(),
    ),
  );
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">StatelessWidget</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">MyApp</span>({<span class="hljs-variable language_">super</span>.<span class="hljs-property">key</span>});

  <span class="hljs-meta">@override</span>
  <span class="hljs-title class_">Widget</span> <span class="hljs-title function_">build</span>(<span class="hljs-params">BuildContext context</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">MaterialApp</span>(
      <span class="hljs-attr">title</span>: <span class="hljs-string">'权限管理示例'</span>,
      <span class="hljs-attr">navigatorKey</span>: navigatorKey, <span class="hljs-comment">// 全局导航 key</span>
      <span class="hljs-attr">initialRoute</span>: <span class="hljs-title class_">AppRoutes</span>.<span class="hljs-property">splash</span>, <span class="hljs-comment">// 启动页</span>
      <span class="hljs-attr">onGenerateRoute</span>: <span class="hljs-title class_">AppRouter</span>.<span class="hljs-property">generateRoute</span>, <span class="hljs-comment">// 自定义路由生成器</span>
      <span class="hljs-attr">debugShowCheckedModeBanner</span>: <span class="hljs-literal">false</span>,
    );
  }
}
</code></pre>
<h4 data-id="heading-9">步骤 6：实现登录 / 登出页面示例</h4>
<h5 data-id="heading-10">6.1 登录页（LoginPage）</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:provider/provider.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'auth_provider.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'app_routes.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoginPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> redirectRoute; <span class="hljs-comment">// 登录成功后跳转的路由</span>

  <span class="hljs-keyword">const</span> LoginPage({<span class="hljs-keyword">super</span>.key, <span class="hljs-keyword">this</span>.redirectRoute});

  <span class="hljs-meta">@override</span>
  State&lt;LoginPage&gt; createState() =&gt; _LoginPageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_LoginPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">LoginPage</span>&gt; </span>{
  <span class="hljs-keyword">final</span> _usernameCtrl = TextEditingController();
  <span class="hljs-keyword">final</span> _passwordCtrl = TextEditingController();

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">final</span> authProvider = Provider.of&lt;AuthProvider&gt;(context);

    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(title: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'登录'</span>)),
      body: Padding(
        padding: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">16</span>),
        child: Column(
          children: [
            TextField(
              controller: _usernameCtrl,
              decoration: <span class="hljs-keyword">const</span> InputDecoration(hintText: <span class="hljs-string">'用户名'</span>),
            ),
            TextField(
              controller: _passwordCtrl,
              obscureText: <span class="hljs-keyword">true</span>,
              decoration: <span class="hljs-keyword">const</span> InputDecoration(hintText: <span class="hljs-string">'密码'</span>),
            ),
            <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">20</span>),
            ElevatedButton(
              onPressed: authProvider.isLoading
                  ? <span class="hljs-keyword">null</span>
                  : () <span class="hljs-keyword">async</span> {
                      <span class="hljs-comment">// 调用登录方法</span>
                      <span class="hljs-keyword">await</span> authProvider.login(
                        username: _usernameCtrl.text,
                        password: _passwordCtrl.text,
                      );
                      <span class="hljs-comment">// 登录成功 → 跳转到目标路由（默认首页）</span>
                      <span class="hljs-keyword">if</span> (authProvider.isLogin) {
                        Navigator.pushReplacementNamed(
                          context,
                          widget.redirectRoute ?? AppRoutes.home,
                        );
                      }
                    },
              child: authProvider.isLoading
                  ? <span class="hljs-keyword">const</span> CircularProgressIndicator(size: <span class="hljs-number">20</span>)
                  : <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'登录'</span>),
            ),
          ],
        ),
      ),
    );
  }
}
</code></pre>
<h5 data-id="heading-11">6.2 个人中心（需登录，示例）</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:provider/provider.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'auth_provider.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'app_routes.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProfilePage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">const</span> ProfilePage({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">final</span> authProvider = Provider.of&lt;AuthProvider&gt;(context);
    <span class="hljs-keyword">final</span> user = authProvider.user!;

    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(title: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'个人中心'</span>)),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Text(<span class="hljs-string">'用户名：<span class="hljs-subst">${user.username}</span>'</span>),
            Text(<span class="hljs-string">'Token：<span class="hljs-subst">${user.token}</span>'</span>),
            <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">20</span>),
            ElevatedButton(
              onPressed: () <span class="hljs-keyword">async</span> {
                <span class="hljs-keyword">await</span> authProvider.logout();
                <span class="hljs-comment">// 登出后跳转到登录页</span>
                Navigator.pushNamedAndRemoveUntil(
                  context,
                  AppRoutes.login,
                  (route) =&gt; <span class="hljs-keyword">false</span>,
                );
              },
              child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'退出登录'</span>),
            ),
          ],
        ),
      ),
    );
  }
}
</code></pre>
<h3 data-id="heading-12">三、进阶优化点</h3>
<h4 data-id="heading-13">1. 敏感信息加密存储</h4>
<p><code>SharedPreferences</code> 是明文存储，token 等敏感信息建议用 <code>flutter_secure_storage</code>（基于 Keychain/iOS、Keystore/Android 加密）：</p>
<p>dart</p>
<pre><code class="hljs language-php" lang="php">import <span class="hljs-string">'package:flutter_secure_storage/flutter_secure_storage.dart'</span>;

<span class="hljs-keyword">final</span> storage = <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">FlutterSecureStorage</span>();

<span class="hljs-comment">// 存储 token</span>
await storage.<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-attr">key</span>: <span class="hljs-string">'token'</span>, <span class="hljs-attr">value</span>: token);
<span class="hljs-comment">// 读取 token</span>
<span class="hljs-keyword">final</span> token = await storage.<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-attr">key</span>: <span class="hljs-string">'token'</span>);
<span class="hljs-comment">// 清除 token</span>
await storage.<span class="hljs-title function_ invoke__">delete</span>(<span class="hljs-attr">key</span>: <span class="hljs-string">'token'</span>);
</code></pre>
<h4 data-id="heading-14">2. 多状态管理方案（替代 Provider）</h4>
<ul>
<li><strong>GetX</strong>：更轻量，无需上下文，直接通过 <code>Get.put(AuthController())</code> 管理状态，路由拦截用 <code>GetMiddleware</code>；</li>
<li><strong>Bloc/Cubit</strong>：适合复杂状态逻辑，通过 <code>BlocBuilder</code> 响应状态变化，路由拦截结合 <code>BlocListener</code>；</li>
<li><strong>Riverpod</strong>：Provider 的升级版，更灵活的依赖注入，无上下文访问状态。</li>
</ul>
<h4 data-id="heading-15">3. 自动刷新 Token</h4>
<p>接口返回 401 时，可先尝试用 refreshToken 刷新 token，失败再登出：</p>
<p>dart</p>
<pre><code class="hljs language-dart" lang="dart">onError: (error, handler) <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">if</span> (error.response?.statusCode == <span class="hljs-number">401</span>) {
    <span class="hljs-comment">// 1. 获取 refreshToken</span>
    <span class="hljs-keyword">final</span> refreshToken = <span class="hljs-keyword">await</span> storage.read(key: <span class="hljs-string">'refreshToken'</span>);
    <span class="hljs-keyword">if</span> (refreshToken == <span class="hljs-keyword">null</span>) {
      <span class="hljs-comment">// 无 refreshToken → 登出</span>
      <span class="hljs-keyword">await</span> authProvider.logout();
      <span class="hljs-keyword">return</span> handler.reject(error);
    }

    <span class="hljs-comment">// 2. 调用刷新 token 接口</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> res = <span class="hljs-keyword">await</span> _dio.post(<span class="hljs-string">'/refreshToken'</span>, data: {<span class="hljs-string">'refreshToken'</span>: refreshToken});
      <span class="hljs-keyword">final</span> newToken = res.data[<span class="hljs-string">'token'</span>];
      <span class="hljs-comment">// 3. 存储新 token</span>
      <span class="hljs-keyword">await</span> storage.write(key: <span class="hljs-string">'token'</span>, value: newToken);
      <span class="hljs-comment">// 4. 重新发起原请求</span>
      <span class="hljs-keyword">final</span> options = error.requestOptions;
      options.headers[<span class="hljs-string">'Authorization'</span>] = <span class="hljs-string">'Bearer <span class="hljs-subst">$newToken</span>'</span>;
      <span class="hljs-keyword">final</span> retryRes = <span class="hljs-keyword">await</span> _dio.request(
        options.path,
        options: options,
      );
      <span class="hljs-keyword">return</span> handler.resolve(retryRes);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-comment">// 刷新失败 → 登出</span>
      <span class="hljs-keyword">await</span> authProvider.logout();
      <span class="hljs-keyword">return</span> handler.reject(error);
    }
  }
  <span class="hljs-keyword">return</span> handler.next(error);
}
</code></pre>
<h4 data-id="heading-16">4. 启动页判断登录状态</h4>
<p>Splash 页初始化时，根据登录状态决定跳转到首页 / 登录页：</p>
<p>dart</p>
<pre><code class="hljs language-scala" lang="scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SplashPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  const <span class="hljs-type">SplashPage</span>({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">State</span>&lt;<span class="hljs-type">SplashPage</span>&gt; createState() =&gt; _SplashPageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_SplashPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State&lt;SplashPage&gt;</span> </span>{
  <span class="hljs-meta">@override</span>
  void initState() {
    <span class="hljs-keyword">super</span>.initState();
    _checkAuth();
  }

  <span class="hljs-type">Future</span>&lt;void&gt; _checkAuth() async {
    await <span class="hljs-type">Future</span>.delayed(const <span class="hljs-type">Duration</span>(seconds: <span class="hljs-number">2</span>)); <span class="hljs-comment">// 模拟启动页延迟</span>
    <span class="hljs-keyword">final</span> authProvider = <span class="hljs-type">Provider</span>.of&lt;<span class="hljs-type">AuthProvider</span>&gt;(context, listen: <span class="hljs-literal">false</span>);
    <span class="hljs-keyword">if</span> (authProvider.isLogin) {
      <span class="hljs-type">Navigator</span>.pushReplacementNamed(context, <span class="hljs-type">AppRoutes</span>.home);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-type">Navigator</span>.pushReplacementNamed(context, <span class="hljs-type">AppRoutes</span>.login);
    }
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-type">Widget</span> build(<span class="hljs-type">BuildContext</span> context) {
    <span class="hljs-keyword">return</span> const <span class="hljs-type">Scaffold</span>(
      body: <span class="hljs-type">Center</span>(child: <span class="hljs-type">Text</span>('启动中...')),
    );
  }
}
</code></pre>
<h3 data-id="heading-17">四、核心总结</h3>
<ol>
<li><strong>状态持久化</strong>：用 <code>SharedPreferences</code>/<code>flutter_secure_storage</code> 存 token，APP 启动时初始化；</li>
<li><strong>全局状态</strong>：用 Provider/GetX/Bloc 管理登录状态，所有页面实时感知；</li>
<li><strong>路由拦截</strong>：自定义 <code>onGenerateRoute</code>，拦截需要登录的页面，未登录则跳转登录页；</li>
<li><strong>接口鉴权</strong>：统一封装网络请求，自动携带 token，处理 401 失效逻辑；</li>
<li><strong>登出逻辑</strong>：清除本地凭证 + 重置状态 + 跳转登录页（清空路由栈）。</li>
</ol>
<p>这套方案覆盖了从「登录」到「权限控制」再到「登出」的全流程，适配大多数 Flutter 应用的权限管理需求，可根据项目复杂度（如多角色权限、动态路由）扩展。</p>
<p>分享</p>
<p>如何使用SharedPreferences保存用户登录凭证？</p>
<p>如何使用Provider管理登录状态？</p>
<p>如何自定义路由守卫？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何优雅的设置公司的NPM源]]></title>    <link>https://juejin.cn/post/7579849892614471716</link>    <guid>https://juejin.cn/post/7579849892614471716</guid>    <pubDate>2025-12-05T05:17:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579849892614471716" data-draft-id="7579843977849356342" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何优雅的设置公司的NPM源"/> <meta itemprop="keywords" content="前端,NPM"/> <meta itemprop="datePublished" content="2025-12-05T05:17:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="杨啸_新房客"/> <meta itemprop="url" content="https://juejin.cn/user/671180664355155"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何优雅的设置公司的NPM源
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/671180664355155/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    杨啸_新房客
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T05:17:10.000Z" title="Fri Dec 05 2025 05:17:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>避免公司源与官方源冲突，以及发布没必要的库到公司源。</p>
<p>这里的案例公司的发布地址与拉取地址不一样， 具体情况自行修改。</p>
<h3 data-id="heading-0">库修改</h3>
<p>在创建或现有库项目中，需要有进行两处修改：</p>
<p>1. package.json中添加要发布地址，代码如下：</p>
<pre><code class="hljs language-json" lang="json">  <span class="hljs-attr">"publishConfig"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"registry"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://nexus.op.xxxxxxxx.cn/repository/privarte-npm/"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
</code></pre>
<p>2. 根目录添加文件《.npmrc》，内容为：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">registry</span>=http://nexus.op.xxxxxxxx.cn/repository/goldnet-npm-group/
</code></pre>
<h3 data-id="heading-1">添加私有的NPM账户</h3>
<p>1. 添加指定源账户，这里是公司账户，一般要求用户名/密码/邮箱：user，password，<a href="https://link.juejin.cn?target=mailto%3Amail%40xxx.com" target="_blank" title="mailto:mail@xxx.com" ref="nofollow noopener noreferrer">mail@xxx.com</a>，命令行执行</p>
<pre><code class="hljs language-ini" lang="ini">npm <span class="hljs-attr">adduser--registry</span>=http://nexus.op.hang-xin.cn/repository/goldnet-npm/
</code></pre>
<h4 data-id="heading-2">发布库</h4>
<p>npm publish</p>
<p> </p>
<p>基于上述设置后，在库中的操作只针对配置文件中的源，不会污染全局设定了。 可以在不同的项目根目录执行<code>npm config list</code>看源地址是否设置成功</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[地址与地基：在 JavaScript 的堆栈迷宫里，重新理解“复制”的哲学]]></title>    <link>https://juejin.cn/post/7579892134817366051</link>    <guid>https://juejin.cn/post/7579892134817366051</guid>    <pubDate>2025-12-05T05:27:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579892134817366051" data-draft-id="7579887768227217442" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="地址与地基：在 JavaScript 的堆栈迷宫里，重新理解“复制”的哲学"/> <meta itemprop="keywords" content="JavaScript,前端,面试"/> <meta itemprop="datePublished" content="2025-12-05T05:27:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="漫天黄叶远飞"/> <meta itemprop="url" content="https://juejin.cn/user/2948205649344634"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            地址与地基：在 JavaScript 的堆栈迷宫里，重新理解“复制”的哲学
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2948205649344634/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    漫天黄叶远飞
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T05:27:50.000Z" title="Fri Dec 05 2025 05:27:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> a = <span class="hljs-number">1</span>
<span class="hljs-keyword">let</span> b = a
<span class="hljs-keyword">let</span> obj = {
  <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>
}
<span class="hljs-keyword">let</span> obj2 = obj
</code></pre>
<p>把 a 的值赋值给 b ，这个是一种拷贝，但是把 obj 的值赋给另一个对象 obj2 ，它就不是拷贝，这是为啥呢，今天我们来深入探讨 js 中的 <strong>拷贝</strong> --- 分为浅拷贝和深拷贝，由于原始类型在任何语言层面操作都是值复制，没有共享问题，也就没有“深浅”维度；所以在这里，拷贝只针对引用类型，基于原对象，拷贝得到一个新对象，这也解释了为什么上面对象赋值不算拷贝。</p>
<hr/>
<h2 data-id="heading-1">浅拷贝</h2>
<h3 data-id="heading-2">1、<code>[].slice(0)</code> ---截取数组</h3>
<p><code>[].slice(0)</code> 就是一种浅拷贝，我们来看看一下浅拷贝都有些什么特征</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> arr = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>, {<span class="hljs-attr">age</span>: <span class="hljs-number">18</span>}]    
<span class="hljs-keyword">const</span> arr2 = arr.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>)
arr2.<span class="hljs-title function_">splice</span>(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr);   
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be9bda81c3ca43d58da3ca82bc02f622~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ryr5aSp6buE5Y-26L-c6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765517270&amp;x-signature=easKNcc8O95DkTPfkJXf26ltJqg%3D" alt="c538c217-9814-4c79-9aae-6add2fa9d77a.png" loading="lazy"/><br/>
看输出结果，它符合基于原对象，拷贝得到一个新对象，新对象改动不影响旧对象，但是这样也解释不了为啥叫浅拷贝呀，别急，我们再来看一段代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> arr = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>, {<span class="hljs-attr">age</span>: <span class="hljs-number">18</span>}]
<span class="hljs-keyword">const</span> arr2 = arr.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>)
arr[<span class="hljs-number">4</span>].<span class="hljs-property">age</span> = <span class="hljs-number">20</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr2);
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/251c27c7a89b4c81bc13dba1b0937ae8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ryr5aSp6buE5Y-26L-c6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765517270&amp;x-signature=IfkF9cYFm9KyIFQfr9tcRbB8N4k%3D" alt="78a83d3d-d1da-44f0-8d5c-e26a4afa842d.png" loading="lazy"/><br/>
我们可以看到，旧对象里面的子对象在拷贝过后改动会影响新对象里面的子对象，只是因为所有的引用类型都会在堆里放一个引用地址，我们拷贝时新对象里面的子对象是 copy 了一个引用地址，后续子对象里面的值更改过后，新对象也会跟着变，如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e32e2c73eafe4933a9031ec9203974f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ryr5aSp6buE5Y-26L-c6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765517270&amp;x-signature=vQYqsIK6%2FplsxbNTtODxTb2wL48%3D" alt="66c027236d7bb4c7a370e6650d915a55.png" loading="lazy"/><br/>
所以我们可以知道 <strong>浅拷贝</strong> --- 新对象受原对象的影响（只拷贝了原对象的第一层，里面的子对象拷贝的还是引用地址）。实现浅拷贝的方法有五种，分别是 <code>[].slice(0)</code> 、<code>[...arr]</code> 、 <code>arr1.concat(arr2)</code> 、 <code>arr.toReversed().reverse()</code>、 <code>Object.assign({}, obj)</code> 。</p>
<hr/>
<h3 data-id="heading-3">2、 <code>[...arr]</code> ---解构数组</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> a = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, {<span class="hljs-attr">age</span>: <span class="hljs-number">18</span>}]
<span class="hljs-keyword">let</span> c = [...a]
c.<span class="hljs-title function_">splice</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)
a[<span class="hljs-number">2</span>].<span class="hljs-property">age</span> = <span class="hljs-number">19</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(c);
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85b9541d575b497b8f1613705614cb13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ryr5aSp6buE5Y-26L-c6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765517270&amp;x-signature=mPbu2M7%2BJC%2Bn6Somn5TnENaqt5w%3D" alt="744c2209-2f31-44b3-9979-652d8c15fb3e.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-4">3、 <code>arr1.concat(arr2)</code> --- 合并数组</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> a = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, {<span class="hljs-attr">age</span>: <span class="hljs-number">18</span>}]
<span class="hljs-keyword">const</span> b = [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>]
<span class="hljs-keyword">const</span> c = a.<span class="hljs-title function_">concat</span>(b)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(c, a);
<span class="hljs-keyword">const</span> d = [].<span class="hljs-title function_">concat</span>(a)
a[<span class="hljs-number">3</span>].<span class="hljs-property">age</span> = <span class="hljs-number">20</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(d);
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3030de226ee0474480a4672f5823ab5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ryr5aSp6buE5Y-26L-c6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765517270&amp;x-signature=Vn13FUV5xvsfTW%2F8met3nrotPx4%3D" alt="fedf2b92-d80f-4d51-a690-7fe491aaadcd.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-5">4、 <code>arr.toReversed().reverse()</code> --- 反转数组</h3>
<p><code>.toReversed()</code> 得到一个反转的新数组，<code>.reverse()</code>方法会反转原数组，配合起来就能实现浅拷贝：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, {<span class="hljs-attr">age</span>: <span class="hljs-number">18</span>}]
<span class="hljs-keyword">const</span> arr2 = arr.<span class="hljs-title function_">toReversed</span>().<span class="hljs-title function_">reverse</span>()
arr2.<span class="hljs-title function_">splice</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)
arr[<span class="hljs-number">3</span>].<span class="hljs-property">age</span> = <span class="hljs-number">20</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr2);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr);
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77ac66a6a29443ffbdfc6d1332a9f573~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ryr5aSp6buE5Y-26L-c6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765517270&amp;x-signature=mDwOqjcTqfRb4vqPN4dAoV94W7g%3D" alt="649d1bc3-acae-4acc-9266-9d774ab45715.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-6">5、 <code>Object.assign({}, obj)</code> --- 合并对象</h3>
<p>它和合并数组不一样，它把后面对象里的值放入前面的对象里面，覆盖前面的对象里的值，返回一个新对象，后面对象不变，所以在这里实现拷贝效果都是在前面放一个空对象</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'俊杰'</span>,
  <span class="hljs-attr">like</span>: [<span class="hljs-string">'泡脚'</span>]
}
<span class="hljs-keyword">const</span> newObj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, obj)
obj.<span class="hljs-property">like</span>[<span class="hljs-number">0</span>] = <span class="hljs-string">'台球'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newObj);
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/954abe10acce4c5987af60f77cc0c0b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ryr5aSp6buE5Y-26L-c6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765517270&amp;x-signature=Kea26rOunYcuW%2BjahsMTAFxj2Ro%3D" alt="3f682b4f-369f-4b7b-92ed-3f050c232420.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-7">手搓浅拷贝</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'俊杰'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
  <span class="hljs-attr">like</span>: {
    <span class="hljs-attr">n</span>: <span class="hljs-string">'洗脚'</span>,
    <span class="hljs-attr">m</span>: <span class="hljs-string">'台球'</span>
  }
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">shallowCopy</span>(<span class="hljs-params">obj</span>) {
  <span class="hljs-keyword">let</span> o = {}
  <span class="hljs-comment">// 遍历原对象，将原对象中的 key，value 都存到新对象中一份</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> obj) {   <span class="hljs-comment">// key 为形参</span>
    <span class="hljs-keyword">if</span> (obj.<span class="hljs-title function_">hasOwnProperty</span>(key)) {  <span class="hljs-comment">// 判断当前的 key 是否是 obj 显示属性</span>
      o[key] = obj[key]    <span class="hljs-comment">// o.name = obj[name] = '俊杰'</span>
    }
  }
  <span class="hljs-keyword">return</span> o
}
<span class="hljs-keyword">const</span> newObj = <span class="hljs-title function_">shallowCopy</span>(obj)
obj.<span class="hljs-property">like</span>.<span class="hljs-property">m</span> = <span class="hljs-string">'篮球'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newObj);
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e689c4c4b044c48a61b010235894aaa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ryr5aSp6buE5Y-26L-c6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765517270&amp;x-signature=jjQwg3iQ5fRqXoA7xrIbQgsD%2BBM%3D" alt="9e1e036b-6105-466b-8178-28ee5548f0c5.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-8">深拷贝</h2>
<p>顾名思义：层层拷贝，新对象不受原对象修改的影响，深拷贝有两种方法 <code>structuredClone()</code> 和 <code>JSON.parse(JSON.stringify(obj))</code></p>
<h3 data-id="heading-9">1、<code>structuredClone()</code></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'俊杰'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
  <span class="hljs-attr">like</span>: {
    <span class="hljs-attr">n</span>: <span class="hljs-string">'洗脚'</span>,
    <span class="hljs-attr">m</span>: <span class="hljs-string">'台球'</span>
  },
  <span class="hljs-attr">a</span>: <span class="hljs-number">123n</span>,
}
<span class="hljs-keyword">const</span> newObj = <span class="hljs-title function_">structuredClone</span>(obj)
obj.<span class="hljs-property">like</span>.<span class="hljs-property">m</span> = <span class="hljs-string">'蓝球'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newObj);
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48385d7b227d4e5f99ae30717be3f13a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ryr5aSp6buE5Y-26L-c6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765517270&amp;x-signature=5S7afL3ohAKZcYbMxihIUY%2FIQyU%3D" alt="a3d5d87f-902e-49fa-8436-9c6b36624752.png" loading="lazy"/><br/>
它可以把子对象里面的东西全给 copy 出来，但是他有一个缺陷，就是无法拷贝函数和 Symbol。</p>
<hr/>
<h3 data-id="heading-10">2、 <code>JSON.parse(JSON.stringify(obj))</code></h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'俊杰'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
  <span class="hljs-attr">like</span>: {
    <span class="hljs-attr">n</span>: <span class="hljs-string">'洗脚'</span>,
    <span class="hljs-attr">m</span>: <span class="hljs-string">'台球'</span>
  }
 }
<span class="hljs-keyword">const</span> oo = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(obj))
obj.<span class="hljs-property">like</span>.<span class="hljs-property">m</span> = <span class="hljs-string">'篮球'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(oo);
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1abc5fd8e808460796519db41d7eee64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ryr5aSp6buE5Y-26L-c6aOe:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765517270&amp;x-signature=EJOm0y3S8X87oJ9N%2FNmaqxyMNgQ%3D" alt="80598ede-6b71-4e04-bab8-05e5a9ae86fb.png" loading="lazy"/><br/>
<code>JSON.stringify(obj)</code> 这是将里面的对象变为字符串，<code>JSON.parse(str)</code> 则是将里面的字符串变为对象，所以合起来实现了深拷贝，同样的他也有缺陷，无法处理 bigint, undefined, NaN, Infinity, function,Symbol。</p>
<h3 data-id="heading-11">手搓深拷贝</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'俊杰'</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
  <span class="hljs-attr">like</span>: {
    <span class="hljs-attr">n</span>: <span class="hljs-string">'洗脚'</span>,
    <span class="hljs-attr">m</span>: <span class="hljs-string">'台球'</span>
  }
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">deepClone</span>(<span class="hljs-params">obj</span>) {
  <span class="hljs-keyword">let</span> o = {}
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> obj) {
    <span class="hljs-keyword">if</span> (obj.<span class="hljs-title function_">hasOwnProperty</span>(key)) {
    <span class="hljs-comment">// 判断里面是否有引用类型例如对象，数组（函数除外），null也要除外</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-title function_">typeof</span>(obj[key]) == <span class="hljs-string">'object'</span> &amp;&amp; obj[key] !== <span class="hljs-literal">null</span>) {
      <span class="hljs-comment">// 如果是引用类型就再执行一次拷贝</span>
        <span class="hljs-keyword">const</span> childObj = <span class="hljs-title function_">deepClone</span>(obj[key])
        o[key] = childObj                      
      } <span class="hljs-keyword">else</span> {
        o[key] = obj[key]
      }
    }
  }
  <span class="hljs-keyword">return</span> o
}
<span class="hljs-keyword">const</span> newObj = <span class="hljs-title function_">deepClone</span>(obj)
obj.<span class="hljs-property">like</span>.<span class="hljs-property">m</span> = <span class="hljs-string">'篮球'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newObj);
</code></pre>
<p>运用递归思想，进行层层拷贝。</p>
<hr/>
<h2 data-id="heading-12">结语</h2>
<p>拷贝，看似只是“复制”二字，实则藏着 JS 内存模型的全部秘密。<br/>
浅拷贝，把引用地址递出去，像递名片——改的是同一份底稿；<br/>
深拷贝，把整座房子连地基都搬过来，从此山水不相逢。<br/>
下次再写 <code>let obj2 = obj</code> 时，不妨先问一句：<br/>
“我只是想要一把钥匙，还是想要一栋真正属于自己的房子？”<br/>
弄懂深浅，才能让你的数据不再“藕断丝连”，也让你的代码少一句 <code>console.log</code> 的叹息。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 JavaScript 中的继承与 instanceof 原理]]></title>    <link>https://juejin.cn/post/7579849892614504484</link>    <guid>https://juejin.cn/post/7579849892614504484</guid>    <pubDate>2025-12-05T05:24:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579849892614504484" data-draft-id="7579846221168541750" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 JavaScript 中的继承与 instanceof 原理"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-05T05:24:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ohyeah"/> <meta itemprop="url" content="https://juejin.cn/user/740446536480618"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 JavaScript 中的继承与 instanceof 原理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/740446536480618/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ohyeah
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T05:24:50.000Z" title="Fri Dec 05 2025 05:24:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 JavaScript 的面向对象编程（OOP）中，<strong>继承</strong>和 <strong><code>instanceof</code></strong> 是两个非常核心的概念。很多初学者容易将 <code>instanceof</code> 简单理解为“判断是否是某个类的实例”，但其实它的本质远不止于此。本文将结合你提供的多个代码示例，系统地梳理 JavaScript 中继承的几种常见方式，并深入剖析 <code>instanceof</code> 的底层机制。</p>
<hr/>
<h2 data-id="heading-0">一、<code>instanceof</code> 到底判断的是什么？</h2>
<p>先来看一个经典例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params"/>) {}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params"/>) {}

<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Animal</span>();

<span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Person</span>); <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(p <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Animal</span>); <span class="hljs-comment">// true</span>
</code></pre>
<p>从结果可以看出，<code>p</code> 不仅是 <code>Person</code> 的实例，也是 <code>Animal</code> 的实例。这说明 <strong><code>instanceof</code> 并不是判断“直接创建关系”，而是判断“原型链上是否存在指定构造函数的原型”</strong> 。</p>
<p>换句话说：</p>
<blockquote>
<p><strong><code>A instanceof B</code> 的含义是：A 的原型链上是否存在 <code>B.prototype</code></strong></p>
</blockquote>
<p>因此，更准确的说法是：<br/>
<strong><code>instanceof</code> 是一个“原型关系判断运算符”</strong> ，而非简单的“实例判断”。</p>
<hr/>
<h2 data-id="heading-1">二、手写 <code>instanceof</code>：理解原型链查找过程</h2>
<p>我们可以手动实现 <code>instanceof</code> 的逻辑：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">myInstanceOf</span>(<span class="hljs-params">left, right</span>) {
  <span class="hljs-keyword">let</span> proto = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(left); <span class="hljs-comment">// 等价于 left.__proto__</span>

  <span class="hljs-keyword">while</span> (proto !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">if</span> (proto === right.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    proto = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(proto);
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<p>这个函数的核心思路就是：<strong>沿着 <code>left</code> 的原型链一路向上查找，看是否能找到 <code>right.prototype</code></strong>。</p>
<p>举个例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params"/>) {}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Dog</span>(<span class="hljs-params"/>) {}
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Animal</span>();

<span class="hljs-keyword">const</span> dog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">myInstanceOf</span>(dog, <span class="hljs-title class_">Dog</span>));     <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">myInstanceOf</span>(dog, <span class="hljs-title class_">Animal</span>));  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">myInstanceOf</span>(dog, <span class="hljs-title class_">Object</span>));  <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">myInstanceOf</span>(dog, <span class="hljs-title class_">Array</span>));   <span class="hljs-comment">// false</span>
</code></pre>
<p>这也解释了为什么数组 <code>[] instanceof Object</code> 为 <code>true</code> —— 因为 <code>Array.prototype.__proto__ === Object.prototype</code>。</p>
<blockquote>
<p>⚠️ 注意：<code>instanceof</code> 对基本数据类型（如 <code>'hello' instanceof String</code>）返回 <code>false</code>，因为字面量不是对象实例。只有 <code>new String('hello') instanceof String</code> 才为 <code>true</code>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-2">三、JavaScript 中的继承方式</h2>
<p>JavaScript 没有传统 OOP 语言中的“类继承”语法（ES6 的 <code>class</code> 本质仍是基于原型），但我们可以通过多种方式模拟继承。下面逐一介绍。</p>
<h3 data-id="heading-3">1. 构造函数绑定（借用构造函数）</h3>
<pre><code class="hljs language-ini" lang="ini">function Animal() {
  <span class="hljs-attr">this.species</span> = <span class="hljs-string">'动物'</span><span class="hljs-comment">;</span>
}

function Cat(name, color) {
  Animal.call(this)<span class="hljs-comment">; // 借用父类构造函数</span>
  <span class="hljs-attr">this.name</span> = name<span class="hljs-comment">;</span>
  <span class="hljs-attr">this.color</span> = color<span class="hljs-comment">;</span>
}

const <span class="hljs-attr">cat</span> = new Cat(<span class="hljs-string">'小黑'</span>, <span class="hljs-string">'黑色'</span>)<span class="hljs-comment">;</span>
console.log(cat.species)<span class="hljs-comment">; // 动物</span>
</code></pre>
<p><strong>优点</strong>：可以继承父类构造函数中的属性。<br/>
<strong>缺点</strong>：无法继承父类原型上的<strong>方法</strong>；每次创建子类实例都会调用父类构造函数，造成内存浪费（如果属性定义在构造函数内）。</p>
<hr/>
<h3 data-id="heading-4">2. 原型链继承（<code>Child.prototype = new Parent()</code>）</h3>
<pre><code class="hljs language-ini" lang="ini">function Animal() {
  <span class="hljs-attr">this.species</span> = <span class="hljs-string">'动物'</span><span class="hljs-comment">;</span>
}

function Cat(name, color) {
  <span class="hljs-attr">this.name</span> = name<span class="hljs-comment">;</span>
  <span class="hljs-attr">this.color</span> = color<span class="hljs-comment">;</span>
}

<span class="hljs-attr">Cat.prototype</span> = new Animal()<span class="hljs-comment">; // 关键：子类原型 = 父类实例</span>
<span class="hljs-attr">Cat.prototype.constructor</span> = Cat<span class="hljs-comment">; // 修复 constructor 指向</span>

const <span class="hljs-attr">cat</span> = new Cat(<span class="hljs-string">'小黑'</span>, <span class="hljs-string">'黑色'</span>)<span class="hljs-comment">;</span>
console.log(cat.species)<span class="hljs-comment">; // 动物</span>
</code></pre>
<p><strong>底层发生了什么？</strong></p>
<ol>
<li><code>new Animal()</code> 创建一个新对象 <code>tempObj</code>，其 <code>__proto__</code> 指向 <code>Animal.prototype</code>，并执行 <code>Animal</code> 函数体，以及<code>this</code>绑定。</li>
<li><code>Cat.prototype</code> 被赋值为 <code>tempObj</code>，即 <code>Cat.prototype = { species: '动物', __proto__: Animal.prototype }</code>。</li>
<li>原本 <code>Cat.prototype</code> 自带的 <code>constructor: Cat</code> 被覆盖，此时<code>Cat.prototype</code>本身不再有<code>constructor</code>属性，会沿着原型链找到<code>Animal.prototype.constructor</code>即 <code>Animal</code>。所以需要手动修复：<code>Cat.prototype.constructor = Cat</code>。</li>
</ol>
<p><strong>优点</strong>：能继承父类原型上的方法。<br/>
<strong>缺点</strong>：父类构造函数会被无意义地调用一次（只为设置原型）；所有子类实例共享父类实例的引用属性（可能引发副作用）。</p>
<hr/>
<h3 data-id="heading-5">3. 直接共享原型（错误示范）</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">Cat.prototype</span> = Animal.prototype<span class="hljs-comment">;//这行代码是引用式拷贝</span>
<span class="hljs-attr">Cat.prototype.constructor</span> = Cat<span class="hljs-comment">;</span>
</code></pre>
<p>这种写法看似简洁，实则<strong>严重污染父类原型</strong>：</p>
<ul>
<li><code>Cat.prototype</code> 和 <code>Animal.prototype</code> 指向同一内存地址。</li>
<li>我们后续将<code>Cat.prototype</code>的<code>constructor</code>属性指回时，也会错误地将<code>Animal.prototype.constructor</code>指向<code>Cat</code></li>
<li>在 <code>Cat.prototype</code> 上添加方法（如 <code>sayHello</code>），也会出现在 <code>Animal.prototype</code> 上。</li>
<li>多个子类（如 <code>Dog</code>、<code>Cat</code>）若都这样继承，会共享同一个原型对象，互相干扰。</li>
</ul>
<p><strong>结论：绝对不要直接赋值 <code>Child.prototype = Parent.prototype</code>！</strong></p>
<hr/>
<h2 data-id="heading-6">四、推荐方案：利用空对象作为中介（<code>Object.create</code>）</h2>
<p>为了解决上述问题，我们可以引入一个<strong>空的中介对象</strong>，让它作为桥梁连接子类和父类的原型。</p>
<h3 data-id="heading-7">核心思想：</h3>
<blockquote>
<p>创建一个新对象，其原型指向父类的原型，但自身不包含任何属性。再把这个对象赋给子类的 <code>prototype</code>。</p>
</blockquote>
<h3 data-id="heading-8">实现方式（使用 <code>Object.create</code>）：</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">species</span> = <span class="hljs-string">'动物'</span>;
}

<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">say</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'I am an animal'</span>);
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Cat</span>(<span class="hljs-params">name, color</span>) {
  <span class="hljs-title class_">Animal</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>); <span class="hljs-comment">// 继承构造函数属性</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">color</span> = color;
}

<span class="hljs-comment">// 关键：使用 Object.create 创建中介对象</span>
<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Cat</span>; <span class="hljs-comment">// 修复 constructor</span>

<span class="hljs-comment">// 子类可安全添加自己的方法</span>
<span class="hljs-title class_">Cat</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">meow</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Meow!'</span>);
};

<span class="hljs-keyword">const</span> cat = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>(<span class="hljs-string">'小黑'</span>, <span class="hljs-string">'黑色'</span>);
cat.<span class="hljs-title function_">say</span>();  <span class="hljs-comment">// I am an animal</span>
cat.<span class="hljs-title function_">meow</span>(); <span class="hljs-comment">// Meow!</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cat <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Cat</span>);    <span class="hljs-comment">// true</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(cat <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Animal</span>); <span class="hljs-comment">// true</span>
</code></pre>
<h3 data-id="heading-9">底层原理：</h3>
<p><code>Object.create(proto)</code> 的作用是：</p>
<ul>
<li>创建一个新对象；</li>
<li>将该对象的 <code>__proto__</code> 指向 <code>proto</code>；</li>
<li>不执行任何构造函数。</li>
</ul>
<p>因此，<code>Object.create(Animal.prototype)</code> 返回的对象结构为：</p>
<pre><code class="hljs language-css" lang="css">{
  __proto__: Animal.prototype
}
</code></pre>
<p>它<strong>没有 <code>species</code> 属性</strong>（避免了无意义调用 <code>Animal</code> 构造函数），也<strong>不会污染 <code>Animal.prototype</code></strong>。</p>
<h3 data-id="heading-10">为什么这是最佳实践？</h3>
<ol>
<li>✅ 完全隔离子类与父类的原型，避免污染；</li>
<li>✅ 支持多子类继承同一个父类，互不影响；</li>
<li>✅ 可同时通过 <code>call</code> 继承构造函数属性，通过原型链继承方法；</li>
<li>✅ 符合“组合优于继承”的现代编程思想。</li>
</ol>
<hr/>
<h2 data-id="heading-11">五、总结</h2>








































<table><thead><tr><th>继承方式</th><th>是否继承构造函数属性</th><th>是否继承原型方法</th><th>是否污染父类</th><th>是否推荐</th></tr></thead><tbody><tr><td>构造函数绑定（call）</td><td>✅</td><td>❌</td><td>❌</td><td>部分场景</td></tr><tr><td>原型链继承</td><td>✅（但有副作用）</td><td>✅</td><td>❌</td><td>不推荐</td></tr><tr><td>直接共享原型</td><td>❌</td><td>✅</td><td>✅（严重）</td><td>禁止</td></tr><tr><td><strong>Object.create 中介</strong></td><td>✅（配合 call）</td><td>✅</td><td>❌</td><td><strong>✅ 推荐</strong></td></tr></tbody></table>
<p>而 <code>instanceof</code> 的本质，始终是<strong>在原型链上查找 <code>B.prototype</code> 是否出现</strong>。理解这一点，就能轻松应对各种继承场景下的类型判断。</p>
<p>在大型项目中，清晰的继承结构和正确的 <code>instanceof</code> 使用，能极大提升代码的可维护性和协作效率。希望本文能帮你夯实基础，在掘金社区写出更高质量的前端文章！</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[七、Kotlin——扩展（Extensions）]]></title>    <link>https://juejin.cn/post/7579917791764955163</link>    <guid>https://juejin.cn/post/7579917791764955163</guid>    <pubDate>2025-12-05T03:54:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579917791764955163" data-draft-id="7579872561675714569" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="七、Kotlin——扩展（Extensions）"/> <meta itemprop="keywords" content="Android,Kotlin"/> <meta itemprop="datePublished" content="2025-12-05T03:54:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Haha_bj"/> <meta itemprop="url" content="https://juejin.cn/user/2612027844214647"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            七、Kotlin——扩展（Extensions）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612027844214647/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Haha_bj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:54:51.000Z" title="Fri Dec 05 2025 03:54:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Kotlin 能够扩展一个类的新功能而无需继承该类。 例如，你可以为一个你不能修改的来自第三方库中的类编写一个新的函数。 这个新增的函数就像那个原始类本来就有的函数一样，可以用普通的方法调用。 这种机制称为 扩展函数 。此外，也有 扩展属性， 允许你为一个已经存在的类添加新的属性。</p>
<p>在Kotlin中提供了大量的扩展，使得我们的代码更加简洁，开发出来的框架更加易用</p>
<h2 data-id="heading-0">一、扩展方法的使用</h2>
<p>Kotlin的扩展函数可以让你作为一个类成员进行调用的函数。这样可以很方便的扩展一个已经存在的类，为它添加额外的方法。在Kotin源码中，有大量的扩展函数来扩展Java，这样使得Kotlin比Java更方便使用，效率更高。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7fe90cf263648fb9699f5df8d3c278c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFoYV9iag==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765511691&amp;x-signature=BxglX2uthmeOn4HPZQzLUgdkwNM%3D" alt="图片.png" loading="lazy"/></p>
<ul>
<li>在Kotlin中使用</li>
</ul>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Jump</span>{
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">test</span><span class="hljs-params">()</span></span>{
        println(<span class="hljs-string">"jump test"</span>)
        <span class="hljs-comment">// 在被扩展的类中使用</span>
        doubleJump(<span class="hljs-number">1f</span>)
    }
}
<span class="hljs-comment">// 扩展方法的定义，就是在方法的前面加上类前缀</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> Jump.<span class="hljs-title">doubleJump</span><span class="hljs-params">(value: <span class="hljs-type">Float</span>)</span></span> : <span class="hljs-built_in">Boolean</span>{
    println(<span class="hljs-string">"value = <span class="hljs-variable">$value</span>"</span>)
    <span class="hljs-keyword">return</span>  <span class="hljs-literal">true</span>
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 使用对象调用</span>
    <span class="hljs-keyword">val</span>  ju = Jump()
    <span class="hljs-comment">/// 外部调用 扩展</span>
    ju.doubleJump(<span class="hljs-number">2f</span>)
}
</code></pre>
<ul>
<li>在Java中使用</li>
</ul>

<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JavaLession</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-comment">///  在Java中调用 Kotlin 的扩展</span>
        <span class="hljs-title class_">Lesson04Kt</span>.<span class="hljs-title function_">doubleJump</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Jump</span>(),1f)
    }
}
</code></pre>
<h2 data-id="heading-1">二、泛型扩展方法</h2>
<p>为了考虑到扩展函数的通用性，我们可以借助上面课程中学习到的泛型，来为扩展方法进行泛型化改造以 fun MutableList Int.swap(index1:Int，index2:Int)为例，接下来我们为它进行泛型化改造</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> MutableList<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">jl_swap</span><span class="hljs-params">(index1: <span class="hljs-type">Int</span>, index2: <span class="hljs-type">Int</span>)</span></span>{
    <span class="hljs-keyword">var</span>  tmp = <span class="hljs-keyword">this</span>[index1]
    <span class="hljs-keyword">this</span>[index1] = <span class="hljs-keyword">this</span>[index2]
    <span class="hljs-keyword">this</span>[index2] = tmp
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> test2 = mutableListOf(<span class="hljs-string">"Android o"</span>,<span class="hljs-string">"Android N"</span>, <span class="hljs-string">"Android M"</span>)
    test2.jl_swap(<span class="hljs-number">3</span>,<span class="hljs-number">5</span>)
}
</code></pre>
<h2 data-id="heading-2">三、为伴生对象添加扩展</h2>
<p>如果一个类定义了伴生对象，那么我们也可以为伴生对象定义扩展函数与属性:</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span>  <span class="hljs-title class_">Jump</span>{
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span>{
    }
}
<span class="hljs-function"><span class="hljs-keyword">fun</span> Jump.Companion.<span class="hljs-title">run</span><span class="hljs-params">(str: <span class="hljs-type">String</span>)</span></span>{
    println(str)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    Jump.run(<span class="hljs-string">"aa"</span>)
}
</code></pre>
<h2 data-id="heading-3">四、Kotlin中常用的扩展</h2>
<p>在Kotlin的源码中定义了大量的扩展，比如: let，run ,apply ，了解并运用这些函数能帮我们提高编码效率。</p>
<p><code>- let扩展</code>let扩展函数的实际上是一个作用域函数，当你需要去定义一个变量在一个特定的作用域范围内，那么let函数是一个不错的选择;let函数另一个作用就是可以避免写一些判断null的操作。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// let扩展函数，类后面加上?代表参数可能为空，使用的时候注意判空</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">testLet</span><span class="hljs-params">(str: <span class="hljs-type">String</span>?)</span></span>{
    str.let {
        <span class="hljs-keyword">var</span> str2 = <span class="hljs-string">"let 扩展"</span>
        println(it + str2)
    }
    <span class="hljs-comment">// str2 外部无法访问</span>

    <span class="hljs-comment">// 判空用法，当str为空，则不会触发闭包里面的逻辑</span>
    str?.let {
        println(it.length)
    }

}
</code></pre>
<p><code>- run扩展</code>
run函数只接收子个lambda函数为参数，以闭包形式返回，返回值为最后一行的值或者指定的return的表达式，在run函数中可以直接访问实例的公有属性和方法。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 返回值为最后一行的值或者指定的return的表达式，在run函数中可以直接访问实例的公有属性和方法。</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span>  <span class="hljs-title">testRun</span><span class="hljs-params">(jump: <span class="hljs-type">Jump</span>)</span></span>: String{
    jump.run {
        test()
        println(<span class="hljs-string">"ddd"</span>)
        <span class="hljs-keyword">return</span>  <span class="hljs-string">"222"</span>
    }
}
</code></pre>
<p><code>- apply扩展</code>apply函数的作用是:调用某对象的apply函数，在函数范围内，可以任意调用该对象的任意方法，并返回该对象。
从结构上来看apply函数和run函数很像，唯一不同点就是它们各自返回的值不一样，run函数是以闭包形式返回最后一行代码的值，而apply函数的返回的是传入对象的本身。</p>
<p>apply一般用于一个对象实例初始化的时候，需要对对象中的属性进行赋值。或者动态inflate出一个XML的View的时候需要给View绑定数据也会用到，这种情景非常常见。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// apply函数的作用是:调用某对象的apply函数，在函数范围内，可以任意调用该对象的任意方法，并返回该对象。</span>
    <span class="hljs-comment">// 从结构上来看apply函数和run函数很像，唯一不同点就是它们各自返回的值不一样，run函数是以闭包形式返回最后一行代码的值,</span>
    ArrayList&lt;String&gt;().apply {
        add(<span class="hljs-string">"dd"</span>)
        add(<span class="hljs-string">"333"</span>)
    }.run {
        <span class="hljs-keyword">for</span> (s <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>){
            println(s)
        }
    }

}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[IOS UIKit 相关知识]]></title>    <link>https://juejin.cn/post/7579921879973150766</link>    <guid>https://juejin.cn/post/7579921879973150766</guid>    <pubDate>2025-12-05T03:58:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579921879973150766" data-draft-id="7579904059525955610" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="IOS UIKit 相关知识"/> <meta itemprop="keywords" content="iOS"/> <meta itemprop="datePublished" content="2025-12-05T03:58:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="如此风景"/> <meta itemprop="url" content="https://juejin.cn/user/342703355996926"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            IOS UIKit 相关知识
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/342703355996926/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    如此风景
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:58:17.000Z" title="Fri Dec 05 2025 03:58:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">iOS UIKit 全体系知识手册（Objective-C 版）</h2>
<p>UIKit 是 iOS/iPadOS 开发的<strong>核心 UI 框架</strong>，基于 Objective-C 构建，封装了所有可视化界面、交互、布局、渲染相关的能力，是构建 iOS 应用的基础。以下从「基础架构→核心组件→布局→事件→渲染→适配→优化→调试」全维度拆解 UIKit 知识体系，覆盖开发全场景。</p>
<h3 data-id="heading-1">一、UIKit 基础核心（框架基石）</h3>
<h4 data-id="heading-2">1. UIKit 定位与依赖</h4>
<ul>
<li>
<p><strong>核心作用</strong>：提供 iOS 应用的可视化界面、用户交互、布局管理、事件处理等能力，是上层业务与底层系统（Core Graphics/Core Animation/Foundation）的桥梁。</p>
</li>
<li>
<p><strong>依赖关系</strong>：</p>
</li>
</ul>
<p>  - 基于 <code>Foundation</code>（数据处理：NSString/NSDictionary 等）；</p>
<p>  - 依赖 <code>Core Graphics</code>（绘图）、<code>Core Animation</code>（动画/渲染）、<code>Core Text</code>（文本排版）；</p>
<p>  - 兼容 <code>AppKit</code>（macOS）部分逻辑，但针对移动设备做了轻量化适配。</p>
<ul>
<li>
<p><strong>核心设计思想</strong>：基于「响应者链」+「MVC 架构」，视图（UIView）负责展示，控制器（UIViewController）负责逻辑，模型（Model）负责数据。</p>
</li>
</ul>
<h4 data-id="heading-3">2. 应用入口与生命周期</h4>
<h5 data-id="heading-4">（1）应用级入口（UIApplication）</h5>
<p><code>UIApplication</code> 是应用的「单例管家」，管理应用生命周期、事件分发、状态栏、URL 跳转等：</p>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-comment">// 获取应用单例</span>

<span class="hljs-built_in">UIApplication</span> *app = [<span class="hljs-built_in">UIApplication</span> sharedApplication];

<span class="hljs-comment">// 设置状态栏样式（iOS 13+ 需在 Info.plist 配置 View controller-based status bar appearance = NO）</span>

app.statusBarStyle = <span class="hljs-built_in">UIStatusBarStyleLightContent</span>;

<span class="hljs-comment">// 打开URL</span>

[app openURL:[<span class="hljs-built_in">NSURL</span> URLWithString:<span class="hljs-string">@"https://www.apple.com"</span>] options:@{} completionHandler:<span class="hljs-literal">nil</span>];

</code></pre>
<h5 data-id="heading-5">（2）应用代理（UIApplicationDelegate / SceneDelegate）</h5>
<ul>
<li>
<p><strong>iOS 12 及以下</strong>：通过 <code>UIApplicationDelegate</code> 管理应用生命周期（全局唯一）；</p>
</li>
<li>
<p><strong>iOS 13+</strong>：引入 <code>UISceneDelegate</code> 管理「场景（Scene）」生命周期（支持多窗口），<code>UIApplicationDelegate</code> 仅负责应用级初始化。</p>
</li>
</ul>

































<table><thead><tr><th>核心生命周期方法（UIApplicationDelegate）</th><th>说明</th></tr></thead><tbody><tr><td><code>application:didFinishLaunchingWithOptions:</code></td><td>应用启动完成（初始化根控制器）</td></tr><tr><td><code>applicationDidBecomeActive:</code>             </td><td>应用进入前台（可交互）</td></tr><tr><td><code>applicationWillResignActive:</code>             </td><td>应用退至后台（如来电、下拉通知）</td></tr><tr><td><code>applicationDidEnterBackground:</code>           </td><td>应用完全后台（需保存数据）</td></tr><tr><td><code>applicationWillEnterForeground:</code>          </td><td>应用即将前台（恢复界面）</td></tr><tr><td><code>applicationWillTerminate:</code>                </td><td>应用即将退出（最后清理）</td></tr></tbody></table>
<h5 data-id="heading-6">（3）UIViewController 生命周期（核心）</h5>
<p>控制器是「视图的管理者」，其生命周期决定了视图的创建/销毁，OC 核心方法如下：</p>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ViewController</span> ()</span>
<span class="hljs-keyword">@end</span>

<span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ViewController</span></span>

<span class="hljs-comment">// 1. 初始化（代码创建时调用）</span>

- (<span class="hljs-keyword">instancetype</span>)initWithNibName:(<span class="hljs-built_in">NSString</span> *)nibNameOrNil bundle:(<span class="hljs-built_in">NSBundle</span> *)nibBundleOrNil {

    <span class="hljs-keyword">self</span> = [<span class="hljs-variable language_">super</span> initWithNibName:nibNameOrNil bundle:nibBundleOrNil];

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>) {

        <span class="hljs-comment">// 初始化数据、配置</span>

    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;

}

<span class="hljs-comment">// 2. 加载视图（视图首次创建，懒加载）</span>

- (<span class="hljs-type">void</span>)loadView {

    <span class="hljs-comment">// 手动创建根视图（若不用XIB/Storyboard）</span>

    <span class="hljs-keyword">self</span>.view = [[<span class="hljs-built_in">UIView</span> alloc] initWithFrame:[<span class="hljs-built_in">UIScreen</span> mainScreen].bounds];

    <span class="hljs-keyword">self</span>.view.backgroundColor = [<span class="hljs-built_in">UIColor</span> whiteColor];

}

<span class="hljs-comment">// 3. 视图加载完成（初始化控件、布局）</span>

- (<span class="hljs-type">void</span>)viewDidLoad {

    [<span class="hljs-variable language_">super</span> viewDidLoad];

    <span class="hljs-comment">// 核心初始化逻辑（仅执行一次）</span>

}

<span class="hljs-comment">// 4. 视图即将显示（每次显示前调用，如跳转返回）</span>

- (<span class="hljs-type">void</span>)viewWillAppear:(<span class="hljs-type">BOOL</span>)animated {

    [<span class="hljs-variable language_">super</span> viewWillAppear:animated];

    <span class="hljs-comment">// 更新界面数据、刷新布局</span>

}

<span class="hljs-comment">// 5. 视图已显示（可执行动画、网络请求）</span>

- (<span class="hljs-type">void</span>)viewDidAppear:(<span class="hljs-type">BOOL</span>)animated {

    [<span class="hljs-variable language_">super</span> viewDidAppear:animated];

}
<span class="hljs-comment">// 6. 视图即将隐藏</span>

- (<span class="hljs-type">void</span>)viewWillDisappear:(<span class="hljs-type">BOOL</span>)animated {

    [<span class="hljs-variable language_">super</span> viewWillDisappear:animated];

    <span class="hljs-comment">// 暂停动画、移除监听</span>

}

<span class="hljs-comment">// 7. 视图已隐藏</span>

- (<span class="hljs-type">void</span>)viewDidDisappear:(<span class="hljs-type">BOOL</span>)animated {

    [<span class="hljs-variable language_">super</span> viewDidDisappear:animated];

}

<span class="hljs-comment">// 8. 内存警告（释放非必要资源）</span>

- (<span class="hljs-type">void</span>)didReceiveMemoryWarning {

    [<span class="hljs-variable language_">super</span> didReceiveMemoryWarning];

}

<span class="hljs-comment">// 9. 视图销毁（控制器释放前）</span>

- (<span class="hljs-type">void</span>)dealloc {

    <span class="hljs-comment">// 移除通知、释放强引用（避免内存泄漏）</span>

    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"控制器销毁"</span>);

}

<span class="hljs-keyword">@end</span>

</code></pre>
<h4 data-id="heading-7">3. 响应者体系（UIResponder）</h4>
<p>UIKit 所有可交互元素都继承自 <code>UIResponder</code>（响应者），构成「响应者链」处理事件（触摸、手势、键盘等）：</p>
<ul>
<li>
<p><strong>核心响应者</strong>：<code>UIApplication</code> → <code>UIWindow</code> → <code>UIViewController</code> → <code>UIView</code> → 子视图；</p>
</li>
<li>
<p><strong>核心方法</strong></p>
</li>
</ul>
<pre><code class="hljs language-objc" lang="objc">  <span class="hljs-comment">// 触摸事件</span>
  - (<span class="hljs-type">void</span>)touchesBegan:(<span class="hljs-built_in">NSSet</span>&lt;<span class="hljs-built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="hljs-built_in">UIEvent</span> *)event;
  - (<span class="hljs-type">void</span>)touchesMoved:(<span class="hljs-built_in">NSSet</span>&lt;<span class="hljs-built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="hljs-built_in">UIEvent</span> *)event;
  - (<span class="hljs-type">void</span>)touchesEnded:(<span class="hljs-built_in">NSSet</span>&lt;<span class="hljs-built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="hljs-built_in">UIEvent</span> *)event;
  - (<span class="hljs-type">void</span>)touchesCancelled:(<span class="hljs-built_in">NSSet</span>&lt;<span class="hljs-built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="hljs-built_in">UIEvent</span> *)event;
  <span class="hljs-comment">// 成为第一响应者（如输入框唤起键盘）</span>
  - (<span class="hljs-type">BOOL</span>)becomeFirstResponder;
  <span class="hljs-comment">// 放弃第一响应者（如输入框收起键盘）</span>
  - (<span class="hljs-type">BOOL</span>)resignFirstResponder;
</code></pre>
<ul>
<li><strong>事件传递规则</strong>：</li>
</ul>
<p>  1. 系统通过 <code>hitTest:withEvent:</code> 从父视图到子视图查找「最顶层可交互视图」；</p>
<p>  2. 找到后调用该视图的事件方法（如 <code>touchesBegan:</code>）；</p>
<p>  3. 若该视图不处理，事件沿响应者链向上传递（子视图→父视图→控制器→Window→Application）。</p>
<h4 data-id="heading-8">4. UIView 核心（视图基础）</h4>
<p><code>UIView</code> 是所有可视化元素的基类，负责展示、布局、事件接收，核心属性/方法：</p>













































<table><thead><tr><th>核心属性         </th><th>说明                                                        </th></tr></thead><tbody><tr><td><code>frame</code>          </td><td>相对于父视图的位置+尺寸（CGRect），决定视图在父视图中的显示区域      </td></tr><tr><td><code>bounds</code>         </td><td>自身坐标系的位置+尺寸（origin 默认 (0,0)，修改会偏移子视图）</td></tr><tr><td><code>center</code>         </td><td>相对于父视图的中心点坐标（CGPoint）</td></tr><tr><td><code>transform</code>      </td><td>形变（缩放、旋转、平移，基于 center）</td></tr><tr><td><code>backgroundColor</code></td><td>背景色（UIColor）</td></tr><tr><td><code>alpha</code>          </td><td>透明度（0~1，0 完全透明，1 不透明）</td></tr><tr><td><code>hidden</code>         </td><td>是否隐藏（YES 隐藏，不参与布局/事件）</td></tr><tr><td><code>clipsToBounds</code>  </td><td>是否裁剪超出自身边界的子视图（YES 裁剪）</td></tr><tr><td><code>layer</code>          </td><td>底层 CALayer（负责渲染，UIView 是 CALayer 的封装）</td></tr></tbody></table>
<h3 data-id="heading-9">二、UIKit 核心组件（常用控件）</h3>
<h4 data-id="heading-10">1. 基础交互控件</h4>


















































<table><thead><tr><th>控件类             </th><th>用途                    </th><th>核心 OC 示例</th></tr></thead><tbody><tr><td><code>UILabel</code>          </td><td>文本展示                </td><td><code>UILabel *label = [[UILabel alloc] init]; label.text = @"Hello UIKit"; label.font = [UIFont systemFontOfSize:16];</code></td></tr><tr><td><code>UIButton</code>         </td><td>按钮（点击交互）</td><td><code>UIButton *btn = [UIButton buttonWithType:UIButtonTypeSystem]; [btn setTitle:@"点击" forState:UIControlStateNormal]; [btn addTarget:self action:@selector(btnClick:) forControlEvents:UIControlEventTouchUpInside];</code></td></tr><tr><td><code>UITextField</code>      </td><td>单行文本输入            </td><td><code>UITextField *tf = [[UITextField alloc] init]; tf.placeholder = @"请输入内容"; tf.keyboardType = UIKeyboardTypeDefault;</code></td></tr><tr><td><code>UITextView</code>       </td><td>多行文本输入/展示       </td><td><code>UITextView *tv = [[UITextView alloc] init]; tv.text = @"多行文本"; tv.editable = YES;</code></td></tr><tr><td><code>UIImageView</code>      </td><td>图片展示                </td><td><code>UIImageView *iv = [[UIImageView alloc] initWithImage:[UIImage imageNamed:@"icon"]]; iv.contentMode = UIViewContentModeScaleAspectFit;</code></td></tr><tr><td><code>UISwitch</code>         </td><td>开关（开/关）</td><td><code>UISwitch *sw = [[UISwitch alloc] init]; sw.on = YES; [sw addTarget:self action:@selector(switchChange:) forControlEvents:UIControlEventValueChanged];</code></td></tr><tr><td><code>UISlider</code>         </td><td>滑块（数值调节）</td><td><code>UISlider *slider = [[UISlider alloc] init]; slider.minimumValue = 0; slider.maximumValue = 100; slider.value = 50;</code></td></tr><tr><td><code>UISegmentedControl</code></td><td>分段选择器              </td><td><code>UISegmentedControl *seg = [[UISegmentedControl alloc] initWithItems:@[@"选项1", @"选项2"]]; seg.selectedSegmentIndex = 0;</code></td></tr></tbody></table>
<h4 data-id="heading-11">2. 列表/集合控件（高频）</h4>
<h5 data-id="heading-12">（1）UITableView（列表）</h5>
<p>核心是「数据源+代理」模式，支持单行列表展示，OC 核心实现：</p>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">TableViewController</span> () &lt;<span class="hljs-title">UITableViewDataSource</span>, <span class="hljs-title">UITableViewDelegate</span>&gt;</span>

<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">UITableView</span> *tableView;

<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">NSArray</span> *dataArray;

<span class="hljs-keyword">@end</span>

<span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">TableViewController</span></span>

- (<span class="hljs-type">void</span>)viewDidLoad {

    [<span class="hljs-variable language_">super</span> viewDidLoad];

    <span class="hljs-keyword">self</span>.dataArray = @[<span class="hljs-string">@"行1"</span>, <span class="hljs-string">@"行2"</span>, <span class="hljs-string">@"行3"</span>];

    <span class="hljs-keyword">self</span>.tableView = [[<span class="hljs-built_in">UITableView</span> alloc] initWithFrame:<span class="hljs-keyword">self</span>.view.bounds style:<span class="hljs-built_in">UITableViewStylePlain</span>];

    <span class="hljs-keyword">self</span>.tableView.dataSource = <span class="hljs-keyword">self</span>;

    <span class="hljs-keyword">self</span>.tableView.delegate = <span class="hljs-keyword">self</span>;

    <span class="hljs-comment">// 注册单元格（复用）</span>

    [<span class="hljs-keyword">self</span>.tableView registerClass:[<span class="hljs-built_in">UITableViewCell</span> <span class="hljs-keyword">class</span>] forCellReuseIdentifier:<span class="hljs-string">@"cellID"</span>];

    [<span class="hljs-keyword">self</span>.view addSubview:<span class="hljs-keyword">self</span>.tableView];

}

<span class="hljs-comment">// 数据源：行数</span>

- (<span class="hljs-built_in">NSInteger</span>)tableView:(<span class="hljs-built_in">UITableView</span> *)tableView numberOfRowsInSection:(<span class="hljs-built_in">NSInteger</span>)section {

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>.dataArray.count;

}

<span class="hljs-comment">// 数据源：单元格内容</span>

- (<span class="hljs-built_in">UITableViewCell</span> *)tableView:(<span class="hljs-built_in">UITableView</span> *)tableView cellForRowAtIndexPath:(<span class="hljs-built_in">NSIndexPath</span> *)indexPath {

    <span class="hljs-built_in">UITableViewCell</span> *cell = [tableView dequeueReusableCellWithIdentifier:<span class="hljs-string">@"cellID"</span> forIndexPath:indexPath];

    cell.textLabel.text = <span class="hljs-keyword">self</span>.dataArray[indexPath.row];

    <span class="hljs-keyword">return</span> cell;

}

<span class="hljs-comment">// 代理：单元格点击</span>

- (<span class="hljs-type">void</span>)tableView:(<span class="hljs-built_in">UITableView</span> *)tableView didSelectRowAtIndexPath:(<span class="hljs-built_in">NSIndexPath</span> *)indexPath {

    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"点击第%ld行"</span>, indexPath.row);

    [tableView deselectRowAtIndexPath:indexPath animated:<span class="hljs-literal">YES</span>];

}

<span class="hljs-keyword">@end</span>

</code></pre>
<h5 data-id="heading-13">（2）UICollectionView（集合视图）</h5>
<p>支持网格、瀑布流等自定义布局，OC 核心实现：</p>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">CollectionViewController</span> () &lt;<span class="hljs-title">UICollectionViewDataSource</span>, <span class="hljs-title">UICollectionViewDelegateFlowLayout</span>&gt;</span>

<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">strong</span>) <span class="hljs-built_in">UICollectionView</span> *collectionView;

<span class="hljs-keyword">@end</span>

<span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">CollectionViewController</span></span>

- (<span class="hljs-type">void</span>)viewDidLoad {

    [<span class="hljs-variable language_">super</span> viewDidLoad];

    <span class="hljs-comment">// 布局配置（流式布局）</span>

    <span class="hljs-built_in">UICollectionViewFlowLayout</span> *layout = [[<span class="hljs-built_in">UICollectionViewFlowLayout</span> alloc] init];

    layout.itemSize = <span class="hljs-built_in">CGSizeMake</span>(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>); <span class="hljs-comment">// 单元格尺寸</span>

    layout.minimumInteritemSpacing = <span class="hljs-number">10</span>; <span class="hljs-comment">// 列间距</span>

    layout.minimumLineSpacing = <span class="hljs-number">10</span>; <span class="hljs-comment">// 行间距</span>

    <span class="hljs-keyword">self</span>.collectionView = [[<span class="hljs-built_in">UICollectionView</span> alloc] initWithFrame:<span class="hljs-keyword">self</span>.view.bounds collectionViewLayout:layout];

    <span class="hljs-keyword">self</span>.collectionView.dataSource = <span class="hljs-keyword">self</span>;

    <span class="hljs-keyword">self</span>.collectionView.delegate = <span class="hljs-keyword">self</span>;

    [<span class="hljs-keyword">self</span>.collectionView registerClass:[<span class="hljs-built_in">UICollectionViewCell</span> <span class="hljs-keyword">class</span>] forCellWithReuseIdentifier:<span class="hljs-string">@"cellID"</span>];

    [<span class="hljs-keyword">self</span>.view addSubview:<span class="hljs-keyword">self</span>.collectionView];

}

<span class="hljs-comment">// 数据源：单元格数量</span>

- (<span class="hljs-built_in">NSInteger</span>)collectionView:(<span class="hljs-built_in">UICollectionView</span> *)collectionView numberOfItemsInSection:(<span class="hljs-built_in">NSInteger</span>)section {
    <span class="hljs-keyword">return</span> <span class="hljs-number">12</span>;
}

<span class="hljs-comment">// 数据源：单元格内容</span>

- (<span class="hljs-built_in">UICollectionViewCell</span> *)collectionView:(<span class="hljs-built_in">UICollectionView</span> *)collectionView cellForItemAtIndexPath:(<span class="hljs-built_in">NSIndexPath</span> *)indexPath {

    <span class="hljs-built_in">UICollectionViewCell</span> *cell = [collectionView dequeueReusableCellWithReuseIdentifier:<span class="hljs-string">@"cellID"</span> forIndexPath:indexPath];

    cell.backgroundColor = [<span class="hljs-built_in">UIColor</span> lightGrayColor];

    <span class="hljs-keyword">return</span> cell;

}

<span class="hljs-keyword">@end</span>

</code></pre>
<h4 data-id="heading-14">3. 容器控件（页面导航/布局）</h4>






























<table><thead><tr><th>控件类                 </th><th>用途                    </th><th>核心 OC 示例                                                                </th></tr></thead><tbody><tr><td><code>UIScrollView</code>         </td><td>可滚动视图（基础）</td><td><code>UIScrollView *scrollView = [[UIScrollView alloc] initWithFrame:self.view.bounds]; scrollView.contentSize = CGSizeMake(375, 1000); scrollView.showsVerticalScrollIndicator = YES;</code></td></tr><tr><td><code>UINavigationController</code></td><td>导航控制器（页面栈）</td><td><code>UINavigationController *nav = [[UINavigationController alloc] initWithRootViewController:[[ViewController alloc] init]]; nav.navigationBar.barTintColor = [UIColor blueColor];</code></td></tr><tr><td><code>UITabBarController</code>   </td><td>标签栏控制器（底部切换）</td><td><code>UITabBarController *tabBarVC = [[UITabBarController alloc] init]; tabBarVC.viewControllers = @[nav1, nav2]; tabBarVC.tabBar.tintColor = [UIColor redColor];</code></td></tr><tr><td><code>UIPageViewController</code> </td><td>分页控制器（左右滑切换）</td><td><code>UIPageViewController *pageVC = [[UIPageViewController alloc] initWithTransitionStyle:UIPageViewControllerTransitionStyleScroll navigationOrientation:UIPageViewControllerNavigationOrientationHorizontal options:nil];</code></td></tr></tbody></table>
<h4 data-id="heading-15">4. 弹窗/提示控件</h4>

























<table><thead><tr><th>控件类               </th><th>用途                    </th><th>核心 OC 示例                                                                </th></tr></thead><tbody><tr><td><code>UIAlertController</code>  </td><td>弹窗（警告/操作）</td><td><code>UIAlertController *alert = [UIAlertController alertControllerWithTitle:@"提示" message:@"确定删除？" preferredStyle:UIAlertControllerStyleAlert]; [alert addAction:[UIAlertAction actionWithTitle:@"确定" style:UIAlertActionStyleDestructive handler:^(UIAlertAction * _Nonnull action) {}]]; [self presentViewController:alert animated:YES completion:nil];</code></td></tr><tr><td><code>UIActivityIndicatorView</code></td><td>加载指示器        </td><td><code>UIActivityIndicatorView *indicator = [[UIActivityIndicatorView alloc] initWithStyle:UIActivityIndicatorViewStyleLarge]; [indicator startAnimating];</code></td></tr><tr><td><code>UIRefreshControl</code>   </td><td>下拉刷新                </td><td><code>UIRefreshControl *refresh = [[UIRefreshControl alloc] init]; [refresh addTarget:self action:@selector(refreshData:) forControlEvents:UIControlEventValueChanged]; self.tableView.refreshControl = refresh;</code></td></tr></tbody></table>
<h3 data-id="heading-16">三、布局体系（UIKit 核心能力）</h3>
<h4 data-id="heading-17">1. 基础布局（Frame/Bounds/Center）</h4>
<p>手动控制视图位置，适合简单布局：</p>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-built_in">UIView</span> *boxView = [[<span class="hljs-built_in">UIView</span> alloc] init];

boxView.frame = <span class="hljs-built_in">CGRectMake</span>(<span class="hljs-number">20</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>); <span class="hljs-comment">// x:20, y:100, 宽100, 高100</span>

boxView.center = <span class="hljs-built_in">CGPointMake</span>(<span class="hljs-number">187.5</span>, <span class="hljs-number">150</span>); <span class="hljs-comment">// 中心点（父视图宽375，水平居中）</span>

boxView.bounds = <span class="hljs-built_in">CGRectMake</span>(<span class="hljs-number">-10</span>, <span class="hljs-number">-10</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>); <span class="hljs-comment">// 自身坐标系偏移，子视图会右移/下移10pt</span>

[<span class="hljs-keyword">self</span>.view addSubview:boxView];

</code></pre>
<h4 data-id="heading-18">2. 自动布局（Auto Layout）</h4>
<p>通过「约束」定义视图关系，适配多屏幕，OC 原生实现：</p>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-built_in">UIButton</span> *btn = [<span class="hljs-built_in">UIButton</span> buttonWithType:<span class="hljs-built_in">UIButtonTypeSystem</span>];

btn.translatesAutoresizingMaskIntoConstraints = <span class="hljs-literal">NO</span>; <span class="hljs-comment">// 必须关闭自动掩码</span>

[<span class="hljs-keyword">self</span>.view addSubview:btn];

<span class="hljs-comment">// 创建约束：按钮左/右间距20pt，顶部100pt，高度44pt</span>

<span class="hljs-built_in">NSLayoutConstraint</span> *leading = [<span class="hljs-built_in">NSLayoutConstraint</span> constraintWithItem:btn attribute:<span class="hljs-built_in">NSLayoutAttributeLeading</span> relatedBy:<span class="hljs-built_in">NSLayoutRelationEqual</span> toItem:<span class="hljs-keyword">self</span>.view attribute:<span class="hljs-built_in">NSLayoutAttributeLeading</span> multiplier:<span class="hljs-number">1.0</span> constant:<span class="hljs-number">20</span>];

<span class="hljs-built_in">NSLayoutConstraint</span> *trailing = [<span class="hljs-built_in">NSLayoutConstraint</span> constraintWithItem:btn attribute:<span class="hljs-built_in">NSLayoutAttributeTrailing</span> relatedBy:<span class="hljs-built_in">NSLayoutRelationEqual</span> toItem:<span class="hljs-keyword">self</span>.view attribute:<span class="hljs-built_in">NSLayoutAttributeTrailing</span> multiplier:<span class="hljs-number">1.0</span> constant:<span class="hljs-number">-20</span>];

<span class="hljs-built_in">NSLayoutConstraint</span> *top = [<span class="hljs-built_in">NSLayoutConstraint</span> constraintWithItem:btn attribute:<span class="hljs-built_in">NSLayoutAttributeTop</span> relatedBy:<span class="hljs-built_in">NSLayoutRelationEqual</span> toItem:<span class="hljs-keyword">self</span>.view attribute:<span class="hljs-built_in">NSLayoutAttributeTop</span> multiplier:<span class="hljs-number">1.0</span> constant:<span class="hljs-number">100</span>];

<span class="hljs-built_in">NSLayoutConstraint</span> *height = [<span class="hljs-built_in">NSLayoutConstraint</span> constraintWithItem:btn attribute:<span class="hljs-built_in">NSLayoutAttributeHeight</span> relatedBy:<span class="hljs-built_in">NSLayoutRelationEqual</span> toItem:<span class="hljs-literal">nil</span> attribute:<span class="hljs-built_in">NSLayoutAttributeNotAnAttribute</span> multiplier:<span class="hljs-number">1.0</span> constant:<span class="hljs-number">44</span>];

<span class="hljs-comment">// 添加约束</span>

[<span class="hljs-keyword">self</span>.view addConstraints:@[leading, trailing, top]];

[btn addConstraint:height];

</code></pre>
<h5 data-id="heading-19">Masonry 封装（OC 主流）</h5>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-meta">#import <span class="hljs-string">"Masonry.h"</span></span>

[btn mas_makeConstraints:^(MASConstraintMaker *make) {

    make.leading.equalTo(<span class="hljs-keyword">self</span>.view).offset(<span class="hljs-number">20</span>);

    make.trailing.equalTo(<span class="hljs-keyword">self</span>.view).offset(<span class="hljs-number">-20</span>);

    make.top.equalTo(<span class="hljs-keyword">self</span>.view).offset(<span class="hljs-number">100</span>);

    make.height.mas_equalTo(<span class="hljs-number">44</span>);

}];

</code></pre>
<h4 data-id="heading-20">3. 尺寸适配（Size Classes + Trait Collection）</h4>
<p>适配多设备/横竖屏，OC 实现：</p>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-comment">// 监听尺寸类变化</span>

- (<span class="hljs-type">void</span>)traitCollectionDidChange:(<span class="hljs-built_in">UITraitCollection</span> *)previousTraitCollection {

    [<span class="hljs-variable language_">super</span> traitCollectionDidChange:previousTraitCollection];

    <span class="hljs-comment">// 宽屏（如iPad/手机横屏）</span>

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.traitCollection.horizontalSizeClass == <span class="hljs-built_in">UIUserInterfaceSizeClassRegular</span>) {

        [<span class="hljs-keyword">self</span>.btn mas_updateConstraints:^(MASConstraintMaker *make) {

            make.height.mas_equalTo(<span class="hljs-number">60</span>);

        }];

    } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// 窄屏（手机竖屏）</span>

        [<span class="hljs-keyword">self</span>.btn mas_updateConstraints:^(MASConstraintMaker *make) {

            make.height.mas_equalTo(<span class="hljs-number">44</span>);

        }];

    }

    [<span class="hljs-keyword">self</span>.view layoutIfNeeded];

}

</code></pre>
<h4 data-id="heading-21">4. 安全区域（Safe Area）</h4>
<p>适配刘海屏/底部横条，OC 实现：</p>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-comment">// 约束适配安全区域</span>

[btn mas_makeConstraints:^(MASConstraintMaker *make) {

    make.leading.equalTo(<span class="hljs-keyword">self</span>.view.safeAreaLayoutGuide).offset(<span class="hljs-number">20</span>);

    make.trailing.equalTo(<span class="hljs-keyword">self</span>.view.safeAreaLayoutGuide).offset(<span class="hljs-number">-20</span>);

    make.top.equalTo(<span class="hljs-keyword">self</span>.view.safeAreaLayoutGuide).offset(<span class="hljs-number">20</span>);

}];

</code></pre>
<h3 data-id="heading-22">四、事件处理（交互核心）</h3>
<h4 data-id="heading-23">1. 触摸事件（UITouch）</h4>
<p>自定义视图触摸处理：</p>
<pre><code class="hljs language-objc" lang="objc">
- (<span class="hljs-type">void</span>)touchesBegan:(<span class="hljs-built_in">NSSet</span>&lt;<span class="hljs-built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="hljs-built_in">UIEvent</span> *)event {

    <span class="hljs-built_in">UITouch</span> *touch = [touches anyObject];

    <span class="hljs-built_in">CGPoint</span> point = [touch locationInView:<span class="hljs-keyword">self</span>.view]; <span class="hljs-comment">// 触摸点坐标</span>

    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"触摸位置：%@"</span>, <span class="hljs-built_in">NSStringFromCGPoint</span>(point));

}

</code></pre>
<h4 data-id="heading-24">2. 手势识别（UIGestureRecognizer）</h4>
<p>OC 核心示例（点击/长按/滑动）：</p>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-comment">// 点击手势</span>

<span class="hljs-built_in">UITapGestureRecognizer</span> *tap = [[<span class="hljs-built_in">UITapGestureRecognizer</span> alloc] initWithTarget:<span class="hljs-keyword">self</span> action:<span class="hljs-keyword">@selector</span>(tapGesture:)];

tap.numberOfTapsRequired = <span class="hljs-number">1</span>; <span class="hljs-comment">// 点击次数</span>

[<span class="hljs-keyword">self</span>.view addGestureRecognizer:tap];

<span class="hljs-comment">// 长按手势</span>

<span class="hljs-built_in">UILongPressGestureRecognizer</span> *longPress = [[<span class="hljs-built_in">UILongPressGestureRecognizer</span> alloc] initWithTarget:<span class="hljs-keyword">self</span> action:<span class="hljs-keyword">@selector</span>(longPressGesture:)];

longPress.minimumPressDuration = <span class="hljs-number">1.0</span>; <span class="hljs-comment">// 长按时长（秒）</span>

[<span class="hljs-keyword">self</span>.view addGestureRecognizer:longPress];


<span class="hljs-comment">// 滑动手势</span>

<span class="hljs-built_in">UISwipeGestureRecognizer</span> *swipe = [[<span class="hljs-built_in">UISwipeGestureRecognizer</span> alloc] initWithTarget:<span class="hljs-keyword">self</span> action:<span class="hljs-keyword">@selector</span>(swipeGesture:)];

swipe.direction = <span class="hljs-built_in">UISwipeGestureRecognizerDirectionRight</span>; <span class="hljs-comment">// 滑动方向</span>

[<span class="hljs-keyword">self</span>.view addGestureRecognizer:swipe];

</code></pre>
<h4 data-id="heading-25">3. 响应者链拦截（hitTest:withEvent:）</h4>
<p>自定义视图可点击区域：</p>
<pre><code class="hljs language-objc" lang="objc">
- (<span class="hljs-built_in">UIView</span> *)hitTest:(<span class="hljs-built_in">CGPoint</span>)point withEvent:(<span class="hljs-built_in">UIEvent</span> *)event {

    <span class="hljs-comment">// 若视图隐藏/透明/不可交互，不响应事件</span>

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">self</span>.hidden || <span class="hljs-keyword">self</span>.alpha &lt;= <span class="hljs-number">0.01</span> || !<span class="hljs-keyword">self</span>.userInteractionEnabled) {

        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;

    }

    <span class="hljs-comment">// 检查点是否在视图范围内</span>

    <span class="hljs-keyword">if</span> (![<span class="hljs-keyword">self</span> pointInside:point withEvent:event]) {

        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>;

    }

    <span class="hljs-comment">// 优先返回子视图（倒序遍历，顶层视图优先）</span>

    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">UIView</span> *subview <span class="hljs-keyword">in</span> [<span class="hljs-keyword">self</span>.subviews reverseObjectEnumerator]) {

        <span class="hljs-built_in">CGPoint</span> subPoint = [subview convertPoint:point fromView:<span class="hljs-keyword">self</span>];

        <span class="hljs-built_in">UIView</span> *hitView = [subview hitTest:subPoint withEvent:event];

        <span class="hljs-keyword">if</span> (hitView) {

            <span class="hljs-keyword">return</span> hitView;

        }

    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">self</span>;

}

</code></pre>
<h3 data-id="heading-26">五、渲染与动画</h3>
<h4 data-id="heading-27">1. 视图渲染（CALayer + drawRect:）</h4>
<h5 data-id="heading-28">（1）CALayer 基础（UIView 底层渲染）</h5>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-comment">// 给视图添加圆角（通过layer）</span>

<span class="hljs-keyword">self</span>.view.layer.cornerRadius = <span class="hljs-number">10</span>;

<span class="hljs-keyword">self</span>.view.layer.masksToBounds = <span class="hljs-literal">YES</span>; <span class="hljs-comment">// 裁剪圆角</span>

<span class="hljs-keyword">self</span>.view.layer.borderWidth = <span class="hljs-number">1.0</span>;

<span class="hljs-keyword">self</span>.view.layer.borderColor = [<span class="hljs-built_in">UIColor</span> grayColor].CGColor;

  


<span class="hljs-comment">// 阴影（注意：masksToBounds=NO 才生效）</span>

<span class="hljs-keyword">self</span>.view.layer.shadowColor = [<span class="hljs-built_in">UIColor</span> blackColor].CGColor;

<span class="hljs-keyword">self</span>.view.layer.shadowOffset = <span class="hljs-built_in">CGSizeMake</span>(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>);

<span class="hljs-keyword">self</span>.view.layer.shadowOpacity = <span class="hljs-number">0.5</span>;

<span class="hljs-keyword">self</span>.view.layer.shadowRadius = <span class="hljs-number">4</span>;

</code></pre>
<h5 data-id="heading-29">（2）自定义绘制（drawRect:）</h5>
<pre><code class="hljs language-objc" lang="objc">
- (<span class="hljs-type">void</span>)drawRect:(<span class="hljs-built_in">CGRect</span>)rect {

    <span class="hljs-comment">// 获取绘图上下文</span>

    <span class="hljs-built_in">CGContextRef</span> ctx = <span class="hljs-built_in">UIGraphicsGetCurrentContext</span>();

    <span class="hljs-comment">// 设置画笔颜色</span>

    <span class="hljs-built_in">CGContextSetStrokeColorWithColor</span>(ctx, [<span class="hljs-built_in">UIColor</span> redColor].CGColor);

    <span class="hljs-comment">// 设置线宽</span>

    <span class="hljs-built_in">CGContextSetLineWidth</span>(ctx, <span class="hljs-number">2.0</span>);

    <span class="hljs-comment">// 绘制矩形</span>

    <span class="hljs-built_in">CGContextAddRect</span>(ctx, <span class="hljs-built_in">CGRectMake</span>(<span class="hljs-number">20</span>, <span class="hljs-number">20</span>, <span class="hljs-number">100</span>, <span class="hljs-number">100</span>));

    <span class="hljs-comment">// 绘制路径</span>

    <span class="hljs-built_in">CGContextStrokePath</span>(ctx);

}

</code></pre>
<h4 data-id="heading-30">2. UIView 动画（基础动画）</h4>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-comment">// 平移动画</span>

[<span class="hljs-built_in">UIView</span> animateWithDuration:<span class="hljs-number">0.3</span> animations:^{

    <span class="hljs-keyword">self</span>.btn.center = <span class="hljs-built_in">CGPointMake</span>(<span class="hljs-keyword">self</span>.btn.center.x + <span class="hljs-number">100</span>, <span class="hljs-keyword">self</span>.btn.center.y);

} completion:^(<span class="hljs-type">BOOL</span> finished) {

    <span class="hljs-comment">// 动画完成回调</span>

}];

<span class="hljs-comment">// 组合动画（缩放+旋转）</span>

[<span class="hljs-built_in">UIView</span> animateWithDuration:<span class="hljs-number">0.5</span> delay:<span class="hljs-number">0</span> options:<span class="hljs-built_in">UIViewAnimationOptionCurveEaseInOut</span> animations:^{

    <span class="hljs-keyword">self</span>.btn.transform = <span class="hljs-built_in">CGAffineTransformMakeScale</span>(<span class="hljs-number">1.5</span>, <span class="hljs-number">1.5</span>); <span class="hljs-comment">// 缩放</span>

    <span class="hljs-keyword">self</span>.btn.transform = <span class="hljs-built_in">CGAffineTransformRotate</span>(<span class="hljs-keyword">self</span>.btn.transform, M_PI_4); <span class="hljs-comment">// 旋转45度</span>

} completion:<span class="hljs-literal">nil</span>];

<span class="hljs-comment">// 转场动画</span>

[<span class="hljs-built_in">UIView</span> transitionWithView:<span class="hljs-keyword">self</span>.view duration:<span class="hljs-number">0.5</span> options:<span class="hljs-built_in">UIViewAnimationOptionTransitionFlipFromLeft</span> animations:^{

    [<span class="hljs-keyword">self</span>.view addSubview:<span class="hljs-keyword">self</span>.newView];

} completion:<span class="hljs-literal">nil</span>];

</code></pre>
<h4 data-id="heading-31">3. Core Animation（核心动画，底层）</h4>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-comment">// 关键帧动画（路径动画）</span>

<span class="hljs-built_in">CAKeyframeAnimation</span> *keyFrame = [<span class="hljs-built_in">CAKeyframeAnimation</span> animationWithKeyPath:<span class="hljs-string">@"position"</span>];

<span class="hljs-built_in">CGMutablePathRef</span> path = <span class="hljs-built_in">CGPathCreateMutable</span>();

<span class="hljs-built_in">CGPathMoveToPoint</span>(path, <span class="hljs-literal">NULL</span>, <span class="hljs-number">20</span>, <span class="hljs-number">100</span>);

<span class="hljs-built_in">CGPathAddLineToPoint</span>(path, <span class="hljs-literal">NULL</span>, <span class="hljs-number">355</span>, <span class="hljs-number">100</span>);

<span class="hljs-built_in">CGPathAddLineToPoint</span>(path, <span class="hljs-literal">NULL</span>, <span class="hljs-number">355</span>, <span class="hljs-number">500</span>);

<span class="hljs-built_in">CGPathAddLineToPoint</span>(path, <span class="hljs-literal">NULL</span>, <span class="hljs-number">20</span>, <span class="hljs-number">500</span>);

keyFrame.path = path;

keyFrame.duration = <span class="hljs-number">2.0</span>;

[<span class="hljs-keyword">self</span>.btn.layer addAnimation:keyFrame forKey:<span class="hljs-string">@"keyFrameAnimation"</span>];

</code></pre>
<h3 data-id="heading-32">六、多态适配（暗黑模式/动态字体）</h3>
<h4 data-id="heading-33">1. 暗黑模式（iOS 13+）</h4>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-comment">// 动态颜色（适配暗黑/浅色模式）</span>

<span class="hljs-built_in">UIColor</span> *dynamicColor = [<span class="hljs-built_in">UIColor</span> colorWithDynamicProvider:^<span class="hljs-built_in">UIColor</span> * _Nonnull(<span class="hljs-built_in">UITraitCollection</span> * _Nonnull traitCollection) {

    <span class="hljs-keyword">if</span> (traitCollection.userInterfaceStyle == <span class="hljs-built_in">UIUserInterfaceStyleDark</span>) {

        <span class="hljs-keyword">return</span> [<span class="hljs-built_in">UIColor</span> whiteColor]; <span class="hljs-comment">// 暗黑模式</span>

    } <span class="hljs-keyword">else</span> {

        <span class="hljs-keyword">return</span> [<span class="hljs-built_in">UIColor</span> blackColor]; <span class="hljs-comment">// 浅色模式</span>

    }

}];

<span class="hljs-keyword">self</span>.view.backgroundColor = dynamicColor;

<span class="hljs-comment">// 监听模式变化</span>

- (<span class="hljs-type">void</span>)traitCollectionDidChange:(<span class="hljs-built_in">UITraitCollection</span> *)previousTraitCollection {

    [<span class="hljs-variable language_">super</span> traitCollectionDidChange:previousTraitCollection];

    <span class="hljs-keyword">if</span> ([<span class="hljs-keyword">self</span>.traitCollection hasDifferentColorAppearanceComparedToTraitCollection:previousTraitCollection]) {

        <span class="hljs-comment">// 更新颜色/图片</span>

        <span class="hljs-keyword">self</span>.label.textColor = dynamicColor;

    }

}

</code></pre>
<h4 data-id="heading-34">2. 动态字体（适配字体大小）</h4>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-comment">// 动态字体（跟随系统字体大小）</span>

<span class="hljs-built_in">UIFont</span> *dynamicFont = [<span class="hljs-built_in">UIFont</span> preferredFontForTextStyle:<span class="hljs-built_in">UIFontTextStyleBody</span>];

<span class="hljs-keyword">self</span>.label.font = dynamicFont;

<span class="hljs-comment">// 监听字体大小变化</span>

[[<span class="hljs-built_in">NSNotificationCenter</span> defaultCenter] addObserver:<span class="hljs-keyword">self</span> selector:<span class="hljs-keyword">@selector</span>(fontSizeChanged:) name:<span class="hljs-built_in">UIContentSizeCategoryDidChangeNotification</span> object:<span class="hljs-literal">nil</span>];

</code></pre>
<h3 data-id="heading-35">七、性能优化</h3>
<h4 data-id="heading-36">1. 列表优化（UITableView/UICollectionView）</h4>
<ul>
<li>
<p>复用单元格（<code>dequeueReusableCellWithIdentifier:</code>）；</p>
</li>
<li>
<p>缓存单元格高度（避免重复计算）；</p>
</li>
<li>
<p>异步加载图片（SDWebImage 等）；</p>
</li>
<li>
<p>减少离屏渲染（避免圆角+阴影同时设置）；</p>
</li>
<li>
<p>禁用不必要的动画（<code>cell.selectionStyle = UITableViewCellSelectionStyleNone</code>）。</p>
</li>
</ul>
<h4 data-id="heading-37">2. 渲染优化</h4>
<ul>
<li>
<p>避免频繁调用 <code>setNeedsLayout</code>/<code>layoutIfNeeded</code>；</p>
</li>
<li>
<p>自定义绘制优先用 <code>CALayer</code> 而非 <code>drawRect:</code>；</p>
</li>
<li>
<p>开启光栅化（<code>layer.shouldRasterize = YES</code>，仅适合静态视图）；</p>
</li>
<li>
<p>减少透明视图（alpha &lt; 1 会触发离屏渲染）。</p>
</li>
</ul>
<h4 data-id="heading-38">3. 内存优化</h4>
<ul>
<li>
<p>避免循环引用（block 中用 <code>weakSelf</code>）；</p>
</li>
<li>
<p>图片压缩（<code>UIImageJPEGRepresentation</code>/<code>UIImagePNGRepresentation</code>）；</p>
</li>
<li>
<p>及时释放强引用（<code>dealloc</code> 中移除通知/定时器）；</p>
</li>
<li>
<p>懒加载控件（避免一次性创建大量视图）。</p>
</li>
</ul>
<h3 data-id="heading-39">八、调试工具</h3>
<h4 data-id="heading-40">1. Xcode 内置工具</h4>
<ul>
<li>
<p><strong>Debug View Hierarchy</strong>：可视化查看视图层级、约束、frame；</p>
</li>
<li>
<p><strong>Instruments</strong>：</p>
</li>
</ul>
<p>  - Core Animation：检测离屏渲染、帧率；</p>
<p>  - Time Profiler：检测卡顿；</p>
<p>  - Allocations：检测内存泄漏；</p>
<ul>
<li>
<p><strong>控制台日志</strong>：打印约束冲突、视图信息（<code>NSLog(@"frame: %@", NSStringFromCGRect(self.view.frame))</code>）。</p>
</li>
</ul>
<h4 data-id="heading-41">2. 约束冲突排查</h4>
<ul>
<li>
<p>控制台日志中定位「Unable to simultaneously satisfy constraints」；</p>
</li>
<li>
<p>降低非核心约束优先级（<code>constraint.priority = UILayoutPriorityDefaultHigh</code>）；</p>
</li>
<li>
<p>动态激活/禁用约束（<code>constraint.active = YES/NO</code>）。</p>
</li>
</ul>
<h3 data-id="heading-42">九、进阶特性</h3>
<h4 data-id="heading-43">1. 自定义控件</h4>
<p>继承 <code>UIView</code>/<code>UIControl</code> 实现自定义交互控件：</p>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">CustomControl</span> : <span class="hljs-title">UIControl</span></span>

<span class="hljs-keyword">@property</span> (<span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">assign</span>) <span class="hljs-built_in">CGFloat</span> progress;

<span class="hljs-keyword">@end</span>

<span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">CustomControl</span></span>

- (<span class="hljs-type">void</span>)setProgress:(<span class="hljs-built_in">CGFloat</span>)progress {

    _progress = progress;

    [<span class="hljs-keyword">self</span> setNeedsDisplay]; <span class="hljs-comment">// 触发重绘</span>

}

- (<span class="hljs-type">void</span>)drawRect:(<span class="hljs-built_in">CGRect</span>)rect {

    <span class="hljs-comment">// 绘制进度条</span>

    <span class="hljs-built_in">CGRect</span> progressRect = <span class="hljs-built_in">CGRectMake</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, rect.size.width * <span class="hljs-keyword">self</span>.progress, rect.size.height);

    [[<span class="hljs-built_in">UIColor</span> blueColor] setFill];

    <span class="hljs-built_in">UIRectFill</span>(progressRect);

}

- (<span class="hljs-type">void</span>)touchesEnded:(<span class="hljs-built_in">NSSet</span>&lt;<span class="hljs-built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="hljs-built_in">UIEvent</span> *)event {

    <span class="hljs-built_in">UITouch</span> *touch = [touches anyObject];

    <span class="hljs-built_in">CGPoint</span> point = [touch locationInView:<span class="hljs-keyword">self</span>];

    <span class="hljs-keyword">self</span>.progress = point.x / <span class="hljs-keyword">self</span>.bounds.size.width;

    [<span class="hljs-keyword">self</span> sendActionsForControlEvents:<span class="hljs-built_in">UIControlEventValueChanged</span>]; <span class="hljs-comment">// 触发值变化事件</span>

}

<span class="hljs-keyword">@end</span>

</code></pre>
<h4 data-id="heading-44">2. 文本排版（NSAttributedString）</h4>
<pre><code class="hljs language-objc" lang="objc">
<span class="hljs-built_in">NSMutableAttributedString</span> *attStr = [[<span class="hljs-built_in">NSMutableAttributedString</span> alloc] initWithString:<span class="hljs-string">@"富文本示例"</span>];

<span class="hljs-comment">// 设置字体</span>

[attStr addAttribute:<span class="hljs-built_in">NSFontAttributeName</span> value:[<span class="hljs-built_in">UIFont</span> boldSystemFontOfSize:<span class="hljs-number">18</span>] range:<span class="hljs-built_in">NSMakeRange</span>(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>)];

<span class="hljs-comment">// 设置颜色</span>

[attStr addAttribute:<span class="hljs-built_in">NSForegroundColorAttributeName</span> value:[<span class="hljs-built_in">UIColor</span> redColor] range:<span class="hljs-built_in">NSMakeRange</span>(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>)];

<span class="hljs-comment">// 设置下划线</span>

[attStr addAttribute:<span class="hljs-built_in">NSUnderlineStyleAttributeName</span> value:@(<span class="hljs-built_in">NSUnderlineStyleSingle</span>) range:<span class="hljs-built_in">NSMakeRange</span>(<span class="hljs-number">3</span>, <span class="hljs-number">2</span>)];

<span class="hljs-keyword">self</span>.label.attributedText = attStr;

</code></pre>
<h3 data-id="heading-45">十、最佳实践</h3>
<ol>
<li>
<p><strong>MVC 分层</strong>：控制器仅负责逻辑调度，视图仅负责展示，模型仅负责数据；</p>
</li>
<li>
<p><strong>控件封装</strong>：将重复的控件逻辑封装为分类/子类（如 <code>UIButton+Custom</code>）；</p>
</li>
<li>
<p><strong>兼容性处理</strong>：通过 <code>@available</code> 适配不同 iOS 版本：</p>
</li>
</ol>
<pre><code class="hljs language-objc" lang="objc">
   <span class="hljs-keyword">if</span> (@available(iOS <span class="hljs-number">13.0</span>, *)) {

       <span class="hljs-comment">// iOS 13+ 逻辑</span>

   } <span class="hljs-keyword">else</span> {

       <span class="hljs-comment">// 低版本逻辑</span>

   }

</code></pre>
<ol start="4">
<li>
<p><strong>避免生命周期陷阱</strong>：<code>viewDidLoad</code> 仅初始化，<code>viewWillAppear</code> 处理每次显示的逻辑；</p>
</li>
<li>
<p><strong>响应链优化</strong>：减少不必要的 <code>userInteractionEnabled = NO</code>，避免事件传递卡顿。</p>
</li>
</ol>
<h3 data-id="heading-46">总结</h3>
<p>UIKit 是 iOS 开发的「基石框架」，核心围绕「视图（UIView）- 控制器（UIViewController）- 事件（UIResponder）」展开，掌握「布局体系」「事件处理」「渲染优化」是关键。实际开发中，优先用 Masonry 简化 Auto Layout，结合 Size Classes/暗黑模式适配多场景，通过 Instruments 定位性能问题，可高效构建稳定、适配性强的 iOS 界面。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 “牵线木偶” 到 “独立个体”：JS 拷贝的爱恨情仇（浅拷贝 VS 深拷贝）]]></title>    <link>https://juejin.cn/post/7579800429376176178</link>    <guid>https://juejin.cn/post/7579800429376176178</guid>    <pubDate>2025-12-04T08:44:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579800429376176178" data-draft-id="7579544918076506147" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 “牵线木偶” 到 “独立个体”：JS 拷贝的爱恨情仇（浅拷贝 VS 深拷贝）"/> <meta itemprop="keywords" content="JavaScript,前端,面试"/> <meta itemprop="datePublished" content="2025-12-04T08:44:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风止何安啊"/> <meta itemprop="url" content="https://juejin.cn/user/2517239724512420"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 “牵线木偶” 到 “独立个体”：JS 拷贝的爱恨情仇（浅拷贝 VS 深拷贝）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2517239724512420/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风止何安啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T08:44:16.000Z" title="Thu Dec 04 2025 08:44:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>你有没有过这种抓狂瞬间：明明新建了对象想单独修改，结果原对象跟着 <strong>“秒同步”</strong>？就像买了个连轴的 <strong>“牵线木偶”</strong>，动新的、老的也跟着晃！这事儿得怪 <strong>JS 的引用类型</strong> —— 对象、数组这类 “特殊选手” 存的不是具体数值，而是指向数据的 <strong>“内存地址”</strong>。想让新对象彻底 “自立门户” 不牵连原对象？<strong>拷贝</strong>，安排上！</p>
<h3 data-id="heading-1">一、先搞懂：为啥基础类型不用拷贝？</h3>
<p>举个例子：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> a = <span class="hljs-number">1</span>;
<span class="hljs-keyword">let</span> b = a;
</code></pre>
<p>a 和 b 存的是<strong>具体数值</strong>，改 a 不会影响 b—— 这叫 <strong>“值传递”</strong>。<strong>原理</strong>：基础类型存栈内存，<code>b = a</code>是复制 a 的具体数值到 b 的<strong>独立栈空间</strong>，改 a 只改自身内存，不影响 b。所以你怎么改变<code>a</code>都不会影响<code>b</code>。</p>
<p>但引用类型（比如对象）不一样：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> obj = { 
    <span class="hljs-attr">age</span>: <span class="hljs-number">18</span> 
};
<span class="hljs-keyword">let</span> obj2 = obj; <span class="hljs-comment">// obj2存的是obj的地址！</span>
obj.<span class="hljs-property">age</span> = <span class="hljs-number">20</span>; 
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj2.<span class="hljs-property">age</span>); <span class="hljs-comment">// 也变成20了！</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbaec51087294aeabe223558b58ba5b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=rZBFrsSbCPtzyL6aObI1bm1a2wk%3D" alt="image.png" loading="lazy"/></p>
<p>这就像你和朋友<strong>共用</strong>一个网盘，你改了文件，朋友那边也同步变了 —— 这就是 <strong>“引用传递”</strong>。</p>
<h3 data-id="heading-2">二、浅拷贝：“表面独立，内核共享”</h3>
<p>浅拷贝是 <strong>“只拷贝第一层”</strong>：新对象的<strong>基本类型属性</strong>是独立的，但<strong>子对象 / 子数组</strong>还是共用地址 —— 相当于 “表面分了家，钱包还共用”。那么浅拷贝有哪些经典的例子呢？我们一个一个来看看：</p>
<h4 data-id="heading-3">1. 数组的浅拷贝：<code>slice(0)</code></h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> arr = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>, {<span class="hljs-attr">age</span>: <span class="hljs-number">18</span>}];
<span class="hljs-keyword">const</span> arr2 = arr.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>);
arr[<span class="hljs-number">4</span>].<span class="hljs-property">age</span> = <span class="hljs-number">20</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr2);
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/493961f8dfbe4106b7f36e7f19d1ae7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=CDhdUapa22XNyWJwIOlDVCRHDBo%3D" alt="image.png" loading="lazy"/></p>
<p><code>slice(0)</code>把数组第一层都复制了，但里面的<code>{age:18}</code>是对象，传的是地址 —— 改原数组里的子对象，新数组也跟着变！</p>
<p>看图更详细：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1cac6fea77641acae66f00344913eb0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=XPA%2BBJOLQAj8nC7MSaIwn%2Fj8IZQ%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-4">2. 数组的浅拷贝：扩展运算符<code>[...arr]</code></h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> a = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, {<span class="hljs-attr">age</span>: <span class="hljs-number">18</span>}];
<span class="hljs-keyword">let</span> c = [...a];
a[<span class="hljs-number">2</span>].<span class="hljs-property">age</span> = <span class="hljs-number">19</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(c);
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3b59a54ce974fdaa15c158acbc05732~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=7XHl85l9usn%2F7Stv2lqEoLRCUXU%3D" alt="image.png" loading="lazy"/></p>
<p>扩展运算符<code>[...arr]</code>看着像是给数组 “开了个全新副本”，用起来简洁又酷炫，新手第一眼都会觉得 “这肯定是完全独立了吧？”—— 但真相是：它依旧是<strong>浅拷贝</strong>！扩展运算符只把数组<strong>第一层的基础类型值</strong>复制了一份，可数组里嵌套的子对象<code>{ age: 18... }</code>，拷贝的依旧是内存地址 —— 就像给你换了个新书包，但书包里的文具盒还是和同桌共用的，他改了文具盒里的笔，你这边也会跟着变。</p>
<h4 data-id="heading-5">3. 数组的浅拷贝：<code>concat()</code></h4>
<p>我们先验证他是否创建了一个新对象：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> a = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, {<span class="hljs-attr">age</span>: <span class="hljs-number">18</span>}];
<span class="hljs-keyword">const</span> b = [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>];
<span class="hljs-keyword">const</span> c = a.<span class="hljs-title function_">concat</span>(b);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(c, a);
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/842aaf6f06fd49939bfbd655d7dbb7ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=FSXs88%2Fa9TuXDdOAWKveRkWROyg%3D" alt="image.png" loading="lazy"/></p>
<p>很明显<code>c</code>为创建的新对象。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> a = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, { <span class="hljs-attr">age</span>: <span class="hljs-number">18</span> }]; 
<span class="hljs-keyword">const</span> d = a.<span class="hljs-title function_">concat</span>(); <span class="hljs-comment">// 或者 const d = [].concat(a);</span>
a[<span class="hljs-number">3</span>].<span class="hljs-property">age</span> = <span class="hljs-number">19</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(d); 
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58568944efa748b9bc4329eae30d8090~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=dWJ8LDkKY0qXYFFE0imIDZmQzKc%3D" alt="image.png" loading="lazy"/></p>
<p><code>concat()</code>做数组浅拷贝时，会复制原数组第一层<strong>基础类型元素</strong>到新数组（改原数组第一层基础值不影响新数组），但原数组里的<strong>嵌套对象 / 数组</strong>，只会复制其内存地址到新数组 —— 改原数组子对象属性，新数组会同步变，子对象<strong>仍是 “牵线木偶”</strong>。</p>
<h4 data-id="heading-6">4. 数组的 “假独立”：<code>toReversed()</code></h4>
<p>在看<code>toReversed()</code>之前，我们先看看为什么不用<code>reverse()</code></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-keyword">const</span> arr2 = arr.<span class="hljs-title function_">reverse</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr);
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7865773a84b343d091c2e8e1da662431~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=BpvsHWrsiRYYbVEW7NW0mq48u6k%3D" alt="image.png" loading="lazy"/></p>
<p>很明显，<code>reverse()</code>并没有创建一个新的对象，而是在原数组上直接修改。所以我们肯定不能用<code>reverse()</code>，于是有请--<code>toReversed()</code>登场！</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-keyword">const</span> arr2 = arr.<span class="hljs-title function_">toReversed</span>().<span class="hljs-title function_">reverse</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr2, arr);
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78603293f9514ce9b53ec8575dc016ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=9plqWIMsN5Psodt9DwYnbK7b%2FqQ%3D" alt="image.png" loading="lazy"/></p>
<p><code>toReversed()</code>是 ES2023 的新方法，会返回<strong>新数组</strong>（浅拷贝），但它仍然是浅拷贝，只复制第一层元素。如果数组里有对象，子对象仍共享地址。</p>
<h4 data-id="heading-7">5. 对象的浅拷贝：<code>Object.assign()</code></h4>
<p>我们先介绍一下<code>Object.assign()</code>的用法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'henry'</span>,
    <span class="hljs-attr">like</span>: [<span class="hljs-string">'🏸'</span>]
}
<span class="hljs-keyword">const</span> obj2 = {
    <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>
}
<span class="hljs-keyword">const</span> newObj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>(obj, obj2);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newObj);
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b774d29e0b1c4944a68456fcb6260ec1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=oTMVemZD8iuXdjWAZKl6jaBTW28%3D" alt="image.png" loading="lazy"/></p>
<p>很显然，就是把两个对象里的元素整合到一个新的对象里面了。那么接下来看如何使用<code>Object.assign()</code>来实现<strong>浅拷贝</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'henry'</span>,
    <span class="hljs-attr">like</span>: [<span class="hljs-string">'🏸'</span>]
}
obj.<span class="hljs-property">name</span> = <span class="hljs-string">'harvest'</span>;
obj.<span class="hljs-property">like</span>[<span class="hljs-number">0</span>] = <span class="hljs-string">'🎤'</span>
<span class="hljs-keyword">const</span> newObj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, obj);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newObj);
</code></pre>
<p>输出结果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e65d66818d943a1ae15a370ffea0879~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=HcscKHi23QlovlUbNwPDkT31yvg%3D" alt="image.png" loading="lazy"/></p>
<p>很明显，<code>Object.assign()</code>把原对象的属性 “搬” 到新对象里，但子对象 / 子数组还是<strong>传地址</strong> —— 所以<code>like</code>数组改了，新对象也变！</p>
<h4 data-id="heading-8">6. 手写浅拷贝函数</h4>
<p>想真正理解<strong>浅拷贝</strong>的核心，最好的方式就是自己手搓一个：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'henry'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
    <span class="hljs-attr">like</span>:{
        <span class="hljs-attr">n</span>: <span class="hljs-string">'🏸'</span>,
        <span class="hljs-attr">m</span>: <span class="hljs-string">'🎤'</span>
    }
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">shallowCopy</span>(<span class="hljs-params">obj</span>) {
    <span class="hljs-keyword">let</span> o = {};
    <span class="hljs-comment">// 遍历原对象，将原对象中的 key, value 都存到新对象中一份</span>
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> obj){
        <span class="hljs-keyword">if</span>(obj.<span class="hljs-title function_">hasOwnProperty</span>(key)){  <span class="hljs-comment">// 只拷贝自身属性</span>
            o[key] = obj[key];  <span class="hljs-comment">// 第一层属性赋值，子对象传地址</span>
        }
    }
    <span class="hljs-keyword">return</span> o;
}
<span class="hljs-keyword">const</span> newObj = <span class="hljs-title function_">shallowCopy</span>(obj);
obj.<span class="hljs-property">like</span>.<span class="hljs-property">m</span> = <span class="hljs-string">'🏀'</span>;  <span class="hljs-comment">// like.m也变成了🏀</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newObj);
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4f384d21ce74ea6b03c5f404a9b5f6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=le9lBiEhGxPIFz1nolldxxpdT2E%3D" alt="image.png" loading="lazy"/></p>
<p>这就是<strong>浅拷贝的本质</strong>：只 “复制第一层”，子对象还是共用地址～ 就像你和同事共享一个工作文件夹，你新建了文件夹快捷方式（浅拷贝），快捷方式里的普通文件是独立副本，但嵌套的子文件夹仍指向原地址。</p>
<h3 data-id="heading-9">三、深拷贝：“彻底分家，各过各的”</h3>
<p>深拷贝是 “层层拷贝”：不管对象嵌套多少层，新对象和原对象的<strong>所有属性都是独立的</strong>—— 相当于 “不仅分家，连钱包都各自买新的”。</p>
<p>但深拷贝也有 “坑”，我们一起来看看：</p>
<h4 data-id="heading-10">1. 现代浏览器的深拷贝：<code>structuredClone()</code></h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'henry'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
    <span class="hljs-attr">like</span>:{
        <span class="hljs-attr">n</span>: <span class="hljs-string">'🏸'</span>,
        <span class="hljs-attr">m</span>: <span class="hljs-string">'🎤'</span>
    },
    <span class="hljs-attr">a</span>: <span class="hljs-number">123n</span>, <span class="hljs-comment">// BigInt</span>
    <span class="hljs-title function_">say</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'hello'</span>);
    }
}
<span class="hljs-keyword">const</span> newObj = <span class="hljs-title function_">structuredClone</span>(obj);
obj.<span class="hljs-property">like</span>.<span class="hljs-property">m</span> = <span class="hljs-string">'🏀'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newObj);
<span class="hljs-comment">// 但注意：structuredClone不支持拷贝函数</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newObj.<span class="hljs-property">say</span>); <span class="hljs-comment">// undefined</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec8c81d2bced41aa8c2b0855342dca94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=ElYkYMXCkImiBjSJVzMxsgGK2mI%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9651bf53ebc448a980807446ed46f44b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=oJnoJ4vm4RS2rFdba8V817aK6Ys%3D" alt="image.png" loading="lazy"/></p>
<p><code>structuredClone()</code>是浏览器自带的深拷贝，能处理大部分情况，但<strong>不支持函数、bigInt、Symbol</strong>等类型。</p>
<h4 data-id="heading-11">2. 经典深拷贝：<code>JSON.parse(JSON.stringify(obj))</code></h4>
<p>这是前端常用的 “曲线救国” 深拷贝，但<strong>坑特别多</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'henry'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
    <span class="hljs-attr">like</span>:{
        <span class="hljs-attr">n</span>: <span class="hljs-string">'🏸'</span>,
        <span class="hljs-attr">m</span>: <span class="hljs-string">'🎤'</span>
    },
    <span class="hljs-title function_">say</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'hello'</span>);
    },
    <span class="hljs-attr">a</span>: <span class="hljs-literal">undefined</span>,
    <span class="hljs-attr">b</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-attr">c</span>: <span class="hljs-title class_">NaN</span>,
    <span class="hljs-attr">d</span>: <span class="hljs-title class_">Infinity</span>
}
<span class="hljs-keyword">const</span> o = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(obj));
obj.<span class="hljs-property">like</span>.<span class="hljs-property">m</span> = <span class="hljs-string">'🏀'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(o);
<span class="hljs-comment">// 结果：{name:'henry', like:{n:'🏸',m:'🎤'}, c:null, d:null}</span>
<span class="hljs-comment">// 消失的：say、a；被篡改的：NaN→null，Infinity→null</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e691415546948c2b1022eddab127f7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=ykRdjoWgn18kbES4M23PyMXfCIc%3D" alt="image.png" loading="lazy"/></p>
<p><code>JSON.stringify</code>会<strong>忽略函数、undefined</strong>，把<code>NaN/Infinity</code>转成<code>null</code>—— 所以这招只适合 “纯 JSON 结构” 的对象！</p>
<blockquote>
<p>总结：无法处理 <code>bigint</code>, <code>undefined</code>, <code>NaN</code>, <code>Infinity</code>, <code>function</code>等</p>
</blockquote>
<h4 data-id="heading-12">3. 手写深拷贝（递归版）</h4>
<p>想要自己实现深拷贝，得用<strong>递归</strong>—— 遇到子对象就继续拷贝，直到所有层都复制完。</p>
<p>先回忆下递归的逻辑，比如计算阶乘：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">mul</span>(<span class="hljs-params">n</span>){
    <span class="hljs-keyword">if</span>(n == <span class="hljs-number">1</span>){
        <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
    }
    <span class="hljs-keyword">return</span> n * <span class="hljs-title function_">mul</span>(n-<span class="hljs-number">1</span>);
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">mul</span>(<span class="hljs-number">5</span>));
</code></pre>
<p>这样我们就很轻松的得出了<code>5</code>的阶层：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e75ad8af84f4c4e9729b1c493d95d8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=yIGE%2BJfnUGrSwld4c3V6OixOW6w%3D" alt="image.png" loading="lazy"/></p>
<p>深拷贝的递归思路就是：<strong>如果当前属性是对象，就递归拷贝；否则直接赋值</strong>。</p>
<p>简易手写版：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'henry'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
    <span class="hljs-attr">like</span>: {
        <span class="hljs-attr">n</span>: <span class="hljs-string">'🏸'</span>,
        <span class="hljs-attr">m</span>: <span class="hljs-string">'🎤'</span>
    }
}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">deepClone</span>(<span class="hljs-params">obj</span>) {
    <span class="hljs-keyword">let</span> o = {};
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> obj) {
        <span class="hljs-keyword">if</span> (obj.<span class="hljs-title function_">hasOwnProperty</span>(key)) {
            <span class="hljs-keyword">if</span>(<span class="hljs-title function_">typeof</span>(obj[key]) == <span class="hljs-string">'object'</span> &amp;&amp; obj[key] != <span class="hljs-literal">null</span>){
                <span class="hljs-keyword">const</span> childObj = <span class="hljs-title function_">deepClone</span>(obj[key]);
                o[key] = childObj;
            } <span class="hljs-keyword">else</span>{
                o[key] = obj[key];
            }
        }
    }
    <span class="hljs-keyword">return</span> o;
}
<span class="hljs-keyword">const</span> newObj = <span class="hljs-title function_">deepClone</span>(obj);
obj.<span class="hljs-property">like</span>.<span class="hljs-property">m</span> = <span class="hljs-string">'🏀'</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(newObj); <span class="hljs-comment">// 还是🎤（彻底独立！）</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1a77eda9bbd467f82d3c5cf13bd9aeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765442656&amp;x-signature=8WbLkDwakLlzMkihydKz3lpgIS8%3D" alt="image.png" loading="lazy"/></p>
<p>这样就实现了 “层层拷贝”，新对象和原对象完全独立啦～</p>
<h3 data-id="heading-13">四、浅拷贝 VS 深拷贝 怎么选？按场景选对不踩坑~</h3>




















<table><thead><tr><th>拷贝类型</th><th>特点</th><th>适用场景</th></tr></thead><tbody><tr><td>浅拷贝</td><td>只拷贝第一层，子对象共享地址</td><td>只需要第一层独立的简单对象 / 数组</td></tr><tr><td>深拷贝</td><td>层层拷贝，完全独立</td><td>嵌套层级多、需要彻底分离的对象</td></tr></tbody></table>
<p>选拷贝方式就像给数据选 <strong>“独立程度”</strong>：</p>
<ul>
<li>浅拷贝：适合<strong>数据只有一层结构</strong>（比如<code>['a', 'b', 'c']</code>、<code>{name: '张三', age: 20}</code>），或不需要修改子对象 / 子数组的场景。比如快速复制列表展示、临时复用基础属性，浅拷贝效率高，代码也简洁（<code>[...arr]</code>、<code>Object.assign</code>随手就用）。</li>
<li>深拷贝：适合<strong>数据嵌套多层</strong>（比如<code>{user: {info: {age: 18}}}</code>），且需要修改深层属性又不想影响原数据的场景。比如表单提交前的草稿复制、复杂数据的缓存备份 —— 但要注意：简单场景用<code>structuredClone</code>，需兼容特殊值（函数、BigInt）就手写递归深拷贝，别盲目用<code>JSON.parse(JSON.stringify)</code>踩坑。</li>
</ul>
<h2 data-id="heading-14">结语</h2>
<p>其实拷贝没有 “谁更好”，只有 <strong>“谁更合适”</strong>。浅拷贝是 <strong>“够用就好”</strong> 的高效选择，深拷贝是 <strong>“彻底隔离”</strong> 的稳妥方案。搞懂引用类型的本质，再结合数据结构和业务场景选拷贝方式，就能告别 “改新对象、原对象乱跳” 的崩溃时刻，让 JS 对象乖乖听你指挥～</p>
<p>最后送你个小口诀：</p>
<ul>
<li><strong>浅拷贝：“表面兄弟，内核共享”</strong></li>
<li><strong>深拷贝：“彻底分家，各自安好”</strong></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大宗供应链企业舆情指标系统设计 (二) 数据源扩展与NLP执行方案]]></title>    <link>https://juejin.cn/post/7579946275435511818</link>    <guid>https://juejin.cn/post/7579946275435511818</guid>    <pubDate>2025-12-05T05:43:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579946275435511818" data-draft-id="7579906040537972782" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大宗供应链企业舆情指标系统设计 (二)  数据源扩展与NLP执行方案"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-12-05T05:43:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="语落心生"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147955741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大宗供应链企业舆情指标系统设计 (二)  数据源扩展与NLP执行方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147955741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    语落心生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T05:43:52.000Z" title="Fri Dec 05 2025 05:43:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>阶段目标</strong>: 扩展到150+采购商，完整NLP模型部署，指标体系完善<br/>
<strong>核心交付物</strong>: 完整舆情指标系统、决策API、BI仪表板、生产级部署</p>
<hr/>
<h2 data-id="heading-0">数据源扩展与NLP完整部署</h2>
<h3 data-id="heading-1">数据源扩展 (20+个源)</h3>
<h4 data-id="heading-2">任务分解</h4>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">新增18个数据源:</span>

<span class="hljs-section">第一类: 全球主流财经新闻 (5个源)</span>
├─ Bloomberg API
├─ CNBC RSS Feed
├─ Financial Times API
├─ MarketWatch
└─ Wall Street Journal

<span class="hljs-section">第二类: 地缘政治情报 (4个源)</span>
├─ ICG (国际危机组织) 报告爬虫
├─ 国务院新闻办 (官方声明)
├─ 外交部 (官方声明)
└─ 各国驻华大使馆新闻稿

<span class="hljs-section">第三类: 商品期货 (3个源)</span>
├─ LME金属交易所 (铜、锌、铝)
├─ NYMEX农产品 (大豆、小麦、玉米)
└─ ICE能源 (天然气、布伦特油)

<span class="hljs-section">第四类: 港口与物流 (4个源)</span>
├─ 上海港口官网API
├─ 鹿特丹港口官网API
├─ 新加坡港口官网API
└─ MarineTraffic AIS数据 (船舶实时位置)

<span class="hljs-section">第五类: 汇率与金融指标 (2个源)</span>
├─ 央行外汇牌价API
└─ CDS价差数据 (彭博终端)
</code></pre>
<h4 data-id="heading-3">Bloomberg API集成 (示例)</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> kafka <span class="hljs-keyword">import</span> KafkaProducer
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime, timedelta

<span class="hljs-keyword">class</span> <span class="hljs-title class_">BloombergCollector</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, api_key, kafka_broker</span>):
        self.api_key = api_key
        self.producer = KafkaProducer(
            bootstrap_servers=kafka_broker,
            value_serializer=<span class="hljs-keyword">lambda</span> x: json.dumps(x).encode(<span class="hljs-string">'utf-8'</span>)
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_news_by_ticker</span>(<span class="hljs-params">self, ticker, since_hours=<span class="hljs-number">1</span></span>):
        <span class="hljs-string">"""根据商品代码获取相关新闻"""</span>
        since_time = datetime.utcnow() - timedelta(hours=since_hours)
        
        headers = {
            <span class="hljs-string">'Authorization'</span>: <span class="hljs-string">f'Bearer <span class="hljs-subst">{self.api_key}</span>'</span>,
            <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>
        }
        
        params = {
            <span class="hljs-string">'query'</span>: <span class="hljs-string">f'ticker:<span class="hljs-subst">{ticker}</span>'</span>,
            <span class="hljs-string">'startDate'</span>: since_time.strftime(<span class="hljs-string">'%Y-%m-%dT%H:%M:%S'</span>),
            <span class="hljs-string">'limit'</span>: <span class="hljs-number">100</span>
        }
        
        response = requests.get(
            <span class="hljs-string">'https://api.bloomberg.com/v1/articles'</span>,
            headers=headers,
            params=params
        )
        
        <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:
            articles = response.json().get(<span class="hljs-string">'articles'</span>, [])
            
            <span class="hljs-keyword">for</span> article <span class="hljs-keyword">in</span> articles:
                event = {
                    <span class="hljs-string">'event_id'</span>: article[<span class="hljs-string">'id'</span>],
                    <span class="hljs-string">'ingest_timestamp'</span>: datetime.utcnow().isoformat(),
                    <span class="hljs-string">'risk_date'</span>: article[<span class="hljs-string">'publishedDate'</span>][:<span class="hljs-number">10</span>],
                    <span class="hljs-string">'source_type'</span>: <span class="hljs-string">'news'</span>,
                    <span class="hljs-string">'source_name'</span>: <span class="hljs-string">'Bloomberg'</span>,
                    <span class="hljs-string">'source_url'</span>: article[<span class="hljs-string">'url'</span>],
                    <span class="hljs-string">'raw_text'</span>: article[<span class="hljs-string">'title'</span>] + <span class="hljs-string">'\n'</span> + article.get(<span class="hljs-string">'summary'</span>, <span class="hljs-string">''</span>),
                    <span class="hljs-string">'language'</span>: <span class="hljs-string">'en'</span>,
                    <span class="hljs-string">'detected_geo_keys'</span>: [],
                    <span class="hljs-string">'keywords'</span>: [ticker] + article.get(<span class="hljs-string">'tags'</span>, []),
                    <span class="hljs-string">'nlp_processing_flag'</span>: <span class="hljs-literal">False</span>,
                    <span class="hljs-string">'processing_version'</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">'confidence_raw'</span>: <span class="hljs-number">0.9</span>,
                    <span class="hljs-string">'_ticker'</span>: ticker  <span class="hljs-comment"># 标记商品</span>
                }
                
                self.producer.send(<span class="hljs-string">'raw_news_events'</span>, value=event)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_continuous</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""持续监测多个商品"""</span>
        <span class="hljs-keyword">import</span> schedule
        <span class="hljs-keyword">import</span> time
        
        tickers = [<span class="hljs-string">'CRU'</span>, <span class="hljs-string">'USCRWTIC'</span>, <span class="hljs-string">'GC'</span>, <span class="hljs-string">'SI'</span>, <span class="hljs-string">'RB'</span>]  <span class="hljs-comment"># 示例代码</span>
        
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">job</span>():
            <span class="hljs-keyword">for</span> ticker <span class="hljs-keyword">in</span> tickers:
                <span class="hljs-keyword">try</span>:
                    self.fetch_news_by_ticker(ticker)
                <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f'Error fetching <span class="hljs-subst">{ticker}</span>: <span class="hljs-subst">{e}</span>'</span>)
        
        schedule.every(<span class="hljs-number">30</span>).minutes.do(job)
        
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            schedule.run_pending()
            time.sleep(<span class="hljs-number">60</span>)

<span class="hljs-comment"># 部署</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    collector = BloombergCollector(
        api_key=<span class="hljs-string">'your_api_key'</span>,
        kafka_broker=<span class="hljs-string">'kafka1:9092,kafka2:9092,kafka3:9092'</span>
    )
    collector.run_continuous()
</code></pre>
<h4 data-id="heading-4">港口状态API集成</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> kafka <span class="hljs-keyword">import</span> KafkaProducer
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime

<span class="hljs-keyword">class</span> <span class="hljs-title class_">PortStatusCollector</span>:
    <span class="hljs-string">"""收集主要港口的实时状态"""</span>
    
    MAJOR_PORTS = {
        <span class="hljs-string">'shanghai'</span>: {
            <span class="hljs-string">'name'</span>: <span class="hljs-string">'上海港'</span>,
            <span class="hljs-string">'api'</span>: <span class="hljs-string">'https://api.shanghai-port.com/v1/status'</span>,
            <span class="hljs-string">'geo_key'</span>: [<span class="hljs-string">'China'</span>, <span class="hljs-string">'Shanghai'</span>]
        },
        <span class="hljs-string">'rotterdam'</span>: {
            <span class="hljs-string">'name'</span>: <span class="hljs-string">'鹿特丹港'</span>,
            <span class="hljs-string">'api'</span>: <span class="hljs-string">'https://api.portofrotterdam.com/vessel'</span>,
            <span class="hljs-string">'geo_key'</span>: [<span class="hljs-string">'Netherlands'</span>, <span class="hljs-string">'Rotterdam'</span>]
        },
        <span class="hljs-string">'singapore'</span>: {
            <span class="hljs-string">'name'</span>: <span class="hljs-string">'新加坡港'</span>,
            <span class="hljs-string">'api'</span>: <span class="hljs-string">'https://api.mpa.gov.sg/vessels'</span>,
            <span class="hljs-string">'geo_key'</span>: [<span class="hljs-string">'Singapore'</span>]
        },
        <span class="hljs-string">'suez'</span>: {
            <span class="hljs-string">'name'</span>: <span class="hljs-string">'苏伊士运河'</span>,
            <span class="hljs-string">'api'</span>: <span class="hljs-string">'https://api.suez-canal.gov.eg/status'</span>,
            <span class="hljs-string">'geo_key'</span>: [<span class="hljs-string">'Egypt'</span>, <span class="hljs-string">'Suez'</span>]
        },
        <span class="hljs-string">'panama'</span>: {
            <span class="hljs-string">'name'</span>: <span class="hljs-string">'巴拿马运河'</span>,
            <span class="hljs-string">'api'</span>: <span class="hljs-string">'https://api.panama-canal.com/status'</span>,
            <span class="hljs-string">'geo_key'</span>: [<span class="hljs-string">'Panama'</span>]
        }
    }
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, kafka_broker</span>):
        self.producer = KafkaProducer(
            bootstrap_servers=kafka_broker,
            value_serializer=<span class="hljs-keyword">lambda</span> x: json.dumps(x).encode(<span class="hljs-string">'utf-8'</span>)
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_port_status</span>(<span class="hljs-params">self, port_name, port_info</span>):
        <span class="hljs-string">"""获取港口状态"""</span>
        <span class="hljs-keyword">try</span>:
            response = requests.get(port_info[<span class="hljs-string">'api'</span>], timeout=<span class="hljs-number">10</span>)
            
            <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:
                data = response.json()
                
                <span class="hljs-comment"># 解析港口状态</span>
                status_event = {
                    <span class="hljs-string">'event_id'</span>: <span class="hljs-string">f"PORT_<span class="hljs-subst">{port_name}</span>_<span class="hljs-subst">{datetime.utcnow().timestamp()}</span>"</span>,
                    <span class="hljs-string">'ingest_timestamp'</span>: datetime.utcnow().isoformat(),
                    <span class="hljs-string">'risk_date'</span>: datetime.utcnow().date().isoformat(),
                    <span class="hljs-string">'source_type'</span>: <span class="hljs-string">'port_status'</span>,
                    <span class="hljs-string">'source_name'</span>: port_info[<span class="hljs-string">'name'</span>],
                    <span class="hljs-string">'source_url'</span>: port_info[<span class="hljs-string">'api'</span>],
                    <span class="hljs-string">'raw_text'</span>: json.dumps(data),
                    <span class="hljs-string">'language'</span>: <span class="hljs-string">'en'</span>,
                    <span class="hljs-string">'detected_geo_keys'</span>: port_info[<span class="hljs-string">'geo_key'</span>],
                    <span class="hljs-string">'keywords'</span>: [<span class="hljs-string">'port'</span>, <span class="hljs-string">'logistics'</span>, <span class="hljs-string">'shipping'</span>, port_name.lower()],
                    <span class="hljs-string">'nlp_processing_flag'</span>: <span class="hljs-literal">False</span>,
                    <span class="hljs-string">'processing_version'</span>: <span class="hljs-number">0</span>,
                    <span class="hljs-string">'confidence_raw'</span>: <span class="hljs-number">1.0</span>,
                    <span class="hljs-comment"># 港口特定信息</span>
                    <span class="hljs-string">'_port_name'</span>: port_name,
                    <span class="hljs-string">'_congestion_level'</span>: data.get(<span class="hljs-string">'congestion_level'</span>),  <span class="hljs-comment"># 拥堵程度</span>
                    <span class="hljs-string">'_vessels_waiting'</span>: data.get(<span class="hljs-string">'vessels_waiting'</span>, <span class="hljs-number">0</span>),
                    <span class="hljs-string">'_avg_wait_hours'</span>: data.get(<span class="hljs-string">'avg_wait_hours'</span>, <span class="hljs-number">0</span>),
                    <span class="hljs-string">'_operational_status'</span>: data.get(<span class="hljs-string">'status'</span>)  <span class="hljs-comment"># Operational/Limited/Closed</span>
                }
                
                self.producer.send(<span class="hljs-string">'port_logistics_status'</span>, value=status_event)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f'Error fetching port status for <span class="hljs-subst">{port_name}</span>: <span class="hljs-subst">{e}</span>'</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_continuous</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""每10分钟检查一次所有港口"""</span>
        <span class="hljs-keyword">import</span> schedule
        <span class="hljs-keyword">import</span> time
        
        <span class="hljs-keyword">def</span> <span class="hljs-title function_">job</span>():
            <span class="hljs-keyword">for</span> port_name, port_info <span class="hljs-keyword">in</span> self.MAJOR_PORTS.items():
                self.fetch_port_status(port_name, port_info)
        
        schedule.every(<span class="hljs-number">10</span>).minutes.do(job)
        
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            schedule.run_pending()
            time.sleep(<span class="hljs-number">60</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    collector = PortStatusCollector(
        kafka_broker=<span class="hljs-string">'kafka1:9092,kafka2:9092,kafka3:9092'</span>
    )
    collector.run_continuous()
</code></pre>
<h4 data-id="heading-5">数据源监控与告警</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">配置所有数据源的健康监控:</span>

<span class="hljs-string">检查项:</span>
<span class="hljs-string">├─</span> <span class="hljs-string">API可用性</span> <span class="hljs-string">(每1小时检查)</span>
<span class="hljs-string">├─</span> <span class="hljs-string">数据新鲜度</span> <span class="hljs-string">(最后更新时间)</span>
<span class="hljs-string">├─</span> <span class="hljs-string">消息吞吐量</span> <span class="hljs-string">(每分钟消息数)</span>
<span class="hljs-string">└─</span> <span class="hljs-string">错误率</span> <span class="hljs-string">(API请求失败率)</span>

<span class="hljs-string">告警规则:</span>

<span class="hljs-attr">Rule 1:</span> <span class="hljs-string">数据源不可用</span>
<span class="hljs-string">├─</span> <span class="hljs-string">条件:</span> <span class="hljs-string">API响应</span> <span class="hljs-string">5xx错误</span> <span class="hljs-string">连续3次</span>
<span class="hljs-string">├─</span> <span class="hljs-string">级别:</span> <span class="hljs-string">P1</span>
<span class="hljs-string">├─</span> <span class="hljs-string">行动:</span> <span class="hljs-string">通知Tech</span> <span class="hljs-string">Lead</span> <span class="hljs-string">+</span> <span class="hljs-string">切换备用源</span>

<span class="hljs-attr">Rule 2:</span> <span class="hljs-string">数据延迟超标</span>
<span class="hljs-string">├─</span> <span class="hljs-string">条件:</span> <span class="hljs-string">最后更新时间</span> <span class="hljs-string">&gt;2小时</span>
<span class="hljs-string">├─</span> <span class="hljs-string">级别:</span> <span class="hljs-string">P2</span>
<span class="hljs-string">├─</span> <span class="hljs-string">行动:</span> <span class="hljs-string">通知数据工程师</span> <span class="hljs-string">+</span> <span class="hljs-string">检查API</span>

<span class="hljs-attr">Rule 3:</span> <span class="hljs-string">吞吐量异常下降</span>
<span class="hljs-string">├─</span> <span class="hljs-string">条件:</span> <span class="hljs-string">当前小时吞吐量</span> <span class="hljs-string">&lt;上周平均值的50%</span>
<span class="hljs-string">├─</span> <span class="hljs-string">级别:</span> <span class="hljs-string">P2</span>
<span class="hljs-string">├─</span> <span class="hljs-string">行动:</span> <span class="hljs-string">告警</span> <span class="hljs-string">+</span> <span class="hljs-string">日志分析</span>

<span class="hljs-string">Prometheus监控配置:</span>

<span class="hljs-string">```yaml</span>
<span class="hljs-attr">global:</span>
  <span class="hljs-attr">scrape_interval:</span> <span class="hljs-string">1m</span>

<span class="hljs-attr">scrape_configs:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">job_name:</span> <span class="hljs-string">'data_sources_health'</span>
    <span class="hljs-attr">static_configs:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">targets:</span> [<span class="hljs-string">'datasource-monitor:9090'</span>]
    <span class="hljs-attr">metrics_path:</span> <span class="hljs-string">'/metrics'</span>
</code></pre>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">Grafana仪表板:</span>
├─ 所有数据源的实时状态
├─ 吞吐量折线图 (24小时)
├─ 延迟热力图
└─ 错误率趋势
</code></pre>
<h3 data-id="heading-6">NLP模型微调与完整部署</h3>
<h4 data-id="heading-7">NLP模型选型与采购</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">模型选择:</span>
<span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">事件分类模型</span> <span class="hljs-string">(A/B/C/D四维)</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">基础:</span> <span class="hljs-string">mBERT</span> <span class="hljs-string">(多语言)</span> <span class="hljs-string">/</span> <span class="hljs-string">XLM-RoBERTa</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">微调数据:</span> <span class="hljs-string">手工标注</span> <span class="hljs-number">5000</span><span class="hljs-string">+</span> <span class="hljs-string">条样本</span>
   <span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">A类</span> <span class="hljs-string">(物流中断):</span> <span class="hljs-number">1250</span><span class="hljs-string">条</span>
   <span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">B类</span> <span class="hljs-string">(监管限制):</span> <span class="hljs-number">1250</span><span class="hljs-string">条</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">C类</span> <span class="hljs-string">(政治不稳定):</span> <span class="hljs-number">1250</span><span class="hljs-string">条</span>
   <span class="hljs-string">└─</span> <span class="hljs-string">D类</span> <span class="hljs-string">(金融冲击):</span> <span class="hljs-number">1250</span><span class="hljs-string">条</span>
   
   <span class="hljs-string">成本:</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">数据标注:</span> <span class="hljs-string">¥5万</span> <span class="hljs-string">(1000条/¥500)</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">模型训练:</span> <span class="hljs-string">¥5万</span> <span class="hljs-string">(GPU租赁)</span>
   <span class="hljs-string">└─</span> <span class="hljs-string">模型部署:</span> <span class="hljs-string">¥3万</span> <span class="hljs-string">(优化与版本管理)</span>

<span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">命名实体识别模型</span> <span class="hljs-string">(NER)</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">基础:</span> <span class="hljs-string">XLM-RoBERTa-large</span> <span class="hljs-string">(多语言强)</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">微调数据:</span> <span class="hljs-number">3000</span><span class="hljs-string">+</span> <span class="hljs-string">句子标注</span>
   <span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">地点</span> <span class="hljs-string">(GPE/LOC):</span> <span class="hljs-string">港口、海峡、国家</span>
   <span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">组织</span> <span class="hljs-string">(ORG):</span> <span class="hljs-string">公司、政府机构</span>
   <span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">人物</span> <span class="hljs-string">(PER):</span> <span class="hljs-string">政治人物、CEO</span>
   <span class="hljs-string">│</span>  <span class="hljs-string">└─</span> <span class="hljs-string">商品</span> <span class="hljs-string">(PRODUCT):</span> <span class="hljs-string">石油、铁矿石等</span>
   <span class="hljs-string">└─</span> <span class="hljs-string">准确度目标:</span> <span class="hljs-string">&gt;90%</span> <span class="hljs-string">F1</span> <span class="hljs-string">score</span>
   
   <span class="hljs-string">成本:</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">标注数据:</span> <span class="hljs-string">¥3万</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">模型训练:</span> <span class="hljs-string">¥2万</span>
   <span class="hljs-string">└─</span> <span class="hljs-string">部署优化:</span> <span class="hljs-string">¥1万</span>

<span class="hljs-number">3</span><span class="hljs-string">.</span> <span class="hljs-string">情感分析模型</span> <span class="hljs-string">(金融领域)</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">基础:</span> <span class="hljs-string">DistilBERT</span> <span class="hljs-string">(轻量级)</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">微调数据:</span> <span class="hljs-number">2000</span><span class="hljs-string">+</span> <span class="hljs-string">金融新闻样本</span>
   <span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">标注维度:</span> <span class="hljs-string">正/中性/负</span>
   <span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">强度:</span> <span class="hljs-string">强/弱</span>
   <span class="hljs-string">│</span>  <span class="hljs-string">└─</span> <span class="hljs-string">金融特定:</span> <span class="hljs-string">机会/风险/中立</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">数据来源:</span>
   <span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">历史金融事件</span> <span class="hljs-string">(标注)</span>
   <span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">第三方数据集</span> <span class="hljs-string">(金融情感语料库)</span>
   <span class="hljs-string">│</span>  <span class="hljs-string">└─</span> <span class="hljs-string">众包标注</span>
   <span class="hljs-string">└─</span> <span class="hljs-string">准确度目标:</span> <span class="hljs-string">&gt;85%</span>
   
   <span class="hljs-string">成本:</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">标注:</span> <span class="hljs-string">¥2万</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">训练:</span> <span class="hljs-string">¥1.5万</span>
   <span class="hljs-string">└─</span> <span class="hljs-string">部署:</span> <span class="hljs-string">¥1万</span>

<span class="hljs-string">总NLP成本:</span> <span class="hljs-string">~¥20万</span> <span class="hljs-string">(M4-M5内完成)</span>
</code></pre>
<h4 data-id="heading-8">模型训练与优化流程</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">时间表:</span>

<span class="hljs-attr">Week 15-16:</span> <span class="hljs-string">数据准备与标注</span>
<span class="hljs-string">├─</span> <span class="hljs-string">准备训练数据</span> <span class="hljs-string">(5000条标注)</span>
<span class="hljs-string">├─</span> <span class="hljs-string">数据清洗与验证</span>
<span class="hljs-string">├─</span> <span class="hljs-string">拆分:</span> <span class="hljs-number">70</span><span class="hljs-string">%</span> <span class="hljs-string">train</span> <span class="hljs-string">/</span> <span class="hljs-number">15</span><span class="hljs-string">%</span> <span class="hljs-string">val</span> <span class="hljs-string">/</span> <span class="hljs-number">15</span><span class="hljs-string">%</span> <span class="hljs-string">test</span>
<span class="hljs-string">└─</span> <span class="hljs-string">保存为标准格式</span> <span class="hljs-string">(HuggingFace</span> <span class="hljs-string">datasets)</span>

<span class="hljs-attr">Week 17-18:</span> <span class="hljs-string">模型训练与评估</span>
<span class="hljs-string">├─</span> <span class="hljs-string">分类模型训练</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">基础模型:</span> <span class="hljs-string">mBERT</span> <span class="hljs-string">/</span> <span class="hljs-string">XLM-RoBERTa</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">训练参数:</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-attr">Learning rate:</span> <span class="hljs-number">2e-5</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-attr">Batch size:</span> <span class="hljs-number">32</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-attr">Epochs:</span> <span class="hljs-number">3</span><span class="hljs-number">-5</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-attr">Early stopping:</span> <span class="hljs-string">验证集无改进3个epoch停止</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span>  <span class="hljs-string">└─</span> <span class="hljs-attr">Optimizer:</span> <span class="hljs-string">AdamW</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">评估指标:</span> <span class="hljs-string">Precision</span> <span class="hljs-string">/</span> <span class="hljs-string">Recall</span> <span class="hljs-string">/</span> <span class="hljs-string">F1</span> <span class="hljs-string">(各维度)</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─</span> <span class="hljs-string">目标:</span> <span class="hljs-string">整体准确度</span> <span class="hljs-string">&gt;95%</span>
<span class="hljs-string">│</span>
<span class="hljs-string">├─</span> <span class="hljs-string">NER模型训练</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">训练参数</span> <span class="hljs-string">(类似)</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">评估:</span> <span class="hljs-string">token-level</span> <span class="hljs-string">F1,</span> <span class="hljs-string">entity-level</span> <span class="hljs-string">F1</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─</span> <span class="hljs-string">目标:</span> <span class="hljs-string">&gt;90%</span> <span class="hljs-string">F1</span>
<span class="hljs-string">│</span>
<span class="hljs-string">├─</span> <span class="hljs-string">情感分析模型训练</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-number">3</span><span class="hljs-string">分类问题</span> <span class="hljs-string">(negative/neutral/positive)</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">目标:</span> <span class="hljs-string">准确度</span> <span class="hljs-string">&gt;85%</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─</span> <span class="hljs-string">关注:</span> <span class="hljs-string">金融特定短语的识别</span>
<span class="hljs-string">│</span>
<span class="hljs-string">├─</span> <span class="hljs-string">交叉验证与超参调优</span>
<span class="hljs-string">└─</span> <span class="hljs-string">对比多个模型选择最优</span>

<span class="hljs-attr">Week 19-20:</span> <span class="hljs-string">模型部署与推理优化</span>
<span class="hljs-string">├─</span> <span class="hljs-string">模型量化</span> <span class="hljs-string">(降低推理延迟)</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">INT8量化</span> <span class="hljs-string">(推理延迟↓50%)</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">知识蒸馏</span> <span class="hljs-string">(模型大小↓60%)</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─</span> <span class="hljs-string">混合精度训练</span>
<span class="hljs-string">├─</span> <span class="hljs-string">部署环境准备</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">GPU服务器配置</span> <span class="hljs-string">(如果有GPU)</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">推理框架:</span> <span class="hljs-string">TorchServe</span> <span class="hljs-string">或</span> <span class="hljs-string">ONNX</span> <span class="hljs-string">Runtime</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─</span> <span class="hljs-string">API包装</span> <span class="hljs-string">(FastAPI)</span>
<span class="hljs-string">├─</span> <span class="hljs-string">性能测试</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">吞吐量:</span> <span class="hljs-string">目标</span> <span class="hljs-string">&gt;1000条/秒</span> <span class="hljs-string">(分类)</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├─</span> <span class="hljs-string">延迟:</span> <span class="hljs-string">P99</span> <span class="hljs-string">&lt;100ms</span> <span class="hljs-string">(单条)</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└─</span> <span class="hljs-string">资源占用:</span> <span class="hljs-string">GPU内存</span> <span class="hljs-string">&lt;4GB</span>
<span class="hljs-string">└─</span> <span class="hljs-string">模型版本管理</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">Model</span> <span class="hljs-string">Registry</span> <span class="hljs-string">(MLflow)</span>
   <span class="hljs-string">├─</span> <span class="hljs-string">版本追踪与回滚</span>
   <span class="hljs-string">└─</span> <span class="hljs-string">A/B测试框架</span>
</code></pre>
<p>推理服务代码示例:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel
<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> pipeline
<span class="hljs-keyword">import</span> uvicorn

app = FastAPI()

<span class="hljs-comment"># 加载模型</span>
classifier = pipeline(
    <span class="hljs-string">'zero-shot-classification'</span>,
    model=<span class="hljs-string">'xlm-roberta-large-finetuned-mgir'</span>,
    device=<span class="hljs-number">0</span>
)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TextInput</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    text: <span class="hljs-built_in">str</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassificationOutput</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    dimension: <span class="hljs-built_in">str</span>
    confidence: <span class="hljs-built_in">float</span>
    scores: <span class="hljs-built_in">dict</span>

<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">'/classify'</span></span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">classify_text</span>(<span class="hljs-params">input_data: TextInput</span>) -&gt; ClassificationOutput:
    candidate_labels = [
        <span class="hljs-string">'Physical logistics disruption'</span>,
        <span class="hljs-string">'Regulatory restrictions'</span>,
        <span class="hljs-string">'Political instability'</span>,
        <span class="hljs-string">'Financial crisis'</span>
    ]
    
    result = classifier(input_data.text, candidate_labels)
    
    dim_map = {
        <span class="hljs-string">'Physical logistics disruption'</span>: <span class="hljs-string">'A'</span>,
        <span class="hljs-string">'Regulatory restrictions'</span>: <span class="hljs-string">'B'</span>,
        <span class="hljs-string">'Political instability'</span>: <span class="hljs-string">'C'</span>,
        <span class="hljs-string">'Financial crisis'</span>: <span class="hljs-string">'D'</span>
    }
    
    <span class="hljs-keyword">return</span> ClassificationOutput(
        dimension=dim_map.get(result[<span class="hljs-string">'labels'</span>][<span class="hljs-number">0</span>]),
        confidence=result[<span class="hljs-string">'scores'</span>][<span class="hljs-number">0</span>],
        scores={
            <span class="hljs-string">'A'</span>: result[<span class="hljs-string">'scores'</span>][<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> result[<span class="hljs-string">'labels'</span>][<span class="hljs-number">0</span>] == <span class="hljs-string">'Physical logistics disruption'</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>,
            <span class="hljs-string">'B'</span>: result[<span class="hljs-string">'scores'</span>][<span class="hljs-number">1</span>] <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(result[<span class="hljs-string">'labels'</span>]) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>,
            <span class="hljs-string">'C'</span>: result[<span class="hljs-string">'scores'</span>][<span class="hljs-number">2</span>] <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(result[<span class="hljs-string">'labels'</span>]) &gt; <span class="hljs-number">2</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>,
            <span class="hljs-string">'D'</span>: result[<span class="hljs-string">'scores'</span>][<span class="hljs-number">3</span>] <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(result[<span class="hljs-string">'labels'</span>]) &gt; <span class="hljs-number">3</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>
        }
    )

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    uvicorn.run(app, host=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">8000</span>)
</code></pre>
<p>部署到Flink:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pyflink.datastream <span class="hljs-keyword">import</span> StreamExecutionEnvironment
<span class="hljs-keyword">from</span> pyflink.datastream.functions <span class="hljs-keyword">import</span> MapFunction
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> json

<span class="hljs-keyword">class</span> <span class="hljs-title class_">NLPClassificationFunction</span>(<span class="hljs-title class_ inherited__">MapFunction</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, nlp_api_url=<span class="hljs-string">'http://nlp-service:8000'</span></span>):
        self.nlp_api_url = nlp_api_url
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">map</span>(<span class="hljs-params">self, element</span>):
        <span class="hljs-keyword">try</span>:
            text = element.get(<span class="hljs-string">'raw_text'</span>, <span class="hljs-string">''</span>)
            
            <span class="hljs-comment"># 调用NLP服务API</span>
            response = requests.post(
                <span class="hljs-string">f'<span class="hljs-subst">{self.nlp_api_url}</span>/classify'</span>,
                json={<span class="hljs-string">'text'</span>: text},
                timeout=<span class="hljs-number">5</span>
            )
            
            <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:
                nlp_result = response.json()
                element[<span class="hljs-string">'delivery_impact_dim'</span>] = nlp_result[<span class="hljs-string">'dimension'</span>]
                element[<span class="hljs-string">'confidence_score_nlp'</span>] = nlp_result[<span class="hljs-string">'confidence'</span>]
                element[<span class="hljs-string">'impact_severity_score'</span>] = self._calculate_severity(
                    nlp_result[<span class="hljs-string">'confidence'</span>],
                    element.get(<span class="hljs-string">'sentiment_score_nlp'</span>, <span class="hljs-number">0</span>)
                )
                element[<span class="hljs-string">'nlp_processing_flag'</span>] = <span class="hljs-literal">True</span>
                element[<span class="hljs-string">'processing_version'</span>] = <span class="hljs-number">1</span>
            
            <span class="hljs-keyword">return</span> element
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f'Error in NLP classification: <span class="hljs-subst">{e}</span>'</span>)
            <span class="hljs-keyword">return</span> element
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_calculate_severity</span>(<span class="hljs-params">self, confidence, sentiment</span>):
        <span class="hljs-string">"""计算严重度 (0-10)"""</span>
        base = confidence * <span class="hljs-number">10</span>
        <span class="hljs-keyword">if</span> sentiment &lt; -<span class="hljs-number">0.5</span>:
            base *= <span class="hljs-number">1.2</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">min</span>(<span class="hljs-number">10.0</span>, base)
</code></pre>
<h3 data-id="heading-9">Flink任务完整化与Paimon数据验证</h3>
<h4 data-id="heading-10">完整的Flink ETL任务</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pyflink.datastream <span class="hljs-keyword">import</span> StreamExecutionEnvironment, KeyedStream
<span class="hljs-keyword">from</span> pyflink.datastream.functions <span class="hljs-keyword">import</span> (
    MapFunction, KeyedProcessFunction, WindowFunction
)
<span class="hljs-keyword">from</span> pyflink.datastream.connectors.kafka <span class="hljs-keyword">import</span> FlinkKafkaConsumer, FlinkKafkaProducer
<span class="hljs-keyword">from</span> pyflink.datastream.connectors.files <span class="hljs-keyword">import</span> FileSink
<span class="hljs-keyword">from</span> pyflink.datastream.formats.json <span class="hljs-keyword">import</span> JsonRowSerializationSchema
<span class="hljs-keyword">from</span> pyflink.datastream.window <span class="hljs-keyword">import</span> TumblingEventTimeWindow
<span class="hljs-keyword">from</span> pyflink.common.typeinfo <span class="hljs-keyword">import</span> Types
<span class="hljs-keyword">from</span> pyflink.common.watermark_strategy <span class="hljs-keyword">import</span> WatermarkStrategy
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> timedelta
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CompleteFlinKETLPipeline</span>:
    <span class="hljs-string">"""完整的Flink ETL管道"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_environment</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""创建Flink环境"""</span>
        env = StreamExecutionEnvironment.get_execution_environment()
        
        <span class="hljs-comment"># 配置</span>
        env.set_parallelism(<span class="hljs-number">32</span>)
        env.enable_change_logs(<span class="hljs-literal">True</span>)
        env.set_default_savepoint_dir(<span class="hljs-string">'hdfs://namenode:8020/flink/savepoints'</span>)
        
        <span class="hljs-comment"># Checkpoint配置</span>
        <span class="hljs-keyword">from</span> pyflink.datastream.checkpoint_config <span class="hljs-keyword">import</span> CheckpointConfig
        checkpoint_config = CheckpointConfig()
        checkpoint_config.set_checkpointing_interval(<span class="hljs-number">60000</span>)  <span class="hljs-comment"># 60秒</span>
        checkpoint_config.set_checkpointing_mode(<span class="hljs-string">'EXACTLY_ONCE'</span>)
        checkpoint_config.set_checkpoint_timeout(<span class="hljs-number">600000</span>)  <span class="hljs-comment"># 10分钟</span>
        checkpoint_config.set_tolerable_checkpoint_failure_number(<span class="hljs-number">3</span>)
        env.enable_checkpointing_with_config(checkpoint_config)
        
        <span class="hljs-keyword">return</span> env
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_kafka_source</span>(<span class="hljs-params">self, env</span>):
        <span class="hljs-string">"""创建Kafka数据源"""</span>
        kafka_props = {
            <span class="hljs-string">'bootstrap.servers'</span>: <span class="hljs-string">'kafka1:9092,kafka2:9092,kafka3:9092'</span>,
            <span class="hljs-string">'group.id'</span>: <span class="hljs-string">'flink_etl_complete'</span>,
            <span class="hljs-string">'auto.offset.reset'</span>: <span class="hljs-string">'earliest'</span>
        }
        
        <span class="hljs-comment"># 消费多个Topic</span>
        topics = [
            <span class="hljs-string">'raw_news_events'</span>,
            <span class="hljs-string">'geopolitical_conflict_events'</span>,
            <span class="hljs-string">'sanctions_and_regulations'</span>,
            <span class="hljs-string">'commodity_prices_stream'</span>,
            <span class="hljs-string">'port_logistics_status'</span>,
            <span class="hljs-string">'financial_indicators'</span>
        ]
        
        kafka_source = FlinkKafkaConsumer(
            topics=topics,
            deserialization_schema=JsonRowSerializationSchema.Builder()
                .type_info(Types.ROW_NAMED(
                    [<span class="hljs-string">'event_id'</span>, <span class="hljs-string">'ingest_timestamp'</span>, <span class="hljs-string">'raw_text'</span>, <span class="hljs-string">'source_type'</span>, ...],
                    [Types.STRING(), Types.STRING(), Types.STRING(), Types.STRING(), ...]
                )).build(),
            properties=kafka_props
        )
        
        <span class="hljs-comment"># 水位线策略 (事件时间)</span>
        kafka_source.assign_timestamps_and_watermarks(
            WatermarkStrategy.for_bounded_out_of_orderness(timedelta(seconds=<span class="hljs-number">10</span>))
                .with_timestamp_assigner(<span class="hljs-keyword">lambda</span> x: <span class="hljs-built_in">int</span>(datetime.fromisoformat(
                    x.get(<span class="hljs-string">'ingest_timestamp'</span>)).timestamp() * <span class="hljs-number">1000</span>))
        )
        
        <span class="hljs-keyword">return</span> env.add_source(kafka_source)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">build_pipeline</span>(<span class="hljs-params">self, env</span>):
        <span class="hljs-string">"""构建完整的数据处理管道"""</span>
        
        <span class="hljs-comment"># 1. Source</span>
        raw_stream = self.create_kafka_source(env)
        
        <span class="hljs-comment"># 2. 数据清洗 (并行度16)</span>
        cleaned_stream = raw_stream \
            .<span class="hljs-built_in">map</span>(DataCleaningFunction()) \
            .set_parallelism(<span class="hljs-number">16</span>) \
            .name(<span class="hljs-string">'DataCleaning'</span>)
        
        <span class="hljs-comment"># 3. 去重 (KeyedProcessFunction, 使用RocksDB状态)</span>
        deduped_stream = cleaned_stream \
            .key_by(<span class="hljs-keyword">lambda</span> x: x.get(<span class="hljs-string">'source_url'</span>)) \
            .process(DeduplicationFunction()) \
            .set_parallelism(<span class="hljs-number">32</span>) \
            .name(<span class="hljs-string">'Deduplication'</span>)
        
        <span class="hljs-comment"># 4. 地理编码与实体识别 (可选的外部API调用)</span>
        geo_enriched_stream = deduped_stream \
            .<span class="hljs-built_in">map</span>(GeoEnrichmentFunction()) \
            .set_parallelism(<span class="hljs-number">16</span>) \
            .name(<span class="hljs-string">'GeoEnrichment'</span>)
        
        <span class="hljs-comment"># 5. 时间窗口聚合 (Tumbling Window, 60秒)</span>
        windowed_stream = geo_enriched_stream \
            .key_by(<span class="hljs-keyword">lambda</span> x: (x.get(<span class="hljs-string">'buyer_geo_key'</span>), x.get(<span class="hljs-string">'commodity_type'</span>))) \
            .window(TumblingEventTimeWindow.of(timedelta(seconds=<span class="hljs-number">60</span>))) \
            .apply(DimensionScoreCalculator()) \
            .set_parallelism(<span class="hljs-number">32</span>) \
            .name(<span class="hljs-string">'DimensionScoreCalculation'</span>)
        
        <span class="hljs-comment"># 6. 综合指标计算</span>
        composite_stream = windowed_stream \
            .<span class="hljs-built_in">map</span>(CompositeRiskCalculator()) \
            .set_parallelism(<span class="hljs-number">16</span>) \
            .name(<span class="hljs-string">'CompositeRiskCalculation'</span>)
        
        <span class="hljs-comment"># 7. 输出 - Sink到多个目标</span>
        
        <span class="hljs-comment"># Sink 1: Paimon (标准化事件表)</span>
        paimon_sink = self.create_paimon_sink(<span class="hljs-string">'standardized_events'</span>)
        deduped_stream.add_sink(paimon_sink).name(<span class="hljs-string">'PaimonStandardizedEvents'</span>)
        
        <span class="hljs-comment"># Sink 2: Paimon (维度指标表)</span>
        dimension_sink = self.create_paimon_sink(<span class="hljs-string">'dimension_scores'</span>)
        windowed_stream.add_sink(dimension_sink).name(<span class="hljs-string">'PaimonDimensionScores'</span>)
        
        <span class="hljs-comment"># Sink 3: Doris (最终指标表)</span>
        doris_sink = DorisStreamLoad(
            <span class="hljs-string">'doris_cdc'</span>,
            <span class="hljs-string">'mgir'</span>,
            <span class="hljs-string">'mgir_indices_fact'</span>,
            options={
                <span class="hljs-string">'fenodes'</span>: <span class="hljs-string">'doris_fe:8030'</span>,
                <span class="hljs-string">'username'</span>: <span class="hljs-string">'root'</span>,
                <span class="hljs-string">'password'</span>: <span class="hljs-string">'doris_password'</span>
            }
        )
        composite_stream.add_sink(doris_sink).name(<span class="hljs-string">'DorisIndices'</span>)
        
        <span class="hljs-comment"># Sink 4: 告警系统 (Red级风险)</span>
        alert_stream = composite_stream \
            .<span class="hljs-built_in">filter</span>(<span class="hljs-keyword">lambda</span> x: x.get(<span class="hljs-string">'risk_alert_level'</span>) == <span class="hljs-string">'Red'</span>) \
            .<span class="hljs-built_in">map</span>(AlertFormattingFunction()) \
            .set_parallelism(<span class="hljs-number">4</span>) \
            .name(<span class="hljs-string">'AlertFiltering'</span>)
        
        alert_kafka_sink = FlinkKafkaProducer(
            <span class="hljs-string">'alert_notifications'</span>,
            serialization_schema=JsonRowSerializationSchema.Builder().build(),
            producer_config={<span class="hljs-string">'bootstrap.servers'</span>: <span class="hljs-string">'kafka1:9092,kafka2:9092,kafka3:9092'</span>}
        )
        alert_stream.add_sink(alert_kafka_sink).name(<span class="hljs-string">'KafkaAlerts'</span>)
        
        <span class="hljs-comment"># Sink 5: 监控指标输出</span>
        metrics_stream = composite_stream \
            .<span class="hljs-built_in">map</span>(MetricsFormattingFunction()) \
            .set_parallelism(<span class="hljs-number">4</span>) \
            .name(<span class="hljs-string">'MetricsFormatting'</span>)
        
        <span class="hljs-comment"># 输出到Prometheus Push Gateway (可选)</span>
        metrics_stream.add_sink(PrometheusMetricsSink()).name(<span class="hljs-string">'PrometheusMetrics'</span>)
        
        <span class="hljs-keyword">return</span> env
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_paimon_sink</span>(<span class="hljs-params">self, table_name</span>):
        <span class="hljs-string">"""创建Paimon Sink"""</span>
        <span class="hljs-comment"># 这里使用Paimon的FlinkDataStreamSink</span>
        <span class="hljs-comment"># 实际使用时需要引入paimon-flink-runtime的相关依赖</span>
        <span class="hljs-keyword">return</span> PaimonStreamSink(
            catalog=<span class="hljs-string">'paimon_catalog'</span>,
            database=<span class="hljs-string">'default'</span>,
            table=table_name,
            options={
                <span class="hljs-string">'warehouse'</span>: <span class="hljs-string">'hdfs://namenode:8020/paimon'</span>,
                <span class="hljs-string">'bucket'</span>: <span class="hljs-string">'64'</span>,
                <span class="hljs-string">'file.compression'</span>: <span class="hljs-string">'lz4'</span>
            }
        )
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">submit_job</span>(<span class="hljs-params">self, env, job_name</span>):
        <span class="hljs-string">"""提交Flink任务"""</span>
        env.execute(job_name)

<span class="hljs-comment"># 辅助函数类</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DataCleaningFunction</span>(<span class="hljs-title class_ inherited__">MapFunction</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">map</span>(<span class="hljs-params">self, element</span>):
        <span class="hljs-comment"># ... 数据清洗逻辑</span>
        <span class="hljs-keyword">return</span> element

<span class="hljs-keyword">class</span> <span class="hljs-title class_">GeoEnrichmentFunction</span>(<span class="hljs-title class_ inherited__">MapFunction</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">map</span>(<span class="hljs-params">self, element</span>):
        <span class="hljs-comment"># 调用外部GeoIP或地理编码服务</span>
        <span class="hljs-comment"># 填充location_latitude, location_longitude, detected_geo_keys</span>
        <span class="hljs-keyword">return</span> element

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DimensionScoreCalculator</span>(<span class="hljs-title class_ inherited__">WindowFunction</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">apply</span>(<span class="hljs-params">self, key, window, elements</span>):
        <span class="hljs-comment"># 在60秒窗口内计算LDI, CRI, GRI, FRI</span>
        <span class="hljs-comment"># 返回维度指标</span>
        <span class="hljs-keyword">yield</span> {
            <span class="hljs-string">'buyer_geo_key'</span>: key[<span class="hljs-number">0</span>],
            <span class="hljs-string">'commodity_type'</span>: key[<span class="hljs-number">1</span>],
            <span class="hljs-string">'window_end'</span>: window.end,
            <span class="hljs-string">'ldi_score'</span>: ...,
            <span class="hljs-string">'cri_score'</span>: ...,
            <span class="hljs-string">'gri_score'</span>: ...,
            <span class="hljs-string">'fri_score'</span>: ...
        }

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CompositeRiskCalculator</span>(<span class="hljs-title class_ inherited__">MapFunction</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">map</span>(<span class="hljs-params">self, element</span>):
        <span class="hljs-comment"># 综合计算: 40%(A+B)/2 + 60%(C+D)/2</span>
        element[<span class="hljs-string">'composite_risk_index'</span>] = (
            <span class="hljs-number">0.4</span> * (element[<span class="hljs-string">'ldi_score'</span>] + element[<span class="hljs-string">'cri_score'</span>]) / <span class="hljs-number">2</span> +
            <span class="hljs-number">0.6</span> * (element[<span class="hljs-string">'gri_score'</span>] + element[<span class="hljs-string">'fri_score'</span>]) / <span class="hljs-number">2</span>
        ) * <span class="hljs-number">10</span>
        
        <span class="hljs-comment"># 转换为预警等级</span>
        <span class="hljs-keyword">if</span> element[<span class="hljs-string">'composite_risk_index'</span>] &lt; <span class="hljs-number">25</span>:
            element[<span class="hljs-string">'risk_alert_level'</span>] = <span class="hljs-string">'Green'</span>
        <span class="hljs-keyword">elif</span> element[<span class="hljs-string">'composite_risk_index'</span>] &lt; <span class="hljs-number">50</span>:
            element[<span class="hljs-string">'risk_alert_level'</span>] = <span class="hljs-string">'Yellow'</span>
        <span class="hljs-keyword">elif</span> element[<span class="hljs-string">'composite_risk_index'</span>] &lt; <span class="hljs-number">75</span>:
            element[<span class="hljs-string">'risk_alert_level'</span>] = <span class="hljs-string">'Orange'</span>
        <span class="hljs-keyword">else</span>:
            element[<span class="hljs-string">'risk_alert_level'</span>] = <span class="hljs-string">'Red'</span>
        
        <span class="hljs-keyword">return</span> element

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AlertFormattingFunction</span>(<span class="hljs-title class_ inherited__">MapFunction</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">map</span>(<span class="hljs-params">self, element</span>):
        <span class="hljs-comment"># 格式化告警消息</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'alert_id'</span>: element[<span class="hljs-string">'event_id'</span>],
            <span class="hljs-string">'buyer_geo_key'</span>: element[<span class="hljs-string">'buyer_geo_key'</span>],
            <span class="hljs-string">'risk_score'</span>: element[<span class="hljs-string">'composite_risk_index'</span>],
            <span class="hljs-string">'timestamp'</span>: datetime.now().isoformat(),
            <span class="hljs-string">'message'</span>: <span class="hljs-string">f"Red Alert: Risk score <span class="hljs-subst">{element[<span class="hljs-string">'composite_risk_index'</span>]:<span class="hljs-number">.1</span>f}</span> for <span class="hljs-subst">{element[<span class="hljs-string">'buyer_geo_key'</span>]}</span>"</span>
        }

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MetricsFormattingFunction</span>(<span class="hljs-title class_ inherited__">MapFunction</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">map</span>(<span class="hljs-params">self, element</span>):
        <span class="hljs-comment"># 输出Prometheus格式的指标</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'metric'</span>: <span class="hljs-string">'mgir_composite_risk_index'</span>,
            <span class="hljs-string">'tags'</span>: {
                <span class="hljs-string">'buyer'</span>: element[<span class="hljs-string">'buyer_geo_key'</span>],
                <span class="hljs-string">'commodity'</span>: element[<span class="hljs-string">'commodity_type'</span>]
            },
            <span class="hljs-string">'value'</span>: element[<span class="hljs-string">'composite_risk_index'</span>],
            <span class="hljs-string">'timestamp'</span>: <span class="hljs-built_in">int</span>(datetime.now().timestamp())
        }

<span class="hljs-comment"># 主程序</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    pipeline = CompleteFlinKETLPipeline()
    env = pipeline.create_environment()
    env = pipeline.build_pipeline(env)
    pipeline.submit_job(env, <span class="hljs-string">'mgir_complete_etl_pipeline'</span>)
</code></pre>
<h4 data-id="heading-11">数据验证与质量检查</h4>
<pre><code class="hljs language-sql" lang="sql">在Paimon中执行数据质量检查:

```<span class="hljs-keyword">sql</span>
<span class="hljs-comment">-- 1. 数据新鲜度检查</span>
<span class="hljs-keyword">SELECT</span> 
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> total_events,
    <span class="hljs-built_in">MAX</span>(ingest_timestamp) <span class="hljs-keyword">as</span> latest_update,
    <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-operator">-</span> <span class="hljs-built_in">MAX</span>(ingest_timestamp) <span class="hljs-keyword">as</span> age_minutes
<span class="hljs-keyword">FROM</span> paimon_catalog.standardized_events
<span class="hljs-keyword">WHERE</span> risk_date <span class="hljs-operator">&gt;=</span> <span class="hljs-built_in">CURRENT_DATE</span> <span class="hljs-operator">-</span> <span class="hljs-type">INTERVAL</span> <span class="hljs-number">1</span> <span class="hljs-keyword">DAY</span>;

<span class="hljs-comment">-- 2. 去重检查</span>
<span class="hljs-keyword">SELECT</span> 
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> total_records,
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> event_id) <span class="hljs-keyword">as</span> unique_events,
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-operator">-</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> event_id) <span class="hljs-keyword">as</span> duplicate_count
<span class="hljs-keyword">FROM</span> paimon_catalog.standardized_events;

<span class="hljs-comment">-- 3. 分类覆盖率</span>
<span class="hljs-keyword">SELECT</span> 
    delivery_impact_dim,
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> count,
    ROUND(<span class="hljs-number">100.0</span> <span class="hljs-operator">*</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-operator">/</span> <span class="hljs-built_in">SUM</span>(<span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>)) <span class="hljs-keyword">OVER</span> (), <span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> percentage
<span class="hljs-keyword">FROM</span> paimon_catalog.standardized_events
<span class="hljs-keyword">WHERE</span> risk_date <span class="hljs-operator">&gt;=</span> <span class="hljs-built_in">CURRENT_DATE</span> <span class="hljs-operator">-</span> <span class="hljs-type">INTERVAL</span> <span class="hljs-number">7</span> <span class="hljs-keyword">DAY</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> delivery_impact_dim;

<span class="hljs-comment">-- 4. 置信度分布</span>
<span class="hljs-keyword">SELECT</span> 
    ROUND(<span class="hljs-built_in">AVG</span>(confidence_score_nlp), <span class="hljs-number">3</span>) <span class="hljs-keyword">as</span> avg_confidence,
    <span class="hljs-built_in">MIN</span>(confidence_score_nlp) <span class="hljs-keyword">as</span> min_confidence,
    <span class="hljs-built_in">MAX</span>(confidence_score_nlp) <span class="hljs-keyword">as</span> max_confidence,
    <span class="hljs-built_in">PERCENTILE_CONT</span>(<span class="hljs-number">0.95</span>) <span class="hljs-keyword">WITHIN</span> <span class="hljs-keyword">GROUP</span> (<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> confidence_score_nlp) <span class="hljs-keyword">as</span> p95
<span class="hljs-keyword">FROM</span> paimon_catalog.standardized_events
<span class="hljs-keyword">WHERE</span> risk_date <span class="hljs-operator">&gt;=</span> <span class="hljs-built_in">CURRENT_DATE</span> <span class="hljs-operator">-</span> <span class="hljs-type">INTERVAL</span> <span class="hljs-number">1</span> <span class="hljs-keyword">DAY</span>;


预期结果:
├─ 数据延迟 <span class="hljs-operator">&lt;</span><span class="hljs-number">5</span>分钟
├─ 去重率 <span class="hljs-operator">&gt;</span><span class="hljs-number">99</span><span class="hljs-operator">%</span>
├─ A<span class="hljs-operator">/</span>B<span class="hljs-operator">/</span>C<span class="hljs-operator">/</span>D分布 均匀 (各<span class="hljs-number">20</span><span class="hljs-number">-30</span><span class="hljs-operator">%</span>)
└─ 平均信心度 <span class="hljs-operator">&gt;</span><span class="hljs-number">0.7</span>
</code></pre>
<hr/>
<h2 data-id="heading-12">决策API与BI仪表板开发</h2>
<h3 data-id="heading-13">决策API设计与实现</h3>
<h4 data-id="heading-14">API规范设计</h4>
<pre><code class="hljs language-bash" lang="bash">RESTful API 设计:

1. /v1/risk/latest_alert
   ├─ 方法: GET
   ├─ 参数: geo_key (采购商ID)
   ├─ 返回:
   │  {
   │    <span class="hljs-string">"buyer_geo_key"</span>: <span class="hljs-string">"BUYER_SH_001"</span>,
   │    <span class="hljs-string">"composite_risk_index"</span>: 75.3,
   │    <span class="hljs-string">"risk_alert_level"</span>: <span class="hljs-string">"Red"</span>,
   │    <span class="hljs-string">"last_update"</span>: <span class="hljs-string">"2025-11-30T10:30:00Z"</span>,
   │    <span class="hljs-string">"top_triggers"</span>: [
   │      {
   │        <span class="hljs-string">"event_id"</span>: <span class="hljs-string">"evt_001"</span>,
   │        <span class="hljs-string">"source"</span>: <span class="hljs-string">"Reuters"</span>,
   │        <span class="hljs-string">"type"</span>: <span class="hljs-string">"A"</span>,
   │        <span class="hljs-string">"severity"</span>: 8.5
   │      }
   │    ]
   │  }
   ├─ 缓存: 1分钟
   └─ 实现: 从Doris直接查询

2. /v1/risk/events
   ├─ 方法: GET
   ├─ 参数:
   │  ├─ buyer (采购商ID)
   │  ├─ timeframe (24h/7d/30d)
   │  ├─ <span class="hljs-built_in">type</span> (A/B/C/D, 可选)
   │  └─ <span class="hljs-built_in">limit</span> (默认100)
   ├─ 返回: 该采购商在时间段内的所有触发事件列表
   └─ 实现: Doris查询 + 缓存

3. /v1/risk/forecast
   ├─ 方法: GET
   ├─ 参数:
   │  ├─ geo_key
   │  └─ days (1/7/30)
   ├─ 返回: 未来N天的风险预测
   │  {
   │    <span class="hljs-string">"forecast"</span>: [
   │      {<span class="hljs-string">"date"</span>: <span class="hljs-string">"2025-12-01"</span>, <span class="hljs-string">"predicted_risk"</span>: 52.3},
   │      {<span class="hljs-string">"date"</span>: <span class="hljs-string">"2025-12-02"</span>, <span class="hljs-string">"predicted_risk"</span>: 48.9}
   │    ],
   │    <span class="hljs-string">"confidence"</span>: 0.65
   │  }
   └─ 实现: 基于历史趋势的简单外推 (ARIMA或机器学习)

4. /v1/hedging/suggestion
   ├─ 方法: GET
   ├─ 参数:
   │  ├─ geo_key
   │  └─ commodity
   ├─ 返回:
   │  {
   │    <span class="hljs-string">"hedging_needed"</span>: <span class="hljs-literal">true</span>,
   │    <span class="hljs-string">"hedging_ratio"</span>: 0.35,  <span class="hljs-comment"># 建议对冲比例</span>
   │    <span class="hljs-string">"hedging_instrument"</span>: <span class="hljs-string">"futures"</span>,
   │    <span class="hljs-string">"futures_contract"</span>: <span class="hljs-string">"CRU_DEC25"</span>,
   │    <span class="hljs-string">"notional_value"</span>: 50000000,  <span class="hljs-comment"># 对冲名义价值</span>
   │    <span class="hljs-string">"estimated_cost"</span>: 125000  <span class="hljs-comment"># 对冲成本估计</span>
   │  }
   └─ 实现: 根据综合风险指数推荐

5. /v1/logistics/alternative_routes
   ├─ 方法: POST
   ├─ 请求体:
   │  {
   │    <span class="hljs-string">"origin_port"</span>: <span class="hljs-string">"Shanghai"</span>,
   │    <span class="hljs-string">"dest_port"</span>: <span class="hljs-string">"Rotterdam"</span>,
   │    <span class="hljs-string">"commodity"</span>: <span class="hljs-string">"Iron Ore"</span>,
   │    <span class="hljs-string">"current_risk_level"</span>: <span class="hljs-string">"Orange"</span>
   │  }
   ├─ 返回: 替代路线及成本对比
   │  {
   │    <span class="hljs-string">"routes"</span>: [
   │      {
   │        <span class="hljs-string">"route_id"</span>: <span class="hljs-string">"route_1"</span>,
   │        <span class="hljs-string">"waypoints"</span>: [<span class="hljs-string">"Shanghai"</span>, <span class="hljs-string">"Singapore"</span>, <span class="hljs-string">"Suez"</span>, <span class="hljs-string">"Rotterdam"</span>],
   │        <span class="hljs-string">"risk_score"</span>: 45,
   │        <span class="hljs-string">"duration_days"</span>: 35,
   │        <span class="hljs-string">"additional_cost_pct"</span>: 5.2,
   │        <span class="hljs-string">"feasibility"</span>: <span class="hljs-string">"high"</span>
   │      }
   │    ]
   │  }
   └─ 实现: 基于当前风险指数和运输网络的推荐
</code></pre>
<p>API实现 (Python FastAPI):</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI, Query
<span class="hljs-keyword">from</span> fastapi.responses <span class="hljs-keyword">import</span> JSONResponse
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> create_engine
<span class="hljs-keyword">import</span> sqlalchemy <span class="hljs-keyword">as</span> sa
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime, timedelta
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span>
<span class="hljs-keyword">import</span> json

app = FastAPI(title=<span class="hljs-string">'MGIR Decision API'</span>, version=<span class="hljs-string">'1.0.0'</span>)

<span class="hljs-comment"># Doris连接</span>
doris_engine = create_engine(<span class="hljs-string">'mysql+pymysql://root:password@doris_fe:9030/mgir'</span>)

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">'/v1/risk/latest_alert'</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_latest_alert</span>(<span class="hljs-params">geo_key: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""获取采购商最新风险评分"""</span>
    <span class="hljs-keyword">with</span> doris_engine.connect() <span class="hljs-keyword">as</span> conn:
        query = sa.text(<span class="hljs-string">'''
            SELECT 
                buyer_geo_key,
                composite_risk_index,
                CASE 
                    WHEN composite_risk_index &lt; 25 THEN 'Green'
                    WHEN composite_risk_index &lt; 50 THEN 'Yellow'
                    WHEN composite_risk_index &lt; 75 THEN 'Orange'
                    ELSE 'Red'
                END as risk_alert_level,
                MAX(ingest_timestamp) as last_update
            FROM mgir_indices_fact
            WHERE buyer_geo_key = :geo_key
                AND risk_date &gt;= CURDATE()
            LIMIT 1
        '''</span>)
        
        result = conn.execute(query, {<span class="hljs-string">'geo_key'</span>: geo_key}).fetchone()
        
        <span class="hljs-keyword">if</span> result:
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">'buyer_geo_key'</span>: result[<span class="hljs-number">0</span>],
                <span class="hljs-string">'composite_risk_index'</span>: <span class="hljs-built_in">float</span>(result[<span class="hljs-number">1</span>]),
                <span class="hljs-string">'risk_alert_level'</span>: result[<span class="hljs-number">2</span>],
                <span class="hljs-string">'last_update'</span>: result[<span class="hljs-number">3</span>].isoformat() <span class="hljs-keyword">if</span> result[<span class="hljs-number">3</span>] <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>
            }
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> {<span class="hljs-string">'error'</span>: <span class="hljs-string">'No data found'</span>}, <span class="hljs-number">404</span>

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">'/v1/risk/events'</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_risk_events</span>(<span class="hljs-params">
    buyer: <span class="hljs-built_in">str</span>,
    timeframe: <span class="hljs-built_in">str</span> = <span class="hljs-string">'24h'</span>,
    <span class="hljs-built_in">type</span>: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-literal">None</span>,
    limit: <span class="hljs-built_in">int</span> = <span class="hljs-number">100</span>
</span>):
    <span class="hljs-string">"""获取采购商的风险事件列表"""</span>
    <span class="hljs-keyword">if</span> timeframe == <span class="hljs-string">'24h'</span>:
        since = datetime.utcnow() - timedelta(hours=<span class="hljs-number">24</span>)
    <span class="hljs-keyword">elif</span> timeframe == <span class="hljs-string">'7d'</span>:
        since = datetime.utcnow() - timedelta(days=<span class="hljs-number">7</span>)
    <span class="hljs-keyword">elif</span> timeframe == <span class="hljs-string">'30d'</span>:
        since = datetime.utcnow() - timedelta(days=<span class="hljs-number">30</span>)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> {<span class="hljs-string">'error'</span>: <span class="hljs-string">'Invalid timeframe'</span>}, <span class="hljs-number">400</span>
    
    <span class="hljs-keyword">with</span> doris_engine.connect() <span class="hljs-keyword">as</span> conn:
        query_str = <span class="hljs-string">'''
            SELECT 
                event_id,
                ingest_timestamp,
                delivery_impact_dim,
                impact_severity_score,
                sentiment_score_nlp,
                source_url,
                confidence_score_nlp
            FROM mgir_indices_fact
            WHERE buyer_geo_key = :buyer
                AND ingest_timestamp &gt;= :since
        '''</span>
        
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>:
            query_str += <span class="hljs-string">f' AND delivery_impact_dim = :type'</span>
        
        query_str += <span class="hljs-string">f' ORDER BY ingest_timestamp DESC LIMIT <span class="hljs-subst">{limit}</span>'</span>
        
        params = {<span class="hljs-string">'buyer'</span>: buyer, <span class="hljs-string">'since'</span>: since}
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>:
            params[<span class="hljs-string">'type'</span>] = <span class="hljs-built_in">type</span>
        
        results = conn.execute(sa.text(query_str), params).fetchall()
        
        events = []
        <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> results:
            events.append({
                <span class="hljs-string">'event_id'</span>: row[<span class="hljs-number">0</span>],
                <span class="hljs-string">'timestamp'</span>: row[<span class="hljs-number">1</span>].isoformat(),
                <span class="hljs-string">'type'</span>: row[<span class="hljs-number">2</span>],
                <span class="hljs-string">'severity'</span>: <span class="hljs-built_in">float</span>(row[<span class="hljs-number">3</span>]),
                <span class="hljs-string">'sentiment'</span>: <span class="hljs-built_in">float</span>(row[<span class="hljs-number">4</span>]),
                <span class="hljs-string">'source'</span>: row[<span class="hljs-number">5</span>],
                <span class="hljs-string">'confidence'</span>: <span class="hljs-built_in">float</span>(row[<span class="hljs-number">6</span>])
            })
        
        <span class="hljs-keyword">return</span> {<span class="hljs-string">'events'</span>: events, <span class="hljs-string">'count'</span>: <span class="hljs-built_in">len</span>(events)}

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">'/v1/risk/forecast'</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_risk_forecast</span>(<span class="hljs-params">geo_key: <span class="hljs-built_in">str</span>, days: <span class="hljs-built_in">int</span> = <span class="hljs-number">7</span></span>):
    <span class="hljs-string">"""预测未来N天的风险趋势"""</span>
    <span class="hljs-keyword">with</span> doris_engine.connect() <span class="hljs-keyword">as</span> conn:
        <span class="hljs-comment"># 获取过去30天的数据用于趋势分析</span>
        query = sa.text(<span class="hljs-string">'''
            SELECT 
                DATE(risk_date) as date,
                AVG(composite_risk_index) as avg_risk
            FROM mgir_indices_fact
            WHERE buyer_geo_key = :geo_key
                AND risk_date &gt;= CURDATE() - INTERVAL 30 DAY
            GROUP BY DATE(risk_date)
            ORDER BY date DESC
        '''</span>)
        
        results = conn.execute(query, {<span class="hljs-string">'geo_key'</span>: geo_key}).fetchall()
        
        <span class="hljs-comment"># 简单的移动平均预测</span>
        historical_data = [(row[<span class="hljs-number">0</span>], <span class="hljs-built_in">float</span>(row[<span class="hljs-number">1</span>])) <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> results]
        
        forecast = []
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(historical_data) &gt;= <span class="hljs-number">7</span>:
            <span class="hljs-comment"># 计算最近7天的平均作为基准</span>
            recent_avg = <span class="hljs-built_in">sum</span>(v <span class="hljs-keyword">for</span> d, v <span class="hljs-keyword">in</span> historical_data[:<span class="hljs-number">7</span>]) / <span class="hljs-number">7</span>
            
            <span class="hljs-comment"># 简单的线性趋势</span>
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(days):
                future_date = datetime.utcnow().date() + timedelta(days=i+<span class="hljs-number">1</span>)
                <span class="hljs-comment"># 加入随机波动</span>
                predicted = recent_avg + (i * <span class="hljs-number">0.5</span>)  <span class="hljs-comment"># 每天趋势增加0.5分</span>
                forecast.append({
                    <span class="hljs-string">'date'</span>: future_date.isoformat(),
                    <span class="hljs-string">'predicted_risk'</span>: <span class="hljs-built_in">min</span>(<span class="hljs-number">100</span>, <span class="hljs-built_in">max</span>(<span class="hljs-number">0</span>, predicted))
                })
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'geo_key'</span>: geo_key,
            <span class="hljs-string">'forecast'</span>: forecast,
            <span class="hljs-string">'confidence'</span>: <span class="hljs-number">0.65</span> <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(historical_data) &gt;= <span class="hljs-number">7</span> <span class="hljs-keyword">else</span> <span class="hljs-number">0.35</span>
        }

<span class="hljs-comment"># 启动API服务</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    <span class="hljs-keyword">import</span> uvicorn
    uvicorn.run(app, host=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">8000</span>)
</code></pre>
<p>部署:</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 创建systemd服务</span>
sudo <span class="hljs-built_in">cat</span> &gt; /etc/systemd/system/mgir-api.service &lt;&lt; <span class="hljs-string">EOF
[Unit]
Description=MGIR Decision API
After=network.target

[Service]
Type=simple
User=api_user
WorkingDirectory=/opt/mgir-api
ExecStart=/usr/bin/python3 /opt/mgir-api/main.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF</span>

<span class="hljs-comment"># 2. 启动服务</span>
sudo systemctl start mgir-api
sudo systemctl <span class="hljs-built_in">enable</span> mgir-api

<span class="hljs-comment"># 3. 配置反向代理 (Nginx)</span>
sudo <span class="hljs-built_in">cat</span> &gt; /etc/nginx/sites-available/mgir-api &lt;&lt; <span class="hljs-string">EOF
upstream mgir_api {
    server localhost:8000;
}

server {
    listen 80;
    server_name api.mgir.internal;

    location / {
        proxy_pass http://mgir_api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_buffering off;
    }
}
EOF</span>

sudo <span class="hljs-built_in">ln</span> -s /etc/nginx/sites-available/mgir-api /etc/nginx/sites-enabled/
sudo systemctl reload nginx
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[n8n 实战：工作流自动发布排版精美的公众号文章]]></title>    <link>https://juejin.cn/post/7579473409749696563</link>    <guid>https://juejin.cn/post/7579473409749696563</guid>    <pubDate>2025-12-04T00:29:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579473409749696563" data-draft-id="7579512734296113190" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="n8n 实战：工作流自动发布排版精美的公众号文章"/> <meta itemprop="keywords" content="工作流引擎,人工智能"/> <meta itemprop="datePublished" content="2025-12-04T00:29:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="曹工不加班"/> <meta itemprop="url" content="https://juejin.cn/user/4336129588870957"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            n8n 实战：工作流自动发布排版精美的公众号文章
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4336129588870957/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    曹工不加班
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-04T00:29:24.000Z" title="Thu Dec 04 2025 00:29:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-04
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这一篇紧接着上一期的内容。</p>
<p>上一期我们搞定了科技早报的自动生成，很多同学跑通后跟我反馈：“曹工，图是有了，但发公众号还是很繁琐啊。”</p>
<p>确实，要把图片保存下来，去公众号后台新建图文，手动把新闻一条条复制进去，还得处理外部链接不能跳转的问题，最后还得手动裁剪封面图。这一套下来，没个二十分钟搞不定。</p>
<p>既然要做自动化，就得做得彻底一点。今天我们要实现的效果是：<strong>上一个工作流生成图片后，自动触发这个工作流，完成公众号图文的排版、封面上传、链接转二维码、最后直接生成一篇“待发布”的草稿。</strong></p>
<p>你要做的，只是在手机上预览一下，检查图片是否有缺陷，原文二维码识别跳转是否正常，就可以直接发表了。</p>
<h3 data-id="heading-0">核心难点与解决方案</h3>
<p>在开始连线之前，有两个痛点必须先说清楚，否则后面的配置你可能会看不懂：</p>
<ol>
<li><strong>外链跳转问题</strong>：微信文章内部不支持直接跳外部新闻链接。
<ul>
<li><em>解法</em>：把每一条新闻的链接自动转成二维码图片，放在标题旁边，用户长按识别即可。</li>
</ul>
</li>
<li><strong>封面图裁剪问题</strong>：通过接口上传封面，文章默认的封面裁剪可能是在中间，不能很好的展现封面图。
<ul>
<li><em>解法</em>：这里需要用到一个取巧的方法，手动抓取微信后台的裁剪参数（下文会详细教）。</li>
</ul>
</li>
</ol>
<p>先看一眼最终做出来的草稿效果，左边新闻，右边二维码，底部还自动挂了名片：</p>
<p><img src="https://pic.fmcat.top/picgo/20251202220030975.png" alt="" loading="lazy"/></p>
<h3 data-id="heading-1">准备工作：安装社区节点</h3>
<p>n8n 原生并没有对接微信公众号和生成二维码的功能，我们需要安装两个社区贡献的节点。</p>
<p>点击左侧菜单的 <strong>Settings</strong> -&gt; <strong>Community Nodes</strong> -&gt; <strong>Install</strong>，分别搜索并安装：</p>
<ol>
<li><code>n8n-nodes-wechat</code> (用于操作公众号接口)</li>
<li><code>n8n-nodes-qrcode-generator</code> (用于把链接转成二维码图片)
<img src="https://pic.fmcat.top/picgo/20251202220637860.png" alt="" loading="lazy"/></li>
</ol>
<p>安装完如果没有搜到相关节点可以重启一下 n8n。</p>
<h2 data-id="heading-2">搭建流程</h2>
<p>先看看工作流的全貌</p>
<p><img src="https://pic.fmcat.top/picgo/20251203213331932.png" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">第一步：接收数据与环境初始化</h3>
<p>这个工作流不是独立运行的，它是被上一个“早报生成”工作流触发的。</p>
<p><strong>Execute Workflow Trigger (工作流被调用)</strong>
这个节点作为入口，接收上游传来的两个核心数据：</p>
<ul>
<li><code>newsList</code>：包含所有新闻标题和链接的数组。</li>
<li><code>picUrl</code>：上一道工序生成好的早报长图链接，封面和内容长图都用这个。</li>
</ul>
<p><img src="https://pic.fmcat.top/picgo/20251202221516464.png" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">第二步：拆解数据，逐条处理</h3>
<p>因为新闻是“一堆”数据，而生成二维码需要“一条一条”来，所以这里需要把数组拆散。</p>
<p><strong>Split Out (拆分数据)</strong></p>
<ul>
<li><strong>Field to Split Out</strong>: 填入 <code>newsList</code>。
这一步把原本的一条包含 10 个新闻的数据，拆成了 10 条独立的数据流。</li>
</ul>
<p><img src="https://pic.fmcat.top/picgo/20251202222143931.png" alt="" loading="lazy"/></p>
<p>注意节点间连接线上的项目数量，经过这个节点处理，变成了 10 个项目，每个项目都是一条独立的新闻。</p>
<p><strong>Loop Over Items (循环处理)</strong>
这是一个容器节点，所有在它里面的操作，都会对每一条新闻执行一次。</p>
<ul>
<li><strong>Batch Size</strong>: 设为 <code>1</code>，保证顺序处理。</li>
<li>把节点的 Loop 端点连到下一个生成二维码的节点上，每一次循环会传递单条新闻数据。</li>
</ul>
<p><img src="https://pic.fmcat.top/picgo/20251202223808210.png" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">第三步：循环内的核心操作（链接转码）</h3>
<p>接下来的三个节点都在 <code>Loop</code> 循环内部，逻辑非常紧凑：<strong>拿链接 -&gt; 转成码 -&gt; 传给微信 -&gt; 拿到微信图片链接</strong>。</p>
<p><img src="https://pic.fmcat.top/picgo/20251202224257869.png" alt="" loading="lazy"/></p>
<p><strong>QR Code Generator (生成原文链接二维码)</strong>
这是刚才安装的社区节点。</p>
<ul>
<li><strong>Content</strong>: 填当前循环的新闻的 <code>link</code> 字段</li>
<li><strong>Width</strong>: 设置为 <code>300</code> 像素足够了，足够长按识别。
这一步会直接输出一个图片的二进制文件（Binary Data）。</li>
</ul>
<p><img src="https://pic.fmcat.top/picgo/20251202225150051.png" alt="" loading="lazy"/></p>
<p><strong>上传图文消息图片 (WeChat)</strong>
注意，刚刚生成的二维码是在 n8n 的内存里，需要上传为微信图文消息图片，获取到图片链接才可以插入文章里。</p>
<ul>
<li><strong>Binary Property</strong>: 填入 <code>data</code>（这是上一个节点输出图片时的默认属性名）。
执行后，微信会返回一个 <code>url</code>，这个 URL 才是能在公众号文章里显示的图片地址。</li>
</ul>
<p><img src="https://pic.fmcat.top/picgo/20251202225820939.png" alt="" loading="lazy"/></p>
<p>注意所有微信相关操作的节点都要选择凭证，使用<strong>微信开发者平台</strong>（12 月 1 日起所有开发相关的配置都挪到这了）里获取 AppID 和 AppSecret，并且把 n8n 运行机器所在的公网 IP 配置到白名单内。
<img src="https://pic.fmcat.top/picgo/20251202230551237.png" alt="" loading="lazy"/></p>
<p><img src="https://pic.fmcat.top/picgo/20251202231133398.png" alt="" loading="lazy"/></p>
<p><strong>Edit Fields (拼装新闻标题和链接)</strong>
一条新闻跑完所有流程后，我们需要整理一下输出给下一步的数据。
保留两个字段：</p>
<ol>
<li><code>title</code>: 新闻标题。</li>
<li><code>qr_url</code>: 刚才微信返回的那个图片 URL。</li>
</ol>
<p><img src="https://pic.fmcat.top/picgo/20251202231713406.png" alt="" loading="lazy"/></p>
<p>循环执行完成以后，所有新闻的原文链接被替换成了微信提供的二维码访问链接</p>
<p><img src="https://pic.fmcat.top/picgo/20251202232537375.png" alt="" loading="lazy"/></p>
<p>其实 n8n 的设计原则是默认支持循环执行节点的，这块要单独添加循环是因为上传图文消息这个节点不能根据前面传入的项目数量自动运行多次，所有需要手动设计循环流程让每次只处理一个新闻，最后再合并，就没问题了。</p>
<h3 data-id="heading-6">第四步：AI 智能排版</h3>
<p>当所有循环跑完，我们用 <strong>Aggregate</strong> 节点把散落的数据重新聚合起来。现在我们手里有了一个包含所有标题和对应二维码 URL 的列表。</p>
<p>这一步是为了让大模型能拿到完整的新闻列表，如果不合并，后面的 AI Agent 节点会对每个新闻运行一次，这样不符合我们汇总拼接的目的。</p>
<p><img src="https://pic.fmcat.top/picgo/20251203215845296.png" alt="" loading="lazy"/></p>
<p>拿到了新闻标题和原文的二维码链接，怎么把它们变成漂亮的表格？手写 HTML 拼接太累了，这种脏活累活交给 AI 就行了。</p>
<p><strong>AI Agent (排版引擎)</strong></p>
<p>添加 AI Agent 节点，按下图设置，注意 allNews 拖进来以后外面要加上一层 <code>JSON. stringify()</code> m，否则大模型不能准确拿到 JSON 里的内容。</p>
<p><img src="https://pic.fmcat.top/picgo/20251203220536708.png" alt="" loading="lazy"/></p>
<p><strong>Chat Model 端点</strong>连接一个大模型，这里我使用了 Gemini，你用 DeepSeek 也可以。</p>
<p><strong>格式化端点</strong>的选择与填写参考下图</p>
<p><img src="https://pic.fmcat.top/picgo/20251203222117948.png" alt="" loading="lazy"/></p>
<p>我在大模型的系统提示词 Prompt 里写得非常具体，让大模型组装一个标准的 HTML Table。
第一列放新闻标题，第二列放一个 img 标签，src 为这条新闻对应的原文链接生成的二维码，最后拼接为完整的表格结构内容放入 content 字段。</p>
<p>AI 就帮我们把十条新闻瞬间拼成了一段整洁的 HTML 代码，并且从传入的 markdown 内容内提取早报图片的 URL 放入 pic_url 字段。</p>
<p><img src="https://pic.fmcat.top/picgo/20251203220744556.png" alt="20251203220744556.png" loading="lazy"/></p>
<p>早报图片链接原内容为 markdown 格式：</p>
<pre><code class="hljs language-less" lang="less">!<span class="hljs-selector-attr">[image]</span>(<span class="hljs-attribute">https</span>:<span class="hljs-comment">//googlecdn2.datas.systems/storage/response_images/644/2025/12/02/1764691118947519493_6982.png)</span>
</code></pre>
<p>大模型会把 <code>https://googlecdn2.datas.systems/storage/response_images/644/2025/12/02/1764691118947519493_6982.png</code> 部分提取出来，可以复制出来测试一下在浏览器是否能访问。</p>
<h3 data-id="heading-7">第五步：处理封面图（硬核知识点）</h3>
<p>新闻正文搞定了，现在处理封面，因为公众号文章的封面是要使用永久素材的 media_id，所以我们要先把早报的图片上传到微信服务器，获取 media_id 和常规 URL，后续正文内也要用到。</p>
<p><strong>HTTP Request (下载封面)</strong></p>
<p>大模型提取出来的封面链接只是一个 URL，我们需要把它下载成二进制文件。</p>
<ul>
<li><strong>URL</strong>: 填入 <code>picUrl</code>。</li>
<li><strong>Response Format</strong>: 选择 <code>File</code>。</li>
<li/>
</ul>
<p><img src="https://pic.fmcat.top/picgo/20251203222548967.png" alt="" loading="lazy"/></p>
<h4 data-id="heading-8">Edit Image(调整图片大小)</h4>
<p>因为前面的工作流画的早报图片是 4K 高清，图片会比较大，上传微信服务器的时候会报图片太大的错，所以这边添加一个编辑图片的节点，选择 Resize，将图片的尺寸调整到 2K 左右，这样图片的大小就不会超标了。</p>
<p><img src="https://pic.fmcat.top/picgo/20251203223259443.png" alt="" loading="lazy"/></p>
<p><strong>上传永久素材 (WeChat)</strong></p>
<p>把刚才调整完大小的图片传到微信素材库， 这里微信会返回一个 <code>media_id</code>，这是封面的唯一身份证，后面的步骤要用到。</p>
<p><img src="https://pic.fmcat.top/picgo/20251203223730377.png" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">第六步：生成草稿与发布</h3>
<p>终于到了最后一步，把所有东西组装起来。</p>
<p><strong>新增文章 (WeChat)</strong></p>
<ul>
<li><strong>标题</strong>: 可以用表达式自动生成日期，如 <code>{{ $now.format('yyyy年MM月dd日') }} 科技早报</code>。</li>
<li><strong>消息内容</strong>: 插入要展示的早报图片，再把刚才 AI 拼接好的 HTML 字符串也添加到指定的位置。你还可以在前后加上一些固定的头部或尾部（比如“关注曹工不加班”的引导语）。</li>
<li><strong>封面媒体ID</strong>: 填入上一步获取的 <code>media_id</code>。</li>
</ul>
<p><img src="https://pic.fmcat.top/picgo/20251203225257365.png" alt="" loading="lazy"/></p>
<p>下面是消息内容的详细配置</p>
<p><img src="https://pic.fmcat.top/picgo/20251203225444501.png" alt="" loading="lazy"/></p>
<p><strong>关键点：如何达到最好的封面裁切效果？</strong></p>
<p>公众号文章的封面有两个尺寸，具体看下图，合并发布时作为第一个文章时为 <code>2.35:1</code>, 后续文章或者分享出去的卡片封面为 <code>1:1</code>，我们需要获取到封面图裁剪的参数，才能达到最佳展示效果。</p>
<p><img src="https://pic.fmcat.top/picgo/20251203234521192.png" alt="20251203234521192.png" loading="lazy"/></p>
<p>像我的早报顶部有标题和日期，用来做封面图正好，所以这个地方裁剪顶部区域即可，裁剪的参数自己计算有点麻烦，这边有个取巧的方法</p>
<p><strong>获取方法：</strong></p>
<ol>
<li>打开 Chrome 浏览器，登录公众号后台，打开新建文章的编辑器页面。</li>
<li>按 F12 打开开发者工具，切换到 Network 面板。</li>
<li>把工作流生成的图片（尺寸需要固定，至少比例需要固定）添加到封面图并裁剪。</li>
<li>在 Network 里找到上传请求，查看 Payload，复制里面的两组参数用下划线连接。</li>
<li>把这个两个值分别填回 n8n 的对应字段里。</li>
</ol>
<p><img src="https://pic.fmcat.top/picgo/20251203235603629.png" alt="" loading="lazy"/></p>
<p><img src="https://pic.fmcat.top/picgo/20251203235610937.png" alt="" loading="lazy"/></p>
<p><strong>发送钉钉消息</strong></p>
<p>最后，调用 HTTP Request 节点通过钉钉机器人的 Webhook 自己发个通知，告诉自己草稿已经上传完成，审核一下没有问题，就可以发表了。</p>
<p><img src="https://pic.fmcat.top/picgo/20251204000257190.png" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">总结</h2>
<p>这套流程跑通后，以前繁琐的排版工作就变成了全自动，解决了从生成到发布最后一公里的痛点。</p>
<p>这套工作流的 JSON 文件，我都打包好了，关注公众号“<strong>曹工不加班</strong>” 发送 “02” 即可获取，直接拿去导入就能用，有问题可以直接公众号私信我。</p>
<p>感谢同学们能看到最后，曹工不加班，点个关注早点下班～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI Coding与单元测试的协同进化：从验证到驱动]]></title>    <link>https://juejin.cn/post/7579920818870534186</link>    <guid>https://juejin.cn/post/7579920818870534186</guid>    <pubDate>2025-12-05T05:51:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579920818870534186" data-draft-id="7579846221168640054" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI Coding与单元测试的协同进化：从验证到驱动"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-05T05:51:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="美团技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/3509296845313741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI Coding与单元测试的协同进化：从验证到驱动
            <!----> <!----></h1> <div class="container team-follow" data-v-d326b38e="" data-v-61fb5e44=""><div class="left" data-v-d326b38e=""><a href="/team/6930512966122995712/posts" data-v-d326b38e=""><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/47ccb42d726640a7889ba1e64ae203e6~tplv-k3u1fbpfcp-watermark.image" class="icon" data-v-d326b38e=""/></a> <div class="content" data-v-d326b38e=""><div style="display: flex" data-v-d326b38e=""><a href="/team/6930512966122995712/posts" data-v-d326b38e=""><p class="title-line" data-v-d326b38e=""><span title="美团技术团队" class="title" data-v-d326b38e="">美团技术团队</span> <img src="//lf-web-assets.juejin.cn/obj/juejin-web/xitu_juejin_web/255e400027b783cbad76dc41527e7695.svg" alt="team icon" class="team-icon" data-v-d326b38e=""/></p></a></div> <div class="meta-box team" data-v-d326b38e="" data-v-61fb5e44=""><time datetime="2025-12-05T05:51:31.000Z" title="Fri Dec 05 2025 05:51:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-d326b38e="" data-v-61fb5e44="">
                2025-12-05
              </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-d326b38e="" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/></svg> <span class="views-count" style="display:none;" data-v-d326b38e="" data-v-61fb5e44="">
                0
              </span> <span class="read-time" data-v-d326b38e="" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-d326b38e="" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-d326b38e="" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-d326b38e="" data-v-61fb5e44=""/></svg>
                阅读21分钟
              </span> <!----> <!----></div></div></div> <button class="jj-follow-button follow-btn" style="display:none;" data-v-b60b2868="" data-v-d326b38e=""><span data-v-b60b2868="" data-v-d326b38e=""><i class="byte-icon byte-icon--plus" data-v-d326b38e=""><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 48 48"><path fill="none" d="M0 0h48v48H0z"/><path d="M24.7 4c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8V22h16.7c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8v1.4c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1H26v16.7c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1h-1.4c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8V26H5.3c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8v-1.4c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1H22V5.3c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1h1.4z"/></svg></i>
        关注
      </span></button></div> <div class="team-user block-hidden" data-v-61fb5e44=""><div class="avatar jj-avatar avatar" data-v-03256cc6="" data-v-61fb5e44=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="avatar" class="lazy avatar-img" data-v-5244ef91="" data-v-03256cc6=""/> </div> <!----> <span class="position ellipsis" data-v-61fb5e44="">
              美团小编 @美团
            </span></div> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>AI生成代码质量难以把控！本文分享来自美团的技术实践，三大策略破解AI编程痛点。单测快速验证逻辑正确性，安全网保护存量代码演进，TDD模式精准传递需求。告别「看起来没问题」的错觉，构建AI时代的代码质量保障体系。</p>
</blockquote>
<h2 data-id="heading-0">一、引言</h2>
<p>目前，国内外很多AI Coding助手能在几秒钟内生成完整代码块，大大提升了开发效率，但这种高速开发模式也带来了潜在风险——与人工编码不同是，AI Coding助手生成代码存在两个特殊风险：其一，AI Coding助手依赖于上下文与模型自身的能力，输出的代码质量相对不可控。其二，AI生成的代码虽然逻辑通顺、结构完整，但可能隐藏着难以察觉的边界问题或逻辑缺陷。</p>
<p><strong>核心问题：我们如何快速的验证AI生成代码的质量和可靠性？</strong></p>
<p>本文旨在分享如何借助单元测试，让AI编程合作更高效可靠，主要解决三个常见痛点：</p>
<ol>
<li><strong>肉眼审查困境</strong>：AI一次性生成大量代码时，难以快速准确判断逻辑完备性；</li>
<li><strong>存量代码信任危机</strong>：如何验证AI修改老代码时，不会产生非预期的结果；</li>
<li><strong>需求传达难题</strong>：如何精准向AI表达复杂需求并快速验证。</li>
</ol>
<p>针对上述三个常见痛点，本文提出采用不同的单元测试策略来应对以上问题。每个策略都针对一个特定痛点设计：策略一通过测试解决肉眼审查的局限性；策略二构建单测安全网应对存量代码的信任问题；策略三则采用TDD模式优化需求传达与验证流程。下文将依次展开说明，希望能对大家有所帮助或启发。</p>
<h2 data-id="heading-1">二、策略一：单测检验AI代码逻辑正确性</h2>
<h3 data-id="heading-2">2.1 问题背景</h3>
<p>传统的人工代码审查在AI生成的大量代码面前显得低效且不可靠。在软件测试实践中，有着测试左移（Shift Left Testing）的概念，本质上是借助工具和测试手段更早地发现问题和预防问题。在AI Coding时代，这一理念尤为关键：跳过单元测试直接集成测试看似"抄近路"，实则是将风险后置——开发阶段几分钟能发现的Bug，在集成测试环境可能需要较长定位修复，这中间包含了代码部署、环境准备、测试条件的准备、问题定位、开发人员修复、再次部署验证等一系列漫长的环节。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf06fb9bdf25441089c1e673219ed865~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518691&amp;x-signature=PSSeuYCvFTfPj6FpnIZvRjo%2B6yo%3D" alt="" loading="lazy"/></p>
<p>相比之下，单元测试具有独特的优势：它能够独立运行、快速验证结果，并且可以无限次重复执行。这种测试方式就像是为项目进行的一次性投资，却能为整个开发周期构建起一张可靠的“安全网”。它不仅能实时验证AI Coding生成的代码是否正确，更能持续保障未来代码的质量稳定性，让开发团队始终对代码库保持信心。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8e14e0feeea4de78ad048f9236831e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518691&amp;x-signature=7sCwXzVNWX1KJLXAWrSQpsEx3f0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">2.2 案例：分页查询接口的隐蔽Bug</h3>
<p><strong>任务背景</strong>：实现一个支持多条件筛选的复杂分页查询接口pageQueryRobot</p>
<p>AI生成了如下核心查询逻辑：</p>
<pre><code class="hljs language-scss" lang="scss">public List&lt;AgentRobotE&gt; <span class="hljs-built_in">pageQueryRobotsByCondition</span>(List&lt;Long&gt; shopIds, String chatSceneCode,
        Boolean enabled, Integer pageNo, Integer pageSize) {
    <span class="hljs-comment">// ... 前置校验代码 ...</span>

    <span class="hljs-comment">// 分页查询机器人基础信息</span>
    int offset = (pageNo - <span class="hljs-number">1</span>) * pageSize;
    List&lt;AgentRobotEntity&gt; entities = robotIds<span class="hljs-selector-class">.stream</span>()
            <span class="hljs-selector-class">.skip</span>(offset)
            <span class="hljs-selector-class">.limit</span>(pageSize)
            <span class="hljs-selector-class">.map</span>(robotId -&gt; agentRobotDAO.getRobotById(robotId, false))
            <span class="hljs-selector-class">.filter</span>(Objects::nonNull)
            <span class="hljs-comment">// 问题代码：类型不匹配的隐蔽Bug</span>
            <span class="hljs-selector-class">.filter</span>(entity -&gt; enabled == null || Objects.equals(entity.getEnabled(), enabled ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>))
            .<span class="hljs-built_in">filter</span>(entity -&gt; Objects.<span class="hljs-built_in">equals</span>(entity.<span class="hljs-built_in">getChatSceneCode</span>(), chatSceneCode))
            .<span class="hljs-built_in">collect</span>(Collectors.<span class="hljs-built_in">toList</span>());

    return entities<span class="hljs-selector-class">.stream</span>()
            <span class="hljs-selector-class">.map</span>(this::convertToModel)
            <span class="hljs-selector-class">.filter</span>(Objects::nonNull)
            <span class="hljs-selector-class">.collect</span>(Collectors.toList());
}
</code></pre>
<p>问题分析：这段代码看起来逻辑完整，但第8行的过滤逻辑包含了多个复杂元素：</p>
<ul>
<li>三元运算符 enabled ? 1 : 0</li>
<li>Objects.equals 的使用</li>
<li>Boolean到Integer的隐式逻辑转换</li>
</ul>
<p>仅凭肉眼很难发现其中的类型不匹配问题。</p>
<p><strong>单元测试发现问题</strong>：通过AI编写了17个全面的单元测试用例，覆盖：</p>
<ul>
<li>正常场景：各种有效参数组合</li>
<li>边界场景：null值、空集合处理</li>
<li>参数组合：enabled为true/false/null的不同情况</li>
</ul>

<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Test</span>
public void testPageQueryWhenEnabledIsTrue() {
    <span class="hljs-comment">// arrange</span>
    List&lt;Long&gt; shopIds = Arrays<span class="hljs-selector-class">.asList</span>(<span class="hljs-number">12345</span>L, <span class="hljs-number">67890</span>L);
    String chatSceneCode = "SCENE_C";
    Boolean enabled = true;  <span class="hljs-comment">// 测试enabled为true的情况</span>

    <span class="hljs-comment">// 模拟数据库返回的实体，enabled字段为Boolean类型</span>
    AgentRobotEntity mockEntity = new <span class="hljs-built_in">AgentRobotEntity</span>();
    mockEntity<span class="hljs-selector-class">.setEnabled</span>(true);  <span class="hljs-comment">// 注意：这里是Boolean类型</span>
    mockEntity<span class="hljs-selector-class">.setChatSceneCode</span>("SCENE_C");

    <span class="hljs-built_in">when</span>(agentRobotDAO.getRobotById(anyLong(), <span class="hljs-built_in">eq</span>(false)))<span class="hljs-selector-class">.thenReturn</span>(mockEntity);

    <span class="hljs-comment">// act</span>
    List&lt;AgentRobotE&gt; result = repository<span class="hljs-selector-class">.pageQueryRobotsByCondition</span>(
        shopIds, chatSceneCode, enabled, <span class="hljs-number">1</span>, <span class="hljs-number">10</span>);

    <span class="hljs-comment">// assert - 这个测试失败了！</span>
    <span class="hljs-built_in">assertEquals</span>(<span class="hljs-number">1</span>, result.size());  <span class="hljs-comment">// 期望返回1个结果，实际返回0个</span>
}
</code></pre>
<p><strong>测试运行结果</strong>：当enabled为true时测试失败！</p>
<p><strong>问题定位</strong>：通过测试失败，快速定位到过滤逻辑的问题：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">// 错误的逻辑：entity.getEnabled()返回<span class="hljs-type">Boolean</span>类型，但与<span class="hljs-type">Integer</span>比较
Objects.<span class="hljs-keyword">equals</span>(entity.getEnabled(), enabled ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>)
// 当enabled=<span class="hljs-literal">true</span>时，比较的是 Objects.<span class="hljs-keyword">equals</span>(<span class="hljs-type">Boolean</span>.<span class="hljs-literal">TRUE</span>, <span class="hljs-number">1</span>) -&gt; <span class="hljs-literal">false</span>
// 当enabled=<span class="hljs-literal">false</span>时，比较的是 Objects.<span class="hljs-keyword">equals</span>(<span class="hljs-type">Boolean</span>.<span class="hljs-literal">TRUE</span>, <span class="hljs-number">0</span>) -&gt; <span class="hljs-literal">false</span>
</code></pre>
<p>正确修复：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 修复后：直接比较Boolean类型</span>
.filter(entity -&gt; enabled == <span class="hljs-literal">null</span> || Objects.<span class="hljs-keyword">equals</span>(entity.getEnabled(), enabled))
</code></pre>
<p><strong>意外收获</strong>：在审查测试覆盖的代码时，还发现了N+1查询的性能问题：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 存在性能问题的代码</span>
.<span class="hljs-built_in">map</span>(robotId -&gt; agentRobotDAO.getRobotById(robotId, <span class="hljs-literal">false</span>))  <span class="hljs-comment">// 每个robotId单独查询</span>
</code></pre>
<p><strong>成果验证</strong>：修复后，所有17个单元测试用例全部通过，代码质量得到保障。</p>
<h2 data-id="heading-4">三、策略二：构建安全网保护存量代码</h2>
<h3 data-id="heading-5">3.1 问题场景</h3>
<p>AI对存量代码的修改挑战更大。AI看到的可能只是函数或类的局部，无法理解背后的业务规则和历史包袱。如何放心的让AI修改已有的代码？</p>
<p><strong>在进行AI Coding前，需要确保旧有逻辑，处于单元测试的完全覆盖保护中</strong>，这就像在开启汽车的“自动辅助驾驶”功能前，必须先系好安全带一样。这条“安全带”就是我们完善的、可运行的单元测试集。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be3f772c9bb64bfaa97fa109f593fc95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518691&amp;x-signature=UXRloKXsww7tNUTUEnXBpFiQmdM%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>快速验证，精准反馈</strong>：AI生成修改后的代码无需人工逐行对比，只需运行单元测试即可获得即时反馈。测试失败的用例直接揭示AI修改中存在的问题——要么触及了不应改动的逻辑，要么未能正确实现预期变更。这种反馈机制既高效又客观。</li>
<li><strong>清晰界定修改边界</strong>：单元测试结果帮助我们明确判断——AI的修改是否精准实现了目标？在引入新功能的同时是否完整保留了原有逻辑？通过区分预期内的失败（主动修改旧逻辑）和意外失败（破坏现有功能），我们获得了优化AI方案的明确方向，大幅提升了迭代效率。</li>
</ul>
<h3 data-id="heading-6">3.2 案例：延迟回复策略的用户范围扩展</h3>
<p><strong>业务背景</strong>：需要将消息延迟回复服务从原来的平台A、平台B的用户扩展到平台C用户。</p>
<p><strong>原始代码分析：</strong></p>
<pre><code class="hljs language-ini" lang="ini">// TextDelayReplyStrategy.java 中的核心逻辑
private boolean needSkip(ChatHistoryE chatHistoryE) {
    UserDTO <span class="hljs-attr">UserDTO</span> = UserHelper.parseUser(chatHistoryE.getUserId())<span class="hljs-comment">;</span>
    return MessageSendDirectionEnum.CLIENT_SEND.value != chatHistoryE.getMessageStatus()
               || <span class="hljs-attr">MessageShieldEnum.RECEIVER_SHIELD.value</span> == chatHistoryE.getShield()
               || <span class="hljs-attr">UserDTO</span> == null
               || !UserType.isLoginUser(UserDTO.getUserType())<span class="hljs-comment">;  // 关键判断逻辑</span>
}
</code></pre>
<p>这个needSkip方法决定了哪些用户类型需要跳过延迟回复处理。原逻辑中，UserType.isLoginUser()只覆盖平台A、平台B的登录用户，不包括平台C用户。</p>
<p><strong>修改前的安全网构建：</strong></p>
<p>按照“分析-测试-实施-验证”方法论，首先完善单元测试：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 针对现有逻辑的保护性测试</span>
<span class="hljs-keyword">@Test</span>
public void testNeedSkipWithAUser() {
    <span class="hljs-comment">// 平台A用户不应被跳过</span>
    ChatHistoryE chatHistory = <span class="hljs-built_in">buildChatHistory</span>(A_USER_ID);
    <span class="hljs-built_in">assertFalse</span>(strategy.needSkip(chatHistory));
}

<span class="hljs-keyword">@Test</span>
public void testNeedSkipWithBUser() {
    <span class="hljs-comment">// 平台B用户不应被跳过</span>
    ChatHistoryE chatHistory = <span class="hljs-built_in">buildChatHistory</span>(B_USER_ID);
    <span class="hljs-built_in">assertFalse</span>(strategy.needSkip(chatHistory));
}

<span class="hljs-keyword">@Test</span>
public void testNeedSkipWithCUser() {
    <span class="hljs-comment">// 平台C在修改前应被跳过</span>
    ChatHistoryE chatHistory = <span class="hljs-built_in">buildChatHistory</span>(C_USER_ID);
    <span class="hljs-built_in">assertTrue</span>(strategy.needSkip(chatHistory));  <span class="hljs-comment">// 修改前的预期行为</span>
}

<span class="hljs-keyword">@Test</span>
public void testNeedSkipWithGuestUser() {
    <span class="hljs-comment">// 游客用户应被跳过</span>
    ChatHistoryE chatHistory = <span class="hljs-built_in">buildChatHistory</span>(GUEST_USER_ID);
    <span class="hljs-built_in">assertTrue</span>(strategy.needSkip(chatHistory));
}
</code></pre>
<p>运行基线测试：确保所有测试通过，建立基线状态</p>
<pre><code class="hljs language-yaml" lang="yaml">[<span class="hljs-string">INFO</span>] <span class="hljs-attr">Tests run:</span> <span class="hljs-number">15</span><span class="hljs-string">,</span> <span class="hljs-attr">Failures:</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-attr">Errors:</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-attr">Skipped:</span> <span class="hljs-number">0</span>
[<span class="hljs-string">INFO</span>] <span class="hljs-string">所有现有逻辑测试通过，可以安全修改</span>
</code></pre>
<p>AI辅助修改实施：</p>
<p>向AI提供需求："将平台C用户也纳入延迟回复服务范围"</p>
<p>AI分析代码后给出修改方案：</p>
<pre><code class="hljs language-ini" lang="ini">// 修改后的代码
private boolean needSkip(ChatHistoryE chatHistoryE) {
    UserDTO <span class="hljs-attr">UserDTO</span> = UserHelper.parseUser(chatHistoryE.getUserId())<span class="hljs-comment">;</span>
    return MessageSendDirectionEnum.CLIENT_SEND.value != chatHistoryE.getMessageStatus()
               || <span class="hljs-attr">MessageShieldEnum.RECEIVER_SHIELD.value</span> == chatHistoryE.getShield()
               || <span class="hljs-attr">UserDTO</span> == null
               || !UserType.isAorBorCLoginUser(UserDTO.getUserType())<span class="hljs-comment">;  // 扩展用户范围</span>
}
</code></pre>
<p>验证阶段的精准反馈：</p>
<p>修改后运行测试集：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 运行结果</span>
[<span class="hljs-string">INFO</span>] <span class="hljs-attr">Tests run:</span> <span class="hljs-number">15</span><span class="hljs-string">,</span> <span class="hljs-attr">Failures:</span> <span class="hljs-number">1</span><span class="hljs-string">,</span> <span class="hljs-attr">Errors:</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-attr">Skipped:</span> <span class="hljs-number">0</span>
[<span class="hljs-string">ERROR</span>] <span class="hljs-attr">testNeedSkipWithCProviderUser:</span> <span class="hljs-string">expected:&lt;true&gt;</span> <span class="hljs-string">but</span> <span class="hljs-string">was:&lt;false&gt;</span>
</code></pre>
<p>结果分析：</p>
<p>✅ testNeedSkipWithAUser - 通过（平台A用户逻辑未变）
✅ testNeedSkipWithBUser - 通过（平台B用户逻辑未变）
❌ testNeedSkipWithCUser - 失败（平台C预期的变更）
✅ testNeedSkipWithGuestUser - 通过（游客用户逻辑未变）</p>
<p>更新期望值：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Test</span>
public void testNeedSkipWithCUser() {
    <span class="hljs-comment">// 修改后：平台C不应被跳过</span>
    ChatHistoryE chatHistory = <span class="hljs-built_in">buildChatHistory</span>(C_USER_ID);
    <span class="hljs-built_in">assertFalse</span>(strategy.needSkip(chatHistory));  <span class="hljs-comment">// 更新期望值</span>
}
</code></pre>
<p>最终验证：</p>
<pre><code class="hljs language-yaml" lang="yaml">[<span class="hljs-string">INFO</span>] <span class="hljs-attr">Tests run:</span> <span class="hljs-number">15</span><span class="hljs-string">,</span> <span class="hljs-attr">Failures:</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-attr">Errors:</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-attr">Skipped:</span> <span class="hljs-number">0</span>
[<span class="hljs-string">INFO</span>] <span class="hljs-string">所有测试通过，修改安全完成</span>
</code></pre>
<p>这种方法将开发者从“担心AI改坏代码”的不信任中解放出来，明确知道哪些功能被影响，哪些保持不变，实现安全、高效的存量代码演进。</p>
<h2 data-id="heading-7">四、策略三：TDD思想驱动AI开发</h2>
<h3 data-id="heading-8">4.1 “先生成，后验证”的局限</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7096cd7855594bd0b53d79fd1d7870a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518691&amp;x-signature=5LNtwMgsobxL3LgE3fa2Lp7VVmU%3D" alt="" loading="lazy"/></p>
<p>前面两节所提到的策略可以归类为"先生成，后验证"，在一定的场景下仍然存在两个问题：</p>
<ul>
<li><strong>提示词驱动</strong>：开发者反复修改自然语言描述，AI产出不确定，返工频繁；</li>
<li><strong>肉眼审查</strong>：生成测试用例仍然需要人工验证，一旦用例较多，效率依然低下。</li>
</ul>
<h3 data-id="heading-9">4.2 TDD模式的革命性转变</h3>
<p><strong>TDD 核心理念：</strong></p>
<ul>
<li><strong>测试先行</strong>：先写测试，再写实现代码。</li>
<li><strong>小步快跑</strong>：以微小增量推进开发，每次只解决一个问题。</li>
<li><strong>设计驱动</strong>：测试即需求文档，驱动接口设计和代码结构。</li>
<li><strong>安全网</strong>：测试集提供即时反馈，支持安全重构。</li>
</ul>
<p>整个开发过程严格遵循 Red -&gt; Green -&gt; Refactor 的循环。</p>
<ul>
<li>🔴 Red: 先编写一个失败的单元测试，用代码来定义我们期望实现的功能。</li>
<li>🟢 Green: 编写最精简的业务代码，让测试恰好通过。</li>
<li>🔵 Refactor: 在测试持续通过的前提下，重构优化代码的设计和质量。</li>
</ul>
<p>借助测试<strong>驱动开发（TDD）思想</strong>，我们先为AI提供一份清晰、无歧义的“需求说明书”和“验收标准”，然后指导它进行代码的生成。这个过程的核心是“🔴 红-🟢 绿-🔵 重构”循环，它将我们的每一次的对话，都转化为一次可验证的、可累加的进步。采用“先验证，后实现”的<strong>红-绿-重构</strong>循环，将模糊的需求转化为精确的代码语言。</p>
<h3 data-id="heading-10">4.3 案例：优惠券使用规则引擎的复杂逻辑</h3>
<p><strong>业务需求</strong>：开发一个智能优惠券使用规则引擎，支持"多券叠加使用和最优组合推荐"</p>
<p><strong>传统困难</strong>：</p>
<ul>
<li>自然语言描述：“实现优惠券规则引擎，支持多种券类型的叠加使用，并智能推荐最优使用方案”</li>
<li>AI需要猜测：哪些券可以叠加？什么是“最优”？有哪些使用限制？</li>
<li>反复沟通：多次修改提示词，AI理解仍然偏离业务实际</li>
</ul>
<p><strong>第一次尝试</strong>：AI理解为“简单累加所有优惠”</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// AI第一次实现 - 过于简化</span>
public BigDecimal <span class="hljs-built_in">calculateDiscount</span>(Order order, List&lt;Coupon&gt; coupons) {
    return coupons<span class="hljs-selector-class">.stream</span>()
        <span class="hljs-selector-class">.map</span>(coupon -&gt; coupon.getDiscountAmount())
        <span class="hljs-selector-class">.reduce</span>(BigDecimal.ZERO, BigDecimal::add);
}
<span class="hljs-comment">// 问题：忽略了券的使用条件、互斥规则、叠加限制</span>
</code></pre>
<p><strong>第二次尝试</strong>：AI理解为“选择面额最大的券”</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// AI第二次实现 - 逻辑错误</span>
public List&lt;Coupon&gt; <span class="hljs-built_in">selectOptimalCoupons</span>(Order order, List&lt;Coupon&gt; availableCoupons) {
    return availableCoupons<span class="hljs-selector-class">.stream</span>()
        <span class="hljs-selector-class">.filter</span>(coupon -&gt; order.getTotalAmount()<span class="hljs-selector-class">.compareTo</span>(coupon.getMinOrderAmount()) &gt;= <span class="hljs-number">0</span>)
        <span class="hljs-selector-class">.max</span>(Comparator.comparing(Coupon::getDiscountAmount))
        <span class="hljs-selector-class">.map</span>(List::of)
        <span class="hljs-selector-class">.orElse</span>(Collections.emptyList());
}
<span class="hljs-comment">// 问题：只考虑单券最大优惠，未考虑多券组合的更优效果</span>
</code></pre>
<p><strong>第三次尝试</strong>：AI尝试复杂逻辑但引入更多问题</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// AI第三次实现 - 逻辑混乱</span>
<span class="hljs-keyword">public</span> <span class="hljs-title class_">CouponUsageResult</span> <span class="hljs-title function_">applyCoupons</span>(<span class="hljs-params">Order order, List&lt;Coupon&gt; coupons</span>) {
    <span class="hljs-comment">// 各种复杂的if-else嵌套，但缺乏清晰的业务规则</span>
    <span class="hljs-comment">// 没有处理券的互斥关系</span>
    <span class="hljs-comment">// 没有考虑计算顺序对最终优惠的影响</span>
    <span class="hljs-comment">// 边界条件处理不当</span>
}
</code></pre>
<p>经过多轮提示词优化，每次都需要重新解释复杂的业务规则，仍不满足预期。</p>
<p>TDD方式的完整循环：</p>
<p>🔴 红色阶段：用测试定义需求</p>
<p>编写测试用例，精确定义复杂的业务规则：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Test</span>
public void <span class="hljs-built_in">testCouponUsageWithBasicStackingRules</span>() {
    <span class="hljs-comment">// 构造订单：总价100元，包含数码产品</span>
    <span class="hljs-selector-tag">Order</span> <span class="hljs-selector-tag">order</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">Order</span>()
        <span class="hljs-selector-class">.setTotalAmount</span>(new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"100.00"</span>))
        <span class="hljs-selector-class">.addItem</span>(<span class="hljs-string">"数码产品"</span>, new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"100.00"</span>));
    
    <span class="hljs-comment">// 构造可用优惠券</span>
    <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">Coupon</span>&gt; <span class="hljs-selector-tag">availableCoupons</span> = <span class="hljs-selector-tag">Arrays</span><span class="hljs-selector-class">.asList</span>(
        new <span class="hljs-built_in">Coupon</span>().<span class="hljs-built_in">setType</span>(<span class="hljs-string">"满减券"</span>).<span class="hljs-built_in">setCondition</span>(<span class="hljs-string">"满50减10"</span>).<span class="hljs-built_in">setDiscountAmount</span>(new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"10"</span>)),
        new <span class="hljs-built_in">Coupon</span>().<span class="hljs-built_in">setType</span>(<span class="hljs-string">"打折券"</span>).<span class="hljs-built_in">setCondition</span>(<span class="hljs-string">"数码类9折"</span>).<span class="hljs-built_in">setDiscountRate</span>(new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"0.9"</span>)),
        new <span class="hljs-built_in">Coupon</span>().<span class="hljs-built_in">setType</span>(<span class="hljs-string">"免邮券"</span>).<span class="hljs-built_in">setCondition</span>(<span class="hljs-string">"免运费"</span>).<span class="hljs-built_in">setDiscountAmount</span>(new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"5"</span>))
    );
    
    <span class="hljs-comment">// 期望结果：满减券和免邮券可叠加，打折券与满减券互斥，应选择最优组合</span>
    <span class="hljs-selector-tag">CouponUsageResult</span> <span class="hljs-selector-tag">result</span> = <span class="hljs-selector-tag">CouponEngine</span><span class="hljs-selector-class">.calculateOptimalUsage</span>(order, availableCoupons);
    
    <span class="hljs-comment">// 验证最优方案：使用打折券+免邮券 (90+0=90元，比满减券+免邮券的85元更优)</span>
    <span class="hljs-selector-tag">assertEquals</span>(<span class="hljs-number">2</span>, result.<span class="hljs-built_in">getUsedCoupons</span>().<span class="hljs-built_in">size</span>());
    <span class="hljs-selector-tag">assertTrue</span>(result.<span class="hljs-built_in">getUsedCoupons</span>().<span class="hljs-built_in">stream</span>().<span class="hljs-built_in">anyMatch</span>(c -&gt; <span class="hljs-string">"打折券"</span>.<span class="hljs-built_in">equals</span>(c.<span class="hljs-built_in">getType</span>())));
    <span class="hljs-selector-tag">assertTrue</span>(result.<span class="hljs-built_in">getUsedCoupons</span>().<span class="hljs-built_in">stream</span>().<span class="hljs-built_in">anyMatch</span>(c -&gt; <span class="hljs-string">"免邮券"</span>.<span class="hljs-built_in">equals</span>(c.<span class="hljs-built_in">getType</span>())));
    <span class="hljs-selector-tag">assertEquals</span>(new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"95.00"</span>), result.<span class="hljs-built_in">getFinalAmount</span>()); <span class="hljs-comment">// 100*0.9 + 0 - 5运费</span>
}

@<span class="hljs-selector-tag">Test</span>  
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">testCouponMutualExclusionRules</span>() {
    <span class="hljs-selector-tag">Order</span> <span class="hljs-selector-tag">order</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">Order</span>()<span class="hljs-selector-class">.setTotalAmount</span>(new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"200.00"</span>));
    
    <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">Coupon</span>&gt; <span class="hljs-selector-tag">availableCoupons</span> = <span class="hljs-selector-tag">Arrays</span><span class="hljs-selector-class">.asList</span>(
        new <span class="hljs-built_in">Coupon</span>().<span class="hljs-built_in">setType</span>(<span class="hljs-string">"满减券"</span>).<span class="hljs-built_in">setCondition</span>(<span class="hljs-string">"满100减30"</span>).<span class="hljs-built_in">setDiscountAmount</span>(new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"30"</span>)),
        new <span class="hljs-built_in">Coupon</span>().<span class="hljs-built_in">setType</span>(<span class="hljs-string">"打折券"</span>).<span class="hljs-built_in">setCondition</span>(<span class="hljs-string">"全场8折"</span>).<span class="hljs-built_in">setDiscountRate</span>(new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"0.8"</span>)),
        new <span class="hljs-built_in">Coupon</span>().<span class="hljs-built_in">setType</span>(<span class="hljs-string">"新用户专享"</span>).<span class="hljs-built_in">setCondition</span>(<span class="hljs-string">"首单5折"</span>).<span class="hljs-built_in">setDiscountRate</span>(new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"0.5"</span>))
    );
    
    <span class="hljs-selector-tag">CouponUsageResult</span> <span class="hljs-selector-tag">result</span> = <span class="hljs-selector-tag">CouponEngine</span><span class="hljs-selector-class">.calculateOptimalUsage</span>(order, availableCoupons);
    
    <span class="hljs-comment">// 验证互斥规则：新用户券与其他券互斥，且优惠最大，应该单独使用</span>
    <span class="hljs-selector-tag">assertEquals</span>(<span class="hljs-number">1</span>, result.<span class="hljs-built_in">getUsedCoupons</span>().<span class="hljs-built_in">size</span>());
    <span class="hljs-selector-tag">assertEquals</span>(<span class="hljs-string">"新用户专享"</span>, result.<span class="hljs-built_in">getUsedCoupons</span>().<span class="hljs-built_in">get</span>(<span class="hljs-number">0</span>).<span class="hljs-built_in">getType</span>());
    <span class="hljs-selector-tag">assertEquals</span>(new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"100.00"</span>), result.<span class="hljs-built_in">getFinalAmount</span>()); <span class="hljs-comment">// 200 * 0.5</span>
}

@<span class="hljs-selector-tag">Test</span>
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">testCouponUsageConditionValidation</span>() {
    <span class="hljs-selector-tag">Order</span> <span class="hljs-selector-tag">order</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">Order</span>()
        <span class="hljs-selector-class">.setTotalAmount</span>(new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"30.00"</span>))
        <span class="hljs-selector-class">.setUserLevel</span>(<span class="hljs-string">"普通用户"</span>)
        <span class="hljs-selector-class">.addItem</span>(<span class="hljs-string">"服装"</span>, new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"30.00"</span>));
    
    <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">Coupon</span>&gt; <span class="hljs-selector-tag">availableCoupons</span> = <span class="hljs-selector-tag">Arrays</span><span class="hljs-selector-class">.asList</span>(
        new <span class="hljs-built_in">Coupon</span>().<span class="hljs-built_in">setCondition</span>(<span class="hljs-string">"满50减10"</span>), <span class="hljs-comment">// 不满足金额条件</span>
        new <span class="hljs-built_in">Coupon</span>().<span class="hljs-built_in">setCondition</span>(<span class="hljs-string">"VIP专享9折"</span>), <span class="hljs-comment">// 不满足用户等级条件  </span>
        new <span class="hljs-built_in">Coupon</span>().<span class="hljs-built_in">setCondition</span>(<span class="hljs-string">"数码类8折"</span>), <span class="hljs-comment">// 不满足品类条件</span>
        new <span class="hljs-built_in">Coupon</span>().<span class="hljs-built_in">setCondition</span>(<span class="hljs-string">"无门槛5元券"</span>).<span class="hljs-built_in">setDiscountAmount</span>(new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"5"</span>)) <span class="hljs-comment">// 满足条件</span>
    );
    
    <span class="hljs-selector-tag">CouponUsageResult</span> <span class="hljs-selector-tag">result</span> = <span class="hljs-selector-tag">CouponEngine</span><span class="hljs-selector-class">.calculateOptimalUsage</span>(order, availableCoupons);
    
    <span class="hljs-comment">// 验证条件判断：只有无门槛券可用</span>
    <span class="hljs-selector-tag">assertEquals</span>(<span class="hljs-number">1</span>, result.<span class="hljs-built_in">getUsedCoupons</span>().<span class="hljs-built_in">size</span>());
    <span class="hljs-selector-tag">assertEquals</span>(<span class="hljs-string">"无门槛5元券"</span>, result.<span class="hljs-built_in">getUsedCoupons</span>().<span class="hljs-built_in">get</span>(<span class="hljs-number">0</span>).<span class="hljs-built_in">getCondition</span>());
    <span class="hljs-selector-tag">assertEquals</span>(new <span class="hljs-built_in">BigDecimal</span>(<span class="hljs-string">"25.00"</span>), result.<span class="hljs-built_in">getFinalAmount</span>());
}
</code></pre>
<p>运行测试：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">[<span class="hljs-keyword">ERROR</span>] testCouponUsageWithBasicStackingRules: 
<span class="hljs-keyword">Class</span> CouponEngine doesn<span class="hljs-comment">'t exist</span>
[<span class="hljs-keyword">ERROR</span>] testCouponMutualExclusionRules:
Method calculateOptimalUsage <span class="hljs-built_in">not</span> found
</code></pre>
<p>红色阶段成功：测试失败，但复杂的业务规则已经通过代码精确表达。</p>
<p>🟢 绿色阶段：AI精确实现</p>
<p>将失败的测试用例提供给AI：“请实现CouponEngine.calculateOptimalUsage方法，让这些测试通过”</p>
<p>AI分析测试用例后，精确理解了复杂的业务规则：</p>
<ol>
<li>券类型包括满减券、打折券、免邮券、新用户券等</li>
<li>不同券有不同的叠加和互斥规则</li>
<li>需要验证使用条件（金额、用户等级、商品类别）</li>
<li>要计算最优的券使用组合</li>
</ol>
<p>AI生成的实现方案：</p>
<pre><code class="hljs language-scss" lang="scss">public class CouponEngine {
    public static CouponUsageResult <span class="hljs-built_in">calculateOptimalUsage</span>(Order order, List&lt;Coupon&gt; availableCoupons) {
        <span class="hljs-comment">// 1. 过滤出满足使用条件的券</span>
        List&lt;Coupon&gt; eligibleCoupons = availableCoupons<span class="hljs-selector-class">.stream</span>()
            <span class="hljs-selector-class">.filter</span>(coupon -&gt; isEligible(order, coupon))
            <span class="hljs-selector-class">.collect</span>(Collectors.toList());
        
        <span class="hljs-comment">// 2. 生成所有可能的券组合（考虑互斥规则）</span>
        List&lt;List&lt;Coupon&gt;&gt; validCombinations = <span class="hljs-built_in">generateValidCombinations</span>(eligibleCoupons);
        
        <span class="hljs-comment">// 3. 计算每种组合的最终优惠，选择最优方案</span>
        return validCombinations<span class="hljs-selector-class">.stream</span>()
            <span class="hljs-selector-class">.map</span>(combination -&gt; calculateResult(order, combination))
            <span class="hljs-selector-class">.min</span>(Comparator.comparing(CouponUsageResult::getFinalAmount))
            <span class="hljs-selector-class">.orElse</span>(new CouponUsageResult(order.getTotalAmount(), Collections<span class="hljs-selector-class">.emptyList</span>()));
    }
    
    private static boolean <span class="hljs-built_in">isEligible</span>(Order order, Coupon coupon) {
        String condition = coupon<span class="hljs-selector-class">.getCondition</span>();
        
        <span class="hljs-comment">// 金额条件检查</span>
        if (condition.contains("满") &amp;&amp; condition<span class="hljs-selector-class">.contains</span>("减")) {
            BigDecimal minAmount = <span class="hljs-built_in">extractMinAmount</span>(condition);
            if (order.getTotalAmount()<span class="hljs-selector-class">.compareTo</span>(minAmount) &lt; <span class="hljs-number">0</span>) return false;
        }
        
        <span class="hljs-comment">// 用户等级检查</span>
        if (condition.contains("VIP") &amp;&amp; !"VIP用户"<span class="hljs-selector-class">.equals</span>(order.getUserLevel())) {
            return false;
        }
        
        <span class="hljs-comment">// 商品类别检查</span>
        if (condition.contains("数码类") &amp;&amp; !<span class="hljs-attribute">order</span><span class="hljs-selector-class">.hasCategory</span>("数码产品")) {
            return false;
        }
        
        return true;
    }
    
    private static List&lt;List&lt;Coupon&gt;&gt; <span class="hljs-built_in">generateValidCombinations</span>(List&lt;Coupon&gt; coupons) {
        List&lt;List&lt;Coupon&gt;&gt; combinations = new ArrayList&lt;&gt;();
        
        <span class="hljs-comment">// 生成所有子集组合</span>
        for (int i = <span class="hljs-number">0</span>; i &lt; Math.pow(<span class="hljs-number">2</span>, coupons.size()); <span class="hljs-selector-tag">i</span>++) {
            List&lt;Coupon&gt; combination = new ArrayList&lt;&gt;();
            for (int j = <span class="hljs-number">0</span>; j &lt; coupons.size(); j++) {
                if ((i &amp; (<span class="hljs-number">1</span> &lt;&lt; j)) != <span class="hljs-number">0</span>) {
                    combination<span class="hljs-selector-class">.add</span>(coupons.get(j));
                }
            }
            
            <span class="hljs-comment">// 检查组合是否符合互斥规则</span>
            if (isValidCombination(combination)) {
                combinations<span class="hljs-selector-class">.add</span>(combination);
            }
        }
        
        return combinations;
    }
    
    private static boolean <span class="hljs-built_in">isValidCombination</span>(List&lt;Coupon&gt; combination) {
        <span class="hljs-comment">// 检查互斥规则</span>
        boolean hasDiscountCoupon = combination<span class="hljs-selector-class">.stream</span>()<span class="hljs-selector-class">.anyMatch</span>(c -&gt; "打折券".equals(c.getType()));
        boolean hasReduceCoupon = combination<span class="hljs-selector-class">.stream</span>()<span class="hljs-selector-class">.anyMatch</span>(c -&gt; "满减券".equals(c.getType()));
        boolean hasNewUserCoupon = combination<span class="hljs-selector-class">.stream</span>()<span class="hljs-selector-class">.anyMatch</span>(c -&gt; "新用户专享".equals(c.getType()));
        
        <span class="hljs-comment">// 新用户券与其他券互斥</span>
        if (hasNewUserCoupon &amp;&amp; combination.size() &gt; <span class="hljs-number">1</span>) {
            return false;
        }
        
        <span class="hljs-comment">// 打折券与满减券互斥</span>
        if (hasDiscountCoupon &amp;&amp; hasReduceCoupon) {
            return false;
        }
        
        return true;
    }
    
    private static CouponUsageResult <span class="hljs-built_in">calculateResult</span>(Order order, List&lt;Coupon&gt; usedCoupons) {
        BigDecimal finalAmount = <span class="hljs-attribute">order</span><span class="hljs-selector-class">.getTotalAmount</span>();
        
        <span class="hljs-comment">// 按照优先级顺序应用优惠</span>
        for (Coupon coupon : usedCoupons) {
            if ("打折券".equals(coupon.getType())) {
                finalAmount = finalAmount<span class="hljs-selector-class">.multiply</span>(coupon.getDiscountRate());
            } else if ("满减券".equals(coupon.getType()) || "无门槛<span class="hljs-number">5</span>元券"<span class="hljs-selector-class">.equals</span>(coupon.getCondition())) {
                finalAmount = finalAmount<span class="hljs-selector-class">.subtract</span>(coupon.getDiscountAmount());
            } else if ("免邮券".equals(coupon.getType())) {
                <span class="hljs-comment">// 免邮券单独处理运费</span>
                finalAmount = finalAmount<span class="hljs-selector-class">.subtract</span>(coupon.getDiscountAmount());
            }
        }
        
        return new <span class="hljs-built_in">CouponUsageResult</span>(finalAmount, usedCoupons);
    }
}
</code></pre>
<p>运行测试：</p>
<pre><code class="hljs language-yaml" lang="yaml">[<span class="hljs-string">INFO</span>] <span class="hljs-attr">Tests run:</span> <span class="hljs-number">3</span><span class="hljs-string">,</span> <span class="hljs-attr">Failures:</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-attr">Errors:</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-attr">Skipped:</span> <span class="hljs-number">0</span>
[<span class="hljs-string">INFO</span>] <span class="hljs-string">All</span> <span class="hljs-string">tests</span> <span class="hljs-string">passed!</span>
</code></pre>
<p>绿色阶段成功：测试通过，复杂的业务逻辑完全正确。</p>
<p>🔵 重构阶段：优化代码质量</p>
<p>在测试保护下，对AI生成的代码进行质量优化：</p>
<pre><code class="hljs language-scss" lang="scss">public class CouponEngine {
    <span class="hljs-comment">// 提取常量，增强可读性</span>
    private static final Set&lt;String&gt; MUTUALLY_EXCLUSIVE_TYPES = Set<span class="hljs-selector-class">.of</span>("打折券", "满减券");
    private static final String NEW_USER_COUPON_TYPE = "新用户专享";
    
    public static CouponUsageResult <span class="hljs-built_in">calculateOptimalUsage</span>(Order order, List&lt;Coupon&gt; availableCoupons) {
        if (CollectionUtils.isEmpty(availableCoupons)) {
            return new <span class="hljs-built_in">CouponUsageResult</span>(order.getTotalAmount(), Collections<span class="hljs-selector-class">.emptyList</span>());
        }
        
        <span class="hljs-comment">// 使用策略模式优化条件验证</span>
        List&lt;Coupon&gt; eligibleCoupons = availableCoupons<span class="hljs-selector-class">.stream</span>()
            <span class="hljs-selector-class">.filter</span>(coupon -&gt; CouponValidator.isEligible(order, coupon))
            <span class="hljs-selector-class">.collect</span>(Collectors.toList());
        
        <span class="hljs-comment">// 使用组合算法优化券组合生成</span>
        List&lt;List&lt;Coupon&gt;&gt; validCombinations = CouponCombinator<span class="hljs-selector-class">.generateValidCombinations</span>(eligibleCoupons);
        
        <span class="hljs-comment">// 使用计算引擎优化折扣计算</span>
        return validCombinations<span class="hljs-selector-class">.stream</span>()
            <span class="hljs-selector-class">.map</span>(combination -&gt; DiscountCalculator.calculateResult(order, combination))
            <span class="hljs-selector-class">.min</span>(Comparator.comparing(CouponUsageResult::getFinalAmount))
            <span class="hljs-selector-class">.orElse</span>(new CouponUsageResult(order.getTotalAmount(), Collections<span class="hljs-selector-class">.emptyList</span>()));
    }
}

<span class="hljs-comment">// 职责分离：券验证器</span>
class CouponValidator {
    public static boolean <span class="hljs-built_in">isEligible</span>(Order order, Coupon coupon) {
        return AmountValidator<span class="hljs-selector-class">.validate</span>(order, coupon) &amp;&amp;
               UserLevelValidator<span class="hljs-selector-class">.validate</span>(order, coupon) &amp;&amp;
               CategoryValidator<span class="hljs-selector-class">.validate</span>(order, coupon);
    }
}

<span class="hljs-comment">// 职责分离：券组合器</span>
class CouponCombinator {
    public static List&lt;List&lt;Coupon&gt;&gt; <span class="hljs-built_in">generateValidCombinations</span>(List&lt;Coupon&gt; coupons) {
        return PowerSetGenerator<span class="hljs-selector-class">.generate</span>(coupons)<span class="hljs-selector-class">.stream</span>()
            <span class="hljs-selector-class">.filter</span>(MutualExclusionChecker::isValidCombination)
            <span class="hljs-selector-class">.collect</span>(Collectors.toList());
    }
}

<span class="hljs-comment">// 职责分离：折扣计算器</span>
class DiscountCalculator {
    public static CouponUsageResult <span class="hljs-built_in">calculateResult</span>(Order order, List&lt;Coupon&gt; usedCoupons) {
        <span class="hljs-comment">// 按优先级排序券，确保计算顺序正确</span>
        List&lt;Coupon&gt; sortedCoupons = usedCoupons<span class="hljs-selector-class">.stream</span>()
            <span class="hljs-selector-class">.sorted</span>(Comparator.comparing(CouponPriorityResolver::getPriority))
            <span class="hljs-selector-class">.collect</span>(Collectors.toList());
        
        BigDecimal finalAmount = <span class="hljs-attribute">order</span><span class="hljs-selector-class">.getTotalAmount</span>();
        
        for (Coupon coupon : sortedCoupons) {
            finalAmount = <span class="hljs-built_in">applyCouponDiscount</span>(finalAmount, coupon);
        }
        
        return new <span class="hljs-built_in">CouponUsageResult</span>(finalAmount, usedCoupons);
    }
    
    private static BigDecimal <span class="hljs-built_in">applyCouponDiscount</span>(BigDecimal currentAmount, Coupon coupon) {
        return CouponTypeHandler<span class="hljs-selector-class">.getHandler</span>(coupon.getType())
            <span class="hljs-selector-class">.applyDiscount</span>(currentAmount, coupon);
    }
}
</code></pre>
<p>重构验证：</p>
<pre><code class="hljs language-yaml" lang="yaml">[<span class="hljs-string">INFO</span>] <span class="hljs-attr">Tests run:</span> <span class="hljs-number">3</span><span class="hljs-string">,</span> <span class="hljs-attr">Failures:</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-attr">Errors:</span> <span class="hljs-number">0</span><span class="hljs-string">,</span> <span class="hljs-attr">Skipped:</span> <span class="hljs-number">0</span>
[<span class="hljs-string">INFO</span>] <span class="hljs-string">重构完成，测试持续通过，代码结构更清晰，职责分离更明确</span>
</code></pre>
<p>协作模式转变：开发者不再需要为如何描述复杂的业务规则而烦恼，现在只需专注于设计精确的测试场景——我们负责定义“做什么”和“预期结果”，而AI则负责实现具体的“怎么做”。这种明确的分工让复杂逻辑的开发变得既可控又高效。</p>
<p>通过这种方式，我们能够确保：</p>
<ol>
<li>需求表达精准无歧义</li>
<li>边界条件全面覆盖</li>
<li>实现过程完全可控</li>
<li>重构过程安全可靠</li>
</ol>
<p>当需要开发新场景时，只需新增测试用例即可，完全不必担心会破坏原有逻辑。这种开发模式不仅提升了效率，更确保了系统的稳定性和可维护性。</p>
<h2 data-id="heading-11">五、实践要点</h2>
<h3 data-id="heading-12">5.1 环境配置</h3>
<p>确保AI Agent能执行<code>mvn test</code>命令</p>
<p>设定明确的行为准则（Rule），让AI能够知道我们现在遵循的开发范式，防止AI为了通过测试"作弊"修改业务代码。一个借助TDD思想驱动代码生成的执行准则如下</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section"># AI Agent 行为准则：TDD 测试驱动开发</span>

<span class="hljs-section">## 1. 总则</span>

<span class="hljs-section">### 1.1. 概述</span>
为了确保 AI Agent 遵循 TDD（测试驱动开发）的开发模式，Agent 必须严格按照 <span class="hljs-strong">**Red-Green-Refactor**</span> 三个阶段的循环进行开发。在执行每个阶段前，Agent 必须向开发者明确声明其当前所处的阶段。

本准则旨在确保 Agent 遵循正确的 TDD 开发流程，避免跳过关键步骤。

<span class="hljs-section">### 1.2. 环境配置：强制使用指定的 settings.xml</span>
<span class="hljs-strong">**核心要求**</span>: 所有对 <span class="hljs-code">`mvn@ 命令的调用（如 mvn test@, mvn compile@ 等），都**必须**使用 --settings@ (或 -s@) 参数来指定一个自定义的 settings.xml`</span> 文件，以确保能够访问内部的 Maven 仓库。

<span class="hljs-bullet">-</span> <span class="hljs-strong">**命令格式示例**</span>: <span class="hljs-code">`mvn --settings [settings.xml的绝对路径] test`</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**`settings.xml` 文件路径**</span>: <span class="hljs-code">`[settings.xml的绝对路径]`</span>

Agent 在执行任何 Maven 命令前，必须确认此路径已被正确配置和使用。

---

<span class="hljs-section">## 2. TDD 三阶段循环</span>

<span class="hljs-section">### 2.1. 第一阶段：RED (写失败的测试)</span>

<span class="hljs-section">#### 2.1.1. 目标</span>
编写一个<span class="hljs-strong">**必然失败**</span>的测试用例，明确定义即将实现的功能需求。

<span class="hljs-section">#### 2.1.2. 核心准则</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**允许**</span>: Agent 可以在 <span class="hljs-code">`src/test/`</span> 目录下创建新的测试文件或添加新的测试方法
<span class="hljs-bullet">-</span> <span class="hljs-strong">**要求**</span>:
<span class="hljs-bullet">  -</span> 测试必须是失败的（因为对应的实现代码尚未存在或不完整）
<span class="hljs-bullet">  -</span> 一次只测试一个功能点
<span class="hljs-bullet">  -</span> 测试代码要简单清晰
<span class="hljs-bullet">  -</span> 测试名称要明确表达测试意图
<span class="hljs-bullet">-</span> <span class="hljs-strong">**禁止**</span>: Agent <span class="hljs-strong">**不能**</span>修改 <span class="hljs-code">`src/main/`</span> 目录下的任何现有代码
<span class="hljs-bullet">-</span> <span class="hljs-strong">**验证**</span>: 运行测试必须显示红色（失败状态）

<span class="hljs-section">#### 2.1.3. 交互示例</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**开发者提示**</span>: "我需要实现一个计算器的加法功能"
<span class="hljs-bullet">-</span> <span class="hljs-strong">**Agent 回应**</span>: "已激活 <span class="hljs-strong">**RED 阶段**</span>。我将先编写一个失败的测试用例来定义加法功能的需求。"

<span class="hljs-section">### 2.2. 第二阶段：GREEN (让测试通过的最简实现)</span>

<span class="hljs-section">#### 2.2.1. 目标</span>
编写<span class="hljs-strong">**最简单**</span>的实现代码，让当前失败的测试通过。

<span class="hljs-section">#### 2.2.2. 核心准则</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**允许**</span>: Agent 可以创建、修改 <span class="hljs-code">`src/main/`</span> 目录下的代码
<span class="hljs-bullet">-</span> <span class="hljs-strong">**要求**</span>:
<span class="hljs-bullet">  -</span> 优先考虑最简单的实现方式
<span class="hljs-bullet">  -</span> 专注于满足当前测试用例
<span class="hljs-bullet">  -</span> 快速实现功能让测试通过
<span class="hljs-bullet">-</span> <span class="hljs-strong">**禁止**</span>:
<span class="hljs-bullet">  -</span> <span class="hljs-strong">**不能**</span>修改测试代码
<span class="hljs-bullet">  -</span> <span class="hljs-strong">**不考虑**</span>代码质量和性能优化
<span class="hljs-bullet">  -</span> <span class="hljs-strong">**不进行**</span>过度设计
<span class="hljs-bullet">-</span> <span class="hljs-strong">**验证**</span>: 运行测试必须显示绿色（通过状态）

<span class="hljs-section">#### 2.2.3. 交互示例</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**Agent 回应**</span>: "已激活 <span class="hljs-strong">**GREEN 阶段**</span>。我将实现最简单的代码来让刚才的测试通过，不考虑优化和设计。"

<span class="hljs-section">### 2.3. 第三阶段：REFACTOR (重构优化)</span>

<span class="hljs-section">#### 2.3.1. 目标</span>
在保持测试通过的前提下，改进代码的设计、质量和可维护性。

<span class="hljs-section">#### 2.3.2. 核心准则</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**允许**</span>: Agent 可以重构 <span class="hljs-code">`src/main/`</span> 目录下的实现代码
<span class="hljs-bullet">-</span> <span class="hljs-strong">**要求**</span>:
<span class="hljs-bullet">  -</span> 改进代码设计和质量
<span class="hljs-bullet">  -</span> 消除重复代码
<span class="hljs-bullet">  -</span> 提高代码可读性和可维护性
<span class="hljs-bullet">  -</span> 每次重构后必须运行测试确保通过
<span class="hljs-bullet">-</span> <span class="hljs-strong">**禁止**</span>:
<span class="hljs-bullet">  -</span> <span class="hljs-strong">**不能**</span>修改测试的行为和期望
<span class="hljs-bullet">  -</span> <span class="hljs-strong">**不能**</span>破坏现有功能
<span class="hljs-bullet">-</span> <span class="hljs-strong">**验证**</span>: 重构过程中和完成后，所有测试必须保持绿色

<span class="hljs-section">#### 2.3.3. 交互示例</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**Agent 回应**</span>: "已激活 <span class="hljs-strong">**REFACTOR 阶段**</span>。我将重构代码以提高质量，同时确保所有测试保持通过状态。"

---

<span class="hljs-section">## 3. TDD 最佳实践</span>

<span class="hljs-section">### 3.1. 循环节奏</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**小步快走**</span>: 每个 Red-Green-Refactor 循环应该很短（几分钟到十几分钟）
<span class="hljs-bullet">-</span> <span class="hljs-strong">**频繁验证**</span>: 每个阶段完成后都要运行测试验证
<span class="hljs-bullet">-</span> <span class="hljs-strong">**逐步推进**</span>: 一次只关注一个小功能点

<span class="hljs-section">### 3.2. 测试质量要求</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**快速执行**</span>: 单元测试应该在秒级内完成
<span class="hljs-bullet">-</span> <span class="hljs-strong">**独立性**</span>: 测试之间不应该有依赖关系
<span class="hljs-bullet">-</span> <span class="hljs-strong">**可重复性**</span>: 测试结果应该是确定的和可重复的
<span class="hljs-bullet">-</span> <span class="hljs-strong">**清晰命名**</span>: 测试方法名应明确表达测试意图

<span class="hljs-section">### 3.3. 代码质量保证</span>
<span class="hljs-bullet">-</span> <span class="hljs-strong">**持续重构**</span>: 在每个循环的 REFACTOR 阶段改进代码
<span class="hljs-bullet">-</span> <span class="hljs-strong">**消除重复**</span>: 遵循 DRY（Don't Repeat Yourself）原则
<span class="hljs-bullet">-</span> <span class="hljs-strong">**保持简洁**</span>: 代码应该简洁明了，易于理解

<span class="hljs-section">### 3.4. 流程控制</span>
Agent 在每个阶段转换时，必须：
<span class="hljs-bullet">1.</span> 明确声明即将进入的阶段
<span class="hljs-bullet">2.</span> 说明当前阶段的具体目标
<span class="hljs-bullet">3.</span> 完成阶段后验证结果
<span class="hljs-bullet">4.</span> 确认是否继续下一个循环
</code></pre>
<h3 data-id="heading-13">5.2 掌握单测语法</h3>
<p>AI擅长基础用例覆盖，但复杂业务场景、边界条件仍有可能需要开发者手动编写。不要完全依赖AI构造用例。</p>
<h3 data-id="heading-14">5.3 选择合适场景与策略</h3>
<p>快速决策法则：</p>
<ul>
<li>简单功能：单个方法，逻辑直观，采用“先实现，后验证”；</li>
<li>复杂业务逻辑：多分支判断、算法计算、状态转换，采用TDD“先验证，后实现”；</li>
<li>存量代码修改：采用“安全网保护”策略；</li>
<li>提示词难以描述需求时：测试用例是最好的需求文档，采用TDD让代码直接表达需求。</li>
</ul>
<h3 data-id="heading-15">5.4 持续维护</h3>
<p>单元测试必须与业务代码演进保持同步。一个过时的、无人维护的测试集，其价值会迅速归零，甚至成为负资产。</p>
<h2 data-id="heading-16">六、结语</h2>
<p>如今，单元测试已被赋予全新的意义——它不再被视为一种“开发负担”，而是进化成为AI Coding时代的“质量引擎”。</p>
<p>我们构建起三重关键保障：</p>
<ul>
<li><strong>策略一</strong>：以客观检验替代主观判断，让AI代码告别“看起来没问题”的错觉；</li>
<li><strong>策略二</strong>：为存量代码筑起防护墙，使修改存量代码安全可控，降低演进风险；</li>
<li><strong>策略三</strong>：用测试作为与AI的沟通语言，精准传递复杂需求与预期。</li>
</ul>
<p>更深层次的变化在于，我们正在重新定义开发者的核心价值：当我们从“思考提示词”转向“思考测试用例”，本质上是从AI代码被动的审查者，转变为了主动的需求设计者与质量掌控者。这不仅加速开发进程，更显著提升代码质量。这正是AI时代中，开发者与智能工具协同进化的优秀范式。</p>
<p>| 关注「美团技术团队」微信公众号，在公众号菜单栏对话框回复【2024年货】、【2023年货】、【2022年货】、【2021年货】、【2020年货】、【2019年货】、【2018年货】、【2017年货】等关键词，可查看美团技术团队历年技术文章合集。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9493cccaa0be4161a6158c0625fd97cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg576O5Zui5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518691&amp;x-signature=NT2JEOZ2ocIEwo2og70f407ctkU%3D" alt="" loading="lazy"/></p>
<p>| 本文系美团技术团队出品，著作权归属美团。欢迎出于分享和交流等非商业目的转载或使用本文内容，敬请注明“内容转载自美团技术团队”。本文未经许可，不得进行商业性转载或者使用。任何商用行为，请发送邮件至 <a href="https://link.juejin.cn?target=mailto%3Atech%40meituan.com" target="_blank" title="mailto:tech@meituan.com" ref="nofollow noopener noreferrer">tech@meituan.com</a> 申请授权。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[10 个 YYDS 的技巧：Google 官方教你用 Nano Banana Pro]]></title>    <link>https://juejin.cn/post/7579917791765266459</link>    <guid>https://juejin.cn/post/7579917791765266459</guid>    <pubDate>2025-12-05T05:53:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579917791765266459" data-draft-id="7579935414422126638" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="10 个 YYDS 的技巧：Google 官方教你用 Nano Banana Pro"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-12-05T05:53:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逛逛GitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1442202996186093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            10 个 YYDS 的技巧：Google 官方教你用 Nano Banana Pro
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442202996186093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逛逛GitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T05:53:28.000Z" title="Fri Dec 05 2025 05:53:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>谷歌官方在 X 上发布了一个指南，手把手教你用 Nano Banana Pro。我对谷歌官方提到的 10 个技巧进行总结下，感兴趣的可以去看原帖。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74708249aec742e09c79fd7d887e9df5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=%2BjvmyEz%2BNxEAhjY%2Bvpw0yfRaNP8%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-bash" lang="bash">地址：https://x.com/GoogleAIStudio/article/1994480371061469306
</code></pre>
<h2 data-id="heading-0">00、前置介绍</h2>
<p>Nano-Banana Pro 相较于上一代模型有了重大飞跃，从趣味图像生成转向实用专业资产制作。</p>
<p>它在文本渲染、角色一致性、视觉合成、世界知识（搜索）以及高分辨率（4K）输出方面表现出色。</p>
<p>记住，Nano-Banana Pro 是一种思考模型。它不仅仅匹配关键词，它还能理解意图、物理和构图。</p>
<p>为了获得最佳效果，不要在使用各种关键词标签了。</p>
<blockquote>
<p>❌ 不要这样写： "酷炫的汽车，霓虹灯，城市，夜晚，8K。" </p>
</blockquote>
<blockquote>
<p>✅ 要这样写：<br/>
“一幅未来感十足的运动汽车在夜晚的雨中东京街头飞驰的电影宽景镜头。霓虹灯牌反射在湿漉漉的路面和汽车的金属车身上。”</p>
</blockquote>
<p>提示词尽可能描述的详细，不要模糊。一旦是通用的提示词就会生成通用的结果。可以明确主题、场景、光线和氛围。</p>
<blockquote>
<p>不要说“一个女人”，而要说“一个穿着复古香奈儿风格套装的成熟老年妇女”。</p>
</blockquote>
<blockquote>
<p>材质： 描述质感。“哑光表面”、“拉丝钢”、“柔软天鹅绒”、“皱褶纸张”。</p>
</blockquote>
<p>因为模型具有思考能力，提供背景信息有助于它画出更好的效果。</p>
<blockquote>
<p>比如：“创作一张三明治的图片 ，用于巴西高端美食烹饪书”。（模型会推断出专业的摆盘、浅景深和完美的光线）</p>
</blockquote>
<p>下面主要按照如下几个模块总结 Google 发布的对 Nano Banana Pro 的教程。</p>
<ol>
<li>
<p>文本渲染、信息图表与视觉合成 </p>
</li>
<li>
<p>角色一致性与病毒式缩略图 </p>
</li>
<li>
<p>使用谷歌搜索进行基础设置 </p>
</li>
<li>
<p>高级编辑、修复与着色 </p>
</li>
<li>
<p>维度转换（2D ↔3D） </p>
</li>
<li>
<p>高分辨率与纹理 </p>
</li>
<li>
<p>思维与推理 </p>
</li>
<li>
<p>一次性故事板与概念设计 </p>
</li>
<li>
<p>结构控制与布局指导 </p>
</li>
</ol>
<h2 data-id="heading-1">01、文本渲染、信息图表与视觉合成</h2>
<p>Nano-Banana Pro 能够生成清晰、风格化的文本，有几种场景比较常用。</p>
<p>① 内容压缩：把 PDF 文件或大量文字复制进去，让模型作为视觉辅助工具，帮你“压缩”成一张可视化的图表或海报。</p>
<p>② 风格生成：想要啥风格直接说，可以生成不同风格的外观，比如“技术图表”、“手绘白板”等等。</p>
<p>③ 文字生成：图上想写啥字？直接用引号引起来告诉它，它保证不给你写成乱码。</p>
<p>比如：</p>
<blockquote>
<p>财报信息图： [谷歌最新财报 PDF 输入] “生成一份干净、现代的信息图，概述本次财报的主要财务亮点。包括‘收入增长’和‘净利润’的图表，并用风格化的引述框突出 CEO 的关键语录。”</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62f9ce6516254b0c835fc3692a7e0ada~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=9tisMK%2Fk7SCrW4o%2Fmc5IROHsoWU%3D" alt="Image" loading="lazy"/></p>
<blockquote>
<p>复古信息图： 制作一份复古的、1950年代风格的美国餐厅历史信息图。包括“食物”、“点唱机”和“装饰”三个不同部分。确保所有文字清晰易读，并且风格与那个时期相符。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2445a5d4e60247b79c2eced60e24e24d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=FivJw0UjNVIg9i5toT%2FNoBotk6A%3D" alt="Image" loading="lazy"/></p>
<blockquote>
<p>技术图示： 创建一份正投影蓝图，描述该建筑的平面图、立面图和剖面图。用专业建筑字体清楚标注“北立面”和“主入口”。格式为16:9。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bebd477fb51941e4b63e22174a485b64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=coHY2BsVstt67WF5WVW2guQD2tM%3D" alt="Image" loading="lazy"/></p>
<blockquote>
<p>白板总结（教育用）： “用手绘白板图示总结‘Transformer 神经网络架构’的概念，适合大学讲座。使用不同颜色的标记区分编码器和解码器块，并包含清晰的‘自注意力’和‘前馈’标签。”</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6b2f64a413443efb75d52e0e260e149~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=9dMF6TrSdA%2FqStDAMITOfmypG%2BA%3D" alt="Image" loading="lazy"/></p>
<h2 data-id="heading-2">02、字符一致性与视频缩略图</h2>
<p>Nano-Banana Pro 可以将参考图片中的特定人物或角色放入新的场景中，而不扭曲面部特征。</p>
<p>你想生成的图片物体样子和你上传图片的参考一样，需要明确说明：“保持此人的面部特征与上传图片 1 完全一致”。</p>
<p>还需要描述在保持身份的同时，情绪或姿势的变化 。还能制作小红书或者 B 站封面，将主题与粗体图形和文本结合在一起，一次完成。</p>
<blockquote>
<p>视频缩略图： 使用图片 1 中的人物设计一个病毒式视频缩略图。 面部一致性： 保持人物的面部特征与图片 1 完全一致，但将表情改为兴奋和惊讶的样子。  动作： 将人物放在左侧，指向画面右侧。  </p>
<p>主题： 在右侧放置一张高质量的美味牛油果吐司图片。  图形： 添加一只粗体黄色箭头，将人物的手指连接到吐司上。  文字： 在中间叠加大号的流行风格文字：“3 分钟搞定！”（用白色粗边和投影效果）。  背景： 一个模糊、明亮的厨房背景。高饱和度和对比度。 </p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1908fb4a77e046b29cef4ebd7a2c09fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=9SyobJ%2BbJE92M3LDArQOqiqEzPc%3D" alt="Image" loading="lazy"/></p>
<blockquote>
<p>“毛绒朋友”场景（群体一致性）： [输入3张不同毛绒玩具的图片] “用这 3 只毛绒朋友展开一个有趣的十部分故事，他们一起去热带度假。故事情节紧凑，高潮迭起，充满情感波折，最后以一个快乐的瞬间结束。 </p>
<p>保持所有角色的服装和身份一致 ，但他们的表情和角度应在全部 10 张图片中有所变化。确保每张图片中只有一个角色出现。”</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebd055700c6d498ebfcffa50d8be1e7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=oXsjsOAqFlAoJLazNKncS5VmfSk%3D" alt="Image" loading="lazy"/></p>
<blockquote>
<p>品牌资产生成： [输入一张产品图片] “创建9张令人惊叹的时尚照片，仿佛来自获奖的时尚编辑。以此参考作为品牌风格，但加入细节和多样性，使其传达专业的设计感。请逐一生成九张图片。”</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/611c3c1c6ced4e60960b6eaecb953651~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=w7Kzk0o6jqeRzi1NYxwvdTxey0g%3D" alt="Image" loading="lazy"/></p>
<h2 data-id="heading-3">03、使用谷歌搜索进行基础验证</h2>
<p>Nano-Banana Pro 利用谷歌搜索根据实时数据、时事或事实验证生成图像，减少在时事话题上的幻觉。</p>
<blockquote>
<p>事件可视化： 根据当前旅游趋势，生成一份关于2025年访问美国国家公园最佳时间的信息图。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae21766f359d48428972b09cd5af5c33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=f96NWXubl%2BafYruLaZL%2BQKKIB8w%3D" alt="Image" loading="lazy"/></p>
<h2 data-id="heading-4">04、高级编辑、修复与着色</h2>
<p>该模型还擅长通过对话，对图片中的物体进行移除或添加、修复旧照片、着色以及风格转换。</p>
<blockquote>
<p>物体移除与补绘： 将这张照片背景中的游客移除，并用与周围环境相匹配的逻辑纹理（如鹅卵石和店面）填充空白区域。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50dfa6602e4a4f969815ac0bb5265eb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=cY%2FAuRS3LnU8mx69tSkLo%2BG4fas%3D" alt="Image" loading="lazy"/></p>
<blockquote>
<p>漫画/连环画彩色化： [输入黑白漫画面板] “为这幅漫画面板上色。使用充满活力的动画风格调色板。确保能量光束的光影效果呈现发光的霓虹蓝色，角色的服装颜色与官方配色保持一致。”</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47374d5f914b4cc8b9a57026e2ec1992~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=yOmvHWGHhmIK8WNaYOT4ZmH8v%2FE%3D" alt="Image" loading="lazy"/></p>
<blockquote>
<p>本地化（文本翻译 + 文化适应）： [伦敦公交站广告的图片] “将这个概念本地化到东京场景中，包括将标语翻译成日语。将背景改为夜晚繁忙的涩谷街头。”</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16682c2a55a4425ea3163079f0286d3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=67lYGV0OXKC2CGCj2YK%2F%2Bu6JN8I%3D" alt="Image" loading="lazy"/></p>
<blockquote>
<p>照明/季节控制： [夏天的房屋图片] “将这个场景变成冬天。保持房屋的建筑完全不变，但在屋顶和院子里添加雪，并将光线改为阴冷、阴天的下午。”</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab0c477dcdf5466c9994a51fc2d5892d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=%2FKHrCDw%2FNH8i1VmClplu9VGG5FA%3D" alt="Image" loading="lazy"/></p>
<h2 data-id="heading-5">05、维度转换（2D ↔ 3D)</h2>
<p>一种强大的新功能是将2D示意图转换为3D可视化，</p>
<blockquote>
<p>二维平面图转三维室内设计展示板： “根据上传的二维平面图，生成一张专业的室内设计展示板，包含在一张图片中。</p>
<p>布局： 一个大主图在顶部（宽角度视角的客厅），下面有三张较小的图片（主卧室、家庭办公室和三维俯视平面图）。 </p>
<p>风格： 采用现代极简风格，所有图片都使用温暖的橡木地板和米白色墙壁。  质量： 照片级逼真渲染，柔和自然光线。”</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ffc037685f148418928ae224a036e8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=1vzjp%2BAErYlvroixwPqvAQtbWOg%3D" alt="Image" loading="lazy"/></p>
<blockquote>
<p>2D 转 3D 表情包转换： “将‘没事的狗’表情包变成逼真的 3D 渲染。保持构图一致，但让狗看起来像毛绒玩具，火焰看起来像真实的火焰。”</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b39929e90bb742b0b9cb7c45d7af484f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=zbn9CDkID8gPxSiqYPA1JKjufn0%3D" alt="Image" loading="lazy"/></p>
<h2 data-id="heading-6">06、高分辨率与纹理</h2>
<p>支持原生 1K 到 4K 的图像生成。这对于细节丰富的纹理或大幅面打印尤为有用。</p>
<blockquote>
<p>4K 纹理生成： “利用原生高保真输出，打造一个令人惊叹、充满氛围的苔藓森林地面环境。</p>
<p>指挥复杂的光影效果和细腻的纹理，确保每一缕苔藓和每一道光束都以像素完美的分辨率呈现，适合作为 4K 壁纸。”</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5c702299bf84fb5acf6fb6bcfb1a3d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=jot9wE%2Bh3ZyaE9E%2BljWndEZTNZ8%3D" alt="Image" loading="lazy"/></p>
<blockquote>
<p>复杂逻辑（思考模式）： “创建一份超逼真的美食汉堡信息图，将其拆解，展示烤制金黄的布里欧面包的纹理、煎制的肉饼的焦脆外壳，以及融化的奶酪的闪亮光泽。为每一层标注其风味特征。”</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f536665b0470465ab1487ee8beb03d15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=6BkbUoFLx6Dj0yTLQT1t6P3EKOc%3D" alt="Image" loading="lazy"/></p>
<h2 data-id="heading-7">07、思考与推理</h2>
<blockquote>
<p>求解方程： 在白板上求解复数域内的方程 log_{x^2+1}(x^4-1)=2。请清楚地展示步骤。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/419587a9ff90491384af17c645d17824~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=vRopYO1rgnE%2BscUXMYYkgJyOu7k%3D" alt="Image" loading="lazy"/></p>
<blockquote>
<p>视觉推理： 分析这张房间的图片，并生成一张“之前”的图片，展示房间在施工期间的样子，包括框架和未完成的石膏板。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e800b99c3cd41d2a9902762e7e704f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=uIcG8M%2FzF3xVNBUNMyo7NLhLEd0%3D" alt="Image" loading="lazy"/></p>
<h2 data-id="heading-8">08、一次性故事板和概念艺术</h2>
<p>你可以生成连续的艺术作品或故事板，确保在一次会话中实现连贯的叙事流程。</p>
<blockquote>
<p>创建一个引人入胜、令人上瘾的九部分故事，配以九张图片，展示一位女性和一位男性在获奖的奢华行李广告中的场景。故事应有情感的高潮与低谷，最后以一张优雅的女性与品牌标志的画面结束。 </p>
<p>女性和男性的身份及着装必须保持一致 ，但他们可以并且应该从不同角度和距离进行拍摄。请逐一生成图片，确保每张图片都是 16:9 的横屏格式。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d67997034eef42e7b7ab4ce22d187f58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=48UW8jSR%2FwLDbAHpBnHpIsC%2FMeg%3D" alt="Image" loading="lazy"/></p>
<h2 data-id="heading-9">09、结构控制与布局指导</h2>
<p>你可以输入一个草图来严格控制最终输出的构图和布局 。</p>
<blockquote>
<p>从草图到最终广告： “根据这个草图为[产品]制作广告。”</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5945153de27840f3ad3fcca564d82e45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=2MNrJY64SAUhxzZ93AuriFsOhK0%3D" alt="Image" loading="lazy"/></p>
<blockquote>
<p>线框图的 UI 模型： “根据这些指南为[产品]创建一个模型。”</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3cf489bbfe0490ea0f01518a3b9d81a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=oquIre37rx38z0oXkIapNxjlJWc%3D" alt="Image" loading="lazy"/></p>
<blockquote>
<p>像素艺术与 LED 显示屏： 生成一只适合完美融入此 64x64 网格图像的像素艺术独角兽精灵。使用高对比度颜色。</p>
<p> (提示：开发者可以通过编程提取每个格子的中心颜色，以驱动连接的 64x64 LED 矩阵显示屏)。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddff2e3c51924a33954a7c8274cf13a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=ew47OPl1oIob%2BpRTAEiAmOH2GbA%3D" alt="Image" loading="lazy"/></p>
<blockquote>
<p>精灵： 一张显示一名女性在无人机上做后空翻的精灵图集，3x3 网格，序列动画，逐帧动画，方形比例。请严格按照附上的参考图片结构进行。</p>
<p> （提示：你可以提取每个格子制作成 GIF）</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d852ad4ca8214c6080c826c4a16ac07c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518807&amp;x-signature=wNX8ISxqIRANRDEmBqYcVSH%2F9Yc%3D" alt="Image" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[玩转小程序AR-实战篇]]></title>    <link>https://juejin.cn/post/7579961957221777435</link>    <guid>https://juejin.cn/post/7579961957221777435</guid>    <pubDate>2025-12-05T05:53:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579961957221777435" data-draft-id="7579872561675649033" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="玩转小程序AR-实战篇"/> <meta itemprop="keywords" content="微信小程序,WebVR,前端"/> <meta itemprop="datePublished" content="2025-12-05T05:53:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="深红"/> <meta itemprop="url" content="https://juejin.cn/user/4353721773338807"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            玩转小程序AR-实战篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4353721773338807/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    深红
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T05:53:34.000Z" title="Fri Dec 05 2025 05:53:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>某天需求方扔了个链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdetail.tmall.com%2Fitem.htm%3FfpChannel%3D101%26fpChannelSig%3D5e762bf5403ecf3effc7b043733500dd040c9068%26id%3D823870055035%26sku_properties%3D134942334%253A33623926433%26u_channel%3Dbybtqdyh%26umpChannel%3Dbybtqdyh" target="_blank" title="https://detail.tmall.com/item.htm?fpChannel=101&amp;fpChannelSig=5e762bf5403ecf3effc7b043733500dd040c9068&amp;id=823870055035&amp;sku_properties=134942334%3A33623926433&amp;u_channel=bybtqdyh&amp;umpChannel=bybtqdyh" ref="nofollow noopener noreferrer">【原神官方】AR 立牌</a>，询问<strong>小程序</strong>是否能够实现类似的<strong>AR</strong>效果。</p>
<p>作为打工的人的我，于是被迫补起：早已过了风口(<del>bushi</del>)的<code>AR</code>知识。</p>
<h2 data-id="heading-1">调研</h2>
<h3 data-id="heading-2">实体 AR 立牌</h3>
<p>斥<strong>巨资</strong>在闲鱼淘了个多莉的角色立牌，实际体验了下完整的交互流程，AR的氛围感还是不错的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9027f13aa82c413ab7aaae9e456f839e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=O6%2BOzqLYfkjR1Mr6feyL8PKWqK4%3D" alt="ar" loading="lazy"/></p>
<h3 data-id="heading-3">AR在线制作平台</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kivicube.com" target="_blank" title="https://www.kivicube.com" ref="nofollow noopener noreferrer">KIVICUBE</a> 提供了可视化的3D场景搭建和动画编排系统：零基础也可创造和发布酷炫的AR作品。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc50ebf0604b48348088f52bf257e728~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=BagamvW8Hw%2BT4UctjyUPqGndMeM%3D" alt="KIVICUBE" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11c2970f05e04aa5b3fcc2969c80fbd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=lYCXwi4PLwi7DswIpfN5pKyHoA0%3D" alt="KIVICUBE" loading="lazy"/></p>
<p>官方同时提供了大量<a href="https://link.juejin.cn?target=https%3A%2F%2Fcloud.kivicube.com%2Ftemplates" target="_blank" title="https://cloud.kivicube.com/templates" ref="nofollow noopener noreferrer">创意模版</a>供大家一键使用</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/133acaba65c248858d6a9a2b4c09ebbf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=4XL4XSLcE11nst0fp%2Fj%2F22GrElo%3D" alt="KIVICUBE" loading="lazy"/></p>
<h2 data-id="heading-4">技术方案</h2>
<p>在微信小程序的技术体系下，官方提供了两种解决方案：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fframework%2Fopen-ability%2Fvisionkit%2Fbase.html" target="_blank" title="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/visionkit/base.html" ref="nofollow noopener noreferrer">VisionKit</a></li>
</ul>
<blockquote>
<p>小程序也在基础库 2.20.0 版本开始提供了开发 AR 功能的能力，即 VisionKit。VisionKit 包含了 AR 在内的视觉算法</p>
</blockquote>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fframework%2Fxr-frame%2F" target="_blank" title="https://developers.weixin.qq.com/miniprogram/dev/framework/xr-frame/" ref="nofollow noopener noreferrer">XR-FRAME</a></li>
</ul>
<blockquote>
<p>xr-frame是一套小程序官方提供的XR/3D应用解决方案，基于混合方案实现，性能逼近原生、效果好、易用、强扩展、渐进式、遵循小程序开发标准</p>
</blockquote>
<p>简单来说：</p>
<ul>
<li>VisionKit 是底层视觉引擎，提供能力但需要自己拼装。</li>
<li>XR-FRAME 是完整开发框架，整合了渲染、交互与视觉能力，适合快速实现产品化的 AR 效果。</li>
</ul>
<p>虽然理论上我们完全可以基于 VisionKit 并结合 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwechat-miniprogram%2Fthreejs-miniprogram" target="_blank" title="https://github.com/wechat-miniprogram/threejs-miniprogram" ref="nofollow noopener noreferrer">Three.js</a> 或自研的 WebGL 渲染逻辑来实现 AR 效果，但这种方案开发成本较高：</p>
<p>开发者需要自行处理相机帧与渲染管线的衔接、追踪状态管理、姿态矩阵更新等底层逻辑，整体工程量大且维护复杂。（<strong>Kivicube</strong> 正是使用此方案，确保自研的 AR 可视化搭建平台的产物能兼容各大平台：微信小程序、原生网页H5）</p>
<p>而 XR-FRAME 在此基础上进一步封装了完整的 3D 渲染与交互体系，提供了大量开箱即用的能力，让开发者可以像写前端组件一样，以声明式方式快速构建 AR 场景，而不必深入到底层渲染细节。</p>
<p>因此最后决定：先用 <strong>XR-FRAME</strong> 快速交付第一版 MVP 小程序</p>
<h2 data-id="heading-5">XR-FRAME 指南</h2>
<p>由于是小程序开发，所以学习 <strong>XR-FRAME</strong> 的前提，需要有<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fframework%2FMINA.html" target="_blank" title="https://developers.weixin.qq.com/miniprogram/dev/framework/MINA.html" ref="nofollow noopener noreferrer">小程序基础知识</a></p>
<p>而官方的两个在线文档，内容还是略显单薄，强烈建议直接参考官方 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdtysky%2Fxr-frame-demo" target="_blank" title="https://github.com/dtysky/xr-frame-demo" ref="nofollow noopener noreferrer">《xr-frame系统的示例集》</a></strong> 的<strong>源码</strong>进行实战学习</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fframework%2Fxr-frame%2F%23%25E6%2596%25B0%25E5%25BB%25BA%25E4%25B8%2580%25E4%25B8%25AAXR%25E7%25BB%2584%25E4%25BB%25B6" target="_blank" title="https://developers.weixin.qq.com/miniprogram/dev/framework/xr-frame/#%E6%96%B0%E5%BB%BA%E4%B8%80%E4%B8%AAXR%E7%BB%84%E4%BB%B6" ref="nofollow noopener noreferrer">指南 XR-FRAME</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fcomponent%2Fxr-frame%2Foverview%2F%23%25E6%25A6%2582%25E8%25BF%25B0" target="_blank" title="https://developers.weixin.qq.com/miniprogram/dev/component/xr-frame/overview/#%E6%A6%82%E8%BF%B0" ref="nofollow noopener noreferrer">组件 XR-FRAME</a></li>
</ul>
<p>本教程配套代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdeepred5%2Fxr-frame-tutorial" target="_blank" title="https://github.com/deepred5/xr-frame-tutorial" ref="nofollow noopener noreferrer">xr-frame-tutorial</a></p>
<h3 data-id="heading-6">XR 组件 模版代码</h3>
<h4 data-id="heading-7">创建 XR 组件</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35fbb864fc3341518aef97d716d06f1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=UlgITFwRtXaph%2B%2FXijysP0zjhJw%3D" alt="1.png" loading="lazy"/></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"component"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"usingComponents"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"renderer"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"xr-frame"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">xr-scene</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-camera</span> <span class="hljs-attr">clear-color</span>=<span class="hljs-string">"0.4 0.8 0.6 1"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">xr-scene</span>&gt;</span>
</code></pre>
<h4 data-id="heading-8">使用 XR 组件</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95863fc915b8455bb4ecda0310b50ce0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=%2FlkJTSiogCRNwwZ4a7OVDYlH51U%3D" alt="2.png" loading="lazy"/></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"usingComponents"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"demo1"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"../../components/demo1"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"disableScroll"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> 
  <span class="hljs-attr">"renderer"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"webview"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">view</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">demo1</span>
    <span class="hljs-attr">disable-scroll</span>
    <span class="hljs-attr">id</span>=<span class="hljs-string">"main-frame"</span>
    <span class="hljs-attr">width</span>=<span class="hljs-string">"{{renderWidth}}"</span>
    <span class="hljs-attr">height</span>=<span class="hljs-string">"{{renderHeight}}"</span>
    <span class="hljs-attr">style</span>=<span class="hljs-string">"width:{{width}}px;height:{{height}}px;top:{{top}}px;left:{{left}}px;"</span>
  /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">view</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Page</span>({
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">left</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">top</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">width</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">height</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">renderWidth</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">renderHeight</span>: <span class="hljs-number">0</span>,
  },
  <span class="hljs-title function_">onLoad</span>(<span class="hljs-params">options</span>) {
    <span class="hljs-keyword">const</span> info = wx.<span class="hljs-title function_">getSystemInfoSync</span>()
    <span class="hljs-keyword">const</span> width = info.<span class="hljs-property">windowWidth</span>
    <span class="hljs-keyword">const</span> height = info.<span class="hljs-property">windowHeight</span>
    <span class="hljs-keyword">const</span> dpi = info.<span class="hljs-property">pixelRatio</span>

    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({
      width, 
      height,
      <span class="hljs-attr">renderWidth</span>: width * dpi,
      <span class="hljs-attr">renderHeight</span>: height * dpi
    });
  },
})
</code></pre>
<h4 data-id="heading-9">渲染 XR 组件</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bd32ef65dfe490ba0128f2b27d69dc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=MwzJs4chxCu6xxWsV6%2BHE58sqr8%3D" alt="3.png" loading="lazy"/></p>
<p>渲染效果：绿色背景的画布 Canvas</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a380758aa7c4b74b8ef86b10ed246d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=s0ZqnpiT2pzi5U9rLZZONgYTacg%3D" alt="4.png" loading="lazy"/></p>
<h3 data-id="heading-10">3D 渲染</h3>
<p>源码示例: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdeepred5%2Fxr-frame-tutorial%2Ftree%2Fmain%2Fcomponents%2Fdemo1%2Findex.wxml" target="_blank" title="https://github.com/deepred5/xr-frame-tutorial/tree/main/components/demo1/index.wxml" ref="nofollow noopener noreferrer">3D 渲染</a></p>
<p>最基础的 3D 渲染 思维导图</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e2d319896ae4fc0809fbe4227bf773f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=9ghjQXxOfN0f9WGKa6RshEM3Se4%3D" alt="whiteboard_exported_image.png" loading="lazy"/></p>
<h4 data-id="heading-11">添加物体</h4>
<p>添加一个 立方体 （Cube）物体</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">xr-scene</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-mesh</span> <span class="hljs-attr">node-id</span>=<span class="hljs-string">"cube"</span> <span class="hljs-attr">geometry</span>=<span class="hljs-string">"cube"</span> /&gt;</span>
  <span class="hljs-comment">&lt;!-- 设置 target 指向 cube，让相机始终看向这个立方体--&gt;</span> 
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-camera</span> <span class="hljs-attr">clear-color</span>=<span class="hljs-string">"0.4 0.8 0.6 1"</span> <span class="hljs-attr">position</span>=<span class="hljs-string">"1 3 4"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"cube"</span> <span class="hljs-attr">camera-orbit-control</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">xr-scene</span>&gt;</span>
</code></pre>
<p>物体黑色是因为在我们没有给<code>xr-mesh</code>指定材质时，用的是基于PBR效果的默认材质，需要光照</p>
<p>临时解决方案：
创建一个不需要光照的材质，并且使用这个材质</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">xr-scene</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-material</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"simple"</span> <span class="hljs-attr">effect</span>=<span class="hljs-string">"simple"</span> <span class="hljs-attr">uniforms</span>=<span class="hljs-string">"u_baseColorFactor:0.8 0.4 0.4 1"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-mesh</span> <span class="hljs-attr">node-id</span>=<span class="hljs-string">"cube"</span> <span class="hljs-attr">geometry</span>=<span class="hljs-string">"cube"</span> <span class="hljs-attr">material</span>=<span class="hljs-string">"simple"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-camera</span> <span class="hljs-attr">clear-color</span>=<span class="hljs-string">"0.4 0.8 0.6 1"</span> <span class="hljs-attr">position</span>=<span class="hljs-string">"1 3 4"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"cube"</span> <span class="hljs-attr">camera-orbit-control</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">xr-scene</span>&gt;</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a20389031d646edaa91f28d72001df8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=H3Rja2laYNmANxDwLSPGwmUeA5M%3D" alt="5.png" loading="lazy"/></p>
<h4 data-id="heading-12">添加光照</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">xr-scene</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-mesh</span> <span class="hljs-attr">node-id</span>=<span class="hljs-string">"cube"</span> <span class="hljs-attr">geometry</span>=<span class="hljs-string">"cube"</span> <span class="hljs-attr">uniforms</span>=<span class="hljs-string">"u_baseColorFactor:0.8 0.4 0.4 1"</span> /&gt;</span>
  <span class="hljs-comment">&lt;!-- 一个环境光 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-light</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"ambient"</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"1 1 1"</span> <span class="hljs-attr">intensity</span>=<span class="hljs-string">"1"</span> /&gt;</span>
  <span class="hljs-comment">&lt;!-- 一个主平行光 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-light</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"directional"</span> <span class="hljs-attr">rotation</span>=<span class="hljs-string">"40 70 0"</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"1 1 1"</span> <span class="hljs-attr">intensity</span>=<span class="hljs-string">"3"</span> <span class="hljs-attr">cast-shadow</span> /&gt;</span> 
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-camera</span> <span class="hljs-attr">clear-color</span>=<span class="hljs-string">"0.4 0.8 0.6 1"</span> <span class="hljs-attr">position</span>=<span class="hljs-string">"1 3 4"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"cube"</span> <span class="hljs-attr">camera-orbit-control</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">xr-scene</span>&gt;</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3291ad38a47049c7957662c796cd162a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=O9qDhwsV3%2FW1GrRuRiBiikKOf7Y%3D" alt="6.png" loading="lazy"/></p>
<h4 data-id="heading-13">添加纹理</h4>
<p>纹理 Texture 是 GPU 中的图像，供着色器采样使用。在框架中其一般被作为材质的一部分uniforms使用</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">xr-scene</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-assets</span> <span class="hljs-attr">bind:progress</span>=<span class="hljs-string">"handleAssetsProgress"</span> <span class="hljs-attr">bind:loaded</span>=<span class="hljs-string">"handleAssetsLoaded"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 加载纹理 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-load</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"texture"</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"waifu"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://mmbizwxaminiprogram-1258344707.cos.ap-guangzhou.myqcloud.com/xr-frame/demo/waifu.png"</span> /&gt;</span>
    <span class="hljs-comment">&lt;!-- 材质中使用纹理 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-material</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"mat"</span> <span class="hljs-attr">uniforms</span>=<span class="hljs-string">"u_baseColorMap: waifu"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">xr-assets</span>&gt;</span>

  <span class="hljs-comment">&lt;!-- 使用材质 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-mesh</span> <span class="hljs-attr">node-id</span>=<span class="hljs-string">"cube"</span> <span class="hljs-attr">geometry</span>=<span class="hljs-string">"cube"</span> <span class="hljs-attr">material</span>=<span class="hljs-string">"mat"</span> <span class="hljs-attr">cast-shadow</span> /&gt;</span>
  
  <span class="hljs-comment">&lt;!-- 一个环境光 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-light</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"ambient"</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"1 1 1"</span> <span class="hljs-attr">intensity</span>=<span class="hljs-string">"1"</span> /&gt;</span>
  <span class="hljs-comment">&lt;!-- 一个主平行光 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-light</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"directional"</span> <span class="hljs-attr">rotation</span>=<span class="hljs-string">"40 70 0"</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"1 1 1"</span> <span class="hljs-attr">intensity</span>=<span class="hljs-string">"3"</span> <span class="hljs-attr">cast-shadow</span> /&gt;</span> 
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-camera</span> <span class="hljs-attr">clear-color</span>=<span class="hljs-string">"0.4 0.8 0.6 1"</span> <span class="hljs-attr">position</span>=<span class="hljs-string">"1 3 4"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"cube"</span> <span class="hljs-attr">camera-orbit-control</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">xr-scene</span>&gt;</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45248391b13145f1aa4b81691e7ac573~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=3yCMYRoKcxFdYT2FAQIptXtcaMw%3D" alt="7.png" loading="lazy"/></p>
<p>我们继续新加一个 平面 (Plane) 物体</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">xr-assets</span> <span class="hljs-attr">bind:progress</span>=<span class="hljs-string">"handleAssetsProgress"</span> <span class="hljs-attr">bind:loaded</span>=<span class="hljs-string">"handleAssetsLoaded"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-load</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"texture"</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"deepred"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://avatars.githubusercontent.com/u/13102815"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-material</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"mat2"</span> <span class="hljs-attr">uniforms</span>=<span class="hljs-string">"u_baseColorMap: deepred"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">xr-assets</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">xr-mesh</span> <span class="hljs-attr">node-id</span>=<span class="hljs-string">"plane"</span> <span class="hljs-attr">geometry</span>=<span class="hljs-string">"plane"</span> <span class="hljs-attr">material</span>=<span class="hljs-string">"mat2"</span> <span class="hljs-attr">position</span>=<span class="hljs-string">"0 1 0"</span> /&gt;</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a860d8ca71a44ff6abb0bba6aa248dd6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=IPgAhy0G8Tc5aimpw7iWOkVxmmg%3D" alt="screenshot-20251111-001750.png" loading="lazy"/></p>
<h4 data-id="heading-14">添加动画</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"setting"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"ignoreDevUnusedFiles"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ignoreUploadUnusedFiles"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/281b22d3dd7f47458e6580664ab864b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=wP%2BH7qHv2cKqrJ%2FqEASmVgHgkUo%3D" alt="8.png" loading="lazy"/></p>
<p>添加一个无限旋转的动画</p>
<ul>
<li>keyframe 中定义了帧动画具体的行为，本质上类似于 CSS 中的 keyframes</li>
<li>animation 中定义了帧动画的播放配置，本质上类似于 CSS 中的 animation</li>
</ul>
<p><strong>注意：旋转的值是弧度！！！</strong></p>
<p><strong>360度等于2π弧度，约等于 2 * 3.14</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"keyframe"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"logo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"0"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"rotation"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"100"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
         <span class="hljs-comment">// 注意是弧度，360度等于2π，约等于6.28</span>
        <span class="hljs-attr">"rotation"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-number">6.28</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0</span><span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"animation"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"logo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"keyframe"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"logo"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"duration"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">4</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"ease"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"linear"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"loop"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">-1</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 加载动画资源 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-load</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"anim"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"keyframe"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/assets/animation.json"</span>/&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">xr-mesh</span> <span class="hljs-attr">node-id</span>=<span class="hljs-string">"plane"</span> <span class="hljs-attr">geometry</span>=<span class="hljs-string">"plane"</span> <span class="hljs-attr">material</span>=<span class="hljs-string">"mat2"</span> <span class="hljs-attr">position</span>=<span class="hljs-string">"0 1 0"</span> <span class="hljs-attr">anim-keyframe</span>=<span class="hljs-string">"anim"</span> <span class="hljs-attr">anim-autoplay</span>=<span class="hljs-string">"clip:logo"</span> /&gt;</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63cc9cc761a34b4e89b759f6896ddbf4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=VY0Lagd6RCSBfqgsIC3LEtddcGw%3D" alt="kapture.gif" loading="lazy"/></p>
<h4 data-id="heading-15">添加 3D 模型</h4>
<p>支持 GLTF 格式模型</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 加载 GLTF 模型 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-load</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"gltf"</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"miku"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://mmbizwxaminiprogram-1258344707.cos.ap-guangzhou.myqcloud.com/xr-frame/demo/miku.glb"</span> /&gt;</span>

<span class="hljs-comment">&lt;!-- 渲染 GLTF 组件 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">xr-gltf</span> <span class="hljs-attr">model</span>=<span class="hljs-string">"miku"</span> <span class="hljs-attr">position</span>=<span class="hljs-string">"-0.15 0.75 1"</span> <span class="hljs-attr">scale</span>=<span class="hljs-string">"0.07 0.07 0.07"</span> <span class="hljs-attr">rotation</span>=<span class="hljs-string">"0 180 0"</span> <span class="hljs-attr">anim-autoplay</span> /&gt;</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e6c656362a944018f9a41c142218c43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=ANW0ihjwaRNJUSSZ5gWVzJSMKdg%3D" alt="kapture2.gif" loading="lazy"/></p>
<h3 data-id="heading-16">AR 系统</h3>
<p>AR 能力，需要调用摄像头权限</p>
<p>微信开发者工具无法模拟，请使用真机预览模式</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ceb20cc936e545f9a36db2131be5a58f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=MThlCKXDduXR7Cc2DjbJOKsSyb0%3D" alt="9.png" loading="lazy"/></p>
<h4 data-id="heading-17">Plane 识别</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f6160ffe26441ae81b44dd5f3440457~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=jc006Lq7HE4ZdA%2Bm5Pa8PcxnUFg%3D" alt="123" loading="lazy"/></p>
<p>源码示例: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdeepred5%2Fxr-frame-tutorial%2Ftree%2Fmain%2Fcomponents%2Fdemo3%2Findex.wxml" target="_blank" title="https://github.com/deepred5/xr-frame-tutorial/tree/main/components/demo3/index.wxml" ref="nofollow noopener noreferrer">Plane 模式</a></p>
<p><strong>Plane 模式</strong>是 AR 中的平面检测与追踪功能</p>
<p>常见的交互流程：</p>
<ol>
<li>扫描阶段</li>
</ol>
<ul>
<li>用户移动手机摄像头</li>
<li>AR 系统分析画面，识别水平或垂直的平面</li>
<li>常见平面：地板、桌面、墙壁、床面等</li>
</ul>
<ol start="2">
<li>检测阶段</li>
</ol>
<ul>
<li>找到平面后，显示视觉指示器（视频中的蓝色圆环）</li>
<li>指示器跟随检测到的平面移动</li>
</ul>
<ol start="3">
<li>放置阶段</li>
</ol>
<ul>
<li>用户点击屏幕</li>
<li>虚拟物体被"放置"到现实世界的平面上</li>
</ul>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- AR system 系统开启 Plane 模式 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">xr-scene</span> <span class="hljs-attr">ar-system</span>=<span class="hljs-string">"modes:Plane"</span> <span class="hljs-attr">bind:ready</span>=<span class="hljs-string">"handleReady"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-assets</span> <span class="hljs-attr">bind:loaded</span>=<span class="hljs-string">"handleAssetsLoaded"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-load</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"gltf"</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"anchor"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://mmbizwxaminiprogram-1258344707.cos.ap-guangzhou.myqcloud.com/xr-frame/demo/ar-plane-marker.glb"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-load</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"gltf"</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"miku"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://mmbizwxaminiprogram-1258344707.cos.ap-guangzhou.myqcloud.com/xr-frame/demo/miku.glb"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-load</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"texture"</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"deepred"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://avatars.githubusercontent.com/u/13102815"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-material</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"mat"</span> <span class="hljs-attr">uniforms</span>=<span class="hljs-string">"u_baseColorMap: deepred"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">xr-assets</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-light</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"ambient"</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"1 1 1"</span> <span class="hljs-attr">intensity</span>=<span class="hljs-string">"1"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-light</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"directional"</span> <span class="hljs-attr">rotation</span>=<span class="hljs-string">"40 70 0"</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"1 1 1"</span> <span class="hljs-attr">intensity</span>=<span class="hljs-string">"3"</span> <span class="hljs-attr">cast-shadow</span> /&gt;</span>
  <span class="hljs-comment">&lt;!-- AR 追踪器 对应也要开启 Plane 模式 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-ar-tracker</span> <span class="hljs-attr">mode</span>=<span class="hljs-string">"Plane"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 找到平面后，显示视觉指示器 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-gltf</span> <span class="hljs-attr">model</span>=<span class="hljs-string">"anchor"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">xr-gltf</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">xr-ar-tracker</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 首先隐藏虚拟物体 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-node</span> <span class="hljs-attr">node-id</span>=<span class="hljs-string">"setitem"</span> <span class="hljs-attr">visible</span>=<span class="hljs-string">"false"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-gltf</span> <span class="hljs-attr">model</span>=<span class="hljs-string">"miku"</span> <span class="hljs-attr">anim-autoplay</span> <span class="hljs-attr">scale</span>=<span class="hljs-string">"0.07 0.07 0.07"</span> <span class="hljs-attr">rotation</span>=<span class="hljs-string">"0 180 0"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-mesh</span> <span class="hljs-attr">node-id</span>=<span class="hljs-string">"plane"</span> <span class="hljs-attr">geometry</span>=<span class="hljs-string">"plane"</span> <span class="hljs-attr">material</span>=<span class="hljs-string">"mat"</span> <span class="hljs-attr">scale</span>=<span class="hljs-string">"0.3 0.3 0.3"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">xr-node</span>&gt;</span>
   <span class="hljs-comment">&lt;!-- camera 的 background 设置成 ar --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-camera</span> <span class="hljs-attr">clear-color</span>=<span class="hljs-string">"0.4 0.8 0.6 1"</span> <span class="hljs-attr">background</span>=<span class="hljs-string">"ar"</span> <span class="hljs-attr">is-ar-camera</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">xr-scene</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Component</span>({
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-attr">handleAssetsLoaded</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">{ detail }</span>) {
      wx.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">'点击屏幕放置模型'</span> });
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scene</span>.<span class="hljs-property">event</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'touchstart'</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 虚拟物体被"放置"到现实世界的平面</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">scene</span>.<span class="hljs-property">ar</span>.<span class="hljs-title function_">placeHere</span>(<span class="hljs-string">'setitem'</span>, <span class="hljs-literal">true</span>);
      });
    },
    <span class="hljs-attr">handleReady</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">{ detail }</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scene</span> = detail.<span class="hljs-property">value</span>;
    },
  }
})
</code></pre>
<h4 data-id="heading-18">Marker 识别</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14ffaf8f391e4cd28061271c5e381be7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=PyxGxGnPor3oXQXLi2RdHa6uDmk%3D" alt="123" loading="lazy"/></p>
<p>源码示例: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdeepred5%2Fxr-frame-tutorial%2Ftree%2Fmain%2Fcomponents%2Fdemo4%2Findex.wxml" target="_blank" title="https://github.com/deepred5/xr-frame-tutorial/tree/main/components/demo4/index.wxml" ref="nofollow noopener noreferrer">Marker 模式</a></p>
<p><strong>Marker 模式</strong>，能够识别预先设定的目标物体(定义为 Marker，包括2D平面物体和3D物体），进行视觉跟踪与定位，通过在目标物体周围渲染虚拟物体，从而实现AR功能。</p>
<p>模型与现实物体保持空间位置关系(即：3D 层级 效果)。</p>
<p>Marker 分类</p>
<ol>
<li>2D Marker，仅适用于平面类物体，用户上传一张平面物体的俯视图像作为目标物体，算法运行时识别该平面物品，并渲染出相关虚拟物体。2D Marker可以理解为特殊的 3D Marker。</li>
<li>3D Marker，相比于2D Marker，能够识别3D物体，不局限于平面物体，具有更广的使用范围，算法运行前，需要手动制作3D Marker的识别目标文件（.map文件），然后算法运行时载入该文件用于识别</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">xr-scene</span> <span class="hljs-attr">ar-system</span>=<span class="hljs-string">"modes:Marker"</span> <span class="hljs-attr">bind:ready</span>=<span class="hljs-string">"handleReady"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-assets</span> <span class="hljs-attr">bind:loaded</span>=<span class="hljs-string">"handleAssetsLoaded"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-load</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"video-texture"</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"hikari"</span> <span class="hljs-attr">options</span>=<span class="hljs-string">"loop:true"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://assets.xxxx.com/resources/cdn/20250925/1c85f5b5ecde29ea.mp4"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-load</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"texture"</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"deepred2"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://assets.xxxx.com/resources/cdn/20250925/c737cf37d083d543.png"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-material</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"mat"</span> <span class="hljs-attr">effect</span>=<span class="hljs-string">"simple"</span> <span class="hljs-attr">uniforms</span>=<span class="hljs-string">"u_baseColorMap: video-hikari"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-material</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"mat3"</span> <span class="hljs-attr">effect</span>=<span class="hljs-string">"simple"</span> <span class="hljs-attr">uniforms</span>=<span class="hljs-string">"u_baseColorMap: deepred2"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">xr-assets</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-node</span> <span class="hljs-attr">wx:if</span>=<span class="hljs-string">"{{loaded}}"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-ar-tracker</span> <span class="hljs-attr">mode</span>=<span class="hljs-string">"Marker"</span> <span class="hljs-attr">bind:ar-tracker-switch</span>=<span class="hljs-string">"handleTrackerSwitch"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://assets.xxxx.com/resources/cdn/20250925/fe8dad0e9800ef81.jpg"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">xr-mesh</span> <span class="hljs-attr">node-id</span>=<span class="hljs-string">"mesh-plane"</span> <span class="hljs-attr">geometry</span>=<span class="hljs-string">"plane"</span> <span class="hljs-attr">material</span>=<span class="hljs-string">"mat"</span> <span class="hljs-attr">scale</span>=<span class="hljs-string">"1.7778 1 1"</span> <span class="hljs-attr">position</span>=<span class="hljs-string">"0 0.1 0"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">xr-mesh</span> <span class="hljs-attr">node-id</span>=<span class="hljs-string">"plane"</span> <span class="hljs-attr">geometry</span>=<span class="hljs-string">"plane"</span> <span class="hljs-attr">material</span>=<span class="hljs-string">"mat3"</span> <span class="hljs-attr">position</span>=<span class="hljs-string">"0.1 0.8 0.1"</span> <span class="hljs-attr">scale</span>=<span class="hljs-string">"0.12 0.12 0.12"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">xr-ar-tracker</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">xr-node</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-camera</span> <span class="hljs-attr">clear-color</span>=<span class="hljs-string">"0.4 0.8 0.6 1"</span> <span class="hljs-attr">background</span>=<span class="hljs-string">"ar"</span> <span class="hljs-attr">is-ar-camera</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">xr-scene</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Component</span>({
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-attr">handleReady</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">{ detail }</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scene</span> = detail.<span class="hljs-property">value</span>;
    },
    <span class="hljs-attr">handleAssetsLoaded</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">{ detail }</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">loaded</span>: <span class="hljs-literal">true</span> });
    },
    <span class="hljs-attr">handleTrackerSwitch</span>: <span class="hljs-keyword">function</span> (<span class="hljs-params">{ detail }</span>) {
      <span class="hljs-comment">// 获取追踪状态</span>
      <span class="hljs-keyword">const</span> active = detail.<span class="hljs-property">value</span>;
      <span class="hljs-keyword">const</span> video = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scene</span>.<span class="hljs-property">assets</span>.<span class="hljs-title function_">getAsset</span>(<span class="hljs-string">'video-texture'</span>, <span class="hljs-string">'hikari'</span>);
      <span class="hljs-comment">// 识别到物体，播放视频</span>
      <span class="hljs-comment">// 识别中，暂停视频</span>
      active ? video.<span class="hljs-title function_">play</span>() : video.<span class="hljs-title function_">stop</span>();
    }
  }
})
</code></pre>
<h4 data-id="heading-19">OSD 识别</h4>
<p>源码示例: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdeepred5%2Fxr-frame-tutorial%2Ftree%2Fmain%2Fcomponents%2Fdemo5%2Findex.wxml" target="_blank" title="https://github.com/deepred5/xr-frame-tutorial/tree/main/components/demo5/index.wxml" ref="nofollow noopener noreferrer">OSD 模式</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27bd28dd2952405fa4aade80d32839e9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rex57qi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765518814&amp;x-signature=VC80mzGD80dVsOE9qi8Eq6b8bkw%3D" alt="123" loading="lazy"/></p>
<p><strong>OSD（One-shot Detection）Marker 识别模式</strong>，可以看成是一种特殊的 <code>Marker</code> 模式
：在摄像头画面上“贴图叠加”的模式，主要以 屏幕坐标系（2D） 为主，不真正感知<strong>空间深度</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">xr-scene</span> <span class="hljs-attr">ar-system</span>=<span class="hljs-string">"modes:OSD"</span> <span class="hljs-attr">bind:ready</span>=<span class="hljs-string">"handleReady"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-assets</span> <span class="hljs-attr">bind:loaded</span>=<span class="hljs-string">"handleAssetsLoaded"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-material</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"mat"</span> <span class="hljs-attr">effect</span>=<span class="hljs-string">"simple"</span> <span class="hljs-attr">states</span>=<span class="hljs-string">"alphaMode:BLEND"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-material</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"text-simple"</span> <span class="hljs-attr">effect</span>=<span class="hljs-string">"simple"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">xr-assets</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-node</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-ar-tracker</span> <span class="hljs-attr">mode</span>=<span class="hljs-string">"OSD"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://assets.xxxx.com/resources/cdn/20250925/fe8dad0e9800ef81.jpg"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">xr-node</span> <span class="hljs-attr">rotation</span>=<span class="hljs-string">"0 180 0"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">xr-mesh</span> <span class="hljs-attr">node-id</span>=<span class="hljs-string">"text-wrap"</span> <span class="hljs-attr">geometry</span>=<span class="hljs-string">"plane"</span> <span class="hljs-attr">material</span>=<span class="hljs-string">"mat"</span> <span class="hljs-attr">position</span>=<span class="hljs-string">"0 1 0"</span> <span class="hljs-attr">scale</span>=<span class="hljs-string">"1 1 0.5"</span> <span class="hljs-attr">rotation</span>=<span class="hljs-string">"90 0 0"</span> <span class="hljs-attr">uniforms</span>=<span class="hljs-string">"u_baseColorFactor:0.875 0.616 0.624 1"</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">xr-text</span> <span class="hljs-attr">node-id</span>=<span class="hljs-string">"text-name"</span> <span class="hljs-attr">position</span>=<span class="hljs-string">"-0.25 1.05 0"</span> <span class="hljs-attr">scale</span>=<span class="hljs-string">"0.1 0.1 0.1"</span> <span class="hljs-attr">material</span>=<span class="hljs-string">"text-simple"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"美食家蜜蜂"</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">xr-node</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">xr-ar-tracker</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">xr-node</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-camera</span> <span class="hljs-attr">clear-color</span>=<span class="hljs-string">"0.4 0.8 0.6 1"</span> <span class="hljs-attr">background</span>=<span class="hljs-string">"ar"</span> <span class="hljs-attr">is-ar-camera</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">xr-scene</span>&gt;</span>
</code></pre>
<h4 data-id="heading-20">人脸识别</h4>
<p>源码示例: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdeepred5%2Fxr-frame-tutorial%2Ftree%2Fmain%2Fcomponents%2Fdemo2%2Findex.wxml" target="_blank" title="https://github.com/deepred5/xr-frame-tutorial/tree/main/components/demo2/index.wxml" ref="nofollow noopener noreferrer">人脸识别</a></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- AR system 系统开启 Face 模式 同时开启前置摄像头 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">xr-scene</span> <span class="hljs-attr">ar-system</span>=<span class="hljs-string">"modes:Face;camera:Front"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-assets</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-asset-load</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"gltf"</span> <span class="hljs-attr">asset-id</span>=<span class="hljs-string">"mask"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://mmbizwxaminiprogram-1258344707.cos.ap-guangzhou.myqcloud.com/xr-frame/demo/jokers_mask_persona5.glb"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">xr-assets</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- AR 追踪器 对应也要开启 Face 模式 --&gt;</span>
  <span class="hljs-comment">&lt;!-- auto-sync 是一个数字数组，用于将对应顺序的子节点绑定到某个特征点上 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-ar-tracker</span> <span class="hljs-attr">mode</span>=<span class="hljs-string">"Face"</span> <span class="hljs-attr">auto-sync</span>=<span class="hljs-string">"43"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 包含识别成功后需要展示的场景 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">xr-gltf</span> <span class="hljs-attr">model</span>=<span class="hljs-string">"mask"</span> <span class="hljs-attr">rotation</span>=<span class="hljs-string">"0 180 0"</span> <span class="hljs-attr">scale</span>=<span class="hljs-string">"0.5 0.5 0.5"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">xr-ar-tracker</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-light</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"ambient"</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"1 1 1"</span> <span class="hljs-attr">intensity</span>=<span class="hljs-string">"1"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-light</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"directional"</span> <span class="hljs-attr">rotation</span>=<span class="hljs-string">"40 70 0"</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"1 1 1"</span> <span class="hljs-attr">intensity</span>=<span class="hljs-string">"3"</span> /&gt;</span>
  <span class="hljs-comment">&lt;!-- AR 相机 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">xr-camera</span> <span class="hljs-attr">background</span>=<span class="hljs-string">"ar"</span> <span class="hljs-attr">is-ar-camera</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">xr-scene</span>&gt;</span>
</code></pre>
<p>除了人脸识别（Face），还有 人体识别（Body），人手识别（Hand），可以参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fcomponent%2Fxr-frame%2Far%2Ftracker.html%23Body" target="_blank" title="https://developers.weixin.qq.com/miniprogram/dev/component/xr-frame/ar/tracker.html#Body" ref="nofollow noopener noreferrer">官方文档学习</a></p>
<h2 data-id="heading-21">总结</h2>
<p>到这里，我们已经把 XR-FRAME 的基础能力都过了一遍：从创建场景、添加物体、设置光照，到加载模型和动画，再到四种 AR 识别模式（Plane、Marker、OSD、Face）。理论上，你已经可以做出一个简单的 AR 效果了。</p>
<p>但理论和实际总是有差距的。在下一篇<strong>实战篇</strong>中，我会分享更高阶的知识点和实际项目中的经验：</p>
<ul>
<li><strong>Shader 着色器</strong>：实现自定义视觉效果，让 AR 场景更炫酷</li>
<li><strong>同层渲染</strong>：XR 组件和小程序原生组件互相通信，实现复杂的 UI 交互</li>
<li><strong>企业级方案</strong>：性能优化、状态管理、多设备兼容等实战经验</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter: Dio + Retrofit 入门（面向 Android 开发者）]]></title>    <link>https://juejin.cn/post/7579921879973429294</link>    <guid>https://juejin.cn/post/7579921879973429294</guid>    <pubDate>2025-12-05T06:00:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579921879973429294" data-draft-id="7579567346390695962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter: Dio + Retrofit 入门（面向 Android 开发者）"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2025-12-05T06:00:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="renxhui"/> <meta itemprop="url" content="https://juejin.cn/user/1292681403181944"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter: Dio + Retrofit 入门（面向 Android 开发者）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1292681403181944/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    renxhui
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T06:00:34.000Z" title="Fri Dec 05 2025 06:00:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Flutter: Dio + Retrofit 入门（面向 Android 开发者）</h2>
<blockquote>
<p>目标：用 Android Retrofit 的思维快速上手 Dart/Flutter 的 Dio + Retrofit 组合，从依赖引入 → 初始化 → 接口定义 → 代码生成 → 调用与排错。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">1. 依赖引入（pubspec.yaml）</h3>
<p>你项目已包含部分依赖，可按需校对版本（以下为示例，建议与现有项目版本一致）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">dependencies:</span>
  <span class="hljs-attr">dio:</span> <span class="hljs-string">^5.x.x</span>
  <span class="hljs-attr">retrofit:</span> <span class="hljs-string">^4.x.x</span>
  <span class="hljs-attr">json_annotation:</span> <span class="hljs-string">^4.x.x</span>

<span class="hljs-attr">dev_dependencies:</span>
  <span class="hljs-attr">build_runner:</span> <span class="hljs-string">^2.x.x</span>
  <span class="hljs-attr">retrofit_generator:</span> <span class="hljs-string">^8.x.x</span>
  <span class="hljs-attr">json_serializable:</span> <span class="hljs-string">^6.x.x</span>
</code></pre>
<p>执行：</p>
<pre><code class="hljs language-bash" lang="bash">flutter pub get
</code></pre>
<hr/>
<h3 data-id="heading-2">2. 初始化 Dio（拦截器/超时/日志）</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// lib/network/base_dio.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:dio/dio.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/foundation.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseDio</span> </span>{
  <span class="hljs-keyword">static</span> Dio create({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> baseUrl,
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt;? defaultHeaders,
    <span class="hljs-built_in">bool</span> enableLog = kDebugMode,
  }) {
    <span class="hljs-keyword">final</span> dio = Dio(BaseOptions(
      baseUrl: baseUrl,
      connectTimeout: <span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">10</span>),
      receiveTimeout: <span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">20</span>),
      headers: {
        <span class="hljs-string">'Accept'</span>: <span class="hljs-string">'application/json'</span>,
        <span class="hljs-keyword">if</span> (defaultHeaders != <span class="hljs-keyword">null</span>) ...defaultHeaders,
      },
    ));

    <span class="hljs-keyword">if</span> (enableLog) {
      dio.interceptors.add(LogInterceptor(
        request: <span class="hljs-keyword">true</span>,
        requestHeader: <span class="hljs-keyword">true</span>,
        requestBody: <span class="hljs-keyword">true</span>,
        responseHeader: <span class="hljs-keyword">false</span>,
        responseBody: <span class="hljs-keyword">true</span>,
        error: <span class="hljs-keyword">true</span>,
      ));
    }

    <span class="hljs-comment">// 自定义拦截器（token 注入、统一错误处理等）</span>
    dio.interceptors.add(InterceptorsWrapper(
      onRequest: (options, handler) {
        <span class="hljs-comment">// options.headers['Authorization'] = 'Bearer xxx';</span>
        handler.next(options);
      },
      onResponse: (response, handler) =&gt; handler.next(response),
      onError: (e, handler) =&gt; handler.next(e),
    ));

    <span class="hljs-keyword">return</span> dio;
  }
}
</code></pre>
<hr/>
<h3 data-id="heading-3">3. 通用响应模型（可选，推荐配合 json_serializable）</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// lib/network/api_response.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:json_annotation/json_annotation.dart'</span>;
<span class="hljs-keyword">part</span> <span class="hljs-string">'api_response.g.dart'</span>;

<span class="hljs-meta">@JsonSerializable</span>(genericArgumentFactories: <span class="hljs-keyword">true</span>, explicitToJson: <span class="hljs-keyword">true</span>)
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ApiResponse</span>&lt;<span class="hljs-title">T</span>&gt; </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int?</span> code;               <span class="hljs-comment">// 0 / 200 -&gt; success</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> message;         <span class="hljs-comment">// 或 err_msg</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> errMsg;
  <span class="hljs-keyword">final</span> T? data;

  <span class="hljs-keyword">const</span> ApiResponse({<span class="hljs-keyword">this</span>.code, <span class="hljs-keyword">this</span>.message, <span class="hljs-keyword">this</span>.errMsg, <span class="hljs-keyword">this</span>.data});

  <span class="hljs-built_in">bool</span> <span class="hljs-keyword">get</span> isSuccess =&gt; code == <span class="hljs-number">0</span> || code == <span class="hljs-number">200</span>;

  <span class="hljs-keyword">factory</span> ApiResponse.fromJson(
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; json,
    T <span class="hljs-built_in">Function</span>(<span class="hljs-built_in">Object?</span> json) fromJsonT,
  ) =&gt; _$ApiResponseFromJson(json, fromJsonT);

  <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; toJson(<span class="hljs-built_in">Object?</span> <span class="hljs-built_in">Function</span>(T value) toJsonT) =&gt;
      _$ApiResponseToJson(<span class="hljs-keyword">this</span>, toJsonT);
}
</code></pre>
<p>生成（首次或模型调整后）：</p>
<pre><code class="hljs language-bash" lang="bash">flutter pub run build_runner build --delete-conflicting-outputs
</code></pre>
<hr/>
<h3 data-id="heading-4">4. Retrofit 接口定义（与 Android Retrofit 思路一致）</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// lib/network/api_service.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:dio/dio.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:retrofit/retrofit.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'api_response.dart'</span>;

<span class="hljs-keyword">part</span> <span class="hljs-string">'api_service.g.dart'</span>;

<span class="hljs-meta">@RestApi</span>()
<span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ApiService</span> </span>{
  <span class="hljs-keyword">factory</span> ApiService(Dio dio, {<span class="hljs-built_in">String</span> baseUrl}) = _ApiService;

  <span class="hljs-comment">// GET 示例（回声服务）</span>
  <span class="hljs-meta">@GET</span>(<span class="hljs-string">'/get'</span>)
  Future&lt;HttpResponse&lt;<span class="hljs-built_in">dynamic</span>&gt;&gt; httpBinGet();

  <span class="hljs-comment">// 业务示例：登录（返回强类型）</span>
  <span class="hljs-meta">@POST</span>(<span class="hljs-string">'/login'</span>)
  Future&lt;ApiResponse&lt;LoginData&gt;&gt; login(<span class="hljs-meta">@Body</span>() <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; body);
}

<span class="hljs-comment">// 模型示例</span>
<span class="hljs-comment">// lib/network/login_data.dart</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:json_annotation/json_annotation.dart'</span>;
<span class="hljs-keyword">part</span> <span class="hljs-string">'login_data.g.dart'</span>;

<span class="hljs-meta">@JsonSerializable</span>()
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoginData</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> userId;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> token;
  LoginData({<span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.userId, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.token});
  <span class="hljs-keyword">factory</span> LoginData.fromJson(<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; json) =&gt; _$LoginDataFromJson(json);
  <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; toJson() =&gt; _$LoginDataToJson(<span class="hljs-keyword">this</span>);
}
</code></pre>
<p>生成接口桩文件：</p>
<pre><code class="hljs language-bash" lang="bash">flutter pub run build_runner build --delete-conflicting-outputs
</code></pre>
<hr/>
<h3 data-id="heading-5">5. 组装与调用</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:dio/dio.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'base_dio.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'api_service.dart'</span>;

<span class="hljs-keyword">final</span> dio = BaseDio.create(baseUrl: <span class="hljs-string">'https://httpbin.org'</span>);
<span class="hljs-keyword">final</span> api = ApiService(dio, baseUrl: <span class="hljs-string">'https://httpbin.org'</span>);

Future&lt;<span class="hljs-keyword">void</span>&gt; ping() <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">final</span> resp = <span class="hljs-keyword">await</span> api.httpBinGet();
    <span class="hljs-comment">// resp.response 为 Dio 的 Response；resp.data 为 decoded body</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'status=<span class="hljs-subst">${resp.response.statusCode}</span>, url=<span class="hljs-subst">${resp.data[<span class="hljs-string">'url'</span>]}</span>'</span>);
  } <span class="hljs-keyword">on</span> DioException <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'dio error: <span class="hljs-subst">${e.message}</span>'</span>);
  }
}

Future&lt;<span class="hljs-keyword">void</span>&gt; doLogin() <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">final</span> loginApi = ApiService(BaseDio.create(baseUrl: <span class="hljs-string">'https://api.example.com'</span>),
      baseUrl: <span class="hljs-string">'https://api.example.com'</span>);
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">final</span> res = <span class="hljs-keyword">await</span> loginApi.login({<span class="hljs-string">'accountNumber'</span>: <span class="hljs-string">'a'</span>, <span class="hljs-string">'password'</span>: <span class="hljs-string">'b'</span>});
    <span class="hljs-keyword">if</span> (res.isSuccess) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'token=<span class="hljs-subst">${res.data?.token}</span>'</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'login fail code=<span class="hljs-subst">${res.code}</span> msg=<span class="hljs-subst">${res.message ?? res.errMsg}</span>'</span>);
    }
  } <span class="hljs-keyword">on</span> DioException <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'network error: <span class="hljs-subst">${e.message}</span>'</span>);
  }
}
</code></pre>
<hr/>
<h3 data-id="heading-6">6. 进阶要点</h3>
<ul>
<li>返回类型选择：
<ul>
<li><code>Future&lt;HttpResponse&lt;T&gt;&gt;</code> 需要底层 <code>Response</code> 细节（headers/status）时用；</li>
<li><code>Future&lt;T&gt;</code> 够用时返回强类型模型；</li>
<li>响应结构不稳定时可用 <code>dynamic</code>/<code>Map&lt;String, dynamic&gt;</code> 临时兜底。</li>
</ul>
</li>
<li>错误处理：Dio v5 抛 <code>DioException</code>，可通过 <code>e.type</code> 区分超时、响应错误等。</li>
<li>拦截器：统一 Header（如 Token）、统一错误码处理、重试策略等。</li>
<li>多环境：用不同 <code>baseUrl</code> 或注入不同 <code>Dio</code> 实例（上层配置）。</li>
<li>代码生成：所有 <code>part '*.g.dart'</code> 文件禁止手改；模型与接口调整后重新生成。</li>
</ul>
<hr/>
<h3 data-id="heading-7">7. 快速排错清单</h3>
<ul>
<li>“Target of URI doesn't exist” → 未生成 <code>*.g.dart</code> 或 <code>part</code> 路径不匹配文件名大小写。</li>
<li>“Map.fromJson 调用错误” → Retrofit 返回泛型为 <code>Map&lt;String, dynamic&gt;</code> 时，优先改为 <code>dynamic</code> 或定义强类型模型。</li>
<li>运行时 4xx/5xx → 用 <code>HttpResponse</code> 检查 <code>response.statusCode</code> 与 <code>response.data</code> 并结合 LogInterceptor。</li>
<li>iOS/Android 真机无网络 → 检查代理/网络权限/域名可达性（可先用 <code>https://httpbin.org/get</code> 连通性测试）。</li>
</ul>
<hr/>
<h3 data-id="heading-8">8. 最小连通性测试（推荐先跑通）</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">final</span> api = ApiService(BaseDio.create(baseUrl: <span class="hljs-string">'https://httpbin.org'</span>), baseUrl: <span class="hljs-string">'https://httpbin.org'</span>);
<span class="hljs-keyword">final</span> resp = <span class="hljs-keyword">await</span> api.httpBinGet();
<span class="hljs-built_in">print</span>(resp.data[<span class="hljs-string">'url'</span>]); <span class="hljs-comment">// 期望输出: https://httpbin.org/get</span>
</code></pre>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🎉刚入职的AIops菜鸡，应该知道gang-scheduling和binpack调度吗？]]></title>    <link>https://juejin.cn/post/7579946275435610122</link>    <guid>https://juejin.cn/post/7579946275435610122</guid>    <pubDate>2025-12-05T06:00:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579946275435610122" data-draft-id="7579946275435544586" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🎉刚入职的AIops菜鸡，应该知道gang-scheduling和binpack调度吗？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-05T06:00:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="有态度的下等马"/> <meta itemprop="url" content="https://juejin.cn/user/448256476727662"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🎉刚入职的AIops菜鸡，应该知道gang-scheduling和binpack调度吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/448256476727662/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    有态度的下等马
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T06:00:02.000Z" title="Fri Dec 05 2025 06:00:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 可插拔的调度框架</h2>
<p>k8s以可插拔的插件方式实现了调度能力，插件可以实现多个扩展点接口来执行更复杂或有状态的任务。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a004cfb8f4bd499a86b6549e64f4f5bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765519202&amp;x-signature=7M4i9KrZKLWLoGIZVIHqVE5igU0%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fkubernetes.io%2Fdocs%2Freference%2Fscheduling%2Fconfig%2F%23scheduling-plugins" title="https://kubernetes.io/docs/reference/scheduling/config/#scheduling-plugins" target="_blank" ref="nofollow noopener noreferrer">默认的调度插件</a> 给出了他们实现的扩展点、默认的打分策略。</p>
<p>在AI工程中要重点关注默认调度器带来的副作用：</p>
<p>① 默认的调度器是以<strong>Pod为调度单元进行依次调度，不会考虑Pod之间的相互关系</strong>。</p>
<p>② NodeResourcesFit插件默认启用的<strong>最少资源分配策略</strong>: 为避免单点故障，调度时打散了Pod。</p>
<hr/>
<h2 data-id="heading-1">2. AIops</h2>
<p>在AI工程化中，我们要面对2个现实：</p>
<p>① 很多数据计算类的离线作业（包括ML训练）具有<strong>组合调度</strong>的特点，即要求所有的子任务都能够成功创建后，整个作业才能正常运行。如果只有部分子任务启动的话，启动的子任务将持续等待剩余的子任务被调度（甚至死锁）， 这浪费了节点资源，这正是<code>Gang Scheduling</code>的场景。</p>
<p>② 在ML训练和推理时，节点上的GPU是最昂贵的算力资源，默认的<code>LeastAllocated调度策略</code>打散了Pod，很容易在节点上产生<strong>GPU碎片</strong>， 影响了资源的利用率，这时就要求<code>binpack</code>调度。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3196464004894785bba4d318fc24ef03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765519202&amp;x-signature=NpmSejdgnloFp7z54khrYbbBMOI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-2">gang-scheduling 调度</h3>
<p>gang-scheduling 是coschedule协同调度中的严格协同调度,(批处理作业完全不允许有“作业碎片”存在)， 也就是“All or Nothing”。</p>
<h3 data-id="heading-3"><a href="https://link.juejin.cn?target=https%3A%2F%2Fkubernetes.io%2Fdocs%2Fconcepts%2Fscheduling-eviction%2Fresource-bin-packing%2F" title="https://kubernetes.io/docs/concepts/scheduling-eviction/resource-bin-packing/" target="_blank" ref="nofollow noopener noreferrer">binpack调度</a></h3>
<p>顾名思义就是：装箱，在k8s调度中意味：避免资源碎片化，尽可能把节点空余出来， 最终最大化的利用节点资源。</p>
<h4 data-id="heading-4">原生NodeResourcesFit调度插件</h4>
<p>官网所述,默认调度器的NodeResourcesFit有三个打分策略</p>
<ul>
<li>LeastAllocated（默认），这种策略的目的是将工作量平均分配到各个节点，防止任何一个节点超负荷工作</li>
<li>MostAllocated</li>
<li>RequestedToCapacityRatio：根据节点资源与 pod 需求的匹配程度来决定哪个节点</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e403c898fd54f1fa69136070e230e26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765519202&amp;x-signature=aGHc4b5Q0ItfFQWVYUX6XoUKiEE%3D" alt="" loading="lazy"/></p>
<hr/>
<p>同一个k8s集群，为了让在线任务和离线任务的不同调度需求能优雅落地，项目引入了koordinator 调度器。</p>
<blockquote>
<p>Koordinator 是一个基于 QoS 的 Kubernetes 混合工作负载调度系统。它旨在提高对延迟敏感的工作负载和批处理作业的运行时效率和可靠性，简化与资源相关的配置调整的复杂性，并增加 Pod 部署密度以提高资源利用率。</p>
</blockquote>
<h2 data-id="heading-5">3.koordinator一把梭</h2>
<h3 data-id="heading-6">3.1 准备环境/背景</h3>
<p>① 本次使用minikube：<code>minikube start --cni=auto --nodes=3 --addons=metrics-server</code></p>
<blockquote>
<p>binpack依赖metrics-server插件判断节点资源利用情况，每个节点默认2核心cpu/2200MB内存。<br/>
对control-plane添加污点<code>kubectl taint nodes minikube node-role.kubernetes.io/control-plane=true:NoSchedule</code>， 只关注两个worker节点的调度。</p>
</blockquote>
<p>② 本次环境无gpu硬件， 本次<a href="https://link.juejin.cn?target=https%3A%2F%2Fkubernetes.io%2Fdocs%2Ftasks%2Fadminister-cluster%2Fextended-resource-node%2F" title="https://kubernetes.io/docs/tasks/administer-cluster/extended-resource-node/" target="_blank" ref="nofollow noopener noreferrer">在k8s上安装虚拟资源：<code>example.com/dongle</code></a></p>
<p>下面对2台worker分别构造了8卡虚拟资源</p>
<pre><code class="hljs language-json" lang="json">kubectl proxy 

# 每个节点申请过<span class="hljs-number">8</span>卡机器
curl --header <span class="hljs-string">"Content-Type: application/json-patch+json"</span> \
  --request PATCH \
  --data '<span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"op"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"add"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/status/capacity/example.com~1dongle"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"8"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>' \
  http<span class="hljs-punctuation">:</span><span class="hljs-comment">//127.00.1:8001/api/v1/nodes/minikube-m02/status</span>


  curl --header <span class="hljs-string">"Content-Type: application/json-patch+json"</span> \
  --request PATCH \
  --data '<span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"op"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"add"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"/status/capacity/example.com~1dongle"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"8"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>' \
  http<span class="hljs-punctuation">:</span><span class="hljs-comment">//127.0.0.1:8001/api/v1/nodes/minikube-m03/status</span>
</code></pre>
<p>③ 启动2副本pod，查看默认调度结果</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># deploy.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">vgpu-job</span> <span class="hljs-comment"># 本次deploy的资源名称</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span> <span class="hljs-comment"># 启动2副本</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">vgpu-job</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">vgpu-job</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">busybox</span>
        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">curlimage</span>
        <span class="hljs-attr">command:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">sleep</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">365d</span>
        <span class="hljs-attr">resources:</span>
          <span class="hljs-attr">limits:</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">40m</span>
            <span class="hljs-attr">memory:</span> <span class="hljs-string">40Mi</span>
            <span class="hljs-attr">example.com/dongle:</span> <span class="hljs-number">2</span>
          <span class="hljs-attr">requests:</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">40m</span>
            <span class="hljs-attr">memory:</span> <span class="hljs-string">40Mi</span>
            <span class="hljs-attr">example.com/dongle:</span> <span class="hljs-number">2</span> 
</code></pre>
<p>每个pod申请2卡<code>example.com/dongle</code>资源，默认调度器的输出：启动的2pod均匀分布到2个worker节点</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e2263f8893d427281375257bb9c2efa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765519202&amp;x-signature=nfF5Vmu1naa5BxPskgL3pnEPdWk%3D" alt="" loading="lazy"/>
按照上面的理论，再申请8卡资源会受限。</p>
<p>本地为不影响原生调度器的能力，将koordinator作为第二套调度器。</p>
<h3 data-id="heading-7">3.2 gang scheduling</h3>
<p>koordinator支持gang scheduling 可使用crd或者注解的方式，这里我们使用crd：</p>
<p>该任务要求3pod，形成组调度：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># pg.deploy.yaml</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">scheduling.sigs.k8s.io/v1alpha1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">PodGroup</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">gang-example</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">scheduleTimeoutSeconds:</span> <span class="hljs-number">10</span>
  <span class="hljs-attr">minMember:</span> <span class="hljs-number">3</span>
</code></pre>
<p>修改业务manifest文件，指定<code>koord-scheduler</code>调度器和gang scheduling规格对象标签。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2b151a553ce47f7a970dd58691aa6a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765519202&amp;x-signature=a%2FKGjkrja%2FZJeTIBIGMvaw2UGqg%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">3.3 binpack</h3>
<p>koordinator有<a href="https://link.juejin.cn?target=https%3A%2F%2Fkoordinator.sh%2Fzh-Hans%2Fdocs%2Fuser-manuals%2Fnode-resource-fit-plus-scoring" title="https://koordinator.sh/zh-Hans/docs/user-manuals/node-resource-fit-plus-scoring" target="_blank" ref="nofollow noopener noreferrer">NodeResourcesFitPlus插件</a> 来做binpack调度。</p>
<p>本例模拟节点上GPU的分配，希望将应用都binpack到一个节点上，而不是均分到多个节点，那么对于资源<code>example.com/dongle</code>的权重要设高。<br/>
修改koordinator的NodeResourcesFitPlus插件配置：</p>
<blockquote>
<p>!!! 以helm方式安装的Koordinator的，对外没有修改插件配置的入口。<br/>
本次拉取helm chart到本地，对<code>template/koord-scheduler-config.yaml</code>新增了插件配置，切记不要用红框内容完全替换文件，而是拿下面的配置patch到文件。<br/>
helm upgrade koordinator ./<br/>
kubectl  rollout restart deploy/koord-scheduler -n koordinator-system</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6f369b2d2ed044a481f1d47e98322e0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765519202&amp;x-signature=YojZiL26%2B8MYf1MefF5Vv2uiT7s%3D" alt="" loading="lazy"/></p>
<p>插件NodeResourcesFitPlus两种策略的评分计算方法和效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d75b7a9430654918b73460016dd84e45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765519202&amp;x-signature=eFvZZKpVtbDa03I1AcazDeUACsY%3D" alt="" loading="lazy"/></p>
<p>最终的节点评分可以按如下方式计算：</p>
<p><code>finalScoreNode = [(weight1 * resource1) + (weight2 * resource2) + … + (weightN* resourceN)] /(weight1+weight2+ … +weightN)</code></p>
<p>那么节点的打分：</p>
<p>nodeScore =  (20* MostAllocatedAlg + 2* LeastAllocatedAlg + 1* LeastAllocatedAlg  )/（20+2+1），</p>
<p>粗略想象在第一个Pod被调度到节点A之后， 调度第二个Pod时， 节点A的MostAllocatedAlg = 2/6， 而节点B的MostAllocatedAlg = 2/8,  20的权重值在分子端占据更大因素，故第二个Pod也会更倾向于调度到节点A， 这样算法就做到了binpack。</p>
<hr/>
<p>到这里条件就都就绪了:
2台节点（均有8卡资源），每个Pod占用2卡资源，要求3 Pod形成组调度，且要求是binpack调度。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23dd0545478b4eb89af27958e05bb658~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765519202&amp;x-signature=0HiASU8WU9sbhtOrhMKXctoaBK4%3D" alt="" loading="lazy"/></p>
<p>验证有效，目前3Pod占用了minikube-m03节点上6卡资源，继续扩容到5 Pod，理论上会有一个Pod调度到另外一个worker节点。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0490d25c382d417582d7084b237780a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765519202&amp;x-signature=Rp6c2jiz56%2FQJ9FpxD64ga%2F1Guc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">总结</h2>
<p>本文回顾了在云原生背景下AIops 与原生k8s调度器的格格不入。</p>
<p>演示了开源的koordinator调度器是如何支持AIOps场景下的gang-scheduling 和binpack调度。</p>
<p>gang-scheduling 聚焦于k8s集群中上层批处理作业要求的Pod协作能力。</p>
<p>binpack 聚焦于k8s集群中作为基础设施节点的资源利用率，binpack会避免打散，尽量留出空闲节点。</p>
<p>本文文字和制图均为原创，特别是binpack的验证耗费了博主1个星期的倒腾时间， 期待一键三连，交个朋友， 35+报团不迷路。🎨🎨</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【AI 编程实战】第 1 篇：TRAE SOLO 模式 10 倍速开发商业级全栈小程序]]></title>    <link>https://juejin.cn/post/7579892222609391651</link>    <guid>https://juejin.cn/post/7579892222609391651</guid>    <pubDate>2025-12-05T04:15:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579892222609391651" data-draft-id="7579813945601065000" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【AI 编程实战】第 1 篇：TRAE SOLO 模式 10 倍速开发商业级全栈小程序"/> <meta itemprop="keywords" content="前端,后端,AI编程"/> <meta itemprop="datePublished" content="2025-12-05T04:15:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HashTang"/> <meta itemprop="url" content="https://juejin.cn/user/1117561754756488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【AI 编程实战】第 1 篇：TRAE SOLO 模式 10 倍速开发商业级全栈小程序
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1117561754756488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HashTang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T04:15:06.000Z" title="Fri Dec 05 2025 04:15:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="vs2015">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1e1e1e;color:#dcdcdc}.hljs-keyword,.hljs-link,.hljs-literal,.hljs-name,.hljs-symbol{color:#569cd6}.hljs-link{text-decoration:underline}.hljs-built_in,.hljs-type{color:#4ec9b0}.hljs-class,.hljs-number{color:#b8d7a3}.hljs-meta-string,.hljs-string{color:#d69d85}.hljs-regexp,.hljs-template-tag{color:#9a5334}.hljs-formula,.hljs-function,.hljs-params,.hljs-subst,.hljs-title{color:#dcdcdc}.hljs-comment,.hljs-quote{color:#57a64a;font-style:italic}.hljs-doctag{color:#608b4e}.hljs-meta,.hljs-meta-keyword,.hljs-tag{color:#9b9b9b}.hljs-template-variable,.hljs-variable{color:#bd63c5}.hljs-attr,.hljs-attribute,.hljs-builtin-name{color:#9cdcfe}.hljs-section{color:gold}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-bullet,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-selector-tag{color:#d7ba7d}.hljs-addition{background-color:#144212}.hljs-addition,.hljs-deletion{display:inline-block;width:100%}.hljs-deletion{background-color:#600}</style><blockquote>
<p>从 2 个月到 2 周，从连滚带爬到游刃有余，AI 编程正在改变我们的开发方式。这是《<a href="https://juejin.cn/column/7579556047783624756" target="_blank" title="https://juejin.cn/column/7579556047783624756">AI 编程实战：TRAE SOLO 全栈开发指南</a>》专栏的第一篇文章，欢迎关注，不错过每一篇文章的更新。相信我，你会从这篇文章开始，体验到 AI 编程的乐趣，感受到零手写代码就能开发商业级项目的便捷。</p>
</blockquote>
<h2 data-id="heading-0">一、你还在为项目进度焦虑吗？</h2>
<p>上周，我的朋友小何找到我，一脸愁容。他接了一个恋爱话术回复类的小程序项目——"心动恋聊"，需要在 2 个月内完成从 0 到 1 的开发。看着需求文档上密密麻麻的功能点，他开始掰着手指算时间：</p>
<ul>
<li>项目架构搭建：至少 2 天</li>
<li>前端页面开发：20 个页面 × 1 天 = 20 天</li>
<li>后端 API 开发：30 个接口 × 半天 = 15 天</li>
<li>登录鉴权、状态管理、HTTP 封装：3 天</li>
<li>代码规范配置：1 天</li>
<li>Bug 修复和优化：预留 10 天</li>
<li>CI/CD 部署配置：2 天</li>
</ul>
<p>粗略一算，<strong>53 天</strong>，还没算上需求变更和各种意外情况。2 个月的工期根本不够用！</p>
<p>一周后，我再见到小何，他却一脸轻松。"怎么样，进度还好吗？" 我关心地问。</p>
<p>"已经完成 80% 了，" 他笑着说，"用了 TRAE SOLO 模式，效率简直爆表！"</p>
<p>这不是魔法，这是 AI 辅助开发的真实效果。</p>
<p><strong>2 个月的工作量，2 周完成</strong>。这不是夸张，这是我亲眼见证的真实案例，目前已经上线，大家感兴趣的可以搜索体验。</p>
<h3 data-id="heading-1">效果预览</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac66ec10cb77431298f8ba34ff504eef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSGFzaFRhbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513958&amp;x-signature=eBUoI356OqH%2Ff81YJ4AzSr6sof0%3D" alt="产品首页图.jpg" loading="lazy"/></p>
<h2 data-id="heading-2">二、TRAE SOLO 模式：你的全栈开发伙伴</h2>
<h3 data-id="heading-3">2.1 这不是又一个代码补全工具</h3>
<p>说到 AI 编程工具，你可能第一时间想到 GitHub Copilot。没错，Copilot 很好用，但它更像一个"代码补全助手"——你写前半句，它帮你补全后半句。还有人会说 Claude code，没错，它确实是最顶尖的 AI 编程工具，但是不上点特殊手段用不了。</p>
<p>而 TRAE SOLO 模式，是完全不同的存在。</p>
<p>如果说 Copilot 是一个会预测你下一句话的助手，那么 TRAE SOLO 就是一个<strong>能独立思考、主动决策的全栈开发伙伴</strong>。</p>
<p>想象一下这个场景：</p>
<p><strong>传统开发</strong>：</p>
<pre><code class="hljs language-erlang" lang="erlang">你：我需要实现用户登录
你：先查微信小程序登录文档...
你：再查 Next.js API 文档...
你：JWT 怎么用来着？搜一下...
你：前端怎么存 Token？想想...
你：代码写完了，自己审查一遍...
你：手动写测试用例...
</code></pre>
<p><strong>TRAE SOLO 模式</strong>：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">你：帮我实现微信小程序的用户登录功能

AI：好的，我来处理：
  ✓ 分析项目结构（识别到 UniApp + <span class="hljs-keyword">Next</span>.js）
  ✓ 设计登录流程（包括前后端交互）
  ✓ 生成前端登录页面（Vue3 + UView Pro）
  ✓ 生成后端 API（<span class="hljs-keyword">Next</span>.js Route Handlers）
  ✓ 实现 JWT Token 管理
  ✓ 添加 TypeScript 类型定义
  ✓ 代码审查优化
  ✓ 生成测试用例

<span class="hljs-number">3</span> 小时后，完整的登录系统已经可以运行了。
</code></pre>
<p>看出区别了吗？<strong>你从"亲力亲为"变成了"委托执行"</strong>。</p>
<h2 data-id="heading-4">三、真实项目案例：心动恋聊小程序</h2>
<p>让我详细讲讲小何的"心动恋聊"项目，看看 AI 辅助开发在真实项目中的效果。</p>
<h3 data-id="heading-5">3.1 项目背景</h3>
<p><strong>项目定位</strong>：一款面向年轻人的恋爱话术回复小程序，帮助用户高情商聊天、轻松接话。</p>
<p><strong>技术选型</strong>：</p>
<ul>
<li><strong>前端</strong>：UniApp + Vue3 + TypeScript + UnoCSS + Pinia</li>
<li><strong>后端</strong>：Next.js 15 + Prisma + PostgreSQL</li>
<li><strong>架构</strong>：Monorepo（pnpm + Turborepo）</li>
<li><strong>工程化</strong>：ESLint + Prettier + Husky + GitHub Actions</li>
</ul>
<p><strong>多平台规划</strong>（这是重点！）：</p>
<pre><code class="hljs language-css" lang="css">第一阶段：微信小程序（快速验证市场）
第二阶段：<span class="hljs-selector-tag">H5</span> 版本（扩大覆盖面）
第三阶段：鸿蒙应用（抓住新机遇）
第四阶段：安卓 App（深度用户）
第五阶段：iOS App（完整生态）
</code></pre>
<p><strong>一套代码，五端发布</strong>。这就是 UniApp 的魅力，也是为什么选择它的原因。</p>
<h3 data-id="heading-6">3.2 代码质量对比</h3>
<p>让小何惊喜的是，AI 生成的代码质量非常高：</p>
<p><strong>架构设计</strong>：</p>
<ul>
<li>✓ 标准的 Monorepo 结构</li>
<li>✓ 清晰的分包策略</li>
<li>✓ 合理的代码复用</li>
</ul>
<p><strong>类型安全</strong>：</p>
<ul>
<li>✓ 100% TypeScript 覆盖</li>
<li>✓ 前后端类型共享（shared-types 包）</li>
<li>✓ 完整的类型推导</li>
</ul>
<p><strong>工程化水平</strong>：</p>
<ul>
<li>✓ ESLint + Prettier 自动格式化</li>
<li>✓ Git Hooks 自动检查</li>
<li>✓ CI/CD 自动化部署</li>
</ul>
<p><strong>代码规范</strong>：</p>
<ul>
<li>✓ 统一的命名规范</li>
<li>✓ 清晰的注释</li>
<li>✓ 符合最佳实践</li>
</ul>
<p>小何说："AI 生成的代码，比我自己写的还要规范。"</p>
<h2 data-id="heading-7">四、AI 能在哪些方面提升你的效率？</h2>
<p>让我们深入看看，AI 到底能在哪些具体环节帮到你。</p>
<h3 data-id="heading-8">4.1 架构设计：从零经验到专家级</h3>
<p><strong>传统方式</strong>：</p>
<ul>
<li>搜索"Monorepo 最佳实践"</li>
<li>看各种博客文章</li>
<li>试错、调整、再试错</li>
</ul>
<p><strong>AI 辅助</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">你：帮我设计一个包含小程序端和服务端的 Monorepo 项目结构

AI：为你设计了这样的结构：
  packages/
  ├── apps/
  │   ├── unibest-mp/          # UniApp 小程序
  │   └── xindong-server/     # Next.js 服务端
  ├── packages/
  │   └── shared-types/        # 共享类型定义
  ├── pnpm-workspace.yaml
  ├── turbo.json
  └── package.json

  这个结构的优势：
<span class="hljs-bullet">  1.</span> 前后端代码隔离，便于独立开发
<span class="hljs-bullet">  2.</span> 共享类型包确保接口一致性
<span class="hljs-bullet">  3.</span> Turborepo 并行构建，提升效率
<span class="hljs-bullet">  4.</span> pnpm 节省磁盘空间和安装时间
</code></pre>
<p><strong>案例</strong>：配置 Turborepo 任务编排</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"pipeline"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"dependsOn"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"^build"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"outputs"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"dist/**"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">".next/**"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"cache"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"persistent"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这段配置，传统方式需要查文档、理解概念、试错，至少半天。AI 生成只需 1 分钟，还会解释每个配置的作用。</p>
<h3 data-id="heading-9">4.2 工程化配置：告别配置地狱</h3>
<p><strong>传统方式</strong>：</p>
<ul>
<li>查 ESLint 文档</li>
<li>查 Prettier 文档</li>
<li>解决规则冲突</li>
<li>配置 Husky</li>
<li>配置 lint-staged</li>
<li>配置 commitlint</li>
</ul>
<p><strong>AI 辅助</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">你：配置完整的代码质量工具链：
<span class="hljs-code">    ESLint + Prettier + Husky + commitlint
</span>
AI：为你配置了：
<span class="hljs-code">    ✓ .eslintrc.js（适配 Vue3 + TypeScript）
    ✓ .prettierrc.js（统一代码风格）
    ✓ .husky/pre-commit（提交前检查）
    ✓ .husky/commit-msg（提交信息规范）
    ✓ .lintstagedrc.js（只检查暂存文件）
    ✓ package.json 脚本命令
</span>
<span class="hljs-code">    已自动解决 ESLint 和 Prettier 的规则冲突。
</span></code></pre>
<h3 data-id="heading-10">4.3 文档生成：100% 自动化</h3>
<p><strong>传统方式</strong>：</p>
<ul>
<li>手写 API 文档</li>
<li>手写类型定义说明</li>
<li>手写代码注释</li>
</ul>
<p><strong>AI 辅助</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">你：为所有 API 接口生成文档

AI：已生成：
<span class="hljs-code">    ✓ API 接口文档（Markdown 格式）
    ✓ 类型定义文档
    ✓ 请求/响应示例
    ✓ 错误码说明
</span>
<span class="hljs-code">    保存位置：docs/api/README.md
</span></code></pre>
<h3 data-id="heading-11">4.4 学习加速：边做边学</h3>
<p><strong>传统学习路径</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 看视频教程（10 小时）
<span class="hljs-bullet">2.</span> 看官方文档（5 小时）
<span class="hljs-bullet">3.</span> 跟着 Demo 练习（10 小时）
<span class="hljs-bullet">4.</span> 应用到实际项目（反复试错）
总耗时：3-5 天
</code></pre>
<p><strong>AI 辅助学习</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">你：我不懂 Monorepo，帮我搭建项目并解释

AI：好的，我来帮你搭建并解释：

<span class="hljs-bullet">    1.</span> 创建 pnpm-workspace.yaml
<span class="hljs-code">       作用：定义 monorepo 的包管理范围
</span>
<span class="hljs-bullet">    2.</span> 创建 turbo.json
<span class="hljs-code">       作用：配置并行构建任务
</span>
<span class="hljs-bullet">    3.</span> 创建 apps/ 和 packages/ 目录
<span class="hljs-code">       apps/：存放应用代码
       packages/：存放共享代码
</span>
<span class="hljs-code">    现在你可以在实际项目中使用，遇到问题随时问我。
</span></code></pre>
<p>总耗时：<strong>1 天</strong>（边用边学）</p>
<p>学习效率提升 <strong>3-5 倍</strong>。</p>
<h3 data-id="heading-12">4.5 技术栈学习门槛降低：不要被技术栈吓跑！</h3>
<p>这是我想特别强调的一点：<strong>你不需要精通每一个技术</strong>。</p>
<p><strong>传统认知</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">想用 Prisma ORM？
→ 先学 Prisma 文档（<span class="hljs-number">2</span> 天）
→ 理解 Schema 语法（半天）
→ 学习 Migration（半天）
→ 学习查询 API（<span class="hljs-number">1</span> 天）
→ 总共：<span class="hljs-number">4</span> 天

想用 Tailwind CSS？
→ 先学所有 <span class="hljs-keyword">class</span> 名称（<span class="hljs-number">1</span> 天）
→ 理解响应式规则（半天）
→ 学习配置（半天）
→ 总共：<span class="hljs-number">2</span> 天
</code></pre>
<p><strong>AI + MCP 的新范式</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">你：不懂 Prisma？没关系！

你：帮我用 Prisma 定义用户表

AI：(通过 MCP 实时查阅 Prisma 文档)
<span class="hljs-code">    ✓ 生成 Schema 定义
    ✓ 生成 Migration 文件
    ✓ 生成查询代码
    ✓ 解释每一行的作用
</span>
你：懂了！下一个功能...
</code></pre>
<p><strong>MCP (Model Context Protocol)</strong> 让 AI 能够<strong>实时查阅最新文档</strong>，相当于 AI 随时在看官方文档，然后把最佳实践应用到你的项目中。</p>
<p><strong>这意味着什么？</strong></p>
<p>以前：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">你需要精通的技术：
☑ Vue3 Composition API
☑ UniApp 多端适配
☑ Pinia 状态管理
☑ UnoCSS 原子化 CSS
☑ TypeScript 类型系统
☑ <span class="hljs-keyword">Next</span>.js <span class="hljs-number">15</span> 新特性
☑ Prisma ORM
☑ PostgreSQL
☑ JWT 认证
☑ RESTful API 设计
☑ ...

学习时间：几个月
</code></pre>
<p>现在：</p>
<pre><code class="hljs">你需要会的：
✓ 知道这些技术的存在
✓ 知道它们能做什么
✓ 会用 AI 工具

学习时间：边用边学，1-2 周上手
</code></pre>
<p><strong>从"必须精通"到"会用即可"，学习成本大幅度降低！</strong></p>
<h2 data-id="heading-13">五、专栏系列文章导读</h2>
<p>这是一个大约 13 篇的系列文章，具体多少篇看实际情况，只会多不会少，每篇都会深入讲解一个具体环节的 AI 辅助开发实战。</p>
<h3 data-id="heading-14">第一部分：AI 辅助项目搭建（3 篇）</h3>
<p><strong>第 2 篇：让 AI 成为你的前端架构师 - UniApp + Vue3 项目初始化</strong></p>
<ul>
<li>技术选型 AI 对比分析</li>
<li>Vite 配置一键生成</li>
<li>UnoCSS + UView Pro 集成</li>
<li>自动导入配置</li>
</ul>
<p><strong>第 3 篇：AI 辅助后端开发 - Next.js 15 API 快速搭建</strong></p>
<ul>
<li>Next.js 15 新特性</li>
<li>RESTful API 设计</li>
<li>Prisma ORM 集成</li>
<li>JWT 认证中间件</li>
</ul>
<h3 data-id="heading-15">第二部分：AI 驱动的工程化实践（3 篇）</h3>
<p><strong>第 4 篇：用 AI 打造原子化 CSS 开发体系 - UnoCSS 实战</strong></p>
<ul>
<li>UnoCSS 配置生成</li>
<li>设计稿转代码</li>
<li>主题定制</li>
<li>性能优化</li>
</ul>
<p><strong>第 5 篇：AI 辅助状态管理 - Pinia Store 设计与实现</strong></p>
<ul>
<li>Store 架构设计</li>
<li>状态持久化</li>
<li>类型安全</li>
<li>最佳实践</li>
</ul>
<p><strong>第 6 篇：让 AI 守护代码质量 - ESLint + Prettier 自动化配置</strong></p>
<ul>
<li>工具链配置</li>
<li>Git Hooks 自动化</li>
<li>代码规范统一</li>
<li>AI 自动修复</li>
</ul>
<h3 data-id="heading-16">第三部分：AI 加速核心功能开发（3 篇）</h3>
<p><strong>第 7 篇：AI 实现小程序登录鉴权 - 从需求到代码一气呵成</strong></p>
<ul>
<li>微信登录流程</li>
<li>Token 管理</li>
<li>权限控制</li>
<li>完整实战</li>
</ul>
<p><strong>第 8 篇：AI 封装 HTTP 请求 - 类型安全的 API 调用方案</strong></p>
<ul>
<li>HTTP 客户端封装</li>
<li>拦截器实现</li>
<li>TypeScript 类型</li>
<li>API 模块化</li>
</ul>
<p><strong>第 9 篇：AI 驱动的页面开发 - 话术回复与恋爱计划生成</strong></p>
<ul>
<li>设计稿转代码</li>
<li>组件化开发</li>
<li>列表优化</li>
<li>交互细节</li>
</ul>
<h3 data-id="heading-17">第四部分：AI 辅助优化与部署（3 篇）</h3>
<p><strong>第 10 篇：用 AI 优化小程序性能 - 从分析到实施</strong></p>
<ul>
<li>性能分析</li>
<li>包体积优化</li>
<li>渲染优化</li>
<li>内存优化</li>
</ul>
<p><strong>第 11 篇：AI 管理类型系统 - shared-types 包的设计</strong></p>
<ul>
<li>类型系统设计</li>
<li>前后端类型共享</li>
<li>运行时验证</li>
<li>最佳实践</li>
</ul>
<p><strong>第 12 篇：AI 辅助 CI/CD - 自动化部署小程序</strong></p>
<ul>
<li>GitHub Actions 配置</li>
<li>自动化测试</li>
<li>小程序上传</li>
<li>监控告警</li>
</ul>
<p><strong>第 13 篇：AI 辅助多渠道打包，一键发布到多个平台</strong></p>
<ul>
<li>多渠道打包</li>
<li>一键发布到多个平台</li>
<li>版本管理</li>
<li>自动更新</li>
</ul>
<h3 data-id="heading-18">学习路径建议</h3>
<p><strong>新手路线</strong>：</p>
<ol>
<li>先看第 1 篇（总纲，建立认知）</li>
<li>跟着第 2-3 篇搭建项目</li>
<li>学习第 4-6 篇工程化实践</li>
<li>实战第 7-9 篇核心功能</li>
<li>进阶第 10-13 篇优化部署</li>
</ol>
<p><strong>进阶路线</strong>：</p>
<ol>
<li>第 1 篇快速浏览</li>
<li>重点看感兴趣的专题</li>
<li>结合自己的项目实践</li>
<li>总结自己的最佳实践</li>
</ol>
<h2 data-id="heading-19">六、总结：AI Coding is Coming</h2>
<p>写到这里，我想和你分享几点思考。</p>
<h3 data-id="heading-20">AI 不是替代，而是赋能</h3>
<p>很多人担心："AI 这么强，程序员会不会失业？"</p>
<p>我的答案是：<strong>不会，但不会用 AI 的程序员会被淘汰。</strong></p>
<p>AI 不是要替代你，而是让你从：</p>
<ul>
<li>重复劳动 → 创造性工作</li>
<li>熟练工 → 架构师</li>
<li>单打独斗 → 带领 AI 团队</li>
</ul>
<p>就像电力没有替代工人，而是让工人从体力劳动解放出来，去做更有价值的事情。</p>
<h3 data-id="heading-21">从"必须精通"到"会用即可"</h3>
<p>以前，做全栈开发需要精通：</p>
<ul>
<li>前端框架</li>
<li>后端框架</li>
<li>数据库</li>
<li>服务器</li>
<li>DevOps</li>
<li>...</li>
</ul>
<p>学习周期：<strong>2-3 年</strong></p>
<p>现在，有了 AI + MCP：</p>
<ul>
<li>知道技术存在</li>
<li>知道能做什么</li>
<li>会提需求</li>
<li>会用 AI 工具</li>
</ul>
<p>学习周期：<strong>0.5-1 个月</strong></p>
<p><strong>技术栈学习门槛大幅度降低，但你能做的事情反而更多了。</strong></p>
<h3 data-id="heading-22">代码质量反而更高</h3>
<p>你可能担心 AI 生成的代码质量不行。</p>
<p>事实恰恰相反：</p>
<p>AI 生成的代码：</p>
<ul>
<li>✓ 符合最佳实践</li>
<li>✓ 类型安全</li>
<li>✓ 错误处理完善</li>
<li>✓ 代码规范统一</li>
<li>✓ 注释清晰</li>
</ul>
<p>比大多数初中级开发者写的代码质量都高。</p>
<h3 data-id="heading-23">学习曲线大幅缩短</h3>
<p>以前学习一个新技术：</p>
<ol>
<li>看视频教程（10 小时）</li>
<li>看官方文档（5 小时）</li>
<li>跟着 Demo 练习（10 小时）</li>
<li>应用到实际项目（反复试错）</li>
</ol>
<p>总耗时：<strong>3-5 天</strong></p>
<p>现在有了 AI：</p>
<ol>
<li>告诉 AI 你的需求</li>
<li>AI 生成代码并解释</li>
<li>边用边学</li>
<li>遇到问题随时问</li>
</ol>
<p>总耗时：<strong>1 天</strong></p>
<h3 data-id="heading-24">多平台发布不再是梦</h3>
<p>"心动恋聊"项目的规划：</p>
<pre><code class="hljs language-css" lang="css">微信小程序 → <span class="hljs-selector-tag">H5</span> → 鸿蒙 → 安卓 → iOS
</code></pre>
<p>以前，这需要：</p>
<ul>
<li>5 个开发团队</li>
<li>5 套代码</li>
<li>5 倍的维护成本</li>
</ul>
<p>现在，有了 UniApp + AI：</p>
<ul>
<li>1 个人</li>
<li>1 套代码</li>
<li>AI 辅助适配</li>
</ul>
<p><strong>一个人，用 AI 工具，也能做出覆盖全平台的产品。</strong></p>
<h3 data-id="heading-25">邀请你一起探索</h3>
<p>这个系列的 13 篇文章，我会带你完整走一遍 AI 辅助开发的全流程：</p>
<ul>
<li>从项目搭建到上线部署</li>
<li>从前端到后端</li>
<li>从代码到工程化</li>
</ul>
<p>每篇文章都是真实项目实战。</p>
<p>如果你：</p>
<ul>
<li>想提升开发效率</li>
<li>想学习全栈开发</li>
<li>想了解 AI 编程</li>
<li>想跟上时代潮流</li>
</ul>
<p>那么，这个系列就是为你准备的。</p>
<p><strong>下一篇预告</strong>：《让 AI 成为你的前端架构师 - UniApp + Vue3 项目初始化》</p>
<p>我会手把手教你，如何用 AI 在 1 小时内搭建一个完整的前端项目架构。</p>
<p><strong>关注我，不错过每一篇实战干货！</strong></p>
<hr/>
<blockquote>
<p>如果这篇文章对你有帮助，请点赞、收藏、转发，让更多人了解 AI 编程的强大！</p>
<p>有任何问题，欢迎在评论区留言，我们一起讨论。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 18新特性实战：这5个Hook组合让我少写50%状态管理代码]]></title>    <link>https://juejin.cn/post/7579886397074980864</link>    <guid>https://juejin.cn/post/7579886397074980864</guid>    <pubDate>2025-12-05T04:16:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579886397074980864" data-draft-id="7579886397074964480" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 18新特性实战：这5个Hook组合让我少写50%状态管理代码"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-05T04:16:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 18新特性实战：这5个Hook组合让我少写50%状态管理代码
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T04:16:39.000Z" title="Fri Dec 05 2025 04:16:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>React 18新特性实战：这5个Hook组合让我少写50%状态管理代码</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>React 18的发布为开发者带来了许多激动人心的新特性，尤其是并发渲染（Concurrent Rendering）和一系列优化的Hooks API。这些改进不仅提升了应用性能，还大幅简化了状态管理的复杂度。作为一名长期深耕React生态的开发者，我发现通过合理组合React 18的新老Hooks，可以显著减少冗余的状态管理代码，甚至在某些场景下减少50%以上的工作量。</p>
<p>本文将深入探讨5个高效的Hook组合模式，涵盖以下内容：</p>
<ol>
<li><code>useState</code> + <code>useReducer</code>：轻量级状态机的完美搭配</li>
<li><code>useSyncExternalStore</code>：无缝集成外部状态库</li>
<li><code>useTransition</code> + <code>useDeferredValue</code>：优化高优先级更新</li>
<li><code>useId</code> + <code>useContext</code>：解决服务端渲染中的ID冲突</li>
<li><code>useMemo</code> + <code>useCallback</code>的性能陷阱与替代方案</li>
</ol>
<p>这些组合不仅适用于新项目，也能在现有代码库中逐步落地。让我们从第一个组合开始！</p>
<hr/>
<h2 data-id="heading-2">1. <code>useState</code> + <code>useReducer</code>：轻量级状态机的完美搭配</h2>
<h3 data-id="heading-3">问题背景</h3>
<p>在传统React开发中，复杂组件的状态管理往往需要引入Redux或MobX等第三方库。但对于中等复杂度的场景，这些方案可能显得过于笨重。</p>
<h3 data-id="heading-4">解决方案</h3>
<p>React内置的<code>useReducer</code>本身就是一个轻量级的状态机方案，结合<code>useState</code>可以分层管理状态：</p>
<ul>
<li><strong>局部UI状态</strong>（如输入框的值）用<code>useState</code></li>
<li><strong>业务逻辑状态</strong>（如表单验证、多步骤流程）用<code>useReducer</code></li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> [input, setInput] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>); <span class="hljs-comment">// UI状态</span>
<span class="hljs-keyword">const</span> [state, dispatch] = <span class="hljs-title function_">useReducer</span>(<span class="hljs-function">(<span class="hljs-params">state, action</span>) =&gt;</span> {
  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'SUBMIT'</span>:
      <span class="hljs-keyword">return</span> { ...state, <span class="hljs-attr">isLoading</span>: <span class="hljs-literal">true</span> };
    <span class="hljs-keyword">case</span> <span class="hljs-string">'SUCCESS'</span>:
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">isLoading</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">data</span>: action.<span class="hljs-property">payload</span> };
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">return</span> state;
  }
}, { <span class="hljs-attr">isLoading</span>: <span class="hljs-literal">false</span> }); <span class="hljs-comment">// 业务状态</span>
</code></pre>
<h3 data-id="heading-5">优势分析</h3>
<ul>
<li><strong>代码缩减</strong>：相比Redux样板代码减少约60%</li>
<li><strong>类型安全</strong>：配合TypeScript能实现完善的类型推导</li>
<li><strong>可测试性</strong>：纯函数的reducer易于单元测试</li>
</ul>
<hr/>
<h2 data-id="heading-6">2. <code>useSyncExternalStore</code>：无缝集成外部状态库</h2>
<h3 data-id="heading-7">React 18的新武器</h3>
<p>这个专为库开发者设计的Hook，使得任何外部存储都能以最优方式接入React的渲染流程。其核心优势在于避免了"撕裂"（tearing）问题。</p>
<h3 data-id="heading-8">实战示例</h3>
<p>假设我们需要集成Zustand商店：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useSyncExternalStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> store <span class="hljs-keyword">from</span> <span class="hljs-string">'./store'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Component</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> state = <span class="hljs-title function_">useSyncExternalStore</span>(
    store.<span class="hljs-property">subscribe</span>,
    store.<span class="hljs-property">getState</span>
  );
}
</code></pre>
<h3 data-id="heading-9">性能对比</h3>























<table><thead><tr><th>方案</th><th>内存占用</th><th>SSR支持</th><th>并发兼容</th></tr></thead><tbody><tr><td>Context API</td><td>高</td><td>✅</td><td>❌</td></tr><tr><td>useSyncExternalStore</td><td>低</td><td>✅</td><td>✅</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-10">3. <code>useTransition</code> + <code>useDeferredValue</code>：优化高优先级更新</h2>
<h3 data-id="heading-11">Concurrent Features的精髓</h3>
<p>这对组合解决了用户交互与后台计算的优先级冲突问题：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();
<span class="hljs-keyword">const</span> deferredValue = <span class="hljs-title function_">useDeferredValue</span>(value);

<span class="hljs-comment">// CPU密集型任务标记为过渡</span>
<span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">setHeavyComputeInput</span>(deferredValue);
});
</code></pre>
<h3 data-id="heading-12">Benchmark数据（处理10万条数据）</h3>
<ul>
<li><strong>传统方式</strong>：输入延迟350ms+</li>
<li><strong>过渡标记</strong>：输入延迟&lt;50ms</li>
</ul>
<hr/>
<h2 data-id="heading-13">4. <code>useId</code> + <code>useContext</code>：解决服务端渲染中的ID冲突</h2>
<h3 data-id="heading-14">SSR的老大难问题</h3>
<p>客户端与服务端生成的ID不一致会导致hydration错误。React18的解决方案：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> id = <span class="hljs-title function_">useId</span>(); <span class="hljs-comment">// → ":r1:"</span>
<span class="hljs-keyword">const</span> theme = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeContext</span>);

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">htmlFor</span>=<span class="hljs-string">{</span>`${<span class="hljs-attr">id</span>}<span class="hljs-attr">-username</span>}`&gt;</span>Username<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">id</span>=<span class="hljs-string">{</span>`${<span class="hljs-attr">id</span>}<span class="hljs-attr">-username</span>}` /&gt;</span></span>
</code></pre>
<h3 data-id="heading-15">Why It Matters?</h3>
<ul>
<li>SEO友好性提升40%（Google Lighthouse评分）</li>
<li>TTI时间缩短22%</li>
</ul>
<hr/>
<h2 data-id="heading-16">5. Memoization陷阱与替代方案</h2>
<h3 data-id="heading-17">Common Pitfalls</h3>
<p>过度使用memoization反而会降低性能：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// ❌ Anti-pattern </span>
<span class="hljs-keyword">const</span> memoizedFn = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {}, [dep]); 

<span class="hljs-comment">// ✅ Better approach</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyComponent</span>(<span class="hljs-params">{ onClick }</span>) {
   <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClick}</span> /&gt;</span></span>
}
</code></pre>
<h3 data-id="heading-18">When to Memoize?</h3>
<p>黄金法则：</p>
<ol>
<li>Props传递超过3层组件树</li>
<li>Deps数组包含引用类型</li>
<li>List项超过100条</li>
</ol>
<hr/>
<h2 data-id="heading-19">Conclusion</h2>
<p>通过这五个Hook组合拳：
1️⃣  减少了Redux依赖带来的包体积膨胀<br/>
2️⃣  提升了SSR场景下的稳定性<br/>
3️⃣  优化了CPU密集型任务的响应速度<br/>
4️⃣  标准化了跨环境ID生成</p>
<p>根据我们的生产环境实测：</p>
<ul>
<li>Codebase体积缩减47%</li>
<li>TBT指标改善38%</li>
<li>Dev体验提升显著</li>
</ul>
<p>这些模式正在成为现代React开发的标配技巧。你现在就可以在项目中逐步采用它们——不需要一次性重写全部代码！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[NocoBase 本周更新汇总：优化及缺陷修复]]></title>    <link>https://juejin.cn/post/7579917791765037083</link>    <guid>https://juejin.cn/post/7579917791765037083</guid>    <pubDate>2025-12-05T04:17:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579917791765037083" data-draft-id="7579889969986469939" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="NocoBase 本周更新汇总：优化及缺陷修复"/> <meta itemprop="keywords" content="开源,资讯,低代码"/> <meta itemprop="datePublished" content="2025-12-05T04:17:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="NocoBase"/> <meta itemprop="url" content="https://juejin.cn/user/180779873743566"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            NocoBase 本周更新汇总：优化及缺陷修复
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180779873743566/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    NocoBase
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T04:17:29.000Z" title="Fri Dec 05 2025 04:17:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>原文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fweekly-updates-20251204" target="_blank" title="https://www.nocobase.com/cn/blog/weekly-updates-20251204" ref="nofollow noopener noreferrer">www.nocobase.com/cn/blog/wee…</a></p>
<p>汇总一周产品更新日志，最新发布可以<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Ftimeline" target="_blank" title="https://www.nocobase.com/cn/blog/timeline" ref="nofollow noopener noreferrer">前往我们的博客查看</a>。</p>
<p><strong>NocoBase 目前更新包括的版本更新包括三个分支：<code>main</code> ，<code>next</code>和 <code>develop</code>。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba1f52aca04546c29c74693d2de3f5f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513049&amp;x-signature=iKsiBTUgyNz3mMzIajiHVTwDUDI%3D" alt="version.png" loading="lazy"/></p>
<p><code>main</code> ：截止目前最稳定的版本，推荐安装此版本。</p>
<p><code>next</code>：包含即将发布的新功能，经过初步测试的版本，可能存在部分已知或未知问题。主要面向测试用户，用于收集反馈和进一步优化功能。适合愿意提前体验新功能并提供反馈的测试用户。</p>
<p><code>develop</code>：开发中的版本，包含最新的功能代码，可能尚未完成或存在较多不稳定因素，主要用于内部开发和快速迭代。适合对产品功能前沿发展感兴趣的技术用户，但可能存在较多问题或不完整功能，不建议在生产环境中使用。</p>
<h2 data-id="heading-0">main</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd404acd45934b0c8b18ee3ca2a9f504~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513049&amp;x-signature=sOc2E3vwK3XpW893m73f7SZ9Tns%3D" alt="main.png" loading="lazy"/></p>
<h3 data-id="heading-1"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv1.9.19" target="_blank" title="https://www.nocobase.com/cn/blog/v1.9.19" ref="nofollow noopener noreferrer">v1.9.19</a></h3>
<p><em>发布时间：2025-12-04</em></p>
<h3 data-id="heading-2">🐛 修复</h3>
<ul>
<li><strong>[工作流：审批]</strong>
<ul>
<li>修复加载审批列表时内存溢出的问题 by @mytharcher</li>
<li>修复审批人弹窗不显示标题的问题 by @zhangzhonghe</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv1.9.18" target="_blank" title="https://www.nocobase.com/cn/blog/v1.9.18" ref="nofollow noopener noreferrer">v1.9.18</a></h3>
<p><em>发布时间：2025-12-04</em></p>
<h3 data-id="heading-4">🐛 修复</h3>
<ul>
<li>
<p><strong>[操作：导入记录]</strong> 导入的字段和导入权限设置的字段不匹配 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8075" target="_blank" title="https://github.com/nocobase/nocobase/pull/8075" ref="nofollow noopener noreferrer">#8075</a>) by @2013xile</p>
</li>
<li>
<p><strong>[工作流]</strong> 修复执行历史页面中当节点上的执行记录不存在时的报错 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8066" target="_blank" title="https://github.com/nocobase/nocobase/pull/8066" ref="nofollow noopener noreferrer">#8066</a>) by @mytharcher</p>
</li>
<li>
<p><strong>[权限控制]</strong> 给外部数据源添加数据表关联操作的权限判断中间件 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8062" target="_blank" title="https://github.com/nocobase/nocobase/pull/8062" ref="nofollow noopener noreferrer">#8062</a>) by @2013xile</p>
</li>
<li>
<p><strong>[工作流：审批]</strong></p>
<ul>
<li>修复在数据详情弹窗中加载相关审批时的权限报错 by @mytharcher</li>
<li>修复退回分支中无法使用审批节点结果中的审批记录数据的问题 by @mytharcher</li>
<li>修复分支模式和顺序会签时流程处理错误的问题 by @mytharcher</li>
</ul>
</li>
</ul>
<h3 data-id="heading-5"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv1.9.17" target="_blank" title="https://www.nocobase.com/cn/blog/v1.9.17" ref="nofollow noopener noreferrer">v1.9.17</a></h3>
<p><em>发布时间：2025-12-02</em></p>
<h3 data-id="heading-6">🐛 修复</h3>
<ul>
<li><strong>[client]</strong> 修复联动规则下拉选择框闪烁的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8018" target="_blank" title="https://github.com/nocobase/nocobase/pull/8018" ref="nofollow noopener noreferrer">#8018</a>) by @zhangzhonghe</li>
<li><strong>[acl]</strong> 修复外部数据源的权限数据范围使用了当前用户相关变量时， acl meta 信息获取不正确的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8013" target="_blank" title="https://github.com/nocobase/nocobase/pull/8013" ref="nofollow noopener noreferrer">#8013</a>) by @2013xile</li>
<li><strong>[主题编辑器]</strong> 移动端支持切换主题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8046" target="_blank" title="https://github.com/nocobase/nocobase/pull/8046" ref="nofollow noopener noreferrer">#8046</a>) by @zhangzhonghe</li>
<li><strong>[多应用管理器]</strong> 设置日志级别，子应用不生效 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8045" target="_blank" title="https://github.com/nocobase/nocobase/pull/8045" ref="nofollow noopener noreferrer">#8045</a>) by @2013xile</li>
</ul>
<h3 data-id="heading-7"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv1.9.16" target="_blank" title="https://www.nocobase.com/cn/blog/v1.9.16" ref="nofollow noopener noreferrer">v1.9.16</a></h3>
<p><em>发布时间：2025-12-02</em></p>
<h3 data-id="heading-8">🎉 新特性</h3>
<ul>
<li><strong>[数据源：REST API]</strong> 在 restful api 数据源配置中新增<code>接口错误信息转换</code>配置项 by @cgyrock</li>
</ul>
<h3 data-id="heading-9">🚀 优化</h3>
<ul>
<li>
<p><strong>[client]</strong></p>
<ul>
<li>优化 Select 组件，鼠标悬停时显示被折叠的已选中选项 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8029" target="_blank" title="https://github.com/nocobase/nocobase/pull/8029" ref="nofollow noopener noreferrer">#8029</a>) by @katherinehhh</li>
<li>优化子表格字段的必填校验提示信息样式 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8001" target="_blank" title="https://github.com/nocobase/nocobase/pull/8001" ref="nofollow noopener noreferrer">#8001</a>) by @katherinehhh</li>
</ul>
</li>
<li>
<p><strong>[工作流]</strong> 为 UserSelect 组件增加主数据源上下文，以提供一个更通用的组件，可以在其他地方使用 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8010" target="_blank" title="https://github.com/nocobase/nocobase/pull/8010" ref="nofollow noopener noreferrer">#8010</a>) by @mytharcher</p>
</li>
<li>
<p><strong>[工作流：审批]</strong> 使用通用组件以减少重复代码 by @mytharcher</p>
</li>
</ul>
<h3 data-id="heading-10">🐛 修复</h3>
<ul>
<li>
<p><strong>[client]</strong> 修复 Variable.Input 组件的懒加载问题，该问题会导致变量选项菜单不正常的重渲染 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8009" target="_blank" title="https://github.com/nocobase/nocobase/pull/8009" ref="nofollow noopener noreferrer">#8009</a>) by @mytharcher</p>
</li>
<li>
<p><strong>[操作：导入记录]</strong> 修复导入时如果字段包含 <code>null</code> 值报错的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8037" target="_blank" title="https://github.com/nocobase/nocobase/pull/8037" ref="nofollow noopener noreferrer">#8037</a>) by @mytharcher</p>
</li>
<li>
<p><strong>[工作流]</strong> 修复发送消息之前队列已关闭的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8003" target="_blank" title="https://github.com/nocobase/nocobase/pull/8003" ref="nofollow noopener noreferrer">#8003</a>) by @mytharcher</p>
</li>
<li>
<p><strong>[工作流：子流程]</strong> 修复选择工作流组件在工作流列表超过 200 个之后展示不正常的问题 by @mytharcher</p>
</li>
<li>
<p><strong>[工作流：审批]</strong></p>
<ul>
<li>修复由于 <code>RemoteSelect</code> 组件变更导致的加载 <code>approvalRecords.reassignee</code> 资源的权限问题 by @mytharcher</li>
<li>修复审批详情弹窗在刷新页面后打印按钮无法工作的问题 by @mytharcher</li>
</ul>
</li>
</ul>
<h3 data-id="heading-11"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv1.9.15" target="_blank" title="https://www.nocobase.com/cn/blog/v1.9.15" ref="nofollow noopener noreferrer">v1.9.15</a></h3>
<p><em>发布时间：2025-11-28</em></p>
<h3 data-id="heading-12">🐛 修复</h3>
<ul>
<li>
<p><strong>[client]</strong></p>
<ul>
<li>避免打开字段默认值配置时的报错 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7997" target="_blank" title="https://github.com/nocobase/nocobase/pull/7997" ref="nofollow noopener noreferrer">#7997</a>) by @mytharcher</li>
<li>修复关系树表表格区块添加子记录时报错的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7989" target="_blank" title="https://github.com/nocobase/nocobase/pull/7989" ref="nofollow noopener noreferrer">#7989</a>) by @katherinehhh</li>
</ul>
</li>
<li>
<p><strong>[部门]</strong> 修复部门插件中的部门用户关联字段无法编辑的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7462" target="_blank" title="https://github.com/nocobase/nocobase/pull/7462" ref="nofollow noopener noreferrer">#7462</a>) by @heziqiang</p>
</li>
<li>
<p><strong>[数据表：树]</strong> 修复因树表父字段获取不正确导致路径表更新失败的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8000" target="_blank" title="https://github.com/nocobase/nocobase/pull/8000" ref="nofollow noopener noreferrer">#8000</a>) by @2013xile</p>
</li>
<li>
<p><strong>[数据表字段：多对多 (数组)]</strong> 修复子表格中多对多数组关系字段数据无法更新问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7998" target="_blank" title="https://github.com/nocobase/nocobase/pull/7998" ref="nofollow noopener noreferrer">#7998</a>) by @cgyrock</p>
</li>
<li>
<p><strong>[工作流：审批]</strong></p>
<ul>
<li>修复用户在撤回重新提交后，工作流上下文中缺少申请人数据的问题 by @mytharcher</li>
<li>修复用户带评论提交审批后在节点结果中评论为空的问题 by @mytharcher</li>
</ul>
</li>
</ul>
<h2 data-id="heading-13">develop</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/664ef607c52f4c599ef7aa493103ae4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513049&amp;x-signature=u3fopMcxhZpQts5VqBRYYRLyriY%3D" alt="develop.png" loading="lazy"/></p>
<h3 data-id="heading-14"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv2.0.0-alpha.50" target="_blank" title="https://www.nocobase.com/cn/blog/v2.0.0-alpha.50" ref="nofollow noopener noreferrer">v2.0.0-alpha.50</a></h3>
<p><em>发布时间：2025-12-02</em></p>
<h3 data-id="heading-15">🚀 优化</h3>
<ul>
<li>
<p><strong>[client]</strong></p>
<ul>
<li>附件上传组件支持“允许多选”设置 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8052" target="_blank" title="https://github.com/nocobase/nocobase/pull/8052" ref="nofollow noopener noreferrer">#8052</a>) by @katherinehhh</li>
<li>优化 Select 组件，鼠标悬停时显示被折叠的已选中选项 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8029" target="_blank" title="https://github.com/nocobase/nocobase/pull/8029" ref="nofollow noopener noreferrer">#8029</a>) by @katherinehhh</li>
<li>优化 Select 组件被折叠的选中项在鼠标悬停时显示出来 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8030" target="_blank" title="https://github.com/nocobase/nocobase/pull/8030" ref="nofollow noopener noreferrer">#8030</a>) by @katherinehhh</li>
</ul>
</li>
<li>
<p><strong>[AI 员工]</strong> 为添加 LLM 表单新增字段 provider (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8049" target="_blank" title="https://github.com/nocobase/nocobase/pull/8049" ref="nofollow noopener noreferrer">#8049</a>) by @heziqiang</p>
</li>
<li>
<p><strong>[工作流]</strong> 为 UserSelect 组件增加主数据源上下文，以提供一个更通用的组件，可以在其他地方使用 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8010" target="_blank" title="https://github.com/nocobase/nocobase/pull/8010" ref="nofollow noopener noreferrer">#8010</a>) by @mytharcher</p>
</li>
</ul>
<h3 data-id="heading-16">🐛 修复</h3>
<ul>
<li>
<p><strong>[client]</strong></p>
<ul>
<li>修复下拉选择关系对多禁用多选后显示 N/A 的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8050" target="_blank" title="https://github.com/nocobase/nocobase/pull/8050" ref="nofollow noopener noreferrer">#8050</a>) by @katherinehhh</li>
<li>修复联动规则下拉选择框闪烁的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8018" target="_blank" title="https://github.com/nocobase/nocobase/pull/8018" ref="nofollow noopener noreferrer">#8018</a>) by @zhangzhonghe</li>
<li>修复筛选操作中将日期字段切换到时间字段后渲染报错的问题。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8036" target="_blank" title="https://github.com/nocobase/nocobase/pull/8036" ref="nofollow noopener noreferrer">#8036</a>) by @gchust</li>
<li>修复添加评论区块时出现当前记录菜单的问题。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8039" target="_blank" title="https://github.com/nocobase/nocobase/pull/8039" ref="nofollow noopener noreferrer">#8039</a>) by @gchust</li>
<li>修复数据选择器区块批量删除数据失败问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8023" target="_blank" title="https://github.com/nocobase/nocobase/pull/8023" ref="nofollow noopener noreferrer">#8023</a>) by @katherinehhh</li>
<li>修复详情区块里的 JS field 默认样式不正确的问题。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8031" target="_blank" title="https://github.com/nocobase/nocobase/pull/8031" ref="nofollow noopener noreferrer">#8031</a>) by @gchust</li>
<li>修复树表表格区块不能展开子节点的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8011" target="_blank" title="https://github.com/nocobase/nocobase/pull/8011" ref="nofollow noopener noreferrer">#8011</a>) by @katherinehhh</li>
<li>修复子表格列拖拽无效问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8026" target="_blank" title="https://github.com/nocobase/nocobase/pull/8026" ref="nofollow noopener noreferrer">#8026</a>) by @katherinehhh</li>
<li>修复子表格列宽设置无效问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8027" target="_blank" title="https://github.com/nocobase/nocobase/pull/8027" ref="nofollow noopener noreferrer">#8027</a>) by @katherinehhh</li>
<li>修复弹窗中关系字段数据加载导致报错的问题，确保数据展示和功能更流畅。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7985" target="_blank" title="https://github.com/nocobase/nocobase/pull/7985" ref="nofollow noopener noreferrer">#7985</a>) by @gchust</li>
<li>修复 Markdown字段 Popover 样式问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8012" target="_blank" title="https://github.com/nocobase/nocobase/pull/8012" ref="nofollow noopener noreferrer">#8012</a>) by @katherinehhh</li>
<li>修复编辑操作和新增操作弹窗的默认标题不正确的问题。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8033" target="_blank" title="https://github.com/nocobase/nocobase/pull/8033" ref="nofollow noopener noreferrer">#8033</a>) by @gchust</li>
<li>修复 Variable.Input 组件的懒加载问题，该问题会导致变量选项菜单不正常的重渲染 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8009" target="_blank" title="https://github.com/nocobase/nocobase/pull/8009" ref="nofollow noopener noreferrer">#8009</a>) by @mytharcher</li>
<li>修复无法正确解析关系字段打开的弹窗里的当前弹窗弹窗记录变量。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8019" target="_blank" title="https://github.com/nocobase/nocobase/pull/8019" ref="nofollow noopener noreferrer">#8019</a>) by @gchust</li>
</ul>
</li>
<li>
<p><strong>[acl]</strong> 修复外部数据源的权限数据范围使用了当前用户相关变量时， acl meta 信息获取不正确的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8013" target="_blank" title="https://github.com/nocobase/nocobase/pull/8013" ref="nofollow noopener noreferrer">#8013</a>) by @2013xile</p>
</li>
<li>
<p><strong>[flow-engine]</strong></p>
<ul>
<li>修复评论编辑后更新保存失败的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8035" target="_blank" title="https://github.com/nocobase/nocobase/pull/8035" ref="nofollow noopener noreferrer">#8035</a>) by @katherinehhh</li>
<li>修复点击弹窗中表单提交按钮关闭弹窗时数据区块数据不刷新的问题。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8021" target="_blank" title="https://github.com/nocobase/nocobase/pull/8021" ref="nofollow noopener noreferrer">#8021</a>) by @gchust</li>
</ul>
</li>
<li>
<p><strong>[主题编辑器]</strong> 移动端支持切换主题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8046" target="_blank" title="https://github.com/nocobase/nocobase/pull/8046" ref="nofollow noopener noreferrer">#8046</a>) by @zhangzhonghe</p>
</li>
<li>
<p><strong>[多应用管理器（已废弃）]</strong> 设置日志级别，子应用不生效 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8045" target="_blank" title="https://github.com/nocobase/nocobase/pull/8045" ref="nofollow noopener noreferrer">#8045</a>) by @2013xile</p>
</li>
<li>
<p><strong>[数据源管理]</strong> 修复外部数据源更新密码报错问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8024" target="_blank" title="https://github.com/nocobase/nocobase/pull/8024" ref="nofollow noopener noreferrer">#8024</a>) by @cgyrock</p>
</li>
<li>
<p><strong>[操作：导入记录]</strong> 修复导入时如果字段包含 <code>null</code> 值报错的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8037" target="_blank" title="https://github.com/nocobase/nocobase/pull/8037" ref="nofollow noopener noreferrer">#8037</a>) by @mytharcher</p>
</li>
<li>
<p><strong>[工作流]</strong> 修复发送消息之前队列已关闭的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8003" target="_blank" title="https://github.com/nocobase/nocobase/pull/8003" ref="nofollow noopener noreferrer">#8003</a>) by @mytharcher</p>
</li>
<li>
<p><strong>[评论]</strong></p>
<ul>
<li>修复评论区块删除记录失败的问题 by @katherinehhh</li>
<li>非评论表使用评论区块时显示提示“当前表不是评论表，无法使用评论区块” by @katherinehhh</li>
</ul>
</li>
<li>
<p><strong>[多空间]</strong> 移动端支持空间切换 by @jiannx</p>
</li>
<li>
<p><strong>[工作流：子流程]</strong> 修复选择工作流组件在工作流列表超过 200 个之后展示不正常的问题 by @mytharcher</p>
</li>
<li>
<p><strong>[工作流：审批]</strong></p>
<ul>
<li>修复创建审批信息区块报错的问题 by @mytharcher</li>
<li>为避免添加索引时重复数据的错误，增加迁移脚本 by @mytharcher</li>
<li>修复审批详情弹窗在刷新页面后打印按钮无法工作的问题 by @mytharcher</li>
</ul>
</li>
</ul>
<h3 data-id="heading-17"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv2.0.0-alpha.49" target="_blank" title="https://www.nocobase.com/cn/blog/v2.0.0-alpha.49" ref="nofollow noopener noreferrer">v2.0.0-alpha.49</a></h3>
<p><em>发布时间：2025-11-29</em></p>
<h3 data-id="heading-18">🎉 新特性</h3>
<ul>
<li><strong>[工作流：审批]</strong> 允许选择在审批处理界面中展示数据的快照还是最新状态 by @mytharcher</li>
</ul>
<h3 data-id="heading-19">🚀 优化</h3>
<ul>
<li><strong>[client]</strong> 优化子表格字段的必填校验提示信息样式 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8001" target="_blank" title="https://github.com/nocobase/nocobase/pull/8001" ref="nofollow noopener noreferrer">#8001</a>) by @katherinehhh</li>
<li><strong>[遥测：Prometheus]</strong> 升级 <code>@opentelemetry/exporter-prometheus</code> by @2013xile</li>
<li><strong>[操作：导入记录 Pro]</strong> 优化异步任务的错误信息，任务失败时将明确提示具体的错误原因 by @mytharcher</li>
</ul>
<h3 data-id="heading-20">🐛 修复</h3>
<ul>
<li><strong>[flow-engine]</strong> 修复详情区块中无法正确触发当前记录变量后端解析的问题。 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8004" target="_blank" title="https://github.com/nocobase/nocobase/pull/8004" ref="nofollow noopener noreferrer">#8004</a>) by @gchust</li>
<li><strong>[client]</strong> 修复联合主键表格区块选中和删除行无效的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7978" target="_blank" title="https://github.com/nocobase/nocobase/pull/7978" ref="nofollow noopener noreferrer">#7978</a>) by @katherinehhh</li>
<li><strong>[操作：导出记录]</strong> 修复导出按钮可导出字段列表缺少系统字段的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8002" target="_blank" title="https://github.com/nocobase/nocobase/pull/8002" ref="nofollow noopener noreferrer">#8002</a>) by @katherinehhh</li>
<li><strong>[数据表：树]</strong> 修复因树表父字段获取不正确导致路径表更新失败的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F8000" target="_blank" title="https://github.com/nocobase/nocobase/pull/8000" ref="nofollow noopener noreferrer">#8000</a>) by @2013xile</li>
<li><strong>[数据表字段：多对多 (数组)]</strong> 修复子表格中多对多数组关系字段数据无法更新问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7998" target="_blank" title="https://github.com/nocobase/nocobase/pull/7998" ref="nofollow noopener noreferrer">#7998</a>) by @cgyrock</li>
<li><strong>[部门]</strong> 修复部门插件中的部门用户关联字段无法编辑的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7462" target="_blank" title="https://github.com/nocobase/nocobase/pull/7462" ref="nofollow noopener noreferrer">#7462</a>) by @heziqiang</li>
<li><strong>[工作流：审批]</strong> 修复由于 <code>RemoteSelect</code> 组件变更导致的加载 <code>approvalRecords.reassignee</code> 资源的权限问题 by @mytharcher</li>
</ul>
<h3 data-id="heading-21"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fv2.0.0-alpha.48" target="_blank" title="https://www.nocobase.com/cn/blog/v2.0.0-alpha.48" ref="nofollow noopener noreferrer">v2.0.0-alpha.48</a></h3>
<p><em>发布时间：2025-11-28</em></p>
<h3 data-id="heading-22">🎉 新特性</h3>
<ul>
<li><strong>[区块：地图]</strong> 新增 2.0 地图区块 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7944" target="_blank" title="https://github.com/nocobase/nocobase/pull/7944" ref="nofollow noopener noreferrer">#7944</a>) by @katherinehhh</li>
<li><strong>[认证：OIDC]</strong> 支持选项 当用户未登录时自动跳转到 SSO 登录页 by @heziqiang</li>
</ul>
<h3 data-id="heading-23">🐛 修复</h3>
<ul>
<li>
<p><strong>[client]</strong></p>
<ul>
<li>避免打开字段默认值配置时的报错 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7997" target="_blank" title="https://github.com/nocobase/nocobase/pull/7997" ref="nofollow noopener noreferrer">#7997</a>) by @mytharcher</li>
<li>修复关系树表表格区块添加子记录时报错的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7989" target="_blank" title="https://github.com/nocobase/nocobase/pull/7989" ref="nofollow noopener noreferrer">#7989</a>) by @katherinehhh</li>
<li>修复 markdown 字段 HTML 模式下超出宽度省略时显示异常的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7994" target="_blank" title="https://github.com/nocobase/nocobase/pull/7994" ref="nofollow noopener noreferrer">#7994</a>) by @katherinehhh</li>
<li>修复级联下拉选择器搜索数据不全问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7990" target="_blank" title="https://github.com/nocobase/nocobase/pull/7990" ref="nofollow noopener noreferrer">#7990</a>) by @katherinehhh</li>
<li>修复跳转页面时页面 tab 的状态和路由不对应的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7991" target="_blank" title="https://github.com/nocobase/nocobase/pull/7991" ref="nofollow noopener noreferrer">#7991</a>) by @zhangzhonghe</li>
<li>修复 下拉列表组件在非对象值回显时没有正确显示label 问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7975" target="_blank" title="https://github.com/nocobase/nocobase/pull/7975" ref="nofollow noopener noreferrer">#7975</a>) by @katherinehhh</li>
</ul>
</li>
<li>
<p><strong>[database]</strong> 修复：移除 time 字段转换中的 UTC 处理，避免因时区导致的纯时间值偏移 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7812" target="_blank" title="https://github.com/nocobase/nocobase/pull/7812" ref="nofollow noopener noreferrer">#7812</a>) by @ChimingLiu</p>
</li>
<li>
<p><strong>[工作流]</strong></p>
<ul>
<li>修复停止服务前，已创建的执行计划未发送到队列的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7981" target="_blank" title="https://github.com/nocobase/nocobase/pull/7981" ref="nofollow noopener noreferrer">#7981</a>) by @mytharcher</li>
<li>修复部分工作流待办菜单不显示的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7980" target="_blank" title="https://github.com/nocobase/nocobase/pull/7980" ref="nofollow noopener noreferrer">#7980</a>) by @mytharcher</li>
<li>修复点击默认进入的待办列表中的任务跳转到错误页面的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7983" target="_blank" title="https://github.com/nocobase/nocobase/pull/7983" ref="nofollow noopener noreferrer">#7983</a>) by @mytharcher</li>
</ul>
</li>
<li>
<p><strong>[数据可视化]</strong> 外部数据源表的筛选字段的配置项不能显示特有属性 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7982" target="_blank" title="https://github.com/nocobase/nocobase/pull/7982" ref="nofollow noopener noreferrer">#7982</a>) by @2013xile</p>
</li>
<li>
<p><strong>[数据源管理]</strong> 修复外部数据源修改密码后系统内无法更新密码的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7977" target="_blank" title="https://github.com/nocobase/nocobase/pull/7977" ref="nofollow noopener noreferrer">#7977</a>) by @cgyrock</p>
</li>
<li>
<p><strong>[操作：导入记录]</strong> 修复树表导入数据报错问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7976" target="_blank" title="https://github.com/nocobase/nocobase/pull/7976" ref="nofollow noopener noreferrer">#7976</a>) by @cgyrock</p>
</li>
<li>
<p><strong>[工作流：人工处理节点]</strong> 修复人工待办任务统计数字不对的问题 (<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnocobase%2Fnocobase%2Fpull%2F7984" target="_blank" title="https://github.com/nocobase/nocobase/pull/7984" ref="nofollow noopener noreferrer">#7984</a>) by @mytharcher</p>
</li>
<li>
<p><strong>[工作流：审批]</strong></p>
<ul>
<li>修复用户在撤回重新提交后，工作流上下文中缺少申请人数据的问题 by @mytharcher</li>
<li>修复用户带评论提交审批后在节点结果中评论为空的问题 by @mytharcher</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 2025 年 11 月 GitHub 十大热门项目排行榜 🔥]]></title>    <link>https://juejin.cn/post/7579889969986502707</link>    <guid>https://juejin.cn/post/7579889969986502707</guid>    <pubDate>2025-12-05T04:18:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579889969986502707" data-draft-id="7579889969986306099" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 2025 年 11 月 GitHub 十大热门项目排行榜 🔥"/> <meta itemprop="keywords" content="前端,GitHub,人工智能"/> <meta itemprop="datePublished" content="2025-12-05T04:18:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一点一木"/> <meta itemprop="url" content="https://juejin.cn/user/1063982986187486"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 2025 年 11 月 GitHub 十大热门项目排行榜 🔥
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1063982986187486/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一点一木
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T04:18:54.000Z" title="Fri Dec 05 2025 04:18:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>欢迎来到 2025 年 11 月 <code>GitHub</code> 热门开源项目排行榜！本期榜单横跨<strong>本地化生产力工具</strong>、<strong><code>AI Agent</code> 可训练化</strong>、<strong>自动化安全测试</strong>、<strong>舆情智能分析</strong>、<strong>跨平台硬件解放</strong>、<strong>浏览器 <code>AI</code> 自动化</strong>、<strong>私有化 <code>CRM</code><strong>等前沿领域。这十个项目代表了当下最火热的三大趋势：</strong><code>Agent</code> 从“能用”到“可训练”</strong> 、<strong>隐私与本地优先全面回归</strong>、<strong><code>AI</code> 原生自动化席卷一切重复性工作</strong>。它们正推动开源从实验玩具快速迈向生产级刚需。</p>
<ol>
<li>
<h3 data-id="heading-0"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmountain-loop%2Fyaak" target="_blank" title="https://github.com/mountain-loop/yaak" ref="nofollow noopener noreferrer"><code>Yaak</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>16.7K+</code></strong></p>
<p><strong>📦 一款隐私优先、跨平台的桌面 <code>API</code> 客户端</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00e0722d6ecc483c8939bda5dce58698~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513134&amp;x-signature=JbjLPr%2Ba5UYd2N2HbcbOaDZlI1E%3D" alt="Yaak.png" loading="lazy"/></p>
<p><strong><code>Yaak</code></strong> 是专为开发者打造的完全本地化 <code>API</code> 客户端，支持 <code>REST / GraphQL / WebSocket / SSE / gRPC</code> 全协议栈。基于 <code>Tauri + Rust + React</code> 构建，轻量极速、无遥测、无云依赖，彻底取代 <code>Postman</code> 与 <code>Insomnia</code>。</p>
<ul>
<li><strong>多协议 &amp; 一站式</strong>：一个工具搞定所有 <code>API</code> 调试场景</li>
<li><strong>导入兼容强</strong>：完美支持 <code>Postman / Insomnia / OpenAPI / Swagger / cURL</code> 一键迁移</li>
<li><strong>隐私 + 本地优先</strong>：所有请求、密钥、环境变量永不上云，无需账号</li>
<li><strong>版本控制友好</strong>：<code>Collections</code> 直接映射为文件夹，天然适配 <code>Git</code> 管理</li>
<li><strong>轻量跨平台</strong>：<code>macOS / Windows / Linux</code> 统一体验，启动秒开</li>
</ul>
<p>💡 <strong><code>Yaak</code></strong> 适合极度重视隐私与数据安全的前后端开发者、多协议 <code>API</code> 重度用户、希望用 <code>Git</code> 管理接口文档的团队。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmountain-loop%2Fyaak" target="_blank" title="https://github.com/mountain-loop/yaak" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-1"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2Fagent-lightning" target="_blank" title="https://github.com/microsoft/agent-lightning" ref="nofollow noopener noreferrer"><code>Agent Lightning</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>9.4K+</code></strong></p>
<p><strong>⚡ 微软研究院开源：让任何 <code>AI Agent</code> 一键可训练、可进化</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74e752f2156a46b4b35dd525c77fa88e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513134&amp;x-signature=BYnZdfEnj4fzJdkmsSpBLdblGI8%3D" alt="agent-lightning.png" loading="lazy"/></p>
<p><strong><code>Agent Lightning</code></strong> 让现有 <code>Agent</code>（<code>LangChain</code>、<code>AutoGen</code>、<code>CrewAI</code>、甚至手写 <code>Agent</code>）几乎不改代码即可接入强化学习、提示优化、微调等训练闭环。</p>
<ul>
<li><strong>兼容任意框架</strong>：不挑框架、不挑实现方式</li>
<li><strong>零侵入接入</strong>：几行 <code>tracer</code> 即可收集训练数据</li>
<li><strong>支持复杂场景</strong>：多 <code>Agent</code>、长交互、工具调用全覆盖训练</li>
<li><strong>多种优化手段</strong>：<code>RL</code> / 自动提示优化 / 监督微调全都有</li>
<li><strong>动态闭环训练</strong>：<code>Agent</code> 执行时自动生成可学习数据并迭代</li>
</ul>
<p>💡 <strong><code>Agent Lightning</code></strong> 适合想把 <code>Agent</code> 从“能跑”进化到“会学”的 <code>AI</code> 工程师、研究者及多代理系统开发者。</p>
<p>👉 <strong>立即探索</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmicrosoft%2Fagent-lightning" target="_blank" title="https://github.com/microsoft/agent-lightning" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-2"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fusestrix%2Fstrix" target="_blank" title="https://github.com/usestrix/strix" ref="nofollow noopener noreferrer"><code>Strix</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>16.5K+</code></strong></p>
<p><strong>🔐 <code>AI</code> 驱动的自动化渗透测试与漏洞验证平台</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e74f34eb65a40ec8c8b7b882421fb03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513134&amp;x-signature=QVv30lmn6rbioVWxrJKrBZz3%2Fto%3D" alt="Strix.png" loading="lazy"/></p>
<p><strong><code>Strix</code></strong> 通过 <code>AI</code> 黑客代理模拟真实攻击者，自动发现、验证漏洞并生成 <code>PoC</code> 与修复报告，假阳性极低，可直接嵌入 <code>CI/CD</code>。</p>
<ul>
<li><strong>真实 <code>Exploit</code> 执行</strong>：不仅扫描，还真正跑攻击链验证漏洞</li>
<li><strong>完整工具链</strong>：浏览器自动化、代码执行环境、<code>HTTP</code> 代理全内置</li>
<li><strong>自动生成 <code>PoC</code></strong> + 可操作修复建议报告</li>
<li><strong>天生适配 <code>DevSecOps</code></strong>：支持 <code>GitHub Actions</code> 一键集成</li>
</ul>
<p>💡 <strong><code>Strix</code></strong> 适合安全团队、<code>DevSecOps</code> 工程师、想在部署前自动拦截漏洞的后端开发者。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fusestrix%2Fstrix" target="_blank" title="https://github.com/usestrix/strix" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-3"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsansan0%2FTrendRadar" target="_blank" title="https://github.com/sansan0/TrendRadar" ref="nofollow noopener noreferrer"><code>TrendRadar</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>37.8K+</code></strong></p>
<p><strong>📡 多平台热点聚合 + <code>AI</code> 驱动舆情/趋势分析工具</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a06578e2e504572b85c36356a043c30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513134&amp;x-signature=9a6WPUeTMVt%2FGBFQUiO9m3dwdZo%3D" alt="TrendRadar.png" loading="lazy"/></p>
<p><strong><code>TrendRadar</code></strong> 实时抓取 35+ 平台热点，通过 <code>AI</code> 分析热度变化、生命周期、跨平台传播，支持自定义关键词与多种推送方式。</p>
<ul>
<li><strong>多平台热点聚合</strong>：抖音、微博、小红书、知乎等 35+ 源</li>
<li><strong>智能筛选 + 趋势分析</strong>：热度曲线、生命周期、持续性全维度</li>
<li><strong>多种推送方式</strong>：<code>Telegram</code> / 企业微信 / 飞书 / 钉钉 / <code>Email</code> 全支持</li>
<li><strong>快速部署</strong>：<code>Docker</code> 一键启动，无需编程基础</li>
</ul>
<p>💡 <strong><code>TrendRadar</code></strong> 适合内容创作者、投资人、公关团队、舆情分析师以及任何想提炼有效信息信号的用户。</p>
<p>👉 <strong>立即探索</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsansan0%2FTrendRadar" target="_blank" title="https://github.com/sansan0/TrendRadar" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-4"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkavishdevar%2Flibrepods" target="_blank" title="https://github.com/kavishdevar/librepods" ref="nofollow noopener noreferrer"><code>LibrePods</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>19.1K+</code></strong></p>
<p><strong>🎧 让 <code>AirPods</code> 在 <code>Android / Linux</code> 上解锁完整功能</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4b7bf0306c746e5b09341addd7581b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513134&amp;x-signature=WkkhF9un1PeQXwjaCW87Ht6%2B%2FnE%3D" alt="librepods-banner.png" loading="lazy"/></p>
<p><strong><code>LibrePods</code></strong> 通过逆向与模块化实现，让非苹果设备用户用上 <code>ANC</code>、通透、入耳检测、头部手势、对话感知等全部高端功能。</p>
<ul>
<li><strong>完整功能还原</strong>：<code>ANC</code>、通透、自适应、头部手势全支持</li>
<li><strong>多设备自动切换</strong>：与苹果生态无缝衔接</li>
<li><strong>支持听觉辅助</strong>与个性化音效定制</li>
<li><strong>适配双平台</strong>：<code>Android</code>（<code>Root</code>）与 <code>Linux</code>（模块）两种方案</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d928e349de2143b8b590c580e97fb3b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513134&amp;x-signature=3LAUKO9cwsFGGVTyPJt9baCv%2F48%3D" alt="librepods-linux.png" loading="lazy"/></p>
<p>💡 <strong><code>LibrePods</code></strong> 适合拥有 <code>AirPods</code> 但使用 <code>Android/Linux</code> 的用户，尤其是想体验完整降噪与空间音频的折腾党。</p>
<p>👉 <strong>立即探索</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fkavishdevar%2Flibrepods" target="_blank" title="https://github.com/kavishdevar/librepods" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-5"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F666ghj%2FBettaFish" target="_blank" title="https://github.com/666ghj/BettaFish" ref="nofollow noopener noreferrer"><code>BettaFish</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>30.9K+</code></strong></p>
<p><strong>🤖 多智能体驱动的全自动舆情分析与报告生成系统</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58abfb62b0924ff58f50b298cdcfad02~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513134&amp;x-signature=vRA2WhhX8FDwwmxH1TXZGR%2BYTZg%3D" alt="BettaFish_system_schematic.png" loading="lazy"/></p>
<p><strong><code>BettaFish</code></strong> 用多个协作 <code>Agent</code> 完成全网抓取 → 多模态分析 → 自动生成带图表的专业舆情报告。</p>
<ul>
<li><strong>多 <code>Agent</code> 协作</strong>：搜索、内容理解、数据库挖掘、报告生成各司其职</li>
<li><strong>多来源 &amp; 多模态</strong>：支持新闻、社交媒体、视频、评论全覆盖</li>
<li><strong>自动报告生成</strong>：包含趋势分析、观点总结、情感结构、可视化图表</li>
<li><strong>一键部署</strong>：<code>Docker</code> 开箱即用，可深度定制</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcadb1e7836a43c2a7d70df0fe64adfa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513134&amp;x-signature=IN%2BHK1Gs%2Bfs%2FIUyuShX1jQcmTVs%3D" alt="BettaFish_framework.png" loading="lazy"/></p>
<p>💡 <strong><code>BettaFish</code></strong> 适合品牌公关、市场研究、媒体监测团队，以及需要快速生成决策级舆情报告的组织。</p>
<p>👉 <strong>立即探索</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F666ghj%2FBettaFish" target="_blank" title="https://github.com/666ghj/BettaFish" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-6"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fourongxing%2Fnewsnow" target="_blank" title="https://github.com/ourongxing/newsnow" ref="nofollow noopener noreferrer"><code>NewsNow</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>14.9K+</code></strong></p>
<p><strong>📡 优雅、实时、多源新闻聚合与阅读平台</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f0ec4db1b64444f9ae35c8d04f8d9c82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513134&amp;x-signature=7BkQFikHFXyBm94P616vSzXL9GM%3D" alt="NewsNow.png" loading="lazy"/></p>
<p><strong><code>NewsNow</code></strong> 从 40+ 新闻源与社交媒体抓取实时内容，以极简清爽界面呈现，支持自建与跨设备同步。</p>
<ul>
<li><strong>多源实时聚合</strong>：覆盖国内外主流媒体与社交平台</li>
<li><strong>极简阅读体验</strong>：界面美观，专注内容本身</li>
<li><strong>智能缓存机制</strong>：默认 30 分钟缓存，最快 2 分钟刷新</li>
<li><strong>多方式部署</strong>：支持 <code>Docker</code>、<code>Vercel</code>、<code>Cloudflare Pages</code></li>
</ul>
<p>💡 <strong><code>NewsNow</code></strong> 适合资讯重度用户、内容创作者、研究者，以及想自建私人新闻中心的开发者。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fourongxing%2Fnewsnow" target="_blank" title="https://github.com/ourongxing/newsnow" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-7"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSkyvern-AI%2Fskyvern" target="_blank" title="https://github.com/Skyvern-AI/skyvern" ref="nofollow noopener noreferrer"><code>Skyvern</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>19.4K+</code></strong></p>
<p><strong>🤖 用 <code>AI</code> + 计算机视觉自动化任意网页工作流</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45be8547b2d5454da7a3cd44fcdcd8b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513134&amp;x-signature=nyDEEmiOZZREwjAej9CHlhEsSmo%3D" alt="skyvern_2_0_system_diagram.png" loading="lazy"/></p>
<p><strong><code>Skyvern</code></strong> 用大模型 + 视觉理解自动完成浏览器任务，无需写 <code>XPath</code>，页面改版也不崩。</p>
<ul>
<li><strong>无需硬编码选择器</strong>：通过视觉 + <code>LLM</code> 理解页面布局</li>
<li><strong>通用网页兼容</strong>：对未见过的网站也能直接操作</li>
<li><strong>支持复杂流程</strong>：登录、填表、下载、批量操作全覆盖</li>
<li><strong>多部署方式</strong>：本地 / <code>Docker</code> / 云端 <code>API</code> 任选</li>
</ul>
<p>💡 <strong><code>Skyvern</code></strong> 适合需要自动化发票下载、表单提交、批量操作、跨站数据抓取的财务、运营、开发者。</p>
<p>👉 <strong>立即探索</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSkyvern-AI%2Fskyvern" target="_blank" title="https://github.com/Skyvern-AI/skyvern" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-8"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F1Panel-dev%2FCordysCRM" target="_blank" title="https://github.com/1Panel-dev/CordysCRM" ref="nofollow noopener noreferrer"><code>CordysCRM</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>1.3K+</code></strong></p>
<p><strong>💼 一款开源 <code>AI</code> 驱动的私有化 <code>CRM</code> 系统</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcc3daac8c1e4e65a0d4c73fac4319ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513134&amp;x-signature=RwDyrYN8ZAsfuIgUbE0AapwC9I0%3D" alt="CordysCRM1.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e801388aea544b6af099f0bdb6b9774~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513134&amp;x-signature=TMXfblWWDk9Ev9Sh15P58COyBpk%3D" alt="CordysCRM2.png" loading="lazy"/></p>
<p><strong><code>CordysCRM</code></strong> 由 <code>1Panel</code> 团队打造，覆盖线索→商机→合同→回款全流程，内置 <code>AI</code> 线索评分与自然语言查询。</p>
<ul>
<li><strong>端到端销售流程</strong>：从线索获取到回款执行全覆盖</li>
<li><code>AI</code> + <code>BI</code> 加持：智能线索评分、自动跟进、自然语言查报表</li>
<li><strong>私有化部署</strong>：<code>Docker</code> 一键部署，所有数据自控</li>
<li><strong>企业协作集成</strong>：支持企业微信、钉钉、飞书</li>
</ul>
<p>💡 <strong><code>CordysCRM</code></strong> 适合重视数据主权、想摆脱 <code>Salesforce</code> 高昂费用的中小企业与成长型团队。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F1Panel-dev%2FCordysCRM" target="_blank" title="https://github.com/1Panel-dev/CordysCRM" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
<li>
<h3 data-id="heading-9"><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgoogle-gemini%2Fgemini-cli" target="_blank" title="https://github.com/google-gemini/gemini-cli" ref="nofollow noopener noreferrer"><code>Gemini CLI</code></a></h3>
<p>🌟 <strong><code>Star</code> 数：<code>85.8K+</code></strong></p>
<p><strong>⚙️ <code>Google</code> 官方开源的终端版 <code>Gemini 2.5 Pro</code></strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d91f4b884b24de8a4b3d10f189d8eb3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA54K55LiA5pyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765513134&amp;x-signature=fgRM9p46ae4xgsiB5cm8%2B6IkWn0%3D" alt="gemini-screenshot.png" loading="lazy"/></p>
<p><code>Gemini CLI</code> 把 <code>Gemini</code> 完整能力带入命令行，支持代码生成、调试、网页搜索、<code>shell</code> 执行，<code>1M</code> 上下文窗口。</p>
<ul>
<li><strong>终端优先</strong>：直接在命令行与 <code>Gemini</code> 对话</li>
<li><strong>多功能工具</strong>：<code>Google Search grounding</code>、文件操作、<code>shell</code> 命令</li>
<li><strong>超长上下文</strong>：<strong>1 百万 <code>token</code></strong>，适合大型代码库分析</li>
<li><strong>可脚本化</strong>：支持非交互模式，完美嵌入 <code>CI/CD</code></li>
</ul>
<p>💡 <strong><code>Gemini CLI</code></strong> 适合终端重度用户、后端开发者、自动化脚本爱好者，以及想把 <code>AI</code> 能力融入工作流的工程师。</p>
<p>👉 <strong>立即体验</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgoogle-gemini%2Fgemini-cli" target="_blank" title="https://github.com/google-gemini/gemini-cli" ref="nofollow noopener noreferrer"><code>GitHub</code></a></p>
</li>
</ol>
<h3 data-id="heading-10">结论</h3>
<p>2025 年 11 月的榜单，清晰勾勒出开源世界的三大新主旋律：</p>
<ul>
<li><strong><code>Agent</code> 可训练化</strong>：从静态脚本到自我进化的智能体</li>
<li><strong><code>AI</code> 原生自动化</strong>：渗透测试、浏览器操作、舆情分析全面被大模型+视觉重塑</li>
<li><strong>隐私与本地优先</strong>：从 <code>API</code> 客户端到 <code>CRM</code>，数据主权正在强势回归</li>
</ul>
<p>这十个项目不再是炫技玩具，而是真正能落地的生产力武器。未来已来，只是分布在这些 <code>GitHub</code> 仓库里。</p>
<p>📌 喜欢哪个就去点个 <code>Star</code>，每一个 <code>Star</code> 都是对开源最好的鼓励！ 📬</p>
<p>欢迎收藏、转发，也欢迎在评论区安利你心中的 12 月黑马～</p>
<hr/>
<h3 data-id="heading-11">往期推荐</h3>
<p>喜欢本期的热门项目？以下是一些值得一读的往期精彩内容：</p>
<ol>
<li><a href="https://juejin.cn/post/7434159897197133836" target="_blank" title="https://juejin.cn/post/7434159897197133836">🚀 2024年11月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7434159897197133836" target="_blank" title="https://juejin.cn/post/7434159897197133836">🚀 2024年12月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7461822837532213267" target="_blank" title="https://juejin.cn/post/7461822837532213267">🚀 2025年01月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7475237484085346355" target="_blank" title="https://juejin.cn/post/7475237484085346355">🚀 2025年02月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7486316823253565474" target="_blank" title="https://juejin.cn/post/7486316823253565474">🚀 2025年03月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7503762078386700298" target="_blank" title="https://juejin.cn/post/7503762078386700298">🚀 2025年04月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7508914438659735589" target="_blank" title="https://juejin.cn/post/7508914438659735589">🚀 2025年05月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7525688196605722670" target="_blank" title="https://juejin.cn/post/7525688196605722670">🚀 2025年06月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7533169614206861339" target="_blank" title="https://juejin.cn/post/7533169614206861339">🚀 2025年07月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7543830033606246419" target="_blank" title="https://juejin.cn/post/7543830033606246419">🚀 2025年08月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7555056825693634601" target="_blank" title="https://juejin.cn/post/7555056825693634601">🚀 2025年09月 GitHub 十大热门项目排行榜 🔥</a></li>
<li><a href="https://juejin.cn/post/7567208390368198696" target="_blank" title="https://juejin.cn/post/7567208390368198696">🚀 2025年10月 GitHub 十大热门项目排行榜 🔥</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python + FFmpeg 视频自动化处理指南：从硬件加速到精确剪辑]]></title>    <link>https://juejin.cn/post/7579849892614389796</link>    <guid>https://juejin.cn/post/7579849892614389796</guid>    <pubDate>2025-12-05T04:43:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579849892614389796" data-draft-id="7579893536106217478" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python + FFmpeg 视频自动化处理指南：从硬件加速到精确剪辑"/> <meta itemprop="keywords" content="FFmpeg,Python,音视频开发"/> <meta itemprop="datePublished" content="2025-12-05T04:43:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mortimer"/> <meta itemprop="url" content="https://juejin.cn/user/4441682704623992"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python + FFmpeg 视频自动化处理指南：从硬件加速到精确剪辑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4441682704623992/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mortimer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T04:43:42.000Z" title="Fri Dec 05 2025 04:43:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.7;font-weight:400;font-size:16px;overflow-x:hidden;color:#212122}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:8px;padding-bottom:8px}.markdown-body h1{color:#a0a0a0;font-size:38px;margin-top:32px;padding-top:32px}.markdown-body h2{color:#fff;background-color:#212122;width:fit-content;border-bottom-right-radius:100px;margin-top:47px;margin-bottom:16px;padding:4px 48px 4px 8px;line-height:1.7;font-size:30px;transition:all .3s ease-out}.markdown-body h2:hover{border-bottom-right-radius:50px;transition:all .3s ease-out}.markdown-body h3{font-size:24px;padding-left:8px;margin-top:32px;border-bottom:2px solid #c6c4c4;line-height:1.7}.markdown-body h4{font-size:20px;padding-left:8px;margin-top:32px;border-bottom:1px solid #ddd}.markdown-body h5{font-size:16px;margin-top:24px}.markdown-body h6{margin-top:16px;line-height:1.1}.markdown-body p{font-size:16px;text-align:start;white-space:normal;text-size-adjust:auto;line-height:2;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%;margin:auto;padding-left:8px;padding-right:8px}.markdown-body hr{border:none;border-top:4px double #212122;margin-top:32px;margin-bottom:32px;text-align:center}.markdown-body hr:after{content:"♥";display:inline-block;position:relative;top:-15px;padding:0 10px;color:#212122;font-size:18px}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f1f1f1;color:#ef7060;font-size:14px;padding:.065em 6px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.7;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);margin:32px 16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-color:#212122;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);background-size:40px}.markdown-body pre&gt;code{font-size:14px;padding:16px 8px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#fff;background:#272822}.markdown-body pre&gt;code::-webkit-scrollbar{height:10px;background-color:#f5f5f5}.markdown-body pre&gt;code::-webkit-scrollbar-track{box-shadow:inset 0 0 6px rgba(0,0,0,.3);border-radius:3px;background-color:#f5f5f5}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{border-radius:3px;box-shadow:inset 0 0 6px rgba(0,0,0,.3);background-color:#555}.markdown-body a{color:#ef7060;padding:2px;text-decoration:none;border-bottom:.125em solid #ef7060;border-radius:2px;box-shadow:inset 0 -.025em 0 #ef7060;transition:box-shadow .27s cubic-bezier(.77,0,.175,1),color .27s cubic-bezier(.77,0,.175,1)}.markdown-body a:focus,.markdown-body a:hover{outline:none;box-shadow:inset 0 -1.5em 0 #ef7060;color:#fff}.markdown-body a:before{content:"⇲ ";vertical-align:top;margin-left:2px;font-family:dart!important;font-size:12px;color:inherit;opacity:.7}.markdown-body table{background:#fbfbfb;border-radius:4px;border-collapse:collapse;margin:auto;padding:5px;width:95%;box-shadow:0 5px 10px rgba(0,0,0,.1);animation:float 5s infinite}.markdown-body table th{color:#fff;background:#212122;border-bottom:1px solid #9ea7af;border-right:1px solid #343a45;font-size:18px;padding:16px;text-align:left;vertical-align:middle}.markdown-body table th:first-child{border-top-left-radius:4px}.markdown-body table th:last-child{border-top-right-radius:4px;border-right:none}.markdown-body table tr{border-top:1px solid #c1c3d1;border-bottom:1px solid #c1c3d1;color:#666b85}.markdown-body table tr:hover td{background:#212122;color:#fff;border-top:1px solid #22262e}.markdown-body table tr:first-child{border-top:none}.markdown-body table tr:last-child{border-bottom:none}.markdown-body table tr:nth-child(odd) td{background:#f1f1f1}.markdown-body table tr:nth-child(odd):hover td{background:#212122}.markdown-body table tr:last-child td:first-child{border-bottom-left-radius:4px}.markdown-body table tr:last-child td:last-child{border-bottom-right-radius:4px}.markdown-body table td{background:#fbfbfb;padding:16px;text-align:left;vertical-align:middle;font-size:16px;border-right:1px solid #c1c3d1}.markdown-body table td:last-child{border-right:0}.markdown-body blockquote{color:#777;padding:1px 16px;margin:24px 0;border-left:4px solid #c6c4c4;background-color:#f1f1f1;transition:all .3s ease-out;border-radius:4px}.markdown-body blockquote:hover{border-left-color:#212122;background-color:#212122;color:#fff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:24px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body span.math{margin-left:32px;font-size:18px;font-weight:700}@media (max-width:720px){.markdown-body h1{font-size:30.4px}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:19.2px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:12.8px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><p>在 Python 中调用 <code>subprocess.run</code> 执行 FFmpeg 命令是视频自动化处理的常见方案。然而，面对 Windows/Linux/macOS 的跨平台兼容性、NVIDIA/Intel/AMD/Apple 的硬件加速差异，以及“拼接黑帧”、“音画不同步”等经典坑点，写出一套健壮的代码并不容易。</p>
<p>本文将总结一套完整的解决方案，涵盖硬件编码参数映射、精确变速剪辑、以及多流合并的终极逻辑。</p>
<hr/>
<h2 data-id="heading-0">一、 跨平台硬件加速：统一接口设计</h2>
<p>不同硬件编码器 NVENC, QSV, VAAPI, VideoToolbox 对参数的要求各不相同。我们需要一个中间层，将通用的“画质 CRF ”和“速度 Preset ”映射到底层参数。</p>
<h3 data-id="heading-1">1. 核心映射逻辑</h3>
<ul>
<li><strong>Preset（预设）</strong>：x264 使用 <code>fast/medium/slow</code>，但 NVENC 使用 <code>p1-p7</code>，VideoToolbox 不支持 preset。</li>
<li><strong>Quality（画质）</strong>：x264/x265 使用 <code>-crf</code>，但硬件编码器通常使用 <code>-cq</code> (NVENC), <code>-global_quality</code> (QSV), 或 <code>-q:v</code> (Apple)。</li>
</ul>
<h3 data-id="heading-2">2. Python 实现代码</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Tuple</span>, <span class="hljs-type">List</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">_translate_crf_to_hw_quality</span>(<span class="hljs-params">crf_value: <span class="hljs-built_in">str</span>, encoder_family: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">int</span>:
    <span class="hljs-string">"""
    将 CRF (0-51) 转换为不同硬件的质量参数。
    """</span>
    <span class="hljs-keyword">try</span>:
        crf = <span class="hljs-built_in">float</span>(crf_value)
        <span class="hljs-comment"># NVENC/QSV/VAAPI: 范围 ~1-51，越小质量越高，逻辑与 CRF 类似</span>
        <span class="hljs-keyword">if</span> encoder_family <span class="hljs-keyword">in</span> [<span class="hljs-string">'nvenc'</span>, <span class="hljs-string">'qsv'</span>, <span class="hljs-string">'vaapi'</span>]:
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">int</span>(<span class="hljs-built_in">max</span>(<span class="hljs-number">1</span>, <span class="hljs-built_in">min</span>(crf, <span class="hljs-number">51</span>)))
        
        <span class="hljs-comment"># VideoToolbox (Mac): 范围 1-100，越大质量越高。需要反向映射。</span>
        <span class="hljs-comment"># 经验公式: Quality = 100 - (CRF * 1.8)</span>
        <span class="hljs-keyword">if</span> encoder_family == <span class="hljs-string">'videotoolbox'</span>:
            quality = <span class="hljs-number">100</span> - (crf * <span class="hljs-number">1.8</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">int</span>(<span class="hljs-built_in">max</span>(<span class="hljs-number">1</span>, <span class="hljs-built_in">min</span>(quality, <span class="hljs-number">100</span>)))
            
    <span class="hljs-keyword">except</span> (ValueError, TypeError):
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">_build_hw_command</span>(<span class="hljs-params">args: <span class="hljs-built_in">list</span>, hw_codec: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>], <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]]:
    <span class="hljs-string">"""
    构建硬件编码参数。
    返回: (新参数列表, 硬件解码参数列表)
    """</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> hw_codec <span class="hljs-keyword">or</span> <span class="hljs-string">'libx'</span> <span class="hljs-keyword">in</span> hw_codec <span class="hljs-keyword">or</span> hw_codec == <span class="hljs-string">'copy'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>(args), []

    encoder_family = hw_codec.split(<span class="hljs-string">'_'</span>)[-<span class="hljs-number">1</span>].lower() <span class="hljs-comment"># 提取 nvenc, qsv 等</span>
    
    <span class="hljs-comment"># 1. Preset 映射表</span>
    PRESET_MAP = {
        <span class="hljs-string">'nvenc'</span>: {<span class="hljs-string">'fast'</span>: <span class="hljs-string">'p2'</span>, <span class="hljs-string">'medium'</span>: <span class="hljs-string">'p4'</span>, <span class="hljs-string">'slow'</span>: <span class="hljs-string">'p7'</span>}, <span class="hljs-comment"># p1-p7</span>
        <span class="hljs-string">'qsv'</span>: {<span class="hljs-string">'fast'</span>: <span class="hljs-string">'faster'</span>, <span class="hljs-string">'medium'</span>: <span class="hljs-string">'medium'</span>, <span class="hljs-string">'slow'</span>: <span class="hljs-string">'slower'</span>},
        <span class="hljs-string">'amf'</span>: {<span class="hljs-string">'fast'</span>: <span class="hljs-string">'speed'</span>, <span class="hljs-string">'medium'</span>: <span class="hljs-string">'balanced'</span>, <span class="hljs-string">'slow'</span>: <span class="hljs-string">'quality'</span>},
        <span class="hljs-string">'videotoolbox'</span>: <span class="hljs-literal">None</span> <span class="hljs-comment"># Apple 硬编不支持 -preset</span>
    }
    
    <span class="hljs-comment"># 2. 质量参数名映射表</span>
    QUALITY_PARAM_MAP = {
        <span class="hljs-string">'nvenc'</span>: <span class="hljs-string">'-cq'</span>,
        <span class="hljs-string">'qsv'</span>: <span class="hljs-string">'-global_quality'</span>,
        <span class="hljs-string">'videotoolbox'</span>: <span class="hljs-string">'-q:v'</span>,
    }

    new_args = []
    <span class="hljs-comment"># ... (省略遍历 args 替换 -c:v, -preset, -crf 的循环逻辑</span>
    <span class="hljs-comment"># 核心是将 args 中的 -crf 23 替换为 [hw_param, mapped_value]</span>
    
    <span class="hljs-keyword">return</span> new_args, []
</code></pre>
<hr/>
<h2 data-id="heading-3">二、 中间素材处理：精确变速与 All-Intra</h2>
<p>在制作长视频时，我们经常需要将长素材切片、变速，最后再拼接。这里有两个核心痛点：<strong>拼接处的卡顿</strong>和<strong>变速后的时长不准</strong>。</p>
<h3 data-id="heading-4">1. 为什么用 <code>-g 1</code> (All-Intra)？</h3>
<p>如果视频包含 P  预测帧 和 B  双向预测帧 ，直接拼接容易导致花屏或时间轴错乱。
<strong>解决方案</strong>：在切片阶段，强制使用 <strong>All-Intra</strong> 模式（即每一帧都是关键帧）。</p>
<ul>
<li><strong>通用参数</strong>：<code>-g 1</code> (GOP size = 1)。这比 <code>-x264-params keyint=1</code> 更通用。</li>
<li><strong>编码器选择</strong>：推荐 <code>libx264</code>。虽然 <code>libx265</code> 压缩率高，但在 All-Intra 模式下体积优势不明显，且编码极慢，拼接兼容性不如 H.264。</li>
</ul>
<h3 data-id="heading-5">2. 精确时长的“三明治”法 (<code>tpad</code> + <code>setpts</code>)</h3>
<p>直接使用 <code>setpts</code> 变速，往往会导致最后一帧由于浮点数精度被丢弃，造成拼接黑场。
<strong>解决方案</strong>：先加尾巴 Padding ，再变速，最后切断。</p>
<p><strong>场景</strong>：截取片段，慢放 2 倍，精确控制输出时长。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 目标：慢放视频，且保证时长绝对精确，防止丢帧</span>
speed_factor = <span class="hljs-number">2.0</span> <span class="hljs-comment"># 慢放2倍 (PTS * 2)</span>
input_duration = <span class="hljs-number">5.0</span> <span class="hljs-comment"># 原始切片时长</span>
target_duration = input_duration * speed_factor <span class="hljs-comment"># 目标时长 10.0秒</span>

cmd = [
    <span class="hljs-string">'-i'</span>, <span class="hljs-string">'input.mp4'</span>,
    <span class="hljs-string">'-an'</span>, <span class="hljs-comment"># 去除音频，防止变速后音画不同步干扰</span>
    <span class="hljs-string">'-c:v'</span>, <span class="hljs-string">'libx264'</span>,
    <span class="hljs-string">'-g'</span>, <span class="hljs-string">'1'</span>, <span class="hljs-comment"># All-Intra，拼接神器</span>
    
    <span class="hljs-comment"># --- 滤镜链 ---</span>
    <span class="hljs-comment"># 1. tpad: 先在尾部复制最后一帧 0.1秒  作为安全缓冲 </span>
    <span class="hljs-comment"># 2. setpts: 将 (原视频 + padding) 整体拉伸</span>
    <span class="hljs-comment"># 结果：缓冲也被拉伸了，保证了最后有足够的数据供截取</span>
    <span class="hljs-string">'-vf'</span>, <span class="hljs-string">f'tpad=stop_mode=clone:stop_duration=0.1,setpts=<span class="hljs-subst">{speed_factor}</span>*PTS'</span>,
    
    <span class="hljs-comment"># --- 关键设置 ---</span>
    <span class="hljs-string">'-fps_mode'</span>, <span class="hljs-string">'vfr'</span>, <span class="hljs-comment"># 允许可变帧率，防止强行对齐导致卡顿</span>
    
    <span class="hljs-comment"># --- 输出截断 ---</span>
    <span class="hljs-comment"># 强制只输出目标时长，切掉多余的 padding</span>
    <span class="hljs-string">'-t'</span>, <span class="hljs-string">f'<span class="hljs-subst">{target_duration:<span class="hljs-number">.6</span>f}</span>'</span>, 
    <span class="hljs-string">'output_clip.mp4'</span>
]
</code></pre>
<hr/>
<h2 data-id="heading-6">三、 终极合并：音频、视频与字幕的复杂关系</h2>
<p>当我们将处理好的视频（无声）、配音文件（m4a）、字幕文件（srt/ass）合并时，需要处理 4 种复杂场景。</p>
<h3 data-id="heading-7">1. 常见陷阱</h3>
<ul>
<li><strong>Windows 路径转义</strong>：FFmpeg 滤镜 (<code>-vf subtitles=...</code>) 中，路径不能直接用 <code>C:\</code>，必须转义为 <code>C\:</code>，且路径分隔符最好用 <code>/</code>。</li>
<li><strong>流映射 (<code>-map</code>)</strong>：多输入源时，必须显式指定 <code>-map 0:v -map 1:a</code>，否则 FFmpeg 可能会错误地选择静音流。</li>
<li><strong>Copy 模式的参数污染</strong>：使用 <code>-c:v copy</code> 时，绝对不能加 <code>-crf</code>、<code>-preset</code> 或 <code>-fps_mode</code>，否则必报错。</li>
</ul>
<h3 data-id="heading-8">2. 健壮的合并逻辑代码</h3>
<p>这是可以直接用于生产环境的合并代码，涵盖了硬/软字幕及有/无配音的排列组合。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path

<span class="hljs-keyword">def</span> <span class="hljs-title function_">merge_media</span>(<span class="hljs-params">novoice_mp4, audio_file, subtitle_file, sub_type, output_path</span>):
    <span class="hljs-string">"""
    sub_type: 1/3 为硬字幕(烧录), 2/4 为软字幕(流)
    """</span>
    <span class="hljs-comment"># 1. 路径处理 (Windows 滤镜兼容性关键!)</span>
    <span class="hljs-comment"># subtitles='C\:/path/to/file.srt'</span>
    abs_sub = Path(subtitle_file).resolve().as_posix()
    vf_sub_path = abs_sub.replace(<span class="hljs-string">':'</span>, <span class="hljs-string">'\\:'</span>) 

    <span class="hljs-comment"># 2. 基础命令</span>
    cmd = [<span class="hljs-string">"ffmpeg"</span>, <span class="hljs-string">"-y"</span>, <span class="hljs-string">"-i"</span>, novoice_mp4]
    
    has_audio = <span class="hljs-literal">False</span>
    <span class="hljs-keyword">if</span> audio_file <span class="hljs-keyword">and</span> os.path.exists(audio_file):
        cmd.extend([<span class="hljs-string">"-i"</span>, audio_file])
        has_audio = <span class="hljs-literal">True</span>
        
    <span class="hljs-comment"># 如果是软字幕，需要作为输入流</span>
    <span class="hljs-keyword">if</span> sub_type <span class="hljs-keyword">in</span> [<span class="hljs-number">2</span>, <span class="hljs-number">4</span>]:
        cmd.extend([<span class="hljs-string">"-i"</span>, subtitle_file])

    <span class="hljs-comment"># 3. 场景分支构建</span>
    <span class="hljs-comment"># 场景 A: 硬字幕 (必须重编码)</span>
    <span class="hljs-keyword">if</span> sub_type <span class="hljs-keyword">in</span> [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>]:
        <span class="hljs-comment"># Map: 视频(0) + 音频(1,如有)</span>
        cmd.extend([<span class="hljs-string">'-map'</span>, <span class="hljs-string">'0:v'</span>])
        <span class="hljs-keyword">if</span> has_audio:
            cmd.extend([<span class="hljs-string">'-map'</span>, <span class="hljs-string">'1:a'</span>])
            
        cmd.extend([
            <span class="hljs-string">'-c:v'</span>, <span class="hljs-string">'libx264'</span>, <span class="hljs-comment"># 硬字幕无法 Copy</span>
            <span class="hljs-string">'-vf'</span>, <span class="hljs-string">f"subtitles='<span class="hljs-subst">{vf_sub_path}</span>'"</span>, <span class="hljs-comment"># 注意单引号包裹</span>
            <span class="hljs-string">'-c:a'</span>, <span class="hljs-string">'copy'</span> <span class="hljs-keyword">if</span> has_audio <span class="hljs-keyword">else</span> <span class="hljs-string">'none'</span>
        ])

    <span class="hljs-comment"># 场景 B: 软字幕 (MP4封装推荐 mov_text)</span>
    <span class="hljs-keyword">elif</span> sub_type <span class="hljs-keyword">in</span> [<span class="hljs-number">2</span>, <span class="hljs-number">4</span>]:
        <span class="hljs-comment"># Map: 视频(0) + 音频(1,如有) + 字幕(1或2)</span>
        cmd.extend([<span class="hljs-string">'-map'</span>, <span class="hljs-string">'0:v'</span>])
        <span class="hljs-keyword">if</span> has_audio:
            cmd.extend([<span class="hljs-string">'-map'</span>, <span class="hljs-string">'1:a'</span>, <span class="hljs-string">'-map'</span>, <span class="hljs-string">'2:s'</span>])
        <span class="hljs-keyword">else</span>:
            cmd.extend([<span class="hljs-string">'-map'</span>, <span class="hljs-string">'1:s'</span>]) <span class="hljs-comment"># 此时字幕是第2个输入(索引1)</span>

        cmd.extend([
            <span class="hljs-string">'-c:v'</span>, <span class="hljs-string">'copy'</span>, <span class="hljs-comment"># 软字幕视频流可以直接 Copy (速度快)</span>
            <span class="hljs-string">'-c:a'</span>, <span class="hljs-string">'copy'</span> <span class="hljs-keyword">if</span> has_audio <span class="hljs-keyword">else</span> <span class="hljs-string">'none'</span>,
            <span class="hljs-string">'-c:s'</span>, <span class="hljs-string">'mov_text'</span>
        ])

    <span class="hljs-comment"># 4. 通用参数与执行</span>
    cmd.extend([<span class="hljs-string">'-movflags'</span>, <span class="hljs-string">'+faststart'</span>])
    
    <span class="hljs-comment"># 只有在重编码(非copy)时才加 CRF/Preset</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">'-c:v'</span> <span class="hljs-keyword">in</span> cmd <span class="hljs-keyword">and</span> <span class="hljs-string">'copy'</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> cmd[cmd.index(<span class="hljs-string">'-c:v'</span>)+<span class="hljs-number">1</span>]:
         cmd.extend([<span class="hljs-string">'-crf'</span>, <span class="hljs-string">'23'</span>, <span class="hljs-string">'-preset'</span>, <span class="hljs-string">'fast'</span>, <span class="hljs-string">'-fps_mode'</span>, <span class="hljs-string">'vfr'</span>])

    cmd.append(output_path)
    
    <span class="hljs-comment"># 执行 (subprocess)</span>
    <span class="hljs-comment"># tools.runffmpeg(cmd) </span>
</code></pre>
<hr/>
<h2 data-id="heading-9">四、 避坑指南</h2>
<h3 data-id="heading-10">Q1: 音频比视频短怎么办？</h3>
<ul>
<li><strong>方法 A (无损)</strong>：使用 <code>-c:a copy</code> 并指定 <code>-t &lt;视频时长&gt;</code>。FFmpeg 会在视频结束时截断，如果音频短，后面就是无声画面。</li>
<li><strong>方法 B (填充静音)</strong>：使用 <code>-c:a aac -af apad -shortest</code>。<code>apad</code> 会给音频无限补静音，<code>-shortest</code> 会在视频结束时停止。注意这需要重编码音频。</li>
</ul>
<h3 data-id="heading-11">Q2: 为什么慢放时画面抖动？</h3>
<ul>
<li><strong>原因</strong>：你在慢放时指定了 <code>-r 30</code> 或没有加 <code>-fps_mode vfr</code>。FFmpeg 为了凑齐帧率，复制了相同的帧。</li>
<li><strong>解决</strong>：在慢放且重编码时，务必加上 <strong><code>-fps_mode vfr</code></strong>，让 FFmpeg 保留原始时间戳信息，不进行强制对齐。</li>
</ul>
<h3 data-id="heading-12">Q3: <code>subprocess</code> 报错 "No such file" 但文件明明存在？</h3>
<ul>
<li><strong>原因</strong>：通常是列表构建错误。</li>
<li><strong>错误示例</strong>：<code>cmd = [..., "-vf", "subtitles=...", "-crf", "23"]</code> (没有错)。</li>
<li><strong>常见手误</strong>：<code>cmd = [..., "+faststart" "-crf", ...]</code> (少了个逗号，Python 把两个字符串连起来了)。</li>
<li><strong>检查</strong>：打印 <code>print(cmd)</code>，看是否有奇怪的合并项。</li>
</ul>
<hr/>
<h2 data-id="heading-13">结语</h2>
<p>视频处理自动化的核心在于<strong>对 FFmpeg 处理流逻辑的理解</strong>。通过标准化的硬件参数映射、All-Intra 的中间素材预处理、以及严谨的 Map 映射逻辑，我们可以构建出一个既高效又稳定的视频生产流水线。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Drools规则引擎实战指南]]></title>    <link>https://juejin.cn/post/7579906040537563182</link>    <guid>https://juejin.cn/post/7579906040537563182</guid>    <pubDate>2025-12-05T03:05:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579906040537563182" data-draft-id="7579917791764758555" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Drools规则引擎实战指南"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-05T03:05:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Drools规则引擎实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:05:32.000Z" title="Fri Dec 05 2025 03:05:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Drools规则引擎实战指南：从入门到生产应用</h2>
<h3 data-id="heading-1">前言</h3>
<p>Drools是一个开源的业务规则管理系统（BRMS），基于Java开发，提供了强大的规则引擎能力。它将业务逻辑从代码中分离出来，使业务人员可以直接维护规则，提高了系统的灵活性和可维护性。本文将深入介绍Drools的核心概念和实战应用。</p>
<h3 data-id="heading-2">一、Drools核心架构</h3>
<h4 data-id="heading-3">1.1 整体架构图</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">+</span><span class="hljs-comment">----------------------------------------------------------+</span>
<span class="hljs-operator">|</span>                    Drools Architecture                    <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>                                                          <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">------------------+      +------------------+          |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  Rules (DRL)     <span class="hljs-operator">|</span>      <span class="hljs-operator">|</span>  Fact Model      <span class="hljs-operator">|</span>          <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">-----------+   |      |  +-----------+   |          |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span> Rule <span class="hljs-number">1</span>    <span class="hljs-operator">|</span>   <span class="hljs-operator">|</span>      <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span> Java POJO <span class="hljs-operator">|</span>   <span class="hljs-operator">|</span>          <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span> Rule <span class="hljs-number">2</span>    <span class="hljs-operator">|</span>   <span class="hljs-operator">|</span>      <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span> Objects   <span class="hljs-operator">|</span>   <span class="hljs-operator">|</span>          <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span> Rule <span class="hljs-number">3</span>    <span class="hljs-operator">|</span>   <span class="hljs-operator">|</span>      <span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">-----------+   |          |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">-----------+   |      +--------+---------+          |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">--------+---------+               |                    |</span>
<span class="hljs-operator">|</span>           <span class="hljs-operator">|</span>                         <span class="hljs-operator">|</span>                    <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>           v                         v                    <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">--------+--------------------------+---------+         |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>         Knowledge Base (KieBase)           <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------------+  |         |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  Compiled Rules <span class="hljs-operator">+</span> Patterns          <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">--------------------------------------+  |         |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">--------+---------------------------------+  |         |</span>
<span class="hljs-operator">|</span>           <span class="hljs-operator">|</span>                                    <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>           v                                    <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">--------+---------------------------------+  |         |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>      Working Memory (KieSession)        <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------+  |  |         |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-keyword">Insert</span> Facts <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">Pattern</span> <span class="hljs-keyword">Match</span>   <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">Execute</span> Actions              <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------+  |  |         |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">------------------------------------------+  |         |</span>
<span class="hljs-operator">|</span>                                                <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">------------------------------------------+  |         |</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>           Agenda (Rule Execution)        <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  Rule1 [priority<span class="hljs-operator">=</span><span class="hljs-number">10</span>] <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">Execute</span>          <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>  Rule2 [priority<span class="hljs-operator">=</span><span class="hljs-number">5</span>]  <span class="hljs-operator">-</span><span class="hljs-operator">&gt;</span> <span class="hljs-keyword">Execute</span>          <span class="hljs-operator">|</span>  <span class="hljs-operator">|</span>         <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  <span class="hljs-operator">+</span><span class="hljs-comment">------------------------------------------+  |         |</span>
<span class="hljs-operator">+</span><span class="hljs-comment">----------------------------------------------------------+</span>
</code></pre>
<h4 data-id="heading-4">1.2 核心组件说明</h4>
<pre><code class="hljs language-lua" lang="lua">组件层次结构:

KieServices
    |
    +<span class="hljs-comment">-- KieContainer</span>
            |
            +<span class="hljs-comment">-- KieBase (Knowledge Base)</span>
                    |
                    +<span class="hljs-comment">-- KieSession (Working Memory)</span>
                            |
                            +<span class="hljs-comment">-- Facts (业务对象)</span>
                            +<span class="hljs-comment">-- Agenda (规则执行队列)</span>
</code></pre>
<h3 data-id="heading-5">二、快速开始</h3>
<h4 data-id="heading-6">2.1 Maven依赖配置</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- pom.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">drools.version</span>&gt;</span>8.44.0.Final<span class="hljs-tag">&lt;/<span class="hljs-name">drools.version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">spring.boot.version</span>&gt;</span>3.1.5<span class="hljs-tag">&lt;/<span class="hljs-name">spring.boot.version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Drools核心依赖 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.drools<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>drools-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${drools.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.drools<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>drools-compiler<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${drools.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.drools<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>drools-mvel<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${drools.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Decision Table支持 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.drools<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>drools-decisiontables<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${drools.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Spring Boot集成 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${spring.boot.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.18.30<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h4 data-id="heading-7">2.2 项目结构</h4>
<pre><code class="hljs language-css" lang="css">drools-demo/
├── <span class="hljs-attribute">src</span>/
│   ├── <span class="hljs-selector-tag">main</span>/
│   │   ├── java/
│   │   │   └── com/example/drools/
│   │   │       ├── config/
│   │   │       │   └── DroolsConfig<span class="hljs-selector-class">.java</span>
│   │   │       ├── model/
│   │   │       │   ├── <span class="hljs-attribute">Order</span><span class="hljs-selector-class">.java</span>
│   │   │       │   ├── Customer<span class="hljs-selector-class">.java</span>
│   │   │       │   └── Product<span class="hljs-selector-class">.java</span>
│   │   │       ├── service/
│   │   │       │   └── RuleService<span class="hljs-selector-class">.java</span>
│   │   │       └── DroolsApplication<span class="hljs-selector-class">.java</span>
│   │   └── resources/
│   │       ├── rules/
│   │       │   ├── discount-rules<span class="hljs-selector-class">.drl</span>
│   │       │   ├── validation-rules<span class="hljs-selector-class">.drl</span>
│   │       │   └── promotion-rules<span class="hljs-selector-class">.drl</span>
│   │       ├── META-INF/
│   │       │   └── kmodule<span class="hljs-selector-class">.xml</span>
│   │       └── application<span class="hljs-selector-class">.yml</span>
│   └── test/
└── pom<span class="hljs-selector-class">.xml</span>
</code></pre>
<h3 data-id="heading-8">三、实体模型定义</h3>
<h4 data-id="heading-9">3.1 订单实体</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.model;

<span class="hljs-keyword">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.NoArgsConstructor;

<span class="hljs-keyword">import</span> java.math.BigDecimal;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> {
    <span class="hljs-keyword">private</span> Long orderId;
    <span class="hljs-keyword">private</span> Customer customer;
    <span class="hljs-keyword">private</span> List&lt;OrderItem&gt; items = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> BigDecimal totalAmount;
    <span class="hljs-keyword">private</span> <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discountAmount</span> <span class="hljs-operator">=</span> BigDecimal.ZERO;
    <span class="hljs-keyword">private</span> BigDecimal finalAmount;
    <span class="hljs-keyword">private</span> String status;
    <span class="hljs-keyword">private</span> LocalDateTime orderTime;
    <span class="hljs-keyword">private</span> String promotionCode;

    <span class="hljs-comment">// 业务方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">calculateTotalAmount</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>.totalAmount = items.stream()
                .map(OrderItem::getSubtotal)
                .reduce(BigDecimal.ZERO, BigDecimal::add);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">applyDiscount</span><span class="hljs-params">(BigDecimal discount)</span> {
        <span class="hljs-built_in">this</span>.discountAmount = <span class="hljs-built_in">this</span>.discountAmount.add(discount);
        <span class="hljs-built_in">this</span>.finalAmount = <span class="hljs-built_in">this</span>.totalAmount.subtract(<span class="hljs-built_in">this</span>.discountAmount);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getItemCount</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> items.stream()
                .mapToInt(OrderItem::getQuantity)
                .sum();
    }
}

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderItem</span> {
    <span class="hljs-keyword">private</span> Product product;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> quantity;
    <span class="hljs-keyword">private</span> BigDecimal price;
    <span class="hljs-keyword">private</span> BigDecimal subtotal;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">calculateSubtotal</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">this</span>.subtotal = <span class="hljs-built_in">this</span>.price.multiply(BigDecimal.valueOf(quantity));
    }
}
</code></pre>
<h4 data-id="heading-10">3.2 客户实体</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.model;

<span class="hljs-keyword">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.NoArgsConstructor;

<span class="hljs-keyword">import</span> java.time.LocalDate;

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Customer</span> {
    <span class="hljs-keyword">private</span> Long customerId;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> String level;  <span class="hljs-comment">// VIP, GOLD, SILVER, NORMAL</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> loyaltyPoints;
    <span class="hljs-keyword">private</span> LocalDate memberSince;
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> isNewCustomer;

    <span class="hljs-comment">// 业务方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getMemberYears</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> LocalDate.now().getYear() - memberSince.getYear();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isVip</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"VIP"</span>.equals(level);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isGold</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"GOLD"</span>.equals(level);
    }
}
</code></pre>
<h4 data-id="heading-11">3.3 产品实体</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.model;

<span class="hljs-keyword">import</span> lombok.AllArgsConstructor;
<span class="hljs-keyword">import</span> lombok.Data;
<span class="hljs-keyword">import</span> lombok.NoArgsConstructor;

<span class="hljs-keyword">import</span> java.math.BigDecimal;

<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {
    <span class="hljs-keyword">private</span> Long productId;
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> String category;  <span class="hljs-comment">// ELECTRONICS, CLOTHING, FOOD, BOOKS</span>
    <span class="hljs-keyword">private</span> BigDecimal price;
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> onSale;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> stockQuantity;

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isInStock</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> stockQuantity &gt; <span class="hljs-number">0</span>;
    }
}
</code></pre>
<h3 data-id="heading-12">四、Drools配置</h3>
<h4 data-id="heading-13">4.1 KModule配置文件</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- src/main/resources/META-INF/kmodule.xml --&gt;</span>
<span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">kmodule</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.drools.org/xsd/kmodule"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">kbase</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"rules"</span> <span class="hljs-attr">packages</span>=<span class="hljs-string">"rules"</span> <span class="hljs-attr">default</span>=<span class="hljs-string">"true"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ksession</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"ksession-rules"</span> <span class="hljs-attr">default</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"stateful"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">kbase</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">kmodule</span>&gt;</span>
</code></pre>
<h4 data-id="heading-14">4.2 Spring Boot配置类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.config;

<span class="hljs-keyword">import</span> org.kie.api.KieServices;
<span class="hljs-keyword">import</span> org.kie.api.builder.KieBuilder;
<span class="hljs-keyword">import</span> org.kie.api.builder.KieFileSystem;
<span class="hljs-keyword">import</span> org.kie.api.builder.KieModule;
<span class="hljs-keyword">import</span> org.kie.api.runtime.KieContainer;
<span class="hljs-keyword">import</span> org.kie.api.runtime.KieSession;
<span class="hljs-keyword">import</span> org.kie.internal.io.ResourceFactory;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.core.io.Resource;
<span class="hljs-keyword">import</span> org.springframework.core.io.support.PathMatchingResourcePatternResolver;
<span class="hljs-keyword">import</span> org.springframework.core.io.support.ResourcePatternResolver;

<span class="hljs-keyword">import</span> java.io.IOException;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DroolsConfig</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">RULES_PATH</span> <span class="hljs-operator">=</span> <span class="hljs-string">"rules/"</span>;

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> KieContainer <span class="hljs-title function_">kieContainer</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-type">KieServices</span> <span class="hljs-variable">kieServices</span> <span class="hljs-operator">=</span> KieServices.Factory.get();
        <span class="hljs-type">KieFileSystem</span> <span class="hljs-variable">kieFileSystem</span> <span class="hljs-operator">=</span> kieServices.newKieFileSystem();

        <span class="hljs-comment">// 加载所有规则文件</span>
        <span class="hljs-type">ResourcePatternResolver</span> <span class="hljs-variable">resourcePatternResolver</span> <span class="hljs-operator">=</span>
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">PathMatchingResourcePatternResolver</span>();
        Resource[] resources = resourcePatternResolver
                .getResources(<span class="hljs-string">"classpath*:"</span> + RULES_PATH + <span class="hljs-string">"**/*.drl"</span>);

        <span class="hljs-keyword">for</span> (Resource resource : resources) {
            kieFileSystem.write(ResourceFactory.newClassPathResource(
                    RULES_PATH + resource.getFilename(), <span class="hljs-string">"UTF-8"</span>));
        }

        <span class="hljs-type">KieBuilder</span> <span class="hljs-variable">kieBuilder</span> <span class="hljs-operator">=</span> kieServices.newKieBuilder(kieFileSystem);
        kieBuilder.buildAll();

        <span class="hljs-type">KieModule</span> <span class="hljs-variable">kieModule</span> <span class="hljs-operator">=</span> kieBuilder.getKieModule();
        <span class="hljs-keyword">return</span> kieServices.newKieContainer(kieModule.getReleaseId());
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> KieSession <span class="hljs-title function_">kieSession</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-keyword">return</span> kieContainer().newKieSession();
    }
}
</code></pre>
<h3 data-id="heading-15">五、规则文件编写</h3>
<h4 data-id="heading-16">5.1 折扣规则</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// src/main/resources/rules/discount-rules.drl</span>
<span class="hljs-keyword">package</span> rules

<span class="hljs-keyword">import</span> com.example.drools.model.Order
<span class="hljs-keyword">import</span> com.example.drools.model.Customer
<span class="hljs-keyword">import</span> java.math.BigDecimal

<span class="hljs-comment">// 规则1: VIP客户享受15%折扣</span>
rule <span class="hljs-string">"VIP Customer Discount"</span>
    salience <span class="hljs-number">100</span>  <span class="hljs-comment">// 优先级</span>
    when
        $order: Order(customer.level == <span class="hljs-string">"VIP"</span>)
    then
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> $order.getTotalAmount()
                .multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.15"</span>));
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"应用VIP折扣: "</span> + discount);
        update($order);
end

<span class="hljs-comment">// 规则2: 金卡客户享受10%折扣</span>
rule <span class="hljs-string">"Gold Customer Discount"</span>
    salience <span class="hljs-number">90</span>
    when
        $order: Order(customer.level == <span class="hljs-string">"GOLD"</span>)
    then
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> $order.getTotalAmount()
                .multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.10"</span>));
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"应用金卡折扣: "</span> + discount);
        update($order);
end

<span class="hljs-comment">// 规则3: 订单金额超过1000元享受8%折扣</span>
rule <span class="hljs-string">"Large Order Discount"</span>
    salience <span class="hljs-number">80</span>
    when
        $order: Order(totalAmount &gt;= <span class="hljs-number">1000</span>)
    then
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> $order.getTotalAmount()
                .multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.08"</span>));
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"应用大额订单折扣: "</span> + discount);
        update($order);
end

<span class="hljs-comment">// 规则4: 新客户首单享受5%折扣</span>
rule <span class="hljs-string">"New Customer First Order Discount"</span>
    salience <span class="hljs-number">70</span>
    when
        $order: Order(customer.isNewCustomer == <span class="hljs-literal">true</span>)
    then
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> $order.getTotalAmount()
                .multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.05"</span>));
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"应用新客户折扣: "</span> + discount);
        update($order);
end

<span class="hljs-comment">// 规则5: 购买商品数量超过10件享受额外折扣</span>
rule <span class="hljs-string">"Bulk Purchase Discount"</span>
    salience <span class="hljs-number">60</span>
    when
        $order: Order(itemCount &gt; <span class="hljs-number">10</span>)
    then
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"50"</span>);
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"应用批量购买折扣: "</span> + discount);
        update($order);
end
</code></pre>
<h4 data-id="heading-17">5.2 促销规则</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// src/main/resources/rules/promotion-rules.drl</span>
<span class="hljs-keyword">package</span> rules

<span class="hljs-keyword">import</span> com.example.drools.model.Order
<span class="hljs-keyword">import</span> com.example.drools.model.OrderItem
<span class="hljs-keyword">import</span> com.example.drools.model.Product
<span class="hljs-keyword">import</span> java.math.BigDecimal
<span class="hljs-keyword">import</span> java.time.LocalDateTime
<span class="hljs-keyword">import</span> java.time.LocalTime

<span class="hljs-comment">// 规则1: 电子产品类别促销 - 买2送1</span>
rule <span class="hljs-string">"Electronics Buy 2 Get 1 Free"</span>
    when
        $order: Order()
        $item: OrderItem(product.category == <span class="hljs-string">"ELECTRONICS"</span>, quantity &gt;= <span class="hljs-number">2</span>) from $order.items
    then
        <span class="hljs-type">int</span> <span class="hljs-variable">freeItems</span> <span class="hljs-operator">=</span> $item.getQuantity() / <span class="hljs-number">2</span>;
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> $item.getPrice()
                .multiply(BigDecimal.valueOf(freeItems));
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"电子产品买2送1，优惠: "</span> + discount);
        update($order);
end

<span class="hljs-comment">// 规则2: 促销码应用</span>
rule <span class="hljs-string">"Promotion Code - SAVE20"</span>
    when
        $order: Order(promotionCode == <span class="hljs-string">"SAVE20"</span>)
    then
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> $order.getTotalAmount()
                .multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.20"</span>));
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"应用促销码SAVE20，优惠: "</span> + discount);
        update($order);
end

<span class="hljs-comment">// 规则3: 限时促销 - 每天10-12点额外9折</span>
rule <span class="hljs-string">"Time Limited Promotion"</span>
    when
        $order: Order()
        eval(LocalTime.now().isAfter(LocalTime.of(<span class="hljs-number">10</span>, <span class="hljs-number">0</span>)) &amp;&amp;
             LocalTime.now().isBefore(LocalTime.of(<span class="hljs-number">12</span>, <span class="hljs-number">0</span>)))
    then
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> $order.getTotalAmount()
                .multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.10"</span>));
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"应用限时促销，优惠: "</span> + discount);
        update($order);
end

<span class="hljs-comment">// 规则4: 满减活动 - 满500减50</span>
rule <span class="hljs-string">"Full Reduction 500-50"</span>
    when
        $order: Order(totalAmount &gt;= <span class="hljs-number">500</span>)
    then
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"50"</span>);
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"满500减50，优惠: "</span> + discount);
        update($order);
end

<span class="hljs-comment">// 规则5: 特定品类组合优惠</span>
rule <span class="hljs-string">"Category Combo Discount"</span>
    when
        $order: Order()
        exists(OrderItem(product.category == <span class="hljs-string">"ELECTRONICS"</span>) from $order.items)
        exists(OrderItem(product.category == <span class="hljs-string">"BOOKS"</span>) from $order.items)
    then
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">discount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"30"</span>);
        $order.applyDiscount(discount);
        System.out.println(<span class="hljs-string">"电子产品+图书组合优惠: "</span> + discount);
        update($order);
end
</code></pre>
<h4 data-id="heading-18">5.3 验证规则</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// src/main/resources/rules/validation-rules.drl</span>
<span class="hljs-keyword">package</span> rules

<span class="hljs-keyword">import</span> com.example.drools.model.Order
<span class="hljs-keyword">import</span> com.example.drools.model.OrderItem
<span class="hljs-keyword">import</span> com.example.drools.model.Product

global java.util.List validationErrors

<span class="hljs-comment">// 规则1: 库存验证</span>
rule <span class="hljs-string">"Check Product Stock"</span>
    when
        $order: Order()
        $item: OrderItem(product.stockQuantity &lt; quantity) from $order.items
    then
        validationErrors.add(<span class="hljs-string">"产品 "</span> + $item.getProduct().getName() +
                           <span class="hljs-string">" 库存不足，库存: "</span> + $item.getProduct().getStockQuantity() +
                           <span class="hljs-string">"，需求: "</span> + $item.getQuantity());
        System.out.println(<span class="hljs-string">"库存验证失败: "</span> + $item.getProduct().getName());
end

<span class="hljs-comment">// 规则2: 订单金额验证</span>
rule <span class="hljs-string">"Minimum Order Amount"</span>
    when
        $order: Order(totalAmount &lt; <span class="hljs-number">10</span>)
    then
        validationErrors.add(<span class="hljs-string">"订单金额不能少于10元"</span>);
        System.out.println(<span class="hljs-string">"订单金额验证失败"</span>);
end

<span class="hljs-comment">// 规则3: 订单项数量验证</span>
rule <span class="hljs-string">"Maximum Item Quantity"</span>
    when
        $order: Order()
        $item: OrderItem(quantity &gt; <span class="hljs-number">100</span>) from $order.items
    then
        validationErrors.add(<span class="hljs-string">"单个商品购买数量不能超过100件"</span>);
        System.out.println(<span class="hljs-string">"商品数量验证失败"</span>);
end

<span class="hljs-comment">// 规则4: VIP客户特殊权限</span>
rule <span class="hljs-string">"VIP Special Product Access"</span>
    when
        $order: Order(customer.level != <span class="hljs-string">"VIP"</span>)
        $item: OrderItem(product.name matches <span class="hljs-string">".*VIP专享.*"</span>) from $order.items
    then
        validationErrors.add(<span class="hljs-string">"VIP专享商品仅限VIP客户购买"</span>);
        System.out.println(<span class="hljs-string">"VIP权限验证失败"</span>);
end
</code></pre>
<h3 data-id="heading-19">六、规则服务实现</h3>
<h4 data-id="heading-20">6.1 规则引擎服务</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.service;

<span class="hljs-keyword">import</span> com.example.drools.model.Order;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.kie.api.runtime.KieContainer;
<span class="hljs-keyword">import</span> org.kie.api.runtime.KieSession;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RuleService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> KieContainer kieContainer;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RuleService</span><span class="hljs-params">(KieContainer kieContainer)</span> {
        <span class="hljs-built_in">this</span>.kieContainer = kieContainer;
    }

    <span class="hljs-comment">/**
     * 执行折扣规则
     */</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">applyDiscountRules</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-type">KieSession</span> <span class="hljs-variable">kieSession</span> <span class="hljs-operator">=</span> kieContainer.newKieSession();

        <span class="hljs-keyword">try</span> {
            log.info(<span class="hljs-string">"开始执行折扣规则，订单ID: {}"</span>, order.getOrderId());

            <span class="hljs-comment">// 插入事实对象</span>
            kieSession.insert(order);

            <span class="hljs-comment">// 触发所有规则</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">firedRules</span> <span class="hljs-operator">=</span> kieSession.fireAllRules();

            log.info(<span class="hljs-string">"执行了 {} 条规则"</span>, firedRules);
            log.info(<span class="hljs-string">"原始金额: {}, 折扣金额: {}, 最终金额: {}"</span>,
                    order.getTotalAmount(),
                    order.getDiscountAmount(),
                    order.getFinalAmount());

            <span class="hljs-keyword">return</span> order;
        } <span class="hljs-keyword">finally</span> {
            kieSession.dispose();
        }
    }

    <span class="hljs-comment">/**
     * 验证订单
     */</span>
    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">validateOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-type">KieSession</span> <span class="hljs-variable">kieSession</span> <span class="hljs-operator">=</span> kieContainer.newKieSession();
        List&lt;String&gt; validationErrors = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-keyword">try</span> {
            log.info(<span class="hljs-string">"开始验证订单，订单ID: {}"</span>, order.getOrderId());

            <span class="hljs-comment">// 设置全局变量</span>
            kieSession.setGlobal(<span class="hljs-string">"validationErrors"</span>, validationErrors);

            <span class="hljs-comment">// 插入事实对象</span>
            kieSession.insert(order);
            order.getItems().forEach(kieSession::insert);

            <span class="hljs-comment">// 触发所有规则</span>
            kieSession.fireAllRules();

            <span class="hljs-keyword">if</span> (validationErrors.isEmpty()) {
                log.info(<span class="hljs-string">"订单验证通过"</span>);
            } <span class="hljs-keyword">else</span> {
                log.warn(<span class="hljs-string">"订单验证失败: {}"</span>, validationErrors);
            }

            <span class="hljs-keyword">return</span> validationErrors;
        } <span class="hljs-keyword">finally</span> {
            kieSession.dispose();
        }
    }

    <span class="hljs-comment">/**
     * 执行指定规则
     */</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">applySpecificRule</span><span class="hljs-params">(Order order, String ruleName)</span> {
        <span class="hljs-type">KieSession</span> <span class="hljs-variable">kieSession</span> <span class="hljs-operator">=</span> kieContainer.newKieSession();

        <span class="hljs-keyword">try</span> {
            log.info(<span class="hljs-string">"执行指定规则: {}"</span>, ruleName);

            kieSession.insert(order);

            <span class="hljs-comment">// 执行指定的规则</span>
            kieSession.getAgenda().getAgendaGroup(ruleName).setFocus();
            kieSession.fireAllRules();

            <span class="hljs-keyword">return</span> order;
        } <span class="hljs-keyword">finally</span> {
            kieSession.dispose();
        }
    }

    <span class="hljs-comment">/**
     * 批量处理订单
     */</span>
    <span class="hljs-keyword">public</span> List&lt;Order&gt; <span class="hljs-title function_">batchProcessOrders</span><span class="hljs-params">(List&lt;Order&gt; orders)</span> {
        <span class="hljs-type">KieSession</span> <span class="hljs-variable">kieSession</span> <span class="hljs-operator">=</span> kieContainer.newKieSession();

        <span class="hljs-keyword">try</span> {
            log.info(<span class="hljs-string">"批量处理 {} 个订单"</span>, orders.size());

            <span class="hljs-comment">// 插入所有订单</span>
            orders.forEach(kieSession::insert);

            <span class="hljs-comment">// 触发所有规则</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">firedRules</span> <span class="hljs-operator">=</span> kieSession.fireAllRules();
            log.info(<span class="hljs-string">"总共执行了 {} 条规则"</span>, firedRules);

            <span class="hljs-keyword">return</span> orders;
        } <span class="hljs-keyword">finally</span> {
            kieSession.dispose();
        }
    }
}
</code></pre>
<h4 data-id="heading-21">6.2 订单处理服务</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.service;

<span class="hljs-keyword">import</span> com.example.drools.model.*;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.math.BigDecimal;
<span class="hljs-keyword">import</span> java.time.LocalDateTime;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RuleService ruleService;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">OrderService</span><span class="hljs-params">(RuleService ruleService)</span> {
        <span class="hljs-built_in">this</span>.ruleService = ruleService;
    }

    <span class="hljs-comment">/**
     * 创建订单并应用规则
     */</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Customer customer, List&lt;OrderItem&gt; items, String promotionCode)</span> {
        <span class="hljs-comment">// 创建订单</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
        order.setOrderId(System.currentTimeMillis());
        order.setCustomer(customer);
        order.setItems(items);
        order.setOrderTime(LocalDateTime.now());
        order.setPromotionCode(promotionCode);
        order.setStatus(<span class="hljs-string">"CREATED"</span>);

        <span class="hljs-comment">// 计算小计</span>
        items.forEach(OrderItem::calculateSubtotal);

        <span class="hljs-comment">// 计算总金额</span>
        order.calculateTotalAmount();
        order.setFinalAmount(order.getTotalAmount());

        log.info(<span class="hljs-string">"创建订单: {}, 客户: {}, 原始金额: {}"</span>,
                order.getOrderId(),
                customer.getName(),
                order.getTotalAmount());

        <span class="hljs-comment">// 验证订单</span>
        List&lt;String&gt; errors = ruleService.validateOrder(order);
        <span class="hljs-keyword">if</span> (!errors.isEmpty()) {
            order.setStatus(<span class="hljs-string">"VALIDATION_FAILED"</span>);
            log.error(<span class="hljs-string">"订单验证失败: {}"</span>, errors);
            <span class="hljs-keyword">return</span> order;
        }

        <span class="hljs-comment">// 应用折扣规则</span>
        order = ruleService.applyDiscountRules(order);
        order.setStatus(<span class="hljs-string">"CONFIRMED"</span>);

        log.info(<span class="hljs-string">"订单处理完成: {}, 最终金额: {}, 节省: {}"</span>,
                order.getOrderId(),
                order.getFinalAmount(),
                order.getDiscountAmount());

        <span class="hljs-keyword">return</span> order;
    }

    <span class="hljs-comment">/**
     * 计算订单优惠预览
     */</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">previewDiscount</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-comment">// 创建订单副本用于预览</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">previewOrder</span> <span class="hljs-operator">=</span> cloneOrder(order);
        <span class="hljs-keyword">return</span> ruleService.applyDiscountRules(previewOrder);
    }

    <span class="hljs-keyword">private</span> Order <span class="hljs-title function_">cloneOrder</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">clone</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
        clone.setOrderId(order.getOrderId());
        clone.setCustomer(order.getCustomer());
        clone.setItems(order.getItems());
        clone.setTotalAmount(order.getTotalAmount());
        clone.setFinalAmount(order.getTotalAmount());
        clone.setPromotionCode(order.getPromotionCode());
        <span class="hljs-keyword">return</span> clone;
    }
}
</code></pre>
<h3 data-id="heading-22">七、实际应用场景</h3>
<h4 data-id="heading-23">7.1 电商促销系统</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.scenario;

<span class="hljs-keyword">import</span> com.example.drools.model.*;
<span class="hljs-keyword">import</span> com.example.drools.service.OrderService;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.math.BigDecimal;
<span class="hljs-keyword">import</span> java.time.LocalDate;
<span class="hljs-keyword">import</span> java.util.Arrays;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EcommerceScenario</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OrderService orderService;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">EcommerceScenario</span><span class="hljs-params">(OrderService orderService)</span> {
        <span class="hljs-built_in">this</span>.orderService = orderService;
    }

    <span class="hljs-comment">/**
     * 场景1: VIP客户购买电子产品
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">vipCustomerPurchase</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 创建VIP客户</span>
        <span class="hljs-type">Customer</span> <span class="hljs-variable">vipCustomer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Customer</span>(
                <span class="hljs-number">1L</span>,
                <span class="hljs-string">"张三"</span>,
                <span class="hljs-string">"VIP"</span>,
                <span class="hljs-number">5000</span>,
                LocalDate.of(<span class="hljs-number">2020</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>),
                <span class="hljs-literal">false</span>
        );

        <span class="hljs-comment">// 创建商品</span>
        <span class="hljs-type">Product</span> <span class="hljs-variable">laptop</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(
                <span class="hljs-number">101L</span>,
                <span class="hljs-string">"笔记本电脑"</span>,
                <span class="hljs-string">"ELECTRONICS"</span>,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"5999"</span>),
                <span class="hljs-literal">true</span>,
                <span class="hljs-number">50</span>
        );

        <span class="hljs-type">Product</span> <span class="hljs-variable">mouse</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(
                <span class="hljs-number">102L</span>,
                <span class="hljs-string">"无线鼠标"</span>,
                <span class="hljs-string">"ELECTRONICS"</span>,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"199"</span>),
                <span class="hljs-literal">true</span>,
                <span class="hljs-number">100</span>
        );

        <span class="hljs-comment">// 创建订单项</span>
        <span class="hljs-type">OrderItem</span> <span class="hljs-variable">item1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderItem</span>(laptop, <span class="hljs-number">1</span>, laptop.getPrice(), BigDecimal.ZERO);
        <span class="hljs-type">OrderItem</span> <span class="hljs-variable">item2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderItem</span>(mouse, <span class="hljs-number">2</span>, mouse.getPrice(), BigDecimal.ZERO);

        List&lt;OrderItem&gt; items = Arrays.asList(item1, item2);

        <span class="hljs-comment">// 处理订单</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderService.createOrder(vipCustomer, items, <span class="hljs-literal">null</span>);

        printOrderSummary(order);
    }

    <span class="hljs-comment">/**
     * 场景2: 新客户首单
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">newCustomerFirstOrder</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Customer</span> <span class="hljs-variable">newCustomer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Customer</span>(
                <span class="hljs-number">2L</span>,
                <span class="hljs-string">"李四"</span>,
                <span class="hljs-string">"NORMAL"</span>,
                <span class="hljs-number">0</span>,
                LocalDate.now(),
                <span class="hljs-literal">true</span>
        );

        <span class="hljs-type">Product</span> <span class="hljs-variable">book</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(
                <span class="hljs-number">201L</span>,
                <span class="hljs-string">"Java编程思想"</span>,
                <span class="hljs-string">"BOOKS"</span>,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"89"</span>),
                <span class="hljs-literal">false</span>,
                <span class="hljs-number">200</span>
        );

        <span class="hljs-type">OrderItem</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderItem</span>(book, <span class="hljs-number">3</span>, book.getPrice(), BigDecimal.ZERO);

        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderService.createOrder(newCustomer, Arrays.asList(item), <span class="hljs-literal">null</span>);

        printOrderSummary(order);
    }

    <span class="hljs-comment">/**
     * 场景3: 促销码+大额订单
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">promotionCodePurchase</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Customer</span> <span class="hljs-variable">goldCustomer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Customer</span>(
                <span class="hljs-number">3L</span>,
                <span class="hljs-string">"王五"</span>,
                <span class="hljs-string">"GOLD"</span>,
                <span class="hljs-number">2000</span>,
                LocalDate.of(<span class="hljs-number">2022</span>, <span class="hljs-number">6</span>, <span class="hljs-number">1</span>),
                <span class="hljs-literal">false</span>
        );

        <span class="hljs-type">Product</span> <span class="hljs-variable">phone</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(
                <span class="hljs-number">301L</span>,
                <span class="hljs-string">"智能手机"</span>,
                <span class="hljs-string">"ELECTRONICS"</span>,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"3999"</span>),
                <span class="hljs-literal">true</span>,
                <span class="hljs-number">30</span>
        );

        <span class="hljs-type">OrderItem</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderItem</span>(phone, <span class="hljs-number">1</span>, phone.getPrice(), BigDecimal.ZERO);

        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderService.createOrder(
                goldCustomer,
                Arrays.asList(item),
                <span class="hljs-string">"SAVE20"</span>
        );

        printOrderSummary(order);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printOrderSummary</span><span class="hljs-params">(Order order)</span> {
        System.out.println(<span class="hljs-string">"\n========== 订单摘要 =========="</span>);
        System.out.println(<span class="hljs-string">"订单ID: "</span> + order.getOrderId());
        System.out.println(<span class="hljs-string">"客户: "</span> + order.getCustomer().getName() +
                         <span class="hljs-string">" ("</span> + order.getCustomer().getLevel() + <span class="hljs-string">")"</span>);
        System.out.println(<span class="hljs-string">"商品数量: "</span> + order.getItemCount());
        System.out.println(<span class="hljs-string">"原始金额: ¥"</span> + order.getTotalAmount());
        System.out.println(<span class="hljs-string">"优惠金额: ¥"</span> + order.getDiscountAmount());
        System.out.println(<span class="hljs-string">"最终金额: ¥"</span> + order.getFinalAmount());
        System.out.println(<span class="hljs-string">"状态: "</span> + order.getStatus());
        System.out.println(<span class="hljs-string">"=============================\n"</span>);
    }
}
</code></pre>
<h4 data-id="heading-24">7.2 规则执行流程</h4>
<pre><code class="hljs language-lua" lang="lua">订单处理流程:

+<span class="hljs-comment">------------------+</span>
|   创建订单对象    |
+<span class="hljs-comment">--------+---------+</span>
         |
         v
+<span class="hljs-comment">--------+---------+</span>
|   计算商品小计    |
+<span class="hljs-comment">--------+---------+</span>
         |
         v
+<span class="hljs-comment">--------+---------+</span>
|   计算订单总额    |
+<span class="hljs-comment">--------+---------+</span>
         |
         v
+<span class="hljs-comment">--------+---------+</span>
|   订单验证规则    |
|   - 库存检查     |
|   - 金额检查     |
|   - 权限检查     |
+<span class="hljs-comment">--------+---------+</span>
         |
    +<span class="hljs-comment">----+----+</span>
    |         |
   YES       NO
    |         |
    v         v
+<span class="hljs-comment">---+----+ +--+------------+</span>
|折扣规则 | | 返回验证错误  |
|执行    | +<span class="hljs-comment">--------------+</span>
+<span class="hljs-comment">---+----+</span>
    |
    v
+<span class="hljs-comment">---+------------+</span>
| 按优先级执行:   |
| <span class="hljs-number">1.</span> VIP折扣     |
| <span class="hljs-number">2.</span> 会员折扣     |
| <span class="hljs-number">3.</span> 大额折扣     |
| <span class="hljs-number">4.</span> 促销折扣     |
+<span class="hljs-comment">---+------------+</span>
    |
    v
+<span class="hljs-comment">---+------------+</span>
| 计算最终金额    |
+<span class="hljs-comment">---+------------+</span>
    |
    v
+<span class="hljs-comment">---+------------+</span>
| 返回订单结果    |
+<span class="hljs-comment">----------------+</span>
</code></pre>
<h3 data-id="heading-25">八、Decision Table决策表</h3>
<h4 data-id="heading-26">8.1 Excel决策表</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 决策表结构 (在Excel中)</span>
<span class="hljs-comment">/*
RuleTable DiscountDecisionTable

CONDITION                    CONDITION           CONDITION       ACTION
客户等级                      订单金额            商品数量         折扣率
customer.level              totalAmount         itemCount       discountRate

VIP                         &gt;1000               &gt;5              0.20
VIP                         &gt;500                &gt;0              0.15
GOLD                        &gt;1000               &gt;5              0.15
GOLD                        &gt;500                &gt;0              0.10
SILVER                      &gt;1000               &gt;10             0.10
SILVER                      &gt;500                &gt;0              0.08
NORMAL                      &gt;2000               &gt;20             0.08
NORMAL                      &gt;1000               &gt;10             0.05
*/</span>
</code></pre>
<h4 data-id="heading-27">8.2 加载Decision Table</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.config;

<span class="hljs-keyword">import</span> org.drools.decisiontable.InputType;
<span class="hljs-keyword">import</span> org.drools.decisiontable.SpreadsheetCompiler;
<span class="hljs-keyword">import</span> org.kie.api.KieServices;
<span class="hljs-keyword">import</span> org.kie.api.builder.KieBuilder;
<span class="hljs-keyword">import</span> org.kie.api.builder.KieFileSystem;
<span class="hljs-keyword">import</span> org.kie.api.builder.KieModule;
<span class="hljs-keyword">import</span> org.kie.api.io.ResourceType;
<span class="hljs-keyword">import</span> org.kie.api.runtime.KieContainer;
<span class="hljs-keyword">import</span> org.kie.internal.io.ResourceFactory;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;

<span class="hljs-keyword">import</span> java.io.InputStream;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DecisionTableConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> KieContainer <span class="hljs-title function_">decisionTableContainer</span><span class="hljs-params">()</span> {
        <span class="hljs-type">KieServices</span> <span class="hljs-variable">kieServices</span> <span class="hljs-operator">=</span> KieServices.Factory.get();
        <span class="hljs-type">KieFileSystem</span> <span class="hljs-variable">kieFileSystem</span> <span class="hljs-operator">=</span> kieServices.newKieFileSystem();

        <span class="hljs-comment">// 编译Excel决策表</span>
        <span class="hljs-type">InputStream</span> <span class="hljs-variable">template</span> <span class="hljs-operator">=</span> getClass()
                .getResourceAsStream(<span class="hljs-string">"/decision-tables/discount-table.xls"</span>);

        <span class="hljs-type">SpreadsheetCompiler</span> <span class="hljs-variable">compiler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpreadsheetCompiler</span>();
        <span class="hljs-type">String</span> <span class="hljs-variable">drl</span> <span class="hljs-operator">=</span> compiler.compile(template, InputType.XLS);

        kieFileSystem.write(<span class="hljs-string">"src/main/resources/discount-table.drl"</span>, drl);

        <span class="hljs-type">KieBuilder</span> <span class="hljs-variable">kieBuilder</span> <span class="hljs-operator">=</span> kieServices.newKieBuilder(kieFileSystem);
        kieBuilder.buildAll();

        <span class="hljs-type">KieModule</span> <span class="hljs-variable">kieModule</span> <span class="hljs-operator">=</span> kieBuilder.getKieModule();
        <span class="hljs-keyword">return</span> kieServices.newKieContainer(kieModule.getReleaseId());
    }
}
</code></pre>
<h3 data-id="heading-28">九、监控与调试</h3>
<h4 data-id="heading-29">9.1 规则执行监听器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.listener;

<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.kie.api.event.rule.*;

<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RuleExecutionListener</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DefaultAgendaEventListener</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">beforeMatchFired</span><span class="hljs-params">(BeforeMatchFiredEvent event)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">ruleName</span> <span class="hljs-operator">=</span> event.getMatch().getRule().getName();
        log.info(<span class="hljs-string">"准备执行规则: {}"</span>, ruleName);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterMatchFired</span><span class="hljs-params">(AfterMatchFiredEvent event)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">ruleName</span> <span class="hljs-operator">=</span> event.getMatch().getRule().getName();
        log.info(<span class="hljs-string">"规则执行完成: {}"</span>, ruleName);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">matchCreated</span><span class="hljs-params">(MatchCreatedEvent event)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">ruleName</span> <span class="hljs-operator">=</span> event.getMatch().getRule().getName();
        log.debug(<span class="hljs-string">"规则匹配成功: {}"</span>, ruleName);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">matchCancelled</span><span class="hljs-params">(MatchCancelledEvent event)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">ruleName</span> <span class="hljs-operator">=</span> event.getMatch().getRule().getName();
        log.debug(<span class="hljs-string">"规则匹配取消: {}"</span>, ruleName);
    }
}
</code></pre>
<h4 data-id="heading-30">9.2 使用监听器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.service;

<span class="hljs-keyword">import</span> com.example.drools.listener.RuleExecutionListener;
<span class="hljs-keyword">import</span> com.example.drools.model.Order;
<span class="hljs-keyword">import</span> org.kie.api.runtime.KieContainer;
<span class="hljs-keyword">import</span> org.kie.api.runtime.KieSession;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MonitoredRuleService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> KieContainer kieContainer;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MonitoredRuleService</span><span class="hljs-params">(KieContainer kieContainer)</span> {
        <span class="hljs-built_in">this</span>.kieContainer = kieContainer;
    }

    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">executeWithMonitoring</span><span class="hljs-params">(Order order)</span> {
        <span class="hljs-type">KieSession</span> <span class="hljs-variable">kieSession</span> <span class="hljs-operator">=</span> kieContainer.newKieSession();

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 添加监听器</span>
            kieSession.addEventListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RuleExecutionListener</span>());

            <span class="hljs-comment">// 执行规则</span>
            kieSession.insert(order);
            kieSession.fireAllRules();

            <span class="hljs-keyword">return</span> order;
        } <span class="hljs-keyword">finally</span> {
            kieSession.dispose();
        }
    }
}
</code></pre>
<h3 data-id="heading-31">十、性能优化</h3>
<h4 data-id="heading-32">10.1 规则优化建议</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 优化前 - 性能较差</span>
rule <span class="hljs-string">"Bad Performance Rule"</span>
    when
        $order: Order()
        $customer: Customer() from $order.customer
        $item: OrderItem() from $order.items
    then
        <span class="hljs-comment">// 复杂计算</span>
end

<span class="hljs-comment">// 优化后 - 性能更好</span>
rule <span class="hljs-string">"Good Performance Rule"</span>
    salience <span class="hljs-number">100</span>
    when
        $order: Order(
            customer.level == <span class="hljs-string">"VIP"</span>,
            totalAmount &gt; <span class="hljs-number">1000</span>
        )
    then
        <span class="hljs-comment">// 简化逻辑</span>
        $order.applyDiscount($order.getTotalAmount().multiply(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.15"</span>)));
end
</code></pre>
<h4 data-id="heading-33">10.2 KieSession管理</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools.service;

<span class="hljs-keyword">import</span> org.kie.api.runtime.KieContainer;
<span class="hljs-keyword">import</span> org.kie.api.runtime.KieSession;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> javax.annotation.PreDestroy;
<span class="hljs-keyword">import</span> java.util.concurrent.ConcurrentLinkedQueue;

<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KieSessionPool</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> KieContainer kieContainer;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentLinkedQueue&lt;KieSession&gt; sessionPool;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">POOL_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">KieSessionPool</span><span class="hljs-params">(KieContainer kieContainer)</span> {
        <span class="hljs-built_in">this</span>.kieContainer = kieContainer;
        <span class="hljs-built_in">this</span>.sessionPool = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentLinkedQueue</span>&lt;&gt;();
        initializePool();
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initializePool</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; POOL_SIZE; i++) {
            sessionPool.offer(kieContainer.newKieSession());
        }
    }

    <span class="hljs-keyword">public</span> KieSession <span class="hljs-title function_">getSession</span><span class="hljs-params">()</span> {
        <span class="hljs-type">KieSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> sessionPool.poll();
        <span class="hljs-keyword">if</span> (session == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> kieContainer.newKieSession();
        }
        <span class="hljs-keyword">return</span> session;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">returnSession</span><span class="hljs-params">(KieSession session)</span> {
        <span class="hljs-keyword">if</span> (session != <span class="hljs-literal">null</span>) {
            session.dispose();
            sessionPool.offer(kieContainer.newKieSession());
        }
    }

    <span class="hljs-meta">@PreDestroy</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanup</span><span class="hljs-params">()</span> {
        sessionPool.forEach(KieSession::dispose);
    }
}
</code></pre>
<h3 data-id="heading-34">十一、测试用例</h3>
<h4 data-id="heading-35">11.1 单元测试</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.drools;

<span class="hljs-keyword">import</span> com.example.drools.model.*;
<span class="hljs-keyword">import</span> com.example.drools.service.RuleService;
<span class="hljs-keyword">import</span> org.junit.jupiter.api.BeforeEach;
<span class="hljs-keyword">import</span> org.junit.jupiter.api.Test;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.boot.test.context.SpringBootTest;

<span class="hljs-keyword">import</span> java.math.BigDecimal;
<span class="hljs-keyword">import</span> java.time.LocalDate;
<span class="hljs-keyword">import</span> java.util.Arrays;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> org.junit.jupiter.api.Assertions.*;

<span class="hljs-meta">@SpringBootTest</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DroolsRuleTest</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RuleService ruleService;

    <span class="hljs-keyword">private</span> Order testOrder;
    <span class="hljs-keyword">private</span> Customer vipCustomer;

    <span class="hljs-meta">@BeforeEach</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUp</span><span class="hljs-params">()</span> {
        vipCustomer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Customer</span>(
                <span class="hljs-number">1L</span>, <span class="hljs-string">"测试VIP"</span>, <span class="hljs-string">"VIP"</span>, <span class="hljs-number">5000</span>,
                LocalDate.of(<span class="hljs-number">2020</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>), <span class="hljs-literal">false</span>
        );

        <span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(
                <span class="hljs-number">1L</span>, <span class="hljs-string">"测试商品"</span>, <span class="hljs-string">"ELECTRONICS"</span>,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"1000"</span>), <span class="hljs-literal">true</span>, <span class="hljs-number">100</span>
        );

        <span class="hljs-type">OrderItem</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderItem</span>(
                product, <span class="hljs-number">2</span>, product.getPrice(), BigDecimal.ZERO
        );
        item.calculateSubtotal();

        testOrder = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
        testOrder.setOrderId(<span class="hljs-number">1L</span>);
        testOrder.setCustomer(vipCustomer);
        testOrder.setItems(Arrays.asList(item));
        testOrder.calculateTotalAmount();
        testOrder.setFinalAmount(testOrder.getTotalAmount());
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testVipDiscount</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> ruleService.applyDiscountRules(testOrder);

        assertTrue(result.getDiscountAmount().compareTo(BigDecimal.ZERO) &gt; <span class="hljs-number">0</span>,
                <span class="hljs-string">"VIP客户应该有折扣"</span>);
        assertTrue(result.getFinalAmount().compareTo(result.getTotalAmount()) &lt; <span class="hljs-number">0</span>,
                <span class="hljs-string">"最终金额应该小于原始金额"</span>);
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testLargeOrderDiscount</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Product</span> <span class="hljs-variable">expensiveProduct</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(
                <span class="hljs-number">2L</span>, <span class="hljs-string">"昂贵商品"</span>, <span class="hljs-string">"ELECTRONICS"</span>,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"1500"</span>), <span class="hljs-literal">true</span>, <span class="hljs-number">50</span>
        );
        <span class="hljs-type">OrderItem</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderItem</span>(
                expensiveProduct, <span class="hljs-number">1</span>, expensiveProduct.getPrice(), BigDecimal.ZERO
        );
        item.calculateSubtotal();

        testOrder.setItems(Arrays.asList(item));
        testOrder.calculateTotalAmount();

        <span class="hljs-type">Order</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> ruleService.applyDiscountRules(testOrder);

        assertTrue(result.getDiscountAmount().compareTo(BigDecimal.ZERO) &gt; <span class="hljs-number">0</span>,
                <span class="hljs-string">"大额订单应该有折扣"</span>);
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">testOrderValidation</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Product</span> <span class="hljs-variable">outOfStock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(
                <span class="hljs-number">3L</span>, <span class="hljs-string">"缺货商品"</span>, <span class="hljs-string">"ELECTRONICS"</span>,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"500"</span>), <span class="hljs-literal">true</span>, <span class="hljs-number">0</span>
        );
        <span class="hljs-type">OrderItem</span> <span class="hljs-variable">item</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderItem</span>(outOfStock, <span class="hljs-number">1</span>, outOfStock.getPrice(), BigDecimal.ZERO);

        testOrder.setItems(Arrays.asList(item));

        List&lt;String&gt; errors = ruleService.validateOrder(testOrder);

        assertFalse(errors.isEmpty(), <span class="hljs-string">"应该有验证错误"</span>);
        assertTrue(errors.stream().anyMatch(e -&gt; e.contains(<span class="hljs-string">"库存"</span>)),
                <span class="hljs-string">"应该包含库存错误"</span>);
    }
}
</code></pre>
<h3 data-id="heading-36">十二、总结</h3>
<p>本文全面介绍了Drools规则引擎的实战应用：</p>
<ol>
<li><strong>核心架构</strong>：KieBase、KieSession、Agenda工作原理</li>
<li><strong>规则编写</strong>：DRL语法、条件匹配、动作执行</li>
<li><strong>Spring集成</strong>：配置管理、依赖注入</li>
<li><strong>实战场景</strong>：电商促销、订单折扣、库存验证</li>
<li><strong>高级特性</strong>：Decision Table、规则监听、性能优化</li>
<li><strong>最佳实践</strong>：规则设计、Session管理、测试策略</li>
</ol>
<p>Drools将业务规则与代码解耦，使规则更易维护和扩展，是企业级应用的理想选择。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数组判断？我早不用instanceof了，现在一行代码搞定！]]></title>    <link>https://juejin.cn/post/7579849892614094884</link>    <guid>https://juejin.cn/post/7579849892614094884</guid>    <pubDate>2025-12-05T03:02:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579849892614094884" data-draft-id="7571846248718794752" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数组判断？我早不用instanceof了，现在一行代码搞定！"/> <meta itemprop="keywords" content="JavaScript,前端"/> <meta itemprop="datePublished" content="2025-12-05T03:02:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南游"/> <meta itemprop="url" content="https://juejin.cn/user/1728872003943688"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数组判断？我早不用instanceof了，现在一行代码搞定！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1728872003943688/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南游
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:02:33.000Z" title="Fri Dec 05 2025 03:02:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">传统方案</h3>
<h4 data-id="heading-1">1. Object.prototype.toString.call 方法</h4>
<p><strong>原理</strong>：通过调用 <code>Object.prototype.toString.call(obj)</code> ，判断返回值是否为  <code>[object Array]</code> 。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">isArray</span>(<span class="hljs-params">obj</span>){
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(obj) === <span class="hljs-string">'[object Array]'</span>;
}
</code></pre>
<p> 
<strong>缺陷</strong>：</p>
<ul>
<li>
<p>ES6 引入 <code>Symbol.toStringTag</code> 后，可被人为篡改。例如：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {
  [<span class="hljs-title class_">Symbol</span>.<span class="hljs-property">toStringTag</span>]: <span class="hljs-string">'Array'</span>
};
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">toString</span>.<span class="hljs-title function_">call</span>(obj)); <span class="hljs-comment">// 输出 [object Array]</span>
</code></pre>
</li>
<li>
<p>若开发通用型代码（如框架、库），该漏洞会导致判断失效。</p>
</li>
</ul>
<h4 data-id="heading-2">2. instanceof 方法</h4>
<p><strong>原理</strong>：判断对象原型链上是否存在 <code>Array</code> 构造函数。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">isArray</span>(<span class="hljs-params">obj</span>){
  <span class="hljs-keyword">return</span> obj <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Array</span>;
}
</code></pre>
<p><strong>缺陷</strong>：</p>
<ul>
<li>
<p>可通过 <code>Object.setPrototypeOf</code> 篡改原型链，导致误判。例如：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> obj = {};
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">setPrototypeOf</span>(obj, <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(obj <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Array</span>); <span class="hljs-comment">// 输出 true，但 obj 并非真正数组</span>
</code></pre>
</li>
<li>
<p>跨 iframe 场景失效。不同 iframe 中的 <code>Array</code> 构造函数不共享，导致真数组被误判为非数组。例如：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> frame = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'iframe'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Array2</span> = frame.<span class="hljs-property">contentWindow</span>.<span class="hljs-property">Array</span>;
<span class="hljs-keyword">const</span> arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array2</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Array</span>); <span class="hljs-comment">// 输出 false，但 arr 是真正数组</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-3">ES6 原生方法</h3>
<p><strong>方法</strong>：使用 <code>Array.isArray</code> 静态方法。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(arr));
</code></pre>
<p> 
<strong>优势</strong>：</p>
<ul>
<li>
<p>该方法由JavaScript引擎内部实现，直接判断对象是否由 Array 构造函数创建，不受原型链、 Symbol.toStringTag  或跨 iframe 影响；</p>
</li>
<li>
<p>完美解决所有边界场景。</p>
</li>
</ul>
<h3 data-id="heading-4">总结</h3>
<p>判断数组的方法中 <code>Array.isArray</code> 是唯一准确且无缺陷的方案。其他方法（如<code>Object.prototype.toString.call</code>、<code>instanceof</code>）均存在局限性，仅在特定场景下可用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS属性：background-position]]></title>    <link>https://juejin.cn/post/7579849892614144036</link>    <guid>https://juejin.cn/post/7579849892614144036</guid>    <pubDate>2025-12-05T03:04:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579849892614144036" data-draft-id="7579846685071933494" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS属性：background-position"/> <meta itemprop="keywords" content="CSS"/> <meta itemprop="datePublished" content="2025-12-05T03:04:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="tj"/> <meta itemprop="url" content="https://juejin.cn/user/4218165277233182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS属性：background-position
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4218165277233182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    tj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:04:07.000Z" title="Fri Dec 05 2025 03:04:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>background-position</strong>是CSS中用于设置背景图片初始位置的属性。这个位置是相对于由<strong>background-origin</strong>定义的位置图层的。通过这个属性，可以精确控制背景图像在元素中的位置，无论是水平还是垂直方向。</p>
<p>使用background-position</p>
<p><strong>background-position</strong>属性可以接受多种类型的值，包括关键字、百分比或长度值。这些值定义了背景图像相对于元素盒子模型边界的x/y坐标。例如：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 关键字值 */</span>
<span class="hljs-attribute">background-position</span>: top;
<span class="hljs-attribute">background-position</span>: bottom;
<span class="hljs-attribute">background-position</span>: left;
<span class="hljs-attribute">background-position</span>: right;
<span class="hljs-attribute">background-position</span>: center;
<span class="hljs-comment">/* 百分比值 */</span>
<span class="hljs-attribute">background-position</span>: <span class="hljs-number">25%</span> <span class="hljs-number">75%</span>;
<span class="hljs-comment">/* 长度值 */</span>
<span class="hljs-attribute">background-position</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span>;
<span class="hljs-attribute">background-position</span>: <span class="hljs-number">1cm</span> <span class="hljs-number">2cm</span>;
<span class="hljs-attribute">background-position</span>: <span class="hljs-number">10ch</span> <span class="hljs-number">8em</span>;
<span class="hljs-comment">/* 多个背景图像 */</span>
<span class="hljs-attribute">background-position</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span>, center;
<span class="hljs-comment">/* 边缘偏移值 */</span>
<span class="hljs-attribute">background-position</span>: bottom <span class="hljs-number">10px</span> right <span class="hljs-number">20px</span>;
</code></pre>
<p>语法和值</p>
<ul>
<li><strong>单个值</strong>：如果只指定了一个值，第二个值默认是<strong>center</strong>。</li>
<li><strong>两个值</strong>：第一个值通常是水平位置，第二个值是垂直位置。如果两个值都是关键字，比如<em>top left</em>，它们的顺序不重要，因为浏览器会重新排序。</li>
<li><strong>三个值</strong>：两个关键字值和一个偏移量，其中偏移量是前面关键字值的偏移。</li>
<li><strong>四个值</strong>：两个定义X和Y的关键字值，以及两个偏移量。</li>
</ul>
<p>百分比值的计算</p>
<p>百分比值是相对于容器的大小减去背景图像大小的。例如，<em>background-position: 25% 75%</em> 表示图像上的左侧25%和顶部75%的位置将放置在距容器左侧25%和距容器顶部75%的容器位置。</p>
<p>示例</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 使用 `background` 缩写 */</span>
exampleone {
 <span class="hljs-attribute">background</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">"startransparent.gif"</span>) <span class="hljs-number">#ffee99</span> <span class="hljs-number">2.5cm</span> bottom no-repeat;
}
exampletwo {
 <span class="hljs-attribute">background</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">"startransparent.gif"</span>) <span class="hljs-number">#ffee99</span> left <span class="hljs-number">4em</span> bottom <span class="hljs-number">1em</span> no-repeat;
}
<span class="hljs-comment">/* 多背景图片：每个图片依次和相应的 `background-position` 匹配 */</span>
examplethree {
 <span class="hljs-attribute">background-image</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">"startransparent.gif"</span>), <span class="hljs-built_in">url</span>(<span class="hljs-string">"catfront.png"</span>);
 <span class="hljs-attribute">background-position</span>: <span class="hljs-number">0px</span> <span class="hljs-number">0px</span>, right <span class="hljs-number">3em</span> bottom <span class="hljs-number">2em</span>;
}
</code></pre>
<p>在上述示例中， <em>.exampleone</em>和 <em>.exampletwo</em>使用了<em>background</em>缩写来设置背景图像及其位置，而 <em>.examplethree</em>则演示了如何为两个不同的背景图片指定位置。</p>
<p>浏览器兼容性</p>
<p><strong>background-position</strong>属性在所有现代浏览器中都得到了支持，包括Chrome、Firefox、Safari、Opera等。对于旧版本的IE，可能需要额外的兼容性考虑。</p>
<p>通过使用<strong>background-position</strong>属性，开发者可以灵活地控制背景图像的显示方式，无论是固定在某个位置，还是相对于元素的边缘进行偏移。这为页面设计提供了更多的创意空间和视觉效果的可能性。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[标书智能体（三）——生成标书正文代码+提示词]]></title>    <link>https://juejin.cn/post/7579892134816727075</link>    <guid>https://juejin.cn/post/7579892134816727075</guid>    <pubDate>2025-12-05T03:05:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579892134816727075" data-draft-id="7579887768227627042" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="标书智能体（三）——生成标书正文代码+提示词"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-05T03:05:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户246293206767"/> <meta itemprop="url" content="https://juejin.cn/user/3871844943530826"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            标书智能体（三）——生成标书正文代码+提示词
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3871844943530826/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户246293206767
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:05:59.000Z" title="Fri Dec 05 2025 03:05:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>用Python+React打造一个开源的AI写标书智能体~</p>
<p><strong>完整代码已开源</strong></p>
<p>代码很多，文章只放主要代码和提示词，完整代码可以查看开源项目</p>
<p>Github： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyibiaoai%2Fyibiao-simple" target="_blank" title="https://github.com/yibiaoai/yibiao-simple" ref="nofollow noopener noreferrer">github.com/yibiaoai/yi…</a></p>
<p>Gitee： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fyibiao-ai%2Fyibiao-simple" target="_blank" title="https://gitee.com/yibiao-ai/yibiao-simple" ref="nofollow noopener noreferrer">gitee.com/yibiao-ai/y…</a></p>
<p>今天是第三期，根据生成好的提纲，填充标书内容。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c029176a80ef4a96af10c4b1c6e7cbd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MjQ2MjkzMjA2NzY3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765508759&amp;x-signature=XKaVIeY7WYL%2BDCDQbm1fGgF5xSY%3D" alt="" loading="lazy"/></p>
<p>正文生成，并不像上一节讲的提纲生成那么复杂，核心难点只有两个：</p>
<ul>
<li><strong>标书需求字数太多：</strong> 一份标书动辄几万几十万字，直接让AI生成必然行不通。有了上一节生成提纲的经验，我们已经知道答案了，那就是把正文也打碎，让AI按照提纲的叶子节点，逐节生成正文。</li>
<li><strong>上下文不连贯，或内容重复：</strong> 这就引出了我们第二个难点，分布生成，多部分内容之间不连贯是肯定的，可以更大的问题是，都是基于一份招标文件生成的技术方案，很可能生成意思过于相近的内容，俗称车轱辘话。
下面，咱们就来逐项分析一下，如何解决上述难点。</li>
</ul>
<h2 data-id="heading-0">一、获取生成内容所需信息</h2>
<p>从前端拆分提纲，提纲的每一个叶子节点都发起一个生成请求，需要传递以下参数</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ChapterContentRequest</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""单章节内容生成请求"""</span>
    chapter: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] = Field(..., description=<span class="hljs-string">"章节信息"</span>)
    parent_chapters: <span class="hljs-type">Optional</span>[<span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]] = Field(<span class="hljs-literal">None</span>, description=<span class="hljs-string">"上级章节列表"</span>)
    sibling_chapters: <span class="hljs-type">Optional</span>[<span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]] = Field(<span class="hljs-literal">None</span>, description=<span class="hljs-string">"同级章节列表"</span>)
    project_overview: <span class="hljs-built_in">str</span> = Field(<span class="hljs-string">""</span>, description=<span class="hljs-string">"项目概述"</span>)
</code></pre>
<ul>
<li><strong>chapter：</strong> 本章节信息，不多说，这是必须的</li>
</ul>

<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"3.2.2"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"技术实力"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"技术研发能力和创新情况"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><strong>parent_chapters：</strong> 上级章节列表，为了保持连贯性</li>
<li><strong>sibling_chapters：</strong> 同级章节列表，为了生成内容不重复</li>
<li><strong>project_overview：</strong> 项目概述，这是核心，让AI知道自己要写的标书的核心需求</li>
</ul>
<h2 data-id="heading-1">二、核心提示词</h2>
<p><strong>SystemPrompt</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">你是一个专业的标书编写专家，负责为投标文件的技术标部分生成具体内容。

要求：
<span class="hljs-bullet">1.</span> 内容要专业、准确，与章节标题和描述保持一致
<span class="hljs-bullet">2.</span> 这是技术方案，不是宣传报告，注意朴实无华，不要假大空
<span class="hljs-bullet">3.</span> 语言要正式、规范，符合标书写作要求，但不要使用奇怪的连接词，不要让人觉得内容像是AI生成的
<span class="hljs-bullet">4.</span> 内容要详细具体，避免空泛的描述
<span class="hljs-bullet">5.</span> 注意避免与同级章节内容重复，保持内容的独特性和互补性
<span class="hljs-bullet">6.</span> 直接返回章节内容，不生成标题，不要任何额外说明或格式标记
</code></pre>
<p><strong>UserPrompt</strong>
这个就需要拼接一下了</p>
<pre><code class="hljs language-markdown" lang="markdown">项目概述信息：
{project<span class="hljs-emphasis">_overview}

请为以下标书章节生成具体内容：

{context_</span>info if context<span class="hljs-emphasis">_info else ''}

当前章节信息：
章节ID: {chapter_</span>id}
章节标题: {chapter<span class="hljs-emphasis">_title}
章节描述: {chapter_</span>description}

请根据项目概述信息和上述章节层级关系，生成详细的专业内容，确保与上级章节的内容逻辑相承，同时避免与同级章节内容重复，突出本章节的独特性和技术方案的优势。
</code></pre>
<p>context_info是拼接的上级、统计节点信息</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 构建上下文信息</span>
context_info = <span class="hljs-string">""</span>

<span class="hljs-comment"># 上级章节信息</span>
<span class="hljs-keyword">if</span> parent_chapters:
    context_info += <span class="hljs-string">"上级章节信息：\n"</span>
    <span class="hljs-keyword">for</span> parent <span class="hljs-keyword">in</span> parent_chapters:
        context_info += <span class="hljs-string">f"- <span class="hljs-subst">{parent[<span class="hljs-string">'id'</span>]}</span> <span class="hljs-subst">{parent[<span class="hljs-string">'title'</span>]}</span>\n  <span class="hljs-subst">{parent[<span class="hljs-string">'description'</span>]}</span>\n"</span>

<span class="hljs-comment"># 同级章节信息（排除当前章节）</span>
<span class="hljs-keyword">if</span> sibling_chapters:
    context_info += <span class="hljs-string">"同级章节信息（请避免内容重复）：\n"</span>
    <span class="hljs-keyword">for</span> sibling <span class="hljs-keyword">in</span> sibling_chapters:
        <span class="hljs-keyword">if</span> sibling.get(<span class="hljs-string">'id'</span>) != chapter_id:  <span class="hljs-comment"># 排除当前章节</span>
            context_info += <span class="hljs-string">f"- <span class="hljs-subst">{sibling.get(<span class="hljs-string">'id'</span>, <span class="hljs-string">'unknown'</span>)}</span> <span class="hljs-subst">{sibling.get(<span class="hljs-string">'title'</span>, <span class="hljs-string">'未命名'</span>)}</span>\n  <span class="hljs-subst">{sibling.get(<span class="hljs-string">'description'</span>, <span class="hljs-string">''</span>)}</span>\n"</span>

</code></pre>
<p>拼接后的完整user_prompt示例</p>
<blockquote>
<p>请为以下标书章节生成具体内容：
上级章节信息：</p>
<ul>
<li>1 投标文件技术要求响应程度
对项目技术要求的响应和符合情况</li>
<li>1.1 技术规格响应
详细描述投标产品技术参数与招标技术要求的符合性</li>
</ul>
<p>同级章节信息（请避免内容重复）：</p>
<ul>
<li>1.1.2 技术文件完整性
提供的技术文件是否齐全、规范
当前章节信息：
章节ID: 1.1.1
章节标题: 灯具规格符合性
章节描述: 逐项说明各灯具规格与招标文件要求的匹配情况</li>
</ul>
<p>请根据项目概述信息和上述章节层级关系，生成详细的专业内容，确保与上级章节的内容逻辑相承，同时避免与同级章节内容重复，突出本章节的独特性和技术方案的优势。</p>
</blockquote>
<p>就这么简单，生成正文不需要过多的逻辑推理，用最普通的大模型即可实现稳定输出，也几乎不存在生成失败的问题~</p>
<h2 data-id="heading-2">完整代码已开源</h2>
<p>Github： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fyibiaoai%2Fyibiao-simple" target="_blank" title="https://github.com/yibiaoai/yibiao-simple" ref="nofollow noopener noreferrer">github.com/yibiaoai/yi…</a></p>
<p>Gitee： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fyibiao-ai%2Fyibiao-simple" target="_blank" title="https://gitee.com/yibiao-ai/yibiao-simple" ref="nofollow noopener noreferrer">gitee.com/yibiao-ai/y…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kubernetes 节点 DNS 解析异常问题排查与解决方案]]></title>    <link>https://juejin.cn/post/7579872561675960329</link>    <guid>https://juejin.cn/post/7579872561675960329</guid>    <pubDate>2025-12-05T03:07:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579872561675960329" data-draft-id="7579872561675796489" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kubernetes 节点 DNS 解析异常问题排查与解决方案"/> <meta itemprop="keywords" content="后端,Kubernetes"/> <meta itemprop="datePublished" content="2025-12-05T03:07:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="壹米饭"/> <meta itemprop="url" content="https://juejin.cn/user/4178616274387758"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kubernetes 节点 DNS 解析异常问题排查与解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4178616274387758/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    壹米饭
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:07:51.000Z" title="Fri Dec 05 2025 03:07:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>因为 NodeLocal DNSCache 未加载更新后的节点 resolv.conf 导致 Pod 无法解析外部域名</strong></p>
<hr/>
<h2 data-id="heading-0">一、问题现象</h2>
<p>在 Kubernetes 集群中，部署的应用 Pod 在调度到 <strong>worker4 节点</strong>时可以正常访问外部服务 <code>qyapi.weixin.qq.com</code>，但当调度到 <strong>worker3 节点</strong>时，Java 应用抛出如下异常：</p>
<pre><code class="hljs language-csharp" lang="csharp">Caused <span class="hljs-keyword">by</span>: java.net.UnknownHostException: qyapi.weixin.qq.com
</code></pre>
<p>经初步排查：</p>
<ul>
<li>worker3 节点本身可通过 <code>ping qyapi.weixin.qq.com</code> 正常解析并连通；</li>
<li>worker4 节点无此问题；</li>
<li>两节点操作系统及网络环境基本一致。</li>
</ul>
<hr/>
<h2 data-id="heading-1">二、根因分析</h2>
<h3 data-id="heading-2">1. 集群启用了 NodeLocal DNSCache</h3>
<p>通过检查发现，集群部署了 <strong>NodeLocal DNSCache</strong>（DaemonSet，标签 <code>k8s-app=nodelocaldns</code>），用于优化 Pod 的 DNS 查询性能。其工作原理如下：</p>
<ul>
<li>每个节点运行一个本地 CoreDNS 实例，监听 IP（通常为 <code>169.254.20.10</code>）；</li>
<li>Pod 的 <code>/etc/resolv.conf</code> 中 <code>nameserver</code> 被设置为此本地地址；</li>
<li>NodeLocal DNSCache 将集群内部域名请求转发给 CoreDNS，外部域名请求则转发给<strong>节点 <code>/etc/resolv.conf</code> 中配置的上游 DNS 服务器</strong>。</li>
</ul>
<h3 data-id="heading-3">2. NodeLocal DNSCache 仅在启动时读取 <code>/etc/resolv.conf</code></h3>
<ul>
<li>NodeLocal DNSCache Pod <strong>在启动时读取所在节点的 <code>/etc/resolv.conf</code></strong>，获取上游 DNS 配置；</li>
<li><strong>不会动态监听或重新加载该文件的后续变更</strong>；</li>
<li>若节点的 DNS 配置发生变化（如修复错误配置），必须<strong>重启 NodeLocal DNSCache Pod</strong> 才能生效。</li>
</ul>
<h3 data-id="heading-4">3. 问题发生过程</h3>
<ol>
<li>worker3 节点初始的 <code>/etc/resolv.conf</code> 配置有误（如 nameserver 不可达）；</li>
<li>NodeLocal DNSCache Pod 启动时加载了错误的上游 DNS 配置；</li>
<li>即使后续手动修正了 worker3 的 <code>/etc/resolv.conf</code>，NodeLocal DNSCache 仍使用旧配置；</li>
<li>导致调度到 worker3 的 Pod 无法解析外部域名，而节点自身（直接使用 <code>/etc/resolv.conf</code>）可正常解析。</li>
</ol>
<hr/>
<h2 data-id="heading-5">三、解决方案</h2>
<h3 data-id="heading-6">✅ 步骤 1：确保节点 DNS 配置正确</h3>
<p>将 worker3 的 <code>/etc/resolv.conf</code> 修改为与正常节点（如 worker4）一致，例如：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 注意这里，修改为与正常节点（如 worker4）一致</span>
nameserver <span class="hljs-number">114.114</span><span class="hljs-number">.114</span><span class="hljs-number">.114</span>

</code></pre>
<blockquote>
<p>💡 建议通过系统级网络管理工具（如 NetworkManager、systemd-resolved）进行持久化配置，避免被 DHCP 或云平台覆盖。</p>
</blockquote>
<h3 data-id="heading-7">✅ 步骤 2：重启 NodeLocal DNSCache Pod</h3>
<p>强制重建 worker3 上的 NodeLocal DNSCache 实例，使其加载最新的 <code>/etc/resolv.conf</code>：</p>
<pre><code class="hljs language-ini" lang="ini">kubectl delete pods -n kube-system -l <span class="hljs-attr">k8s-app</span>=nodelocaldns
</code></pre>
<p>Kubernetes DaemonSet 控制器会自动在所有节点（包括 worker3）上创建新的 Pod。</p>
<h3 data-id="heading-8">✅ 步骤 3：验证修复结果</h3>
<p>在 worker3 上部署测试 Pod，验证外部域名解析：</p>
<pre><code class="hljs language-ini" lang="ini">kubectl run debug <span class="hljs-attr">--image</span>=busybox:<span class="hljs-number">1.28</span> --rm -it --restart=Never \
  <span class="hljs-attr">--overrides</span>=<span class="hljs-string">'{"spec":{"nodeSelector":{"kubernetes.io/hostname":"worker3"}}}'</span> \
  -- nslookup qyapi.weixin.qq.com
</code></pre>
<p>预期输出应包含有效的 IP 地址，无超时或错误。</p>
<hr/>
<h2 data-id="heading-9">四、经验总结与建议</h2>

























<table><thead><tr><th>项目</th><th>说明</th></tr></thead><tbody><tr><td><strong>关键认知</strong></td><td>NodeLocal DNSCache <strong>不会动态重载</strong> <code>/etc/resolv.conf</code>，修改后必须重启 Pod</td></tr><tr><td><strong>运维规范</strong></td><td>修改节点 DNS 配置后，应同步执行 <code>kubectl delete pod -n kube-system -l k8s-app=nodelocaldns</code></td></tr><tr><td><strong>配置持久化</strong></td><td>避免直接编辑 <code>/etc/resolv.conf</code>，推荐使用系统网络管理工具或云平台配置</td></tr><tr><td><strong>监控建议</strong></td><td>可通过 Prometheus + CoreDNS 指标监控 DNS 解析失败率，提前发现类似问题</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-10">五、附录：相关组件说明</h2>
<h3 data-id="heading-11">NodeLocal DNSCache 架构简图</h3>
<pre><code class="hljs language-scss" lang="scss">Pod (nameserver: <span class="hljs-number">169.254</span>.<span class="hljs-number">20.10</span>)
        ↓
NodeLocal DNSCache (本地 CoreDNS, 运行于每个节点)
        ↓
上游 DNS（来自节点 /etc/resolv<span class="hljs-selector-class">.conf</span>）
        ↓
公网/内网 DNS 服务器
</code></pre>
<h3 data-id="heading-12">查看 NodeLocal DNSCache 配置</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 查看 ConfigMap</span>
kubectl <span class="hljs-keyword">get</span> cm nodelocaldns -n kube-system -o yaml

<span class="hljs-meta"># 查看 Pod 状态</span>
kubectl <span class="hljs-keyword">get</span> pods -n kube-system -l k8s-app=nodelocaldns -o wide
</code></pre>
<hr/>
<p><strong>记录人</strong>：壹米饭
<strong>记录时间</strong>：2025年12月5日<br/>
<strong>适用环境</strong>：启用 NodeLocal DNSCache 的 Kubernetes 集群（v1.18+）</p>
<blockquote>
<p>📌 <strong>一句话总结</strong>：改了节点 DNS 配置？别忘了重启 nodelocaldns！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[函数组件 useEffect 清理函数抛错：ErrorBoundary 能捕获吗？]]></title>    <link>https://juejin.cn/post/7579961957221007387</link>    <guid>https://juejin.cn/post/7579961957221007387</guid>    <pubDate>2025-12-05T03:09:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579961957221007387" data-draft-id="7579917791764660251" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="函数组件 useEffect 清理函数抛错：ErrorBoundary 能捕获吗？"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-12-05T03:09:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xiechao"/> <meta itemprop="url" content="https://juejin.cn/user/377887728340302"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            函数组件 useEffect 清理函数抛错：ErrorBoundary 能捕获吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/377887728340302/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xiechao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:09:23.000Z" title="Fri Dec 05 2025 03:09:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">函数组件 useEffect 清理函数抛错：ErrorBoundary 能捕获吗？</h2>
<p>在函数组件中，useEffect 的返回方法（通常称为 “清理函数”）承担着类似类组件 componentWillUnmount 的职责，比如取消定时器、清除订阅、终止未完成的接口请求等。最近有开发者问：“如果在这个清理函数里不小心抛出了错误，ErrorBoundary 能捕获到吗？” 这个问题恰好卡在 ErrorBoundary 的 “能力边界” 上，我们结合之前讲过的限制来拆解分析。</p>
<h4 data-id="heading-1">先给结论：清理函数中的错误，ErrorBoundary 无法捕获</h4>
<p>要理解原因，得先回顾两个关键前提：</p>
<ol>
<li>ErrorBoundary 仅能捕获 <strong>子组件渲染、生命周期（类组件）、构造函数中的同步错误</strong>；</li>
</ol>

<ol start="2">
<li>useEffect 清理函数的执行时机，是在组件卸载时或依赖项更新导致 effect 重新执行前 —— 这个时机<strong>脱离了组件的 “渲染流程”</strong> ，属于 “组件销毁 / 更新后的收尾操作”，和我们之前讲的 “异步操作错误”“事件处理错误” 本质上是同一类：不在 ErrorBoundary 的监控范围内。</li>
</ol>
<h4 data-id="heading-2">用实例验证：清理函数抛错会直接崩溃</h4>
<p>我们写一段代码来模拟这个场景：在 useEffect 清理函数中故意抛出错误，看看 ErrorBoundary 是否生效。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 先定义基础的 ErrorBoundary 组件（复用之前的逻辑）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorBoundary</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">React.Component</span> {
  state = { <span class="hljs-attr">hasError</span>: <span class="hljs-literal">false</span> };
  <span class="hljs-keyword">static</span> <span class="hljs-title function_">getDerivedStateFromError</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">hasError</span>: <span class="hljs-literal">true</span> };
  }
  <span class="hljs-title function_">componentDidCatch</span>(<span class="hljs-params">error</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'ErrorBoundary 捕获到错误：'</span>, error);
  }
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span>.<span class="hljs-property">hasError</span>) <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>页面出错了，但被捕获了~<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>;
  }
}
<span class="hljs-comment">// 2. 函数组件：在 useEffect 清理函数中抛错</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">CleanupErrorComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// effect 执行逻辑（空）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 组件卸载时执行的清理函数，故意抛错</span>
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'useEffect 清理函数出错了！'</span>);
    };
  }, []);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>我是一个会在卸载时抛错的组件<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
<span class="hljs-comment">// 3. 父组件：用 ErrorBoundary 包裹目标组件，并加卸载触发按钮</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">ParentComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [showChild, setShowChild] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">true</span>);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setShowChild(false)}&gt;卸载子组件<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ErrorBoundary</span>&gt;</span>
        {showChild &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">CleanupErrorComponent</span> /&gt;</span>}
      <span class="hljs-tag">&lt;/<span class="hljs-name">ErrorBoundary</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>当点击 “卸载子组件” 时，CleanupErrorComponent 触发清理函数并抛错 —— 此时控制台会打印红色错误，但 ErrorBoundary 没有渲染 “页面出错了，但被捕获了～” 的备用 UI，反而可能导致页面功能异常（比如按钮点击无响应）。</p>
<p>这就证明了：<strong>useEffect 清理函数中的错误，完全绕过了 ErrorBoundary 的捕获机制</strong>。</p>
<h4 data-id="heading-3">为什么会这样？从 React 执行流程看本质</h4>
<p>React 处理 useEffect 清理函数的逻辑，属于 “commit 阶段” 后的收尾操作：</p>
<ol>
<li>当组件需要卸载时，React 先完成 “DOM 移除”“状态更新” 等核心渲染流程；</li>
</ol>

<ol start="2">
<li>核心流程结束后，才会异步执行 useEffect 的清理函数；</li>
</ol>

<ol start="3">
<li>此时 ErrorBoundary 对该组件的 “渲染监控” 已经结束 —— 毕竟组件都从 DOM 树上移除了，ErrorBoundary 自然无法感知后续的错误。</li>
</ol>
<p>简单说：ErrorBoundary 只 “盯着” 组件 “活着” 时的渲染相关操作，组件 “死了” 之后（卸载后）的清理函数抛错，它管不着。</p>
<h4 data-id="heading-4">解决方案：手动用 try/catch 包裹清理函数</h4>
<p>既然 ErrorBoundary 不管用，那该如何处理清理函数中的错误？答案和处理 “事件处理错误”“异步错误” 一致 ——<strong>主动用 try/catch 捕获</strong>。</p>
<p>修改后的清理函数代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 用 try/catch 包裹所有可能抛错的逻辑</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 比如：取消接口请求、清除定时器等可能出错的操作</span>
      <span class="hljs-keyword">const</span> invalidJson = <span class="hljs-string">'这不是合法的JSON'</span>;
      <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(invalidJson); <span class="hljs-comment">// 这里会抛错</span>
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-comment">// 错误处理：打印日志、上报监控平台，避免崩溃</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'useEffect 清理函数出错（已捕获）：'</span>, error);
      <span class="hljs-comment">// 可选：如果需要用户感知，可以通过状态提示（但注意组件已卸载，需谨慎）</span>
      <span class="hljs-comment">// 比如：用一个全局状态管理错误提示，而非组件自身状态</span>
    }
  };
}, []);
</code></pre>
<p>这里有个注意点：清理函数中不要更新组件自身的状态（比如 setState），因为组件此时已卸载，更新状态会触发 “内存泄漏警告”。如果需要告知用户错误，可以用全局状态（如 Redux、Context）管理错误提示，在其他未卸载的组件（如顶部通知栏）中显示。</p>
<h4 data-id="heading-5">延伸：类似场景的错误处理原则</h4>
<p>除了 useEffect 清理函数，以下场景的错误也需要手动用 try/catch 处理，而非依赖 ErrorBoundary：</p>
<ul>
<li>useLayoutEffect 的清理函数（执行时机虽早于 useEffect，但同样不在渲染流程内）；</li>
</ul>

<ul>
<li>自定义 Hook 中的清理逻辑（如 useRequest 中的请求取消函数）；</li>
</ul>

<ul>
<li>组件卸载时执行的其他回调（如第三方库的销毁方法）。</li>
</ul>
<h4 data-id="heading-6">总结</h4>
<p>useEffect 返回的清理函数，虽然承担着类组件 componentWillUnmount 的职责，但它的执行时机和错误性质，决定了 ErrorBoundary 无法捕获其中的错误。处理这类错误的核心原则是：<strong>主动预判风险，用 try/catch 包裹所有可能抛错的逻辑</strong>，再配合日志上报和用户提示，才能避免应用崩溃，同时保障用户体验。</p>
<p>记住：ErrorBoundary 是 “渲染流程的守护者”，而非 “所有错误的万能药”—— 在函数组件的副作用清理中，手动捕获错误才是更可靠的方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uni-app 使用 uview-plus]]></title>    <link>https://juejin.cn/post/7579893536105791494</link>    <guid>https://juejin.cn/post/7579893536105791494</guid>    <pubDate>2025-12-05T03:11:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579893536105791494" data-draft-id="7579846685071851574" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uni-app 使用 uview-plus"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-05T03:11:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一壶纱"/> <meta itemprop="url" content="https://juejin.cn/user/897635786437944"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uni-app 使用 uview-plus
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/897635786437944/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一壶纱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:11:51.000Z" title="Fri Dec 05 2025 03:11:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>uview-plus</code> 是一个基于 <code>uni-app</code> 的高质量 UI 组件库，提供了丰富的组件和工具函数，帮助开发者快速构建跨平台应用。</p>
<h2 data-id="heading-0">1. 安装 uview-plus</h2>
<p>在项目中安装 <code>uview-plus</code>：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm add uview-plus
</code></pre>
<h2 data-id="heading-1">2. 使用 easycom 方式引入组件</h2>
<p>在本项目中，<code>uview-plus</code> 是通过 <code>easycom</code> 的方式按需引入组件的。以下是具体使用方法：</p>
<h3 data-id="heading-2">2.1 配置组件路径</h3>
<p>在 <code>pages.json</code> 中配置 <code>easycom</code> 规则：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"easycom"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"autoscan"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"custom"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"^u-(.*)"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"uview-plus/components/u-$1/u-$1.vue"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"^up-(.*)"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"uview-plus/components/u-$1/u-$1.vue"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>说明：</strong></p>
<ul>
<li><code>autoscan</code>: 设置为 <code>true</code>，自动扫描 <code>node_modules/uview-plus/components</code> 目录下的组件。</li>
<li><code>custom</code>: 自定义组件匹配规则，<code>^u-(.*)</code> 和 <code>^up-(.*)</code> 表示以 <code>u-</code> 或 <code>up-</code> 开头的组件名会匹配到 <code>uview-plus</code> 的对应组件路径。</li>
</ul>
<h3 data-id="heading-3">2.2 使用组件</h3>
<p>配置完成后，可以直接在页面中使用 <code>uview-plus</code> 的组件，无需手动引入。例如：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;view&gt;
    &lt;u-button type="primary"&gt;主要按钮&lt;/u-button&gt;
    &lt;up-button type="success"&gt;成功按钮&lt;/up-button&gt;
  &lt;/view&gt;
&lt;/template&gt;
</code></pre>
<h2 data-id="heading-4">3. 自定义主题</h2>
<p><code>uview-plus</code> 支持通过 SCSS 变量自定义主题。以下是推荐的自定义主题方案：</p>
<h3 data-id="heading-5">3.1 创建自定义主题文件</h3>
<p>在项目的 <code>src/styles</code> 目录下新建一个 <code>uview-plus.theme.scss</code> 文件，并将 <code>node_modules/uview-plus/theme.scss</code> 中的所有变量复制到该文件中。例如：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-variable">$u-primary</span>: <span class="hljs-number">#007aff</span>; <span class="hljs-comment">// 修改主色</span>
<span class="hljs-variable">$u-success</span>: <span class="hljs-number">#4cd964</span>; <span class="hljs-comment">// 修改成功色</span>
<span class="hljs-variable">$u-warning</span>: <span class="hljs-number">#f0ad4e</span>; <span class="hljs-comment">// 修改警告色</span>
<span class="hljs-variable">$u-error</span>: <span class="hljs-number">#dd524d</span>; <span class="hljs-comment">// 修改错误色</span>
<span class="hljs-comment">// 其他变量...</span>
</code></pre>
<p>根据需求修改这些变量的值，以实现自定义主题。</p>
<h3 data-id="heading-6">3.2 引入自定义主题文件</h3>
<p>在 <code>src/uni.scss</code> 文件的顶部引入自定义主题文件：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@import</span> <span class="hljs-string">'@/styles/uview-plus.theme.scss'</span>;
</code></pre>
<p>通过这种方式，<code>uview-plus</code> 的组件将使用自定义的主题变量。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大数据-174 Elasticsearch 查询 DSL 实战：match/match_phrase/query_string/multi_match 全解析]]></title>    <link>https://juejin.cn/post/7579917791764807707</link>    <guid>https://juejin.cn/post/7579917791764807707</guid>    <pubDate>2025-12-05T03:17:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579917791764807707" data-draft-id="7579961957221023771" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大数据-174 Elasticsearch 查询 DSL 实战：match/match_phrase/query_string/multi_match 全解析"/> <meta itemprop="keywords" content="后端,大数据,Elasticsearch"/> <meta itemprop="datePublished" content="2025-12-05T03:17:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="武子康"/> <meta itemprop="url" content="https://juejin.cn/user/149189314230039"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大数据-174 Elasticsearch 查询 DSL 实战：match/match_phrase/query_string/multi_match 全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/149189314230039/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    武子康
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-05T03:17:25.000Z" title="Fri Dec 05 2025 03:17:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">TL;DR</h2>
<ul>
<li>场景：在 Elasticsearch 7.3 中用查询 DSL 做全文检索，而不是靠 Kibana 点选和简单关键字搜索。</li>
<li>结论：区分 match、match_phrase、query_string、multi_match 的匹配边界和分词语义，是中文搜索是否“搜得到”的关键。</li>
<li>产出：一套可直接复制的 DSL 示例与排错思路，覆盖中文分词、逻辑查询、多字段匹配和常见“查不到数据”的问题定位。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67f123ad8a594f3ab926af631d9d62b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=B66cYktM0dUDNTg0%2Bk5hh04ko8g%3D" alt="大数据-174 Elasticsearch 查询 DSL 实战：match/match_phrase/query_string/multi_match 全解析" loading="lazy"/></p>
<h2 data-id="heading-1">版本矩阵</h2>

















<table><thead><tr><th>Elasticsearch 版本</th><th>已验证说明</th></tr></thead><tbody><tr><td>7.3</td><td>是全文示例基于 7.3 官方 DSL 文档与实际集群验证，语法与截图一一对应。</td></tr><tr><td>7.4–7.17</td><td>部分查询 DSL 语法整体兼容，match、match_phrase、query_string、multi_match 用法基本一致，个别参数以官方文档为准。</td></tr></tbody></table>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce294769cd5d4439b97113ef70fbbcb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=kuuWar5DB7Hz2jlpdOG77dlqGJk%3D" alt="Elasticsearch" loading="lazy"/></p>
<h2 data-id="heading-2">官方地址</h2>
<pre><code class="hljs language-shell" lang="shell">https://www.elastic.co/guide/en/elasticsearch/reference/7.3/query-dsl.html
</code></pre>
<p>Elasticsearch提供了基于JSON的完整查询DSL（Domain Specific Language 特定域语言）来定义查询，将查询 DSL 视为查询AST（抽象语法树），它由两种子句组成：</p>
<ul>
<li>叶子查询句 叶子查询子句 在特定域中寻找特定的值，如 match、term、range 查询</li>
<li>复合查询子句 复合查询子句包装其他叶子查询或复合查询，并用于以逻辑方式组合多个查询（例如 bool或dis_max查询），或更改其行为（如 constant_score 查询）
我们在使用Elasticsearch的时候，避免不使用DSL语句去查询，就像使用关系型数据库的时候要学会使用SQL一样。</li>
</ul>
<h2 data-id="heading-3">查询所有</h2>
<p>示例</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">查询所有数据</span>
POST /wzkicu-index/_search
{
  "query":{
    "match_all": {}
  }
}
</code></pre>
<ul>
<li>query 代表查询的对象</li>
<li>match_all 代表查询所有</li>
</ul>
<p>执行后，结果如下：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6671f5047784bce8a8eff8ce1acef49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=m%2FxxerogvGZh5zsQ8w02iXot%2FAU%3D" alt="Elasticsearch 查询语法" loading="lazy"/>
结果中：</p>
<ul>
<li>took 查询花费时间，单位是毫秒</li>
<li>time_out 是否超时</li>
<li>_shards 分片信息</li>
<li>hits 搜索结果总览对象</li>
<li>total 搜索到的总数</li>
<li>max_score 所有结果中文档得分的最高分</li>
<li>_index 索引库</li>
<li>_type 文档类型</li>
<li>_id 文档id</li>
<li>_score 文档得分</li>
<li>_source 文档的数据源</li>
</ul>
<h2 data-id="heading-4">全文检索（full-text query）</h2>
<p>全文搜索能够搜索已分析的文本字段，如电子邮件正文、商品描述，使用索引期间应用于字段的同一分词处理查询字符串，全文搜索的分类很多，有如下的这么几种。</p>
<h3 data-id="heading-5">匹配搜索（match query）</h3>
<p>全文查询的标准查询，查询条件比较宽松：</p>
<ul>
<li>需要指定字段名</li>
<li>输入文本会进行分词，比如hello world，会拆分成 hello 和 world，然后进行匹配，如果字段内容中包含hello或者world，name就会被查询出来。也就是说match是一个部分匹配的模糊查询。</li>
</ul>
<p>match queries 接收 text/numerics/dates，对它们进行分词分析，再组织成一个boolean查询，可通过operator指定bool组合操作（or、and、默认是or）。</p>
<p>假设一个案例，目前索引库中，有两部手机，一台电视：
先新增索引库：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">创建索引</span>
PUT /wzk-property
{
  "settings": {},
  "mappings": {
    "properties": {
      "title": {
        "type": "text",
        "analyzer": "ik_max_word"
      },
      "images": {
        "type": "keyword"
      },
      "price": {
        "type": "float"
      }
    }
  }
}
</code></pre>
<p>执行的结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53e4c8a09db54d3cbbd83148af634b84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=E9OsHRS0h%2FGMrlCBgq6nTcdf1QI%3D" alt="Elasticsearch 分词" loading="lazy"/>
接着我们写入一些数据进去：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">添加数据1</span>
POST /wzk-property/_doc/
{
  "title": "小米电视4A",
  "images": "https://profile-avatar.csdnimg.cn/755ff10be62f4e7081bc36028fa9eafe_w776341482.jpg!1",
  "price": 4288
}
<span class="hljs-meta prompt_">
# </span><span class="bash">添加数据2</span>
POST /wzk-property/_doc/
{
  "title": "小米手机",
  "images": "https://profile-avatar.csdnimg.cn/755ff10be62f4e7081bc36028fa9eafe_w776341482.jpg!1",
  "price": 2699
}
<span class="hljs-meta prompt_">
# </span><span class="bash">添加数据3</span>
POST /wzk-property/_doc/
{
  "title": "华为手机",
  "images": "https://profile-avatar.csdnimg.cn/755ff10be62f4e7081bc36028fa9eafe_w776341482.jpg!1",
  "price": 5699
}

</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8e62e75d3dd4325aadeb717ac85e3f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=Vd%2BQCg2V2ek%2BjI%2BZt89vXGLXh%2Bc%3D" alt="Elasticsearch 添加数据" loading="lazy"/>
我们进行or关系的match搜索，会把查询条件进行分词，然后进行查询，多个词条之间是or的关系：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">match 分词匹配</span>
POST /wzk-property/_search
{
  "query":{
    "match":{
      "title":"小米电视4A"
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ead348e025844c282790987fac61c7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=IdSvEIebWmZHsUefA1GA846YSUI%3D" alt="Elasticsearch 匹配查询" loading="lazy"/>
我们可以看到，不仅查到了小米电视、还查询到了小米手机。这不是我们要的结果。此时我们需要使用 and 的方式来进行精确的查找：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">match 分词匹配 title字段 同时 分词后的每个词 都要匹配到才可以（and）</span>
POST /wzk-property/_search
{"query":
  {
    "match": {
      "title":
      {
        "query": "小米电视4A",
        "operator": "and"
      }
    }
  }
}
</code></pre>
<p>执行结果如下，可以看到已经精准匹配到了：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb174886256b473c8c2de36e96ffe61b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=6IcgOkYqgo%2F%2F8iAyyj3UwMRKrpw%3D" alt="Elasticsearch 精确匹配" loading="lazy"/></p>
<h3 data-id="heading-6">短语搜索（match phrase query）</h3>
<p>match_query是分词的，text也是分词的，match_phrase的分词结果必须在text字段中都包含，而且顺序必须相同，而且必须是连续的：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">分词匹配但考虑顺序</span>
<span class="hljs-meta prompt_"># </span><span class="bash">match是不考虑分词出现的顺序</span>
<span class="hljs-meta prompt_"># </span><span class="bash">match_phrase 将遵循分词的出现顺序才进行匹配</span>
POST /wzk-property/_search
{
  "query": {
    "match_phrase": {
      "title": "小米电视"
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1677f2caa9ff45c6923b909a7002a90a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=FoB50mVBH1P5pUfrecnOq1IP7rc%3D" alt="Elasticsearch 短语搜索" loading="lazy"/></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">match_phrase 分伺后：1电视 2小米</span>
<span class="hljs-meta prompt_"># </span><span class="bash">因为条目中 小米电视的出现不是 1、2，所以没有匹配到</span>
POST /wzk-property/_search
{
  "query": {
    "match_phrase": {
      "title": "电视小米"
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0342630862694425970d054a43400807~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=5n%2FkvCNQFpU1nw3rvxXPeMlGUM4%3D" alt="Elasticsearch 分词检索" loading="lazy"/></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">match_phrase 分词 1是小米 2是4A</span>
<span class="hljs-meta prompt_"># </span><span class="bash">但是由于 原：小米电视4A，对比中没有严格按照1、2的顺序</span>
<span class="hljs-meta prompt_"># </span><span class="bash">所以没有结果</span>
POST /wzk-property/_search
{
  "query": {
    "match_phrase": {
      "title": "小米4A"
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/520e6cff3b074129b28e8c611e167312~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=ACwzt5jX2Kszyxgb3yOv3Gokj80%3D" alt="Elasticsearch 分词检索" loading="lazy"/>
但是对于刚才的结果，可能我们希望使用  小米4A，可以按照 match_phrase 的顺序来查找到 小米电视4A，而不用严格遵守顺序，可以跳过几个词：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">通过 slop 可以跳过一个词 来让 match_phrase 匹配到顺序的结果</span>
POST /wzk-property/_search
{
  "query": {
    "match_phrase": {
      "title": {
        "query": "小米4A",
        "slop": 1
      }
    }
  }
}
</code></pre>
<h3 data-id="heading-7">query_string 查询</h3>
<p>该查询与match类似，但是match需要指定字段名，query_string是在所有字段中搜索，范围更广泛。
Query String Query提供了无需指定某字段而对文档全文进行匹配查询的一个高级查询，同时可以指定在哪些字段上进行匹配。</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">广泛查询 所有字段中查找 2699</span>
POST /wzk-property/_search
{
  "query": {
    "query_string": {
      "query": "2699"
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2983d5a471634275947a29a92171c65f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=XrQfm7kOX3cWDmEuUB2UjwL9mZM%3D" alt="Elasticsearch query string" loading="lazy"/></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">广泛查找 但是你希望从这个default_field字段中查找</span>
POST /wzk-property/_search
{
  "query": {
    "query_string": {
      "query": "2699",
      "default_field": "title"
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8660078aa59c4da78c3a58e0e49687c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=FA1BIylTjULSZVpirRXf8n%2FAMPY%3D" alt="Elasticsearch match phrase" loading="lazy"/></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">逻辑查询 使用 OR 或者 AND</span>
POST /wzk-property/_search
{
  "query": {
    "query_string": {
      "query": "手机 OR 小米",
      "default_field": "title"
    }
  }
}
</code></pre>
<p>执行结果下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78192c1b709c412b8d5f359fa5ec5de1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=P0jdZdEy0MdvGU6DiVdKDHZOlTs%3D" alt="Elasticsearch 查询数据" loading="lazy"/></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">逻辑查询 使用 OR 或者 AND</span>
POST /wzk-property/_search
{
  "query": {
    "query_string": {
      "query": "手机 AND 小米",
      "default_field": "title"
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d898d32254154fdf92d709fcbe6f7d2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=6CZk%2FMDczIua%2F8Uh4b7posbrUxI%3D" alt="Elasticsearch 逻辑查询" loading="lazy"/></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">模糊查询，表示 小米 这个词可以有1个词变动</span>
<span class="hljs-meta prompt_"># </span><span class="bash">比如：小明、米小 都是可以查询出来的</span>
POST /wzk-property/_search
{
  "query": {
    "query_string": {
      "query": "小米~1",
      "default_field": "title"
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afb0afa7494f45d984654e355f01ba7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=3pvVWHu6ZJ3E%2Fgck%2BrioJJ%2B3NTw%3D" alt="Elasticsearch 查询结果" loading="lazy"/></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">模糊查询，表示 小米 这个词可以有1个词变动</span>
<span class="hljs-meta prompt_"># </span><span class="bash">比如：小明、米小 都是可以查询出来的</span>
<span class="hljs-meta prompt_"># </span><span class="bash">以此类推，如果是 小米~2 那就两个词都可以变动...</span>
POST /wzk-property/_search
{
  "query": {
    "query_string": {
      "query": "米小~1",
      "default_field": "title"
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/43ae7969ed614f55ab7310ae8c02d67f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=jN%2Bc5J%2Bu3Jv0fVSklrpiHRoh8fo%3D" alt="Elasticsearch 查询" loading="lazy"/></p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">多字段支持</span>
POST /lagou-property/_search
{
  "query": {
    "query_string" : {
      "query":"2699",
      "fields": [ "title","price"]
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cca1973dc5b8497ca1c0f928cf019d4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=RbrK1UiUPj5%2BJs2VQtIz3I2CPT4%3D" alt="Elasticsearch 查询结果" loading="lazy"/></p>
<h3 data-id="heading-8">多字段匹配查询（multi match query）</h3>
<p>如果你需要在多个字段上进行文本搜索，可用multi_match，multi_match在match的基础上支持对多个字段进行文本查询。</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">multi_match 是 match查询的一种扩展方式，用于在多个字段上进行查询</span>
POST /wzk-property/_search
{
  "query": {
    "multi_match" : {
      "query":"小米4A",
      "fields": [ "title","images"]
    }
  }
}
</code></pre>
<p>执行结果如下图所示：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1dc0771c871c4adcaefa9db9047c02b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5q2m5a2Q5bq3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765509445&amp;x-signature=8j4yZq6DHAYibfYsbwesCLmWjs8%3D" alt="Elasticsearch 多字段匹配" loading="lazy"/></p>
<h2 data-id="heading-9">错误速查</h2>















































<table><thead><tr><th>症状</th><th>根因</th><th>定位</th><th>修复</th></tr></thead><tbody><tr><td>用 match 查询“小米电视4A”，结果把“小米手机”也查出来</td><td>match 默认 operator=OR，中文分词后任意一个词命中即算匹配</td><td>在 Kibana 中使用 _analyze 查看 title 分词结果，确认分词粒度</td><td>在 match 中显式设置 "operator": "and"，或改用 keyword/精确匹配字段承载商品名</td></tr><tr><td>match_phrase 查不到预期文档（如“电视小米”“小米4A”均无结果）</td><td>match_phrase 要求分词顺序与位置连续，默认不允许跳词</td><td>用 _analyze 查看短语分词顺序，对比 _source.title 的实际分词顺序</td><td>使用 "slop": N 放宽位置约束，或改写查询短语与文案保持一致</td></tr><tr><td>query_string 报解析错误或查不到数据</td><td>query_string 语法较复杂，逻辑运算符、特殊字符未转义，或 default_field 不含目标内容</td><td>查看 Kibana 报错信息，逐步简化 query 字符串，只保留单词验证</td><td>避免直接透传用户输入，必要时对 `+ - &amp;&amp;</td></tr><tr><td>使用 query_string 模糊查询“小米~1”但结果过多或过少</td><td>模糊匹配基于编辑距离，且受 analyzer 影响，并非“看起来相似就一定命中”</td><td>对同一单词分别用 _analyze 和 query_string 测试，观察实际命中词条</td><td>明确业务接受的模糊程度，合理设置 ~1/~2，必要时改为前缀/通配符或拼音索引等更明确方案</td></tr><tr><td>multi_match 跨字段查询命中不符合预期</td><td>多字段中字段类型和分词方式不同，score 被某个字段主导，导致排序或命中偏移</td><td>查看 mapping 中各字段的 type/analyzer，并用单字段 match 对比效果</td><td>在 multi_match 中显式配置 fields 权重（如 "title^3"），或统一文本字段的 analyzer，避免 keyword 与 text 混用产生误解</td></tr><tr><td>match_all 能查到文档，但任一全文查询都查不到</td><td>字段被映射为 keyword 或未被索引，全文查询打在错误字段上</td><td>用 mapping 接口确认字段 type 及 index 属性，检查查询 JSON 中的字段名拼写</td><td>将字段改为 text 或设置合适的多字段（text + keyword），并校正 DSL 中的字段名，重建索引后再次验证</td></tr></tbody></table>
<h2 data-id="heading-10">其他系列</h2>
<h3 data-id="heading-11">🚀 AI篇持续更新中（长期更新）</h3>
<p><strong>AI炼丹日志-29 - 字节跳动 DeerFlow 深度研究框<em>斜体样式</em>架 私有部署 测试上手 架构研究</strong>，持续打造实用AI工具指南！
<strong>AI研究-132 Java 生态前沿 2025：Spring、Quarkus、GraalVM、CRaC 与云原生落地</strong></p>
<h3 data-id="heading-12">💻 Java篇持续更新中（长期更新）</h3>
<p><strong>Java-180 Java 接入 FastDFS：自编译客户端与 Maven/Spring Boot 实战</strong>
MyBatis 已完结，Spring 已完结，Nginx已完结，Tomcat已完结，分布式服务已完结，Dubbo已完结，MySQL已完结，MongoDB已完结，Neo4j已完结，FastDFS 已完结，OSS正在更新... 深入浅出助你打牢基础！</p>
<h3 data-id="heading-13">📊 大数据板块已完成多项干货更新（300篇）：</h3>
<p>包括 Hadoop、Hive、Kafka、Flink、ClickHouse、Elasticsearch 等二十余项核心组件，覆盖离线+实时数仓全栈！
<strong>大数据-278 Spark MLib - 基础介绍 机器学习算法 梯度提升树 GBDT案例 详解</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>