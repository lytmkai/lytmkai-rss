<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[Spring Boot + JPackage：构建独立安装包]]></title>    <link>https://juejin.cn/post/7600284420633952297</link>    <guid>https://juejin.cn/post/7600284420633952297</guid>    <pubDate>2026-01-28T23:58:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600284420633952297" data-draft-id="7600296037542428672" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Spring Boot + JPackage：构建独立安装包"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-28T23:58:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风象南"/> <meta itemprop="url" content="https://juejin.cn/user/2524134428655159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Spring Boot + JPackage：构建独立安装包
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134428655159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风象南
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-28T23:58:11.000Z" title="Wed Jan 28 2026 23:58:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    46
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>从 JDK 14 开始，Java 官方引入了 <strong>JPackage</strong> 工具（在 JDK 16 正式成为标准功能），它能够将 Java 应用打包成特定平台的原生安装包，<strong>自带定制化的 JRE 运行环境</strong>。这意味着用户无需提前安装 Java 环境，双击安装包即可完成应用部署，极大地简化了交付流程。</p>
<p>本文将介绍如何使用 JPackage 工具将 Spring Boot 项目打包成 Windows、macOS 或 Linux 平台的原生安装包。</p>
<h2 data-id="heading-1">一、JPackage 简介</h2>
<h4 data-id="heading-2">1.1 什么是 JPackage</h4>
<p>JPackage 是 JDK 自带的打包工具，位于 <code>$JAVA_HOME/bin</code> 目录下。它的核心功能是：</p>
<p><strong>生成平台原生安装包</strong>：Windows 的 <code>.exe</code>/<code>.msi</code>、macOS 的 <code>.dmg</code>/<code>.pkg</code>、Linux 的 <code>.deb</code>/<code>.rpm</code></p>
<p><strong>自定义 JRE</strong>：使用 <code>jlink</code> 工具裁剪 JDK，仅打包应用所需的模块，大幅减小安装包体积</p>
<p><strong>简化部署</strong>：用户无需预装 Java 环境，安装包自带运行时</p>
<h4 data-id="heading-3">1.2 JPackage 的优势</h4>

























<table><thead><tr><th>传统部署方式</th><th>JPackage 方式</th></tr></thead><tbody><tr><td>需要预装 JRE/JDK</td><td>自带 JRE，无需额外安装</td></tr><tr><td>环境版本可能不匹配</td><td>绑定特定 JRE 版本，环境一致</td></tr><tr><td>手动编写启动脚本</td><td>自动生成启动器</td></tr><tr><td>跨平台需要多套脚本</td><td>一键生成各平台安装包</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-4">二、环境准备</h2>
<h4 data-id="heading-5">2.1 JDK 版本要求</h4>
<p><strong>推荐使用 JDK 17 或更高版本</strong>（JPackage 在 JDK 16 才成为标准功能，JDK 17 是 LTS 版本）</p>
<p>确认 JPackage 可用：</p>
<pre><code class="hljs language-bash" lang="bash">jpackage --version
</code></pre>
<h4 data-id="heading-6">2.2 平台特定工具</h4>
<p>根据目标操作系统，需要安装对应的打包工具：</p>
<h5 data-id="heading-7">Windows</h5>
<p><strong>WiX Toolset 3.11+</strong>（用于生成 <code>.msi</code> 安装包）<br/>
下载地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwixtoolset.org%2F" target="_blank" title="https://wixtoolset.org/" ref="nofollow noopener noreferrer">wixtoolset.org/</a><br/>
安装后将 <code>bin</code> 目录添加到系统环境变量 <code>PATH</code></p>
<h5 data-id="heading-8">macOS</h5>
<p>Xcode 命令行工具（用于生成 <code>.dmg</code>/<code>.pkg</code>）</p>
<pre><code class="hljs language-bash" lang="bash">xcode-select --install
</code></pre>
<h5 data-id="heading-9">Linux</h5>
<p><strong>Debian/Ubuntu</strong>：安装 <code>fakeroot</code></p>
<pre><code class="hljs language-bash" lang="bash">sudo apt-get install fakeroot
</code></pre>
<p><strong>RedHat/CentOS</strong>：安装 <code>rpm-build</code></p>
<pre><code class="hljs language-bash" lang="bash">sudo yum install rpm-build
</code></pre>
<h2 data-id="heading-10">三、Spring Boot 项目准备</h2>
<h4 data-id="heading-11">3.1 示例项目结构</h4>
<p>假设我们有一个标准的 Spring Boot 项目：</p>
<pre><code class="hljs language-css" lang="css">my-springboot-app/
├── <span class="hljs-attribute">src</span>/
│   └── <span class="hljs-selector-tag">main</span>/
│       ├── java/
│       └── resources/
├── pom<span class="hljs-selector-class">.xml</span>
└── target/
    └── my-app-<span class="hljs-number">1.0</span>.<span class="hljs-number">0</span><span class="hljs-selector-class">.jar</span>
</code></pre>
<h4 data-id="heading-12">3.2 构建可执行 JAR</h4>
<p>首先使用 Maven 或 Gradle 构建项目：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Maven</span>
mvn clean package

<span class="hljs-comment"># Gradle</span>
gradle clean build
</code></pre>
<p>确保生成的 JAR 包是可执行的（Spring Boot 默认打包方式）。</p>
<h2 data-id="heading-13">四、使用 JPackage 打包</h2>
<h4 data-id="heading-14">4.1 基础打包命令</h4>
<p>以下是一个基础的 JPackage 命令示例（以 Windows 为例）：</p>
<pre><code class="hljs language-bash" lang="bash">jpackage \
  --input target \
  --name MySpringBootApp \
  --main-jar my-app-1.0.0.jar \
  --main-class org.springframework.boot.loader.JarLauncher \
  --<span class="hljs-built_in">type</span> msi \
  --app-version 1.0.0 \
  --vendor <span class="hljs-string">"我的公司"</span> \
  --description <span class="hljs-string">"基于 Spring Boot 的企业级应用"</span> \
  --icon src/main/resources/app-icon.ico \
  --win-dir-chooser \
  --win-menu \
  --win-shortcut
</code></pre>
<h5 data-id="heading-15">参数说明</h5>

















































<table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>--input</code></td><td>输入目录，包含 JAR 包和依赖</td></tr><tr><td><code>--name</code></td><td>应用名称</td></tr><tr><td><code>--main-jar</code></td><td>主 JAR 包文件名</td></tr><tr><td><code>--main-class</code></td><td>主类（Spring Boot 使用 <code>JarLauncher</code>）</td></tr><tr><td><code>--type</code></td><td>安装包类型（<code>msi</code>/<code>exe</code>/<code>dmg</code>/<code>pkg</code>/<code>deb</code>/<code>rpm</code>）</td></tr><tr><td><code>--app-version</code></td><td>应用版本号</td></tr><tr><td><code>--icon</code></td><td>应用图标（Windows 用 <code>.ico</code>，macOS 用 <code>.icns</code>）</td></tr><tr><td><code>--win-dir-chooser</code></td><td>允许用户选择安装目录</td></tr><tr><td><code>--win-menu</code></td><td>创建开始菜单项</td></tr><tr><td><code>--win-shortcut</code></td><td>创建桌面快捷方式</td></tr></tbody></table>
<h4 data-id="heading-16">4.2 自定义 JRE（使用 jlink）</h4>
<p>为了减小安装包体积，可以使用 <code>jlink</code> 裁剪 JRE，仅包含必要的模块。</p>
<h5 data-id="heading-17">步骤 1：查找应用依赖的模块</h5>
<pre><code class="hljs language-bash" lang="bash">jdeps --list-deps target/my-app-1.0.0.jar
</code></pre>
<p>输出示例：</p>
<pre><code class="hljs language-csharp" lang="csharp">java.<span class="hljs-keyword">base</span>
java.logging
java.sql
java.naming
java.desktop
...
</code></pre>
<h5 data-id="heading-18">步骤 2：使用 jlink 创建自定义 JRE</h5>
<pre><code class="hljs language-bash" lang="bash">jlink \
  --add-modules java.base,java.logging,java.sql,java.naming,java.desktop,java.xml,java.management \
  --output custom-jre \
  --strip-debug \
  --no-header-files \
  --no-man-pages \
  --compress=2
</code></pre>
<h5 data-id="heading-19">步骤 3：使用自定义 JRE 打包</h5>
<pre><code class="hljs language-bash" lang="bash">jpackage \
  --input target \
  --name MySpringBootApp \
  --main-jar my-app-1.0.0.jar \
  --main-class org.springframework.boot.loader.JarLauncher \
  --<span class="hljs-built_in">type</span> msi \
  --runtime-image custom-jre \
  --app-version 1.0.0 \
  --vendor <span class="hljs-string">"我的公司"</span>
</code></pre>
<blockquote>
<p><strong>注意</strong>：Spring Boot 应用通常依赖较多模块，建议先不裁剪 JRE，确保功能正常后再优化。</p>
</blockquote>
<hr/>
<h2 data-id="heading-20">五、不同平台的打包示例</h2>
<h4 data-id="heading-21">5.1 Windows 平台（MSI）</h4>
<pre><code class="hljs language-bash" lang="bash">jpackage \
  --input target \
  --name MyApp \
  --main-jar my-app-1.0.0.jar \
  --main-class org.springframework.boot.loader.JarLauncher \
  --<span class="hljs-built_in">type</span> msi \
  --app-version 1.0.0 \
  --icon src/main/resources/app.ico \
  --win-dir-chooser \
  --win-menu \
  --win-shortcut \
  --win-menu-group <span class="hljs-string">"我的应用"</span>
</code></pre>
<h4 data-id="heading-22">5.2 macOS 平台（DMG）</h4>
<pre><code class="hljs language-bash" lang="bash">jpackage \
  --input target \
  --name MyApp \
  --main-jar my-app-1.0.0.jar \
  --main-class org.springframework.boot.loader.JarLauncher \
  --<span class="hljs-built_in">type</span> dmg \
  --app-version 1.0.0 \
  --icon src/main/resources/app.icns \
  --mac-package-name <span class="hljs-string">"com.mycompany.myapp"</span> \
  --mac-package-identifier <span class="hljs-string">"com.mycompany.myapp"</span>
</code></pre>
<h4 data-id="heading-23">5.3 Linux 平台（DEB）</h4>
<pre><code class="hljs language-bash" lang="bash">jpackage \
  --input target \
  --name myapp \
  --main-jar my-app-1.0.0.jar \
  --main-class org.springframework.boot.loader.JarLauncher \
  --<span class="hljs-built_in">type</span> deb \
  --app-version 1.0.0 \
  --icon src/main/resources/app.png \
  --linux-shortcut \
  --linux-menu-group <span class="hljs-string">"Development"</span>
</code></pre>
<hr/>
<h2 data-id="heading-24">六、集成到 Maven 构建流程</h2>
<p>为了自动化打包流程，可以将 JPackage 命令集成到 Maven 的 <code>pom.xml</code> 中。</p>
<h4 data-id="heading-25">6.1 使用 exec-maven-plugin</h4>
<p>在 <code>pom.xml</code> 中添加以下插件配置：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- Spring Boot Maven 插件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>

        <span class="hljs-comment">&lt;!-- JPackage 打包插件 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.codehaus.mojo<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>exec-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>jpackage<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">phase</span>&gt;</span>package<span class="hljs-tag">&lt;/<span class="hljs-name">phase</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>exec<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">executable</span>&gt;</span>jpackage<span class="hljs-tag">&lt;/<span class="hljs-name">executable</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">arguments</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--input<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>target<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--name<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>MySpringBootApp<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--main-jar<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>${project.build.finalName}.jar<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--main-class<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>org.springframework.boot.loader.JarLauncher<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--type<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>msi<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--app-version<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>${project.version}<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--vendor<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>我的公司<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--win-dir-chooser<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--win-menu<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">argument</span>&gt;</span>--win-shortcut<span class="hljs-tag">&lt;/<span class="hljs-name">argument</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">arguments</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>
</code></pre>
<h4 data-id="heading-26">6.2 执行构建</h4>
<pre><code class="hljs language-bash" lang="bash">mvn clean package
</code></pre>
<p>构建完成后，安装包将生成在项目根目录下。</p>
<h2 data-id="heading-27">七、总结</h2>
<p>JPackage 工具为 Java 应用的分发提供了强大的支持，从简单的命令行操作到集成到自动化构建流程，JPackage 都能很好地满足需求。</p>
<p>在实际项目中，建议根据应用特点选择合适的打包策略，平衡安装包体积、部署便利性和运行性能，为用户提供最佳的使用体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java SPI机制：从原理到实战]]></title>    <link>https://juejin.cn/post/7600316828485009423</link>    <guid>https://juejin.cn/post/7600316828485009423</guid>    <pubDate>2026-01-29T01:15:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600316828485009423" data-draft-id="7600265780349321256" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java SPI机制：从原理到实战"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-29T01:15:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java SPI机制：从原理到实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T01:15:53.000Z" title="Thu Jan 29 2026 01:15:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Java SPI机制：从原理到实战</h2>
<h2 data-id="heading-1">一、什么是SPI机制</h2>
<p>SPI（Service Provider Interface），服务提供者接口，是Java提供的一种服务发现机制。它允许第三方服务提供商为核心库或接口提供实现，而不需要修改核心代码。</p>
<h3 data-id="heading-2">1.1 为什么需要SPI？</h3>
<p>在实际开发中，我们经常遇到这样的场景：定义了一个接口，但具体实现由不同厂商或不同场景提供。例如：</p>
<ul>
<li><strong>JDBC驱动</strong>：不同数据库（MySQL、Oracle、PostgreSQL）提供不同的驱动实现</li>
<li><strong>日志框架</strong>：SLF4J定义接口，Logback、Log4j2提供实现</li>
</ul>
<p>传统做法是通过硬编码或配置文件指定实现类，这样存在以下问题：</p>
<ul>
<li>代码耦合度高，切换实现需要修改代码</li>
<li>无法动态扩展</li>
<li>不符合"开闭原则"</li>
</ul>
<p>SPI机制通过约定配置文件的方式，实现了服务的动态发现和加载。</p>
<h3 data-id="heading-3">1.2 SPI vs API</h3>






























<table><thead><tr><th>特性</th><th>API（Application Programming Interface）</th><th>SPI（Service Provider Interface）</th></tr></thead><tbody><tr><td>调用方向</td><td>应用 → 框架/库</td><td>框架/库 → 服务提供者</td></tr><tr><td>定义者</td><td>框架/库定义</td><td>框架/库定义</td></tr><tr><td>实现者</td><td>应用实现</td><td>第三方提供者实现</td></tr><tr><td>使用场景</td><td>应用使用框架功能</td><td>框架调用扩展实现</td></tr></tbody></table>
<p>简单理解：<strong>API是给应用用的，SPI是给框架扩展用的。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/000af4c89a2549ab8b83413a24d2aed9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770254152&amp;x-signature=nqnUqV981Eyrc%2FDxAqLEm93fqdI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">二、Java SPI核心原理</h2>
<h3 data-id="heading-5">2.1 核心类</h3>
<p>Java SPI主要依赖<code>java.util.ServiceLoader</code>类，位于JDK核心库中。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceLoader</span>&lt;<span class="hljs-title class_">S</span>&gt; <span class="hljs-title class_">implements</span> <span class="hljs-title class_">Iterable</span>&lt;<span class="hljs-title class_">S</span>&gt; {
    <span class="hljs-comment">// 服务接口的Class对象</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Class</span>&lt;<span class="hljs-type">S</span>&gt; service;

    <span class="hljs-comment">// 类加载器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ClassLoader</span> loader;

    <span class="hljs-comment">// 已加载的服务提供者缓存</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">LinkedHashMap</span>&lt;<span class="hljs-type">String</span>,<span class="hljs-type">S</span>&gt; providers <span class="hljs-operator">=</span> new <span class="hljs-type">LinkedHashMap</span>&lt;&gt;();

    <span class="hljs-comment">// 懒加载查找迭代器</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">LazyIterator</span> lookupIterator;

    <span class="hljs-comment">// 通过类加载器和接口类型加载服务</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-operator">&lt;</span><span class="hljs-type">S</span><span class="hljs-operator">&gt;</span> <span class="hljs-type">ServiceLoader</span>&lt;<span class="hljs-type">S</span>&gt; load(<span class="hljs-type">Class</span>&lt;<span class="hljs-type">S</span>&gt; service) {
        <span class="hljs-type">ClassLoader</span> cl <span class="hljs-operator">=</span> <span class="hljs-type">Thread</span>.currentThread().getContextClassLoader();
        <span class="hljs-keyword">return</span> <span class="hljs-type">ServiceLoader</span>.load(service, cl);
    }

    <span class="hljs-comment">// 通过指定类加载器加载服务</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-operator">&lt;</span><span class="hljs-type">S</span><span class="hljs-operator">&gt;</span> <span class="hljs-type">ServiceLoader</span>&lt;<span class="hljs-type">S</span>&gt; load(<span class="hljs-type">Class</span>&lt;<span class="hljs-type">S</span>&gt; service, <span class="hljs-type">ClassLoader</span> loader) {
        <span class="hljs-keyword">return</span> new <span class="hljs-type">ServiceLoader</span>&lt;&gt;(service, loader);
    }
}
</code></pre>
<h3 data-id="heading-6">2.2 约定配置文件</h3>
<p>SPI机制通过约定配置文件来发现服务实现。配置文件位置必须为：</p>
<pre><code class="hljs language-bash" lang="bash">META-INF/services/
└── com.example.spi.SomeService  <span class="hljs-comment"># 文件名为接口的全限定名</span>
</code></pre>
<p>文件内容为实现类的全限定名，每行一个：</p>
<pre><code class="hljs language-rust" lang="rust">com.example.spi.<span class="hljs-keyword">impl</span>.SomeServiceImpl
com.example.spi.<span class="hljs-keyword">impl</span>.AnotherServiceImpl
</code></pre>
<h3 data-id="heading-7">2.3 服务加载流程</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c29e3110cda049fa93ef8d6f73b14d3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770254152&amp;x-signature=aq7j06Y1xtYG00%2F8HbS4V8sKI8A%3D" alt="" loading="lazy"/></p>
<p>服务加载流程如下：</p>
<ol>
<li><strong>查找配置文件</strong>：ServiceLoader在classpath下查找<code>META-INF/services/接口全限定名</code>文件</li>
<li><strong>解析配置文件</strong>：读取文件内容，获取所有实现类的全限定名</li>
<li><strong>类加载</strong>：使用类加载器加载实现类</li>
<li><strong>实例化</strong>：通过反射创建实现类实例</li>
<li><strong>类型转换</strong>：将实例转换为接口类型</li>
<li><strong>缓存结果</strong>：将实例缓存到providers Map中</li>
</ol>
<h2 data-id="heading-8">三、Java SPI使用示例</h2>
<p>让我们通过一个完整的示例来演示Java SPI的使用。</p>
<h3 data-id="heading-9">3.1 定义接口</h3>
<p>首先定义一个数据库操作接口：</p>
<pre><code class="hljs language-arduino" lang="arduino">package com.example.spi;

<span class="hljs-comment">/**
 * 数据库操作接口
 */</span>
<span class="hljs-keyword">public</span> interface DatabaseOperation {

    <span class="hljs-comment">/**
     * 执行查询
     * @param sql SQL语句
     * @return 查询结果
     */</span>
    <span class="hljs-function"><span class="hljs-type">String</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-type">String</span> sql)</span></span>;

    <span class="hljs-comment">/**
     * 获取数据库类型
     * @return 数据库类型名称
     */</span>
    <span class="hljs-function"><span class="hljs-type">String</span> <span class="hljs-title">getDatabaseType</span><span class="hljs-params">()</span></span>;

    <span class="hljs-comment">/**
     * 获取版本信息
     * @return 版本号
     */</span>
    <span class="hljs-function"><span class="hljs-type">String</span> <span class="hljs-title">getVersion</span><span class="hljs-params">()</span></span>;
}
</code></pre>
<h3 data-id="heading-10">3.2 实现MySQL操作</h3>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">example</span>.<span class="hljs-property">spi</span>.<span class="hljs-property">impl</span>;

<span class="hljs-keyword">import</span> com.<span class="hljs-property">example</span>.<span class="hljs-property">spi</span>.<span class="hljs-property">DatabaseOperation</span>;

<span class="hljs-comment">/**
 * MySQL数据库操作实现
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MySQLDatabaseOperation</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DatabaseOperation</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">query</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> sql</span>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"[MySQL] 执行SQL: "</span> + sql);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"MySQL查询结果集"</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getDatabaseType</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"MySQL"</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getVersion</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"8.0.32"</span>;
    }
}
</code></pre>
<h3 data-id="heading-11">3.3 实现Oracle操作</h3>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">example</span>.<span class="hljs-property">spi</span>.<span class="hljs-property">impl</span>;

<span class="hljs-keyword">import</span> com.<span class="hljs-property">example</span>.<span class="hljs-property">spi</span>.<span class="hljs-property">DatabaseOperation</span>;

<span class="hljs-comment">/**
 * Oracle数据库操作实现
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OracleDatabaseOperation</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DatabaseOperation</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">query</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> sql</span>) {
        <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"[Oracle] 执行SQL: "</span> + sql);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Oracle查询结果集"</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getDatabaseType</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Oracle"</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getVersion</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"19c"</span>;
    }
}
</code></pre>
<h3 data-id="heading-12">3.4 配置SPI文件</h3>
<p>在<code>src/main/resources/META-INF/services/</code>目录下创建配置文件：</p>
<p><strong>文件名</strong>：<code>com.example.spi.DatabaseOperation</code></p>
<p><strong>文件内容</strong>：</p>
<pre><code class="hljs language-rust" lang="rust">com.example.spi.<span class="hljs-keyword">impl</span>.MySQLDatabaseOperation
com.example.spi.<span class="hljs-keyword">impl</span>.OracleDatabaseOperation
</code></pre>
<h3 data-id="heading-13">3.5 使用ServiceLoader加载服务</h3>
<pre><code class="hljs language-csharp" lang="csharp">package com.example.spi;

import java.util.ServiceLoader;

<span class="hljs-comment">/**
 * SPI服务加载器
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SPIDemo</span> {

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"=== Java SPI 机制演示 ===\n"</span>);

        <span class="hljs-comment">// 加载所有DatabaseOperation实现</span>
        ServiceLoader&lt;DatabaseOperation&gt; loader = ServiceLoader.load(DatabaseOperation.<span class="hljs-keyword">class</span>);

        <span class="hljs-comment">// 遍历所有实现</span>
        <span class="hljs-keyword">for</span> (DatabaseOperation operation : loader) {
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"发现数据库实现: "</span> + operation.getClass().getSimpleName());
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"数据库类型: "</span> + operation.getDatabaseType());
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"版本信息: "</span> + operation.getVersion());
            String result = operation.query(<span class="hljs-string">"SELECT * FROM users"</span>);
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"查询结果: "</span> + result);
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"----------------------"</span>);
        }

        <span class="hljs-comment">// 再次遍历，验证缓存机制</span>
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"\n=== 第二次遍历（从缓存读取）==="</span>);
        <span class="hljs-keyword">for</span> (DatabaseOperation operation : loader) {
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"缓存中的实现: "</span> + operation.getClass().getSimpleName());
        }
    }
}
</code></pre>
<h2 data-id="heading-14">四、SPI在JDBC驱动中的应用</h2>
<p>JDBC是Java SPI机制的典型应用场景。让我们深入分析JDBC如何通过SPI加载驱动。</p>
<h3 data-id="heading-15">4.1 传统驱动加载方式</h3>
<p>在JDBC 4.0之前，需要显式加载驱动：</p>
<pre><code class="hljs language-ini" lang="ini">// 显式加载驱动
Class.forName("com.mysql.cj.jdbc.Driver")<span class="hljs-comment">;</span>
Connection <span class="hljs-attr">conn</span> = DriverManager.getConnection(url, user, password)<span class="hljs-comment">;</span>
</code></pre>
<p>这种方式存在以下问题：</p>
<ul>
<li>需要硬编码驱动类名</li>
<li>代码与具体驱动耦合</li>
<li>切换数据库需要修改代码</li>
</ul>
<h3 data-id="heading-16">4.2 SPI自动加载机制</h3>
<p>从JDBC 4.0开始，通过SPI机制自动发现并加载驱动。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac4a68a5d22e4dccba12d2fff32792a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770254152&amp;x-signature=ntb3SvjBTPDto32qZJ7Ut4TuqZU%3D" alt="" loading="lazy"/></p>
<p><strong>驱动注册流程</strong>：</p>
<ol>
<li>MySQL驱动jar包中的SPI配置文件</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">文件路径：META-INF/services/java.sql.Driver
com.mysql.cj.jdbc.Driver

 
</code></pre>
<ol>
<li>当DriverManager类被加载时，会触发静态初始化块：</li>
</ol>
<pre><code class="hljs language-scss" lang="scss"> public class DriverManager {
 static {
        <span class="hljs-built_in">loadInitialDrivers</span>();
        <span class="hljs-built_in">println</span>("JDBC DriverManager initialized");
    }

 private static void <span class="hljs-built_in">loadInitialDrivers</span>() {
        ServiceLoader&lt;Driver&gt; loadedDrivers = ServiceLoader<span class="hljs-selector-class">.load</span>(Driver.class);
        Iterator&lt;Driver&gt; driversIterator = loadedDrivers<span class="hljs-selector-class">.iterator</span>();

 try {
 <span class="hljs-built_in">while</span>(driversIterator.hasNext()) {
                driversIterator<span class="hljs-selector-class">.next</span>();
            }
        } <span class="hljs-built_in">catch</span>(Throwable t) {
 <span class="hljs-comment">// 处理异常</span>
        }
    }
}

 
</code></pre>
<ol>
<li>MySQL驱动实现类的静态初始化块会注册驱动：</li>
</ol>

<pre><code class="hljs language-scala" lang="scala"><span class="hljs-keyword">package</span> com.mysql.cj.jdbc;

public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Driver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">NonRegisteringDriver</span> <span class="hljs-title">implements</span> <span class="hljs-title">java</span>.<span class="hljs-title">sql</span>.<span class="hljs-title">Driver</span> </span>{
 static {
 <span class="hljs-keyword">try</span> {
            java.sql.<span class="hljs-type">DriverManager</span>.registerDriver(<span class="hljs-keyword">new</span> <span class="hljs-type">Driver</span>());
        } <span class="hljs-keyword">catch</span> (<span class="hljs-type">SQLException</span> <span class="hljs-type">E</span>) {
 <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">RuntimeException</span>(<span class="hljs-string">"Can't register driver!"</span>);
        }
    }

}
</code></pre>
<h3 data-id="heading-17">4.3 使用示例</h3>
<p>使用SPI机制后，获取数据库连接变得非常简单：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.jdbc;

<span class="hljs-keyword">import</span> java.sql.Connection;
<span class="hljs-keyword">import</span> java.sql.DriverManager;
<span class="hljs-keyword">import</span> java.sql.PreparedStatement;
<span class="hljs-keyword">import</span> java.sql.ResultSet;

<span class="hljs-comment">/**
 * JDBC SPI使用示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JdbcSPIDemo</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 无需显式加载驱动，SPI自动发现</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> <span class="hljs-string">"jdbc:mysql://localhost:3306/test"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> <span class="hljs-string">"root"</span>;
        <span class="hljs-type">String</span> <span class="hljs-variable">password</span> <span class="hljs-operator">=</span> <span class="hljs-string">"password"</span>;

        <span class="hljs-keyword">try</span> (<span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> DriverManager.getConnection(url, user, password)) {
            <span class="hljs-type">String</span> <span class="hljs-variable">sql</span> <span class="hljs-operator">=</span> <span class="hljs-string">"SELECT id, username, email FROM users WHERE status = ?"</span>;

            <span class="hljs-keyword">try</span> (<span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">pstmt</span> <span class="hljs-operator">=</span> conn.prepareStatement(sql)) {
                pstmt.setInt(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);

                <span class="hljs-keyword">try</span> (<span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> pstmt.executeQuery()) {
                    <span class="hljs-keyword">while</span> (rs.next()) {
                        System.out.println(<span class="hljs-string">"ID: "</span> + rs.getInt(<span class="hljs-string">"id"</span>));
                        System.out.println(<span class="hljs-string">"用户名: "</span> + rs.getString(<span class="hljs-string">"username"</span>));
                        System.out.println(<span class="hljs-string">"邮箱: "</span> + rs.getString(<span class="hljs-string">"email"</span>));
                    }
                }
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-18">4.4 实际生产案例</h3>
<p><strong>场景</strong>：支持多数据源动态切换</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.jdbc;

<span class="hljs-keyword">import</span> javax.sql.DataSource;
<span class="hljs-keyword">import</span> java.sql.Connection;
<span class="hljs-keyword">import</span> java.sql.SQLException;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.ServiceLoader;

<span class="hljs-comment">/**
 * 多数据源管理器
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiDataSourceManager</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, DataSource&gt; dataSourceMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MultiDataSourceManager</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 通过SPI加载所有DataSource实现</span>
        ServiceLoader&lt;DataSourceProvider&gt; providers =
            ServiceLoader.load(DataSourceProvider.class);

        <span class="hljs-keyword">for</span> (DataSourceProvider provider : providers) {
            <span class="hljs-type">DataSource</span> <span class="hljs-variable">ds</span> <span class="hljs-operator">=</span> provider.createDataSource();
            dataSourceMap.put(provider.getDataSourceName(), ds);
            System.out.println(<span class="hljs-string">"注册数据源: "</span> + provider.getDataSourceName());
        }
    }

    <span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">(String dataSourceName)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-type">DataSource</span> <span class="hljs-variable">ds</span> <span class="hljs-operator">=</span> dataSourceMap.get(dataSourceName);
        <span class="hljs-keyword">if</span> (ds == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"未找到数据源: "</span> + dataSourceName);
        }
        <span class="hljs-keyword">return</span> ds.getConnection();
    }

    <span class="hljs-comment">/**
     * 动态切换数据源执行查询
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeQuery</span><span class="hljs-params">(String dataSourceName, String sql)</span> <span class="hljs-keyword">throws</span> SQLException {
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> getConnection(dataSourceName)) {
            <span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> conn.createStatement();
                 <span class="hljs-type">var</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> stmt.executeQuery(sql)) {

                System.out.println(<span class="hljs-string">"["</span> + dataSourceName + <span class="hljs-string">"] 查询结果:"</span>);
                <span class="hljs-keyword">while</span> (rs.next()) {
                    <span class="hljs-comment">// 处理结果集</span>
                }
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-19">五、Dubbo对SPI的改进</h2>
<p>虽然Java SPI提供了服务发现机制，但存在一些不足：</p>
<ol>
<li><strong>无法按需加载</strong>：一次性加载所有实现，浪费资源</li>
<li><strong>缺少配置化</strong>：无法通过配置选择具体实现</li>
<li><strong>缺少依赖注入</strong>：实现类之间无法相互依赖</li>
<li><strong>缺少扩展点隔离</strong>：不同扩展点的实现可能冲突</li>
</ol>
<p>Dubbo实现了自己的SPI机制，解决了这些问题。</p>
<h3 data-id="heading-20">5.1 Dubbo SPI改进</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de6a6c1833794f19bd8c7157c02b2367~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770254152&amp;x-signature=vwyUBEHQrdpnT8u%2FpFcen6coxRA%3D" alt="" loading="lazy"/></p>
<p><strong>主要改进</strong>：</p>
<ol>
<li><strong>支持按需加载</strong>：只加载需要的实现</li>
<li><strong>支持依赖注入</strong>：实现类可以注入其他扩展点</li>
<li><strong>支持自适应扩展</strong>：根据运行时参数自动选择实现</li>
<li><strong>支持AOP</strong>：可以为扩展点添加包装类</li>
</ol>
<h3 data-id="heading-21">5.2 Dubbo SPI示例</h3>
<pre><code class="hljs language-ini" lang="ini">package com.example.dubbo.spi<span class="hljs-comment">;</span>

import org.apache.dubbo.common.extension.ExtensionLoader<span class="hljs-comment">;</span>

/**
 * Dubbo SPI使用示例
 */
public class DubboSPIDemo {

    public static void main(String<span class="hljs-section">[]</span> args) {
        // 获取扩展加载器
        ExtensionLoader&lt;Robot&gt; <span class="hljs-attr">loader</span> = ExtensionLoader.getExtensionLoader(Robot.class)<span class="hljs-comment">;</span>

        // 按需获取指定实现
        Robot <span class="hljs-attr">optimusPrime</span> = loader.getExtension(<span class="hljs-string">"optimusPrime"</span>)<span class="hljs-comment">;</span>
        optimusPrime.sayHello()<span class="hljs-comment">;</span>

        Robot <span class="hljs-attr">bumblebee</span> = loader.getExtension(<span class="hljs-string">"bumblebee"</span>)<span class="hljs-comment">;</span>
        bumblebee.sayHello()<span class="hljs-comment">;</span>

        // 获取自适应扩展（根据URL参数自动选择）
        Robot <span class="hljs-attr">adaptiveRobot</span> = loader.getAdaptiveExtension()<span class="hljs-comment">;</span>
        adaptiveRobot.sayHello()<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h2 data-id="heading-22">六、实际生产案例：日志框架SPI</h2>
<h3 data-id="heading-23">6.1 SLF4J + Logback实现</h3>
<p>SLF4J定义日志门面接口，Logback提供实现。</p>
<p><strong>SLF4J接口</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">package org.slf4j;

<span class="hljs-keyword">public</span> interface Logger {
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">debug</span><span class="hljs-params">(<span class="hljs-type">String</span> msg)</span></span>;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">info</span><span class="hljs-params">(<span class="hljs-type">String</span> msg)</span></span>;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">warn</span><span class="hljs-params">(<span class="hljs-type">String</span> msg)</span></span>;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">error</span><span class="hljs-params">(<span class="hljs-type">String</span> msg)</span></span>;
}
</code></pre>
<p><strong>Logback实现</strong>：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">META-INF/services/org.slf4j.spi.SLF4JServiceProvider</span>
ch.qos.logback.classic.spi.LogbackServiceProvider
</code></pre>
<p><strong>使用示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.slf4j.Logger;
<span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoggingService</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(LoggingService.class);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processOrder</span><span class="hljs-params">(Order order)</span> {
        logger.info(<span class="hljs-string">"开始处理订单: {}"</span>, order.getId());

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 业务逻辑</span>
            logger.debug(<span class="hljs-string">"订单金额: {}"</span>, order.getAmount());
        } <span class="hljs-keyword">catch</span> (Exception e) {
            logger.error(<span class="hljs-string">"处理订单失败"</span>, e);
            <span class="hljs-keyword">throw</span> e;
        }

        logger.info(<span class="hljs-string">"订单处理完成"</span>);
    }
}
</code></pre>
<h3 data-id="heading-24">6.2 实际生产案例：支付系统</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/419187ab020d4594b1d153357d3c1e39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo5Lit6aOY6I2h55qE6K6w5b-G:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770254152&amp;x-signature=DekGrbnEliD41lrHxuIZ%2Fhu%2FNWE%3D" alt="" loading="lazy"/></p>
<p><strong>场景</strong>：支持多种支付方式（支付宝、微信、银联）</p>
<p><strong>支付接口定义</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.payment.spi;

<span class="hljs-comment">/**
 * 支付服务接口
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PaymentService</span> {

    <span class="hljs-comment">/**
     * 创建支付订单
     * <span class="hljs-doctag">@param</span> request 支付请求
     * <span class="hljs-doctag">@return</span> 支付结果
     */</span>
    PaymentResult <span class="hljs-title function_">createPayment</span><span class="hljs-params">(PaymentRequest request)</span>;

    <span class="hljs-comment">/**
     * 查询支付状态
     * <span class="hljs-doctag">@param</span> paymentId 支付订单号
     * <span class="hljs-doctag">@return</span> 支付状态
     */</span>
    PaymentStatus <span class="hljs-title function_">queryStatus</span><span class="hljs-params">(String paymentId)</span>;

    <span class="hljs-comment">/**
     * 申请退款
     * <span class="hljs-doctag">@param</span> refundRequest 退款请求
     * <span class="hljs-doctag">@return</span> 退款结果
     */</span>
    RefundResult <span class="hljs-title function_">refund</span><span class="hljs-params">(RefundRequest refundRequest)</span>;

    <span class="hljs-comment">/**
     * 获取支付方式
     * <span class="hljs-doctag">@return</span> 支付方式名称
     */</span>
    String <span class="hljs-title function_">getPaymentType</span><span class="hljs-params">()</span>;
}
</code></pre>
<p><strong>支付宝实现</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">example</span>.<span class="hljs-property">payment</span>.<span class="hljs-property">impl</span>;

<span class="hljs-keyword">import</span> com.<span class="hljs-property">example</span>.<span class="hljs-property">payment</span>.<span class="hljs-property">spi</span>.*;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">alipay</span>.<span class="hljs-property">api</span>.<span class="hljs-property">AlipayClient</span>;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">alipay</span>.<span class="hljs-property">api</span>.<span class="hljs-property">DefaultAlipayClient</span>;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">alipay</span>.<span class="hljs-property">api</span>.<span class="hljs-property">request</span>.<span class="hljs-property">AlipayTradeCreateRequest</span>;
<span class="hljs-keyword">import</span> com.<span class="hljs-property">alipay</span>.<span class="hljs-property">api</span>.<span class="hljs-property">response</span>.<span class="hljs-property">AlipayTradeCreateResponse</span>;

<span class="hljs-comment">/**
 * 支付宝支付实现
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AlipayPaymentService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PaymentService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-title class_">AlipayClient</span> alipayClient;

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">AlipayPaymentService</span>() {
        <span class="hljs-comment">// 初始化支付宝客户端</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">alipayClient</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultAlipayClient</span>(
            <span class="hljs-string">"https://openapi.alipay.com/gateway.do"</span>,
            <span class="hljs-string">"APP_ID"</span>, <span class="hljs-string">"PRIVATE_KEY"</span>, <span class="hljs-string">"json"</span>, <span class="hljs-string">"UTF-8"</span>, <span class="hljs-string">"ALIPAY_PUBLIC_KEY"</span>
        );
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">PaymentResult</span> <span class="hljs-title function_">createPayment</span>(<span class="hljs-params">PaymentRequest request</span>) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-title class_">AlipayTradeCreateRequest</span> alipayRequest = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AlipayTradeCreateRequest</span>();
            alipayRequest.<span class="hljs-title function_">setBizContent</span>(<span class="hljs-title class_">String</span>.<span class="hljs-title function_">format</span>(
                <span class="hljs-string">"{"</span>out_trade_no<span class="hljs-string">":"</span>%s<span class="hljs-string">","</span>total_amount<span class="hljs-string">":"</span>%s<span class="hljs-string">","</span>subject<span class="hljs-string">":"</span>%s<span class="hljs-string">"}"</span>,
                request.<span class="hljs-title function_">getOrderNo</span>(), request.<span class="hljs-title function_">getAmount</span>(), request.<span class="hljs-title function_">getSubject</span>()
            ));

            <span class="hljs-title class_">AlipayTradeCreateResponse</span> response = alipayClient.<span class="hljs-title function_">execute</span>(alipayRequest);

            <span class="hljs-keyword">if</span> (response.<span class="hljs-title function_">isSuccess</span>()) {
                <span class="hljs-keyword">return</span> <span class="hljs-title class_">PaymentResult</span>.<span class="hljs-title function_">success</span>(response.<span class="hljs-title function_">getTradeNo</span>());
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-title class_">PaymentResult</span>.<span class="hljs-title function_">fail</span>(response.<span class="hljs-title function_">getSubMsg</span>());
            }
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">PaymentResult</span>.<span class="hljs-title function_">fail</span>(<span class="hljs-string">"支付异常: "</span> + e.<span class="hljs-title function_">getMessage</span>());
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">PaymentStatus</span> <span class="hljs-title function_">queryStatus</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> paymentId</span>) {
        <span class="hljs-comment">// 查询支付状态实现</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">PaymentStatus</span>.<span class="hljs-property">PAID</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">RefundResult</span> <span class="hljs-title function_">refund</span>(<span class="hljs-params">RefundRequest refundRequest</span>) {
        <span class="hljs-comment">// 退款实现</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">RefundResult</span>.<span class="hljs-title function_">success</span>();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getPaymentType</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"ALIPAY"</span>;
    }
}
</code></pre>
<p><strong>微信支付实现</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">example</span>.<span class="hljs-property">payment</span>.<span class="hljs-property">impl</span>;

<span class="hljs-keyword">import</span> com.<span class="hljs-property">example</span>.<span class="hljs-property">payment</span>.<span class="hljs-property">spi</span>.*;

<span class="hljs-comment">/**
 * 微信支付实现
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WechatPaymentService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">PaymentService</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">PaymentResult</span> <span class="hljs-title function_">createPayment</span>(<span class="hljs-params">PaymentRequest request</span>) {
        <span class="hljs-comment">// 微信支付统一下单实现</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">PaymentResult</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">"WX"</span> + request.<span class="hljs-title function_">getOrderNo</span>());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">PaymentStatus</span> <span class="hljs-title function_">queryStatus</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> paymentId</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">PaymentStatus</span>.<span class="hljs-property">PAID</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">RefundResult</span> <span class="hljs-title function_">refund</span>(<span class="hljs-params">RefundRequest refundRequest</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">RefundResult</span>.<span class="hljs-title function_">success</span>();
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getPaymentType</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"WECHAT"</span>;
    }
}
</code></pre>
<p><strong>支付服务工厂</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.payment;

<span class="hljs-keyword">import</span> com.example.payment.spi.PaymentService;
<span class="hljs-keyword">import</span> com.example.payment.spi.PaymentRequest;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;
<span class="hljs-keyword">import</span> java.util.ServiceLoader;

<span class="hljs-comment">/**
 * 支付服务工厂
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentServiceFactory</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Map&lt;String, PaymentService&gt; SERVICE_MAP = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-keyword">static</span> {
        <span class="hljs-comment">// 通过SPI加载所有支付实现</span>
        ServiceLoader&lt;PaymentService&gt; loader = ServiceLoader.load(PaymentService.class);
        <span class="hljs-keyword">for</span> (PaymentService service : loader) {
            SERVICE_MAP.put(service.getPaymentType(), service);
            System.out.println(<span class="hljs-string">"注册支付服务: "</span> + service.getPaymentType());
        }
    }

    <span class="hljs-comment">/**
     * 根据支付类型获取支付服务
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> PaymentService <span class="hljs-title function_">getPaymentService</span><span class="hljs-params">(String paymentType)</span> {
        <span class="hljs-type">PaymentService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> SERVICE_MAP.get(paymentType);
        <span class="hljs-keyword">if</span> (service == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">"不支持的支付方式: "</span> + paymentType);
        }
        <span class="hljs-keyword">return</span> service;
    }

    <span class="hljs-comment">/**
     * 创建支付订单
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createPayment</span><span class="hljs-params">(String paymentType, PaymentRequest request)</span> {
        <span class="hljs-type">PaymentService</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> getPaymentService(paymentType);
        System.out.println(<span class="hljs-string">"使用 "</span> + paymentType + <span class="hljs-string">" 支付..."</span>);
        <span class="hljs-type">var</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> service.createPayment(request);

        <span class="hljs-keyword">if</span> (result.isSuccess()) {
            System.out.println(<span class="hljs-string">"支付创建成功: "</span> + result.getTransactionId());
        } <span class="hljs-keyword">else</span> {
            System.out.println(<span class="hljs-string">"支付失败: "</span> + result.getErrorMessage());
        }
    }
}
</code></pre>
<p><strong>配置文件</strong>：</p>
<pre><code class="hljs language-rust" lang="rust"># META-INF/services/com.example.payment.spi.PaymentService
com.example.payment.<span class="hljs-keyword">impl</span>.AlipayPaymentService
com.example.payment.<span class="hljs-keyword">impl</span>.WechatPaymentService
</code></pre>
<p><strong>使用示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">package</span> com.example.payment;

<span class="hljs-keyword">import</span> com.example.payment.spi.PaymentRequest;
<span class="hljs-keyword">import</span> java.math.BigDecimal;

<span class="hljs-comment">/**
 * 支付系统使用示例
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PaymentSystemDemo</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 创建支付请求</span>
        <span class="hljs-type">PaymentRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PaymentRequest</span>();
        request.setOrderNo(<span class="hljs-string">"ORDER20240101001"</span>);
        request.setAmount(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"99.99"</span>));
        request.setSubject(<span class="hljs-string">"测试商品"</span>);

        <span class="hljs-comment">// 使用支付宝支付</span>
        PaymentServiceFactory.createPayment(<span class="hljs-string">"ALIPAY"</span>, request);

        <span class="hljs-comment">// 使用微信支付</span>
        PaymentServiceFactory.createPayment(<span class="hljs-string">"WECHAT"</span>, request);
    }
}
</code></pre>
<h2 data-id="heading-25">七、总结</h2>
<p>Java SPI机制是一种优雅的服务发现和扩展机制，它通过约定配置文件的方式，实现了：</p>
<ol>
<li><strong>解耦</strong>：核心框架与具体实现分离</li>
<li><strong>扩展</strong>：第三方可以轻松提供实现</li>
<li><strong>灵活</strong>：支持动态切换实现</li>
</ol>
<blockquote>
<p>掌握SPI机制，不仅能更好地理解开源框架的设计思想，还能在实际项目中实现更优雅的架构设计。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Jetpack Compose 从入门到精通（二）：核心基石 - 深入理解 Modifier 与布局系统]]></title>    <link>https://juejin.cn/post/7600342663319388201</link>    <guid>https://juejin.cn/post/7600342663319388201</guid>    <pubDate>2026-01-29T03:31:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600342663319388201" data-draft-id="7600430748780445739" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Jetpack Compose 从入门到精通（二）：核心基石 - 深入理解 Modifier 与布局系统"/> <meta itemprop="keywords" content="Android,Kotlin,JetBrains"/> <meta itemprop="datePublished" content="2026-01-29T03:31:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="邹阿涛涛涛涛涛涛涛涛"/> <meta itemprop="url" content="https://juejin.cn/user/3808364009106839"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Jetpack Compose 从入门到精通（二）：核心基石 - 深入理解 Modifier 与布局系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808364009106839/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    邹阿涛涛涛涛涛涛涛涛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T03:31:20.000Z" title="Thu Jan 29 2026 03:31:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    19
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本篇文章将从源码层面深入解析 Compose 的核心机制，帮助你真正理解 Modifier 的设计哲学、布局系统的测量流程，以及 LazyColumn 的惰性加载原理。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">前言</h2>
<p>在上一篇中，我们完成了 Compose 的入门。但如果你只停留在"会用"的层面，遇到复杂场景时就会束手无策。比如：</p>
<ul>
<li>为什么 Modifier 的调用顺序会影响最终效果？</li>
<li>LazyColumn 为什么能流畅处理上万条数据？</li>
<li>自定义 Layout 时，Constraints 到底该怎么用？</li>
<li>什么时候应该用 ConstraintLayout，什么时候用嵌套 Column/Row？</li>
</ul>
<p>本篇文章将带你<strong>深入原理层</strong>，不仅告诉你"怎么做"，更要让你理解"为什么这样做"。准备好了吗？让我们开始深度探索！</p>
<hr/>
<h2 data-id="heading-1">一、Modifier 深度解析：从设计哲学到源码实现</h2>
<h3 data-id="heading-2">1.1 为什么需要 Modifier？</h3>
<p>在传统 View 系统中，每个 View 都有一大堆属性方法：<code>setPadding()</code>、<code>setBackground()</code>、<code>setOnClickListener()</code>... 这不仅让 View 类变得臃肿，也限制了扩展性。</p>
<p>Compose 采用了完全不同的设计：<strong>将修饰能力从组件中分离出来</strong>，形成独立的 Modifier 系统。</p>
<p><strong>设计哲学</strong>：</p>
<ul>
<li><strong>单一职责</strong>：Text 只负责显示文字，修饰交给 Modifier</li>
<li><strong>可组合</strong>：通过链式调用组合各种修饰效果</li>
<li><strong>可扩展</strong>：随时可以增加新的 Modifier，无需修改组件</li>
</ul>
<h3 data-id="heading-3">1.2 Modifier 的本质：接口与链表</h3>
<p>Modifier 是一个<strong>接口</strong>，它的核心设计非常精巧：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 简化版源码</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Modifier</span> {
    <span class="hljs-comment">// 从左到右遍历所有 Element</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;R&gt;</span> <span class="hljs-title">foldIn</span><span class="hljs-params">(initial: <span class="hljs-type">R</span>, operation: (<span class="hljs-type">R</span>, <span class="hljs-type">Element</span>) -&gt; <span class="hljs-type">R</span>)</span></span>: R
    
    <span class="hljs-comment">// 从右到左遍历所有 Element</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;R&gt;</span> <span class="hljs-title">foldOut</span><span class="hljs-params">(initial: <span class="hljs-type">R</span>, operation: (<span class="hljs-type">Element</span>, <span class="hljs-type">R</span>) -&gt; <span class="hljs-type">R</span>)</span></span>: R
    
    <span class="hljs-comment">// 检查是否有满足条件的 Element</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">any</span><span class="hljs-params">(predicate: (<span class="hljs-type">Element</span>) -&gt; <span class="hljs-type">Boolean</span>)</span></span>: <span class="hljs-built_in">Boolean</span>
    
    <span class="hljs-comment">// 检查是否所有 Element 都满足条件</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">all</span><span class="hljs-params">(predicate: (<span class="hljs-type">Element</span>) -&gt; <span class="hljs-type">Boolean</span>)</span></span>: <span class="hljs-built_in">Boolean</span>
    
    <span class="hljs-comment">// 组合两个 Modifier</span>
    <span class="hljs-keyword">infix</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">then</span><span class="hljs-params">(other: <span class="hljs-type">Modifier</span>)</span></span>: Modifier
    
    <span class="hljs-comment">// 空的 Modifier 实例</span>
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> : Modifier {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;R&gt;</span> <span class="hljs-title">foldIn</span><span class="hljs-params">(initial: <span class="hljs-type">R</span>, operation: (<span class="hljs-type">R</span>, <span class="hljs-type">Element</span>) -&gt; <span class="hljs-type">R</span>)</span></span>: R = initial
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;R&gt;</span> <span class="hljs-title">foldOut</span><span class="hljs-params">(initial: <span class="hljs-type">R</span>, operation: (<span class="hljs-type">Element</span>, <span class="hljs-type">R</span>) -&gt; <span class="hljs-type">R</span>)</span></span>: R = initial
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">then</span><span class="hljs-params">(other: <span class="hljs-type">Modifier</span>)</span></span>: Modifier = other
    }
}
</code></pre>
<p><strong>关键设计</strong>：Modifier 内部使用<strong>链表结构</strong>存储所有的修饰元素。</p>
<h3 data-id="heading-4">1.3 链式调用的秘密</h3>
<p>当我们写下这样的代码时，发生了什么？</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Modifier
    .padding(<span class="hljs-number">16.</span>dp)
    .background(Color.Blue)
    .size(<span class="hljs-number">100.</span>dp)
</code></pre>
<p><strong>执行过程</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">步骤</span> <span class="hljs-attr">1:</span> <span class="hljs-string">Modifier</span> <span class="hljs-string">(空)</span> 
        <span class="hljs-string">↓</span> <span class="hljs-string">then()</span>
<span class="hljs-string">步骤</span> <span class="hljs-attr">2:</span> <span class="hljs-string">Modifier</span> <span class="hljs-string">+</span> <span class="hljs-string">PaddingModifier</span>
        <span class="hljs-string">↓</span> <span class="hljs-string">then()</span>
<span class="hljs-string">步骤</span> <span class="hljs-attr">3:</span> <span class="hljs-string">Modifier</span> <span class="hljs-string">+</span> <span class="hljs-string">PaddingModifier</span> <span class="hljs-string">+</span> <span class="hljs-string">BackgroundModifier</span>
        <span class="hljs-string">↓</span> <span class="hljs-string">then()</span>
<span class="hljs-string">步骤</span> <span class="hljs-attr">4:</span> <span class="hljs-string">Modifier</span> <span class="hljs-string">+</span> <span class="hljs-string">PaddingModifier</span> <span class="hljs-string">+</span> <span class="hljs-string">BackgroundModifier</span> <span class="hljs-string">+</span> <span class="hljs-string">SizeModifier</span>
</code></pre>
<p><strong>源码实现</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Modifier.kt</span>
<span class="hljs-keyword">infix</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">then</span><span class="hljs-params">(other: <span class="hljs-type">Modifier</span>)</span></span>: Modifier = 
    <span class="hljs-keyword">if</span> (other === Modifier) <span class="hljs-keyword">this</span> <span class="hljs-keyword">else</span> CombinedModifier(<span class="hljs-keyword">this</span>, other)

<span class="hljs-comment">// CombinedModifier 将两个 Modifier 组合在一起</span>
<span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CombinedModifier</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> outer: Modifier,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> <span class="hljs-keyword">inner</span>: Modifier
) : Modifier {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;R&gt;</span> <span class="hljs-title">foldIn</span><span class="hljs-params">(initial: <span class="hljs-type">R</span>, operation: (<span class="hljs-type">R</span>, <span class="hljs-type">Modifier</span>.<span class="hljs-type">Element</span>) -&gt; <span class="hljs-type">R</span>)</span></span>: R =
        <span class="hljs-keyword">inner</span>.foldIn(outer.foldIn(initial, operation), operation)
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;R&gt;</span> <span class="hljs-title">foldOut</span><span class="hljs-params">(initial: <span class="hljs-type">R</span>, operation: (<span class="hljs-type">Modifier</span>.<span class="hljs-type">Element</span>, <span class="hljs-type">R</span>) -&gt; <span class="hljs-type">R</span>)</span></span>: R =
        outer.foldOut(<span class="hljs-keyword">inner</span>.foldOut(initial, operation), operation)
}
</code></pre>
<p><strong>核心洞察</strong>：<code>CombinedModifier</code> 是一个<strong>二叉树结构</strong>，<code>outer</code> 指向链表头部，<code>inner</code> 指向链表尾部。</p>
<h3 data-id="heading-5">1.4 执行顺序：为什么顺序很重要？</h3>
<p>这是 Modifier 最容易让人困惑的地方。让我们通过一个例子理解：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 情况 A</span>
Modifier
    .padding(<span class="hljs-number">16.</span>dp)        <span class="hljs-comment">// 外层</span>
    .background(Color.Blue) <span class="hljs-comment">// 中间</span>
    .padding(<span class="hljs-number">8.</span>dp)         <span class="hljs-comment">// 内层</span>
    .size(<span class="hljs-number">100.</span>dp)
</code></pre>
<p><strong>视觉效果</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────┐  ← 外层 <span class="hljs-attribute">padding</span> (<span class="hljs-number">16</span>dp) - 透明区域
│                             │
│  ┌───────────────────────┐  │
│  │  蓝色背景             │  │
│  │  ┌─────────────────┐  │  │
│  │  │                 │  │  │  ← 内层 <span class="hljs-attribute">padding</span> (<span class="hljs-number">8</span>dp) - 蓝色区域内
│  │  │    <span class="hljs-number">100</span>x100      │  │  │
│  │  │     内容        │  │  │
│  │  │                 │  │  │
│  │  └─────────────────┘  │  │
│  │                       │  │
│  └───────────────────────┘  │
│                             │
└─────────────────────────────┘
</code></pre>
<p><strong>设计原则</strong>：Modifier 的执行遵循**"从外到内"**的顺序。先应用的 Modifier 在外层，后应用的在内层。</p>
<h3 data-id="heading-6">1.5 Modifier 的遍历机制</h3>
<p>Compose 需要遍历 Modifier 链表来应用各种效果。遍历有两种方式：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// foldIn: 从左到右（outer → inner）</span>
modifier.foldIn(initialValue) { acc, element -&gt;
    <span class="hljs-comment">// 处理每个 Element</span>
    acc + element
}

<span class="hljs-comment">// foldOut: 从右到左（inner → outer）</span>
modifier.foldOut(initialValue) { element, acc -&gt;
    <span class="hljs-comment">// 处理每个 Element</span>
    element + acc
}
</code></pre>
<p><strong>应用场景</strong>：</p>
<ul>
<li><strong>foldIn</strong>：测量、布局时，需要从外到内传递约束</li>
<li><strong>foldOut</strong>：绘制时，需要从内到外绘制内容</li>
</ul>
<h3 data-id="heading-7">1.6 Modifier 的分类与内部实现</h3>
<h4 data-id="heading-8">1.6.1 布局类 Modifier</h4>
<p><strong>size() 的实现原理</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// SizeModifier 简化版</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SizeModifier</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> minWidth: Dp = Dp.Unspecified,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> minHeight: Dp = Dp.Unspecified,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> maxWidth: Dp = Dp.Unspecified,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> maxHeight: Dp = Dp.Unspecified,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> enforceIncoming: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">true</span>
) : LayoutModifier {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> MeasureScope.<span class="hljs-title">measure</span><span class="hljs-params">(
        measurable: <span class="hljs-type">Measurable</span>,
        constraints: <span class="hljs-type">Constraints</span>
    )</span></span>: MeasureResult {
        <span class="hljs-comment">// 解析尺寸值</span>
        <span class="hljs-keyword">val</span> resolvedMinWidth = <span class="hljs-keyword">if</span> (minWidth != Dp.Unspecified) {
            minWidth.roundToPx()
        } <span class="hljs-keyword">else</span> {
            constraints.minWidth
        }
        
        <span class="hljs-keyword">val</span> resolvedMaxWidth = <span class="hljs-keyword">if</span> (maxWidth != Dp.Unspecified) {
            maxWidth.roundToPx()
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (enforceIncoming) constraints.maxWidth <span class="hljs-keyword">else</span> Constraints.Infinity
        }
        
        <span class="hljs-comment">// ... 高度同理</span>
        
        <span class="hljs-comment">// 创建新的约束</span>
        <span class="hljs-keyword">val</span> wrappedConstraints = Constraints(
            minWidth = resolvedMinWidth,
            maxWidth = resolvedMaxWidth,
            minHeight = resolvedMinHeight,
            maxHeight = resolvedMaxHeight
        )
        
        <span class="hljs-comment">// 测量子元素</span>
        <span class="hljs-keyword">val</span> placeable = measurable.measure(wrappedConstraints)
        
        <span class="hljs-comment">// 返回测量结果</span>
        <span class="hljs-keyword">return</span> layout(placeable.width, placeable.height) {
            placeable.placeRelative(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
        }
    }
}
</code></pre>
<p><strong>关键洞察</strong>：SizeModifier 是一个 <code>LayoutModifier</code>，它拦截了测量过程，修改了传递给子元素的 Constraints。</p>
<h4 data-id="heading-9">1.6.2 绘制类 Modifier</h4>
<p><strong>background() 的实现原理</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// BackgroundModifier 简化版</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BackgroundModifier</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> color: Color? = <span class="hljs-literal">null</span>,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> brush: Brush? = <span class="hljs-literal">null</span>,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> shape: Shape = RectangleShape,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> alpha: <span class="hljs-built_in">Float</span> = <span class="hljs-number">1.0f</span>
) : DrawModifier {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> ContentDrawScope.<span class="hljs-title">draw</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 绘制背景</span>
        <span class="hljs-keyword">if</span> (shape == RectangleShape) {
            <span class="hljs-comment">// 矩形背景</span>
            <span class="hljs-keyword">if</span> (color != <span class="hljs-literal">null</span>) {
                drawRect(color = color, alpha = alpha)
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (brush != <span class="hljs-literal">null</span>) {
                drawRect(brush = brush, alpha = alpha)
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 圆角/自定义形状背景</span>
            <span class="hljs-keyword">val</span> outline = shape.createOutline(size, layoutDirection, <span class="hljs-keyword">this</span>)
            <span class="hljs-keyword">if</span> (color != <span class="hljs-literal">null</span>) {
                drawOutline(outline, color = color, alpha = alpha)
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (brush != <span class="hljs-literal">null</span>) {
                drawOutline(outline, brush = brush, alpha = alpha)
            }
        }
        
        <span class="hljs-comment">// 绘制内容（调用 drawContent 继续链式绘制）</span>
        drawContent()
    }
}
</code></pre>
<p><strong>关键洞察</strong>：<code>DrawModifier</code> 拦截了绘制流程，先绘制背景，再通过 <code>drawContent()</code> 继续绘制后续内容和子元素。</p>
<h4 data-id="heading-10">1.6.3 交互类 Modifier</h4>
<p><strong>clickable() 的实现原理</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// clickable 的 Modifier 链</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> Modifier.<span class="hljs-title">clickable</span><span class="hljs-params">(
    enabled: <span class="hljs-type">Boolean</span> = <span class="hljs-literal">true</span>,
    onClickLabel: <span class="hljs-type">String</span>? = <span class="hljs-literal">null</span>,
    role: <span class="hljs-type">Role</span>? = <span class="hljs-literal">null</span>,
    onClick: () -&gt; <span class="hljs-type">Unit</span>
)</span></span>: Modifier = composed(
    inspectorInfo = debugInspectorInfo { ... }
) {
    <span class="hljs-keyword">val</span> interactionSource = remember { MutableInteractionSource() }
    <span class="hljs-keyword">val</span> indication = LocalIndication.current
    
    Modifier
        .clickable(
            interactionSource = interactionSource,
            indication = indication,
            enabled = enabled,
            onClickLabel = onClickLabel,
            role = role,
            onClick = onClick
        )
}
</code></pre>
<p><strong>clickable 内部 Modifier 链</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">clickable
├── focusableInNonTouchMode  (焦点管理)
├── pointerInput             (手势检测)
├── semantics                (无障碍支持)
├── indication               (涟漪效果)
└── isComposeRootInScrollableContainer (滚动容器检测)
</code></pre>
<h3 data-id="heading-11">1.7 自定义 Modifier 的完整指南</h3>
<h4 data-id="heading-12">1.7.1 简单自定义：使用 composed</h4>
<p>适用于需要访问 CompositionLocal 或 remember 状态的场景：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 自定义带阴影的圆角背景</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> Modifier.<span class="hljs-title">shadowBackground</span><span class="hljs-params">(
    color: <span class="hljs-type">Color</span>,
    cornerRadius: <span class="hljs-type">Dp</span> = <span class="hljs-number">8.</span>dp,
    shadowElevation: <span class="hljs-type">Dp</span> = <span class="hljs-number">4.</span>dp
)</span></span>: Modifier = composed {
    <span class="hljs-comment">// 可以在这里使用 remember 和 CompositionLocal</span>
    <span class="hljs-keyword">val</span> density = LocalDensity.current
    <span class="hljs-keyword">val</span> shadowPx = with(density) { shadowElevation.toPx() }
    
    remember(color, cornerRadius, shadowElevation) {
        Modifier
            .shadow(shadowElevation, RoundedCornerShape(cornerRadius))
            .background(color, RoundedCornerShape(cornerRadius))
            .padding(cornerRadius)
    }
}
</code></pre>
<h4 data-id="heading-13">1.7.2 中级自定义：实现 Modifier.NodeElement</h4>
<p>适用于需要自定义测量、布局或绘制的场景：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 自定义绘制对角线的 Modifier</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DiagonalLineElement</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> color: Color,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> strokeWidth: <span class="hljs-built_in">Float</span>
) : ModifierNodeElement&lt;DiagonalLineNode&gt;() {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">()</span></span>: DiagonalLineNode = 
        DiagonalLineNode(color, strokeWidth)
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">update</span><span class="hljs-params">(node: <span class="hljs-type">DiagonalLineNode</span>)</span></span> {
        node.color = color
        node.strokeWidth = strokeWidth
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> =
        color.hashCode() * <span class="hljs-number">31</span> + strokeWidth.hashCode()
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">equals</span><span class="hljs-params">(other: <span class="hljs-type">Any</span>?)</span></span>: <span class="hljs-built_in">Boolean</span> =
        other <span class="hljs-keyword">is</span> DiagonalLineElement &amp;&amp;
        other.color == color &amp;&amp;
        other.strokeWidth == strokeWidth
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DiagonalLineNode</span>(
    <span class="hljs-keyword">var</span> color: Color,
    <span class="hljs-keyword">var</span> strokeWidth: <span class="hljs-built_in">Float</span>
) : Modifier.Node(), DrawModifierNode {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> ContentDrawScope.<span class="hljs-title">draw</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 先绘制内容</span>
        drawContent()
        
        <span class="hljs-comment">// 再绘制对角线</span>
        drawLine(
            color = color,
            start = Offset(<span class="hljs-number">0f</span>, <span class="hljs-number">0f</span>),
            end = Offset(size.width, size.height),
            strokeWidth = strokeWidth
        )
    }
}

<span class="hljs-comment">// 使用扩展函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> Modifier.<span class="hljs-title">diagonalLine</span><span class="hljs-params">(
    color: <span class="hljs-type">Color</span>,
    strokeWidth: <span class="hljs-type">Float</span> = <span class="hljs-number">2</span>f
)</span></span>: Modifier = <span class="hljs-keyword">this</span>.then(DiagonalLineElement(color, strokeWidth))
</code></pre>
<h4 data-id="heading-14">1.7.3 高级自定义：LayoutModifier</h4>
<p>适用于需要自定义测量和布局逻辑的场景：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 自定义 AspectRatio Modifier（保持宽高比）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AspectRatioElement</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> ratio: <span class="hljs-built_in">Float</span>
) : ModifierNodeElement&lt;AspectRatioNode&gt;() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">create</span><span class="hljs-params">()</span></span> = AspectRatioNode(ratio)
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">update</span><span class="hljs-params">(node: <span class="hljs-type">AspectRatioNode</span>)</span></span> {
        node.ratio = ratio
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AspectRatioNode</span>(<span class="hljs-keyword">var</span> ratio: <span class="hljs-built_in">Float</span>) : 
    Modifier.Node(), 
    LayoutModifierNode {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> MeasureScope.<span class="hljs-title">measure</span><span class="hljs-params">(
        measurable: <span class="hljs-type">Measurable</span>,
        constraints: <span class="hljs-type">Constraints</span>
    )</span></span>: MeasureResult {
        <span class="hljs-comment">// 根据约束计算合适的尺寸</span>
        <span class="hljs-keyword">val</span> width = constraints.maxWidth
        <span class="hljs-keyword">val</span> height = (width / ratio).toInt()
        
        <span class="hljs-comment">// 确保不超过最大高度</span>
        <span class="hljs-keyword">val</span> finalHeight = <span class="hljs-keyword">if</span> (height &gt; constraints.maxHeight) {
            constraints.maxHeight
        } <span class="hljs-keyword">else</span> {
            height
        }
        
        <span class="hljs-comment">// 重新计算宽度以保持比例</span>
        <span class="hljs-keyword">val</span> finalWidth = (finalHeight * ratio).toInt()
        
        <span class="hljs-comment">// 测量子元素</span>
        <span class="hljs-keyword">val</span> placeable = measurable.measure(
            Constraints.fixed(finalWidth, finalHeight)
        )
        
        <span class="hljs-keyword">return</span> layout(finalWidth, finalHeight) {
            placeable.placeRelative(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
        }
    }
}
</code></pre>
<h3 data-id="heading-15">1.8 Intrinsic 测量：解决"先有鸡还是先有蛋"</h3>
<h4 data-id="heading-16">1.8.1 问题场景</h4>
<p>考虑这样一个需求：两个 Text 垂直排列，要求 Divider 的宽度等于两个 Text 中最宽的那个。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Column {
    Text(<span class="hljs-string">"Short"</span>)
    Text(<span class="hljs-string">"Longer text"</span>)
    Divider() <span class="hljs-comment">// 宽度应该等于 "Longer text" 的宽度</span>
}
</code></pre>
<p><strong>问题</strong>：在测量 Divider 时，Column 还不知道两个 Text 的宽度，因为 Text 还没被测量。</p>
<h4 data-id="heading-17">1.8.2 Intrinsic 测量的原理</h4>
<p>Intrinsic 测量允许父组件在正式测量前，<strong>预先询问子元素的期望尺寸</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">IntrinsicMeasurable</span> {
    <span class="hljs-comment">// 给定高度，返回最小/最大宽度</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">minIntrinsicWidth</span><span class="hljs-params">(height: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">maxIntrinsicWidth</span><span class="hljs-params">(height: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span>
    
    <span class="hljs-comment">// 给定宽度，返回最小/最大高度  </span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">minIntrinsicHeight</span><span class="hljs-params">(width: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">maxIntrinsicHeight</span><span class="hljs-params">(width: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span>
}
</code></pre>
<p><strong>使用 Intrinsic 测量解决 Divider 问题</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">IntrinsicWidthDemo</span><span class="hljs-params">()</span></span> {
    Column(
        modifier = Modifier.width(IntrinsicSize.Max)  <span class="hljs-comment">// 使用最大固有宽度</span>
    ) {
        Text(<span class="hljs-string">"Short text"</span>)
        Text(<span class="hljs-string">"This is a longer text"</span>)
        Divider(
            modifier = Modifier.fillMaxWidth(),
            color = Color.Black
        )
    }
}
</code></pre>
<p><strong>执行流程</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> Column 收到 IntrinsicSize.Max 约束
<span class="hljs-bullet">2.</span> Column 询问所有子元素的 maxIntrinsicWidth
<span class="hljs-bullet">3.</span> Text 返回自己的文本宽度
<span class="hljs-bullet">4.</span> Column 取最大值作为自身宽度
<span class="hljs-bullet">5.</span> Column 正式测量，将宽度约束传递给子元素
<span class="hljs-bullet">6.</span> Divider 收到与最宽 Text 相同的宽度
</code></pre>
<h4 data-id="heading-18">1.8.3 IntrinsicSize.Min 与 IntrinsicSize.Max</h4>




















<table><thead><tr><th>类型</th><th>说明</th><th>应用场景</th></tr></thead><tbody><tr><td><code>IntrinsicSize.Min</code></td><td>使用子元素的最小固有尺寸</td><td>按钮等需要紧凑尺寸的场景</td></tr><tr><td><code>IntrinsicSize.Max</code></td><td>使用子元素的最大固有尺寸</td><td>表单等需要对齐的场景</td></tr></tbody></table>
<h3 data-id="heading-19">1.9 Modifier 性能优化</h3>
<h4 data-id="heading-20">1.9.1 避免不必要的重组</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误：每次重组都创建新的 Modifier</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">BadExample</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> count <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-number">0</span>) }
    
    Text(
        text = <span class="hljs-string">"Count: <span class="hljs-variable">$count</span>"</span>,
        modifier = Modifier.padding(<span class="hljs-number">16.</span>dp)  <span class="hljs-comment">// 每次重组都创建新实例</span>
    )
}

<span class="hljs-comment">// ✅ 正确：使用 remember 缓存 Modifier</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">GoodExample</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> count <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-number">0</span>) }
    <span class="hljs-keyword">val</span> modifier = remember { Modifier.padding(<span class="hljs-number">16.</span>dp) }
    
    Text(
        text = <span class="hljs-string">"Count: <span class="hljs-variable">$count</span>"</span>,
        modifier = modifier  <span class="hljs-comment">// 复用同一个实例</span>
    )
}

<span class="hljs-comment">// ✅ 更好：将 Modifier 作为参数，由父组件提供</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">BestExample</span><span class="hljs-params">(
    text: <span class="hljs-type">String</span>,
    modifier: <span class="hljs-type">Modifier</span> = Modifier  <span class="hljs-comment">// 由调用方提供</span>
)</span></span> {
    Text(
        text = text,
        modifier = modifier
    )
}
</code></pre>
<h4 data-id="heading-21">1.9.2 Modifier 的相等性优化</h4>
<p>Compose 使用 <code>equals()</code> 判断 Modifier 是否变化，从而决定是否跳过重组：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 自定义 Modifier 时，务必实现 equals 和 hashCode</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyModifier</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> color: Color,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> size: Dp
) : Modifier.Element {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">equals</span><span class="hljs-params">(other: <span class="hljs-type">Any</span>?)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> === other) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
        <span class="hljs-keyword">if</span> (other !<span class="hljs-keyword">is</span> MyModifier) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
        <span class="hljs-keyword">return</span> color == other.color &amp;&amp; size == other.size
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Int</span> {
        <span class="hljs-keyword">return</span> color.hashCode() * <span class="hljs-number">31</span> + size.hashCode()
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-22">二、布局系统深度解析：从测量到绘制</h2>
<h3 data-id="heading-23">2.1 Compose 布局的三阶段</h3>
<p>Compose 的渲染流程分为三个阶段：</p>
<pre><code class="hljs language-css" lang="css">┌─────────────────────────────────────────────────────────────┐
│                      Composition                            │
│  执行 Composable 函数，构建 UI 树（LayoutNode 树）            │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                        Layout                               │
│  测量每个节点的尺寸（Measure），确定位置（Place）              │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                        Drawing                              │
│  将 UI 绘制到 <span class="hljs-selector-tag">Canvas</span> 上                                      │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-24">2.2 Layout 节点的数据结构</h3>
<p>每个 Composable 在布局阶段都会对应一个 <code>LayoutNode</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 简化版 LayoutNode 结构</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LayoutNode</span> {
    <span class="hljs-comment">// 父节点</span>
    <span class="hljs-keyword">var</span> parent: LayoutNode? = <span class="hljs-literal">null</span>
    
    <span class="hljs-comment">// 子节点列表</span>
    <span class="hljs-keyword">val</span> children: MutableList&lt;LayoutNode&gt; = mutableListOf()
    
    <span class="hljs-comment">// Modifier 链表</span>
    <span class="hljs-keyword">var</span> modifier: Modifier = Modifier
    
    <span class="hljs-comment">// 测量结果</span>
    <span class="hljs-keyword">var</span> width: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
    <span class="hljs-keyword">var</span> height: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
    
    <span class="hljs-comment">// 位置</span>
    <span class="hljs-keyword">var</span> x: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
    <span class="hljs-keyword">var</span> y: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
    
    <span class="hljs-comment">// 测量函数（由 Layout Composable 提供）</span>
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> measurePolicy: MeasurePolicy
}
</code></pre>
<h3 data-id="heading-25">2.3 Constraints：布局的约束条件</h3>
<p>Constraints 是 Compose 布局系统的核心，它定义了尺寸的限制范围：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Constraints</span> {
    <span class="hljs-keyword">val</span> minWidth: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">val</span> maxWidth: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">val</span> minHeight: <span class="hljs-built_in">Int</span>
    <span class="hljs-keyword">val</span> maxHeight: <span class="hljs-built_in">Int</span>
    
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-comment">// 创建固定尺寸约束</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fixed</span><span class="hljs-params">(width: <span class="hljs-type">Int</span>, height: <span class="hljs-type">Int</span>)</span></span>: Constraints
        
        <span class="hljs-comment">// 创建最大尺寸约束</span>
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">maxWidth</span><span class="hljs-params">(width: <span class="hljs-type">Int</span>)</span></span>: Constraints
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">maxHeight</span><span class="hljs-params">(height: <span class="hljs-type">Int</span>)</span></span>: Constraints
        
        <span class="hljs-comment">// 无限约束</span>
        <span class="hljs-keyword">val</span> Infinity = <span class="hljs-built_in">Int</span>.MAX_VALUE
    }
}
</code></pre>
<p><strong>约束类型</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">┌─────────────────────────────────────────────────────────────┐
│                    约束类型图解                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  精确约束                    范围约束                       │
│  ┌─────────┐               ┌───────────────────────────┐   │
│  │         │               │  minWidth          maxWidth│   │
│  │ 100x100 │               │  ├─────────────────────┤   │   │
│  │         │               │       可以是任意值          │   │
│  └─────────┘               └───────────────────────────┘   │
│  <span class="hljs-attr">minWidth</span> = maxWidth = <span class="hljs-number">100</span>                                  │
│                                                             │
│  无约束                                                     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    Infinity                          │   │
│  │  可以是任意大的尺寸                                   │   │
│  └─────────────────────────────────────────────────────┘   │
│  <span class="hljs-attr">maxWidth</span> = Int.MAX_VALUE                                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-26">2.4 测量流程详解</h3>
<p>测量是一个<strong>自顶向下</strong>的过程：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 父节点测量子节点的流程</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">measureChild</span><span class="hljs-params">(child: <span class="hljs-type">Measurable</span>, constraints: <span class="hljs-type">Constraints</span>)</span></span>: Placeable {
    <span class="hljs-comment">// 1. 根据父节点的约束，计算给子节点的约束</span>
    <span class="hljs-keyword">val</span> childConstraints = calculateChildConstraints(constraints)
    
    <span class="hljs-comment">// 2. 让子节点测量自己</span>
    <span class="hljs-keyword">val</span> placeable = child.measure(childConstraints)
    
    <span class="hljs-comment">// 3. 返回测量结果（Placeable）</span>
    <span class="hljs-keyword">return</span> placeable
}
</code></pre>
<p><strong>完整测量流程示例</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MeasureDemo</span><span class="hljs-params">()</span></span> {
    Layout(
        content = {
            Text(<span class="hljs-string">"Child 1"</span>)
            Text(<span class="hljs-string">"Child 2"</span>)
        }
    ) { measurables, constraints -&gt;
        <span class="hljs-comment">// constraints: 父节点给当前节点的约束</span>
        println(<span class="hljs-string">"父约束: minW=<span class="hljs-subst">${constraints.minWidth}</span>, maxW=<span class="hljs-subst">${constraints.maxWidth}</span>"</span>)
        
        <span class="hljs-comment">// 测量子节点</span>
        <span class="hljs-keyword">val</span> placeables = measurables.map { measurable -&gt;
            <span class="hljs-comment">// 可以给子节点不同的约束</span>
            <span class="hljs-keyword">val</span> childConstraints = Constraints(
                minWidth = <span class="hljs-number">0</span>,
                maxWidth = constraints.maxWidth / <span class="hljs-number">2</span>,  <span class="hljs-comment">// 每个子节点最多一半宽度</span>
                minHeight = <span class="hljs-number">0</span>,
                maxHeight = constraints.maxHeight
            )
            measurable.measure(childConstraints)
        }
        
        <span class="hljs-comment">// 计算自己的尺寸</span>
        <span class="hljs-keyword">val</span> width = placeables.sumOf { it.width }
        <span class="hljs-keyword">val</span> height = placeables.maxOf { it.height }
        
        <span class="hljs-comment">// 布局</span>
        layout(width, height) {
            <span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>
            placeables.forEach { placeable -&gt;
                placeable.placeRelative(x, <span class="hljs-number">0</span>)
                x += placeable.width
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-27">2.5 Column 的测量与布局原理</h3>
<p>让我们深入分析 Column 的实现：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Column 的简化实现</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Column</span><span class="hljs-params">(
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    verticalArrangement: <span class="hljs-type">Arrangement</span>.<span class="hljs-type">Vertical</span> = Arrangement.Top,
    horizontalAlignment: <span class="hljs-type">Alignment</span>.<span class="hljs-type">Horizontal</span> = Alignment.Start,
    content: @<span class="hljs-type">Composable</span> <span class="hljs-type">ColumnScope</span>.() -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    <span class="hljs-keyword">val</span> measurePolicy = columnMeasurePolicy(
        verticalArrangement = verticalArrangement,
        horizontalAlignment = horizontalAlignment
    )
    
    Layout(
        content = { ColumnScopeInstance.content() },
        measurePolicy = measurePolicy,
        modifier = modifier
    )
}

<span class="hljs-comment">// Column 的测量策略</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">columnMeasurePolicy</span><span class="hljs-params">(
    verticalArrangement: <span class="hljs-type">Arrangement</span>.<span class="hljs-type">Vertical</span>,
    horizontalAlignment: <span class="hljs-type">Alignment</span>.<span class="hljs-type">Horizontal</span>
)</span></span>: MeasurePolicy = MeasurePolicy { measurables, constraints -&gt;
    <span class="hljs-comment">// 1. 测量所有子元素</span>
    <span class="hljs-keyword">val</span> placeables = measurables.map { measurable -&gt;
        measurable.measure(constraints)
    }
    
    <span class="hljs-comment">// 2. 计算 Column 的尺寸</span>
    <span class="hljs-keyword">val</span> width = placeables.maxOf { it.width }
        .coerceIn(constraints.minWidth, constraints.maxWidth)
    
    <span class="hljs-keyword">val</span> height = placeables.sumOf { it.height }
        .coerceIn(constraints.minHeight, constraints.maxHeight)
    
    <span class="hljs-comment">// 3. 计算垂直位置（根据 Arrangement）</span>
    <span class="hljs-keyword">val</span> positions = verticalArrangement.arrange(
        totalSize = height,
        sizes = placeables.map { it.height },
        layoutDirection = layoutDirection
    )
    
    <span class="hljs-comment">// 4. 布局</span>
    layout(width, height) {
        placeables.forEachIndexed { index, placeable -&gt;
            <span class="hljs-comment">// 计算水平位置（根据 Alignment）</span>
            <span class="hljs-keyword">val</span> x = horizontalAlignment.align(
                size = placeable.width,
                space = width,
                layoutDirection = layoutDirection
            )
            placeable.placeRelative(x, positions[index])
        }
    }
}
</code></pre>
<p><strong>关键设计</strong>：</p>
<ul>
<li>Column 给子元素的约束是<strong>完整的父约束</strong>，子元素可以决定自己的高度</li>
<li>Column 的总高度是子元素高度之和</li>
<li>Arrangement 决定子元素的垂直分布</li>
<li>Alignment 决定子元素的水平对齐</li>
</ul>
<h3 data-id="heading-28">2.6 Row 的测量与布局原理</h3>
<p>Row 与 Column 类似，只是方向不同：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Row 的测量策略</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rowMeasurePolicy</span><span class="hljs-params">(
    horizontalArrangement: <span class="hljs-type">Arrangement</span>.<span class="hljs-type">Horizontal</span>,
    verticalAlignment: <span class="hljs-type">Alignment</span>.<span class="hljs-type">Vertical</span>
)</span></span>: MeasurePolicy = MeasurePolicy { measurables, constraints -&gt;
    <span class="hljs-comment">// 1. 测量所有子元素</span>
    <span class="hljs-keyword">val</span> placeables = measurables.map { measurable -&gt;
        measurable.measure(constraints)
    }
    
    <span class="hljs-comment">// 2. 计算 Row 的尺寸</span>
    <span class="hljs-keyword">val</span> width = placeables.sumOf { it.width }
        .coerceIn(constraints.minWidth, constraints.maxWidth)
    
    <span class="hljs-keyword">val</span> height = placeables.maxOf { it.height }
        .coerceIn(constraints.minHeight, constraints.maxHeight)
    
    <span class="hljs-comment">// 3. 计算水平位置（根据 Arrangement）</span>
    <span class="hljs-keyword">val</span> positions = horizontalArrangement.arrange(
        totalSize = width,
        sizes = placeables.map { it.width },
        layoutDirection = layoutDirection
    )
    
    <span class="hljs-comment">// 4. 布局</span>
    layout(width, height) {
        placeables.forEachIndexed { index, placeable -&gt;
            <span class="hljs-comment">// 计算垂直位置（根据 Alignment）</span>
            <span class="hljs-keyword">val</span> y = verticalAlignment.align(
                size = placeable.height,
                space = height
            )
            placeable.placeRelative(positions[index], y)
        }
    }
}
</code></pre>
<h3 data-id="heading-29">2.7 Box 的测量与布局原理</h3>
<p>Box 是层叠布局，子元素可以重叠：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Box 的测量策略</span>
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">boxMeasurePolicy</span><span class="hljs-params">(alignment: <span class="hljs-type">Alignment</span>)</span></span>: MeasurePolicy = 
    MeasurePolicy { measurables, constraints -&gt;
        <span class="hljs-comment">// 1. 测量所有子元素</span>
        <span class="hljs-keyword">val</span> placeables = measurables.map { measurable -&gt;
            measurable.measure(constraints)
        }
        
        <span class="hljs-comment">// 2. 计算 Box 的尺寸</span>
        <span class="hljs-keyword">val</span> width = placeables.maxOf { it.width }
            .coerceIn(constraints.minWidth, constraints.maxWidth)
        
        <span class="hljs-keyword">val</span> height = placeables.maxOf { it.height }
            .coerceIn(constraints.minHeight, constraints.maxHeight)
        
        <span class="hljs-comment">// 3. 布局（所有子元素都使用相同的对齐方式）</span>
        layout(width, height) {
            placeables.forEach { placeable -&gt;
                <span class="hljs-keyword">val</span> x = alignment.align(
                    size = placeable.width,
                    space = width,
                    layoutDirection = layoutDirection
                )
                <span class="hljs-keyword">val</span> y = alignment.align(
                    size = placeable.height,
                    space = height
                )
                placeable.placeRelative(x, y)
            }
        }
    }
</code></pre>
<p><strong>Box 的特殊之处</strong>：</p>
<ul>
<li>所有子元素都测量为最大尺寸</li>
<li>子元素默认使用 contentAlignment 对齐</li>
<li>可以单独指定子元素的对齐方式（使用 Modifier.align）</li>
</ul>
<h3 data-id="heading-30">2.8 自定义 Layout 的设计思路</h3>
<h4 data-id="heading-31">2.8.1 设计自定义布局的步骤</h4>
<ol>
<li><strong>明确需求</strong>：要实现什么样的布局效果？</li>
<li><strong>确定约束</strong>：子元素的尺寸如何确定？</li>
<li><strong>设计测量策略</strong>：如何测量子元素？</li>
<li><strong>设计布局策略</strong>：子元素如何排列？</li>
</ol>
<h4 data-id="heading-32">2.8.2 实战：自定义瀑布流布局</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 瀑布流布局（StaggeredGrid）
 * 
 * 设计思路：
 * 1. 将子元素分配到多列中
 * 2. 每列独立计算高度
 * 3. 新元素添加到最短的列
 */</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">StaggeredGrid</span><span class="hljs-params">(
    columns: <span class="hljs-type">Int</span> = <span class="hljs-number">2</span>,
    horizontalGap: <span class="hljs-type">Dp</span> = <span class="hljs-number">8.</span>dp,
    verticalGap: <span class="hljs-type">Dp</span> = <span class="hljs-number">8.</span>dp,
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    content: @<span class="hljs-type">Composable</span> () -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    Layout(
        content = content,
        modifier = modifier
    ) { measurables, constraints -&gt;
        <span class="hljs-keyword">val</span> hGapPx = horizontalGap.roundToPx()
        <span class="hljs-keyword">val</span> vGapPx = verticalGap.roundToPx()
        
        <span class="hljs-comment">// 计算每列的宽度</span>
        <span class="hljs-keyword">val</span> columnWidth = (constraints.maxWidth - (columns - <span class="hljs-number">1</span>) * hGapPx) / columns
        
        <span class="hljs-comment">// 创建列高度追踪器</span>
        <span class="hljs-keyword">val</span> columnHeights = IntArray(columns) { <span class="hljs-number">0</span> }
        
        <span class="hljs-comment">// 存储每个子元素的位置信息</span>
        <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ItemInfo</span>(
            <span class="hljs-keyword">val</span> placeable: Placeable,
            <span class="hljs-keyword">val</span> column: <span class="hljs-built_in">Int</span>,
            <span class="hljs-keyword">val</span> x: <span class="hljs-built_in">Int</span>,
            <span class="hljs-keyword">val</span> y: <span class="hljs-built_in">Int</span>
        )
        
        <span class="hljs-keyword">val</span> itemInfos = mutableListOf&lt;ItemInfo&gt;()
        
        <span class="hljs-comment">// 测量并放置每个子元素</span>
        measurables.forEach { measurable -&gt;
            <span class="hljs-comment">// 测量子元素（宽度固定为列宽，高度不限）</span>
            <span class="hljs-keyword">val</span> placeable = measurable.measure(
                Constraints.fixedWidth(columnWidth)
            )
            
            <span class="hljs-comment">// 找到最短的列</span>
            <span class="hljs-keyword">val</span> shortestColumn = columnHeights.indices.minByOrNull { columnHeights[it] } ?: <span class="hljs-number">0</span>
            
            <span class="hljs-comment">// 计算位置</span>
            <span class="hljs-keyword">val</span> x = shortestColumn * (columnWidth + hGapPx)
            <span class="hljs-keyword">val</span> y = columnHeights[shortestColumn]
            
            <span class="hljs-comment">// 更新列高度</span>
            columnHeights[shortestColumn] += placeable.height + vGapPx
            
            itemInfos.add(ItemInfo(placeable, shortestColumn, x, y))
        }
        
        <span class="hljs-comment">// 计算总高度（最高列的高度）</span>
        <span class="hljs-keyword">val</span> totalHeight = columnHeights.maxOrNull()?.let { 
            it - vGapPx  <span class="hljs-comment">// 减去最后一个间隙</span>
        } ?: <span class="hljs-number">0</span>
        
        <span class="hljs-comment">// 布局</span>
        layout(constraints.maxWidth, totalHeight.coerceIn(constraints.minHeight, constraints.maxHeight)) {
            itemInfos.forEach { info -&gt;
                info.placeable.placeRelative(info.x, info.y)
            }
        }
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">StaggeredGridDemo</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> items = listOf(
        <span class="hljs-string">"短文本"</span> to <span class="hljs-number">80</span>,
        <span class="hljs-string">"这是一个比较长的文本内容"</span> to <span class="hljs-number">120</span>,
        <span class="hljs-string">"中等"</span> to <span class="hljs-number">100</span>,
        <span class="hljs-string">"很长很长很长的文本内容在这里"</span> to <span class="hljs-number">150</span>,
        <span class="hljs-string">"短"</span> to <span class="hljs-number">60</span>,
    )
    
    StaggeredGrid(
        columns = <span class="hljs-number">2</span>,
        horizontalGap = <span class="hljs-number">8.</span>dp,
        verticalGap = <span class="hljs-number">8.</span>dp,
        modifier = Modifier.fillMaxWidth()
    ) {
        items.forEach { (text, height) -&gt;
            Card(
                modifier = Modifier.height(height.dp)
            ) {
                Text(
                    text = text,
                    modifier = Modifier.padding(<span class="hljs-number">8.</span>dp)
                )
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-33">2.9 SubcomposeLayout：延迟组合</h3>
<p>SubcomposeLayout 允许在测量阶段动态创建子元素，这在某些场景下非常有用。</p>
<h4 data-id="heading-34">2.9.1 使用场景</h4>
<ol>
<li><strong>根据测量结果决定子元素内容</strong></li>
<li><strong>实现复杂的自适应布局</strong></li>
<li><strong>动态加载内容</strong></li>
</ol>
<h4 data-id="heading-35">2.9.2 实战：响应式文本</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 响应式文本：根据可用宽度自动调整字体大小
 */</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ResponsiveText</span><span class="hljs-params">(
    text: <span class="hljs-type">String</span>,
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    minFontSize: <span class="hljs-type">TextUnit</span> = <span class="hljs-number">12.</span>sp,
    maxFontSize: <span class="hljs-type">TextUnit</span> = <span class="hljs-number">48.</span>sp
)</span></span> {
    SubcomposeLayout(modifier = modifier) { constraints -&gt;
        <span class="hljs-keyword">var</span> fontSize = maxFontSize
        <span class="hljs-keyword">var</span> placeable: Placeable? = <span class="hljs-literal">null</span>
        
        <span class="hljs-comment">// 二分查找合适的字体大小</span>
        <span class="hljs-keyword">while</span> (fontSize &gt;= minFontSize) {
            <span class="hljs-keyword">val</span> measurable = subcompose(<span class="hljs-string">"text_<span class="hljs-variable">$fontSize</span>"</span>) {
                Text(
                    text = text,
                    fontSize = fontSize,
                    maxLines = <span class="hljs-number">1</span>
                )
            }[<span class="hljs-number">0</span>]
            
            <span class="hljs-keyword">val</span> testPlaceable = measurable.measure(constraints)
            
            <span class="hljs-keyword">if</span> (testPlaceable.width &lt;= constraints.maxWidth) {
                placeable = testPlaceable
                <span class="hljs-keyword">break</span>
            }
            
            fontSize *= <span class="hljs-number">0.9f</span>
        }
        
        placeable = placeable ?: subcompose(<span class="hljs-string">"text_min"</span>) {
            Text(text = text, fontSize = minFontSize, maxLines = <span class="hljs-number">1</span>)
        }[<span class="hljs-number">0</span>].measure(constraints)
        
        layout(placeable.width, placeable.height) {
            placeable.placeRelative(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-36">三、LazyColumn 深度解析：惰性加载的艺术</h2>
<h3 data-id="heading-37">3.1 为什么需要惰性加载？</h3>
<p>假设我们要显示 10000 条数据的列表：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用普通 Column - 会创建 10000 个 Text 组件！</span>
Column {
    repeat(<span class="hljs-number">10000</span>) { index -&gt;
        Text(<span class="hljs-string">"Item <span class="hljs-variable">$index</span>"</span>)
    }
}
</code></pre>
<p><strong>问题</strong>：</p>
<ul>
<li>内存占用：10000 个 Text 组件同时存在</li>
<li>首次加载：需要测量和布局所有 item</li>
<li>滑动性能：大量视图参与绘制</li>
</ul>
<h3 data-id="heading-38">3.2 LazyColumn 的解决方案</h3>
<p>LazyColumn 采用<strong>视口渲染 + 对象池复用</strong>策略：</p>
<pre><code class="hljs language-scss" lang="scss">┌────────────────────────────────────────────────────────────────┐
│                     LazyColumn 视口                            │
│                                                                │
│  ┌──────────────────────────────────────────────────────┐     │
│  │                    可见区域 (Viewport)                  │     │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  │     │
│  │  │ Item <span class="hljs-number">5</span>  │  │ Item <span class="hljs-number">6</span>  │  │ Item <span class="hljs-number">7</span>  │  │ Item <span class="hljs-number">8</span>  │  │     │
│  │  │ (可见)  │  │ (可见)  │  │ (可见)  │  │ (可见)  │  │     │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘  │     │
│  └──────────────────────────────────────────────────────┘     │
│                                                                │
│  Item <span class="hljs-number">1</span>-<span class="hljs-number">4</span>: 已滑出视口，组件被回收，状态保存                      │
│  Item <span class="hljs-number">9</span>+:  未进入视口，组件未创建                                │
│                                                                │
└────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-39">3.3 LazyColumn 的架构设计</h3>
<pre><code class="hljs language-scss" lang="scss">LazyColumn
├── LazyListState          (状态管理)
│   ├── firstVisibleItemIndex
│   ├── firstVisibleItemScrollOffset
│   └── layoutInfo
├── LazyListLayoutInfo     (布局信息)
│   ├── visibleItemsInfo   (可见 item 信息)
│   ├── totalItemsCount
│   └── viewportSize
└── LazyListItemProvider   (Item 提供器)
    └── itemProvider       (根据索引创建 item)
</code></pre>
<h3 data-id="heading-40">3.4 测量与布局流程</h3>
<p>LazyColumn 的测量流程与普通 Layout 不同：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// LazyColumn 的测量策略（简化版）</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">measureLazyList</span><span class="hljs-params">(constraints: <span class="hljs-type">Constraints</span>)</span></span>: MeasureResult {
    <span class="hljs-comment">// 1. 计算视口大小</span>
    <span class="hljs-keyword">val</span> viewportWidth = constraints.maxWidth
    <span class="hljs-keyword">val</span> viewportHeight = constraints.maxHeight
    
    <span class="hljs-comment">// 2. 确定可见 item 范围</span>
    <span class="hljs-keyword">val</span> firstVisibleIndex = calculateFirstVisibleItem()
    <span class="hljs-keyword">val</span> lastVisibleIndex = calculateLastVisibleItem(viewportHeight)
    
    <span class="hljs-comment">// 3. 测量可见 item</span>
    <span class="hljs-keyword">val</span> visiblePlaceables = mutableListOf&lt;Placeable&gt;()
    <span class="hljs-keyword">for</span> (index <span class="hljs-keyword">in</span> firstVisibleIndex..lastVisibleIndex) {
        <span class="hljs-keyword">val</span> placeable = measureItem(index, constraints)
        visiblePlaceables.add(placeable)
    }
    
    <span class="hljs-comment">// 4. 计算总高度（预估）</span>
    <span class="hljs-keyword">val</span> totalHeight = <span class="hljs-keyword">if</span> (hasMoreItems) {
        estimateTotalHeight()
    } <span class="hljs-keyword">else</span> {
        visiblePlaceables.sumOf { it.height }
    }
    
    <span class="hljs-comment">// 5. 布局</span>
    <span class="hljs-keyword">return</span> layout(viewportWidth, totalHeight) {
        <span class="hljs-keyword">var</span> y = -scrollOffset
        visiblePlaceables.forEach { placeable -&gt;
            placeable.placeRelative(<span class="hljs-number">0</span>, y)
            y += placeable.height
        }
    }
}
</code></pre>
<h3 data-id="heading-41">3.5 key 的作用与 diff 算法</h3>
<h4 data-id="heading-42">3.5.1 为什么需要 key？</h4>
<p>当列表数据变化时，Compose 需要知道：</p>
<ul>
<li>哪些 item 是新增的？</li>
<li>哪些 item 被删除了？</li>
<li>哪些 item 移动了位置？</li>
</ul>
<p><strong>没有 key 的问题</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 假设列表初始状态</span>
items = [A, B, C]

<span class="hljs-comment">// 删除 A 后</span>
items = [B, C]

<span class="hljs-comment">// 没有 key 时，Compose 会认为：</span>
<span class="hljs-comment">// - 位置 0 的内容从 A 变成了 B</span>
<span class="hljs-comment">// - 位置 1 的内容从 B 变成了 C</span>
<span class="hljs-comment">// - 位置 2 被删除</span>
<span class="hljs-comment">// 结果是：B 和 C 都会重组，状态丢失！</span>
</code></pre>
<p><strong>有 key 时</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">items(items, key = { it.id }) { item -&gt;
    ItemCard(item)
}

<span class="hljs-comment">// 删除 A 后</span>
<span class="hljs-comment">// Compose 知道：</span>
<span class="hljs-comment">// - A 被删除了</span>
<span class="hljs-comment">// - B 和 C 只是位置变了</span>
<span class="hljs-comment">// 结果是：只有 A 的组件被销毁，B 和 C 只是移动位置</span>
</code></pre>
<h4 data-id="heading-43">3.5.2 key 的 diff 算法</h4>
<p>Compose 使用类似 React 的 diff 算法：</p>
<pre><code class="hljs language-ini" lang="ini">旧列表: <span class="hljs-section">[A(key=1), B(key=2), C(key=3)]</span>
新列表: <span class="hljs-section">[B(key=2), C(key=3), D(key=4)]</span>

Diff 结果:
<span class="hljs-attr">1. key</span>=<span class="hljs-number">1</span> 的 A 不在新列表中 → 删除 A
<span class="hljs-attr">2. key</span>=<span class="hljs-number">2</span> 的 B 在位置 <span class="hljs-number">0</span> → 移动到位置 <span class="hljs-number">0</span>
<span class="hljs-attr">3. key</span>=<span class="hljs-number">3</span> 的 C 在位置 <span class="hljs-number">1</span> → 移动到位置 <span class="hljs-number">1</span>  
<span class="hljs-attr">4. key</span>=<span class="hljs-number">4</span> 的 D 是新元素 → 创建 D
</code></pre>
<h3 data-id="heading-44">3.6 列表状态管理</h3>
<h4 data-id="heading-45">3.6.1 记住滚动位置</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LazyColumnWithState</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// rememberLazyListState 会自动保存和恢复滚动位置</span>
    <span class="hljs-keyword">val</span> listState = rememberLazyListState()
    
    LazyColumn(state = listState) {
        items(<span class="hljs-number">1000</span>) { index -&gt;
            Text(<span class="hljs-string">"Item <span class="hljs-variable">$index</span>"</span>)
        }
    }
    
    <span class="hljs-comment">// 滚动到指定位置</span>
    LaunchedEffect(<span class="hljs-built_in">Unit</span>) {
        listState.scrollToItem(<span class="hljs-number">100</span>)
    }
    
    <span class="hljs-comment">// 平滑滚动</span>
    scope.launch {
        listState.animateScrollToItem(<span class="hljs-number">100</span>)
    }
}
</code></pre>
<h4 data-id="heading-46">3.6.2 监听滚动状态</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LazyColumnWithScrollListener</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> listState = rememberLazyListState()
    
    <span class="hljs-comment">// 使用 derivedStateOf 优化频繁变化的状态</span>
    <span class="hljs-keyword">val</span> firstVisibleItem <span class="hljs-keyword">by</span> remember {
        derivedStateOf { listState.firstVisibleItemIndex }
    }
    
    <span class="hljs-keyword">val</span> isScrolling <span class="hljs-keyword">by</span> remember {
        derivedStateOf { listState.isScrollInProgress }
    }
    
    <span class="hljs-comment">// 判断是否滑到底部</span>
    <span class="hljs-keyword">val</span> isAtBottom <span class="hljs-keyword">by</span> remember {
        derivedStateOf {
            <span class="hljs-keyword">val</span> layoutInfo = listState.layoutInfo
            <span class="hljs-keyword">val</span> visibleItems = layoutInfo.visibleItemsInfo
            <span class="hljs-keyword">val</span> lastVisibleItem = visibleItems.lastOrNull()
            
            lastVisibleItem != <span class="hljs-literal">null</span> &amp;&amp; 
            lastVisibleItem.index &gt;= layoutInfo.totalItemsCount - <span class="hljs-number">1</span>
        }
    }
    
    LazyColumn(state = listState) {
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<h3 data-id="heading-47">3.7 分页加载实现</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">PaginatedList</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> listState = rememberLazyListState()
    <span class="hljs-keyword">var</span> items <span class="hljs-keyword">by</span> remember { mutableStateOf&lt;List&lt;Item&gt;&gt;(emptyList()) }
    <span class="hljs-keyword">var</span> isLoading <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-literal">false</span>) }
    <span class="hljs-keyword">var</span> hasMore <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-literal">true</span>) }
    
    <span class="hljs-comment">// 监听是否需要加载更多</span>
    <span class="hljs-keyword">val</span> shouldLoadMore <span class="hljs-keyword">by</span> remember {
        derivedStateOf {
            <span class="hljs-keyword">val</span> layoutInfo = listState.layoutInfo
            <span class="hljs-keyword">val</span> visibleItems = layoutInfo.visibleItemsInfo
            <span class="hljs-keyword">val</span> lastVisibleItem = visibleItems.lastOrNull()
            
            <span class="hljs-comment">// 当最后一个可见 item 是倒数第 5 个时，开始加载</span>
            lastVisibleItem != <span class="hljs-literal">null</span> &amp;&amp;
            lastVisibleItem.index &gt;= layoutInfo.totalItemsCount - <span class="hljs-number">5</span> &amp;&amp;
            !isLoading &amp;&amp; hasMore
        }
    }
    
    <span class="hljs-comment">// 加载数据</span>
    LaunchedEffect(shouldLoadMore) {
        <span class="hljs-keyword">if</span> (shouldLoadMore) {
            isLoading = <span class="hljs-literal">true</span>
            <span class="hljs-keyword">val</span> newItems = repository.loadMore(items.size, pageSize = <span class="hljs-number">20</span>)
            items = items + newItems
            hasMore = newItems.size &gt;= <span class="hljs-number">20</span>
            isLoading = <span class="hljs-literal">false</span>
        }
    }
    
    LazyColumn(state = listState) {
        items(items, key = { it.id }) { item -&gt;
            ItemCard(item)
        }
        
        <span class="hljs-keyword">if</span> (isLoading) {
            item {
                Box(
                    modifier = Modifier
                        .fillMaxWidth()
                        .padding(<span class="hljs-number">16.</span>dp),
                    contentAlignment = Alignment.Center
                ) {
                    CircularProgressIndicator()
                }
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-48">3.8 性能优化最佳实践</h3>
<h4 data-id="heading-49">3.8.1 使用 key</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 正确：使用 key</span>
items(dataList, key = { it.id }) { item -&gt;
    ItemCard(item)
}

<span class="hljs-comment">// ❌ 错误：不使用 key</span>
items(dataList) { item -&gt;
    ItemCard(item)
}
</code></pre>
<h4 data-id="heading-50">3.8.2 避免在 item 中创建新的对象</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误：每次重组都创建新的 lambda</span>
items(dataList, key = { it.id }) { item -&gt;
    ItemCard(
        item = item,
        onClick = { viewModel.onItemClick(item) }  <span class="hljs-comment">// 每次重组都创建</span>
    )
}

<span class="hljs-comment">// ✅ 正确：使用 remember 缓存 lambda</span>
items(dataList, key = { it.id }) { item -&gt;
    <span class="hljs-keyword">val</span> onClick = remember(item.id) {
        { viewModel.onItemClick(item) }
    }
    ItemCard(item = item, onClick = onClick)
}
</code></pre>
<h4 data-id="heading-51">3.8.3 使用 contentType 优化不同类型 item</h4>
<pre><code class="hljs language-kotlin" lang="kotlin">LazyColumn {
    items(
        items = mixedList,
        key = { it.id },
        contentType = { it.type }  <span class="hljs-comment">// 帮助 Compose 复用 item</span>
    ) { item -&gt;
        <span class="hljs-keyword">when</span> (item.type) {
            Type.HEADER -&gt; HeaderItem(item)
            Type.CONTENT -&gt; ContentItem(item)
            Type.FOOTER -&gt; FooterItem(item)
        }
    }
}
</code></pre>
<h4 data-id="heading-52">3.8.4 合理使用 remember 缓存计算</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ItemCard</span><span class="hljs-params">(item: <span class="hljs-type">Item</span>)</span></span> {
    <span class="hljs-comment">// ✅ 缓存格式化后的价格</span>
    <span class="hljs-keyword">val</span> formattedPrice = remember(item.price) {
        NumberFormat.getCurrencyInstance().format(item.price)
    }
    
    <span class="hljs-comment">// ✅ 缓存渐变 Brush</span>
    <span class="hljs-keyword">val</span> gradient = remember(item.color) {
        Brush.linearGradient(
            colors = listOf(item.color, item.color.copy(alpha = <span class="hljs-number">0.5f</span>))
        )
    }
    
    Text(text = formattedPrice)
}
</code></pre>
<hr/>
<h2 data-id="heading-53">四、ConstraintLayout 深度解析</h2>
<h3 data-id="heading-54">4.1 ConstraintLayout 的设计哲学</h3>
<p>ConstraintLayout 的核心思想是<strong>通过约束条件描述布局</strong>，而不是通过嵌套层次。</p>
<p><strong>优势</strong>：</p>
<ul>
<li>扁平的视图层级（通常只有一层）</li>
<li>灵活的相对定位</li>
<li>更好的性能（减少测量次数）</li>
</ul>
<p><strong>适用场景</strong>：</p>
<ul>
<li>复杂的表单页面</li>
<li>需要相对定位的布局</li>
<li>需要动态调整位置的元素</li>
</ul>
<h3 data-id="heading-55">4.2 约束求解原理</h3>
<p>ConstraintLayout 的布局过程可以看作是一个<strong>约束求解问题</strong>：</p>
<pre><code class="hljs language-css" lang="css">变量：每个 View 的 x, y, <span class="hljs-attribute">width</span>, <span class="hljs-attribute">height</span>
约束条件：
  - View <span class="hljs-selector-tag">A</span> 的左边与父布局左边对齐
  - View <span class="hljs-selector-tag">B</span> 的左边与 View <span class="hljs-selector-tag">A</span> 的右边对齐
  - View C 在父布局中水平居中
  - ...

求解目标：找到满足所有约束的 x, y, <span class="hljs-attribute">width</span>, <span class="hljs-attribute">height</span>
</code></pre>
<h3 data-id="heading-56">4.3 与嵌套布局的选择策略</h3>



































<table><thead><tr><th>场景</th><th>推荐方案</th><th>理由</th></tr></thead><tbody><tr><td>简单线性排列</td><td>Column/Row</td><td>代码更简洁，语义更清晰</td></tr><tr><td>需要相对定位</td><td>ConstraintLayout</td><td>减少嵌套层级</td></tr><tr><td>复杂表单</td><td>ConstraintLayout</td><td>标签和输入框对齐更方便</td></tr><tr><td>列表项</td><td>Column/Row</td><td>性能更好，代码更易读</td></tr><tr><td>需要动态位置</td><td>ConstraintLayout</td><td>约束可以动态修改</td></tr></tbody></table>
<h3 data-id="heading-57">4.4 性能对比</h3>
<pre><code class="hljs language-diff" lang="diff">场景：一个包含 10 个子元素的复杂布局

嵌套 Column + Row:
<span class="hljs-deletion">- 测量次数：O(n²) 级别</span>
<span class="hljs-deletion">- 视图层级：3-4 层</span>

ConstraintLayout:
<span class="hljs-deletion">- 测量次数：O(n) 级别</span>
<span class="hljs-deletion">- 视图层级：1 层</span>
</code></pre>
<p><strong>建议</strong>：</p>
<ul>
<li>简单布局优先使用 Column/Row</li>
<li>复杂布局考虑 ConstraintLayout</li>
<li>不要过度优化，先保证代码可读性</li>
</ul>
<hr/>
<h2 data-id="heading-58">五、常见问题与解决方案</h2>
<h3 data-id="heading-59">5.1 Modifier 相关问题</h3>
<p><strong>Q: 为什么 Modifier.padding() 和 Modifier.background() 的顺序会影响效果？</strong></p>
<p>A: 因为 Modifier 是从外到内执行的。先应用的 Modifier 在外层，后应用的在内层。</p>
<p><strong>Q: 如何实现点击区域比实际 View 大？</strong></p>
<p>A: 使用 <code>Modifier.clickable</code> 配合 <code>Modifier.padding</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Box(
    modifier = Modifier
        .clickable { <span class="hljs-comment">/* 点击处理 */</span> }
        .padding(<span class="hljs-number">16.</span>dp)  <span class="hljs-comment">// 点击区域包含 padding</span>
        .background(Color.Blue)
) {
    Text(<span class="hljs-string">"Click me"</span>)
}
</code></pre>
<h3 data-id="heading-60">5.2 布局相关问题</h3>
<p><strong>Q: 如何实现宽高比固定的组件？</strong></p>
<p>A: 使用 <code>AspectRatio</code> Modifier：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Image(
    painter = painterResource(R.drawable.image),
    contentDescription = <span class="hljs-literal">null</span>,
    modifier = Modifier.aspectRatio(<span class="hljs-number">16f</span> / <span class="hljs-number">9f</span>)
)
</code></pre>
<p><strong>Q: 如何让子元素填满剩余空间？</strong></p>
<p>A: 使用 <code>Modifier.weight</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Column {
    Text(<span class="hljs-string">"Header"</span>)
    Box(
        modifier = Modifier
            .fillMaxWidth()
            .weight(<span class="hljs-number">1f</span>)  <span class="hljs-comment">// 填满剩余空间</span>
    )
    Text(<span class="hljs-string">"Footer"</span>)
}
</code></pre>
<h3 data-id="heading-61">5.3 LazyColumn 相关问题</h3>
<p><strong>Q: 列表滑动卡顿怎么办？</strong></p>
<p>A: 检查以下几点：</p>
<ol>
<li>是否使用了 key</li>
<li>item 中是否避免了创建新对象</li>
<li>是否使用了 derivedStateOf 优化频繁变化的状态</li>
<li>item 的布局是否过于复杂</li>
</ol>
<p><strong>Q: 如何实现粘性 Header？</strong></p>
<p>A: 使用 <code>stickyHeader</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">LazyColumn {
    stickyHeader {
        Text(<span class="hljs-string">"Section A"</span>, modifier = Modifier.background(Color.Gray))
    }
    items(itemsA) { Item(it) }
    
    stickyHeader {
        Text(<span class="hljs-string">"Section B"</span>, modifier = Modifier.background(Color.Gray))
    }
    items(itemsB) { Item(it) }
}
</code></pre>
<hr/>
<h2 data-id="heading-62">六、本篇小结</h2>
<p>今天我们深入探讨了 Compose 的核心基石：</p>
<h3 data-id="heading-63">Modifier</h3>
<ul>
<li>理解了 Modifier 的接口设计和链表结构</li>
<li>掌握了链式调用的执行顺序</li>
<li>学会了自定义 Modifier 的三种方式</li>
<li>了解了 Intrinsic 测量的原理</li>
</ul>
<h3 data-id="heading-64">布局系统</h3>
<ul>
<li>理解了 Composition → Layout → Drawing 的三阶段</li>
<li>掌握了 Constraints 的使用方法</li>
<li>深入了解了 Column、Row、Box 的测量与布局原理</li>
<li>学会了自定义 Layout 的设计思路</li>
</ul>
<h3 data-id="heading-65">LazyColumn</h3>
<ul>
<li>理解了惰性加载的视口渲染机制</li>
<li>掌握了 key 的作用和 diff 算法</li>
<li>学会了列表状态管理和分页加载</li>
<li>了解了性能优化的最佳实践</li>
</ul>
<h3 data-id="heading-66">ConstraintLayout</h3>
<ul>
<li>理解了约束求解的原理</li>
<li>掌握了与嵌套布局的选择策略</li>
</ul>
<hr/>
<h2 data-id="heading-67">下篇预告</h2>
<p><strong>第三篇：状态管理</strong> 将深入讲解：</p>
<ul>
<li>状态与重组机制深度解析（Slot Table 原理）</li>
<li>remember、mutableStateOf 源码分析</li>
<li>状态提升（State Hoisting）设计模式</li>
<li>ViewModel 与 Compose 的最佳实践</li>
<li>CompositionLocal 原理与应用</li>
</ul>
<p>敬请期待！</p>
<hr/>
<h2 data-id="heading-68">参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Flayouts" target="_blank" title="https://developer.android.com/jetpack/compose/layouts" ref="nofollow noopener noreferrer">Compose 布局官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Flists" target="_blank" title="https://developer.android.com/jetpack/compose/lists" ref="nofollow noopener noreferrer">Lazy 列表官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fframeworks%2Fsupport%2F%2B%2Fandroidx-main%2Fcompose%2F" target="_blank" title="https://android.googlesource.com/platform/frameworks/support/+/androidx-main/compose/" ref="nofollow noopener noreferrer">Compose 源码</a></li>
</ul>
<hr/>
<blockquote>
<p>📌 <strong>系列文章导航</strong></p>
<ul>
<li>第一篇：初识 Compose ✅</li>
<li>第二篇：核心基石（当前）✅</li>
<li>第三篇：状态管理</li>
<li>第四篇：Material 组件与主题</li>
<li>第五篇：动画与交互</li>
<li>第六篇：架构与工程化</li>
<li>第七篇：高级特性与实战</li>
</ul>
</blockquote>
<hr/>
<p>如果这篇文章对你有帮助，欢迎 <strong>点赞</strong>、<strong>收藏</strong>、<strong>关注</strong>！有任何问题可以在评论区留言。</p>
<p><del>Generated by Kimi K2.5 Agent</del></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[什么？Mybaits扩展 JPA功能，有趣！]]></title>    <link>https://juejin.cn/post/7600314093294207014</link>    <guid>https://juejin.cn/post/7600314093294207014</guid>    <pubDate>2026-01-29T01:22:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600314093294207014" data-draft-id="7600314093294190630" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="什么？Mybaits扩展 JPA功能，有趣！"/> <meta itemprop="keywords" content="后端,Java,程序员"/> <meta itemprop="datePublished" content="2026-01-29T01:22:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SimonKing"/> <meta itemprop="url" content="https://juejin.cn/user/4001878056904584"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            什么？Mybaits扩展 JPA功能，有趣！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4001878056904584/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SimonKing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T01:22:24.000Z" title="Thu Jan 29 2026 01:22:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>关注我的公众号：【编程朝花夕拾】，可获取首发内容。</p>
</blockquote>
<h2 data-id="heading-0">01 引言</h2>
<p>一直很关注<code>dromara</code>社区的项目，最近浏览器项目时，发现一个<code>mybatis-jpa-extra</code>项目，里面针对<code>JPA</code>扩展，可以使用<code>Lambda</code>表达式，于是好奇的点进去了解了一下，分享给大家。</p>
<h2 data-id="heading-1">02 简介</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c408060fe3a14e7cb84368a74351d103~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770254543&amp;x-signature=0EGN0a7DrQYjMgOMHuYNR7GjygA%3D" alt="" loading="lazy"/></p>
<p><code>MyBatis JPA Extra</code>对<code>MyBatis</code>扩展<code>JPA</code>功能，<code>Jakarta JPA</code> 注释简化<code>CRUD</code>操作，增强了SELECT分页查询，增加链式Query查询条件构造器；支持<code>Lambda</code> 形式调用，方便编写各类查询条件，使用<code>@Encrypted</code>注解轻松实现字段数据加密和解密以及字段数据自动填充功能等。</p>
<p><code>GitHub</code>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdromara%2Fmybatis-jpa-extra" target="_blank" title="https://github.com/dromara/mybatis-jpa-extra" ref="nofollow noopener noreferrer">github.com/dromara/myb…</a></p>
<p><code>Gitee</code>地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fdromara%2Fmybatis-jpa-extra" target="_blank" title="https://gitee.com/dromara/mybatis-jpa-extra" ref="nofollow noopener noreferrer">gitee.com/dromara/myb…</a></p>
<h2 data-id="heading-2">03 简单使用</h2>
<h3 data-id="heading-3">3.1 依赖</h3>
<p><strong>Maven</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.dromara.mybatis-jpa-extra<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-jpa-extra-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>配置</strong></p>
<pre><code class="hljs language-properties" lang="properties">spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
spring.datasource.url=jdbc:mysql://localhost:3306/test
spring.datasource.username=root
spring.datasource.password=123456

mybatis.type-aliases-package=com.simonking.boot.jpa.pojo
</code></pre>
<h3 data-id="heading-4">3.2 实体定义</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Entity(name = "users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Users</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaEntity</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@Column</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Integer id;
    <span class="hljs-meta">@Column</span>
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-meta">@Column</span>
    <span class="hljs-keyword">private</span> String password;
    <span class="hljs-meta">@Column(name = "password_salt")</span>
    <span class="hljs-keyword">private</span> String passwordSalt;
    <span class="hljs-meta">@Column(name = "del_flag")</span>
    <span class="hljs-keyword">private</span> Boolean delFlag;
}
</code></pre>
<p>需要注意的是这里的<code>@Column</code>一定要加，否则使用<code>Lambda</code>调用的时候会出现<code>sql</code>异常。</p>
<h3 data-id="heading-5">3.3 接口以及实现</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 接口
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UsersService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IJpaService</span>&lt;Users, Integer&gt; {

}

<span class="hljs-comment">/**
 * 实现
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UsersServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaServiceImpl</span>&lt;UsersMapper, Users, Integer&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UsersService</span>  {

}
</code></pre>
<p>官方说明里面继承的是<code>AbstractJpaRepository</code>，使用起来有点小问题，会导致<code>getMapper</code>为空的异常。使用时需要继承<code>JpaServiceImpl</code>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34af6f35a058457aa4cf37911839fc53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770254543&amp;x-signature=zosIKJRs%2FTtbfDKUNNLkag6TzG8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">3.4 Mapper</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UsersMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">IJpaMapper</span>&lt;Users, Integer&gt; {
}
</code></pre>
<p>这里的Mapper可以使用<code>@Mapper</code>注解，也可以使用<code>@MapperScan("com.simonking.boot.jpa.mapper")</code>放在启动类上。</p>
<h3 data-id="heading-7">3.5 测试</h3>
<pre><code class="hljs language-java" lang="java"> <span class="hljs-meta">@Autowired</span>
<span class="hljs-keyword">private</span> UsersService usersService;

<span class="hljs-comment">/**
 * JPA 测试
 */</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">test03</span><span class="hljs-params">()</span> {
    <span class="hljs-type">Users</span> <span class="hljs-variable">byId</span> <span class="hljs-operator">=</span> usersService.findById(<span class="hljs-number">1</span>);
    System.out.println(byId);
}

<span class="hljs-comment">/**
 * Lambda 测试
 */</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">test02</span><span class="hljs-params">()</span> {
    usersService.query(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LambdaQuery</span>&lt;Users&gt;()
                    .eq(Users::getUsername, <span class="hljs-string">"test"</span>)
            ).forEach(System.out::println);
}

<span class="hljs-comment">/**
 * Mybatis 注解测试
 */</span>
<span class="hljs-meta">@Test</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">test03</span><span class="hljs-params">()</span> {
     <span class="hljs-type">Users</span> <span class="hljs-variable">users</span> <span class="hljs-operator">=</span> usersService.getByUsername(<span class="hljs-string">"lisi"</span>);
     System.out.println(users);
}
</code></pre>
<p>结果</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18e64b6f904d44aeb9ccf17d3f430fc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770254543&amp;x-signature=y8J8ROY0MefQOiNP4IhTlugdtGM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fdcb0b2aac54462a27b143df8e631fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770254543&amp;x-signature=lLL4p8WqhEJR7HNZ6kdjQH1tNJA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab0245df69574ae5a9ec2eac79dd9e5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770254543&amp;x-signature=5HP%2F8HNzYSpqOmT5oMD2QPhe0gE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">04 小结</h2>
<p>作者是基于<code>Mybaits</code>扩展的<code>JPA</code>。类似框架<code>Mybaits-Plus</code>、<code>Mybaits-Flex</code>，本身是对<code>Mybatis</code>的增强，没有引入其他的框架。<code>mybatis-jpa-extra</code>何尝不是一种新的选择。</p>
<p>框架可能还不成熟，测试下来总会碰到一些小问题。</p>
<ul>
<li><code>xxxServiceImpl</code>需要继承<code>JpaServiceImpl</code>，而不是<code>AbstractJpaRepository</code>，否则<code>getMapper</code> is null</li>
<li>使用<code>SpringBoot 3.x</code>启动异常，使用<code>SpringBoot4.0.1</code>正常启动测试</li>
<li><code>insert</code>方法没有返回主键</li>
</ul>
<p>使用下来感觉没有<code>MP</code>、<code>MF</code>丝滑，就没有深入去了解了。有懂的朋友一起唠唠！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot 开发效率翻倍的5个隐藏技巧，你知道几个？]]></title>    <link>https://juejin.cn/post/7600265780349861928</link>    <guid>https://juejin.cn/post/7600265780349861928</guid>    <pubDate>2026-01-29T00:17:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600265780349861928" data-draft-id="7600296037542674432" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot 开发效率翻倍的5个隐藏技巧，你知道几个？"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-29T00:17:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot 开发效率翻倍的5个隐藏技巧，你知道几个？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T00:17:20.000Z" title="Thu Jan 29 2026 00:17:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    22
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>SpringBoot 开发效率翻倍的5个隐藏技巧，你知道几个？</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>SpringBoot 作为 Java 生态中最流行的微服务框架之一，以其“约定优于配置”的理念和丰富的 Starter 依赖极大地简化了开发流程。然而，很多开发者仅停留在基础用法上，忽略了 SpringBoot 提供的一些隐藏技巧。这些技巧不仅能减少样板代码，还能显著提升开发效率。本文将深入剖析 <strong>5 个鲜为人知但极其实用的 SpringBoot 技巧</strong>，帮助你从“会用”进阶到“精通”。</p>
<hr/>
<h3 data-id="heading-2">1. Lombok + @Builder.Default：优雅处理默认值</h3>
<h4 data-id="heading-3">问题场景</h4>
<p>在实体类或 DTO 中，我们经常需要为字段设置默认值。传统做法是在构造函数或 <code>@Data</code> 注解生成的 <code>setter</code> 方法中硬编码，但这会导致代码冗余且难以维护。</p>
<h4 data-id="heading-4">解决方案</h4>
<p>结合 Lombok 的 <code>@Builder</code> 和 <code>@Builder.Default</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-meta">@Builder</span>.Default
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ACTIVE"</span>;
    
    <span class="hljs-meta">@Builder</span>.Default
    <span class="hljs-keyword">private</span> <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">createdAt</span> <span class="hljs-operator">=</span> LocalDateTime.now();
}
</code></pre>
<ul>
<li><strong>优势</strong>：
<ol>
<li><strong>清晰直观</strong>：通过注解显式声明默认值。</li>
<li><strong>线程安全</strong>：每次构建对象时会重新计算默认值（如 <code>LocalDateTime.now()</code>）。</li>
<li><strong>与 Jackson 无缝集成</strong>：反序列化时自动应用默认值。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-5">注意事项</h4>
<ul>
<li>Lombok v1.18.4+ 版本支持此特性。</li>
<li>避免在 <code>@Builder.Default</code> 中使用可变对象（如 <code>List</code>），建议用不可变集合（如 <code>Collections.unmodifiableList</code>）。</li>
</ul>
<hr/>
<h3 data-id="heading-6">2. @ConfigurationProperties + Validation：强类型的配置管理</h3>
<h4 data-id="heading-7">问题场景</h4>
<p>SpringBoot 的 <code>application.properties</code>/<code>.yml</code> 通常通过 <code>@Value</code>注入，但这种方式缺乏类型安全和结构化验证。</p>
<h4 data-id="heading-8">解决方案</h4>
<p>使用 <code>@ConfigurationProperties</code> + JSR-303 Validation：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">app:</span>
   <span class="hljs-attr">max-retry:</span> <span class="hljs-number">3</span>
   <span class="hljs-attr">endpoints:</span>
     <span class="hljs-bullet">-</span> <span class="hljs-string">"/api/v1/users"</span>
     <span class="hljs-bullet">-</span> <span class="hljs-string">"/api/v1/products"</span>
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ConfigurationProperties(prefix = "app")</span>
<span class="hljs-meta">@Validated</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppConfig</span> {
    <span class="hljs-meta">@Min(1)</span> <span class="hljs-meta">@Max(10)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> maxRetry;
    
    <span class="hljs-meta">@NotEmpty</span>
    <span class="hljs-keyword">private</span> List&lt;String&gt; endpoints;
    
    <span class="hljs-comment">// Getters and Setters</span>
}
</code></pre>
<ul>
<li><strong>优势</strong>：
<ol>
<li><strong>类型安全</strong>：避免拼写错误和类型转换问题。</li>
<li><strong>自动补全支持</strong>：IDE（如 IntelliJ）能识别配置项。</li>
<li><strong>启动时验证</strong>：配置错误会直接抛出异常。</li>
</ol>
</li>
</ul>
<h4 data-id="heading-9">进阶技巧</h4>
<p>通过 <code>spring-boot-configuration-processor</code>生成元数据文件，实现配置提示：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-10">3. Spring DevTools + LiveReload：极速热部署</h3>
<h4 data-id="heading-11">Why DevTools?</h4>
<p>传统的重启式热部署（如 JRebel）需要付费或复杂配置。Spring DevTools是官方提供的免费方案：</p>
<ol>
<li><strong>快速重启</strong>：仅重载变更的类（比冷启动快5-10倍）。</li>
<li><strong>LiveReload集成</strong>：自动刷新浏览器（需安装LiveReload插件）。</li>
</ol>
<h4 data-id="heading-12">Hidden Features:</h4>
<ul>
<li><strong>排除静态资源重启</strong>：</li>
</ul>
<pre><code class="hljs language-properties" lang="properties">spring.devtools.restart.exclude=static/**
</code></pre>
<ul>
<li><strong>远程调试支持</strong>：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">mvn spring-boot:run -Dspring.devtools.restart.enabled=<span class="hljs-literal">true</span> 
</code></pre>
<h4 data-id="heading-13">Profiling结果对比：</h4>

















<table><thead><tr><th>Method</th><th>Avg Restart Time</th></tr></thead><tbody><tr><td>Cold Start</td><td>~8s</td></tr><tr><td>With DevTools</td><td>~1s</td></tr></tbody></table>
<hr/>
<p>###4 .自定义FailureAnalyzer ：让启动错误一目了然</p>
<p>当SpringBoot应用启动失败时,默认的错误日志可能晦涩难懂 。通过实现FailureAnalyzer接口,可以将底层异常转换为友好的错误提示 :</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBeanFailureAnalyzer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FailureAnalyzer</span> {
<span class="hljs-meta">@Override</span> 
<span class="hljs-keyword">public</span> FailureAnalysis <span class="hljs-title function_">analyze</span><span class="hljs-params">(Throwable failure)</span> { 
<span class="hljs-keyword">if</span> (failure <span class="hljs-keyword">instanceof</span> UnsatisfiedDependencyException ex) { 
<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FailureAnalysis</span>(
<span class="hljs-string">"Bean依赖注入失败: "</span>+ex.getInjectionPoint(),
<span class="hljs-string">"检查是否存在对应的Bean定义"</span>, 
failure); } <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; } }
</code></pre>
<p>注册到META-INF/spring.factories :</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">org.springframework.boot.diagnostics.FailureAnalyzer</span>=\ com.example.MyBeanFailureAnalyzer 
</code></pre>
<p>效果对比 :</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Before : NoSuchBeanDefinitionException ... 
After : [ACTION REQUIRED] Bean依赖注入失败: UserService.userDao → Check <span class="hljs-keyword">if</span> <span class="hljs-meta">@Repository</span> <span class="hljs-keyword">is</span> missing!
</code></pre>
<hr/>
<p>###5 .Smart Initialization ：优化启动性能</p>
<p>SpringBoot默认按顺序初始化所有Bean,导致启动慢 。通过以下方式优化 :</p>
<p>1 .懒加载特定Bean :</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Lazy</span> <span class="hljs-meta">@Service</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HeavyService</span> { ... } 
</code></pre>
<p>2 .分批初始化 (Spring Boot2.4+) :</p>
<pre><code class="hljs language-properties" lang="properties">spring.main.lazy-initialization=true #全局懒加载 spring.main.eager-init-beans[0]=criticalService #强制提前加载关键Bean 
</code></pre>
<p>3 .使用ApplicationRunner控制顺序 :</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Order(1)</span> <span class="hljs-meta">@Bean</span> <span class="hljs-keyword">public</span> ApplicationRunner <span class="hljs-title function_">initDB</span><span class="hljs-params">()</span> { .. } 

实测效果 (基于<span class="hljs-number">100</span>个Bean的项目 ):
| Configuration       | Startup Time |
|----------------------|--------------|
| Default              | ~12s         |
| Smart Initialization | ~6s          |
</code></pre>
<hr/>
<p>###总结</p>
<p>本文揭示的五个技巧覆盖了从编码 、配置到调试 、优化的完整链路 :</p>
<p>• Lombok的 Builder.Default →减少样板代码 • ConfigurationProperties →强化配置管理 • DevTools深度使用 →加速开发循环 • Custom FailureAnalyzer →提升可维护性 • Smart Initialization →优化运行时性能</p>
<p>掌握这些鲜为人知却至关重要的技术 ,你的SpringBoot开发效率将产生质的飞跃 。建议收藏本文并实践每一个案例 ,它们都来自真实项目的最佳实践 。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Jetpack Compose 从入门到精通（三）：状态管理 - 从原理到实践]]></title>    <link>https://juejin.cn/post/7600663744192069668</link>    <guid>https://juejin.cn/post/7600663744192069668</guid>    <pubDate>2026-01-29T11:34:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600663744192069668" data-draft-id="7600562816458653738" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Jetpack Compose 从入门到精通（三）：状态管理 - 从原理到实践"/> <meta itemprop="keywords" content="Kotlin,JetBrains,Android"/> <meta itemprop="datePublished" content="2026-01-29T11:34:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="邹阿涛涛涛涛涛涛涛涛"/> <meta itemprop="url" content="https://juejin.cn/user/3808364009106839"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Jetpack Compose 从入门到精通（三）：状态管理 - 从原理到实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808364009106839/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    邹阿涛涛涛涛涛涛涛涛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T11:34:11.000Z" title="Thu Jan 29 2026 11:34:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>深入理解 Compose 的状态系统：Slot Table 机制、重组原理、状态提升设计模式，以及企业级状态管理最佳实践。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">前言</h2>
<p>在前两篇中，我们掌握了 Compose 的布局系统。但一个完整的应用离不开状态管理：用户的点击、网络请求的结果、页面的切换...这些都需要状态来驱动 UI 更新。</p>
<p>Compose 的状态系统与传统 View 系统完全不同，它采用了<strong>响应式编程</strong>的思想：状态变化自动触发 UI 更新。这听起来很神奇，但背后有着精妙的设计。</p>
<p>本篇文章将带你深入理解：</p>
<ul>
<li>Compose 如何追踪状态变化？</li>
<li>重组（Recomposition）到底是什么？</li>
<li>为什么有时候状态更新了 UI 却没刷新？</li>
<li>如何设计优雅的状态管理架构？</li>
</ul>
<p>让我们开始这场深入源码的探索之旅！</p>
<hr/>
<h2 data-id="heading-1">一、状态与重组机制深度解析</h2>
<h3 data-id="heading-2">1.1 响应式编程的本质</h3>
<p>Compose 的核心理念是<strong>状态驱动 UI</strong>。当状态变化时，UI 会自动更新。这背后的关键机制就是<strong>重组（Recomposition）</strong>。</p>
<p><strong>传统 View 系统（命令式）</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 手动更新 UI</span>
button.setOnClickListener {
    count++
    textView.text = <span class="hljs-string">"Count: <span class="hljs-variable">$count</span>"</span>  <span class="hljs-comment">// 手动设置新值</span>
}
</code></pre>
<p><strong>Compose（声明式）</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Counter</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> count <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-number">0</span>) }
    
    Button(onClick = { count++ }) {
        Text(<span class="hljs-string">"Count: <span class="hljs-variable">$count</span>"</span>)  <span class="hljs-comment">// 自动更新</span>
    }
}
</code></pre>
<p><strong>关键区别</strong>：Compose 会自动追踪 <code>count</code> 的变化，当 <code>count</code> 改变时，自动重新执行 <code>Counter</code> 函数，更新 UI。</p>
<h3 data-id="heading-3">1.2 Slot Table：Compose 的"记忆"系统</h3>
<p>Compose 如何知道哪些 Composable 需要重组？答案就是 <strong>Slot Table</strong>。</p>
<h4 data-id="heading-4">1.2.1 为什么需要 Slot Table？</h4>
<p>想象这样一个场景：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Counter</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> count <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-number">0</span>) }
    
    Button(onClick = { count++ }) {
        Text(<span class="hljs-string">"Count: <span class="hljs-variable">$count</span>"</span>)
    }
}
</code></pre>
<p>当用户点击按钮，<code>count</code> 从 0 变成 1。此时 Compose 需要：</p>
<ol>
<li>知道 <code>count</code> 的新值是 1</li>
<li>知道哪些 Composable 读取了 <code>count</code></li>
<li>只更新那些 Composable</li>
</ol>
<p><strong>Slot Table 就是解决这个问题的核心机制</strong>。</p>
<h4 data-id="heading-5">1.2.2 Slot Table 是什么？</h4>
<p>Slot Table 是 Compose 运行时维护的一个<strong>线性数组</strong>，用于存储 Composable 函数的执行结果。你可以把它理解为 Compose 的"记忆系统"。</p>
<pre><code class="hljs language-vbnet" lang="vbnet">┌─────────────────────────────────────────────────────────────────┐
│                      Slot Table 结构                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  索引    类型          内容                                      │
│  ─────────────────────────────────────────────────────────────  │
│   <span class="hljs-number">0</span>      <span class="hljs-keyword">Group</span>        Counter (Composable 组)                   │
│   <span class="hljs-number">1</span>      Int          <span class="hljs-number">0</span> (remember 的 <span class="hljs-keyword">key</span>)                       │
│   <span class="hljs-number">2</span>      State        MutableState(value=<span class="hljs-number">0</span>)                     │
│   <span class="hljs-number">3</span>      <span class="hljs-keyword">Group</span>        Button                                    │
│   <span class="hljs-number">4</span>      Lambda       onClick = { count++ }                     │
│   <span class="hljs-number">5</span>      <span class="hljs-keyword">Group</span>        <span class="hljs-keyword">Text</span>                                      │
│   <span class="hljs-number">6</span>      <span class="hljs-type">String</span>       <span class="hljs-string">"Count: 0"</span>                                │
│   <span class="hljs-number">7</span>      EndGroup     <span class="hljs-keyword">Text</span> 结束                                 │
│   <span class="hljs-number">8</span>      EndGroup     Button 结束                               │
│   <span class="hljs-number">9</span>      EndGroup     Counter 结束                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>Slot Table 的三大作用</strong>：</p>
<ol>
<li><strong>记忆状态</strong>：保存 <code>remember</code>、<code>mutableStateOf</code> 等的状态，重组时不丢失</li>
<li><strong>追踪结构</strong>：记录 Composable 树的结构，知道哪个组件在哪里</li>
<li><strong>支持重组</strong>：通过对比新旧 Slot Table，确定哪些部分需要更新</li>
</ol>
<h4 data-id="heading-6">1.2.3 Slot Table 的源码实现</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// SlotTable 简化版源码（位于 androidx.compose.runtime 包）</span>
<span class="hljs-keyword">internal</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SlotTable</span> {
    <span class="hljs-comment">// 存储数据的数组，所有状态和对象都存在这里</span>
    <span class="hljs-keyword">val</span> slots = Array&lt;Any?&gt;(<span class="hljs-number">64</span>) { <span class="hljs-literal">null</span> }
    
    <span class="hljs-comment">// 当前写入位置</span>
    <span class="hljs-keyword">var</span> currentSlot = <span class="hljs-number">0</span>
    
    <span class="hljs-comment">// 组（Group）的栈，用于追踪嵌套的 Composable</span>
    <span class="hljs-keyword">val</span> groups = IntArray(<span class="hljs-number">64</span>)
    <span class="hljs-keyword">var</span> currentGroup = <span class="hljs-number">0</span>
    
    <span class="hljs-comment">// 写入数据到当前位置，然后移动到下一个</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">write</span><span class="hljs-params">(value: <span class="hljs-type">Any</span>?)</span></span> {
        slots[currentSlot++] = value
    }
    
    <span class="hljs-comment">// 读取当前位置的数据，然后移动到下一个</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">read</span><span class="hljs-params">()</span></span>: Any? = slots[currentSlot++]
    
    <span class="hljs-comment">// 开始一个组（Composable）</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startGroup</span><span class="hljs-params">(key: <span class="hljs-type">Int</span>)</span></span> {
        groups[currentGroup++] = currentSlot
        write(key)
    }
    
    <span class="hljs-comment">// 结束一个组</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">endGroup</span><span class="hljs-params">()</span></span> {
        currentGroup--
    }
}
</code></pre>
<h4 data-id="heading-7">1.2.4 Slot Table 如何工作？</h4>
<p>让我们通过一个完整例子理解：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Counter</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> count <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-number">0</span>) }
    
    Button(onClick = { count++ }) {
        Text(<span class="hljs-string">"Count: <span class="hljs-variable">$count</span>"</span>)
    }
}
</code></pre>
<p><strong>首次组合时</strong>：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-number">1</span>. 开始 Counter 组
   SlotTable<span class="hljs-selector-class">.startGroup</span>("Counter".hashCode())
   
<span class="hljs-number">2</span>. 执行 remember { <span class="hljs-built_in">mutableStateOf</span>(<span class="hljs-number">0</span>) }
   - 创建 MutableState 对象
   - 写入 SlotTable: <span class="hljs-built_in">write</span>(<span class="hljs-built_in">MutableState</span>(<span class="hljs-number">0</span>))
   
<span class="hljs-number">3</span>. 开始 Button 组
   SlotTable.<span class="hljs-built_in">startGroup</span>(<span class="hljs-string">"Button"</span>.<span class="hljs-built_in">hashCode</span>())
   
<span class="hljs-number">4</span>. 执行 <span class="hljs-built_in">Text</span>(<span class="hljs-string">"Count: $count"</span>)
   - 读取 count 的值: <span class="hljs-number">0</span>
   - 写入 SlotTable: <span class="hljs-built_in">write</span>(<span class="hljs-string">"Count: 0"</span>)
   
<span class="hljs-number">5</span>. 结束所有组
</code></pre>
<p><strong>重组时</strong>（用户点击后，count 变成 1）：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 开始 Counter 组
<span class="hljs-bullet">   -</span> 发现这个组已经存在
<span class="hljs-bullet">   -</span> 跳过已存在的内容，只对比变化
   
<span class="hljs-bullet">2.</span> 执行 remember
<span class="hljs-bullet">   -</span> 发现 remember 已经存在
<span class="hljs-bullet">   -</span> 直接返回缓存的 MutableState
   
<span class="hljs-bullet">3.</span> 执行 Text("Count: $count")
<span class="hljs-bullet">   -</span> 发现之前的值是 "Count: 0"
<span class="hljs-bullet">   -</span> 新的值是 "Count: 1"
<span class="hljs-bullet">   -</span> 值不同！需要更新
   
<span class="hljs-bullet">4.</span> 只更新 Text 组件
</code></pre>
<h3 data-id="heading-8">1.3 Composition 的生命周期</h3>
<p>Compose 的渲染过程分为三个阶段：</p>
<pre><code class="hljs language-sql" lang="sql">┌─────────────────────────────────────────────────────────────────┐
│                   Composition 生命周期                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   初始组合 (<span class="hljs-keyword">Initial</span> Composition)                                │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ <span class="hljs-number">1.</span> 执行 Composable 函数                                  │  │
│   │ <span class="hljs-number">2.</span> 填充 Slot <span class="hljs-keyword">Table</span>                                       │  │
│   │ <span class="hljs-number">3.</span> 创建 LayoutNode 树                                    │  │
│   │ <span class="hljs-number">4.</span> 测量、布局、绘制                                       │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              ↓                                  │
│   状态变化                                                      │
│                              ↓                                  │
│   重组 (Recomposition)                                          │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ <span class="hljs-number">1.</span> 检测到 State 变化                                     │  │
│   │ <span class="hljs-number">2.</span> 标记受影响的 Composable 为"过期"                      │  │
│   │ <span class="hljs-number">3.</span> 重新执行过期的 Composable                             │  │
│   │ <span class="hljs-number">4.</span> 对比新旧 Slot <span class="hljs-keyword">Table</span>                                   │  │
│   │ <span class="hljs-number">5.</span> 只更新变化的部分                                      │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              ↓                                  │
│   布局与绘制 (Layout <span class="hljs-operator">&amp;</span> Draw)                                    │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ <span class="hljs-number">1.</span> 测量受影响的节点                                       │  │
│   │ <span class="hljs-number">2.</span> 布局受影响的节点                                       │  │
│   │ <span class="hljs-number">3.</span> 绘制受影响的区域                                       │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-9">1.4 重组的触发机制</h3>
<h4 data-id="heading-10">1.4.1 State 变化如何触发重组？</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// mutableStateOf 的简化实现</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">mutableStateOf</span><span class="hljs-params">(value: <span class="hljs-type">T</span>)</span></span>: MutableState&lt;T&gt; =
    SnapshotMutableStateImpl(value)

<span class="hljs-comment">// SnapshotMutableStateImpl 简化版</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SnapshotMutableStateImpl</span>&lt;<span class="hljs-type">T</span>&gt;(initial: T) : MutableState&lt;T&gt; {
    <span class="hljs-meta">@Suppress(<span class="hljs-string">"UNCHECKED_CAST"</span>)</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">var</span> value: T
        <span class="hljs-keyword">get</span>() = next.readable(<span class="hljs-keyword">this</span>).value
        <span class="hljs-keyword">set</span>(value) = next.withCurrent {
            <span class="hljs-keyword">if</span> (it.value != value) {
                <span class="hljs-comment">// 1. 创建新的 State 记录</span>
                next = it.newStateRecord(value)
                <span class="hljs-comment">// 2. 通知观察者</span>
                notifyObservers()
            }
        }
}
</code></pre>
<p><strong>触发流程</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">1. 用户点击按钮
        ↓
2. count++ 执行
        ↓
<span class="hljs-attr">3. MutableState.value</span> = newValue
        ↓
4. 创建新的 Snapshot 记录
        ↓
5. 通知所有读取过该 State 的 Composable
        ↓
6. 将这些 Composable 标记为"需要重组"
        ↓
7. 在下一帧，执行重组
</code></pre>
<h4 data-id="heading-11">1.4.2 重组的范围控制</h4>
<p>Compose 会尽量缩小重组的范围：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Parent</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> count <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-number">0</span>) }
    
    Column {
        <span class="hljs-comment">// 这个 Text 会重组，因为它读取了 count</span>
        Text(<span class="hljs-string">"Count: <span class="hljs-variable">$count</span>"</span>)
        
        <span class="hljs-comment">// 这个 Button 不会重组，因为它没有读取 count</span>
        Button(onClick = { count++ }) {
            Text(<span class="hljs-string">"Increment"</span>)
        }
        
        <span class="hljs-comment">// Child 会重组吗？取决于它是否读取了 count</span>
        Child(count)
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Child</span><span class="hljs-params">(count: <span class="hljs-type">Int</span>)</span></span> {
    <span class="hljs-comment">// 如果这里使用了 count，就会重组</span>
    Text(<span class="hljs-string">"Child: <span class="hljs-variable">$count</span>"</span>)
}
</code></pre>
<p><strong>重组范围规则</strong>：</p>
<ul>
<li>只有<strong>读取了变化 State</strong> 的 Composable 才会重组</li>
<li>重组会<strong>向下传播</strong>到所有子 Composable</li>
<li>可以通过<strong>参数传递</strong>控制重组范围</li>
</ul>
<h3 data-id="heading-12">1.5 重组的优化策略</h3>
<h4 data-id="heading-13">1.5.1 @Stable 与 @Immutable</h4>
<p>Compose 使用 <strong>稳定性（Stability）</strong> 来判断对象变化时是否需要重组：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 不稳定类 - 任何变化都会触发重组</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UnstableUser</span> {
    <span class="hljs-keyword">var</span> name: String = <span class="hljs-string">""</span>
    <span class="hljs-keyword">var</span> age: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
}

<span class="hljs-comment">// 稳定类 - 只有属性变化时触发重组</span>
<span class="hljs-meta">@Stable</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">StableUser</span> {
    <span class="hljs-keyword">var</span> name: String = <span class="hljs-string">""</span>
    <span class="hljs-keyword">var</span> age: <span class="hljs-built_in">Int</span> = <span class="hljs-number">0</span>
}

<span class="hljs-comment">// 不可变类 - 实例替换时触发重组</span>
<span class="hljs-meta">@Immutable</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ImmutableUser</span>(
    <span class="hljs-keyword">val</span> name: String,
    <span class="hljs-keyword">val</span> age: <span class="hljs-built_in">Int</span>
)
</code></pre>
<p><strong>稳定性对比</strong>：</p>

























<table><thead><tr><th>注解</th><th>说明</th><th>触发重组条件</th></tr></thead><tbody><tr><td>无</td><td>不稳定</td><td>任何情况都可能重组</td></tr><tr><td>@Stable</td><td>稳定</td><td>属性变化时重组</td></tr><tr><td>@Immutable</td><td>不可变</td><td>实例替换时重组</td></tr></tbody></table>
<h4 data-id="heading-14">1.5.2 remember 的妙用</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ExpensiveCalculation</span><span class="hljs-params">(<span class="hljs-keyword">data</span>: <span class="hljs-type">List</span>&lt;<span class="hljs-type">Int</span>&gt;)</span></span> {
    <span class="hljs-comment">// ❌ 错误：每次重组都重新计算</span>
    <span class="hljs-keyword">val</span> sum = <span class="hljs-keyword">data</span>.sum()
    
    <span class="hljs-comment">// ✅ 正确：只在 data 变化时计算</span>
    <span class="hljs-keyword">val</span> sum = remember(<span class="hljs-keyword">data</span>) { <span class="hljs-keyword">data</span>.sum() }
    
    Text(<span class="hljs-string">"Sum: <span class="hljs-variable">$sum</span>"</span>)
}
</code></pre>
<h4 data-id="heading-15">1.5.3 derivedStateOf：派生状态</h4>
<p>当状态变化频繁，但 UI 不需要每次都更新时，使用 <code>derivedStateOf</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">SearchList</span><span class="hljs-params">(query: <span class="hljs-type">String</span>, items: <span class="hljs-type">List</span>&lt;<span class="hljs-type">Item</span>&gt;)</span></span> {
    <span class="hljs-comment">// ❌ 错误：每次 query 变化都过滤整个列表</span>
    <span class="hljs-keyword">val</span> filtered = items.filter { it.name.contains(query) }
    
    <span class="hljs-comment">// ✅ 正确：只在必要时更新</span>
    <span class="hljs-keyword">val</span> filtered <span class="hljs-keyword">by</span> remember {
        derivedStateOf {
            items.filter { it.name.contains(query) }
        }
    }
    
    LazyColumn {
        items(filtered) { item -&gt;
            ItemRow(item)
        }
    }
}
</code></pre>
<p><strong>derivedStateOf 的原理</strong>：</p>
<ul>
<li>内部维护一个缓存值</li>
<li>只有读取时才会重新计算</li>
<li>计算结果变化时才通知观察者</li>
</ul>
<hr/>
<h2 data-id="heading-16">二、remember 与 mutableStateOf 源码解析</h2>
<h3 data-id="heading-17">2.1 remember 的原理</h3>
<p><code>remember</code> 是 Compose 中用于<strong>缓存计算结果</strong>的函数。它的核心作用是：在重组时保持状态不变。</p>
<h4 data-id="heading-18">2.1.1 为什么需要 remember？</h4>
<p>看一个例子：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Counter</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> count = <span class="hljs-number">0</span>  <span class="hljs-comment">// ❌ 错误：每次重组都会重置为 0</span>
    
    Button(onClick = { count++ }) {
        Text(<span class="hljs-string">"Count: <span class="hljs-variable">$count</span>"</span>)
    }
}
</code></pre>
<p>每次用户点击按钮，触发重组，<code>count</code> 都会被重新初始化为 0。这是因为我们没有"记住"这个值。</p>
<p><strong>remember 的作用</strong>：在首次组合时计算值，并在后续重组时返回缓存的值。</p>
<h4 data-id="heading-19">2.1.2 remember 的源码实现</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// remember 的简化实现</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">remember</span><span class="hljs-params">(
    <span class="hljs-keyword">vararg</span> keys: <span class="hljs-type">Any</span>?,  <span class="hljs-comment">// 缓存的 key</span>
    calculation: () -&gt; <span class="hljs-type">T</span>  <span class="hljs-comment">// 计算函数</span>
)</span></span>: T {
    <span class="hljs-comment">// 获取当前 Composer</span>
    <span class="hljs-keyword">val</span> composer = currentComposer
    
    <span class="hljs-comment">// 在 Slot Table 中查找缓存</span>
    <span class="hljs-keyword">val</span> slot = composer.nextSlot()
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (slot === Composer.Empty || 
               keys.any { it != composer.rememberedValue() }) {
        <span class="hljs-comment">// 缓存不存在或 key 变化，重新计算</span>
        <span class="hljs-keyword">val</span> value = calculation()
        composer.updateRememberedValue(value)
        value
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 使用缓存</span>
        <span class="hljs-meta">@Suppress(<span class="hljs-string">"UNCHECKED_CAST"</span>)</span>
        slot <span class="hljs-keyword">as</span> T
    }
}
</code></pre>
<p><strong>执行流程</strong>：</p>
<pre><code class="hljs language-css" lang="css">┌─────────────────────────────────────────────────────────────────┐
│                      remember 执行流程                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  第一次组合                                                      │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ <span class="hljs-number">1</span>. 读取 Slot <span class="hljs-selector-tag">Table</span> → 得到 Composer<span class="hljs-selector-class">.Empty</span>               │   │
│  │ <span class="hljs-number">2</span>. 执行 calculation()                                   │   │
│  │ <span class="hljs-number">3</span>. 将结果写入 Slot <span class="hljs-selector-tag">Table</span>                                │   │
│  │ <span class="hljs-number">4</span>. 返回结果                                             │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              ↓                                  │
│  重组（key 未变化）                                              │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ <span class="hljs-number">1</span>. 读取 Slot <span class="hljs-selector-tag">Table</span> → 得到缓存值                         │   │
│  │ <span class="hljs-number">2</span>. 对比 keys → 没有变化                                 │   │
│  │ <span class="hljs-number">3</span>. 直接返回缓存值（跳过了 calculation）                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              ↓                                  │
│  重组（key 变化）                                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ <span class="hljs-number">1</span>. 读取 Slot <span class="hljs-selector-tag">Table</span> → 得到缓存值                         │   │
│  │ <span class="hljs-number">2</span>. 对比 keys → 有变化                                   │   │
│  │ <span class="hljs-number">3</span>. 执行 calculation()                                   │   │
│  │ <span class="hljs-number">4</span>. 更新 Slot <span class="hljs-selector-tag">Table</span>                                      │   │
│  │ <span class="hljs-number">5</span>. 返回新结果                                           │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-20">2.1.3 remember 的多种用法</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 无 key - 永远使用缓存</span>
<span class="hljs-keyword">val</span> value = remember { expensiveCalculation() }

<span class="hljs-comment">// 2. 有 key - key 变化时重新计算</span>
<span class="hljs-keyword">val</span> value = remember(userId) { loadUser(userId) }

<span class="hljs-comment">// 3. 多个 key - 任一 key 变化都重新计算</span>
<span class="hljs-keyword">val</span> value = remember(userId, refreshFlag) { loadUser(userId) }

<span class="hljs-comment">// 4. rememberSaveable - 配置变更后恢复</span>
<span class="hljs-keyword">val</span> value = rememberSaveable { mutableStateOf(<span class="hljs-number">0</span>) }
</code></pre>
<h3 data-id="heading-21">2.2 mutableStateOf 的原理</h3>
<p><code>mutableStateOf</code> 创建了一个<strong>可观察的状态对象</strong>，当值变化时会自动触发重组。</p>
<h4 data-id="heading-22">2.2.1 mutableStateOf 的源码实现</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// mutableStateOf 实现</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> <span class="hljs-title">mutableStateOf</span><span class="hljs-params">(
    value: <span class="hljs-type">T</span>,
    policy: <span class="hljs-type">SnapshotMutationPolicy</span>&lt;<span class="hljs-type">T</span>&gt; = structuralEqualityPolicy()</span></span>
): MutableState&lt;T&gt; = createSnapshotMutableState(value, policy)

<span class="hljs-comment">// SnapshotMutableStateImpl 简化版</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SnapshotMutableStateImpl</span>&lt;<span class="hljs-type">T</span>&gt;(
    initial: T,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> policy: SnapshotMutationPolicy&lt;T&gt;
) : MutableState&lt;T&gt; {
    
    <span class="hljs-meta">@Suppress(<span class="hljs-string">"UNCHECKED_CAST"</span>)</span>
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">var</span> value: T
        <span class="hljs-keyword">get</span>() = next.readable(<span class="hljs-keyword">this</span>).value
        <span class="hljs-keyword">set</span>(value) = next.withCurrent {
            <span class="hljs-comment">// 使用 policy 判断是否相等</span>
            <span class="hljs-keyword">if</span> (!policy.equivalent(it.value, value)) {
                <span class="hljs-comment">// 创建新的 State 记录</span>
                next = it.newStateRecord(value)
            }
        }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">component1</span><span class="hljs-params">()</span></span>: T = value
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">component2</span><span class="hljs-params">()</span></span>: (T) -&gt; <span class="hljs-built_in">Unit</span> = { value = it }
}
</code></pre>
<h4 data-id="heading-23">2.2.2 Snapshot 机制</h4>
<p>Compose 的 State 基于 <strong>Snapshot（快照）</strong> 机制实现：</p>
<pre><code class="hljs language-ini" lang="ini">┌─────────────────────────────────────────────────────────────────┐
│                      Snapshot 机制                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Snapshot 1 (当前)                                             │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │  StateRecord 1: <span class="hljs-attr">value</span> = <span class="hljs-string">"A"</span>                             │  │
│   │  StateRecord 2: <span class="hljs-attr">value</span> = <span class="hljs-string">"B"</span>  ← 当前值                   │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              ↓                                  │
│   <span class="hljs-attr">value</span> = <span class="hljs-string">"C"</span> (修改)                                            │
│                              ↓                                  │
│   Snapshot 2 (新快照)                                           │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │  StateRecord 1: <span class="hljs-attr">value</span> = <span class="hljs-string">"A"</span>                             │  │
│   │  StateRecord 2: <span class="hljs-attr">value</span> = <span class="hljs-string">"B"</span>                             │  │
│   │  StateRecord 3: <span class="hljs-attr">value</span> = <span class="hljs-string">"C"</span>  ← 新记录                   │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              ↓                                  │
│   通知观察者：值从 "B" 变为 "C"                                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>Snapshot 的优势</strong>：</p>
<ul>
<li><strong>原子性</strong>：多个 State 的修改要么全部生效，要么全部不生效</li>
<li><strong>一致性</strong>：读取时看到的是一致的快照</li>
<li><strong>可回滚</strong>：可以丢弃未提交的修改</li>
</ul>
<h4 data-id="heading-24">2.2.3 状态比较策略</h4>
<p><code>mutableStateOf</code> 支持三种比较策略：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 结构相等（默认）- 使用 == 比较</span>
<span class="hljs-keyword">val</span> state = mutableStateOf(listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>))
state.value = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)  <span class="hljs-comment">// 不会触发重组，因为内容相等</span>

<span class="hljs-comment">// 2. 引用相等 - 使用 === 比较</span>
<span class="hljs-keyword">val</span> state = mutableStateOf(listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>), policy = referentialEqualityPolicy())
state.value = listOf(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)  <span class="hljs-comment">// 会触发重组，因为是新对象</span>

<span class="hljs-comment">// 3. 永不比较 - 总是认为不同</span>
<span class="hljs-keyword">val</span> state = mutableStateOf(<span class="hljs-number">0</span>, policy = neverEqualPolicy())
state.value = <span class="hljs-number">0</span>  <span class="hljs-comment">// 会触发重组</span>
</code></pre>
<h3 data-id="heading-25">2.3 rememberSaveable 的原理</h3>
<p><code>rememberSaveable</code> 可以在<strong>配置变更</strong>（如屏幕旋转）后恢复状态。</p>
<h4 data-id="heading-26">2.3.1 为什么需要 rememberSaveable？</h4>
<p>看一个场景：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">FormScreen</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> name <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">""</span>) }
    <span class="hljs-keyword">var</span> email <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">""</span>) }
    
    <span class="hljs-comment">// 用户填写了表单...</span>
    
    <span class="hljs-comment">// 旋转屏幕后，name 和 email 都变成空字符串了！</span>
    <span class="hljs-comment">// 因为 Activity 重建，remember 的缓存丢失了</span>
}
</code></pre>
<p><strong>rememberSaveable 的作用</strong>：将状态保存到 Bundle，配置变更后自动恢复。</p>
<h4 data-id="heading-27">2.3.2 实现原理</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-keyword">inline</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T : Any&gt;</span> <span class="hljs-title">rememberSaveable</span><span class="hljs-params">(
    <span class="hljs-keyword">vararg</span> inputs: <span class="hljs-type">Any</span>?,
    saver: <span class="hljs-type">Saver</span>&lt;<span class="hljs-type">T</span>, <span class="hljs-keyword">out</span> Any&gt; = autoSaver()</span></span>,
    key: String? = <span class="hljs-literal">null</span>,
    <span class="hljs-keyword">init</span>: () -&gt; T
): T {
    <span class="hljs-comment">// 组合本地提供的 SaveableStateRegistry</span>
    <span class="hljs-keyword">val</span> registry = LocalSaveableStateRegistry.current
    
    <span class="hljs-comment">// 生成唯一 key</span>
    <span class="hljs-keyword">val</span> finalKey = key ?: rememberSaveableKey()
    
    <span class="hljs-comment">// 尝试从 Bundle 恢复</span>
    <span class="hljs-keyword">val</span> restored = registry?.consumeRestored(finalKey)
    
    <span class="hljs-comment">// 创建或恢复状态</span>
    <span class="hljs-keyword">val</span> value = remember(*inputs) {
        restored?.let { saver.restore(it) } ?: <span class="hljs-keyword">init</span>()
    }
    
    <span class="hljs-comment">// 注册保存回调</span>
    <span class="hljs-keyword">if</span> (registry != <span class="hljs-literal">null</span>) {
        DisposableEffect(registry, finalKey, saver) {
            <span class="hljs-keyword">val</span> entry = registry.registerProvider(finalKey) {
                saver.save(value)
            }
            onDispose { entry.unregister() }
        }
    }
    
    <span class="hljs-keyword">return</span> value
}
</code></pre>
<p><strong>保存与恢复流程</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────────┐
│                  rememberSaveable 流程                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   首次创建                                                       │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ <span class="hljs-number">1</span>. 检查 Bundle 中没有该 key 的保存值                     │  │
│   │ <span class="hljs-number">2</span>. 执行 <span class="hljs-built_in">init</span>() 创建初始值                               │  │
│   │ <span class="hljs-number">3</span>. 注册保存回调到 SaveableStateRegistry                 │  │
│   │ <span class="hljs-number">4</span>. 返回初始值                                           │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              ↓                                  │
│   配置变更（如旋转屏幕）                                         │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ <span class="hljs-number">1</span>. Activity 被销毁，触发 onSaveInstanceState            │  │
│   │ <span class="hljs-number">2</span>. SaveableStateRegistry 调用所有注册的保存回调          │  │
│   │ <span class="hljs-number">3</span>. 将值序列化保存到 Bundle                               │  │
│   │ <span class="hljs-number">4</span>. Activity 重建                                         │  │
│   │ <span class="hljs-number">5</span>. 从 Bundle 恢复值                                      │  │
│   │ <span class="hljs-number">6</span>. rememberSaveable 读取恢复的值                         │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-28">2.3.3 自定义 Saver</h4>
<p><strong>什么是 Saver？</strong></p>
<p>Saver 是 rememberSaveable 用来<strong>序列化和反序列化状态</strong>的工具。因为 Bundle 只能存储特定类型的数据，我们需要告诉 Compose 如何将自定义对象转换为 Bundle 可存储的格式。</p>
<p><strong>为什么需要自定义 Saver？</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 假设我们有一个自定义类</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(
    <span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Int</span>,
    <span class="hljs-keyword">val</span> name: String,
    <span class="hljs-keyword">val</span> email: String
)

<span class="hljs-comment">// ❌ 错误：直接 rememberSaveable 会崩溃</span>
<span class="hljs-keyword">var</span> user <span class="hljs-keyword">by</span> rememberSaveable { mutableStateOf(User(<span class="hljs-number">1</span>, <span class="hljs-string">"张三"</span>, <span class="hljs-string">"zhangsan@example.com"</span>)) }
<span class="hljs-comment">// 崩溃原因：User 类不知道如何保存到 Bundle</span>
</code></pre>
<p><strong>自定义 Saver 示例</strong>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 为自定义类创建 Saver</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> name: String, <span class="hljs-keyword">val</span> email: String)

<span class="hljs-keyword">val</span> UserSaver = Saver&lt;User, Bundle&gt;(
    <span class="hljs-comment">// save: 将 User 转换为 Bundle</span>
    save = { user -&gt;
        Bundle().apply {
            putInt(<span class="hljs-string">"id"</span>, user.id)
            putString(<span class="hljs-string">"name"</span>, user.name)
            putString(<span class="hljs-string">"email"</span>, user.email)
        }
    },
    <span class="hljs-comment">// restore: 从 Bundle 恢复 User</span>
    restore = { bundle -&gt;
        User(
            id = bundle.getInt(<span class="hljs-string">"id"</span>),
            name = bundle.getString(<span class="hljs-string">"name"</span>) ?: <span class="hljs-string">""</span>,
            email = bundle.getString(<span class="hljs-string">"email"</span>) ?: <span class="hljs-string">""</span>
        )
    }
)

<span class="hljs-comment">// 使用自定义 Saver</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserScreen</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> user <span class="hljs-keyword">by</span> rememberSaveable(saver = UserSaver) {
        mutableStateOf(User(<span class="hljs-number">1</span>, <span class="hljs-string">"张三"</span>, <span class="hljs-string">"zhangsan@example.com"</span>))
    }
    
    <span class="hljs-comment">// 现在旋转屏幕后，user 的值会被正确恢复</span>
    Text(<span class="hljs-string">"Name: <span class="hljs-subst">${user.name}</span>"</span>)
}
</code></pre>
<p><strong>Saver 生效机制</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────────┐
│                    Saver 生效流程                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  保存时                                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ <span class="hljs-number">1</span>. rememberSaveable 检测到配置变更                       │   │
│  │ <span class="hljs-number">2</span>. 调用 Saver<span class="hljs-selector-class">.save</span>(value)                                │   │
│  │ <span class="hljs-number">3</span>. 返回 Bundle/Parcelable/List 等可序列化类型            │   │
│  │ <span class="hljs-number">4</span>. 系统自动保存到 Activity 的 Bundle                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              ↓                                  │
│  恢复时                                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ <span class="hljs-number">1</span>. Activity 重建，从 Bundle 读取保存的数据               │   │
│  │ <span class="hljs-number">2</span>. rememberSaveable 调用 Saver<span class="hljs-selector-class">.restore</span>(savedData)        │   │
│  │ <span class="hljs-number">3</span>. 返回恢复后的对象                                        │   │
│  │ <span class="hljs-number">4</span>. 赋值给状态变量                                          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>适合使用自定义 Saver 的场景</strong>：</p>
<ol>
<li><strong>表单数据</strong>：用户填写的表单，旋转屏幕后需要保留</li>
<li><strong>滚动位置</strong>：列表的滚动位置</li>
<li><strong>用户偏好</strong>：当前选中的选项、开关状态</li>
<li><strong>临时数据</strong>：未提交的编辑内容</li>
</ol>
<p><strong>不适合使用 Saver 的场景</strong>：</p>
<ol>
<li><strong>大量数据</strong>：Bundle 有大小限制（约 1MB）</li>
<li><strong>敏感数据</strong>：Bundle 数据可以被读取</li>
<li><strong>不需要持久化的数据</strong>：如网络请求结果</li>
</ol>
<hr/>
<h2 data-id="heading-29">三、状态提升（State Hoisting）设计模式</h2>
<h3 data-id="heading-30">3.1 什么是状态提升？</h3>
<p><strong>状态提升</strong>是 Compose 推荐的状态管理模式：将状态从子组件"提升"到父组件，子组件通过参数接收状态，通过回调通知状态变化。</p>
<p><strong>为什么叫"提升"？</strong></p>
<p>想象一个组件树：</p>
<pre><code class="hljs">Parent
├── ChildA
│   └── GrandChild
└── ChildB
</code></pre>
<p>如果 <code>GrandChild</code> 需要修改状态，而这个状态需要影响 <code>ChildB</code>，那么状态就需要"提升"到它们的共同祖先 <code>Parent</code>。</p>
<h3 data-id="heading-31">3.2 状态提升的设计原则</h3>
<p><strong>单一数据源</strong>：状态只在一个地方定义
<strong>状态向下流动</strong>：通过参数传递给子组件
<strong>事件向上传递</strong>：通过回调通知父组件修改状态</p>
<h3 data-id="heading-32">3.3 状态提升的示例</h3>
<h4 data-id="heading-33">3.3.1 无状态提升（问题代码）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误：状态分散在各个组件中</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CounterScreen</span><span class="hljs-params">()</span></span> {
    Column {
        Counter()  <span class="hljs-comment">// 每个 Counter 有自己的状态</span>
        Counter()
        Counter()
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Counter</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> count <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-number">0</span>) }  <span class="hljs-comment">// 状态在子组件中</span>
    
    Button(onClick = { count++ }) {
        Text(<span class="hljs-string">"Count: <span class="hljs-variable">$count</span>"</span>)
    }
}
</code></pre>
<p><strong>问题</strong>：</p>
<ul>
<li>无法同步多个 Counter 的状态</li>
<li>父组件无法获取/修改子组件的状态</li>
<li>状态分散，难以管理</li>
</ul>
<h4 data-id="heading-34">3.3.2 有状态提升（正确代码）</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 正确：状态提升到父组件</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CounterScreen</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> counts <span class="hljs-keyword">by</span> remember { mutableStateOf(List(<span class="hljs-number">3</span>) { <span class="hljs-number">0</span> }) }
    
    Column {
        counts.forEachIndexed { index, count -&gt;
            Counter(
                count = count,
                onIncrement = {
                    counts = counts.toMutableList().apply {
                        <span class="hljs-keyword">this</span>[index]++
                    }
                }
            )
        }
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Counter</span><span class="hljs-params">(
    count: <span class="hljs-type">Int</span>,                    <span class="hljs-comment">// 状态通过参数传入</span>
    onIncrement: () -&gt; <span class="hljs-type">Unit</span>        <span class="hljs-comment">// 事件通过回调传出</span>
)</span></span> {
    Button(onClick = onIncrement) {
        Text(<span class="hljs-string">"Count: <span class="hljs-variable">$count</span>"</span>)
    }
}
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>状态集中管理</li>
<li>子组件可复用</li>
<li>易于测试</li>
</ul>
<h3 data-id="heading-35">3.4 状态提升的设计模式</h3>
<h4 data-id="heading-36">3.4.1 状态容器模式</h4>
<p>对于复杂的状态，可以创建专门的状态容器类：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 状态容器</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CounterState</span> {
    <span class="hljs-keyword">var</span> count <span class="hljs-keyword">by</span> mutableStateOf(<span class="hljs-number">0</span>)
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">set</span>
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">increment</span><span class="hljs-params">()</span></span> {
        count++
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">decrement</span><span class="hljs-params">()</span></span> {
        count--
    }
}

<span class="hljs-comment">// 使用 remember 创建状态容器</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">rememberCounterState</span><span class="hljs-params">()</span></span> = remember { CounterState() }

<span class="hljs-comment">// 使用</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CounterScreen</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> state = rememberCounterState()
    
    Counter(
        count = state.count,
        onIncrement = { state.increment() }
    )
}
</code></pre>
<h4 data-id="heading-37">3.4.2 屏幕级状态管理</h4>
<p>对于整个屏幕的状态，可以在屏幕级 Composable 中统一管理：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserProfileScreen</span><span class="hljs-params">(
    userId: <span class="hljs-type">String</span>,
    viewModel: <span class="hljs-type">UserProfileViewModel</span> = hiltViewModel()</span></span>
) {
    <span class="hljs-comment">// 收集 ViewModel 的状态</span>
    <span class="hljs-keyword">val</span> uiState <span class="hljs-keyword">by</span> viewModel.uiState.collectAsState()
    
    <span class="hljs-comment">// 屏幕级状态管理</span>
    <span class="hljs-keyword">var</span> isEditing <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-literal">false</span>) }
    <span class="hljs-keyword">var</span> editedName <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">""</span>) }
    
    <span class="hljs-keyword">when</span> (<span class="hljs-keyword">val</span> state = uiState) {
        <span class="hljs-keyword">is</span> UiState.Loading -&gt; LoadingScreen()
        <span class="hljs-keyword">is</span> UiState.Error -&gt; ErrorScreen(state.message)
        <span class="hljs-keyword">is</span> UiState.Success -&gt; {
            UserProfileContent(
                user = state.<span class="hljs-keyword">data</span>,
                isEditing = isEditing,
                editedName = editedName,
                onEditClick = { 
                    isEditing = <span class="hljs-literal">true</span>
                    editedName = state.<span class="hljs-keyword">data</span>.name
                },
                onNameChange = { editedName = it },
                onSaveClick = {
                    viewModel.updateName(editedName)
                    isEditing = <span class="hljs-literal">false</span>
                }
            )
        }
    }
}
</code></pre>
<h3 data-id="heading-38">3.5 状态提升的边界</h3>
<p>不是所有状态都需要提升，需要根据场景判断：</p>





















<table><thead><tr><th>状态位置</th><th>适用场景</th></tr></thead><tbody><tr><td>子组件内部</td><td>纯 UI 状态（如动画状态、滚动位置）</td></tr><tr><td>父组件</td><td>需要共享的状态、需要持久化的状态</td></tr><tr><td>ViewModel</td><td>业务逻辑状态、需要跨屏幕共享的状态</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-39">四、ViewModel 与 Compose 最佳实践</h2>
<h3 data-id="heading-40">4.1 ViewModel 的作用</h3>
<p>ViewModel 是 Android 架构组件，用于：</p>
<ul>
<li><strong>保存配置变更后的状态</strong></li>
<li><strong>管理业务逻辑</strong></li>
<li><strong>作为 UI 层和数据层的桥梁</strong></li>
</ul>
<h3 data-id="heading-41">4.2 ViewModel 与 Compose 的集成</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ViewModel 定义</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserViewModel</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> userRepository: UserRepository
) : ViewModel() {
    
    <span class="hljs-comment">// 使用 StateFlow 管理状态</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _uiState = MutableStateFlow&lt;UiState&lt;User&gt;&gt;(UiState.Loading)
    <span class="hljs-keyword">val</span> uiState: StateFlow&lt;UiState&lt;User&gt;&gt; = _uiState.asStateFlow()
    
    <span class="hljs-keyword">init</span> {
        loadUser()
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadUser</span><span class="hljs-params">()</span></span> {
        viewModelScope.launch {
            _uiState.value = UiState.Loading
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">val</span> user = userRepository.getUser()
                _uiState.value = UiState.Success(user)
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                _uiState.value = UiState.Error(e.message ?: <span class="hljs-string">"Unknown error"</span>)
            }
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">refresh</span><span class="hljs-params">()</span></span> {
        loadUser()
    }
}

<span class="hljs-comment">// Composable 中使用</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserScreen</span><span class="hljs-params">(
    viewModel: <span class="hljs-type">UserViewModel</span> = hiltViewModel()</span></span>
) {
    <span class="hljs-keyword">val</span> uiState <span class="hljs-keyword">by</span> viewModel.uiState.collectAsState()
    
    <span class="hljs-keyword">when</span> (<span class="hljs-keyword">val</span> state = uiState) {
        <span class="hljs-keyword">is</span> UiState.Loading -&gt; LoadingScreen()
        <span class="hljs-keyword">is</span> UiState.Error -&gt; ErrorScreen(
            message = state.message,
            onRetry = { viewModel.refresh() }
        )
        <span class="hljs-keyword">is</span> UiState.Success -&gt; UserContent(user = state.<span class="hljs-keyword">data</span>)
    }
}
</code></pre>
<h3 data-id="heading-42">4.3 StateFlow vs LiveData</h3>
<p>在 Compose 中，推荐使用 <strong>StateFlow</strong>：</p>






























<table><thead><tr><th>特性</th><th>StateFlow</th><th>LiveData</th></tr></thead><tbody><tr><td>生命周期感知</td><td>需要配合 <code>collectAsState</code></td><td>自动感知</td></tr><tr><td>初始值</td><td>必须有</td><td>可以没有</td></tr><tr><td>线程安全</td><td>是</td><td>是</td></tr><tr><td>与 Compose 集成</td><td>更自然</td><td>需要额外转换</td></tr></tbody></table>
<h3 data-id="heading-43">4.4 UI 状态设计最佳实践</h3>
<h4 data-id="heading-44">4.4.1 单一状态类</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 推荐：使用单一状态类</span>
<span class="hljs-keyword">sealed</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserUiState</span> {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">object</span> Loading : UserUiState
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>(<span class="hljs-keyword">val</span> user: User) : UserUiState
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span>(<span class="hljs-keyword">val</span> message: String) : UserUiState
}

<span class="hljs-comment">// ❌ 不推荐：分散的状态</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    <span class="hljs-keyword">val</span> isLoading = MutableStateFlow(<span class="hljs-literal">false</span>)
    <span class="hljs-keyword">val</span> user = MutableStateFlow&lt;User?&gt;(<span class="hljs-literal">null</span>)
    <span class="hljs-keyword">val</span> error = MutableStateFlow&lt;String?&gt;(<span class="hljs-literal">null</span>)
}
</code></pre>
<h4 data-id="heading-45">4.4.2 不可变状态</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 推荐：状态不可变，通过 copy 更新</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserUiState</span>(
    <span class="hljs-keyword">val</span> isLoading: <span class="hljs-built_in">Boolean</span> = <span class="hljs-literal">false</span>,
    <span class="hljs-keyword">val</span> user: User? = <span class="hljs-literal">null</span>,
    <span class="hljs-keyword">val</span> error: String? = <span class="hljs-literal">null</span>
)

<span class="hljs-comment">// ViewModel 中</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _uiState = MutableStateFlow(UserUiState())
<span class="hljs-keyword">val</span> uiState = _uiState.asStateFlow()

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateUser</span><span class="hljs-params">(user: <span class="hljs-type">User</span>)</span></span> {
    _uiState.update { it.copy(user = user, isLoading = <span class="hljs-literal">false</span>) }
}
</code></pre>
<h3 data-id="heading-46">4.5 ViewModel 的生命周期</h3>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────────┐
│                    ViewModel 生命周期                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Activity/Fragment 创建                                        │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ <span class="hljs-number">1</span>. ViewModel 创建                                       │  │
│   │ <span class="hljs-number">2</span>. 执行 init 块                                         │  │
│   │ <span class="hljs-number">3</span>. 开始收集数据                                          │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              ↓                                  │
│   配置变更（旋转屏幕）                                           │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ <span class="hljs-number">1</span>. Activity 销毁                                        │  │
│   │ <span class="hljs-number">2</span>. ViewModel 保留（不销毁）                              │  │
│   │ <span class="hljs-number">3</span>. 新的 Activity 创建                                    │  │
│   │ <span class="hljs-number">4</span>. 获取相同的 ViewModel 实例                             │  │
│   │ <span class="hljs-number">5</span>. 状态保持不变                                          │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              ↓                                  │
│   Activity/Fragment 真正销毁                                     │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ <span class="hljs-number">1</span>. <span class="hljs-built_in">onCleared</span>() 被调用                                    │  │
│   │ <span class="hljs-number">2</span>. ViewModel 销毁                                        │  │
│   │ <span class="hljs-number">3</span>. 协程作用域取消                                        │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<hr/>
<h2 data-id="heading-47">五、CompositionLocal 深度解析</h2>
<h3 data-id="heading-48">5.1 什么是 CompositionLocal？</h3>
<p><strong>CompositionLocal</strong> 是一种<strong>隐式传参</strong>机制，允许在 Composable 树中向下传递数据，而不需要通过每一层的参数。</p>
<p><strong>为什么需要 CompositionLocal？</strong></p>
<p>想象这样一个场景：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 不使用 CompositionLocal - 需要层层传递</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">App</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> user = User(<span class="hljs-string">"张三"</span>, <span class="hljs-string">"admin"</span>)
    ScreenA(user = user)
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ScreenA</span><span class="hljs-params">(user: <span class="hljs-type">User</span>)</span></span> {
    Header(user = user)
    Content(user = user)
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Header</span><span class="hljs-params">(user: <span class="hljs-type">User</span>)</span></span> {
    Avatar(user = user)
    UserName(user = user)
}

<span class="hljs-comment">// 每一层都需要传递 user 参数，即使中间层不使用它</span>
</code></pre>
<p>使用 CompositionLocal：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用 CompositionLocal - 隐式传递</span>
<span class="hljs-keyword">val</span> LocalUser = compositionLocalOf&lt;User&gt; { error(<span class="hljs-string">"No user provided"</span>) }

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">App</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> user = User(<span class="hljs-string">"张三"</span>, <span class="hljs-string">"admin"</span>)
    CompositionLocalProvider(LocalUser provides user) {
        ScreenA()  <span class="hljs-comment">// 不需要传递 user</span>
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ScreenA</span><span class="hljs-params">()</span></span> {
    Header()   <span class="hljs-comment">// 不需要传递 user</span>
    Content()  <span class="hljs-comment">// 不需要传递 user</span>
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Header</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> user = LocalUser.current  <span class="hljs-comment">// 在需要的地方获取</span>
    Avatar(user = user)
    UserName(user = user)
}
</code></pre>
<h3 data-id="heading-49">5.2 CompositionLocal 的原理</h3>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────────┐
│                  CompositionLocal 原理                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   Composable 树                                                 │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ <span class="hljs-built_in">CompositionLocalProvider</span>(LocalColor provides Color.Red) │  │
│   │ ┌─────────────────────────────────────────────────────┐ │  │
│   │ │  <span class="hljs-built_in">Child1</span>()                                          │ │  │
│   │ │   ┌─────────────────────────────────────────────┐  │ │  │
│   │ │   │  <span class="hljs-built_in">Child2</span>()                                  │  │ │  │
│   │ │   │   ┌─────────────────────────────────────┐  │  │ │  │
│   │ │   │   │  LocalColor<span class="hljs-selector-class">.current</span>  <span class="hljs-comment">// 返回 Red   │  │  │ │  │</span>
│   │ │   │   └─────────────────────────────────────┘  │  │ │  │
│   │ │   └─────────────────────────────────────────────┘  │ │  │
│   │ └─────────────────────────────────────────────────────┘ │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
│   查找规则：                                                      │
│   <span class="hljs-number">1</span>. 从当前节点向上查找                                           │
│   <span class="hljs-number">2</span>. 找到最近的 CompositionLocalProvider                          │
│   <span class="hljs-number">3</span>. 返回对应的值                                                 │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-50">5.3 创建与使用 CompositionLocal</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 创建 CompositionLocal</span>
<span class="hljs-keyword">val</span> LocalUser = compositionLocalOf&lt;User&gt; { error(<span class="hljs-string">"No user provided"</span>) }

<span class="hljs-comment">// 2. 提供值</span>
CompositionLocalProvider(LocalUser provides currentUser) {
    UserProfile()  <span class="hljs-comment">// 及其子组件都可以通过 LocalUser.current 获取</span>
}

<span class="hljs-comment">// 3. 使用值</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserProfile</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> user = LocalUser.current
    Text(<span class="hljs-string">"Hello, <span class="hljs-subst">${user.name}</span>"</span>)
}
</code></pre>
<h3 data-id="heading-51">5.4 compositionLocalOf vs staticCompositionLocalOf</h3>




















<table><thead><tr><th>函数</th><th>特点</th><th>适用场景</th></tr></thead><tbody><tr><td><code>compositionLocalOf</code></td><td>值变化时，只重组读取该值的组件</td><td>频繁变化的值</td></tr><tr><td><code>staticCompositionLocalOf</code></td><td>值变化时，重组整个子树</td><td>很少变化的值</td></tr></tbody></table>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 主题颜色 - 很少变化</span>
<span class="hljs-keyword">val</span> LocalColors = staticCompositionLocalOf { LightColorScheme }

<span class="hljs-comment">// 滚动状态 - 频繁变化</span>
<span class="hljs-keyword">val</span> LocalScrollState = compositionLocalOf { ScrollState(<span class="hljs-number">0</span>) }
</code></pre>
<h3 data-id="heading-52">5.5 MaterialTheme 的实现</h3>
<p>MaterialTheme 就是基于 CompositionLocal 实现的：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MaterialTheme</span><span class="hljs-params">(
    colorScheme: <span class="hljs-type">ColorScheme</span> = MaterialTheme.colorScheme,
    typography: <span class="hljs-type">Typography</span> = MaterialTheme.typography,
    shapes: <span class="hljs-type">Shapes</span> = MaterialTheme.shapes,
    content: @<span class="hljs-type">Composable</span> () -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    <span class="hljs-keyword">val</span> rememberedColorScheme = remember { colorScheme }
    <span class="hljs-keyword">val</span> rememberedTypography = remember { typography }
    <span class="hljs-keyword">val</span> rememberedShapes = remember { shapes }
    
    CompositionLocalProvider(
        LocalColorScheme provides rememberedColorScheme,
        LocalTypography provides rememberedTypography,
        LocalShapes provides rememberedShapes
    ) {
        content()
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MyComponent</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> colorScheme = MaterialTheme.colorScheme
    <span class="hljs-keyword">val</span> typography = MaterialTheme.typography
    
    Text(
        text = <span class="hljs-string">"Hello"</span>,
        color = colorScheme.primary,
        style = typography.bodyLarge
    )
}
</code></pre>
<h3 data-id="heading-53">5.6 CompositionLocal 的最佳实践</h3>
<h4 data-id="heading-54">✅ 推荐使用</h4>
<ul>
<li>主题配置（颜色、字体、形状）</li>
<li>上下文信息（屏幕类型、权限状态）</li>
<li>全局服务（Navigator、Analytics）</li>
</ul>
<h4 data-id="heading-55">❌ 避免使用</h4>
<ul>
<li>频繁变化的数据（使用参数传递）</li>
<li>业务逻辑状态（使用 ViewModel）</li>
<li>可能导致隐式依赖，降低代码可读性</li>
</ul>
<hr/>
<h2 data-id="heading-56">六、副作用 API 详解</h2>
<h3 data-id="heading-57">6.1 什么是副作用？</h3>
<p><strong>副作用</strong>是指 Composable 函数对外部世界的影响，如：</p>
<ul>
<li>网络请求</li>
<li>数据库操作</li>
<li>订阅事件</li>
<li>修改共享状态</li>
</ul>
<p>Compose 是纯函数式的，Composable 不应该有副作用。但应用开发离不开副作用，因此 Compose 提供了专门的 API 来处理副作用。</p>
<h3 data-id="heading-58">6.2 LaunchedEffect：在组合中启动协程</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserProfile</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-keyword">var</span> user <span class="hljs-keyword">by</span> remember { mutableStateOf&lt;User?&gt;(<span class="hljs-literal">null</span>) }
    
    <span class="hljs-comment">// 在组合时启动协程</span>
    LaunchedEffect(userId) {
        <span class="hljs-comment">// 这里的代码在协程中执行</span>
        user = api.getUser(userId)
    }
    
    user?.let {
        Text(<span class="hljs-string">"Name: <span class="hljs-subst">${it.name}</span>"</span>)
    }
}
</code></pre>
<p><strong>LaunchedEffect 的特点</strong>：</p>
<ul>
<li>在组合时启动协程</li>
<li>key 变化时，取消旧协程，启动新协程</li>
<li>重组时不会重新启动</li>
</ul>
<pre><code class="hljs language-vbnet" lang="vbnet">┌─────────────────────────────────────────────────────────────────┐
│                   LaunchedEffect 生命周期                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   首次组合                                                       │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ <span class="hljs-number">1</span>. LaunchedEffect 进入组合                              │  │
│   │ <span class="hljs-number">2</span>. 启动协程，执行副作用代码                              │  │
│   │ <span class="hljs-number">3</span>. 协程持续运行...                                       │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              ↓                                  │
│   重组（<span class="hljs-keyword">key</span> 未变化）                                             │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ <span class="hljs-number">1</span>. LaunchedEffect 重组                                  │  │
│   │ <span class="hljs-number">2</span>. <span class="hljs-keyword">key</span> 相同，协程继续运行                                │  │
│   │ <span class="hljs-number">3</span>. 不执行副作用代码                                      │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              ↓                                  │
│   重组（<span class="hljs-keyword">key</span> 变化）                                               │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ <span class="hljs-number">1</span>. 取消旧协程                                           │  │
│   │ <span class="hljs-number">2</span>. 启动新协程                                           │  │
│   │ <span class="hljs-number">3</span>. 执行新的副作用代码                                    │  │
│   └─────────────────────────────────────────────────────────┘  │
│                              ↓                                  │
│   退出组合                                                       │
│   ┌─────────────────────────────────────────────────────────┐  │
│   │ <span class="hljs-number">1</span>. LaunchedEffect 退出组合                              │  │
│   │ <span class="hljs-number">2</span>. 取消协程                                             │  │
│   └─────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-59">6.3 SideEffect：每次重组都执行</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">AnalyticsScreen</span><span class="hljs-params">(screenName: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-comment">// 每次重组都执行</span>
    SideEffect {
        analytics.logScreenView(screenName)
    }
    
    <span class="hljs-comment">// UI 内容</span>
    Text(<span class="hljs-string">"Screen: <span class="hljs-variable">$screenName</span>"</span>)
}
</code></pre>
<p><strong>使用场景</strong>：需要确保副作用在每次成功重组后都执行。</p>
<h3 data-id="heading-60">6.4 DisposableEffect：需要清理的副作用</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">BackHandler</span><span class="hljs-params">(onBack: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    <span class="hljs-keyword">val</span> dispatcher = LocalOnBackPressedDispatcherOwner.current?.onBackPressedDispatcher
    
    DisposableEffect(dispatcher) {
        <span class="hljs-comment">// 设置回调</span>
        <span class="hljs-keyword">val</span> callback = <span class="hljs-keyword">object</span> : OnBackPressedCallback(<span class="hljs-literal">true</span>) {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handleOnBackPressed</span><span class="hljs-params">()</span></span> {
                onBack()
            }
        }
        dispatcher?.addCallback(callback)
        
        <span class="hljs-comment">// 返回清理函数</span>
        onDispose {
            callback.remove()
        }
    }
}
</code></pre>
<p><strong>DisposableEffect 的特点</strong>：</p>
<ul>
<li>key 变化时，先执行 onDispose，再执行新的副作用</li>
<li>退出组合时，执行 onDispose</li>
</ul>
<h3 data-id="heading-61">6.5 rememberCoroutineScope：在回调中启动协程</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserList</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> scope = rememberCoroutineScope()
    <span class="hljs-keyword">var</span> users <span class="hljs-keyword">by</span> remember { mutableStateOf&lt;List&lt;User&gt;&gt;(emptyList()) }
    
    Button(onClick = {
        <span class="hljs-comment">// 在回调中启动协程</span>
        scope.launch {
            users = api.getUsers()
        }
    }) {
        Text(<span class="hljs-string">"Load Users"</span>)
    }
    
    <span class="hljs-comment">// 显示用户列表</span>
    LazyColumn {
        items(users) { user -&gt;
            Text(user.name)
        }
    }
}
</code></pre>
<p><strong>与 LaunchedEffect 的区别</strong>：</p>
<ul>
<li><code>LaunchedEffect</code>：在组合时自动启动</li>
<li><code>rememberCoroutineScope</code>：提供 CoroutineScope，在回调中手动启动</li>
</ul>
<h3 data-id="heading-62">6.6 rememberUpdatedState：获取最新值</h3>
<p>当需要在长时间运行的副作用中获取最新状态时，使用 <code>rememberUpdatedState</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">Timer</span><span class="hljs-params">(
    onTick: () -&gt; <span class="hljs-type">Unit</span>,
    interval: <span class="hljs-type">Long</span> = <span class="hljs-number">1000</span>L
)</span></span> {
    <span class="hljs-comment">// 使用 rememberUpdatedState 获取最新的 onTick</span>
    <span class="hljs-keyword">val</span> currentOnTick <span class="hljs-keyword">by</span> rememberUpdatedState(onTick)
    
    LaunchedEffect(<span class="hljs-built_in">Unit</span>) {
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            delay(interval)
            currentOnTick()  <span class="hljs-comment">// 总是调用最新的 onTick</span>
        }
    }
}
</code></pre>
<p><strong>为什么需要 rememberUpdatedState？</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误：LaunchedEffect 捕获的是旧的 onTick</span>
LaunchedEffect(<span class="hljs-built_in">Unit</span>) {
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        delay(<span class="hljs-number">1000</span>)
        onTick()  <span class="hljs-comment">// 总是调用第一次传入的 onTick</span>
    }
}

<span class="hljs-comment">// ✅ 正确：使用 rememberUpdatedState</span>
<span class="hljs-keyword">val</span> currentOnTick <span class="hljs-keyword">by</span> rememberUpdatedState(onTick)
LaunchedEffect(<span class="hljs-built_in">Unit</span>) {
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        delay(<span class="hljs-number">1000</span>)
        currentOnTick()  <span class="hljs-comment">// 总是调用最新的 onTick</span>
    }
}
</code></pre>
<h3 data-id="heading-63">6.7 DerivedState：派生状态</h3>
<p>当需要基于其他状态计算派生状态时，使用 <code>derivedStateOf</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">SearchResults</span><span class="hljs-params">(query: <span class="hljs-type">String</span>, items: <span class="hljs-type">List</span>&lt;<span class="hljs-type">Item</span>&gt;)</span></span> {
    <span class="hljs-comment">// 只在必要时重新计算</span>
    <span class="hljs-keyword">val</span> filteredItems <span class="hljs-keyword">by</span> remember {
        derivedStateOf {
            items.filter { it.name.contains(query, ignoreCase = <span class="hljs-literal">true</span>) }
        }
    }
    
    LazyColumn {
        items(filteredItems) { item -&gt;
            ItemRow(item)
        }
    }
}
</code></pre>
<p><strong>derivedStateOf vs remember</strong>：</p>




















<table><thead><tr><th>特性</th><th>derivedStateOf</th><th>remember</th></tr></thead><tbody><tr><td>触发条件</td><td>读取时</td><td>依赖变化时</td></tr><tr><td>适用场景</td><td>频繁读取、计算成本高</td><td>一次性计算</td></tr></tbody></table>
<h3 data-id="heading-64">6.8 produceState：将非 Compose 状态转换为 State</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadUser</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span>: State&lt;User?&gt; {
    <span class="hljs-keyword">return</span> produceState&lt;User?&gt;(initialValue = <span class="hljs-literal">null</span>, userId) {
        value = api.getUser(userId)
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserProfile</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span> {
    <span class="hljs-keyword">val</span> user <span class="hljs-keyword">by</span> loadUser(userId)
    
    user?.let {
        Text(<span class="hljs-string">"Name: <span class="hljs-subst">${it.name}</span>"</span>)
    }
}
</code></pre>
<h3 data-id="heading-65">6.9 snapshotFlow：将 State 转换为 Flow</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">SearchScreen</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> query <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">""</span>) }
    
    <span class="hljs-comment">// 将 State 转换为 Flow</span>
    <span class="hljs-keyword">val</span> searchResults <span class="hljs-keyword">by</span> remember {
        snapshotFlow { query }
            .debounce(<span class="hljs-number">300</span>)  <span class="hljs-comment">// 防抖</span>
            .flatMapLatest { api.search(it) }
            .collectAsState(initial = emptyList())
    }
    
    Column {
        TextField(
            value = query,
            onValueChange = { query = it }
        )
        
        LazyColumn {
            items(searchResults) { result -&gt;
                Text(result.name)
            }
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-66">七、状态管理架构设计</h2>
<h3 data-id="heading-67">7.1 分层架构</h3>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────────┐
│                      UI Layer (Composable)                      │
│  - 显示数据                                                      │
│  - 处理用户交互                                                  │
│  - 调用 ViewModel 方法                                           │
├─────────────────────────────────────────────────────────────────┤
│                   ViewModel Layer                               │
│  - 管理 UI 状态                                                  │
│  - 处理业务逻辑                                                  │
│  - 调用 Repository 方法                                          │
├─────────────────────────────────────────────────────────────────┤
│                  Repository Layer                               │
│  - 数据聚合                                                      │
│  - 业务规则                                                      │
│  - 选择数据源                                                    │
├─────────────────────────────────────────────────────────────────┤
│                   Data Source Layer                             │
│  - 网络 API (Retrofit)                                          │
│  - 本地数据库 (Room)                                            │
│  - 本地缓存 (DataStore)                                         │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-68">7.2 完整实战：用户列表页面</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ============ Data Layer ============</span>

<span class="hljs-comment">// 数据模型</span>
<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(
    <span class="hljs-keyword">val</span> id: String,
    <span class="hljs-keyword">val</span> name: String,
    <span class="hljs-keyword">val</span> email: String,
    <span class="hljs-keyword">val</span> avatar: String
)

<span class="hljs-comment">// Repository</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserRepository</span> {
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUsers</span><span class="hljs-params">()</span></span>: List&lt;User&gt;
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">searchUsers</span><span class="hljs-params">(query: <span class="hljs-type">String</span>)</span></span>: List&lt;User&gt;
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRepositoryImpl</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> api: UserApi
) : UserRepository {
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUsers</span><span class="hljs-params">()</span></span>: List&lt;User&gt; = api.getUsers()
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">searchUsers</span><span class="hljs-params">(query: <span class="hljs-type">String</span>)</span></span>: List&lt;User&gt; = api.searchUsers(query)
}

<span class="hljs-comment">// ============ ViewModel Layer ============</span>

<span class="hljs-keyword">sealed</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UsersUiState</span> {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">object</span> Loading : UsersUiState
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>(<span class="hljs-keyword">val</span> users: List&lt;User&gt;) : UsersUiState
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span>(<span class="hljs-keyword">val</span> message: String) : UsersUiState
}

<span class="hljs-meta">@HiltViewModel</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UsersViewModel</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> repository: UserRepository
) : ViewModel() {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _uiState = MutableStateFlow&lt;UsersUiState&gt;(UsersUiState.Loading)
    <span class="hljs-keyword">val</span> uiState: StateFlow&lt;UsersUiState&gt; = _uiState.asStateFlow()
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _searchQuery = MutableStateFlow(<span class="hljs-string">""</span>)
    <span class="hljs-keyword">val</span> searchQuery: StateFlow&lt;String&gt; = _searchQuery.asStateFlow()
    
    <span class="hljs-comment">// 搜索结果的派生状态</span>
    <span class="hljs-keyword">val</span> searchResults: StateFlow&lt;UsersUiState&gt; = _searchQuery
        .debounce(<span class="hljs-number">300</span>)
        .flatMapLatest { query -&gt;
            <span class="hljs-keyword">if</span> (query.isEmpty()) {
                flowOf(UsersUiState.Success(emptyList()))
            } <span class="hljs-keyword">else</span> {
                flow {
                    emit(UsersUiState.Loading)
                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-keyword">val</span> users = repository.searchUsers(query)
                        emit(UsersUiState.Success(users))
                    } <span class="hljs-keyword">catch</span> (e: Exception) {
                        emit(UsersUiState.Error(e.message ?: <span class="hljs-string">"Unknown error"</span>))
                    }
                }
            }
        }
        .stateIn(
            scope = viewModelScope,
            started = SharingStarted.WhileSubscribed(<span class="hljs-number">5000</span>),
            initialValue = UsersUiState.Success(emptyList())
        )
    
    <span class="hljs-keyword">init</span> {
        loadUsers()
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadUsers</span><span class="hljs-params">()</span></span> {
        viewModelScope.launch {
            _uiState.value = UsersUiState.Loading
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">val</span> users = repository.getUsers()
                _uiState.value = UsersUiState.Success(users)
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                _uiState.value = UsersUiState.Error(e.message ?: <span class="hljs-string">"Unknown error"</span>)
            }
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSearchQueryChange</span><span class="hljs-params">(query: <span class="hljs-type">String</span>)</span></span> {
        _searchQuery.value = query
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">refresh</span><span class="hljs-params">()</span></span> {
        loadUsers()
    }
}

<span class="hljs-comment">// ============ UI Layer ============</span>

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UsersScreen</span><span class="hljs-params">(
    viewModel: <span class="hljs-type">UsersViewModel</span> = hiltViewModel()</span></span>
) {
    <span class="hljs-keyword">val</span> uiState <span class="hljs-keyword">by</span> viewModel.uiState.collectAsState()
    <span class="hljs-keyword">val</span> searchQuery <span class="hljs-keyword">by</span> viewModel.searchQuery.collectAsState()
    <span class="hljs-keyword">val</span> searchResults <span class="hljs-keyword">by</span> viewModel.searchResults.collectAsState()
    
    <span class="hljs-keyword">val</span> isSearching = searchQuery.isNotEmpty()
    <span class="hljs-keyword">val</span> currentState = <span class="hljs-keyword">if</span> (isSearching) searchResults <span class="hljs-keyword">else</span> uiState
    
    UsersContent(
        uiState = currentState,
        searchQuery = searchQuery,
        onSearchQueryChange = viewModel::onSearchQueryChange,
        onRefresh = viewModel::refresh
    )
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UsersContent</span><span class="hljs-params">(
    uiState: <span class="hljs-type">UsersUiState</span>,
    searchQuery: <span class="hljs-type">String</span>,
    onSearchQueryChange: (<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Unit</span>,
    onRefresh: () -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    Column(modifier = Modifier.fillMaxSize()) {
        <span class="hljs-comment">// 搜索框</span>
        SearchBar(
            query = searchQuery,
            onQueryChange = onSearchQueryChange
        )
        
        <span class="hljs-comment">// 内容区域</span>
        <span class="hljs-keyword">when</span> (<span class="hljs-keyword">val</span> state = uiState) {
            <span class="hljs-keyword">is</span> UsersUiState.Loading -&gt; LoadingScreen()
            <span class="hljs-keyword">is</span> UsersUiState.Error -&gt; ErrorScreen(
                message = state.message,
                onRetry = onRefresh
            )
            <span class="hljs-keyword">is</span> UsersUiState.Success -&gt; {
                <span class="hljs-keyword">if</span> (state.users.isEmpty()) {
                    EmptyScreen()
                } <span class="hljs-keyword">else</span> {
                    UserList(users = state.users)
                }
            }
        }
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserList</span><span class="hljs-params">(users: <span class="hljs-type">List</span>&lt;<span class="hljs-type">User</span>&gt;)</span></span> {
    LazyColumn {
        items(users, key = { it.id }) { user -&gt;
            UserItem(user = user)
        }
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserItem</span><span class="hljs-params">(user: <span class="hljs-type">User</span>)</span></span> {
    Card(
        modifier = Modifier
            .fillMaxWidth()
            .padding(horizontal = <span class="hljs-number">16.</span>dp, vertical = <span class="hljs-number">8.</span>dp)
    ) {
        Row(
            modifier = Modifier.padding(<span class="hljs-number">16.</span>dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            AsyncImage(
                model = user.avatar,
                contentDescription = <span class="hljs-literal">null</span>,
                modifier = Modifier
                    .size(<span class="hljs-number">48.</span>dp)
                    .clip(CircleShape)
            )
            
            Spacer(modifier = Modifier.width(<span class="hljs-number">16.</span>dp))
            
            Column {
                Text(
                    text = user.name,
                    style = MaterialTheme.typography.titleMedium
                )
                Text(
                    text = user.email,
                    style = MaterialTheme.typography.bodyMedium,
                    color = Color.Gray
                )
            }
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-69">八、本篇小结</h2>
<p>今天我们深入探讨了 Compose 的状态管理系统：</p>
<h3 data-id="heading-70">状态与重组机制</h3>
<ul>
<li>理解了 Slot Table 的数据结构和作用</li>
<li>掌握了重组的触发机制和优化策略</li>
<li>学会了使用 @Stable 和 @Immutable 控制重组</li>
</ul>
<h3 data-id="heading-71">remember 与 mutableStateOf</h3>
<ul>
<li>深入理解了 remember 的缓存原理</li>
<li>掌握了 mutableStateOf 的 Snapshot 机制</li>
<li>学会了 rememberSaveable 的保存与恢复</li>
</ul>
<h3 data-id="heading-72">状态提升</h3>
<ul>
<li>理解了状态提升的设计哲学</li>
<li>掌握了状态容器模式和屏幕级状态管理</li>
</ul>
<h3 data-id="heading-73">ViewModel 与 Compose</h3>
<ul>
<li>学会了 StateFlow 与 Compose 的集成</li>
<li>掌握了 UI 状态设计的最佳实践</li>
</ul>
<h3 data-id="heading-74">CompositionLocal</h3>
<ul>
<li>理解了隐式传参的原理</li>
<li>学会了创建和使用 CompositionLocal</li>
</ul>
<h3 data-id="heading-75">副作用 API</h3>
<ul>
<li>掌握了 LaunchedEffect、DisposableEffect 等副作用 API</li>
<li>理解了不同场景下的选择策略</li>
</ul>
<hr/>
<h2 data-id="heading-76">下篇预告</h2>
<p><strong>第四篇：Material 组件与主题</strong> 将深入讲解：</p>
<ul>
<li>Material Design 3 组件大全</li>
<li>自定义主题与颜色系统</li>
<li>深色模式与动态主题适配</li>
<li>自定义组件的设计思路</li>
</ul>
<p>敬请期待！</p>
<hr/>
<h2 data-id="heading-77">参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fstate" target="_blank" title="https://developer.android.com/jetpack/compose/state" ref="nofollow noopener noreferrer">Compose 状态官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fside-effects" target="_blank" title="https://developer.android.com/jetpack/compose/side-effects" ref="nofollow noopener noreferrer">Compose 副作用官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fframeworks%2Fsupport%2F%2B%2Fandroidx-main%2Fcompose%2F" target="_blank" title="https://android.googlesource.com/platform/frameworks/support/+/androidx-main/compose/" ref="nofollow noopener noreferrer">Compose 源码</a></li>
</ul>
<hr/>
<blockquote>
<p>📌 <strong>系列文章导航</strong></p>
<ul>
<li>第一篇：初识 Compose ✅</li>
<li>第二篇：核心基石 ✅</li>
<li>第三篇：状态管理（当前）✅</li>
<li>第四篇：Material 组件与主题</li>
<li>第五篇：动画与交互</li>
<li>第六篇：架构与工程化</li>
<li>第七篇：高级特性与实战</li>
</ul>
</blockquote>
<hr/>
<p>如果这篇文章对你有帮助，欢迎 <strong>点赞</strong>、<strong>收藏</strong>、<strong>关注</strong>！有任何问题可以在评论区留言。</p>
<p><del>Generated by Kimi K2.5 Agent</del></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[构建专业命令行工具：解析 Commander 与 Inquirer 的协作之道]]></title>    <link>https://juejin.cn/post/7600344784945381422</link>    <guid>https://juejin.cn/post/7600344784945381422</guid>    <pubDate>2026-01-29T06:23:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600344784945381422" data-draft-id="7600344784945348654" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="构建专业命令行工具：解析 Commander 与 Inquirer 的协作之道"/> <meta itemprop="keywords" content="后端,前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-29T06:23:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火车叼位"/> <meta itemprop="url" content="https://juejin.cn/user/1345457960792808"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            构建专业命令行工具：解析 Commander 与 Inquirer 的协作之道
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1345457960792808/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火车叼位
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T06:23:57.000Z" title="Thu Jan 29 2026 06:23:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Node.js 生态中，开发一个命令行界面（CLI）工具几乎是每个高级开发者的必经之路。然而，面对 <strong>Commander.js</strong> 和 <strong>Inquirer.js</strong> 这两个顶级库时，很多开发者会产生困惑：“我到底该选哪一个？”</p>
<p>实际上，这种困惑源于对两者定位的重叠性误解。Commander 负责的是**“命令的结构”<strong>，而 Inquirer 负责的是</strong>“互动的体验”**。本文将带你深入底层，看清它们的相同点与本质区别，助你做出最理性的技术选型。</p>
<hr/>
<h2 data-id="heading-0">1. Commander.js：CLI 的骨架与规则</h2>
<h3 data-id="heading-1">1.1 核心定位</h3>
<p>Commander 是一个完整的 Node.js 命令行解决方案。它效仿了 Ruby 的 <code>commander</code>，其核心目标是<strong>解析（Parsing）</strong>。它负责告诉程序：用户在启动时输入了什么指令、带了什么参数、设置了哪些选项。</p>
<h3 data-id="heading-2">1.2 核心功能特性</h3>
<ul>
<li><strong>参数解析</strong>：自动处理 <code>process.argv</code>，支持必填参数 <code>&lt;arg&gt;</code> 和可选参数 <code>[arg]</code>。</li>
<li><strong>选项定义</strong>：支持短选项（<code>-f</code>）和长选项（<code>--force</code>），并自动生成布尔值或参数值。</li>
<li><strong>子命令系统</strong>：通过 <code>.command()</code> 构建类似 <code>git push</code>、<code>git pull</code> 的嵌套结构。</li>
<li><strong>自动文档</strong>：基于定义自动生成 <code>-h, --help</code> 帮助信息。</li>
</ul>
<h3 data-id="heading-3">1.3 代码示例（基于文档）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { program } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'commander'</span>);

program
  .<span class="hljs-title function_">name</span>(<span class="hljs-string">'pizza-cli'</span>)
  .<span class="hljs-title function_">description</span>(<span class="hljs-string">'订购皮萨的工具'</span>)
  .<span class="hljs-title function_">version</span>(<span class="hljs-string">'1.0.0'</span>);

program
  .<span class="hljs-title function_">option</span>(<span class="hljs-string">'-s, --size &lt;type&gt;'</span>, <span class="hljs-string">'皮萨尺寸'</span>, <span class="hljs-string">'medium'</span>)
  .<span class="hljs-title function_">option</span>(<span class="hljs-string">'-d, --debug'</span>, <span class="hljs-string">'开启调试模式'</span>)
  .<span class="hljs-title function_">action</span>(<span class="hljs-function">(<span class="hljs-params">options</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`您订购了一个 <span class="hljs-subst">${options.size}</span> 尺寸的皮萨。`</span>);
  });

program.<span class="hljs-title function_">parse</span>();
</code></pre>
<hr/>
<h2 data-id="heading-4">2. Inquirer.js：CLI 的血肉与交互</h2>
<h3 data-id="heading-5">2.1 核心定位</h3>
<p>Inquirer 是一个交互式命令行用户界面的集合。它的目标是<strong>引导（Guiding）</strong>。当你的程序需要从用户那里获取非预设的、复杂的信息时，Inquirer 提供了丰富的 UI 组件。</p>
<h3 data-id="heading-6">2.2 核心功能特性</h3>
<ul>
<li><strong>多样化输入</strong>：支持 <code>input</code>（文本）、<code>password</code>（遮罩）、<code>confirm</code>（确认）、<code>select</code>（单选）、<code>checkbox</code>（多选）等。</li>
<li><strong>流式对话</strong>：可以根据上一步的回答动态决定下一步提问的内容。</li>
<li><strong>输入校验</strong>：内置 <code>validate</code> 钩子，实时反馈输入错误。</li>
<li><strong>新版优化</strong>：最新版（<code>@inquirer/prompts</code>）采用了更轻量、性能更高的架构，并支持更灵活的异步操作。</li>
</ul>
<h3 data-id="heading-7">2.3 代码示例（基于文档）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { input, select } <span class="hljs-keyword">from</span> <span class="hljs-string">'@inquirer/prompts'</span>;

<span class="hljs-keyword">const</span> name = <span class="hljs-keyword">await</span> <span class="hljs-title function_">input</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'请输入您的名字'</span> });
<span class="hljs-keyword">const</span> color = <span class="hljs-keyword">await</span> <span class="hljs-title function_">select</span>({
  <span class="hljs-attr">message</span>: <span class="hljs-string">'选择你喜欢的颜色'</span>,
  <span class="hljs-attr">choices</span>: [
    { <span class="hljs-attr">name</span>: <span class="hljs-string">'红色'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'red'</span> },
    { <span class="hljs-attr">name</span>: <span class="hljs-string">'蓝色'</span>, <span class="hljs-attr">value</span>: <span class="hljs-string">'blue'</span> },
  ],
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`你好 <span class="hljs-subst">${name}</span>，你选择了 <span class="hljs-subst">${color}</span>。`</span>);
</code></pre>
<hr/>
<h2 data-id="heading-8">3. 深度对比：相同点与不同点</h2>
<p>为了辅助选型，我们将两者进行多维度的横向对比：</p>



































<table><thead><tr><th align="left">维度</th><th align="left">Commander.js</th><th align="left">Inquirer.js</th></tr></thead><tbody><tr><td align="left"><strong>交互模式</strong></td><td align="left"><strong>静态/声明式</strong>：用户启动前决定一切</td><td align="left"><strong>动态/交互式</strong>：程序运行中实时问答</td></tr><tr><td align="left"><strong>主要职责</strong></td><td align="left">命令解析、版本管理、帮助信息、子命令调度</td><td align="left">收集用户输入、数据校验、流程引导、UI 呈现</td></tr><tr><td align="left"><strong>自动化支持</strong></td><td align="left"><strong>极佳</strong>：完美支持 CI/CD、脚本自动化调用</td><td align="left"><strong>较差</strong>：通常需要人工干预（除非 Mock 标准输入）</td></tr><tr><td align="left"><strong>学习曲线</strong></td><td align="left">低：主要是声明 API 及其回调</td><td align="left">中：需处理异步流程、逻辑分支和校验</td></tr><tr><td align="left"><strong>用户群体</strong></td><td align="left">高级用户（偏向脚本化、快速指令）</td><td align="left">普通用户（偏向配置向导、初始化工具）</td></tr></tbody></table>
<h3 data-id="heading-9">相同点</h3>
<ol>
<li><strong>基础环境</strong>：两者都运行在 Node.js 环境，均对原生 <code>process.stdin</code> 和 <code>process.stdout</code> 进行了高级封装。</li>
<li><strong>社区标准</strong>：它们都是各自领域的“事实标准”，npm 下载量均为千万级。</li>
<li><strong>扩展性</strong>：都支持自定义扩展，Commander 可以自定义配置 Help 类，Inquirer 可以开发自定义 Prompt 插件。</li>
</ol>
<h3 data-id="heading-10">核心区别</h3>
<ul>
<li><strong>触发时机不同</strong>：Commander 关注的是命令启动那一刻的状态；Inquirer 关注的是启动后与用户的持续对话。</li>
<li><strong>CI/CD 友好度不同</strong>：如果你的工具要在服务器脚本（如 Jenkins）中运行，Commander 是必须的，因为它可以通过 Flag（如 <code>--yes</code>）避开人工干预；而 Inquirer 在这种场景下会阻塞进程。</li>
</ul>
<hr/>
<h2 data-id="heading-11">4. 混合选型策略：1 + 1 &gt; 2</h2>
<p>在现代 CLI 开发中，**“Commander 构建骨架 + Inquirer 填充交互”**是最成熟的方案。</p>
<h3 data-id="heading-12">实践案例：脚手架初始化</h3>
<p>想象你要开发一个类似 <code>vue-cli</code> 的工具：</p>
<ol>
<li><strong>使用 Commander 解析指令</strong>：用户输入 <code>my-cli create my-project</code>。</li>
<li><strong>缺省检测</strong>：如果用户没传参数，或者需要进一步配置，则唤起 <strong>Inquirer</strong>。</li>
<li><strong>交互式问答</strong>：询问“是否使用 TypeScript？”、“是否集成 ESLint？”。</li>
<li><strong>结果合并</strong>：将 Commander 解析的初始参数与 Inquirer 收集的配置合并，最后执行文件创建任务。</li>
</ol>
<hr/>
<h2 data-id="heading-13">5. 结论与行动建议</h2>
<p>针对你的技术选型，我给出以下结论：</p>
<ol>
<li><strong>如果你的工具主要用于自动化脚本、数据处理或拥有大量复杂参数</strong>：请优先确保 <strong>Commander</strong> 的稳健实现。它能让你的工具像 <code>ls</code> 或 <code>git</code> 一样专业且易于集成。</li>
<li><strong>如果你的工具主要面向初级用户，或者涉及复杂的初始化配置（如脚手架、安装向导）</strong>：<strong>Inquirer</strong>（推荐使用新版 <code>@inquirer/prompts</code>）将极大提升用户体验。</li>
<li><strong>行动建议</strong>：
<ul>
<li><strong>立即可做</strong>：定义你的 CLI 核心命令结构，使用 Commander 建立第一个 <code>--help</code>。</li>
<li><strong>中期计划</strong>：识别用户容易输错或难以记忆的复杂参数，将其转化为 Inquirer 的交互式问答流程。</li>
</ul>
</li>
</ol>
<hr/>
<p><strong>参考来源：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FSBoudrias%2FInquirer.js" target="_blank" title="https://github.com/SBoudrias/Inquirer.js" ref="nofollow noopener noreferrer">Inquirer.js GitHub Repository</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftj%2Fcommander.js" target="_blank" title="https://github.com/tj/commander.js" ref="nofollow noopener noreferrer">Commander.js GitHub Repository</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 0 到 1 精通 Redux：从“绕晕”到“真香”的保姆级实战]]></title>    <link>https://juejin.cn/post/7600489282822832178</link>    <guid>https://juejin.cn/post/7600489282822832178</guid>    <pubDate>2026-01-29T05:06:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600489282822832178" data-draft-id="7600508556102811698" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 0 到 1 精通 Redux：从“绕晕”到“真香”的保姆级实战"/> <meta itemprop="keywords" content="前端,面试,Vue.js"/> <meta itemprop="datePublished" content="2026-01-29T05:06:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="豆苗学前端"/> <meta itemprop="url" content="https://juejin.cn/user/1935598759719400"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 0 到 1 精通 Redux：从“绕晕”到“真香”的保姆级实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1935598759719400/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    豆苗学前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T05:06:18.000Z" title="Thu Jan 29 2026 05:06:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    33
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言：为什么你觉得 Redux 绕？</h2>
<p>很多同学在学习 Redux 时，会被 <strong>Action、Reducer、Dispatch、Store</strong> 这一堆名词绕晕。其实，Redux 的本质就是一个**“全店共享的中央账本”**。</p>
<p>在没有 Redux 的时候，组件传值像“传声筒”，父传子、子传孙，层级一深，代码就成了乱麻。而 Redux 让数据脱离了组件树，独立存在。</p>
<p>今天，我们以**“古茗奶茶下单系统”**为例，用最现代的 <strong>Redux Toolkit (RTK)</strong>  方案，完成从零到一的进化。</p>
<hr/>
<h2 data-id="heading-1">第一步：建立心智模型——“古茗店长笔记”</h2>
<p>在动手写代码前，先记住这个映射关系：</p>
<ol>
<li><strong>Store（大账本）</strong> ：古茗店里唯一的中央账本，记录了所有库存和订单。</li>
<li><strong>Slice（部门）</strong> ：账本里的分区。比如“购物车部”、“用户部”。</li>
<li><strong>Action（申请单）</strong> ：你想改账本？必须填申请单。比如“加一杯杨梅冰”。</li>
<li><strong>Reducer（财务主管）</strong> ：唯一有权改账本的人。他看到申请单，亲自划掉旧数字，写上新数字。</li>
<li><strong>Selector（监控器）</strong> ：收银台的屏幕。账本一变，屏幕自动刷新显示。</li>
</ol>
<hr/>
<h2 data-id="heading-2">第二步：环境搭建（起步）</h2>
<p>现在我们不再写老旧的 Redux 模板，直接上 <strong>Redux Toolkit</strong>。</p>
<p>codeBash</p>
<pre><code class="hljs language-bash" lang="bash">npm install @reduxjs/toolkit react-redux
</code></pre>
<hr/>
<h2 data-id="heading-3">第三步：编写业务逻辑切片 (Slice)</h2>
<p>我们要处理购物车业务。新建 src/features/cartSlice.js：</p>
<p>codeJavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createSlice } <span class="hljs-keyword">from</span> <span class="hljs-string">'@reduxjs/toolkit'</span>;

<span class="hljs-keyword">const</span> cartSlice = <span class="hljs-title function_">createSlice</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'cart'</span>, <span class="hljs-comment">// 部门名称</span>
  <span class="hljs-attr">initialState</span>: {
    <span class="hljs-attr">items</span>: [],    <span class="hljs-comment">// 购物车奶茶列表</span>
    <span class="hljs-attr">total</span>: <span class="hljs-number">0</span>      <span class="hljs-comment">// 总金额</span>
  },
  <span class="hljs-attr">reducers</span>: {
    <span class="hljs-comment">// 申请单1：加入购物车</span>
    <span class="hljs-attr">addToCart</span>: <span class="hljs-function">(<span class="hljs-params">state, action</span>) =&gt;</span> {
      <span class="hljs-comment">// action.payload 就是传进来的奶茶：{ name: '杨梅冰', price: 15 }</span>
      state.<span class="hljs-property">items</span>.<span class="hljs-title function_">push</span>(action.<span class="hljs-property">payload</span>);
      state.<span class="hljs-property">total</span> += action.<span class="hljs-property">payload</span>.<span class="hljs-property">price</span>;
    },
    <span class="hljs-comment">// 申请单2：清空购物车</span>
    <span class="hljs-attr">clearCart</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> {
      state.<span class="hljs-property">items</span> = [];
      state.<span class="hljs-property">total</span> = <span class="hljs-number">0</span>;
    }
  }
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> { addToCart, clearCart } = cartSlice.<span class="hljs-property">actions</span>; <span class="hljs-comment">// 导出申请单</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> cartSlice.<span class="hljs-property">reducer</span>; <span class="hljs-comment">// 导出财务主管</span>
</code></pre>
<hr/>
<h2 data-id="heading-4">第四步：配置中央仓库 (Store)</h2>
<p>新建 src/app/store.js，把各部门主管集合起来：</p>
<p>codeJavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { configureStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@reduxjs/toolkit'</span>;
<span class="hljs-keyword">import</span> cartReducer <span class="hljs-keyword">from</span> <span class="hljs-string">'../features/cartSlice'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> store = <span class="hljs-title function_">configureStore</span>({
  <span class="hljs-attr">reducer</span>: {
    <span class="hljs-attr">cart</span>: cartReducer, <span class="hljs-comment">// 注册购物车部门</span>
    <span class="hljs-comment">// user: userReducer, 以后有用户部门再往这加</span>
  }
});
</code></pre>
<hr/>
<h2 data-id="heading-5">第五步：全局注入</h2>
<p>在入口文件 main.jsx 中，用  把账本发给全店：</p>
<p>codeJsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Provider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-redux'</span>;
<span class="hljs-keyword">import</span> { store } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app/store'</span>;

<span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>)).<span class="hljs-title function_">render</span>(
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">store</span>=<span class="hljs-string">{store}</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span></span>
);
</code></pre>
<hr/>
<h2 data-id="heading-6">第六步：在组件中使用（实战演练）</h2>
<h3 data-id="heading-7">1. 提交申请单（Dispatching Actions）</h3>
<p>在 Menu.jsx（菜单页），点击按钮加奶茶：</p>
<p>codeJsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useDispatch } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-redux'</span>;
<span class="hljs-keyword">import</span> { addToCart } <span class="hljs-keyword">from</span> <span class="hljs-string">'./features/cartSlice'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Menu</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> dispatch = <span class="hljs-title function_">useDispatch</span>(); <span class="hljs-comment">// 拿到那个“发单机”</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> dispatch(addToCart({ name: '杨梅冰', price: 15 }))}&gt;
      点一杯杨梅冰
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-8">2. 查看屏幕显示（Selecting State）</h3>
<p>在 Header.jsx（页眉），实时显示金额：</p>
<p>codeJsx</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useSelector } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-redux'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Header</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 盯着账本里的 cart 部分看</span>
  <span class="hljs-keyword">const</span> { total, items } = <span class="hljs-title function_">useSelector</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">cart</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>购物车数量：{items.length}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>总金额：￥{total}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<hr/>
<h2 data-id="heading-9">第七步：进阶——处理异步业务 (Async Thunk)</h2>
<p>现实中，我们要领优惠券，需要等接口返回。</p>
<p>codeJavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在 cartSlice.js 中添加</span>
<span class="hljs-keyword">import</span> { createAsyncThunk } <span class="hljs-keyword">from</span> <span class="hljs-string">'@reduxjs/toolkit'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> fetchCoupon = <span class="hljs-title function_">createAsyncThunk</span>(<span class="hljs-string">'cart/fetchCoupon'</span>, <span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/get-coupon'</span>);
  <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">json</span>(); <span class="hljs-comment">// 返回 { discount: 5 }</span>
});

<span class="hljs-comment">// 在 createSlice 的 extraReducers 中监听</span>
<span class="hljs-attr">extraReducers</span>: <span class="hljs-function">(<span class="hljs-params">builder</span>) =&gt;</span> {
  builder.<span class="hljs-title function_">addCase</span>(fetchCoupon.<span class="hljs-property">fulfilled</span>, <span class="hljs-function">(<span class="hljs-params">state, action</span>) =&gt;</span> {
    state.<span class="hljs-property">total</span> -= action.<span class="hljs-property">payload</span>.<span class="hljs-property">discount</span>; <span class="hljs-comment">// 领券成功，减钱！</span>
  });
}
</code></pre>
<hr/>
<h2 data-id="heading-10">总结：精通 Redux 的三字经</h2>
<ol>
<li><strong>分 (Slice)</strong> ：按业务拆分模块，别把所有东西塞一起。</li>
<li><strong>选 (Selector)</strong> ：组件只拿自己需要的那一小块数据，避免无效渲染。</li>
<li><strong>单 (Dispatch)</strong> ：改数据必须发 Action，不要在组件里直接改 State。</li>
</ol>
<h3 data-id="heading-11">什么时候用 Redux？</h3>
<ul>
<li><strong>跨页面共享</strong>：用户信息、购物车、全局主题。</li>
<li><strong>频繁变动</strong>：多处组件依赖同一个数据源。</li>
<li><strong>本地缓存</strong>：比如电视机播放白屏优化中的“离线资源列表”。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[openspec工作流解析：proposal、spec、tasks的明确分工与协作]]></title>    <link>https://juejin.cn/post/7600298554871726086</link>    <guid>https://juejin.cn/post/7600298554871726086</guid>    <pubDate>2026-01-29T01:18:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600298554871726086" data-draft-id="7600326291552403462" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="openspec工作流解析：proposal、spec、tasks的明确分工与协作"/> <meta itemprop="keywords" content="前端,后端,架构"/> <meta itemprop="datePublished" content="2026-01-29T01:18:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火车叼位"/> <meta itemprop="url" content="https://juejin.cn/user/1345457960792808"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            openspec工作流解析：proposal、spec、tasks的明确分工与协作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1345457960792808/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火车叼位
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T01:18:46.000Z" title="Thu Jan 29 2026 01:18:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>OpenSpec</strong> 是一个专为 AI 编码助手设计的规范驱动开发系统，旨在编写代码之前建立人与 AI 之间的对齐。通过在实现之前锁定意图，OpenSpec 提供了确定性、可审查的输出，而无需 API 密钥。</p>
<p>OpenSpec 引入了一个轻量级的规范工作流，改变了你与 AI 编码助手的协作方式。它不再依赖聊天历史记录来获取需求，而是创建了一个明确的结构化契约，供人类和 AI 工具持续参考。这种方法确保提案、任务和规范更新在整个开发生命周期中保持可见、可审计和明确。</p>
<p>该系统通过原生斜杠命令或 AGENTS.md 约定支持 20 多种 AI 工具，使其既灵活地集成到你现有的工作流中，又能提供足够的结构以在复杂的多文件更改中保持一致性。</p>
<hr/>
<h2 data-id="heading-0">三者定位：OpenSpec工具中的角色</h2>
<p><strong>在OpenSpec工具中，这三份文档具有明确的定位：</strong></p>
<ul>
<li><strong><code>proposal.md</code></strong> = 变更提案文档（为什么改、改什么、影响范围）</li>
<li><strong><code>spec.md</code></strong> = 规格定义文档（系统最终应该怎么工作）</li>
<li><strong><code>tasks.md</code></strong> = 任务执行清单（具体怎么完成、进度跟踪）</li>
</ul>
<p><strong>它们在OpenSpec工作流中的主次关系：</strong></p>
<ol>
<li>
<p><strong><code>proposal.md</code> 是决策起点</strong>：在使用OpenSpec管理变更时，任何改动都从创建proposal.md开始。它阐述变更的理由（Why）、概述内容（What）、明确影响范围（Impact）。这份文档是团队讨论是否接受该变更的决策依据，通常篇幅较短。</p>
</li>
<li>
<p><strong><code>spec.md</code> 定义验收标准</strong>：当proposal被接受后，需要编写spec.md来详细定义系统行为的规格说明。在OpenSpec中，spec通常采用BDD风格（WHEN/THEN）来定义需求和场景，它是验收的黄金标准，也是篇幅最长的文档。</p>
</li>
<li>
<p><strong><code>tasks.md</code> 指导具体执行</strong>：基于proposal的目标和spec的规格，tasks.md将变更拆解为可执行、可跟踪的任务列表，每个任务都带有checkbox。在OpenSpec工作流中，开发者按照tasks.md一步步完成，并打钩标记进度。</p>
</li>
</ol>
<p><strong>核心区别可以概括为：</strong></p>
<ul>
<li><strong>Proposal</strong> 回答"<strong>为什么要做这个变更</strong>"</li>
<li><strong>Spec</strong> 回答"<strong>变更后系统应该是什么样</strong>"</li>
<li><strong>Tasks</strong> 回答"<strong>如何一步步完成这个变更</strong>"</li>
</ul>
<h2 data-id="heading-1">OpenSpec工作流中的可视化关系</h2>
<p>为了更直观地理解它们在OpenSpec工具中的协作关系，我们可以用图表来描述。</p>
<p><strong>结构关系图</strong>展示了文档间的产出与参照关系：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[proposal.md&lt;br/&gt;变更提案] --&gt;|产出| B[spec.md&lt;br/&gt;规格定义]
    A --&gt;|分解为| C[tasks.md&lt;br/&gt;任务清单]
    B -.参照.-&gt; C
    
    classDef proposal fill:#e1f5ff,stroke:#0366d6,stroke-width:2px
    classDef spec fill:#fff5e1,stroke:#d73a49,stroke-width:2px
    classDef tasks fill:#e1ffe1,stroke:#22863a,stroke-width:2px
</code></pre>
<p><em>图表说明：在OpenSpec中，proposal.md是变更的起点，产出spec.md（定义验收标准）并分解为tasks.md（执行清单）。tasks在执行过程中会参照spec的验收标准。</em></p>
<p><strong>时序图</strong>展示了OpenSpec工作流中的时间顺序：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Dev as 开发者
    participant P as proposal.md
    participant S as spec.md
    participant T as tasks.md
    participant Code as 代码实现

    Dev-&gt;&gt;P: 1. 创建变更提案&lt;br/&gt;(Why/What/Impact)
    Note over P: 团队决策：是否接受变更？
    
    Dev-&gt;&gt;S: 2. 编写规格说明&lt;br/&gt;(WHEN/THEN 场景)
    Note over S: 定义验收标准
    
    Dev-&gt;&gt;T: 3. 分解任务清单&lt;br/&gt;(可执行步骤)
    Note over T: 规划实施路径
    
    loop 迭代开发
        Dev-&gt;&gt;Code: 4. 实现代码
        Code--&gt;&gt;T: 完成任务打钩 [x]
        Code--&gt;&gt;S: 满足规格场景
    end
    
    Note over Dev,Code: 所有 tasks 完成 + spec 通过验证&lt;br/&gt;→ 准备归档
</code></pre>
<p><em>图表说明：OpenSpec工作流始于变更提案决策，经过规格定义和任务规划，进入迭代开发，最终以完成所有任务并满足规格为结束标志，准备归档。</em></p>
<h2 data-id="heading-2">OpenSpec工作流的关键阶段</h2>
<p>在使用OpenSpec工具管理变更时，整个流程可以分为五个清晰的阶段：</p>
<ol>
<li><strong>提案阶段</strong>：在OpenSpec的changes目录下创建proposal.md，阐述变更理由，团队讨论并决定是否接受该变更。</li>
<li><strong>设计阶段</strong>：编写spec.md，明确变更后系统行为的详细契约和验收标准。这是OpenSpec强调的"设计先行"原则。</li>
<li><strong>规划阶段</strong>：编写tasks.md，将变更拆解为具体、可执行的任务项，每个任务都带有checkbox。</li>
<li><strong>开发阶段</strong>：按照tasks.md进行编码，并持续对照spec.md进行验证，完成一项打钩一项。OpenSpec鼓励"小步快跑"的迭代方式。</li>
<li><strong>归档阶段</strong>：当所有tasks完成且spec通过验证后，将整个变更文档从changes目录移至archive/目录，标志变更完结。</li>
</ol>
<h2 data-id="heading-3">实际案例：add-feedback-command</h2>
<p>以OpenSpec项目本身的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenspec%2Fopenspec%2Ftree%2Fmain%2Fchanges%2Fadd-feedback-command%25E5%258F%2598%25E6%259B%25B4%25E4%25B8%25BA%25E4%25BE%258B%25EF%25BC%258C%25E5%258F%25AF%25E4%25BB%25A5%25E6%25B8%2585%25E6%2599%25B0%25E5%259C%25B0%25E7%259C%258B%25E5%2588%25B0%25E4%25B8%2589%25E8%2580%2585%25E5%259C%25A8OpenSpec%25E5%25B7%25A5%25E5%2585%25B7%25E4%25B8%25AD%25E7%259A%2584%25E5%25AE%259E%25E9%2599%2585%25E5%25BA%2594%25E7%2594%25A8%25EF%25BC%259A" target="_blank" title="https://github.com/openspec/openspec/tree/main/changes/add-feedback-command%E5%8F%98%E6%9B%B4%E4%B8%BA%E4%BE%8B%EF%BC%8C%E5%8F%AF%E4%BB%A5%E6%B8%85%E6%99%B0%E5%9C%B0%E7%9C%8B%E5%88%B0%E4%B8%89%E8%80%85%E5%9C%A8OpenSpec%E5%B7%A5%E5%85%B7%E4%B8%AD%E7%9A%84%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%EF%BC%9A" ref="nofollow noopener noreferrer">github.com/openspec/op…</a></p>





























<table><thead><tr><th align="left">文件</th><th align="left">核心内容</th><th align="left">行数（约）</th><th align="left">在OpenSpec中的作用</th></tr></thead><tbody><tr><td align="left"><code>proposal.md</code></td><td align="left"><strong>Why</strong>: 需要收集用户反馈<br/><strong>What</strong>: 添加 <code>openspec feedback</code> 命令<br/><strong>Impact</strong>: 新增CLI命令、依赖 <code>gh</code> CLI</td><td align="left">21 行</td><td align="left"><strong>变更决策依据</strong>，说明变更必要性和范围</td></tr><tr><td align="left"><code>spec.md</code></td><td align="left">6个主要需求、20+个具体场景<br/>详细定义命令行为、错误处理、跨平台兼容性</td><td align="left">189 行</td><td align="left"><strong>验收标准定义</strong>，详细定义"正确"行为</td></tr><tr><td align="left"><code>tasks.md</code></td><td align="left">4大模块、30+个子任务<br/>从命令实现、参数解析到测试覆盖，全部带checkbox</td><td align="left">31 行</td><td align="left"><strong>执行路线图</strong>，指导开发一步步完成变更</td></tr></tbody></table>
<p>从这个案例可以看出，在OpenSpec工具中，<code>spec.md</code>是篇幅最大、最详细的文档，因为它承载了最终的质量标准；而<code>proposal.md</code>和<code>tasks.md</code>则更偏向于变更管理和执行规划。</p>
<h2 data-id="heading-4">小结与延伸</h2>
<p>在OpenSpec工具中，将<code>proposal.md</code>、<code>spec.md</code>和<code>tasks.md</code>清晰分离，是工具设计哲学的核心体现。这种分离确保了：</p>
<ul>
<li><strong>关注点分离</strong>：决策者、设计者和执行者都能获得最相关、最清晰的信息</li>
<li><strong>强制设计先行</strong>：在动手编码前必须思考清楚"为什么改"、"改什么"和"怎么改"</li>
<li><strong>可追溯性</strong>：从提案到实现，每个环节都有明确文档记录</li>
<li><strong>质量可控</strong>：通过spec.md的详细定义，确保最终交付符合预期</li>
</ul>
<p><strong>如果你想进一步了解OpenSpec工具的设计哲学：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenspec%2Fopenspec%2Fblob%2Fmain%2Fdocs%2F11-spec-vs-change-separation-model.md" target="_blank" title="https://github.com/openspec/openspec/blob/main/docs/11-spec-vs-change-separation-model.md" ref="nofollow noopener noreferrer">github.com/openspec/op…</a> - 理解OpenSpec中specs/和changes/目录的核心设计思想</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenspec%2Fopenspec%2Fblob%2Fmain%2Fdocs%2F15-archive-and-merge-process.md" target="_blank" title="https://github.com/openspec/openspec/blob/main/docs/15-archive-and-merge-process.md" ref="nofollow noopener noreferrer">github.com/openspec/op…</a> - 了解OpenSpec中变更完成后如何规范归档</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenspec%2Fopenspec%2Fblob%2Fmain%2Fdocs%2F10-directory-structure-conventions.md" target="_blank" title="https://github.com/openspec/openspec/blob/main/docs/10-directory-structure-conventions.md" ref="nofollow noopener noreferrer">github.com/openspec/op…</a> - 掌握OpenSpec项目的标准文件组织方式</li>
</ul>
<p>清晰定义每个文档的职责，是使用OpenSpec工具进行高效变更管理的重要基础。希望这篇解析能帮助你更好地理解和应用OpenSpec的文档工作流。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Tip: 如何使用AI提升学习效率]]></title>    <link>https://juejin.cn/post/7600967006893293577</link>    <guid>https://juejin.cn/post/7600967006893293577</guid>    <pubDate>2026-01-30T09:49:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600967006893293577" data-draft-id="7600953198746992646" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Tip: 如何使用AI提升学习效率"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-30T09:49:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="桦说编程"/> <meta itemprop="url" content="https://juejin.cn/user/2212689394274136"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Tip: 如何使用AI提升学习效率
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2212689394274136/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    桦说编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T09:49:04.000Z" title="Fri Jan 30 2026 09:49:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">如何使用AI提升学习效率</h2>
<p>这一节可能是我最近最关注和思考的，然而可能复杂的问题常常可以用简单的形式得到很好的解答。因为人们学习的底层原理并没有因为AI的出现而改变，曾经有一篇很有名的学习方法的论文，总结了所有人类已经研究过的学习方法，发现间隔学习、问题优先（使用测试）、不同任务混搭的学习效果最好。实际上，学习的效果取决于人的思考参与程度，比如一道数学题你自己推导一遍会记得更深，学游泳要下水，学编程要写代码。</p>
<p>没有灵丹妙药，学习需要付出脑力。</p>
<p>AI辅助学习有很多有用的形式，我使用最多的是 Notebooklm：</p>
<ol>
<li>根据知识库生成问题卡片，主动回忆并回答</li>
<li>一些原本优秀的书籍、教程依然优秀，他们会帮你保持思维的连贯性和心流状态</li>
<li>使用AI辅助复习，逐渐回忆起忘记的内容</li>
<li>生成音频对话，我推荐使用辩论形式，会获得不同角度的理解</li>
<li>生成教程式演示文稿，有时可以帮助你把复杂的问题简化，让简单的内容更容易记住</li>
</ol>
<p>下一篇文章准备举例说明如何使用AI成倍提升学习效率，欢迎关注。</p>
<p>作者：桦说编程<br/>
链接：<a href="https://juejin.cn/spost/7597634458697531398" target="_blank" title="https://juejin.cn/spost/7597634458697531398">juejin.cn/spost/75976…</a><br/>
来源：稀土掘金<br/>
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI与物联网结合：智能体的真正落地场景]]></title>    <link>https://juejin.cn/post/7600303087874703398</link>    <guid>https://juejin.cn/post/7600303087874703398</guid>    <pubDate>2026-01-29T01:43:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600303087874703398" data-draft-id="7600260767687442458" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI与物联网结合：智能体的真正落地场景"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-29T01:43:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LeonGao"/> <meta itemprop="url" content="https://juejin.cn/user/3976252950591149"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI与物联网结合：智能体的真正落地场景
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3976252950591149/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LeonGao
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T01:43:12.000Z" title="Thu Jan 29 2026 01:43:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0"><strong>引言</strong></h2>
<p>随着人工智能（AI）和物联网（IoT）的不断发展，二者的结合正在成为推动“万物智联”的关键力量。AI赋予物联网设备“学习、决策与优化”的能力，使其从“信息收集者”转变为“智能体”（Intelligent Agent）——不仅能感知环境，还能自主执行任务与协同决策。<br/>
本文将深入探讨AI与IoT的融合机制、技术实现方式及实际应用场景，帮助读者理解智能体如何在现实世界中真正落地。</p>
<hr/>
<h2 data-id="heading-1"><strong>一、背景与问题定义</strong></h2>
<p>传统物联网主要实现“互连互通”，即通过各种传感器收集数据，并将其上传至云端。但这种架构存在以下问题：</p>
<ol>
<li><strong>数据延迟与带宽浪费</strong>：大量原始数据上传云端，延迟高且成本大。</li>
<li><strong>缺乏自治能力</strong>：设备仅能执行预设规则，无法根据环境自适应。</li>
<li><strong>安全与隐私隐患</strong>：数据集中处理易造成隐私泄露与单点故障。</li>
</ol>
<p>这促使AI与IoT的融合成为趋势——让设备具备本地智能与自治能力，即 <strong>AIoT（Artificial Intelligence of Things）</strong> 。</p>
<hr/>
<h2 data-id="heading-2"><strong>二、技术实现与解决方案</strong></h2>
<h3 data-id="heading-3"><strong>1. 架构层次</strong></h3>
<p>AIoT系统可分为三层架构：</p>
<ul>
<li><strong>感知层（Perception Layer）</strong> ：传感器收集环境数据（温度、光强、位移等）。</li>
<li><strong>边缘智能层（Edge Intelligence Layer）</strong> ：设备或边缘节点进行AI推理与本地决策。</li>
<li><strong>云端协同层（Cloud Orchestration Layer）</strong> ：云端负责模型训练、数据分析与全局调优。</li>
</ul>
<p>这形成“云-边-端协同”的架构，使AI在物联网场景中具备实时性与可扩展性。</p>
<hr/>
<h3 data-id="heading-4"><strong>2. 技术实现示例</strong></h3>
<p>以下是一个基于Python与TensorFlow Lite的<strong>边缘AI温湿度监测系统</strong>示例：</p>
<h4 data-id="heading-5"><strong>(1) 硬件配置</strong></h4>
<ul>
<li>Raspberry Pi + DHT11 温湿度传感器</li>
<li>TensorFlow Lite 运行环境</li>
<li>本地模型文件 <code>temp_predict.tflite</code></li>
</ul>
<h4 data-id="heading-6"><strong>(2) 数据采集与推理代码</strong></h4>
<pre><code class="hljs language-ini" lang="ini">import tensorflow as tf
import Adafruit_DHT
import time

<span class="hljs-comment"># 加载边缘模型</span>
<span class="hljs-attr">interpreter</span> = tf.lite.Interpreter(model_path=<span class="hljs-string">"temp_predict.tflite"</span>)
interpreter.allocate_tensors()

<span class="hljs-attr">input_details</span> = interpreter.get_input_details()
<span class="hljs-attr">output_details</span> = interpreter.get_output_details()

<span class="hljs-attr">SENSOR</span> = Adafruit_DHT.DHT11
<span class="hljs-attr">PIN</span> = <span class="hljs-number">4</span>  <span class="hljs-comment"># GPIO 引脚编号</span>

def read_sensor():
    humidity, <span class="hljs-attr">temperature</span> = Adafruit_DHT.read_retry(SENSOR, PIN)
    return humidity, temperature

while True:
    humidity, <span class="hljs-attr">temp</span> = read_sensor()
    <span class="hljs-attr">input_data</span> = [[humidity, temp]]
    interpreter.set_tensor(input_details<span class="hljs-section">[0]</span><span class="hljs-section">['index']</span>, input_data)
    interpreter.invoke()
    <span class="hljs-attr">prediction</span> = interpreter.get_tensor(output_details[<span class="hljs-number">0</span>][<span class="hljs-string">'index'</span>])
    print(f"Current: {temp:.1f}°C, Predicted Trend: {prediction<span class="hljs-section">[0]</span>:.2f}")
    time.sleep(5)
</code></pre>
<h4 data-id="heading-7"><strong>(3) 机制说明</strong></h4>
<ul>
<li>通过本地模型预测环境变化趋势；</li>
<li>若检测到异常变化（如快速升温），系统可自动触发报警或调节空调；</li>
<li>云端周期性收集摘要数据，用于模型再训练与全局优化。</li>
</ul>
<hr/>
<h3 data-id="heading-8"><strong>3. 智能体的体现</strong></h3>
<p>在AIoT架构中，单一设备（例如智能空调）通过AI算法具备“自治智能”：</p>
<ul>
<li>根据环境数据自我调整参数；</li>
<li>与其他设备协作（例如窗帘、温控器）；</li>
<li>可在断网环境中独立运行。</li>
</ul>
<p>如下是其决策逻辑示例（伪代码）：</p>
<pre><code class="hljs language-css" lang="css">if temp &gt; <span class="hljs-number">30</span> and humidity &lt; <span class="hljs-number">40</span>:
    <span class="hljs-built_in">turn_on_air_conditioner</span>()
    <span class="hljs-built_in">send_log</span>(<span class="hljs-string">"Cooling started"</span>)
elif temp &lt; <span class="hljs-number">22</span>:
    <span class="hljs-built_in">turn_off_air_conditioner</span>()
else:
    <span class="hljs-built_in">maintain_state</span>()
</code></pre>
<p>这种自主逻辑让“设备”转变为真正的“智能体”。</p>
<hr/>
<h2 data-id="heading-9"><strong>三、优缺点分析与实践建议</strong></h2>






























<table><thead><tr><th>方面</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td><strong>实时性</strong></td><td>边缘处理减少延迟</td><td>模型计算资源受限</td></tr><tr><td><strong>安全性</strong></td><td>数据本地化保护隐私</td><td>边缘安全仍面临攻击风险</td></tr><tr><td><strong>可扩展性</strong></td><td>云端统一调优，支持设备协同</td><td>模型更新与同步需机制保障</td></tr><tr><td><strong>能耗与成本</strong></td><td>降低云端负载</td><td>硬件算力成本较高</td></tr></tbody></table>
<h3 data-id="heading-10"><strong>实践建议</strong></h3>
<ol>
<li><strong>采用轻量化模型</strong>（如TensorFlow Lite、ONNX Runtime、TinyML）以适配边缘算力。</li>
<li><strong>通过联邦学习（Federated Learning）</strong> 实现分布式智能体训练，保护隐私。</li>
<li><strong>建立统一的设备管理平台</strong>，实现智能体协作与升级管理。</li>
<li><strong>强化安全机制</strong>，如设备身份认证、加密通信、防篡改机制。</li>
</ol>
<hr/>
<h2 data-id="heading-11"><strong>四、结论</strong></h2>
<p>AI与物联网的深度融合，使得“智能体”不再停留在概念层面，而是真正进入家庭、工业、交通、能源等场景。<br/>
未来，随着<strong>低功耗AI芯片、5G/6G网络、边缘计算与大模型压缩技术</strong>的不断进步，AIoT将成为智能化社会的核心基础设施。</p>
<p>简而言之，<strong>AI赋予物联以灵魂，IoT赋予AI以载体</strong>——智能体的落地，将成为人机协作与智能社会的核心标志。</p>
<hr/>
<h2 data-id="heading-12"><strong>参考资料</strong></h2>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.tensorflow.org%2Flite" target="_blank" title="https://www.tensorflow.org/lite" ref="nofollow noopener noreferrer">Google TensorFlow Lite 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fieeexplore.ieee.org%2Fdocument%2F9390318" target="_blank" title="https://ieeexplore.ieee.org/document/9390318" ref="nofollow noopener noreferrer">Edge AI and IoT Integration – IEEE Xplore</a></li>
<li>李飞飞等，《人工智能导论》，清华大学出版社，2022年。</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.nvidia.com%2Fembedded-computing" target="_blank" title="https://developer.nvidia.com/embedded-computing" ref="nofollow noopener noreferrer">NVIDIA Jetson Edge AI 平台</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Git Commit 规范化实践 - 告别手动输入表情符号]]></title>    <link>https://juejin.cn/post/7600597995768021001</link>    <guid>https://juejin.cn/post/7600597995768021001</guid>    <pubDate>2026-01-29T09:32:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600597995768021001" data-draft-id="7600581247020384265" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Git Commit 规范化实践 - 告别手动输入表情符号"/> <meta itemprop="keywords" content="Git,GitHub"/> <meta itemprop="datePublished" content="2026-01-29T09:32:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="没多少逻辑"/> <meta itemprop="url" content="https://juejin.cn/user/2717648475395325"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Git Commit 规范化实践 - 告别手动输入表情符号
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2717648475395325/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    没多少逻辑
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T09:32:53.000Z" title="Thu Jan 29 2026 09:32:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    44
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">写在前面</h2>
<p>之前我一直手动在 commit 信息前加表情符号，比如 <code>✨ feat: xxx</code>、<code>🐛 fix: xxx</code>，每次都要去找对应的 emoji，有时候还会遗漏，挺麻烦的。最近发现了 commitizen + cz-git 这套方案，可以通过交互式界面自动生成规范的提交信息，分享给大家。</p>
<p>顺便推荐一下我在维护的开源项目 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgocronx-team%2Fgocron" target="_blank" title="https://github.com/gocronx-team/gocron" ref="nofollow noopener noreferrer">gocron</a> - 一个 Go 写的分布式定时任务管理系统，用来替代 Linux crontab 的，支持 Web 界面、秒级精度、任务依赖等功能。欢迎 Star ⭐️</p>
<h2 data-id="heading-1">对比效果</h2>
<p><strong>之前手动输入：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">✨</span> <span class="hljs-attr">feat:</span> <span class="hljs-string">add</span> <span class="hljs-string">task</span> <span class="hljs-string">dependency</span> <span class="hljs-string">feature</span>  <span class="hljs-comment"># 每次都要复制粘贴 emoji</span>
<span class="hljs-string">🐛</span> <span class="hljs-attr">fix:</span> <span class="hljs-string">fix</span> <span class="hljs-string">status</span> <span class="hljs-string">update</span> <span class="hljs-string">issue</span>
</code></pre>
<p><strong>现在交互式选择：</strong></p>
<pre><code class="hljs language-bash" lang="bash">pnpm run commit
<span class="hljs-comment"># 选择类型、范围、填写描述，自动生成带 emoji 的规范提交</span>
</code></pre>
<h2 data-id="heading-2">在gocron项目中使用案例</h2>
<p>gocron 项目已经配置好了，直接使用：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> gocron
pnpm install
pnpm run prepare

<span class="hljs-comment"># 提交代码</span>
git add .
pnpm run commit
</code></pre>
<h2 data-id="heading-3">在自己项目中配置</h2>
<h3 data-id="heading-4">1. 安装依赖</h3>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D @commitlint/cli @commitlint/config-conventional commitizen cz-git husky
</code></pre>
<h3 data-id="heading-5">2. 创建配置文件</h3>
<p>创建 <code>commitlint.config.cjs</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">extends</span>: [<span class="hljs-string">'@commitlint/config-conventional'</span>],
  <span class="hljs-attr">prompt</span>: {
    <span class="hljs-attr">types</span>: [
      { <span class="hljs-attr">value</span>: <span class="hljs-string">"✨ feat"</span>,     <span class="hljs-attr">name</span>: <span class="hljs-string">"feat:     ✨ 新增功能"</span> },
      { <span class="hljs-attr">value</span>: <span class="hljs-string">"🐛 fix"</span>,      <span class="hljs-attr">name</span>: <span class="hljs-string">"fix:      🐛 修复缺陷"</span> },
      { <span class="hljs-attr">value</span>: <span class="hljs-string">"📝 docs"</span>,     <span class="hljs-attr">name</span>: <span class="hljs-string">"docs:     📝 文档变更"</span> },
      { <span class="hljs-attr">value</span>: <span class="hljs-string">"💄 style"</span>,    <span class="hljs-attr">name</span>: <span class="hljs-string">"style:    💄 代码格式"</span> },
      { <span class="hljs-attr">value</span>: <span class="hljs-string">"♻️ refactor"</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"refactor: ♻️ 代码重构"</span> },
      { <span class="hljs-attr">value</span>: <span class="hljs-string">"⚡️ perf"</span>,     <span class="hljs-attr">name</span>: <span class="hljs-string">"perf:     ⚡️ 性能优化"</span> },
      { <span class="hljs-attr">value</span>: <span class="hljs-string">"✅ test"</span>,     <span class="hljs-attr">name</span>: <span class="hljs-string">"test:     ✅ 添加测试"</span> },
      { <span class="hljs-attr">value</span>: <span class="hljs-string">"📦️ build"</span>,    <span class="hljs-attr">name</span>: <span class="hljs-string">"build:    📦️ 构建变更"</span> },
      { <span class="hljs-attr">value</span>: <span class="hljs-string">"🎡 ci"</span>,       <span class="hljs-attr">name</span>: <span class="hljs-string">"ci:       🎡 CI 配置"</span> },
      { <span class="hljs-attr">value</span>: <span class="hljs-string">"⏪️ revert"</span>,   <span class="hljs-attr">name</span>: <span class="hljs-string">"revert:   ⏪️ 回滚"</span> },
      { <span class="hljs-attr">value</span>: <span class="hljs-string">"🔨 chore"</span>,    <span class="hljs-attr">name</span>: <span class="hljs-string">"chore:    🔨 其他修改"</span> }
    ],
    <span class="hljs-attr">skipQuestions</span>: [<span class="hljs-string">'breaking'</span>, <span class="hljs-string">'footerPrefix'</span>, <span class="hljs-string">'footer'</span>]
  }
}
</code></pre>
<h3 data-id="heading-6">3. 修改 package.json</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"prepare"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"husky"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"commit"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"git-cz"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"config"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"commitizen"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"path"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node_modules/cz-git"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-7">4. 初始化 husky</h3>
<pre><code class="hljs language-bash" lang="bash">pnpm run prepare
<span class="hljs-built_in">echo</span> <span class="hljs-string">"npx --no -- commitlint --edit \$1"</span> &gt; .husky/commit-msg
</code></pre>
<h2 data-id="heading-8">使用</h2>
<pre><code class="hljs language-bash" lang="bash">git add .
pnpm run commit
</code></pre>
<p>按提示操作：</p>
<ol>
<li>选择提交类型（自动带 emoji）</li>
<li>选择影响范围（可选）</li>
<li>填写简短描述</li>
<li>确认提交</li>
</ol>
<h2 data-id="heading-9">提交类型说明</h2>

































































<table><thead><tr><th>类型</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td>feat</td><td>新功能</td><td><code>✨ feat(task): 添加任务依赖配置</code></td></tr><tr><td>fix</td><td>Bug 修复</td><td><code>🐛 fix(api): 修复状态更新异常</code></td></tr><tr><td>docs</td><td>文档</td><td><code>📝 docs: 更新 API 文档</code></td></tr><tr><td>style</td><td>代码格式</td><td><code>💄 style: 统一代码缩进</code></td></tr><tr><td>refactor</td><td>重构</td><td><code>♻️ refactor: 重构任务调度逻辑</code></td></tr><tr><td>perf</td><td>性能优化</td><td><code>⚡️ perf: 优化查询性能</code></td></tr><tr><td>test</td><td>测试</td><td><code>✅ test: 添加单元测试</code></td></tr><tr><td>build</td><td>构建</td><td><code>📦️ build: 升级依赖</code></td></tr><tr><td>ci</td><td>CI 配置</td><td><code>🎡 ci: 添加 GitHub Actions</code></td></tr><tr><td>revert</td><td>回滚</td><td><code>⏪️ revert: 回滚某功能</code></td></tr><tr><td>chore</td><td>其他</td><td><code>🔨 chore: 更新 .gitignore</code></td></tr></tbody></table>
<h2 data-id="heading-10">相关链接</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgocronx-team%2Fgocron" target="_blank" title="https://github.com/gocronx-team/gocron" ref="nofollow noopener noreferrer">GoCron 项目</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgocron-docs.pages.dev" target="_blank" title="https://gocron-docs.pages.dev" ref="nofollow noopener noreferrer">GoCron 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcz-git.qbb.sh%2Fzh%2F" target="_blank" title="https://cz-git.qbb.sh/zh/" ref="nofollow noopener noreferrer">cz-git 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcommitlint.js.org%2F" target="_blank" title="https://commitlint.js.org/" ref="nofollow noopener noreferrer">Commitlint 文档</a></li>
</ul>
<hr/>
<p>如果觉得有用，欢迎给 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgocronx-team%2Fgocron" target="_blank" title="https://github.com/gocronx-team/gocron" ref="nofollow noopener noreferrer">gocron</a> 点个 Star ⭐️</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我不允许谁还不清楚function call在AI-Agent领域中流砥柱的地位]]></title>    <link>https://juejin.cn/post/7600296037543854080</link>    <guid>https://juejin.cn/post/7600296037543854080</guid>    <pubDate>2026-01-29T03:26:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600296037543854080" data-draft-id="7600293373476765696" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我不允许谁还不清楚function call在AI-Agent领域中流砥柱的地位"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-29T03:26:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="有态度的下等马"/> <meta itemprop="url" content="https://juejin.cn/user/448256476727662"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我不允许谁还不清楚function call在AI-Agent领域中流砥柱的地位
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/448256476727662/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    有态度的下等马
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T03:26:45.000Z" title="Thu Jan 29 2026 03:26:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前文提要：还有比ollama更傻瓜式的大模型本地部署方式吗 ？</p>
<h2 data-id="heading-0">1.<a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2F%40jamestang%2Fllm-function-calling-explained-a-deep-dive-into-the-request-and-response-payloads-894800fcad75" title="https://medium.com/@jamestang/llm-function-calling-explained-a-deep-dive-into-the-request-and-response-payloads-894800fcad75" target="_blank" ref="nofollow noopener noreferrer">function calling</a> 底层工作原理</h2>
<p>大模型重塑了我们与软件应用的交互方式， 其中最重要的特性就是 function calling 。</p>
<p>一种<strong>利用结构化输入/输出在LLM和编程应用之间建立桥梁</strong>的方式。</p>
<p>不管是当前火热的AI-agent还是MCP，了解function calling底层工作原理都至关重要，特别是request和response payload。</p>
<p>回顾上文我们与qwen大模型的对话：</p>
<p><code>what is the temperature in the capital of china today？</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93c158ad999046ebab870e1aabadd442~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262882&amp;x-signature=DbQP0xBsQB3dWsK1v%2FffgV3QqmA%3D" alt="" loading="lazy"/></p>
<p>一个由LLM驱动的应用， 回答这个问题，应用与LLM经历了三次对话。</p>
<p>① 第一次请求payload：</p>
<ul>
<li>message：标准的历史对话， 提供上下文context</li>
<li>tools：一系列的工具函数定义， 提供给LLM来选择</li>
</ul>
<p>LLM的响应payload：</p>
<ul>
<li><code>tool_calls.function.name</code>： LLM选中的工具函数<code>get_currentDate</code></li>
<li><code>tool_calls.id</code>： 由LLM为这个函数指定的id，后面会用到</li>
</ul>
<p>② 第二次request：</p>
<ul>
<li><code>messages.role.assistant</code>: 告诉LLM我们这次请求包含了上次function calling的结果</li>
<li><code>messages.role.tool</code>： 上次function calling执行的结果<code>2026-01-24</code></li>
</ul>
<p>LLM的响应payload：</p>
<p>如第一次类似：
本例也有<code>tool_calls</code>:包含LLM选中的函数<code>get_temperature()</code> 和所有的参数<code>beijing</code> <code>2026-01-24</code>。</p>
<p>③ 应用最后一次请求，包含所有信息</p>
<p>LLM推理认为不再需要外部工具，不再返回<code>tool_calls</code>,给出结合外部工具的对话结果。</p>
<hr/>
<p>从三次请求对话来看， LLM在三次对话的响应中体现了它的思考和逻辑步骤，应用持续被LLM引导做出行动，同时LLM也持续对应用的行为做出进一步思考和反馈。</p>
<h2 data-id="heading-1">2. agent的实现原理</h2>
<p>大模型是 AI 的大脑，其核心是理解自然语言，并做出回应，(文本)大模型本身只能接收一段文本，然后输出一段文本。</p>
<p>而当你希望大模型能使用一些工具自行获取所需的信息、执行一些动作，就需要使用 Tool 来实现了，拥有了 Tool 的大模型就像是拥有了手脚，可以和当下已有的 IT 基础设施进行交互。</p>
<blockquote>
<p>RAG给LLM装上实时知识外挂， 通过将信息检索与文本生成结合，让模型能引用外部权威信息生成回答，既保证了时效性，又提升了准确性。</p>
</blockquote>
<p>字节开源的<code>Eino</code>标榜的优势在于：</p>
<ol>
<li>
<p>LangChain，LlamaIndex等主流框架虽然起源自python强大的AI生态，但是也继承了python“弱类型检查”和“长期维护成本高”的诟病。 Eino作为golang下的开源agent开发框架，规避了这一问题。</p>
</li>
<li>
<p>另一方面， 借助字节系在agent领域的工程化实践，Eino既封装了领域内不变的通用核心和最佳实践，也能敏捷的反映业内技术动向。</p>
</li>
</ol>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cloudwego.io%2Fzh%2Fdocs%2Feino%2Fquick_start%2F" title="https://www.cloudwego.io/zh/docs/eino/quick_start/" target="_blank" ref="nofollow noopener noreferrer">Eino</a>框架结构图：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f8174a2cdb14bb2a570e232d69f5e1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262882&amp;x-signature=ahn0eXegCeZFRHfrCgU1BcH5JdM%3D" alt="" loading="lazy"/></p>
<p>Eino 有三大稳定内核： compose编排、components组件，common公共库。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cloudwego.io%2Fzh%2Fdocs%2Feino%2Foverview%2Fbytedance_eino_practice%2F" target="_blank" title="https://www.cloudwego.io/zh/docs/eino/overview/bytedance_eino_practice/" ref="nofollow noopener noreferrer">组件</a>一抹多,是原子能力的最小单位， <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cloudwego.io%2Fzh%2Fdocs%2Feino%2Fcore_modules%2Fchain_and_graph_orchestration%2F" target="_blank" title="https://www.cloudwego.io/zh/docs/eino/core_modules/chain_and_graph_orchestration/" ref="nofollow noopener noreferrer">编排</a>对这些组件进行组合、串连。</p>
<h2 data-id="heading-2">3.  中国首都今天的天气怎么样? 我母鸡啊</h2>
<p>我们使用Eino框架来实现本文的题目：
<code>what is  the temperature in the capital of china today</code>。</p>
<p>按照我们的分析，
从LLM的视角，要回答这个问题，经历了“思考-行动-观察-思考” 循环， 这是一个<code>ReAct</code>模式的agent。</p>
<p>下面基于阿里百炼 千问大模型，实现了天气对话，请自行从阿里百炼平台申请的apiKey替换到54行。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"context"</span>
	<span class="hljs-string">"fmt"</span>
	<span class="hljs-string">"log"</span>
	<span class="hljs-string">"os"</span>
	<span class="hljs-string">"time"</span>

	<span class="hljs-string">"github.com/cloudwego/eino-ext/components/model/qwen"</span>
	<span class="hljs-string">"github.com/cloudwego/eino/components/tool"</span>
	<span class="hljs-string">"github.com/cloudwego/eino/components/tool/utils"</span>
	<span class="hljs-string">"github.com/cloudwego/eino/compose"</span>
	<span class="hljs-string">"github.com/cloudwego/eino/schema"</span>
)

<span class="hljs-comment">// what is  the temperature in the capital of china today</span>

<span class="hljs-keyword">type</span> weatherReqParam <span class="hljs-keyword">struct</span> {
	City <span class="hljs-type">string</span> <span class="hljs-string">`json:"city"  jsonschema:"description=the name of the city"`</span>
	Date <span class="hljs-type">string</span> <span class="hljs-string">`json:"date"  jsonschema:"description=the date in the format of YYYY-MM-DD"`</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetTemperatureFunc</span><span class="hljs-params">(_ context.Context, p weatherReqParam)</span></span> (<span class="hljs-type">float64</span>, <span class="hljs-type">error</span>) {
	<span class="hljs-comment">// 这里直接mock一个温度值，实际应用中应该替换为真实的API调用</span>
	<span class="hljs-keyword">return</span> <span class="hljs-number">32</span>, <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">GetCurrentDateFunc</span><span class="hljs-params">(_ context.Context, _ <span class="hljs-keyword">struct</span>{})</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) {
	<span class="hljs-keyword">return</span> time.Now().Format(<span class="hljs-string">"2006-01-02"</span>), <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">of</span>[<span class="hljs-title">T</span> <span class="hljs-title">any</span>]<span class="hljs-params">(t T)</span></span> *T {
	<span class="hljs-keyword">return</span> &amp;t
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	getDateTool, err := utils.InferTool(<span class="hljs-string">"get_currentDate"</span>, <span class="hljs-string">"Get the current date"</span>, GetCurrentDateFunc)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-built_in">panic</span>(err)
	}
	getTemperatureTool, err := utils.InferTool(<span class="hljs-string">"get_temperature"</span>, <span class="hljs-string">"Get the temperature in the capital of the city"</span>, GetTemperatureFunc)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		<span class="hljs-built_in">panic</span>(err)
	}

	<span class="hljs-comment">// 初始化 tools</span>
	weatherTools := []tool.BaseTool{
		getDateTool,
		getTemperatureTool,
	}

	apiKey := os.Getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>)
	apiKey = <span class="hljs-string">"{}"</span>  <span class="hljs-comment">// 在阿里百炼平台申请签名</span>
	modelName := os.Getenv(<span class="hljs-string">"MODEL_NAME"</span>)
	modelName = <span class="hljs-string">"qwen3-max"</span>
	chatModel, err := qwen.NewChatModel(context.Background(), &amp;qwen.ChatModelConfig{
		BaseURL:     <span class="hljs-string">"https://dashscope.aliyuncs.com/compatible-mode/v1"</span>,
		APIKey:      apiKey,
		Timeout:     <span class="hljs-number">0</span>,
		Model:       modelName,
		MaxTokens:   of(<span class="hljs-number">2048</span>),
		Temperature: of(<span class="hljs-type">float32</span>(<span class="hljs-number">0.7</span>)),
		TopP:        of(<span class="hljs-type">float32</span>(<span class="hljs-number">0.7</span>)),
	})
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatalf(<span class="hljs-string">"NewChatModel of qwen failed, err=%v"</span>, err)
	}

	<span class="hljs-keyword">var</span> ctx = context.Background()
	<span class="hljs-comment">// 获取工具信息并绑定到 ChatModel</span>
	toolInfos := <span class="hljs-built_in">make</span>([]*schema.ToolInfo, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(weatherTools))
	<span class="hljs-keyword">for</span> _, tool := <span class="hljs-keyword">range</span> weatherTools {
		info, err := tool.Info(ctx)
		<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
			log.Fatal(err)
		}
		toolInfos = <span class="hljs-built_in">append</span>(toolInfos, info)
	}
	err = chatModel.BindTools(toolInfos)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatal(err)
	}

	<span class="hljs-comment">// 创建 tools 节点</span>
	weatherToolsNode, err := compose.NewToolNode(context.Background(), &amp;compose.ToolsNodeConfig{
		Tools: weatherTools,
	})
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatal(err)
	}

	<span class="hljs-comment">// 构建基于 Graph 的 Agent，实现 ReAct 模式（自动执行工具并生成自然语言回复）</span>

	<span class="hljs-comment">// 定义状态，用于保存对话历史</span>
	<span class="hljs-keyword">type</span> appState <span class="hljs-keyword">struct</span> {
		messages []*schema.Message
	}

	graph := compose.NewGraph[[]*schema.Message, *schema.Message](
		compose.WithGenLocalState(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context)</span></span> *appState {
			<span class="hljs-keyword">return</span> &amp;appState{}
		}),
	)

	<span class="hljs-comment">// 添加 ChatModel 节点</span>
	err = graph.AddChatModelNode(<span class="hljs-string">"qwen_chat_model"</span>, chatModel,
		compose.WithStatePreHandler(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, input []*schema.Message, state *appState)</span></span> ([]*schema.Message, <span class="hljs-type">error</span>) {
			<span class="hljs-comment">// 如果是第一次进入（从 Start），将输入（用户问题）添加到历史</span>
			<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(state.messages) == <span class="hljs-number">0</span> {
				state.messages = <span class="hljs-built_in">append</span>(state.messages, input...)
			}
			<span class="hljs-comment">// 始终将完整的历史记录作为 ChatModel 的输入</span>
			<span class="hljs-keyword">return</span> state.messages, <span class="hljs-literal">nil</span>
		}),
		compose.WithStatePostHandler(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, output *schema.Message, state *appState)</span></span> (*schema.Message, <span class="hljs-type">error</span>) {
			<span class="hljs-comment">// 将 ChatModel 的输出（可能是工具调用或最终回复）添加到历史</span>
			state.messages = <span class="hljs-built_in">append</span>(state.messages, output)
			<span class="hljs-keyword">return</span> output, <span class="hljs-literal">nil</span>
		}),
	)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatal(err)
	}

	<span class="hljs-comment">// 添加 Tools 节点</span>
	err = graph.AddToolsNode(<span class="hljs-string">"agent_tools"</span>, weatherToolsNode,
		compose.WithStatePostHandler(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, output []*schema.Message, state *appState)</span></span> ([]*schema.Message, <span class="hljs-type">error</span>) {
			<span class="hljs-comment">// 将工具执行结果添加到历史</span>
			state.messages = <span class="hljs-built_in">append</span>(state.messages, output...)
			<span class="hljs-keyword">return</span> output, <span class="hljs-literal">nil</span>
		}),
	)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatal(err)
	}

	<span class="hljs-comment">// 添加边和分支</span>
	_ = graph.AddEdge(compose.START, <span class="hljs-string">"qwen_chat_model"</span>)

	<span class="hljs-comment">// 如果有工具调用，流转到 tools；否则结束</span>
	_ = graph.AddBranch(<span class="hljs-string">"qwen_chat_model"</span>, compose.NewGraphBranch(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(ctx context.Context, msg *schema.Message)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) {
		<span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(msg.ToolCalls) &gt; <span class="hljs-number">0</span> {
			<span class="hljs-keyword">return</span> <span class="hljs-string">"agent_tools"</span>, <span class="hljs-literal">nil</span>
		}
		<span class="hljs-keyword">return</span> compose.END, <span class="hljs-literal">nil</span>
	}, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">bool</span>{<span class="hljs-string">"agent_tools"</span>: <span class="hljs-literal">true</span>, compose.END: <span class="hljs-literal">true</span>}))

	<span class="hljs-comment">// 工具执行完后，回流到 chat_model 生成回复</span>
	_ = graph.AddEdge(<span class="hljs-string">"agent_tools"</span>, <span class="hljs-string">"qwen_chat_model"</span>)

	<span class="hljs-comment">// 编译运行</span>
	agent, err := graph.Compile(ctx)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatal(err)
	}

	<span class="hljs-comment">// 运行示例</span>
	resp, err := agent.Invoke(ctx, []*schema.Message{
		{
			Role:    schema.User,
			Content: <span class="hljs-string">"what is the temperature in the capital of china today? please answer in a humam like way."</span>,
		},
	})
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		log.Fatal(err)
	}

	<span class="hljs-comment">// 输出结果</span>
	fmt.Println(resp.Content)
}

</code></pre>
<p>一开始我参照的官网的<code>chain</code>编排Eino组件，但是得到的结果是数字“32”， 并不是LLM对话的类人语言。</p>
<p>使用Trae的编码agent，20s就帮我改成了Graph形式的正确编码， 输出：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">The temperature <span class="hljs-keyword">in</span> Beijing, the capital of China, today (January <span class="hljs-number">28</span>, <span class="hljs-number">2026</span>) <span class="hljs-keyword">is</span> a warm <span class="hljs-number">32</span>°C! That’s quite hot <span class="hljs-keyword">for</span> <span class="hljs-keyword">this</span> time of year—make sure to stay hydrated and cool <span class="hljs-keyword">if</span> you’re <span class="hljs-keyword">out</span> and about!
</code></pre>
<blockquote>
<p>本例实际也可以使用<code>Chain</code>来完成，chain是一种特殊的、简化的graph，chain不能回头，本例需要手动串起来，Chain更适合确定性的编排。</p>
</blockquote>
<p>Graph就像一个自动化的流水线（loop），工人是 chat_model 和 tools ：</p>
<p>本例的Graph图如下，读者可以结合源代码理解。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afe66b9b3e89498f8802096181aa56dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770262882&amp;x-signature=%2BJulP4zHryucNgMwa07hjemOEPE%3D" alt="" loading="lazy"/></p>
<ol>
<li>START -&gt; chat_model
<ul>
<li>ChatModel 拿到用户问题，思考后说：“我需要查日期。”（输出包含 ToolCall）</li>
</ul>
</li>
<li>chat_model -&gt; tools (由 Branch 判断)
<ul>
<li>Tools 听到指令，去查日期，得到 "2026-01-24"。</li>
</ul>
</li>
<li>tools -&gt; chat_model (由 AddEdge 强制流转)
<ul>
<li>ChatModel 再次被唤醒。这次它的输入包含了之前的历史（用户问题 + 刚才的 ToolCall + 刚才的结果）。</li>
<li>它再次思考：“我知道日期了，现在我要查北京的温度。”（输出包含 ToolCall）</li>
</ul>
</li>
<li>chat_model -&gt; tools (再次循环)
<ul>
<li>Tools 去查温度，得到 "32度"。</li>
</ul>
</li>
<li>tools -&gt; chat_model (再次循环)
<ul>
<li>ChatModel 再次被唤醒。现在的输入更丰富了（所有历史）。</li>
<li>它再次思考：“日期有了，温度也有了，我可以直接回答用户了。”（输出 不包含 ToolCall）</li>
</ul>
</li>
<li>chat_model -&gt; END (由 Branch 判断)
<ul>
<li>循环结束。</li>
</ul>
</li>
</ol>
<p>最后我们重温全文，function calling（function tools）在agent中的作用：
在由LLM驱动的agent应用中，function calling（function tools）作为LLM的手脚，让LLM具备使用工具从外部获取最新信息并指导应用行为的能力，这一过程由结构化的输入输出参数来传递。</p>
<p>最近股市长虹，祝大家发大财。😄😄😄</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RBAC 权限系统实战（一）：页面级访问控制全解析]]></title>    <link>https://juejin.cn/post/7600600904094842914</link>    <guid>https://juejin.cn/post/7600600904094842914</guid>    <pubDate>2026-01-29T10:56:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600600904094842914" data-draft-id="7600600904094826530" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RBAC 权限系统实战（一）：页面级访问控制全解析"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-01-29T10:56:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="十五丶"/> <meta itemprop="url" content="https://juejin.cn/user/343495027727229"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RBAC 权限系统实战（一）：页面级访问控制全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/343495027727229/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    十五丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T10:56:23.000Z" title="Thu Jan 29 2026 10:56:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>本篇文章主要讲解 RBAC 权限方案在中后台管理系统的实现</p>
<p>在公司内部写过好几个后台系统，都需要实现权限控制，在职时工作繁多，没有系统性的来总结一下相关经验，现在人已离职，就把自己的经验总结一下，希望能帮助到你</p>
<blockquote>
<p>本文是<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbryqiu%2FBlog%3Ftab%3Dreadme-ov-file%23%25E9%2580%259A%25E4%25BF%2597%25E6%2598%2593%25E6%2587%2582%25E7%259A%2584%25E4%25B8%25AD%25E5%2590%258E%25E5%258F%25B0%25E7%25B3%25BB%25E7%25BB%259F%25E5%25BB%25BA%25E8%25AE%25BE%25E6%258C%2587%25E5%258D%2597%25E4%25B8%2593%25E6%25A0%258F" target="_blank" title="https://github.com/bryqiu/Blog?tab=readme-ov-file#%E9%80%9A%E4%BF%97%E6%98%93%E6%87%82%E7%9A%84%E4%B8%AD%E5%90%8E%E5%8F%B0%E7%B3%BB%E7%BB%9F%E5%BB%BA%E8%AE%BE%E6%8C%87%E5%8D%97%E4%B8%93%E6%A0%8F" ref="nofollow noopener noreferrer">《通俗易懂的中后台系统建设指南》</a>系列的第九篇文章，该系列旨在告诉你如何来构建一个优秀的中后台管理系统</p>
</blockquote>
<h2 data-id="heading-1">权限模型有哪些？</h2>
<p>主流的权限模型主要分为以下五种：</p>
<ul>
<li>ACL模型：访问控制列表</li>
<li>DAC模型：自主访问控制</li>
<li>MAC模型：强制访问控制</li>
<li>ABAC模型：基于属性的访问控制</li>
<li>RBAC模型：基于角色的权限访问控制</li>
</ul>
<p>这里不介绍全部的权限模型，有兴趣你可以看看这篇文章：<a href="https://juejin.cn/post/7121977695197970463" target="_blank" title="https://juejin.cn/post/7121977695197970463">权限系统就该这么设计，yyds</a></p>
<p>如果你看过、用过市面上一些开源后台系统及权限设计，你会发现它们主要都是基于 RBAC 模型来实现的</p>
<h2 data-id="heading-2">为什么是 RBAC 权限模型？</h2>
<p>好问题！我帮你问了下 AI</p>



































<table><thead><tr><th align="left">对比维度</th><th align="left">ACL (访问控制列表)</th><th align="left">RBAC (基于角色)</th><th align="left">ABAC (基于属性)</th></tr></thead><tbody><tr><td align="left"><strong>核心逻辑</strong></td><td align="left"><strong>用户 ↔ 权限</strong><br/>直接点对点绑定，无中间层</td><td align="left"><strong>用户 ↔ 角色 ↔ 权限</strong><br/>引入“角色”解耦，权限归于角色</td><td align="left"><strong>属性 + 规则 = 权限</strong><br/>动态计算 (Who, When, Where)</td></tr><tr><td align="left"><strong>优点</strong></td><td align="left">模型极简，开发速度快，适合初期 MVP</td><td align="left">结构清晰，<strong>复用性高</strong>，符合企业组织架构，维护成本低</td><td align="left">极度灵活，支持细粒度控制<br/>(如：只能在工作日访问)</td></tr><tr><td align="left"><strong>缺点</strong></td><td align="left">用户量大时维护工作呈指数级增长，极易出错</td><td align="left"><strong>角色爆炸</strong>：若特例过多，可能导致定义成百上千个角色</td><td align="left">开发复杂度极高，规则引擎难设计，有一定的性能消耗</td></tr><tr><td align="left"><strong>适用场景</strong></td><td align="left">个人博客、小型内部工具</td><td align="left"><strong>中大型后台系统、SaaS 平台 (行业标准)</strong></td><td align="left">银行风控、AWS IAM、国家安全级系统</td></tr></tbody></table>
<p>总结来说，在后台系统的场景下，RBAC 模型在灵活性（对比ACL）和复杂性（对比ABAC）上取得了一个很好的平衡</p>
<h2 data-id="heading-3">RBAC 概念理解</h2>
<p>RBAC 权限模型，全称 Role-Based Access Control，基于角色的权限访问控制</p>
<p>模型有三要素：</p>
<ul>
<li>用户（User）：系统主体，即操作系统的具体人员或账号</li>
<li>角色（Role）：角色是一组权限的集合，代表了用户在组织中的职能或身份</li>
<li>权限（Permission）：用户可以对系统资源进行的访问或操作能力</li>
</ul>
<p>RBAC 的设计是将角色绑定权限，用户绑定角色，从而实现权限控制</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/477cc8185d0244aaa6a073d8313920c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2B5LqU5Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770288982&amp;x-signature=6fTTIUFMJOrZGOxj7nfS%2BhqLnJg%3D" alt="image.png" loading="lazy"/></p>
<p>并且，它们之间的逻辑关系通常是多对多的：</p>
<p><strong>用户 - 角色 (User-Role)：</strong> 一个用户可以拥有多个角色（例如：某人既是“项目经理”又是“技术委员会成员”）</p>
<p><strong>角色 - 权限(Role-Permission)：</strong> 一个角色包含多个权限（例如：“人事经理”角色拥有“查看员工”、“编辑薪资”等权限）</p>
<h2 data-id="heading-4">主导权限控制的前端、后端方案</h2>
<p>市面上这些开源 Admin 的权限控制中，存在两种主要的权限主导方案：前端主导的权限方案和后端主导的权限方案</p>
<h3 data-id="heading-5">前端主导的权限方案</h3>
<p>前端主导的权限方案，一个主要的特征是菜单数据由前端维护，而不是存在数据库中</p>
<p>后端只需要在登录后给到用户信息，这个信息中会包含用户的角色，根据这个角色信息，前端可以筛选出具有权限的菜单、按钮</p>
<p>这种方案的主要逻辑放在前端，而不是后端数据库，所以安全性没保障，灵活性也较差，要更新权限，就需要改动前端代码并重新打包上线，无法支持“动态配置权限”</p>
<p>适合一些小型、简单系统</p>
<h3 data-id="heading-6">后端主导的权限方案</h3>
<p>后端控制方案，即登录后在返回用户信息时，还会给到此用户对应的菜单数据和按钮权限码等</p>
<p>菜单数据、按钮权限码等都存在数据库，这样一来，安全性、灵活性更高，要更新权限数据或用户权限控制，提供相应接口即可修改</p>
<blockquote>
<p>倒也不是说前端完全不用管菜单数据，而是前端只需要维护一些静态菜单数据，比如登录页、异常页(404、403...)</p>
</blockquote>
<p>在企业级后台系统中，后端主导的权限方案是比较常用的，本文只介绍后端主导的权限方案</p>
<h2 data-id="heading-7">权限方案整体流程</h2>
<p>在开始写代码之前，要清晰知道整体实现流程，我画了一张图来直观展示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24d25fc5a24b446eb3b46d1109e688ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2B5LqU5Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770288982&amp;x-signature=X8GZE0WmhkV99y%2BwVUpesaS5Fmc%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-8">后台系统中的 RBAC 权限实战</h2>
<h3 data-id="heading-9">权限菜单类型定义</h3>
<p>首先，在前后端人员配合中，我们最好约定一套菜单数据的结构，比如：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">RouteMeta</span>, <span class="hljs-title class_">RouteRecordRaw</span>, <span class="hljs-title class_">RouteRecordRedirectOption</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">Component</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">DefineComponent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">RouteType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'#/type'</span>;

<span class="hljs-keyword">declare</span> <span class="hljs-variable language_">global</span> {
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CustomRouteRecordRaw</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Omit</span>&lt;<span class="hljs-title class_">RouteRecordRaw</span>, 'meta'&gt; {
    <span class="hljs-comment">/**
     * 路由地址
     */</span>
    path?: <span class="hljs-built_in">string</span>;
    <span class="hljs-comment">/**
     * 路由名称
     */</span>
    name?: <span class="hljs-built_in">string</span>;
    <span class="hljs-comment">/**
     * 重定向路径
     */</span>
    redirect?: <span class="hljs-title class_">RouteRecordRedirectOption</span>;
    <span class="hljs-comment">/**
     * 组件
     */</span>
    component?: <span class="hljs-title class_">Component</span> | <span class="hljs-title class_">DefineComponent</span> | (<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">unknown</span>&gt;);
    <span class="hljs-comment">/**
     * 子路由信息
     */</span>
    children?: <span class="hljs-title class_">CustomRouteRecordRaw</span>[];
    <span class="hljs-comment">/**
     * 路由类型
     */</span>
    <span class="hljs-keyword">type</span>?: <span class="hljs-title class_">RouteType</span>;
    <span class="hljs-comment">/**
     * 元信息
     */</span>
    <span class="hljs-attr">meta</span>: {
      <span class="hljs-comment">/**
       * 菜单标题
       */</span>
      <span class="hljs-attr">title</span>: <span class="hljs-built_in">string</span>;
      <span class="hljs-comment">/**
       * 菜单图标
       */</span>
      menuIcon?: <span class="hljs-built_in">string</span>;
      <span class="hljs-comment">/**
       * 排序
       */</span>
      sort?: <span class="hljs-built_in">number</span>;
      <span class="hljs-comment">/**
       * 是否在侧边栏菜单中隐藏
       * <span class="hljs-doctag">@default</span> <span class="hljs-variable">false</span>
       */</span>
      hideMenu?: <span class="hljs-built_in">boolean</span>;
      <span class="hljs-comment">/**
       * 是否在面包屑中隐藏
       * <span class="hljs-doctag">@default</span> <span class="hljs-variable">false</span>
       */</span>
      hideBreadcrumb?: <span class="hljs-built_in">boolean</span>;
      <span class="hljs-comment">/**
       * 当只有一个子菜单时，是否隐藏父级菜单直接显示子菜单内容
       * <span class="hljs-doctag">@default</span> <span class="hljs-variable">false</span>
       */</span>
      hideParentIfSingleChild?: <span class="hljs-built_in">boolean</span>;
    };
  }

  <span class="hljs-comment">/**
   * 后端返回的权限路由类型定义
   */</span>
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">PermissionRoute</span> = <span class="hljs-title class_">Omit</span>&lt;<span class="hljs-title class_">CustomRouteRecordRaw</span>, <span class="hljs-string">'component'</span> | <span class="hljs-string">'children'</span> | <span class="hljs-string">'type'</span>&gt; &amp; {
    <span class="hljs-comment">/**
     * 路由ID
     */</span>
    id?: <span class="hljs-built_in">number</span>;
    <span class="hljs-comment">/**
     * 路由父ID
     */</span>
    parentId?: <span class="hljs-built_in">number</span>;
    <span class="hljs-comment">/**
     * 组件路径（后端返回时为字符串，前端处理后为组件）
     */</span>
    <span class="hljs-attr">component</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-comment">/**
     * 子路由信息
     */</span>
    children?: <span class="hljs-title class_">PermissionRoute</span>[];
    <span class="hljs-comment">/**
     * 路由类型
     */</span>
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">RouteType</span>;
  };
}

</code></pre>
<blockquote>
<p>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbryqiu%2Fvue-clean-admin%2Fblob%2Fmain%2Fsrc%2Ftypings%2Frouter.d.ts" target="_blank" title="https://github.com/bryqiu/vue-clean-admin/blob/main/src/typings/router.d.ts" ref="nofollow noopener noreferrer">router.d.ts</a> 找到类型文件</p>
</blockquote>
<p>以上面的类型定义为例，我们约定 <code>PermissionRoute</code> 类型是后端返回的权限路由类型：</p>
<p>我这里使用 ApiFox 来 Mock 权限路由数据，数据是这样的：</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fclean-admin.apifox.cn%2F" target="_blank" title="https://clean-admin.apifox.cn/" ref="nofollow noopener noreferrer">clean-admin ApiFox 文档在线地址</a></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d472ebe0289417aab9114ab52c82a2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2B5LqU5Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770288982&amp;x-signature=533qsuaKRIxS%2Bvb0FxFeUHlz7Mo%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-10">从登录页到路由守卫</h3>
<p>权限方案的第一步，是登录并拿到用户信息</p>
<p>假设我们现在用 Element Plus 搭建起了一个登录页面，当用户点击登录时，我们需要做这几件事：</p>
<ol>
<li>调用登录接口，将账号、密码发送给后端进行验证，验证通过则返回 JWT 信息</li>
<li>将返回的 JWT 信息保存到本地，后续每次请求都携带 Token 来识别用户身份并决定你能拿到的权限路由数据</li>
<li>触发路由守卫拦截</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d1195e632f74c2aa508c623555734ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2B5LqU5Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770288982&amp;x-signature=f%2FsehCMd98KQLSHYFgN9fuwg2Qg%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbryqiu%2Fvue-clean-admin%2Fblob%2Fmain%2Fsrc%2Fviews%2Fauth%2Fpage%2Faccount-login.vue" target="_blank" title="https://github.com/bryqiu/vue-clean-admin/blob/main/src/views/auth/page/account-login.vue" ref="nofollow noopener noreferrer">account-login.vue</a> 找到全部代码</p>
</blockquote>
<h3 data-id="heading-11">基本 Vue Router 配置</h3>
<p>登录完成后，我们就可以触发路由守卫了，但在写路由守卫之前，我们先来配置一下基本的 Vue Router</p>
<p>在整个权限系统中，我们将路由数据分为两种：</p>
<ol>
<li>静态路由：系统固定的路由，比如登录页、异常页(404、403...)</li>
<li>动态路由：由后端接口返回的用户角色对应的菜单路由数据</li>
</ol>
<p>静态路由是直接由前端定义，不会从后端接口返回、不会根据用户角色动态变化，所以这部分路由我们直接写好然后注册到 Vue Router 中即可</p>
<p>Vue Router 配置：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { createRouter, createWebHashHistory } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">RouteRecordRaw</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">App</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">ImportGlobRoutes</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./typing'</span>;
<span class="hljs-keyword">import</span> { extractRoutes } <span class="hljs-keyword">from</span> <span class="hljs-string">'./helpers'</span>;
<span class="hljs-keyword">import</span> { afterEachGuard, beforeEachGuard } <span class="hljs-keyword">from</span> <span class="hljs-string">'./guards'</span>;

<span class="hljs-comment">/** 静态路由 */</span>
<span class="hljs-keyword">const</span> staticRoutes = <span class="hljs-title function_">extractRoutes</span>(
  <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">glob</span>&lt;<span class="hljs-title class_">ImportGlobRoutes</span>&gt;([<span class="hljs-string">'./modules/constant-routes/**/*.ts'</span>], {
    <span class="hljs-attr">eager</span>: <span class="hljs-literal">true</span>,
  }),
);

<span class="hljs-comment">/** 系统路由 */</span>
<span class="hljs-keyword">const</span> systemRoutes = <span class="hljs-title function_">extractRoutes</span>(
  <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">glob</span>&lt;<span class="hljs-title class_">ImportGlobRoutes</span>&gt;([<span class="hljs-string">'./modules/system-routes/**/*.ts'</span>], {
    <span class="hljs-attr">eager</span>: <span class="hljs-literal">true</span>,
  }),
);

<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>({
  <span class="hljs-attr">history</span>: <span class="hljs-title function_">createWebHashHistory</span>(),
  <span class="hljs-attr">routes</span>: [...staticRoutes, ...systemRoutes] <span class="hljs-keyword">as</span> <span class="hljs-title class_">RouteRecordRaw</span>[],
  <span class="hljs-attr">strict</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">scrollBehavior</span>: <span class="hljs-function">() =&gt;</span> ({ <span class="hljs-attr">left</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">top</span>: <span class="hljs-number">0</span> }),
});

<span class="hljs-title function_">beforeEachGuard</span>(router);
<span class="hljs-title function_">afterEachGuard</span>(router);

<span class="hljs-comment">/** 初始化路由 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">initRouter</span>(<span class="hljs-params">app: App&lt;Element&gt;</span>) {
  app.<span class="hljs-title function_">use</span>(router);
}

<span class="hljs-keyword">export</span> { router, initRouter, staticRoutes };

</code></pre>
<blockquote>
<p>图中的静态路由和系统路由是同一类路由数据，即静态路由</p>
</blockquote>
<p>这个配置文件可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbryqiu%2Fvue-clean-admin%2Fblob%2Fmain%2Fsrc%2Frouter%2Findex.ts" target="_blank" title="https://github.com/bryqiu/vue-clean-admin/blob/main/src/router/index.ts" ref="nofollow noopener noreferrer">router/index.ts</a> 找到</p>
<p>这个基本的 Vue Router 配置，做了这么几件事：</p>
<ol>
<li>导入 <code>modules</code> 文件夹下的静态路由进行注册</li>
<li>路由初始化配置 <code>initRouter</code> ，在 <code>main.ts</code> 中调用</li>
<li>注册全局前置守卫 <code>beforeEach</code>、全局后置守卫 <code>afterEach</code></li>
</ol>
<p>我们实现动态路由注册的逻辑就写在 <code>beforeEach</code> 中</p>
<p>值得一提的是，使用了 <code>import.meta.glob</code> 来动态导入指定路径下的文件模块，这是 <code>Vite</code> 提供的一种导入方式，参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.vite.dev%2Fguide%2Ffeatures%23glob-import" target="_blank" title="https://cn.vite.dev/guide/features#glob-import" ref="nofollow noopener noreferrer">Vite Glob 导入</a></p>
<h3 data-id="heading-12">路由守卫与动态注册</h3>
<p>路由守卫是 Vue Router 提供的一种机制，主要用来通过跳转或取消的方式守卫导航：<a href="https://link.juejin.cn?target=https%3A%2F%2Frouter.vuejs.org%2Fzh%2Fguide%2Fadvanced%2Fnavigation-guards.html" target="_blank" title="https://router.vuejs.org/zh/guide/advanced/navigation-guards.html" ref="nofollow noopener noreferrer">Vue Router 路由守卫</a></p>
<p>重头戏在全局前置守卫 <code>router.beforeEach</code> 中实现，来看看我们做哪些事：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">ROUTE_NAMES</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../config'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">RouteRecordNameGeneric</span>, <span class="hljs-title class_">RouteRecordRaw</span>, <span class="hljs-title class_">Router</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>;
<span class="hljs-keyword">import</span> { getLocalAccessToken } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/permission'</span>;
<span class="hljs-keyword">import</span> { userService } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/services/api'</span>;
<span class="hljs-keyword">import</span> { nprogress } <span class="hljs-keyword">from</span> <span class="hljs-string">'./helpers'</span>;
<span class="hljs-keyword">import</span> { storeToRefs } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>;

<span class="hljs-comment">/** 登录认证页面：账号登录页、短信登录页、二维码登录页、忘记密码页、注册页... */</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">authPages</span>: <span class="hljs-title class_">RouteRecordNameGeneric</span>[] = [
  <span class="hljs-variable constant_">ROUTE_NAMES</span>.<span class="hljs-property">AUTH</span>,
  <span class="hljs-variable constant_">ROUTE_NAMES</span>.<span class="hljs-property">ACCOUNT_LOGIN</span>,
  <span class="hljs-variable constant_">ROUTE_NAMES</span>.<span class="hljs-property">SMS_LOGIN</span>,
  <span class="hljs-variable constant_">ROUTE_NAMES</span>.<span class="hljs-property">QR_LOGIN</span>,
  <span class="hljs-variable constant_">ROUTE_NAMES</span>.<span class="hljs-property">FORGOT_PASSWORD</span>,
  <span class="hljs-variable constant_">ROUTE_NAMES</span>.<span class="hljs-property">REGISTER</span>,
];

<span class="hljs-comment">/** 页面白名单：不需要登录也能访问的页面 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">pageWhiteList</span>: <span class="hljs-title class_">RouteRecordNameGeneric</span>[] = [...authPages];

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">beforeEachGuard</span>(<span class="hljs-params">router: Router</span>) {
  router.<span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> (to) =&gt; {
    <span class="hljs-comment">/** 进度条：开始 */</span>
    nprogress.<span class="hljs-title function_">start</span>();

    <span class="hljs-keyword">const</span> { <span class="hljs-attr">name</span>: <span class="hljs-title class_">RouteName</span> } = to;

    <span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>();
    <span class="hljs-keyword">const</span> { getAccessToken, getRoutesAddStatus, registerRoutes } = <span class="hljs-title function_">storeToRefs</span>(userStore);
    <span class="hljs-keyword">const</span> { setRoutesAddStatus, setUserInfo, logout } = userStore;

    <span class="hljs-comment">/** 访问令牌 */</span>
    <span class="hljs-keyword">const</span> accessToken = getAccessToken.<span class="hljs-property">value</span> || <span class="hljs-title function_">getLocalAccessToken</span>();

    <span class="hljs-comment">// 1.用户未登录（无 Token）</span>
    <span class="hljs-keyword">if</span> (!accessToken) {
      <span class="hljs-keyword">const</span> isWhitePage = pageWhiteList.<span class="hljs-title function_">includes</span>(<span class="hljs-title class_">RouteName</span>);
      <span class="hljs-comment">// 1.1 未登录，如果访问的是白名单中的页面，直接放行</span>
      <span class="hljs-keyword">if</span> (isWhitePage) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

      nprogress.<span class="hljs-title function_">done</span>();

      <span class="hljs-comment">// 1.2 未登录又不在白名单，则拦截并重定向到登录页</span>
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">name</span>: <span class="hljs-variable constant_">ROUTE_NAMES</span>.<span class="hljs-property">ACCOUNT_LOGIN</span> };
    }

    <span class="hljs-comment">// 如果已登录用户试图访问登录页，避免重复登录，要强制重定向到首页</span>
    <span class="hljs-keyword">if</span> (authPages.<span class="hljs-title function_">includes</span>(<span class="hljs-title class_">RouteName</span>)) {
      nprogress.<span class="hljs-title function_">done</span>();
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">name</span>: <span class="hljs-variable constant_">ROUTE_NAMES</span>.<span class="hljs-property">ROOT</span> };
    }

    <span class="hljs-comment">// 判断是否需要动态加载路由的操作</span>
    <span class="hljs-keyword">if</span> (!getRoutesAddStatus.<span class="hljs-property">value</span>) {
      <span class="hljs-comment">// isRoutesAdded 默认为 false（未持久化），在已经动态注册过时会设置为true，在页面刷新时会重置为 false</span>
      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 1.拉取用户信息</span>
        <span class="hljs-keyword">const</span> userInfo = <span class="hljs-keyword">await</span> userService.<span class="hljs-title function_">getUserInfo</span>();

        <span class="hljs-comment">// 2.将用户信息存入 Store</span>
        <span class="hljs-title function_">setUserInfo</span>(userInfo);

        <span class="hljs-comment">// 3.动态注册路由，registerRoutes 是处理后的路由表</span>
        registerRoutes.<span class="hljs-property">value</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">route</span>) =&gt;</span> {
          router.<span class="hljs-title function_">addRoute</span>(route <span class="hljs-keyword">as</span> <span class="hljs-built_in">unknown</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">RouteRecordRaw</span>);
        });

        <span class="hljs-comment">// 4.标记路由已添加</span>
        <span class="hljs-title function_">setRoutesAddStatus</span>(<span class="hljs-literal">true</span>);

        <span class="hljs-comment">// 5.中断当前导航，重新进入守卫</span>
        <span class="hljs-keyword">return</span> { ...to, <span class="hljs-attr">replace</span>: <span class="hljs-literal">true</span> };
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-comment">// 获取用户信息失败（如 Token 过期失效、网络异常）</span>
        <span class="hljs-title function_">logout</span>();
        nprogress.<span class="hljs-title function_">done</span>();
        <span class="hljs-comment">// 重定向回登录页，让用户重新登录</span>
        <span class="hljs-keyword">return</span> { <span class="hljs-attr">name</span>: <span class="hljs-variable constant_">ROUTE_NAMES</span>.<span class="hljs-property">ACCOUNT_LOGIN</span> };
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  });
}

</code></pre>
<blockquote>
<p>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbryqiu%2Fvue-clean-admin%2Fblob%2Fmain%2Fsrc%2Frouter%2Fguards%2Fbefore-each-guard.ts" target="_blank" title="https://github.com/bryqiu/vue-clean-admin/blob/main/src/router/guards/before-each-guard.ts" ref="nofollow noopener noreferrer">before-each-guard.ts</a> 找到全部代码</p>
</blockquote>
<p>上面的代码已经给出了很详细的注释，从整体角度来讲，我们做了两件事：</p>
<ol>
<li>处理一些情况，比如用户未登录、登录后访问登录页、白名单等情况</li>
<li>拉取用户信息，动态注册路由</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52a61b13fbbd43698183f2e65dee3b47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2B5LqU5Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770288982&amp;x-signature=bEbJ33PHj4SjT%2BBG4X%2BVC942%2BOA%3D" alt="image.png" loading="lazy"/></p>
<p>在路由守卫中“拉取用户信息”，一般来说，除了返回用户本身的信息外，还会给到权限路由信息、权限码信息，这里的数据结构可以跟后端进行约定</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e69f7c3abe341d4b51f2033820b757e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2B5LqU5Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770288982&amp;x-signature=ciXyPsIRKCJK%2BwXwvHogFOQlqBg%3D" alt="image.png" loading="lazy"/></p>
<p>比如在 vue-clean-admin 中，返回的数据结构是这样的：</p>
<blockquote>
<p>在 ApiFox 文档可以找到用户接口说明：<a href="https://link.juejin.cn?target=https%3A%2F%2Fclean-admin.apifox.cn%2F336121333e0" target="_blank" title="https://clean-admin.apifox.cn/336121333e0" ref="nofollow noopener noreferrer">ApiFox 文档 - 用户信息</a></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a1983f04833498ca8738fd8e027677c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2B5LqU5Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770288982&amp;x-signature=TEQWMgkv5Yb42BKazc%2BroN1epGE%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-13">后端路由结构的转化</h3>
<p>在通过“拉取用户信息”拿到路由数据后，并不是直接注册到 Vue Router，而是需要进行处理转化，才能符合 Vue Router 定义的路由表结构，<code>registerRoutes</code> 就是处理后的路由表，处理后的类型定义可以参考 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbryqiu%2Fvue-clean-admin%2Fblob%2Fmain%2Fsrc%2Ftypings%2Frouter.d.ts%23L7-L64" target="_blank" title="https://github.com/bryqiu/vue-clean-admin/blob/main/src/typings/router.d.ts#L7-L64" ref="nofollow noopener noreferrer"><code>CustomRouteRecordRaw</code></a></p>
<p>处理什么内容呢？</p>
<p>比如，接口拿到的路由数据字段 <code>component</code> 是一个字符串路径，这是一个映射路径，映射到前端项目下的真实组件路径</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e45648c28a1842d989038a603c9d8fdc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2B5LqU5Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770288982&amp;x-signature=3pupbwBxPl8RwEVJMSVXNGpW8Ws%3D" alt="image.png" loading="lazy"/></p>
<p>实现路由结构转换的代码，我写在了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbryqiu%2Fvue-clean-admin%2Fblob%2Fmain%2Fsrc%2Frouter%2Fhelpers.ts" target="_blank" title="https://github.com/bryqiu/vue-clean-admin/blob/main/src/router/helpers.ts" ref="nofollow noopener noreferrer">router/helpers.ts</a>，最主要逻辑是 <code>generateRoutes</code> 函数：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 生成符合 Vue Router 定义的路由表
 * <span class="hljs-doctag">@param</span> routes 未转化的路由数据
 * <span class="hljs-doctag">@returns</span> 符合结构的路由表
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateRoutes</span>(<span class="hljs-params">routes: PermissionRoute[]</span>): <span class="hljs-title class_">CustomRouteRecordRaw</span>[] {
  <span class="hljs-keyword">if</span> (!routes.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span> [];
  <span class="hljs-keyword">return</span> routes.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">route</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> { path, name, redirect, <span class="hljs-keyword">type</span>, meta } = route;
    <span class="hljs-keyword">const</span> <span class="hljs-attr">baseRoute</span>: <span class="hljs-title class_">Omit</span>&lt;<span class="hljs-title class_">CustomRouteRecordRaw</span>, <span class="hljs-string">'children'</span>&gt; = {
      path,
      name,
      redirect,
      <span class="hljs-keyword">type</span>,
      <span class="hljs-attr">component</span>: <span class="hljs-title function_">loadComponent</span>(route),
      <span class="hljs-attr">meta</span>: {
        ...meta,
        <span class="hljs-comment">// 是否在侧边栏菜单中隐藏</span>
        <span class="hljs-attr">hideMenu</span>: route.<span class="hljs-property">meta</span>?.<span class="hljs-property">hideMenu</span> || <span class="hljs-literal">false</span>,
        <span class="hljs-comment">// 是否在面包屑中隐藏</span>
        <span class="hljs-attr">hideBreadcrumb</span>: route.<span class="hljs-property">meta</span>?.<span class="hljs-property">hideBreadcrumb</span> || <span class="hljs-literal">false</span>,
        <span class="hljs-comment">// 当只有一个子菜单时，是否隐藏父级菜单直接显示子菜单内容</span>
        <span class="hljs-attr">hideParentIfSingleChild</span>: route.<span class="hljs-property">meta</span>?.<span class="hljs-property">hideParentIfSingleChild</span> || <span class="hljs-literal">false</span>,
      },
    };

    <span class="hljs-comment">// 是目录数据，设置重定向路径</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> === <span class="hljs-title class_">PermissionRouteTypeEnum</span>.<span class="hljs-property">DIR</span>) {
      baseRoute.<span class="hljs-property">redirect</span> = redirect || <span class="hljs-title function_">getRedirectPath</span>(route);
    }
    <span class="hljs-comment">// 递归处理子路由</span>
    <span class="hljs-keyword">const</span> processedChildren =
      route.<span class="hljs-property">children</span> &amp;&amp; route.<span class="hljs-property">children</span>.<span class="hljs-property">length</span> ? <span class="hljs-title function_">generateRoutes</span>(route.<span class="hljs-property">children</span>) : <span class="hljs-literal">undefined</span>;

    <span class="hljs-keyword">return</span> {
      ...baseRoute,
      ...(processedChildren ? { <span class="hljs-attr">children</span>: processedChildren } : {}),
    };
  });
}
</code></pre>
<p>经过 <code>generateRoutes</code> 处理的路由表，再 <code>addRoute</code> 到 Vue Router 中</p>
<h3 data-id="heading-14">侧边栏菜单的渲染</h3>
<p>当路由守卫的逻辑走完后，就进入到首页，在首页中，我们会根据路由表（转换过的）来渲染侧边栏菜单</p>
<p>侧边栏菜单是拿 Element Plus 的 <code>el-menu</code> 组件来做的，我们封装了一个菜单组件，除了渲染路由数据外，也更方便自定义配置菜单属性（<code>meta</code>）来实现一些功能</p>
<p>封装不难，就是拿处理后的路由表循环渲染 <code>menu-item</code>，根据 <code>meta</code> 配置项来实现"是否隐藏菜单"，"当只有一个子菜单时，是否隐藏父级菜单直接显示子菜单内容"等</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc22c2cff5504c7da9f622501542575d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y2B5LqU5Li2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770288982&amp;x-signature=N30nuLBJhKAnO0gn1RD1N8kky4E%3D" alt="image.png" loading="lazy"/></p>
<p>菜单组件的封装代码在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbryqiu%2Fvue-clean-admin%2Ftree%2Fmain%2Fsrc%2Flayout%2Fcomponents%2Fbasic-menu" target="_blank" title="https://github.com/bryqiu/vue-clean-admin/tree/main/src/layout/components/basic-menu" ref="nofollow noopener noreferrer">basic-menu</a> 文件夹中</p>
<p>到这一步，已经实现了动态权限路由及侧边栏菜单的渲染，但还不算完</p>
<p>因为我们还不能自由定义菜单信息、角色信息、用户信息来实现权限控制，在下一篇文章来聊聊管理模块</p>
<h2 data-id="heading-15">了解更多</h2>
<p>系列专栏地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbryqiu%2FBlog" target="_blank" title="https://github.com/bryqiu/Blog" ref="nofollow noopener noreferrer">GitHub 博客</a> | <a href="https://juejin.cn/column/7437267529330901026" target="_blank" title="https://juejin.cn/column/7437267529330901026">掘金专栏</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fsegmentfault.com%2Fblog%2Fadmin_guide" target="_blank" title="https://segmentfault.com/blog/admin_guide" ref="nofollow noopener noreferrer">思否专栏</a></p>
<p>实战项目：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbryqiu%2Fvue-clean-admin" target="_blank" title="https://github.com/bryqiu/vue-clean-admin" ref="nofollow noopener noreferrer">vue-clean-admin</a></p>
<h2 data-id="heading-16">交流讨论</h2>
<p>文章如有错误或需要改进之处，欢迎指正</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[飞书AI机器人流式输出实践：从消息编辑踩坑到卡片更新最佳方案]]></title>    <link>https://juejin.cn/post/7600990891206819867</link>    <guid>https://juejin.cn/post/7600990891206819867</guid>    <pubDate>2026-01-30T09:50:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600990891206819867" data-draft-id="7600953879500521523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="飞书AI机器人流式输出实践：从消息编辑踩坑到卡片更新最佳方案"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2026-01-30T09:50:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="moshuying"/> <meta itemprop="url" content="https://juejin.cn/user/2700056289356936"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            飞书AI机器人流式输出实践：从消息编辑踩坑到卡片更新最佳方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2700056289356936/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    moshuying
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T09:50:01.000Z" title="Fri Jan 30 2026 09:50:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文总结了在开发 AI Agent + 飞书机器人场景下，实现流式输出时踩过的坑和最终的工程方案。适合有飞书开放平台开发经验、正在构建 AI 应用的工程师阅读。</p>
</blockquote>
<h2 data-id="heading-0">一、背景与问题</h2>
<h3 data-id="heading-1">1.1 场景描述</h3>
<p>在 AI Agent 场景下，大模型的输出往往是<strong>流式</strong>的（Streaming），即内容逐步生成、逐步返回。为了提升用户体验，我们希望在飞书机器人中实现类似 ChatGPT 的「打字机效果」——用户发送消息后，机器人先回复一条「正在处理...」，然后随着 Agent 的输出不断更新这条消息，最终显示完整回复。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User as 用户
    participant Bot as 飞书机器人
    participant Agent as AI Agent
    
    User-&gt;&gt;Bot: 发送消息
    Bot-&gt;&gt;User: 回复「正在处理...」
    Bot-&gt;&gt;Agent: 调用 Agent
    loop 流式输出
        Agent--&gt;&gt;Bot: chunk_1
        Bot-&gt;&gt;User: 更新消息为 chunk_1
        Agent--&gt;&gt;Bot: chunk_1 + chunk_2
        Bot-&gt;&gt;User: 更新消息为 chunk_1 + chunk_2
    end
    Agent--&gt;&gt;Bot: 完整内容
    Bot-&gt;&gt;User: 最终更新
</code></pre>
<h3 data-id="heading-2">1.2 踩坑：消息编辑次数上限</h3>
<p>最初的实现方案是使用飞书的<strong>编辑消息 API</strong>（<code>PATCH /open-apis/im/v1/messages/:message_id</code>）来更新已发送的文本消息。</p>
<p><strong>问题暴露</strong>：当 Agent 输出较长、chunk 较多时，编辑请求会<strong>静默失败</strong>——API 返回成功，但消息内容不再更新。</p>
<p><strong>根因分析</strong>：飞书对单条消息的编辑次数有<strong>隐性上限</strong>（官方文档未明确说明具体数值），超过上限后编辑操作会被忽略。</p>




















<table><thead><tr><th>方案</th><th>编辑次数限制</th><th>适用场景</th></tr></thead><tbody><tr><td>消息编辑 API</td><td>有上限（约 20-30 次）</td><td>少量更新、非流式场景</td></tr><tr><td>卡片实体更新</td><td>无明确上限</td><td>高频更新、流式输出场景</td></tr></tbody></table>
<h2 data-id="heading-3">二、解决方案：卡片实体（CardKit）</h2>
<h3 data-id="heading-4">2.1 方案对比</h3>
<p>飞书提供了两种消息更新机制：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    subgraph 方案A["方案 A: 消息编辑"]
        A1[发送文本消息] --&gt; A2[获取 message_id]
        A2 --&gt; A3[调用编辑 API]
        A3 --&gt; A4{超过上限?}
        A4 --&gt;|是| A5[静默失败]
        A4 --&gt;|否| A3
    end
    
    subgraph 方案B["方案 B: 卡片实体"]
        B1[创建卡片实体] --&gt; B2[获取 card_id]
        B2 --&gt; B3[发送卡片消息]
        B3 --&gt; B4[调用卡片更新 API]
        B4 --&gt; B4
    end
</code></pre>
<p><strong>卡片实体的优势</strong>：</p>
<ol>
<li><strong>无编辑次数限制</strong>：适合高频更新场景</li>
<li><strong>支持 JSON 2.0</strong>：富文本、Markdown、交互组件等</li>
<li><strong>流式更新专用配置</strong>：<code>streaming_mode</code> 可优化客户端渲染</li>
</ol>
<h3 data-id="heading-5">2.2 核心流程</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User as 用户
    participant Bot as 飞书机器人
    participant CardKit as CardKit API
    participant Agent as AI Agent
    
    User-&gt;&gt;Bot: 发送消息
    Bot-&gt;&gt;CardKit: 创建卡片实体
    CardKit--&gt;&gt;Bot: 返回 card_id
    Bot-&gt;&gt;User: 发送卡片消息（关联 card_id）
    Bot-&gt;&gt;Agent: 调用 Agent
    loop 流式输出（带节流）
        Agent--&gt;&gt;Bot: accumulated_content
        Bot-&gt;&gt;CardKit: 更新卡片内容（card_id, seq++）
        CardKit--&gt;&gt;User: 推送更新
    end
    Bot-&gt;&gt;CardKit: 兜底更新（最终内容）
</code></pre>
<h2 data-id="heading-6">三、工程实现</h2>
<h3 data-id="heading-7">3.1 模块架构</h3>
<p>为了可维护性和可复用性，将飞书插件拆分为以下模块：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph feishu["飞书插件模块"]
        client["client.py&lt;br/&gt;主客户端 &amp; 事件路由"]
        card["card.py&lt;br/&gt;卡片创建/更新/发送"]
        message["message.py&lt;br/&gt;文本消息操作"]
        agent["agent.py&lt;br/&gt;Agent 流式调用"]
    end
    
    client --&gt; card
    client --&gt; message
    client --&gt; agent
    agent --&gt; card
    agent --&gt; message
</code></pre>

























<table><thead><tr><th>模块</th><th>职责</th></tr></thead><tbody><tr><td><code>client.py</code></td><td>主类，WebSocket 事件处理，消息路由</td></tr><tr><td><code>card.py</code></td><td>CardMixin：卡片模板、创建、更新、发送</td></tr><tr><td><code>message.py</code></td><td>MessageMixin：文本消息发送、回复、编辑</td></tr><tr><td><code>agent.py</code></td><td>Agent 流式调用，节流回调，兜底更新</td></tr></tbody></table>
<h3 data-id="heading-8">3.2 核心代码示例</h3>
<h4 data-id="heading-9">3.2.1 卡片创建与更新</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># card.py - 卡片相关功能</span>

<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path
<span class="hljs-keyword">from</span> lark_oapi.api.cardkit.v1 <span class="hljs-keyword">import</span> (
    Card, CreateCardRequest, CreateCardRequestBody,
    UpdateCardRequest, UpdateCardRequestBody,
)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CardMixin</span>:
    <span class="hljs-string">"""卡片相关方法的 Mixin 类"""</span>
    
    http_client: <span class="hljs-string">"lark.Client"</span>
    _card_sequence: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">int</span>]  <span class="hljs-comment"># 卡片序号管理</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_get_next_sequence</span>(<span class="hljs-params">self, card_id: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">int</span>:
        <span class="hljs-string">"""获取并递增卡片操作序号（必须严格递增）"""</span>
        seq = self._card_sequence.get(card_id, <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>
        self._card_sequence[card_id] = seq
        <span class="hljs-keyword">return</span> seq
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_card_entity</span>(<span class="hljs-params">self, content: <span class="hljs-built_in">str</span>, title: <span class="hljs-built_in">str</span> = <span class="hljs-string">"AI 助手"</span></span>) -&gt; <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""创建卡片实体，返回 card_id"""</span>
        card_data = {
            <span class="hljs-string">"schema"</span>: <span class="hljs-string">"2.0"</span>,
            <span class="hljs-string">"config"</span>: {<span class="hljs-string">"update_multi"</span>: <span class="hljs-literal">True</span>},  <span class="hljs-comment"># 共享卡片，所有人可见更新</span>
            <span class="hljs-string">"header"</span>: {<span class="hljs-string">"title"</span>: {<span class="hljs-string">"tag"</span>: <span class="hljs-string">"plain_text"</span>, <span class="hljs-string">"content"</span>: title}},
            <span class="hljs-string">"body"</span>: {
                <span class="hljs-string">"elements"</span>: [{<span class="hljs-string">"tag"</span>: <span class="hljs-string">"markdown"</span>, <span class="hljs-string">"content"</span>: content}]
            }
        }
        request = CreateCardRequest.builder() \
            .request_body(
                CreateCardRequestBody.builder()
                .<span class="hljs-built_in">type</span>(<span class="hljs-string">"card_json"</span>)
                .data(json.dumps(card_data))
                .build()
            ).build()
        
        response = self.http_client.cardkit.v1.card.create(request)
        <span class="hljs-keyword">if</span> response.success():
            <span class="hljs-keyword">return</span> response.data.card_id
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update_card_content</span>(<span class="hljs-params">self, card_id: <span class="hljs-built_in">str</span>, content: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-string">"""更新卡片内容"""</span>
        card_data = {
            <span class="hljs-string">"schema"</span>: <span class="hljs-string">"2.0"</span>,
            <span class="hljs-string">"config"</span>: {<span class="hljs-string">"update_multi"</span>: <span class="hljs-literal">True</span>},
            <span class="hljs-string">"body"</span>: {<span class="hljs-string">"elements"</span>: [{<span class="hljs-string">"tag"</span>: <span class="hljs-string">"markdown"</span>, <span class="hljs-string">"content"</span>: content}]}
        }
        seq = self._get_next_sequence(card_id)
        
        <span class="hljs-comment"># 注意：card 参数需要 Card 对象，不是字符串</span>
        card_obj = Card.builder() \
            .<span class="hljs-built_in">type</span>(<span class="hljs-string">"card_json"</span>) \
            .data(json.dumps(card_data)) \
            .build()
        
        request = UpdateCardRequest.builder() \
            .card_id(card_id) \
            .request_body(
                UpdateCardRequestBody.builder()
                .card(card_obj)
                .sequence(seq)  <span class="hljs-comment"># 必须严格递增</span>
                .build()
            ).build()
        
        <span class="hljs-keyword">return</span> self.http_client.cardkit.v1.card.update(request).success()
</code></pre>
<h4 data-id="heading-10">3.2.2 流式更新节流</h4>
<p>Agent 输出非常快，但飞书 API 有频率限制，需要<strong>节流</strong>处理：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># agent.py - Agent 流式调用</span>

<span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Callable</span>

<span class="hljs-comment"># 节流间隔（秒）- 控制更新频率</span>
UPDATE_THROTTLE_INTERVAL = <span class="hljs-number">0.5</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">make_throttled_callback</span>(<span class="hljs-params">
    do_update: <span class="hljs-type">Callable</span>[[<span class="hljs-built_in">str</span>], <span class="hljs-literal">None</span>],
    interval: <span class="hljs-built_in">float</span> = UPDATE_THROTTLE_INTERVAL,
</span>) -&gt; <span class="hljs-type">Callable</span>[[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">bool</span>], <span class="hljs-literal">None</span>]:
    <span class="hljs-string">"""
    创建带节流的回调函数
    - 每隔 interval 秒最多执行一次 do_update
    - is_last=True 时强制执行（保证最终内容同步）
    """</span>
    state = {<span class="hljs-string">"last_update_time"</span>: <span class="hljs-number">0.0</span>, <span class="hljs-string">"last_content"</span>: <span class="hljs-string">""</span>}
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">on_chunk</span>(<span class="hljs-params">accumulated: <span class="hljs-built_in">str</span>, is_last: <span class="hljs-built_in">bool</span></span>) -&gt; <span class="hljs-literal">None</span>:
        state[<span class="hljs-string">"last_content"</span>] = accumulated <span class="hljs-keyword">or</span> <span class="hljs-string">"正在处理..."</span>
        now = time.time()
        
        <span class="hljs-comment"># 节流逻辑：间隔足够 或 最后一次</span>
        <span class="hljs-keyword">if</span> is_last <span class="hljs-keyword">or</span> (now - state[<span class="hljs-string">"last_update_time"</span>]) &gt;= interval:
            do_update(state[<span class="hljs-string">"last_content"</span>])
            state[<span class="hljs-string">"last_update_time"</span>] = now
    
    <span class="hljs-keyword">return</span> on_chunk


<span class="hljs-keyword">def</span> <span class="hljs-title function_">run_agent_with_card</span>(<span class="hljs-params">
    plugin: <span class="hljs-string">"FeishuPlugin"</span>,
    card_id: <span class="hljs-built_in">str</span>,
    user_text: <span class="hljs-built_in">str</span>,
</span>) -&gt; <span class="hljs-literal">None</span>:
    <span class="hljs-string">"""使用卡片进行流式更新"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">do_update</span>(<span class="hljs-params">content: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-literal">None</span>:
        plugin.update_card_content(card_id, content)
    
    on_chunk = make_throttled_callback(do_update)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">_run</span>():
        <span class="hljs-comment"># 假设 run_agent_streaming 是 Agent 的流式调用函数</span>
        final = <span class="hljs-keyword">await</span> run_agent_streaming(user_text, on_chunk)
        <span class="hljs-comment"># 兜底更新：确保最终内容已同步</span>
        do_update(final <span class="hljs-keyword">or</span> <span class="hljs-string">"处理完成"</span>)
    
    <span class="hljs-comment"># 适配事件循环</span>
    <span class="hljs-keyword">try</span>:
        loop = asyncio.get_running_loop()
        loop.create_task(_run())
    <span class="hljs-keyword">except</span> RuntimeError:
        asyncio.run(_run())
</code></pre>
<h4 data-id="heading-11">3.2.3 消息处理主逻辑</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># client.py - 主客户端</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">FeishuPlugin</span>(CardMixin, MessageMixin):
    <span class="hljs-string">"""飞书机器人主类"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, app_id: <span class="hljs-built_in">str</span>, app_secret: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-comment"># ... 初始化 http_client, ws_client 等</span>
        self._card_sequence: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">int</span>] = {}  <span class="hljs-comment"># 卡片序号</span>
        self._processed_ids: <span class="hljs-built_in">set</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-built_in">set</span>()     <span class="hljs-comment"># 消息去重</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_message</span>(<span class="hljs-params">self, message_id: <span class="hljs-built_in">str</span>, user_text: <span class="hljs-built_in">str</span>, open_id: <span class="hljs-built_in">str</span></span>):
        <span class="hljs-string">"""处理用户消息"""</span>
        <span class="hljs-comment"># 1. 创建卡片实体</span>
        card_id = self.create_card_entity(<span class="hljs-string">"正在处理..."</span>, title=<span class="hljs-string">"🤖 AI 助手"</span>)
        
        <span class="hljs-keyword">if</span> card_id:
            <span class="hljs-comment"># 2. 发送卡片消息</span>
            self.send_card_message(open_id, card_id)
            <span class="hljs-comment"># 3. 启动 Agent 流式更新</span>
            run_agent_with_card(self, card_id, user_text)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># fallback: 普通消息（有编辑次数限制）</span>
            reply_id = self.send_text_message(open_id, <span class="hljs-string">"正在处理..."</span>)
            run_agent_with_message(self, reply_id, user_text)
</code></pre>
<h3 data-id="heading-12">3.3 SDK 踩坑记录</h3>
<h4 data-id="heading-13">坑 1：UpdateCardRequestBody.card 参数类型</h4>
<p><strong>错误写法</strong>：</p>
<pre><code class="hljs language-python" lang="python">UpdateCardRequestBody.builder().card(card_json_str)  <span class="hljs-comment"># ❌ 字符串</span>
</code></pre>
<p><strong>正确写法</strong>：</p>
<pre><code class="hljs language-python" lang="python">card_obj = Card.builder().<span class="hljs-built_in">type</span>(<span class="hljs-string">"card_json"</span>).data(card_json_str).build()
UpdateCardRequestBody.builder().card(card_obj)  <span class="hljs-comment"># ✅ Card 对象</span>
</code></pre>
<h4 data-id="heading-14">坑 2：sequence 必须严格递增</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 错误：每次都传 1</span>
.sequence(<span class="hljs-number">1</span>)  <span class="hljs-comment"># ❌ 第二次更新会失败</span>

<span class="hljs-comment"># 正确：维护递增序号</span>
seq = self._card_sequence.get(card_id, <span class="hljs-number">0</span>) + <span class="hljs-number">1</span>
self._card_sequence[card_id] = seq
.sequence(seq)  <span class="hljs-comment"># ✅</span>
</code></pre>
<h4 data-id="heading-15">坑 3：asyncio.run() 不能在已有事件循环中调用</h4>
<p>WebSocket 回调已在事件循环中，再调 <code>asyncio.run()</code> 会报错：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 错误</span>
asyncio.run(async_func())  <span class="hljs-comment"># ❌ RuntimeError</span>

<span class="hljs-comment"># 正确</span>
<span class="hljs-keyword">try</span>:
    loop = asyncio.get_running_loop()
    loop.create_task(async_func())  <span class="hljs-comment"># 挂到现有循环</span>
<span class="hljs-keyword">except</span> RuntimeError:
    asyncio.run(async_func())  <span class="hljs-comment"># 无循环时新建</span>
</code></pre>
<h2 data-id="heading-16">四、最佳实践总结</h2>
<h3 data-id="heading-17">4.1 架构设计</h3>





















<table><thead><tr><th>原则</th><th>说明</th></tr></thead><tbody><tr><td><strong>职责分离</strong></td><td>卡片、消息、Agent 调用拆分为独立模块</td></tr><tr><td><strong>Mixin 模式</strong></td><td>功能模块通过 Mixin 组合到主类</td></tr><tr><td><strong>优雅降级</strong></td><td>卡片创建失败时 fallback 到普通消息</td></tr></tbody></table>
<h3 data-id="heading-18">4.2 流式更新</h3>





















<table><thead><tr><th>策略</th><th>实现</th></tr></thead><tbody><tr><td><strong>节流</strong></td><td>每 0.5s 最多更新一次，避免打爆 API</td></tr><tr><td><strong>兜底</strong></td><td>流式结束后强制同步最终内容</td></tr><tr><td><strong>序号管理</strong></td><td>维护 <code>card_id → sequence</code> 映射，严格递增</td></tr></tbody></table>
<h3 data-id="heading-19">4.3 异常处理</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[收到用户消息] --&gt; B{创建卡片成功?}
    B --&gt;|是| C[发送卡片消息]
    B --&gt;|否| D[发送文本消息]
    C --&gt; E[启动 Agent]
    D --&gt; F[启动 Agent - fallback 模式]
    E --&gt; G{更新失败?}
    G --&gt;|是| H[记录日志, 继续]
    G --&gt;|否| I[继续更新]
    F --&gt; J[可能触发编辑上限]
</code></pre>
<h2 data-id="heading-20">五、总结</h2>





























<table><thead><tr><th>问题</th><th>解决方案</th></tr></thead><tbody><tr><td>消息编辑次数上限</td><td>改用卡片实体 + CardKit API</td></tr><tr><td>Agent 输出过快</td><td>节流回调，0.5s 更新一次</td></tr><tr><td>最终内容可能丢失</td><td>流式结束后兜底更新</td></tr><tr><td>SDK 参数类型坑</td><td>Card 对象而非字符串</td></tr><tr><td>异步上下文冲突</td><td>判断是否已有事件循环</td></tr></tbody></table>
<p>这套方案已在生产环境稳定运行，支持 Agent 输出上万字的长文本，更新次数不受限制。</p>
<hr/>
<h2 data-id="heading-21">附录：相关 API 文档</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.feishu.cn%2Fdocument%2FuAjLw4CM%2FukTMukTMukTM%2Fcardkit-v1%2Fcard%2Fcreate" target="_blank" title="https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/cardkit-v1/card/create" ref="nofollow noopener noreferrer">创建卡片实体</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.feishu.cn%2Fdocument%2FuAjLw4CM%2FukTMukTMukTM%2Fcardkit-v1%2Fcard%2Fupdate" target="_blank" title="https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/cardkit-v1/card/update" ref="nofollow noopener noreferrer">更新卡片实体</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.feishu.cn%2Fdocument%2FuAjLw4CM%2FukzMukzMukzM%2Ffeishu-cards%2Fcard-json-v2-structure" target="_blank" title="https://open.feishu.cn/document/uAjLw4CM/ukzMukzMukzM/feishu-cards/card-json-v2-structure" ref="nofollow noopener noreferrer">卡片 JSON 2.0 结构</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.feishu.cn%2Fdocument%2FuAjLw4CM%2FukzMukzMukzM%2Ffeishu-cards%2Fstreaming-updates-openapi-overview" target="_blank" title="https://open.feishu.cn/document/uAjLw4CM/ukzMukzMukzM/feishu-cards/streaming-updates-openapi-overview" ref="nofollow noopener noreferrer">流式更新卡片</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[结构化并发：告别线程泄露的优雅方案]]></title>    <link>https://juejin.cn/post/7600863478929621011</link>    <guid>https://juejin.cn/post/7600863478929621011</guid>    <pubDate>2026-01-30T09:52:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600863478929621011" data-draft-id="7600990891206836251" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="结构化并发：告别线程泄露的优雅方案"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-30T09:52:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="桦说编程"/> <meta itemprop="url" content="https://juejin.cn/user/2212689394274136"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            结构化并发：告别线程泄露的优雅方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2212689394274136/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    桦说编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T09:52:51.000Z" title="Fri Jan 30 2026 09:52:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是桦说编程。</p>
<blockquote>
<p>本文深入分析传统并发模型中 <code>Future.get()</code> 超时导致的线程泄露问题，并介绍结构化并发（Structured Concurrency）如何从根本上解决这一痛点。</p>
</blockquote>
<h2 data-id="heading-0">问题背景</h2>
<p>在高并发系统中，我们经常使用 <code>ExecutorService</code> 提交异步任务，然后通过 <code>Future.get(timeout)</code> 获取结果。看似合理的代码，却隐藏着一个致命问题——<strong>线程泄露</strong>。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);
Future&lt;String&gt; future = executor.submit(() -&gt; {
    <span class="hljs-comment">// 模拟慢速操作，如调用外部服务</span>
    Thread.sleep(<span class="hljs-number">5000</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-string">"result"</span>;
});

<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 超时 100ms 后放弃等待</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> future.get(<span class="hljs-number">100</span>, TimeUnit.MILLISECONDS);
} <span class="hljs-keyword">catch</span> (TimeoutException e) {
    <span class="hljs-comment">// 超时了，但任务还在后台运行！</span>
    log.warn(<span class="hljs-string">"Request timeout"</span>);
}
</code></pre>
<p><strong>问题核心</strong>：<code>Future.get()</code> 超时只是放弃了等待，<strong>底层任务仍在线程池中继续执行</strong>。</p>
<h2 data-id="heading-1">线程泄露的三种典型场景</h2>
<h3 data-id="heading-2">场景一：Future.get() 超时不取消</h3>
<p>这是最常见的情况。调用方设置了超时，但超时后只是 catch 异常继续执行，任务本身仍占用线程资源。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误示例：超时后任务继续运行</span>
<span class="hljs-keyword">try</span> {
    result = future.get(<span class="hljs-number">100</span>, TimeUnit.MILLISECONDS);
} <span class="hljs-keyword">catch</span> (TimeoutException e) {# 结构化并发：告别线程泄露的优雅方案

大家好，我是桦说编程。

&gt; 本文深入分析传统并发模型中 `Future.get()` 超时导致的线程泄露问题，并介绍结构化并发（Structured Concurrency）如何从根本上解决这一痛点。

## 问题背景

在高并发系统中，我们经常使用 `ExecutorService` 提交异步任务，然后通过 `Future.get(timeout)` 获取结果。看似合理的代码，却隐藏着一个致命问题——**线程泄露**。

```java
<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">10</span>);
Future&lt;String&gt; future = executor.submit(() -&gt; {
    <span class="hljs-comment">// 模拟慢速操作，如调用外部服务</span>
    Thread.sleep(<span class="hljs-number">5000</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-string">"result"</span>;
});

<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 超时 100ms 后放弃等待</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> future.get(<span class="hljs-number">100</span>, TimeUnit.MILLISECONDS);
} <span class="hljs-keyword">catch</span> (TimeoutException e) {
    <span class="hljs-comment">// 超时了，但任务还在后台运行！</span>
    log.warn(<span class="hljs-string">"Request timeout"</span>);
}
</code></pre>
<p><strong>问题核心</strong>：<code>Future.get()</code> 超时只是放弃了等待，<strong>底层任务仍在线程池中继续执行</strong>。</p>
<h2 data-id="heading-3">线程泄露的三种典型场景</h2>
<h3 data-id="heading-4">场景一：Future.get() 超时不取消</h3>
<p>这是最常见的情况。调用方设置了超时，但超时后只是 catch 异常继续执行，任务本身仍占用线程资源。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误示例：超时后任务继续运行</span>
<span class="hljs-keyword">try</span> {
    result = future.get(<span class="hljs-number">100</span>, TimeUnit.MILLISECONDS);
} <span class="hljs-keyword">catch</span> (TimeoutException e) {
    <span class="hljs-comment">// 任务仍在后台运行，线程被占用</span>
    <span class="hljs-keyword">return</span> defaultValue;
}
</code></pre>
<h3 data-id="heading-5">场景二：cancel() 无法中断阻塞操作</h3>
<p>即使调用 <code>future.cancel(true)</code>，如果任务内部在执行不可中断的阻塞操作（如 Socket I/O），线程依然无法释放。</p>
<pre><code class="hljs language-java" lang="java">Future&lt;String&gt; future = executor.submit(() -&gt; {
    <span class="hljs-comment">// Socket 读取是不可中断的！</span>
    <span class="hljs-keyword">return</span> httpClient.execute(request);  <span class="hljs-comment">// 阻塞在网络 I/O</span>
});

future.cancel(<span class="hljs-literal">true</span>);  <span class="hljs-comment">// 无效！线程仍被阻塞</span>
</code></pre>
<h3 data-id="heading-6">场景三：异常传播断裂</h3>
<p>父任务超时退出，但子任务不知道父任务已经不需要结果，继续执行完整逻辑。</p>
<pre><code class="hljs language-java" lang="java">Future&lt;Result&gt; parentTask = executor.submit(() -&gt; {
    Future&lt;Data&gt; childTask = executor.submit(() -&gt; {
        <span class="hljs-keyword">return</span> slowDatabaseQuery();  <span class="hljs-comment">// 耗时操作</span>
    });
    <span class="hljs-keyword">return</span> process(childTask.get());
});

parentTask.get(<span class="hljs-number">100</span>, TimeUnit.MILLISECONDS);  <span class="hljs-comment">// 超时</span>
<span class="hljs-comment">// parentTask 超时了，但 childTask 仍在执行数据库查询！</span>
</code></pre>
<h2 data-id="heading-7">线程泄露的危害</h2>
<p>在生产环境中，线程泄露会导致：</p>
<ol>
<li><strong>线程池耗尽</strong>：所有线程被"僵尸任务"占用，新请求无法执行</li>
<li><strong>系统响应变慢</strong>：线程切换开销增大，CPU 利用率飙升</li>
<li><strong>内存泄露</strong>：任务持有的对象无法被 GC 回收</li>
<li><strong>级联故障</strong>：下游服务超时 → 线程积压 → 上游超时 → 全链路雪崩</li>
</ol>
<h2 data-id="heading-8">传统解决方案的局限</h2>
<h3 data-id="heading-9">方案一：手动 cancel</h3>
<pre><code class="hljs language-java" lang="java">Future&lt;String&gt; future = executor.submit(task);
<span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">return</span> future.get(timeout, TimeUnit.MILLISECONDS);
} <span class="hljs-keyword">catch</span> (TimeoutException e) {
    future.cancel(<span class="hljs-literal">true</span>);  <span class="hljs-comment">// 尝试取消</span>
    <span class="hljs-keyword">throw</span> e;
} <span class="hljs-keyword">finally</span> {
    <span class="hljs-comment">// 问题：cancel 可能无效</span>
}
</code></pre>
<p><strong>局限</strong>：<code>cancel(true)</code> 依赖任务内部正确响应中断，很多三方库并不支持。</p>
<h3 data-id="heading-10">方案二：ExecutorService.invokeAll</h3>
<pre><code class="hljs language-java" lang="java">List&lt;Callable&lt;String&gt;&gt; tasks = Arrays.asList(task1, task2, task3);
List&lt;Future&lt;String&gt;&gt; futures = executor.invokeAll(tasks, timeout, TimeUnit.MILLISECONDS);
</code></pre>
<p><strong>局限</strong>：只适用于批量任务，无法处理动态创建的子任务。</p>
<h3 data-id="heading-11">方案三：CompletableFuture.orTimeout (Java 9+)</h3>
<pre><code class="hljs language-java" lang="java">CompletableFuture.supplyAsync(() -&gt; slowOperation())
    .orTimeout(<span class="hljs-number">100</span>, TimeUnit.MILLISECONDS)
    .exceptionally(ex -&gt; defaultValue);
</code></pre>
<p><strong>局限</strong>：超时后底层任务仍在执行，只是不再等待结果。</p>
<h2 data-id="heading-12">结构化并发：根本性解决方案</h2>
<p><strong>结构化并发（Structured Concurrency）</strong> 的核心思想是：<strong>让并发任务的生命周期与代码块的作用域绑定</strong>。就像结构化编程让控制流有明确的入口和出口，结构化并发让并发任务也有明确的开始和结束边界。</p>
<h3 data-id="heading-13">核心原则</h3>
<ol>
<li><strong>任务作用域</strong>：所有子任务必须在父任务的作用域内完成</li>
<li><strong>自动取消传播</strong>：父任务取消时，所有子任务自动取消</li>
<li><strong>异常聚合</strong>：子任务的异常能正确传播到父任务</li>
<li><strong>资源自动清理</strong>：作用域结束时，确保所有资源被释放</li>
</ol>
<h3 data-id="heading-14">Java 21 StructuredTaskScope</h3>
<p>Java 21 正式引入了 <code>StructuredTaskScope</code>（JEP 453），提供了结构化并发的原生支持：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">scope</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StructuredTaskScope</span>.ShutdownOnFailure()) {
    Subtask&lt;String&gt; user = scope.fork(() -&gt; fetchUser(userId));
    Subtask&lt;List&lt;Order&gt;&gt; orders = scope.fork(() -&gt; fetchOrders(userId));

    scope.joinUntil(Instant.now().plusMillis(<span class="hljs-number">100</span>));  <span class="hljs-comment">// 超时控制</span>
    scope.throwIfFailed();  <span class="hljs-comment">// 任一失败则抛异常</span>

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserProfile</span>(user.get(), orders.get());
}
<span class="hljs-comment">// 离开 try 块时，所有未完成的子任务自动取消！</span>
</code></pre>
<p><strong>关键优势</strong>：</p>
<ul>
<li><code>fork()</code> 创建的任务绑定到 scope 的生命周期</li>
<li><code>joinUntil()</code> 超时后，scope 关闭会自动取消所有子任务</li>
<li>try-with-resources 确保资源释放</li>
</ul>
<h3 data-id="heading-15">对比传统方式</h3>



































<table><thead><tr><th>特性</th><th>传统 Future</th><th>结构化并发</th></tr></thead><tbody><tr><td>超时取消</td><td>需手动 cancel</td><td>自动取消</td></tr><tr><td>子任务管理</td><td>无关联</td><td>生命周期绑定</td></tr><tr><td>异常处理</td><td>容易丢失</td><td>自动聚合</td></tr><tr><td>资源清理</td><td>需手动处理</td><td>自动清理</td></tr><tr><td>线程泄露</td><td>容易发生</td><td>从根本杜绝</td></tr></tbody></table>
<h2 data-id="heading-16">Java 8 环境下的结构化并发实现</h2>
<p>由于很多项目仍在使用 Java 8，我们可以借鉴结构化并发的思想，实现一个简化版本：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StructuredScope</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AutoCloseable</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ExecutorService executor;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> List&lt;Future&lt;?&gt;&gt; tasks = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CopyOnWriteArrayList</span>&lt;&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicBoolean</span> <span class="hljs-variable">shutdown</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicBoolean</span>(<span class="hljs-literal">false</span>);

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">StructuredScope</span><span class="hljs-params">(ExecutorService executor)</span> {
        <span class="hljs-built_in">this</span>.executor = executor;
    }

    <span class="hljs-keyword">public</span> &lt;R&gt; Future&lt;R&gt; <span class="hljs-title function_">fork</span><span class="hljs-params">(Callable&lt;R&gt; task)</span> {
        <span class="hljs-keyword">if</span> (shutdown.get()) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"Scope already shutdown"</span>);
        }
        Future&lt;R&gt; future = executor.submit(() -&gt; {
            <span class="hljs-keyword">if</span> (shutdown.get()) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CancellationException</span>(<span class="hljs-string">"Scope shutdown"</span>);
            }
            <span class="hljs-keyword">return</span> task.call();
        });
        tasks.add(future);
        <span class="hljs-keyword">return</span> future;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">joinAll</span><span class="hljs-params">(<span class="hljs-type">long</span> timeout, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> TimeoutException {
        <span class="hljs-type">long</span> <span class="hljs-variable">deadline</span> <span class="hljs-operator">=</span> System.nanoTime() + unit.toNanos(timeout);
        <span class="hljs-keyword">for</span> (Future&lt;?&gt; task : tasks) {
            <span class="hljs-type">long</span> <span class="hljs-variable">remaining</span> <span class="hljs-operator">=</span> deadline - System.nanoTime();
            <span class="hljs-keyword">if</span> (remaining &lt;= <span class="hljs-number">0</span>) {
                shutdown();
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimeoutException</span>(<span class="hljs-string">"Scope timeout"</span>);
            }
            <span class="hljs-keyword">try</span> {
                task.get(remaining, TimeUnit.NANOSECONDS);
            } <span class="hljs-keyword">catch</span> (TimeoutException e) {
                shutdown();
                <span class="hljs-keyword">throw</span> e;
            } <span class="hljs-keyword">catch</span> (Exception e) {
                <span class="hljs-comment">// 记录但继续等待其他任务</span>
            }
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shutdown</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (shutdown.compareAndSet(<span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>)) {
            <span class="hljs-keyword">for</span> (Future&lt;?&gt; task : tasks) {
                task.cancel(<span class="hljs-literal">true</span>);
            }
        }
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> {
        shutdown();
    }
}
</code></pre>
<p>使用方式：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">try</span> (StructuredScope&lt;String&gt; scope = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StructuredScope</span>&lt;&gt;(executor)) {
    Future&lt;String&gt; user = scope.fork(() -&gt; fetchUser(userId));
    Future&lt;List&lt;Order&gt;&gt; orders = scope.fork(() -&gt; fetchOrders(userId));

    scope.joinAll(<span class="hljs-number">100</span>, TimeUnit.MILLISECONDS);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserProfile</span>(user.get(), orders.get());
}
<span class="hljs-comment">// 超时或异常时，所有任务自动取消</span>
</code></pre>
<h2 data-id="heading-17">最佳实践</h2>
<h3 data-id="heading-18">1. 任务内部正确响应中断</h3>
<pre><code class="hljs language-java" lang="java">executor.submit(() -&gt; {
    <span class="hljs-keyword">while</span> (!Thread.currentThread().isInterrupted()) {
        <span class="hljs-comment">// 处理逻辑</span>
        <span class="hljs-keyword">if</span> (Thread.interrupted()) {
            cleanup();
            <span class="hljs-keyword">return</span>;
        }
    }
});
</code></pre>
<h3 data-id="heading-19">2. 设置合理的超时层级</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 外层超时 &gt; 内层超时，留出取消的时间窗口</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">var</span> <span class="hljs-variable">scope</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StructuredScope</span>(executor)) {
    Future&lt;A&gt; a = scope.fork(() -&gt; callServiceA(innerTimeout));
    Future&lt;B&gt; b = scope.fork(() -&gt; callServiceB(innerTimeout));
    scope.joinAll(outerTimeout, TimeUnit.MILLISECONDS);
}
</code></pre>
<h2 data-id="heading-20">总结</h2>
<ul>
<li><strong>线程泄露根因</strong>：<code>Future.get()</code> 超时只放弃等待，不取消任务；<code>cancel()</code> 依赖任务响应中断</li>
<li><strong>结构化并发核心</strong>：让任务生命周期与代码作用域绑定，作用域结束时自动取消所有任务。可以视为黑盒。</li>
<li><del><strong>Java 21+ 推荐</strong>：使用 <code>StructuredTaskScope</code> 原生支持</del></li>
<li><strong>关键实践</strong>：任务内部必须正确响应中断，使用可中断的 I/O 操作</li>
</ul>
<hr/>
<p>如果这篇文章对你有帮助，欢迎关注我，持续分享高质量技术干货，助你更快提升编程能力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[代码签名证书：数字化时代软件安全的必然趋势]]></title>    <link>https://juejin.cn/post/7600622206269554698</link>    <guid>https://juejin.cn/post/7600622206269554698</guid>    <pubDate>2026-01-30T01:24:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600622206269554698" data-draft-id="7600674821307842596" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="代码签名证书：数字化时代软件安全的必然趋势"/> <meta itemprop="keywords" content="算法,架构"/> <meta itemprop="datePublished" content="2026-01-30T01:24:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JoySSL数字加密证书"/> <meta itemprop="url" content="https://juejin.cn/user/4162089392540587"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            代码签名证书：数字化时代软件安全的必然趋势
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4162089392540587/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JoySSL数字加密证书
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T01:24:10.000Z" title="Fri Jan 30 2026 01:24:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>从日常使用的手机应用，到企业依赖的业务系统，软件的广泛应用极大地提升了效率与便利性。然而，软件安全问题却如影随形，恶意软件、代码篡改等威胁层出不穷，给用户和企业带来了巨大的损失。</p>
<p>2025年全年，全球因软件安全漏洞导致的经济损失超过1.8万亿美元，同比增长15%，其中恶意软件攻击事件占比高达42%。在这样的背景下，代码签名证书作为保障软件安全的核心工具，已逐渐成为数字化时代的标配，而国内知名数字证书品牌     [JoySSL] 凭借其专业能力和本地化服务，正引领着代码签名证书行业的发展。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d67f26a7f3104d8b91131a320d24552f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSm95U1NM5pWw5a2X5Yqg5a-G6K-B5Lmm:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770370181&amp;x-signature=u9iF9DcjXb%2FIkDPim2m7bflPqSs%3D" alt="代码签名.jpg" loading="lazy"/></p>
<h2 data-id="heading-0">一、代码签名证书：软件安全的“数字身份证”</h2>
<h3 data-id="heading-1">1.1 核心原理与功能</h3>
<p>代码签名证书是一种由受信任的证书颁发机构（CA）签发的数字证书，它允许开发者对应用程序代码进行签名，以验证软件的完整性和来源。当用户下载或安装应用程序时，操作系统能够通过代码签名来确认该应用程序是由合法的开发者创建的，并且在传输过程中没有被篡改。</p>
<p>其工作原理基于公钥密码学体系：开发者使用私钥对软件的哈希值进行加密，生成数字签名。用户在下载软件时，操作系统会使用公钥对数字签名进行解密，并重新计算软件的哈希值，与签名中的哈希值进行比对。如果两者一致，则证明软件未被篡改，来源可信；反之则会触发安全警告。</p>
<h3 data-id="heading-2">1.2 类型与适用场景</h3>
<p>代码签名证书主要分为标准OV代码签名证书和EV扩展验证代码签名证书。OV证书通过验证企业身份，为软件提供基础的可信标识，适用于大多数通用软件；EV证书则采用更严格的身份审核流程，且私钥存储在硬件加密设备中，安全性更高，适合金融、政务等对安全要求极高的行业场景。</p>
<p>例如，微软等平台要求驱动程序提交前必须使用代码签名证书进行签名，并指定使用SHA256算法，自2016年起逐步淘汰SHA1算法。国内智能家居企业小米在其IoT设备固件发布中，全面采用EV代码签名证书，有效防止了固件被篡改和恶意植入，保障了5000万以上设备的安全运行。</p>
<h2 data-id="heading-3">二、代码签名证书成为软件安全刚需的三大原因</h2>
<h3 data-id="heading-4">2.1 遏制恶意软件传播，守护用户安全</h3>
<p>在软件市场中，存在着大量伪装成合法软件的恶意程序，它们可能窃取用户的个人信息、破坏系统数据甚至控制用户的设备。通过代码签名，用户可以轻松识别出这些恶意软件，避免下载和安装，从而大大降低感染风险。</p>
<p>2025年，国内某办公软件开发商曾因未使用代码签名证书，导致软件被黑客篡改并植入窃密模块，超10万用户账号信息泄露，企业不仅赔偿用户损失超500万元，还流失了30%的客户。启用代码签名证书后，软件篡改尝试均被系统拦截，未再发生安全事故，成功守住代码安全防线。</p>
<h3 data-id="heading-5">2.2 构建信任体系，提升软件分发效率</h3>
<p>许多操作系统和浏览器在打开未签名的应用程序时，都会展示“未知发布者”的警告信息，这会导致70%以上的用户放弃安装。而拥有签名的软件则可以绕过这些警告，提供更流畅的安装体验。某SaaS企业使用EV代码签名证书后，企业客户的安装转化率提升了45%，用户咨询量减少了30%。</p>
<p>此外，时间戳功能可确保证书过期后已签名代码仍有效，避免了因证书到期导致已发布软件无法正常运行的问题。</p>
<h3 data-id="heading-6">2.3 满足合规要求，规避法律风险</h3>
<p>随着《网络安全法》《数据安全法》等法律法规的不断完善，软件安全合规已成为企业运营的底线要求。例如，金融行业的软件必须通过等保三级以上认证，而代码签名证书是等保认证的必要条件之一。</p>
<p>2025年，国内某P2P平台因未对其客户端软件进行代码签名，被监管部门处以200万元罚款，并要求限期整改。而使用JoySSL代码签名证书的企业，在合规审核中通过率高达98%。</p>
<h2 data-id="heading-7">三、JoySSL：国内代码签名证书行业标杆</h2>
<h3 data-id="heading-8">3.1 本土化服务优势</h3>
<p>作为国内领先的数字证书服务商，JoySSL深知国内企业的需求与痛点。与国际品牌相比，JoySSL提供7*24小时中文技术支持，响应速度提升60%，证书申请周期缩短至1-3个工作日，远快于国际品牌的5-7个工作日。</p>
<p>针对国内企业对国密算法的需求，JoySSL率先推出支持SM2/SM3/SM4国密算法的代码签名证书，满足了金融、政务等领域的合规要求。目前，已有超过300家政府机构和央企选择JoySSL的国密代码签名证书服务。</p>
<h3 data-id="heading-9">3.2 全场景安全解决方案</h3>
<p>JoySSL为企业提供从证书申请、部署到管理的全生命周期服务。其自主研发的证书管理平台，支持一键批量签名、证书到期自动提醒等功能，帮助企业提升管理效率。同时，JoySSL与国内主流应用商店（如华为应用市场、小米应用商店）达成合作，为开发者提供签名快速审核通道，缩短应用上线时间。</p>
<h3 data-id="heading-10">3.3 行业案例与客户口碑</h3>
<p>安徽本地制造业巨头江淮汽车，在其车联网系统开发中采用JoySSL的EV代码签名证书，实现了对车载软件全生命周期的安全管控，有效防止了固件篡改和远程攻击，保障了百万级车辆的数据安全。</p>
<p>截至2026年1月，JoySSL已为国内超过2万家企业提供代码签名证书服务，客户满意度高达96.8%。在Gartner 2025年国内数字证书服务商排名中，JoySSL凭借其创新能力和客户服务，跻身前三。</p>
<h2 data-id="heading-11">四、代码签名证书未来发展趋势</h2>
<h3 data-id="heading-12">4.1 自动化与智能化</h3>
<p>随着DevOps模式的普及，代码签名将融入软件开发流水线，实现自动化签名。JoySSL已推出与GitLab、Jenkins等CI/CD工具的集成方案，支持代码提交后自动完成签名，提升开发效率。</p>
<h3 data-id="heading-13">4.2 多场景融合</h3>
<p>代码签名将与区块链技术结合，实现签名信息的不可篡改和可追溯。未来，用户通过区块链浏览器即可查询软件的签名历史和开发者信息，进一步提升信任度。</p>
<h3 data-id="heading-14">4.3 零信任架构适配</h3>
<p>在零信任架构下，代码签名将作为身份验证的重要环节，实现对软件的动态信任评估。JoySSL正与国内零信任解决方案厂商合作，打造基于代码签名的零信任安全体系。</p>
<h2 data-id="heading-15"/>
<p>在数字化时代，软件安全已不再是可选选项，而是企业生存和发展的必要条件。代码签名证书作为软件安全的“数字身份证”，不仅能有效防止恶意软件传播、提升用户信任，还能帮助企业满足合规要求。</p>
<p>JoySSL凭借其本土化服务优势和全场景解决方案，正在成为国内企业保障软件安全的首选合作伙伴。未来，随着技术的不断演进，代码签名证书将在构建可信软件生态中发挥更加重要的作用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我的2025：TRAE帮我圆梦开发的VibeCoding时光]]></title>    <link>https://juejin.cn/post/7598587406708064297</link>    <guid>https://juejin.cn/post/7598587406708064297</guid>    <pubDate>2026-01-25T12:45:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7598587406708064297" data-draft-id="7598744870995427371" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我的2025：TRAE帮我圆梦开发的VibeCoding时光"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2026-01-25T12:45:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鼓掌MVP"/> <meta itemprop="url" content="https://juejin.cn/user/3009786736020724"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我的2025：TRAE帮我圆梦开发的VibeCoding时光
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3009786736020724/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鼓掌MVP
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-25T12:45:30.000Z" title="Sun Jan 25 2026 12:45:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读31分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65e3d64677984768b6983c87bc2fc3a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6byT5o6MTVZQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769949930&amp;x-signature=GC3RCvLXe%2F5GZj9Uc4qSBubitag%3D" alt="image.png" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/112c25d09b494a1d9a2a002a37c676ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6byT5o6MTVZQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769949930&amp;x-signature=1hO7T8fIXtwmC3vl455adaGRYJc%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h2 data-id="heading-0">引言</h2>
<p>2025年，对我而言是充满技术探索与创意实践的一年。这一年，我与TRAE相遇，它像一把钥匙，为我打开了创意与技术融合的大门。</p>
<p>从旅游札记到游戏开发，从生活助手到社交管理，TRAE与MCP的组合以其强大的AI辅助编程和服务整合能力，让我这个前端开发者能够轻松将创意变为现实。现在，就让我回顾这段与TRAE和MCP相伴的精彩时光。</p>
<h2 data-id="heading-1">一、TRAE赋能的创意项目</h2>
<h3 data-id="heading-2">1. AI驱动的旅游札记生成器：MCP能力的完美展示</h3>
<p>作为一个热爱旅行的人，我一直困扰于旅行后整理照片和撰写游记的繁琐。2025年，我利用TRAE Builder+MCP服务开发了一个AI驱动的旅游札记生成器，彻底解决了这个问题。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd7bd65cfb6d46248a8e96d2dab1caf1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6byT5o6MTVZQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769949930&amp;x-signature=uXGl4adc%2FGswzx9UYHQ3c06PIVY%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fa3f24946744cf6b2c7dc349c08300e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6byT5o6MTVZQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769949930&amp;x-signature=c3i4BMKwg%2B9rN%2BQuVKWXiwkZYps%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>这个应用的神奇之处在于：只需输入旅行的基本信息和照片，它就能自动分析照片内容，结合地理位置信息，生成风格多样、内容丰富的旅行札记。更令人惊喜的是，它还支持Markdown、HTML、PDF等多种格式导出，让我的旅行记忆能够以各种形式保存和分享。</p>
<p>MCP服务在这里发挥了核心作用：</p>
<ul>
<li><strong>图像分析MCP</strong>：像一位专业的视觉解读师，智能识别照片中的场景、物体、人物和氛围，甚至能捕捉到照片中的情感色彩，为游记增添生动的描述。</li>
<li><strong>高德地图MCP</strong>：将普通地址精准转换为经纬度坐标，不仅能在地图上标记旅行足迹，还能智能搜索周边的隐藏景点和特色美食，为旅行故事增添惊喜元素。</li>
<li><strong>文本生成MCP</strong>：结合所有分析结果，生成风格各异的旅行故事，从文艺小清新到深度旅行感悟，满足不同场景的表达需求。</li>
</ul>
<p>通过这些MCP服务的无缝整合，最终生成的旅行故事个性化十足，细节丰富，情感真挚，比我自己写的还要精彩。这让我深刻体会到，MCP不仅是技术工具，更是创意的放大器。</p>
<h3 data-id="heading-3">2. 基于MCP与Trae框架的"人情账本"系统：智能社交管理的新范式</h3>
<p>中国人的社交往来中，"人情"是一个重要的组成部分。但随着时间推移，事务繁杂，很难记得清这些往来账。为此，我利用TRAE的Vibe Coding开发能力，结合MCP技术，开发了一个"人情账本"系统。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61cbd800f1584a55911082a739261a68~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6byT5o6MTVZQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769949930&amp;x-signature=5ZsNzU5%2FsgybGF5cXrLsx7qZSEs%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7790eafa19114ae2b2e384dc3211e9f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6byT5o6MTVZQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769949930&amp;x-signature=%2BNA%2FQrET7GDw5WxhyYcgTFbzQ8I%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>这个系统的核心特点是支持自然语言管理人际往来，让用户能够轻松记录和查询社交账目。无论是收到的红包，还是需要随份子的庆典，都能通过简单的语言描述快速记录，从此人际往来不再头疼。</p>
<p>MCP技术在这里的应用让系统更加智能：</p>
<ul>
<li><strong>自然语言处理MCP</strong>：理解用户的自然语言输入，自动提取关键信息（如人物、金额、事件类型、日期等），将非结构化的语言描述转化为结构化的数据记录。</li>
<li><strong>数据存储与分析MCP</strong>：安全存储用户的社交往来数据，并提供智能分析功能，如往来频次统计、金额分析、关系网络图等，帮助用户更好地理解自己的社交网络。</li>
<li><strong>提醒服务MCP</strong>：根据历史数据和时间节点，智能提醒用户重要的社交事件，如朋友的生日、纪念日等，避免因疏忽而错过重要的社交场合。</li>
</ul>
<p>通过这些MCP服务的整合，"人情账本"系统不仅解决了实际问题，还为用户提供了全新的社交管理体验。这让我意识到，MCP的价值在于它能够将复杂的技术能力封装为简单易用的服务，让开发者能够专注于解决用户问题。</p>
<h3 data-id="heading-4">3. 智能睡眠助手Agent：MCP驱动的健康管理</h3>
<p>由于工作压力，我曾经常遭受失眠的困扰，早上醒来总是头疼不已。意识到这个问题后，我想到了用TRAE的AI智能体功能结合MCP服务开发一个睡眠助手。</p>
<p>虽然最初只是抱着尝试的心态，但TRAE与MCP的组合让我惊喜不已。通过与睡眠助手的交流，它能够分析我的睡眠习惯，提供个性化的睡眠建议，甚至通过放松音乐和冥想指导帮助我改善睡眠质量。这个小小的工具，成为了我2025年最贴心的健康伙伴。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7d168f4391f4266b4cc454c16055dbe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6byT5o6MTVZQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769949930&amp;x-signature=IkpsJynwo89yBJnmb3E7B9kPkc8%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>MCP服务在这里的应用让睡眠助手更加智能和实用：</p>
<ul>
<li><strong>语音交互MCP</strong>：提供自然流畅的语音对话能力，让我能够在睡前放松状态下与助手交流，无需动手操作。</li>
<li><strong>数据分析MCP</strong>：记录和分析我的睡眠数据，包括入睡时间、睡眠时长、睡眠质量等，生成详细的睡眠报告，帮助我了解自己的睡眠状况。</li>
<li><strong>内容生成MCP</strong>：根据我的偏好和当前状态，生成个性化的放松音乐和冥想指导，帮助我更快进入睡眠状态。</li>
<li><strong>健康建议MCP</strong>：结合睡眠数据和个人情况，提供科学的睡眠建议，如调整作息时间、改善睡眠环境等，帮助我建立健康的睡眠习惯。</li>
</ul>
<p>通过这些MCP服务的整合，智能睡眠助手不仅是一个简单的应用，更是一个个性化的健康管理专家。这让我认识到，MCP技术在健康领域有着巨大的应用潜力，能够为人们的生活带来实质性的改善。</p>
<h3 data-id="heading-5">4. 碰碰车吃豆大战游戏：MCP增强的游戏体验</h3>
<p>游戏开发一直是我的兴趣所在，但传统的游戏开发流程复杂且耗时。2025年，我利用Trae对话式编程，结合HTML5 Canvas技术和MCP服务，开发了一款碰碰车吃豆大战游戏。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8b9e7aa4bd848b68f8b69fbe9d738df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6byT5o6MTVZQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769949930&amp;x-signature=PkG1BOkh3jbQDftpcDL4w8gnjg4%3D" alt="pp.gif" loading="lazy"/></p>
<p>这是一款休闲竞技游戏，玩家控制一辆碰碰车与其他AI对手在地图上争夺资源。游戏实现了爽快的物理碰撞体验、智能的AI对手行为、随机生成的奖励系统和实时计分排行榜。整个开发过程中，TRAE的代码生成和优化能力让我能够在短时间内实现复杂的游戏逻辑和AI行为，而MCP服务则为游戏增添了更多精彩特性。</p>
<p>MCP服务在这里的应用让游戏更加丰富和智能：</p>
<ul>
<li><strong>AI行为MCP</strong>：为游戏中的AI对手提供智能决策能力，使它们能够评估地图上的资源价值，选择最优目标，甚至能够学习玩家的游戏风格并调整策略。</li>
<li><strong>音效MCP</strong>：根据游戏场景和玩家操作，生成动态的音效和背景音乐，增强游戏的沉浸感和趣味性。</li>
<li><strong>数据分析MCP</strong>：记录玩家的游戏数据，如游戏时长、得分、常用策略等，生成个人游戏报告，帮助玩家了解自己的游戏风格和改进方向。</li>
<li><strong>社交分享MCP</strong>：提供便捷的游戏成绩分享功能，让玩家能够轻松将自己的精彩表现分享到社交平台，增加游戏的社交属性。</li>
</ul>
<p>通过这些MCP服务的整合，碰碰车吃豆大战游戏不仅具有出色的游戏体验，还具备了智能和社交特性。这让我意识到，MCP技术能够为游戏开发带来全新的可能性，让游戏更加智能、个性化和社交化。</p>
<h3 data-id="heading-6">5. "猫鼠大作战"小游戏：MCP助力的快速开发</h3>
<p>作为一名前端开发者，我一直希望能够快速实现自己的游戏创意。2025年，我尝试了豆包AI+Trae IDE+MCP的组合，仅用一句话就开发了"猫鼠大作战"网页小游戏。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7501824bf044355a77d8a047a5ea960~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6byT5o6MTVZQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769949930&amp;x-signature=fofUbk7PLiAk6rXrwsC61xcTEf4%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>整个开发过程始于一个简单的需求描述："帮我开发一个猫捉老鼠的网页小游戏"。豆包AI通过智能分析和代码生成，快速实现了游戏的基本框架，而MCP服务则为游戏增添了更多智能特性。最终的游戏包含了键盘和触摸控制、动态难度系统、智能的老鼠AI和响应式设计，能够在不同设备上提供良好的游戏体验。</p>
<p>MCP服务在这里的应用让游戏开发更加高效和智能：</p>
<ul>
<li><strong>游戏逻辑MCP</strong>：提供预设的游戏逻辑模块，如碰撞检测、AI行为、计分系统等，大大减少了手动编写代码的工作量。</li>
<li><strong>多设备适配MCP</strong>：自动生成适配不同设备的代码，确保游戏在PC、平板和手机上都能提供良好的体验，无需手动编写复杂的响应式代码。</li>
<li><strong>性能优化MCP</strong>：根据游戏的具体情况，自动优化代码结构和资源加载策略，确保游戏在各种设备上都能流畅运行。</li>
<li><strong>用户体验MCP</strong>：提供游戏教程、难度调整、成就系统等通用游戏功能模块，让游戏更加完整和专业。</li>
</ul>
<p>通过这些MCP服务的整合，"猫鼠大作战"小游戏的开发时间大大缩短，而游戏质量却得到了保证。这让我深刻体会到，MCP技术是快速原型开发和创意验证的强大工具，能够让开发者在短时间内将创意变为现实。</p>
<h2 data-id="heading-7">二、TRAE的2025年更新变迁</h2>
<p>2025年是TRAE快速发展的一年，在这一年里，TRAE推出了多项重要更新，不断提升开发者体验和能力。这些更新不仅丰富了TRAE的功能，也为VibeCoding的实践提供了更加强大的支持。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/401244d4976848f693805c2cd1d1aada~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6byT5o6MTVZQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769949930&amp;x-signature=G6zrm7MC6eaS8fS6vXYrxZsPhyg%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>作为一个受益匪浅的开发者，感谢TRAE的陪伴，也感谢无数工作人员背后默默的付出！</p>
<h3 data-id="heading-8">2.1 TRAE插件系统的推出</h3>
<p>年初，TRAE正式推出了插件系统，为开发者提供了扩展TRAE功能的全新方式。插件系统的核心价值在于：</p>
<ul>
<li><strong>功能扩展</strong>：开发者可以通过安装和开发插件，为TRAE添加新的功能和能力，如特定领域的代码生成、自定义MCP服务集成等。</li>
<li><strong>个性化定制</strong>：每个开发者都可以根据自己的工作流程和偏好，定制TRAE的界面和功能，打造专属的开发环境。</li>
<li><strong>社区生态</strong>：插件系统催生了活跃的开发者社区，开发者可以分享自己开发的插件，也可以从社区获取他人开发的优质插件，共同丰富TRAE的功能生态。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/adbb33f0b0064e9e8b4005cb9264d3a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6byT5o6MTVZQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769949930&amp;x-signature=qgtn45wYpqLzXkTFdMMq6JXU%2FLQ%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>作为前端开发者，我还特别喜欢前端相关的插件，如React组件生成插件、Tailwind CSS智能提示插件等，这些插件大大提高了我的开发效率。</p>
<h3 data-id="heading-9">2.2 TRAE Builder的全面升级</h3>
<p>年中，TRAE Builder迎来了重大升级，从一个简单的项目生成工具进化为功能强大的可视化开发平台：</p>
<ul>
<li><strong>可视化界面设计</strong>：新增了拖拽式界面设计器，开发者可以通过可视化操作创建和编辑UI界面，无需手动编写HTML和CSS代码。</li>
<li><strong>流程编排能力</strong>：提供了直观的流程编排工具，开发者可以通过拖拽和连接不同的节点，构建复杂的业务逻辑和工作流程。</li>
<li><strong>MCP服务可视化配置</strong>：支持通过可视化界面配置和管理MCP服务，大大降低了MCP服务的使用门槛。</li>
<li><strong>多平台发布</strong>：内置了多平台发布功能，开发者可以一键将应用发布到Web、移动端、桌面端等多个平台，无需为不同平台单独开发。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32607827bc984b00a36daad4a8161028~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6byT5o6MTVZQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769949930&amp;x-signature=jJu9%2FKOHU60gVXruo44crp%2Bbeic%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>TRAE Builder的升级，让我能够更加高效地构建完整的应用，从界面设计到功能实现，都可以在一个统一的平台上完成，大大简化了开发流程。</p>
<h3 data-id="heading-10">2.3 SOLO模式的创新</h3>
<p>下半年，TRAE推出了全新的SOLO模式，为个人开发者提供了更加专注和高效的开发环境：</p>
<ul>
<li><strong>沉浸式开发体验</strong>：SOLO模式提供了极简的界面设计，移除了所有不必要的干扰元素，让开发者能够完全专注于代码和创意。</li>
<li><strong>智能上下文感知</strong>：系统能够智能感知开发者的工作上下文，自动提供相关的代码建议、文档和工具，减少了开发者的认知负担。</li>
<li><strong>离线工作能力</strong>：SOLO模式支持完全离线工作，开发者可以在没有网络连接的情况下继续开发，确保了开发工作的连续性。</li>
<li><strong>个人知识管理</strong>：内置了个人知识管理系统，自动记录和组织开发者的代码片段、解决方案和开发经验，形成个人的开发知识库。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f43a0b8fe61846eb8768fd05b0d263b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6byT5o6MTVZQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769949930&amp;x-signature=uapHWN2PV%2FL81ydmDD1W0QG5Dlg%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>这时我苦苦排队等了很久，心心念念的SOLO模式，终于用上了！还是免费的！</p>
<p>SOLO模式的推出，让我在开发过程中能够更加专注和高效，特别是在处理复杂的问题时，沉浸式的开发环境帮助我更好地集中注意力，找到最佳的解决方案。</p>
<h3 data-id="heading-11">2.4 其他重要更新</h3>
<p>除了上述重大更新外，TRAE在2025年还推出了多项其他重要更新：</p>
<ul>
<li><strong>AI能力增强</strong>：不断提升TRAE的AI理解和生成能力，支持更加复杂和抽象的需求描述，生成更加准确和高质量的代码。</li>
<li><strong>性能优化</strong>：持续优化TRAE的运行性能，减少响应时间，提高代码生成速度，确保流畅的开发体验。</li>
<li><strong>多语言支持</strong>：增加了对更多编程语言和框架的支持，扩大了TRAE的适用范围。</li>
<li><strong>安全性提升</strong>：加强了代码和数据的安全性，确保开发者的知识产权和敏感信息得到充分保护。</li>
</ul>
<p>这些更新，让TRAE在2025年实现了从工具到平台的跨越，成为了一个功能完整、生态丰富的AI辅助开发平台。作为一名前端开发者，我深刻感受到了这些更新带来的便利和效率提升，它们不仅改变了我的开发方式，也让我对编程的未来充满了期待。</p>
<h2 data-id="heading-12">三、TRAE带来的技术体验与收获</h2>
<h3 data-id="heading-13">1. 降低编程门槛，提高开发效率</h3>
<p>在与TRAE相伴的2025年，我深刻体会到了AI辅助编程如何彻底改变传统的软件开发流程。无论是复杂的旅游札记生成器，还是简单的网页小游戏，TRAE都能通过对话式编程和智能代码生成，帮助我快速实现创意。</p>
<p>这种开发方式不仅大大降低了编程门槛，让编程经验有限的我也能开发出专业级别的应用，也极大提高了开发效率，让我能够将更多精力放在创意设计和用户体验上。</p>
<h3 data-id="heading-14">2. 模块化设计与技术整合：MCP的核心价值</h3>
<p>TRAE的开发环境鼓励模块化设计，让我能够将复杂的项目分解为多个独立但相互协作的组件。这种设计方式不仅使代码结构清晰，也便于后续维护和扩展。</p>
<p>而MCP（Module Connect Platform）则是技术整合的最佳实践，它像一个智能的连接器，让不同的技术服务能够无缝协作：</p>
<ul>
<li><strong>服务封装</strong>：MCP将复杂的技术能力封装为简单易用的服务接口，开发者无需了解底层实现细节，只需关注如何使用这些服务来解决问题。</li>
<li><strong>标准化接口</strong>：MCP提供标准化的服务接口，使不同的服务能够按照统一的方式进行调用和集成，大大降低了技术整合的复杂度。</li>
<li><strong>服务编排</strong>：MCP支持服务之间的智能编排，使多个服务能够协同工作，形成更强大的复合功能。例如，在旅游札记生成器中，图像分析MCP、地图MCP和文本生成MCP的协同工作，产生了1+1+1&gt;3的效果。</li>
<li><strong>可扩展性</strong>：MCP的模块化架构使得系统具有高度的可扩展性，开发者可以根据需要轻松添加新的服务或替换现有的服务，而不会影响整个系统的稳定性。</li>
</ul>
<p>通过TRAE与MCP的结合，我能够轻松整合各种第三方服务，如图像分析、地图服务、语音识别等，为应用添加丰富的功能。这种技术整合能力，让我的项目能够站在巨人的肩膀上，实现更多可能性。</p>
<p>作为前端开发者，我尤其欣赏MCP在前端技术整合方面的能力。它不仅能够整合后端服务，还能够整合各种前端库和框架，如React、Vue、Three.js等，让前端开发更加高效和灵活。</p>
<h3 data-id="heading-15">3. 从创意到现实的快速转化：MCP的加速作用</h3>
<p>2025年，我最深的感受是：有了TRAE和MCP，创意到现实的距离变得前所未有的近。无论是突发奇想的小游戏，还是解决实际问题的工具应用，我都能通过TRAE和MCP快速将其变为现实。</p>
<p>MCP在创意转化过程中发挥了关键的加速作用：</p>
<ul>
<li><strong>快速原型</strong>：通过调用现有的MCP服务，我可以在短时间内搭建出功能完整的原型，验证创意的可行性，而不需要从零开始编写所有代码。</li>
<li><strong>功能丰富</strong>：MCP提供了丰富的服务库，涵盖了从图像处理、自然语言处理到数据分析、社交分享等各种功能，让我能够为应用添加更多高级特性，提升用户体验。</li>
<li><strong>技术兜底</strong>：MCP服务由专业团队维护和更新，确保了服务的稳定性和安全性，让我能够专注于创意设计，而不需要担心技术实现的细节和风险。</li>
<li><strong>迭代迅速</strong>：当创意需要调整时，我可以通过修改MCP服务的配置或替换不同的MCP服务，快速实现功能的变更和优化，大大缩短了迭代周期。</li>
</ul>
<p>这种快速转化的能力，让我更加勇于尝试新的创意，也让我的2025年充满了惊喜和成就感。正如那句"人人都是VibeMaker"所说，TRAE和MCP让每个人都有机会成为创意的实现者。</p>
<p>作为前端开发者，我发现MCP在前端创意转化方面尤其有价值。它不仅能够加速前端界面的开发，还能够轻松整合后端服务，让我能够独立完成从前端到后端的完整应用开发，真正实现"一个人就是一个团队"的开发效率。</p>
<h3 data-id="heading-16">4. VibeCoding：重新定义编程体验</h3>
<p>在使用TRAE和MCP的过程中，我逐渐领悟到VibeCoding的真正含义。它不仅仅是一种编程方式，更是一种全新的创意表达形式，而MCP则是VibeCoding的重要技术支撑。</p>
<p>VibeCoding的核心在于"对话式编程"，它打破了传统编程中人与机器之间的壁垒。通过自然语言交流，我可以直接向TRAE表达我的创意和需求，而不需要担心语法错误或复杂的代码结构。这种交流方式更加符合人类的思维习惯，让编程变得更加直观和愉悦。</p>
<p>而MCP则为VibeCoding提供了强大的技术后盾：</p>
<ul>
<li><strong>能力扩展</strong>：MCP为VibeCoding提供了丰富的技术能力，让开发者能够通过对话式编程调用各种高级服务，如图像处理、自然语言处理、数据分析等，大大扩展了VibeCoding的应用范围。</li>
<li><strong>复杂度管理</strong>：MCP将复杂的技术实现封装为简单的服务接口，让开发者能够通过自然语言命令轻松使用这些服务，而不需要了解底层实现的复杂度，进一步降低了编程的门槛。</li>
<li><strong>创意聚焦</strong>：MCP让开发者能够专注于问题的本质和解决方案的创意，而不是陷入繁琐的代码细节中。当我开发旅游札记生成器时，我可以专注于如何让AI更好地理解照片内容和旅行故事，而不是纠结于图像处理的具体算法；当我开发游戏时，我可以专注于游戏机制和用户体验，而不是担心碰撞检测的实现细节。</li>
</ul>
<p>这种思维方式的转变，让我对编程有了全新的认识。编程不再是一种技术门槛，而是一种创意表达的工具。每个人都可以通过VibeCoding和MCP，将自己的创意变为现实，成为数字世界的建设者。</p>
<p>作为前端开发者，我发现VibeCoding和MCP的结合在前端开发中尤其有价值。它不仅能够加速前端界面的开发，还能够轻松整合各种后端服务，让前端开发者能够独立完成更加复杂和功能丰富的应用，真正实现"创意驱动开发"的理念。</p>
<h3 data-id="heading-17">5. TRAE与MCP对前端开发者的特别帮助</h3>
<p>作为一名前端开发者，我发现TRAE与MCP的组合在前端开发领域尤其具有革命性的意义。它们不仅解决了前端开发中的许多痛点，也为前端开发者打开了新的可能性。</p>
<h4 data-id="heading-18">5.1 前端框架与库的智能应用</h4>
<p>TRAE对主流前端框架（如React、Vue、Angular等）和库（如Tailwind CSS、Three.js等）有深入的理解。通过简单的对话，我可以快速生成符合最佳实践的组件代码，而不需要手动编写繁琐的模板和配置。</p>
<p>而MCP则为前端框架提供了强大的扩展能力：</p>
<ul>
<li><strong>组件库MCP</strong>：提供丰富的预设组件库，涵盖了从基础UI组件到复杂交互组件的各种类型，让前端开发更加高效。</li>
<li><strong>框架适配MCP</strong>：自动生成适配不同前端框架的代码，让我能够根据项目需求灵活选择合适的框架，而不需要学习多种框架的语法。</li>
</ul>
<p>例如，当我需要创建一个响应式导航栏时，只需告诉TRAE我的需求，它就能生成包含适当的HTML结构、CSS样式和JavaScript交互的完整代码，甚至会自动处理移动端适配和动画效果。</p>
<h4 data-id="heading-19">5.2 响应式设计与移动适配</h4>
<p>响应式设计是现代前端开发的核心要求之一，但手动编写媒体查询和处理各种设备尺寸的适配往往耗时且容易出错。TRAE能够智能分析设计需求，自动生成适配各种屏幕尺寸的响应式代码，确保应用在不同设备上都能提供良好的用户体验。</p>
<p>MCP在响应式设计中发挥了重要作用：</p>
<ul>
<li><strong>设备检测MCP</strong>：智能检测用户设备的类型和尺寸，提供针对性的界面适配方案。</li>
<li><strong>布局优化MCP</strong>：根据不同设备的屏幕尺寸，自动调整布局结构和元素大小，确保最佳的视觉效果。</li>
<li><strong>交互适配MCP</strong>：根据设备类型（如触摸设备 vs 鼠标设备），自动调整交互方式，提供符合设备特性的用户体验。</li>
</ul>
<h4 data-id="heading-20">5.3 UI组件开发与样式管理</h4>
<p>TRAE可以帮助前端开发者快速创建和管理UI组件库。通过对话式编程，我可以描述组件的外观和行为，TRAE会生成符合设计规范的组件代码，并自动处理样式隔离和主题管理。</p>
<p>MCP在UI组件开发中提供了强大的支持：</p>
<ul>
<li><strong>设计系统MCP</strong>：提供完整的设计系统支持，包括颜色、字体、间距等设计规范，确保整个应用的视觉风格统一。</li>
<li><strong>样式管理MCP</strong>：提供现代化的样式管理方案，如CSS-in-JS、CSS Modules等，解决样式冲突和命名空间问题。</li>
<li><strong>主题切换MCP</strong>：支持动态主题切换，让应用能够根据用户偏好或系统设置自动调整主题，提升用户体验。</li>
</ul>
<h4 data-id="heading-21">5.4 性能优化</h4>
<p>前端性能优化是一个复杂且持续的过程，涉及代码分割、懒加载、缓存策略等多个方面。TRAE能够分析项目结构，识别性能瓶颈，并提供针对性的优化建议和代码实现，帮助前端开发者构建更加高效的应用。</p>
<p>MCP在前端性能优化中发挥了关键作用：</p>
<ul>
<li><strong>代码分析MCP</strong>：智能分析前端代码，识别性能瓶颈和优化机会。</li>
<li><strong>资源优化MCP</strong>：自动优化图片、字体、脚本等资源的加载策略，减少页面加载时间。</li>
<li><strong>渲染优化MCP</strong>：提供虚拟列表、无限滚动等高级渲染技术，提升复杂页面的渲染性能。</li>
<li><strong>缓存策略MCP</strong>：根据应用的具体情况，自动生成最佳的缓存策略，减少重复请求和数据传输。</li>
</ul>
<h4 data-id="heading-22">5.5 API集成与数据处理</h4>
<p>前端开发中经常需要与后端API进行交互，处理数据获取、状态管理和错误处理等问题。TRAE可以帮助开发者快速生成API调用代码，实现数据的高效处理和状态管理，减少了手动编写重复代码的工作量。</p>
<p>MCP在API集成中提供了强大的能力：</p>
<ul>
<li><strong>API客户端MCP</strong>：自动生成符合RESTful或GraphQL规范的API客户端代码，简化API调用过程。</li>
<li><strong>状态管理MCP</strong>：提供现代化的状态管理方案，如Redux、Vuex、MobX等，帮助前端开发者高效管理应用状态。</li>
<li><strong>数据转换MCP</strong>：自动处理前后端数据格式的转换，解决数据结构不匹配的问题。</li>
<li><strong>错误处理MCP</strong>：提供统一的错误处理机制，确保API调用失败时能够优雅地处理错误，提升用户体验。</li>
</ul>
<h4 data-id="heading-23">5.6 前端测试</h4>
<p>测试是确保前端应用质量的重要环节，但编写测试代码往往繁琐且耗时。TRAE能够根据组件和功能自动生成测试代码，覆盖常见的测试场景，帮助前端开发者提高代码质量和可靠性。</p>
<p>MCP在前端测试中提供了全面的支持：</p>
<ul>
<li><strong>测试框架MCP</strong>：支持多种前端测试框架，如Jest、Mocha、Cypress等，满足不同类型的测试需求。</li>
<li><strong>测试用例MCP</strong>：根据组件和功能的特性，自动生成针对性的测试用例，确保测试覆盖全面。</li>
<li><strong>测试报告MCP</strong>：生成详细的测试报告，帮助开发者了解测试结果和代码质量状况。</li>
<li><strong>CI/CD集成MCP</strong>：提供与持续集成/持续部署系统的集成，实现自动化测试和部署，确保代码质量和开发效率。</li>
</ul>
<h2 data-id="heading-24">四、对未来的展望</h2>
<p>回顾2025年与TRAE和MCP相伴的时光，我充满感激。TRAE和MCP不仅是开发工具，更是我实现创意的伙伴。通过它们，我不仅开发了多个有趣实用的项目，也提升了自己的编程能力和创意表达能力。</p>
<h3 data-id="heading-25">VibeCoding与MCP的未来发展</h3>
<p>展望未来，我相信VibeCoding将会成为主流的编程方式，而MCP则会成为技术整合的标准实践，两者的结合将彻底改变软件开发的格局。</p>
<p>我期待TRAE和MCP能够在以下几个方面继续进化：</p>
<ol>
<li><strong>更深入的行业解决方案</strong>：针对不同行业的特定需求，提供更加专业的MCP服务和开发模板，如教育、医疗、金融等领域的专用解决方案。这些解决方案将整合行业特定的技术能力，为开发者提供一站式的行业应用开发工具。</li>
<li><strong>更强的协作能力</strong>：支持多人实时协作开发，让团队成员能够通过对话式编程共同完成项目，提高团队协作效率。MCP将作为团队协作的技术基础，确保不同开发者的代码和服务能够无缝集成。</li>
<li><strong>更丰富的创意表达形式</strong>：除了文字和代码，还能支持语音、图像、视频等多种形式的创意输入，让开发者能够更加自由地表达自己的想法。MCP将提供相应的服务，处理这些不同形式的创意输入，并转化为可执行的代码。</li>
<li><strong>更智能的代码优化</strong>：能够根据项目的具体情况，自动优化代码结构和性能，提供更加专业和高效的解决方案。MCP将整合先进的代码分析和优化技术，为不同类型的应用提供定制化的优化方案。</li>
<li><strong>更广泛的生态系统</strong>：MCP将构建更加开放和丰富的服务生态系统，吸引更多的服务提供商加入，为开发者提供更加多样化的技术选择。同时，MCP将提供标准化的服务接口和开发工具，降低服务集成的门槛，促进生态系统的健康发展。</li>
<li><strong>更强大的前端能力</strong>：针对前端开发的特点，提供更加专业和强大的MCP服务，如WebAssembly优化、PWA增强、WebXR支持等，帮助前端开发者构建更加先进和丰富的Web应用。</li>
</ol>
<h3 data-id="heading-26">个人的未来规划</h3>
<p>作为一名前端开发者和VibeCoder，我计划在未来继续深入探索TRAE和MCP的潜力，开发更多有意义的前端项目：</p>
<ol>
<li><strong>扩展旅游札记生成器</strong>：增加更多的风格选项和导出格式，支持视频游记的生成，让旅行记忆的保存和分享更加丰富多样。作为前端开发者，我将重点优化用户界面和交互体验，采用现代前端框架构建响应式布局，确保在各种设备上都能提供出色的用户体验。同时，我将探索整合更多MCP服务，如视频处理MCP、社交媒体分享MCP等，为应用添加更多高级特性。</li>
<li><strong>开发教育辅助工具</strong>：利用AI技术和MCP服务，开发能够根据学生特点和学习进度，自动生成个性化学习计划和辅导内容的教育工具。在前端实现上，我将采用组件化开发方式，构建可复用的教育组件库，支持多种学习场景和交互模式。同时，我将整合教育内容MCP、学习分析MCP等专业服务，提升工具的教育价值。</li>
<li><strong>探索虚拟现实应用</strong>：结合VR技术和MCP服务，开发沉浸式的游戏和应用，为用户带来更加真实和震撼的体验。作为前端开发者，我将利用Three.js等3D库，实现WebVR/AR应用，探索前端技术在虚拟现实领域的应用潜力。同时，我将整合空间计算MCP、虚拟场景MCP等专业服务，提升VR/AR应用的质量和体验。</li>
<li><strong>构建前端组件库</strong>：基于TRAE的VibeCoding能力和MCP服务，开发一套完整的前端组件库，包含常用的UI组件和交互模式，支持主题定制和响应式设计，为前端开发提供更加高效的工具。我将特别关注组件库与MCP服务的集成，让开发者能够通过简单的配置，为组件添加智能特性，如表单验证、数据可视化等。</li>
<li><strong>参与开源项目</strong>：将自己的VibeCoding和MCP使用经验分享给社区，与其他开发者共同推动VibeCoding和MCP的发展。特别是在前端领域，我希望能够贡献更多基于TRAE和MCP的前端开发工具和最佳实践，帮助其他前端开发者提高开发效率。我计划创建一个开源的MCP前端集成库，简化前端开发者使用MCP服务的流程。</li>
<li><strong>探索前端与AI的结合</strong>：利用TRAE的AI能力和MCP服务，探索前端开发与人工智能的深度结合，开发能够根据用户行为和偏好自动调整界面和功能的智能前端应用，为用户提供更加个性化的体验。我将整合用户行为分析MCP、个性化推荐MCP等服务，构建智能前端应用的技术框架。</li>
<li><strong>MCP服务开发</strong>：尝试开发自己的MCP服务，专注于解决前端开发中的特定问题，如高性能动画、智能表单、实时协作等。通过开发MCP服务，我希望能够更深入地理解MCP的技术架构和工作原理，为前端开发社区贡献更多有价值的工具和服务。</li>
</ol>
<p>同时，我也期待看到更多开发者加入VibeCoding的行列，通过TRAE释放创意，共同创造一个更加丰富多彩的数字世界。</p>
<h2 data-id="heading-27">五、结语</h2>
<p>2025年，是我与TRAE和MCP结缘的一年，也是我创意迸发的一年。从旅游札记生成器到游戏开发，从生活助手到社交管理工具，TRAE与MCP的组合陪伴我走过了一段充满惊喜和成就的技术探索之旅。</p>
<h3 data-id="heading-28">我的VibeCoding与MCP之旅</h3>
<p>对我个人而言，2025年的VibeCoding与MCP之旅是一次自我突破和成长的过程。作为一名前端开发者，我不仅开发了多个有趣实用的项目，也发现了自己在创意设计和问题解决方面的潜力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89ed48e5322846d7a023e8481f8ce421~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6byT5o6MTVZQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769949930&amp;x-signature=spTtsqVWbQfekWyVGvFgAHNEj0Y%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>技术的魅力在于它能够让生活变得更加美好，而TRAE和MCP正是这样一对能够赋能创意、简化开发的神奇组合。TRAE提供了智能的对话式编程环境，让创意表达更加自然和直观；MCP提供了丰富的技术服务，让创意实现更加高效和强大。</p>
<p>我回顾我这一年TRAE的总结报告，获得了“执剑人”评价。倒也十分贴切！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/061e5c889f0d48b186057300cec12ddd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6byT5o6MTVZQ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1769949930&amp;x-signature=ZsyYX%2BDqLBuPZUUEDHG3g%2BQ%2BZao%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>2025年，与TRAE和MCP的故事已经成为我人生中一段美好的回忆；而未来，更多与TRAE和MCP的精彩故事正在等待着我去书写。</p>
<h3 data-id="heading-29">未来的展望</h3>
<p>我相信，在未来的日子里，TRAE和MCP将继续进化，为开发者带来更加强大和智能的开发体验。VibeCoding将成为主流的编程方式，而MCP将成为技术整合的标准实践，两者的结合将彻底改变软件开发的格局。</p>
<p>作为一名前端开发者，我期待着在VibeCoding和MCP的道路上继续探索，开发更多有意义的项目，为前端开发社区贡献自己的力量。我也期待着与更多志同道合的伙伴相遇，共同探索技术的无限可能，创造一个更加美好的数字未来。</p>
<p>技术的进步永无止境，创意的表达也永无止境。有了TRAE和MCP，我们每个人都可以成为数字世界的建设者，用创意和技术共同创造一个更加丰富多彩的未来。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[谷歌开放世界模型一夜刷屏，AI游戏门槛归零时刻来了？]]></title>    <link>https://juejin.cn/post/7600957412128964623</link>    <guid>https://juejin.cn/post/7600957412128964623</guid>    <pubDate>2026-01-30T09:56:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600957412128964623" data-draft-id="7600799940971216936" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="谷歌开放世界模型一夜刷屏，AI游戏门槛归零时刻来了？"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2026-01-30T09:56:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            谷歌开放世界模型一夜刷屏，AI游戏门槛归零时刻来了？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T09:56:18.000Z" title="Fri Jan 30 2026 09:56:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>谷歌世界模型，再一次惊艳了所有人！</p>
<p>今天一早，谷歌 DeepMind 开放了世界模型 Genie 3 的实验性研究原型「Project Genie」，允许用户创建、编辑并探索虚拟世界。</p>
<p>在世界模型 Genie 3 之外，Project Genie 同样由图像生成与编辑模型 Nano Banana Pro 和语言模型 Gemini 提供技术支撑。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2efa739c59bc4bfc9b562e4aa0e3d12b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371778&amp;x-signature=G8qvqkHX%2BI3wIvRK%2BJg31%2BW8D9E%3D" alt="图片" loading="lazy"/></p>
<p>去年 8 月，谷歌预发布了通用世界模型 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2650983908%26idx%3D1%26sn%3Df33650540bdffd2558dea77ba3ab7377%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2650983908&amp;idx=1&amp;sn=f33650540bdffd2558dea77ba3ab7377&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Genie 3</a>，它能够生成多样化的交互式环境。在这一早期阶段，受邀测试者们已经创造出了令人印象深刻且极具吸引力的虚拟世界与沉浸式体验，并挖掘出了全新的使用方式。</p>
<p>接下来的目标是构建一个专注于「沉浸式世界创建」的交互式原型，进一步扩大受众范围。</p>
<p>因此自即日起，谷歌面向美国 18 岁及以上的 Google AI Ultra 用户开放了 Project Genie 的访问权限。</p>
<p>Project Genie 的多样性玩法</p>
<p>世界模型能够模拟环境的动态变化，并预测环境的演变方式以及动作对环境的影响。</p>
<p>与静态 3D 快照中的可探索体验不同，谷歌通用世界模型 Genie 3 会在用户移动并与世界交互时，实时生成前方的路径。</p>
<p>它能够为动态世界模拟出物理效果和交互，并且其突破性的一致性使得模拟任何现实场景成为可能，从机器人技术、动画建模和小说创作，到地点探索和历史场景还原。</p>
<p>如今，在 Genie 3、Nano Banana Pro 和 Gemini 等三大模型的支持下，Project Genie 具备了以下三大核心能力：</p>
<p>首先是，世界草绘（World sketching）。</p>
<p>通过文本提示词以及生成或上传的图片，用户即可创建一个生动且不断扩张的环境。用户可以创建自己的角色和世界，并定义自己想要的探索方式，比如行走、骑行、飞行或者驾驶，等等。</p>
<p>为了实现更精准的控制，谷歌将「世界草绘」与 Nano Banana Pro 进行了整合。这样一来，用户在正式进入世界之前，可以预览世界的样貌并修改图像以进行微调。</p>
<p>用户还可以定义角色的视角（第一人称或第三人称），在进入场景前掌控自己的视觉体验。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cbc03879a1845f29182ddafdab23d98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371778&amp;x-signature=lM51I9rtNOZGZ8HrpPJ%2FU7P501M%3D" alt="图片" loading="lazy"/></p>
<p>其次是，世界探索（World exploration）。</p>
<p>用户创建的世界是一个等待探索的可导航环境。在移动时，Project Genie 会根据用户采取的行动实时生成前方路径。在穿行过程中，用户还可以调整相机视角。</p>
<p>最后是，世界重混（World remixing）。</p>
<p>通过在原有提示词的基础上进行创作，将现有世界重混成新的演绎版本。用户也可以在画廊或「随机生成」图标中探索精选世界以获取灵感，并在此基础上继续构建。</p>
<p>完成后，用户可以下载关于自己的世界和探索过程的视频。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd304c9585c04af5ae5be320fa9bb2e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371778&amp;x-signature=zWp8syh4JQbO6eyzMlEGYj0eFaU%3D" alt="图片" loading="lazy"/></p>
<p>不过目前，谷歌也承认，Genie 3 仍处于早期研究阶段， 以下几个方面需要进一步改进：</p>
<ul>
<li>
<p>生成的世界可能看起来并不完全逼真，或者并不总是能严格遵循提示词、图像或现实世界的物理规律；</p>
</li>
<li>
<p>角色有时可能不太受控，或者在控制上存在较高的延迟；</p>
</li>
<li>
<p>生成内容的时长限制在 60 秒以内；</p>
</li>
<li>
<p>此前宣布的部分 Genie 3 功能（例如在探索时改变世界的提示事件「promptable events」）尚未包含在此原型中。</p>
</li>
</ul>
<p>第一手体验出炉</p>
<p>谷歌开放 Project Genie，终于让更多用户亲身体验到了世界模型 Genie 3 的「AI 生万物」。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/458d644bc71b4075a820a5dafbb91ec2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371778&amp;x-signature=3pB2r1WlOU%2Fcved031Sr6%2BNTPaI%3D" alt="图片" loading="lazy"/></p>
<p>已经上手的 Ultra 用户纷纷晒出了自己的作品，给予了不错的评价。</p>
<p>「刚刚用 Genie 3 做出了我的第一款 AI 游戏。提示词：一位法国女子必须攀越一个违背逻辑的世界，到处都是飞行物体。这会是游戏行业的终结吗？」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27c967830c72480191ef6bd2ca4aa0ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371778&amp;x-signature=t4TJ8HYKhLThOJUVqFmRk0dEdA8%3D" alt="图片" loading="lazy"/></p>
<p>「Genie 3 能运行《毁灭战士》（Doom）吗？看它生成的《毁灭战士》，墙壁全是由同样在运行《毁灭战士》的屏幕组成；主角是《毁灭战士》里的陆战队员，但他的头也是一个正在运行《毁灭战士》的屏幕。」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d1f4b7c237a44f18e75dcb164583739~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371778&amp;x-signature=C9ICZq0k%2BDDYKTI0Xj%2FtPlb0Mms%3D" alt="图片" loading="lazy"/></p>
<p>「Genie 3 在建模和物理模拟方面是一个巨大的飞跃，但仍存在一些待解决的问题，比如一只头顶着鸭子的水獭飞行员正走在一家罗斯科（Rothko）风格的机场里；以及一只穿着翼装的水獭正飞越一座充满哥特式塔楼的城市。」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8692a66e2bb4bbe80824f93f5204873~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371778&amp;x-signature=YfoecsrN%2BElDzpA4jg%2FoCwlY0IE%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f14ac253acb748d9877fe02704316e6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371778&amp;x-signature=HusCQ%2FhKZvWO38%2Fiv96IHLerXyM%3D" alt="图片" loading="lazy"/></p>
<p>「看 Genie 3 生成的人物是怎么打开车门的，这简直太令人震撼了。」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acaf788fdf7c40a9874957f9148c6123~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371778&amp;x-signature=WVd6e4Y7ssgLRnww2EUo1V4P6HY%3D" alt="图片" loading="lazy"/></p>
<p>「画面提示词为：一个男人正沿着好莱坞大道漫步。不仅能控制这个男人的动作，还能实时操控相机的视角。」</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06e83b9956284ec6aa4b86488cfc54cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371778&amp;x-signature=d4B93EF0HDSiiGMiXJQ0gbKGZUo%3D" alt="图片" loading="lazy"/></p>
<p>参考链接：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.google%2Finnovation-and-ai%2Fmodels-and-research%2Fgoogle-deepmind%2Fproject-genie%2F" target="_blank" title="https://blog.google/innovation-and-ai/models-and-research/google-deepmind/project-genie/" ref="nofollow noopener noreferrer">blog.google/innovation-…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2FTrueSlazac%2Fstatus%2F2016959063699906740%3Fs%3D20" target="_blank" title="https://x.com/TrueSlazac/status/2016959063699906740?s=20" ref="nofollow noopener noreferrer">x.com/TrueSlazac/…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Femollick%2Fstatus%2F2016982218506199531" target="_blank" title="https://x.com/emollick/status/2016982218506199531" ref="nofollow noopener noreferrer">x.com/emollick/st…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Femollick%2Fstatus%2F2016919989865840906%3Fs%3D20" target="_blank" title="https://x.com/emollick/status/2016919989865840906?s=20" ref="nofollow noopener noreferrer">x.com/emollick/st…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2FEHuanglu%2Fstatus%2F2016926887151354255%3Fs%3D20" target="_blank" title="https://x.com/EHuanglu/status/2016926887151354255?s=20" ref="nofollow noopener noreferrer">x.com/EHuanglu/st…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型的第一性原理：（二）信号处理篇]]></title>    <link>https://juejin.cn/post/7600837236620738612</link>    <guid>https://juejin.cn/post/7600837236620738612</guid>    <pubDate>2026-01-30T09:57:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600837236620738612" data-draft-id="7600728866758098996" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型的第一性原理：（二）信号处理篇"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2026-01-30T09:57:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型的第一性原理：（二）信号处理篇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T09:57:04.000Z" title="Fri Jan 30 2026 09:57:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>白铂 博士，华为 2012 实验室理论研究部主任 信息论首席科学家</p>
<p>引言</p>
<p>本篇是《大模型的第一性原理》系列解读文章的第二篇（<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzA3MzI4MjgzMw%3D%3D%26mid%3D2651006633%26idx%3D1%26sn%3D822f0d7b22e8054ea897d55c7a7b3028%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzA3MzI4MjgzMw==&amp;mid=2651006633&amp;idx=1&amp;sn=822f0d7b22e8054ea897d55c7a7b3028&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">点击回顾第一篇</a>），我们将从信号处理的角度解读原论文[1]。重点探讨语义向量化背后的信号处理和信息论原理，并从时间序列的角度分析 Transformer 及其与 Granger 因果的关系。</p>
<p>我们首先提出一个观点：大模型的输入是 Token 的语义嵌入（也称为语义向量），其本质是把自然语言处理问题转换为信号处理问题。因此对于大模型而言，向量化非常关键，它和信号处理、信息论有非常深刻的联系。</p>
<p>尽管从语言学的角度看，语法和逻辑是人类语言现象的关键，然而本系列的《统计物理篇》已经指出：大模型并不考虑这些因素，而是从纯概率的角度出发建模自然语言。</p>
<p>从 Token 的维度看，这种纯粹的概率模型在计算上是非常困难的，因此人们发展出了概率图模型、消息传递算法等工具[2]。对于当前海量数据而言，这些方法的复杂度仍然过高，很难用于大规模训练，也难以建模语义非对称性和长程依赖性。但是，当 Token 被向量化之后，情况就发生了本质的变化，因为我们可以定义内积，并用内积来表示语义相关性，从而大幅度降低计算量。</p>
<p>基于内积，我们可以进一步定义距离、微分、低维流形等一系列相对容易数值计算的量。这样就可以通过反向传播算法来训练神经网络，将 Token 的向量化变成神经网络的输入、输出和参数化记忆[3][4]。实际上，许多研究也表明神经网络之所以能完成分类，正是因为同一类事物（如照片中的猫、狗等）在高维参数空间中会内聚成低维流形[5][6]。</p>
<p>顺便提及，我们在向量检索方面的研究取得了一定进展，所提出的近似最近邻向量检索算法，过去两年一直蝉联 ANNBenchemarks 榜单的第一名 。</p>
<p>语义嵌入 / 向量化</p>
<p>人们用向量来建模语义的想法最早出现于 Luhn 在 1953 年发表的论文中[8]。但直到 2013 年，Mikolov 等人才真正取得突破[9][10]。基于大量语料，他们成功地训练出了将 Token 转化成语义向量的神经网络模型。下面这个例子经常被用来表达最理想的语义向量化：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38734473a84e4c97a20d39a5441430d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=aamwhItyFEdZKupvG5O7OJY%2FW9k%3D" alt="图片" loading="lazy"/></p>
<p>其中 s (⋅) 为一个词的向量化表示。然而遗憾的是，上述理想的语义向量化当前并未完全实现，但是语义向量之间的内积（或者归一化为余弦相似性）却可以表示 Token 层面的语义相关性。</p>
<p>假设 Ω 是一种自然语言所包含的 M 个 Token 的集合，那么从大模型的角度看，一个 Token 的语义就由定义在 Ω 上的概率分布所描述[11]。该分布可以从大量语料中学到，因此语义空间就可以用这个学到的概率空间建模。进一步地，将语义向量空间定义为一个 M 维空间中的单位球面<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cae4e32acfed43cc9dbfcb75d502df30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=VdQ4C60g%2FB496h18zJxSYqHK9Sc%3D" alt="图片" loading="lazy"/>，其中每个 Token 都和球面上的一个点一一对应。</p>
<p>对于大模型而言，语义向量空间就可以建模为一个概率-内积空间。许多研究认为语义向量空间应该是结构更复杂的低维流形，但余弦相似性和欧式距离的实际效果就已经足够好了。因此，我们认为用单位球面 S^(M-1) 来定义语义向量空间是在效果和复杂度之间的良好平衡。需要特别强调的是，语义向量空间中的每一个向量本身并没有语义，而这个向量与其它所有向量的内积（即相对关系）才代表了语义。这一点和信息论中的信源编码有本质的区别。经典的信源编码是对每一个信源符号的压缩，而语义向量的压缩则是在相对关系近似不变的前提下，对整个语义向量空间的降维。</p>
<p>那么，如何衡量两个语义空间的距离，以控制语义向量空间降维带来的精度损失或者衡量两个不同自然语言的语义差异性就变得至关重要。当代著名的几何学家，2009 年阿贝尔奖获得者，Mikhael Gromov 为我们提供了数学工具，即 Gromov-Wasserstein 距离[12]。它衡量了两个度量 - 概率空间之间的任意两点间度量的平均差异。该定义极大地拓展了最优传输理论中的 Wasserstein 距离的应用范围[13]。据此，我们定义语义向量空间距离如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c21d5551bbc4ed6b819a47f2b215513~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=P14ZueS%2FAJkH3WOvMn038E5Gf9Q%3D" alt="图片" loading="lazy"/></p>
<p>其中，<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b244ce4d36e64707bdeb2620be95717c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=DDOycgQtCJK74CsA40CipRhlVKg%3D" alt="图片" loading="lazy"/> 和 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60059d9514be473fa306b20f0aad7659~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=ePQYPNODcF91eF30yDdy%2FjA03FA%3D" alt="图片" loading="lazy"/> 是两个语义向量空间，<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49ea09c702ba4237b9409f241c187c34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=bDHWwatwqFu6HTsMBBpUO6PdgCA%3D" alt="图片" loading="lazy"/> 是 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c10dd855a8994096a2d939ab3b442fd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=3HHtWQMt0diGXF75BVYE30z1Opc%3D" alt="图片" loading="lazy"/> 上的语义向量，<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb0bcf92cb0b4e998bce0dd76ee957a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=fGVfDS3uCG0E4llTifE%2FqbgKlsg%3D" alt="图片" loading="lazy"/> 是 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/17bb6b80180d432284d19322d8cb55a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=TphwcpaF5JnhuioZK01jluyoEvI%3D" alt="图片" loading="lazy"/> 上的语义向量，μ 和 ν 分别是定义在 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/945f9b3b5e304bda901af0b52c86cb15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=jj7WyqRdQhpdocXmNVYN1nOBJFY%3D" alt="图片" loading="lazy"/> 和 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1932121e5d541d2a288f3c5e68ee9ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=Q1X4e9lhk9pnb0%2B81wYtogYj1bs%3D" alt="图片" loading="lazy"/>上的概率测度，π 是联合概率测度，Π(μ,ν) 是边缘分布为 μ 和 ν 的所有联合概率测度的集合。在最优传输理论中，Π(μ,ν) 中的任何一个联合概率测度都被称为传输方案。</p>
<p>可以看到，<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a374a8f19814bc985c19e50a0cd6b3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=gjmQUi7QQM2%2FhPqwv%2FPasp4JrI0%3D" alt="图片" loading="lazy"/> 衡量了概率加权意义下两个空间内积的平均最小差异，即两个空间的平均结构差异。如果 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ea226e5464a4280a259f9c98f6b53b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=qKFnQd1ZC3dwE2aFb4HZd8eoaxY%3D" alt="图片" loading="lazy"/>，在数学上称这两个空间是等距同构的。这意味着这两个语义向量空间完全等价，即两种语言在 Token 语义层面实际上是同一种语言。从这个角度看，<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc83b50ebe7c46579ea79d0591b71f63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=q0Wk0ZwjqI%2FcUhDQFKBDbHr99Pg%3D" alt="图片" loading="lazy"/> 衡量了两个语义向量空间偏离等距同构的程度。偏离程度越大，翻译起来的难度就越高。</p>
<p>因此，<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66beb30d226f434fa68fcba611efbb8d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=8UWC4A8XY9%2FWBTlNMGH3fD8HYzc%3D" alt="图片" loading="lazy"/> 不仅可以用于衡量语义向量空间降维带来的语义失真，同时还可以用来度量语义对齐的效果[14]。我们近期正在将这个方法从自然语言的语义对齐推广到多模态语义对齐问题上。</p>
<p>基于语义向量空间的概念，下面讨论语义压缩问题。原始 M 维语义向量空间的维数过高，难以计算且容易导致维数灾难。Landauer 等人指出语义向量化存在一个最优维数区间，即所谓甜点维数[14]。那么，如何将 M 维语义向量空间压缩到一个合适维数？这背后的数学原理就是著名的 Johnson-Lindenstrauss（JL）引理[16]。考虑 ϵ∈(0,1) 和 K 个 M 维向量 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e19a610ca17547749adf5187a2f35884~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=qAAhcDjLaoiw4bQ4Xc3dsO1FoO0%3D" alt="图片" loading="lazy"/>，如果 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aadf7a7831ff4c868d3bf827ceadddbb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=2cOhuDXThI6DoHuGTP89X1QnLb8%3D" alt="图片" loading="lazy"/>，那么一定存在一个矩阵 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edb09d32d57c482bba39fd8d23fea07c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=1FnPYMmLxpmSAoNLtJ5HOLg8%2BqE%3D" alt="图片" loading="lazy"/> 使得</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7637731de87c41c5bd5c3094915f1cc7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=zFdgLUlpayJFXMf%2Fr6AxsCkruUQ%3D" alt="图片" loading="lazy"/></p>
<p>JL 引理表明，可以通过线性变换来降低语义向量的维数，同时使得内积的误差小于 ϵ。因此，压缩之后的语义失真可用下面的语义向量空间距离来衡量</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00baa1483b70477ca60e0921ce2b7f7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=377szuiHvJ77L3cahckEt3YtoUs%3D" alt="图片" loading="lazy"/></p>
<p>其中，S 为原 M 维语义向量空间，S' 为降维后的 m 维语义向量空间。更进一步，如果考虑语义向量本身的稀疏性，我们还可以用压缩感知理论来强化 JL 引理。这种强化可以导出基于采样 FFT、采样 DCT 和采样 Hadamard 矩阵的快速压缩算法。详情可参见原论文中的相应章节，这里不再赘述。需要注意的是，这里并未考虑语义向量空间上的概率测度，而是对每个语义向量都成立。因此，如果结合从语料中学到的概率测度，很有可能会提出更高效的语义降维算法或得到更高的压缩比 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05b1d173212c452984b5297b615d6042~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=tS3m5InFxOGKyV9c4vUWt6zxzEo%3D" alt="图片" loading="lazy"/>。</p>
<p>最优语义向量化</p>
<p>我们知道，一个 Token 到底呈现出什么语义是和下游任务密切相关的。在本系列的《统计物理篇》中已经指出，大模型的目标是预测下一个 Token。因此，Token 的向量化也应围绕该目标展开。令 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/616db03b6ac74bcc9d2c866ae66627c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=1reQ2E3SBP33iqU9XXfkcHHADjY%3D" alt="图片" loading="lazy"/> 为 Token 序列，<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5e251be58934eb9bca08b54c06ff8c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=GlQEn36e51wi1vP9Iic4T9irzR0%3D" alt="图片" loading="lazy"/> 为对应的语义向量。对于下一个 Token 预测任务，语义编码器 f 是 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cb41a78520c4b829bc1f7c74df4a079~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=vqAIg7tJ%2BKccUNmHcC9dGMqietU%3D" alt="图片" loading="lazy"/> 的函数，其输出 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28f1d0f640f3413da330723306c95f29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=mr6NCWBc41%2BTVpKuXeQgjdr9Tso%3D" alt="图片" loading="lazy"/> 是 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4a74cf470a94eb5bb1cf7442552649a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=pCAdZqxI%2FTegV388ySV9hLlVhpc%3D" alt="图片" loading="lazy"/>中对于预测 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb81db0718634f848d4067369e6e3952~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=TnrpP30Ib%2FHuaL9QlhI%2B3GF9tG0%3D" alt="图片" loading="lazy"/> 有用但不在 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f930787309c8423891238a9858ec842e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=BKyXFmfXHdf7vN6HuqOnPLUXO10%3D" alt="图片" loading="lazy"/> 里的信息。那么，从信息论的角度看，最优语义编码器是下述优化问题的解：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ddde1675bd142dca545ba03b069cce5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=s0Vxpfq7OjIBnpG4vinx1P3Fj6U%3D" alt="图片" loading="lazy"/></p>
<p>上述定义的核心是条件互信息，它保证了语义向量 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/957ea839ea894a5c962762688b444b3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=3ENyo9GzzWLtii7okAfSooguOms%3D" alt="图片" loading="lazy"/> 并不是 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0111d1887a5458a8577fd29ecb87beb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=8HwNHoNTOvGv5Cdk6TVh3Epcxr0%3D" alt="图片" loading="lazy"/> 的向量表示，而是表示 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32c3fec738344855883031af262fae87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=H26nALAQBcIDCLleppdMUMr95rE%3D" alt="图片" loading="lazy"/> 中对预测 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b39e0e96f9db4f48ac0511765a611648~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=Yj17ejIAof2z%2FB6LGiXcvGx6sII%3D" alt="图片" loading="lazy"/> 有用但不在 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88886be860c046ff90af49c7a575f18f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=2bQxWTTOoMg1IUsOVgYfVOnAKmc%3D" alt="图片" loading="lazy"/> 里的信息。应用互信息不等式，我们有</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3105c483b3140458a27a94390436f3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=0S2SXrTbwnUyxfnU28ht8%2FnU7%2BE%3D" alt="图片" loading="lazy"/></p>
<p>该不等式的最右端项就是 Google DeepMind 团队提出并广泛应用的（包括 OpenAI）Contrastive Predictive Coding（CPC）算法[17]。这篇论文明确指出，他们的工作得到了信息论中 Predictive Coding 的启发。这正是发表在 IEEE 的前身 IRE 主办的信息论汇刊 IRE Transactions on Information Theory 的第 1 卷第 1 期的第 1 篇和第 2 篇论文[18][19]。作者则是大名鼎鼎的 Peter Elias，他是卷积码的发明人，1977 年香农奖得主，3G 时代编码领域的绝对王者。Google 的研究人员撰写论文系统综述了互信息的变分下界，并最终选择 InfoNCE 作为损失函数，从而通过神经网络最小化 InfoNCE 来最大化 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90dfbf31577d40888d1904cfe5ba26d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=zpti31u%2ByRmFNHOBGhonDR9uTkE%3D" alt="图片" loading="lazy"/> 的下界[20]。</p>
<p>以上的讨论启发我们：对于任何一个语义嵌入问题，都可以先基于下游任务要求写出信息论优化问题，再设计神经网络或数值算法来搜寻逼近信息论最优解或其上 / 下界的语义编码器。</p>
<p>从上述推导可以看出，CPC 实际上优化的是最优语义编码器的上界的 InfoNCE 逼近，所得到的语义编码器并不是最优的。如果我们有更好的工具来直接优化上述不等式最左端的条件互信息的和，那么将能得到性能更优的语义编码器。因此，这里要引入一个非常关键的信息论概念，即定向信息。这一概念的提出者是著名的信息论专家，1988 年香农奖得主，James Massey[21]。根据 Massey 的研究，从信道的输入序列 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/297c1fcd0a5a4dbfb41a17e5fc45e8e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=18d6cgwpakmfxYFkNPvVfckLm%2Bc%3D" alt="图片" loading="lazy"/> 到输出序列 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70c40f1a129245e5b66036681ac0cc40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=F1WhJ1SRZRtFO%2BeHOwZraKhylDM%3D" alt="图片" loading="lazy"/> 的定向信息可定义为</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e565e84e5e1488aacf23eb1f39e9db1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=mB%2Bknm1OXAJ6z4eaY%2F%2FWqqY%2BgT8%3D" alt="图片" loading="lazy"/></p>
<p>它衡量了从序列 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f2d7cfaa239469b820ee64ce9330d63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=xE8pzn7IbBvxcfsZSMjiNNHPh9I%3D" alt="图片" loading="lazy"/> 传递给序列 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2524af3e86564ef98b51019cfda0196d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=v7TiQ6arOTWACirhK99gxS%2BeavI%3D" alt="图片" loading="lazy"/> 的信息量。进一步地，我们定义从 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff5d33ad96064f03a12327a2df34e87b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=jFO9WTscUsyEQGAXukBEIfSOUTQ%3D" alt="图片" loading="lazy"/> 到 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e40729eebe3d4f1aa58d43225f408f12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=xhtVFdCftv2wpC%2B2CwvSW2Eh7sU%3D" alt="图片" loading="lazy"/> 的倒向定向信息：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11d1a81df0834b83be929ce37d948c56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=kb6PeW0ZVEI%2FKzPdEFeMvttwPwc%3D" alt="图片" loading="lazy"/></p>
<p>选择倒向这个词是受到彭实戈院士所研究的倒向随机微分方程的启发[22]。彭院士的研究成果最终促使他提出了一套与 Kolmogorov 概率公理化体系平行的非线性期望理论。我们从中可以看出，前面讨论的信息论最优的语义编码器，就是在最优化倒向定向信息，即：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe41c0a0ae64448e89f83582fd474fdc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=kRJZCnmG004wVGpEfIeioj932c0%3D" alt="图片" loading="lazy"/></p>
<p>然而，定向信息的计算和估计是非常困难的。该问题将在本系列的第三篇《信息论篇》中展开讨论。可见，CPC 选择 InfoNCE 作为损失函数平衡了复杂度和效果。</p>
<p>Transformer 是非线性时变向量自回归时间序列</p>
<p>在本系列的第一篇《统计物理篇》中，我们详细探讨了 Transformer 的能量模型（Energy-based Model，EBM）形式。本篇我们从信号处理角度进一步讨论 Transformer 的本质。业界已经达成共识，Transformer 是一个自回归大语言模型。这是因为它基于输入 Token 序列和已经生成的 Token 序列来预测下一个 Token。事实上，从经典随机过程和时间序列分析的角度看，自回归模型有严格的数学定义，即用过去的随机变量的值的线性加权和来预测未来的随机变量[23]。</p>
<p>考虑提示词的长度为 n，用向量序列 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/779fbbb8ee3c4988a74628847e588dba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=ElPPWKxKjQHiA4xTrMhOhXKAGG8%3D" alt="图片" loading="lazy"/> 来表示。当前要预测第 i 个 Token，表示为向量 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8631345cc23e4ded83d62616ed1a3d66~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=tFKXtEeYKwHc7E5Y%2BSSUHy2YBgw%3D" alt="图片" loading="lazy"/>，其中 i=n+1,…,N。为表示方便，令 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5680ffd53ed34f8da29f441523d2ee81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=QwQy%2F%2BqtzkHN4NexEUtzYCqAct0%3D" alt="图片" loading="lazy"/>，其中 i=1,…,n。结合自回归模型的思想，Attention 模块的数学形式可以写为：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96fb838a9d7a49dfb2fc1668aa10ff62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=BmiIFGP8SkG5d%2BIkpYI6tJBsHrw%3D" alt="图片" loading="lazy"/></p>
<p>其中，<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d51a4ede061a48c2afa022b916ea6466~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=hu7MxpF0ECmELxzhdixJfAZac8s%3D" alt="图片" loading="lazy"/> 是 Attention 权重，定义为：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2cfea2c1e35463186676ca108181e02~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=NQug4cn7IiGh%2BhoFqhtUpI%2FPJqE%3D" alt="图片" loading="lazy"/></p>
<p>从数学形式上看，Attention 是一个非线性时变向量自回归时间序列：</p>
<ul>
<li>
<p>时变性体现在 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a8c23ce254e4936bdbdb946f7318656~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=ClIAt6FZc%2BN9d6k%2FqK44qAsStd8%3D" alt="图片" loading="lazy"/> 与当前输出的 Token 编号 i 相关；</p>
</li>
<li>
<p>非线性体现在 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d03ec7696ebe45ee8f958f15a4329d5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=6K6eKHl1VmiA65ADudNztan5KvU%3D" alt="图片" loading="lazy"/> 的定义中包含了 softmax 函数和建模语义非对称关系的双线性型 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e891b42fd5424b689d1bf3e620b9c8b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=InMhU%2BnkazNccapf0cnf2o0MdKU%3D" alt="图片" loading="lazy"/>，其中 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73f6909e4482454d8b4e8687ef31a5fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=oqZ%2BxlKbKue3%2BkufL9rtm6DcmM0%3D" alt="图片" loading="lazy"/>。</p>
</li>
</ul>
<p>令 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63da2c51dc7f4ce1990943b4c974fbc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=HVy4k2KhoD0YJCBIeTBWNUiFVrY%3D" alt="图片" loading="lazy"/> 表示 Tranformer 的 FFN 层，那么 Transformer 本质上是通过</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb9615933a4f41bb895f06a19ab5531a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=qAgFIB7BId9hbf1rgw5eH5s%2Btq4%3D" alt="图片" loading="lazy"/></p>
<p>来预测下一个 Token 的向量表示。在《统计物理》篇中，我们已经指出 FFN 层对于预测下一个 Token 是很重要的，它被认为是大模型储存知识的位置。基于记忆容量的思路，Attention 模块输出的向量应该会激活 FFN 层中与之最匹配的记忆模式，从而作为下一个 Token 的向量表示。后续的操作需要在离散的词表中选择最有可能的那个 Token。在实际中可以设计多种采样策略来满足输出的要求，但背后的原理与通信接收机中的最大似然译码很类似。</p>
<p>简单起见，这里将采样操作表示成 argsoftmax (⋅) 函数。令 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52957747012d4d34952f35cd09cb623f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=vkflKGixelPkyNNqetgoxEXdu6w%3D" alt="图片" loading="lazy"/> 为词表 Ω 中的第 m 个 Token 的向量表示，那么 Transformer 的数学形式可以写为：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4dd553579a34c4ba70ae74f6071e72f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=fxHRM1BBFePNBoSiAzgwqvbKJiU%3D" alt="图片" loading="lazy"/></p>
<p>其中 T 是温度。</p>
<p>实际上，上述模型可作以下推广</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a60d8351405348609fbbe3d6a4609a2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=j0MuOcMUZkCK2pf%2BBDuIhy5OlX0%3D" alt="图片" loading="lazy"/></p>
<p>其中 Ψ 为非线性函数，<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc3d321c205b41d59c922e621e965f8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=AQZaHM9TJEO0n%2B%2BS0Z7D11jOK2E%3D" alt="图片" loading="lazy"/> 为时变参数矩阵。可见，Transformer 是更普遍的非线性时变向量自回归时间序列的一个特例。对 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac9b4166d2f74ce7b14ba82144ed4d8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=rsfXqteCX2Pmro1%2FjcfAyJgeO40%3D" alt="图片" loading="lazy"/> 进行其他分解或简化就能构造出新的 Attention 机制。例如，Mamba/Mamba2 是一种线性化的简化方式。由于线性 Attention 机制难以捕捉非对称语义相关性，其模型能力很自然地会受到很大影响。对 Ψ 也同样可以进行优化和修改，一种思路是用现代连续 Hopfield 网络来直接替换 FFN 模块[24]。另外，当前通过向量数据库和知识图谱等方式实现 RAG 也是通过改变 Ψ 来增强知识记忆的准确性和及时性[25]。</p>
<p>本系列的《统计物理篇》已经指出：大模型的能力极限是在预测下一个 Token 的任务上逼近人类水平的 Granger 因果推断。从时间序列的角度看，Granger 因果检测的主要作用就是分析两个序列之间与时间相关的统计关系。相关方法已经广泛应用于物理学、神经科学、社交网络、经济学和金融学等领域。回忆 Granger 因果的定义，令 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbc92e8ab39941d08488085bb89591df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=X8nLss5BbehISKN9Vmr7tI%2Bpq60%3D" alt="图片" loading="lazy"/>，<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e6cb4cb66b34618b6245780cb657b76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=fy2b1jm31vyB%2F5dhY7g3OV%2B8Jeg%3D" alt="图片" loading="lazy"/>，那么下面的不等式自然成立：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/793bdc344fbe4d41b2f1e8d41b4f21e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=tjTO%2BtSP7F6dQbDxHNCe1ZPCo%2Bg%3D" alt="图片" loading="lazy"/></p>
<p>因此，从时间序列的角度看，大模型输入的 Token 序列和输出的 Token 序列符合 Granger 因果推断的定义。这进一步印证了第一篇的结论：大模型推理的本质，是通过预测下一个 Token 这一看似简单的训练目标，进而实现逼近人类水平的 Granger 因果推断。</p>
<p>信号处理与信息论</p>
<p>在引言中我们已经指出：大模型处理的是向量化后的 Token 序列，其本质是把传统基于概率的自然语言处理问题转换成了基于数值计算的信号处理问题。从本文的讨论中可以看到，这种从 Token 到其向量表示的转化，与信息论和信号处理之间的关系非常类似。</p>
<p>具体来说，Shannon 信息论是一个基于概率论的理论框架，旨在理解信息压缩、传输和存储的基本原理及其性能极限，但它并不关注工程中的具体实现方法和复杂度。信号处理将信息论中的抽象符号表示为 n 维实 / 复空间中的向量。这种表示使得数值计算方法能有效应用于感知、通信和存储系统的高效算法设计中。可以说，信号处理是信息论原理在特定计算架构下的具体实现。</p>
<p>更广泛地看，我们经常用下图来表达计算理论和信息论之间的关系。图的左边是 Turing 和他的计算理论，他关心用多少个步骤能完成特定的计算，因此时延（通常用时间复杂度来度量）是最关键的指标。图的右边是 Shannon 和他的信息论，他关心的是通信速率的上限或者数据压缩的下限，即存在性和可达性。此时，通常假设码长趋于无穷大，因而时延是被忽略的。那么在实践中就会发现，开发通信算法的瓶颈永远是算力不够，算法复杂度太高；而研究计算算法的瓶颈永远都是（访存 / 卡间 / 服务器间）通信带宽不够，或者缓存 / 内存空间太小。</p>
<p>我们注意到，尽管计算理论和信息论有本质的不同，但他们最基本的操作单位都是 BIT，因此我们可以肯定地说：BIT 是连接计算和通信这两大领域的桥梁。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d2129e16f344dbd83969eac25cd6b5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770371824&amp;x-signature=VhxsF%2BQ0BUMnhstrHbiYhKOMmFo%3D" alt="图片" loading="lazy"/></p>
<p>图：BIT 是连接计算理论和信息论的桥梁，是信息时代最伟大的发明。</p>
<p>正如 5G Polar 码发明人，2019 年香农奖得主，Erdal Arikan 教授参加我们的圆桌论坛中所指出的：BIT 是信息时代最伟大的发明。Shannon 在与 Weaver 合著的论文中也明确指出：信息论只解决了信息的可靠传输问题，即技术问题，而不考虑语义和语效[26]。但是人类已经进入了 AI 时代，信息论是否还能继续发挥其基础性作用？</p>
<p>我们将在本系列的第三篇《信息论篇》中看到，只要将核心概念从信息时代的 BIT 转换成 AI 时代的 TOKEN，Shannon 信息论就可以用来解释大模型背后的数学原理。</p>
<p>参考文献</p>
<ol>
<li>
<p>B. Bai, "Forget BIT, it is all about TOKEN: Towards semantic information theory for LLMs," arXiv:2511.01202, Nov. 2025.</p>
</li>
<li>
<p>D. Koller and N. Friedman, Probabilistic Graphical Models: Principles and Techniques. Cambridge, MA, USA: The MIT Press, 2009.</p>
</li>
<li>
<p>G. Hinton, "Learning distributed representations of concepts," in Proc. 8th Annual Conference on Cognitive Science Society ’86, Amherst, MA, USA, Aug. 1986.</p>
</li>
<li>
<p>Y. Bengio, R. Ducharme, P. Vincent, and C. Jauvin, "A neural probabilistic language model," Journal of Machine Learning Research, vol. 3, no. 2, pp. 1137-1155, Feb. 2003.</p>
</li>
<li>
<p>S. Chung, D. Lee, and H. Sompolinsky, "Classification and geometry of general perceptual manifolds," Physical Review X, vol. 8, no. 3, p. 031003, Jul. 2018.</p>
</li>
<li>
<p>Y. Bahri, J. Kadmon, J. Pennington, S. Schoenholz, J. Sohl-Dickstein, and S. Ganguli, "Statistical mechanics of deep learning," Annual Review of Condensed Matter Physics, vol. 11, no. 3, pp. 501-528, Mar. 2020.</p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fann-benchmarks.com" target="_blank" title="https://ann-benchmarks.com" ref="nofollow noopener noreferrer">ann-benchmarks.com</a></p>
</li>
<li>
<p>H. Luhn, "A new method of recording and searching information," American Documentation, vol. 4, no. 1, pp. 14–16, Jan. 1953.</p>
</li>
<li>
<p>T. Mikolov, K. Chen, G. Corrado, and J. Dean, "Efficient estimation of word representations in vector space," arXiv: 1301.3781, 7 Sep. 2013.</p>
</li>
<li>
<p>T. Mikolov, I. Sutskever, K. Chen, G. Corrado, and J. Dean, "Distributed representations of words and phrases and their compositionality," Proc. 27th Annual Conference on Neural Information Processing Systems '13, Lake Tahoe, NV, USA, Dec. 2013.</p>
</li>
<li>
<p>D. Jurafsky and J. Martin, Speech and Language Processing: An Introduction to Natural Language Processing, Computational Linguistics, and Speech Recognition with Language Models, 3rd ed. Draft, 2025.</p>
</li>
<li>
<p>M. Gromov, Metric Structures for Riemannian and Non-Riemannian Spaces. Boston, MA, USA: Birkhäuser, 2007.</p>
</li>
<li>
<p>C. Villani, Optimal Transport: Old and New. New York, NY, USA: Springer, 2009.</p>
</li>
<li>
<p>D. Alvarez-Melis and T. Jaakkola, "Gromov-Wasserstein alignment of word embedding spaces," in Proc. ACL Conference on Empirical Methods in Natural Language Processing ’18, Brussels, Belgium, Oct. 2018, pp. 1881–1890.</p>
</li>
<li>
<p>T. Landauer, P. Foltz, and D. Laham, "An introduction to latent semantic analysis," Discourse Processes, vol. 25, no. 2-3, pp. 259-284, Jan. 1998.</p>
</li>
<li>
<p>W. Johnson, J. Lindenstrauss, and G. Schechtman, "Extensions of Lipschitz maps into Banach spaces," Israel Journal of Mathematics, vol. 54, no. 2, pp. 129-138, Jun. 1986.</p>
</li>
<li>
<p>A. Oord, Y. Li, and O. Vinyals, "Representation learning with contrastive predictive coding," arXiv: 1807.03748, Jan. 2019.</p>
</li>
<li>
<p>P. Elias, "Predictive coding - Part 1," IRE Transactions on Information Theory, vol. 1, no. 1, pp. 16-24, Mar. 1955.</p>
</li>
<li>
<p>P. Elias, "Predictive coding - Part 2," IRE Transactions on Information Theory, vol. 1, no. 1, pp. 24-33, Mar. 1955.</p>
</li>
<li>
<p>B. Poole, S. Ozair, A. Oord, A. Alemi, and G. Tucker, "On variational bounds of mutual information," in Proc. 36th International Conference on Machine Learning ’19, Long Beach, CA, USA, Jun. 2019, pp. 5171-5180.</p>
</li>
<li>
<p>J. Massey, "Causality, feedback and directed information," in Proc. IEEE International Symposium on Information Theory ’90, Waikiki, HI, USA, Nov. 1990.</p>
</li>
<li>
<p>S. Peng, Nonlinear Expectations and Stochastic Calculus under Uncertainty: with Robust CLT and G-Brownian Motion. Berlin, Germany: Springer, 2019.</p>
</li>
<li>
<p>H. Lütkepohl, New Introduction to Multiple Time Series Analysis. Berlin, Germany: Springer, 2007.</p>
</li>
<li>
<p>H. Ramsauer et al., "Hopfield networks is all you need," arXiv: 2008.02217, Apr. 2021.</p>
</li>
<li>
<p>Y. Xia et al., "ER-RAG: Enhance RAG with ER-based unified modeling of heterogeneous data sources," arXiv: 2504.06271, Mar. 2025.</p>
</li>
<li>
<p>W. Weaver and C. Shannon, "Recent contributions to the mathematical theory of communications," The Rockefeller Foundation, Sep. 1949.</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redux vs Zustand vs MobX 对比文档]]></title>    <link>https://juejin.cn/post/7600764857769852978</link>    <guid>https://juejin.cn/post/7600764857769852978</guid>    <pubDate>2026-01-30T07:03:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600764857769852978" data-draft-id="7600990891205984283" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redux vs Zustand vs MobX 对比文档"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-30T07:03:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王柄真"/> <meta itemprop="url" content="https://juejin.cn/user/1966406809955719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redux vs Zustand vs MobX 对比文档
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1966406809955719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王柄真
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T07:03:40.000Z" title="Fri Jan 30 2026 07:03:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">概述</h2>
<p>Redux、Zustand 和 MobX 是三个流行的 React 状态管理库，它们各有特点和适用场景。本文档从多个维度对比这三个库，帮助你选择最适合的状态管理方案。</p>
<h2 data-id="heading-1">概念对比</h2>
<h3 data-id="heading-2">Redux</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ced62adaaf6f43c3bf858e888d1a820f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5p-E55yf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770361422&amp;x-signature=kQzXGKwNaRZ59wWcO21HXZU0GFY%3D" alt="redux.png" loading="lazy"/></p>
<ul>
<li><strong>单向数据流</strong>：View → Action → Reducer → Store → View</li>
<li><strong>不可变更新</strong>：必须返回新状态</li>
<li><strong>纯函数</strong>：Reducer 必须是纯函数</li>
<li><strong>单一数据源</strong>：整个应用只有一个 store</li>
</ul>
<h3 data-id="heading-3">Zustand</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55a6e64738fc47e4ba7ab8711b48fe83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5p-E55yf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770361422&amp;x-signature=LIWoSb93NUzKcQFf8GgDl2U6Vuw%3D" alt="z.png" loading="lazy"/></p>
<ul>
<li><strong>简单直接</strong>：直接调用 store 的方法</li>
<li><strong>选择器订阅</strong>：只订阅需要的状态部分</li>
<li><strong>灵活更新</strong>：支持函数式和直接更新</li>
<li><strong>无 Provider</strong>：不需要包裹 Provider</li>
</ul>
<h3 data-id="heading-4">MobX</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64afff5066144ce3832c43565ebe539d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5p-E55yf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770361422&amp;x-signature=7jIqChm8gAMxEnQ3EULTr5%2Fk7Es%3D" alt="m.png" loading="lazy"/></p>
<ul>
<li><strong>响应式编程</strong>：自动追踪状态变化</li>
<li><strong>直接修改</strong>：可以直接修改状态</li>
<li><strong>自动更新</strong>：自动更新依赖的组件</li>
<li><strong>细粒度更新</strong>：只更新真正变化的部分</li>
</ul>
<h2 data-id="heading-5">详细对比</h2>
<h3 data-id="heading-6">1. 体积和依赖</h3>



































<table><thead><tr><th>特性</th><th>Redux</th><th>Zustand</th><th>MobX</th></tr></thead><tbody><tr><td><strong>体积</strong></td><td>~10KB</td><td>~1KB</td><td>~15KB</td></tr><tr><td><strong>依赖</strong></td><td>无</td><td>无</td><td>无</td></tr><tr><td><strong>React 绑定</strong></td><td>react-redux (~5KB)</td><td>内置</td><td>mobx-react-lite (~2KB)</td></tr><tr><td><strong>总体积</strong></td><td>~15KB</td><td>~1KB</td><td>~17KB</td></tr></tbody></table>
<p><strong>结论</strong>：Zustand 体积最小，Redux 和 MobX 体积相近。</p>
<h3 data-id="heading-7">2. 代码示例对比</h3>
<h4 data-id="heading-8">创建 Store</h4>
<p><strong>Redux</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// actions/counterActions.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; ({ <span class="hljs-attr">type</span>: <span class="hljs-string">'INCREMENT'</span> })
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">decrement</span> = (<span class="hljs-params"/>) =&gt; ({ <span class="hljs-attr">type</span>: <span class="hljs-string">'DECREMENT'</span> })
​
<span class="hljs-comment">// reducers/counterReducer.js</span>
<span class="hljs-keyword">const</span> initialState = { <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> }
<span class="hljs-keyword">function</span> <span class="hljs-title function_">counterReducer</span>(<span class="hljs-params">state = initialState, action</span>) {
  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'INCREMENT'</span>:
      <span class="hljs-keyword">return</span> { ...state, <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> }
    <span class="hljs-keyword">case</span> <span class="hljs-string">'DECREMENT'</span>:
      <span class="hljs-keyword">return</span> { ...state, <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> - <span class="hljs-number">1</span> }
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">return</span> state
  }
}
​
<span class="hljs-comment">// store/index.js</span>
<span class="hljs-keyword">import</span> { createStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'redux'</span>
<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">createStore</span>(counterReducer)
</code></pre>
<p><strong>Zustand</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { create } <span class="hljs-keyword">from</span> <span class="hljs-string">'zustand'</span>
​
<span class="hljs-keyword">const</span> useStore = <span class="hljs-title function_">create</span>(<span class="hljs-function">(<span class="hljs-params">set</span>) =&gt;</span> ({
  <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">increment</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> })),
  <span class="hljs-attr">decrement</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">set</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> ({ <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> - <span class="hljs-number">1</span> })),
}))
</code></pre>
<p><strong>MobX</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { makeAutoObservable } <span class="hljs-keyword">from</span> <span class="hljs-string">'mobx'</span>
​
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CounterStore</span> {
  count = <span class="hljs-number">0</span>
  
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">makeAutoObservable</span>(<span class="hljs-variable language_">this</span>)
  }
  
  <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++
  }
  
  <span class="hljs-title function_">decrement</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>--
  }
}
​
<span class="hljs-keyword">const</span> counterStore = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CounterStore</span>()
</code></pre>
<h4 data-id="heading-9">在组件中使用</h4>
<p><strong>Redux</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useSelector, useDispatch } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-redux'</span>
<span class="hljs-keyword">import</span> { increment, decrement } <span class="hljs-keyword">from</span> <span class="hljs-string">'./actions/counterActions'</span>
​
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">useSelector</span>(<span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> state.<span class="hljs-property">count</span>)
  <span class="hljs-keyword">const</span> dispatch = <span class="hljs-title function_">useDispatch</span>()
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> dispatch(decrement())}&gt;-<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{count}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> dispatch(increment())}&gt;+<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p><strong>Zustand</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> useStore <span class="hljs-keyword">from</span> <span class="hljs-string">'./store'</span>
​
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">useStore</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">count</span>)
  <span class="hljs-keyword">const</span> increment = <span class="hljs-title function_">useStore</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">increment</span>)
  <span class="hljs-keyword">const</span> decrement = <span class="hljs-title function_">useStore</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">decrement</span>)
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{decrement}</span>&gt;</span>-<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{count}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{increment}</span>&gt;</span>+<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p><strong>MobX</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { observer } <span class="hljs-keyword">from</span> <span class="hljs-string">'mobx-react-lite'</span>
<span class="hljs-keyword">import</span> counterStore <span class="hljs-keyword">from</span> <span class="hljs-string">'./stores/counterStore'</span>
​
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Counter</span> = <span class="hljs-title function_">observer</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> counterStore.decrement()}&gt;-<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{counterStore.count}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> counterStore.increment()}&gt;+<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
})
</code></pre>
<p><strong>对比</strong>：</p>
<ul>
<li>Redux：（actions + reducer + store + component）</li>
<li>Zustand：（store + component）</li>
<li>MobX：（store + component）</li>
</ul>
<h3 data-id="heading-10">3. 性能对比</h3>



































<table><thead><tr><th>特性</th><th>Redux</th><th>Zustand</th><th>MobX</th></tr></thead><tbody><tr><td><strong>更新粒度</strong></td><td>组件级（通过 useSelector）</td><td>选择器级（细粒度）</td><td>属性级（最细粒度）</td></tr><tr><td><strong>重新渲染</strong></td><td>订阅的组件重新渲染</td><td>订阅的组件重新渲染</td><td>只有使用变化属性的组件重新渲染</td></tr><tr><td><strong>性能优化</strong></td><td>需要手动优化（useMemo、useCallback）</td><td>自动优化（选择器）</td><td>自动优化（细粒度追踪）</td></tr><tr><td><strong>大列表性能</strong></td><td>良好</td><td>良好</td><td>优秀</td></tr></tbody></table>
<p><strong>结论</strong>：MobX 性能最好（细粒度更新），Zustand 和 Redux 性能相近。</p>
<h3 data-id="heading-11">5. TypeScript 支持</h3>





























<table><thead><tr><th>特性</th><th>Redux</th><th>Zustand</th><th>MobX</th></tr></thead><tbody><tr><td><strong>原生支持</strong></td><td>需要额外配置</td><td>原生支持</td><td>原生支持</td></tr><tr><td><strong>类型推断</strong></td><td>需要手动定义类型</td><td>自动推断</td><td>自动推断</td></tr><tr><td><strong>类型安全</strong></td><td>良好（需要配置）</td><td>优秀</td><td>优秀</td></tr></tbody></table>
<p><strong>结论</strong>：Zustand 和 MobX 的 TypeScript 支持更好。</p>
<h3 data-id="heading-12">6. 中间件和扩展</h3>



































<table><thead><tr><th>特性</th><th>Redux</th><th>Zustand</th><th>MobX</th></tr></thead><tbody><tr><td><strong>中间件系统</strong></td><td>强大（redux-thunk、redux-saga 等）</td><td>内置中间件（persist、devtools）</td><td>无中间件概念</td></tr><tr><td><strong>DevTools</strong></td><td>优秀（Redux DevTools）</td><td>支持（可选）</td><td>支持（MobX DevTools）</td></tr><tr><td><strong>持久化</strong></td><td>需要 redux-persist</td><td>内置 persist 中间件</td><td>需要 mobx-persist</td></tr><tr><td><strong>异步处理</strong></td><td>redux-thunk、redux-saga</td><td>原生支持</td><td>原生支持（runInAction）</td></tr></tbody></table>
<p><strong>结论</strong>：Redux 的中间件生态系统最丰富，Zustand 内置常用功能，MobX 通过其他方式实现。</p>
<h3 data-id="heading-13">7. 适用场景</h3>
<h4 data-id="heading-14">Redux 适合：</h4>
<ul>
<li>✅ 大型复杂应用</li>
<li>✅ 需要时间旅行调试</li>
<li>✅ 需要强大的中间件系统</li>
<li>✅ 团队熟悉函数式编程</li>
<li>✅ 需要严格的状态管理规范</li>
</ul>
<h4 data-id="heading-15">Zustand 适合：</h4>
<ul>
<li>✅ 中小型应用</li>
<li>✅ 需要简单快速的状态管理</li>
<li>✅ 不想写太多样板代码</li>
<li>✅ 需要轻量级解决方案</li>
<li>✅ 快速原型开发</li>
</ul>
<h4 data-id="heading-16">MobX 适合：</h4>
<ul>
<li>✅ 需要细粒度更新</li>
<li>✅ 喜欢响应式编程</li>
<li>✅ 面向对象思维</li>
<li>✅ 需要高性能的大列表</li>
<li>✅ 复杂的状态依赖关系</li>
</ul>
<h3 data-id="heading-17">8. 生态</h3>



































<table><thead><tr><th>特性</th><th>Redux</th><th>Zustand</th><th>MobX</th></tr></thead><tbody><tr><td><strong>社区规模</strong></td><td>最大</td><td>中等</td><td>较大</td></tr><tr><td><strong>第三方库</strong></td><td>丰富（redux-thunk、redux-saga 等）</td><td>较少</td><td>中等</td></tr><tr><td><strong>学习资源</strong></td><td>最多</td><td>中等</td><td>较多</td></tr><tr><td><strong>维护活跃度</strong></td><td>活跃</td><td>活跃</td><td>活跃</td></tr></tbody></table>
<p><strong>结论</strong>：Redux 生态系统最丰富，Zustand 和 MobX 生态系统相对较小但足够使用。</p>

























<table><thead><tr><th>方案</th><th>核心定位</th><th>最佳适用场景</th></tr></thead><tbody><tr><td>Redux</td><td>规范优先的全量状态管理</td><td>超大型应用、多人协作团队、需要严格状态追溯 / 审计的场景（如企业级系统、大型电商、政务系统）；需依赖丰富中间件（saga/thunk）处理复杂异步逻辑的场景。</td></tr><tr><td>Zustand</td><td>轻量优先的极简状态管理</td><td>中小型应用、追求低样板代码的场景；替代 Context + useReducer 解决性能问题的场景（如工具类应用、中小型业务系统）；需要「无 Provider 嵌套」+「细粒度订阅」的场景。</td></tr><tr><td>MobX</td><td>效率优先的响应式管理</td><td>复杂状态交互、快速开发的场景；交互密集型应用（如可视化编辑器、表单密集型应用、数据看板）；追求「零样板代码」+「极致细粒度更新」的场景。</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS BEM命名-档案管理和物联网]]></title>    <link>https://juejin.cn/post/7600764857769918514</link>    <guid>https://juejin.cn/post/7600764857769918514</guid>    <pubDate>2026-01-30T07:06:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600764857769918514" data-draft-id="7600678255042412553" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS BEM命名-档案管理和物联网"/> <meta itemprop="keywords" content="CSS"/> <meta itemprop="datePublished" content="2026-01-30T07:06:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="hypnos_xy"/> <meta itemprop="url" content="https://juejin.cn/user/1259383317872089"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS BEM命名-档案管理和物联网
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1259383317872089/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    hypnos_xy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T07:06:34.000Z" title="Fri Jan 30 2026 07:06:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto;border:3px solid rgba(62,175,124,.2)}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-weight:700;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:6px;border:2px solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c}.markdown-body a:active,.markdown-body a:hover{border-bottom:1.5px solid #3eaf7c}.markdown-body a:before{content:"⇲"}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(62,175,124,.2)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:.5rem solid;border-color:#42b983;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none}.markdown-body ul li:before{content:"•";margin-right:4px;color:#3eaf7c}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">档案管理</h2>
<h3 data-id="heading-1">block</h3>
<h4 data-id="heading-2">文件管理</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.file</span>            <span class="hljs-comment">/* 文件 */</span>
<span class="hljs-selector-class">.folder</span>          <span class="hljs-comment">/* 文件夹 */</span>
<span class="hljs-selector-class">.document</span>        <span class="hljs-comment">/* 文档 */</span>
<span class="hljs-selector-class">.archive</span>         <span class="hljs-comment">/* 档案 */</span>
<span class="hljs-selector-class">.record</span>          <span class="hljs-comment">/* 记录 */</span>
<span class="hljs-selector-class">.file-list</span>       <span class="hljs-comment">/* 文件列表 */</span>
<span class="hljs-selector-class">.folder-tree</span>     <span class="hljs-comment">/* 文件夹树 */</span>
<span class="hljs-selector-class">.file-grid</span>       <span class="hljs-comment">/* 文件网格 */</span>
<span class="hljs-selector-class">.file-item</span>       <span class="hljs-comment">/* 文件项 */</span>
<span class="hljs-selector-class">.folder-item</span>     <span class="hljs-comment">/* 文件夹项 */</span>
</code></pre>
<h4 data-id="heading-3">文件操作</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.file-upload</span>     <span class="hljs-comment">/* 文件上传 */</span>
<span class="hljs-selector-class">.file-download</span>   <span class="hljs-comment">/* 文件下载 */</span>
<span class="hljs-selector-class">.file-preview</span>    <span class="hljs-comment">/* 文件预览 */</span>
<span class="hljs-selector-class">.file-edit</span>       <span class="hljs-comment">/* 文件编辑 */</span>
<span class="hljs-selector-class">.file-delete</span>     <span class="hljs-comment">/* 文件删除 */</span>
<span class="hljs-selector-class">.file-move</span>       <span class="hljs-comment">/* 文件移动 */</span>
<span class="hljs-selector-class">.file-copy</span>       <span class="hljs-comment">/* 文件复制 */</span>
<span class="hljs-selector-class">.file-share</span>      <span class="hljs-comment">/* 文件分享 */</span>
<span class="hljs-selector-class">.file-print</span>      <span class="hljs-comment">/* 文件打印 */</span>
<span class="hljs-selector-class">.file-export</span>     <span class="hljs-comment">/* 文件导出 */</span>
<span class="hljs-selector-class">.file-import</span>     <span class="hljs-comment">/* 文件导入 */</span>
</code></pre>
<h4 data-id="heading-4">预览与查看</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.preview</span>         <span class="hljs-comment">/* 预览 */</span>
<span class="hljs-selector-class">.viewer</span>          <span class="hljs-comment">/* 查看器 */</span>
<span class="hljs-selector-class">.thumbnail</span>       <span class="hljs-comment">/* 缩略图 */</span>
<span class="hljs-selector-class">.fullscreen</span>      <span class="hljs-comment">/* 全屏查看 */</span>
<span class="hljs-selector-class">.document-view</span>   <span class="hljs-comment">/* 文档视图 */</span>
<span class="hljs-selector-class">.image-viewer</span>    <span class="hljs-comment">/* 图片查看器 */</span>
<span class="hljs-selector-class">.pdf-viewer</span>      <span class="hljs-comment">/* PDF查看器 */</span>
<span class="hljs-selector-class">.video-viewer</span>    <span class="hljs-comment">/* 视频查看器 */</span>
</code></pre>
<h4 data-id="heading-5">分类与标签</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.category</span>        <span class="hljs-comment">/* 分类 */</span>
<span class="hljs-selector-class">.tag</span>             <span class="hljs-comment">/* 标签 */</span>
<span class="hljs-selector-class">.label</span>           <span class="hljs-comment">/* 标签（用于标记） */</span>
<span class="hljs-selector-class">.classification</span>  <span class="hljs-comment">/* 分类（分级） */</span>
<span class="hljs-selector-class">.taxonomy</span>        <span class="hljs-comment">/* 分类法 */</span>
<span class="hljs-selector-class">.metadata</span>        <span class="hljs-comment">/* 元数据 */</span>
<span class="hljs-selector-class">.keyword</span>         <span class="hljs-comment">/* 关键词 */</span>
</code></pre>
<h4 data-id="heading-6">搜索与筛选</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.search-box</span>      <span class="hljs-comment">/* 搜索框 */</span>
<span class="hljs-selector-class">.advanced-search</span> <span class="hljs-comment">/* 高级搜索 */</span>
<span class="hljs-selector-class">.filter</span>          <span class="hljs-comment">/* 筛选器 */</span>
<span class="hljs-selector-class">.sort</span>            <span class="hljs-comment">/* 排序器 */</span>
<span class="hljs-selector-class">.search-result</span>   <span class="hljs-comment">/* 搜索结果 */</span>
<span class="hljs-selector-class">.filter-panel</span>    <span class="hljs-comment">/* 筛选面板 */</span>
<span class="hljs-selector-class">.search-history</span>  <span class="hljs-comment">/* 搜索历史 */</span>
</code></pre>
<h4 data-id="heading-7">版本控制</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.version</span>         <span class="hljs-comment">/* 版本 */</span>
<span class="hljs-selector-class">.version-history</span> <span class="hljs-comment">/* 版本历史 */</span>
<span class="hljs-selector-class">.version-list</span>    <span class="hljs-comment">/* 版本列表 */</span>
<span class="hljs-selector-class">.revision</span>        <span class="hljs-comment">/* 修订版 */</span>
<span class="hljs-selector-class">.diff</span>            <span class="hljs-comment">/* 差异对比 */</span>
<span class="hljs-selector-class">.change-log</span>      <span class="hljs-comment">/* 变更日志 */</span>
</code></pre>
<h4 data-id="heading-8">权限与分享</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.permission</span>      <span class="hljs-comment">/* 权限 */</span>
<span class="hljs-selector-class">.permission-list</span> <span class="hljs-comment">/* 权限列表 */</span>
<span class="hljs-selector-class">.share</span>           <span class="hljs-comment">/* 分享 */</span>
<span class="hljs-selector-class">.share-dialog</span>    <span class="hljs-comment">/* 分享对话框 */</span>
<span class="hljs-selector-class">.access-control</span>  <span class="hljs-comment">/* 访问控制 */</span>
<span class="hljs-selector-class">.role</span>            <span class="hljs-comment">/* 角色 */</span>
<span class="hljs-selector-class">.user-permission</span> <span class="hljs-comment">/* 用户权限 */</span>
</code></pre>
<h4 data-id="heading-9">工作流</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.workflow</span>        <span class="hljs-comment">/* 工作流 */</span>
<span class="hljs-selector-class">.approval</span>        <span class="hljs-comment">/* 审批 */</span>
<span class="hljs-selector-class">.approval-flow</span>   <span class="hljs-comment">/* 审批流程 */</span>
<span class="hljs-selector-class">.task</span>            <span class="hljs-comment">/* 任务 */</span>
<span class="hljs-selector-class">.task-list</span>       <span class="hljs-comment">/* 任务列表 */</span>
<span class="hljs-selector-class">.process</span>         <span class="hljs-comment">/* 流程 */</span>
<span class="hljs-selector-class">.step</span>            <span class="hljs-comment">/* 步骤 */</span>
</code></pre>
<h4 data-id="heading-10">档案属性</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.metadata-panel</span>  <span class="hljs-comment">/* 元数据面板 */</span>
<span class="hljs-selector-class">.properties</span>      <span class="hljs-comment">/* 属性 */</span>
<span class="hljs-selector-class">.details</span>         <span class="hljs-comment">/* 详情 */</span>
<span class="hljs-selector-class">.info-panel</span>      <span class="hljs-comment">/* 信息面板 */</span>
<span class="hljs-selector-class">.stats</span>           <span class="hljs-comment">/* 统计信息 */</span>
<span class="hljs-selector-class">.usage-stats</span>     <span class="hljs-comment">/* 使用统计 */</span>
</code></pre>
<h4 data-id="heading-11">其他</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.barcode-scanner</span> <span class="hljs-comment">/* 条形码扫描器 */</span>
<span class="hljs-selector-class">.qr-code</span>         <span class="hljs-comment">/* 二维码 */</span>
<span class="hljs-selector-class">.document-scanner</span> <span class="hljs-comment">/* 文档扫描仪 */</span>
<span class="hljs-selector-class">.ocr</span>             <span class="hljs-comment">/* 光学字符识别 */</span>
<span class="hljs-selector-class">.digital-signature</span> <span class="hljs-comment">/* 数字签名 */</span>
<span class="hljs-selector-class">.watermark</span>       <span class="hljs-comment">/* 水印 */</span>
<span class="hljs-selector-class">.archive-search</span>  <span class="hljs-comment">/* 档案搜索 */</span>
<span class="hljs-selector-class">.retention-policy</span> <span class="hljs-comment">/* 保留策略 */</span>
</code></pre>
<h3 data-id="heading-12">element</h3>
<h4 data-id="heading-13">文件管理</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* .file 的 Element */</span>
__icon       <span class="hljs-comment">/* 文件图标 */</span>
__name       <span class="hljs-comment">/* 文件名 */</span>
__size       <span class="hljs-comment">/* 文件大小 */</span>
__type       <span class="hljs-comment">/* 文件类型 */</span>
__modified   <span class="hljs-comment">/* 修改时间 */</span>
__preview    <span class="hljs-comment">/* 文件预览 */</span>
__actions    <span class="hljs-comment">/* 文件操作 */</span>
__status     <span class="hljs-comment">/* 文件状态 */</span>
__version    <span class="hljs-comment">/* 文件版本 */</span>
__metadata   <span class="hljs-comment">/* 元数据 */</span>
</code></pre>
<h4 data-id="heading-14">文件夹管理</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* .folder 的 Element */</span>
__icon       <span class="hljs-comment">/* 文件夹图标 */</span>
__name       <span class="hljs-comment">/* 文件夹名 */</span>
__count      <span class="hljs-comment">/* 文件数量 */</span>
__size       <span class="hljs-comment">/* 文件夹大小 */</span>
__tree       <span class="hljs-comment">/* 树形结构 */</span>
__node       <span class="hljs-comment">/* 树节点 */</span>
__children   <span class="hljs-comment">/* 子文件夹 */</span>
__expand     <span class="hljs-comment">/* 展开按钮 */</span>
__collapse   <span class="hljs-comment">/* 折叠按钮 */</span>
</code></pre>
<h4 data-id="heading-15">文档查看器</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* .document-viewer 的 Element */</span>
__page       <span class="hljs-comment">/* 页面 */</span>
__content    <span class="hljs-comment">/* 文档内容 */</span>
__toolbar    <span class="hljs-comment">/* 工具栏 */</span>
__zoom       <span class="hljs-comment">/* 缩放控制 */</span>
__page-<span class="hljs-selector-tag">nav</span>   <span class="hljs-comment">/* 页面导航 */</span>
__thumbnails <span class="hljs-comment">/* 缩略图 */</span>
__search     <span class="hljs-comment">/* 搜索区域 */</span>
__highlight  <span class="hljs-comment">/* 高亮标记 */</span>
__annotation <span class="hljs-comment">/* 批注 */</span>
</code></pre>
<h2 data-id="heading-16">物联网项目</h2>
<h3 data-id="heading-17">block</h3>
<h4 data-id="heading-18">设备管理</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.device</span>          <span class="hljs-comment">/* 设备 */</span>
<span class="hljs-selector-class">.device-list</span>     <span class="hljs-comment">/* 设备列表 */</span>
<span class="hljs-selector-class">.device-item</span>     <span class="hljs-comment">/* 设备项 */</span>
<span class="hljs-selector-class">.device-detail</span>   <span class="hljs-comment">/* 设备详情 */</span>
<span class="hljs-selector-class">.device-status</span>   <span class="hljs-comment">/* 设备状态 */</span>
<span class="hljs-selector-class">.device-control</span>  <span class="hljs-comment">/* 设备控制 */</span>
<span class="hljs-selector-class">.device-config</span>   <span class="hljs-comment">/* 设备配置 */</span>
<span class="hljs-selector-class">.device-group</span>    <span class="hljs-comment">/* 设备组 */</span>
</code></pre>
<h4 data-id="heading-19">传感器与数据</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.sensor</span>          <span class="hljs-comment">/* 传感器 */</span>
<span class="hljs-selector-class">.sensor-list</span>     <span class="hljs-comment">/* 传感器列表 */</span>
<span class="hljs-selector-class">.data-stream</span>     <span class="hljs-comment">/* 数据流 */</span>
<span class="hljs-selector-class">.metric</span>          <span class="hljs-comment">/* 指标 */</span>
<span class="hljs-selector-class">.reading</span>         <span class="hljs-comment">/* 读数 */</span>
<span class="hljs-selector-class">.sensor-data</span>     <span class="hljs-comment">/* 传感器数据 */</span>
<span class="hljs-selector-class">.data-point</span>      <span class="hljs-comment">/* 数据点 */</span>
<span class="hljs-selector-class">.telemetry</span>       <span class="hljs-comment">/* 遥测数据 */</span>
</code></pre>
<h4 data-id="heading-20">监控与告警</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.monitor</span>         <span class="hljs-comment">/* 监控 */</span>
<span class="hljs-selector-class">.monitor-panel</span>   <span class="hljs-comment">/* 监控面板 */</span>
<span class="hljs-selector-class">.alert</span>           <span class="hljs-comment">/* 告警 */</span>
<span class="hljs-selector-class">.alert-list</span>      <span class="hljs-comment">/* 告警列表 */</span>
<span class="hljs-selector-class">.notification</span>    <span class="hljs-comment">/* 通知 */</span>
<span class="hljs-selector-class">.threshold</span>       <span class="hljs-comment">/* 阈值 */</span>
<span class="hljs-selector-class">.alert-history</span>   <span class="hljs-comment">/* 告警历史 */</span>
<span class="hljs-selector-class">.warning</span>         <span class="hljs-comment">/* 警告 */</span>
</code></pre>
<h4 data-id="heading-21">地图与位置</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.map</span>             <span class="hljs-comment">/* 地图 */</span>
<span class="hljs-selector-class">.map-view</span>        <span class="hljs-comment">/* 地图视图 */</span>
<span class="hljs-selector-class">.location</span>        <span class="hljs-comment">/* 位置 */</span>
<span class="hljs-selector-class">.geo-map</span>         <span class="hljs-comment">/* 地理地图 */</span>
<span class="hljs-selector-class">.location-marker</span> <span class="hljs-comment">/* 位置标记 */</span>
<span class="hljs-selector-class">.geofence</span>        <span class="hljs-comment">/* 地理围栏 */</span>
<span class="hljs-selector-class">.coordinate</span>      <span class="hljs-comment">/* 坐标 */</span>
</code></pre>
<h4 data-id="heading-22">控制面板</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.dashboard</span>       <span class="hljs-comment">/* 仪表板 */</span>
<span class="hljs-selector-class">.control-panel</span>   <span class="hljs-comment">/* 控制面板 */</span>
<span class="hljs-selector-class">.control-button</span>  <span class="hljs-comment">/* 控制按钮 */</span>
<span class="hljs-selector-class">.switch</span>          <span class="hljs-comment">/* 开关 */</span>
<span class="hljs-selector-class">.slider-control</span>  <span class="hljs-comment">/* 滑块控制 */</span>
<span class="hljs-selector-class">.toggle-control</span>  <span class="hljs-comment">/* 切换控制 */</span>
<span class="hljs-selector-class">.remote-control</span>  <span class="hljs-comment">/* 远程控制 */</span>
</code></pre>
<h4 data-id="heading-23">图表与可视化</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.chart</span>           <span class="hljs-comment">/* 图表 */</span>
<span class="hljs-selector-class">.realtime-chart</span>  <span class="hljs-comment">/* 实时图表 */</span>
<span class="hljs-selector-class">.historical-data</span> <span class="hljs-comment">/* 历史数据 */</span>
<span class="hljs-selector-class">.trend</span>           <span class="hljs-comment">/* 趋势 */</span>
<span class="hljs-selector-class">.graph</span>           <span class="hljs-comment">/* 图形 */</span>
<span class="hljs-selector-class">.gauge</span>           <span class="hljs-comment">/* 仪表盘 */</span>
<span class="hljs-selector-class">.indicator</span>       <span class="hljs-comment">/* 指示器 */</span>
</code></pre>
<h4 data-id="heading-24">网络与连接</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.network</span>         <span class="hljs-comment">/* 网络 */</span>
<span class="hljs-selector-class">.connection</span>      <span class="hljs-comment">/* 连接 */</span>
<span class="hljs-selector-class">.signal</span>          <span class="hljs-comment">/* 信号 */</span>
<span class="hljs-selector-class">.signal-strength</span> <span class="hljs-comment">/* 信号强度 */</span>
<span class="hljs-selector-class">.network-status</span>  <span class="hljs-comment">/* 网络状态 */</span>
<span class="hljs-selector-class">.connectivity</span>    <span class="hljs-comment">/* 连接性 */</span>
<span class="hljs-selector-class">.connection-log</span>  <span class="hljs-comment">/* 连接日志 */</span>
</code></pre>
<h4 data-id="heading-25">日志与事件</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.log</span>             <span class="hljs-comment">/* 日志 */</span>
<span class="hljs-selector-class">.log-viewer</span>      <span class="hljs-comment">/* 日志查看器 */</span>
<span class="hljs-selector-class">.event</span>           <span class="hljs-comment">/* 事件 */</span>
<span class="hljs-selector-class">.event-list</span>      <span class="hljs-comment">/* 事件列表 */</span>
<span class="hljs-selector-class">.activity-log</span>    <span class="hljs-comment">/* 活动日志 */</span>
<span class="hljs-selector-class">.audit-trail</span>     <span class="hljs-comment">/* 审计追踪 */</span>
<span class="hljs-selector-class">.timestamp</span>       <span class="hljs-comment">/* 时间戳 */</span>
</code></pre>
<h4 data-id="heading-26">设备类型特定</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.thermostat</span>      <span class="hljs-comment">/* 温控器 */</span>
<span class="hljs-selector-class">.camera</span>          <span class="hljs-comment">/* 摄像头 */</span>
<span class="hljs-selector-class">.lock</span>            <span class="hljs-comment">/* 锁 */</span>
<span class="hljs-selector-class">.light</span>           <span class="hljs-comment">/* 灯 */</span>
<span class="hljs-selector-class">.motor</span>           <span class="hljs-comment">/* 电机 */</span>
<span class="hljs-selector-class">.valve</span>           <span class="hljs-comment">/* 阀门 */</span>
<span class="hljs-selector-class">.relay</span>           <span class="hljs-comment">/* 继电器 */</span>
<span class="hljs-selector-class">.gateway</span>         <span class="hljs-comment">/* 网关 */</span>
</code></pre>
<h4 data-id="heading-27">其他</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.firmware-update</span> <span class="hljs-comment">/* 固件更新 */</span>
<span class="hljs-selector-class">.ota</span>             <span class="hljs-comment">/* 空中下载技术 */</span>
<span class="hljs-selector-class">.command</span>         <span class="hljs-comment">/* 命令 */</span>
<span class="hljs-selector-class">.command-history</span> <span class="hljs-comment">/* 命令历史 */</span>
<span class="hljs-selector-class">.device-log</span>      <span class="hljs-comment">/* 设备日志 */</span>
<span class="hljs-selector-class">.battery-status</span>  <span class="hljs-comment">/* 电池状态 */</span>
<span class="hljs-selector-class">.signal-quality</span>  <span class="hljs-comment">/* 信号质量 */</span>
<span class="hljs-selector-class">.provisioning</span>    <span class="hljs-comment">/* 设备配网 */</span>
</code></pre>
<h3 data-id="heading-28">element</h3>
<h4 data-id="heading-29">设备管理</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* .device 的 Element */</span>
__icon       <span class="hljs-comment">/* 设备图标 */</span>
__name       <span class="hljs-comment">/* 设备名称 */</span>
__status     <span class="hljs-comment">/* 设备状态 */</span>
__online     <span class="hljs-comment">/* 在线状态 */</span>
__offline    <span class="hljs-comment">/* 离线状态 */</span>
__signal     <span class="hljs-comment">/* 信号强度 */</span>
__battery    <span class="hljs-comment">/* 电池状态 */</span>
__location   <span class="hljs-comment">/* 位置信息 */</span>
__data       <span class="hljs-comment">/* 设备数据 */</span>
__controls   <span class="hljs-comment">/* 控制按钮 */</span>
</code></pre>
<h4 data-id="heading-30">传感器数据</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* .sensor 的 Element */</span>
__value      <span class="hljs-comment">/* 传感器数值 */</span>
__unit       <span class="hljs-comment">/* 单位 */</span>
__reading    <span class="hljs-comment">/* 读数 */</span>
__timestamp  <span class="hljs-comment">/* 时间戳 */</span>
__trend      <span class="hljs-comment">/* 趋势指示 */</span>
__chart      <span class="hljs-comment">/* 数据图表 */</span>
__threshold  <span class="hljs-comment">/* 阈值显示 */</span>
__alert      <span class="hljs-comment">/* 告警状态 */</span>
</code></pre>
<h4 data-id="heading-31">地图展示</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* .map 的 Element */</span>
__marker     <span class="hljs-comment">/* 标记点 */</span>
__cluster    <span class="hljs-comment">/* 标记簇 */</span>
__popup      <span class="hljs-comment">/* 弹出信息 */</span>
__tooltip    <span class="hljs-comment">/* 工具提示 */</span>
__controls   <span class="hljs-comment">/* 地图控制 */</span>
__zoom       <span class="hljs-comment">/* 缩放控制 */</span>
__pan        <span class="hljs-comment">/* 平移控制 */</span>
__layer      <span class="hljs-comment">/* 地图图层 */</span>
__legend     <span class="hljs-comment">/* 图例 */</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[text-decoration 属性]]></title>    <link>https://juejin.cn/post/7600728866757443636</link>    <guid>https://juejin.cn/post/7600728866757443636</guid>    <pubDate>2026-01-30T07:17:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600728866757443636" data-draft-id="7600728866757427252" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="text-decoration 属性"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-30T07:17:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户9388783127708"/> <meta itemprop="url" content="https://juejin.cn/user/1865202043469607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            text-decoration 属性
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1865202043469607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户9388783127708
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T07:17:50.000Z" title="Fri Jan 30 2026 07:17:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">简介</h3>
<p>text-decoration是CSS中用于为文本添加装饰效果的核心属性，主要作用是给文本添加下划线、删除线、上划线等视觉装饰，常用于标记可点击链接、已完成内容、编辑状态文本等场景，通过视觉提示帮助用户理解文本的功能或状态。它是一个简写属性，可以同时设置文本装饰的样式、颜色和线条类型，也可以通过单独的子属性进行更精细的控制。</p>
<h3 data-id="heading-1">语法</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-number">1</span>. 简写语法：<span class="hljs-attribute">text-decoration</span>: &lt;text-decoration-line&gt; || &lt;text-decoration-style&gt; || &lt;text-decoration-color&gt; || &lt;text-decoration-thickness&gt;;
<span class="hljs-number">2</span>. 单独子属性：
   - <span class="hljs-attribute">text-decoration-line</span>：控制装饰线的位置，可选值有<span class="hljs-attribute">none</span>（默认，无装饰）、underline（下划线）、overline（上划线）、line-through（删除线）、blink（已废弃，闪烁效果），可多个值空格分隔同时设置
   - <span class="hljs-attribute">text-decoration-style</span>：控制装饰线的样式，可选值有solid（实线，默认）、double（双实线）、dotted（点线）、dashed（虚线）、wavy（波浪线）
   - <span class="hljs-attribute">text-decoration-color</span>：控制装饰线的颜色，可使用任意CSS颜色值（十六进制、RGB、颜色名等）
   - <span class="hljs-attribute">text-decoration</span>-thickness：控制装饰线的粗细，可选值有auto（默认，浏览器自动计算）、from-<span class="hljs-attribute">font</span>（使用字体文件中定义的粗细）、长度值（如<span class="hljs-number">2px</span>）、百分比（如<span class="hljs-number">10%</span>）
</code></pre>
<h3 data-id="heading-2">示例</h3>
<h4 data-id="heading-3">HTML</h4>
<p>复制</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>text-decoration 示例<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"style.css"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>text-decoration 基础示例<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"default"</span>&gt;</span>默认文本（无装饰）<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"underline"</span>&gt;</span>这是带下划线的文本<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"line-through"</span>&gt;</span>这是带删除线的文本<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"overline"</span>&gt;</span>这是带上划线的文本<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"multi-line"</span>&gt;</span>同时带上划线和下划线<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"custom-style"</span>&gt;</span>带波浪下划线的文本<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"custom-color"</span>&gt;</span>蓝色粗下划线的文本<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"remove-link"</span>&gt;</span>去除默认下划线的链接<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h4 data-id="heading-4">CSS</h4>
<p>复制</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 基础装饰效果 */</span>
<span class="hljs-selector-class">.default</span> {
    <span class="hljs-attribute">text-decoration</span>: none;
}
<span class="hljs-selector-class">.underline</span> {
    <span class="hljs-attribute">text-decoration</span>: underline;
}
<span class="hljs-selector-class">.line-through</span> {
    <span class="hljs-attribute">text-decoration</span>: line-through;
}
<span class="hljs-selector-class">.overline</span> {
    <span class="hljs-attribute">text-decoration</span>: overline;
}
<span class="hljs-comment">/* 多装饰线同时设置 */</span>
<span class="hljs-selector-class">.multi-line</span> {
    <span class="hljs-attribute">text-decoration</span>: underline overline;
}
<span class="hljs-comment">/* 自定义装饰线样式 */</span>
<span class="hljs-selector-class">.custom-style</span> {
    <span class="hljs-attribute">text-decoration</span>: underline wavy;
}
<span class="hljs-comment">/* 自定义颜色和粗细 */</span>
<span class="hljs-selector-class">.custom-color</span> {
    <span class="hljs-attribute">text-decoration</span>: underline solid blue <span class="hljs-number">2px</span>;
}
<span class="hljs-comment">/* 去除链接默认下划线 */</span>
<span class="hljs-selector-class">.remove-link</span> {
    <span class="hljs-attribute">text-decoration</span>: none;
}
<span class="hljs-selector-class">.remove-link</span><span class="hljs-selector-pseudo">:hover</span> {
    <span class="hljs-attribute">text-decoration</span>: underline dashed <span class="hljs-number">#ff4444</span>;
}
</code></pre>
<h3 data-id="heading-5">详细解释</h3>
<ol>
<li>.default类：设置text-decoration为none，展示无装饰的默认文本状态 2. .underline/.line-through/.overline类：分别设置单一的下划线、删除线、上划线效果，是最基础的使用方式 3. .multi-line类：同时设置underline和overline，实现文本上下同时有装饰线的效果 4. .custom-style类：指定了装饰线类型为underline，样式为wavy（波浪线），展示自定义装饰线样式的效果 5. .custom-color类：完整设置了装饰线的所有属性，分别是下划线、实线样式、蓝色、2px粗细，展示多属性组合的写法 6. .remove-link类：先去除a标签默认的下划线，然后在hover（鼠标悬停）时添加红色虚线下划线，既优化了默认样式，又保留了链接的交互提示</li>
</ol>
<h3 data-id="heading-6">进阶用法</h3>
<ol>
<li>编辑状态标记：在富文本编辑器中，使用line-through标记已删除的内容，使用underline标记新增的内容，配合不同颜色区分编辑状态 2. 电商价格展示：给原价添加line-through #999的样式，同时展示红色的现价，突出价格优惠信息 3. 自定义链接样式：给链接设置text-decoration: underline wavy #2196F3，实现区别于默认下划线的特色链接样式，增强品牌视觉识别 4. 表单验证提示：给输入错误的表单提示文本添加wavy red的下划线，直观提示用户输入错误 5. 结合伪元素使用：可以通过::after伪元素配合text-decoration实现更复杂的装饰效果，比如在标题下方添加带颜色的装饰线</li>
</ol>
<h3 data-id="heading-7">常见错误</h3>
<ol>
<li>错误：给块级元素设置text-decoration后，误以为子元素可以单独取消装饰。实际上text-decoration会继承给子元素，若要取消子元素的装饰，需要单独给子元素设置text-decoration:none 2. 错误：使用blink值实现闪烁效果，该值已被标准废弃，大部分浏览器不再支持，应避免使用 3. 错误：过度使用装饰线，比如同时给文本添加underline、overline、line-through，导致文本可读性极差 4. 错误：设置装饰线颜色时使用与文本完全相同的颜色，导致装饰线不明显，失去提示作用 5. 错误：去除链接下划线后未添加其他交互反馈，导致用户无法识别可点击元素，应在hover/focus状态下添加装饰或颜色变化</li>
</ol>
<h3 data-id="heading-8">使用技巧</h3>
<ol>
<li>链接样式优化：默认a标签带有下划线，可设置text-decoration:none去除，在hover/focus状态下再添加装饰，提升页面美观度同时保证可访问性 2. 删除线使用场景：常用于电商网站的原价标记、已完成的待办事项，建议搭配较浅的颜色，避免干扰主要内容 3. 装饰线颜色：建议与文本颜色区分开但保持协调，比如使用文本色的70%透明度，既保留提示性又不突兀 4. 避免过度使用：不要同时给文本添加多种装饰线，会导致文本可读性下降，仅在有明确语义需求时使用 5. 可访问性注意：如果使用下划线模拟链接，务必确保有对应的交互反馈，避免混淆普通文本和可点击元素</li>
</ol>
<h3 data-id="heading-9">浏览器兼容性</h3>
<ol>
<li>基础属性（text-decoration-line的none/underline/overline/line-through）：支持所有现代浏览器，包括IE6及以上 2. text-decoration-style的wavy/double/dotted/dashed：支持Chrome 57+、Firefox 36+、Safari 12.1+、Edge 79+，IE不支持 3. text-decoration-thickness：支持Chrome 87+、Firefox 70+、Safari 14.1+、Edge 87+，IE不支持 4. 简写属性的多值组合：所有支持CSS3的浏览器都能正常解析</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[字体大小切割]]></title>    <link>https://juejin.cn/post/7600692485947146249</link>    <guid>https://juejin.cn/post/7600692485947146249</guid>    <pubDate>2026-01-30T07:24:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600692485947146249" data-draft-id="7600692485947064329" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="字体大小切割"/> <meta itemprop="keywords" content="前端,JavaScript,Node.js"/> <meta itemprop="datePublished" content="2026-01-30T07:24:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="葉_"/> <meta itemprop="url" content="https://juejin.cn/user/3369350189299688"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            字体大小切割
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3369350189299688/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    葉_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T07:24:16.000Z" title="Fri Jan 30 2026 07:24:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h4 data-id="heading-0">在开发中可能涉及到使用其他字体 但是大多数都太大了 需要优化加载的速度 这时候就可以用到字体大小切割了</h4>
<h3 data-id="heading-1">这里向大家介绍一下 <code>fontmin</code>库 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fecomfe%2Ffontmin" target="_blank" title="https://github.com/ecomfe/fontmin" ref="nofollow noopener noreferrer">地址</a></h3>
<h6 data-id="heading-2">Fontmin是一个用于优化网页字体文件的JavaScript工具库，核心功能是“字体子集化”。它能从完整的字体文件中提取出网页上实际用到的字符，从而将几兆甚至十几兆的字体文件（尤其是中文字体）压缩到几百KB，显著提升网页加载速度。</h6>
<h3 data-id="heading-3">核心功能一览</h3>

























<table><thead><tr><th>功能/插件</th><th>说明</th></tr></thead><tbody><tr><td><strong>字体子集化 (<code>glyph</code>)</strong></td><td>核心功能。通过分析指定文本，仅保留所需字符字形，生成极小字体文件<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2F%40akylas%2Ffontmin%3FactiveTab%3Dreadme" target="_blank" title="https://www.npmjs.com/package/@akylas/fontmin?activeTab=readme" ref="nofollow noopener noreferrer"/>。</td></tr><tr><td><strong>格式转换</strong></td><td>支持 <code>ttf2eot</code>, <code>ttf2woff</code>, <code>ttf2svg</code>, <code>otf2ttf</code> 等多种格式互转<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2F%40akylas%2Ffontmin%3FactiveTab%3Dreadme" target="_blank" title="https://www.npmjs.com/package/@akylas/fontmin?activeTab=readme" ref="nofollow noopener noreferrer"/><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fgitblog_00038%2Farticle%2Fdetails%2F154730055" target="_blank" title="https://blog.csdn.net/gitblog_00038/article/details/154730055" ref="nofollow noopener noreferrer"/>。</td></tr><tr><td><strong>CSS生成 (<code>css</code>)</strong></td><td>自动生成 <code>@font-face</code> 等CSS代码，便于网页使用图标字体或自定义字体<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2F%40akylas%2Ffontmin%3FactiveTab%3Dreadme" target="_blank" title="https://www.npmjs.com/package/@akylas/fontmin?activeTab=readme" ref="nofollow noopener noreferrer"/>。</td></tr><tr><td><strong>SVG图标合并 (<code>svgs2ttf</code>)</strong></td><td>将多个SVG图标文件合并成一个字体文件，方便制作图标字体<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2F%40akylas%2Ffontmin%3FactiveTab%3Dreadme" target="_blank" title="https://www.npmjs.com/package/@akylas/fontmin?activeTab=readme" ref="nofollow noopener noreferrer"/>。</td></tr></tbody></table>
<h3 data-id="heading-4">使用方法（以下是用koa框架进行的开发）</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 1.编辑Server</span>
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Fontmin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fontmin'</span>);
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AppletService</span> {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">generateFontSubset</span>(<span class="hljs-params">text, ttfpath, outputPath</span>) {
        <span class="hljs-keyword">const</span> fontmin = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Fontmin</span>().<span class="hljs-title function_">src</span>(ttfpath).<span class="hljs-title function_">use</span>(<span class="hljs-title class_">Fontmin</span>.<span class="hljs-title function_">glyph</span>({
            text <span class="hljs-comment">//仅保留文本中出现的字符  </span>
        })).<span class="hljs-title function_">use</span>(<span class="hljs-title class_">Fontmin</span>.<span class="hljs-title function_">ttf2woff</span>({
            <span class="hljs-attr">deflate</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 启用WOFF2压缩</span>
        })).<span class="hljs-title function_">dest</span>(outputPath);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
            fontmin.<span class="hljs-title function_">run</span>(<span class="hljs-function">(<span class="hljs-params">err, files</span>) =&gt;</span> {
                <span class="hljs-keyword">if</span> (err) <span class="hljs-title function_">reject</span>(err);
                <span class="hljs-keyword">else</span> <span class="hljs-title function_">resolve</span>(files);
            });
        });
    }
}
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AppletService</span>;
<span class="hljs-comment">// 2.编辑Controller</span>
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>).<span class="hljs-property">promises</span>;
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AppletController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">BaseController</span> {
    <span class="hljs-comment">/** *font
     * 字体分割
     * <span class="hljs-doctag">@param</span> {<span class="hljs-type">*</span>} ctx 
     */</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">getFont</span>(<span class="hljs-params">ctx</span>) {
        <span class="hljs-keyword">const</span> { text, fontFamily } = ctx.<span class="hljs-property">query</span>;
        <span class="hljs-keyword">if</span> (!text || !fontFamily) {
            <span class="hljs-keyword">return</span> ctx.<span class="hljs-property">body</span> = <span class="hljs-title class_">BaseController</span>.<span class="hljs-title function_">renderJsonFail</span>(<span class="hljs-number">303</span>, <span class="hljs-string">'参数错误'</span>);
        }
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">//const fontPath = `./fonts/${fontFamily}.ttf`</span>

            <span class="hljs-keyword">const</span> fontPath = <span class="hljs-string">`xxxx\\font\\今年也要加油鸭.ttf`</span>;
            <span class="hljs-comment">// 检查文件是否存在</span>
            <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">access</span>(fontPath);

            <span class="hljs-keyword">const</span> files = <span class="hljs-keyword">await</span> <span class="hljs-title class_">AppletService</span>.<span class="hljs-title function_">generateFontSubset</span>(text, fontPath, <span class="hljs-string">'xxxx\\subset.ttf'</span>);
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Subset files generated:'</span>, files)
            
            <span class="hljs-comment">// 找到生成的 woff 文件</span>
            <span class="hljs-keyword">const</span> woffFile = files.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">f</span> =&gt;</span> f.<span class="hljs-property">path</span>.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.woff'</span>));
            <span class="hljs-keyword">if</span> (!woffFile) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'生成字体文件失败'</span>);
            }
            

            ctx.<span class="hljs-property">type</span> = <span class="hljs-string">'font/woff2'</span>;
            ctx.<span class="hljs-property">body</span> = woffFile.<span class="hljs-property">contents</span>;
        } <span class="hljs-keyword">catch</span> (e) {
          
            <span class="hljs-keyword">return</span> ctx.<span class="hljs-property">body</span> = <span class="hljs-title class_">BaseController</span>.<span class="hljs-title function_">renderJsonFail</span>(<span class="hljs-number">303</span>, e);
        }

    }
}
<span class="hljs-comment">// 3.编辑router</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">AppletController</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../controller/AppletController'</span>);
router.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/font'</span>,<span class="hljs-title class_">AppletController</span>.<span class="hljs-property">getFont</span>)

<span class="hljs-comment">// 4.使用方法</span>
&lt;style&gt;
	@font-face {
		font-<span class="hljs-attr">family</span>: <span class="hljs-string">'CustomFont'</span>;
		<span class="hljs-attr">src</span>: <span class="hljs-title function_">url</span>(<span class="hljs-string">'http://localhost:3000/api/font?text=示例文本&amp;fontFamily=wwww'</span>) <span class="hljs-title function_">format</span>(<span class="hljs-string">'woff2'</span>);
	}

	.<span class="hljs-property">custom</span>-text {
		font-<span class="hljs-attr">family</span>: <span class="hljs-string">'CustomFont'</span>, sans-serif;
	}
&lt;/style&gt;
....
&lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"custom-text"</span>&gt;示例文本哦哦哦本&lt;/div&gt;
....
</code></pre>
<h4 data-id="heading-5">效果</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f975ef0b43394cb994649212ef6255e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JGJXw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770362655&amp;x-signature=wiZCrLvIpLdTmY8N8ggH9%2Ba88cQ%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于JavaScript和CSS的交互式图片面板设计与实现]]></title>    <link>https://juejin.cn/post/7600799940970414120</link>    <guid>https://juejin.cn/post/7600799940970414120</guid>    <pubDate>2026-01-30T07:49:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600799940970414120" data-draft-id="7600692485947310089" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于JavaScript和CSS的交互式图片面板设计与实现"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-30T07:49:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lee川"/> <meta itemprop="url" content="https://juejin.cn/user/2402874087453658"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于JavaScript和CSS的交互式图片面板设计与实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2402874087453658/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lee川
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T07:49:28.000Z" title="Fri Jan 30 2026 07:49:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">基于JavaScript和CSS的交互式图片面板设计与实现</h2>
<h3 data-id="heading-1">概述</h3>
<p>本文详细分析一个交互式图片面板展示效果的完整实现，涵盖HTML结构、CSS样式（包括Stylus预处理器）、JavaScript DOM操作和事件处理等前端核心技术。该效果允许用户点击不同面板，被点击的面板会展开并显示标题，其他面板则收缩，创造出流畅的视觉体验。</p>
<h3 data-id="heading-2">1. HTML结构设计</h3>
<p>HTML文档构建了基本的页面结构，包含一个容器和多个面板元素：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"panel active"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"background-image: url('...')"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>Explore The World<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"panel"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"background-image: url('...')"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>Wild Forest<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 更多面板 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>关键设计要点：</p>
<ul>
<li>使用<code>container</code>作为弹性布局容器，统一管理所有面板</li>
<li>每个<code>panel</code>代表一个可交互的图片面板</li>
<li>通过内联样式设置背景图片，实现动态内容加载</li>
<li>初始状态通过<code>active</code>类标记默认展开的面板</li>
<li>每个面板包含标题元素<code>&lt;h3&gt;</code>，初始状态下隐藏</li>
</ul>
<h3 data-id="heading-3">2. CSS样式与Stylus预处理器</h3>
<h4 data-id="heading-4">2.1 基础样式重置与布局</h4>
<pre><code class="hljs language-css" lang="css">* {
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
}
</code></pre>
<p>此规则重置了所有元素的默认边距，确保跨浏览器的一致性。</p>
<h4 data-id="heading-5">2.2 弹性布局实现</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">body</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: row;
  <span class="hljs-attribute">justify-content</span>: center;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
  <span class="hljs-attribute">overflow</span>: hidden;
}

<span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">90vw</span>;
}
</code></pre>
<p>布局关键技术：</p>
<ul>
<li><code>body</code>使用flex布局并设置<code>height: 100vh</code>，实现整体垂直水平居中</li>
<li><code>container</code>作为flex容器，默认沿主轴（水平方向）排列子元素</li>
<li><code>width: 90vw</code>确保容器占据视口宽度的90%，留出边距</li>
</ul>
<h4 data-id="heading-6">2.3 面板样式与动画效果</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> <span class="hljs-selector-class">.panel</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">80vh</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50px</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
  <span class="hljs-attribute">cursor</span>: pointer;
  <span class="hljs-attribute">flex</span>: <span class="hljs-number">0.5</span>;
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">background-size</span>: cover;
  <span class="hljs-attribute">background-position</span>: center;
  <span class="hljs-attribute">background-repeat</span>: no-repeat;
  <span class="hljs-attribute">transition</span>: all <span class="hljs-number">700ms</span> ease-in;
}

<span class="hljs-selector-class">.container</span> <span class="hljs-selector-class">.panel</span><span class="hljs-selector-class">.active</span> {
  <span class="hljs-attribute">flex</span>: <span class="hljs-number">5</span>;
}
</code></pre>
<p>面板设计特点：</p>
<ul>
<li><code>flex: 0.5</code>设置面板的初始伸缩比例，实现均匀分布</li>
<li><code>flex: 5</code>在激活状态下显著增加面板宽度</li>
<li><code>transition: all 700ms ease-in</code>创建700毫秒的过渡动画，ease-in函数使动画开始缓慢然后加速</li>
<li>背景图片使用<code>cover</code>模式，确保完全覆盖面板区域</li>
</ul>
<h4 data-id="heading-7">2.4 标题动画效果</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> <span class="hljs-selector-class">.panel</span> <span class="hljs-selector-tag">h3</span> {
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">transition</span>: opacity <span class="hljs-number">300ms</span> ease-in <span class="hljs-number">400ms</span>;
}

<span class="hljs-selector-class">.container</span> <span class="hljs-selector-class">.panel</span><span class="hljs-selector-class">.active</span> <span class="hljs-selector-tag">h3</span> {
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>;
}
</code></pre>
<p>标题动画设计：</p>
<ul>
<li>初始状态<code>opacity: 0</code>完全透明隐藏标题</li>
<li>激活状态下<code>opacity: 1</code>显示标题</li>
<li>过渡效果延迟400毫秒执行，确保面板展开动画完成后才开始标题显示</li>
</ul>
<h3 data-id="heading-8">3. Stylus预处理器优势</h3>
<p>虽然最终使用的是标准CSS，但开发过程中可以使用Stylus预处理器提高效率：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.container</span> 
  <span class="hljs-attribute">display</span> <span class="hljs-attribute">flex</span>
  <span class="hljs-attribute">width</span> <span class="hljs-number">90vw</span>
  
  <span class="hljs-selector-class">.panel</span>
    <span class="hljs-attribute">height</span> <span class="hljs-number">80vh</span>
    <span class="hljs-attribute">border-radius</span> <span class="hljs-number">50px</span>
    <span class="hljs-attribute">flex</span> <span class="hljs-number">0.5</span>
    <span class="hljs-attribute">transition</span> <span class="hljs-attribute">all</span> <span class="hljs-number">700ms</span> ease-in
    
    &amp;<span class="hljs-selector-class">.active</span>
      <span class="hljs-attribute">flex</span> <span class="hljs-number">5</span>
      
    <span class="hljs-selector-tag">h3</span>
      <span class="hljs-attribute">opacity</span> <span class="hljs-number">0</span>
      <span class="hljs-attribute">transition</span> <span class="hljs-attribute">opacity</span> <span class="hljs-number">300ms</span> ease-in <span class="hljs-number">400ms</span>
      
      <span class="hljs-selector-class">.active</span> &amp;
        <span class="hljs-attribute">opacity</span> <span class="hljs-number">1</span>
</code></pre>
<p>Stylus的核心优势：</p>
<ul>
<li><strong>简洁语法</strong>：省略花括号、分号和冒号，使用缩进表示层级</li>
<li><strong>嵌套规则</strong>：直观反映HTML结构，提高代码可读性</li>
<li><strong>变量与混合</strong>：支持定义可重用样式片段</li>
<li><strong>自动前缀</strong>：自动添加浏览器厂商前缀，确保兼容性</li>
</ul>
<p>开发工作流：<code>stylus style.styl -o style.css -w</code>命令实现实时编译监听。</p>
<h3 data-id="heading-9">4. JavaScript交互逻辑</h3>
<h4 data-id="heading-10">4.1 DOM元素选择与类型检测</h4>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">panels</span> = document.querySelectorAll(<span class="hljs-string">'.panel'</span>)<span class="hljs-comment">;</span>

console.log(panels,
    panels<span class="hljs-section">[0]</span>,
    typeof panels<span class="hljs-section">[0]</span>, // "object"
    Object.prototype.toString.call(panels<span class="hljs-section">[0]</span>) // <span class="hljs-section">[object HTMLDivElement]</span>
)<span class="hljs-comment">;</span>
</code></pre>
<p>关键技术点：</p>
<ul>
<li><code>querySelectorAll</code>返回NodeList集合，类似数组但不是真正的数组</li>
<li>JavaScript数据类型检测：<code>typeof</code>对于DOM元素返回"object"</li>
<li>精确类型检测使用<code>Object.prototype.toString.call()</code>方法</li>
</ul>
<h4 data-id="heading-11">4.2 事件监听与类名切换</h4>
<pre><code class="hljs language-javascript" lang="javascript">panels.<span class="hljs-title function_">forEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">panel</span>) {
    panel.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">const</span> cur = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.active'</span>); 
        <span class="hljs-keyword">if</span>(cur) {
            cur.<span class="hljs-property">classList</span>.<span class="hljs-title function_">remove</span>(<span class="hljs-string">'active'</span>);
        }
        panel.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'active'</span>);
    });
});
</code></pre>
<p>事件处理逻辑：</p>
<ul>
<li>使用<code>forEach</code>遍历所有面板元素</li>
<li>为每个面板添加点击事件监听器</li>
<li>点击时先查找当前活跃元素并移除其<code>active</code>类</li>
<li>为当前点击的面板添加<code>active</code>类，触发CSS过渡动画</li>
</ul>
<h3 data-id="heading-12">5. 技术亮点与最佳实践</h3>
<h4 data-id="heading-13">5.1 分离关注点</h4>
<ul>
<li>HTML负责结构</li>
<li>CSS负责表现与动画</li>
<li>JavaScript负责行为与交互</li>
<li>三者清晰分离，提高代码可维护性</li>
</ul>
<h4 data-id="heading-14">5.2 性能优化</h4>
<ul>
<li>使用CSS过渡而非JavaScript动画，利用浏览器硬件加速</li>
<li>事件委托可考虑但当前实现已足够高效</li>
<li>背景图片使用合适的尺寸和压缩，减少加载时间</li>
</ul>
<h4 data-id="heading-15">5.3 用户体验设计</h4>
<ul>
<li>明显的鼠标指针变化(<code>cursor: pointer</code>)提示可交互性</li>
<li>平滑的过渡动画提供视觉反馈</li>
<li>响应式设计适应不同屏幕尺寸</li>
</ul>
<h3 data-id="heading-16">6. 扩展可能性</h3>
<p>此基础实现可以进一步扩展：</p>
<ul>
<li>添加键盘导航支持</li>
<li>实现自动轮播功能</li>
<li>添加触摸滑动支持移动设备</li>
<li>集成更复杂的动画效果</li>
<li>添加懒加载优化性能</li>
</ul>
<h3 data-id="heading-17">结论</h3>
<p>这个交互式图片面板展示了现代前端开发的核心技术融合：语义化HTML结构、CSS3过渡动画与弹性布局、JavaScript DOM操作与事件处理。通过合理的架构设计和关注点分离，创建了既美观又功能完善的用户界面。Stylus预处理器的使用进一步提高了开发效率，体现了现代前端工作流的优势。</p>
<p>此项目是学习前端基础技术的优秀范例，涵盖了从静态布局到动态交互的完整开发流程，为更复杂的前端应用开发奠定了坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从“SQL 工人”到“架构师”：我是如何用语义层干掉冗余宽表的]]></title>    <link>https://juejin.cn/post/7600755567486615604</link>    <guid>https://juejin.cn/post/7600755567486615604</guid>    <pubDate>2026-01-30T08:08:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600755567486615604" data-draft-id="7600728866757591092" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从“SQL 工人”到“架构师”：我是如何用语义层干掉冗余宽表的"/> <meta itemprop="keywords" content="数据分析"/> <meta itemprop="datePublished" content="2026-01-30T08:08:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="工程师9527"/> <meta itemprop="url" content="https://juejin.cn/user/4475441251110203"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从“SQL 工人”到“架构师”：我是如何用语义层干掉冗余宽表的
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4475441251110203/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    工程师9527
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T08:08:46.000Z" title="Fri Jan 30 2026 08:08:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这活儿干得越久，就越像西西弗斯推石头——业务需求（石头）源源不断，我们吭哧吭哧建宽表（推上山），然后需求一变，宽表作废（石头滚下来），周而复始。直到最近在一个指标平台项目里，接触到一种叫 “NoETL 语义编织” 的架构，才感觉这石头，好像终于能卸下来了。今天不吹牛，就聊聊这套东西背后的逻辑，以及它是不是真的能让我们摆脱“写不完的宽表 SQL”的宿命。</p>
<h2 data-id="heading-0">一、宽表困境：一个经典的数据工程“不可能三角”</h2>
<p>先别急着说“我们不一样”。扪心自问，下面这几个场景熟不熟悉：</p>
<ol>
<li>排期地狱：运营想加个“用户最近一次登录渠道”的维度来分析 GMV。你心里一算：得，上游用户表没这个字段，得找业务系统加；加了之后，DWD 层要改，然后 DWS 宽表要重建，测试、上线… 一个需求排期两周起步。</li>
<li>口径修罗场：“日活用户”这个指标，在A报表里是<code>UV</code>，在 B 报表里是<code>DAU</code>，在 C 看板里可能还排除了内部账号。业务方拿着三个数来对账，你查了一晚上 SQL，发现是三个不同的 ETL 任务算出来的，逻辑藏在各自的脚本注释里。</li>
<li>存储黑洞：某张核心交易宽表，为了应对各种维度组合，字段膨胀到 200+，其中<code>user_region</code>, <code>user_province</code>, <code>user_city</code>这种地理信息就存了七八套。每天全量更新一次，存储成本高得吓人，查询性能却越来越慢。</li>
</ol>
<p>这就是传统“数仓+宽表”模式的 “效率、质量、成本”不可能三角。你想快（效率），就得牺牲模型规范性（质量），或者堆机器（成本）。你想准（质量），开发周期就长（效率），冗余就多（成本）。最终结果就是：数据工程师成了“SQL 工人”，业务成了“数据乞丐”，整个数据价值链陷入低效内耗。</p>
<h2 data-id="heading-1">二、破局思路：从“物理堆砌”到“语义编织”</h2>
<p>问题的根子在于 “逻辑”和“物理”的强耦合。每个业务需求，都直接对应一张物理宽表。解耦的关键，就是在物理表之上，构建一个统一的逻辑语义层。这个层不存数据，只定义规则。</p>
<p>“语义编织”的核心四步法，下面我们拆开揉碎了看。</p>
<h3 data-id="heading-2">第一步：构建“虚拟业务事实网络”——告别烟囱式宽表</h3>
<p>这步是根基。传统做法是：<code>订单表</code> JOIN <code>用户表</code> JOIN <code>商品表</code> -&gt; 生成 <code>订单_用户_商品_宽表</code>。</p>
<p>语义层的做法是：在界面里声明，<code>订单表</code> 通过 <code>user_id</code> 关联 <code>用户表</code>，通过 <code>sku_id</code> 关联 <code>商品表</code>。系统在逻辑层面记住这些关联关系，但并不立即物理执行 JOIN。</p>
<p>你可以把它理解成一个 “虚拟的、无限宽的明细表” 。所有上层应用，无论是 BI、报表还是 API，都统一向这个虚拟层“要数据”，而不是各自去找不同的物理宽表。这就从源头上解决了“数据孤岛”和“口径不一”的问题。</p>
<p>技术细节：这背后是一个语义引擎（Semantic Engine）。它维护了一套元数据，包括表、字段、关联关系、业务含义注解。当收到查询请求时，引擎根据这些元数据，动态地“编织”出查询所需的逻辑数据模型。</p>
<h3 data-id="heading-3">第二步：声明式指标定义——SQL 工人下岗</h3>
<p>有了虚拟表，怎么算指标？传统是手写 SQL：<code>SELECT sum(amount) FROM 订单宽表 WHERE status='paid' AND dt='2025-01-01'</code>。</p>
<p>语义层把它抽象成四个可配置的要素：</p>
<ol>
<li>基础度量：<code>订单金额 (sum(amount))</code>。这里支持高级聚合，比如“月日均最大值”（先按天聚合，再取月内最大值），传统 SQL 写起来就挺啰嗦。</li>
<li>业务限定：<code>状态='已支付'</code>。更骚的是，它支持“指标结果筛选”，比如“上月交易金额 &gt;1000 的用户”，这本质是一个子查询，但在这里可以像搭积木一样配置。</li>
<li>统计周期：<code>2025-01-01</code>。支持自定义日历，比如“近 5 个交易日”，不用再写复杂的日期偏移函数。</li>
<li>衍生计算：比如用上面定义的“当日支付金额”和“昨日支付金额”，直接配置一个“日环比”计算。</li>
</ol>
<p>“定义即治理”：当你创建一个叫“GMV”的指标时，系统会全局检索同名指标，提示你是否复用或冲突。这就把口径管控从“人治”（靠文档和记忆）变成了“法治”（靠系统规则）。</p>
<h3 data-id="heading-4">第三步：智能物化加速——性能与成本的平衡术</h3>
<p>看到这里，有经验的兄弟肯定要拍桌子了：“你搞个虚拟层，每次查询都现场<code>JOIN</code>，<code>PB</code>级数据还不查崩了？”</p>
<p>问得好！这就是第三步的核心：按需、声明式的物化加速。它不是不物化，而是更聪明地物化。</p>
<ul>
<li>明细加速（预打宽）：对于<code>订单+用户</code>这种高频关联组合，可以声明物化一张实际的宽表。但这是平台根据你的配置自动完成的，你不用写<code>CREATE TABLE AS</code>的 SQL。</li>
<li>汇总加速（预聚合）：对于<code>按天、按省份的GMV</code>这种固定维度聚合，预计算好结果。</li>
<li>结果加速：完全固定的报表结果，直接缓存。</li>
</ul>
<p>最骚的操作是 “智能路由” 。当业务在 BI 里点选“GMV by 省份”时，语义引擎会解析这个请求，发现命中“汇总加速表”，就会自动将查询改写并路由到物化表上，而不是去<code>JOIN</code>明细。整个过程对查询者完全透明。</p>
<p>性能承诺：据他们材料说，能做到百亿数据下 P99&lt;5s。原理就是通过查询模式分析，把资源精准投入到最需要加速的地方，避免了我们以前“无脑建宽表”带来的存储浪费。</p>
<h3 data-id="heading-5">第四步：平滑落地——三步走替换，而非革命</h3>
<p>这套东西再好，也不可能让企业把现有数仓推倒重来。他们的策略很务实，叫 “资产演进三步走”：</p>
<ol>
<li>存量挂载：把现在正在用的、稳定的核心宽表，直接“挂载”到语义层，映射成一个逻辑实体。先让业务方在同一个平台看到统一的数据，建立信任。零开发成本。</li>
<li>增量原生：所有新需求，一律不走新建物理宽表的老路，直接基于 DWD 明细层，在语义层上配置实现。从源头遏制宽表膨胀。</li>
<li>存量替旧：随着时间推移，逐步把那些老旧、难维护的物理宽表下线，将其逻辑迁移到语义层。完成架构的平稳升级。</li>
</ol>
<h2 data-id="heading-6">三、思维转变：从“实现需求”到“定义资产”</h2>
<p>这套技术栈背后，其实是对数据工程师角色的重新定位。</p>
<p>以前我们是“SQL 实现者”：业务提需求，我们翻译成 SQL，跑出数据。我们的价值体现在“会不会写高效的 SQL”、“能不能按时交付”。</p>
<p>未来我们应该成为 “语义定义者”和“资产架构师”：</p>
<ul>
<li>核心工作不再是写<code>JOIN</code>和<code>GROUP BY</code>，而是和业务一起梳理：什么是“订单”？“支付成功”的状态枚举有哪些？“GMV”应该由哪些“基础度量”在什么“限定”下组成？</li>
<li>把这些业务语义通过声明式的方式，固化到语义层中，成为全公司公认的数据资产。</li>
<li>然后设计物化策略，在性能和成本间取得平衡。</li>
</ul>
<p>协作模式也会变成 “136 模式”：数据团队只定义 10% 最核心的原子指标；分析师可以基于这些原子指标，配置出 30% 的常用派生指标；剩下 60% 的临时性、探索性分析需求，业务可以直接在 BI 里，像搭积木一样，用已有的指标和维度自助完成。</p>
<h2 data-id="heading-7">四、一些冷静的思考</h2>
<p>这东西（以Aloudata CAN 为例）当然不是银弹。</p>
<ol>
<li>学习曲线：从写 SQL 到做配置，需要适应。尤其是梳理全公司统一语义，是件非常考验技术和沟通能力的事，比写 SQL 难多了。</li>
<li>性能上限：智能路由和物化策略再牛，终究要落库。面对千亿、PB 级实时扫描查询，它的加速引擎到底有多能打，需要实际业务压测才知道。“按需物化” 听起来美好，但如果业务查询模式极其分散且随机（即席查询），可能会退化成大量现场计算。</li>
<li>厂商绑定：深度使用后，你的业务语义模型就长在它平台里了。迁移成本会比较高。</li>
</ol>
<p>但无论如何，它指出了一个明确的方向：通过语义层解耦逻辑与物理，通过声明式配置替代重复编码，通过智能自动化降低运维负担。这绝对是数据工程领域一次有价值的范式演进。</p>
<p>目前看这套逻辑是自洽的，特别是“虚拟事实网络”和“智能物化”的设计，直击了宽表冗余和性能的痛点。但它到底是不是“真香”，还得看极端场景下的表现。有条件的团队，完全可以拿一个业务边界清晰、但宽表已经有点臃肿的模块去试点一下，压一压它的上限。毕竟，把我们从写宽表 SQL 的苦海里捞出来的任何尝试，都值得一个认真的技术评估。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[独立工作室Empty Vessel如何使用Xsens创建高质量角色动画]]></title>    <link>https://juejin.cn/post/7600967006892441609</link>    <guid>https://juejin.cn/post/7600967006892441609</guid>    <pubDate>2026-01-30T08:12:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600967006892441609" data-draft-id="7600990891206344731" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="独立工作室Empty Vessel如何使用Xsens创建高质量角色动画"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-30T08:12:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱迪斯通"/> <meta itemprop="url" content="https://juejin.cn/user/2672256188156042"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            独立工作室Empty Vessel如何使用Xsens创建高质量角色动画
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2672256188156042/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱迪斯通
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T08:12:06.000Z" title="Fri Jan 30 2026 08:12:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>对于许多独立工作室来说，角色动画在质量、时间和预算之间始终要做出妥协。Empty Vessel正在试图避免这种妥协。</p>
<p>Empty Vessel由经验丰富的AAA开发者创立并以小而敏捷的团队运营，该团队正在开发 DEFECT，这是一款赛博朋克风格的基于小队协作的沉浸式目标射击游戏，其中紧张感、现实主义和电影画面呈现起着核心作用。从开发的早期阶段，团队就知道，可信的人类动作对于实现这一体验至关重要。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7375d5605f354f489494502a6c0202b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix6L-q5pav6YCa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770365526&amp;x-signature=SEwyJO6V7PSJMBKsVOseJpa620M%3D" alt="ScreenShot_2026-01-30_122211_472.png" loading="lazy"/></p>
<p>为了在不使用传统动作捕捉流程的额外开销的情况下达到该质量水平， Empty Vessel在其动画工作流程中使用了Xsens惯性动作捕捉技术。</p>
<p><strong><strong>Empty Vessel********工作室</strong></strong></p>
<p>Empty Vessel工作室由来自Naughty Dog、id Software和BioWare等工作室的开发者组成。团队成员之前曾参与过包括神秘海域、最后生还者、毁灭战士和使命召唤等大型系列游戏的开发。</p>
<p>今天，工作室以约17人的精简团队运营。目标不是复制AAA级制作的规模，而是提供同样精致的体验，同时保持灵活性和效率。</p>
<p>DEFECT的背景设定在一个反乌托邦的赛博朋克未来，是一款基于小队的沉浸式目标射击游戏，四个队伍在同场比赛中竞争，每个队伍追求不同的目标。玩家可以扮演专制执行单位或强大的帮派派系，在充满人工智能控制的敌人和其他玩家的复杂环境中生存对抗。</p>
<p>游戏玩法强调战术紧张感。移动需要谨慎，沟通很重要，每一个角落都充满了不确定性。这使得多人竞技模式中也充满了PvE元素，迫使玩家不断评估风险并适应。</p>
<p>沉浸感是游戏的核心设计支柱。无需依赖传统的抬头显示器（HUD），DEFECT的菜单直接存在于世界中，以游戏中的PDA形式出现，角色与之进行物理互动。目标通过配音和环境线索展开，支持从游戏玩法中自然产生的电影体验，而不通过过场动画呈现。</p>
<p><strong>独立动画挑战</strong></p>
<p>对于像Empty Vessel这样的小型工作室来说，动画质量是该项目的压力点。逼真的真人动作需要花费大量时间来制作，而传统的动作捕捉管道通常会在捕捉和可用数据之间导致长时间的延迟。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cc2c10222404fb189f9e477f87c06c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix6L-q5pav6YCa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770365526&amp;x-signature=vPwX4Ink6UG5Ce81cbbXzL2Vi6k%3D" alt="ScreenShot_2026-01-30_122211_472.png" loading="lazy"/></p>
<p>Rico Flores是Empty Vessel工作室的动画总监，他职业生涯中一直在处理高端光学动作捕捉和更符合预算的设置。虽然光学捕捉能带来出色的结果，但其通常伴随着无法适应精简制作和拖长制作时间等问题。</p>
<p>“从拍摄日到实际获得可用数据，可能需要几周甚至几个月，”Flores解释道。“这使得迭代变得非常缓慢。”</p>
<p>由于游戏的即时性、节奏和紧张感在不断变化，速度成为了一个关键问题。团队需要一种快速原型设计、立即测试想法和优化表演的方法，同时该方法不会耗尽时间和预算。</p>
<p><strong><strong>为什么</strong></strong>Empty Vessel<strong><strong>选择了</strong></strong>Xsens****</p>
<p>Flores已经在之前的工作室项目中使用过Xsens，并亲眼目睹了它如何改变动画团队的工作方式。当Empty Vessel成立时，Xsens惯性动捕系统立即成为了项目角色动画制作的首选工具。</p>
<p>“在我体验了Xsens的强大功能并了解我能用它生产多少产品后，我就知道，对于我的下一家公司，我们将会从Xsens开始。”Flores说。</p>
<p>Xsens系统的投入使Empty Vessel 能够将动作捕捉完全内部化。与其安排外部拍摄并等待结果不同，团队可以在需要时随时捕捉动作，并立即看到结果。</p>
<p>“例如我今天可以拍摄一些东西，几小时后就能看到它，并且当天就能在我的角色上使用它，”Flores说。“如果某件事是优先事项，我可以去我的车库，捕获它，并将其加入游戏中。”</p>
<p>这种速度从根本上改变了人们对动画制作的期望。</p>
<p><strong>构建动画管道</strong></p>
<p>Xsens是DEFECT动画工作流程的核心。该系统用于捕捉各种角色动作，从移动和战斗动作再到环境互动和日常动作。</p>
<p>其中大部分工作是由Flores自己完成的，这让团队能够快速迭代，无需依赖于外部资源。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14ae171280d347359dc01e8e72adc345~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix6L-q5pav6YCa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770365526&amp;x-signature=vKeivD7GZAiGBzdzA8bAWpSVDhM%3D" alt="ScreenShot_2026-01-30_122102_084.png" loading="lazy"/></p>
<p>“如果我们想测试什么，我会迅速捕捉它，把它放进游戏中，不需要复杂的清理工作，然后看看感觉如何，”他解释道。“如果行得通，我就把它打磨好。如果不行，我们就继续下一个。这可能只花费几小时的工作时间。”</p>
<p>这种方法让Empty Vessel可以自由实验。动画不再成为阻碍设计决策的瓶颈。相反，它们成为创意过程的一部分，支持快速原型制作和改进。</p>
<p>对于更专业的表演，例如复杂的特技或高度训练的战斗动作，团队偶尔会通过光学动作捕捉来补充其流程。</p>
<p>“走路、与物体互动、拔出武器、使用杠杆。所有这些都可以通过Xsens快速完成，而不需要完整的工作室拍摄。”</p>
<p><strong><strong>干净的<strong><strong><strong><strong>数据和更快的</strong></strong></strong></strong>后期制作</strong></strong></p>
<p>除了速度，数据质量是团队采用Xsens的关键因素。动画清理中最耗时的步骤之一是去除运动数据的抖动和噪音。</p>
<p>“这一直是最具挑战性的部分之一，”Flores说。“使用Xsens捕获到的数据很干净。我们很少需要处理抖动，因此我可以专注于优化性能，而不是修正曲线。”</p>
<p>在该工作流程中捕获的动作几乎可以立即使用，这大大减少了在进一步优化和最终确定制作计划之前所需的清理工作。</p>
<p><strong><strong>展望未来</strong></strong></p>
<p>随着DEFECT的持续开发，Xsens仍然是Empty Vessel生产流程中的核心部分。这种快速捕捉运动、自由迭代并保持高质量的能力，使团队能够不断优化体验并快速发展。</p>
<p>对于那些希望在没有AAA级预算的情况下也提供逼真角色动作和电影效果的独立工作室来说， Empty Vessel的案例展示了Xsens在独立工作室工作流程中的应用方向。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React-深度解码：React Fiber架构]]></title>    <link>https://juejin.cn/post/7600752623068364810</link>    <guid>https://juejin.cn/post/7600752623068364810</guid>    <pubDate>2026-01-30T08:14:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600752623068364810" data-draft-id="7600705962249289737" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React-深度解码：React Fiber架构"/> <meta itemprop="keywords" content="前端,面试,React.js"/> <meta itemprop="datePublished" content="2026-01-30T08:14:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="发现一只大呆瓜"/> <meta itemprop="url" content="https://juejin.cn/user/180747382561607"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React-深度解码：React Fiber架构
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180747382561607/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    发现一只大呆瓜
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T08:14:12.000Z" title="Fri Jan 30 2026 08:14:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>在 React 16 之前，Stack Reconciler 的同步递归更新机制让大树渲染成了“性能黑洞”。<strong>Fiber 架构</strong> 的引入，彻底改变了 React 的底层游戏规则，将“不可中断的同步更新”进化为“异步、可中断、带优先级的并发更新”。</p>
<h2 data-id="heading-1">一、 诞生背景：为什么要重构？</h2>
<ul>
<li>
<p>React16之前在实现虚拟dom对比渲染的时候，采用递归的方式遍历组件树，这个过程是同步的，一旦开始就无法中断，如果遇到的组件树很大的话，js就会长时间占用主线程，导致页面卡顿、用户输入无反应。</p>
</li>
<li>
<p>Fiber架构为解决以上问题，设计出了一个<strong>可中断以及任务优先级调度的架构</strong>，让React能够根据不同任务设定不同的优先级，让高优先级任务先执行，低优先级任务后执</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-2">二、 Fiber核心概念：Fiber 节点</h2>
<p>它是实现渲染任务可中断、可恢复、可重新执行的基础，是 React 的工作单元。它本质上是一个js对象，包含了组件、链表、更新、副作用等相关的属性信息</p>
<h3 data-id="heading-3">1. FiberNode 结构拆解</h3>
<p>Fiber 节点通过指针构建了一棵“虚拟链表树”：</p>
<ul>
<li><strong><code>child</code></strong>：指向第一个子节点。</li>
<li><strong><code>sibling</code></strong>：指向下一个兄弟节点。</li>
<li><strong><code>return</code></strong>：指向父节点。</li>
</ul>
<p>这种链表结构是实现<strong>可中断渲染</strong>的物理基础——我们可以随时记录当前处理到哪个节点，中断后再回来。</p>
<p><strong>Fiber节点具体详细结构如下：</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">FiberNode</span>(<span class="hljs-params">tag: WorkTag, pendingProps: mixed, key: <span class="hljs-literal">null</span> | <span class="hljs-built_in">string</span>, mode: TypeOfMode</span>) {
  <span class="hljs-comment">// ===================== 组件标识 =====================</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">tag</span> = tag; <span class="hljs-comment">// 组件类型</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">key</span> = key; <span class="hljs-comment">// 用于diff算法的key</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">elementType</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 原始元素类型</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">type</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 组件函数/类 或 DOM标签名</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">stateNode</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 组件实例 或 DOM节点</span>

  <span class="hljs-comment">// ===================== 链表指针 =====================</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">return</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 父节点</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">child</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 第一个子节点</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">sibling</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 兄弟节点</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// 在兄弟节点中的索引</span>

  <span class="hljs-comment">// ===================== 更新相关 =====================</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">ref</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// ref引用</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingProps</span> = pendingProps; <span class="hljs-comment">// 新的props（待处理）</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">memoizedProps</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 上一次渲染的props</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">updateQueue</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 更新队列</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">memoizedState</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 上一次渲染的state</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">dependencies</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 依赖项（context, events）</span>

  <span class="hljs-comment">// ===================== 模式相关 =====================</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">mode</span> = mode; <span class="hljs-comment">// 渲染模式（ConcurrentMode等）</span>

  <span class="hljs-comment">// ===================== 副作用相关 =====================</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">flags</span> = <span class="hljs-title class_">NoFlags</span>; <span class="hljs-comment">// 当前节点的副作用标记</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">subtreeFlags</span> = <span class="hljs-title class_">NoFlags</span>; <span class="hljs-comment">// 子树的副作用标记</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">deletions</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 要删除的子节点数组</span>

  <span class="hljs-comment">// ===================== 副作用链表 =====================</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">nextEffect</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 下一个有副作用的节点</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">firstEffect</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 第一个有副作用的子节点</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">lastEffect</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 最后一个有副作用的子节点</span>

  <span class="hljs-comment">// ===================== 优先级调度 =====================</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">lanes</span> = <span class="hljs-title class_">NoLanes</span>; <span class="hljs-comment">// 当前节点的优先级车道</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">childLanes</span> = <span class="hljs-title class_">NoLanes</span>; <span class="hljs-comment">// 子节点的优先级车道</span>

  <span class="hljs-comment">// ===================== 双缓存相关 =====================</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">alternate</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 指向另一棵树上的对应节点</span>

  <span class="hljs-comment">// ===================== 开发调试 =====================</span>
  <span class="hljs-keyword">if</span> (__DEV__) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_debugID</span> = debugCounter++;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_debugSource</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_debugOwner</span> = <span class="hljs-literal">null</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_debugNeedsRemount</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_debugHookTypes</span> = <span class="hljs-literal">null</span>;
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-4">三、 Fiber核心概念：双缓存机制</h2>
<p><strong>双缓存机制</strong> 是React 保持 UI 连贯性的核心，也是Fiber架构实现可中断渲染的基础，它在内存中同时维护两棵Fiber树：当前屏幕显示的<code>current</code>树和正在构建的<code>workInProgress</code>树，两棵树通过每个Fiber节点上的<code>alternate</code>属性相互连接，构成双缓存的基础。</p>
<ul>
<li><strong>Current Tree</strong>：对应当前屏幕上显示的真实 DOM。</li>
<li><strong>workInProgress Tree</strong>：正在内存中构建的树。所有的 Diff 和计算都在这里进行。</li>
<li><strong>指针切换</strong>：一旦 <code>workInProgress</code> 树构建并提交完成，React 只需要将 <code>root.current</code> 指针指向它，即可瞬间完成 UI 更新。</li>
</ul>
<hr/>
<h2 data-id="heading-5">四、Fiber核心概念：双阶段渲染</h2>
<p>为了平衡性能与响应速度，React 将渲染划分为两个性格截然不同的阶段：</p>
<h3 data-id="heading-6">阶段 1：协调阶段 (Reconciliation)</h3>
<ul>
<li><strong>任务</strong>：对比新旧 Fiber树，构建出一个要渲染的workInProgress树，并给需要更新的节点打上 <code>flags</code>副作用标签（如移动, 更新）。</li>
<li><strong>特点</strong>：<strong>可中断</strong>。可中断的实现则与fiber架构中的优先级调度与时间片切片有关。</li>
</ul>
<h3 data-id="heading-7">阶段 2：提交阶段 (Commit)</h3>
<ul>
<li><strong>任务</strong>：将diff算法构建出的树渲染到真实Dom上。</li>
<li><strong>特点</strong>：<strong>不可中断</strong>。必须一次性完成，防止 UI 出现中间状态（半截更新）。</li>
</ul>
<hr/>
<h2 data-id="heading-8">五、 Fiber核心概念：副作用标记与执行</h2>
<p><strong>副作用是指Dom的增删改、ref的绑定与解绑、相关hooks调用</strong>。</p>
<ul>
<li>
<p>在协调阶段的diff算法对比过程中，react会为需要新增、删除、移动的节点打上副作用标签并连接成链表。</p>
</li>
<li>
<p>这样在提交阶段，React 就不需遍历整棵 Fiber 树，<strong>而是直接遍历这个副作用链表</strong>，仅对真正需要更新的节点进行操作，这大大减少了需要处理的节点数量，显著提升了更新效率</p>
</li>
</ul>
<h2 data-id="heading-9">六、 Fiber核心概念：优先级调度与 Lanes 模型</h2>
<p>React 18之后使用 <strong>Lanes（车道模型）</strong> 来精细化管理任务优先级与执行顺序，并通过Scheduler调度器实现任务的调度</p>
<ul>
<li>
<p><strong>调度器 (Scheduler)</strong> ：独立包，主要负责不同任务的执行顺序，确保浏览器能及时渲染和响应用户。</p>
</li>
<li>
<p><strong>优先级调度实现</strong>：
Lanes车道模型使用 31 位整数表示优先级通道，react在进行更新时，车道模型会根据事件类型分配不同优先级的<code>lane</code>，在同一渲染批次中，车道模型会将相同优先级的多个更新共享在同一个车道内，并根据不同<code>lane</code>进行优先级排序，执行当前最高优先级的车道集合后清理这些车道。</p>
</li>
<li>
<p><strong>车道分配</strong>：</p>
<ul>
<li><strong>同步车道</strong>：用户输入、离散交互（最高）。</li>
<li><strong>连续车道</strong>：滚动、拖拽。</li>
<li><strong>默认车道</strong>：数据请求、<code>setState</code>。</li>
<li><strong>空闲车道</strong>：日志上报（最低）。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-10">七、 Fiber核心概念：时间片切片</h2>
<h3 data-id="heading-11">1、时间片分片整体概览</h3>
<p>React通过时间片分片将渲染任务拆分成多个小任务，并给这些任务预设一个5毫秒左右的时间预算。每次执行完一个小任务，都会检查当前时间片是否用完、以及是否有更紧急的任务需要处理（用户输入、点击）。如果时间片用完或者出现更高优先级任务，react就会暂停当前任务将主线程控制权交给浏览器，去处理更高优先级任务，等浏览器空闲再从中断的地方继续执行工作。</p>
<h3 data-id="heading-12">2、时间片分片设计目标</h3>
<p>React通过时间片切片，可让浏览器在执行小任务间隙有机会去响应用户输入、动画渲染，这避免了主线程卡顿提升了响应速，优化了用户体验。</p>
<h3 data-id="heading-13">3、时间片分片实现原理</h3>
<h4 data-id="heading-14">3.1 任务分割</h4>
<p>对于任务分割的原理是基于Fiber节点中的链表结构，将大任务拆解为以“节点”为单位的小任务。</p>
<blockquote>
<p>在react中每个组件对应一个Fiber节点，节点中包含child（第一个子节点）、sibing（下一个兄弟节点）、return（父节点）。这种结构可以灵活实现组件的遍历、中断以及回溯</p>
</blockquote>
<h4 data-id="heading-15">3.2任务的中断与恢复</h4>
<p>对于任务的中断与重新执行则是通过工作循环函数<code>workLoop</code>与中断检查函数<code>shouldYield</code>实现。</p>
<ul>
<li>
<p><strong><code>workLoop</code></strong>：它会调用<code>performUnitOfWork</code>函数循环地处理Fiber节点，并对比新旧节点的<code>props、state</code>。而<code>workLoop</code>可根据调用时机分为<code>workLoopSync</code>同步工作循环，以及<code>workLoopConcurrent</code>并发工作循环。</p>
<ul>
<li>
<p><code>workLoopSync</code>：它是不可中断的，不包含<code>shouldYield</code>函数会执行到底，主要在组件的首次渲染以及<code>flushSync</code> 包裹的更新中等场景中调用。</p>
</li>
<li>
<p><code>workLoopConcurrent</code>调用场景：它是可中断的，受<code>shouldYield</code>函数控制，主要在<code>setState</code>、<code>Suspense </code>加载、<code>Transition </code>更新等场景中调用。</p>
</li>
</ul>
</li>
<li>
<p><strong><code>shouldYield</code></strong>：它是一个<strong>中断检查函数</strong>，用于检查当前时间片是否耗尽以及是否有更高优先级的任务执行，如果有的话则会将主线程控制权交还给浏览器，以保证高优先级任务（如用户输入、动画）能及时响应。</p>
<ul>
<li><code>shouldYield</code>在<code>workLoopConcurrent</code>调用，当<code>shouldYield()</code>返回<code>true</code>（时间片用完或检测到高优先级输入），<code>workLoop</code>会立刻<strong>跳出循环</strong>，渲染任务被中断</li>
</ul>
</li>
<li>
<p>任务中断时React会保存一个指向下一个待处理Fiber节点的指针（<code>workInProgress</code>）以及当前的Fiber遍历状态（深度优先遍历的位置）。当浏览器空闲时，调度器通过<code>MessageChannel</code>会重新触发工作循环，从上次中断的节点继续执行，直到整个渲染任务完成</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【重构笔记】Vue Router 路由守卫：拒绝“隐式依赖”，拥抱“集中编排”]]></title>    <link>https://juejin.cn/post/7600967006892474377</link>    <guid>https://juejin.cn/post/7600967006892474377</guid>    <pubDate>2026-01-30T08:17:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600967006892474377" data-draft-id="7600692485947441161" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【重构笔记】Vue Router 路由守卫：拒绝“隐式依赖”，拥抱“集中编排”"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-30T08:17:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="user8615818578154"/> <meta itemprop="url" content="https://juejin.cn/user/3549647826599133"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【重构笔记】Vue Router 路由守卫：拒绝“隐式依赖”，拥抱“集中编排”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3549647826599133/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    user8615818578154
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T08:17:19.000Z" title="Fri Jan 30 2026 08:17:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>在中大型 Vue 项目中，全局路由守卫（Router Guards）往往是逻辑堆积的重灾区：权限校验、进度条控制（NProgress）、动态 Title 修改、埋点上报等逻辑杂糅在一起。</p>
<p>许多项目的做法是将这些逻辑分散在不同的文件中，然后在 <code>main.js</code> 中直接引入。这种做法虽然实现了物理文件的分离，却带来了严重的隐式依赖问题。</p>
<p>本文将介绍如何通过集中编排模式，重构路由拦截机制，提升系统的可维护性与稳定性。</p>
<h3 data-id="heading-1">一、痛点：隐式依赖带来的“竞态风险”</h3>
<p>看看你的 <code>main.js</code> 是否长这样：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// main.js</span>
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>

<span class="hljs-comment">// 这里的引入顺序决定了执行顺序</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./permission'</span>  <span class="hljs-comment">// 权限控制</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./nprogress'</span>   <span class="hljs-comment">// 进度条</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./analytics'</span>   <span class="hljs-comment">// 埋点</span>
</code></pre>
<p>而在 <code>permission.js</code> 内部，代码通常是直接操作 router 实例：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// permission.js</span>
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>
router.<span class="hljs-title function_">beforeEach</span>(<span class="hljs-function">(<span class="hljs-params">to, <span class="hljs-keyword">from</span>, next</span>) =&gt;</span> {
  <span class="hljs-comment">// ... 业务逻辑</span>
})
</code></pre>
<p><strong>这种模式存在的问题：</strong></p>
<ol>
<li><strong>执行顺序不可见</strong>：守卫的执行顺序完全依赖于 <code>import</code> 语句的物理顺序。如果新人不小心调整了引入顺序（例如 IDE 自动格式化），可能导致“先渲染页面后校验权限”的严重 Bug。</li>
<li><strong>耦合度高</strong>：每个模块都强依赖全局 <code>router</code> 实例，难以进行单元测试。</li>
<li><strong>调试困难</strong>：由于逻辑分散，想要理清一个完整的路由跳转链路（Flow），需要在多个文件间反复横跳。</li>
</ol>
<h3 data-id="heading-2">二、解决方案：集中式编排设计</h3>
<p>重构的核心思想是：<strong>将“业务逻辑实现”与“执行流程注册”解耦。</strong></p>
<p>我们需要建立一个<strong>路由守卫编排中心</strong>，显式地管理所有守卫的生命周期。</p>
<h4 data-id="heading-3">1. 拆分逻辑为纯函数</h4>
<p>将具体的业务逻辑剥离为独立的函数，不再直接依赖全局 router 实例。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// src/guards/nprogress.ts</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">NProgress</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'nprogress'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NavigationGuardNext</span>, <span class="hljs-title class_">RouteLocationNormalized</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">startProgress</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title class_">NProgress</span>.<span class="hljs-title function_">start</span>()
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">stopProgress</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title class_">NProgress</span>.<span class="hljs-title function_">done</span>()
}
</code></pre>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// src/guards/permission.ts</span>
<span class="hljs-keyword">import</span> store <span class="hljs-keyword">from</span> <span class="hljs-string">'@/store'</span>

<span class="hljs-comment">// 这是一个纯粹的逻辑函数，只负责判断</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">checkPermission</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">
  to: RouteLocationNormalized,
  <span class="hljs-keyword">from</span>: RouteLocationNormalized,
  next: NavigationGuardNext
</span>) =&gt; {
  <span class="hljs-keyword">const</span> hasToken = store.<span class="hljs-property">getters</span>.<span class="hljs-property">token</span>
  <span class="hljs-keyword">if</span> (hasToken) {
    <span class="hljs-comment">// ... 校验逻辑</span>
    <span class="hljs-title function_">next</span>()
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-title function_">next</span>(<span class="hljs-string">'/login'</span>)
  }
}
</code></pre>
<h4 data-id="heading-4">2. 建立统一编排入口</h4>
<p>创建一个 <code>index.ts</code> 作为“总管”，负责按既定顺序注册这些守卫。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// src/guards/index.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Router</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>
<span class="hljs-keyword">import</span> { startProgress, stopProgress } <span class="hljs-keyword">from</span> <span class="hljs-string">'./nprogress'</span>
<span class="hljs-keyword">import</span> { checkPermission } <span class="hljs-keyword">from</span> <span class="hljs-string">'./permission'</span>
<span class="hljs-keyword">import</span> { updateTitle } <span class="hljs-keyword">from</span> <span class="hljs-string">'./title'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">setupGuards</span>(<span class="hljs-params">router: Router</span>) {
  <span class="hljs-comment">// 1. HTTP 拦截与进度条开始（最先执行）</span>
  router.<span class="hljs-title function_">beforeEach</span>(startProgress)

  <span class="hljs-comment">// 2. 核心权限校验（中间执行，决定去留）</span>
  router.<span class="hljs-title function_">beforeEach</span>(checkPermission)

  <span class="hljs-comment">// 3. UI 状态更新（最后执行）</span>
  router.<span class="hljs-title function_">beforeEach</span>(updateTitle)

  <span class="hljs-comment">// 4. 后置钩子</span>
  router.<span class="hljs-title function_">afterEach</span>(stopProgress)
}
</code></pre>
<h4 data-id="heading-5">3. 在入口文件中调用</h4>
<p>在 <code>main.ts</code> 中，我们只需要调用这个 setup 函数。</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-comment">// main.ts</span>
<span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>
<span class="hljs-keyword">import</span> { setupGuards } <span class="hljs-keyword">from</span> <span class="hljs-string">'./guards'</span>

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)

<span class="hljs-comment">// 显式初始化守卫</span>
<span class="hljs-title function_">setupGuards</span>(router)

app.<span class="hljs-title function_">use</span>(router).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<h3 data-id="heading-6">三、重构收益</h3>
<p>通过这次简单的架构调整，我们获得了三个关键收益：</p>
<ol>
<li>
<p><strong>显式编排（Explicit Orchestration）</strong> 打开 <code>src/guards/index.ts</code>，所有人都能一眼看清路由跳转的完整生命周期。执行顺序由代码逻辑决定，不再依赖脆弱的 <code>import</code> 顺序。</p>
</li>
<li>
<p><strong>关注点分离（Separation of Concerns）</strong></p>
<ul>
<li><code>permission.ts</code> 只关注有没有权限，不需要知道进度条什么时候关。</li>
<li><code>setupGuards</code> 只关注流程顺序，不需要知道具体的校验细节。</li>
<li>代码结构符合单一职责原则（SRP）。</li>
</ul>
</li>
<li>
<p><strong>热插拔能力（Pluggable）</strong> 如果需要在某个特殊版本去掉“埋点功能”，只需在 <code>setupGuards</code> 中注释掉一行代码即可，无需侵入修改具体的业务文件，极大降低了回归测试的风险。</p>
</li>
</ol>
<h3 data-id="heading-7">总结</h3>
<p>架构不仅仅是分层，更是对<strong>依赖关系</strong>的治理。</p>
<p>将分散的 <code>router.beforeEach</code> 这种“隐式依赖”重构为集中管理的“显式编排”，虽然代码量没有减少，但显著提升了工程的<strong>可预测性</strong>和<strong>可维护性</strong>。这在多人协作的中大型前端项目中，是一项投入产出比极高的优化。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Jetpack Compose 从入门到精通（四）：Material Design 3 组件与主题系统]]></title>    <link>https://juejin.cn/post/7600868443832090643</link>    <guid>https://juejin.cn/post/7600868443832090643</guid>    <pubDate>2026-01-30T08:55:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600868443832090643" data-draft-id="7600868443832074259" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Jetpack Compose 从入门到精通（四）：Material Design 3 组件与主题系统"/> <meta itemprop="keywords" content="JetBrains,Android Jetpack,Android"/> <meta itemprop="datePublished" content="2026-01-30T08:55:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="邹阿涛涛涛涛涛涛涛涛"/> <meta itemprop="url" content="https://juejin.cn/user/3808364009106839"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Jetpack Compose 从入门到精通（四）：Material Design 3 组件与主题系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808364009106839/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    邹阿涛涛涛涛涛涛涛涛
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T08:55:09.000Z" title="Fri Jan 30 2026 08:55:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>深入理解 Material Design 3 的设计哲学，掌握主题定制、深色模式、动态取色的完整实现方案。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">前言</h2>
<p>在前三篇中，我们掌握了 Compose 的核心机制。现在让我们进入实战阶段——使用 Material Design 3 构建美观、一致的界面。</p>
<p>Material Design 3 不仅是组件库，更是一套完整的设计系统。理解它的设计哲学，才能做出优雅的应用。</p>
<p>本篇文章将深入讲解：</p>
<ul>
<li>Material Design 3 的设计哲学与核心概念</li>
<li>MaterialTheme 的源码实现与定制方法</li>
<li>ColorScheme、Typography、Shape 三大系统</li>
<li>深色模式的完整实现方案</li>
<li>动态取色（Dynamic Color）的原理与应用</li>
<li>自定义组件的设计思路</li>
</ul>
<hr/>
<h2 data-id="heading-1">一、Material Design 3 设计哲学</h2>
<h3 data-id="heading-2">1.1 什么是 Material Design？</h3>
<p><strong>Material Design</strong> 是 Google 推出的设计系统，它基于物理世界的隐喻：</p>
<ul>
<li><strong>纸张（Paper）</strong>：界面元素像纸张一样有厚度、有阴影</li>
<li><strong>墨水（Ink）</strong>：内容像墨水一样印在纸张上</li>
<li><strong>光线（Light）</strong>：阴影反映光源位置，创造层次感</li>
</ul>
<h3 data-id="heading-3">1.2 Material Design 3 的核心变化</h3>
<p>相比 Material Design 2，MD3 有三大核心变化：</p>

























<table><thead><tr><th>特性</th><th>MD2</th><th>MD3</th></tr></thead><tbody><tr><td><strong>颜色系统</strong></td><td>主色/辅色/强调色</td><td>基于色度的动态配色</td></tr><tr><td><strong>组件风格</strong></td><td>圆角较小</td><td>更大的圆角，更柔和</td></tr><tr><td><strong>个性化</strong></td><td>固定配色</td><td>支持动态取色</td></tr></tbody></table>
<h3 data-id="heading-4">1.3 MD3 的设计原则</h3>
<h4 data-id="heading-5">1.3.1 个性化（Personalization）</h4>
<p>MD3 强调应用的个性化表达，通过颜色、字体、形状传达品牌特性。</p>
<h4 data-id="heading-6">1.3.2 适应性（Adaptability）</h4>
<p>界面应适应不同的设备、环境和用户需求：</p>
<ul>
<li>响应式布局</li>
<li>深色模式</li>
<li>动态取色</li>
</ul>
<h4 data-id="heading-7">1.3.3 层次结构（Hierarchy）</h4>
<p>通过颜色、阴影、大小区分信息层级：</p>
<ul>
<li>主色用于主要操作</li>
<li>表面色用于背景</li>
<li>强调色用于高亮</li>
</ul>
<hr/>
<h2 data-id="heading-8">二、MaterialTheme 源码解析</h2>
<h3 data-id="heading-9">2.1 MaterialTheme 的结构</h3>
<p>MaterialTheme 是 MD3 的主题容器，它通过 CompositionLocal 向下传递主题配置：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MaterialTheme</span><span class="hljs-params">(
    colorScheme: <span class="hljs-type">ColorScheme</span> = MaterialTheme.colorScheme,
    typography: <span class="hljs-type">Typography</span> = MaterialTheme.typography,
    shapes: <span class="hljs-type">Shapes</span> = MaterialTheme.shapes,
    content: @<span class="hljs-type">Composable</span> () -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    <span class="hljs-keyword">val</span> rememberedColorScheme = remember { colorScheme }
    <span class="hljs-keyword">val</span> rememberedTypography = remember { typography }
    <span class="hljs-keyword">val</span> rememberedShapes = remember { shapes }
    
    CompositionLocalProvider(
        LocalColorScheme provides rememberedColorScheme,
        LocalTypography provides rememberedTypography,
        LocalShapes provides rememberedShapes
    ) {
        content()
    }
}
</code></pre>
<h3 data-id="heading-10">2.2 MaterialTheme 的组成</h3>
<pre><code class="hljs language-bash" lang="bash">┌─────────────────────────────────────────────────────────────────┐
│                     MaterialTheme 结构                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  ColorScheme（颜色系统）                                  │   │
│  │  ├── primary/primaryContainer                            │   │
│  │  ├── secondary/secondaryContainer                        │   │
│  │  ├── surface/surfaceVariant                              │   │
│  │  ├── background                                          │   │
│  │  ├── error/errorContainer                                │   │
│  │  └── onPrimary/onSecondary/onSurface...                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              ↓                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Typography（字体系统）                                   │   │
│  │  ├── displayLarge/displayMedium/displaySmall             │   │
│  │  ├── headlineLarge/headlineMedium/headlineSmall          │   │
│  │  ├── titleLarge/titleMedium/titleSmall                   │   │
│  │  ├── bodyLarge/bodyMedium/bodySmall                      │   │
│  │  └── labelLarge/labelMedium/labelSmall                   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              ↓                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Shapes（形状系统）                                       │   │
│  │  ├── extraSmall/Small/Medium/Large/extraLarge            │   │
│  │  └── 用于 Card、Button、Dialog 等组件                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-11">2.3 访问 MaterialTheme 的值</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MyComponent</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 获取颜色</span>
    <span class="hljs-keyword">val</span> colorScheme = MaterialTheme.colorScheme
    <span class="hljs-keyword">val</span> primaryColor = colorScheme.primary
    <span class="hljs-keyword">val</span> surfaceColor = colorScheme.surface
    
    <span class="hljs-comment">// 获取字体</span>
    <span class="hljs-keyword">val</span> typography = MaterialTheme.typography
    <span class="hljs-keyword">val</span> titleStyle = typography.titleLarge
    <span class="hljs-keyword">val</span> bodyStyle = typography.bodyMedium
    
    <span class="hljs-comment">// 获取形状</span>
    <span class="hljs-keyword">val</span> shapes = MaterialTheme.shapes
    <span class="hljs-keyword">val</span> cardShape = shapes.medium
}
</code></pre>
<hr/>
<h2 data-id="heading-12">三、ColorScheme 颜色系统深度解析</h2>
<h3 data-id="heading-13">3.1 为什么需要 ColorScheme？</h3>
<p>传统的颜色管理存在以下问题：</p>
<ul>
<li>颜色分散在代码各处，难以维护</li>
<li>深色模式需要手动替换每个颜色</li>
<li>品牌色变化时需要全局搜索替换</li>
</ul>
<p><strong>ColorScheme 的解决方案</strong>：</p>
<ul>
<li>集中定义所有颜色</li>
<li>语义化命名（primary、surface、error 等）</li>
<li>自动支持深色模式</li>
</ul>
<h3 data-id="heading-14">3.2 ColorScheme 的颜色角色</h3>
<p>MD3 定义了 28 个颜色角色，每个都有明确的语义：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                    <span class="hljs-string">ColorScheme</span> <span class="hljs-string">颜色角色</span>                         <span class="hljs-string">│</span>
<span class="hljs-string">├─────────────────────────────────────────────────────────────────┤</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">主要颜色（Primary）-</span> <span class="hljs-string">主要操作、突出显示</span>                         <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">primary:</span> <span class="hljs-string">主色（按钮、选中状态）</span>                            <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">onPrimary:</span> <span class="hljs-string">主色上的文字/图标</span>                               <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">primaryContainer:</span> <span class="hljs-string">主色容器（选中项背景）</span>                   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-attr">onPrimaryContainer:</span> <span class="hljs-string">主色容器上的文字</span>                       <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">次要颜色（Secondary）-</span> <span class="hljs-string">次要操作、筛选器</span>                         <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">secondary:</span> <span class="hljs-string">次要色</span>                                          <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">onSecondary:</span> <span class="hljs-string">次要色上的文字</span>                                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">secondaryContainer:</span> <span class="hljs-string">次要色容器</span>                             <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-attr">onSecondaryContainer:</span> <span class="hljs-string">次要色容器上的文字</span>                   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">第三颜色（Tertiary）-</span> <span class="hljs-string">对比强调</span>                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">tertiary:</span> <span class="hljs-string">第三色</span>                                           <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">onTertiary:</span> <span class="hljs-string">第三色上的文字</span>                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">tertiaryContainer:</span> <span class="hljs-string">第三色容器</span>                              <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-attr">onTertiaryContainer:</span> <span class="hljs-string">第三色容器上的文字</span>                    <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">表面颜色（Surface）-</span> <span class="hljs-string">背景、卡片</span>                                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">surface:</span> <span class="hljs-string">最底层背景</span>                                        <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">onSurface:</span> <span class="hljs-string">表面上的文字</span>                                    <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">surfaceVariant:</span> <span class="hljs-string">变体表面（区分层次）</span>                       <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">onSurfaceVariant:</span> <span class="hljs-string">变体表面上的文字</span>                         <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">surfaceTint:</span> <span class="hljs-string">表面色调（用于</span> <span class="hljs-string">elevation）</span>                    <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-attr">inverseSurface/inverseOnSurface:</span> <span class="hljs-string">反色表面</span>                  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">背景颜色（Background）-</span> <span class="hljs-string">页面背景</span>                               <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">background:</span> <span class="hljs-string">页面背景</span>                                       <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-attr">onBackground:</span> <span class="hljs-string">背景上的文字</span>                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">错误颜色（Error）-</span> <span class="hljs-string">错误状态</span>                                    <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">error:</span> <span class="hljs-string">错误色</span>                                              <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">onError:</span> <span class="hljs-string">错误色上的文字</span>                                    <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">errorContainer:</span> <span class="hljs-string">错误色容器</span>                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-attr">onErrorContainer:</span> <span class="hljs-string">错误色容器上的文字</span>                       <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">轮廓颜色（Outline）-</span> <span class="hljs-string">边框、分割线</span>                              <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">outline:</span> <span class="hljs-string">轮廓色</span>                                            <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-attr">outlineVariant:</span> <span class="hljs-string">变体轮廓色</span>                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">阴影颜色（Scrim/Shadow）</span>                                       <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">scrim:</span> <span class="hljs-string">遮罩层颜色</span>                                          <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-attr">shadow:</span> <span class="hljs-string">阴影颜色</span>                                           <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>
</code></pre>
<h3 data-id="heading-15">3.3 颜色角色的使用规范</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 正确使用颜色角色</span>
Button(
    onClick = { },
    colors = ButtonDefaults.buttonColors(
        containerColor = MaterialTheme.colorScheme.primary,
        contentColor = MaterialTheme.colorScheme.onPrimary
    )
) {
    Text(<span class="hljs-string">"确认"</span>)
}

Card(
    colors = CardDefaults.cardColors(
        containerColor = MaterialTheme.colorScheme.surfaceVariant
    )
) {
    Text(
        text = <span class="hljs-string">"内容"</span>,
        color = MaterialTheme.colorScheme.onSurfaceVariant
    )
}

<span class="hljs-comment">// ❌ 错误：硬编码颜色</span>
Button(
    onClick = { },
    colors = ButtonDefaults.buttonColors(
        containerColor = Color(<span class="hljs-number">0xFF6750A4</span>)  <span class="hljs-comment">// 硬编码</span>
    )
) {
    Text(<span class="hljs-string">"确认"</span>)
}
</code></pre>
<h3 data-id="heading-16">3.4 创建自定义 ColorScheme</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 浅色主题</span>
<span class="hljs-keyword">val</span> LightColorScheme = lightColorScheme(
    primary = Color(<span class="hljs-number">0xFF6750A4</span>),
    onPrimary = Color(<span class="hljs-number">0xFFFFFFFF</span>),
    primaryContainer = Color(<span class="hljs-number">0xFFEADDFF</span>),
    onPrimaryContainer = Color(<span class="hljs-number">0xFF21005D</span>),
    secondary = Color(<span class="hljs-number">0xFF625B71</span>),
    onSecondary = Color(<span class="hljs-number">0xFFFFFFFF</span>),
    secondaryContainer = Color(<span class="hljs-number">0xFFE8DEF8</span>),
    onSecondaryContainer = Color(<span class="hljs-number">0xFF1D192B</span>),
    tertiary = Color(<span class="hljs-number">0xFF7D5260</span>),
    onTertiary = Color(<span class="hljs-number">0xFFFFFFFF</span>),
    tertiaryContainer = Color(<span class="hljs-number">0xFFFFD8E4</span>),
    onTertiaryContainer = Color(<span class="hljs-number">0xFF31111D</span>),
    error = Color(<span class="hljs-number">0xFFB3261E</span>),
    onError = Color(<span class="hljs-number">0xFFFFFFFF</span>),
    errorContainer = Color(<span class="hljs-number">0xFFF9DEDC</span>),
    onErrorContainer = Color(<span class="hljs-number">0xFF410E0B</span>),
    background = Color(<span class="hljs-number">0xFFFFFBFE</span>),
    onBackground = Color(<span class="hljs-number">0xFF1C1B1F</span>),
    surface = Color(<span class="hljs-number">0xFFFFFBFE</span>),
    onSurface = Color(<span class="hljs-number">0xFF1C1B1F</span>),
    surfaceVariant = Color(<span class="hljs-number">0xFFE7E0EC</span>),
    onSurfaceVariant = Color(<span class="hljs-number">0xFF49454F</span>),
    outline = Color(<span class="hljs-number">0xFF79747E</span>),
    outlineVariant = Color(<span class="hljs-number">0xFFCAC4D0</span>),
    scrim = Color(<span class="hljs-number">0xFF000000</span>),
    inverseSurface = Color(<span class="hljs-number">0xFF313033</span>),
    inverseOnSurface = Color(<span class="hljs-number">0xFFF4EFF4</span>),
    inversePrimary = Color(<span class="hljs-number">0xFFD0BCFF</span>),
    surfaceTint = Color(<span class="hljs-number">0xFF6750A4</span>)
)

<span class="hljs-comment">// 深色主题</span>
<span class="hljs-keyword">val</span> DarkColorScheme = darkColorScheme(
    primary = Color(<span class="hljs-number">0xFFD0BCFF</span>),
    onPrimary = Color(<span class="hljs-number">0xFF381E72</span>),
    primaryContainer = Color(<span class="hljs-number">0xFF4F378B</span>),
    onPrimaryContainer = Color(<span class="hljs-number">0xFFEADDFF</span>),
    <span class="hljs-comment">// ... 其他颜色</span>
)
</code></pre>
<h3 data-id="heading-17">3.5 颜色生成工具</h3>
<p>Google 提供了 Material Theme Builder 工具，可以自动生成完整的 ColorScheme：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 基于种子色生成 ColorScheme</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">generateColorScheme</span><span class="hljs-params">(seedColor: <span class="hljs-type">Color</span>, isDark: <span class="hljs-type">Boolean</span>)</span></span>: ColorScheme {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> (isDark) {
        darkColorScheme(
            primary = seedColor,
            <span class="hljs-comment">// ... 工具会自动计算其他颜色</span>
        )
    } <span class="hljs-keyword">else</span> {
        lightColorScheme(
            primary = seedColor,
            <span class="hljs-comment">// ...</span>
        )
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-18">四、Typography 字体系统</h2>
<h3 data-id="heading-19">4.1 为什么需要 Typography？</h3>
<p>字体是界面设计的重要组成部分，Typography 系统提供了：</p>
<ul>
<li>一致的字体大小和字重</li>
<li>语义化的字体角色</li>
<li>自动适配不同屏幕尺寸</li>
</ul>
<h3 data-id="heading-20">4.2 MD3 的字体角色</h3>
<p>MD3 定义了 15 个字体角色，分为 5 大类：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                    <span class="hljs-string">Typography</span> <span class="hljs-string">字体角色</span>                          <span class="hljs-string">│</span>
<span class="hljs-string">├─────────────────────────────────────────────────────────────────┤</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">Display（展示）-</span> <span class="hljs-string">最大的文字，用于品牌展示</span>                       <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">displayLarge:</span> <span class="hljs-string">57sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Regular</span>                              <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">displayMedium:</span> <span class="hljs-string">45sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Regular</span>                             <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-attr">displaySmall:</span> <span class="hljs-string">36sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Regular</span>                              <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">Headline（标题）-</span> <span class="hljs-string">页面标题、模块标题</span>                           <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">headlineLarge:</span> <span class="hljs-string">32sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Regular</span>                             <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">headlineMedium:</span> <span class="hljs-string">28sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Regular</span>                            <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-attr">headlineSmall:</span> <span class="hljs-string">24sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Regular</span>                             <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">Title（标题）-</span> <span class="hljs-string">卡片标题、列表项标题</span>                            <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">titleLarge:</span> <span class="hljs-string">22sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Medium</span>                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">titleMedium:</span> <span class="hljs-string">16sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Medium</span>                                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-attr">titleSmall:</span> <span class="hljs-string">14sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Medium</span>                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">Body（正文）-</span> <span class="hljs-string">主要内容、段落</span>                                   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">bodyLarge:</span> <span class="hljs-string">16sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Regular</span>                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">bodyMedium:</span> <span class="hljs-string">14sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Regular</span>                                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-attr">bodySmall:</span> <span class="hljs-string">12sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Regular</span>                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">Label（标签）-</span> <span class="hljs-string">按钮、输入框标签、小字</span>                          <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">labelLarge:</span> <span class="hljs-string">14sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Medium</span>                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">├──</span> <span class="hljs-attr">labelMedium:</span> <span class="hljs-string">12sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Medium</span>                                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└──</span> <span class="hljs-attr">labelSmall:</span> <span class="hljs-string">11sp</span> <span class="hljs-string">/</span> <span class="hljs-string">Medium</span>                                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                 <span class="hljs-string">│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>
</code></pre>
<h3 data-id="heading-21">4.3 创建自定义 Typography</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> AppTypography = Typography(
    displayLarge = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Normal,
        fontSize = <span class="hljs-number">57.</span>sp,
        lineHeight = <span class="hljs-number">64.</span>sp,
        letterSpacing = (-<span class="hljs-number">0.25</span>).sp
    ),
    displayMedium = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Normal,
        fontSize = <span class="hljs-number">45.</span>sp,
        lineHeight = <span class="hljs-number">52.</span>sp,
        letterSpacing = <span class="hljs-number">0.</span>sp
    ),
    <span class="hljs-comment">// ... 其他字体角色</span>
    bodyLarge = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Normal,
        fontSize = <span class="hljs-number">16.</span>sp,
        lineHeight = <span class="hljs-number">24.</span>sp,
        letterSpacing = <span class="hljs-number">0.5</span>.sp
    ),
    titleLarge = TextStyle(
        fontFamily = FontFamily.Default,
        fontWeight = FontWeight.Medium,
        fontSize = <span class="hljs-number">22.</span>sp,
        lineHeight = <span class="hljs-number">28.</span>sp,
        letterSpacing = <span class="hljs-number">0.</span>sp
    )
)
</code></pre>
<h3 data-id="heading-22">4.4 使用自定义字体</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 加载字体资源</span>
<span class="hljs-keyword">val</span> InterFontFamily = FontFamily(
    Font(R.font.inter_regular, FontWeight.Normal),
    Font(R.font.inter_medium, FontWeight.Medium),
    Font(R.font.inter_semibold, FontWeight.SemiBold),
    Font(R.font.inter_bold, FontWeight.Bold)
)

<span class="hljs-comment">// 应用到 Typography</span>
<span class="hljs-keyword">val</span> AppTypography = Typography(
    displayLarge = TextStyle(
        fontFamily = InterFontFamily,
        fontWeight = FontWeight.Normal,
        fontSize = <span class="hljs-number">57.</span>sp
    ),
    <span class="hljs-comment">// ...</span>
)
</code></pre>
<h3 data-id="heading-23">4.5 字体使用规范</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 正确使用字体角色</span>
Text(
    text = <span class="hljs-string">"页面标题"</span>,
    style = MaterialTheme.typography.headlineMedium
)

Text(
    text = <span class="hljs-string">"卡片标题"</span>,
    style = MaterialTheme.typography.titleLarge
)

Text(
    text = <span class="hljs-string">"正文内容"</span>,
    style = MaterialTheme.typography.bodyMedium
)

Button(onClick = { }) {
    Text(
        text = <span class="hljs-string">"按钮"</span>,
        style = MaterialTheme.typography.labelLarge
    )
}

<span class="hljs-comment">// ❌ 错误：硬编码字体大小</span>
Text(
    text = <span class="hljs-string">"标题"</span>,
    fontSize = <span class="hljs-number">24.</span>sp  <span class="hljs-comment">// 硬编码</span>
)
</code></pre>
<hr/>
<h2 data-id="heading-24">五、Shape 形状系统</h2>
<h3 data-id="heading-25">5.1 Shape 的作用</h3>
<p>Shape 系统定义了组件的圆角大小，影响界面的整体风格：</p>
<ul>
<li>大圆角：柔和、友好</li>
<li>小圆角：专业、严肃</li>
<li>无圆角：硬朗、现代</li>
</ul>
<h3 data-id="heading-26">5.2 MD3 的形状角色</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> Shapes = Shapes(
    extraSmall = RoundedCornerShape(<span class="hljs-number">4.</span>dp),   <span class="hljs-comment">// 小标签、芯片</span>
    small = RoundedCornerShape(<span class="hljs-number">8.</span>dp),        <span class="hljs-comment">// 按钮、输入框</span>
    medium = RoundedCornerShape(<span class="hljs-number">12.</span>dp),      <span class="hljs-comment">// 卡片</span>
    large = RoundedCornerShape(<span class="hljs-number">16.</span>dp),       <span class="hljs-comment">// 对话框</span>
    extraLarge = RoundedCornerShape(<span class="hljs-number">28.</span>dp)   <span class="hljs-comment">// 底部 Sheet</span>
)
</code></pre>
<h3 data-id="heading-27">5.3 组件默认形状</h3>



































<table><thead><tr><th>组件</th><th>默认形状</th><th>说明</th></tr></thead><tbody><tr><td>Button</td><td>small (8.dp)</td><td>标准按钮</td></tr><tr><td>Card</td><td>medium (12.dp)</td><td>卡片容器</td></tr><tr><td>Dialog</td><td>extraLarge (28.dp)</td><td>对话框</td></tr><tr><td>TextField</td><td>small (8.dp)</td><td>输入框</td></tr><tr><td>FloatingActionButton</td><td>large (16.dp)</td><td>浮动按钮</td></tr></tbody></table>
<h3 data-id="heading-28">5.4 自定义组件形状</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 覆盖组件默认形状</span>
Button(
    onClick = { },
    shape = MaterialTheme.shapes.medium  <span class="hljs-comment">// 使用 medium 而不是默认 small</span>
) {
    Text(<span class="hljs-string">"圆角按钮"</span>)
}

<span class="hljs-comment">// 使用 CutCornerShape 创建切割角</span>
<span class="hljs-keyword">val</span> CutShapes = Shapes(
    medium = CutCornerShape(
        topStart = <span class="hljs-number">12.</span>dp,
        topEnd = <span class="hljs-number">0.</span>dp,
        bottomEnd = <span class="hljs-number">12.</span>dp,
        bottomStart = <span class="hljs-number">0.</span>dp
    )
)
</code></pre>
<hr/>
<h2 data-id="heading-29">六、深色模式完整实现</h2>
<h3 data-id="heading-30">6.1 为什么需要深色模式？</h3>
<ul>
<li><strong>用户体验</strong>：在低光环境下更舒适的阅读体验</li>
<li><strong>设备续航</strong>：OLED 屏幕显示黑色时更省电</li>
<li><strong>个性化</strong>：满足用户的审美偏好</li>
</ul>
<h3 data-id="heading-31">6.2 深色模式的设计原则</h3>
<h4 data-id="heading-32">6.2.1 颜色反转规则</h4>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────────┐
│                    深色模式颜色映射                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  浅色模式                    深色模式                            │
│  ─────────────────────────────────────────────────────────────  │
│  <span class="hljs-attribute">background</span> (#FFFBFE)  →   <span class="hljs-attribute">background</span> (#<span class="hljs-number">1</span>C1B1F)                 │
│  surface (#FFFBFE)     →   surface (#<span class="hljs-number">1</span>C1B1F)                   │
│  onSurface (#<span class="hljs-number">1</span>C1B1F)   →   onSurface (#E6E1E5)                 │
│  primary (#<span class="hljs-number">6750</span>A4)     →   primary (#D0BCFF)                   │
│  onPrimary (#FFFFFF)   →   onPrimary (#<span class="hljs-number">381</span>E72)                 │
│                                                                 │
│  核心原则：降低亮度，保持对比度                                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-33">6.2.2 Elevation 在深色模式中的表现</h4>
<p>在深色模式下，elevation 不使用阴影，而是使用<strong>表面变亮</strong>来表示：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 深色模式下，elevation 越高，surface 越亮</span>
Card(
    modifier = Modifier.height(<span class="hljs-number">48.</span>dp),
    colors = CardDefaults.elevatedCardColors()
) {
    <span class="hljs-comment">// 内容</span>
}
</code></pre>
<h3 data-id="heading-34">6.3 实现深色模式</h3>
<h4 data-id="heading-35">6.3.1 定义深色 ColorScheme</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 深色主题颜色</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> DarkColorScheme = darkColorScheme(
    primary = Purple80,
    secondary = PurpleGrey80,
    tertiary = Pink80,
    background = Color(<span class="hljs-number">0xFF1C1B1F</span>),
    surface = Color(<span class="hljs-number">0xFF1C1B1F</span>),
    onSurface = Color(<span class="hljs-number">0xFFE6E1E5</span>)
)

<span class="hljs-comment">// 浅色主题颜色</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> LightColorScheme = lightColorScheme(
    primary = Purple40,
    secondary = PurpleGrey40,
    tertiary = Pink40,
    background = Color(<span class="hljs-number">0xFFFFFBFE</span>),
    surface = Color(<span class="hljs-number">0xFFFFFBFE</span>),
    onSurface = Color(<span class="hljs-number">0xFF1C1B1F</span>)
)
</code></pre>
<h4 data-id="heading-36">6.3.2 检测系统主题</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MyApp</span><span class="hljs-params">(
    darkTheme: <span class="hljs-type">Boolean</span> = isSystemInDarkTheme()</span></span>  <span class="hljs-comment">// 检测系统主题</span>
) {
    <span class="hljs-keyword">val</span> colorScheme = <span class="hljs-keyword">if</span> (darkTheme) {
        DarkColorScheme
    } <span class="hljs-keyword">else</span> {
        LightColorScheme
    }
    
    MaterialTheme(
        colorScheme = colorScheme,
        typography = Typography,
        shapes = Shapes,
        content = content
    )
}
</code></pre>
<h4 data-id="heading-37">6.3.3 主题切换功能</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 使用 DataStore 保存用户主题偏好</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ThemePreference</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> dataStore: DataStore&lt;Preferences&gt;) {
    <span class="hljs-keyword">val</span> themeFlow: Flow&lt;ThemeMode&gt; = dataStore.<span class="hljs-keyword">data</span>
        .map { preferences -&gt;
            <span class="hljs-keyword">when</span> (preferences[THEME_KEY]) {
                <span class="hljs-string">"light"</span> -&gt; ThemeMode.LIGHT
                <span class="hljs-string">"dark"</span> -&gt; ThemeMode.DARK
                <span class="hljs-keyword">else</span> -&gt; ThemeMode.SYSTEM
            }
        }
    
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setTheme</span><span class="hljs-params">(theme: <span class="hljs-type">ThemeMode</span>)</span></span> {
        dataStore.edit { preferences -&gt;
            preferences[THEME_KEY] = <span class="hljs-keyword">when</span> (theme) {
                ThemeMode.LIGHT -&gt; <span class="hljs-string">"light"</span>
                ThemeMode.DARK -&gt; <span class="hljs-string">"dark"</span>
                ThemeMode.SYSTEM -&gt; <span class="hljs-string">"system"</span>
            }
        }
    }
    
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">val</span> THEME_KEY = stringPreferencesKey(<span class="hljs-string">"theme"</span>)
    }
}

<span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThemeMode</span> {
    LIGHT, DARK, SYSTEM
}

<span class="hljs-comment">// 在应用中使用</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MyApp</span><span class="hljs-params">(
    themePreference: <span class="hljs-type">ThemePreference</span>
)</span></span> {
    <span class="hljs-keyword">val</span> themeMode <span class="hljs-keyword">by</span> themePreference.themeFlow.collectAsState(ThemeMode.SYSTEM)
    <span class="hljs-keyword">val</span> systemDarkTheme = isSystemInDarkTheme()
    
    <span class="hljs-keyword">val</span> darkTheme = <span class="hljs-keyword">when</span> (themeMode) {
        ThemeMode.LIGHT -&gt; <span class="hljs-literal">false</span>
        ThemeMode.DARK -&gt; <span class="hljs-literal">true</span>
        ThemeMode.SYSTEM -&gt; systemDarkTheme
    }
    
    MaterialTheme(
        colorScheme = <span class="hljs-keyword">if</span> (darkTheme) DarkColorScheme <span class="hljs-keyword">else</span> LightColorScheme,
        content = content
    )
}

<span class="hljs-comment">// 主题设置界面</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ThemeSettings</span><span class="hljs-params">(
    themePreference: <span class="hljs-type">ThemePreference</span>
)</span></span> {
    <span class="hljs-keyword">val</span> themeMode <span class="hljs-keyword">by</span> themePreference.themeFlow.collectAsState(ThemeMode.SYSTEM)
    <span class="hljs-keyword">val</span> scope = rememberCoroutineScope()
    
    Column {
        Text(<span class="hljs-string">"主题设置"</span>, style = MaterialTheme.typography.titleLarge)
        
        ThemeOption(
            title = <span class="hljs-string">"跟随系统"</span>,
            selected = themeMode == ThemeMode.SYSTEM,
            onClick = { scope.launch { themePreference.setTheme(ThemeMode.SYSTEM) } }
        )
        
        ThemeOption(
            title = <span class="hljs-string">"浅色模式"</span>,
            selected = themeMode == ThemeMode.LIGHT,
            onClick = { scope.launch { themePreference.setTheme(ThemeMode.LIGHT) } }
        )
        
        ThemeOption(
            title = <span class="hljs-string">"深色模式"</span>,
            selected = themeMode == ThemeMode.DARK,
            onClick = { scope.launch { themePreference.setTheme(ThemeMode.DARK) } }
        )
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ThemeOption</span><span class="hljs-params">(
    title: <span class="hljs-type">String</span>,
    selected: <span class="hljs-type">Boolean</span>,
    onClick: () -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    Row(
        modifier = Modifier
            .fillMaxWidth()
            .clickable(onClick = onClick)
            .padding(<span class="hljs-number">16.</span>dp),
        horizontalArrangement = Arrangement.SpaceBetween
    ) {
        Text(title)
        <span class="hljs-keyword">if</span> (selected) {
            Icon(Icons.Default.Check, contentDescription = <span class="hljs-literal">null</span>)
        }
    }
}
</code></pre>
<h3 data-id="heading-38">6.4 深色模式最佳实践</h3>
<h4 data-id="heading-39">6.4.1 避免纯黑色</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ❌ 错误：使用纯黑色</span>
<span class="hljs-keyword">val</span> DarkBackground = Color(<span class="hljs-number">0xFF000000</span>)

<span class="hljs-comment">// ✅ 正确：使用深灰色</span>
<span class="hljs-keyword">val</span> DarkBackground = Color(<span class="hljs-number">0xFF1C1B1F</span>)  <span class="hljs-comment">// 推荐</span>
</code></pre>
<h4 data-id="heading-40">6.4.2 保持对比度</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 确保文字对比度符合 WCAG 标准</span>
<span class="hljs-comment">// 深色模式下，onSurface 应该是浅色</span>
<span class="hljs-keyword">val</span> onSurfaceDark = Color(<span class="hljs-number">0xFFE6E1E5</span>)  <span class="hljs-comment">// 对比度 &gt; 4.5:1</span>
</code></pre>
<h4 data-id="heading-41">6.4.3 图片适配</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 为深色模式提供不同的图片资源</span>
Image(
    painter = painterResource(
        <span class="hljs-keyword">if</span> (isSystemInDarkTheme()) {
            R.drawable.logo_dark
        } <span class="hljs-keyword">else</span> {
            R.drawable.logo_light
        }
    ),
    contentDescription = <span class="hljs-literal">null</span>
)
</code></pre>
<hr/>
<h2 data-id="heading-42">七、动态取色（Dynamic Color）</h2>
<h3 data-id="heading-43">7.1 什么是动态取色？</h3>
<p><strong>动态取色</strong>是 Android 12+ 引入的功能，应用可以根据用户设置的壁纸自动生成配色方案。</p>
<h3 data-id="heading-44">7.2 动态取色的原理</h3>
<pre><code class="hljs language-ini" lang="ini">┌─────────────────────────────────────────────────────────────────┐
│                    动态取色流程                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 提取壁纸主色调                                               │
│     ├── 使用 quantizer 算法提取主要颜色                         │
│     └── 筛选出符合无障碍标准的颜色                              │
│                              ↓                                  │
│  2. 生成色板（Tonal Palette）                                   │
│     ├── 基于主色生成不同色调的变体                              │
│     └── 创建 Primary、Secondary、Tertiary、Neutral 色板        │
│                              ↓                                  │
│  3. 映射到 ColorScheme                                          │
│     ├── <span class="hljs-attr">primary</span> = 主色板的 <span class="hljs-number">40</span> 色调                              │
│     ├── <span class="hljs-attr">primaryContainer</span> = 主色板的 <span class="hljs-number">90</span> 色调                     │
│     └── ...                                                    │
│                              ↓                                  │
│  4. 应用到应用                                                  │
│     └── MaterialTheme 使用动态 ColorScheme                      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-45">7.3 实现动态取色</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MyApp</span><span class="hljs-params">(
    dynamicColor: <span class="hljs-type">Boolean</span> = <span class="hljs-literal">true</span>
)</span></span> {
    <span class="hljs-keyword">val</span> darkTheme = isSystemInDarkTheme()
    
    <span class="hljs-keyword">val</span> colorScheme = <span class="hljs-keyword">when</span> {
        <span class="hljs-comment">// Android 12+ 支持动态取色</span>
        dynamicColor &amp;&amp; Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.S -&gt; {
            <span class="hljs-keyword">val</span> context = LocalContext.current
            <span class="hljs-keyword">if</span> (darkTheme) {
                dynamicDarkColorScheme(context)
            } <span class="hljs-keyword">else</span> {
                dynamicLightColorScheme(context)
            }
        }
        <span class="hljs-comment">// 使用预定义主题</span>
        darkTheme -&gt; DarkColorScheme
        <span class="hljs-keyword">else</span> -&gt; LightColorScheme
    }
    
    MaterialTheme(
        colorScheme = colorScheme,
        typography = Typography,
        shapes = Shapes,
        content = content
    )
}
</code></pre>
<h3 data-id="heading-46">7.4 动态取色最佳实践</h3>
<h4 data-id="heading-47">7.4.1 提供关闭选项</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 让用户选择是否使用动态取色</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ColorPreference</span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> dataStore: DataStore&lt;Preferences&gt;) {
    <span class="hljs-keyword">val</span> dynamicColorFlow: Flow&lt;<span class="hljs-built_in">Boolean</span>&gt; = dataStore.<span class="hljs-keyword">data</span>
        .map { it[DYNAMIC_COLOR_KEY] ?: <span class="hljs-literal">true</span> }
    
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setDynamicColor</span><span class="hljs-params">(enabled: <span class="hljs-type">Boolean</span>)</span></span> {
        dataStore.edit { it[DYNAMIC_COLOR_KEY] = enabled }
    }
    
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">val</span> DYNAMIC_COLOR_KEY = booleanPreferencesKey(<span class="hljs-string">"dynamic_color"</span>)
    }
}
</code></pre>
<h4 data-id="heading-48">7.4.2 备用方案</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 当动态取色不可用时，使用品牌色</span>
<span class="hljs-keyword">val</span> colorScheme = <span class="hljs-keyword">if</span> (dynamicColor &amp;&amp; supportsDynamicColor()) {
    dynamicLightColorScheme(context)
} <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 使用应用的品牌色</span>
    lightColorScheme(
        primary = BrandPrimary,
        secondary = BrandSecondary
    )
}
</code></pre>
<hr/>
<h2 data-id="heading-49">八、Material 组件深度解析</h2>
<h3 data-id="heading-50">8.1 Button 组件</h3>
<h4 data-id="heading-51">8.1.1 Button 的类型</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. FilledButton（填充按钮）- 主要操作</span>
Button(onClick = { }) {
    Text(<span class="hljs-string">"确认"</span>)
}

<span class="hljs-comment">// 2. ElevatedButton（凸起按钮）- 需要强调的操作</span>
ElevatedButton(onClick = { }) {
    Text(<span class="hljs-string">"重要操作"</span>)
}

<span class="hljs-comment">// 3. OutlinedButton（描边按钮）- 次要操作</span>
OutlinedButton(onClick = { }) {
    Text(<span class="hljs-string">"取消"</span>)
}

<span class="hljs-comment">// 4. TextButton（文本按钮）- 最低优先级操作</span>
TextButton(onClick = { }) {
    Text(<span class="hljs-string">"了解更多"</span>)
}

<span class="hljs-comment">// 5. IconButton（图标按钮）</span>
IconButton(onClick = { }) {
    Icon(Icons.Default.Add, contentDescription = <span class="hljs-string">"添加"</span>)
}

<span class="hljs-comment">// 6. FloatingActionButton（浮动按钮）</span>
FloatingActionButton(onClick = { }) {
    Icon(Icons.Default.Add, contentDescription = <span class="hljs-string">"添加"</span>)
}
</code></pre>
<h4 data-id="heading-52">8.1.2 Button 的设计规范</h4>
<pre><code class="hljs language-css" lang="css">┌─────────────────────────────────────────────────────────────────┐
│                    <span class="hljs-selector-tag">Button</span> 使用规范                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  按钮层级（从高到低）：                                          │
│                                                                 │
│  <span class="hljs-number">1</span>. FilledButton                                                │
│     ├── 用途：最重要的操作                                       │
│     ├── 数量：每屏最多 <span class="hljs-number">1</span> 个                                      │
│     └── 位置：底部或操作区域                                     │
│                                                                 │
│  <span class="hljs-number">2</span>. ElevatedButton                                              │
│     ├── 用途：需要强调的操作                                     │
│     └── 场景：在背景复杂的区域                                   │
│                                                                 │
│  <span class="hljs-number">3</span>. OutlinedButton                                              │
│     ├── 用途：次要操作                                           │
│     ├── 数量：可以有多个                                         │
│     └── 场景：与 FilledButton 配合使用                           │
│                                                                 │
│  <span class="hljs-number">4</span>. TextButton                                                  │
│     ├── 用途：最低优先级操作                                     │
│     └── 场景：工具栏、对话框                                     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-53">8.1.3 自定义 Button</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 自定义颜色</span>
Button(
    onClick = { },
    colors = ButtonDefaults.buttonColors(
        containerColor = MaterialTheme.colorScheme.primary,
        contentColor = MaterialTheme.colorScheme.onPrimary,
        disabledContainerColor = MaterialTheme.colorScheme.surfaceVariant,
        disabledContentColor = MaterialTheme.colorScheme.onSurfaceVariant
    )
) {
    Text(<span class="hljs-string">"自定义按钮"</span>)
}

<span class="hljs-comment">// 带图标的按钮</span>
Button(onClick = { }) {
    Icon(Icons.Default.Send, contentDescription = <span class="hljs-literal">null</span>)
    Spacer(Modifier.width(<span class="hljs-number">8.</span>dp))
    Text(<span class="hljs-string">"发送"</span>)
}
</code></pre>
<h3 data-id="heading-54">8.2 Card 组件</h3>
<h4 data-id="heading-55">8.2.1 Card 的类型</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 普通 Card</span>
Card(
    modifier = Modifier.fillMaxWidth(),
    onClick = { }
) {
    Column(modifier = Modifier.padding(<span class="hljs-number">16.</span>dp)) {
        Text(<span class="hljs-string">"卡片标题"</span>, style = MaterialTheme.typography.titleLarge)
        Text(<span class="hljs-string">"卡片内容"</span>, style = MaterialTheme.typography.bodyMedium)
    }
}

<span class="hljs-comment">// 2. ElevatedCard（带阴影）</span>
ElevatedCard(
    modifier = Modifier.fillMaxWidth(),
    elevation = CardDefaults.elevatedCardElevation(
        defaultElevation = <span class="hljs-number">6.</span>dp
    )
) {
    <span class="hljs-comment">// 内容</span>
}

<span class="hljs-comment">// 3. OutlinedCard（带边框）</span>
OutlinedCard(
    modifier = Modifier.fillMaxWidth()
) {
    <span class="hljs-comment">// 内容</span>
}
</code></pre>
<h4 data-id="heading-56">8.2.2 Card 的设计规范</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 卡片内容结构</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ArticleCard</span><span class="hljs-params">(article: <span class="hljs-type">Article</span>)</span></span> {
    Card(
        modifier = Modifier.fillMaxWidth(),
        onClick = { }
    ) {
        Column {
            <span class="hljs-comment">// 图片（可选）</span>
            AsyncImage(
                model = article.imageUrl,
                contentDescription = <span class="hljs-literal">null</span>,
                modifier = Modifier
                    .fillMaxWidth()
                    .height(<span class="hljs-number">194.</span>dp),
                contentScale = ContentScale.Crop
            )
            
            <span class="hljs-comment">// 内容区域</span>
            Column(modifier = Modifier.padding(<span class="hljs-number">16.</span>dp)) {
                <span class="hljs-comment">// 标题</span>
                Text(
                    text = article.title,
                    style = MaterialTheme.typography.titleLarge
                )
                
                <span class="hljs-comment">// 副标题（可选）</span>
                Text(
                    text = article.subtitle,
                    style = MaterialTheme.typography.bodyMedium,
                    color = MaterialTheme.colorScheme.onSurfaceVariant
                )
                
                <span class="hljs-comment">// 操作按钮</span>
                Row(
                    modifier = Modifier.padding(top = <span class="hljs-number">16.</span>dp),
                    horizontalArrangement = Arrangement.End
                ) {
                    TextButton(onClick = { }) {
                        Text(<span class="hljs-string">"阅读更多"</span>)
                    }
                }
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-57">8.3 TextField 组件</h3>
<h4 data-id="heading-58">8.3.1 TextField 的类型</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. OutlinedTextField（描边样式）</span>
<span class="hljs-keyword">var</span> text <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">""</span>) }
OutlinedTextField(
    value = text,
    onValueChange = { text = it },
    label = { Text(<span class="hljs-string">"用户名"</span>) },
    placeholder = { Text(<span class="hljs-string">"请输入用户名"</span>) },
    leadingIcon = {
        Icon(Icons.Default.Person, contentDescription = <span class="hljs-literal">null</span>)
    },
    trailingIcon = {
        <span class="hljs-keyword">if</span> (text.isNotEmpty()) {
            IconButton(onClick = { text = <span class="hljs-string">""</span> }) {
                Icon(Icons.Default.Clear, contentDescription = <span class="hljs-string">"清除"</span>)
            }
        }
    },
    isError = text.length &gt; <span class="hljs-number">20</span>,
    supportingText = {
        <span class="hljs-keyword">if</span> (text.length &gt; <span class="hljs-number">20</span>) {
            Text(<span class="hljs-string">"用户名不能超过 20 个字符"</span>)
        }
    }
)

<span class="hljs-comment">// 2. TextField（填充样式）</span>
TextField(
    value = text,
    onValueChange = { text = it },
    label = { Text(<span class="hljs-string">"密码"</span>) },
    visualTransformation = PasswordVisualTransformation(),
    keyboardOptions = KeyboardOptions(
        keyboardType = KeyboardType.Password
    )
)
</code></pre>
<h4 data-id="heading-59">8.3.2 表单验证</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LoginForm</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> email <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">""</span>) }
    <span class="hljs-keyword">var</span> password <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">""</span>) }
    
    <span class="hljs-keyword">val</span> emailError = <span class="hljs-keyword">if</span> (email.isNotEmpty() &amp;&amp; !email.isValidEmail()) {
        <span class="hljs-string">"请输入有效的邮箱地址"</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>
    
    <span class="hljs-keyword">val</span> passwordError = <span class="hljs-keyword">if</span> (password.isNotEmpty() &amp;&amp; password.length &lt; <span class="hljs-number">6</span>) {
        <span class="hljs-string">"密码不能少于 6 位"</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-literal">null</span>
    
    Column {
        OutlinedTextField(
            value = email,
            onValueChange = { email = it },
            label = { Text(<span class="hljs-string">"邮箱"</span>) },
            isError = emailError != <span class="hljs-literal">null</span>,
            supportingText = emailError?.let { { Text(it) } }
        )
        
        OutlinedTextField(
            value = password,
            onValueChange = { password = it },
            label = { Text(<span class="hljs-string">"密码"</span>) },
            visualTransformation = PasswordVisualTransformation(),
            isError = passwordError != <span class="hljs-literal">null</span>,
            supportingText = passwordError?.let { { Text(it) } }
        )
        
        Button(
            onClick = { <span class="hljs-comment">/* 登录 */</span> },
            enabled = emailError == <span class="hljs-literal">null</span> &amp;&amp; passwordError == <span class="hljs-literal">null</span>
        ) {
            Text(<span class="hljs-string">"登录"</span>)
        }
    }
}
</code></pre>
<h3 data-id="heading-60">8.4 Dialog 组件</h3>
<h4 data-id="heading-61">8.4.1 AlertDialog</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">DeleteConfirmDialog</span><span class="hljs-params">(
    onConfirm: () -&gt; <span class="hljs-type">Unit</span>,
    onDismiss: () -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    AlertDialog(
        onDismissRequest = onDismiss,
        title = { Text(<span class="hljs-string">"确认删除"</span>) },
        text = { Text(<span class="hljs-string">"确定要删除这个项目吗？此操作无法撤销。"</span>) },
        confirmButton = {
            TextButton(
                onClick = onConfirm,
                colors = ButtonDefaults.textButtonColors(
                    contentColor = MaterialTheme.colorScheme.error
                )
            ) {
                Text(<span class="hljs-string">"删除"</span>)
            }
        },
        dismissButton = {
            TextButton(onClick = onDismiss) {
                Text(<span class="hljs-string">"取消"</span>)
            }
        }
    )
}
</code></pre>
<h4 data-id="heading-62">8.4.2 自定义 Dialog</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CustomDialog</span><span class="hljs-params">(
    onDismiss: () -&gt; <span class="hljs-type">Unit</span>,
    content: @<span class="hljs-type">Composable</span> () -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    Dialog(onDismissRequest = onDismiss) {
        Card(
            modifier = Modifier
                .fillMaxWidth()
                .padding(<span class="hljs-number">16.</span>dp),
            shape = MaterialTheme.shapes.extraLarge
        ) {
            content()
        }
    }
}
</code></pre>
<h3 data-id="heading-63">8.5 Scaffold 布局</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MyScreen</span><span class="hljs-params">()</span></span> {
    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text(<span class="hljs-string">"标题"</span>) },
                navigationIcon = {
                    IconButton(onClick = { }) {
                        Icon(Icons.Default.ArrowBack, contentDescription = <span class="hljs-string">"返回"</span>)
                    }
                },
                actions = {
                    IconButton(onClick = { }) {
                        Icon(Icons.Default.Search, contentDescription = <span class="hljs-string">"搜索"</span>)
                    }
                }
            )
        },
        bottomBar = {
            NavigationBar {
                NavigationBarItem(
                    selected = <span class="hljs-literal">true</span>,
                    onClick = { },
                    icon = { Icon(Icons.Default.Home, contentDescription = <span class="hljs-literal">null</span>) },
                    label = { Text(<span class="hljs-string">"首页"</span>) }
                )
                NavigationBarItem(
                    selected = <span class="hljs-literal">false</span>,
                    onClick = { },
                    icon = { Icon(Icons.Default.Person, contentDescription = <span class="hljs-literal">null</span>) },
                    label = { Text(<span class="hljs-string">"我的"</span>) }
                )
            }
        },
        floatingActionButton = {
            FloatingActionButton(onClick = { }) {
                Icon(Icons.Default.Add, contentDescription = <span class="hljs-string">"添加"</span>)
            }
        }
    ) { innerPadding -&gt;
        <span class="hljs-comment">// 内容区域</span>
        LazyColumn(
            modifier = Modifier.padding(innerPadding)
        ) {
            <span class="hljs-comment">// 列表内容</span>
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-64">九、自定义组件设计思路</h2>
<h3 data-id="heading-65">9.1 组件设计原则</h3>
<h4 data-id="heading-66">9.1.1 单一职责</h4>
<p>一个组件只做一件事：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 好的设计：只负责显示用户信息</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserAvatar</span><span class="hljs-params">(user: <span class="hljs-type">User</span>, size: <span class="hljs-type">Dp</span> = <span class="hljs-number">48.</span>dp)</span></span> {
    AsyncImage(
        model = user.avatarUrl,
        contentDescription = user.name,
        modifier = Modifier
            .size(size)
            .clip(CircleShape)
    )
}

<span class="hljs-comment">// ❌ 坏的设计：既显示头像又处理点击跳转</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">UserAvatarBad</span><span class="hljs-params">(user: <span class="hljs-type">User</span>, onNavigate: () -&gt; <span class="hljs-type">Unit</span>)</span></span> {
    AsyncImage(
        model = user.avatarUrl,
        contentDescription = user.name,
        modifier = Modifier
            .size(<span class="hljs-number">48.</span>dp)
            .clip(CircleShape)
            .clickable { onNavigate() }  <span class="hljs-comment">// 不应该在这里处理导航</span>
    )
}
</code></pre>
<h4 data-id="heading-67">9.1.2 可配置性</h4>
<p>提供合理的自定义选项：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">PrimaryButton</span><span class="hljs-params">(
    text: <span class="hljs-type">String</span>,
    onClick: () -&gt; <span class="hljs-type">Unit</span>,
    modifier: <span class="hljs-type">Modifier</span> = Modifier,  <span class="hljs-comment">// 允许外部传入 Modifier</span>
    enabled: <span class="hljs-type">Boolean</span> = <span class="hljs-literal">true</span>,
    icon: <span class="hljs-type">ImageVector</span>? = <span class="hljs-literal">null</span>
)</span></span> {
    Button(
        onClick = onClick,
        modifier = modifier,
        enabled = enabled
    ) {
        icon?.let {
            Icon(it, contentDescription = <span class="hljs-literal">null</span>)
            Spacer(Modifier.width(<span class="hljs-number">8.</span>dp))
        }
        Text(text)
    }
}
</code></pre>
<h4 data-id="heading-68">9.1.3 状态提升</h4>
<p>将状态提升到父组件：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ✅ 好的设计：无状态组件</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ExpandableCard</span><span class="hljs-params">(
    expanded: <span class="hljs-type">Boolean</span>,
    onExpandedChange: (<span class="hljs-type">Boolean</span>) -&gt; <span class="hljs-type">Unit</span>,
    title: @<span class="hljs-type">Composable</span> () -&gt; <span class="hljs-type">Unit</span>,
    content: @<span class="hljs-type">Composable</span> () -&gt; <span class="hljs-type">Unit</span>
)</span></span> {
    Card {
        Column {
            Row(
                modifier = Modifier
                    .fillMaxWidth()
                    .clickable { onExpandedChange(!expanded) }
                    .padding(<span class="hljs-number">16.</span>dp)
            ) {
                title()
                Spacer(Modifier.weight(<span class="hljs-number">1f</span>))
                Icon(
                    <span class="hljs-keyword">if</span> (expanded) Icons.Default.ExpandLess <span class="hljs-keyword">else</span> Icons.Default.ExpandMore,
                    contentDescription = <span class="hljs-keyword">if</span> (expanded) <span class="hljs-string">"收起"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"展开"</span>
                )
            }
            
            AnimatedVisibility(visible = expanded) {
                content()
            }
        }
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MyScreen</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> expanded <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-literal">false</span>) }
    
    ExpandableCard(
        expanded = expanded,
        onExpandedChange = { expanded = it },
        title = { Text(<span class="hljs-string">"标题"</span>) },
        content = { Text(<span class="hljs-string">"展开的内容"</span>) }
    )
}
</code></pre>
<h3 data-id="heading-69">9.2 实战：自定义 Chip 组件</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 自定义 Chip 组件
 * 
 * 设计思路：
 * 1. 支持选中/未选中两种状态
 * 2. 可配置颜色、形状、尺寸
 * 3. 支持图标和删除按钮
 */</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CustomChip</span><span class="hljs-params">(
    text: <span class="hljs-type">String</span>,
    selected: <span class="hljs-type">Boolean</span>,
    onClick: () -&gt; <span class="hljs-type">Unit</span>,
    modifier: <span class="hljs-type">Modifier</span> = Modifier,
    enabled: <span class="hljs-type">Boolean</span> = <span class="hljs-literal">true</span>,
    leadingIcon: @<span class="hljs-type">Composable</span> (() -&gt; <span class="hljs-type">Unit</span>)? = <span class="hljs-literal">null</span>,
    onDelete: (() -&gt; <span class="hljs-type">Unit</span>)? = <span class="hljs-literal">null</span>,
    colors: <span class="hljs-type">SelectableChipColors</span> = ChipDefaults.selectableChipColors()</span></span>,
    shape: Shape = MaterialTheme.shapes.small
) {
    <span class="hljs-keyword">val</span> containerColor <span class="hljs-keyword">by</span> colors.containerColor(enabled, selected)
    <span class="hljs-keyword">val</span> labelColor <span class="hljs-keyword">by</span> colors.labelColor(enabled, selected)
    
    Surface(
        modifier = modifier,
        shape = shape,
        color = containerColor,
        onClick = onClick,
        enabled = enabled
    ) {
        Row(
            modifier = Modifier.padding(horizontal = <span class="hljs-number">12.</span>dp, vertical = <span class="hljs-number">6.</span>dp),
            verticalAlignment = Alignment.CenterVertically
        ) {
            leadingIcon?.let { icon -&gt;
                Box(Modifier.size(<span class="hljs-number">18.</span>dp)) { icon() }
                Spacer(Modifier.width(<span class="hljs-number">8.</span>dp))
            }
            
            Text(
                text = text,
                style = MaterialTheme.typography.labelLarge,
                color = labelColor
            )
            
            onDelete?.let { onDeleteClick -&gt;
                Spacer(Modifier.width(<span class="hljs-number">8.</span>dp))
                Icon(
                    imageVector = Icons.Default.Close,
                    contentDescription = <span class="hljs-string">"删除"</span>,
                    modifier = Modifier
                        .size(<span class="hljs-number">18.</span>dp)
                        .clickable(onClick = onDeleteClick),
                    tint = labelColor
                )
            }
        }
    }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">ChipDemo</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> selected <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-literal">false</span>) }
    
    FlowRow(horizontalGap = <span class="hljs-number">8.</span>dp, verticalGap = <span class="hljs-number">8.</span>dp) {
        <span class="hljs-comment">// 普通 Chip</span>
        CustomChip(
            text = <span class="hljs-string">"标签 1"</span>,
            selected = <span class="hljs-literal">false</span>,
            onClick = { }
        )
        
        <span class="hljs-comment">// 选中状态</span>
        CustomChip(
            text = <span class="hljs-string">"已选中"</span>,
            selected = <span class="hljs-literal">true</span>,
            onClick = { selected = !selected }
        )
        
        <span class="hljs-comment">// 带图标的 Chip</span>
        CustomChip(
            text = <span class="hljs-string">"带图标"</span>,
            selected = <span class="hljs-literal">false</span>,
            onClick = { },
            leadingIcon = {
                Icon(Icons.Default.Check, contentDescription = <span class="hljs-literal">null</span>)
            }
        )
        
        <span class="hljs-comment">// 可删除的 Chip</span>
        CustomChip(
            text = <span class="hljs-string">"可删除"</span>,
            selected = <span class="hljs-literal">false</span>,
            onClick = { },
            onDelete = { <span class="hljs-comment">/* 删除逻辑 */</span> }
        )
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-70">十、本篇小结</h2>
<p>今天我们深入探讨了 Material Design 3 的组件与主题系统：</p>
<h3 data-id="heading-71">Material Design 3 设计哲学</h3>
<ul>
<li>理解了 MD3 的核心变化和设计原则</li>
<li>掌握了个性化、适应性、层次结构三大特性</li>
</ul>
<h3 data-id="heading-72">MaterialTheme 系统</h3>
<ul>
<li>深入理解了 ColorScheme、Typography、Shape 三大系统</li>
<li>掌握了主题定制的完整方法</li>
</ul>
<h3 data-id="heading-73">深色模式</h3>
<ul>
<li>理解了颜色反转规则和 elevation 处理</li>
<li>掌握了完整实现方案和最佳实践</li>
</ul>
<h3 data-id="heading-74">动态取色</h3>
<ul>
<li>理解了动态取色的原理</li>
<li>掌握了实现方法和备用方案</li>
</ul>
<h3 data-id="heading-75">Material 组件</h3>
<ul>
<li>深入理解了 Button、Card、TextField、Dialog 等组件</li>
<li>掌握了组件使用规范和自定义方法</li>
</ul>
<h3 data-id="heading-76">自定义组件</h3>
<ul>
<li>理解了组件设计原则（单一职责、可配置性、状态提升）</li>
<li>掌握了自定义组件的完整设计思路</li>
</ul>
<hr/>
<h2 data-id="heading-77">下篇预告</h2>
<p><strong>第五篇：动画与交互</strong> 将深入讲解：</p>
<ul>
<li>Compose 动画系统架构</li>
<li>属性动画与过渡动画</li>
<li>手势处理与触摸交互</li>
<li>自定义动画的设计思路</li>
</ul>
<p>敬请期待！</p>
<hr/>
<h2 data-id="heading-78">参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fm3.material.io%2F" target="_blank" title="https://m3.material.io/" ref="nofollow noopener noreferrer">Material Design 3 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fjetpack%2Fcompose%2Fcomponents" target="_blank" title="https://developer.android.com/jetpack/compose/components" ref="nofollow noopener noreferrer">Compose Material 3 组件</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fm3.material.io%2Ftheme-builder" target="_blank" title="https://m3.material.io/theme-builder" ref="nofollow noopener noreferrer">Material Theme Builder</a></li>
</ul>
<hr/>
<blockquote>
<p>📌 <strong>系列文章导航</strong></p>
<ul>
<li>第一篇：初识 Compose ✅</li>
<li>第二篇：核心基石 ✅</li>
<li>第三篇：状态管理 ✅</li>
<li>第四篇：Material 组件与主题（当前）✅</li>
<li>第五篇：动画与交互</li>
<li>第六篇：架构与工程化</li>
<li>第七篇：高级特性与实战</li>
</ul>
</blockquote>
<hr/>
<p>如果这篇文章对你有帮助，欢迎 <strong>点赞</strong>、<strong>收藏</strong>、<strong>关注</strong>！有任何问题可以在评论区留言。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[吊打前端面试：从 0 到 1 手写前端异常监控生产级脚本，带你吃透所有核心考点]]></title>    <link>https://juejin.cn/post/7600787795477119022</link>    <guid>https://juejin.cn/post/7600787795477119022</guid>    <pubDate>2026-01-30T08:33:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600787795477119022" data-draft-id="7591304659131400230" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="吊打前端面试：从 0 到 1 手写前端异常监控生产级脚本，带你吃透所有核心考点"/> <meta itemprop="keywords" content="前端,监控,面试"/> <meta itemprop="datePublished" content="2026-01-30T08:33:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="humor"/> <meta itemprop="url" content="https://juejin.cn/user/3227821867810664"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            吊打前端面试：从 0 到 1 手写前端异常监控生产级脚本，带你吃透所有核心考点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3227821867810664/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    humor
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T08:33:43.000Z" title="Fri Jan 30 2026 08:33:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前端异常监控实战指南：从原理到落地，吃透大厂面试与生产级脚本</h2>
<h3 data-id="heading-1">一、先搞懂：为什么前端必须做异常监控？</h3>
<p>通往高级前端的必备阶梯</p>
<p>很多前端都有一个误区：“代码写完测通就行，监控没必要”。但实际业务落地中，本地测试环境与用户真实使用场景的差距，总会带来各种意想不到的问题，这些问题往往难以复现、排查成本极高：</p>
<ul>
<li>环境差异坑：本地测试全流程通顺，部分用户却反馈页面白屏、脚本报错，因设备、浏览器版本、网络环境不同，无法复现问题路径；</li>
<li>偶发异常坑：按钮点击无响应、接口偶尔返回500、页面跳转卡顿等偶发问题，用户刷新后可能恢复，日志中无任何痕迹，排查陷入僵局；</li>
<li>用户沉默坑：大部分用户遇到轻微异常不会主动投诉，只会直接退出页面，导致开发者错失问题修复时机，默默流失用户；</li>
<li>生产崩溃坑：线上核心功能崩溃（如支付、登录），若无法及时发现，会造成直接业务损失，甚至影响产品口碑。</li>
</ul>
<p>前端异常监控的核心价值，就是<strong>把用户端的“黑盒问题”变成可追溯的“白盒数据”</strong> ，打破“测试通=线上稳”的认知误区，精准解决3大核心痛点，为线上产品稳定性兜底：</p>
<ol>
<li><strong>及时发现问题</strong>：用户遇到错误时，开发者能第一时间收到分级告警（致命异常立即提醒、轻微异常定期汇总），主动响应而非被动等待用户投诉；</li>
<li><strong>精准定位原因</strong>：上报数据附带完整上下文——环境信息（浏览器/设备/系统版本）、错误栈、用户操作路径、请求参数，快速锁定问题根源，避免无效排查；</li>
<li><strong>量化错误影响</strong>：统计异常发生率、影响用户数、涉及页面，按“严重程度+影响范围”排序，优先解决白屏、核心功能崩溃等高频高危问题，合理分配研发资源。</li>
</ol>
<p>更关键的是，前端异常监控早已成为多家大厂的面试高频模块——面试官不仅考察技术实现，更看重你对“监控价值”的理解、工程化思维，以及落地中的实战思考。</p>
<p><strong>前端面试高频真题（异常监控模块）</strong></p>
<ol>
<li>前端常见的异常类型有哪些？如何分别捕获？</li>
<li>监控脚本加载前的早期异常，该如何处理？</li>
<li>断网场景下，如何避免异常丢失？</li>
<li>高流量项目中，如何控制异常上报的服务端压力？</li>
<li>单页应用中，如何避免监控脚本导致的内存泄漏？</li>
</ol>
<p>注：下文将结合生产级TypeScript脚本，逐一拆解上述真题的答题思路与实战代码，精准匹配面试得分点，新手也能直接套用。</p>
<h3 data-id="heading-2">二、脚本核心亮点：为什么它能成为面试 &amp; 项目双利器？</h3>
<p>本文拆解的前端异常监控脚本，基于TypeScript开发，对标企业级工具，核心亮点精准对标面试考点和项目痛点，既能打动面试官，也能解决实际业务问题：</p>


















































<table><thead><tr><th>核心亮点</th><th>对应面试考点</th><th>解决的项目痛点</th></tr></thead><tbody><tr><td>全类型异常自动捕获（JS/Promise/资源/API）</td><td>前端异常类型及捕获方式</td><td>传统监控覆盖不全，关键异常遗漏</td></tr><tr><td>早期异常捕获机制</td><td>监控脚本启动前的异常处理</td><td>项目启动阶段异常丢失，无法排查启动白屏问题</td></tr><tr><td>双存储缓存 + 指数退避重试</td><td>断网场景下的异常可靠性保障</td><td>网络波动/服务端故障导致异常上报丢失</td></tr><tr><td>全局 + 按类型双层采样</td><td>高流量项目的上报流量管控</td><td>大量重复异常压垮服务端，增加服务器成本</td></tr><tr><td>完善的销毁机制</td><td>单页应用的内存泄漏问题</td><td>路由切换后事件监听残留，导致内存泄漏&amp;重复上报</td></tr><tr><td>TypeScript原生开发 + 模块化设计</td><td>工程化 &amp; 可扩展性思维</td><td>无类型提示，难以扩展，适配现代前端项目成本高</td></tr><tr><td>轻量无依赖（打包后＜10KB）</td><td>性能优化意识</td><td>第三方监控体积庞大，影响页面加载性能</td></tr><tr><td>高兼容性（IE11+&amp;主流框架）</td><td>兼容性处理能力</td><td>老旧浏览器/不同框架下监控脚本无法运行</td></tr></tbody></table>
<p>下文将从原理到实战，结合完整代码片段，拆解这款脚本的实现细节，帮你吃透每个亮点对应的面试考点与业务落地逻辑。</p>
<h3 data-id="heading-3">三、异常捕获：精准覆盖全场景，避开常见盲区（附实战代码）</h3>
<p>异常捕获的核心是“无死角”，也是面试中最易踩坑的环节。脚本通过「原生事件监听」+「API重写」的方式，实现全类型异常无侵入捕获，代码可直接复用，完美应对“前端异常类型及捕获方式”高频考点。</p>
<h4 data-id="heading-4">1. 脚本执行异常捕获（JS + 未处理Promise）</h4>
<p>通过window.onerror和window.unhandledrejection组合监听，格式化错误信息并过滤无用异常，解决“同步/异步异常捕获差异”的面试难点：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 摘自脚本核心代码：JS执行异常捕获</span>
private <span class="hljs-title function_">_monitorJsError</span>(): <span class="hljs-keyword">void</span> {
  <span class="hljs-keyword">const</span> that = <span class="hljs-variable language_">this</span>;
  <span class="hljs-comment">// 普通JS错误捕获</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">onerror</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">message, source, lineno, colno, error</span>) {
    <span class="hljs-keyword">const</span> errorMessage = <span class="hljs-keyword">typeof</span> message === <span class="hljs-string">'string'</span> ? message : <span class="hljs-string">'未知JS错误'</span>;
    <span class="hljs-comment">// 过滤跨域脚本错误、插件错误（面试常考：如何忽略无用异常）</span>
    <span class="hljs-keyword">if</span> (that.<span class="hljs-title function_">_ignoreError</span>(errorMessage)) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> errorType = <span class="hljs-string">'js_error'</span>;
    <span class="hljs-comment">// 采样判断（后续讲解）</span>
    <span class="hljs-keyword">if</span> (!that.<span class="hljs-title function_">_isNeedSample</span>(errorType)) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

    <span class="hljs-comment">// 构造标准错误信息（面试常考：错误信息该包含哪些字段）</span>
    <span class="hljs-keyword">const</span> <span class="hljs-attr">errorInfo</span>: <span class="hljs-title class_">ErrorDetail</span> = {
      <span class="hljs-attr">type</span>: errorType,
      <span class="hljs-attr">message</span>: error?.<span class="hljs-property">message</span> || errorMessage,
      <span class="hljs-attr">stack</span>: error?.<span class="hljs-property">stack</span> || that.<span class="hljs-title function_">_formatStack</span>(errorMessage, source, lineno, colno),
      <span class="hljs-attr">source</span>: source || <span class="hljs-string">''</span>,
      <span class="hljs-attr">lineno</span>: lineno || <span class="hljs-number">0</span>,
      <span class="hljs-attr">colno</span>: colno || <span class="hljs-number">0</span>,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
    };

    <span class="hljs-comment">// 先缓存后上报（保障可靠性，后续讲解）</span>
    that.<span class="hljs-property">cacheManager</span>.<span class="hljs-title function_">saveError</span>(errorInfo, {
      <span class="hljs-attr">projectName</span>: that.<span class="hljs-property">config</span>.<span class="hljs-property">projectName</span>,
      <span class="hljs-attr">environment</span>: that.<span class="hljs-property">environmentInfo</span>,
      <span class="hljs-attr">extra</span>: that.<span class="hljs-property">config</span>.<span class="hljs-property">extraInfo</span>
    }).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> that.<span class="hljs-title function_">_reportError</span>(errorInfo));

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 阻止错误冒泡，避免重复打印</span>
  };

  <span class="hljs-comment">// 未捕获Promise异常捕获（面试高频：Promise异常为什么无法被onerror捕获？）</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'unhandledrejection'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) {
    event.<span class="hljs-title function_">preventDefault</span>(); <span class="hljs-comment">// 阻止浏览器默认提示</span>
    <span class="hljs-keyword">const</span> reason = event.<span class="hljs-property">reason</span>;
    <span class="hljs-keyword">const</span> errorMessage = reason?.<span class="hljs-property">message</span> || <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(reason);
    <span class="hljs-keyword">if</span> (that.<span class="hljs-title function_">_ignoreError</span>(errorMessage)) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> errorType = <span class="hljs-string">'promise_error'</span>;
    <span class="hljs-keyword">if</span> (!that.<span class="hljs-title function_">_isNeedSample</span>(errorType)) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> <span class="hljs-attr">errorInfo</span>: <span class="hljs-title class_">ErrorDetail</span> = {
      <span class="hljs-attr">type</span>: errorType,
      <span class="hljs-attr">message</span>: reason?.<span class="hljs-property">message</span> || <span class="hljs-string">'未捕获Promise错误'</span>,
      <span class="hljs-attr">stack</span>: reason?.<span class="hljs-property">stack</span> || <span class="hljs-string">'无调用栈信息'</span>,
      <span class="hljs-attr">source</span>: <span class="hljs-string">'Promise'</span>,
      <span class="hljs-attr">lineno</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">colno</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
    };

    that.<span class="hljs-property">cacheManager</span>.<span class="hljs-title function_">saveError</span>(errorInfo, {
      <span class="hljs-attr">projectName</span>: that.<span class="hljs-property">config</span>.<span class="hljs-property">projectName</span>,
      <span class="hljs-attr">environment</span>: that.<span class="hljs-property">environmentInfo</span>,
      <span class="hljs-attr">extra</span>: that.<span class="hljs-property">config</span>.<span class="hljs-property">extraInfo</span>
    }).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> that.<span class="hljs-title function_">_reportError</span>(errorInfo));
  });
}
</code></pre>
<p><strong>面试加分点</strong>：</p>
<ul>
<li>
<p>Promise异常无法被window.onerror捕获，因为Promise异常会被封装在微任务中，不会冒泡到全局；</p>
</li>
<li>
<p>捕获后需调用event.preventDefault()，避免浏览器在控制台打印默认错误信息；</p>
</li>
<li>
<p>用户可配置过滤Script error（跨域脚本错误）和插件错误，减少无用上报。</p>
</li>
</ul>
<h4 data-id="heading-5">2. 资源加载异常捕获</h4>
<p>图片、CSS、JS等资源加载失败无法通过常规脚本错误捕获，脚本通过document.addEventListener在捕获阶段监听，过滤目标资源标签：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 摘自脚本核心代码：资源加载异常捕获</span>
private <span class="hljs-title function_">_monitorResourceError</span>(): <span class="hljs-keyword">void</span> {
  <span class="hljs-keyword">const</span> that = <span class="hljs-variable language_">this</span>;
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>, <span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) {
    <span class="hljs-keyword">const</span> target = event.<span class="hljs-property">target</span> || event.<span class="hljs-property">srcElement</span>;
    <span class="hljs-keyword">if</span> (!(target <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HTMLElement</span>)) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 过滤需要监控的资源标签（script/link/img等）</span>
    <span class="hljs-keyword">const</span> resourceTags = [<span class="hljs-string">'SCRIPT'</span>, <span class="hljs-string">'LINK'</span>, <span class="hljs-string">'IMG'</span>, <span class="hljs-string">'VIDEO'</span>, <span class="hljs-string">'AUDIO'</span>, <span class="hljs-string">'IFRAME'</span>];
    <span class="hljs-keyword">if</span> (!resourceTags.<span class="hljs-title function_">includes</span>(target.<span class="hljs-property">tagName</span>?.<span class="hljs-title function_">toUpperCase</span>() || <span class="hljs-string">''</span>)) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">if</span> (!that.<span class="hljs-title function_">_isNeedSample</span>(<span class="hljs-string">'resource_error'</span>)) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 获取资源URL</span>
    <span class="hljs-keyword">const</span> resourceUrl = (target <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLScriptElement</span> | <span class="hljs-title class_">HTMLImageElement</span>).<span class="hljs-property">src</span> || 
                        (target <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLLinkElement</span>).<span class="hljs-property">href</span> || <span class="hljs-string">''</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-attr">errorInfo</span>: <span class="hljs-title class_">ErrorDetail</span> = {
      <span class="hljs-attr">type</span>: <span class="hljs-string">'resource_error'</span>,
      <span class="hljs-attr">message</span>: <span class="hljs-string">`资源加载失败：<span class="hljs-subst">${resourceUrl}</span>`</span>,
      <span class="hljs-attr">resourceType</span>: target.<span class="hljs-property">tagName</span>?.<span class="hljs-title function_">toLowerCase</span>() || <span class="hljs-string">'unknown'</span>,
      <span class="hljs-attr">resourceUrl</span>: resourceUrl,
      <span class="hljs-attr">source</span>: resourceUrl,
      <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
    };

    that.<span class="hljs-property">cacheManager</span>.<span class="hljs-title function_">saveError</span>(errorInfo, {
      <span class="hljs-attr">projectName</span>: that.<span class="hljs-property">config</span>.<span class="hljs-property">projectName</span>,
      <span class="hljs-attr">environment</span>: that.<span class="hljs-property">environmentInfo</span>,
      <span class="hljs-attr">extra</span>: that.<span class="hljs-property">config</span>.<span class="hljs-property">extraInfo</span>
    }).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> that.<span class="hljs-title function_">_reportError</span>(errorInfo));
  }, <span class="hljs-literal">true</span>); <span class="hljs-comment">// 捕获阶段监听，优先于冒泡阶段，确保不遗漏</span>
}
</code></pre>
<p><strong>面试加分点</strong>：</p>
<ul>
<li>必须在「捕获阶段」监听（第三个参数为true），因为资源加载异常不会冒泡，在冒泡阶段无法捕获；</li>
<li>需过滤资源标签，避免捕获到非资源元素的错误（如div的error事件）。</li>
</ul>
<h4 data-id="heading-6">3. 接口请求异常捕获</h4>
<p>接口报错是业务异常的主要来源，脚本通过重写XMLHttpRequest和Fetch API实现，保留原生功能，注入监控逻辑，区分网络异常与状态码异常：</p>
<pre><code class="hljs language-ini" lang="ini">// 摘自脚本核心代码：重写XMLHttpRequest捕获API异常
private _overrideXMLHttpRequest(): void {
  const <span class="hljs-attr">that</span> = this<span class="hljs-comment">;</span>
  const <span class="hljs-attr">originalXHR</span> = window.XMLHttpRequest<span class="hljs-comment">;</span>

  <span class="hljs-attr">window.XMLHttpRequest</span> = function () {
    const <span class="hljs-attr">xhr</span> = new originalXHR()<span class="hljs-comment">;</span>
    const <span class="hljs-attr">originalOpen</span> = xhr.open<span class="hljs-comment">;</span>
    const <span class="hljs-attr">originalSend</span> = xhr.send<span class="hljs-comment">;</span>
    let <span class="hljs-attr">apiInfo</span> = { method: <span class="hljs-string">'GET'</span>, url: <span class="hljs-string">''</span>, data: null }<span class="hljs-comment">;</span>

    // 记录请求方法和URL
    <span class="hljs-attr">xhr.open</span> = function (method: string, url: string) {
      <span class="hljs-attr">apiInfo.method</span> = method || <span class="hljs-string">'GET'</span><span class="hljs-comment">;</span>
      <span class="hljs-attr">apiInfo.url</span> = url || <span class="hljs-string">''</span><span class="hljs-comment">;</span>
      return originalOpen.apply(this, arguments)<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>

    // 记录请求参数
    <span class="hljs-attr">xhr.send</span> = function (data: any) {
      <span class="hljs-attr">apiInfo.data</span> = data || null<span class="hljs-comment">;</span>
      return originalSend.apply(this, arguments)<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>

    // 监听请求完成
    xhr.addEventListener('readystatechange', function () {
      if (<span class="hljs-attr">xhr.readyState</span> === <span class="hljs-number">4</span>) {
        const <span class="hljs-attr">status</span> = xhr.status<span class="hljs-comment">;</span>
        // 非2xx状态码判定为异常
        if (status &lt; 200 || status &gt;= 300) {
          if (!that._isNeedSample('api_error')) return<span class="hljs-comment">;</span>

          const errorInfo: <span class="hljs-attr">ErrorDetail</span> = {
            type: 'api_error',
            message: `接口请求失败：${apiInfo.url} (状态码：${status})`,
            method: apiInfo.method,
            url: apiInfo.url,
            status: status,
            requestData: apiInfo.data,
            responseText: xhr.responseText || '无响应数据',
            timestamp: Date.now()
          }<span class="hljs-comment">;</span>

          that.cacheManager.saveError(errorInfo, {
            projectName: that.config.projectName,
            environment: that.environmentInfo,
            extra: that.config.extraInfo
          }).then(() =&gt; that._reportError(errorInfo))<span class="hljs-comment">;</span>
        }
      }
    })<span class="hljs-comment">;</span>

    return xhr<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
}
</code></pre>
<p><strong>面试加分点</strong>：</p>
<ul>
<li>重写时需保留原生XMLHttpRequest的所有功能，避免影响业务代码；</li>
<li>不仅要捕获非2xx状态码，还要捕获网络错误（如断网导致的xhr.onerror）；</li>
<li>需记录请求方法、URL、参数、响应数据，便于后续排查问题。</li>
</ul>
<h4 data-id="heading-7">4. **实战优化递进-**监控启动前异常捕获</h4>
<p><strong>实战优化递进</strong>：常规的window.onerror监听，上线后发现大量“启动白屏”相关的异常未被捕获，排查后才意识到是「监控脚本加载晚于页面核心JS」，导致早期报错“漏网”。于是迭代出“种子文件”方案，解决早期异常捕获问题。</p>
<p>这是大厂面试高频难点：监控脚本本身需要加载执行，业务脚本可能先于监控脚本执行，导致启动阶段异常无法捕获。脚本通过「页面顶部预插入内存存储脚本」+「批量处理」解决：</p>
<pre><code class="hljs language-typescript" lang="typescript">&lt;!-- 需插入在页面最顶部<span class="hljs-comment">// 摘自脚本核心代码：处理早期异常</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">_handleEarlyJsErrors</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
  <span class="hljs-keyword">const</span> that = <span class="hljs-variable language_">this</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">async</span> (resolve) =&gt; {
    <span class="hljs-comment">// 无早期异常直接返回</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">window</span>.<span class="hljs-property">__EARLY_JS_ERROR_STORE__</span> || <span class="hljs-variable language_">window</span>.<span class="hljs-property">__EARLY_JS_ERROR_STORE__</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-title function_">resolve</span>();
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> earlyErrors = <span class="hljs-variable language_">window</span>.<span class="hljs-property">__EARLY_JS_ERROR_STORE__</span>;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[ErrorMonitor] 检测到<span class="hljs-subst">${earlyErrors.length}</span>条早期JS异常，开始处理上报`</span>);

    <span class="hljs-comment">// 批量处理早期异常</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> error <span class="hljs-keyword">of</span> earlyErrors) {
      <span class="hljs-keyword">if</span> (!that.<span class="hljs-title function_">_isNeedSample</span>(error.<span class="hljs-property">type</span>)) {
        <span class="hljs-keyword">continue</span>;
      }
      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 保存到缓存，再上报</span>
        <span class="hljs-keyword">await</span> that.<span class="hljs-property">cacheManager</span>.<span class="hljs-title function_">saveError</span>(error, {
          <span class="hljs-attr">projectName</span>: that.<span class="hljs-property">config</span>.<span class="hljs-property">projectName</span>,
          <span class="hljs-attr">environment</span>: that.<span class="hljs-property">environmentInfo</span>,
          <span class="hljs-attr">extra</span>: that.<span class="hljs-property">config</span>.<span class="hljs-property">extraInfo</span>
        });
        that.<span class="hljs-title function_">_reportError</span>(error);
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'[ErrorMonitor] 早期JS异常处理失败'</span>, e);
      }
    }

    <span class="hljs-comment">// 清空存储，释放内存</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">__EARLY_JS_ERROR_STORE__</span> = [];
    <span class="hljs-title function_">resolve</span>();
  });
}
</code></pre>
<p><strong>面试加分点</strong>：</p>
<ul>
<li>核心思路：「内存暂存 + 批量处理」，先将早期异常存在window全局变量中，待监控脚本初始化后再统一处理；</li>
<li>必须将存储脚本插入到页面最顶部，确保早于所有业务脚本执行；</li>
<li>处理完成后清空内存存储，避免内存泄漏。</li>
</ul>
<h3 data-id="heading-8">四、数据处理：兼顾性能与精准，规避无效上报</h3>
<p>捕获异常后，并非直接上报所有数据：高流量场景下，无效上报会拖垮服务端；杂乱数据也会增加排查成本。数据处理的核心是“去重、过滤、富集、采样”，平衡性能与数据价值，对应“高流量项目上报管控”面试考点。</p>
<h4 data-id="heading-9">1. 异常过滤与去重</h4>
<ul>
<li>过滤无效异常：剔除跨域脚本、浏览器插件、调试工具产生的无用报错，减少冗余数据（对应脚本中_ignoreError方法）；</li>
<li>异常去重：基于错误信息、错误栈、页面URL生成唯一标识（如MD5哈希），避免同一异常重复上报（如用户反复刷新触发的同一报错），降低服务端压力。</li>
</ul>
<h4 data-id="heading-10">2. 数据富集：提升排查效率</h4>
<p>单纯的错误信息不足以定位问题，需补充上下文数据，让异常“可溯源”——这是面试中区分“基础选手”与“实战选手”的关键：</p>
<ul>
<li>环境信息：浏览器版本、设备型号、系统版本、屏幕分辨率；</li>
<li>用户信息：用户ID、登录状态（非敏感信息），便于定位特定用户的问题；</li>
<li>页面信息：当前URL、路由路径、页面加载时间；</li>
<li>业务信息：请求参数、操作路径（如用户点击了哪个按钮触发报错），关联业务场景。</li>
</ul>
<p>脚本中通过cacheManager.saveError方法，自动将上述信息与异常数据关联，上报时一并提交。</p>
<h4 data-id="heading-11">3. 双层采样控制：适配高流量场景</h4>
<p>高并发项目中，100%上报会导致服务端过载，脚本支持“全局采样+按类型采样”，精细化管控上报流量，这是高流量场景监控的核心优化：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 摘自脚本核心代码：采样判断逻辑</span>
<span class="hljs-comment">// 1. 校验采样配置（容错处理）</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">_validateSampleConfig</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">const</span> { sampleRate, sampleRules } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>;
  <span class="hljs-comment">// 全局采样率边界校验：0-1之间</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> sampleRate !== <span class="hljs-string">'number'</span> || sampleRate &lt; <span class="hljs-number">0</span> || sampleRate &gt; <span class="hljs-number">1</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>.<span class="hljs-property">sampleRate</span> = <span class="hljs-number">1</span>;
  }
  <span class="hljs-comment">// 按类型采样率边界校验</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(sampleRules).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">errorType</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> rate = sampleRules[errorType];
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> rate !== <span class="hljs-string">'number'</span> || rate &lt; <span class="hljs-number">0</span> || rate &gt; <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">delete</span> sampleRules[errorType];
    }
  });
}

<span class="hljs-comment">// 2. 采样判断核心方法</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">_isNeedSample</span>(<span class="hljs-attr">errorType</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">boolean</span> {
  <span class="hljs-keyword">const</span> { sampleRate, sampleRules } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">config</span>;
  <span class="hljs-comment">// 类型采样优先级高于全局采样</span>
  <span class="hljs-keyword">const</span> targetRate = sampleRules[errorType] ?? sampleRate;
  <span class="hljs-keyword">if</span> (targetRate === <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 100%上报</span>
  <span class="hljs-keyword">if</span> (targetRate === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 不上报</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &lt; targetRate; <span class="hljs-comment">// 随机采样</span>
}
</code></pre>
<p><strong>面试加分点</strong>：</p>
<ul>
<li>采样优先级：按异常类型采样 ＞ 全局采样，可对关键异常（如JS执行异常）配置100%上报，对非关键异常（如图片加载失败）配置低采样率；</li>
<li>容错处理：自动校验采样率范围（0-1），非法配置自动重置为100%上报，避免配置错误导致采样失效；</li>
<li>无状态实现：基于Math.random()实现采样，无需额外存储状态，性能开销极低。</li>
</ul>
<p><strong>实战优化递进</strong>：全局100%上报高峰期服务端接口被打爆，出现大量上报超时，反而导致更多异常数据丢失。之后尝试全局固定采样（如50%采样），但又出现“致命异常被采样过滤”的问题，影响线上问题定位。最终迭代出“分层采样”策略，既控制了服务端压力，又保证了关键异常不丢失。</p>
<h3 data-id="heading-12">五、可靠上报：确保数据不丢失，兼顾稳定性</h3>
<p>捕获并处理好的异常数据，需可靠上报至服务端——断网、接口报错、上报时机不当，都可能导致数据丢失。可靠上报的核心是“选对方案、做好兜底、控制频率”，对应“断网场景异常不丢失”面试考点。</p>
<h4 data-id="heading-13">1. 上报方案选型：放弃sendBeacon，优选XHR</h4>
<p>面试高频考点：对比sendBeacon与XHR的差异，说明选型逻辑，脚本最终选用XHR方案，兼顾可靠性与可控性：</p>
<ul>
<li>放弃sendBeacon：无状态、无法重试、有体积限制，断网或接口报错时数据直接丢失，不适用于核心监控场景；</li>
<li>优选XHR：状态可控、支持重试、可自定义请求头，能灵活处理上报失败的情况，可控性拉满。</li>
</ul>
<p><strong>实战优化递进</strong>：上报方案的选择，经历“尝试-踩坑-迭代”的完整过程。最初优先选用sendBeacon，核心考虑是它能在页面卸载时仍完成上报，无需手动处理页面关闭场景，看似能保证上报成功，其实返回true只代表进入队列，并不证明上报成功。sendBeacon的「无反馈」特性是致命缺陷——无法判断上报是否成功，断网、服务端过载时，异常数据会直接丢失，且无法重试。为了解决这个问题，我们改用XHR方案，搭配缓存+重试机制，形成完整上报闭环。</p>
<p>注意：这里如果是面试不要说太死，毕竟也有一些大厂在有限选中sendBeacon上报</p>
<h4 data-id="heading-14">2. 双存储缓存 + 指数退避重试：兜底断网场景</h4>
<p>脚本通过“双存储缓存”解决断网数据丢失问题，通过“指数退避重试”避免重试压垮服务端，是可靠上报的核心实现：</p>
<h5 data-id="heading-15">（1）双存储缓存：IndexedDB 优先 + localStorage 降级</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 核心设计思路（对应脚本缓存模块）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorCacheManager</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">projectName</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">maxCacheCount</span>: <span class="hljs-built_in">number</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">options: { projectName: <span class="hljs-built_in">string</span>; maxCacheCount: <span class="hljs-built_in">number</span> }</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">projectName</span> = options.<span class="hljs-property">projectName</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">maxCacheCount</span> = options.<span class="hljs-property">maxCacheCount</span>;
  }

  <span class="hljs-comment">// 保存异常：优先IndexedDB，降级localStorage</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">saveError</span>(<span class="hljs-params">error: ErrorDetail, extra: <span class="hljs-built_in">any</span></span>) {
    <span class="hljs-keyword">const</span> cacheItem = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">formatCacheItem</span>(error, extra);
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 判断是否支持IndexedDB</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">supportIndexedDB</span>()) {
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">saveToIndexedDB</span>(cacheItem);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">saveToLocalStorage</span>(cacheItem);
      }
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'保存异常缓存失败'</span>, e);
    }
  }

  <span class="hljs-comment">// 判断IndexedDB支持性</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">supportIndexedDB</span>(): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-keyword">return</span> !!<span class="hljs-variable language_">window</span>.<span class="hljs-property">indexedDB</span>;
  }

  <span class="hljs-comment">// 获取所有缓存异常</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getCacheErrors</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">CacheItem</span>[]&gt; {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">supportIndexedDB</span>()) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getFromIndexedDB</span>();
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getFromLocalStorage</span>();
    }
  }

  <span class="hljs-comment">// 其他方法：删除异常、销毁缓存...</span>
}
</code></pre>
<h5 data-id="heading-16">（2）指数退避重试：智能控制重试频率</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 摘自脚本核心代码：指数退避重试逻辑</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">_retryReport</span>(
  <span class="hljs-attr">reportDataStr</span>: <span class="hljs-built_in">string</span>,
  <span class="hljs-attr">errorDetail</span>: <span class="hljs-title class_">ErrorDetail</span>,
  <span class="hljs-attr">currentRetry</span>: <span class="hljs-built_in">number</span>,
  errorId = <span class="hljs-string">''</span>,
  callback?: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>
): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">const</span> that = <span class="hljs-variable language_">this</span>;
  <span class="hljs-comment">// 超出最大重试次数，放弃上报</span>
  <span class="hljs-keyword">if</span> (currentRetry &gt;= that.<span class="hljs-property">config</span>.<span class="hljs-property">retryCount</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[ErrorMonitor] 异常上报超出最大重试次数（<span class="hljs-subst">${that.config.retryCount}</span>次），放弃上报（已缓存）`</span>, errorDetail);
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> callback === <span class="hljs-string">'function'</span>) <span class="hljs-title function_">callback</span>();
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 指数级延迟重试：1s、2s、4s...（避免频繁重试）</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[ErrorMonitor] 异常上报第<span class="hljs-subst">${currentRetry + <span class="hljs-number">1</span>}</span>次重试`</span>, errorDetail);
    that.<span class="hljs-title function_">_reportByXHR</span>(reportDataStr, errorDetail, currentRetry + <span class="hljs-number">1</span>, errorId, callback);
  }, <span class="hljs-number">1000</span> * (currentRetry + <span class="hljs-number">1</span>));
}
</code></pre>
<p><strong>面试加分点</strong>：</p>
<ul>
<li>双存储优势：IndexedDB无5MB容量限制，支持异步存取，适合存储大量异常；localStorage兼容性更好，作为兜底方案；</li>
<li>重试策略：采用「指数退避」，而非固定延迟，既提升上报成功率，又避免给服务端造成额外压力；</li>
<li>兜底逻辑：监控初始化时，优先上报历史缓存异常，上报成功后删除对应缓存，避免重复上报。</li>
</ul>
<h4 data-id="heading-17">3. 上报频率控制</h4>
<p>避免频繁上报：采用防抖（如300ms内的异常批量上报）或节流策略，减少请求次数；同时限制单用户、单页面的上报频率，防止恶意上报或异常风暴。</p>
<h3 data-id="heading-18">六、功能扩展：适配复杂场景，体现技术深度</h3>
<p>基础的监控功能只能满足简单项目需求，复杂场景（单页应用、多框架项目、白屏监控）的扩展能力，是面试中的核心加分项，也是业务落地的关键。</p>
<h4 data-id="heading-19">1. 单页应用适配：完善的销毁机制，避免内存泄漏</h4>
<p>单页应用路由切换时，若监控实例未销毁，会导致事件监听重复绑定，引发内存泄漏和异常重复上报，脚本提供destroy方法完美解决，对应“单页应用内存泄漏”面试考点：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 摘自脚本核心代码：销毁监控实例</span>
<span class="hljs-keyword">public</span> <span class="hljs-title function_">destroy</span>(): <span class="hljs-built_in">void</span> {
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">isInit</span>) <span class="hljs-keyword">return</span>;

  <span class="hljs-comment">// 1. 销毁缓存管理器，关闭数据库连接</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">cacheManager</span>.<span class="hljs-title function_">destroy</span>();

  <span class="hljs-comment">// 2. 重置全局事件监听，避免内存泄漏</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">onerror</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'unhandledrejection'</span>, <span class="hljs-function">() =&gt;</span> {});
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">() =&gt;</span> {}, <span class="hljs-literal">true</span>);

  <span class="hljs-comment">// 3. 清空早期异常存储，释放内存</span>
  <span class="hljs-keyword">declare</span> <span class="hljs-variable language_">global</span> {
    <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Window</span> {
      <span class="hljs-attr">__EARLY_JS_ERROR_STORE__</span>: <span class="hljs-title class_">EarlyJsError</span>[];
    }
  }
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">__EARLY_JS_ERROR_STORE__</span>) {
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">__EARLY_JS_ERROR_STORE__</span> = [];
  }

  <span class="hljs-comment">// 4. 重置初始化状态</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">isInit</span> = <span class="hljs-literal">false</span>;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[ErrorMonitor] <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.config.projectName}</span> 异常监控已销毁`</span>);
}
</code></pre>
<p><strong>面试加分点</strong>：</p>
<ul>
<li>销毁时需清理三类资源：缓存管理器资源、全局事件监听、内存存储数据；</li>
<li>幂等设计：先判断isInit状态，避免重复销毁导致的错误；</li>
<li>使用场景：单页应用中，需在路由切换前调用destroy方法，销毁旧的监控实例。</li>
</ul>
<p><strong>实战优化递进</strong>：初期做单页应用监控时，我们忽略了路由切换的场景，上线后发现页面切换次数越多，内存占用越高，最终导致部分低端设备页面崩溃。排查后定位到是「监控事件监听未清理」——每次路由切换，监控脚本会重新绑定onerror、unhandledrejection等全局事件，旧的监听未销毁，导致内存泄漏。后续迭代时，新增destroy方法，彻底解决了该问题。</p>
<h4 data-id="heading-20">2. 多框架适配</h4>
<p>不同前端框架的异常捕获有专属方案，脚本可结合框架特性优化捕获能力，体现框架熟练度，适配多项目落地：</p>
<h5 data-id="heading-21">（1）Vue项目适配</h5>
<pre><code class="hljs language-php" lang="php">import Vue <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
import { initErrorMonitor } <span class="hljs-keyword">from</span> <span class="hljs-string">'frontend-error-monitor-ts'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">errorMonitor</span> = <span class="hljs-title function_ invoke__">initErrorMonitor</span>({
  <span class="hljs-attr">reportUrl</span>: <span class="hljs-string">'https://你的服务端接口/error/report'</span>,
  <span class="hljs-attr">projectName</span>: <span class="hljs-string">'vue-project'</span>
});

<span class="hljs-comment">// 捕获Vue组件内部异常，补充组件上下文信息</span>
Vue.config.errorHandler = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, vm, info</span>) </span>{
  errorMonitor?.<span class="hljs-title function_ invoke__">manualReport</span>({
    <span class="hljs-attr">message</span>: err.message,
    <span class="hljs-attr">stack</span>: err.stack,
    <span class="hljs-attr">component</span>: vm?.<span class="hljs-variable">$options</span>?.name || <span class="hljs-string">'未知组件'</span>,
    <span class="hljs-attr">info</span>: info // 异常发生的生命周期钩子
  }, <span class="hljs-string">'vue_component_error'</span>);
};
</code></pre>
<h5 data-id="heading-22">（2）React项目适配</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { <span class="hljs-title class_">Component</span>, <span class="hljs-title class_">ErrorInfo</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { initErrorMonitor } <span class="hljs-keyword">from</span> <span class="hljs-string">'frontend-error-monitor-ts'</span>;

<span class="hljs-keyword">const</span> errorMonitor = <span class="hljs-title function_">initErrorMonitor</span>({
  <span class="hljs-attr">reportUrl</span>: <span class="hljs-string">'https://你的服务端接口/error/report'</span>,
  <span class="hljs-attr">projectName</span>: <span class="hljs-string">'react-project'</span>
});

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorBoundary</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Component</span> {
  <span class="hljs-title function_">componentDidCatch</span>(<span class="hljs-params">error: <span class="hljs-built_in">Error</span>, errorInfo: ErrorInfo</span>) {
    errorMonitor?.<span class="hljs-title function_">manualReport</span>({
      <span class="hljs-attr">message</span>: error.<span class="hljs-property">message</span>,
      <span class="hljs-attr">stack</span>: error.<span class="hljs-property">stack</span>,
      <span class="hljs-attr">errorInfo</span>: errorInfo.<span class="hljs-property">componentStack</span>
    }, <span class="hljs-string">'react_component_error'</span>);
  }

  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">props</span>.<span class="hljs-property">children</span>;
  }
}

<span class="hljs-comment">// 使用：包裹根组件或需要监控的组件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">ErrorBoundary</span>;
</code></pre>
<h4 data-id="heading-23">3. 白屏监控：补充视觉层面异常</h4>
<p>白屏是用户可感知的严重异常，但无法通过常规脚本错误捕获，脚本可扩展白屏监控能力，完善异常覆盖场景：</p>
<ul>
<li>DOM节点检测：定时器判断页面核心节点（如body下的内容节点）是否渲染，超时未渲染则判定为白屏；</li>
<li>结合性能指标：关联首屏加载时间（FCP），若FCP超时且无核心节点渲染，触发白屏异常上报。</li>
</ul>
<h4 data-id="heading-24">4. 告警与复盘闭环</h4>
<p>监控的最终价值是“解决问题”，需扩展告警与复盘能力，形成完整闭环，体现业务思维：</p>
<ul>
<li>分级告警：致命异常（页面崩溃、核心接口报错）立即触发短信/企业微信告警，轻微异常定期汇总；</li>
<li>复盘沉淀：记录异常修复过程、根因分析，形成监控优化方案，迭代监控规则（如新增高频异常的过滤规则）。</li>
</ul>
<h3 data-id="heading-25">七、落地实战：5分钟接入，直接用在你的项目中</h3>
<p>这款脚本接入简单，支持工程化项目和静态页面，无需复杂配置，5分钟即可完成落地，兼顾开发效率与实用性。</p>
<h4 data-id="heading-26">1. 安装依赖（工程化项目推荐）</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># npm</span>
npm install frontend-error-monitor-ts --save

<span class="hljs-meta"># yarn</span>
yarn <span class="hljs-keyword">add</span> frontend-error-monitor-ts

<span class="hljs-meta"># pnpm</span>
pnpm <span class="hljs-keyword">add</span> frontend-error-monitor-ts
</code></pre>
<h4 data-id="heading-27">2. 初始化配置</h4>
<pre><code class="hljs language-ruby" lang="ruby">import { initErrorMonitor } from <span class="hljs-string">'frontend-error-monitor-ts'</span>;

<span class="hljs-regexp">//</span> 最简初始化（满足大部分项目需求）
const errorMonitor = initErrorMonitor({
  <span class="hljs-symbol">reportUrl:</span> <span class="hljs-string">'https://你的服务端接口/error/report'</span>, <span class="hljs-regexp">//</span> 必填：异常上报接口
  <span class="hljs-symbol">projectName:</span> <span class="hljs-string">'你的项目名称'</span> /<span class="hljs-regexp">/ 必填：多项目隔离标识
});

/</span><span class="hljs-regexp">/ 完整初始化（自定义配置，对应脚本亮点）
/</span><span class="hljs-regexp">/ const errorMonitor = initErrorMonitor({
/</span><span class="hljs-regexp">/   reportUrl: 'https:/</span><span class="hljs-regexp">/你的服务端接口/error</span><span class="hljs-regexp">/report',
/</span><span class="hljs-regexp">/   projectName: '你的项目名称',
/</span><span class="hljs-regexp">/   enableJsError: true, /</span><span class="hljs-regexp">/ 启用JS异常监控
/</span><span class="hljs-regexp">/   enableResourceError: true, /</span><span class="hljs-regexp">/ 启用资源异常监控
/</span><span class="hljs-regexp">/   enableApiError: true, /</span><span class="hljs-regexp">/ 启用API异常监控
/</span><span class="hljs-regexp">/   timeout: 5000, /</span><span class="hljs-regexp">/ 上报超时时间
/</span><span class="hljs-regexp">/   retryCount: 2, /</span><span class="hljs-regexp">/ 最大重试次数
/</span><span class="hljs-regexp">/   sampleRate: 0.8, /</span><span class="hljs-regexp">/ 全局采样率
/</span><span class="hljs-regexp">/   sampleRules: { /</span><span class="hljs-regexp">/ 按类型采样率
/</span><span class="hljs-regexp">/     js_error: 1, /</span><span class="hljs-regexp">/ JS异常100%上报
/</span><span class="hljs-regexp">/     resource_error: 0.5 /</span><span class="hljs-regexp">/ 资源异常50%上报
/</span><span class="hljs-regexp">/   },
/</span><span class="hljs-regexp">/   extraInfo: { /</span><span class="hljs-regexp">/ 自定义额外信息（如用户ID、版本号）
/</span><span class="hljs-regexp">/     userId: localStorage.getItem('userId'),
/</span><span class="hljs-regexp">/     appVersion: '1.0.0'
/</span><span class="hljs-regexp">/   },
/</span><span class="hljs-regexp">/  ignoreError: ()=&gt;{return true}  按需忽略某些js错误
/</span><span class="hljs-regexp">/  ignoreApi: ()=&gt;true 接口错误
/</span><span class="hljs-regexp">/  ignoreResource: ()=&gt;true /</span><span class="hljs-regexp">/ 资源错误
/</span><span class="hljs-regexp">/ });
</span></code></pre>
<h4 data-id="heading-28">3. 早期异常捕获配置（可选，推荐添加）</h4>
<p>在页面最顶部中插入早期异常存储脚本，确保早于所有业务脚本执行（前文已给出完整代码，此处省略）。</p>
<h4 data-id="heading-29">4. 常用API使用</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 1. 手动上报异常（捕获try/catch中的自定义异常）</span>
errorMonitor?.<span class="hljs-built_in">manualReport</span>(<span class="hljs-string">'用户提交表单失败'</span>, <span class="hljs-string">'business_error'</span>);
<span class="hljs-comment">// 紧急异常：不缓存、忽略采样，强制上报</span>
errorMonitor?.<span class="hljs-built_in">manualReport</span>(<span class="hljs-string">'系统级异常'</span>, <span class="hljs-string">'system_error'</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);

<span class="hljs-comment">// 2. 销毁监控实例（单页应用路由切换时）</span>
<span class="hljs-comment">// errorMonitor?.destroy();</span>
</code></pre>
<h3 data-id="heading-30">八、性能优化：让监控脚本“隐形”运行</h3>
<p>监控脚本的性能优化是项目落地的关键，也是面试中“性能优化”考点的延伸。脚本从5个维度做了极致优化，确保对业务性能的影响可忽略不计：</p>
<ol>
<li><strong>体积优化</strong>：轻量无依赖，打包后＜10KB，开启gzip/brotli压缩后传输体积低至3KB左右，不影响首屏加载；</li>
<li><strong>执行性能优化</strong>：异步执行缓存、上报操作，不阻塞主线程；批量处理早期异常和缓存异常，减少性能开销；</li>
<li><strong>内存优化</strong>：及时清空内存存储，限制缓存上限，destroy方法彻底清理资源，避免内存泄漏；</li>
<li><strong>网络优化</strong>：批量上报、采样控制减少请求数量，按需上报减少请求体体积，配置超时时间避免无效连接；</li>
<li><strong>事件监听优化</strong>：捕获阶段监听提升效率，单一监听避免重复绑定，可销毁设计适配单页应用。</li>
</ol>
<h3 data-id="heading-31">九、最佳实践：让异常监控发挥最大价值</h3>
<h4 data-id="heading-32">1. 异常数据丰富化</h4>
<p>补充业务、页面、上下文信息，让异常可溯源，示例配置如下：</p>
<pre><code class="hljs language-css" lang="css">initErrorMonitor({
  // 其他配置...
  extraInfo: {
    userId: localStorage.<span class="hljs-built_in">getItem</span>(<span class="hljs-string">'userId'</span>) || <span class="hljs-string">'匿名用户'</span>,
    appVersion: process.env.VUE_APP_VERSION || <span class="hljs-string">'1.0.0'</span>,
    env: process.env.VUE_APP_ENV || <span class="hljs-string">'production'</span>,
    deviceId: localStorage.<span class="hljs-built_in">getItem</span>(<span class="hljs-string">'deviceId'</span>) || <span class="hljs-built_in">uuid</span>() // 自定义设备ID
  }
});
</code></pre>
<h4 data-id="heading-33">2. 异常分级处理</h4>
<p>按严重程度分级，优先处理核心异常，通过采样规则配置实现：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-built_in">initErrorMonitor</span>({
  <span class="hljs-comment">// 其他配置...</span>
  sampleRules: {
    js_error: <span class="hljs-number">1</span>, <span class="hljs-comment">// 一级（致命）：100%上报</span>
    api_error: <span class="hljs-number">0.8</span>, <span class="hljs-comment">// 二级（严重）：80%上报</span>
    resource_error: <span class="hljs-number">0.2</span> <span class="hljs-comment">// 三级（轻微）：20%上报</span>
  }
});
</code></pre>
<h4 data-id="heading-34">3. 前端&amp;服务端联动</h4>
<p>形成“捕获-上报-告警-排查-修复-复盘”闭环：前端负责捕获与可靠上报，服务端负责存储与告警，研发负责排查修复，定期复盘优化监控策略。</p>
<h4 data-id="heading-35">4. 灰度发布&amp;监控</h4>
<p>脚本升级或配置变更时，先对10%用户灰度验证，观察异常数据无异常后，再逐步扩大范围，降低线上风险。</p>
<h3 data-id="heading-36">十、脚本扩展</h3>
<p><strong>作为异常监控脚本，一般还需要包含以下功能</strong>(不是本文章重点内容，感兴趣自行了解)</p>
<ol>
<li>PV、UV上报</li>
<li>性能指标统计与上报</li>
</ol>
<h3 data-id="heading-37">十一、总结：面试与实战的核心共识</h3>
<p>前端异常监控的核心，是“精准捕获、高效处理、可靠上报、灵活扩展”。这款TypeScript脚本不仅能直接落地到项目中，解决线上稳定性问题，更能精准覆盖大厂面试高频考点，帮你打造面试竞争力。</p>
<p>对于面试而言，无需堆砌API，重点突出“盲区解决方案”（早期异常、单页内存泄漏）、“性能优化思路”（分层采样、批量上报）、“业务价值关联”（数据富集、闭环复盘）——这些才是面试官真正关注的难点与亮点。</p>
<p>对于业务落地而言，监控不是“越多越好”，而是“精准有用”：兼顾性能与可靠性，让异常数据能快速定位问题、优化用户体验，才是监控的最终意义。吃透本文内容，既能从容应对大厂面试，也能快速落地生产级前端异常监控方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Expo React Native + EAS 本地/云端实战真实构建避坑指南]]></title>    <link>https://juejin.cn/post/7600964907488608262</link>    <guid>https://juejin.cn/post/7600964907488608262</guid>    <pubDate>2026-01-30T08:39:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600964907488608262" data-draft-id="7600888960105725988" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Expo React Native + EAS 本地/云端实战真实构建避坑指南"/> <meta itemprop="keywords" content="前端,React Native"/> <meta itemprop="datePublished" content="2026-01-30T08:39:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ArkPppp"/> <meta itemprop="url" content="https://juejin.cn/user/4484239094198752"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Expo React Native + EAS 本地/云端实战真实构建避坑指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4484239094198752/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ArkPppp
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T08:39:30.000Z" title="Fri Jan 30 2026 08:39:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Expo React Native + EAS 本地/云端构建避坑指南 (Windows/Android篇)</h2>
<p><strong>编者注:</strong> 本人与Gemini3,ChatGPT5,Minimax2.1共同奋战6h血泪总结，战绩可查，希望能帮助到正在做RN开发的同学！</p>
<blockquote>
<p>在 React Native (特别是 Expo) 开发中，<strong>版本依赖一致性</strong>和<strong>网络连通性</strong>是最大的拦路虎。报错时，我们一定要先看环境和配置，最后再怀疑代码。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95f770826bd14bb7a1a6b00572a38e70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXJrUHBwcA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770367174&amp;x-signature=RC3ffg%2F8FpVHhILBuq6PZITR%2FVk%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/602e6784981c4325bead44117fc7f08c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQXJrUHBwcA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770367174&amp;x-signature=nk385t0BnrY1q2nIi7LJvrTTpdg%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-1">一、善用 Expo CLI 和 Doctor (版本对齐是生命线)</h3>
<p>很多编译错误（如 NDK 版本不匹配、Kotlin 版本过低、Reanimated 编译失败）的根源，都是因为我们安装的依赖版本和 Expo SDK 不兼容。</p>
<h4 data-id="heading-2">1. 永远不要手动 npm install 原生库</h4>
<p><strong>错误做法</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">npm install react-native-reanimated`
</code></pre>
<p><strong>正确做法</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">npx expo install react-native-reanimated
</code></pre>
<p><strong>原因</strong>：
<code>npx expo install</code> 会自动查找当前 Expo SDK 版本（如 SDK 52）对应的、经过验证的依赖版本。手动安装容易装上最新的（尚未适配的）版本，导致Gradle编译时疯狂窜稀。</p>
<h4 data-id="heading-3">2. 构建前必须运行npx expo-doctor</h4>
<p>在开始折腾编译相关的事情前，先运行：</p>
<pre><code class="hljs language-bash" lang="bash">npx expo-doctor
</code></pre>
<p><code>expo-doctor</code>
<strong>关注点</strong>：</p>
<ul>
<li><strong>Check dependencies for packages that should match Expo SDK</strong>：如果有红叉，必须修。</li>
<li><strong>React Native Version</strong>：确保 RN 版本完全符合 Expo 要求。</li>
</ul>
<p><strong>解决方法:</strong>
在Expo项目的根目录下执行:</p>
<pre><code class="hljs language-bash" lang="bash">npx expo install --check
</code></pre>
<p>直到命令行提示<code>17/17 checks passed. No issues detected!</code>为止，说明彻底解决了Expo依赖可能导致的问题。</p>
<h3 data-id="heading-4">二、依赖管理：无条件锁死你的依赖</h3>
<h4 data-id="heading-5">1. 必须提交 Lock 文件</h4>
<p>EAS Build (云端) 和本地构建都严格依赖 <code>yarn.lock</code>。</p>
<ul>
<li><strong>切忌</strong>：本地删了 lock 文件跑通了，却不提交 lock 文件。</li>
<li><strong>后果</strong>：云端构建时会根据 <code>package.json</code> 拉取最新小版本，导致云端和本地环境不一致。</li>
<li><strong>操作建议</strong>：考虑到EAS Build使用<code>yarn</code>作为默认的包管理工具，强烈建议Expo项目保持一致，同样使用<code>yarn install</code>管理依赖，记得<code>git add yarn.lock -f</code>添加到代码仓库。</li>
</ul>
<h4 data-id="heading-6">2. 清理缓存的“三板斧”</h4>
<p>当你感觉环境脏了（改了 NDK、换了源但没生效），按顺序执行：</p>
<ol>
<li><strong>项目级清理</strong>：<code>cd android &amp;&amp; ./gradlew clean</code> (最重要，必须做)</li>
<li><strong>依赖清理</strong>：<code>rm -rf node_modules</code> (Windows下手动删)</li>
<li><strong>构建缓存</strong>：如果改了 <code>init.gradle</code>，建议重启终端。</li>
</ol>
<hr/>
<h3 data-id="heading-7">三、关键配置文件 (<code>app.json</code> &amp; <code>eas.json</code>)</h3>
<h4 data-id="heading-8">app.json (核心配置)</h4>
<p>不要把原生代码里的修改（如 AndroidManifest.xml）写死在 <code>android</code> 文件夹里（Prebuild 模式下会被覆盖），而是用 Config Plugin。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"expo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MyApp"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"android"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"package"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"com.company.myapp"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"versionCode"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"plugins"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-comment">// 在这里配置原生插件，保证每次 prebuild 都能生成正确的原生代码</span>
      <span class="hljs-string">"expo-router"</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-9">eas.json (构建配置)</h4>
<p>本地构建（Local Build）是调试神器。</p>
<p>同时<strong>强烈建议写死<code>node</code>版本号</strong>：</p>
<p>本人使用<code>EAS Build</code>编译时发现未设置Node版本号可能导致意外的编译失败。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"build"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"development"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"developmentClient"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"distribution"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"internal"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"production"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"node"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"22.15.1"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"android"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"buildType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"app-bundle"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>调试命令</strong>：<code>eas build --platform android --profile development --local</code></p>
<hr/>
<h3 data-id="heading-10">四、Android 环境配置 (Windows本地编译必读)</h3>
<p>这是作者踩坑报错最多的地方。</p>
<h4 data-id="heading-11">1. local.properties (路标)</h4>
<p>确保 <code>android/local.properties</code> 存在，且路径写法正确（Windows下转义冒号和反斜杠）。</p>
<p><strong>推荐配置（最好全都写清楚）</strong>：</p>
<pre><code class="hljs language-properties" lang="properties">sdk.dir=D\:\\dev\\Android\\Sdk
ndk.dir=\\path\\to\\ndk
cmake.dir=\\path\\to\\cmake
# 除非特定版本死活找不到，否则尽量写清楚
</code></pre>
<h4 data-id="heading-12">2. NDK 版本管理 (重灾区)</h4>
<p>Gradle 报错 <code>NDK version defined in... disagrees with...</code> 时：</p>
<ul>
<li><strong>方案 A (推荐)</strong>：修改 <code>android/build.gradle</code> 中的 <code>ndkVersion</code>，改成你电脑上<strong>实际已安装</strong>的版本（如 <code>27.3.13750724</code>）。</li>
<li><strong>方案 B (保守)</strong>：去 Android Studio SDK Manager 下载报错信息中要求的精确版本（如 <code>27.1.12297006</code>）。</li>
</ul>
<h4 data-id="heading-13">3. CMake</h4>
<p>通常不需要手动配置，但如果报错 <code>CMake not found</code>，在 SDK Manager 里安装 <code>CMake 3.22.1</code> 即可。</p>
<h3 data-id="heading-14">五、Gradle 网络救灾指南 (中国区特供)</h3>
<p>即便配置了阿里云镜像，依然可能因为 <strong>Gradle Wrapper 下载</strong>、<strong>插件依赖</strong>、<strong>特殊 aar 包</strong> 而失败。</p>
<h4 data-id="heading-15">1. 终极 <code>init.gradle</code> (全局镜像)</h4>
<p>不要在每个项目里改 <code>build.gradle</code>，直接在 <code>USER_HOME/.gradle/init.d/init.gradle</code> (gradle所在目录下) 放置此脚本。</p>
<p><strong>核心逻辑</strong>：不是 <code>remove</code>（会报错），而是 <code>setUrl</code>（劫持替换）。</p>
<pre><code class="hljs language-groovy" lang="groovy">def ALIYUN_PUBLIC = 'https://maven.aliyun.com/repository/public'
def ALIYUN_GOOGLE = 'https://maven.aliyun.com/repository/google'
def ALIYUN_PLUGIN = 'https://maven.aliyun.com/repository/gradle-plugin'

def replaceRepositoryUrl = { repo -&gt;
    if (repo instanceof MavenArtifactRepository) {
        def url = repo.url.toString()
        if (url.contains('dl.google.com') || url.contains('android/maven2')) {
            repo.setUrl(ALIYUN_GOOGLE)
        } else if (url.contains('repo1.maven.org') || url.contains('jcenter')) {
            repo.setUrl(ALIYUN_PUBLIC)
        } else if (url.contains('plugins.gradle.org')) {
            repo.setUrl(ALIYUN_PLUGIN)
        }
    }
}

allprojects {
    buildscript { repositories { all { replaceRepositoryUrl(it) } } }
    repositories { all { replaceRepositoryUrl(it) } }
}
gradle.settingsEvaluated { settings -&gt;
    settings.pluginManagement { repositories { all { replaceRepositoryUrl(it) } } }
}
</code></pre>
<h4 data-id="heading-16">2. 只有镜像是不够的：HTTP 代理</h4>
<p>阿里云镜像无法覆盖 100% 的 Google 资源（尤其是最新的 NDK 或某些冷门库）。
<strong>必须配置 Gradle 走本地代理</strong>。
强烈建议全程挂载相关的<strong>网络工具</strong>并开启<strong>全局代理</strong>。（原因是部分网络工具可能不支持JDK SSL协议）</p>
<p>修改 <code>android/gradle.properties</code> (或全局 <code>.gradle/gradle.properties</code>)：</p>
<pre><code class="hljs language-properties" lang="properties"># 假设你的网络工具已经打开了HTTP/HTTPS代理，假设端口是 7890
systemProp.http.proxyHost=127.0.0.1
systemProp.http.proxyPort=7890
systemProp.https.proxyHost=127.0.0.1
systemProp.https.proxyPort=7890
</code></pre>
<h3 data-id="heading-17">六、日志分析心法</h3>
<p>当构建失败（BUILD FAILED）时，不要慌，按以下顺序看日志：</p>
<ol>
<li><strong>看最下面</strong>：<code>FAILURE: Build failed with an exception.</code></li>
<li><strong>找 What went wrong</strong>：
<ul>
<li>如果是 <code>Could not resolve ...</code> -&gt; <strong>网络问题</strong>（检查代理、镜像）。</li>
<li>如果是 <code>NDK version ... disagrees</code> -&gt; <strong>版本不匹配</strong>（改 build.gradle）。</li>
<li>如果是 <code>No signature of method: remove()</code> -&gt; <strong>Gradle脚本写错</strong>（不要删集合，要改属性）。</li>
<li>如果是 <code>Task :app:compileReleaseJavaWithJavac failed</code> -&gt; <strong>代码语法错误</strong>（检查 RN 代码）。</li>
</ul>
</li>
<li><strong>看 Caused by</strong>：通常藏在堆栈中间，特别是 <code>SSLHandshakeException</code> (被墙) 或 <code>EOFException</code> (网络中断)。</li>
</ol>
<h3 data-id="heading-18">七、总结</h3>
<p>想要在 Windows 上顺畅开发 React Native Android：</p>
<ol>
<li><strong>网络是爹</strong>：准备好魔法，Gradle 配好镜像。</li>
<li><strong>环境是妈</strong>：Expo Doctor 没病再开工。</li>
<li><strong>配置是命</strong>：NDK 版本要对齐，<code>local.properties</code> 路径要对。</li>
</ol>
<p>祝各位开发老师编译顺利!</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3 中的 Teleport 是什么，有哪些应用场景？]]></title>    <link>https://juejin.cn/post/7600755567486926900</link>    <guid>https://juejin.cn/post/7600755567486926900</guid>    <pubDate>2026-01-30T08:50:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600755567486926900" data-draft-id="7600957412128522255" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3 中的 Teleport 是什么，有哪些应用场景？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-30T08:50:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户3905133219288"/> <meta itemprop="url" content="https://juejin.cn/user/3609051079121550"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3 中的 Teleport 是什么，有哪些应用场景？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3609051079121550/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户3905133219288
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T08:50:35.000Z" title="Fri Jan 30 2026 08:50:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>简单来说，<strong>Teleport 是一个内置组件</strong>。它允许你将一段模板内容“传送”到当前组件 DOM 结构之外的一个指定位置去渲染。</p>
<p>但它<strong>不是真的移动 DOM 元素</strong>，而是在 Vue 的虚拟 DOM 层面进行逻辑控制，最终渲染到目标位置。</p>
<p>在 Vue2 的时代，我们经常遇到一个难题：一个组件的模板结构在逻辑上属于这个组件，但在视觉或 DOM 结构上，它需要被放在别的地方。最常见的例子就是<strong>模态框（Modal）、通知（Toast）、全局提示框（Message）</strong> 。</p>
<p>想象一下，你在一个很深的组件里触发了一个全屏弹窗。按照 Vue 的渲染规则，这个弹窗的 DOM 会嵌套在那个很深组件的内部。这会带来一些问题：</p>
<p>• <strong>样式问题</strong>：父组件的 CSS 可能会影响弹窗的样式（比如 <code>overflow: hidden</code> 或 <code>z-index</code>）。
• <strong>定位问题</strong>：弹窗可能被祖先元素的定位或变换属性限制住，无法真正覆盖全屏。</p>
<p>• <strong>结构问题</strong>：从语义上看，一个全局的弹窗不应该属于页面某个局部模块，它应该独立于应用的主体内容。</p>
<p>以前，我们可能需要用 Vue 的 <code>render</code> 函数手动操作，或者依赖第三方库。现在，Vue3 直接提供了 <code>Teleport</code> 来解决这个问题。</p>
<p>它的基本语法长这样：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"showModal = true"</span>&gt;</span>打开弹窗<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 使用 Teleport 将内容传送到 body 末尾 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Teleport</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"body"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"showModal"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"modal"</span>&gt;</span>
        我是一个弹窗！
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"showModal = false"</span>&gt;</span>关闭<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Teleport</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">const</span> showModal = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>在上面的代码里，<code>&lt;Teleport to="body"&gt;</code> 包裹的 <code>div.modal</code> 虽然在模板中写在 <code>.container</code> 里面，但它最终会被渲染到 <code>&lt;body&gt;</code> 标签的末尾。这样，弹窗就脱离了深层嵌套，避免了样式和定位的干扰。</p>
<p><code>to</code> 属性是一个 CSS 选择器字符串，或者一个真实的 DOM 节点。它指定了“传送”的目标位置。</p>
<h2 data-id="heading-0">Teleport 的核心特性</h2>
<p>了解它的基本用法后，我们来看看它的一些重要特性。</p>
<h3 data-id="heading-1">1. 逻辑归属与视觉分离</h3>
<p>这是 Teleport 最核心的价值。<strong>组件在逻辑上仍然属于当前的子组件</strong>。这意味着：</p>
<p>• 它可以使用当前组件作用域内的数据（props、状态、方法）。</p>
<p>• 它遵循当前组件的生命周期。</p>
<p>• 它和当前组件的上下文（Context）保持一致。</p>
<p>但是，<strong>它的 DOM 结构被渲染到了指定的目标位置</strong>。实现了“身在曹营心在汉”的效果。</p>
<h3 data-id="heading-2">2. 条件渲染与多个 Teleport</h3>
<p>你可以像使用普通组件一样，用 <code>v-if</code> 或 <code>v-show</code> 来控制 Teleport 内容的显示隐藏。当条件为假时，目标位置不会有任何内容。</p>
<p>你也可以在同一个目标位置使用多个 Teleport。Vue 会按照它们在组件树中出现的顺序，将内容依次追加到目标容器中。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Teleport</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"#modals"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>弹窗 A<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Teleport</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">Teleport</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"#modals"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>弹窗 B<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Teleport</span>&gt;</span>
</code></pre>
<p>最终在 <code>#modals</code> 容器里，会先渲染“弹窗 A”，再渲染“弹窗 B”。这个顺序很重要，它影响了层叠顺序（z-index）和交互逻辑。</p>
<h3 data-id="heading-3">3. 与组件一起使用</h3>
<p>Teleport 不仅可以传送普通的 HTML 元素，更常见的是传送一个完整的 Vue 组件。</p>
<pre><code class="hljs language-ini" lang="ini">&lt;Teleport <span class="hljs-attr">to</span>=<span class="hljs-string">"body"</span>&gt;
  &lt;MyModal :<span class="hljs-attr">title</span>=<span class="hljs-string">"modalTitle"</span> @close=<span class="hljs-string">"handleClose"</span> /&gt;
&lt;/Teleport&gt;
</code></pre>
<p>这样，<code>MyModal</code> 组件在逻辑上属于当前父组件，能接收父组件传来的 props 和事件，但它的 DOM 被渲染到了 <code>&lt;body&gt;</code> 下，确保了视觉上的独立性。</p>
<h2 data-id="heading-4">Teleport 的典型应用场景</h2>
<p>知道了它是什么，我们来看看它具体能用在哪些地方。</p>
<h3 data-id="heading-5">创建全局弹窗与对话框</h3>
<p>这是最经典的应用。全屏遮罩、对话框、侧边抽屉（Drawer）等，都需要脱离当前内容流，避免被父级样式影响。</p>
<p><strong>没有 Teleport 的问题</strong>：<br/>
如果你的弹窗嵌套在一个有 <code>position: relative</code> 和 <code>overflow: hidden</code> 的容器里，它可能无法正常显示或滚动。</p>
<p><strong>使用 Teleport 的解决方案</strong>：<br/>
直接将弹窗传送到 <code>&lt;body&gt;</code> 或一个专门的全屏容器，确保其样式和定位完全可控。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"open"</span>&gt;</span>打开设置面板<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Teleport</span> <span class="hljs-attr">to</span>=<span class="hljs-string">"body"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">SettingsPanel</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"isOpen"</span> @<span class="hljs-attr">close</span>=<span class="hljs-string">"isOpen = false"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Teleport</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h3 data-id="heading-6">实现通知与提示系统</h3>
<p>应用顶部的通知栏、操作成功的 toast 提示，这些也是全局性的 UI 元素。它们通常由某个页面深处的组件触发，但需要显示在页面最顶层。</p>
<p>使用 Teleport 可以轻松管理一个全局的通知容器。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 在根组件或布局组件中定义一个通知容器 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"notification-container"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 在任意子组件中触发通知 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useNotification } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useNotification'</span>;
<span class="hljs-keyword">const</span> { showSuccess } = <span class="hljs-title function_">useNotification</span>();
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"showSuccess('保存成功！')"</span>&gt;</span>保存<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p>在 <code>useNotification</code> 组合式函数内部，可以使用 Teleport 动态地将通知内容渲染到 <code>#notification-container</code>。</p>
<h3 data-id="heading-7">处理固定定位（fixed）元素</h3>
<p>CSS 的 <code>position: fixed</code> 通常是相对于浏览器窗口定位。但如果其祖先元素设置了 <code>transform</code>, <code>perspective</code>, <code>filter</code> 等属性，<code>fixed</code> 就会相对于这个祖先元素定位，这常常导致意料之外的效果。</p>
<p>使用 Teleport 将需要 <code>fixed</code> 定位的元素传送到 <code>&lt;body&gt;</code>，可以彻底避免这个问题，让它真正相对于视口定位。</p>
<h3 data-id="heading-8">集成第三方库或非 Vue 内容</h3>
<p>有时我们需要在 Vue 应用中集成一个第三方库（比如一个地图组件、一个富文本编辑器），这个库可能需要将一些 UI 元素（如工具栏、下拉框）挂载到特定的 DOM 节点上。</p>
<p>你可以利用 Teleport，在 Vue 的模板中声明这些需要被第三方库控制的内容，并将它们“传送”到第三方库期望的 DOM 位置，实现更优雅的集成。</p>
<h3 data-id="heading-9">构建复杂的布局系统</h3>
<p>在一些复杂的门户网站或管理后台，你可能有一个动态的布局系统。某个区域的内容可能需要根据用户操作，动态“移动”到页面另一个区域显示。</p>
<p>虽然这种情况不常见，但 Teleport 提供了一种声明式的、基于 Vue 响应式系统的方式来实现这种动态布局，比直接操作 DOM 更可控。</p>
<h2 data-id="heading-10">使用 Teleport 需要注意什么？</h2>
<p>Teleport 很好用，但使用时也要留意一些细节。</p>
<h3 data-id="heading-11">1. 目标容器必须已存在</h3>
<p><code>to</code> 属性指向的目标容器必须在 Teleport 组件挂载时就已经存在于 DOM 中。通常我们会选择 <code>&lt;body&gt;</code> 或者一个在应用初始化时就渲染好的根节点。</p>
<p>如果你传送到一个不存在的选择器，内容将不会被渲染（在开发模式下会有警告）。</p>
<h3 data-id="heading-12">2. 顺序与层叠上下文</h3>
<p>多个 Teleport 内容传送到同一目标时，它们的渲染顺序就是它们在源码中的顺序。这个顺序会影响它们在 DOM 中的前后位置，进而影响 CSS 的层叠（谁在上面谁在下面）。你需要通过 <code>z-index</code> 或顺序来管理它们的覆盖关系。</p>
<h3 data-id="heading-13">3. 可访问性（A11y）</h3>
<p>对于模态框这类组件，传送 DOM 后，你仍然需要手动管理可访问性。例如，将焦点锁定在弹窗内，为遮罩层添加 <code>aria-modal</code> 和 <code>role</code> 属性等。Teleport 只负责 DOM 位置，不负责这些交互细节。</p>
<h3 data-id="heading-14">4. 与 SSR 的兼容</h3>
<p>在服务端渲染（SSR）中，Teleport 的内容也需要被正确渲染。Vue3 的 SSR 支持 Teleport，但你需要确保客户端激活（hydration）过程能正确匹配。通常这不需要你额外操心，但如果你遇到了激活不匹配的错误，可能需要检查 Teleport 的使用。</p>
<h2 data-id="heading-15">一个简单例子</h2>
<p>我们通过一个简单的通知钩子来结束今天的讲解。</p>
<p>首先，在 <code>index.html</code> 的 <code>&lt;body&gt;</code> 里添加一个容器：</p>
<pre><code class="hljs language-bash" lang="bash">&lt;div <span class="hljs-built_in">id</span>=<span class="hljs-string">"notices"</span>&gt;&lt;/div&gt;
</code></pre>
<p>然后，创建一个 <code>useNotice</code> 组合式函数：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// useNotice.js</span>
<span class="hljs-keyword">import</span> { ref, h } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Teleport</span>, render, createVNode } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">const</span> noticeList = <span class="hljs-title function_">ref</span>([]);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useNotice</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">showNotice</span> = (<span class="hljs-params">message, <span class="hljs-keyword">type</span> = <span class="hljs-string">'info'</span></span>) =&gt; {
    <span class="hljs-keyword">const</span> id = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">const</span> notice = { id, message, <span class="hljs-keyword">type</span> };
    noticeList.<span class="hljs-property">value</span>.<span class="hljs-title function_">push</span>(notice);

    <span class="hljs-comment">// 3秒后自动移除</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> index = noticeList.<span class="hljs-property">value</span>.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function"><span class="hljs-params">n</span> =&gt;</span> n.<span class="hljs-property">id</span> === id);
      <span class="hljs-keyword">if</span> (index &gt; -<span class="hljs-number">1</span>) {
        noticeList.<span class="hljs-property">value</span>.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
      }
    }, <span class="hljs-number">3000</span>);
  };

  <span class="hljs-comment">// 一个用于渲染通知列表的组件</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">NoticeRenderer</span> = {
    <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">h</span>(<span class="hljs-title class_">Teleport</span>, { <span class="hljs-attr">to</span>: <span class="hljs-string">'#notices'</span> }, [
        <span class="hljs-title function_">h</span>(<span class="hljs-string">'div'</span>, { <span class="hljs-attr">class</span>: <span class="hljs-string">'notice-container'</span> },
          noticeList.<span class="hljs-property">value</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">notice</span> =&gt;</span> 
            <span class="hljs-title function_">h</span>(<span class="hljs-string">'div'</span>, { 
              <span class="hljs-attr">key</span>: notice.<span class="hljs-property">id</span>, 
              <span class="hljs-attr">class</span>: <span class="hljs-string">`notice notice-<span class="hljs-subst">${notice.<span class="hljs-keyword">type</span>}</span>`</span>
            }, notice.<span class="hljs-property">message</span>)
          )
        )
      ]);
    }
  };

  <span class="hljs-comment">// 你可以选择在应用初始化时挂载这个渲染器</span>
  <span class="hljs-comment">// 或者在需要的地方动态使用 &lt;NoticeRenderer /&gt; 组件</span>

  <span class="hljs-keyword">return</span> { showNotice, <span class="hljs-title class_">NoticeRenderer</span> };
}
</code></pre>
<p>最后，在任意组件中使用：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"showInfo"</span>&gt;</span>显示信息通知<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 只需要在应用某处（如根组件）放置一次 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">NoticeRenderer</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useNotice } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useNotice'</span>;
<span class="hljs-keyword">const</span> { showNotice } = <span class="hljs-title function_">useNotice</span>();

<span class="hljs-keyword">const</span> <span class="hljs-title function_">showInfo</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-title function_">showNotice</span>(<span class="hljs-string">'这是一条操作提示！'</span>, <span class="hljs-string">'info'</span>);
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>这样，无论你在多深的组件里调用 <code>showNotice</code>，通知都会整齐地显示在 <code>#notices</code> 容器里，样式完全独立，管理起来非常方便。</p>
<p>Teleport 是 Vue3 提供的一个非常实用的工具。它用一种声明式的方法，解决了过去需要侵入性 DOM 操作才能解决的问题。下次当你需要创建全局性、脱离文档流的 UI 组件时，别忘了试试它。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么在使用Vue的v-for时，一定要加上key字段？]]></title>    <link>https://juejin.cn/post/7600755567487008820</link>    <guid>https://juejin.cn/post/7600755567487008820</guid>    <pubDate>2026-01-30T08:53:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600755567487008820" data-draft-id="7600799940970938408" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么在使用Vue的v-for时，一定要加上key字段？"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-01-30T08:53:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户3905133219288"/> <meta itemprop="url" content="https://juejin.cn/user/3609051079121550"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么在使用Vue的v-for时，一定要加上key字段？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3609051079121550/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户3905133219288
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T08:53:31.000Z" title="Fri Jan 30 2026 08:53:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>假设我们要渲染一个简单的待办事项列表：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in list"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{{ item.text }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>当我们删除中间某个项目时，你可能会发现复选框的状态出现了错误。选中的项目被删除了，但其他项目的选中状态却乱了套。</p>
<h2 data-id="heading-0">问题的根源</h2>
<p>Vue在更新DOM时，会尽量复用已有的元素。这是一种优化策略，可以减少DOM操作，提高性能。</p>
<p>但是，当数据顺序发生变化时，Vue需要知道哪些元素可以复用，哪些需要重新创建。如果没有key，Vue只能按照顺序进行对比。</p>
<p><strong>没有key的情况：</strong></p>
<ul>
<li>• Vue按顺序对比新旧节点</li>
<li>• 删除第二个元素后，后面的元素会前移</li>
<li>• Vue认为这是同一个元素，只是内容变了</li>
<li>• 复用的元素保留了之前的状态</li>
</ul>
<h2 data-id="heading-1">key的作用</h2>
<p>key给每个节点一个唯一标识。Vue通过这个标识来跟踪每个节点的身份。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 正确的写法 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in list"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.id"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{{ item.text }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p><strong>加上key之后：</strong></p>
<ul>
<li>• Vue知道每个节点的唯一身份</li>
<li>• 删除某个节点时，其他节点身份不变</li>
<li>• 不会错误地复用其他节点的状态</li>
<li>• 列表更新更加准确</li>
</ul>
<h2 data-id="heading-2">深入理解虚拟DOM</h2>
<p>要理解key的重要性，我们需要了解Vue的虚拟DOM机制。</p>
<h3 data-id="heading-3">虚拟DOM是什么</h3>
<p>虚拟DOM是真实DOM的JavaScript对象表示。Vue通过对比新旧虚拟DOM的差异，来决定如何更新真实DOM。</p>
<h3 data-id="heading-4">Diff算法</h3>
<p>Vue使用Diff算法来比较虚拟DOM的差异。这个算法会找出最小的变更，然后应用到真实DOM上。</p>
<p><strong>没有key的Diff过程：</strong></p>
<ul>
<li>• 按顺序逐个比较节点</li>
<li>• 发现长度变化，进行插入或删除</li>
<li>• 可能导致大量不必要的DOM操作</li>
</ul>
<p><strong>有key的Diff过程：</strong></p>
<ul>
<li>• 根据key建立映射关系</li>
<li>• 精确找到新增、删除、移动的节点</li>
<li>• 最小化DOM操作</li>
</ul>
<h2 data-id="heading-5">key的选择</h2>
<p>选择合适的key很重要。不合适的key可能带来问题。</p>
<h3 data-id="heading-6">好的key选择</h3>
<ul>
<li>• 数据中的唯一标识符</li>
<li>• 稳定的、不会改变的值</li>
<li>• 如：数据库ID、UUID等</li>
</ul>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 好的例子</span>
<span class="hljs-type">const</span> list = [
  { id: <span class="hljs-number">1</span>, text: <span class="hljs-string">'学习Vue'</span> },
  { id: <span class="hljs-number">2</span>, text: <span class="hljs-string">'写代码'</span> },
  { id: <span class="hljs-number">3</span>, text: <span class="hljs-string">'阅读文档'</span> }
]
</code></pre>
<h3 data-id="heading-7">不好的key选择</h3>
<ul>
<li>• 数组索引（在排序、过滤时会出问题）</li>
<li>• 随机数（每次渲染都会变化）</li>
<li>• 可能重复的值</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">// 不好的例子 - 使用索引作为key
&lt;div <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(item, index) in list"</span> :key=<span class="hljs-string">"index"</span>&gt;

// 不好的例子 - 使用随机数作为key  
&lt;div <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in list"</span> :key=<span class="hljs-string">"Math.random()"</span>&gt;
</code></pre>
<h2 data-id="heading-8">实际开发中的场景</h2>
<h3 data-id="heading-9">列表排序</h3>
<p>当列表需要排序时，key的作用特别明显。</p>
<pre><code class="hljs language-bash" lang="bash">// 初始列表
[
  { <span class="hljs-built_in">id</span>: 1, name: <span class="hljs-string">'苹果'</span> },
  { <span class="hljs-built_in">id</span>: 2, name: <span class="hljs-string">'香蕉'</span> }, 
  { <span class="hljs-built_in">id</span>: 3, name: <span class="hljs-string">'橙子'</span> }
]

// 排序后
[
  { <span class="hljs-built_in">id</span>: 3, name: <span class="hljs-string">'橙子'</span> },
  { <span class="hljs-built_in">id</span>: 1, name: <span class="hljs-string">'苹果'</span> },
  { <span class="hljs-built_in">id</span>: 2, name: <span class="hljs-string">'香蕉'</span> }
]
</code></pre>
<p>有key时，Vue知道这是元素位置的移动，而不是内容的修改。</p>
<h3 data-id="heading-10">列表过滤</h3>
<p>过滤列表时，key确保正确的元素被保留或移除。</p>
<h3 data-id="heading-11">动态组件</h3>
<p>在动态组件中，key可以强制组件重新创建：</p>
<pre><code class="hljs language-ruby" lang="ruby">&lt;component <span class="hljs-symbol">:is=<span class="hljs-string">"currentComponent"</span></span> <span class="hljs-symbol">:key=<span class="hljs-string">"componentKey"</span>&gt;</span>
</code></pre>
<p>改变componentKey会触发组件的重新渲染。</p>
<h2 data-id="heading-12">性能考虑</h2>
<h3 data-id="heading-13">什么时候可以不加key</h3>
<p>在某些简单场景下，不加key可能不会立即发现问题：</p>
<ul>
<li>• 静态列表，永远不会改变</li>
<li>• 列表项没有内部状态</li>
<li>• 列表项非常简单</li>
</ul>
<p>但为了代码的健壮性，建议始终加上key。</p>
<h3 data-id="heading-14">错误的使用方式</h3>
<p>有些开发者会这样使用key：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 错误：使用索引作为key --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(item, index) in list"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"index"</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 错误：使用不稳定的值作为key --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"item in list"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"Math.random()"</span>&gt;</span>
</code></pre>
<p>这些用法都会导致各种奇怪的问题。</p>
<h2 data-id="heading-15">常见问题解答</h2>
<h3 data-id="heading-16">为什么不能用索引作为key？</h3>
<p>当列表发生变化时，索引也会变化。原来索引为1的元素，在删除前面的元素后，可能变成索引0。这会导致Vue错误地复用元素。</p>
<h3 data-id="heading-17">key一定要全局唯一吗？</h3>
<p>在同一个v-for中唯一即可，不需要全局唯一。</p>
<h3 data-id="heading-18">如果没有唯一标识怎么办？</h3>
<p>如果数据源没有提供唯一标识，可以考虑：</p>
<ol>
<li>
<ol>
<li>在获取数据时生成唯一ID</li>
</ol>
</li>
<li>
<ol start="2">
<li>使用多个字段组合作为key</li>
</ol>
</li>
<li>
<ol start="3">
<li>使用第三方库生成UUID</li>
</ol>
</li>
</ol>
<blockquote>
<p>记住：key是Vue跟踪节点身份的标识，不是普通的属性。</p>
</blockquote>
<h2 data-id="heading-19">写在最后</h2>
<p>理解key的作用，能帮助我们写出更稳定、性能更好的Vue应用。这个看似小的细节，在实际开发中却很重要。</p>
<p>下次使用v-for时，记得给它一个合适的key。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于Capacitor+H5（Vue+Vite）的App开发经历]]></title>    <link>https://juejin.cn/post/7600799940970922024</link>    <guid>https://juejin.cn/post/7600799940970922024</guid>    <pubDate>2026-01-30T08:52:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600799940970922024" data-draft-id="7600799940970840104" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于Capacitor+H5（Vue+Vite）的App开发经历"/> <meta itemprop="keywords" content="前端,iOS,Android"/> <meta itemprop="datePublished" content="2026-01-30T08:52:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="chen77"/> <meta itemprop="url" content="https://juejin.cn/user/2027977720214573"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于Capacitor+H5（Vue+Vite）的App开发经历
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2027977720214573/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    chen77
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T08:52:05.000Z" title="Fri Jan 30 2026 08:52:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">基于Capacitor+H5（Vue+Vite）的App开发经历</h2>
<h3 data-id="heading-1">一、App开发模式</h3>
<h4 data-id="heading-2">1.Native</h4>
<p><code>Native App</code>指原生APP，使用原生（即<code>Android</code>或<code>iOS</code>）开发的APP，<code>Android</code>基于<code>kotlin</code>语言和<code>Android Studio</code>工具进行开发，<code>iOs</code>基于<code>swift</code>语言和<code>X code</code>工具进行开发,显然需要开发<code>iOS</code>和<code>Android</code>两者，成本很大，需要同时开发两套系统。</p>
<h4 data-id="heading-3">2.WebApp</h4>
<p><code>Web App</code>一般指的是基于 Web 的应用，基于<strong>浏览器运行</strong>，<strong>无需下载安装</strong>，基本上可以说是触屏版的网页应用。这类应用基本上是一个网页或一系列网页，旨在在移动屏幕上工作。开发和维护成本低，可以跨平台，但是性能低，用户体验差，功能受限较多。</p>
<h4 data-id="heading-4">3.Hybrid</h4>
<p><code>Hhybrid App</code>顾名思义就是原生 App 与 <code>Web App</code> 的结合。它的壳是原生 App，但是里面放的是<code>WebView</code>。 可以理解成，混合 App 里面隐藏了一个浏览器，用户看到的实际上是这个隐藏浏览器渲染出来的网页。支持跨平台，开发成本低。</p>
<p>现在比较流行的混合方案主要有三种，主要是在UI渲染机制上的不同：</p>
<ol>
<li>基于 <strong>WebView UI</strong> 的基础方案，市面上大部分主流 App 都有采用，例如<code>微信JS-SDK</code>、<code>Cordova</code>，<code>Capacitor</code>,通过<code> JSBridge</code> 完成<code>H5</code>与 <code>Native</code> 的双向通讯，从而赋予H5一定程度的原生能力。</li>
<li>基于 <strong>Native UI</strong> 的方案，例如 <code>React-Native</code>、<code>Weex</code>、<code>uniapp</code>。在赋予 H5 原生API能力的基础上，进一步通过<code> JSBridge</code> 将<code>js</code>解析成的虚拟节点树(Virtual DOM)传递到 Native 并使用原生渲染。</li>
</ol>
<p>在此特别强调一下第三种方案——基于<strong>小程序</strong>方案，也是通过更加定制化的 <code>JSBridge</code>，并使用<code>双 WebView </code>双线程的模式隔离了<code>JS</code>逻辑与UI渲染，形成了特殊的开发模式，加强了<code> H5</code> 与<code>Native</code>混合程度，提高了页面性能及开发体验。</p>
<h3 data-id="heading-5">二、技术选型</h3>
<p>基于对<code>App</code>开发的调研，以及团队的整体情况，最终确定了以<code>Hybrid</code>的形式进行<code>App</code>开发，基于时间成本的考虑，最终敲定了<code>H5</code>开发+<code>Capacitor</code>的形式。</p>
<h3 data-id="heading-6">三、关于Capacitor</h3>
<ul>
<li>
<p>Capacitor 是Ionic 团队维护的项目，其官方团队和社区提供了很多 Capacitor 插件，旨在提供一些原生功能。</p>
</li>
<li>
<p>Capacitor 需要结合Android Studio进行apk打包，如果你还需要打包iOS ipa 的话则也需要安装XCODE (过程可能会需要更新OSX 系统)</p>
</li>
</ul>
<h3 data-id="heading-7">四、安装Android Studio</h3>
<p>具体安装过程跳过</p>
<p>为了测试不同版本的<code>Android</code>，可以考虑将7~14 版本的<code>SDK</code>都装起来试试看！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/845c78daac084ead92a227eef277404e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hlbjc3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770367924&amp;x-signature=S%2Boj7CCyDlJilNCEWrWcaGqYsQ0%3D" alt="1.png" loading="lazy"/></p>
<h3 data-id="heading-8">五、Capacitor 安装教学</h3>
<h5 data-id="heading-9">1.基础依赖</h5>
<p>最好项目使用<code>npm</code>进行安装依赖</p>
<pre><code class="hljs language-bash" lang="bash">npm install @capacitor/core  @capacitor/android @capacitor/ios
npm install @capacitor/cli @capacitor/assets -D
</code></pre>
<p>项目使用具体版本</p>
<pre><code class="hljs language-perl" lang="perl">    <span class="hljs-string">"@capacitor/android"</span>: <span class="hljs-string">"^4.1.0"</span>,
    <span class="hljs-string">"@capacitor/core"</span>: <span class="hljs-string">"^4.1.0"</span>,
    <span class="hljs-string">"@capacitor/ios"</span>: <span class="hljs-string">"^4.1.0"</span>,
    
    <span class="hljs-string">"@capacitor/assets"</span>: <span class="hljs-string">"^3.0.5"</span>,
    <span class="hljs-string">"@capacitor/cli"</span>: <span class="hljs-string">"^4.1.0"</span>,
</code></pre>
<h5 data-id="heading-10">2.初始化Capacitor配置文件</h5>
<pre><code class="hljs language-bash" lang="bash">npx <span class="hljs-built_in">cap</span> init
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9887d28b85a84b0084ff3054434da766~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hlbjc3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770367924&amp;x-signature=4HR8EBeCD3OHkEIXr2t29DFx%2B7Q%3D" alt="2.png" loading="lazy"/>
初始化的过程会询问你要如何命名这个app名称、以及反向域名格式的APP ID。
例如：<code>com.example.frontapp</code></p>
<p>然后会生成一个<code>capacitor.config.json</code>文件 ，这是<code>Capacitor</code>项目的核心配置文件，你可以在这里设置应用名称、ID、Web目录、原生权限等关键参数。</p>
<p>以下是一个典型的配置示例：</p>
<pre><code class="hljs language-rust" lang="rust">{
  <span class="hljs-string">"appId"</span>: <span class="hljs-string">"com.example.frontapp"</span>,
  <span class="hljs-string">"appName"</span>: <span class="hljs-string">"APP名称"</span>,
  <span class="hljs-string">"webDir"</span>: <span class="hljs-string">"dist"</span>, 生产环境取打包后名叫dist的文件作为app底座
  <span class="hljs-string">"bundledWebRuntime"</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-string">"server"</span>: {
    <span class="hljs-string">"url"</span>：<span class="hljs-symbol">'http</span>:<span class="hljs-comment">//xxxxx'  本地环境url</span>
    <span class="hljs-string">"cleartext"</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">//允许http明文传输</span>
  },
}

</code></pre>
<p>如果是<code>typescript</code>项目使用<code>capacitor.config.ts</code></p>
<p>以下是一个典型的配置示例：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">import</span> { CapacitorConfig } from <span class="hljs-string">'@capacitor/cli'</span>;
 
<span class="hljs-type">const</span> config: CapacitorConfig = {
  appId: <span class="hljs-string">'com.example.myapp'</span>,
  appName: <span class="hljs-string">'My Capacitor App'</span>,
  webDir: <span class="hljs-string">'dist'</span>, <span class="hljs-comment">// Web构建产物目录</span>
  bundledWebRuntime: <span class="hljs-literal">false</span>,
  server: {
    url: <span class="hljs-string">'http://192.168.1.100:8100'</span>, <span class="hljs-comment">// 开发服务器地址</span>
    cleartext: <span class="hljs-literal">true</span> <span class="hljs-comment">// 允许明文传输（开发环境）</span>
  },
  ios: {
    contentInset: <span class="hljs-string">'always'</span> <span class="hljs-comment">// 刘海屏 状态栏  底部 Home Indicator WebView 默认会给内容加 inset（内边距） </span>
    <span class="hljs-comment">// scrollableAxes只在可滚动方向适配 </span>
    <span class="hljs-comment">// never 不处理</span>
  },
  android: {
    allowMixedContent: <span class="hljs-literal">true</span>, <span class="hljs-comment">// HTTPS 页面里能不能加载 HTTP 资源 ,生产用 HTTPS + 关掉 mixed content</span>
    webContentsDebuggingEnabled: <span class="hljs-literal">true</span> <span class="hljs-comment">// 可以用 Chrome DevTools 调试 Android WebView   chrome://inspect</span>
  }
};
 
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> config;
</code></pre>
<p>关键配置项说明：</p>
<ul>
<li><code>webDir</code>：指定Web应用构建后的文件目录，通常是<code>dist</code>、<code>build</code>或<code>public</code></li>
<li><code>server</code>：配置开发服务器，用于实时重载和调试</li>
<li><code>ios/android</code>：平台特定配置，如权限、界面行为等</li>
<li>当<code>server</code>存在<code>url</code>的时候，默认安卓会走指向<code>url</code>的开发环境，而不是走<code>dist</code>构建后的产物</li>
</ul>
<h5 data-id="heading-11">3.打包vite项目</h5>
<pre><code class="hljs language-arduino" lang="arduino">npm run build
</code></pre>
<p>打包后的包名需要和capacitor配置文件中的<code>webDir</code>对应</p>
<pre><code class="hljs language-bash" lang="bash">pnpm <span class="hljs-built_in">cap</span> add android <span class="hljs-comment"># 会在vite项目根目录生成一个android 目录(保证已经打包构建出了 dist 目录)</span>
</code></pre>
<p>请提前配置好安卓环境，安装好 SDK</p>
<pre><code class="hljs language-bash" lang="bash">pnpm <span class="hljs-built_in">cap</span> open android <span class="hljs-comment">## 打开Android Studio后，第一次加载有点慢（点击build查看进度）</span>
</code></pre>
<ul>
<li>等待打开<code>Android Studio</code>后后，点击 <code>Android Studio </code>右上角的 <code>Sync Project with Gradle Files</code>按钮，如果出现<code>Gradle </code>和<code>Gradle jdk</code>版本不兼容，需要到<code>Android Studio</code> - <code>setting</code>下进行配置</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44f501f644624fd7b9518f2068d08d5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hlbjc3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770367924&amp;x-signature=NvzD%2FaFpVRJIxZXGTnTb59Uy8rE%3D" alt="3.png" loading="lazy"/></p>
<ul>
<li>添加设备</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5051065a228f471b97e44fea562e986b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hlbjc3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770367924&amp;x-signature=xOvOxqYA99XcVICYC7mr3gY3ikI%3D" alt="4.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/989061261a544c749558f00071264fd9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hlbjc3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770367924&amp;x-signature=OiEFmYlSFDar8zsrEfp8oC%2Fc5MI%3D" alt="5.png" loading="lazy"/></p>
<ul>
<li>点击右上角的 Run</li>
</ul>
<h5 data-id="heading-12">4.开发工作流</h5>
<ul>
<li>如果是本地环境</li>
</ul>
<p>我们需要在<code>capacitor.config.json</code>中，加上<code>server</code>的<code>url</code>，当加上此<code>url</code>，执行<code>npx cap sync</code>同步配置到<code>android</code>中</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"appId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"app.flyshare.h5"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"appName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"飞享家"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"webDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dist"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"bundledWebRuntime"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"server"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://本地环境地址"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"cleartext"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>

</code></pre>
<ul>
<li>如果是线上环境，则需要去掉<code>url</code>配置，让<code>android</code>指向<code>dist</code>构建后的产物</li>
</ul>

<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"appId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"app.flyshare.h5"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"appName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"飞享家"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"webDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dist"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"bundledWebRuntime"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>如果线上环境希望只是给H5套一个壳，并且后端是http请求，可以类似<code>wap2app</code>处理方式，给H5套壳然后url指向项目线上地址。</li>
</ul>

<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"appId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"app.flyshare.h5"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"appName"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"飞享家"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"webDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"dist"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"bundledWebRuntime"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"server"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"url"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://线上环境地址"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"cleartext"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-comment">//允许http明文传输</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-13">5.启动画面和App图标</h5>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fionic-team%2Fcapacitor-assets" target="_blank" title="https://github.com/ionic-team/capacitor-assets" ref="nofollow noopener noreferrer">可以使用@capacitor/assets</a>工具为您的<code> iOS</code>、<code>Android </code>或渐进式 Web 应用程序生成启动画面和图标。</p>
<p>使用以下文件夹/文件名结构提供图标和启动画面源图像：</p>
<pre><code class="hljs language-css" lang="css">assets/
├── <span class="hljs-attribute">icon</span>-only<span class="hljs-selector-class">.png</span>
├── <span class="hljs-attribute">icon</span>-foreground<span class="hljs-selector-class">.png</span>
├── <span class="hljs-attribute">icon</span>-<span class="hljs-attribute">background</span><span class="hljs-selector-class">.png</span>
├── splash<span class="hljs-selector-class">.png</span>
└── splash-dark<span class="hljs-selector-class">.png</span>
</code></pre>
<ul>
<li>图标文件大小至少应为<code>1024px</code>x <code>1024px</code>。</li>
<li>启动画面文件大小至少应为<code>2732px</code>x <code>2732px</code>。</li>
<li>格式可以是<code>jpg</code>或<code>png</code>。</li>
</ul>
<p>然后生成（适用于您的原生项目或生成 PWA 清单文件）：</p>
<pre><code class="hljs">npx capacitor-assets generate
</code></pre>
<p><strong>注意：如果此处如果出现sharp报错,请使用npm安装@capacitor/assets 依赖，并且安装sharp到项目或者全局</strong></p>
<pre><code class="hljs language-ini" lang="ini">npm install  <span class="hljs-attr">--include</span>=optional sharp
</code></pre>
<p>or</p>
<pre><code class="hljs language-ini" lang="ini">npm install -g <span class="hljs-attr">--include</span>=optional sharp
</code></pre>
<h5 data-id="heading-14">6.打包apk</h5>
<ul>
<li>选取<code>Android Studio</code>的<code>Build -&gt; Build Bundle(s ) / APK(s) -&gt; Build APK(s)</code></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47a5a11952814ee5800aae7496045dd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hlbjc3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770367924&amp;x-signature=29Nl2j0cvumSvVV4sb8FSNrZ4SI%3D" alt="6.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c952436e53a4c6b8e600d53d251d61b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hlbjc3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770367924&amp;x-signature=2GSEth1113F4iP3ekbJVJfC%2BGYA%3D" alt="7.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ce9f35fa90a456fadcb87af4416cdd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hlbjc3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770367924&amp;x-signature=jPrdh5V%2F%2F7rMAvjaKFTAVTG4AO0%3D" alt="8.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c85ab15c167640d48a5d06162d7eea78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hlbjc3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770367924&amp;x-signature=TazfKsE0xRUD8VZLliMx20af8N4%3D" alt="9.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cefde235628544e19296c6d827833bc3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hlbjc3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770367924&amp;x-signature=Bfik5v4t0%2Fun0IyooNd%2FDDRR554%3D" alt="10.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1855c59493d43dab5515641b42841af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2hlbjc3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770367924&amp;x-signature=IHzlgwlFylaRSd8YiiGgOYeqJkc%3D" alt="11.png" loading="lazy"/></p>
<h3 data-id="heading-15">六、理解Capacitor</h3>
<pre><code class="hljs language-bash" lang="bash">pnpm <span class="hljs-built_in">cap</span> add android
</code></pre>
<ul>
<li>创建 <code>android/</code> 原生工程</li>
<li>把 <code>dist/</code> 拷贝进 Android</li>
<li>建立 WebView 壳</li>
<li>不会自动监听你后续的前端变化</li>
<li>全局执行一次即可，后续如果web有更新，配合<code>npx cap sync</code>更新即可</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">npx <span class="hljs-built_in">cap</span> <span class="hljs-built_in">sync</span>
</code></pre>
<ul>
<li>同步web端的更新、capator.config配置更新 到<code>android</code>或<code>iOs</code></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[css代码规范]]></title>    <link>https://juejin.cn/post/7600787795477217326</link>    <guid>https://juejin.cn/post/7600787795477217326</guid>    <pubDate>2026-01-30T08:54:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600787795477217326" data-draft-id="7600675515151532059" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="css代码规范"/> <meta itemprop="keywords" content="CSS"/> <meta itemprop="datePublished" content="2026-01-30T08:54:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="hypnos_xy"/> <meta itemprop="url" content="https://juejin.cn/user/1259383317872089"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            css代码规范
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1259383317872089/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    hypnos_xy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T08:54:29.000Z" title="Fri Jan 30 2026 08:54:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto;border:3px solid rgba(62,175,124,.2)}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-weight:700;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:6px;border:2px solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c}.markdown-body a:active,.markdown-body a:hover{border-bottom:1.5px solid #3eaf7c}.markdown-body a:before{content:"⇲"}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(62,175,124,.2)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:.5rem solid;border-color:#42b983;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none}.markdown-body ul li:before{content:"•";margin-right:4px;color:#3eaf7c}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">css规范</h2>
<h3 data-id="heading-1">使用属性简写</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 使用属性简写 */</span>
<span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">10px</span> <span class="hljs-number">20px</span>;
}

<span class="hljs-comment">/* 不使用属性简写 */</span>
<span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">20px</span>;
}
</code></pre>
<h3 data-id="heading-2">统一样式格式</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 统一使用双引号 */</span>
<span class="hljs-selector-class">.button</span> {
  <span class="hljs-attribute">font-family</span>: <span class="hljs-string">"Arial"</span>, sans-serif;
}

<span class="hljs-comment">/* 统一使用分号结尾 */</span>
<span class="hljs-selector-class">.button</span> {
  <span class="hljs-attribute">color</span>: red;
}
</code></pre>
<h3 data-id="heading-3">避免使用全局样式</h3>
<p>全局样式是指能够影响整个页面的样式，比如 <code>body</code> 元素或者 <code>*</code> 选择器。虽然在某些情况下使用全局样式会很方便，但是过度依赖全局样式会增加代码的复杂度，降低代码的可维护性。在编写 CSS 代码时，应该尽量避免使用全局样式，而是优先使用类名和 ID 来控制样式。</p>
<h3 data-id="heading-4"> !important</h3>
<p>除公共样式之外，在业务代码中尽量不能使用 !important</p>
<h3 data-id="heading-5">z-index</h3>
<p>建议将 z-index 进行分层，对文档流外绝对定位元素的视觉层级关系进行管理。</p>
<h3 data-id="heading-6">不要为 id、class 选择器添加类型选择器</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* good */</span>
<span class="hljs-selector-id">#error</span>,<span class="hljs-selector-class">.message</span> {
  <span class="hljs-attribute">font</span>-<span class="hljs-attribute">color</span>: <span class="hljs-number">#c00</span>;
}

<span class="hljs-comment">/* bad */</span>
<span class="hljs-selector-tag">input</span><span class="hljs-selector-id">#error</span>,<span class="hljs-selector-tag">p</span><span class="hljs-selector-class">.message</span> {
  <span class="hljs-attribute">font</span>-<span class="hljs-attribute">color</span>: <span class="hljs-number">#c00</span>;
}
</code></pre>
<h3 data-id="heading-7">文字排版</h3>
<ol>
<li>字号 不要小于12px</li>
<li>字重使用数值</li>
<li>行高使用数字</li>
</ol>
<pre><code class="hljs language-css" lang="css"> <span class="hljs-comment">/* good */</span>
<span class="hljs-selector-tag">h1</span> {
   <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">700</span>;
   <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.5</span>;
   <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>
}

<span class="hljs-comment">/* bad */</span>
<span class="hljs-selector-tag">h1</span> {
   <span class="hljs-attribute">font-weight</span>: bold;
   <span class="hljs-attribute">line-height</span>: <span class="hljs-number">15px</span>;
   <span class="hljs-attribute">font-size</span>: <span class="hljs-number">10px</span>
}
</code></pre>
<h3 data-id="heading-8">清楚浮动</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.clearfix</span><span class="hljs-selector-pseudo">::before</span>,
<span class="hljs-selector-class">.clearfix</span><span class="hljs-selector-pseudo">::after</span> {
  <span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>;
  <span class="hljs-attribute">display</span>: block;
  <span class="hljs-attribute">clear</span>: both;
}
</code></pre>
<h2 data-id="heading-9">CSS代码命名规范</h2>
<p>前端css代码规范：主要遵循<strong>BEM命名规范</strong>，BEM分别对应的是block,element和modifier,为的是结束混乱的命名方式，达到一个语义话的css命名方式</p>
<h3 data-id="heading-10">BEM命名规范</h3>
<h4 data-id="heading-11">block</h4>
<p>block 表示一个外层组件的意思，表示盒子的呈现的内容，如button,card，tabs等，在块被写为和class的名字一样
常见的block有：</p>
<p><strong>布局类</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.header</span>      <span class="hljs-comment">/* 页头 */</span>
<span class="hljs-selector-class">.footer</span>      <span class="hljs-comment">/* 页脚 */</span>
<span class="hljs-selector-class">.sidebar</span>     <span class="hljs-comment">/* 侧边栏 */</span>
<span class="hljs-selector-class">.container</span>   <span class="hljs-comment">/* 容器 */</span>
<span class="hljs-selector-class">.layout</span>      <span class="hljs-comment">/* 布局 */</span>
<span class="hljs-selector-class">.grid</span>        <span class="hljs-comment">/* 网格布局 */</span>
<span class="hljs-selector-class">.wrapper</span>     <span class="hljs-comment">/* 包装器 */</span>
<span class="hljs-selector-class">.frame</span>       <span class="hljs-comment">/* 框架 */</span>
<span class="hljs-selector-class">.holder</span>      <span class="hljs-comment">/* 容器 */</span>
<span class="hljs-selector-class">.box</span>         <span class="hljs-comment">/* 盒子 */</span>
<span class="hljs-selector-class">.panel</span>       <span class="hljs-comment">/* 面板 */</span>
<span class="hljs-selector-class">.segment</span>     <span class="hljs-comment">/* 分段 */</span>
<span class="hljs-selector-class">.section</span>     <span class="hljs-comment">/* 区块 */</span>
<span class="hljs-selector-class">.stack</span>       <span class="hljs-comment">/* 堆叠布局 */</span>
<span class="hljs-selector-class">.column</span>      <span class="hljs-comment">/* 列 */</span>
<span class="hljs-selector-class">.row</span>         <span class="hljs-comment">/* 行 */</span>
<span class="hljs-selector-class">.main</span>        <span class="hljs-comment">/* 主要内容区 */</span>
<span class="hljs-selector-class">.aside</span>       <span class="hljs-comment">/* 侧边内容 */</span>
</code></pre>
<p><strong>UI组件类</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.button</span>      <span class="hljs-comment">/* 按钮 */</span>
<span class="hljs-selector-class">.modal</span>       <span class="hljs-comment">/* 模态框 */</span>
<span class="hljs-selector-class">.card</span>        <span class="hljs-comment">/* 卡片 */</span>
<span class="hljs-selector-class">.form</span>        <span class="hljs-comment">/* 表单 */</span>
<span class="hljs-selector-class">.input</span>       <span class="hljs-comment">/* 输入框 */</span>
<span class="hljs-selector-class">.select</span>      <span class="hljs-comment">/* 选择器 */</span>
<span class="hljs-selector-class">.checkbox</span>    <span class="hljs-comment">/* 复选框 */</span>
<span class="hljs-selector-class">.radio</span>       <span class="hljs-comment">/* 单选框 */</span>
<span class="hljs-selector-class">.toggle</span>      <span class="hljs-comment">/* 切换开关 */</span>
<span class="hljs-selector-class">.switch</span>      <span class="hljs-comment">/* 开关 */</span>
<span class="hljs-selector-class">.slider</span>      <span class="hljs-comment">/* 滑块 */</span>
<span class="hljs-selector-class">.range</span>       <span class="hljs-comment">/* 范围选择器 */</span>
<span class="hljs-selector-class">.stepper</span>     <span class="hljs-comment">/* 步进器 */</span>
<span class="hljs-selector-class">.rate</span>        <span class="hljs-comment">/* 评分组件 */</span>
</code></pre>
<p><strong>导航类</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.menu</span>          <span class="hljs-comment">/* 菜单 */</span>
<span class="hljs-selector-class">.nav</span>           <span class="hljs-comment">/* 导航 */</span>
<span class="hljs-selector-class">.breadcrumb</span>    <span class="hljs-comment">/* 面包屑 */</span>
<span class="hljs-selector-class">.pagination</span>    <span class="hljs-comment">/* 分页 */</span>
<span class="hljs-selector-class">.tabs</span>          <span class="hljs-comment">/* 标签页 */</span>
<span class="hljs-selector-class">.dropdown</span>      <span class="hljs-comment">/* 下拉菜单 */</span>
<span class="hljs-selector-class">.pager</span>         <span class="hljs-comment">/* 分页器 */</span>
<span class="hljs-selector-class">.quick-nav</span>     <span class="hljs-comment">/* 快速导航 */</span>
<span class="hljs-selector-class">.action-sheet</span>  <span class="hljs-comment">/* 动作面板 */</span>
<span class="hljs-selector-class">.bottom-sheet</span>  <span class="hljs-comment">/* 底部面板 */</span>
<span class="hljs-selector-class">.drawer</span>        <span class="hljs-comment">/* 抽屉 */</span>
</code></pre>
<p><strong>表单控件</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.search</span>        <span class="hljs-comment">/* 搜索框 */</span>
<span class="hljs-selector-class">.filter</span>        <span class="hljs-comment">/* 过滤器 */</span>
<span class="hljs-selector-class">.sort</span>          <span class="hljs-comment">/* 排序器 */</span>
<span class="hljs-selector-class">.upload</span>        <span class="hljs-comment">/* 上传组件 */</span>
<span class="hljs-selector-class">.date-picker</span>   <span class="hljs-comment">/* 日期选择器 */</span>
<span class="hljs-selector-class">.time-picker</span>   <span class="hljs-comment">/* 时间选择器 */</span>
<span class="hljs-selector-class">.color-picker</span>  <span class="hljs-comment">/* 颜色选择器 */</span>
<span class="hljs-selector-class">.uploader</span>      <span class="hljs-comment">/* 上传器 */</span>
<span class="hljs-selector-class">.search-bar</span>    <span class="hljs-comment">/* 搜索栏 */</span>
<span class="hljs-selector-class">.filter-bar</span>    <span class="hljs-comment">/* 筛选栏 */</span>
<span class="hljs-selector-class">.textarea</span>      <span class="hljs-comment">/* 文本域 */</span>
<span class="hljs-selector-class">.file-input</span>    <span class="hljs-comment">/* 文件输入 */</span>
</code></pre>
<p><strong>数据展示</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.table</span>         <span class="hljs-comment">/* 表格 */</span>
<span class="hljs-selector-class">.list</span>          <span class="hljs-comment">/* 列表 */</span>
<span class="hljs-selector-class">.chart</span>         <span class="hljs-comment">/* 图表 */</span>
<span class="hljs-selector-class">.graph</span>         <span class="hljs-comment">/* 图形 */</span>
<span class="hljs-selector-class">.gauge</span>         <span class="hljs-comment">/* 仪表盘 */</span>
<span class="hljs-selector-class">.progress</span>      <span class="hljs-comment">/* 进度条 */</span>
<span class="hljs-selector-class">.timeline</span>      <span class="hljs-comment">/* 时间轴 */</span>
<span class="hljs-selector-class">.statistic</span>     <span class="hljs-comment">/* 统计数字 */</span>
<span class="hljs-selector-class">.counter</span>       <span class="hljs-comment">/* 计数器 */</span>
<span class="hljs-selector-class">.metric</span>        <span class="hljs-comment">/* 指标 */</span>
<span class="hljs-selector-class">.dashboard</span>     <span class="hljs-comment">/* 仪表板 */</span>
<span class="hljs-selector-class">.data-table</span>    <span class="hljs-comment">/* 数据表格 */</span>
<span class="hljs-selector-class">.pie-chart</span>     <span class="hljs-comment">/* 饼图 */</span>
<span class="hljs-selector-class">.bar-chart</span>     <span class="hljs-comment">/* 柱状图 */</span>
<span class="hljs-selector-class">.line-chart</span>    <span class="hljs-comment">/* 折线图 */</span>
</code></pre>
<p><strong>内容容器</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.accordion</span>     <span class="hljs-comment">/* 手风琴 */</span>
<span class="hljs-selector-class">.carousel</span>      <span class="hljs-comment">/* 轮播图 */</span>
<span class="hljs-selector-class">.widget</span>        <span class="hljs-comment">/* 小部件 */</span>
<span class="hljs-selector-class">.tile</span>          <span class="hljs-comment">/* 磁贴 */</span>
<span class="hljs-selector-class">.collection</span>    <span class="hljs-comment">/* 集合 */</span>
<span class="hljs-selector-class">.feed</span>          <span class="hljs-comment">/* 信息流 */</span>
<span class="hljs-selector-class">.stream</span>        <span class="hljs-comment">/* 流 */</span>
<span class="hljs-selector-class">.grid-view</span>     <span class="hljs-comment">/* 网格视图 */</span>
<span class="hljs-selector-class">.list-view</span>     <span class="hljs-comment">/* 列表视图 */</span>
<span class="hljs-selector-class">.portfolio</span>     <span class="hljs-comment">/* 作品集 */</span>
<span class="hljs-selector-class">.gallery</span>       <span class="hljs-comment">/* 画廊 */</span>
</code></pre>
<p><strong>交互反馈</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.alert</span>         <span class="hljs-comment">/* 警告提示 */</span>
<span class="hljs-selector-class">.toast</span>         <span class="hljs-comment">/* 轻量提示 */</span>
<span class="hljs-selector-class">.notification</span>  <span class="hljs-comment">/* 通知 */</span>
<span class="hljs-selector-class">.snackbar</span>      <span class="hljs-comment">/* 底部提示 */</span>
<span class="hljs-selector-class">.popover</span>       <span class="hljs-comment">/* 弹出框 */</span>
<span class="hljs-selector-class">.tooltip</span>       <span class="hljs-comment">/* 工具提示 */</span>
<span class="hljs-selector-class">.spinner</span>       <span class="hljs-comment">/* 加载器 */</span>
<span class="hljs-selector-class">.skeleton</span>      <span class="hljs-comment">/* 骨架屏 */</span>
<span class="hljs-selector-class">.placeholder</span>   <span class="hljs-comment">/* 占位符 */</span>
<span class="hljs-selector-class">.overlay</span>       <span class="hljs-comment">/* 遮罩层 */</span>
<span class="hljs-selector-class">.backdrop</span>      <span class="hljs-comment">/* 背景遮罩 */</span>
<span class="hljs-selector-class">.indicator</span>     <span class="hljs-comment">/* 指示器 */</span>
</code></pre>
<p><strong>多媒体</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.player</span>        <span class="hljs-comment">/* 播放器 */</span>
<span class="hljs-selector-class">.audio-player</span>  <span class="hljs-comment">/* 音频播放器 */</span>
<span class="hljs-selector-class">.video-player</span>  <span class="hljs-comment">/* 视频播放器 */</span>
<span class="hljs-selector-class">.lightbox</span>      <span class="hljs-comment">/* 灯箱 */</span>
<span class="hljs-selector-class">.slideshow</span>     <span class="hljs-comment">/* 幻灯片 */</span>
<span class="hljs-selector-class">.image</span>         <span class="hljs-comment">/* 图片容器 */</span>
<span class="hljs-selector-class">.video</span>         <span class="hljs-comment">/* 视频容器 */</span>
<span class="hljs-selector-class">.audio</span>         <span class="hljs-comment">/* 音频容器 */</span>
</code></pre>
<p><strong>装饰元素</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.avatar</span>        <span class="hljs-comment">/* 头像 */</span>
<span class="hljs-selector-class">.icon</span>          <span class="hljs-comment">/* 图标 */</span>
<span class="hljs-selector-class">.badge</span>         <span class="hljs-comment">/* 徽章 */</span>
<span class="hljs-selector-class">.label</span>         <span class="hljs-comment">/* 标签 */</span>
<span class="hljs-selector-class">.chip</span>          <span class="hljs-comment">/* 碎片标签 */</span>
<span class="hljs-selector-class">.tag</span>           <span class="hljs-comment">/* 标签 */</span>
<span class="hljs-selector-class">.mark</span>          <span class="hljs-comment">/* 标记 */</span>
<span class="hljs-selector-class">.highlight</span>     <span class="hljs-comment">/* 高亮 */</span>
<span class="hljs-selector-class">.divider</span>       <span class="hljs-comment">/* 分割线 */</span>
<span class="hljs-selector-class">.ornament</span>      <span class="hljs-comment">/* 装饰元素 */</span>
<span class="hljs-selector-class">.decoration</span>    <span class="hljs-comment">/* 装饰 */</span>
<span class="hljs-selector-class">.pattern</span>       <span class="hljs-comment">/* 图案 */</span>
</code></pre>
<p><strong>文本相关</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.heading</span>       <span class="hljs-comment">/* 标题 */</span>
<span class="hljs-selector-class">.subheading</span>    <span class="hljs-comment">/* 副标题 */</span>
<span class="hljs-selector-class">.caption</span>       <span class="hljs-comment">/* 说明文字 */</span>
<span class="hljs-selector-class">.quote</span>         <span class="hljs-comment">/* 引用 */</span>
<span class="hljs-selector-class">.code-block</span>    <span class="hljs-comment">/* 代码块 */</span>
<span class="hljs-selector-class">.text</span>          <span class="hljs-comment">/* 文本容器 */</span>
<span class="hljs-selector-class">.article</span>       <span class="hljs-comment">/* 文章 */</span>
<span class="hljs-selector-class">.testimonial</span>   <span class="hljs-comment">/* 推荐语 */</span>
<span class="hljs-selector-class">.title</span>         <span class="hljs-comment">/* 标题 */</span>
<span class="hljs-selector-class">.subtitle</span>      <span class="hljs-comment">/* 副标题 */</span>
<span class="hljs-selector-class">.paragraph</span>     <span class="hljs-comment">/* 段落 */</span>
</code></pre>
<p><strong>功能模块</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.wizard</span>        <span class="hljs-comment">/* 向导步骤 */</span>
<span class="hljs-selector-class">.tour</span>          <span class="hljs-comment">/* 引导漫游 */</span>
<span class="hljs-selector-class">.help</span>          <span class="hljs-comment">/* 帮助组件 */</span>
<span class="hljs-selector-class">.sorter</span>        <span class="hljs-comment">/* 排序器 */</span>
<span class="hljs-selector-class">.paginator</span>     <span class="hljs-comment">/* 分页器 */</span>
<span class="hljs-selector-class">.wishlist</span>      <span class="hljs-comment">/* 收藏夹 */</span>
<span class="hljs-selector-class">.cart</span>          <span class="hljs-comment">/* 购物车 */</span>
<span class="hljs-selector-class">.checkout</span>      <span class="hljs-comment">/* 结账流程 */</span>
<span class="hljs-selector-class">.settings</span>      <span class="hljs-comment">/* 设置面板 */</span>
<span class="hljs-selector-class">.profile</span>       <span class="hljs-comment">/* 个人资料 */</span>
<span class="hljs-selector-class">.account</span>       <span class="hljs-comment">/* 账户管理 */</span>
</code></pre>
<p><strong>移动端</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.floating-action</span>  <span class="hljs-comment">/* 浮动按钮 */</span>
<span class="hljs-selector-class">.swipe</span>            <span class="hljs-comment">/* 滑动组件 */</span>
<span class="hljs-selector-class">.swipeable</span>        <span class="hljs-comment">/* 可滑动 */</span>
<span class="hljs-selector-class">.pull-to-refresh</span>  <span class="hljs-comment">/* 下拉刷新 */</span>
<span class="hljs-selector-class">.infinite-scroll</span>  <span class="hljs-comment">/* 无限滚动 */</span>
<span class="hljs-selector-class">.app-bar</span>          <span class="hljs-comment">/* 应用栏 */</span>
<span class="hljs-selector-class">.bottom-nav</span>       <span class="hljs-comment">/* 底部导航 */</span>
<span class="hljs-selector-class">.tab-bar</span>          <span class="hljs-comment">/* 标签栏 */</span>
</code></pre>
<p><strong>业务相关</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.product-card</span>     <span class="hljs-comment">/* 商品卡片 */</span>
<span class="hljs-selector-class">.quick-view</span>       <span class="hljs-comment">/* 快速查看 */</span>
<span class="hljs-selector-class">.add-to-cart</span>      <span class="hljs-comment">/* 加入购物车 */</span>
<span class="hljs-selector-class">.review</span>           <span class="hljs-comment">/* 评论 */</span>
<span class="hljs-selector-class">.rating-stars</span>     <span class="hljs-comment">/* 星级评分 */</span>
<span class="hljs-selector-class">.price-display</span>    <span class="hljs-comment">/* 价格显示 */</span>
<span class="hljs-selector-class">.post</span>             <span class="hljs-comment">/* 帖子 */</span>
<span class="hljs-selector-class">.comment-thread</span>   <span class="hljs-comment">/* 评论线程 */</span>
<span class="hljs-selector-class">.like-button</span>      <span class="hljs-comment">/* 点赞按钮 */</span>
<span class="hljs-selector-class">.share-menu</span>       <span class="hljs-comment">/* 分享菜单 */</span>
<span class="hljs-selector-class">.notification-bell</span> <span class="hljs-comment">/* 通知铃 */</span>
<span class="hljs-selector-class">.profile-card</span>     <span class="hljs-comment">/* 个人资料卡片 */</span>
</code></pre>
<p><strong>营销展示</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.banner</span>       <span class="hljs-comment">/* 横幅 */</span>
<span class="hljs-selector-class">.hero</span>         <span class="hljs-comment">/* 主视觉区 */</span>
<span class="hljs-selector-class">.feature</span>      <span class="hljs-comment">/* 特色区 */</span>
<span class="hljs-selector-class">.cta</span>          <span class="hljs-comment">/* 行动号召 */</span>
<span class="hljs-selector-class">.promo</span>        <span class="hljs-comment">/* 推广区块 */</span>
<span class="hljs-selector-class">.spotlight</span>    <span class="hljs-comment">/* 聚光灯区 */</span>
<span class="hljs-selector-class">.showcase</span>     <span class="hljs-comment">/* 展示区 */</span>
<span class="hljs-selector-class">.ad</span>           <span class="hljs-comment">/* 广告 */</span>
<span class="hljs-selector-class">.newsletter</span>   <span class="hljs-comment">/* 新闻订阅 */</span>
</code></pre>
<p><strong>形状组件</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.circle</span>       <span class="hljs-comment">/* 圆形 */</span>
<span class="hljs-selector-class">.square</span>       <span class="hljs-comment">/* 方形 */</span>
<span class="hljs-selector-class">.triangle</span>     <span class="hljs-comment">/* 三角形 */</span>
<span class="hljs-selector-class">.diamond</span>      <span class="hljs-comment">/* 菱形 */</span>
<span class="hljs-selector-class">.hexagon</span>      <span class="hljs-comment">/* 六边形 */</span>
<span class="hljs-selector-class">.oval</span>         <span class="hljs-comment">/* 椭圆形 */</span>
<span class="hljs-selector-class">.polygon</span>      <span class="hljs-comment">/* 多边形 */</span>
</code></pre>
<p><strong>状态指示器</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.status</span>       <span class="hljs-comment">/* 状态显示 */</span>
<span class="hljs-selector-class">.signal</span>       <span class="hljs-comment">/* 信号指示 */</span>
<span class="hljs-selector-class">.dot</span>          <span class="hljs-comment">/* 点状指示 */</span>
<span class="hljs-selector-class">.marker</span>       <span class="hljs-comment">/* 标记 */</span>
<span class="hljs-selector-class">.flag</span>         <span class="hljs-comment">/* 标志 */</span>
</code></pre>
<p><strong>链接相关</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.link</span>           <span class="hljs-comment">/* 链接 */</span>
<span class="hljs-selector-class">.external-link</span>  <span class="hljs-comment">/* 外部链接 */</span>
<span class="hljs-selector-class">.internal-link</span>  <span class="hljs-comment">/* 内部链接 */</span>
<span class="hljs-selector-class">.nav-link</span>       <span class="hljs-comment">/* 导航链接 */</span>
<span class="hljs-selector-class">.button-link</span>    <span class="hljs-comment">/* 按钮样式链接 */</span>
</code></pre>
<p><strong>用户界面</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.user-profile</span>    <span class="hljs-comment">/* 用户资料 */</span>
<span class="hljs-selector-class">.user-settings</span>   <span class="hljs-comment">/* 用户设置 */</span>
<span class="hljs-selector-class">.preferences</span>     <span class="hljs-comment">/* 偏好设置 */</span>
<span class="hljs-selector-class">.theme-switcher</span>  <span class="hljs-comment">/* 主题切换器 */</span>
</code></pre>
<p><strong>通知系统</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.notification-center</span>  <span class="hljs-comment">/* 通知中心 */</span>
<span class="hljs-selector-class">.notification-bell</span>    <span class="hljs-comment">/* 通知铃 */</span>
<span class="hljs-selector-class">.message-center</span>      <span class="hljs-comment">/* 消息中心 */</span>
<span class="hljs-selector-class">.inbox</span>              <span class="hljs-comment">/* 收件箱 */</span>
</code></pre>
<p><strong>数据分析</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.analytics</span>       <span class="hljs-comment">/* 分析 */</span>
<span class="hljs-selector-class">.report</span>          <span class="hljs-comment">/* 报告 */</span>
<span class="hljs-selector-class">.report-generator</span> <span class="hljs-comment">/* 报告生成器 */</span>
<span class="hljs-selector-class">.data-export</span>     <span class="hljs-comment">/* 数据导出 */</span>
<span class="hljs-selector-class">.statistics</span>      <span class="hljs-comment">/* 统计数据 */</span>
</code></pre>
<p><strong>系统管理</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.admin-panel</span>     <span class="hljs-comment">/* 管理面板 */</span>
<span class="hljs-selector-class">.system-status</span>   <span class="hljs-comment">/* 系统状态 */</span>
<span class="hljs-selector-class">.backup</span>          <span class="hljs-comment">/* 备份 */</span>
<span class="hljs-selector-class">.restore</span>         <span class="hljs-comment">/* 恢复 */</span>
<span class="hljs-selector-class">.logs</span>            <span class="hljs-comment">/* 日志 */</span>
<span class="hljs-selector-class">.audit</span>           <span class="hljs-comment">/* 审计 */</span>
</code></pre>
<p><strong>时间相关</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.timeline</span>        <span class="hljs-comment">/* 时间线 */</span>
<span class="hljs-selector-class">.schedule</span>        <span class="hljs-comment">/* 计划 */</span>
<span class="hljs-selector-class">.calendar</span>        <span class="hljs-comment">/* 日历 */</span>
<span class="hljs-selector-class">.time-range</span>      <span class="hljs-comment">/* 时间范围 */</span>
<span class="hljs-selector-class">.date-selector</span>   <span class="hljs-comment">/* 日期选择器 */</span>
</code></pre>
<p><strong>状态指示</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.status-indicator</span> <span class="hljs-comment">/* 状态指示器 */</span>
<span class="hljs-selector-class">.health-status</span>   <span class="hljs-comment">/* 健康状态 */</span>
<span class="hljs-selector-class">.connection-status</span> <span class="hljs-comment">/* 连接状态 */</span>
<span class="hljs-selector-class">.battery-level</span>   <span class="hljs-comment">/* 电池电量 */</span>
</code></pre>
<p><strong>图表类型</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.line-chart</span>      <span class="hljs-comment">/* 折线图 */</span>
<span class="hljs-selector-class">.bar-chart</span>       <span class="hljs-comment">/* 柱状图 */</span>
<span class="hljs-selector-class">.pie-chart</span>       <span class="hljs-comment">/* 饼图 */</span>
<span class="hljs-selector-class">.area-chart</span>      <span class="hljs-comment">/* 面积图 */</span>
<span class="hljs-selector-class">.scatter-plot</span>    <span class="hljs-comment">/* 散点图 */</span>
<span class="hljs-selector-class">.heatmap</span>         <span class="hljs-comment">/* 热力图 */</span>
<span class="hljs-selector-class">.gauge-chart</span>     <span class="hljs-comment">/* 仪表图 */</span>
</code></pre>
<p><strong>工具类组件</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.toolbar</span>         <span class="hljs-comment">/* 工具栏 */</span>
<span class="hljs-selector-class">.context-menu</span>    <span class="hljs-comment">/* 上下文菜单 */</span>
<span class="hljs-selector-class">.shortcut</span>        <span class="hljs-comment">/* 快捷方式 */</span>
<span class="hljs-selector-class">.quick-action</span>    <span class="hljs-comment">/* 快速操作 */</span>
<span class="hljs-selector-class">.bulk-action</span>     <span class="hljs-comment">/* 批量操作 */</span>
<span class="hljs-selector-class">.wizard</span>          <span class="hljs-comment">/* 向导 */</span>
<span class="hljs-selector-class">.tour</span>            <span class="hljs-comment">/* 引导 */</span>
<span class="hljs-selector-class">.help-tooltip</span>    <span class="hljs-comment">/* 帮助提示 */</span>
</code></pre>
<p><strong>响应式组件</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.mobile-view</span>     <span class="hljs-comment">/* 移动端视图 */</span>
<span class="hljs-selector-class">.tablet-view</span>     <span class="hljs-comment">/* 平板视图 */</span>
<span class="hljs-selector-class">.desktop-view</span>    <span class="hljs-comment">/* 桌面视图 */</span>
<span class="hljs-selector-class">.responsive-grid</span> <span class="hljs-comment">/* 响应式网格 */</span>
<span class="hljs-selector-class">.adaptive-layout</span> <span class="hljs-comment">/* 自适应布局 */</span>
</code></pre>
<p><strong>交互组件</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.drag-drop</span>       <span class="hljs-comment">/* 拖放 */</span>
<span class="hljs-selector-class">.dropzone</span>        <span class="hljs-comment">/* 放置区域 */</span>
<span class="hljs-selector-class">.draggable</span>       <span class="hljs-comment">/* 可拖动 */</span>
<span class="hljs-selector-class">.sortable</span>        <span class="hljs-comment">/* 可排序 */</span>
<span class="hljs-selector-class">.resizable</span>       <span class="hljs-comment">/* 可调整大小 */</span>
<span class="hljs-selector-class">.collapsible</span>     <span class="hljs-comment">/* 可折叠 */</span>
<span class="hljs-selector-class">.accordion</span>       <span class="hljs-comment">/* 手风琴 */</span>
</code></pre>
<p><strong>存储相关</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.storage</span>         <span class="hljs-comment">/* 存储 */</span>
<span class="hljs-selector-class">.storage-usage</span>   <span class="hljs-comment">/* 存储使用情况 */</span>
<span class="hljs-selector-class">.quota</span>           <span class="hljs-comment">/* 配额 */</span>
<span class="hljs-selector-class">.backup-status</span>   <span class="hljs-comment">/* 备份状态 */</span>
<span class="hljs-selector-class">.cloud-storage</span>   <span class="hljs-comment">/* 云存储 */</span>
<span class="hljs-selector-class">.local-storage</span>   <span class="hljs-comment">/* 本地存储 */</span>
</code></pre>
<p><strong>安全组件</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.authentication</span>  <span class="hljs-comment">/* 身份验证 */</span>
<span class="hljs-selector-class">.login</span>           <span class="hljs-comment">/* 登录 */</span>
<span class="hljs-selector-class">.logout</span>          <span class="hljs-comment">/* 登出 */</span>
<span class="hljs-selector-class">.password</span>        <span class="hljs-comment">/* 密码 */</span>
<span class="hljs-selector-class">.two-factor</span>      <span class="hljs-comment">/* 双重认证 */</span>
<span class="hljs-selector-class">.encryption</span>      <span class="hljs-comment">/* 加密 */</span>
<span class="hljs-selector-class">.security-log</span>    <span class="hljs-comment">/* 安全日志 */</span>
</code></pre>
<p><strong>监控组件</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.monitoring</span>      <span class="hljs-comment">/* 监控 */</span>
<span class="hljs-selector-class">.real-time</span>       <span class="hljs-comment">/* 实时 */</span>
<span class="hljs-selector-class">.historical</span>      <span class="hljs-comment">/* 历史 */</span>
<span class="hljs-selector-class">.trend-analysis</span>  <span class="hljs-comment">/* 趋势分析 */</span>
<span class="hljs-selector-class">.performance</span>     <span class="hljs-comment">/* 性能 */</span>
<span class="hljs-selector-class">.uptime</span>          <span class="hljs-comment">/* 运行时间 */</span>
<span class="hljs-selector-class">.downtime</span>        <span class="hljs-comment">/* 停机时间 */</span>
</code></pre>
<p><strong>同步组件</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.sync</span>            <span class="hljs-comment">/* 同步 */</span>
<span class="hljs-selector-class">.sync-status</span>     <span class="hljs-comment">/* 同步状态 */</span>
<span class="hljs-selector-class">.offline</span>         <span class="hljs-comment">/* 离线 */</span>
<span class="hljs-selector-class">.online</span>          <span class="hljs-comment">/* 在线 */</span>
<span class="hljs-selector-class">.conflict</span>        <span class="hljs-comment">/* 冲突 */</span>
<span class="hljs-selector-class">.conflict-resolution</span> <span class="hljs-comment">/* 冲突解决 */</span>
</code></pre>
<p><strong>报告组件</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">.report          <span class="hljs-comment">/* 报告 */</span>
.report-builder  <span class="hljs-comment">/* 报告构建器 */</span>
.report-<span class="hljs-keyword">template</span> <span class="hljs-comment">/* 报告模板 */</span>
.<span class="hljs-keyword">export</span>-report   <span class="hljs-comment">/* 导出报告 */</span>
.print-report    <span class="hljs-comment">/* 打印报告 */</span>
.schedule-report <span class="hljs-comment">/* 计划报告 */</span>
</code></pre>
<h4 data-id="heading-12">Element</h4>
<p>元素是块的子节点，元素表示的目的，而不是状态。块和元素之间用一个双下划线划开。</p>
<p><strong>布局结构类</strong></p>
<pre><code class="hljs language-css" lang="css">__header     <span class="hljs-comment">/* 头部 */</span>
__footer     <span class="hljs-comment">/* 脚部 */</span>
__body       <span class="hljs-comment">/* 主体 */</span>
__main       <span class="hljs-comment">/* 主要区域 */</span>
__aside      <span class="hljs-comment">/* 侧边区域 */</span>
__content    <span class="hljs-comment">/* 内容区域 */</span>
__container  <span class="hljs-comment">/* 容器 */</span>
__wrapper    <span class="hljs-comment">/* 包装器 */</span>
__inner      <span class="hljs-comment">/* 内部容器 */</span>
__section    <span class="hljs-comment">/* 区块 */</span>
__group      <span class="hljs-comment">/* 分组 */</span>
__panel      <span class="hljs-comment">/* 面板 */</span>
__frame      <span class="hljs-comment">/* 框架 */</span>
</code></pre>
<p><strong>导航与交互</strong></p>
<pre><code class="hljs language-css" lang="css">__item       <span class="hljs-comment">/* 项目/项 */</span>
__link       <span class="hljs-comment">/* 链接 */</span>
__button     <span class="hljs-comment">/* 按钮 */</span>
__icon       <span class="hljs-comment">/* 图标 */</span>
__toggle     <span class="hljs-comment">/* 切换开关 */</span>
__arrow      <span class="hljs-comment">/* 箭头 */</span>
__caret      <span class="hljs-comment">/* 指示箭头 */</span>
__handle     <span class="hljs-comment">/* 手柄/把手 */</span>
__drag       <span class="hljs-comment">/* 拖拽手柄 */</span>
__scroll     <span class="hljs-comment">/* 滚动区域 */</span>
__trigger    <span class="hljs-comment">/* 触发器 */</span>
__action     <span class="hljs-comment">/* 操作按钮 */</span>
</code></pre>
<p><strong>内容显示</strong></p>
<pre><code class="hljs language-css" lang="css">__title      <span class="hljs-comment">/* 标题 */</span>
__subtitle   <span class="hljs-comment">/* 副标题 */</span>
__heading    <span class="hljs-comment">/* 标题（可细分 __heading-1, __heading-2） */</span>
__text       <span class="hljs-comment">/* 文本 */</span>
__label      <span class="hljs-comment">/* 标签文字 */</span>
__caption    <span class="hljs-comment">/* 说明文字 */</span>
__description<span class="hljs-comment">/* 描述 */</span>
__summary    <span class="hljs-comment">/* 摘要 */</span>
__paragraph  <span class="hljs-comment">/* 段落 */</span>
__quote      <span class="hljs-comment">/* 引用 */</span>
__code       <span class="hljs-comment">/* 代码 */</span>
__image      <span class="hljs-comment">/* 图片 */</span>
__video      <span class="hljs-comment">/* 视频 */</span>
__audio      <span class="hljs-comment">/* 音频 */</span>
__media      <span class="hljs-comment">/* 媒体内容 */</span>
</code></pre>
<p> <strong>表单元素</strong></p>
<pre><code class="hljs language-css" lang="css">__input      <span class="hljs-comment">/* 输入框 */</span>
__textarea   <span class="hljs-comment">/* 文本域 */</span>
__select     <span class="hljs-comment">/* 选择框 */</span>
__option     <span class="hljs-comment">/* 选项 */</span>
__checkbox   <span class="hljs-comment">/* 复选框 */</span>
__radio      <span class="hljs-comment">/* 单选按钮 */</span>
__field      <span class="hljs-comment">/* 表单字段 */</span>
__label      <span class="hljs-comment">/* 表单标签 */</span>
__hint       <span class="hljs-comment">/* 提示文字 */</span>
__error      <span class="hljs-comment">/* 错误信息 */</span>
__success    <span class="hljs-comment">/* 成功信息 */</span>
__warning    <span class="hljs-comment">/* 警告信息 */</span>
__validation <span class="hljs-comment">/* 验证信息 */</span>
</code></pre>
<p><strong>列表与集合</strong></p>
<pre><code class="hljs language-css" lang="css">__list       <span class="hljs-comment">/* 列表 */</span>
__item       <span class="hljs-comment">/* 列表项 */</span>
__entry      <span class="hljs-comment">/* 条目 */</span>
__row        <span class="hljs-comment">/* 行 */</span>
__cell       <span class="hljs-comment">/* 单元格 */</span>
__col        <span class="hljs-comment">/* 列 */</span>
__grid       <span class="hljs-comment">/* 网格项 */</span>
__card       <span class="hljs-comment">/* 卡片 */</span>
__tile       <span class="hljs-comment">/* 磁贴 */</span>
__block      <span class="hljs-comment">/* 块状项 */</span>
__segment    <span class="hljs-comment">/* 分段 */</span>
__piece      <span class="hljs-comment">/* 片段 */</span>
</code></pre>
<p><strong>信息与状态</strong></p>
<pre><code class="hljs language-css" lang="css">__status     <span class="hljs-comment">/* 状态显示 */</span>
__badge      <span class="hljs-comment">/* 徽章 */</span>
__tag        <span class="hljs-comment">/* 标签 */</span>
__marker     <span class="hljs-comment">/* 标记 */</span>
__indicator  <span class="hljs-comment">/* 指示器 */</span>
__signal     <span class="hljs-comment">/* 信号 */</span>
__dot        <span class="hljs-comment">/* 点状指示 */</span>
__counter    <span class="hljs-comment">/* 计数器 */</span>
__number     <span class="hljs-comment">/* 数字显示 */</span>
__value      <span class="hljs-comment">/* 数值 */</span>
__percentage <span class="hljs-comment">/* 百分比 */</span>
__rating     <span class="hljs-comment">/* 评分 */</span>
__star       <span class="hljs-comment">/* 星星 */</span>
</code></pre>
<p><strong>装饰与辅助</strong></p>
<pre><code class="hljs language-css" lang="css">__icon       <span class="hljs-comment">/* 图标 */</span>
__avatar     <span class="hljs-comment">/* 头像 */</span>
__thumbnail  <span class="hljs-comment">/* 缩略图 */</span>
__preview    <span class="hljs-comment">/* 预览图 */</span>
__background <span class="hljs-comment">/* 背景 */</span>
__overlay    <span class="hljs-comment">/* 遮罩层 */</span>
__shadow     <span class="hljs-comment">/* 阴影 */</span>
__border     <span class="hljs-comment">/* 边框 */</span>
__divider    <span class="hljs-comment">/* 分割线 */</span>
__separator  <span class="hljs-comment">/* 分隔符 */</span>
__ornament   <span class="hljs-comment">/* 装饰元素 */</span>
__pattern    <span class="hljs-comment">/* 图案 */</span>
__gradient   <span class="hljs-comment">/* 渐变 */</span>
</code></pre>
<p><strong>工具与控制</strong></p>
<pre><code class="hljs language-css" lang="css">__toolbar    <span class="hljs-comment">/* 工具栏 */</span>
__tool       <span class="hljs-comment">/* 工具按钮 */</span>
__control    <span class="hljs-comment">/* 控制元素 */</span>
__settings   <span class="hljs-comment">/* 设置按钮 */</span>
__config     <span class="hljs-comment">/* 配置 */</span>
__option     <span class="hljs-comment">/* 选项按钮 */</span>
__switch     <span class="hljs-comment">/* 开关 */</span>
__slider     <span class="hljs-comment">/* 滑块 */</span>
__handle     <span class="hljs-comment">/* 滑块手柄 */</span>
__knob       <span class="hljs-comment">/* 旋钮 */</span>
__dial       <span class="hljs-comment">/* 刻度盘 */</span>
</code></pre>
<p><strong>时间与进度</strong></p>
<pre><code class="hljs language-css" lang="css">__time       <span class="hljs-comment">/* 时间显示 */</span>
__date       <span class="hljs-comment">/* 日期显示 */</span>
__timestamp  <span class="hljs-comment">/* 时间戳 */</span>
__duration   <span class="hljs-comment">/* 时长 */</span>
__progress   <span class="hljs-comment">/* 进度条 */</span>
__bar        <span class="hljs-comment">/* 进度条条状部分 */</span>
__track      <span class="hljs-comment">/* 轨道 */</span>
__step       <span class="hljs-comment">/* 步骤 */</span>
__milestone  <span class="hljs-comment">/* 里程碑 */</span>
__clock      <span class="hljs-comment">/* 时钟 */</span>
__calendar   <span class="hljs-comment">/* 日历 */</span>
</code></pre>
<p><strong>交互反馈</strong></p>
<pre><code class="hljs language-css" lang="css">__loading    <span class="hljs-comment">/* 加载指示器 */</span>
__spinner    <span class="hljs-comment">/* 旋转器 */</span>
__skeleton   <span class="hljs-comment">/* 骨架屏元素 */</span>
__placeholder<span class="hljs-comment">/* 占位符 */</span>
__hint       <span class="hljs-comment">/* 提示 */</span>
__tooltip    <span class="hljs-comment">/* 工具提示内容 */</span>
__popup      <span class="hljs-comment">/* 弹出内容 */</span>
__message    <span class="hljs-comment">/* 消息内容 */</span>
__alert      <span class="hljs-comment">/* 警告内容 */</span>
__toast      <span class="hljs-comment">/* 轻提示内容 */</span>
__notification <span class="hljs-comment">/* 通知内容 */</span>
</code></pre>
<p><strong>导航组件 (Navigation)</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* .menu 的 Element */</span>
__item       <span class="hljs-comment">/* 菜单项 */</span>
__link       <span class="hljs-comment">/* 菜单链接 */</span>
__icon       <span class="hljs-comment">/* 菜单图标 */</span>
__text       <span class="hljs-comment">/* 菜单文字 */</span>
__submenu    <span class="hljs-comment">/* 子菜单 */</span>
__dropdown   <span class="hljs-comment">/* 下拉菜单 */</span>

<span class="hljs-comment">/* .tabs 的 Element */</span>
__tab        <span class="hljs-comment">/* 标签页 */</span>
__content    <span class="hljs-comment">/* 标签内容 */</span>
__nav        <span class="hljs-comment">/* 标签导航 */</span>
__panel      <span class="hljs-comment">/* 标签面板 */</span>

<span class="hljs-comment">/* .breadcrumb 的 Element */</span>
__crumb      <span class="hljs-comment">/* 面包屑项 */</span>
__separator  <span class="hljs-comment">/* 分隔符 */</span>
</code></pre>
<p><strong>表单组件 (Forms)</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* .form 的 Element */</span>
__group      <span class="hljs-comment">/* 表单组 */</span>
__field      <span class="hljs-comment">/* 表单字段 */</span>
__label      <span class="hljs-comment">/* 标签 */</span>
__input      <span class="hljs-comment">/* 输入框 */</span>
__error      <span class="hljs-comment">/* 错误信息 */</span>
__help       <span class="hljs-comment">/* 帮助文字 */</span>
__submit     <span class="hljs-comment">/* 提交按钮 */</span>
__reset      <span class="hljs-comment">/* 重置按钮 */</span>

<span class="hljs-comment">/* .input 的 Element */</span>
__wrapper    <span class="hljs-comment">/* 包装器 */</span>
__field      <span class="hljs-comment">/* 输入区域 */</span>
__prefix     <span class="hljs-comment">/* 前缀 */</span>
__suffix     <span class="hljs-comment">/* 后缀 */</span>
__clear      <span class="hljs-comment">/* 清除按钮 */</span>
</code></pre>
<p><strong>卡片组件 (Cards)</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* .card 的 Element */</span>
__header     <span class="hljs-comment">/* 卡片头部 */</span>
__title      <span class="hljs-comment">/* 卡片标题 */</span>
__subtitle   <span class="hljs-comment">/* 卡片副标题 */</span>
__body       <span class="hljs-comment">/* 卡片主体 */</span>
__content    <span class="hljs-comment">/* 卡片内容 */</span>
__footer     <span class="hljs-comment">/* 卡片脚部 */</span>
__image      <span class="hljs-comment">/* 卡片图片 */</span>
__actions    <span class="hljs-comment">/* 卡片操作区 */</span>
__button     <span class="hljs-comment">/* 卡片按钮 */</span>
</code></pre>
<p><strong>模态框 (Modals)</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* .modal 的 Element */</span>
__overlay    <span class="hljs-comment">/* 遮罩层 */</span>
__dialog     <span class="hljs-comment">/* 对话框 */</span>
__header     <span class="hljs-comment">/* 头部 */</span>
__title      <span class="hljs-comment">/* 标题 */</span>
__close      <span class="hljs-comment">/* 关闭按钮 */</span>
__body       <span class="hljs-comment">/* 主体 */</span>
__content    <span class="hljs-comment">/* 内容 */</span>
__footer     <span class="hljs-comment">/* 脚部 */</span>
__actions    <span class="hljs-comment">/* 操作区 */</span>
</code></pre>
<p><strong>数据表格 (Tables)</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* .table 的 Element */</span>
__header     <span class="hljs-comment">/* 表头 */</span>
__head       <span class="hljs-comment">/* 头部区域 */</span>
__body       <span class="hljs-comment">/* 表格主体 */</span>
__footer     <span class="hljs-comment">/* 表格脚部 */</span>
__row        <span class="hljs-comment">/* 行 */</span>
__cell       <span class="hljs-comment">/* 单元格 */</span>
__col        <span class="hljs-comment">/* 列 */</span>
__sort       <span class="hljs-comment">/* 排序按钮 */</span>
__filter     <span class="hljs-comment">/* 筛选按钮 */</span>
__pagination <span class="hljs-comment">/* 分页区域 */</span>
</code></pre>
<p><strong>工具栏 (Toolbars)</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* .toolbar 的 Element */</span>
__left       <span class="hljs-comment">/* 左侧区域 */</span>
__center     <span class="hljs-comment">/* 中间区域 */</span>
__right      <span class="hljs-comment">/* 右侧区域 */</span>
__item       <span class="hljs-comment">/* 工具项 */</span>
__button     <span class="hljs-comment">/* 工具按钮 */</span>
__separator  <span class="hljs-comment">/* 分隔符 */</span>
__search     <span class="hljs-comment">/* 搜索框 */</span>
__filter     <span class="hljs-comment">/* 筛选器 */</span>
__sort       <span class="hljs-comment">/* 排序器 */</span>
</code></pre>
<p><strong>轮播图 (Carousels)</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* .carousel 的 Element */</span>
__slide      <span class="hljs-comment">/* 幻灯片 */</span>
__content    <span class="hljs-comment">/* 幻灯片内容 */</span>
__image      <span class="hljs-comment">/* 幻灯片图片 */</span>
__caption    <span class="hljs-comment">/* 幻灯片说明 */</span>
__prev       <span class="hljs-comment">/* 上一个按钮 */</span>
__next       <span class="hljs-comment">/* 下一个按钮 */</span>
__dots       <span class="hljs-comment">/* 指示点区域 */</span>
__dot        <span class="hljs-comment">/* 单个指示点 */</span>
__pagination <span class="hljs-comment">/* 分页指示器 */</span>
</code></pre>
<p><strong>图表组件 (Charts)</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* .chart 的 Element */</span>
__container  <span class="hljs-comment">/* 容器 */</span>
__canvas     <span class="hljs-comment">/* 画布 */</span>
__axis       <span class="hljs-comment">/* 坐标轴 */</span>
__axis-x     <span class="hljs-comment">/* X轴 */</span>
__axis-y     <span class="hljs-comment">/* Y轴 */</span>
__grid       <span class="hljs-comment">/* 网格线 */</span>
__legend     <span class="hljs-comment">/* 图例 */</span>
__tooltip    <span class="hljs-comment">/* 工具提示 */</span>
__data       <span class="hljs-comment">/* 数据点 */</span>
__bar        <span class="hljs-comment">/* 柱状 */</span>
__line       <span class="hljs-comment">/* 线条 */</span>
__area       <span class="hljs-comment">/* 面积 */</span>
</code></pre>
<p><strong>通知组件 (Notifications)</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* .notification 的 Element */</span>
__icon       <span class="hljs-comment">/* 图标 */</span>
__title      <span class="hljs-comment">/* 标题 */</span>
__message    <span class="hljs-comment">/* 消息内容 */</span>
__close      <span class="hljs-comment">/* 关闭按钮 */</span>
__actions    <span class="hljs-comment">/* 操作按钮 */</span>
__time       <span class="hljs-comment">/* 时间显示 */</span>
__progress   <span class="hljs-comment">/* 进度条 */</span>
</code></pre>
<p><strong>位置关系</strong></p>
<pre><code class="hljs language-css" lang="css">__top        <span class="hljs-comment">/* 顶部 */</span>
__bottom     <span class="hljs-comment">/* 底部 */</span>
__left       <span class="hljs-comment">/* 左侧 */</span>
__right      <span class="hljs-comment">/* 右侧 */</span>
__center     <span class="hljs-comment">/* 中间 */</span>
__side       <span class="hljs-comment">/* 侧边 */</span>
__edge       <span class="hljs-comment">/* 边缘 */</span>
__corner     <span class="hljs-comment">/* 角落 */</span>
__start      <span class="hljs-comment">/* 起始端 */</span>
__end        <span class="hljs-comment">/* 结束端 */</span>
</code></pre>
<p> <strong>大小尺寸</strong></p>
<pre><code class="hljs language-css" lang="css">__small      <span class="hljs-comment">/* 小尺寸 */</span>
__medium     <span class="hljs-comment">/* 中尺寸 */</span>
__large      <span class="hljs-comment">/* 大尺寸 */</span>
__mini       <span class="hljs-comment">/* 迷你尺寸 */</span>
__tiny       <span class="hljs-comment">/* 超小尺寸 */</span>
__compact    <span class="hljs-comment">/* 紧凑型 */</span>
__expanded   <span class="hljs-comment">/* 展开型 */</span>
__full       <span class="hljs-comment">/* 全尺寸 */</span>
</code></pre>
<p><strong>状态指示</strong></p>
<pre><code class="hljs language-css" lang="css">__active     <span class="hljs-comment">/* 激活状态 */</span>
__inactive   <span class="hljs-comment">/* 非激活状态 */</span>
__enabled    <span class="hljs-comment">/* 启用状态 */</span>
__disabled   <span class="hljs-comment">/* 禁用状态 */</span>
__selected   <span class="hljs-comment">/* 选中状态 */</span>
__checked    <span class="hljs-comment">/* 勾选状态 */</span>
__focused    <span class="hljs-comment">/* 聚焦状态 */</span>
__hover      <span class="hljs-comment">/* 悬停状态 */</span>
__pressed    <span class="hljs-comment">/* 按下状态 */</span>
</code></pre>
<p><strong>数量关系</strong></p>
<pre><code class="hljs language-css" lang="css">__single     <span class="hljs-comment">/* 单个 */</span>
__multiple   <span class="hljs-comment">/* 多个 */</span>
__first      <span class="hljs-comment">/* 第一个 */</span>
__last       <span class="hljs-comment">/* 最后一个 */</span>
__even       <span class="hljs-comment">/* 偶数 */</span>
__odd        <span class="hljs-comment">/* 奇数 */</span>
__nth        <span class="hljs-comment">/* 第n个 */</span>
__all        <span class="hljs-comment">/* 所有 */</span>
__none       <span class="hljs-comment">/* 无 */</span>
</code></pre>
<p><strong>时间关系</strong></p>
<pre><code class="hljs language-css" lang="css">__past       <span class="hljs-comment">/* 过去 */</span>
__present    <span class="hljs-comment">/* 现在 */</span>
__future     <span class="hljs-comment">/* 未来 */</span>
__old        <span class="hljs-comment">/* 旧的 */</span>
__new        <span class="hljs-comment">/* 新的 */</span>
__current    <span class="hljs-comment">/* 当前的 */</span>
__previous   <span class="hljs-comment">/* 上一个 */</span>
__next       <span class="hljs-comment">/* 下一个 */</span>
</code></pre>
<p><strong>功能角色</strong></p>
<pre><code class="hljs language-css" lang="css">__primary    <span class="hljs-comment">/* 主要的 */</span>
__secondary  <span class="hljs-comment">/* 次要的 */</span>
__tertiary   <span class="hljs-comment">/* 第三级的 */</span>
__auxiliary  <span class="hljs-comment">/* 辅助的 */</span>
__main       <span class="hljs-comment">/* 主要的 */</span>
__sub        <span class="hljs-comment">/* 次要的 */</span>
__support    <span class="hljs-comment">/* 支持的 */</span>
__detail     <span class="hljs-comment">/* 详细的 */</span>
</code></pre>
<h3 data-id="heading-13">Modifier</h3>
<p>修饰符是改变某个块的外观的标志。要使用修饰符，用一个双短横线线隔开</p>
<h4 data-id="heading-14">通用状态</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--active</span>      <span class="hljs-comment">/* 激活/活动状态 */</span>
<span class="hljs-attr">--inactive</span>    <span class="hljs-comment">/* 非激活状态 */</span>
<span class="hljs-attr">--enabled</span>     <span class="hljs-comment">/* 启用状态 */</span>
<span class="hljs-attr">--disabled</span>    <span class="hljs-comment">/* 禁用状态 */</span>
<span class="hljs-attr">--selected</span>    <span class="hljs-comment">/* 选中状态 */</span>
<span class="hljs-attr">--checked</span>     <span class="hljs-comment">/* 已勾选 */</span>
<span class="hljs-attr">--unchecked</span>   <span class="hljs-comment">/* 未勾选 */</span>
<span class="hljs-attr">--focused</span>     <span class="hljs-comment">/* 获得焦点 */</span>
<span class="hljs-attr">--blurred</span>     <span class="hljs-comment">/* 失去焦点 */</span>
<span class="hljs-attr">--hover</span>       <span class="hljs-comment">/* 悬停状态 */</span>
<span class="hljs-attr">--pressed</span>     <span class="hljs-comment">/* 按下状态 */</span>
<span class="hljs-attr">--dragging</span>    <span class="hljs-comment">/* 拖拽中 */</span>
<span class="hljs-attr">--loading</span>     <span class="hljs-comment">/* 加载中 */</span>
<span class="hljs-attr">--processing</span>  <span class="hljs-comment">/* 处理中 */</span>
<span class="hljs-attr">--waiting</span>     <span class="hljs-comment">/* 等待中 */</span>
</code></pre>
<h4 data-id="heading-15">可见性状态</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--visible</span>     <span class="hljs-comment">/* 可见 */</span>
<span class="hljs-attr">--hidden</span>      <span class="hljs-comment">/* 隐藏 */</span>
<span class="hljs-attr">--collapsed</span>   <span class="hljs-comment">/* 折叠 */</span>
<span class="hljs-attr">--expanded</span>    <span class="hljs-comment">/* 展开 */</span>
<span class="hljs-attr">--closed</span>      <span class="hljs-comment">/* 关闭 */</span>
<span class="hljs-attr">--open</span>        <span class="hljs-comment">/* 打开 */</span>
<span class="hljs-attr">--show</span>        <span class="hljs-comment">/* 显示 */</span>
<span class="hljs-attr">--hide</span>        <span class="hljs-comment">/* 隐藏 */</span>
</code></pre>
<h4 data-id="heading-16">交互状态</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--clickable</span>   <span class="hljs-comment">/* 可点击 */</span>
<span class="hljs-attr">--editable</span>    <span class="hljs-comment">/* 可编辑 */</span>
<span class="hljs-attr">--draggable</span>   <span class="hljs-comment">/* 可拖动 */</span>
<span class="hljs-attr">--droppable</span>   <span class="hljs-comment">/* 可放置 */</span>
<span class="hljs-attr">--sortable</span>    <span class="hljs-comment">/* 可排序 */</span>
<span class="hljs-attr">--resizable</span>   <span class="hljs-comment">/* 可调整大小 */</span>
<span class="hljs-attr">--selectable</span>  <span class="hljs-comment">/* 可选择 */</span>
</code></pre>
<h4 data-id="heading-17">数据状态</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--empty</span>       <span class="hljs-comment">/* 空状态 */</span>
<span class="hljs-attr">--filled</span>      <span class="hljs-comment">/* 已填充 */</span>
<span class="hljs-attr">--valid</span>       <span class="hljs-comment">/* 有效 */</span>
<span class="hljs-attr">--invalid</span>     <span class="hljs-comment">/* 无效 */</span>
<span class="hljs-attr">--verified</span>    <span class="hljs-comment">/* 已验证 */</span>
<span class="hljs-attr">--unverified</span>  <span class="hljs-comment">/* 未验证 */</span>
<span class="hljs-attr">--dirty</span>       <span class="hljs-comment">/* 已修改（表单） */</span>
<span class="hljs-attr">--clean</span>       <span class="hljs-comment">/* 未修改 */</span>
</code></pre>
<h4 data-id="heading-18">文件/上传状态</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--uploading</span>   <span class="hljs-comment">/* 上传中 */</span>
<span class="hljs-attr">--uploaded</span>    <span class="hljs-comment">/* 已上传 */</span>
<span class="hljs-attr">--failed</span>      <span class="hljs-comment">/* 失败 */</span>
<span class="hljs-attr">--success</span>     <span class="hljs-comment">/* 成功 */</span>
<span class="hljs-attr">--pending</span>     <span class="hljs-comment">/* 等待中 */</span>
<span class="hljs-attr">--completed</span>   <span class="hljs-comment">/* 已完成 */</span>
<span class="hljs-attr">--cancelled</span>   <span class="hljs-comment">/* 已取消 */</span>
</code></pre>
<h4 data-id="heading-19">网络/连接状态</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--online</span>      <span class="hljs-comment">/* 在线 */</span>
<span class="hljs-attr">--offline</span>     <span class="hljs-comment">/* 离线 */</span>
<span class="hljs-attr">--connected</span>   <span class="hljs-comment">/* 已连接 */</span>
<span class="hljs-attr">--disconnected</span> <span class="hljs-comment">/* 断开连接 */</span>
<span class="hljs-attr">--connecting</span>  <span class="hljs-comment">/* 连接中 */</span>
<span class="hljs-attr">--syncing</span>     <span class="hljs-comment">/* 同步中 */</span>
<span class="hljs-attr">--synced</span>      <span class="hljs-comment">/* 已同步 */</span>
</code></pre>
<h4 data-id="heading-20">通用尺寸</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 通用尺寸 */</span>
<span class="hljs-attr">--small</span>       <span class="hljs-comment">/* 小尺寸 */</span>
<span class="hljs-attr">--medium</span>      <span class="hljs-comment">/* 中等尺寸 */</span>
<span class="hljs-attr">--large</span>       <span class="hljs-comment">/* 大尺寸 */</span>
<span class="hljs-attr">--xl</span>          <span class="hljs-comment">/* 加大尺寸 */</span>
<span class="hljs-attr">--xxl</span>         <span class="hljs-comment">/* 特大尺寸 */</span>
<span class="hljs-attr">--tiny</span>        <span class="hljs-comment">/* 超小尺寸 */</span>
<span class="hljs-attr">--mini</span>        <span class="hljs-comment">/* 迷你尺寸 */</span>
<span class="hljs-attr">--compact</span>     <span class="hljs-comment">/* 紧凑型 */</span>
<span class="hljs-comment">/* 宽度尺寸 */</span>
<span class="hljs-attr">--narrow</span>      <span class="hljs-comment">/* 窄 */</span>
<span class="hljs-attr">--wide</span>        <span class="hljs-comment">/* 宽 */</span>
<span class="hljs-attr">--full</span>        <span class="hljs-comment">/* 全宽 */</span>
<span class="hljs-attr">--half</span>        <span class="hljs-comment">/* 半宽 */</span>
<span class="hljs-attr">--third</span>       <span class="hljs-comment">/* 三分之一宽 */</span>
<span class="hljs-attr">--quarter</span>     <span class="hljs-comment">/* 四分之一宽 */</span>
<span class="hljs-attr">--fluid</span>       <span class="hljs-comment">/* 流体宽度 */</span>
<span class="hljs-attr">--fixed</span>       <span class="hljs-comment">/* 固定宽度 */</span>
<span class="hljs-comment">/* 高度尺寸 */</span>
<span class="hljs-attr">--short</span>       <span class="hljs-comment">/* 矮 */</span>
<span class="hljs-attr">--tall</span>        <span class="hljs-comment">/* 高 */</span>
<span class="hljs-attr">--full-height</span> <span class="hljs-comment">/* 全高 */</span>
<span class="hljs-attr">--auto-height</span> <span class="hljs-comment">/* 自动高度 */</span>
<span class="hljs-comment">/* 间距尺寸 */</span>
<span class="hljs-attr">--dense</span>       <span class="hljs-comment">/* 密集间距 */</span>
<span class="hljs-attr">--loose</span>       <span class="hljs-comment">/* 宽松间距 */</span>
<span class="hljs-attr">--tight</span>       <span class="hljs-comment">/* 紧凑间距 */</span>
<span class="hljs-attr">--spacious</span>    <span class="hljs-comment">/* 宽敞间距 */</span>
</code></pre>
<h4 data-id="heading-21">颜色主题</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--primary</span>     <span class="hljs-comment">/* 主要颜色 */</span>
<span class="hljs-attr">--secondary</span>   <span class="hljs-comment">/* 次要颜色 */</span>
<span class="hljs-attr">--tertiary</span>    <span class="hljs-comment">/* 第三颜色 */</span>
<span class="hljs-attr">--accent</span>      <span class="hljs-comment">/* 强调色 */</span>
<span class="hljs-attr">--muted</span>       <span class="hljs-comment">/* 柔和色 */</span>
<span class="hljs-attr">--light</span>       <span class="hljs-comment">/* 浅色 */</span>
<span class="hljs-attr">--dark</span>        <span class="hljs-comment">/* 深色 */</span>
<span class="hljs-attr">--inverse</span>     <span class="hljs-comment">/* 反色 */</span>
</code></pre>
<h4 data-id="heading-22">语义颜色</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--success</span>     <span class="hljs-comment">/* 成功/绿色 */</span>
<span class="hljs-attr">--error</span>       <span class="hljs-comment">/* 错误/红色 */</span>
<span class="hljs-attr">--warning</span>     <span class="hljs-comment">/* 警告/黄色 */</span>
<span class="hljs-attr">--info</span>        <span class="hljs-comment">/* 信息/蓝色 */</span>
<span class="hljs-attr">--danger</span>      <span class="hljs-comment">/* 危险/红色 */</span>
<span class="hljs-attr">--safe</span>        <span class="hljs-comment">/* 安全/绿色 */</span>
<span class="hljs-attr">--critical</span>    <span class="hljs-comment">/* 严重/橙色 */</span>
</code></pre>
<h4 data-id="heading-23">样式变体</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--outline</span>     <span class="hljs-comment">/* 轮廓样式 */</span>
<span class="hljs-attr">--solid</span>       <span class="hljs-comment">/* 实心样式 */</span>
<span class="hljs-attr">--ghost</span>       <span class="hljs-comment">/* 幽灵样式（透明背景） */</span>
<span class="hljs-attr">--flat</span>        <span class="hljs-comment">/* 扁平样式 */</span>
<span class="hljs-attr">--raised</span>      <span class="hljs-comment">/* 凸起样式 */</span>
<span class="hljs-attr">--shadow</span>      <span class="hljs-comment">/* 有阴影 */</span>
<span class="hljs-attr">--borderless</span>  <span class="hljs-comment">/* 无边框 */</span>
<span class="hljs-attr">--rounded</span>     <span class="hljs-comment">/* 圆角 */</span>
<span class="hljs-attr">--square</span>      <span class="hljs-comment">/* 直角 */</span>
<span class="hljs-attr">--circle</span>      <span class="hljs-comment">/* 圆形 */</span>
</code></pre>
<h4 data-id="heading-24">透明度</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--transparent</span> <span class="hljs-comment">/* 透明 */</span>
<span class="hljs-attr">--semi-transparent</span> <span class="hljs-comment">/* 半透明 */</span>
<span class="hljs-attr">--opaque</span>      <span class="hljs-comment">/* 不透明 */</span>
<span class="hljs-attr">--translucent</span> <span class="hljs-comment">/* 半透明 */</span>
</code></pre>
<h4 data-id="heading-25">布局方向</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--vertical</span>    <span class="hljs-comment">/* 垂直排列 */</span>
<span class="hljs-attr">--horizontal</span>  <span class="hljs-comment">/* 水平排列 */</span>
<span class="hljs-attr">--row</span>         <span class="hljs-comment">/* 行方向 */</span>
<span class="hljs-attr">--column</span>      <span class="hljs-comment">/* 列方向 */</span>
</code></pre>
<h4 data-id="heading-26">文本方向</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--left</span>        <span class="hljs-comment">/* 左对齐 */</span>
<span class="hljs-attr">--center</span>      <span class="hljs-comment">/* 居中对齐 */</span>
<span class="hljs-attr">--right</span>       <span class="hljs-comment">/* 右对齐 */</span>
<span class="hljs-attr">--justify</span>     <span class="hljs-comment">/* 两端对齐 */</span>
<span class="hljs-attr">--start</span>       <span class="hljs-comment">/* 起始对齐 */</span>
<span class="hljs-attr">--end</span>         <span class="hljs-comment">/* 结束对齐 */</span>
</code></pre>
<h4 data-id="heading-27">位置方向</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--top</span>         <span class="hljs-comment">/* 顶部 */</span>
<span class="hljs-attr">--bottom</span>      <span class="hljs-comment">/* 底部 */</span>
<span class="hljs-attr">--left</span>        <span class="hljs-comment">/* 左侧 */</span>
<span class="hljs-attr">--right</span>       <span class="hljs-comment">/* 右侧 */</span>
<span class="hljs-attr">--middle</span>      <span class="hljs-comment">/* 中间 */</span>
<span class="hljs-attr">--center</span>      <span class="hljs-comment">/* 居中 */</span>
<span class="hljs-attr">--absolute</span>    <span class="hljs-comment">/* 绝对定位 */</span>
<span class="hljs-attr">--relative</span>    <span class="hljs-comment">/* 相对定位 */</span>
<span class="hljs-attr">--fixed</span>       <span class="hljs-comment">/* 固定定位 */</span>
<span class="hljs-attr">--sticky</span>      <span class="hljs-comment">/* 粘性定位 */</span>
</code></pre>
<h4 data-id="heading-28">浮动方向</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--float-left</span>  <span class="hljs-comment">/* 左浮动 */</span>
<span class="hljs-attr">--float-right</span> <span class="hljs-comment">/* 右浮动 */</span>
<span class="hljs-attr">--float-none</span>  <span class="hljs-comment">/* 不浮动 */</span>
</code></pre>
<h4 data-id="heading-29">行为模式</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--readonly</span>    <span class="hljs-comment">/* 只读 */</span>
<span class="hljs-attr">--editable</span>    <span class="hljs-comment">/* 可编辑 */</span>
<span class="hljs-attr">--required</span>    <span class="hljs-comment">/* 必填 */</span>
<span class="hljs-attr">--optional</span>    <span class="hljs-comment">/* 可选 */</span>
<span class="hljs-attr">--multiple</span>    <span class="hljs-comment">/* 多选 */</span>
<span class="hljs-attr">--single</span>      <span class="hljs-comment">/* 单选 */</span>
<span class="hljs-attr">--searchable</span>  <span class="hljs-comment">/* 可搜索 */</span>
<span class="hljs-attr">--filterable</span>  <span class="hljs-comment">/* 可筛选 */</span>
<span class="hljs-attr">--sortable</span>    <span class="hljs-comment">/* 可排序 */</span>
</code></pre>
<h4 data-id="heading-30">交互模式</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--interactive</span> <span class="hljs-comment">/* 可交互 */</span>
<span class="hljs-attr">--static</span>      <span class="hljs-comment">/* 静态 */</span>
<span class="hljs-attr">--dynamic</span>     <span class="hljs-comment">/* 动态 */</span>
<span class="hljs-attr">--animated</span>    <span class="hljs-comment">/* 有动画 */</span>
<span class="hljs-attr">--static</span>      <span class="hljs-comment">/* 静态 */</span>
<span class="hljs-attr">--fixed</span>       <span class="hljs-comment">/* 固定 */</span>
<span class="hljs-attr">--sticky</span>      <span class="hljs-comment">/* 粘性 */</span>
</code></pre>
<h4 data-id="heading-31">数据模式</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--empty</span>       <span class="hljs-comment">/* 空数据 */</span>
<span class="hljs-attr">--loading</span>     <span class="hljs-comment">/* 加载数据 */</span>
<span class="hljs-attr">--loaded</span>      <span class="hljs-comment">/* 数据已加载 */</span>
<span class="hljs-attr">--error</span>       <span class="hljs-comment">/* 数据错误 */</span>
<span class="hljs-attr">--no-data</span>     <span class="hljs-comment">/* 无数据 */</span>
<span class="hljs-attr">--has-data</span>    <span class="hljs-comment">/* 有数据 */</span>
</code></pre>
<h4 data-id="heading-32">内容类型</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--text</span>        <span class="hljs-comment">/* 文本类型 */</span>
<span class="hljs-attr">--number</span>      <span class="hljs-comment">/* 数字类型 */</span>
<span class="hljs-attr">--date</span>        <span class="hljs-comment">/* 日期类型 */</span>
<span class="hljs-attr">--file</span>        <span class="hljs-comment">/* 文件类型 */</span>
<span class="hljs-attr">--image</span>       <span class="hljs-comment">/* 图片类型 */</span>
<span class="hljs-attr">--video</span>       <span class="hljs-comment">/* 视频类型 */</span>
<span class="hljs-attr">--audio</span>       <span class="hljs-comment">/* 音频类型 */</span>
</code></pre>
<h4 data-id="heading-33">文件类型</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--pdf</span>         <span class="hljs-comment">/* PDF文件 */</span>
<span class="hljs-attr">--doc</span>         <span class="hljs-comment">/* Word文档 */</span>
<span class="hljs-attr">--xls</span>         <span class="hljs-comment">/* Excel文件 */</span>
<span class="hljs-attr">--ppt</span>         <span class="hljs-comment">/* PowerPoint文件 */</span>
<span class="hljs-attr">--image</span>       <span class="hljs-comment">/* 图片文件 */</span>
<span class="hljs-attr">--archive</span>     <span class="hljs-comment">/* 压缩文件 */</span>
<span class="hljs-attr">--code</span>        <span class="hljs-comment">/* 代码文件 */</span>
</code></pre>
<h4 data-id="heading-34">设备类型</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--mobile</span>      <span class="hljs-comment">/* 移动设备 */</span>
<span class="hljs-attr">--tablet</span>      <span class="hljs-comment">/* 平板设备 */</span>
<span class="hljs-attr">--desktop</span>     <span class="hljs-comment">/* 桌面设备 */</span>
<span class="hljs-attr">--phone</span>       <span class="hljs-comment">/* 手机 */</span>
<span class="hljs-attr">--watch</span>       <span class="hljs-comment">/* 手表 */</span>
<span class="hljs-attr">--tv</span>          <span class="hljs-comment">/* 电视 */</span>
</code></pre>
<h4 data-id="heading-35">时间状态</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--new</span>         <span class="hljs-comment">/* 新的 */</span>
<span class="hljs-attr">--old</span>         <span class="hljs-comment">/* 旧的 */</span>
<span class="hljs-attr">--recent</span>      <span class="hljs-comment">/* 最近的 */</span>
<span class="hljs-attr">--past</span>        <span class="hljs-comment">/* 过去的 */</span>
<span class="hljs-attr">--future</span>      <span class="hljs-comment">/* 未来的 */</span>
<span class="hljs-attr">--expired</span>     <span class="hljs-comment">/* 已过期 */</span>
<span class="hljs-attr">--upcoming</span>    <span class="hljs-comment">/* 即将到来 */</span>
</code></pre>
<h4 data-id="heading-36">频率状态</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--frequent</span>    <span class="hljs-comment">/* 频繁的 */</span>
<span class="hljs-attr">--rare</span>        <span class="hljs-comment">/* 罕见的 */</span>
<span class="hljs-attr">--once</span>        <span class="hljs-comment">/* 一次性的 */</span>
<span class="hljs-attr">--recurring</span>   <span class="hljs-comment">/* 重复的 */</span>
<span class="hljs-attr">--daily</span>       <span class="hljs-comment">/* 每日的 */</span>
<span class="hljs-attr">--weekly</span>      <span class="hljs-comment">/* 每周的 */</span>
<span class="hljs-attr">--monthly</span>     <span class="hljs-comment">/* 每月的 */</span>
</code></pre>
<h4 data-id="heading-37">屏幕尺寸</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--mobile</span>      <span class="hljs-comment">/* 移动端 */</span>
<span class="hljs-attr">--tablet</span>      <span class="hljs-comment">/* 平板端 */</span>
<span class="hljs-attr">--desktop</span>     <span class="hljs-comment">/* 桌面端 */</span>
<span class="hljs-attr">--sm</span>          <span class="hljs-comment">/* 小屏幕 */</span>
<span class="hljs-attr">--md</span>          <span class="hljs-comment">/* 中等屏幕 */</span>
<span class="hljs-attr">--lg</span>          <span class="hljs-comment">/* 大屏幕 */</span>
<span class="hljs-attr">--xl</span>          <span class="hljs-comment">/* 超大屏幕 */</span>
</code></pre>
<h4 data-id="heading-38">设备方向</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--portrait</span>    <span class="hljs-comment">/* 竖屏 */</span>
<span class="hljs-attr">--landscape</span>   <span class="hljs-comment">/* 横屏 */</span>
</code></pre>
<h4 data-id="heading-39">断点相关</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--below-md</span>    <span class="hljs-comment">/* 小于中等屏幕 */</span>
<span class="hljs-attr">--above-lg</span>    <span class="hljs-comment">/* 大于大屏幕 */</span>
<span class="hljs-attr">--only-mobile</span> <span class="hljs-comment">/* 仅移动端 */</span>
<span class="hljs-attr">--only-desktop</span> <span class="hljs-comment">/* 仅桌面端 */</span>
</code></pre>
<h4 data-id="heading-40">数据质量</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--valid</span>       <span class="hljs-comment">/* 数据有效 */</span>
<span class="hljs-attr">--invalid</span>     <span class="hljs-comment">/* 数据无效 */</span>
<span class="hljs-attr">--verified</span>    <span class="hljs-comment">/* 已验证 */</span>
<span class="hljs-attr">--pending</span>     <span class="hljs-comment">/* 待验证 */</span>
<span class="hljs-attr">--expired</span>     <span class="hljs-comment">/* 已过期 */</span>
<span class="hljs-attr">--fresh</span>       <span class="hljs-comment">/* 新鲜数据 */</span>
<span class="hljs-attr">--stale</span>       <span class="hljs-comment">/* 陈旧数据 */</span>
</code></pre>
<h4 data-id="heading-41">数据量</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--empty</span>       <span class="hljs-comment">/* 空数据 */</span>
<span class="hljs-attr">--few</span>         <span class="hljs-comment">/* 少量数据 */</span>
<span class="hljs-attr">--many</span>        <span class="hljs-comment">/* 大量数据 */</span>
<span class="hljs-attr">--full</span>        <span class="hljs-comment">/* 数据已满 */</span>
<span class="hljs-attr">--overflow</span>    <span class="hljs-comment">/* 数据溢出 */</span>
</code></pre>
<h4 data-id="heading-42">安全状态 Modifier</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--secured</span>     <span class="hljs-comment">/* 已保护 */</span>
<span class="hljs-attr">--unsecured</span>   <span class="hljs-comment">/* 未保护 */</span>
<span class="hljs-attr">--encrypted</span>   <span class="hljs-comment">/* 已加密 */</span>
<span class="hljs-attr">--decrypted</span>   <span class="hljs-comment">/* 已解密 */</span>
<span class="hljs-attr">--authenticated</span> <span class="hljs-comment">/* 已认证 */</span>
<span class="hljs-attr">--unauthenticated</span> <span class="hljs-comment">/* 未认证 */</span>
<span class="hljs-attr">--authorized</span>  <span class="hljs-comment">/* 已授权 */</span>
<span class="hljs-attr">--unauthorized</span> <span class="hljs-comment">/* 未授权 */</span>
</code></pre>
<h4 data-id="heading-43">按钮 Button</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--primary</span>     <span class="hljs-comment">/* 主要按钮 */</span>
<span class="hljs-attr">--secondary</span>   <span class="hljs-comment">/* 次要按钮 */</span>
<span class="hljs-attr">--danger</span>      <span class="hljs-comment">/* 危险操作按钮 */</span>
<span class="hljs-attr">--warning</span>     <span class="hljs-comment">/* 警告操作按钮 */</span>
<span class="hljs-attr">--success</span>     <span class="hljs-comment">/* 成功操作按钮 */</span>
<span class="hljs-attr">--link</span>        <span class="hljs-comment">/* 链接样式按钮 */</span>
<span class="hljs-attr">--icon</span>        <span class="hljs-comment">/* 图标按钮 */</span>
<span class="hljs-attr">--block</span>       <span class="hljs-comment">/* 块级按钮（宽度100%） */</span>
</code></pre>
<h4 data-id="heading-44">输入框 Input</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--filled</span>      <span class="hljs-comment">/* 已填充 */</span>
<span class="hljs-attr">--error</span>       <span class="hljs-comment">/* 错误状态 */</span>
<span class="hljs-attr">--success</span>     <span class="hljs-comment">/* 成功状态 */</span>
<span class="hljs-attr">--warning</span>     <span class="hljs-comment">/* 警告状态 */</span>
<span class="hljs-attr">--disabled</span>    <span class="hljs-comment">/* 禁用状态 */</span>
<span class="hljs-attr">--readonly</span>    <span class="hljs-comment">/* 只读状态 */</span>
<span class="hljs-attr">--search</span>      <span class="hljs-comment">/* 搜索框样式 */</span>
</code></pre>
<h4 data-id="heading-45">表格 Table</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--striped</span>     <span class="hljs-comment">/* 斑马纹 */</span>
<span class="hljs-attr">--bordered</span>    <span class="hljs-comment">/* 有边框 */</span>
<span class="hljs-attr">--hover</span>       <span class="hljs-comment">/* 悬停效果 */</span>
<span class="hljs-attr">--condensed</span>   <span class="hljs-comment">/* 紧凑型 */</span>
<span class="hljs-attr">--responsive</span>  <span class="hljs-comment">/* 响应式表格 */</span>
<span class="hljs-attr">--sortable</span>    <span class="hljs-comment">/* 可排序 */</span>
</code></pre>
<h4 data-id="heading-46">卡片 Card</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--shadow</span>      <span class="hljs-comment">/* 有阴影 */</span>
<span class="hljs-attr">--border</span>      <span class="hljs-comment">/* 有边框 */</span>
<span class="hljs-attr">--hoverable</span>   <span class="hljs-comment">/* 悬停效果 */</span>
<span class="hljs-attr">--selected</span>    <span class="hljs-comment">/* 选中状态 */</span>
<span class="hljs-attr">--clickable</span>   <span class="hljs-comment">/* 可点击 */</span>
<span class="hljs-attr">--draggable</span>   <span class="hljs-comment">/* 可拖动 */</span>
</code></pre>
<h4 data-id="heading-47">模态框 Modal</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--small</span>       <span class="hljs-comment">/* 小尺寸模态框 */</span>
<span class="hljs-attr">--medium</span>      <span class="hljs-comment">/* 中尺寸模态框 */</span>
<span class="hljs-attr">--large</span>       <span class="hljs-comment">/* 大尺寸模态框 */</span>
<span class="hljs-attr">--fullscreen</span>  <span class="hljs-comment">/* 全屏模态框 */</span>
<span class="hljs-attr">--centered</span>    <span class="hljs-comment">/* 居中显示 */</span>
</code></pre>
<h4 data-id="heading-48">导航 Nav</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--vertical</span>    <span class="hljs-comment">/* 垂直导航 */</span>
<span class="hljs-attr">--horizontal</span>  <span class="hljs-comment">/* 水平导航 */</span>
<span class="hljs-attr">--pills</span>       <span class="hljs-comment">/* 胶囊式导航 */</span>
<span class="hljs-attr">--tabs</span>        <span class="hljs-comment">/* 标签式导航 */</span>
<span class="hljs-attr">--underline</span>   <span class="hljs-comment">/* 下划线式导航 */</span>
</code></pre>
<h4 data-id="heading-49">国际化 Modifier</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--ltr</span>         <span class="hljs-comment">/* 从左到右 */</span>
<span class="hljs-attr">--rtl</span>         <span class="hljs-comment">/* 从右到左 */</span>
<span class="hljs-attr">--en</span>          <span class="hljs-comment">/* 英语 */</span>
<span class="hljs-attr">--zh</span>          <span class="hljs-comment">/* 中文 */</span>
<span class="hljs-attr">--ja</span>          <span class="hljs-comment">/* 日语 */</span>
<span class="hljs-attr">--ar</span>          <span class="hljs-comment">/* 阿拉伯语 */</span>
<span class="hljs-attr">--locale-en</span>   <span class="hljs-comment">/* 英语地区 */</span>
<span class="hljs-attr">--locale-zh</span>   <span class="hljs-comment">/* 中文地区 */</span>
</code></pre>
<h4 data-id="heading-50">优先级 Modifier</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attr">--high</span>        <span class="hljs-comment">/* 高优先级 */</span>
<span class="hljs-attr">--medium</span>      <span class="hljs-comment">/* 中优先级 */</span>
<span class="hljs-attr">--low</span>         <span class="hljs-comment">/* 低优先级 */</span>
<span class="hljs-attr">--critical</span>    <span class="hljs-comment">/* 关键优先级 */</span>
<span class="hljs-attr">--normal</span>      <span class="hljs-comment">/* 普通优先级 */</span>
<span class="hljs-attr">--urgent</span>      <span class="hljs-comment">/* 紧急优先级 */</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[有趣的Binder异常传递故事：为什么客户端抛异常会让服务端崩溃？]]></title>    <link>https://juejin.cn/post/7600868443831336979</link>    <guid>https://juejin.cn/post/7600868443831336979</guid>    <pubDate>2026-01-30T06:17:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600868443831336979" data-draft-id="7600706866785910827" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="有趣的Binder异常传递故事：为什么客户端抛异常会让服务端崩溃？"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-30T06:17:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Android童话镇"/> <meta itemprop="url" content="https://juejin.cn/user/2716247406161241"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            有趣的Binder异常传递故事：为什么客户端抛异常会让服务端崩溃？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2716247406161241/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Android童话镇
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T06:17:27.000Z" title="Fri Jan 30 2026 06:17:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">故事背景：Binder帝国的通信系统</h2>
<p>想象一下，Android系统就像一个有多个岛屿（进程）的帝国，每个岛屿需要通信。Binder就是帝国的高速邮差系统，负责在岛屿间传递消息。</p>
<h2 data-id="heading-1">角色介绍：</h2>
<ol>
<li><strong>客户端岛</strong>（Test App） - 年轻冲动的岛民</li>
<li><strong>服务端岛</strong>（Navi Service） - 经验丰富的导航大师</li>
<li><strong>Binder邮差</strong> - 帝国的快递员</li>
<li><strong>邮局</strong>（Binder驱动） - 帝国的邮局中心</li>
</ol>
<h2 data-id="heading-2">完整故事：</h2>
<h3 data-id="heading-3">第一章：建立通信</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 客户端岛民写了一份"承诺书"（回调接口）</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">INaviInfoCallBack</span> <span class="hljs-variable">naviInfoCallBack</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">INaviInfoCallBack</span>.Stub() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSuccess</span><span class="hljs-params">(NaviInfo naviInfo)</span> {
        appendLog(<span class="hljs-string">"收到导航信息！"</span>);
        <span class="hljs-comment">// 突然发脾气，扔了个"空指针炸弹"</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>(<span class="hljs-string">"我来自测试应用！"</span>);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onError</span><span class="hljs-params">()</span> {
        appendLog(<span class="hljs-string">"导航出错"</span>);
    }
};
</code></pre>
<h3 data-id="heading-4">第二章：请求导航</h3>
<p>客户端岛民把这份承诺书通过Binder邮差寄给了服务端的导航大师，说："大师，这是我的回信地址，有结果就告诉我！"</p>
<h3 data-id="heading-5">第三章：服务端处理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 服务端导航大师收到请求后...</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">naviInfoCallBack</span><span class="hljs-params">(Intent intent)</span> {
    <span class="hljs-type">NaviInfo</span> <span class="hljs-variable">naviInfo</span> <span class="hljs-operator">=</span> intent.getParcelableExtra(...);
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">if</span> (iNaviInfoCallBack != <span class="hljs-literal">null</span> &amp;&amp; iNaviInfoCallBack.asBinder().isBinderAlive()) {
            <span class="hljs-keyword">if</span> (naviInfo != <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// 大师通过Binder邮差给客户端回信</span>
                iNaviInfoCallBack.onSuccess(naviInfo);
            }
        }
    } <span class="hljs-keyword">catch</span> (RemoteException e) {
        <span class="hljs-comment">// 哦不！邮差说回信出问题了！</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
    }
}
</code></pre>
<h2 data-id="heading-6">关键问题：为什么服务端会崩溃？</h2>
<h3 data-id="heading-7">时序图揭秘：</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/110ae55d714b48f78a94caab5d6692d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW5kcm9pZOerpeivnemVhw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770359541&amp;x-signature=98SDKSti9%2BItZMrlOYQEtbWmFH4%3D" alt="为什么服务端会崩溃？.png" loading="lazy"/></p>
<h2 data-id="heading-8">技术细节解析：</h2>
<h3 data-id="heading-9">1. Binder异常传递机制</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 这是Android源码中Parcel类的关键方法</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeException</span><span class="hljs-params">(Exception e)</span> {
    <span class="hljs-comment">// Binder会把异常编码到Parcel中</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> getExceptionCode(e);
    writeInt(code);
    <span class="hljs-keyword">if</span> (code != <span class="hljs-number">0</span>) {
        writeString(e.getMessage());
        <span class="hljs-comment">// 把堆栈信息也写进去</span>
        writeStackTrace(e);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readException</span><span class="hljs-params">()</span> {
    <span class="hljs-type">int</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> readInt();
    <span class="hljs-keyword">if</span> (code != <span class="hljs-number">0</span>) {
        <span class="hljs-type">String</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> readString();
        <span class="hljs-comment">// 关键！在这里重新创建异常并抛出</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Binder调用异常: "</span> + msg);
    }
}
</code></pre>
<h3 data-id="heading-10">2. 实际调用链</h3>
<pre><code class="hljs language-java" lang="java">服务端调用链：
WidgetBinder.naviInfoCallBack()
  → INaviInfoCallBack.Proxy.onSuccess()
  → Binder.transact() 发送到内核
  → 客户端处理
  → 客户端抛出异常
  → 异常被封装到Parcel
  → 返回给服务端
  → Parcel.readException() 重新抛出异常
  → 被RemoteException包装
  → 最终变成RuntimeException抛出
</code></pre>
<h3 data-id="heading-11">3. 为什么异常会跨进程传播？</h3>
<p>Binder机制设计时考虑到了异常传播：</p>
<ul>
<li><strong>设计原则</strong>：如果回调失败，调用方应该知道</li>
<li><strong>实现方式</strong>：异常被序列化到Parcel中传递</li>
<li><strong>安全问题</strong>：防止一个进程的异常影响另一个进程</li>
</ul>
<h2 data-id="heading-12">有趣比喻：</h2>
<p>想象一下Binder邮差的工作流程：</p>
<ol>
<li>
<p><strong>正常情况</strong>：</p>
<pre><code class="hljs language-text" lang="text">服务端 → 写封信 → Binder邮差 → 客户端 → 读信 → 写回信 → Binder邮差 → 服务端
</code></pre>
</li>
<li>
<p><strong>异常情况</strong>：</p>
<pre><code class="hljs language-text" lang="text">服务端 → 写封信 → Binder邮差 → 客户端 → 读信 → 生气！撕碎信！
        ↑                                 ↓
        ← 邮差带回"碎信报告" ← Binder邮差 ←
服务端看到"碎信报告" → 自己也生气崩溃！
</code></pre>
</li>
</ol>
<h2 data-id="heading-13">解决方案：</h2>
<h3 data-id="heading-14">方案1：客户端捕获异常（推荐）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onSuccess</span><span class="hljs-params">(NaviInfo naviInfo)</span> {
    <span class="hljs-keyword">try</span> {
        appendLog(<span class="hljs-string">"getCurrentLocation onSuccess: "</span> + naviInfo);
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>(<span class="hljs-string">"i'm from test app"</span>);
    } <span class="hljs-keyword">catch</span> (Exception e) {
        Log.e(<span class="hljs-string">"Client"</span>, <span class="hljs-string">"回调异常"</span>, e);
        <span class="hljs-comment">// 不向上抛异常</span>
    }
}
</code></pre>
<h3 data-id="heading-15">方案2：服务端更安全的处理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">naviInfoCallBack</span><span class="hljs-params">(Intent intent)</span> {
    <span class="hljs-type">NaviInfo</span> <span class="hljs-variable">naviInfo</span> <span class="hljs-operator">=</span> intent.getParcelableExtra(...);
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">if</span> (iNaviInfoCallBack != <span class="hljs-literal">null</span> &amp;&amp; iNaviInfoCallBack.asBinder().isBinderAlive()) {
            <span class="hljs-keyword">if</span> (naviInfo != <span class="hljs-literal">null</span>) {
                iNaviInfoCallBack.onSuccess(naviInfo);
            }
        }
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-comment">// 只记录，不崩溃</span>
        Log.e(<span class="hljs-string">"Server"</span>, <span class="hljs-string">"回调失败: "</span> + e.getMessage());
        <span class="hljs-comment">// 不抛出RuntimeException</span>
    }
}
</code></pre>
<h3 data-id="heading-16">方案3：使用Oneway（异步，不推荐）</h3>
<pre><code class="hljs language-aidl" lang="aidl">interface INaviInfoCallBack {
    oneway void onSuccess(NaviInfo naviInfo);
    oneway void onError();
}
</code></pre>
<h2 data-id="heading-17">核心教训：</h2>
<ol>
<li><strong>Binder回调中的异常会跨进程传播</strong></li>
<li><strong>RemoteException不只是网络/通信错误</strong></li>
<li><strong>Parcel.readException()会重新抛出客户端异常</strong></li>
<li><strong>回调接口设计要考虑异常安全性</strong></li>
</ol>
<h2 data-id="heading-18">代码验证实验：</h2>
<p>你可以自己写个简单的AIDL测试：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 服务端看到的是：</span>
<span class="hljs-comment">// Caused by: java.lang.RuntimeException: </span>
<span class="hljs-comment">//   at android.os.Parcel.readException(Parcel.java:1690)</span>
<span class="hljs-comment">//   ...</span>
<span class="hljs-comment">// Caused by: java.lang.NullPointerException: i'm from test app</span>
<span class="hljs-comment">//   at 客户端的堆栈...</span>

<span class="hljs-comment">// 这说明异常经历了：</span>
<span class="hljs-comment">// 客户端NPE → 序列化到Parcel → 服务端反序列化 → 重新抛出</span>
</code></pre>
<h2 data-id="heading-19">总结：</h2>
<p>Binder就像一个严格的邮局系统，它不仅传递好消息，也传递坏消息（异常）。当客户端在回调中抛异常时，这个异常就像一封"投诉信"，通过Binder系统原封不动地寄回给服务端，导致服务端也"生气"崩溃了。</p>
<p>记住：<strong>跨进程回调中，你的异常不是你的私有财产，它会旅行！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 全局拖放事件完整调用链路分析]]></title>    <link>https://juejin.cn/post/7600752623068037130</link>    <guid>https://juejin.cn/post/7600752623068037130</guid>    <pubDate>2026-01-30T07:28:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600752623068037130" data-draft-id="7599450177058045962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 全局拖放事件完整调用链路分析"/> <meta itemprop="keywords" content="源码"/> <meta itemprop="datePublished" content="2026-01-30T07:28:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CarryZhang"/> <meta itemprop="url" content="https://juejin.cn/user/782508007385415"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 全局拖放事件完整调用链路分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/782508007385415/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CarryZhang
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T07:28:53.000Z" title="Fri Jan 30 2026 07:28:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"> </h2>
<h3 data-id="heading-1">一、应用层调用链</h3>
<p>流程图如下</p>
<p> </p>
<h4 data-id="heading-2">1.1 应用层启动拖放</h4>
<pre><code class="hljs language-ini" lang="ini">// 组装 数据ClipData，包括卡片信息
final ClipData <span class="hljs-attr">data</span> = assembleClipData()<span class="hljs-comment">;</span>
//调用系统拖拽
boolean <span class="hljs-attr">dragResult</span> = dragView.startDragAndDrop(data, builder, null,
        View.DRAG_FLAG_GLOBAL | View.DRAG_FLAG_OPAQUE | DRAG_FLAG_CUSTOM_RETURN_ANIMATION | DRAG_FLAG_CUSTOM_CANCEL_ANIMATION)<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-3">1.2应用层监听拖拽事件</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">getDragLayer</span>()<span class="hljs-selector-class">.setOnDragListener</span>(new View.<span class="hljs-built_in">OnDragListener</span>() {
    <span class="hljs-variable">@Override</span>
    public boolean <span class="hljs-built_in">onDrag</span>(View v, DragEvent event) {
        
    }
});


<span class="hljs-selector-tag">View</span><span class="hljs-selector-class">.dispatchDragEvent</span> 就会将事件传递到这里
</code></pre>
<p> </p>
<h3 data-id="heading-4">二、Framework 层调用链（View → WindowManagerService）</h3>
<h4 data-id="heading-5">2.1 View.startDragAndDrop() 实现</h4>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" loading="lazy"/></p>
<p><strong>源码位置：</strong> <code>frameworks/base/core/java/android/view/View.java</code></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// View.java</span>
<span class="hljs-keyword">public</span> final <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">startDragAndDrop</span>(<span class="hljs-params">ClipData data, 
                                      DragShadowBuilder shadowBuilder,
                                      <span class="hljs-built_in">Object</span> myLocalState, 
                                      
    <span class="hljs-comment">//1. DRAG_FLAG_ACCESSIBILITY_ACTION 表示不需要动画，所以不需要surface                                                                                                      int flags) {</span>
    <span class="hljs-keyword">if</span> (a11yEnabled &amp;&amp; (flags &amp; View.DRAG_FLAG_ACCESSIBILITY_ACTION) != <span class="hljs-number">0</span>) {
      IBinder token = mAttachInfo.mSession.performDrag(
          mAttachInfo.mWindow, flags, <span class="hljs-literal">null</span>,
          mAttachInfo.mViewRootImpl.getLastTouchSource(),
          mAttachInfo.mViewRootImpl.getLastTouchDeviceId(),
          mAttachInfo.mViewRootImpl.getLastTouchPointerId(),
          0f, 0f, 0f, 0f, data);
    }
    
   
    <span class="hljs-comment">// 2. 创建DragSurface,大小为view的大小</span>
     final SurfaceControl surfaceControl = <span class="hljs-keyword">new</span> SurfaceControl.Builder()
                .setName(<span class="hljs-string">"drag surface"</span>)
                .setParent(root.getSurfaceControl())
                .setBufferSize(shadowSize.x, shadowSize.y)
                .setFormat(PixelFormat.TRANSLUCENT)
                .setCallsite(<span class="hljs-string">"View.startDragAndDrop"</span>)
                .build();
    transaction.setMatrix(surfaceControl, <span class="hljs-number">1</span> / overrideInvScale, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span> / overrideInvScale)
        .apply();
    final Surface surface = <span class="hljs-keyword">new</span> Surface();
    surface.copyFrom(surfaceControl);
    <span class="hljs-comment">//3.创建scanvas</span>
    final Canvas canvas = isHardwareAccelerated()
        ? surface.lockHardwareCanvas()
        : surface.lockCanvas(<span class="hljs-literal">null</span>);
    


    canvas.drawColor(<span class="hljs-number">0</span>, PorterDuff.Mode.CLEAR);
     <span class="hljs-comment">//4.绘制内容,最终调用view.draw(canvas)</span>
    shadowBuilder.onDrawShadow(canvas);




    <span class="hljs-comment">//5.调用 ViewRootImpl.performDrag()</span>
    result = mAttachInfo.mSession.performDrag(mAttachInfo.mWindow, flags, surfaceControl,
                        root.getLastTouchSource(), root.getLastTouchDeviceId(),
                        root.getLastTouchPointerId(), lastTouchPoint.x, lastTouchPoint.y,
                        shadowTouchPoint.x, shadowTouchPoint.y, data)!=<span class="hljs-literal">null</span>;
    
    
    mAttachInfo.mDragSurface = surface;
    <span class="hljs-keyword">return</span> result；
}


<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> onDrawShadow(@NonNull Canvas canvas) {
    final View view = mView.get();
    <span class="hljs-keyword">if</span> (view != <span class="hljs-literal">null</span>) {
        view.draw(canvas); //绘制内容


    } <span class="hljs-keyword">else</span> {
        Log.e(View.VIEW_LOG_TAG, <span class="hljs-string">"Asked to draw drag shadow but no view"</span>);
    }
}
</span></code></pre>
<p> </p>
<h4 data-id="heading-6">2.2 Session.performDrag() 实现</h4>
<p><strong>源码位置：</strong> frameworks/base/services/core/java/com/android/server/wm/Session.java</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> IBinder <span class="hljs-title function_">performDrag</span><span class="hljs-params">(IWindow window, <span class="hljs-type">int</span> flags, SurfaceControl surface, <span class="hljs-type">int</span> touchSource,
            <span class="hljs-type">int</span> touchDeviceId, <span class="hljs-type">int</span> touchPointerId, <span class="hljs-type">float</span> touchX, <span class="hljs-type">float</span> touchY, <span class="hljs-type">float</span> thumbCenterX,
            <span class="hljs-type">float</span> thumbCenterY, ClipData data)</span> {
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">callingUid</span> <span class="hljs-operator">=</span> Binder.getCallingUid();
        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">callingPid</span> <span class="hljs-operator">=</span> Binder.getCallingPid();
        <span class="hljs-comment">// Validate and resolve ClipDescription data before clearing the calling identity</span>
        validateAndResolveDragMimeTypeExtras(data, callingUid, callingPid, mPackageName);
        validateDragFlags(flags, callingUid);
        <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">ident</span> <span class="hljs-operator">=</span> Binder.clearCallingIdentity();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> mDragDropController.performDrag(mPid, mUid, window, flags, surface, touchSource,
                    touchDeviceId, touchPointerId, touchX, touchY, thumbCenterX, thumbCenterY,
                    data);
        } <span class="hljs-keyword">finally</span> {
            Binder.restoreCallingIdentity(ident);
        }
    }
</code></pre>
<p> </p>
<h4 data-id="heading-7">2.3 DragDropController .performDrag() 调用</h4>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" loading="lazy"/></p>
<p><strong>源码位置：</strong> frameworks/base/services/core/java/com/android/server/wm/DragDropController.java</p>
<pre><code class="hljs language-ini" lang="ini">// IWindowSession.aidl
 IBinder performDrag(int callerPid, int callerUid, IWindow window, int flags,
            SurfaceControl surface, int touchSource, int touchDeviceId, int touchPointerId,
            float touchX, float touchY, float thumbCenterX, float thumbCenterY, ClipData data) {


  //1.初始化DragState
 <span class="hljs-attr">mDragState</span> = new DragState(mService, this, token, surface, flags, winBinder)<span class="hljs-comment">;</span>
                    <span class="hljs-attr">surface</span> = null<span class="hljs-comment">;</span>
                    <span class="hljs-attr">mDragState.mPid</span> = callerPid<span class="hljs-comment">;</span>
                    <span class="hljs-attr">mDragState.mUid</span> = callerUid<span class="hljs-comment">;</span>
                    <span class="hljs-attr">mDragState.mOriginalAlpha</span> = alpha<span class="hljs-comment">;</span>
                    <span class="hljs-attr">mDragState.mAnimatedScale</span> = callingWin.mGlobalScale<span class="hljs-comment">;</span>
                    <span class="hljs-attr">mDragState.mToken</span> = dragToken<span class="hljs-comment">;</span>
                    <span class="hljs-attr">mDragState.mDisplayContent</span> = displayContent<span class="hljs-comment">;</span>
                    <span class="hljs-attr">mDragState.mData</span> = data<span class="hljs-comment">;</span>
                    <span class="hljs-attr">mDragState.mCallingTaskIdToHide</span> = shouldMoveCallingTaskToBack(callingWin,
                            flags)<span class="hljs-comment">;</span>


//2.给InputFlinger注册拖拽标记
<span class="hljs-attr">touchFocusTransferredFuture</span> = mCallback.get().registerInputChannel(
                                mDragState, display, mService.mInputManager,
                                callingWin.mInputChannelToken)<span class="hljs-comment">;</span>


//3.分发第一个拖拽事件到当前窗口，当前窗口需要 设置 PRIVATE_FLAG_INTERCEPT_GLOBAL_DRAG_AND_DROP
 mDragState.broadcastDragStartedLocked(touchX, touchY)


//4.调整surface层级，重新绑定parent
displayContent.reparentToOverlay(transaction, surfaceControl)<span class="hljs-comment">;</span>
}
</code></pre>
<h3 data-id="heading-8">三、系统服务层调用链（WindowManagerService）</h3>
<p> </p>
<h4 data-id="heading-9">3.1 WindowManagerInternal.registerInputChannel()调用</h4>
<p><strong>源码位置：</strong> frameworks/base/services/core/java/com/android/server/wm/WindowManagerInternal.java</p>
<pre><code class="hljs language-arduino" lang="arduino"> <span class="hljs-function"><span class="hljs-keyword">default</span> CompletableFuture&lt;Boolean&gt; <span class="hljs-title">registerInputChannel</span><span class="hljs-params">(
                DragState state, Display display, InputManagerService service,
                IBinder sourceInputChannelToken)</span> </span>{
            <span class="hljs-keyword">return</span> state.<span class="hljs-built_in">register</span>(display)
                .<span class="hljs-built_in">thenApply</span>(unused -&gt;
                    service.<span class="hljs-built_in">startDragAndDrop</span>(sourceInputChannelToken, state.<span class="hljs-built_in">getInputToken</span>()));
        }
</code></pre>
<h4 data-id="heading-10">3.2 InputManagerService.startDragAndDrop()调用</h4>
<p><strong>源码位置：</strong> frameworks/base/services/core/java/com/android/server/input/InputManagerService.java</p>
<pre><code class="hljs language-less" lang="less">  <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">boolean</span> <span class="hljs-selector-tag">startDragAndDrop</span>(<span class="hljs-variable">@NonNull</span> IBinder fromChannelToken,
            <span class="hljs-variable">@NonNull</span> IBinder dragAndDropChannelToken) {
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">mNative</span><span class="hljs-selector-class">.transferTouchGesture</span>(fromChannelToken, dragAndDropChannelToken,
                true <span class="hljs-comment">/* isDragDrop */</span>);
    }
</code></pre>
<h4 data-id="heading-11">3.3 com_android_server_input_InputManagerService. nativeTransferTouchGesture()调用</h4>
<p><strong>源码位置：</strong> frameworks/base/services/core/jni/com_android_server_input_InputManagerService.cpp</p>
<pre><code class="hljs language-ini" lang="ini">static jboolean nativeTransferTouchGesture(JNIEnv* env, jobject nativeImplObj,
                                           jobject fromChannelTokenObj, jobject toChannelTokenObj,
                                           jboolean isDragDrop) {
    if (<span class="hljs-attr">fromChannelTokenObj</span> == nullptr || toChannelTokenObj == nullptr) {
        return JNI_FALSE<span class="hljs-comment">;</span>
    }


    sp&lt;IBinder&gt; <span class="hljs-attr">fromChannelToken</span> = ibinderForJavaObject(env, fromChannelTokenObj)<span class="hljs-comment">;</span>
    sp&lt;IBinder&gt; <span class="hljs-attr">toChannelToken</span> = ibinderForJavaObject(env, toChannelTokenObj)<span class="hljs-comment">;</span>


    NativeInputManager* <span class="hljs-attr">im</span> = getNativeInputManager(env, nativeImplObj)<span class="hljs-comment">;</span>
    if (im-&gt;getInputManager()-&gt;getDispatcher().transferTouchGesture(fromChannelToken,
                                                                    toChannelToken, isDragDrop)) {
        return JNI_TRUE<span class="hljs-comment">;</span>
    } else {
        return JNI_FALSE<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h3 data-id="heading-12">四、输入系统调用链（InputDispatcher）</h3>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" loading="lazy"/></p>
<h4 data-id="heading-13">4.1InputDispatcher.transferTouchGesture()标记拖拽</h4>
<p><strong>源码位置：</strong> frameworks/native/services/inputflinger/dispatcher/InputDispatcher.cpp</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-type">bool</span> InputDispatcher::<span class="hljs-title function_ invoke__">transferTouchGesture</span>(<span class="hljs-keyword">const</span> sp&lt;IBinder&gt;&amp; fromToken, <span class="hljs-keyword">const</span> sp&lt;IBinder&gt;&amp; toToken,
                                           <span class="hljs-type">bool</span> isDragDrop) {
...
        <span class="hljs-comment">// Store the dragging window.</span>
        <span class="hljs-title function_ invoke__">if</span> (isDragDrop) {
            <span class="hljs-title function_ invoke__">if</span> (pointers.<span class="hljs-title function_ invoke__">size</span>() != <span class="hljs-number">1</span>) {
                <span class="hljs-title function_ invoke__">ALOGW</span>(<span class="hljs-string">"The drag and drop cannot be started when there is no pointer or more than 1"</span>
                      <span class="hljs-string">" pointer on the window."</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
            <span class="hljs-comment">// Track the pointer id for drag window and generate the drag state.</span>
            <span class="hljs-keyword">const</span> size_t id = pointers.<span class="hljs-title function_ invoke__">begin</span>()<span class="hljs-punctuation">-&gt;</span>id;
          <span class="hljs-comment">//1.初始化mDragState </span>
            mDragState = std::make_unique&lt;DragState&gt;(toWindowHandle, deviceId, id);
        }
    <span class="hljs-comment">//2.唤醒事件分发,进入下一个循环</span>
     mLooper<span class="hljs-punctuation">-&gt;</span><span class="hljs-title function_ invoke__">wake</span>();
}
</code></pre>
<p> </p>
<h4 data-id="heading-14">4.2添加拖拽事件到队列</h4>
<p> </p>
<pre><code class="hljs language-arduino" lang="arduino">InputDispatcher::<span class="hljs-built_in">findTouchedWindowTargetsLocked</span>(<span class="hljs-type">nsecs_t</span> currentTime, <span class="hljs-type">const</span> MotionEntry&amp; entry) {
...
<span class="hljs-built_in">addDragEventLocked</span>(entry)<span class="hljs-comment">// 添加Drag事件到队列中</span>
...
}
</code></pre>
<p> </p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">InputDispatcher::addDragEventLocked</span><span class="hljs-params">(<span class="hljs-type">const</span> MotionEntry&amp; entry)</span> {
  ...
  <span class="hljs-comment">//添加拖拽事件到队列</span>
 enqueueDragEventLocked(mDragState-&gt;dragHoverWindowHandle, <span class="hljs-comment">/*isExiting=*/</span><span class="hljs-literal">true</span>, x,
                                       y)
  ....
}
<span class="hljs-type">void</span> <span class="hljs-title function_">InputDispatcher::enqueueDragEventLocked</span><span class="hljs-params">(<span class="hljs-type">const</span> sp&lt;WindowInfoHandle&gt;&amp; windowHandle,
                                             <span class="hljs-type">bool</span> isExiting, <span class="hljs-type">const</span> <span class="hljs-type">int32_t</span> rawX,
                                             <span class="hljs-type">const</span> <span class="hljs-type">int32_t</span> rawY)</span> {
    <span class="hljs-type">const</span> vec2 xy = windowHandle-&gt;getInfo()-&gt;transform.transform(vec2(rawX, rawY));
    <span class="hljs-comment">//初始化事件</span>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">unique_ptr</span>&lt;DragEntry&gt; dragEntry =
            <span class="hljs-built_in">std</span>::make_unique&lt;DragEntry&gt;(mIdGenerator.nextId(), now(), windowHandle-&gt;getToken(),
                                        isExiting, xy.x, xy.y);
    <span class="hljs-comment">//添加拖拽事件到队列</span>
    enqueueInboundEventLocked(<span class="hljs-built_in">std</span>::move(dragEntry));
}
</code></pre>
<p> </p>
<h4 data-id="heading-15">4.3 通过socket发送拖拽事件</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">InputDispatcher::dispatchOnceInnerLocked</span><span class="hljs-params">(<span class="hljs-type">nsecs_t</span>&amp; nextWakeupTime)</span> {
  <span class="hljs-keyword">switch</span> (mPendingEvent-&gt;type) {
     <span class="hljs-keyword">case</span> EventEntry::Type::DRAG: {
            <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;<span class="hljs-type">const</span> DragEntry&gt; typedEntry =
                    <span class="hljs-built_in">std</span>::static_pointer_cast&lt;<span class="hljs-type">const</span> DragEntry&gt;(mPendingEvent);
            dispatchDragLocked(currentTime, typedEntry);
            done = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">break</span>;
        }  
      ...
  }
}


<span class="hljs-type">void</span> <span class="hljs-title function_">InputDispatcher::dispatchDragLocked</span><span class="hljs-params">(<span class="hljs-type">nsecs_t</span> currentTime,
                                         <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;<span class="hljs-type">const</span> DragEntry&gt; entry)</span> {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Connection&gt; connection =
            mConnectionManager.getConnection(entry-&gt;connectionToken);
    <span class="hljs-keyword">if</span> (connection == nullptr) {
        <span class="hljs-keyword">return</span>; <span class="hljs-comment">// Connection has gone away</span>
    }
    entry-&gt;dispatchInProgress = <span class="hljs-literal">true</span>;
    dispatchEventLocked(currentTime, entry, {{connection}});
}
</code></pre>
<p>后续跟事件输入的流程基本一样了，dispatchEventLocked最终到startDispatchCycleLocked</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">InputDispatcher::startDispatchCycleLocked</span><span class="hljs-params">(<span class="hljs-type">nsecs_t</span> currentTime,
                                               <span class="hljs-type">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">shared_ptr</span>&lt;Connection&gt;&amp; connection)</span> {
 <span class="hljs-keyword">switch</span> (eventEntry.type) {
  <span class="hljs-keyword">case</span> EventEntry::Type::DRAG: {
        <span class="hljs-type">const</span> DragEntry&amp; dragEntry = static_cast&lt;<span class="hljs-type">const</span> DragEntry&amp;&gt;(eventEntry);
        <span class="hljs-comment">//调用socket发送事件</span>
        status = connection-&gt;inputPublisher.publishDragEvent(dispatchEntry-&gt;seq,
                                                             dragEntry.id, dragEntry.x,
                                                             dragEntry.y,
                                                             dragEntry.isExiting);
        <span class="hljs-keyword">break</span>;
      }
  }
}
</code></pre>
<p>后续流程可以参考<a href="https://juejin.cn/post/7591338980693639214#heading-12" target="_blank" title="https://juejin.cn/post/7591338980693639214#heading-12"> Android输入系统源码分析(上)</a>
 </p>
<p> </p>
<h3 data-id="heading-16">五、应用层接受事件</h3>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" loading="lazy"/></p>
<h4 data-id="heading-17">5.1InputEventReceiver.consumeEvents接受事件后消费事件</h4>
<pre><code class="hljs language-scss" lang="scss">frameworks/base/core/jni/android_view_InputEventReceiver<span class="hljs-selector-class">.cpp</span>
status_t NativeInputEventReceiver::<span class="hljs-built_in">consumeEvents</span>(JNIEnv* env,
        bool consumeBatches, nsecs_t frameTime, bool* outConsumedBatch) {
  InputEvent* inputEvent;
  <span class="hljs-comment">//读取事件</span>
  status_t status = mInputConsumer<span class="hljs-selector-class">.consume</span>(&amp;mInputEventFactory,
          consumeBatches, frameTime, &amp;seq, &amp;inputEvent);
 switch (inputEvent-&gt;getType()) {
   case InputEventType::MOTION: {
     env-&gt;<span class="hljs-built_in">CallVoidMethod</span>(receiverObj.get(),
            gInputEventReceiverClassInfo<span class="hljs-selector-class">.dispatchInputEvent</span>, seq,
            inputEventObj<span class="hljs-selector-class">.get</span>());
  
   }
    <span class="hljs-comment">//拖拽事件处理</span>
   case InputEventType::DRAG: {
      const DragEvent* dragEvent = static_cast&lt;DragEvent*&gt;(inputEvent);       
      env-&gt;<span class="hljs-built_in">CallVoidMethod</span>(receiverObj.get(), gInputEventReceiverClassInfo<span class="hljs-selector-class">.onDragEvent</span>,
          <span class="hljs-built_in">jboolean</span>(dragEvent-&gt;isExiting()), dragEvent-&gt;<span class="hljs-built_in">getX</span>(),
          dragEvent-&gt;<span class="hljs-built_in">getY</span>());
   }
...
 }
}
</code></pre>
<h4 data-id="heading-18">5.2ViewRootImpl$WindowInputEventReceiver.onDragEvent</h4>
<pre><code class="hljs language-scala" lang="scala">frameworks/base/core/java/android/view/<span class="hljs-type">ViewRootImpl</span>.java
<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WindowInputEventReceiver</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">InputEventReceiver</span> </span>{
          public void onDragEvent(boolean isExiting, float x, float y) {
            <span class="hljs-comment">// force DRAG_EXITED_EVENT if appropriate</span>
            <span class="hljs-type">DragEvent</span> event = <span class="hljs-type">DragEvent</span>.obtain(
                    isExiting ? <span class="hljs-type">DragEvent</span>.<span class="hljs-type">ACTION_DRAG_EXITED</span> : <span class="hljs-type">DragEvent</span>.<span class="hljs-type">ACTION_DRAG_LOCATION</span>,
                    x, y, <span class="hljs-number">0</span> <span class="hljs-comment">/* offsetX */</span>, <span class="hljs-number">0</span> <span class="hljs-comment">/* offsetY */</span>, <span class="hljs-number">0</span> <span class="hljs-comment">/* flags */</span>, <span class="hljs-literal">null</span><span class="hljs-comment">/* localState */</span>,
                    <span class="hljs-literal">null</span><span class="hljs-comment">/* description */</span>, <span class="hljs-literal">null</span> <span class="hljs-comment">/* data */</span>, <span class="hljs-literal">null</span> <span class="hljs-comment">/* dragSurface */</span>,
                    <span class="hljs-literal">null</span> <span class="hljs-comment">/* dragAndDropPermissions */</span>, <span class="hljs-literal">false</span> <span class="hljs-comment">/* result */</span>);
            dispatchDragEvent(event);
        }
}
</code></pre>
<p>dispatchDragEvent后续会调用到 handleDragEvent，然后调用到View.dispatchDragEvent</p>
<p>这样应用层的 通过 setOnDragListener 设置的listener</p>
<p> </p>
<h3 data-id="heading-19">六、总结</h3>
<h4 data-id="heading-20">6.1 核心流程</h4>
<ol>
<li><strong>应用层启动：</strong> 调用 <code>View.startDragAndDrop(DRAG_FLAG_GLOBAL)</code></li>
<li><strong>Framework 层：</strong> <code>ViewRootImpl.performDrag()</code> 通过 Binder 调用系统服务</li>
<li><strong>系统服务层：</strong> <code>WindowManagerService.performDrag()</code> 创建 <code>DragState</code>，通知 <code>InputDispatcher</code></li>
<li><strong>输入系统：</strong> <code>InputDispatcher</code> 将触摸事件转换为拖放事件，分发到所有符合条件的窗口</li>
<li><strong>应用层接收：</strong> Launcher 通过 <code>IWindow.dispatchDragEvent()</code></li>
</ol>
<p> </p>
<h4 data-id="heading-21">6.2时序图</h4>
<p>主要流程时序图</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant App as 应用层
    participant View as View/ViewRootImpl
    participant WMS as WindowManagerService
    participant InputDispatcher as InputDispatcher
    participant InputChannel as InputChannel

    Note over App,InputChannel: 拖拽启动流程
    
    App-&gt;&gt;View: startDragAndDrop(flags=GLOBAL)
    View-&gt;&gt;View: 创建DragSurface
    View-&gt;&gt;WMS: Session.performDrag()
    WMS-&gt;&gt;WMS: DragDropController.performDrag()
    WMS-&gt;&gt;WMS: 创建DragState
    WMS-&gt;&gt;InputDispatcher: registerInputChannel()
    InputDispatcher-&gt;&gt;InputDispatcher: transferTouchGesture()
    InputDispatcher-&gt;&gt;InputDispatcher: 初始化mDragState
    
    Note over App,InputChannel: 事件分发流程
    
    loop 每次触摸移动
        InputDispatcher-&gt;&gt;InputDispatcher: 检测触摸事件
        InputDispatcher-&gt;&gt;InputDispatcher: addDragEventLocked()
        InputDispatcher-&gt;&gt;InputDispatcher: enqueueDragEventLocked()
        InputDispatcher-&gt;&gt;InputChannel: publishDragEvent()
        InputChannel-&gt;&gt;View: 发送拖拽事件
        View-&gt;&gt;App: dispatchDragEvent()
        App-&gt;&gt;App: OnDragListener.onDrag()
    end
    
    Note over App,InputChannel: 拖拽结束流程
    
    App-&gt;&gt;View: 调用endDrag()
    View-&gt;&gt;WMS: 结束拖拽
    WMS-&gt;&gt;InputDispatcher: 清理DragState
    InputDispatcher-&gt;&gt;InputDispatcher: 发送DRAG_EXITED事件
</code></pre>
<p> </p>
<p>数据流转时序图</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Launcher as App
    participant ClipData as ClipData
    participant Surface as DragSurface
    participant DragState as DragState
    participant DragEntry as DragEntry
    participant DragEvent as DragEvent

    Note over Launcher,DragEvent: 数据创建和传递流程
    
    Launcher-&gt;&gt;ClipData: assembleClipData()&lt;br/&gt;创建ClipData对象&lt;br/&gt;包含卡片信息
    Launcher-&gt;&gt;Surface: 创建SurfaceControl&lt;br/&gt;绘制拖拽阴影
    Launcher-&gt;&gt;DragState: performDrag()&lt;br/&gt;传递ClipData和Surface
    
    DragState-&gt;&gt;DragState: 保存mData=ClipData&lt;br/&gt;保存mSurface=Surface
    
    Note over Launcher,DragEvent: 事件生成流程
    
    InputDispatcher-&gt;&gt;DragEntry: enqueueDragEventLocked()&lt;br/&gt;创建DragEntry&lt;br/&gt;包含x, y, isExiting
    DragEntry-&gt;&gt;DragEntry: 坐标转换&lt;br/&gt;transform(rawX, rawY)
    
    Note over Launcher,DragEvent: 事件接收流程
    
    InputReceiver-&gt;&gt;DragEvent: 解析Socket数据&lt;br/&gt;创建DragEvent对象
    DragEvent-&gt;&gt;DragEvent: 设置ACTION类型&lt;br/&gt;ACTION_DRAG_LOCATION&lt;br/&gt;或ACTION_DRAG_EXITED
    DragEvent-&gt;&gt;Launcher: dispatchDragEvent()&lt;br/&gt;传递到应用层
    Launcher-&gt;&gt;Launcher: 从event.getClipData()&lt;br/&gt;获取原始数据
</code></pre>
<p> </p>
<p>完整时序图</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Launcher as App应用层
    participant View as View
    participant ViewRootImpl as ViewRootImpl
    participant Session as Session
    participant DragDropController as DragDropController
    participant WMS as WindowManagerService
    participant InputManager as InputManagerService
    participant InputDispatcher as InputDispatcher
    participant Socket as Socket通信
    participant InputReceiver as InputEventReceiver
    participant DragListener as OnDragListener

    Note over Launcher,DragListener: 一、启动拖拽阶段
    
    Launcher-&gt;&gt;Launcher: assembleClipData&lt;br/&gt;组装卡片数据
    Launcher-&gt;&gt;View: startDragAndDrop(data, builder, flags)
    
    View-&gt;&gt;View: 检查DRAG_FLAG_ACCESSIBILITY_ACTION
    alt 无障碍模式
        View-&gt;&gt;Session: performDrag(无需Surface)
    else 正常模式
        View-&gt;&gt;View: 创建SurfaceControl
        View-&gt;&gt;View: 创建Canvas并绘制阴影
        View-&gt;&gt;ViewRootImpl: performDrag(surfaceControl, data)
    end
    
    ViewRootImpl-&gt;&gt;Session: performDrag(window, flags, surface, data)
    Session-&gt;&gt;DragDropController: performDrag(...)
    
    Note over DragDropController: 初始化DragState
    DragDropController-&gt;&gt;DragDropController: 创建DragState对象
    DragDropController-&gt;&gt;DragDropController: 设置mData, mToken等属性
    
    DragDropController-&gt;&gt;WMS: registerInputChannel(DragState)
    WMS-&gt;&gt;InputManager: startDragAndDrop(sourceToken, dragToken)
    InputManager-&gt;&gt;InputDispatcher: transferTouchGesture(fromToken, toToken, isDragDrop=true)
    
    Note over InputDispatcher: 初始化拖拽状态
    InputDispatcher-&gt;&gt;InputDispatcher: 创建mDragState
    InputDispatcher-&gt;&gt;InputDispatcher: 唤醒事件分发循环
    
    Note over Launcher,DragListener: 二、事件分发阶段
    
    InputDispatcher-&gt;&gt;InputDispatcher: findTouchedWindowTargetsLocked
    InputDispatcher-&gt;&gt;InputDispatcher: addDragEventLocked
    InputDispatcher-&gt;&gt;InputDispatcher: enqueueDragEventLocked&lt;br/&gt;创建DragEntry
    InputDispatcher-&gt;&gt;InputDispatcher: enqueueInboundEventLocked&lt;br/&gt;添加到队列
    
    InputDispatcher-&gt;&gt;InputDispatcher: dispatchOnceInnerLocked
    InputDispatcher-&gt;&gt;InputDispatcher: dispatchDragLocked
    InputDispatcher-&gt;&gt;InputDispatcher: startDispatchCycleLocked
    InputDispatcher-&gt;&gt;Socket: publishDragEvent(seq, id, x, y, isExiting)
    
    Note over Launcher,DragListener: 三、应用层接收阶段
    
    Socket-&gt;&gt;InputReceiver: 接收拖拽事件数据
    InputReceiver-&gt;&gt;InputReceiver: consumeEvents
    InputReceiver-&gt;&gt;InputReceiver: InputConsumer.consume&lt;br/&gt;解析DragEvent
    InputReceiver-&gt;&gt;ViewRootImpl: onDragEvent(isExiting, x, y)
    
    ViewRootImpl-&gt;&gt;ViewRootImpl: 创建DragEvent对象&lt;br/&gt;ACTION_DRAG_LOCATION&lt;br/&gt;或ACTION_DRAG_EXITED
    ViewRootImpl-&gt;&gt;View: dispatchDragEvent(event)
    View-&gt;&gt;DragListener: onDrag(v, event)
    DragListener-&gt;&gt;Launcher: handleDragEvent(event)
    
    Note over Launcher: 处理拖拽事件&lt;br/&gt;更新UI状态
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android-常见问题]]></title>    <link>https://juejin.cn/post/7600863478929129491</link>    <guid>https://juejin.cn/post/7600863478929129491</guid>    <pubDate>2026-01-30T08:06:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600863478929129491" data-draft-id="7600964907488444422" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android-常见问题"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-30T08:06:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xxthy"/> <meta itemprop="url" content="https://juejin.cn/user/3281414678644264"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android-常见问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3281414678644264/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xxthy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T08:06:45.000Z" title="Fri Jan 30 2026 08:06:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">XML</h2>
<pre><code class="hljs language-ini" lang="ini">&lt;androidx.appcompat.widget.AppCompatImageView
    android:<span class="hljs-attr">id</span>=<span class="hljs-string">"@+id/iv_title_vip"</span>
    android:<span class="hljs-attr">layout_marginStart</span>=<span class="hljs-string">"12dp"</span>
    app:<span class="hljs-attr">layout_constraintStart_toStartOf</span>=<span class="hljs-string">"parent"</span>
    app:<span class="hljs-attr">layout_constraintTop_toTopOf</span>=<span class="hljs-string">"parent"</span>
    android:<span class="hljs-attr">scaleType</span>=<span class="hljs-string">"fitStart"</span>
    android:<span class="hljs-attr">adjustViewBounds</span>=<span class="hljs-string">"true"</span>
    android:<span class="hljs-attr">layout_width</span>=<span class="hljs-string">"wrap_content"</span>
    android:<span class="hljs-attr">layout_height</span>=<span class="hljs-string">"20dp"</span>/&gt;
</code></pre>
<p>android:adjustViewBounds 让ImageView根据图片的实际宽高比自动调整边界</p>
<p>方法block回调，参数透传</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkShowEmoteGuide</span><span class="hljs-params">(callback: (() -&gt; <span class="hljs-type">Unit</span>)?= <span class="hljs-literal">null</span>)</span></span> {

  callback?.invoke()
  
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">videoFeedConfig</span><span class="hljs-params">(<span class="hljs-keyword">val</span> scene: <span class="hljs-type">String</span>?, <span class="hljs-keyword">val</span> canSlide: <span class="hljs-type">Boolean</span>? = <span class="hljs-literal">false</span>)</span></span> {

}
</code></pre>
<p>接收 new</p>
<pre><code class="hljs language-kotlin" lang="kotlin">emoteView.checkShowEmoteGuide(new Function0&lt;<span class="hljs-built_in">Unit</span>&gt;() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">Unit</span> invoke() {
        isShowEmote = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
});
</code></pre>
<h2 data-id="heading-1">本地存储</h2>
<p>getUserSp 用户纬度</p>
<p>UserHelper.getGlobleSp 设备纬度</p>
<p>UserHelper.getGlobleSp().putBoolean(PreferencesConst.POST_INFO_COMMENT_GUIDE, true);</p>
<p>boolean isShowComment = UserHelper.getGlobleSp().getBoolean(PreferencesConst.POST_INFO_COMMENT_GUIDE, false);</p>
<h2 data-id="heading-2">动画</h2>
<p>java</p>
<pre><code class="hljs language-scss" lang="scss">contentView<span class="hljs-selector-class">.animate</span>()
        <span class="hljs-selector-class">.alpha</span>(<span class="hljs-number">0</span>f)
        <span class="hljs-selector-class">.setDuration</span>(<span class="hljs-number">300</span>)
        <span class="hljs-selector-class">.withEndAction</span>(new Runnable() {
            <span class="hljs-keyword">@Override</span>
            public void run() {
                if (guidePopupWindow != null) {
                    guidePopupWindow<span class="hljs-selector-class">.safeDismiss</span>();
                    guidePopupWindow = null;
                }
            }
        })
        <span class="hljs-selector-class">.start</span>();
</code></pre>
<p>kt</p>
<pre><code class="hljs language-scss" lang="scss">contentView<span class="hljs-selector-class">.alpha</span> = <span class="hljs-number">0</span>f
contentView<span class="hljs-selector-class">.animate</span>()
    <span class="hljs-selector-class">.alpha</span>(<span class="hljs-number">1</span>f)
    <span class="hljs-selector-class">.setDuration</span>(<span class="hljs-number">300</span>)
    <span class="hljs-selector-class">.start</span>()
</code></pre>
<h2 data-id="heading-3">runnable 任务</h2>
<pre><code class="hljs language-scss" lang="scss">private Runnable <span class="hljs-built_in">showGuidePopupRunnable</span>() {
    return new <span class="hljs-built_in">Runnable</span>() {
        <span class="hljs-keyword">@Override</span>
        public void run() {
            mBottomView<span class="hljs-selector-class">.removeCallbacks</span>(null);
            if (isShowEmote == false &amp;&amp; guidePopupWindow != null &amp;&amp; commentContentOnTheScreen(<span class="hljs-number">1</span>)) {
                guidePopupWindow<span class="hljs-selector-class">.showAsDropDown</span>(mBottomView, DpAndPxUtils.dip2px(-<span class="hljs-number">16</span>), DpAndPxUtils<span class="hljs-selector-class">.dip2px</span>(-<span class="hljs-number">100</span>));
                isShowComment = true;
                UserHelper<span class="hljs-selector-class">.getGlobleSp</span>()<span class="hljs-selector-class">.putBoolean</span>(PreferencesConst.POST_INFO_COMMENT_GUIDE, true);
                contentView<span class="hljs-selector-class">.setAlpha</span>(<span class="hljs-number">0</span>f);
                contentView<span class="hljs-selector-class">.animate</span>()
                        <span class="hljs-selector-class">.alpha</span>(<span class="hljs-number">1</span>f)
                        <span class="hljs-selector-class">.setDuration</span>(<span class="hljs-number">300</span>)
                        <span class="hljs-selector-class">.start</span>();

                mBottomView<span class="hljs-selector-class">.postDelayed</span>(new Runnable() {
                    <span class="hljs-keyword">@Override</span>
                    public void run() {
                        <span class="hljs-built_in">dismissGuidePopup</span>();
                    }
                }, <span class="hljs-number">3000</span>);
            }
        }
    };
}
</code></pre>
<h2 data-id="heading-4">延迟展示</h2>
<p>mBottomView.postDelayed(showGuidePopupRunnable(), 3000);</p>
<h2 data-id="heading-5">操作取消</h2>
<p>mBottomView.removeCallbacks(null);</p>
<h2 data-id="heading-6">弱引用</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 改用静态内部类 + 弱引用解决</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeRunnable</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> WeakReference&lt;Activity&gt; activityRef;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> WeakReference&lt;View&gt; anchorViewRef;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OnShowGuideTipListener listener;

    SafeRunnable(Activity activity, View view, OnShowGuideTipListener l) {
        <span class="hljs-built_in">this</span>.activityRef = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakReference</span>&lt;&gt;(activity);
        <span class="hljs-built_in">this</span>.anchorViewRef = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakReference</span>&lt;&gt;(view);
        <span class="hljs-built_in">this</span>.listener = l;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        <span class="hljs-type">Activity</span> <span class="hljs-variable">activity</span> <span class="hljs-operator">=</span> activityRef.get();
        <span class="hljs-type">View</span> <span class="hljs-variable">view</span> <span class="hljs-operator">=</span> anchorViewRef.get();
        <span class="hljs-keyword">if</span> (activity == <span class="hljs-literal">null</span> || view == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span>;
        
        dismissGuideTipBox();
        <span class="hljs-keyword">if</span> (listener != <span class="hljs-literal">null</span>) {
            listener.showGuideTip();
        }
    }
}
</code></pre>
<h2 data-id="heading-7">imageloader 图片加载</h2>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-type">void</span> <span class="hljs-title">loadImg</span><span class="hljs-params">(<span class="hljs-type">String</span> imgUrl, ImageView imageView, <span class="hljs-type">boolean</span> autoSize, <span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height)</span> </span>{
    <span class="hljs-keyword">if</span> (!TextUtils.<span class="hljs-built_in">isEmpty</span>(imgUrl)) {
        IImageLoader imageLoader = ImageLoader.<span class="hljs-built_in">get</span>(context).<span class="hljs-built_in">load</span>(imgUrl)
                .<span class="hljs-built_in">autoSize</span>(autoSize);
        <span class="hljs-keyword">if</span> (width &gt; <span class="hljs-number">0</span>) {
           imageLoader = imageLoader.<span class="hljs-built_in">urlWidth</span>(width);
        }
        <span class="hljs-keyword">if</span> (height &gt; <span class="hljs-number">0</span>) {
            imageLoader = imageLoader.<span class="hljs-built_in">urlHeight</span>(height);
        }
        <span class="hljs-keyword">if</span> (width &gt; <span class="hljs-number">0</span> &amp;&amp; height &gt; <span class="hljs-number">0</span> &amp;&amp; !autoSize) {
            imageLoader = imageLoader.<span class="hljs-built_in">size</span>(width, height);
        }
        imageLoader.<span class="hljs-built_in">target</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">LoadCompleteCallback</span>&lt;Bitmap&gt;() {
                    @Override
                    <span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-built_in">onLoadComplete</span>(Bitmap resource) {
                        <span class="hljs-keyword">if</span> (resource != null) {
                            imageView.<span class="hljs-built_in">setImageBitmap</span>(resource);
                        }
                    }

                    @Override
                    <span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-built_in">onLoadFailed</span>(Exception info) {

                    }
                }).<span class="hljs-built_in">request</span>();
    }
}
</code></pre>
<h2 data-id="heading-8">IDE报错</h2>
<p>Couldn't resolve the package 'shimmer' in 'package:shimmer/shimmer.dart'.</p>
<p>local.properties</p>
<p>本地 #application.debug.flutterAAR=false </p>
<pre><code class="hljs language-arduino" lang="arduino">ndk {
    abiFilters <span class="hljs-string">"armeabi-v7a"</span>
    packagingOptions {
        doNotStrip <span class="hljs-string">"*/armeabi-v7a/*.so"</span>
    }
}
</code></pre>
<p>安卓硬改32位系统在64位上运行</p>
<h2 data-id="heading-9">跳转到flutter页面</h2>
<p>HashMap&lt;String, Object&gt; maps = new HashMap&lt;&gt;();</p>
<p>maps.put("blogId", blogId);</p>
<p>maps.put("otherBlogId", otherBlogId);</p>
<p>maps.put("otherBlogName", otherBlogName);</p>
<p>maps.put("dnd", dndInt);</p>
<p>maps.put("menuShowStatus", isMenuStyleInt);</p>
<p>FlutterNativeManager.route(((Activity) mcontext), RouteConfig.SingleChatDetailPage, maps);</p>
<h2 data-id="heading-10">实例化对象查找</h2>
<p>singleChatActivity.Class</p>
<h3 data-id="heading-11"><code>@Keep</code>：代码混淆的“护盾”</h3></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[关于梆梆加固应用收集堆栈崩溃]]></title>    <link>https://juejin.cn/post/7600863478929178643</link>    <guid>https://juejin.cn/post/7600863478929178643</guid>    <pubDate>2026-01-30T08:16:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600863478929178643" data-draft-id="7600706866786041899" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="关于梆梆加固应用收集堆栈崩溃"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-30T08:16:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="PenguinLetsGo"/> <meta itemprop="url" content="https://juejin.cn/user/1025210238645342"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            关于梆梆加固应用收集堆栈崩溃
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1025210238645342/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    PenguinLetsGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T08:16:50.000Z" title="Fri Jan 30 2026 08:16:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题背景</h2>
<p>近期收到某大厂反馈他们的应用程序在我们的机型中频繁出现如下崩溃信息。这个问题处理前面是其他同事处理的，后来同事咨询问如何跟踪某个管道 FD 被关闭的堆栈，看了他们的文档介绍后，一看这东西咋那么眼熟。</p>
<pre><code class="hljs language-rust" lang="rust"> pid: <span class="hljs-number">21992</span>, tid: <span class="hljs-number">28371</span>, name: Signal Catcher  &gt;&gt;&gt; a.b.c &lt;&lt;&lt;
 uid: <span class="hljs-number">10283</span>
 tagged_addr_ctrl: <span class="hljs-number">0000000000000001</span> (PR_TAGGED_ADDR_ENABLE)
 pac_enabled_keys: <span class="hljs-number">000000000000000</span>f (PR_PAC_APIAKEY, PR_PAC_APIBKEY, PR_PAC_APDAKEY, PR_PAC_APDBKEY)
 esr: <span class="hljs-number">0000000092000006</span> (Data Abort Exception <span class="hljs-number">0x24</span>)
 signal <span class="hljs-number">6</span> (SIGABRT), code -<span class="hljs-number">1</span> (SI_QUEUE), fault addr --------
 Abort message: <span class="hljs-symbol">'Check</span> failed: niceness != -<span class="hljs-number">1</span> || errno == <span class="hljs-number">0</span>  No such process tid:<span class="hljs-number">28373</span>' 
     x0  <span class="hljs-number">0000000000000000</span>  x1  <span class="hljs-number">0000000000006</span>ed3  x2  <span class="hljs-number">0000000000000006</span>  x3  <span class="hljs-number">000000774e92</span>bd40
     x4  <span class="hljs-number">00000000000</span>efe20  x5  <span class="hljs-number">00000000000</span>efe20  x6  <span class="hljs-number">00000000000</span>efe20  x7  <span class="hljs-number">0000000000000001</span>
     x8  <span class="hljs-number">00000000000000</span>f0  x9  <span class="hljs-number">000001</span>ff00000020  x10 <span class="hljs-number">000000</span>ff00000020  x11 <span class="hljs-number">000000000012800</span>c
     x12 <span class="hljs-number">000000000000</span>cc32  x13 <span class="hljs-number">000000005</span>fff4000  x14 <span class="hljs-number">0000000000000001</span>  x15 <span class="hljs-number">00000000000000</span>f0
     x16 <span class="hljs-number">0000007</span>a1e58a170  x17 <span class="hljs-number">0000007</span>a1e570840  x18 <span class="hljs-number">00000076</span>dde34000  x19 <span class="hljs-number">00000000000055e8</span>
     x20 <span class="hljs-number">0000000000006</span>ed3  x21 <span class="hljs-number">00000000</span>ffffffff  x22 <span class="hljs-number">0000007761e146</span>c8  x23 <span class="hljs-number">0000007855603010</span>
     x24 <span class="hljs-number">0000007761e13000</span>  x25 <span class="hljs-number">0000000000</span>fffff9  x26 <span class="hljs-number">000000005</span>a000000  x27 <span class="hljs-number">0000000000000000</span>
     x28 b4000077e5616d10  x29 <span class="hljs-number">000000774e92</span>bdc0
     lr  <span class="hljs-number">0000007</span>a1e510c3c  sp  <span class="hljs-number">000000774e92</span>bd40  pc  <span class="hljs-number">0000007</span>a1e510c60  pst <span class="hljs-number">0000000000001000</span>
     esr <span class="hljs-number">0000000092000006</span>
 <span class="hljs-number">26</span> total frames
 backtrace:
       #<span class="hljs-number">00</span> pc <span class="hljs-number">0000000000075</span>c60  /apex/com.android.runtime/lib64/bionic/libc.<span class="hljs-title function_ invoke__">so</span> (abort+<span class="hljs-number">160</span>) (BuildId: c56349c5b531d74a1e2fa0bafba78e5c)
       #<span class="hljs-number">01</span> pc <span class="hljs-number">000000000091</span>ee30  /apex/com.android.art/lib64/libart.<span class="hljs-title function_ invoke__">so</span> (art::Runtime::<span class="hljs-title function_ invoke__">Abort</span>(<span class="hljs-type">char</span> <span class="hljs-keyword">const</span>*)+<span class="hljs-number">1008</span>) (BuildId: <span class="hljs-number">358</span>ba270e15145fce121992683a577bc)
       #<span class="hljs-number">02</span> pc <span class="hljs-number">0000000000016134</span>  /apex/com.android.art/lib64/libbase.<span class="hljs-title function_ invoke__">so</span> (android::base::<span class="hljs-title function_ invoke__">SetAborter</span>(std::__1::function&lt;<span class="hljs-title function_ invoke__">void</span> (<span class="hljs-type">char</span> <span class="hljs-keyword">const</span>*)&gt;&amp;&amp;)::$_0::__invoke(<span class="hljs-type">char</span> <span class="hljs-keyword">const</span>*)+<span class="hljs-number">68</span>) (BuildId: e3a4bdc6221ada5240a090255fdc022d)
       #<span class="hljs-number">03</span> pc <span class="hljs-number">0000000000015690</span>  /apex/com.android.art/lib64/libbase.<span class="hljs-title function_ invoke__">so</span> (android::base::LogMessage::~<span class="hljs-title function_ invoke__">LogMessage</span>()+<span class="hljs-number">540</span>) (BuildId: e3a4bdc6221ada5240a090255fdc022d)
       #<span class="hljs-number">04</span> pc <span class="hljs-number">00000000004</span>b0264  /apex/com.android.art/lib64/libart.<span class="hljs-title function_ invoke__">so</span> (art::Thread::<span class="hljs-title function_ invoke__">GetNativeNiceness</span>() <span class="hljs-keyword">const</span>+<span class="hljs-number">412</span>) (BuildId: <span class="hljs-number">358</span>ba270e15145fce121992683a577bc)
       #<span class="hljs-number">05</span> pc <span class="hljs-number">0000000000456</span>f24  /apex/com.android.art/lib64/libart.<span class="hljs-title function_ invoke__">so</span> (art::Thread::<span class="hljs-title function_ invoke__">DumpState</span>(std::__1::basic_ostream&lt;<span class="hljs-type">char</span>, std::__1::char_traits&lt;<span class="hljs-type">char</span>&gt;&gt;&amp;, art::Thread <span class="hljs-keyword">const</span>*, int)+<span class="hljs-number">3768</span>) (BuildId: <span class="hljs-number">358</span>ba270e15145fce121992683a577bc)
       #<span class="hljs-number">06</span> pc <span class="hljs-number">0000000000455</span>a04  /apex/com.android.art/lib64/libart.<span class="hljs-title function_ invoke__">so</span> (art::Thread::<span class="hljs-title function_ invoke__">Dump</span>(std::__1::basic_ostream&lt;<span class="hljs-type">char</span>, std::__1::char_traits&lt;<span class="hljs-type">char</span>&gt;&gt;&amp;, unwindstack::AndroidLocalUnwinder&amp;, <span class="hljs-type">bool</span>, <span class="hljs-type">bool</span>) <span class="hljs-keyword">const</span>+<span class="hljs-number">56</span>) (BuildId: <span class="hljs-number">358</span>ba270e15145fce121992683a577bc)
       #<span class="hljs-number">07</span> pc <span class="hljs-number">00000000004558</span>f4  /apex/com.android.art/lib64/libart.<span class="hljs-title function_ invoke__">so</span> (art::DumpCheckpoint::<span class="hljs-title function_ invoke__">Run</span>(art::Thread*)+<span class="hljs-number">116</span>) (BuildId: <span class="hljs-number">358</span>ba270e15145fce121992683a577bc) 
       #<span class="hljs-number">08</span> pc <span class="hljs-number">00000000002</span>c1a14  /apex/com.android.art/lib64/libart.<span class="hljs-title function_ invoke__">so</span> (art::ThreadList::<span class="hljs-title function_ invoke__">RunCheckpoint</span>(art::Closure*, art::Closure*, <span class="hljs-type">bool</span>, <span class="hljs-type">bool</span>)+<span class="hljs-number">1140</span>) (BuildId: <span class="hljs-number">358</span>ba270e15145fce121992683a577bc)
       #<span class="hljs-number">09</span> pc <span class="hljs-number">0000000000459</span>fc8  /apex/com.android.art/lib64/libart.<span class="hljs-title function_ invoke__">so</span> (art::ThreadList::<span class="hljs-title function_ invoke__">Dump</span>(std::__1::basic_ostream&lt;<span class="hljs-type">char</span>, std::__1::char_traits&lt;<span class="hljs-type">char</span>&gt;&gt;&amp;, <span class="hljs-type">bool</span>)+<span class="hljs-number">216</span>) (BuildId: <span class="hljs-number">358</span>ba270e15145fce121992683a577bc)
       #<span class="hljs-number">10</span> pc <span class="hljs-number">0000000000922</span>b50  /apex/com.android.art/lib64/libart.<span class="hljs-title function_ invoke__">so</span> (art::AbortState::<span class="hljs-title function_ invoke__">Dump</span>(std::__1::basic_ostream&lt;<span class="hljs-type">char</span>, std::__1::char_traits&lt;<span class="hljs-type">char</span>&gt;&gt;&amp;) <span class="hljs-keyword">const</span>+<span class="hljs-number">208</span>) (BuildId: <span class="hljs-number">358</span>ba270e15145fce121992683a577bc)
       #<span class="hljs-number">11</span> pc <span class="hljs-number">000000000091</span>ee78  /apex/com.android.art/lib64/libart.<span class="hljs-title function_ invoke__">so</span> (art::Runtime::<span class="hljs-title function_ invoke__">Abort</span>(<span class="hljs-type">char</span> <span class="hljs-keyword">const</span>*)+<span class="hljs-number">1080</span>) (BuildId: <span class="hljs-number">358</span>ba270e15145fce121992683a577bc)
       #<span class="hljs-number">12</span> pc <span class="hljs-number">0000000000016134</span>  /apex/com.android.art/lib64/libbase.<span class="hljs-title function_ invoke__">so</span> (android::base::<span class="hljs-title function_ invoke__">SetAborter</span>(std::__1::function&lt;<span class="hljs-title function_ invoke__">void</span> (<span class="hljs-type">char</span> <span class="hljs-keyword">const</span>*)&gt;&amp;&amp;)::$_0::__invoke(<span class="hljs-type">char</span> <span class="hljs-keyword">const</span>*)+<span class="hljs-number">68</span>) (BuildId: e3a4bdc6221ada5240a090255fdc022d)
       #<span class="hljs-number">13</span> pc <span class="hljs-number">0000000000015690</span>  /apex/com.android.art/lib64/libbase.<span class="hljs-title function_ invoke__">so</span> (android::base::LogMessage::~<span class="hljs-title function_ invoke__">LogMessage</span>()+<span class="hljs-number">540</span>) (BuildId: e3a4bdc6221ada5240a090255fdc022d)
       #<span class="hljs-number">14</span> pc <span class="hljs-number">00000000004</span>b0264  /apex/com.android.art/lib64/libart.<span class="hljs-title function_ invoke__">so</span> (art::Thread::<span class="hljs-title function_ invoke__">GetNativeNiceness</span>() <span class="hljs-keyword">const</span>+<span class="hljs-number">412</span>) (BuildId: <span class="hljs-number">358</span>ba270e15145fce121992683a577bc)
       #<span class="hljs-number">15</span> pc <span class="hljs-number">0000000000456</span>b3c  /apex/com.android.art/lib64/libart.<span class="hljs-title function_ invoke__">so</span> (art::Thread::<span class="hljs-title function_ invoke__">DumpState</span>(std::__1::basic_ostream&lt;<span class="hljs-type">char</span>, std::__1::char_traits&lt;<span class="hljs-type">char</span>&gt;&gt;&amp;, art::Thread <span class="hljs-keyword">const</span>*, int)+<span class="hljs-number">2768</span>) (BuildId: <span class="hljs-number">358</span>ba270e15145fce121992683a577bc)
       #<span class="hljs-number">16</span> pc <span class="hljs-number">0000000000455</span>a04  /apex/com.android.art/lib64/libart.<span class="hljs-title function_ invoke__">so</span> (art::Thread::<span class="hljs-title function_ invoke__">Dump</span>(std::__1::basic_ostream&lt;<span class="hljs-type">char</span>, std::__1::char_traits&lt;<span class="hljs-type">char</span>&gt;&gt;&amp;, unwindstack::AndroidLocalUnwinder&amp;, <span class="hljs-type">bool</span>, <span class="hljs-type">bool</span>) <span class="hljs-keyword">const</span>+<span class="hljs-number">56</span>) (BuildId: <span class="hljs-number">358</span>ba270e15145fce121992683a577bc)
       #<span class="hljs-number">17</span> pc <span class="hljs-number">00000000004558</span>f4  /apex/com.android.art/lib64/libart.<span class="hljs-title function_ invoke__">so</span> (art::DumpCheckpoint::<span class="hljs-title function_ invoke__">Run</span>(art::Thread*)+<span class="hljs-number">116</span>) (BuildId: <span class="hljs-number">358</span>ba270e15145fce121992683a577bc)
       #<span class="hljs-number">18</span> pc <span class="hljs-number">00000000002</span>c1a14  /apex/com.android.art/lib64/libart.<span class="hljs-title function_ invoke__">so</span> (art::ThreadList::<span class="hljs-title function_ invoke__">RunCheckpoint</span>(art::Closure*, art::Closure*, <span class="hljs-type">bool</span>, <span class="hljs-type">bool</span>)+<span class="hljs-number">1140</span>) (BuildId: <span class="hljs-number">358</span>ba270e15145fce121992683a577bc)
       #<span class="hljs-number">19</span> pc <span class="hljs-number">0000000000459</span>fc8  /apex/com.android.art/lib64/libart.<span class="hljs-title function_ invoke__">so</span> (art::ThreadList::<span class="hljs-title function_ invoke__">Dump</span>(std::__1::basic_ostream&lt;<span class="hljs-type">char</span>, std::__1::char_traits&lt;<span class="hljs-type">char</span>&gt;&gt;&amp;, <span class="hljs-type">bool</span>)+<span class="hljs-number">216</span>) (BuildId: <span class="hljs-number">358</span>ba270e15145fce121992683a577bc)
       #<span class="hljs-number">20</span> pc <span class="hljs-number">0000000000459</span>a58  /apex/com.android.art/lib64/libart.<span class="hljs-title function_ invoke__">so</span> (art::ThreadList::<span class="hljs-title function_ invoke__">DumpForSigQuit</span>(std::__1::basic_ostream&lt;<span class="hljs-type">char</span>, std::__1::char_traits&lt;<span class="hljs-type">char</span>&gt;&gt;&amp;)+<span class="hljs-number">376</span>) (BuildId: <span class="hljs-number">358</span>ba270e15145fce121992683a577bc)
       #<span class="hljs-number">21</span> pc <span class="hljs-number">0000000000458</span>cd0  /apex/com.android.art/lib64/libart.<span class="hljs-title function_ invoke__">so</span> (art::Runtime::<span class="hljs-title function_ invoke__">DumpForSigQuit</span>(std::__1::basic_ostream&lt;<span class="hljs-type">char</span>, std::__1::char_traits&lt;<span class="hljs-type">char</span>&gt;&gt;&amp;)+<span class="hljs-number">48</span>) (BuildId: <span class="hljs-number">358</span>ba270e15145fce121992683a577bc)
       #<span class="hljs-number">22</span> pc <span class="hljs-number">00000000005097e0</span>  /apex/com.android.art/lib64/libart.<span class="hljs-title function_ invoke__">so</span> (art::SignalCatcher::<span class="hljs-title function_ invoke__">HandleSigQuit</span>()+<span class="hljs-number">632</span>) (BuildId: <span class="hljs-number">358</span>ba270e15145fce121992683a577bc)
       #<span class="hljs-number">23</span> pc <span class="hljs-number">00000000004713</span>a4  /apex/com.android.art/lib64/libart.<span class="hljs-title function_ invoke__">so</span> (art::SignalCatcher::<span class="hljs-title function_ invoke__">Run</span>(void*)+<span class="hljs-number">1388</span>) (BuildId: <span class="hljs-number">358</span>ba270e15145fce121992683a577bc)
       #<span class="hljs-number">24</span> pc <span class="hljs-number">0000000000086</span>f60  /apex/com.android.runtime/lib64/bionic/libc.<span class="hljs-title function_ invoke__">so</span> (__pthread_start(void*) (.__uniq.<span class="hljs-number">67847048707805468364044055584648682506</span>)+<span class="hljs-number">184</span>) (BuildId: c56349c5b531d74a1e2fa0bafba78e5c)
       #<span class="hljs-number">25</span> pc <span class="hljs-number">0000000000079690</span>  /apex/com.android.runtime/lib64/bionic/libc.<span class="hljs-title function_ invoke__">so</span> (__start_thread+<span class="hljs-number">68</span>) (BuildId: c56349c5b531d74a1e2fa0bafba78e5c)
</code></pre>
<p>其 abort 原因在函数 GetNativeNiceness 上发现该 art::Thread 已经不存在，从 Signal Catcher 线程号 28371，线程号 28373 基本可以判断是虚拟机创建的线程，诸如“Metrics Background Reporting Thread”，“perfetto_hprof_listener”，“ADB-JDWP Connection Control Thread” 等。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68fc980235f746bc92a4d94f5407b423~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGVuZ3VpbkxldHNHbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770365813&amp;x-signature=APsmwbYUeiVdrDHaAmwJCpzaNb4%3D" alt="img_v3_02ue_63d643aa-ede9-486b-986d-74d08548a95g.jpg" loading="lazy"/>
该函数 art::Thread::GetNativeNiceness() 替代以前的 art::Thread::GetNativePriority();</p>
<h2 data-id="heading-1">问题分析</h2>
<p>安装反馈提供的应用程序启动后，用抓取现场，可以看到线程 <code>perfetto_hprof_listener</code> 已经不存在了，但是它的 art::Thread 对象依旧挂在 thread_list_ 列表，意味着该线程退出前，没有 Unregister() 从列表中移除，于是调用 GetNativeNiceness 函数触发 abort 中断程序。</p>
<pre><code class="hljs language-arduino" lang="arduino">core-parser&gt; t -a
 ID   TID    STATUS                          ADDRESS              NAME
*<span class="hljs-number">1</span>    <span class="hljs-number">11589</span>  Native                          <span class="hljs-number">0xb400007472617010</span>   <span class="hljs-string">"main"</span> 
 <span class="hljs-number">2</span>    <span class="hljs-number">12468</span>  WaitingInMainSignalCatcherLoop  <span class="hljs-number">0x747263b820</span>         <span class="hljs-string">"Signal Catcher"</span> 
 <span class="hljs-number">3</span>    <span class="hljs-number">12469</span>  Native                          <span class="hljs-number">0x747261fb20</span>         <span class="hljs-string">"perfetto_hprof_listener"</span> (NOT EXIST THREAD)
 <span class="hljs-number">4</span>    <span class="hljs-number">12470</span>  WaitingInMainDebuggerLoop       <span class="hljs-number">0x747261c380</span>         <span class="hljs-string">"ADB-JDWP Connection Control Thread"</span> 
 <span class="hljs-number">5</span>    <span class="hljs-number">12472</span>  Native                          <span class="hljs-number">0x747261a7b0</span>         <span class="hljs-string">"Jit thread pool worker thread 0"</span> 
 <span class="hljs-number">6</span>    <span class="hljs-number">12474</span>  Waiting                         <span class="hljs-number">0x7472628630</span>         <span class="hljs-string">"ReferenceQueueDaemon"</span> 
 <span class="hljs-number">7</span>    <span class="hljs-number">12473</span>  WaitingForTaskProcessor         <span class="hljs-number">0x74726216f0</span>         <span class="hljs-string">"HeapTaskDaemon"</span> 
 <span class="hljs-number">8</span>    <span class="hljs-number">12475</span>  Waiting                         <span class="hljs-number">0x74726232c0</span>         <span class="hljs-string">"FinalizerDaemon"</span> 
 <span class="hljs-number">9</span>    <span class="hljs-number">12476</span>  Sleeping                        <span class="hljs-number">0x7472639c50</span>         <span class="hljs-string">"FinalizerWatchdogDaemon"</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddf4db13c3e141809d0fce079cb8d4e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGVuZ3VpbkxldHNHbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770365813&amp;x-signature=d0WtMxtP1dKrVXzR4%2BHGY8E9MVs%3D" alt="img_v3_02ue_f5cb46e6-0349-4275-8cd4-83a282ab3dfg.jpg" loading="lazy"/></p>
<p>可以看到线程 <code>perfetto_hprof_listener</code> 代码仅有 AttachCurrentThread 函数添加到虚拟机管理，没有在异常退出处调用 DetachCurrentThread 反注册移除 thread_list_ 的列表。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/941423400109496ca3eb445428f2ef75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGVuZ3VpbkxldHNHbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770365813&amp;x-signature=WBYYKvEfr0THuinmtsIeg%2B%2F97xc%3D" alt="img_v3_02ue_1dff549a-7782-41b1-b1fc-663fc6338fdg.jpg" loading="lazy"/></p>
<p>从代码的角度，不难发现只有写管道的 <code>g_signal_pipe_fds[1]</code> 被关闭的情况下退出满足条件退出循环。看到这个变量符号那一刻，<a href="https://juejin.cn/post/7436662001802002484" target="_blank" title="https://juejin.cn/post/7436662001802002484">关于 Android15 GKI2407R40 导致梆梆加固软件崩溃</a>，不就是当时这个问题里看到代码片段吗...。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc864d0e4bd74a50afd9179ef9bb5481~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGVuZ3VpbkxldHNHbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770365813&amp;x-signature=tI%2FbNsVpzYMXVG%2Byq%2F4krLnhodo%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">调试取证</h2>
<p>两年前已经存在这样的逻辑，我想现在发生类似的事情，这部分代码应该还在，于是抓个现场证据看看。已知条件是通过读取 g_signal_pipe_fds 符号地址，获取写管道 fd 的值。调用 close 进行关闭操作。</p>
<h3 data-id="heading-3">注入 libopencore.so</h3>
<pre><code class="hljs language-vbnet" lang="vbnet"># setenforce <span class="hljs-number">0</span>
./data/core-parser -p `pidof zygote64`

core-parser&gt; remote hook --inject -l /data/libopencore.so
<span class="hljs-symbol">arm64:</span> hook inject <span class="hljs-string">"/data/libopencore.so"</span>
<span class="hljs-symbol">arm64:</span> hook found <span class="hljs-string">"dlopen"</span> address: <span class="hljs-number">0</span>x733a131020
<span class="hljs-symbol">arm64:</span> target process current sp: <span class="hljs-number">0</span>x7ffe9f02a0
<span class="hljs-symbol">arm64:</span> <span class="hljs-keyword">call</span> dlopen(<span class="hljs-number">0</span>x7ffe9f0280 <span class="hljs-string">"/data/libopencore.so"</span>, <span class="hljs-number">0</span>x2)
<span class="hljs-symbol">arm64:</span> <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>xa4eeb80a85c4950f
</code></pre>
<h3 data-id="heading-4">修改 zygote64 内存</h3>
<p>我们可以对 close 函数进行改造，如果 fd = g_signal_pipe_fds[1]，则 segv 触发 core。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">core-parser&gt;</span> <span class="hljs-string">disas</span> <span class="hljs-string">_ZN14perfetto_hprof17g_signal_pipe_fdsE</span>
<span class="hljs-attr">LIB:</span> <span class="hljs-string">/apex/com.android.art/lib64/libperfetto_hprof.so</span>
<span class="hljs-attr">SYMBOL:</span> <span class="hljs-string">_ZN14perfetto_hprof17g_signal_pipe_fdsE</span>
  <span class="hljs-string">*</span> <span class="hljs-attr">perfetto_hprof::g_signal_pipe_fds:</span> <span class="hljs-number">0x706ed634b8</span>
  
<span class="hljs-string">core-parser&gt;</span> <span class="hljs-string">rd</span> <span class="hljs-number">0x706ed634b8</span>
<span class="hljs-attr">706ed634b8:</span> <span class="hljs-number">0000000000000000</span>  <span class="hljs-string">........</span>
<span class="hljs-string">core-parser&gt;</span>
</code></pre>
<p>新增汇编代码逻辑改造 close 函数汇编代码如下，写入 zygote64 内存中。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">mov</span> <span class="hljs-selector-tag">x2</span>, <span class="hljs-number">0</span><span class="hljs-selector-tag">x34b8</span>
<span class="hljs-selector-tag">movk</span> <span class="hljs-selector-tag">x2</span>, <span class="hljs-number">0</span><span class="hljs-selector-tag">x6ed6</span>, <span class="hljs-selector-tag">lsl</span> <span class="hljs-selector-id">#16</span>
<span class="hljs-selector-tag">movk</span> <span class="hljs-selector-tag">x2</span>, <span class="hljs-number">0</span><span class="hljs-selector-tag">x0070</span>, <span class="hljs-selector-tag">lsl</span> <span class="hljs-selector-id">#32</span>
<span class="hljs-selector-tag">ldr</span> <span class="hljs-selector-tag">w3</span>, <span class="hljs-selector-attr">[x2, #4]</span>
<span class="hljs-selector-tag">cmp</span> <span class="hljs-selector-tag">w0</span>, <span class="hljs-selector-tag">w3</span>
<span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.ne</span> <span class="hljs-number">0</span><span class="hljs-selector-tag">x8</span>
<span class="hljs-selector-tag">ldr</span> <span class="hljs-selector-tag">x1</span>, <span class="hljs-selector-attr">[x1]</span> <span class="hljs-comment">// segv dead</span>
</code></pre>

<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">core-parser&gt;</span> <span class="hljs-string">rd</span> <span class="hljs-string">7343fc6100</span> <span class="hljs-string">-e</span> <span class="hljs-string">7343fc6164</span> <span class="hljs-string">-i</span>
<span class="hljs-attr">0x7343fc6100:</span> <span class="hljs-string">a9be7bfd</span> <span class="hljs-string">|</span> <span class="hljs-string">stp</span> <span class="hljs-string">x29,</span> <span class="hljs-string">x30,</span> [<span class="hljs-string">sp</span>, <span class="hljs-comment">#-0x20]!</span>
<span class="hljs-attr">0x7343fc6104:</span> <span class="hljs-string">f9000bf3</span> <span class="hljs-string">|</span> <span class="hljs-string">str</span> <span class="hljs-string">x19</span>, [<span class="hljs-string">sp</span>, <span class="hljs-comment">#0x10]</span>
<span class="hljs-attr">0x7343fc6108:</span> <span class="hljs-string">910003fd</span> <span class="hljs-string">|</span> <span class="hljs-string">mov</span> <span class="hljs-string">x29</span>, <span class="hljs-string">sp</span>
<span class="hljs-attr">0x7343fc610c:</span> <span class="hljs-string">aa1f03e1</span> <span class="hljs-string">|</span> <span class="hljs-string">mov</span> <span class="hljs-string">x1</span>, <span class="hljs-string">xzr</span>
<span class="hljs-attr">0x7343fc6110:</span> <span class="hljs-string">d2869702</span> <span class="hljs-string">|</span> <span class="hljs-string">mov</span> <span class="hljs-string">x2</span>, <span class="hljs-comment">#0x34b8</span>
<span class="hljs-attr">0x7343fc6114:</span> <span class="hljs-string">f2addac2</span> <span class="hljs-string">|</span> <span class="hljs-string">movk</span> <span class="hljs-string">x2</span>, <span class="hljs-comment">#0x6ed6, lsl #16</span>
<span class="hljs-attr">0x7343fc6118:</span> <span class="hljs-string">f2c00e02</span> <span class="hljs-string">|</span> <span class="hljs-string">movk</span> <span class="hljs-string">x2</span>, <span class="hljs-comment">#0x70, lsl #32</span>
<span class="hljs-attr">0x7343fc611c:</span> <span class="hljs-string">b9400443</span> <span class="hljs-string">|</span> <span class="hljs-string">ldr</span> <span class="hljs-string">w3</span>, [<span class="hljs-string">x2</span>, <span class="hljs-comment">#4]</span>
<span class="hljs-attr">0x7343fc6120:</span> <span class="hljs-string">6b03001f</span> <span class="hljs-string">|</span> <span class="hljs-string">cmp</span> <span class="hljs-string">w0</span>, <span class="hljs-string">w3</span>
<span class="hljs-attr">0x7343fc6124:</span> <span class="hljs-number">54000041</span> <span class="hljs-string">|</span> <span class="hljs-string">b.ne</span> <span class="hljs-number">0x7343fc612c</span>
<span class="hljs-attr">0x7343fc6128:</span> <span class="hljs-string">f9400021</span> <span class="hljs-string">|</span> <span class="hljs-string">ldr</span> <span class="hljs-string">x1</span>, [<span class="hljs-string">x1</span>]
<span class="hljs-attr">0x7343fc612c:</span> <span class="hljs-string">97fffa35</span> <span class="hljs-string">|</span> <span class="hljs-string">bl</span> <span class="hljs-number">0x7343fc4a00</span>
<span class="hljs-attr">0x7343fc6130:</span> <span class="hljs-string">3100041f</span> <span class="hljs-string">|</span> <span class="hljs-string">cmn</span> <span class="hljs-string">w0</span>, <span class="hljs-comment">#1</span>
<span class="hljs-attr">0x7343fc6134:</span> <span class="hljs-number">54000121</span> <span class="hljs-string">|</span> <span class="hljs-string">b.ne</span> <span class="hljs-number">0x7343fc6158</span>
<span class="hljs-attr">0x7343fc6138:</span> <span class="hljs-string">2a0003f3</span> <span class="hljs-string">|</span> <span class="hljs-string">mov</span> <span class="hljs-string">w19</span>, <span class="hljs-string">w0</span>
<span class="hljs-attr">0x7343fc613c:</span> <span class="hljs-string">97fff7fd</span> <span class="hljs-string">|</span> <span class="hljs-string">bl</span> <span class="hljs-number">0x7343fc4130</span>
<span class="hljs-attr">0x7343fc6140:</span> <span class="hljs-string">aa0003e8</span> <span class="hljs-string">|</span> <span class="hljs-string">mov</span> <span class="hljs-string">x8</span>, <span class="hljs-string">x0</span>
<span class="hljs-attr">0x7343fc6144:</span> <span class="hljs-string">2a1303e0</span> <span class="hljs-string">|</span> <span class="hljs-string">mov</span> <span class="hljs-string">w0</span>, <span class="hljs-string">w19</span>
<span class="hljs-attr">0x7343fc6148:</span> <span class="hljs-string">b9400108</span> <span class="hljs-string">|</span> <span class="hljs-string">ldr</span> <span class="hljs-string">w8</span>, [<span class="hljs-string">x8</span>]
<span class="hljs-attr">0x7343fc614c:</span> <span class="hljs-string">7100111f</span> <span class="hljs-string">|</span> <span class="hljs-string">cmp</span> <span class="hljs-string">w8</span>, <span class="hljs-comment">#4</span>
<span class="hljs-attr">0x7343fc6150:</span> <span class="hljs-number">54000041</span> <span class="hljs-string">|</span> <span class="hljs-string">b.ne</span> <span class="hljs-number">0x7343fc6158</span>
<span class="hljs-attr">0x7343fc6154:</span> <span class="hljs-string">2a1f03e0</span> <span class="hljs-string">|</span> <span class="hljs-string">mov</span> <span class="hljs-string">w0</span>, <span class="hljs-string">wzr</span>
<span class="hljs-attr">0x7343fc6158:</span> <span class="hljs-string">f9400bf3</span> <span class="hljs-string">|</span> <span class="hljs-string">ldr</span> <span class="hljs-string">x19</span>, [<span class="hljs-string">sp</span>, <span class="hljs-comment">#0x10]</span>
<span class="hljs-attr">0x7343fc615c:</span> <span class="hljs-string">a8c27bfd</span> <span class="hljs-string">|</span> <span class="hljs-string">ldp</span> <span class="hljs-string">x29</span>, <span class="hljs-string">x30</span>, [<span class="hljs-string">sp</span>], <span class="hljs-comment">#0x20</span>
<span class="hljs-attr">0x7343fc6160:</span> <span class="hljs-string">d65f03c0</span> <span class="hljs-string">|</span> <span class="hljs-string">ret</span> 
<span class="hljs-string">...</span>
</code></pre>

<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">core-parser&gt;</span> <span class="hljs-string">disas</span> <span class="hljs-string">close</span>
<span class="hljs-attr">LIB:</span> <span class="hljs-string">/apex/com.android.runtime/lib64/bionic/libc.so</span>
<span class="hljs-attr">close:</span> [<span class="hljs-string">7343f4daf0</span>, <span class="hljs-string">7343f4db38</span>]
  <span class="hljs-attr">0x7343f4daf0:</span> <span class="hljs-number">1401e184</span> <span class="hljs-string">|</span> <span class="hljs-string">b</span> <span class="hljs-number">0x7343fc6100</span>
  <span class="hljs-attr">0x7343f4daf4:</span> <span class="hljs-string">f9000bf3</span> <span class="hljs-string">|</span> <span class="hljs-string">str</span> <span class="hljs-string">x19,</span> [<span class="hljs-string">sp</span>, <span class="hljs-comment">#0x10]</span>
  <span class="hljs-attr">0x7343f4daf8:</span> <span class="hljs-string">910003fd</span> <span class="hljs-string">|</span> <span class="hljs-string">mov</span> <span class="hljs-string">x29</span>, <span class="hljs-string">sp</span>
  <span class="hljs-attr">0x7343f4dafc:</span> <span class="hljs-string">aa1f03e1</span> <span class="hljs-string">|</span> <span class="hljs-string">mov</span> <span class="hljs-string">x1</span>, <span class="hljs-string">xzr</span>
  <span class="hljs-attr">0x7343f4db00:</span> <span class="hljs-string">9401dbc0</span> <span class="hljs-string">|</span> <span class="hljs-string">bl</span> <span class="hljs-number">0x7343fc4a00</span>
  <span class="hljs-attr">0x7343f4db04:</span> <span class="hljs-string">3100041f</span> <span class="hljs-string">|</span> <span class="hljs-string">cmn</span> <span class="hljs-string">w0</span>, <span class="hljs-comment">#1</span>
  <span class="hljs-attr">0x7343f4db08:</span> <span class="hljs-number">54000121</span> <span class="hljs-string">|</span> <span class="hljs-string">b.ne</span> <span class="hljs-number">0x7343f4db2c</span>
  <span class="hljs-attr">0x7343f4db0c:</span> <span class="hljs-string">2a0003f3</span> <span class="hljs-string">|</span> <span class="hljs-string">mov</span> <span class="hljs-string">w19</span>, <span class="hljs-string">w0</span>
  <span class="hljs-attr">0x7343f4db10:</span> <span class="hljs-string">9401d988</span> <span class="hljs-string">|</span> <span class="hljs-string">bl</span> <span class="hljs-number">0x7343fc4130</span>
  <span class="hljs-attr">0x7343f4db14:</span> <span class="hljs-string">aa0003e8</span> <span class="hljs-string">|</span> <span class="hljs-string">mov</span> <span class="hljs-string">x8</span>, <span class="hljs-string">x0</span>
  <span class="hljs-attr">0x7343f4db18:</span> <span class="hljs-string">2a1303e0</span> <span class="hljs-string">|</span> <span class="hljs-string">mov</span> <span class="hljs-string">w0</span>, <span class="hljs-string">w19</span>
  <span class="hljs-attr">0x7343f4db1c:</span> <span class="hljs-string">b9400108</span> <span class="hljs-string">|</span> <span class="hljs-string">ldr</span> <span class="hljs-string">w8</span>, [<span class="hljs-string">x8</span>]
  <span class="hljs-attr">0x7343f4db20:</span> <span class="hljs-string">7100111f</span> <span class="hljs-string">|</span> <span class="hljs-string">cmp</span> <span class="hljs-string">w8</span>, <span class="hljs-comment">#4</span>
  <span class="hljs-attr">0x7343f4db24:</span> <span class="hljs-number">54000041</span> <span class="hljs-string">|</span> <span class="hljs-string">b.ne</span> <span class="hljs-number">0x7343f4db2c</span>
  <span class="hljs-attr">0x7343f4db28:</span> <span class="hljs-string">2a1f03e0</span> <span class="hljs-string">|</span> <span class="hljs-string">mov</span> <span class="hljs-string">w0</span>, <span class="hljs-string">wzr</span>
  <span class="hljs-attr">0x7343f4db2c:</span> <span class="hljs-string">f9400bf3</span> <span class="hljs-string">|</span> <span class="hljs-string">ldr</span> <span class="hljs-string">x19</span>, [<span class="hljs-string">sp</span>, <span class="hljs-comment">#0x10]</span>
  <span class="hljs-attr">0x7343f4db30:</span> <span class="hljs-string">a8c27bfd</span> <span class="hljs-string">|</span> <span class="hljs-string">ldp</span> <span class="hljs-string">x29</span>, <span class="hljs-string">x30</span>, [<span class="hljs-string">sp</span>], <span class="hljs-comment">#0x20</span>
  <span class="hljs-attr">0x7343f4db34:</span> <span class="hljs-string">d65f03c0</span> <span class="hljs-string">|</span> <span class="hljs-string">ret</span>
</code></pre>
<p>修改 close 第一行机器码直接跳转到 0x7343fc6100 hook_close 位置。</p>
<h3 data-id="heading-5">启动应用程序</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta"># killall -9 usap64  <span class="hljs-comment">// 删掉 app 进程缓存</span></span>
</code></pre>

<pre><code class="hljs language-less" lang="less"><span class="hljs-number">01</span><span class="hljs-selector-tag">-28</span> <span class="hljs-number">18</span>:<span class="hljs-number">58</span>:<span class="hljs-number">15.649</span> <span class="hljs-number">13270</span> <span class="hljs-number">13270</span> <span class="hljs-selector-tag">I</span> <span class="hljs-selector-tag">opencore</span>: <span class="hljs-selector-tag">Init</span> <span class="hljs-selector-tag">inject</span> <span class="hljs-selector-tag">opencore-1</span><span class="hljs-selector-class">.4</span><span class="hljs-selector-class">.16</span> <span class="hljs-selector-tag">environment</span>..
<span class="hljs-number">01</span><span class="hljs-selector-tag">-28</span> <span class="hljs-number">19</span>:<span class="hljs-number">00</span>:<span class="hljs-number">24.215</span>  <span class="hljs-number">5895</span>  <span class="hljs-number">5895</span> <span class="hljs-selector-tag">I</span> <span class="hljs-selector-tag">opencore</span>: <span class="hljs-selector-tag">Wait</span> (<span class="hljs-number">5984</span>) <span class="hljs-selector-tag">coredump</span>
<span class="hljs-number">01</span><span class="hljs-selector-tag">-28</span> <span class="hljs-number">19</span>:<span class="hljs-number">00</span>:<span class="hljs-number">24.217</span>  <span class="hljs-number">5984</span>  <span class="hljs-number">5984</span> <span class="hljs-selector-tag">I</span> <span class="hljs-selector-tag">opencore</span>: <span class="hljs-selector-tag">Coredump</span> /<span class="hljs-selector-tag">sdcard</span>/<span class="hljs-selector-tag">Android</span>/<span class="hljs-selector-tag">data</span>/<span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.b</span><span class="hljs-selector-class">.c</span>/<span class="hljs-selector-tag">files</span>/<span class="hljs-selector-tag">core</span><span class="hljs-selector-class">.a</span><span class="hljs-selector-class">.b</span><span class="hljs-selector-class">.c_5895_1769598024</span> ...
<span class="hljs-number">01</span><span class="hljs-selector-tag">-28</span> <span class="hljs-number">19</span>:<span class="hljs-number">00</span>:<span class="hljs-number">29.501</span>  <span class="hljs-number">5984</span>  <span class="hljs-number">5984</span> <span class="hljs-selector-tag">I</span> <span class="hljs-selector-tag">opencore</span>: <span class="hljs-selector-tag">Finish</span> <span class="hljs-selector-tag">done</span>.
</code></pre>

<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">core-parser&gt;</span> <span class="hljs-string">bt</span>
<span class="hljs-string">"main"</span> <span class="hljs-string">sysTid=5895</span> <span class="hljs-string">Native</span>
  <span class="hljs-string">|</span> <span class="hljs-string">group="main"</span> <span class="hljs-string">daemon=0</span> <span class="hljs-string">prio=5</span> <span class="hljs-string">target=0x0</span> <span class="hljs-string">uncaught_exception=0x0</span>
  <span class="hljs-string">|</span> <span class="hljs-string">tid=1</span> <span class="hljs-string">sCount=0</span> <span class="hljs-string">flags=0</span> <span class="hljs-string">obj=0x728b83e0</span> <span class="hljs-string">self=0xb40000712140d7b0</span> <span class="hljs-string">env=0xb4000071b1414710</span>
  <span class="hljs-string">|</span> <span class="hljs-string">stack=0x7ffe1f5000-0x7ffe1f7000</span> <span class="hljs-string">stackSize=0x7ff000</span> <span class="hljs-string">handle=0x7357535118</span>
  <span class="hljs-string">|</span> <span class="hljs-string">mutexes=0xb40000712140df50</span> <span class="hljs-string">held=</span>
  <span class="hljs-string">x0</span>  <span class="hljs-number">0x000000000000005d</span>  <span class="hljs-string">x1</span>  <span class="hljs-number">0x0000000000000000</span>  <span class="hljs-string">x2</span>  <span class="hljs-number">0x000000706ed634b8</span>  <span class="hljs-string">x3</span>  <span class="hljs-number">0x000000000000005d</span>  
  <span class="hljs-string">x4</span>  <span class="hljs-number">0xffffffffffffffff</span>  <span class="hljs-string">x5</span>  <span class="hljs-number">0x0000007ffe9ed650</span>  <span class="hljs-string">x6</span>  <span class="hljs-number">0x0000000000000039</span>  <span class="hljs-string">x7</span>  <span class="hljs-number">0x7f7f7f7f7f7f7f7f</span>  
  <span class="hljs-string">x8</span>  <span class="hljs-number">0x0000007ffe9ed243</span>  <span class="hljs-string">x9</span>  <span class="hljs-number">0x0000000000000065</span>  <span class="hljs-string">x10</span> <span class="hljs-number">0x0000000000000033</span>  <span class="hljs-string">x11</span> <span class="hljs-number">0x0000000000000002</span>  
  <span class="hljs-string">x12</span> <span class="hljs-number">0x0000007ffe9ecd14</span>  <span class="hljs-string">x13</span> <span class="hljs-number">0xffffff80ffffffd8</span>  <span class="hljs-string">x14</span> <span class="hljs-number">0x0000000000000010</span>  <span class="hljs-string">x15</span> <span class="hljs-number">0x00000000ffffffa5</span>  
  <span class="hljs-string">x16</span> <span class="hljs-number">0x0000006ff4a2ea68</span>  <span class="hljs-string">x17</span> <span class="hljs-number">0x0000007343f4daf0</span>  <span class="hljs-string">x18</span> <span class="hljs-number">0x0000007356464000</span>  <span class="hljs-string">x19</span> <span class="hljs-number">0x0000006ff4a39930</span>  
  <span class="hljs-string">x20</span> <span class="hljs-number">0x0000006ff4a39000</span>  <span class="hljs-string">x21</span> <span class="hljs-number">0x000000706ed634b8</span>  <span class="hljs-string">x22</span> <span class="hljs-number">0x000000000000005d</span>  <span class="hljs-string">x23</span> <span class="hljs-number">0x0000000000000045</span>  
  <span class="hljs-string">x24</span> <span class="hljs-number">0x0000007ffe9ed240</span>  <span class="hljs-string">x25</span> <span class="hljs-number">0x0000006ff4a39000</span>  <span class="hljs-string">x26</span> <span class="hljs-number">0x0000006ff4a39000</span>  <span class="hljs-string">x27</span> <span class="hljs-number">0x0000006ff4a30000</span>  
  <span class="hljs-string">x28</span> <span class="hljs-number">0x0000006ff4a393e0</span>  <span class="hljs-string">fp</span>  <span class="hljs-number">0x0000007ffe9ed0d0</span>  
  <span class="hljs-string">lr</span>  <span class="hljs-number">0x0000006ff4967de4</span>  <span class="hljs-string">sp</span>  <span class="hljs-number">0x0000007ffe9ed0d0</span>  <span class="hljs-string">pc</span>  <span class="hljs-number">0x0000007343fc6128</span>  <span class="hljs-string">pst</span> <span class="hljs-number">0x0000000060001000</span>  
  <span class="hljs-attr">Native:</span> <span class="hljs-comment">#0  0000007343fc6128  /apex/com.android.runtime/lib64/bionic/libc.so+0xf2128</span>
  <span class="hljs-attr">Native:</span> <span class="hljs-comment">#1  0000006ff4967de0  </span>
  <span class="hljs-attr">Native:</span> <span class="hljs-comment">#2  0000006ff494e9bc  </span>
  <span class="hljs-attr">Native:</span> <span class="hljs-comment">#3  0000006ff49482d4  </span>
  <span class="hljs-attr">Native:</span> <span class="hljs-comment">#4  000000707d53966c  art::JavaVMExt::LoadNativeLibrary(_JNIEnv*, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt; const&amp;, _jobject*, _jclass*, std::__1::basic_string&lt;char, std::__1::char_traits&lt;char&gt;, std::__1::allocator&lt;char&gt; &gt;*)+0x4ec</span>
  <span class="hljs-attr">Native:</span> <span class="hljs-comment">#5  000000706b8ee480  JVM_NativeLoad+0x170</span>
  <span class="hljs-attr">Native:</span> <span class="hljs-comment">#6  00000000715d2078  art_jni_trampoline+0x98</span>
  <span class="hljs-attr">JavaKt:</span> <span class="hljs-comment">#00  0000000000000000  java.lang.Runtime.nativeLoad</span>
  <span class="hljs-attr">JavaKt:</span> <span class="hljs-comment">#01  000000707cb0c56c  java.lang.Runtime.loadLibrary0</span>
  <span class="hljs-attr">JavaKt:</span> <span class="hljs-comment">#02  000000707cb0c4f8  java.lang.Runtime.loadLibrary0</span>
  <span class="hljs-attr">JavaKt:</span> <span class="hljs-comment">#03  000000707cb17b90  java.lang.System.loadLibrary</span>
  <span class="hljs-attr">JavaKt:</span> <span class="hljs-comment">#04  0000006ff947cafc  com.AppGuard.AppGuard.XLVQB.load</span>
  <span class="hljs-attr">JavaKt:</span> <span class="hljs-comment">#05  0000006ff947b74e  com.AppGuard.AppGuard.NZMXG.instantiateClassLoader</span>
  <span class="hljs-attr">JavaKt:</span> <span class="hljs-comment">#06  000000707c1516c6  android.app.LoadedApk.createOrUpdateClassLoaderLocked</span>
  <span class="hljs-attr">JavaKt:</span> <span class="hljs-comment">#07  000000707c150378  android.app.LoadedApk.getResources</span>
  <span class="hljs-attr">JavaKt:</span> <span class="hljs-comment">#08  000000707c0e0b30  android.app.ContextImpl.createAppContext</span>
  <span class="hljs-attr">JavaKt:</span> <span class="hljs-comment">#09  000000707c0ae14e  android.app.ActivityThread.handleBindApplication</span>
  <span class="hljs-attr">JavaKt:</span> <span class="hljs-comment">#10  000000707c0aa8fc  android.app.ActivityThread.-$$Nest$mhandleBindApplication</span>
  <span class="hljs-attr">JavaKt:</span> <span class="hljs-comment">#11  000000707c0a5780  android.app.ActivityThread$H.handleMessage</span>
  <span class="hljs-attr">JavaKt:</span> <span class="hljs-comment">#12  000000707afaabae  android.os.Handler.dispatchMessage</span>
  <span class="hljs-attr">JavaKt:</span> <span class="hljs-comment">#13  000000707afd3ed2  android.os.Looper.loopOnce</span>
  <span class="hljs-attr">JavaKt:</span> <span class="hljs-comment">#14  000000707afd4800  android.os.Looper.loop</span>
  <span class="hljs-attr">JavaKt:</span> <span class="hljs-comment">#15  000000707c0b3072  android.app.ActivityThread.main</span>
  <span class="hljs-attr">JavaKt:</span> <span class="hljs-comment">#16  0000000000000000  java.lang.reflect.Method.invoke</span>
  <span class="hljs-attr">JavaKt:</span> <span class="hljs-comment">#17  0000007079f6bbfa  com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run</span>
  <span class="hljs-attr">JavaKt:</span> <span class="hljs-comment">#18  0000007079f70ae0  com.android.internal.os.ZygoteInit.main</span>
<span class="hljs-string">core-parser&gt;</span> 
</code></pre>

<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">core-parser&gt;</span> <span class="hljs-string">disas</span> <span class="hljs-string">_ZN14perfetto_hprof17g_signal_pipe_fdsE</span>
<span class="hljs-attr">LIB:</span> <span class="hljs-string">/apex/com.android.art/lib64/libperfetto_hprof.so</span>
<span class="hljs-attr">SYMBOL:</span> <span class="hljs-string">_ZN14perfetto_hprof17g_signal_pipe_fdsE</span>
  <span class="hljs-string">*</span> <span class="hljs-attr">perfetto_hprof::g_signal_pipe_fds:</span> <span class="hljs-number">0x706ed634b8</span>
  
<span class="hljs-string">core-parser&gt;</span> <span class="hljs-string">rd</span> <span class="hljs-number">0x706ed634b8</span>
<span class="hljs-attr">706ed634b8:</span> <span class="hljs-string">0000005d00000045</span>  <span class="hljs-string">E...]...</span>
<span class="hljs-string">core-parser&gt;</span>
</code></pre>

<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">core-parser&gt;</span> <span class="hljs-string">f</span> <span class="hljs-number">1</span>
  <span class="hljs-attr">JavaKt:</span> <span class="hljs-comment">#01  000000707cb0c56c  java.lang.Runtime.loadLibrary0(java.lang.ClassLoader, java.lang.Class, java.lang.String)</span>
  {
      <span class="hljs-attr">Location:</span> <span class="hljs-string">/apex/com.android.art/javalib/core-oj.jar</span>
      <span class="hljs-attr">art::ArtMethod:</span> <span class="hljs-number">0x6fc7bcf0</span>
      <span class="hljs-attr">dex_pc_ptr:</span> <span class="hljs-number">0x707cb0c56c</span>
      <span class="hljs-attr">quick_frame:</span> <span class="hljs-number">0x7ffe9ef810</span>
      <span class="hljs-attr">frame_pc:</span> <span class="hljs-number">0x71384bd8</span>
      <span class="hljs-attr">method_header:</span> <span class="hljs-number">0x71384a8c</span>

      <span class="hljs-attr">DEX CODE:</span>
      <span class="hljs-attr">0x707cb0c564:</span> <span class="hljs-string">020c</span>                     <span class="hljs-string">|</span> <span class="hljs-string">move-result-object</span> <span class="hljs-string">v2</span>
      <span class="hljs-attr">0x707cb0c566:</span> <span class="hljs-number">2107</span>                     <span class="hljs-string">|</span> <span class="hljs-string">move-object</span> <span class="hljs-string">v1</span>, <span class="hljs-string">v2</span>
      <span class="hljs-attr">0x707cb0c568:</span> <span class="hljs-number">0138 </span><span class="hljs-number">0010</span>                <span class="hljs-string">|</span> <span class="hljs-string">if-eqz</span> <span class="hljs-string">v1</span>, <span class="hljs-number">0x707cb0c588</span> <span class="hljs-string">//+16</span>
      <span class="hljs-attr">0x707cb0c56c:</span> <span class="hljs-number">3071 </span><span class="hljs-string">0dbb</span> <span class="hljs-number">0761</span>           <span class="hljs-string">|</span> <span class="hljs-string">invoke-static</span> {<span class="hljs-string">v1</span>, <span class="hljs-string">v6</span>, <span class="hljs-string">v7</span>}, <span class="hljs-string">java.lang.String</span> <span class="hljs-string">java.lang.Runtime.nativeLoad(java.lang.String</span>, <span class="hljs-string">java.lang.ClassLoader</span>, <span class="hljs-string">java.lang.Class)</span> <span class="hljs-string">//</span> <span class="hljs-string">method@3515</span>
      {
          <span class="hljs-string">v0</span> <span class="hljs-string">=</span> <span class="hljs-string">w24</span>    <span class="hljs-string">v1</span> <span class="hljs-string">=</span> <span class="hljs-string">w26</span>    <span class="hljs-string">v5</span> <span class="hljs-string">=</span> <span class="hljs-string">w25</span>    <span class="hljs-string">v6</span> <span class="hljs-string">=</span> <span class="hljs-string">w22</span>    
          <span class="hljs-string">v7</span> <span class="hljs-string">=</span> <span class="hljs-string">w23</span>    <span class="hljs-string">v8</span> <span class="hljs-string">=</span> <span class="hljs-string">w24</span>
      }

      <span class="hljs-attr">OAT CODE:</span>
      <span class="hljs-attr">0x71384bb4:</span> <span class="hljs-number">14000002</span> <span class="hljs-string">|</span> <span class="hljs-string">b</span> <span class="hljs-number">0x71384bbc</span>
      <span class="hljs-attr">0x71384bb8:</span> <span class="hljs-string">aa0003fa</span> <span class="hljs-string">|</span> <span class="hljs-string">mov</span> <span class="hljs-string">x26</span>, <span class="hljs-string">x0</span>
      <span class="hljs-attr">0x71384bbc:</span> <span class="hljs-string">340003da</span> <span class="hljs-string">|</span> <span class="hljs-string">cbz</span> <span class="hljs-string">w26</span>, <span class="hljs-number">0x71384c34</span>
      <span class="hljs-attr">0x71384bc0:</span> <span class="hljs-string">aa1603e2</span> <span class="hljs-string">|</span> <span class="hljs-string">mov</span> <span class="hljs-string">x2</span>, <span class="hljs-string">x22</span>
      <span class="hljs-attr">0x71384bc4:</span> <span class="hljs-string">aa1703e3</span> <span class="hljs-string">|</span> <span class="hljs-string">mov</span> <span class="hljs-string">x3</span>, <span class="hljs-string">x23</span>
      <span class="hljs-attr">0x71384bc8:</span> <span class="hljs-string">aa1a03e1</span> <span class="hljs-string">|</span> <span class="hljs-string">mov</span> <span class="hljs-string">x1</span>, <span class="hljs-string">x26</span>
      <span class="hljs-attr">0x71384bcc:</span> <span class="hljs-string">f0ff47a0</span> <span class="hljs-string">|</span> <span class="hljs-string">adrp</span> <span class="hljs-string">x0</span>, <span class="hljs-number">0x6fc7b000</span>
      <span class="hljs-attr">0x71384bd0:</span> <span class="hljs-string">9135c000</span> <span class="hljs-string">|</span> <span class="hljs-string">add</span> <span class="hljs-string">x0</span>, <span class="hljs-string">x0</span>, <span class="hljs-comment">#0xd70</span>
      <span class="hljs-attr">0x71384bd4:</span> <span class="hljs-string">f9400c1e</span> <span class="hljs-string">|</span> <span class="hljs-string">ldr</span> <span class="hljs-string">x30</span>, [<span class="hljs-string">x0</span>, <span class="hljs-comment">#0x18]</span>
      <span class="hljs-attr">0x71384bd8:</span> <span class="hljs-string">d63f03c0</span> <span class="hljs-string">|</span> <span class="hljs-string">blr</span> <span class="hljs-string">x30</span>
      <span class="hljs-attr">0x71384bdc:</span> <span class="hljs-string">350000c0</span> <span class="hljs-string">|</span> <span class="hljs-string">cbnz</span> <span class="hljs-string">w0</span>, <span class="hljs-number">0x71384bf4</span>
      <span class="hljs-attr">0x71384be0:</span> <span class="hljs-string">aa0003fb</span> <span class="hljs-string">|</span> <span class="hljs-string">mov</span> <span class="hljs-string">x27</span>, <span class="hljs-string">x0</span>
      {
          <span class="hljs-string">x19</span> <span class="hljs-string">=</span> <span class="hljs-number">0xb40000712140d7b0</span>    <span class="hljs-string">x20</span> <span class="hljs-string">=</span> <span class="hljs-number">0x0000000000000000</span>    <span class="hljs-string">x21</span> <span class="hljs-string">=</span> <span class="hljs-number">0xb40000712140d870</span>    <span class="hljs-string">x22</span> <span class="hljs-string">=</span> <span class="hljs-number">0x00000000023bcc70</span>    
          <span class="hljs-string">x23</span> <span class="hljs-string">=</span> <span class="hljs-number">0x00000000af2bdde0</span>    <span class="hljs-string">x24</span> <span class="hljs-string">=</span> <span class="hljs-number">0x00000000023bec58</span>    <span class="hljs-string">x25</span> <span class="hljs-string">=</span> <span class="hljs-number">0x000000006fa5cd10</span>    <span class="hljs-string">x26</span> <span class="hljs-string">=</span> <span class="hljs-number">0x00000000023bef70</span>    
          <span class="hljs-string">x27</span> <span class="hljs-string">=</span> <span class="hljs-number">0x0000000000000018</span>    <span class="hljs-string">x28</span> <span class="hljs-string">=</span> <span class="hljs-number">0x0000007ffe9ef990</span>    <span class="hljs-string">fp</span> <span class="hljs-string">=</span> <span class="hljs-number">0x0000007ffe9ef96c</span>    <span class="hljs-string">lr</span> <span class="hljs-string">=</span> <span class="hljs-number">0x0000000071384bdc</span>
      }
  }
</code></pre>

<pre><code class="hljs language-ini" lang="ini">core-parser&gt; p 0x00000000023bef70
Size: 0x70
Object Name: java.lang.String
    <span class="hljs-section">[0x10]</span> virutal char<span class="hljs-section">[]</span> <span class="hljs-attr">values</span> = <span class="hljs-string">"/data/app/~~gKv2P9XhKhqKOOzrwlg7NQ==/a.b.c-SUPK3pUVM0I0SmBiF2mlGg==/lib/arm64/libAppGuard.so"</span>
    <span class="hljs-section">[0x0c]</span> private int <span class="hljs-attr">hash</span> = <span class="hljs-number">0</span>
    <span class="hljs-section">[0x08]</span> private final int <span class="hljs-attr">count</span> = <span class="hljs-number">96</span>
  // extends java.lang.Object
    <span class="hljs-section">[0x04]</span> private transient int shadow$<span class="hljs-attr">_monitor_</span> = <span class="hljs-number">0</span>
    <span class="hljs-section">[0x00]</span> private transient java.lang.Class shadow$<span class="hljs-attr">_klass_</span> = <span class="hljs-number">0</span>x6faa0a80
core-parser&gt; 
</code></pre>

<pre><code class="hljs language-markdown" lang="markdown">core-parser&gt; vtor 0000006ff4967de0
<span class="hljs-bullet">  *</span> VIRTUAL: 0x6ff4967de0
<span class="hljs-bullet">  *</span> PHYSICAL: 0x9e501de0
<span class="hljs-bullet">  *</span> OFFSET: 0x34de0
<span class="hljs-bullet">  *</span> OR: 0x74bb701de0
<span class="hljs-bullet">  *</span> MMAP: 0x0
<span class="hljs-bullet">  *</span> OVERLAY: 0x0
[6ff4933000, 6ff4a24000)  rwx  00000f1000  00000f1000  [] [<span class="hljs-emphasis">*]
core-parser&gt;
</span></code></pre>
<p>可以看到在加载 <code>libAppGuard.so</code> 的过程中，在匿名代码段 <code>&lt;anonymous:6ff4933000&gt;</code> 中调用了 close 函数关闭了 g_signal_pipe_fds[1] 管道，于是 <code>perfetto_hprof_listener</code> 线程异常退出。</p>
<h3 data-id="heading-6">匿名代码段</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">core-parser&gt; </span><span class="bash">rd 6ff4933000 -e 6ff4a24000 -f /data/6ff4933000.bin</span>
Saved [/data/6ff4933000.bin].
<span class="hljs-meta prompt_">core-parser&gt;</span><span class="bash">
</span></code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23516e98c6824444aa2ae3c72f44ab2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUGVuZ3VpbkxldHNHbw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770365813&amp;x-signature=vJ6xPd3HWB9C4eFCAXetia0FPl8%3D" alt="img_v3_02ue_afa09a21-5451-45df-9335-dd3efd0864eg.jpg" loading="lazy"/></p>
<p>该代码片段和一年前的一模一样，埋下了这个隐患，直到 ART 代码更新，新增 GetNativeNiceness 函数后开始发生错误。</p>
<h2 data-id="heading-7">后记</h2>
<p><code>perfetto_hprof_listener</code> 线程的异常退出没有移除 <code>thread_list_</code> 列表属 ART 的 BUG，但是依赖 Google Mainline 的更新，周期一般都挺长的，应用端更新相对较快，期望更多开发者能尽快更新，转达不易，感谢相互告知！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Windows 下 VS Code 配置 MCP 服务避坑指南：解决spawn *** ENOENT 报错]]></title>    <link>https://juejin.cn/post/7600326291553255430</link>    <guid>https://juejin.cn/post/7600326291553255430</guid>    <pubDate>2026-01-29T02:48:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600326291553255430" data-draft-id="7600298554872512518" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Windows 下 VS Code 配置 MCP 服务避坑指南：解决spawn *** ENOENT 报错"/> <meta itemprop="keywords" content="MCP"/> <meta itemprop="datePublished" content="2026-01-29T02:48:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿虎儿"/> <meta itemprop="url" content="https://juejin.cn/user/3394908210857901"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Windows 下 VS Code 配置 MCP 服务避坑指南：解决spawn *** ENOENT 报错
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3394908210857901/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿虎儿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T02:48:13.000Z" title="Thu Jan 29 2026 02:48:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Windows 系统中配置 MCP 服务器的完整指南</h2>
<blockquote>
<p>解决 VSCode 启动 MCP 服务器时出现 <code>spawn xxx ENOENT</code> 错误的终极方案</p>
</blockquote>
<h3 data-id="heading-1">前言</h3>
<p>随着 AI 编程助手的发展，MCP（Model Context Protocol）服务器成为了扩展 AI 能力的重要方式。然而，许多 Windows 用户在 VSCode 中配置 MCP 服务器时，经常会遇到一个令人困惑的问题：</p>
<p><strong>命令行中可以正常运行的命令，在 VSCode 的 MCP 配置中却报错 <code>ENOENT</code>。</strong></p>
<p>本文将深入分析这个问题的原因，并提供多种解决方案。</p>
<hr/>
<h3 data-id="heading-2">问题现象</h3>
<h4 data-id="heading-3">典型场景</h4>
<p>使用 fnm、nvm-windows 等 Node.js 版本管理工具安装 Node.js 后，全局安装一个 MCP 服务包：</p>
<pre><code class="hljs language-bash" lang="bash">npm install -g chrome-devtools-mcp@latest
</code></pre>
<p>在 VSCode 的 MCP 配置文件中添加：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"chrome-devtools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"chrome-devtools-mcp"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"--autoConnect"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"--channel=beta"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-4">错误信息</h4>
<p>启动 MCP 服务器时，出现以下错误：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">连接状态: 错误 spawn chrome-devtools-mcp ENOENT</span>
</code></pre>
<h4 data-id="heading-5">矛盾点</h4>
<p>在命令行（CMD 或 PowerShell）中直接执行同样的命令，却能正常运行：</p>
<pre><code class="hljs language-bash" lang="bash">chrome-devtools-mcp --autoConnect --channel=beta
<span class="hljs-comment"># ✅ 正常启动</span>
</code></pre>
<hr/>
<h3 data-id="heading-6">问题根因分析</h3>
<h4 data-id="heading-7">ENOENT 的含义</h4>
<p><code>ENOENT</code> 是 Node.js 中的错误码，表示 <strong>"Error NO ENTry"</strong>，即找不到指定的文件或目录。</p>
<h4 data-id="heading-8">为什么命令行可以，VSCode 却不行？</h4>
<p>这涉及到 Windows 系统中 <strong>PATH 环境变量的加载机制</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">┌─────────────────────────────────────────────────────────────────┐
│                    环境变量加载流程对比                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  【命令行启动】                                                  │
│  ┌──────────┐    ┌──────────┐    ┌─────────────────────┐       │
│  │ 打开 CMD │───▶│ 加载配置 │───▶│ fnm/nvm 注入 PATH   │       │
│  └──────────┘    │ (profile)│    │ 包含 node/npm 路径  │       │
│                  └──────────┘    └─────────────────────┘       │
│                                            │                    │
│                                            ▼                    │
│                               ┌─────────────────────┐          │
│                               │ ✅ 可找到全局包命令  │          │
│                               └─────────────────────┘          │
│                                                                 │
│  【VSCode 启动 MCP】                                            │
│  ┌──────────┐    ┌──────────────────┐                          │
│  │  VSCode  │───▶│ 使用系统原始 PATH │                          │
│  │  进程    │    │ (无 fnm/nvm 注入) │                          │
│  └──────────┘    └──────────────────┘                          │
│                           │                                     │
│                           ▼                                     │
│                 ┌─────────────────────┐                        │
│                 │ ❌ 找不到全局包命令  │                        │
│                 └─────────────────────┘                        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>核心原因</strong>：</p>
<ol>
<li><strong>fnm/nvm 是动态注入 PATH 的</strong>：它们通过 shell 配置文件（如 <code>.bashrc</code>、PowerShell profile）在每次打开终端时动态设置 PATH</li>
<li><strong>VSCode 不加载这些配置</strong>：VSCode 启动子进程时，直接使用系统级 PATH，不会执行 shell 配置文件</li>
<li><strong>全局包路径不在系统 PATH 中</strong>：npm 全局包的可执行文件路径没有被 VSCode 识别</li>
</ol>
<hr/>
<h3 data-id="heading-9">解决方案</h3>
<h4 data-id="heading-10">方案一：使用完整路径（推荐 ⭐⭐⭐）</h4>
<p>这是最直接、最可靠的方案。</p>
<p><strong>步骤 1：查找可执行文件的完整路径</strong></p>
<pre><code class="hljs language-cmd" lang="cmd">where chrome-devtools-mcp
</code></pre>
<p>输出示例：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">C:\Users\YourName\AppData\Roaming\fnm\node-versions\v24.0.0\installation\chrome-devtools-mcp.cmd</span>
</code></pre>
<p><strong>步骤 2：修改 MCP 配置</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"chrome-devtools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"C:\\Users\\YourName\\AppData\\Roaming\\fnm\\node-versions\\v24.0.0\\installation\\chrome-devtools-mcp.cmd"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"--autoConnect"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"--channel=beta"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p>⚠️ <strong>注意</strong>：JSON 中的反斜杠需要转义，使用 <code>\\</code></p>
</blockquote>
<p><strong>优点</strong>：</p>
<ul>
<li>100% 可靠</li>
<li>不依赖任何环境变量</li>
<li>明确指定版本</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>路径较长</li>
<li>更换 Node.js 版本后需要更新路径</li>
</ul>
<hr/>
<h4 data-id="heading-11">方案二：通过 CMD 中转</h4>
<p>利用 <code>cmd /c</code> 让 Windows 的命令处理器来解析 PATH。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"chrome-devtools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cmd"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"/c"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"chrome-devtools-mcp"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"--autoConnect"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"--channel=beta"</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>工作原理</strong>：</p>
<pre><code class="hljs">VSCode ──▶ cmd.exe ──▶ 解析系统 PATH ──▶ 找到并执行命令
</code></pre>
<p><strong>适用场景</strong>：</p>
<ul>
<li>可执行文件路径已在系统级 PATH 中</li>
<li>不想写完整路径</li>
</ul>
<hr/>
<h4 data-id="heading-12">方案三：通过 PowerShell 中转</h4>
<p>与 CMD 类似，但使用 PowerShell：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"chrome-devtools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"powershell"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"-Command"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"chrome-devtools-mcp --autoConnect --channel=beta"</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>如果需要加载 PowerShell 配置文件（包含 fnm 初始化）：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"chrome-devtools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"powershell"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"-NoLogo"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"-NoExit"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"-Command"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">". $PROFILE; chrome-devtools-mcp --autoConnect --channel=beta"</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h4 data-id="heading-13">方案四：使用 npx 运行</h4>
<p>npx 可以自动查找并运行 npm 包：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"chrome-devtools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npx"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"chrome-devtools-mcp"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"--autoConnect"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"--channel=beta"</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>如果 npx 本身也找不到，使用完整路径：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"chrome-devtools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"C:\\Users\\YourName\\AppData\\Roaming\\fnm\\node-versions\\v24.0.0\\installation\\npx.cmd"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"chrome-devtools-mcp"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"--autoConnect"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"--channel=beta"</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h4 data-id="heading-14">方案五：在配置中指定环境变量</h4>
<p>MCP 配置支持 <code>env</code> 字段，可以手动注入 PATH：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"chrome-devtools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"chrome-devtools-mcp"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"--autoConnect"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"--channel=beta"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"PATH"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"C:\\Users\\YourName\\AppData\\Roaming\\fnm\\node-versions\\v24.0.0\\installation;${env:PATH}"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<blockquote>
<p>⚠️ <strong>注意</strong>：<code>${env:PATH}</code> 语法可能因 MCP 客户端实现而异，部分客户端可能不支持</p>
</blockquote>
<hr/>
<h4 data-id="heading-15">方案六：将 Node 路径添加到系统 PATH</h4>
<p>一劳永逸的方案，将 npm 全局包路径添加到系统环境变量。</p>
<p><strong>步骤 1：获取 npm 全局包路径</strong></p>
<pre><code class="hljs language-bash" lang="bash">npm config get prefix
</code></pre>
<p>输出示例：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">C:\Users\YourName\AppData\Roaming\fnm\node-versions\v24.0.0\installation</span>
</code></pre>
<p><strong>步骤 2：添加到系统 PATH</strong></p>
<ol>
<li>按 <code>Win + R</code>，输入 <code>sysdm.cpl</code>，回车</li>
<li>点击「高级」→「环境变量」</li>
<li>在「系统变量」中找到 <code>Path</code>，点击「编辑」</li>
<li>点击「新建」，粘贴上面获取的路径</li>
<li>确定保存，<strong>重启 VSCode</strong></li>
</ol>
<p><strong>优点</strong>：</p>
<ul>
<li>一次配置，永久生效</li>
<li>配置文件保持简洁</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>切换 Node 版本后需要更新系统 PATH</li>
<li>与版本管理工具的理念冲突</li>
</ul>
<hr/>
<h3 data-id="heading-16">方案对比</h3>






















































<table><thead><tr><th>方案</th><th>可靠性</th><th>配置复杂度</th><th>版本切换适应性</th><th>推荐场景</th></tr></thead><tbody><tr><td>完整路径</td><td>⭐⭐⭐⭐⭐</td><td>中</td><td>❌ 需更新</td><td>生产环境、固定版本</td></tr><tr><td>CMD 中转</td><td>⭐⭐⭐⭐</td><td>低</td><td>✅</td><td>快速配置</td></tr><tr><td>PowerShell 中转</td><td>⭐⭐⭐⭐</td><td>中</td><td>✅</td><td>需要 PS 特性</td></tr><tr><td>npx</td><td>⭐⭐⭐</td><td>低</td><td>✅</td><td>简单场景</td></tr><tr><td>指定 env</td><td>⭐⭐⭐</td><td>高</td><td>❌ 需更新</td><td>特殊需求</td></tr><tr><td>修改系统 PATH</td><td>⭐⭐⭐⭐</td><td>高</td><td>❌ 需更新</td><td>单一 Node 版本</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-17">常见问题排查</h3>
<h4 data-id="heading-18">Q1：如何确认是 PATH 问题？</h4>
<p>在 VSCode 终端中执行：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看 VSCode 终端的 PATH</span>
<span class="hljs-built_in">echo</span> %PATH%

<span class="hljs-comment"># 检查命令是否可用</span>
<span class="hljs-built_in">where</span> chrome-devtools-mcp
</code></pre>
<p>如果 <code>where</code> 命令显示「找不到」，则确认是 PATH 问题。</p>
<h4 data-id="heading-19">Q2：使用 nvm-windows 也有同样问题吗？</h4>
<p>是的。nvm-windows 同样通过动态切换 PATH 来管理 Node 版本。解决方案相同，只是路径不同：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">C:\Users\YourName\AppData\Roaming\nvm\v24.0.0\chrome-devtools-mcp.cmd</span>
</code></pre>
<h4 data-id="heading-20">Q3：配置修改后不生效？</h4>
<ol>
<li>确保配置文件语法正确（可用 JSON 校验工具检查）</li>
<li><strong>完全重启 VSCode</strong>（不是仅重新加载窗口）</li>
<li>检查配置文件位置是否正确</li>
</ol>
<h4 data-id="heading-21">Q4：如何找到 MCP 配置文件位置？</h4>
<p>不同的 MCP 客户端/扩展，配置文件位置可能不同：</p>
<ul>
<li><strong>Cline 扩展</strong>：VSCode 设置 → 扩展设置</li>
<li><strong>Claude Desktop</strong>：<code>%APPDATA%\Claude\claude_desktop_config.json</code></li>
<li><strong>其他扩展</strong>：查阅对应扩展文档</li>
</ul>
<hr/>
<h3 data-id="heading-22">最佳实践建议</h3>
<h4 data-id="heading-23">1. 开发环境：使用完整路径</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"my-mcp-server"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"C:\\full\\path\\to\\executable.cmd"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"--arg1"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"--arg2"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-24">2. 团队协作：使用项目本地安装 + npx</h4>
<p>将 MCP 服务器作为项目开发依赖：</p>
<pre><code class="hljs language-bash" lang="bash">npm install --save-dev chrome-devtools-mcp
</code></pre>
<p>配置使用 npx：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"chrome-devtools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npx"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"chrome-devtools-mcp"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"--autoConnect"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-25">3. 创建启动脚本</h4>
<p>在项目根目录创建 <code>start-mcp.cmd</code>：</p>
<pre><code class="hljs language-cmd" lang="cmd">@echo off
call C:\Users\YourName\AppData\Roaming\fnm\fnm.exe env --use-on-cd | call
call chrome-devtools-mcp %*
</code></pre>
<p>配置引用脚本：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"chrome-devtools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"${workspaceFolder}\\start-mcp.cmd"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"--autoConnect"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"--channel=beta"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-26">总结</h3>
<p>Windows 系统中 MCP 服务器的 <code>ENOENT</code> 错误，本质上是<strong>环境变量作用域问题</strong>。VSCode 启动子进程时不会加载 shell 配置文件，导致版本管理工具（fnm/nvm）注入的 PATH 无法被识别。</p>
<p><strong>解决核心思路</strong>：</p>
<ol>
<li>让 VSCode 能找到可执行文件（完整路径 / 修改系统 PATH）</li>
<li>或者通过 shell 中转来解析 PATH（cmd /c / powershell）</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从“人治”到“机治”：得物离线数仓发布流水线质量门禁实践]]></title>    <link>https://juejin.cn/post/7600341731047555107</link>    <guid>https://juejin.cn/post/7600341731047555107</guid>    <pubDate>2026-01-29T06:52:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600341731047555107" data-draft-id="7600491179499159606" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从“人治”到“机治”：得物离线数仓发布流水线质量门禁实践"/> <meta itemprop="keywords" content="大数据"/> <meta itemprop="datePublished" content="2026-01-29T06:52:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="得物技术"/> <meta itemprop="url" content="https://juejin.cn/user/2392954206960247"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从“人治”到“机治”：得物离线数仓发布流水线质量门禁实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2392954206960247/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    得物技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T06:52:20.000Z" title="Thu Jan 29 2026 06:52:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前言</h2>
<p>随着企业数字化转型加速推进，大数据业务规模呈现指数级增长，迭代变更越发频繁。此背景下，呈现"高频变更"与"超大规模"并存的特征，这种双重特性给大数据任务的发布变更带来了严峻挑战。</p>
<h2 data-id="heading-1">二、项目目标</h2>
<p><strong>离线数仓任务资产管理</strong></p>
<p>增量：通过大数据变更发布流水线进行卡点，确保末端任务发布前，消费场景&amp;风险等级完成绑定。增量任务发布消费场景绑定率100%覆盖。</p>
<p>存量：盘点存量资产任务，人工梳理打标，完成初始化消费场景绑定。</p>
<p><strong>大数据变更发布流水线</strong></p>
<p>数仓任务发布流水线管控100%覆盖，任务发布效率提升60%。</p>
<h2 data-id="heading-2">三、项目方案</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcbbcbdf03ae4c869a91b4799f8179fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=QZE13mEVp5cv6Tsx6rr6em2WzPM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h3 data-id="heading-3">数仓任务资产管理</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d6954c35f584787b99df00ed967578b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=0jv6VAoQYcAFbrplwcLprBM8Bww%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>消费场景定义</strong></p>
<p>根据业务用途梳理消费端内容，根据风险高低定义风险等级P0、P1、P2，从末节点自动倒推追溯上游全链路，并全部打上风险等级P0、P1、P2标识，以相同的生产规范标准要求上下游各方协同保障。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba6a1b928c3c4763afc4868e6ea87c0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=c%2BYgadRA44Mj3ohKsnzatoBevSU%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>风险等级定义</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5eb42fe993c14ff0a996420bd470633f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=FKQ%2B9CuEQsB9NkMs20RLfQY7mk4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>消费场景注册&amp;绑定</strong></p>
<ul>
<li><strong>消费场景注册</strong></li>
</ul>
<p>当前数仓任务消费场景已经完成初步盘点和梳理，并且将盘点的消费场景数据初始化到平台中。随着迭代场景的新增，需要注册新的场景，从而应业务所需。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a44db55d88a747288596b986ae51adad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=Z6di80hvl2Zqe4JZzlXp2jaaApc%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<ul>
<li><strong>存量资产任务绑定</strong></li>
</ul>
<p>针对当前数仓存量资产任务进行盘点，将adm、ads层表进行梳理、打标，最终初始化到平台中，完成存量资产绑定消费场景。</p>
<ul>
<li><strong>任务消费场景应用</strong></li>
</ul>
<p>任务和消费场景完成绑定后，从而决定任务的应用场景、风险等级，P0、P1任务将在变更管控、线上稳定性保障等得到重保。</p>
<h3 data-id="heading-4">数仓变更管控流水线</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd3ec25b6c174764bbefe31ef8f678c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=d%2BQ3NXjO3p3RJAzM6SFQySKci5g%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>质量定义(DQC)</strong></p>
<p>在离线数据仓库（数仓）中，数据质量检查（DQC，Data Quality Check）是确保数据准确性、一致性、完整性的重要环节。数仓ETL任务在加工完成后，会执行DQC检查，从而有效、及时发现数据质量问题，便于研发人员及时修复，避免问题数据对业务造成损失。</p>
<ul>
<li><strong>DQC强规则</strong></li>
</ul>
<p>当强规则执行不通过后，直接失败任务，及时通知任务Owner，并拦截下游任务执行，待修复后下游链路再继续执行。（拦截任务，需要值班人员及时修复。）</p>
<ul>
<li><strong>DQC弱规则</strong></li>
</ul>
<p>当弱规则执行不通过后，及时通知任务Owner。任务正常执行成功，下游任务也正在运行。（不拦截任务，会通知到任务Owner。）</p>
<p><strong>质量定义配置</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/974a23fb07ba43d98f01b66c0cecb206~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=puuYyBdSDog231%2B8%2BeWtjjVbbIY%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<ul>
<li><strong>通用型DQC规则</strong></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3512b3f1aab4648b9ba778cdfb4c63e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=1UkUpg7fLuZGXTSivlugXMYoAyM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d98c1542c8154560927cf261bd0ff6e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=uLhY%2F6i5BBrqr4FmeAmcBgUuaNw%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79a2fa1812f748bcbb90081b3a5a25ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=vWv8spTY%2F7flnSngyhgL3v8Ni0M%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>质量定义通过可视化界面操作，让用户可以直接通过简单的勾选方式，即可生成对应的DQC规则，大大提高研发人员配置DQC的效率。</p>
<ul>
<li><strong>自定义DQC规则</strong></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d810c6bbd9e14324826a623e71239657~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=gLG73ppalBoRWLZ8umEQIg9d3BM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>用户可以按照规则SQL补充规则逻辑，从而实现自定义验证SQL融入DQC-SQL中，达到自定义DQC规则的效果。</p>
<p><strong>强弱规则配置</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5962e1b7c45242d9bf90bfc4b3c2e965~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=XldHabsNTfOMJ6sPXO6znTkJFfw%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>DQC强规则和弱规则的配置方式完全一致，通过Tab的切换，可以完成强弱规则的配置。</p>
<p><strong>质量DQC试运行</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63209616aa5c4f23a6585636ea201e16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=VwH6bLAI7qETWL86u9mqJsg1hZY%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>所有DQC配置完成后，需要通过试运行之后才能保存上线，确保DQC配置的合理性、有效性。</p>
<p><strong>告警策略</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/924be0c0232847fb985fff63432c9d40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=u064XJgH0xNHpZMB15dZK2lysiA%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>支持飞书、电话、短信、邮箱等方式告警通知。其中强规则一旦触发，必定电话告警（采取15分钟无响应即逐级上升原则）。</p>
<p><strong>发布流水线管控</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce8d58bbb15b4e5aa6bd4d3963452cc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=qcRcaLfzKFjoU3s1IRryc12MpeE%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9feb9ce26724d57aa8ca88768e0a6a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=IK4SX69%2FGUyIHEnNW%2B5Q%2FTRsntk%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>静态扫描</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32ad381e710944d2b45b515c01af2f0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=zOpY7suZOCLsCUZgMzDyZZcX0TM%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b192059f63b44e3a4bfc774e33a628b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=%2B8iTU3GXC8epX8Vlh%2FPuIKmonmY%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>检测规则：任务依赖、建表规范、编码规范、集成规范、DQC规范等。</p>
<p><strong>冒烟测试</strong></p>
<p>在数仓测试环境下，完成任务冒烟测试执行，执行内容包含：ETL任务、DQC规则。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6eeb933954cb4c3e83e8255b003d02ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=8lcZK1qNQ1RISk1MXWUupsqFHPs%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>CodeReview</strong></p>
<p>描述：根据业务熟悉对，由数据域数仓PM 或者 业务数仓技术负责人进行评审，给出评审结论。</p>
<p>内容：ETL代码、调度配置、质量定义配置、DQC-SQL等。</p>
<p>注意：审批人飞书会接收到来自“xx稳定中心”机器人推送的消息，点击进入审批详情完成审批即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1ecd73992434cb79c77b75eab7164c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=7uX7O1vN6ZbbD7DDZttpIzF%2BAL4%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>数据探查</strong></p>
<p>描述：针对表内所有字段进行探查和校验，主要场景：数字探查、字符探查、主键验证、无效字段验证、异常字段验证</p>
<p>PS：数字探查和字符探查会给出明显问题红色高亮标识。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dd1305690b6d44dbb26c20f6057358f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=FrYlzF6QEGxUgVHxHaNfyPvgjGg%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79697b5c131b432bac3440ceb2ec194e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=8o6JPjaV8O9lg%2F0iPBIC5e1Oep0%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>数据比对</strong></p>
<p>描述：针对生产表和测试表进行数据比对，比对场景：数据量对比、聚合指标对比、明细对比。</p>
<p>注意信息：对比的两张表用户无法输入，用户需要输入执行分区、主键字段、去噪字段、风险阈值（针对明细对比生效）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fda58c471ee46108b5e520e644ecf4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=AwYFo9VTNy6Gw3%2BPoC%2F%2FxwV4Hy0%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><strong>发布审批</strong></p>
<p>描述：发布审批节点，用户输入本次发布的基础信息，提交审批即可。</p>
<p>所有需求都需要数据域PM和对应数据域的责任QA进行审批。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee84a4e7a23743dcbf98092ab8e909e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=iyZwVJ%2Fl3uvhqnWpTmGfNxQpEQw%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-5">四、总结&amp;未来规划</h2>
<h3 data-id="heading-6">实践总结</h3>
<p>得物离线数仓发布流水线过去1年有着从0到1的建设，以及后期从1到10的优化和改进。当前流水线能力已经足以支撑数仓内部日常迭代变更需求的发布管控，为发布准出规则执行提供了巨大帮助。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c5761a470744a7e8d0d9fe86f1c8815~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6X54mp5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770274403&amp;x-signature=mDN6ddVP0IZQze8m%2F1EMU3jFu%2Bg%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p>发布管控对于QA来说是最重要的一个环节，所有发布都能够达到准出标准的要求，从而才能守住发布的最后一道线。</p>
<h3 data-id="heading-7">未来规划</h3>
<p><strong>节点能力优化</strong></p>
<p>当前数仓表单分区大于3TB（十亿、百亿、千亿级别）存储数据后，数据探查、数据比对将不提供验证服务，主要源于数据量、存储过大、字段过多，对计算资源、计算存储带来巨大的消耗，严重影响其他任务的执行进度。后续通过数据抽样验证的方式从而降低资源的消耗，从而提升场景覆盖度。</p>
<p><strong>流水线能力补充</strong></p>
<p>数据探查未来考虑通过和历史探查结果比对参考的方式，给出诊断结果，进一步提升工具卡点能力。</p>
<h3 data-id="heading-8">往期回顾</h3>
<p>1.AI编程实践：从Claude Code实践到团队协作的优化思考｜得物技术</p>
<p>2.入选AAAI-PerFM｜得物社区推荐之基于大语言模型的新颖性推荐算法 </p>
<p>3.Galaxy比数平台功能介绍及实现原理｜得物技术</p>
<p>4.得物App智能巡检技术的探索与实践</p>
<p>5.深度实践：得物算法域全景可观测性从 0 到 1 的演进之路</p>
<h3 data-id="heading-9">文 /家森</h3>
<p>关注得物技术，每周更新技术干货</p>
<p>要是觉得文章对你有帮助的话，欢迎评论转发点赞～</p>
<p>未经得物技术许可严禁转载，否则依法追究法律责任。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端向架构突围系列 - 编译原理 [6 - 2]：Babel 插件开发与访问者模式]]></title>    <link>https://juejin.cn/post/7600581247019679753</link>    <guid>https://juejin.cn/post/7600581247019679753</guid>    <pubDate>2026-01-29T07:37:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600581247019679753" data-draft-id="7600489282838986762" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端向架构突围系列 - 编译原理 [6 - 2]：Babel 插件开发与访问者模式"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-29T07:37:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端王壮壮"/> <meta itemprop="url" content="https://juejin.cn/user/4473272506789485"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端向架构突围系列 - 编译原理 [6 - 2]：Babel 插件开发与访问者模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4473272506789485/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端王壮壮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T07:37:12.000Z" title="Thu Jan 29 2026 07:37:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p><strong>写在前面</strong></p>
<p>很多高级的前端库都在用 Babel 插件做“魔法”。</p>
<ul>
<li><strong>React:</strong> JSX 语法根本不是 JS，是 Babel 把它变成了 <code>React.createElement</code>。</li>
<li><strong>Vue:</strong> <code>v-model</code> 的语法糖，是在编译阶段展开的。</li>
<li><strong>babel-plugin-import:</strong> 为什么 Ant Design 可以按需加载？因为它悄悄把 <code>import { Button } from 'antd'</code> 改写成了引用具体文件的路径。</li>
</ul>
<p>学会写 Babel 插件，意味着你拥有了<strong>改写语言规则</strong>的能力。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce72ee99ca0b4093bef22a0b910de43f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv546L5aOu5aOu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770277039&amp;x-signature=tMfRBdJK%2BNTJmTOTVk6YpqixTE8%3D" alt="unnamed.jpg" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-0">一、 核心设计模式：访问者模式 (Visitor Pattern)</h2>
<p>AST 是一棵深度极深、结构复杂的树。如果让你手动写递归函数去遍历每一个节点，还得判断“这是不是函数”、“这是不是变量”，你会疯掉的。</p>
<p>Babel 采用 <strong>访问者模式</strong> 来解决这个问题。</p>
<h3 data-id="heading-1">1.1 什么是 Visitor？</h3>
<p>想象 AST 是一个巨大的<strong>迷宫</strong>。</p>
<ul>
<li><strong>Babel (Traverser):</strong> 是一个不知疲倦的导游，他负责走遍迷宫的每一个角落（深度优先遍历）。</li>
<li><strong>你 (Visitor):</strong> 是游客。你不需要自己走，你只需要在特定的“景点”等着。</li>
<li><strong>工作流：</strong> 导游走到一个节点（比如“函数声明节点”），就会大喊：“这里有个函数声明！”如果你对这个节点感兴趣，你就处理它；不感兴趣，导游就继续走。</li>
</ul>
<h3 data-id="heading-2">1.2 代码中的 Visitor</h3>
<p>在 Babel 插件中，Visitor 就是一个对象，对象的<strong>Key</strong> 是你感兴趣的 AST 节点类型。</p>
<pre><code class="hljs language-scss" lang="scss">const visitor = {
  <span class="hljs-comment">// 当遍历到 Identifier（标识符/变量名）节点时，执行这个函数</span>
  <span class="hljs-built_in">Identifier</span>(path) {
    console<span class="hljs-selector-class">.log</span>("我发现了一个变量:", path.node.name);
  },
  
  <span class="hljs-comment">// 当遍历到 BinaryExpression（二元表达式，如 a + b）节点时...</span>
  <span class="hljs-built_in">BinaryExpression</span>(path) {
    console<span class="hljs-selector-class">.log</span>("我发现了一个运算");
  }
};
</code></pre>
<hr/>
<h2 data-id="heading-3">二、 手术刀的核心：Path 与 Types</h2>
<p>在编写插件时，有两个最重要的概念：<code>path</code> 和 <code>@babel/types</code>。</p>
<h3 data-id="heading-4">2.1 Path：节点之间的桥梁</h3>
<p>注意，Visitor 函数接收的参数不是 <code>node</code>，而是 <code>path</code>。</p>
<ul>
<li>
<p><strong>Node (节点):</strong> 只是静态的数据（JSON 对象），比如 <code>{ type: "Identifier", name: "a" }</code>。它没有灵魂。</p>
</li>
<li>
<p><strong>Path (路径):</strong> 是一个<strong>响应式对象</strong>。它不仅包含当前节点的信息，还包含<strong>父节点</strong>、<strong>作用域</strong>以及<strong>增删改查的方法</strong>。</p>
<ul>
<li><code>path.node</code>: 获取当前节点数据。</li>
<li><code>path.parent</code>: 获取父节点。</li>
<li><code>path.remove()</code>: 自杀（把自己从树中移除）。</li>
<li><code>path.replaceWith(newNode)</code>: 变身（把自己替换成新节点）。</li>
<li><code>path.stop()</code>: 告诉导游（Babel），停止遍历，不要往下走了。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-5">2.2 @babel/types：节点的生成器与验证器</h3>
<p>如果你想把 <code>a</code> 替换成 <code>b</code>，你不能直接写 <code>path.node.name = 'b'</code>（虽然有时候也能跑，但不规范）。你需要创建一个标准的 AST 节点。 <code>@babel/types</code> (通常简写为 <code>t</code>) 就是干这个的。</p>
<ul>
<li><code>t.isIdentifier(node)</code>: 判断是不是标识符。</li>
<li><code>t.stringLiteral("hello")</code>: 创建一个字符串字面量节点。</li>
</ul>
<hr/>
<h2 data-id="heading-6">三、 实战演练：编写一个“去除 console.log”的插件</h2>
<p>这是 Babel 插件开发的 "Hello World"。 <strong>需求：</strong> 生产环境构建时，自动删除代码里所有的 <code>console.log</code>，但保留 <code>console.error</code>。</p>
<h3 data-id="heading-7">3.1 第一步：在 AST Explorer 中观察</h3>
<p>输入源码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'hello'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'oops'</span>);
</code></pre>
<p>观察 AST 结构，发现 <code>console.log('hello')</code> 是一个 <strong>CallExpression</strong> (调用表达式)。</p>
<ul>
<li>
<p><code>callee</code> 是一个 <strong>MemberExpression</strong> (成员表达式 <code>console.log</code>)。</p>
<ul>
<li><code>object</code>: <code>console</code> (Identifier)</li>
<li><code>property</code>: <code>log</code> (Identifier)</li>
</ul>
</li>
</ul>
<h3 data-id="heading-8">3.2 第二步：编写插件代码</h3>
<p>一个 Babel 插件就是一个函数，返回一个包含 <code>visitor</code> 的对象。</p>
<pre><code class="hljs language-lua" lang="lua">// my-babel-plugin.js
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">({ types: t })</span></span> {
  <span class="hljs-keyword">return</span> {
    name: <span class="hljs-string">"remove-console-log"</span>,
    visitor: {
      // 监听 CallExpression 节点
      CallExpression(<span class="hljs-built_in">path</span>) {
        // <span class="hljs-number">1.</span> 获取 callee (被调用的函数，比如 console.<span class="hljs-built_in">log</span>)
        const { callee } = <span class="hljs-built_in">path</span>.node;

        // <span class="hljs-number">2.</span> 判断是否是成员表达式 (MemberExpression)，且不是计算属性 (a[<span class="hljs-string">'b'</span>])
        <span class="hljs-keyword">if</span> (t.isMemberExpression(callee) &amp;&amp; !callee.computed) {
          
          // <span class="hljs-number">3.</span> 检查 object 是不是 <span class="hljs-string">'console'</span>，property 是不是 <span class="hljs-string">'log'</span>
          <span class="hljs-keyword">if</span> (t.isIdentifier(callee.object, { name: <span class="hljs-string">'console'</span> }) &amp;&amp;
              t.isIdentifier(callee.property, { name: <span class="hljs-string">'log'</span> })) {
            
            // <span class="hljs-number">4.</span> 这里的 <span class="hljs-built_in">path</span> 就是 console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'...'</span>) 这一整行
            // 直接由手术刀切除！
            <span class="hljs-built_in">path</span>.<span class="hljs-built_in">remove</span>();
          }
        }
      }
    }
  };
};
</code></pre>
<h3 data-id="heading-9">3.3 第三步：测试效果</h3>
<p><strong>输入：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'debug:'</span>, a);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'fatal error'</span>);
  <span class="hljs-keyword">return</span> a + b;
}
</code></pre>
<p><strong>输出：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a, b</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'fatal error'</span>);
  <span class="hljs-keyword">return</span> a + b;
}
</code></pre>
<p><em>Bingo！</em> 你刚刚成功完成了一次代码外科手术。</p>
<hr/>
<h2 data-id="heading-10">四、 进阶：作用域 (Scope) 的魔咒</h2>
<p>架构师和普通开发者的区别在于对<strong>副作用</strong>的考虑。 上面的插件有个 Bug：如果用户自己定义了一个叫 <code>console</code> 的变量怎么办？</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> <span class="hljs-variable language_">console</span> = { <span class="hljs-attr">log</span>: <span class="hljs-function">() =&gt;</span> {} };
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这不应该被删除'</span>); <span class="hljs-comment">// 我们的插件会错误地删除这一行！</span>
}
</code></pre>
<h3 data-id="heading-11">4.1 作用域检查</h3>
<p>Babel 的 <code>path.scope</code> 提供了强大的作用域分析能力。 我们需要检查：<code>console</code> 这个引用，是否<strong>绑定(Binding)</strong> 到了全局？还是被局部变量覆盖了？</p>
<p><strong>优化后的代码：</strong></p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">CallExpression</span>(path) {
  <span class="hljs-selector-tag">const</span> { <span class="hljs-selector-tag">callee</span> } = <span class="hljs-selector-tag">path</span><span class="hljs-selector-class">.node</span>;
  <span class="hljs-selector-tag">if</span> (t.<span class="hljs-built_in">isMemberExpression</span>(callee) &amp;&amp; 
      t.<span class="hljs-built_in">isIdentifier</span>(callee.object, { <span class="hljs-attribute">name</span>: <span class="hljs-string">'console'</span> }) &amp;&amp;
      t.<span class="hljs-built_in">isIdentifier</span>(callee.property, { <span class="hljs-attribute">name</span>: <span class="hljs-string">'log'</span> })) {

    <span class="hljs-comment">// 【新增】核心检查：获取 'console' 这个标识符的绑定信息</span>
    <span class="hljs-selector-tag">const</span> <span class="hljs-selector-tag">binding</span> = <span class="hljs-selector-tag">path</span><span class="hljs-selector-class">.scope</span><span class="hljs-selector-class">.getBinding</span>(<span class="hljs-string">'console'</span>);
    
    <span class="hljs-comment">// 如果没有绑定（说明是全局变量），才删除</span>
    <span class="hljs-selector-tag">if</span> (!binding) {
      <span class="hljs-selector-tag">path</span><span class="hljs-selector-class">.remove</span>();
    }
  }
}
</code></pre>
<p>现在，Babel 能够识别出局部变量 <code>console</code>，从而放过它。</p>
<hr/>
<h2 data-id="heading-12">五、 总结与脑洞：Babel 还能干什么？</h2>
<p>通过这个简单的例子，你掌握了 Babel 插件的精髓：<strong>Find (Visitor) -&gt; Check (Path/Types) -&gt; Modify (Remove/Replace)</strong> 。</p>
<p>在架构设计中，Babel 插件有无限的潜力：</p>
<ol>
<li><strong>自动埋点：</strong> 找到所有的 Click 事件函数，在函数体第一行自动插入 <code>track('click')</code> 代码。</li>
<li><strong>国际化 (i18n) 提取：</strong> 扫描所有中文字符串，自动提取到 JSON 文件中，并替换为 <code>t('key')</code>。</li>
<li><strong>代码卫士：</strong> 禁止使用某些落后的 API，一旦发现直接构建报错（比 ESLint 更暴力）。</li>
</ol>
<hr/>
<h2 data-id="heading-13">结语：从手术刀到守门员</h2>
<p>我们现在已经拥有了修改代码的手术刀（Babel Plugin）。 但是，手术刀太锋利了，容易伤人。在日常开发中，我们更多时候不需要“修改”代码，而是需要“检查”代码，或者进行大规模的、安全的“自动化重构”。</p>
<p>这时候，我们需要另一套基于 AST 的工具体系。</p>
<blockquote>
<p><strong>Next Step:</strong> 既然我们能分析代码结构，那是不是可以制定一套“代码法律”？ 下一节，我们将探讨**《第三篇：工具——代码质量的守门员：ESLint 原理、自定义规则与 Codemod 自动化重构》**。我们将学习如何编写自定义的 ESLint 规则，以及如何用 Codemod 瞬间修改 1000 个文件。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么 InnoDB 中的反向索引扫描更慢？]]></title>    <link>https://juejin.cn/post/7600260767687622682</link>    <guid>https://juejin.cn/post/7600260767687622682</guid>    <pubDate>2026-01-29T02:13:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600260767687622682" data-draft-id="7600303087874998310" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么 InnoDB 中的反向索引扫描更慢？"/> <meta itemprop="keywords" content="数据库,MySQL"/> <meta itemprop="datePublished" content="2026-01-29T02:13:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱可生开源社区"/> <meta itemprop="url" content="https://juejin.cn/user/1480387593251847"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么 InnoDB 中的反向索引扫描更慢？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1480387593251847/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱可生开源社区
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T02:13:05.000Z" title="Thu Jan 29 2026 02:13:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>作者：马金友， 一名给 MySQL 找 bug 的初级 DBA。</p>
<p>爱可生开源社区出品，原创内容未经授权不得随意使用，转载请联系小编并注明来源。</p>
<p>本文约 1500 字，预计阅读需要 5 分钟。</p>
</blockquote>
<p>如果你注意到在 MySQL 中 <code>ORDER BY DESC</code> 查询比 <code>ORDER BY ASC</code> 稍微慢一些，不用担心 —— 这是已知且符合预期的行为。</p>
<p>这是因为 <strong>InnoDB 的设计和优化是为了进行正向扫描</strong>，它使用单向链表结构来组织页面上的记录。</p>
<p>因此，向前移动（<code>ASC</code>）的时间复杂度是 <code>O(1)</code>，而向后移动（<code>DESC</code>）的时间复杂度是 <code>O(n)</code>。</p>
<p>这篇博客将从存储层面的角度演示这两种算法。</p>
<h2 data-id="heading-0">1. InnoDB 页面结构</h2>
<h3 data-id="heading-1">1.1 单向链表</h3>
<p>InnoDB 使用单向链表来组织record。 每个页面有两个虚拟record：<code>infimum</code> 和 <code>supremum</code>，它们分别作为链表的<code>头部</code>和<code>尾部</code>。
一旦数据页面包含用户记录，链表就会按逻辑顺序显示。</p>
<pre><code class="hljs language-rust" lang="rust">infimum <span class="hljs-punctuation">-&gt;</span> rec1 <span class="hljs-punctuation">-&gt;</span> rec2 <span class="hljs-punctuation">-&gt;</span> rec3 <span class="hljs-punctuation">-&gt;</span> rec4 <span class="hljs-punctuation">-&gt;</span> ... <span class="hljs-punctuation">-&gt;</span> supremum
</code></pre>
<h3 data-id="heading-2">1.2 REC_NEXT</h3>
<p>每条记录在记录头中额外占用 <code>2</code> 个字节(byte)来存储指向下一条记录的偏移量。</p>
<pre><code class="hljs language-ini" lang="ini">constexpr uint32_t <span class="hljs-attr">REC_NEXT</span> = <span class="hljs-number">2</span><span class="hljs-comment">;</span>
constexpr uint32_t <span class="hljs-attr">REC_NEXT_MASK</span> = <span class="hljs-number">0</span>xFFFFUL<span class="hljs-comment">;</span>
</code></pre>
<p>例如，<code>infimum</code> 记录的 <code>REC_NEXT</code> 值是 <code>0x00, 0x0d</code>。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/** The page infimum and supremum of an empty page in ROW_FORMAT=COMPACT */</span>
<span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-type">byte</span> infimum_supremum_compact[] = {
    <span class="hljs-comment">/* the infimum record */</span>
    <span class="hljs-number">0x01</span> <span class="hljs-comment">/*n_owned=1*/</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x02</span> <span class="hljs-comment">/* heap_no=0, REC_STATUS_INFIMUM */</span>, <span class="hljs-number">0x00</span>,
    <span class="hljs-number">0x0d</span> <span class="hljs-comment">/* pointer to supremum */</span>, <span class="hljs-string">'i'</span>, <span class="hljs-string">'n'</span>, <span class="hljs-string">'f'</span>, <span class="hljs-string">'i'</span>, <span class="hljs-string">'m'</span>, <span class="hljs-string">'u'</span>, <span class="hljs-string">'m'</span>, <span class="hljs-number">0</span>,
    <span class="hljs-comment">/* the supremum record */</span>
    <span class="hljs-number">0x01</span> <span class="hljs-comment">/*n_owned=1*/</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x0b</span> <span class="hljs-comment">/* heap_no=1, REC_STATUS_SUPREMUM */</span>, <span class="hljs-number">0x00</span>,
    <span class="hljs-number">0x00</span> <span class="hljs-comment">/* end of record list */</span>, <span class="hljs-string">'s'</span>, <span class="hljs-string">'u'</span>, <span class="hljs-string">'p'</span>, <span class="hljs-string">'r'</span>, <span class="hljs-string">'e'</span>, <span class="hljs-string">'m'</span>, <span class="hljs-string">'u'</span>, <span class="hljs-string">'m'</span>};
</code></pre>
<p>通过 <code>infimum</code> 记录偏移 <code>0x000d</code>，可以得到 <code>supremum</code> 记录。</p>
<pre><code class="hljs language-ini" lang="ini">In <span class="hljs-section">[1]</span>: <span class="hljs-attr">infimum_supremum_compact</span> = [
   ...:     <span class="hljs-number">0</span>x01 , <span class="hljs-number">0</span>x00, <span class="hljs-number">0</span>x02 , <span class="hljs-number">0</span>x00,
   ...:     <span class="hljs-number">0</span>x0d , <span class="hljs-string">'i'</span>, <span class="hljs-string">'n'</span>, <span class="hljs-string">'f'</span>, <span class="hljs-string">'i'</span>, <span class="hljs-string">'m'</span>, <span class="hljs-string">'u'</span>, <span class="hljs-string">'m'</span>, <span class="hljs-number">0</span>,
   ...:     <span class="hljs-number">0</span>x01 , <span class="hljs-number">0</span>x00, <span class="hljs-number">0</span>x0b, <span class="hljs-number">0</span>x00,
   ...:     <span class="hljs-number">0</span>x00, <span class="hljs-string">'s'</span>, <span class="hljs-string">'u'</span>, <span class="hljs-string">'p'</span>, <span class="hljs-string">'r'</span>, <span class="hljs-string">'e'</span>, <span class="hljs-string">'m'</span>, <span class="hljs-string">'u'</span>, <span class="hljs-string">'m'</span>
   ...: ]
   ...:

In <span class="hljs-section">[2]</span>: infimum_supremum_compact<span class="hljs-section">[5]</span>
Out<span class="hljs-section">[2]</span>: 'i'

In <span class="hljs-section">[3]</span>: infimum_supremum_compact<span class="hljs-section">[5+0x000d]</span>
Out<span class="hljs-section">[3]</span>: 's'
</code></pre>
<h3 data-id="heading-3">1.3 页面目录 (Page Directory)</h3>
<p>由于单向链表的数据结构，InnoDB 必须扫描整个链表才能找到一条 record，这效率很低。</p>
<p>InnoDB 在每个数据页的末尾维护一个动态数组（page directory），数组中的每个元素（槽/slot）存储一条record的位置。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/* We define a slot in the page directory as two bytes */</span>
<span class="hljs-keyword">constexpr</span> <span class="hljs-type">uint32_t</span> PAGE_DIR_SLOT_SIZE = <span class="hljs-number">2</span>;
</code></pre>
<p>它不是存储每条记录的地址，而是每个槽指向该槽所管理记录中的最后一条记录。一个槽通常管理 4 到 8 条记录。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/* The maximum and minimum number of records owned by a directory slot. The
number may drop below the minimum in the first and the last slot in the
directory. */</span>
<span class="hljs-keyword">constexpr</span> <span class="hljs-type">uint32_t</span> PAGE_DIR_SLOT_MAX_N_OWNED = <span class="hljs-number">8</span>;
<span class="hljs-keyword">constexpr</span> <span class="hljs-type">uint32_t</span> PAGE_DIR_SLOT_MIN_N_OWNED = <span class="hljs-number">4</span>;
</code></pre>
<p>第一个槽总是指向 <code>infimum</code>，最后一个槽总是指向 <code>supremum</code>。</p>
<h3 data-id="heading-4">1.4 N_OWNED</h3>
<p>每条记录在记录头中占用 4 个位（bit）来存储 <code>N_OWNED</code>。</p>
<pre><code class="hljs language-ini" lang="ini">constexpr uint32_t <span class="hljs-attr">REC_NEW_N_OWNED</span> = <span class="hljs-number">5</span><span class="hljs-comment">; /* This is single byte bit-field */</span>
constexpr uint32_t <span class="hljs-attr">REC_N_OWNED_MASK</span> = <span class="hljs-number">0</span>xFUL<span class="hljs-comment">;</span>
</code></pre>
<p>如果记录是槽中的最后一条记录，它的值就是该槽拥有的记录数。否则，值为 <code>0</code>。</p>
<h2 data-id="heading-5">2. 示例</h2>
<p>下图展示了数据页面的布局</p>
<p><img src="http://openwrite.cn/uploads/16955/59082/58dd74c4-d31d-409e-bf02-ea61f3f3b475.jpg" alt="微信图片_20260120101037_46_176.jpg" loading="lazy"/></p>
<ul>
<li>橙色箭头连接了从 <code>rec0</code> 到 <code>rec23</code> 的 24 条用户记录。</li>
<li>灰色箭头指向槽所管理的最后一条记录。
槽 <code>0</code> 指向 <code>infimum</code>，它包含 1 条记录。
槽 <code>n</code> 指向 <code>supremum</code>，它包含 5 条记录。
槽 <code>1</code> 指向 <code>rec3</code>，它包含 4 条记录。</li>
</ul>
<h2 data-id="heading-6">3. 算法</h2>
<p>我们将使用以下逻辑 InnoDB 页面布局来理解这两种扫描算法。</p>
<p><img src="http://openwrite.cn/uploads/16955/59082/929d9aa6-51d4-49b9-ba57-20605ac39206.jpg" alt="微信图片_20260120101032_45_176.jpg" loading="lazy"/></p>
<h3 data-id="heading-7">3.1 正向扫描 (Forward Scan)</h3>
<p>从 <code>rec10</code> 找到页面上的下一条记录很容易。</p>
<ol>
<li>读取 <code>REC_NEXT</code> 偏移量</li>
</ol>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">field_value</span> = mach_read_from_2(rec - REC_NEXT)<span class="hljs-comment">;</span>
</code></pre>
<ol start="2">
<li>获取下一条记录的位置</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">return</span> (ut_align_offset(rec + field_value, UNIV_PAGE_SIZE));
</code></pre>
<h3 data-id="heading-8">3.2 反向扫描 (Backward Scan)</h3>
<p>从<code>rec10</code>找到页面上的前一条记录会更困难。</p>
<h4 data-id="heading-9">3.2.1 查找哪个槽管理了当前记录 (page_dir_find_owner_slot)</h4>
<p>① 扫描从当前记录开始的所有记录，直到 <code>n_owned</code> 不为 <code>0</code>。</p>
<pre><code class="hljs language-ini" lang="ini">while (rec_get_n_owned_new(r) == 0) {
      <span class="hljs-attr">r</span> = rec_get_next_ptr_const(r, <span class="hljs-literal">true</span>)<span class="hljs-comment">;</span>
      ...
    }
</code></pre>
<p>它会检查 rec10，然后是 rec11。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[rec10]</span> --&gt; <span class="hljs-selector-attr">[rec11]</span>
  ^

  
<span class="hljs-selector-attr">[rec10]</span> --&gt; <span class="hljs-selector-attr">[rec11]</span>
              ^
</code></pre>
<p>因为 rec11 的 n_owned 是 4，所以会跳转到步骤 1.2。</p>
<p>② 检查所有槽，直到找到指向步骤 1.1 中记录 r 的槽。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">rec_offs_bytes</span> = mach_encode_2(r - page)<span class="hljs-comment">;</span>

  while (UNIV_LIKELY(*(uint16 *)slot != rec_offs_bytes)) {
  ....
    slot += PAGE_DIR_SLOT_SIZE<span class="hljs-comment">;</span>
  }
  
  return (((ulint)(first_slot - slot)) / PAGE_DIR_SLOT_SIZE)<span class="hljs-comment">;</span>
</code></pre>
<p>它会从最后一个槽（slot n）开始扫描到 slot 0。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[n]</span>...<span class="hljs-selector-attr">[4]</span><span class="hljs-selector-attr">[3]</span><span class="hljs-selector-attr">[2]</span><span class="hljs-selector-attr">[1]</span><span class="hljs-selector-attr">[0]</span>
 ^
</code></pre>
<p>因为 slot n 指向 supremum（不是 rec11），所以会检查下一个槽（slot 4）。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[n]</span>...<span class="hljs-selector-attr">[4]</span><span class="hljs-selector-attr">[3]</span><span class="hljs-selector-attr">[2]</span><span class="hljs-selector-attr">[1]</span><span class="hljs-selector-attr">[0]</span>
       ^
</code></pre>
<p>因为 slot 4 指向 rec15（不是 rec11），所以会检查下一个槽（slot 3）。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[n]</span>...<span class="hljs-selector-attr">[4]</span><span class="hljs-selector-attr">[3]</span><span class="hljs-selector-attr">[2]</span><span class="hljs-selector-attr">[1]</span><span class="hljs-selector-attr">[0]</span>
          ^
</code></pre>
<p>因为 slot 3 指向 rec11，所以会返回 3。</p>
<h4 data-id="heading-10">3.2.2 扫描当前slot group 以查找前一条记录</h4>
<p>① 跳转到前一个槽。 因为 slot 3 只持有slot group的最后一条记录，它无法扫描 slot 3 中的所有记录。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">slot</span> = page_dir_get_nth_slot(page, slot_<span class="hljs-literal">no</span> - <span class="hljs-number">1</span>)<span class="hljs-comment">;</span>

  <span class="hljs-attr">rec2</span> = page_dir_slot_get_rec(slt)<span class="hljs-comment">;</span>
</code></pre>
<p>幸运的是，它可以利用<code>前</code>一个槽组的最后一条记录来扫描当前槽组中的所有record。</p>
<p>通过检查 slot 2，它会找到 rec7。</p>
<p>② 扫描槽组中的所有记录所有 record 匹配当前 record。</p>
<pre><code class="hljs language-ini" lang="ini">while (rec != rec2) {
      <span class="hljs-attr">prev_rec</span> = rec2<span class="hljs-comment">;</span>
      <span class="hljs-attr">rec2</span> = page_rec_get_next_low(rec2, <span class="hljs-literal">true</span>)<span class="hljs-comment">;</span>
    }
    
    return (prev_rec)<span class="hljs-comment">;</span>
</code></pre>
<p>它会检查 rec7、rec8、rec9，然后是 rec10，直到找到 rec10 的前一条 record，即 rec9。</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[rec7]</span> --&gt; <span class="hljs-selector-attr">[rec8]</span> --&gt; <span class="hljs-selector-attr">[rec9]</span> --&gt; <span class="hljs-selector-attr">[rec10]</span> --&gt; <span class="hljs-selector-attr">[rec11]</span>
  ^
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[rec7]</span> --&gt; <span class="hljs-selector-attr">[rec8]</span> --&gt; <span class="hljs-selector-attr">[rec9]</span> --&gt; <span class="hljs-selector-attr">[rec10]</span> --&gt; <span class="hljs-selector-attr">[rec11]</span>
             ^
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[rec7]</span> --&gt; <span class="hljs-selector-attr">[rec8]</span> --&gt; <span class="hljs-selector-attr">[rec9]</span> --&gt; <span class="hljs-selector-attr">[rec10]</span> --&gt; <span class="hljs-selector-attr">[rec11]</span>
                        ^
</code></pre>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[rec7]</span> --&gt; <span class="hljs-selector-attr">[rec8]</span> --&gt; <span class="hljs-selector-attr">[rec9]</span> --&gt; <span class="hljs-selector-attr">[rec10]</span> --&gt; <span class="hljs-selector-attr">[rec11]</span>
                                   ^
</code></pre>
<h2 data-id="heading-11">4. 时间复杂度</h2>
<p>正向扫描是 <code>O(1)</code>，但反向扫描是 <code>O(n)</code>，其中 <code>n</code> 是页面目录中的槽数。</p>
<h2 data-id="heading-12">5. 基准测试</h2>
<h3 data-id="heading-13">5.1 正向扫描 (Forward scan)</h3>
<pre><code class="hljs language-sql" lang="sql">mysql <span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> k <span class="hljs-keyword">from</span> sbtest1 <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> k <span class="hljs-keyword">asc</span> limit <span class="hljs-number">9999999</span>, <span class="hljs-number">1</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">---------+</span>
<span class="hljs-operator">|</span> k       <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">---------+</span>
<span class="hljs-operator">|</span> <span class="hljs-number">8670945</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">---------+</span>
<span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">1.41</span> sec)

mysql <span class="hljs-operator">&gt;</span> <span class="hljs-keyword">desc</span> <span class="hljs-keyword">select</span> k <span class="hljs-keyword">from</span> sbtest1 <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> k <span class="hljs-keyword">asc</span> limit <span class="hljs-number">9999999</span>, <span class="hljs-number">1</span>\G
<span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span> <span class="hljs-number">1.</span> <span class="hljs-type">row</span> <span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span>
           id: <span class="hljs-number">1</span>
  select_type: SIMPLE
        <span class="hljs-keyword">table</span>: sbtest1
   partitions: <span class="hljs-keyword">NULL</span>
         type: index
possible_keys: <span class="hljs-keyword">NULL</span>
          key: k_1
      key_len: <span class="hljs-number">4</span>
          <span class="hljs-keyword">ref</span>: <span class="hljs-keyword">NULL</span>
         <span class="hljs-keyword">rows</span>: <span class="hljs-number">9864216</span>
     filtered: <span class="hljs-number">100.00</span>
        Extra: <span class="hljs-keyword">Using</span> index
<span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span>, <span class="hljs-number">1</span> warning (<span class="hljs-number">0.00</span> sec)
</code></pre>
<h3 data-id="heading-14">5.2 反向扫描 (Backward scan)</h3>
<pre><code class="hljs language-sql" lang="sql">mysql <span class="hljs-operator">&gt;</span> <span class="hljs-keyword">select</span> k <span class="hljs-keyword">from</span> sbtest1 <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> k <span class="hljs-keyword">desc</span> limit <span class="hljs-number">9999999</span>, <span class="hljs-number">1</span>;
<span class="hljs-operator">+</span><span class="hljs-comment">---------+</span>
<span class="hljs-operator">|</span> k       <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">---------+</span>
<span class="hljs-operator">|</span> <span class="hljs-number">1184614</span> <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">---------+</span>
<span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span> (<span class="hljs-number">2.01</span> sec)

mysql <span class="hljs-operator">&gt;</span> <span class="hljs-keyword">desc</span> <span class="hljs-keyword">select</span> k <span class="hljs-keyword">from</span> sbtest1 <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> k <span class="hljs-keyword">desc</span> limit <span class="hljs-number">9999999</span>, <span class="hljs-number">1</span>\G
<span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span> <span class="hljs-number">1.</span> <span class="hljs-type">row</span> <span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span><span class="hljs-operator">*</span>
           id: <span class="hljs-number">1</span>
  select_type: SIMPLE
        <span class="hljs-keyword">table</span>: sbtest1
   partitions: <span class="hljs-keyword">NULL</span>
         type: index
possible_keys: <span class="hljs-keyword">NULL</span>
          key: k_1
      key_len: <span class="hljs-number">4</span>
          <span class="hljs-keyword">ref</span>: <span class="hljs-keyword">NULL</span>
         <span class="hljs-keyword">rows</span>: <span class="hljs-number">9864216</span>
     filtered: <span class="hljs-number">100.00</span>
        Extra: Backward index scan; <span class="hljs-keyword">Using</span> index
<span class="hljs-number">1</span> <span class="hljs-type">row</span> <span class="hljs-keyword">in</span> <span class="hljs-keyword">set</span>, <span class="hljs-number">1</span> warning (<span class="hljs-number">0.00</span> sec)
</code></pre>
<h2 data-id="heading-15">References</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmysql%2Fmysql-server%2Fblob%2Fmysql-8.4.6%2Fstorage%2Finnobase%2Finclude%2Fbtr0pcur.h%23L860" target="_blank" title="https://github.com/mysql/mysql-server/blob/mysql-8.4.6/storage/innobase/include/btr0pcur.h#L860" ref="nofollow noopener noreferrer">btr_pcur_t::move_to_next</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmysql%2Fmysql-server%2Fblob%2Fmysql-8.4.6%2Fstorage%2Finnobase%2Fbtr%2Fbtr0pcur.cc%23L418" target="_blank" title="https://github.com/mysql/mysql-server/blob/mysql-8.4.6/storage/innobase/btr/btr0pcur.cc#L418" ref="nofollow noopener noreferrer">btr_pcur_t::move_to_prev</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 NanUI 快速创建具有现代用户界面的 WinForm 应用程序]]></title>    <link>https://juejin.cn/post/7600601482690723886</link>    <guid>https://juejin.cn/post/7600601482690723886</guid>    <pubDate>2026-01-29T13:03:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600601482690723886" data-draft-id="7600414546190286858" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 NanUI 快速创建具有现代用户界面的 WinForm 应用程序"/> <meta itemprop="keywords" content="后端,.NET"/> <meta itemprop="datePublished" content="2026-01-29T13:03:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="追逐时光者"/> <meta itemprop="url" content="https://juejin.cn/user/2770425031690333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 NanUI 快速创建具有现代用户界面的 WinForm 应用程序
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2770425031690333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    追逐时光者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T13:03:43.000Z" title="Thu Jan 29 2026 13:03:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>今天大姚给大家分享一个强大的 .NET 开源框架，它利用 Web 技术（HTML5、CSS3、JavaScript）为 WinForm 应用程序构建现代化的用户界面：NanUI。</p>
<p>如果你正在寻找一个用于创建具有现代用户界面的 WinForm 应用程序的框架，NanUI 是一个不错的选择。</p>
<h2 data-id="heading-1">项目介绍</h2>
<p>NanUI 是一个基于 .NET 平台的开源（MIT License）框架，旨在帮助开发者使用 HTML5、CSS3 和 JavaScript 构建具有现代感的 WinForm 应用程序用户界面。它底层依托于 Xilium.CefGlue 这是 Chromium Embedded Framework（CEF）在 .NET 环境下的官方绑定实现，通过嵌入完整的 Chromium 渲染引擎，使 WinForm 应用能够呈现 Web 技术驱动的富交互界面。</p>
<h2 data-id="heading-2">基本原理</h2>
<p><strong>官方介绍：</strong> <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/936bb8c441a9473cbdebb9fffe0a14e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770296623&amp;x-signature=PpObB%2FqRcdRVwLVoN%2Fs41lpHWtY%3D" alt="" loading="lazy"/></p>
<p><strong>基本原理概括：</strong></p>
<ul>
<li><strong>Chromium Embedded Framework (CEF)</strong> 是一个开源项目，一个用于将基于 Chromium 的浏览器嵌入其他应用程序的简单框架。</li>
<li>它提供稳定的 C/C++ API，支持多进程架构（Browser 进程 + Renderer/GPU 等子进程），具备完整的 HTML5 渲染、JavaScript 执行、网络请求、安全沙箱等能力。</li>
<li>NanUI 并未直接调用 CEF 的 C 接口，而是基于 <strong>Xilium.CefGlue</strong> 这是一个高质量的 .NET 封装库，将 CEF 的 C++ API 转换为 C# 可调用的托管接口。</li>
</ul>
<h2 data-id="heading-3">环境要求</h2>
<h3 data-id="heading-4">开发环境</h3>
<ul>
<li>Visual Studio 2019 或更高版本。</li>
<li>NET Framework 4.6.2 或更高版本 / .NET 6.0 或更高版本。</li>
</ul>
<h3 data-id="heading-5">部署环境</h3>
<ul>
<li>.NET Framework 4.6.2 或更高版本。</li>
<li>.NET 6.0 需要 Windows 7 Service Pack 1 或更高版本。</li>
<li>.NET 7.0/8.0/9.0 需要 Windows 10 或 Windows 11。</li>
<li>Microsoft Windows 7 Service Pack 1 或更高版本。</li>
</ul>
<h2 data-id="heading-6">项目源代码</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/547e942f350b42e1aecb767505252310~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770296623&amp;x-signature=e%2Be48s1%2BXuAR9pI%2B6rVh1yeWvWE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">快速使用</h2>
<h3 data-id="heading-8">创建一个 WinForm 应用程序</h3>
<p>首先我们快速创建一个名为<code>NanUIExercise</code> Windows 窗体应用程序：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2884a370369f4be4b222c02fd6ddeba4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770296623&amp;x-signature=0XcDslTRTewdtYbDOj274ZVFWlo%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f031758a598848afa62c620084fa137d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770296623&amp;x-signature=Z7JTOrYoS5Xba0NhFs0qtgar%2FG4%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61eec09e8e6d443fb6c0be956b31e425~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770296623&amp;x-signature=cxsqJzURS5O2%2Fe%2F77c18SkScBjc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">安装 NanUI NuGet 包</h3>
<p>安装 <code>NanUI</code> 包 <code>NetDimension.NanUI</code> ：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f922b7ffd26486597b27e346e846444~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770296623&amp;x-signature=BDPFMhbkWDIePrWeDoYHCSNOuOk%3D" alt="" loading="lazy"/></p>
<p>安装 <code>NanUI</code> 所依赖的 <code>Chromium Embedded Framework</code> 依赖包 <code>NetDimension.NanUI.Runtime</code>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad6d3aace26d47e18a2560bbefbf033d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770296623&amp;x-signature=prduxXfdRolkd7y%2Fc20U75UCa8g%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">创建一个基本的 NanUI 应用程序</h3>
<p><strong>Program.cs：</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> NetDimension.NanUI;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">NanUIExercise</span>
{
    <span class="hljs-keyword">internal</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
    {
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span>  The main entry point for the application.</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        [<span class="hljs-meta">STAThread</span>]
        <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span>
        {
            <span class="hljs-keyword">var</span> builder = NanUIApp.CreateBuilder();

            builder.UseNanUIApp&lt;MyFirstAPP&gt;();

            <span class="hljs-keyword">var</span> app = builder.Build();

            app.Run();
        }
    }
}
</code></pre>
<p><strong>创建一个类继承 AppStartup 来配置应用程序：</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> Microsoft.Extensions.DependencyInjection;
<span class="hljs-keyword">using</span> NetDimension.NanUI;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">NanUIExercise</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">MyFirstAPP</span> : <span class="hljs-title">AppStartup</span>
    {
        <span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> MainWindowCreationAction? UseMainWindow(MainWindowOptions opts)
        {
            <span class="hljs-comment">// 设置应用程序的主窗体</span>
            <span class="hljs-keyword">return</span> opts.UseMainFormium&lt;MyWindow&gt;();
        }

        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ProgramMain</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] args</span>)</span>
        {
            <span class="hljs-comment">// Main函数中的代码应该在这里，该函数只在主进程中运行。这样可以防止子进程运行一些不正确的初始化代码。</span>
            ApplicationConfiguration.Initialize();
        }

        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigurationChromiumEmbedded</span>(<span class="hljs-params">ChromiumEnvironmentBuiler cef</span>)</span>
        {
            <span class="hljs-comment">// 在此处配置 Chromium Embedded Framwork</span>
        }

        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureServices</span>(<span class="hljs-params">IServiceCollection services</span>)</span>
        {
            <span class="hljs-comment">// 在这里配置该应用程序的服务</span>
        }
    }
}
</code></pre>
<p><strong>创建一个类实现 Formium，用于配置应用程序的主窗口：</strong></p>
<pre><code class="hljs language-ini" lang="ini">using NetDimension.NanUI<span class="hljs-comment">;</span>
using NetDimension.NanUI.Forms<span class="hljs-comment">;</span>

namespace NanUIExercise
{
    public class MyWindow : Formium
    {
        public MyWindow()
        {
            <span class="hljs-attr">Url</span> = <span class="hljs-string">"https://juejin.cn/"</span><span class="hljs-comment">;</span>
        }

        protected override FormStyle ConfigureWindowStyle(WindowStyleBuilder builder)
        {
            // 此处配置窗口的样式和属性，或留空以使用默认样式

            var <span class="hljs-attr">style</span> = builder.UseSystemForm()<span class="hljs-comment">;</span>

            <span class="hljs-attr">style.TitleBar</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>

            <span class="hljs-attr">style.DefaultAppTitle</span> = <span class="hljs-string">"My First NanUI App"</span><span class="hljs-comment">;</span>

            return style<span class="hljs-comment">;</span>
        }
    }
}
</code></pre>
<p><strong>运行效果查看：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36bffd063d3a49aaa51c94636f8de74c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770296623&amp;x-signature=zN3tOH%2FNXodw96cXkzDtU0sNxeg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2414c969cc764693927583dba165f224~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770296623&amp;x-signature=UYvqRypd9ntuYyvcB%2Bs%2Fgljaexg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">项目源码地址</h2>
<p>更多项目实用功能和特性欢迎前往项目开源地址查看👀，别忘了给项目一个Star支持💖。</p>
<ul>
<li><strong>Gitee开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fdotnetchina%2FNanUI" target="_blank" title="https://gitee.com/dotnetchina/NanUI" ref="nofollow noopener noreferrer">gitee.com/dotnetchina…</a></li>
<li><strong>项目文档地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fdotnetchina%2FNanUI%2Fblob%2Fmaster%2Fdocs%2FREADME.md" target="_blank" title="https://gitee.com/dotnetchina/NanUI/blob/master/docs/README.md" ref="nofollow noopener noreferrer">gitee.com/dotnetchina…</a></li>
</ul>
<h2 data-id="heading-12">优秀项目和框架精选</h2>
<p>该项目已收录到C#/.NET/.NET Core优秀项目和框架精选中，关注优秀项目和框架精选能让你及时了解C#、.NET和.NET Core领域的最新动态和最佳实践，提高开发工作效率和质量。坑已挖，欢迎大家踊跃提交PR推荐或自荐（<strong>让优秀的项目和框架不被埋没🤞</strong>）。</p>
<ul>
<li><strong>GitHub开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FYSGStudyHards%2FDotNetGuide%2Fblob%2Fmain%2Fdocs%2FDotNet%2FDotNetProjectPicks.md" target="_blank" title="https://github.com/YSGStudyHards/DotNetGuide/blob/main/docs/DotNet/DotNetProjectPicks.md" ref="nofollow noopener noreferrer">github.com/YSGStudyHar…</a></li>
<li><strong>Gitee开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fysgdaydayup%2FDotNetGuide%2Fblob%2Fmain%2Fdocs%2FDotNet%2FDotNetProjectPicks.md" target="_blank" title="https://gitee.com/ysgdaydayup/DotNetGuide/blob/main/docs/DotNet/DotNetProjectPicks.md" ref="nofollow noopener noreferrer">gitee.com/ysgdaydayup…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AOT编译详解与应用实战]]></title>    <link>https://juejin.cn/post/7600333405978656809</link>    <guid>https://juejin.cn/post/7600333405978656809</guid>    <pubDate>2026-01-29T03:10:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600333405978656809" data-draft-id="7600430748780281899" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AOT编译详解与应用实战"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-29T03:10:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AOT编译详解与应用实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T03:10:58.000Z" title="Thu Jan 29 2026 03:10:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    15
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、AOT编译基础概念与核心原理</h2>
<p>AOT（Ahead-of-Time，预先编译）是一种<strong>在程序运行前将代码编译为机器码</strong>的技术，与JIT（Just-in-Time，即时编译）的“运行时编译”形成鲜明对比。其核心目标是<strong>消除运行时的编译开销</strong>，提升应用启动速度和运行性能，同时降低内存占用。</p>
<h3 data-id="heading-1">1. AOT与JIT的关键差异</h3>



































<table><thead><tr><th><strong>特性</strong>​</th><th><strong>AOT编译</strong>​</th><th><strong>JIT编译</strong>​</th></tr></thead><tbody><tr><td>编译时机</td><td>构建阶段（开发/打包时）</td><td>运行时（应用启动时）</td></tr><tr><td>启动性能</td><td>快（直接执行预编译代码）</td><td>慢（需下载/初始化JVM+编译代码）</td></tr><tr><td>应用体积</td><td>小（不包含JVM/编译器）</td><td>大（包含JVM/编译器）</td></tr><tr><td>错误检测</td><td>构建时发现（语法/类型错误）</td><td>运行时发现（可能导致崩溃）</td></tr><tr><td>适用场景</td><td>生产环境（微服务/Serverless）</td><td>开发环境（动态调试）</td></tr></tbody></table>
<h3 data-id="heading-2">2. AOT编译的核心原理</h3>
<p>Java中的AOT编译依赖<strong>GraalVM Native Image</strong>技术，将Java字节码转换为操作系统原生镜像（如Linux的ELF文件、Windows的PE文件）。其核心流程分为三步：</p>
<h4 data-id="heading-3">（1）静态分析与优化（构建时）</h4>
<p>Spring Boot 3.x的<strong>AOT处理器</strong>会扫描应用上下文，提前解析<code>@Component</code>、<code>@Bean</code>等注解，生成<strong>静态Bean定义</strong>（替代运行时的组件扫描）；同时，移除动态特性依赖（如反射、动态代理），若无法避免，需手动配置<code>reflect-config.json</code>声明。</p>
<h4 data-id="heading-4">（2）字节码增强（构建时）</h4>
<p>通过<code>spring-aot-maven-plugin</code>插件，生成适配原生编译的代码：</p>
<ul>
<li>替换Spring的动态组件扫描为<strong>静态Bean注册</strong>；</li>
<li>将<code>ApplicationContext</code>的初始化逻辑固化，避免运行时反射调用；</li>
<li>优化自动配置，只保留应用实际依赖的配置类。</li>
</ul>
<h4 data-id="heading-5">（3）原生镜像构建（构建时）</h4>
<p>借助<strong>GraalVM</strong>，将增强后的字节码编译为原生镜像：</p>
<ul>
<li>支持跨平台编译（Linux、Windows、macOS）；</li>
<li>镜像包含应用代码、依赖库和<strong>最小化的JVM运行时</strong>（仅保留必要模块）；</li>
<li>编译时进行<strong>逃逸分析</strong>、<strong>死码消除</strong>，进一步减小镜像体积。</li>
</ul>
<h2 data-id="heading-6">二、AOT编译的应用场景与优势</h2>
<p>AOT编译是<strong>Java生产环境的关键优化手段</strong>，尤其适合以下场景：</p>
<h3 data-id="heading-7">1. 生产环境部署（微服务/Serverless）</h3>
<ul>
<li><strong>更快的启动速度</strong>：原生镜像无需初始化JVM，启动时间从秒级降至毫秒级（如Spring Boot应用启动时间从30秒缩短至300毫秒）；</li>
<li><strong>更小的内存占用</strong>：移除JVM开销后，内存占用可减少50%以上（如2GB内存占用降至1GB以下）；</li>
<li><strong>更简单的部署</strong>：原生镜像包含所有依赖，无需在目标环境安装JDK，简化容器化部署（如Docker镜像体积减小30%）。</li>
</ul>
<h3 data-id="heading-8">2. 大型应用优化（Spring Boot 大型项目）</h3>
<p>对于大型Spring Boot应用，AOT编译的<strong>提前错误检测</strong>能避免运行时崩溃（如模板中的语法错误、类型不匹配）；同时，<strong>静态Bean定义</strong>减少了运行时的组件扫描开销，提升应用稳定性。</p>
<h3 data-id="heading-9">3. 云原生与边缘计算</h3>
<p>在云原生（如Kubernetes）或边缘计算场景中，AOT编译的<strong>快速启动</strong>和<strong>低内存占用</strong>能更好地适应弹性伸缩（如Serverless函数的冷启动优化），以及资源受限的边缘设备（如物联网网关）。</p>
<h2 data-id="heading-10">三、AOT编译的应用实战（Spring Boot 3.x 为例）</h2>
<p>以下结合<strong>Spring Boot 3.x</strong>（依赖Spring Framework 6+），详细说明AOT编译的配置与实践。</p>
<h3 data-id="heading-11">1. 环境准备</h3>
<ul>
<li><strong>JDK</strong>：OpenJDK 17+（Spring Boot 3.x最低要求）；</li>
<li><strong>构建工具</strong>：Maven 3.8+ 或 Gradle 7.5+；</li>
<li><strong>原生编译工具</strong>：GraalVM CE 21+（需配置<code>GRAALVM_HOME</code>环境变量）。</li>
</ul>
<h3 data-id="heading-12">2. 项目配置（Maven 示例）</h3>
<h4 data-id="heading-13">（1）引入Spring Boot 3.x依赖</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Web依赖 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- AOT测试依赖 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h4 data-id="heading-14">（2）配置AOT插件</h4>
<p>在<code>pom.xml</code>中添加<code>spring-boot-maven-plugin</code>，启用AOT编译：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
                <span class="hljs-comment">&lt;!-- 启用AOT编译 --&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">aot</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">aot</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>
</code></pre>
<h3 data-id="heading-15">3. 编写核心代码（REST 接口示例）</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@SpringBootApplication</span>
<span class="hljs-variable">@RestController</span>
public class AotDemoApplication {
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">main</span>(String[] args) {
        <span class="hljs-selector-tag">SpringApplication</span><span class="hljs-selector-class">.run</span>(AotDemoApplication.class, args);
    }

    <span class="hljs-comment">// 简单REST接口</span>
    @<span class="hljs-selector-tag">GetMapping</span>(<span class="hljs-string">"/hello"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">hello</span>(<span class="hljs-variable">@RequestParam</span> String name) {
        <span class="hljs-selector-tag">return</span> "<span class="hljs-selector-tag">Hello</span>, " + <span class="hljs-selector-tag">name</span> + "! <span class="hljs-selector-tag">This</span> <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">Spring</span> <span class="hljs-selector-tag">Boot</span> <span class="hljs-number">3</span> <span class="hljs-selector-tag">AOT</span> <span class="hljs-selector-tag">Demo</span>.";
    }
}
</code></pre>
<h3 data-id="heading-16">4. 构建原生镜像</h3>
<p>执行Maven命令，自动完成AOT处理和原生镜像构建：</p>
<pre><code class="hljs language-go" lang="go">mvn clean <span class="hljs-keyword">package</span> -Pnative
</code></pre>
<p>构建成功后，在<code>target</code>目录下生成原生镜像文件（如<code>aot-demo</code>），直接运行（无需JVM）：</p>
<pre><code class="hljs language-bash" lang="bash">./target/aot-demo
</code></pre>
<h3 data-id="heading-17">5. 关键优化点</h3>
<h4 data-id="heading-18">（1）处理反射（必选）</h4>
<p>GraalVM默认不支持动态反射，需通过<code>RuntimeHints</code>（Spring 6+）配置：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomRuntimeHints</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RuntimeHintsRegistrar</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">registerHints</span>(<span class="hljs-params">RuntimeHints hints, ClassLoader classLoader</span>) {
        <span class="hljs-comment">// 注册反射类</span>
        hints.<span class="hljs-title function_">reflection</span>().<span class="hljs-title function_">registerType</span>(<span class="hljs-title class_">User</span>.<span class="hljs-property">class</span>, builder -&gt; 
            builder.<span class="hljs-title function_">withMembers</span>(<span class="hljs-title class_">MemberCategory</span>.<span class="hljs-property">INVOKE_DECLARED_CONSTRUCTORS</span>)
        );
        <span class="hljs-comment">// 注册代理接口</span>
        hints.<span class="hljs-title function_">proxies</span>().<span class="hljs-title function_">registerJdkProxy</span>(<span class="hljs-title class_">UserInterface</span>.<span class="hljs-property">class</span>);
    }
}
</code></pre>
<h4 data-id="heading-19">（2）避免动态代理（可选）</h4>
<p>尽量使用静态代理，或在<code>RuntimeHints</code>中注册代理接口（如上例）。</p>
<h4 data-id="heading-20">（3）优化镜像体积（可选）</h4>
<p>通过<code>GraalVM</code>的<code>--gc=G1</code>、<code>--compact</code>等参数减小镜像体积：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.graalvm.buildtools<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>native-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">buildArgs</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">buildArg</span>&gt;</span>--gc=G1<span class="hljs-tag">&lt;/<span class="hljs-name">buildArg</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">buildArg</span>&gt;</span>--compact<span class="hljs-tag">&lt;/<span class="hljs-name">buildArg</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">buildArgs</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
</code></pre>
<h2 data-id="heading-21">四、AOT编译的常见问题与解决方案</h2>
<p>尽管AOT编译优势显著，但仍有一些<strong>常见限制</strong>需解决：</p>
<h3 data-id="heading-22">1. 反射兼容性问题</h3>
<p><strong>问题</strong>：反射调用未配置的类/方法，导致<code>MissingMetadataException</code>。</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>使用<code>RuntimeHints</code>（Spring 6+）配置反射元数据；</li>
<li>避免在AOT中使用动态反射（如<code>Class.forName()</code>），改用静态类型。</li>
</ul>
<h3 data-id="heading-23">2. 动态代理与代码生成</h3>
<p><strong>问题</strong>：<code>System.Reflection.Emit</code>（动态生成代码）不支持。</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>改用<strong>源码生成器</strong>（Source Generators）或预生成代码；</li>
<li>使用静态代理替代动态代理。</li>
</ul>
<h3 data-id="heading-24">3. 第三方库兼容性</h3>
<p><strong>问题</strong>：部分第三方库（如<code>Microsoft.Extensions.AI</code>预览版）依赖JIT编译。</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>检查库的AOT兼容性（参考Spring Native Hints）；</li>
<li>在<code>rd.xml</code>中添加配置保留必要元数据。</li>
</ul>
<h3 data-id="heading-25">4. 调试困难</h3>
<p><strong>问题</strong>：AOT编译后的代码是机器码，调试困难。</p>
<p><strong>解决方案</strong>：</p>
<ul>
<li>通过<code>-H:GenerateDebugInfo=1</code>生成带调试信息的镜像；</li>
<li>使用<code>jstack</code>（Java）或<code>dotnet trace</code>（.NET）进行性能分析。</li>
</ul>
<h2 data-id="heading-26">五、总结</h2>
<p>AOT编译是<strong>Java生产环境的关键优化手段</strong>，通过“提前编译”消除运行时开销，提升应用启动速度和稳定性。其核心价值在于：</p>
<ul>
<li><strong>更快的启动速度</strong>：直接执行预编译代码，无需运行时编译；</li>
<li><strong>更小的应用体积</strong>：移除JVM/编译器，减少带宽消耗；</li>
<li><strong>更好的安全性</strong>：避免将未编译的代码暴露给用户。</li>
</ul>
<p>在实际应用中，需根据Spring Boot 3.x的特性配置AOT编译，解决反射、动态代理等兼容性问题，确保应用稳定运行。对于<strong>大型应用</strong>或<strong>云原生项目</strong>，AOT编译是实现“高性能、轻量级”的关键技术。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入解析 Vercel Skill：跨 Agent 的技能包管理器]]></title>    <link>https://juejin.cn/post/7600628279215669274</link>    <guid>https://juejin.cn/post/7600628279215669274</guid>    <pubDate>2026-01-29T14:49:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600628279215669274" data-draft-id="7600597995768791049" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入解析 Vercel Skill：跨 Agent 的技能包管理器"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2026-01-29T14:49:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="candyTong"/> <meta itemprop="url" content="https://juejin.cn/user/2242659449576952"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入解析 Vercel Skill：跨 Agent 的技能包管理器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2242659449576952/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    candyTong
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T14:49:37.000Z" title="Thu Jan 29 2026 14:49:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>1. 背景：技能检索与部署的挑战</strong></h2>
<p>在利用 AI Agent（如 Claude Code, Cursor, Trae）进行开发时，开发者面临的核心挑战在于技能（Skill）的 <strong>检索效率</strong> 与 <strong>安装成本</strong>：</p>
<ul>
<li><strong>发现困难</strong>：优质的 Prompt 和指令集散落在 GitHub、博客或社区中，缺乏标准化的中心化检索入口。</li>
<li><strong>安装繁琐</strong>：手动将指令内容配置到不同 Agent 的特定目录中，操作路径长且低效。</li>
<li><strong>配置不统一</strong>：不同 Agent 的配置标准不统一，难以实现跨平台的技能同步与管理。</li>
</ul>
<p><strong>Vercel Skill</strong> 定位于 <strong>跨 Agent 的技能包管理器</strong>。它通过 <code>find</code> 命令建立标准化的检索机制，通过 <code>add</code> 命令实现自动化部署，将 Agent 的能力扩展过程标准化。</p>
<hr/>
<h2 data-id="heading-1"><strong>2. 核心功能：<code>find</code> 与 <code>add</code></strong></h2>
<h3 data-id="heading-2"><strong><code>find</code>：检索与发现</strong></h3>
<pre><code class="hljs language-bash" lang="bash">npx skills find react
</code></pre>
<p>用于在官方资源库中交互式搜索技能。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34c14f3c36ab4357bcc2fa5f103ecc16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2FuZHlUb25n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770302977&amp;x-signature=qDTS%2Bni9A1iSFbFj%2FS49rWEr7x8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3"><strong><code>add</code>：安装与同步</strong></h3>
<pre><code class="hljs language-bash" lang="bash">npx skills add https://github.com/vercel-labs/skills --skill find-skills
</code></pre>
<p>用于从远程仓库、URL 或本地路径安装技能。它能自动识别本地已安装的 Agent（如 Claude Code, Cursor, Trae）并实现一键同步配置。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c92e79fb4238453e85243104c466e0ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2FuZHlUb25n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770302977&amp;x-signature=DDjtHYzyJqkLkYoSVTVUCoOwmLw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4"><strong>find-skills：赋予 Agent 搜索 skill 能力</strong></h2>
<p>除了 CLI 工具，官方还提供了一个名为 <code>find-skills</code> 的内置技能，专门用于辅助 Agent 发现新能力。</p>
<ul>
<li><strong>核心功能</strong>：让 Agent 能够根据用户的模糊需求（如“帮我找个写测试的工具”），自主调用检索逻辑。</li>
<li><strong>多轮检索机制</strong>：Agent 会根据初始反馈，自动尝试多轮查找，并生成更精准的关键词进行二次搜索，直到找到最匹配的技能。</li>
<li><strong>决策辅助</strong>：Agent 会对比搜索结果，向用户解释每个技能的用途，并给出安装建议，从而降低用户的决策成本。</li>
<li><strong>安装方式</strong>：
<pre><code class="hljs language-bash" lang="bash">npx skills add vercel-labs/skills@find-skills
</code></pre>
</li>
</ul>
<p>使用效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29adece6e2024acd92f396c75ea4539a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY2FuZHlUb25n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770302977&amp;x-signature=CfPodfcDVb8fkkxvN%2FcWM3dDbk4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5"><strong>3. 实现原理</strong></h2>
<p>Vercel Skill 采用“协调者”架构。<code>find</code> 与 <code>add</code> 既可以独立运行，也可以在交互模式下链式调用。</p>
<h3 data-id="heading-6"><strong><code>find</code> 检索流程时序图</strong></h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User as 用户
    participant CLI as Vercel Skill CLI (find.ts)
    participant Registry as skills.sh API

    User-&gt;&gt;CLI: npx skills find "react"
    loop 交互式输入
        CLI-&gt;&gt;Registry: GET /api/search (携带 query)
        Registry--&gt;&gt;CLI: 返回技能元数据列表 (包含名称、仓库源、安装量等)
        CLI-&gt;&gt;User: 动态渲染交互界面 (显示名称与 Source)
    end
    User-&gt;&gt;CLI: 确认选择项 (提取 Source 标识符)
    Note over CLI: 内部调用 runAdd(source)
</code></pre>
<h3 data-id="heading-7"><strong><code>add</code> 部署流程时序图</strong></h3>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User as 用户
    participant CLI as Vercel Skill CLI (add.ts)
    participant Source as 源码托管 (GitHub/Local)
    participant Agent as AI Agent (如 Claude Code)

    User-&gt;&gt;CLI: npx skills add &lt;source&gt;
    CLI-&gt;&gt;CLI: 解析 Source (标准 URL 或 简写)

    alt 远程源 (GitHub/GitLab)
        CLI-&gt;&gt;Source: 克隆仓库至临时目录
    else 本地源
        CLI-&gt;&gt;Source: 读取本地路径
    end

    CLI-&gt;&gt;CLI: 发现并解析 SKILL.md
    CLI-&gt;&gt;Agent: 自动探测已安装的 Agent 环境
    User-&gt;&gt;CLI: 确认安装范围与方式 (Symlink/Copy)

    loop 遍历目标 Agent
        CLI-&gt;&gt;Agent: 写入配置或创建软链接
    end
    Agent--&gt;&gt;User: 部署完成并打印路径
</code></pre>
<ol>
<li><strong>源解析</strong>：将用户输入的简写（如 <code>owner/repo</code>）或标准 URL 解析为统一的结构。</li>
<li><strong>资源获取</strong>：针对远程仓库，CLI 自动克隆源码至临时目录；针对本地路径则直接读取。</li>
<li><strong>环境探测</strong>：扫描系统预定义的 Agent 配置路径（如 Claude Code、Cursor、Trae 等），识别当前活跃环境。</li>
<li><strong>自动化部署</strong>：根据用户选择的范围（全局/项目）和方式（软链接/复制），CLI 批量在目标 Agent 的技能目录下建立关联。</li>
</ol>
<hr/>
<h2 data-id="heading-8"><strong>4. 企业内部 skill 平台的接入方式</strong></h2>
<h3 data-id="heading-9"><strong>Search 功能接入</strong></h3>
<p>对于企业内部环境，Vercel Skill 提供了 <code>SKILLS_API_URL</code> 环境变量，用于修改请求的域名；只要域名提供对应的接口，并保持入参出参一致即可。</p>
<pre><code class="hljs language-bash" lang="bash">SKILLS_API_URL=https://your-internal-api.com npx skills find react
</code></pre>
<p><strong>企业内部搜索接入时序图：</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant CLI as Skills CLI
    participant IntAPI as 企业内部 API (SKILLS_API_URL)
    participant Registry as 内部 Skill 注册表
    participant ExtAPI as 外部公开 API (skills.sh)

    CLI-&gt;&gt;IntAPI: GET /api/search?q=...
    activate IntAPI
    IntAPI-&gt;&gt;Registry: 检索企业私有 Skill
    Registry--&gt;&gt;IntAPI: 返回私有 Skill 列表

    rect rgb(240, 240, 240)
    Note over IntAPI, ExtAPI: 可选：聚合外部搜索
    IntAPI-&gt;&gt;ExtAPI: GET /api/search?q=...
    ExtAPI--&gt;&gt;IntAPI: 返回公开 Skill 列表
    end

    IntAPI-&gt;&gt;IntAPI: 合并并转换格式
    IntAPI--&gt;&gt;CLI: 返回统一格式的技能列表
    deactivate IntAPI
</code></pre>
<p><strong>接口伪代码示例（同时支持搜索企业内和企业外部的 skill）：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 企业内部 Skill 搜索接口示例 (Next.js / Vercel Route Handler)</span>
<span class="hljs-comment">// GET /api/search?q=...</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">GET</span>(<span class="hljs-params">request: Request</span>) {
  <span class="hljs-keyword">const</span> { searchParams } = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(request.<span class="hljs-property">url</span>);
  <span class="hljs-keyword">const</span> query = searchParams.<span class="hljs-title function_">get</span>(<span class="hljs-string">'q'</span>);

  <span class="hljs-comment">// 1. 搜索企业内部私有 Skill 仓库</span>
  <span class="hljs-keyword">const</span> internalSkills = <span class="hljs-keyword">await</span> <span class="hljs-title function_">searchInternalRegistry</span>(query);

  <span class="hljs-comment">// 2. 搜索企业外部公开 Skill (可选，实现聚合搜索)</span>
  <span class="hljs-keyword">const</span> publicSkills = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`https://skills.sh/api/search?q=<span class="hljs-subst">${query}</span>`</span>)
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> res.<span class="hljs-title function_">json</span>())
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> data.<span class="hljs-property">skills</span>)
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> []);

  <span class="hljs-comment">// 3. 统一转换格式并合并结果</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Response</span>.<span class="hljs-title function_">json</span>({
    <span class="hljs-attr">skills</span>: [
      ...internalSkills.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">s</span>) =&gt;</span> ({
        <span class="hljs-attr">id</span>: s.<span class="hljs-property">id</span>,
        <span class="hljs-attr">name</span>: s.<span class="hljs-property">name</span>,
        <span class="hljs-attr">installs</span>: s.<span class="hljs-property">downloads</span>,
        <span class="hljs-attr">topSource</span>: s.<span class="hljs-property">gitUrl</span>, <span class="hljs-comment">// 内部 Git 地址</span>
      })),
      ...publicSkills,
    ],
  });
}
</code></pre>
<h3 data-id="heading-10"><strong>Add 功能接入与权限处理</strong></h3>
<p>针对企业内部 <code>add</code> 功能，主要有以下两种接入方案：</p>
<h4 data-id="heading-11"><strong>方案一：无改造直接接入 (Direct Clone)</strong></h4>
<p>不需要任何改造，直接传入 Git 仓库进行下载。</p>
<ul>
<li><strong>原理</strong>：直接利用本地 Git 环境进行 <code>Clone</code> 内部仓库。</li>
<li><strong>优点</strong>：实现成本低，完全复用现有逻辑。</li>
<li><strong>缺点</strong>：受限于用户本地权限，对于没有仓库访问权限的用户会安装失败。</li>
</ul>
<h4 data-id="heading-12"><strong>方案二：平台中间层接入 (Well-known Proxy)</strong></h4>
<p>如果要做到通用且安全，可以通过引入一个<strong>平台中间层 (Proxy Layer)</strong>。此时 <code>add</code> 命令传入不再是内部 Git 地址，而是中间层的 HTTP 域名。</p>
<ul>
<li>
<p><strong>原理</strong>：</p>
<ol>
<li><strong>屏蔽权限复杂性</strong>：服务端统一持有 Git Token/SSH Key，负责克隆内部私有仓库。终端用户无需配置 Git 权限。</li>
<li><strong>协议转换</strong>：将复杂的 Git 结构转换为标准的 <strong>Well-known (RFC 8615)</strong> 静态文件接口。</li>
<li><strong>按需发现</strong>：支持通过子路径（如 <code>middleware.com/org-name</code>）实现多团队的技能发现。</li>
</ol>
</li>
<li>
<p><strong>实现细节</strong>：</p>
<ul>
<li><strong>接口规范</strong>：需实现 <code>GET /.well-known/skills/index.json</code> 索引接口。</li>
<li><strong>单个文件下载</strong>：CLI 在解析 <code>index.json</code> 后，会根据 <code>files</code> 数组中的路径，拼接完整的 URL 逐个下载文件（例如：<code>GET /.well-known/skills/db-helper/SKILL.md</code>）。</li>
<li><strong>数据结构示例</strong>：
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"skills"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"internal-db-helper"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"企业内部数据库查询助手"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"files"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"SKILL.md"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"handler.ts"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>工作流时序图</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User as 用户 (CLI)
    participant Proxy as 中间层 (Well-known Server)
    participant Git as 内部 Git (GitLab/Bitbucket)

    User-&gt;&gt;Proxy: npx skills add https://proxy.com/skills
    Proxy-&gt;&gt;Proxy: 鉴权并解析目标技能
    Proxy-&gt;&gt;Git: 服务端 Clone (使用预设 Token)
    Proxy-&gt;&gt;Proxy: 提取 SKILL.md 并生成 index.json
    Proxy--&gt;&gt;User: 返回 index.json 索引
    User-&gt;&gt;Proxy: GET /.well-known/skills/db-helper/SKILL.md
    Proxy--&gt;&gt;User: 返回文件流
    Note over User: CLI 完成本地安装
</code></pre>
</li>
</ul>
<p>这种方案将“仓库访问控制”转化为了“Web API 访问控制”，极大地降低了企业内部推广技能包的门槛。</p>
<hr/>
<h2 data-id="heading-13"><strong>总结</strong></h2>
<p><strong>Vercel Skill</strong> 通过标准化的 CLI 工具，打破了 AI Agent 技能发现与部署的壁垒：</p>
<ol>
<li><strong>用户侧</strong>：提供了类似 <code>npm</code> 的丝滑体验，实现了一次安装、多 Agent 同步。</li>
<li><strong>开发者侧</strong>：通过简单的 <code>SKILL.md</code> 规范即可发布技能，支持 Git、本地路径及 Web URL 等多种源。</li>
<li><strong>企业侧</strong>：通过灵活的 API 环境变量及 <strong>Well-known 代理模式</strong>，在确保安全与权限受控的前提下，实现了企业内部私有技能的高效分发。</li>
</ol>
<p>随着 AI Agent 生态的爆发，这种<strong>跨平台、标准化的技能包管理方案</strong>将成为提升开发者生产力的关键基础设施。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（72）如何在NoSQL数据库中使用Hibernate？]]></title>    <link>https://juejin.cn/post/7600616270002864166</link>    <guid>https://juejin.cn/post/7600616270002864166</guid>    <pubDate>2026-01-29T11:54:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600616270002864166" data-draft-id="7600616270002847782" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（72）如何在NoSQL数据库中使用Hibernate？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-29T11:54:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（72）如何在NoSQL数据库中使用Hibernate？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-29T11:54:11.000Z" title="Thu Jan 29 2026 11:54:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    15
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在NoSQL数据库中使用Hibernate，可以使用Hibernate OGM（Object/Grid Mapper）。Hibernate OGM是Hibernate ORM的扩展，旨在为NoSQL数据库提供对象映射和持久化功能。它支持多种NoSQL数据库，包括MongoDB、CouchDB、Neo4j等。</p>
<p>下面是详细步骤和代码示例，展示如何在MongoDB（一种常见的NoSQL数据库）中使用Hibernate OGM。</p>
<h3 data-id="heading-0">1. 项目依赖</h3>
<p>在<code>pom.xml</code>中添加必要的依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spring Boot Starter Data JPA --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- MongoDB Driver --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mongodb<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mongodb-driver-sync<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.4.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Hibernate OGM Core --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.hibernate.ogm<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hibernate-ogm-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.4.1.Final<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Hibernate OGM MongoDB --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.hibernate.ogm<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hibernate-ogm-mongodb<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.4.1.Final<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-1">2. 配置Hibernate OGM</h3>
<p>创建一个配置类来配置Hibernate OGM。</p>
<h4 data-id="heading-2"><code>OgmConfig.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Primary;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.JpaTransactionManager;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean;
<span class="hljs-keyword">import</span> org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter;

<span class="hljs-keyword">import</span> javax.persistence.EntityManagerFactory;
<span class="hljs-keyword">import</span> javax.sql.DataSource;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OgmConfig</span> {

    <span class="hljs-meta">@Value("${spring.data.mongodb.host}")</span>
    <span class="hljs-keyword">private</span> String mongoHost;

    <span class="hljs-meta">@Value("${spring.data.mongodb.port}")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> mongoPort;

    <span class="hljs-meta">@Value("${spring.data.mongodb.database}")</span>
    <span class="hljs-keyword">private</span> String mongoDatabase;

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="hljs-title function_">entityManagerFactory</span><span class="hljs-params">()</span> {
        <span class="hljs-type">LocalContainerEntityManagerFactoryBean</span> <span class="hljs-variable">em</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalContainerEntityManagerFactoryBean</span>();
        em.setJpaVendorAdapter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HibernateJpaVendorAdapter</span>());
        
        Map&lt;String, Object&gt; properties = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        properties.put(<span class="hljs-string">"hibernate.ogm.datastore.provider"</span>, <span class="hljs-string">"mongodb"</span>);
        properties.put(<span class="hljs-string">"hibernate.ogm.datastore.create_database"</span>, <span class="hljs-literal">true</span>);
        properties.put(<span class="hljs-string">"hibernate.ogm.datastore.database"</span>, mongoDatabase);
        properties.put(<span class="hljs-string">"hibernate.ogm.datastore.host"</span>, mongoHost);
        properties.put(<span class="hljs-string">"hibernate.ogm.datastore.port"</span>, mongoPort);
        
        em.setJpaPropertyMap(properties);
        
        <span class="hljs-keyword">return</span> em;
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@Primary</span>
    <span class="hljs-keyword">public</span> JpaTransactionManager <span class="hljs-title function_">transactionManager</span><span class="hljs-params">(EntityManagerFactory emf)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JpaTransactionManager</span>(emf);
    }
}
</code></pre>
<p>在<code>application.properties</code>中配置MongoDB参数：</p>
<pre><code class="hljs language-properties" lang="properties">spring.data.mongodb.host=localhost
spring.data.mongodb.port=27017
spring.data.mongodb.database=mydatabase
</code></pre>
<h3 data-id="heading-3">3. 定义实体类和DAO层</h3>
<h4 data-id="heading-4"><code>Person.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.hibernate.annotations.GenericGenerator;

<span class="hljs-keyword">import</span> javax.persistence.Entity;
<span class="hljs-keyword">import</span> javax.persistence.GeneratedValue;
<span class="hljs-keyword">import</span> javax.persistence.Id;
<span class="hljs-keyword">import</span> javax.persistence.Table;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "person")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {

    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(generator = "UUID")</span>
    <span class="hljs-meta">@GenericGenerator(
        name = "UUID",
        strategy = "org.hibernate.id.UUIDGenerator"
    )</span>
    <span class="hljs-keyword">private</span> String id;

    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;

    <span class="hljs-comment">// Getters and Setters</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(String id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-built_in">this</span>.name = name;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAge</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> age;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAge</span><span class="hljs-params">(<span class="hljs-type">int</span> age)</span> {
        <span class="hljs-built_in">this</span>.age = age;
    }
}
</code></pre>
<h4 data-id="heading-5"><code>PersonRepository.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PersonRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaRepository</span>&lt;Person, String&gt; {
}
</code></pre>
<h3 data-id="heading-6">4. 创建服务层</h3>
<h4 data-id="heading-7"><code>PersonService.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PersonService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> PersonRepository personRepository;

    <span class="hljs-keyword">public</span> Person <span class="hljs-title function_">createPerson</span><span class="hljs-params">(Person person)</span> {
        <span class="hljs-keyword">return</span> personRepository.save(person);
    }

    <span class="hljs-keyword">public</span> Person <span class="hljs-title function_">getPersonById</span><span class="hljs-params">(String id)</span> {
        <span class="hljs-keyword">return</span> personRepository.findById(id).orElse(<span class="hljs-literal">null</span>);
    }

    <span class="hljs-keyword">public</span> List&lt;Person&gt; <span class="hljs-title function_">getAllPersons</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> personRepository.findAll();
    }

    <span class="hljs-keyword">public</span> Person <span class="hljs-title function_">updatePerson</span><span class="hljs-params">(Person person)</span> {
        <span class="hljs-keyword">return</span> personRepository.save(person);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deletePerson</span><span class="hljs-params">(String id)</span> {
        personRepository.deleteById(id);
    }
}
</code></pre>
<h3 data-id="heading-8">5. 创建控制器</h3>
<h4 data-id="heading-9"><code>PersonController.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.http.ResponseEntity;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/persons")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PersonController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> PersonService personService;

    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Person&gt; <span class="hljs-title function_">createPerson</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> Person person)</span> {
        <span class="hljs-type">Person</span> <span class="hljs-variable">createdPerson</span> <span class="hljs-operator">=</span> personService.createPerson(person);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(createdPerson);
    }

    <span class="hljs-meta">@GetMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Person&gt; <span class="hljs-title function_">getPersonById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id)</span> {
        <span class="hljs-type">Person</span> <span class="hljs-variable">person</span> <span class="hljs-operator">=</span> personService.getPersonById(id);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(person);
    }

    <span class="hljs-meta">@GetMapping</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;List&lt;Person&gt;&gt; <span class="hljs-title function_">getAllPersons</span><span class="hljs-params">()</span> {
        List&lt;Person&gt; persons = personService.getAllPersons();
        <span class="hljs-keyword">return</span> ResponseEntity.ok(persons);
    }

    <span class="hljs-meta">@PutMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Person&gt; <span class="hljs-title function_">updatePerson</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id, <span class="hljs-meta">@RequestBody</span> Person person)</span> {
        person.setId(id); <span class="hljs-comment">// Ensure the person ID is set correctly</span>
        <span class="hljs-type">Person</span> <span class="hljs-variable">updatedPerson</span> <span class="hljs-operator">=</span> personService.updatePerson(person);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(updatedPerson);
    }

    <span class="hljs-meta">@DeleteMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Void&gt; <span class="hljs-title function_">deletePerson</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String id)</span> {
        personService.deletePerson(id);
        <span class="hljs-keyword">return</span> ResponseEntity.noContent().build();
    }
}
</code></pre>
<h3 data-id="heading-10">6. 运行应用</h3>
<ol>
<li><strong>启动MongoDB</strong>：确保你的MongoDB数据库运行在<code>localhost:27017</code>。</li>
<li><strong>启动Spring Boot应用</strong>：运行Spring Boot应用程序。</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">mvn spring-boot:run
</code></pre>
<h3 data-id="heading-11">7. 访问API</h3>
<p>通过以下API访问<code>Person</code>数据：</p>
<ul>
<li><code>POST /persons</code>：创建Person。</li>
<li><code>GET /persons/{id}</code>：按ID获取Person。</li>
<li><code>GET /persons</code>：获取所有Persons。</li>
<li><code>PUT /persons/{id}</code>：更新Person。</li>
<li><code>DELETE /persons/{id}</code>：删除Person。</li>
</ul>
<h3 data-id="heading-12">总结</h3>
<p>通过上述步骤，我们展示了如何在NoSQL数据库（如MongoDB）中使用Hibernate OGM，包括配置Hibernate OGM、定义实体和DAO层、创建服务层和控制器以及如何运行和访问API。在大数据和NoSQL环境中，Hibernate OGM提供了一种基于对象的方式来处理复杂的数据持久化需求，使得开发人员可以更方便地进行数据操作。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文详解 Kotlin 中的流- flow、channel]]></title>    <link>https://juejin.cn/post/7600953198745812998</link>    <guid>https://juejin.cn/post/7600953198745812998</guid>    <pubDate>2026-01-30T07:15:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7600953198745812998" data-draft-id="7599166436683972654" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文详解 Kotlin 中的流- flow、channel"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-30T07:15:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jony_"/> <meta itemprop="url" content="https://juejin.cn/user/3403743732709767"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文详解 Kotlin 中的流- flow、channel
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3403743732709767/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jony_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-30T07:15:54.000Z" title="Fri Jan 30 2026 07:15:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前言</h2>
<p>当下 Android 比较流行的架构是 MVI + Kotlin 协程 + Compose，在 MVI 的架构中。为了减少 LiveData 在复杂页面过多的问题，我们推荐使用 State 进行统一管理。</p>
<p>LiveData 是 UI Layer 所观察的对象，在页面销毁的时候，能够自动取消所有的观察者，避免内存泄漏。和 LiveData 相比， Flow具有如下优势：</p>
<ol>
<li>支持背压</li>
<li>支持数据变换</li>
<li>支持线程切换</li>
</ol>
<p>总之一句话，Flow 天生为协程而生。</p>
<h2 data-id="heading-1">二、流的分类</h2>
<p>Kotlin 的流可以分为两类，冷流和热流。冷流和热流的区别如下：</p>
<p><strong>冷流</strong>：没有消费者，生产者就不会生产数据。</p>
<p><strong>热流</strong>：是否生产数据，和消费者没有关系</p>
<p>在 Kotlin 协程中，Flow 是冷流，StateFlow、SharedFlow、Channel 等是热流。StateFlow 用于页面状态，SharedFlow 用于事件，Channel 主要用于协程间进行通信。</p>
<h2 data-id="heading-2">三、flow、channel 的用法</h2>
<p>flow 的用法如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ViewModel</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getData</span><span class="hljs-params">()</span></span>: Flow&lt;String&gt; = flow {
    emit(<span class="hljs-string">""</span>)
}.flowOn(Dispatchers.IO).<span class="hljs-keyword">catch</span> {
    println(it.message)
}

<span class="hljs-comment">// Activity</span>
lifecycleScope.launch {
    lifecycle.repeatOnLifecycle(Lifecycle.State.STARTED) {
        vm.getData().collect {}
    }
}
</code></pre>
<p>StateFlow 和 SharedFlow用法如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _stateFlow = MutableStateFlow(<span class="hljs-number">1</span>)
<span class="hljs-keyword">val</span> stateFlow: StateFlow&lt;<span class="hljs-built_in">Int</span>&gt; = _stateFlow

<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _shareFlow = MutableSharedFlow&lt;<span class="hljs-built_in">Int</span>&gt;()
<span class="hljs-keyword">val</span> shareFlow : SharedFlow&lt;<span class="hljs-built_in">Int</span>&gt; = _shareFlow

viewModelScope.launch {
    _stateFlow.value = <span class="hljs-number">2</span>
    _shareFlow.emit(<span class="hljs-number">1</span>)
}
</code></pre>
<p>Channel 主要是用在协程之间进行通信，代码示例如下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    GlobalScope.launch {
        <span class="hljs-keyword">val</span> channel = Channel&lt;<span class="hljs-built_in">Int</span>&gt;()
        <span class="hljs-keyword">val</span> scope = CoroutineScope(Job())
        scope.launch {
            launch {
                channel.send(<span class="hljs-number">1</span>)
            }
            launch {
                println(channel.receive())
            }
        }.join()
    }.join()
}
</code></pre>
<p>Flow 还有其他的一些操作变换符，例如 map、tranform 等，不在这里一一详述。另外，Channel 是线程安全的。</p>
<h2 data-id="heading-3">四、需要注意什么</h2>
<p><strong>LiveData</strong> 和 <strong>StateFlow</strong> 在 Android 架构中，都是用于状态更新的，他们区别如下：</p>
<ol>
<li>LiveData 具有生命周期感知的能力，StateFlow 不具备，因此 StateFlow监听数据的时候，需要在生命周期里</li>
<li>LiveData 不具备防抖的能力，StateFlow 具有防抖的能力</li>
</ol>
<p><strong>SharedFlow</strong> 和 <strong>StateFlow</strong> 都是热流，StateFlow 是特殊 SharedFlow，他们的区别如下：</p>
<ol>
<li>从作用场景来看，SharedFlow 用于事件更新，StateFlow 用于状态更新</li>
<li>collect() 和 emit() 都是挂起函数，需要确保在协程内部进行调用</li>
<li>SharedFlow emit() 和collect() 都是挂起函数，可能会阻塞当前的协程。<strong>因此生产者和消费者需要需要在不同的协程。</strong></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>