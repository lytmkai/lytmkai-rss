<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[在企业级 Java 中应用领域驱动设计：一种行为驱动方法]]></title>    <link>https://juejin.cn/post/7577438119558578227</link>    <guid>https://juejin.cn/post/7577438119558578227</guid>    <pubDate>2025-11-28T08:10:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577438119558578227" data-draft-id="7577430671947595802" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在企业级 Java 中应用领域驱动设计：一种行为驱动方法"/> <meta itemprop="keywords" content="领域驱动设计"/> <meta itemprop="datePublished" content="2025-11-28T08:10:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="信码由缰"/> <meta itemprop="url" content="https://juejin.cn/user/2110664941509214"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在企业级 Java 中应用领域驱动设计：一种行为驱动方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2110664941509214/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    信码由缰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T08:10:32.000Z" title="Fri Nov 28 2025 08:10:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>了解如何结合 DDD 和 BDD 于企业级 Java 中，以创建能够模拟真实业务领域并通过可执行场景验证行为的软件。</p>
</blockquote>
<p><img src="https://cf-blog.icodebuddy.com/image/94/94-0.png" alt="" loading="lazy"/></p>
<p>在软件开发领域，最大的错误之一就是交付客户"精确"想要的东西。这听起来可能像陈词滥调，但即使在行业摸爬滚打数十年后，这个问题依然存在。一个更有效的方法是从关注业务需求开始测试。</p>
<p><strong>行为驱动开发</strong>【<a href="https://link.juejin.cn?target=https%3A%2F%2Fdzone.com%2Farticles%2Fwhat-is-bdd-a-complete-guide" target="_blank" title="https://dzone.com/articles/what-is-bdd-a-complete-guide" ref="nofollow noopener noreferrer">Behavior-driven development</a>】（<strong>BDD</strong>）是一种强调行为和领域术语（也称为<strong>统一语言</strong>）的软件开发方法论。它使用共享的自然语言，从用户的角度定义和测试软件行为。BDD 建立在<strong>测试驱动开发</strong>【<a href="https://link.juejin.cn?target=https%3A%2F%2Fdzone.com%2Farticles%2Fthe-importance-of-test-driven-development-in-softw" target="_blank" title="https://dzone.com/articles/the-importance-of-test-driven-development-in-softw" ref="nofollow noopener noreferrer">test-driven development</a>】（<strong>TDD</strong>）的基础上，专注于与业务相关的场景。这些场景以纯语言规范的形式编写，可以自动化成测试，同时也充当活文档。</p>
<p>这种方法促进了技术和非技术利益相关者之间的共识，确保软件满足用户需求，并有助于减少返工和开发时间。在本文中，我们将进一步探讨这种方法论，并讨论如何使用 Oracle NoSQL 和 Java 来实现它。</p>
<h2 data-id="heading-0">BDD 与 DDD 如何协同工作</h2>
<p>乍看之下，行为驱动开发（BDD）和领域驱动设计（DDD）似乎解决的是不同的问题——一个侧重于<em>测试</em>，另一个侧重于<em>建模</em>。然而，它们共享相同的哲学基础：确保软件真实反映其所服务的<strong>业务领域</strong>。</p>
<p><strong>DDD</strong>，由 Eric Evans 在其 2003 年具有开创性的著作*《领域驱动设计：软件核心复杂性的应对之道》*中提出，教导我们围绕业务概念（实体、值对象、聚合和限界上下文）来建模软件。其力量在于使用<strong>统一语言</strong>，这是一种连接开发人员和领域专家的共享词汇表。</p>
<p><strong>BDD</strong>，由 Dan North 在几年后提出，是这一思想自然而然的延伸。它将统一语言引入测试过程，将业务规则转化为可执行的规范。DDD 定义了系统应该表示<em>什么</em>，而 BDD 则根据该模型验证系统的<em>行为方式</em>。</p>
<p>当结合使用时，DDD 和 BDD 形成了一个持续的反馈循环：</p>
<ul>
<li>
<p>DDD 塑造了捕获业务逻辑的<strong>领域模型</strong>。</p>
</li>
<li>
<p>BDD 确保<strong>系统行为</strong>随着时间的推移与该模型保持一致。</p>
</li>
</ul>
<p>在实践中，这种协同作用意味着您可以编写与聚合（如 Room 和 Reservation）直接相关的特性场景——例如"当我预订一个 VIP 房间时，系统应将其标记为不可用"。这些测试成为开发人员和利益相关者的活文档，确保您的领域始终与真实的业务需求保持一致。</p>
<p>如果您想深入探索这种结合，我的著作<a href="https://link.juejin.cn?target=https%3A%2F%2Fbpbonline.com%2Fproducts%2Fdomain-driven-design-with-java" target="_blank" title="https://bpbonline.com/products/domain-driven-design-with-java" ref="nofollow noopener noreferrer">《Domain-Driven Design with Java》</a>详细阐述了这些原则。它展示了如何在现代 Java 应用程序中使用 Jakarta EE、Spring 和云技术应用 DDD 模式，为统一架构和行为提供了实践基础。</p>
<p>总之，DDD 和 BDD 共同弥合了理解业务与证明其可行之间的差距——将软件从技术制品转变为领域本身的忠实表达。</p>
<h2 data-id="heading-1">代码实现</h2>
<p>在本示例中，我们将使用企业级 Java 和 Oracle NoSQL 数据库生成一个简单的酒店管理应用程序。</p>
<p>第一步是创建项目。由于我们使用的是 Java SE，我们可以使用以下 Maven 命令生成它：</p>
<pre><code class="hljs language-shell" lang="shell">
mvn archetype:generate \

"-DarchetypeGroupId=io.cucumber" \

"-DarchetypeArtifactId=cucumber-archetype" \

"-DarchetypeVersion=7.30.0" \

"-DgroupId=org.soujava.demos.hotel" \

"-DartifactId=behavior-driven-development" \

"-Dpackage=org.soujava.demos" \

"-Dversion=1.0.0-SNAPSHOT" \

"-DinteractiveMode=false"

</code></pre>
<p>下一步是引入 <strong>Eclipse JNoSQL</strong> 与 <strong>Oracle NoSQL</strong>，以及 <strong>Jakarta EE 组件的实现</strong>：CDI、JSON 和 Eclipse MicroProfile 实现。</p>
<p>您可以找到完整的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsoujava%2Fbehavior-driven-development-oracle-nosql%2Fblob%2Fmain%2Fpom.xml" target="_blank" title="https://github.com/soujava/behavior-driven-development-oracle-nosql/blob/main/pom.xml" ref="nofollow noopener noreferrer"><code>pom.xml</code></a> 文件。</p>
<p>初始项目准备就绪后，我们将从创建测试开始。</p>
<p>请记住，BDD 是 TDD 的扩展，它包含了统一语言——领域和业务之间的共享词汇。</p>
<pre><code class="hljs language-textile" lang="textile">
功能: 管理酒店房间

  


场景: 注册一个新房间

假设 酒店管理系统正在运行

当 我注册一个号码为 203 的房间

那么 号码为 203 的房间应该出现在房间列表中

  


场景: 注册多个房间

假设 酒店管理系统正在运行

当 我注册以下房间:

| number | type | status | cleanStatus |

| 101 | STANDARD | AVAILABLE | CLEAN |

| 102 | SUITE | RESERVED | DIRTY |

| 103 | VIP_SUITE | UNDER_MAINTENANCE | CLEAN |

那么 系统中应该有 3 个可用房间

  


场景: 更改房间状态

假设 酒店管理系统正在运行

并且 一个号码为 101 的房间已注册为 AVAILABLE

当 我将房间 101 标记为 OUT_OF_SERVICE

那么 房间 101 应被标记为 OUT_OF_SERVICE

</code></pre>
<p>Maven 项目完成后，让我们进入下一步，即创建建模和存储库。如前所述，我们将专注于房间管理。因此，我们的下一个目标是确保之前定义的 BDD 测试通过。让我们从实现领域模型和存储库开始：</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">CleanStatus</span> {

CLEAN, <span class="hljs-comment">// 清洁</span>

DIRTY, <span class="hljs-comment">// 脏污</span>

INSPECTION_NEEDED <span class="hljs-comment">// 需要检查</span>

}

  


<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">RoomStatus</span> {

AVAILABLE, <span class="hljs-comment">// 可用</span>

RESERVED, <span class="hljs-comment">// 已预订</span>

UNDER_MAINTENANCE, <span class="hljs-comment">// 维护中</span>

OUT_OF_SERVICE <span class="hljs-comment">// 停止服务</span>

}

  


<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">RoomType</span> {

STANDARD, <span class="hljs-comment">// 标准间</span>

DELUXE, <span class="hljs-comment">// 豪华间</span>

SUITE, <span class="hljs-comment">// 套房</span>

VIP_SUITE <span class="hljs-comment">// VIP套房</span>

}

  


<span class="hljs-meta">@Entity</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Room</span> {

  


<span class="hljs-meta">@Id</span>

<span class="hljs-keyword">private</span> String id;

  


<span class="hljs-meta">@Column</span>

<span class="hljs-keyword">private</span> <span class="hljs-type">int</span> number; <span class="hljs-comment">// 房间号</span>

  


<span class="hljs-meta">@Column</span>

<span class="hljs-keyword">private</span> RoomType type; <span class="hljs-comment">// 房间类型</span>

  


<span class="hljs-meta">@Column</span>

<span class="hljs-keyword">private</span> RoomStatus status; <span class="hljs-comment">// 房间状态</span>

  


<span class="hljs-meta">@Column</span>

<span class="hljs-keyword">private</span> CleanStatus cleanStatus; <span class="hljs-comment">// 清洁状态</span>

  


<span class="hljs-meta">@Column</span>

<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> smokingAllowed; <span class="hljs-comment">// 允许吸烟</span>

  


<span class="hljs-meta">@Column</span>

<span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> underMaintenance; <span class="hljs-comment">// 处于维护状态</span>

  


}

</code></pre>
<p>有了模型，下一步是创建企业级 Java 与作为非关系型数据库的 Oracle NoSQL 之间的桥梁。我们可以使用 Jakarta Data 非常轻松地完成，它只有一个存储库接口，所以我们不需要担心实现。</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-meta">@Repository</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RoomRepository</span> {

  


<span class="hljs-meta">@Query("FROM Room")</span>

List&lt;Room&gt; <span class="hljs-title function_">findAll</span><span class="hljs-params">()</span>;

  


<span class="hljs-meta">@Save</span>

Room <span class="hljs-title function_">save</span><span class="hljs-params">(Room room)</span>;

  


<span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteBy</span><span class="hljs-params">()</span>;

  


Optional&lt;Room&gt; <span class="hljs-title function_">findByNumber</span><span class="hljs-params">(Integer number)</span>;

}

</code></pre>
<p>项目完成后，下一步是准备测试环境，首先提供一个数据库实例用于测试。多亏了 Testcontainers，我们可以轻松启动一个隔离的 Oracle NoSQL 实例来运行我们的测试。</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">DatabaseContainer</span> {

  


INSTANCE;

  


<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> GenericContainer&lt;?&gt; container = <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenericContainer</span>&lt;&gt;

(DockerImageName.parse(<span class="hljs-string">"ghcr.io/oracle/nosql:latest-ce"</span>))

.withExposedPorts(<span class="hljs-number">8080</span>);

  


{

container.start();

}

<span class="hljs-keyword">public</span> DatabaseManager <span class="hljs-title function_">get</span><span class="hljs-params">(String database)</span> {

<span class="hljs-type">DatabaseManagerFactory</span> <span class="hljs-variable">factory</span> <span class="hljs-operator">=</span> managerFactory();

<span class="hljs-keyword">return</span> factory.apply(database);

}

  


<span class="hljs-keyword">public</span> DatabaseManagerFactory <span class="hljs-title function_">managerFactory</span><span class="hljs-params">()</span> {

<span class="hljs-type">var</span> <span class="hljs-variable">configuration</span> <span class="hljs-operator">=</span> DatabaseConfiguration.getConfiguration();

<span class="hljs-type">Settings</span> <span class="hljs-variable">settings</span> <span class="hljs-operator">=</span> Settings.builder()

.put(OracleNoSQLConfigurations.HOST, host())

.build();

<span class="hljs-keyword">return</span> configuration.apply(settings);

}

  


<span class="hljs-keyword">public</span> String <span class="hljs-title function_">host</span><span class="hljs-params">()</span> {

<span class="hljs-keyword">return</span> <span class="hljs-string">"http://"</span> + container.getHost() + <span class="hljs-string">":"</span> + container.getFirstMappedPort();

}

}

</code></pre>
<p>之后，我们将创建一个与 <code>@Alternative</code> CDI 注解集成的生产者。此配置指导 CDI 如何提供数据库实例——在本例中是由 Testcontainers 管理的实例：</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-meta">@ApplicationScoped</span>

<span class="hljs-meta">@Alternative</span>

<span class="hljs-meta">@Priority(Interceptor.Priority.APPLICATION)</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ManagerSupplier</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Supplier</span>&lt;DatabaseManager&gt; {

  


<span class="hljs-meta">@Produces</span>

<span class="hljs-meta">@Database(DatabaseType.DOCUMENT)</span>

<span class="hljs-meta">@Default</span>

<span class="hljs-keyword">public</span> DatabaseManager <span class="hljs-title function_">get</span><span class="hljs-params">()</span> {

<span class="hljs-keyword">return</span> DatabaseContainer.INSTANCE.get(<span class="hljs-string">"hotel"</span>);

}

  


}

</code></pre>
<p>借助 Cucumber，我们可以定义一个将类注入到 Cucumber 测试上下文中的 ObjectFactory。由于我们使用 CDI 并以 Weld 作为实现，我们将创建一个自定义的 <code>WeldCucumberObjectFactory</code> 来无缝集成这两种技术。</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeldCucumberObjectFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ObjectFactory</span> {

  


<span class="hljs-keyword">private</span> Weld weld;

<span class="hljs-keyword">private</span> WeldContainer container;

  


<span class="hljs-meta">@Override</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> {

weld = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Weld</span>();

container = weld.initialize();

}

  


<span class="hljs-meta">@Override</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">()</span> {

<span class="hljs-keyword">if</span> (weld != <span class="hljs-literal">null</span>) {

weld.shutdown();

}

}

  


<span class="hljs-meta">@Override</span>

<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">addClass</span><span class="hljs-params">(Class&lt;?&gt; stepClass)</span> {

<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

}

  


<span class="hljs-meta">@Override</span>

<span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">getInstance</span><span class="hljs-params">(Class&lt;T&gt; type)</span> {

<span class="hljs-keyword">return</span> (T) container.select(type).get();

}

}

</code></pre>
<p>一个重要提示：此设置作为 SPI（服务提供者接口）工作。因此，您必须创建以下文件：</p>
<p><code>src/test/resources/META-INF/services/io.cucumber.core.backend.ObjectFactory</code></p>
<p>内容如下：</p>
<pre><code class="hljs language-shell" lang="shell">
org.soujava.demos.hotels.config.WeldCucumberObjectFactory

</code></pre>
<p>我们将让 Mapper 将我们的数据表转换为所有模型中的 Room 对象。</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-meta">@ApplicationScoped</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RoomDataTableMapper</span> {

  


<span class="hljs-meta">@DataTableType</span>

<span class="hljs-keyword">public</span> Room <span class="hljs-title function_">roomEntry</span><span class="hljs-params">(Map&lt;String, String&gt; entry)</span> {

<span class="hljs-keyword">return</span> Room.builder()

.number(Integer.parseInt(entry.get(<span class="hljs-string">"number"</span>)))

.type(RoomType.valueOf(entry.get(<span class="hljs-string">"type"</span>)))

.status(RoomStatus.valueOf(entry.get(<span class="hljs-string">"status"</span>)))

.cleanStatus(CleanStatus.valueOf(entry.get(<span class="hljs-string">"cleanStatus"</span>)))

.build();

}

}

</code></pre>
<p>整个测试基础设施完成后，下一步是设计包含我们实际测试的 Step 测试类。</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-meta">@ApplicationScoped</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HotelRoomSteps</span> {

  


<span class="hljs-meta">@Inject</span>

<span class="hljs-keyword">private</span> RoomRepository repository;

  


<span class="hljs-meta">@Before</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cleanDatabase</span><span class="hljs-params">()</span> {

repository.deleteBy();

}

  


<span class="hljs-meta">@Given("the hotel management system is operational")</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">theHotelManagementSystemIsOperational</span><span class="hljs-params">()</span> {

Assertions.assertThat(repository).as(<span class="hljs-string">"RoomRepository 应该已初始化"</span>).isNotNull();

}

  


<span class="hljs-meta">@When("I register a room with number {int}")</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">iRegisterARoomWithNumber</span><span class="hljs-params">(Integer number)</span> {

<span class="hljs-type">Room</span> <span class="hljs-variable">room</span> <span class="hljs-operator">=</span> Room.builder()

.number(number)

.type(RoomType.STANDARD)

.status(RoomStatus.AVAILABLE)

.cleanStatus(CleanStatus.CLEAN)

.build();

repository.save(room);

}

  


<span class="hljs-meta">@Then("the room with number {int} should appear in the room list")</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">theRoomWithNumberShouldAppearInTheRoomList</span><span class="hljs-params">(Integer number)</span> {

List&lt;Room&gt; rooms = repository.findAll();

Assertions.assertThat(rooms)

.extracting(Room::getNumber)

.contains(number);

}

  


<span class="hljs-meta">@When("I register the following rooms:")</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">iRegisterTheFollowingRooms</span><span class="hljs-params">(List&lt;Room&gt; rooms)</span> {

rooms.forEach(repository::save);

}

  


<span class="hljs-meta">@Then("there should be {int} rooms available in the system")</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">thereShouldBeRoomsAvailableInTheSystem</span><span class="hljs-params">(<span class="hljs-type">int</span> expectedCount)</span> {

List&lt;Room&gt; rooms = repository.findAll();

Assertions.assertThat(rooms).hasSize(expectedCount);

}

  


<span class="hljs-meta">@Given("a room with number {int} is registered as {word}")</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">aRoomWithNumberIsRegisteredAs</span><span class="hljs-params">(Integer number, String statusName)</span> {

<span class="hljs-type">RoomStatus</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> RoomStatus.valueOf(statusName);

<span class="hljs-type">Room</span> <span class="hljs-variable">room</span> <span class="hljs-operator">=</span> Room.builder()

.number(number)

.type(RoomType.STANDARD)

.status(status)

.cleanStatus(CleanStatus.CLEAN)

.build();

repository.save(room);

}

  


<span class="hljs-meta">@When("I mark the room {int} as {word}")</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">iMarkTheRoomAs</span><span class="hljs-params">(Integer number, String newStatusName)</span> {

<span class="hljs-type">RoomStatus</span> <span class="hljs-variable">newStatus</span> <span class="hljs-operator">=</span> RoomStatus.valueOf(newStatusName);

Optional&lt;Room&gt; roomOpt = repository.findByNumber(number);

  


Assertions.assertThat(roomOpt)

.as(<span class="hljs-string">"房间 %s 应该存在"</span>, number)

.isPresent();

  


<span class="hljs-type">Room</span> <span class="hljs-variable">updatedRoom</span> <span class="hljs-operator">=</span> roomOpt.orElseThrow();

updatedRoom.update(newStatus); <span class="hljs-comment">// 假设 Room 类有 update 方法</span>

  


repository.save(updatedRoom);

}

  


<span class="hljs-meta">@Then("the room {int} should be marked as {word}")</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">theRoomShouldBeMarkedAs</span><span class="hljs-params">(Integer number, String expectedStatusName)</span> {

<span class="hljs-type">RoomStatus</span> <span class="hljs-variable">expectedStatus</span> <span class="hljs-operator">=</span> RoomStatus.valueOf(expectedStatusName);

Optional&lt;Room&gt; roomOpt = repository.findByNumber(number);

  


Assertions.assertThat(roomOpt)

.as(<span class="hljs-string">"房间 %s 应该存在"</span>, number)

.isPresent()

.get()

.extracting(Room::getStatus)

.isEqualTo(expectedStatus);

}

}

</code></pre>
<p>是时候执行测试了：</p>
<pre><code class="hljs language-shell" lang="shell">
mvn clean test

</code></pre>
<p>您可以看到结果：</p>
<pre><code class="hljs language-shell" lang="shell">
INFO: Connecting to Oracle NoSQL database at http://localhost:61325 using ON_PREMISES deployment type

✔ Given the hotel management system is operational # org.soujava.demos.hotels.HotelRoomSteps.theHotelManagementSystemIsOperational()

✔ And a room with number 101 is registered as AVAILABLE # org.soujava.demos.hotels.HotelRoomSteps.aRoomWithNumberIsRegisteredAs(java.lang.Integer,java.lang.String)

✔ When I mark the room 101 as OUT_OF_SERVICE # org.soujava.demos.hotels.HotelRoomSteps.iMarkTheRoomAs(java.lang.Integer,java.lang.String)

✔ Then the room 101 should be marked as OUT_OF_SERVICE # org.soujava.demos.hotels.HotelRoomSteps.theRoomShouldBeMarkedAs(java.lang.Integer,java.lang.String)

Oct 21, 2025 6:18:43 PM org.jboss.weld.environment.se.WeldContainer shutdown

INFO: WELD-ENV-002001: Weld SE container fc4b3b51-fba8-4ea6-9cef-42bcee97d220 shut down

[INFO] Tests run: 4, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 7.231 s -- in org.soujava.demos.hotels.RunCucumberTest

[INFO] Running org.soujava.demos.hotels.MongoDBTest

[INFO] Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 0.007 s -- in org.soujava.demos.hotels.MongoDBTest

[INFO]

[INFO] Results:

[INFO]

[INFO] Tests run: 5, Failures: 0, Errors: 0, Skipped: 0

[INFO]

</code></pre>
<h2 data-id="heading-2">结论</h2>
<p>通过结合领域驱动设计（DDD）和行为驱动开发（BDD），开发人员可以超越技术正确性，构建真正反映业务意图的软件。DDD 为领域提供了结构，确保模型精确地捕捉现实世界的概念，而 BDD 则通过用业务本身的语言编写的清晰、可测试的场景，确保这些模型按预期运行。</p>
<p>在本文中，您学习了如何使用 Oracle NoSQL、Eclipse JNoSQL 和 Jakarta EE 连接这两个世界——从定义您的领域到运行由 Cucumber 和 CDI 支持的真实行为测试。这种协同作用将测试转化为活文档，弥合了工程师和利益相关者之间的差距，并确保您的系统在演进过程中始终与业务目标保持一致。</p>
<p>您可以深入探索并将 DDD 与 BDD 结合起来。在<a href="https://link.juejin.cn?target=https%3A%2F%2Fbpbonline.com%2Fproducts%2Fdomain-driven-design-with-java" target="_blank" title="https://bpbonline.com/products/domain-driven-design-with-java" ref="nofollow noopener noreferrer">《Domain-Driven Design with Java》</a>这本书中，您可以找到一个很好的起点来理解为什么 DDD 对我们仍然很重要。它扩展了这里分享的想法，展示了 DDD 和 BDD 如何共同带来更简单、更易维护且以业务为中心的软件。这种软件交付的是超越需求的实际价值。</p>
<hr/>
<p>【注】本文译自：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdzone.com%2Farticles%2Fdomain-driven-design-enterprise-java" target="_blank" title="https://dzone.com/articles/domain-driven-design-enterprise-java" ref="nofollow noopener noreferrer">Applying Domain-Driven Design With Enterprise Java: A Behavior-Driven Approach</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[DongSQL数据库内核V1.1.0介绍]]></title>    <link>https://juejin.cn/post/7577439614953652276</link>    <guid>https://juejin.cn/post/7577439614953652276</guid>    <pubDate>2025-11-28T08:13:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577439614953652276" data-draft-id="7577395040593264650" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="DongSQL数据库内核V1.1.0介绍"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-28T08:13:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东零售技术"/> <meta itemprop="url" content="https://juejin.cn/user/4233576972293643"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            DongSQL数据库内核V1.1.0介绍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4233576972293643/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东零售技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T08:13:37.000Z" title="Fri Nov 28 2025 08:13:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p><strong>京东零售数据库团队持续多年深耕数据库技术领域</strong>，团队于今年(2025.9)打磨出了深度优化的自研数据库内核——DongSQL V1.1.0。</p>
<p><em>[如果对前因后果比较感兴趣，可以移步上一篇文章</em><a href="https://link.juejin.cn?target=http%3A%2F%2Fsd.jd.com%2Farticle%2F47706%3FshareId%3D52009%26isHideShareButton%3D1" target="_blank" title="http://sd.jd.com/article/47706?shareId=52009&amp;isHideShareButton=1" ref="nofollow noopener noreferrer"> <em>《宝剑锋从磨砺出——零售数据库内核，为大促铸剑！》</em> </a><em>]</em></p>
<p>本文将深度解析DongSQL在语法扩展、并发控制、查询优化等方面的内核改造，以及在电商场景下的优化实践。</p>
<p><img src="" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">1、DongSQL在语法扩展上的优化</h2>
<h3 data-id="heading-2">1.1. RETURNING子句功能</h3>
<p><strong>▶︎ 语法扩展创新</strong>：DongSQL在标准SQL语法基础上扩展了RETURNING子句，这是重要语法创新。RETURNING子句允许DML语句(INSERT、UPDATE、DELETE、REPLACE)在执行数据修改操作的同时返回受影响的行数据，无需额外查询。</p>
<p>传统数据库在执行DML操作后，如果需要获取操作结果，必须执行额外的SELECT查询，这在高并发场景下会产生额外的网络往返开销。DongSQL通过RETURNING子句彻底解决了这一问题。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- INSERT操作返回自增ID</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders (customer_id, order_date) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1001</span>, NOW()) RETURNING order_id;

<span class="hljs-comment">-- UPDATE操作返回更新后的数据</span>
<span class="hljs-keyword">UPDATE</span> products <span class="hljs-keyword">SET</span> price <span class="hljs-operator">=</span> price <span class="hljs-operator">*</span> <span class="hljs-number">1.1</span> <span class="hljs-keyword">WHERE</span> category <span class="hljs-operator">=</span> <span class="hljs-string">'electronics'</span> 
RETURNING product_id, name, old_price, price;

<span class="hljs-comment">-- DELETE操作返回被删除的记录</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> expired_sessions <span class="hljs-keyword">WHERE</span> expire_time <span class="hljs-operator">&lt;</span> NOW() 
RETURNING session_id, user_id, expire_time;
</code></pre>
<p><strong>▶︎ 性能提升效果</strong>：经测试验证，RETURNING子句在不同场景下都能带来显著的性能提升：</p>
<p>•<strong>固定行更新场景</strong>：16并发时TPS提升61%，响应时间降低44%</p>
<p>•<strong>随机行更新场景</strong>：128并发时TPS提升18%</p>
<p>•<strong>大规模更新测试</strong>：2000万次操作中平均TPS提升5-10%</p>
<p><img src="" alt="" loading="lazy"/></p>
<p><strong>▶︎ 生产落地预期</strong>：该功能与DongDAL发号器逻辑高度匹配，有望将发号器性能瓶颈大幅提升(DongDAL团队配套开发推进中)</p>
<h3 data-id="heading-3">1.2. Hint语法扩展</h3>
<p><strong>▶︎ 多样化Hint支持</strong>：DongSQL扩展了Hint语法体系，提供了针对电商场景的专用提示功能，包括并发控制、库存管理等领域特定的优化。</p>
<p><strong>▶︎ Inventory Hint</strong>：专门针对电商库存管理场景设计的提示语法，提供目标影响行数控制、自动提交/回滚等特性。</p>
<pre><code class="hljs language-ini" lang="ini">-- 库存扣减：确保只影响一行，成功自动提交，失败自动回滚
UPDATE /*+ TARGET_AFFECT_ROW(1) COMMIT_ON_SUCCESS ROLLBACK_ON_FAIL */
inventory SET <span class="hljs-attr">stock</span> = stock - <span class="hljs-number">5</span> 
WHERE <span class="hljs-attr">product_id</span> = <span class="hljs-number">1001</span> AND stock &gt;= <span class="hljs-number">5</span><span class="hljs-comment">;</span>
</code></pre>
<p><strong>▶︎ 性能提升数据</strong>：在16并发的库存扣减场景下，使用Inventory Hint比不使用hint性能提升215%。</p>
<p><img src="" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">2、DongSQL在并发控制上的优化</h2>
<h3 data-id="heading-5">2.1. CCL并发控制</h3>
<p><strong>▶︎ 多维度限流机制</strong>：DongSQL实现了CCL(Concurrency Control)并发控制功能，通过多维度的限流策略，有效解决电商秒杀场景下的热点数据访问问题。</p>
<p>传统数据库在面对高并发热点数据访问时，往往会因为激烈的锁竞争导致性能急剧下降，甚至系统雪崩。DongSQL的CCL通过智能排队机制，将无序的并发请求转换为有序处理，从根本上解决了这一问题。</p>
<p><strong>▶︎ 多维度控制策略</strong>：</p>
<p>•<strong>基于字段的限流</strong>：<code>ccl_queue_field(column_name, concurrency)</code>，对特定字段值进行并发控制</p>
<p>•<strong>基于值的限流</strong>：<code>ccl_queue_value(value, concurrency)</code>，对特定数据值进行精准限流</p>
<p>•<strong>基于SQL指纹的限流</strong>：<code>ccl_queue_digest(concurrency)</code>，对相同SQL模式进行统一管控</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 对商品ID为999的热门商品进行限流，并发度限制为5</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-comment">/*+ ccl_queue_value(999, 5) */</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> product_id <span class="hljs-operator">=</span> <span class="hljs-number">999</span>;

<span class="hljs-comment">-- 对库存扣减操作按商品ID进行限流</span>
<span class="hljs-keyword">UPDATE</span> <span class="hljs-comment">/*+ ccl_queue_field(product_id, 8) */</span> inventory <span class="hljs-keyword">SET</span> stock <span class="hljs-operator">=</span> stock <span class="hljs-operator">-</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> product_id <span class="hljs-operator">=</span> ?;

<span class="hljs-comment">-- 对相同SQL模式进行统一限流</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-comment">/*+ ccl_queue_digest(10) */</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> hot_products <span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
</code></pre>
<p><strong>▶︎ 性能突破数据</strong>：</p>
<p>•<strong>秒杀场景优化</strong>：在4096并发下，使用CCL限流后TPS从573提升至1337，性能提升133%</p>
<p>•<strong>系统稳定性</strong>：有效防止系统雪崩，将无序并发转换为有序处理</p>
<p>•<strong>热点缓解</strong>：通过队列机制显著降低热点数据的锁竞争</p>
<p><img src="" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">2.2. Statement Outline执行计划及自定义提示管理</h3>
<p><strong>▶︎ 企业级计划稳定性</strong>：DongSQL提供了Statement Outline功能，用于固化重要SQL的执行计划，防止因数据变化导致的计划不稳定问题。</p>
<p><strong>▶︎ 自定义Hint注入工具</strong>：包括但不限于上述秒杀、CCL限流场景的Hint，即使业务研发预期外的过载或者突发流量发生，应急情况下DBA也可以通过Statement Outline功能对问题SQL进行干预</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 为重要SQL固化执行计划</span>
<span class="hljs-keyword">CALL</span> dbms_outln.add_index_outline(
  <span class="hljs-string">'test_db'</span>, <span class="hljs-string">''</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'USE INDEX'</span>, <span class="hljs-string">'idx_status'</span>, <span class="hljs-string">''</span>,
  <span class="hljs-string">'SELECT * FROM orders WHERE status = "PAID"'</span>
);

<span class="hljs-comment">-- 为特定查询添加ccl_queue_digest限流hint，限制并发度为2</span>
<span class="hljs-keyword">CALL</span> dbms_outln.add_optimizer_outline(
  <span class="hljs-string">'test_db'</span>, <span class="hljs-string">''</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'/*+ ccl_queue_digest(2) */'</span>,
  <span class="hljs-string">'SELECT * FROM orders WHERE customer_id = 1001'</span>
);
</code></pre>
<p><strong>▶︎ 核心价值</strong>：</p>
<p>•<strong>性能稳定性</strong>：保障核心SQL性能不因数据变化而波动</p>
<p>•<strong>智能限流</strong>：支持基于SQL指纹的手动限流和自动限流(自动限流默认不开启，需要开启的业务需单独申请)</p>
<p>•<strong>企业级管理</strong>：提供生产级的执行计划管理能力</p>
<h2 data-id="heading-7">3、DongSQL在查询优化上的改进</h2>
<h3 data-id="heading-8">3.1. 单点查询优化</h3>
<p><strong>▶︎ 查询路径优化</strong>：DongSQL实现了单点查询bypass功能，针对主键等值查询这类高频简单查询，绕过部分SQL层处理逻辑，直接访问存储引擎，大幅提升查询性能。</p>
<p>电商场景中，商品详情查询、用户信息查询等基于主键的简单查询占据了很大比例。虽然这些查询逻辑简单，但在高并发下仍然消耗大量CPU资源。DongSQL的单点查询优化针对这一痛点进行了专项优化。</p>
<p><strong>▶︎ 性能提升数据</strong>：</p>
<p>•<strong>不同环境性能提升</strong>：容器环境提升20%，物理机环境提升30%</p>
<p>•<strong>高并发场景</strong>：当CPU达到瓶颈时，QPS提升20-28%</p>
<p>•<strong>资源效率</strong>：相同硬件配置下处理能力显著提升</p>
<p><img src="" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">3.2. 线程池优化</h3>
<p><strong>▶︎ 高并发处理能力</strong>：DongSQL实现了企业级线程池功能，通过智能线程调度和资源管理，显著提升了系统在高并发场景下的处理能力和稳定性。</p>
<p>传统数据库在面对大量并发连接时，会为每个连接创建独立线程，这在高并发下会导致线程切换开销过大、内存消耗激增等问题。DongSQL的线程池优化通过复用线程资源，有效解决了这些问题。</p>
<p><strong>▶︎ 调度机制</strong>：</p>
<p>•<strong>线程复用：</strong> 通过线程池复用减少线程创建销毁开销</p>
<p>•<strong>负载均衡：</strong> 分配任务到不同线程，避免热点线程</p>
<p>•<strong>优先级调度：</strong> 支持任务优先级，保障重要业务优先处理</p>
<p><strong>▶︎ 性能突破数据</strong>（基于8C32G测试环境，sysbench 16张表每张1000万行数据）：</p>
<p><strong>只读场景性能对比</strong>：</p>
<p>•<strong>低并发优势</strong>：32线程时，线程池模式QPS达到141,261，相比传统模式的110,658提升27.6%</p>
<p>•<strong>高并发稳定性</strong>：在512线程高并发下，线程池模式QPS保持131,939，而传统模式仅61,580，性能提升114%</p>
<p>•<strong>延迟控制</strong>：512线程时TP99延迟从传统模式的297.92ms优化到118.92ms，降低60%</p>
<p><strong>纯写场景性能突破</strong>：</p>
<p>•<strong>中等并发</strong>：64线程时QPS从46,577提升到57,655，性能提升23.8%</p>
<p>•<strong>高并发场景</strong>：512线程时QPS从29,541提升到58,166，性能提升97%</p>
<p>•<strong>超高并发</strong>：4096线程时QPS从28,571提升到54,687，性能提升91%</p>
<p><strong>读写混合场景优化</strong>：</p>
<p>•<strong>128线程</strong>：QPS从54,870提升到80,244，性能提升46%</p>
<p>•<strong>256线程</strong>：QPS从48,787提升到77,961，性能提升60%</p>
<p>•<strong>延迟优化</strong>：256线程时TP99延迟从196.89ms优化到158.63ms，降低19%</p>
<p><img src="" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">3.3. 其他查询执行优化</h3>
<p><strong>▶︎ 执行路径优化</strong>：DongSQL在查询执行引擎层面进行了多项优化，包括算子优化、内存管理优化、并行执行优化等。</p>
<p><strong>▶︎ 缓存机制增强</strong>：优化了Buffer Pool管理策略，页面mutex优化，提升了数据访问效率，降低了I/O锁冲突。</p>
<h2 data-id="heading-11">4、性能基准测试汇总</h2>
<h3 data-id="heading-12">OLTP标准基准测试</h3>
<p>基于标准测试环境的性能数据（16C32G, 16张表，每张表100万行）：</p>





















































<table><thead><tr><th>测试场景</th><th>最佳线程数</th><th>TPS</th><th>QPS</th><th>TP99延迟</th><th>平均延迟</th></tr></thead><tbody><tr><td>只读查询</td><td>64</td><td>19,484</td><td>311,745</td><td>21.50ms</td><td>3.28ms</td></tr><tr><td>只写操作</td><td>256</td><td>17,004</td><td>102,025</td><td>29.72ms</td><td>15.05ms</td></tr><tr><td>插入操作</td><td>256</td><td>25,614</td><td>25,614</td><td>15.83ms</td><td>9.99ms</td></tr><tr><td>读写混合</td><td>128</td><td>9,795</td><td>195,908</td><td>33.12ms</td><td>13.06ms</td></tr><tr><td>点查询</td><td>64</td><td>560,933</td><td>560,933</td><td>0.18ms</td><td>0.11ms</td></tr></tbody></table>
<h3 data-id="heading-13">电商场景专项性能汇总</h3>



































<table><thead><tr><th>优化模块</th><th>测试场景</th><th>性能提升幅度</th><th>关键指标</th></tr></thead><tbody><tr><td><strong>RETURNING子句</strong></td><td>固定行更新</td><td><strong>61%</strong></td><td>TPS: 925→1,490</td></tr><tr><td><strong>CCL并发控制</strong></td><td>秒杀场景</td><td><strong>133%</strong></td><td>TPS: 573→1,337</td></tr><tr><td><strong>Inventory Hint</strong></td><td>库存扣减</td><td><strong>215%</strong></td><td>TPS: 1,537→4,843</td></tr><tr><td><strong>单点查询优化</strong></td><td>主键查询</td><td><strong>28%</strong></td><td>QPS: 76,432→98,470</td></tr></tbody></table>
<h2 data-id="heading-14">5、未来规划</h2>
<p>1.<strong>持续语法扩展</strong>：基于业务需求继续扩展SQL语法功能</p>
<p>2.<strong>智能优化增强</strong>：引入机器学习优化执行计划选择</p>
<p>3.<strong>内核级技术支持</strong>：具备内核研发能力的团队，持续从最底层为业务研发提供深度优化的数据库解决方案</p>
<p>4.<strong>云原生存算分离</strong>：继续打造属于京东自己的高性能低成本数据库产品</p>
<h2 data-id="heading-15">6、结语</h2>
<p>从开源内核到自研DongSQL，京东零售数据库团队始终以"业务价值驱动技术创新"为核心理念。DongSQL作为专为京东电商场景设计的数据库，通过语法扩展、并发控制、查询优化等多个模块的深度创新，为电商业务的快速发展提供了强有力的数据库技术支撑。</p>
<p>这些优化不仅提升了系统性能，更重要的是为集团基础技术底座提供了坚实的基础。未来，京东零售数据库团队将持续深耕数据库内核技术，让数据库更好地服务业务发展。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从0到1用Go撸一个AI应用？Eino框架让你效率翻倍！]]></title>    <link>https://juejin.cn/post/7577239264308822016</link>    <guid>https://juejin.cn/post/7577239264308822016</guid>    <pubDate>2025-11-27T10:07:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577239264308822016" data-draft-id="7577229187896246307" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从0到1用Go撸一个AI应用？Eino框架让你效率翻倍！"/> <meta itemprop="keywords" content="后端,Go"/> <meta itemprop="datePublished" content="2025-11-27T10:07:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码一行"/> <meta itemprop="url" content="https://juejin.cn/user/2963939081856328"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从0到1用Go撸一个AI应用？Eino框架让你效率翻倍！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2963939081856328/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码一行
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T10:07:21.000Z" title="Thu Nov 27 2025 10:07:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为Go开发者，你是否也曾羡慕Python生态里层出不穷的LLM框架？从LangChain到LlamaIndex，Python开发者总能轻松搭起AI应用的骨架。但现在，Go开发者也有了专属的终极解决方案——Eino框架！</p>
<h2 data-id="heading-0">Go AI应用开发的进化之路</h2>
<p>回顾Go语言在AI领域的应用历程，大致可分为三个阶段：</p>
<p><strong>1. 原生API调用阶段</strong></p>
<p>早期开发者只能直接调用OpenAI等平台的HTTP API，手写请求签名、处理流式响应，代码充斥着大量重复的网络请求逻辑。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 原始API调用示例</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">callOpenAI</span><span class="hljs-params">(prompt <span class="hljs-type">string</span>)</span></span> (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) {
    reqBody := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>{}{
        <span class="hljs-string">"model"</span>: <span class="hljs-string">"gpt-3.5-turbo"</span>,
        <span class="hljs-string">"messages"</span>: []<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>{
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt},
        },
    }
    <span class="hljs-comment">// 手动处理HTTP请求、签名、序列化...</span>
    <span class="hljs-comment">// 大量模板代码占用开发精力</span>
}
</code></pre>
<p><strong>2. 基础工具库阶段</strong></p>
<p>社区出现了一些封装API的工具库，但缺乏统一标准，组件间难以协同，复杂流程编排仍需手动实现。</p>
<p><strong>3. 全功能框架阶段</strong></p>
<p>随着Eino的出现，Go终于有了专为LLM应用设计的完整框架，提供组件化、流程编排、类型安全等企业级能力。</p>
<h2 data-id="heading-1">Eino：Go生态的LLM应用开发利器</h2>
<p>Eino（发音类似"I know"）是CloudWeGo团队推出的Go语言LLM应用开发框架，借鉴了LangChain等框架的优秀思想，同时深度贴合Go语言特性。</p>
<p>它的核心价值在于：</p>
<ul>
<li>
<p>标准化组件抽象：模型、工具、检索器等组件即插即用</p>
</li>
<li>
<p>强大的编排能力：处理类型检查、流式响应、并发管理等复杂问题</p>
</li>
<li>
<p>简洁API设计：符合Go开发者的使用习惯</p>
</li>
<li>
<p>丰富最佳实践：内置流程模板和示例代码</p>
</li>
<li>
<p>全生命周期工具：从开发调试到监控评估一应俱全</p>
<ul>
<li/>
</ul>
</li>
</ul>
<h2 data-id="heading-2">快速上手：30行代码实现智能问答</h2>
<p>让我们用Eino快速实现一个简单的AI问答应用，体验其简洁高效的开发模式。</p>
<h3 data-id="heading-3">1. 安装依赖</h3>
<pre><code class="hljs language-arduino" lang="arduino">go get github.com/cloudwego/eino
go get github.com/cloudwego/eino-ext
</code></pre>
<h3 data-id="heading-4">2. 基础问答示例</h3>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"context"</span>
    <span class="hljs-string">"fmt"</span>
    
    <span class="hljs-string">"github.com/cloudwego/eino"</span>
    <span class="hljs-string">"github.com/cloudwego/eino/components/model"</span>
    <span class="hljs-string">"github.com/cloudwego/eino-ext/model/openai"</span>
    <span class="hljs-string">"github.com/cloudwego/eino/schema"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    ctx := context.Background()
    
    <span class="hljs-comment">// 1. 配置OpenAI模型</span>
    config := &amp;openai.ChatConfig{
        APIKey: <span class="hljs-string">"your-api-key"</span>,
        Model:  <span class="hljs-string">"gpt-3.5-turbo"</span>,
    }
    
    <span class="hljs-comment">// 2. 创建模型实例</span>
    chatModel, err := openai.NewChatModel(ctx, config)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-built_in">panic</span>(err)
    }
    
    <span class="hljs-comment">// 3. 生成回答</span>
    message, err := chatModel.Generate(ctx, []*schema.Message{
        schema.SystemMessage(<span class="hljs-string">"你是一个Go开发者助手，用简洁的语言回答问题"</span>),
        schema.UserMessage(<span class="hljs-string">"如何用Go实现一个简单的LLM客户端？"</span>),
    })
    
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-built_in">panic</span>(err)
    }
    
    fmt.Println(<span class="hljs-string">"AI回答："</span>, message.Content)
}
</code></pre>
<h3 data-id="heading-5">3. 进阶：使用Chain编排复杂流程</h3>
<p>当需求变得复杂时，Eino的Chain编排能力就能派上用场。比如实现"提示模板→LLM调用"的流水线：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">func</span> <span class="hljs-selector-tag">main</span>() {
    ctx := context.<span class="hljs-attribute">Background()
    
    // 1. 创建模型
    chatModel, _ </span>:= openai.<span class="hljs-built_in">NewChatModel</span>(ctx, &amp;openai.ChatConfig{
        <span class="hljs-attribute">APIKey</span>: <span class="hljs-string">"your-api-key"</span>,
        <span class="hljs-attribute">Model</span>:  <span class="hljs-string">"gpt-3.5-turbo"</span>,
    })
    
    <span class="hljs-comment">// 2. 创建提示模板</span>
    <span class="hljs-attribute">promptTpl </span>:= prompt.<span class="hljs-built_in">FromMessages</span>(
        schema.Jinja2,
        schema.<span class="hljs-built_in">SystemMessage</span>(<span class="hljs-string">"你是{{role}}，请回答：{{question}}"</span>),
    )
    
    <span class="hljs-comment">// 3. 构建Chain</span>
    chain, <span class="hljs-attribute">_ </span>:= compose.NewChain[map[string]any, *schema.Message]().
        <span class="hljs-built_in">AppendChatTemplate</span>(promptTpl).
        <span class="hljs-built_in">AppendChatModel</span>(chatModel).
        <span class="hljs-built_in">Compile</span>(ctx)
    
    <span class="hljs-comment">// 4. 执行Chain</span>
    result, <span class="hljs-attribute">_ </span>:= chain.<span class="hljs-built_in">Invoke</span>(ctx, map[string]any{
        <span class="hljs-string">"role"</span>:     <span class="hljs-string">"Go专家"</span>,
        <span class="hljs-string">"question"</span>: <span class="hljs-string">"Go 1.21版本有哪些重要更新？"</span>,
    })
    
    fmt.<span class="hljs-built_in">Println</span>(result.Content)
}
</code></pre>
<h3 data-id="heading-6">4. 工具调用示例</h3>
<p>Eino内置了工具调用能力，让AI可以调用外部函数获取信息：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 定义一个天气查询工具</span>
<span class="hljs-keyword">type</span> WeatherTool <span class="hljs-keyword">struct</span>{}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *WeatherTool)</span></span> Info(ctx context.Context) (*schema.ToolInfo, <span class="hljs-type">error</span>) {
    <span class="hljs-keyword">return</span> &amp;schema.ToolInfo{
        Name: <span class="hljs-string">"get_weather"</span>,
        Desc: <span class="hljs-string">"查询指定城市的天气"</span>,
        ParamsOneOf: schema.NewParamsOneOfByParams(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]*schema.ParameterInfo{
            <span class="hljs-string">"city"</span>: {
                Desc:     <span class="hljs-string">"城市名称"</span>,
                Required: <span class="hljs-literal">true</span>,
                Type:     schema.String,
            },
        }),
    }, <span class="hljs-literal">nil</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(w *WeatherTool)</span></span> InvokableRun(ctx context.Context, args <span class="hljs-type">string</span>) (<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) {
    <span class="hljs-comment">// 实际实现调用天气API的逻辑</span>
    <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">"城市%s的天气是晴朗，25℃"</span>, args), <span class="hljs-literal">nil</span>
}

<span class="hljs-comment">// 在Agent中使用工具</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    ctx := context.Background()
    
    <span class="hljs-comment">// 创建模型</span>
    model, _ := openai.NewChatModel(ctx, &amp;openai.ChatConfig{
        APIKey: <span class="hljs-string">"your-api-key"</span>,
    })
    
    <span class="hljs-comment">// 创建工具</span>
    weatherTool := &amp;WeatherTool{}
    
    <span class="hljs-comment">// 配置Agent</span>
    agent, _ := adk.NewChatModelAgent(ctx, &amp;adk.ChatModelAgentConfig{
        Name:        <span class="hljs-string">"weather_agent"</span>,
        Description: <span class="hljs-string">"查询天气的智能助手"</span>,
        Model:       model,
        ToolsConfig: adk.ToolsConfig{
            ToolsNodeConfig: compose.ToolsNodeConfig{
                Tools: []tool.Tool{weatherTool},
            },
        },
    })
    
    <span class="hljs-comment">// 运行Agent</span>
    input := &amp;adk.AgentInput{
        Messages: []*schema.Message{
            schema.UserMessage(<span class="hljs-string">"北京今天的天气怎么样？"</span>),
        },
    }
    
    iter := agent.Run(ctx, input)
    <span class="hljs-keyword">for</span> iter.Next(ctx) {
        event := iter.Value()
        <span class="hljs-keyword">if</span> event.Output != <span class="hljs-literal">nil</span> &amp;&amp; event.Output.MessageOutput != <span class="hljs-literal">nil</span> {
            msg, _ := event.Output.MessageOutput.GetMessage()
            fmt.Println(<span class="hljs-string">"AI回复："</span>, msg.Content)
        }
    }
}
</code></pre>
<h2 data-id="heading-7">Eino框架架构解析</h2>
<p>Eino采用模块化设计，主要包含以下部分：</p>
<ul>
<li>
<p><strong>核心框架（eino）</strong> ：类型定义、流处理、组件抽象、编排功能</p>
</li>
<li>
<p><strong>扩展组件（eino-ext）</strong> ：各类组件的具体实现，如OpenAI模型、工具等</p>
</li>
<li>
<p><strong>DevOps工具</strong>：可视化开发、调试工具</p>
</li>
<li>
<p><strong>示例代码（eino-examples）</strong> ：最佳实践参考</p>
<ul>
<li/>
</ul>
</li>
</ul>
<p>这种架构让开发者可以根据需求灵活选择组件，同时保证了框架的可扩展性。</p>
<h2 data-id="heading-8">为什么选择Eino？</h2>
<ol>
<li>
<p><strong>类型安全</strong>：Go的静态类型特性结合Eino的类型检查，减少运行时错误</p>
</li>
<li>
<p><strong>性能优势</strong>：Go的并发模型特别适合处理LLM的流式响应</p>
</li>
<li>
<p><strong>企业级支持</strong>：CloudWeGo团队背书，适合生产环境使用</p>
</li>
<li>
<p><strong>生态融合</strong>：可与Kitex、Hertz等CloudWeGo项目无缝集成</p>
</li>
<li>
<p><strong>持续迭代</strong>：活跃的开发团队不断优化功能</p>
<ol>
<li/>
</ol>
</li>
</ol>
<h2 data-id="heading-9">开始使用Eino</h2>
<ul>
<li>
<p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcloudwego%2Feino" target="_blank" title="https://github.com/cloudwego/eino" ref="nofollow noopener noreferrer">github.com/cloudwego/e…</a></p>
</li>
<li>
<p>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cloudwego.io%2Fzh%2Fdocs%2Feino%2F" target="_blank" title="https://www.cloudwego.io/zh/docs/eino/" ref="nofollow noopener noreferrer">www.cloudwego.io/zh/docs/ein…</a></p>
</li>
<li>
<p>快速入门：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cloudwego.io%2Fzh%2Fdocs%2Feino%2Fquick_start%2F" target="_blank" title="https://www.cloudwego.io/zh/docs/eino/quick_start/" ref="nofollow noopener noreferrer">www.cloudwego.io/zh/docs/ein…</a></p>
<ul>
<li/>
</ul>
</li>
</ul>
<p>如果你是Go开发者，想要快速构建可靠的LLM应用，Eino绝对值得一试。现在就克隆仓库，开始你的Go AI开发之旅吧！</p>
<p>欢迎在评论区分享你用Go开发AI应用的经验，或者对Eino框架的期待~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[探秘新一代向量存储格式Lance-format (一)Lance 项目概览与设计理念]]></title>    <link>https://juejin.cn/post/7576935292427567146</link>    <guid>https://juejin.cn/post/7576935292427567146</guid>    <pubDate>2025-11-27T01:49:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576935292427567146" data-draft-id="7576923573777596458" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="探秘新一代向量存储格式Lance-format (一)Lance 项目概览与设计理念"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-11-27T01:49:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="语落心生"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147955741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            探秘新一代向量存储格式Lance-format (一)Lance 项目概览与设计理念
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147955741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    语落心生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T01:49:02.000Z" title="Thu Nov 27 2025 01:49:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第一章：Lance 项目概览与设计理念</h2>
<h3 data-id="heading-1">核心概览</h3>
<p>Lance 是一个面向多模态 AI 工作流的列式数据格式。它解决的根本问题是：<strong>如何在统一的存储格式中，高效地支持向量搜索、随机访问、SQL 查询和多模态数据存储</strong>。</p>
<p>想象您在构建一个视频推荐系统：</p>
<ul>
<li>需要存储视频元数据（标题、描述、标签）</li>
<li>需要存储视频的向量嵌入用于相似度搜索</li>
<li>需要存储原始视频数据（BLOB）</li>
<li>需要在这些数据上执行复杂的 SQL 查询和向量搜索</li>
</ul>
<p>Lance 就是为这样的场景设计的。</p>
<h3 data-id="heading-2">Lance 主架构设计</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "应用层 Application Layer"
        A1["Python API&lt;br/&gt;(PyLance)"]
        A2["Java API&lt;br/&gt;(JNI)"]
        A3["Rust API"]
    end
    
    subgraph "查询引擎层 Query Engine"
        B1["DataFusion 集成&lt;br/&gt;lance-datafusion"]
        B2["SQL 查询&lt;br/&gt;解析与规划"]
        B3["Scanner&lt;br/&gt;查询执行"]
    end
    
    subgraph "数据集层 Dataset Layer"
        C1["Dataset&lt;br/&gt;版本管理"]
        C2["Transaction&lt;br/&gt;事务处理"]
        C3["Fragment&lt;br/&gt;数据分片"]
        C4["Schema&lt;br/&gt;演化管理"]
    end
    
    subgraph "索引层 Index Layer"
        D1["向量索引&lt;br/&gt;IVF/HNSW/FLAT"]
        D2["标量索引&lt;br/&gt;BTree/Bitmap"]
        D3["全文索引&lt;br/&gt;Tantivy"]
    end
    
    subgraph "表管理层 Table Layer"
        E1["Manifest&lt;br/&gt;lance-table"]
        E2["Commit 协议&lt;br/&gt;版本控制"]
        E3["RowID 系统&lt;br/&gt;行地址管理"]
    end
    
    subgraph "存储层 Storage Layer"
        F1["文件格式&lt;br/&gt;lance-file"]
        F2["编码器&lt;br/&gt;lance-encoding"]
        F3["IO 调度&lt;br/&gt;lance-io"]
    end
    
    subgraph "核心层 Core Layer"
        G1["类型系统&lt;br/&gt;lance-core"]
        G2["缓存管理"]
        G3["Arrow 集成&lt;br/&gt;lance-arrow"]
    end
    
    subgraph "对象存储 Object Storage"
        H1["S3"]
        H2["Azure Blob"]
        H3["GCS"]
        H4["本地文件系统"]
    end
    
    A1 --&gt; B1
    A2 --&gt; B1
    A3 --&gt; C1
    B1 --&gt; B3
    B2 --&gt; B1
    B3 --&gt; C1
    C1 --&gt; C2
    C1 --&gt; C3
    C1 --&gt; C4
    C1 --&gt; D1
    C1 --&gt; D2
    C3 --&gt; E1
    C2 --&gt; E2
    C1 --&gt; E3
    D1 --&gt; F1
    D2 --&gt; F1
    D3 --&gt; F1
    E1 --&gt; F1
    E2 --&gt; F1
    E3 --&gt; F1
    F1 --&gt; F2
    F1 --&gt; F3
    F2 --&gt; G1
    F3 --&gt; G1
    G1 --&gt; G3
    F3 --&gt; H1
    F3 --&gt; H2
    F3 --&gt; H3
    F3 --&gt; H4
</code></pre>
<h3 data-id="heading-3">核心功能时序图</h3>
<h4 data-id="heading-4">1. 数据写入流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User
    participant Dataset
    participant Transaction
    participant Writer
    participant Encoder
    participant ObjectStore
    participant Manifest
    
    User-&gt;&gt;Dataset: write_dataset(data, uri)
    Dataset-&gt;&gt;Transaction: begin_transaction()
    Transaction-&gt;&gt;Writer: create_writer(schema)
    
    loop 每个 RecordBatch
        Writer-&gt;&gt;Encoder: encode_batch(batch)
        Encoder-&gt;&gt;Encoder: 选择编码方式
        Encoder-&gt;&gt;ObjectStore: write_data_file()
        ObjectStore--&gt;&gt;Encoder: 确认写入
    end
    
    Writer-&gt;&gt;Dataset: 返回 Fragments
    Dataset-&gt;&gt;Manifest: create_new_version()
    Manifest-&gt;&gt;ObjectStore: write_manifest()
    Dataset-&gt;&gt;Transaction: commit()
    Transaction-&gt;&gt;ObjectStore: 原子性提交
    Transaction--&gt;&gt;User: 返回新版本
</code></pre>
<h4 data-id="heading-5">2. 数据扫描流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User
    participant Scanner
    participant Dataset
    participant Fragment
    participant FileReader
    participant Decoder
    participant Cache
    
    User-&gt;&gt;Scanner: scan().project([columns])
    Scanner-&gt;&gt;Scanner: build_execution_plan()
    Scanner-&gt;&gt;Dataset: get_fragments()
    Dataset--&gt;&gt;Scanner: Fragment列表
    
    loop 每个 Fragment
        Scanner-&gt;&gt;Fragment: open_reader()
        Fragment-&gt;&gt;FileReader: create_reader()
        FileReader-&gt;&gt;Cache: check_cache()
        
        alt 缓存命中
            Cache--&gt;&gt;FileReader: 返回缓存数据
        else 缓存未命中
            FileReader-&gt;&gt;Decoder: decode_page()
            Decoder-&gt;&gt;Decoder: 解压与解码
            Decoder--&gt;&gt;FileReader: RecordBatch
            FileReader-&gt;&gt;Cache: store_cache()
        end
        
        FileReader--&gt;&gt;Scanner: RecordBatch
    end
    
    Scanner--&gt;&gt;User: Stream&lt;RecordBatch&gt;
</code></pre>
<h4 data-id="heading-6">3. 向量索引创建流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User
    participant Dataset
    participant IndexBuilder
    participant KMeans
    participant Quantizer
    participant IVFStorage
    participant ObjectStore
    
    User-&gt;&gt;Dataset: create_index(column, IVF_PQ)
    Dataset-&gt;&gt;IndexBuilder: build_index()
    IndexBuilder-&gt;&gt;Dataset: scan_vectors()
    Dataset--&gt;&gt;IndexBuilder: 向量数据流
    
    IndexBuilder-&gt;&gt;KMeans: train_centroids(vectors, k)
    KMeans-&gt;&gt;KMeans: 迭代聚类
    KMeans--&gt;&gt;IndexBuilder: 质心列表
    
    IndexBuilder-&gt;&gt;Quantizer: train_pq(vectors)
    Quantizer-&gt;&gt;Quantizer: 学习 codebooks
    Quantizer--&gt;&gt;IndexBuilder: PQ 模型
    
    IndexBuilder-&gt;&gt;IndexBuilder: assign_to_partitions()
    
    loop 每个分区
        IndexBuilder-&gt;&gt;Quantizer: quantize_vectors()
        Quantizer--&gt;&gt;IndexBuilder: PQ codes
        IndexBuilder-&gt;&gt;IVFStorage: write_partition()
        IVFStorage-&gt;&gt;ObjectStore: 持久化
    end
    
    IndexBuilder-&gt;&gt;Dataset: update_index_metadata()
    Dataset-&gt;&gt;ObjectStore: 更新 Manifest
    Dataset--&gt;&gt;User: 索引创建完成
</code></pre>
<h4 data-id="heading-7">4. 向量搜索流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User
    participant Scanner
    participant VectorIndex
    participant IVF
    participant Quantizer
    participant PostFilter
    participant Ranker
    
    User-&gt;&gt;Scanner: nearest(query, k=10)
    Scanner-&gt;&gt;VectorIndex: search(query_vector)
    
    VectorIndex-&gt;&gt;IVF: compute_distances_to_centroids()
    IVF--&gt;&gt;VectorIndex: 排序的分区列表
    
    VectorIndex-&gt;&gt;VectorIndex: select_nprobes(nprobes)
    
    loop 对于每个选中的分区
        VectorIndex-&gt;&gt;IVF: load_partition()
        IVF-&gt;&gt;Quantizer: approximate_distances()
        Quantizer--&gt;&gt;IVF: 近似距离列表
        IVF-&gt;&gt;Ranker: add_candidates()
    end
    
    Ranker-&gt;&gt;Ranker: top_k_selection()
    Ranker-&gt;&gt;PostFilter: refine_distances()
    PostFilter-&gt;&gt;PostFilter: 计算精确距离
    PostFilter--&gt;&gt;Scanner: 最终 Top-K 结果
    Scanner--&gt;&gt;User: RecordBatch with scores
</code></pre>
<h4 data-id="heading-8">5. 事务提交流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Client
    participant Transaction
    participant CommitHandler
    participant DynamoDB
    participant ObjectStore
    participant Manifest
    
    Client-&gt;&gt;Transaction: commit_changes()
    Transaction-&gt;&gt;Transaction: validate_operations()
    Transaction-&gt;&gt;Manifest: build_new_manifest()
    Manifest--&gt;&gt;Transaction: manifest_data
    
    Transaction-&gt;&gt;CommitHandler: begin_commit()
    
    alt 使用 DynamoDB 锁
        CommitHandler-&gt;&gt;DynamoDB: acquire_lock(dataset_id)
        DynamoDB--&gt;&gt;CommitHandler: lock_acquired
    else 使用文件锁
        CommitHandler-&gt;&gt;ObjectStore: create_lock_file()
        ObjectStore--&gt;&gt;CommitHandler: lock_acquired
    end
    
    CommitHandler-&gt;&gt;ObjectStore: write_manifest(version_n)
    ObjectStore--&gt;&gt;CommitHandler: write_success
    
    CommitHandler-&gt;&gt;ObjectStore: update_latest_pointer()
    ObjectStore--&gt;&gt;CommitHandler: update_success
    
    alt 使用 DynamoDB 锁
        CommitHandler-&gt;&gt;DynamoDB: release_lock()
    else 使用文件锁
        CommitHandler-&gt;&gt;ObjectStore: delete_lock_file()
    end
    
    CommitHandler--&gt;&gt;Transaction: commit_success
    Transaction--&gt;&gt;Client: 返回新版本号
</code></pre>
<hr/>
<h3 data-id="heading-9">第一部分：Lance 的定位与应用场景</h3>
<h4 data-id="heading-10">What - Lance 是什么？</h4>
<p><strong>定义</strong>：Lance 是一个 Apache 许可的、开源的列式数据格式和表格式（Lakehouse Format）。</p>
<p>核心特点：</p>
<ul>
<li><strong>列式存储</strong>：按列而非行存储数据，适合分析型查询</li>
<li><strong>向量原生支持</strong>：内置向量索引和搜索能力</li>
<li><strong>多模态数据</strong>：支持图像、视频、音频、文本、向量等混合存储</li>
<li><strong>ACID 事务</strong>：支持原子性更新和版本控制</li>
</ul>
<h4 data-id="heading-11">Why - 为什么需要 Lance？</h4>
<h5 data-id="heading-12">问题背景</h5>
<p>传统数据格式存在的痛点：</p>















































<table><thead><tr><th>功能需求</th><th>Parquet</th><th>ORC</th><th>Iceberg</th><th>Lance</th></tr></thead><tbody><tr><td>随机访问速度</td><td>⭐</td><td>⭐</td><td>⭐⭐</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td>向量搜索支持</td><td>❌</td><td>❌</td><td>❌</td><td>✅</td></tr><tr><td>多模态支持</td><td>差</td><td>差</td><td>差</td><td>✅</td></tr><tr><td>Schema 演化</td><td>困难</td><td>困难</td><td>✅</td><td>✅</td></tr><tr><td>版本控制</td><td>需要外部系统</td><td>需要外部系统</td><td>✅</td><td>✅</td></tr></tbody></table>
<p><strong>为什么选择 Lance？</strong></p>
<ol>
<li><strong>100 倍随机访问速度提升</strong>：Parquet 为 100ns/随机访问，Lance 为 1ns，对于 ML 训练至关重要</li>
<li><strong>向量搜索加速</strong>：内置 IVF-PQ、HNSW 等索引，毫秒级查询</li>
<li><strong>零拷贝版本控制</strong>：无需数据复制即可实现版本管理和时间旅行</li>
<li><strong>多模态一体化</strong>：在同一格式中存储结构化数据和非结构化数据</li>
</ol>
<h4 data-id="heading-13">How - Lance 如何解决这些问题？</h4>
<h5 data-id="heading-14">核心设计原则</h5>
<pre><code class="hljs language-python" lang="python">┌─────────────────────────────────────────────────────────┐
│         Lance 的四大设计支柱                               │
├─────────────────────────────────────────────────────────┤
│ <span class="hljs-number">1</span>️⃣ 高效的列式存储                                        │
│    → 通过多种编码（Bitpacking、<span class="hljs-type">Dict</span>、RLE）最小化存储    │
│    → 支持快速列扫描和随机访问                            │
│                                                          │
│ <span class="hljs-number">2</span>️⃣ 向量原生能力                                         │
│    → 内置向量索引和量化技术                             │
│    → 支持混合搜索（向量+SQL）                            │
│                                                          │
│ <span class="hljs-number">3</span>️⃣ 灵活的版本管理                                       │
│    → Manifest + Fragment 设计                           │
│    → 无锁并发更新                                       │
│                                                          │
│ <span class="hljs-number">4</span>️⃣ 云原生架构                                          │
│    → 基于对象存储（S3/GCS/Azure）                       │
│    → 分布式计算友好                                     │
└─────────────────────────────────────────────────────────┘
</code></pre>
<hr/>
<h3 data-id="heading-15">第二部分：与其他格式的对比优势</h3>
<h4 data-id="heading-16">Parquet 与 Lance 的差异</h4>
<p><strong>场景 1：机器学习训练</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Parquet 的问题：需要顺序读取大部分数据</span>
<span class="hljs-comment"># 训练一个 1000 万行的数据集，但每次迭代只需要 100 行</span>
<span class="hljs-comment"># - 读取 Parquet：必须扫描整个文件，性能低</span>

<span class="hljs-comment"># Lance 的优势：支持随机行访问</span>
dataset = lance.<span class="hljs-built_in">open</span>(<span class="hljs-string">"features.lance"</span>)
<span class="hljs-comment"># 直接获取第 5000、8000、12000 行，无需全扫描</span>
rows = dataset.take([<span class="hljs-number">5000</span>, <span class="hljs-number">8000</span>, <span class="hljs-number">12000</span>])
</code></pre>
<p><strong>场景 2：多模态存储</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 需要存储：文本 + 图像向量 + 原始图像</span>
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> lance

df = pd.DataFrame({
    <span class="hljs-string">'text'</span>: [<span class="hljs-string">'A cat sleeping'</span>, <span class="hljs-string">'A dog running'</span>, ...],
    <span class="hljs-string">'image_vector'</span>: [[<span class="hljs-number">0.1</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">0.3</span>, ...], ...],  <span class="hljs-comment"># 向量嵌入</span>
    <span class="hljs-string">'image_blob'</span>: [image_bytes_1, image_bytes_2, ...],  <span class="hljs-comment"># 原始图像</span>
})

<span class="hljs-comment"># Lance 原生支持这种混合存储</span>
dataset = lance.write_dataset(df, <span class="hljs-string">"multimodal.lance"</span>)
</code></pre>
<p><strong>场景 3：实时特征更新</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 需要不断更新特征值，同时保持版本历史</span>
<span class="hljs-comment"># Iceberg 需要重写大量文件</span>
<span class="hljs-comment"># Lance 只需追加新 Fragment + 更新 Manifest</span>

dataset = lance.<span class="hljs-built_in">open</span>(<span class="hljs-string">"features.lance"</span>)
dataset.add_column(<span class="hljs-string">"new_feature"</span>, values)  <span class="hljs-comment"># 原子性添加</span>
<span class="hljs-comment"># 自动版本控制，可回溯到任何历史版本</span>
</code></pre>
<h4 data-id="heading-17">与 Iceberg 的差异</h4>



































<table><thead><tr><th>方面</th><th>Iceberg</th><th>Lance</th></tr></thead><tbody><tr><td>设计目标</td><td>数据湖、表管理</td><td>向量搜索、ML 工作流</td></tr><tr><td>向量支持</td><td>无原生支持</td><td>内置索引和量化</td></tr><tr><td>随机访问</td><td>需要额外优化</td><td>内置优化</td></tr><tr><td>学习曲线</td><td>陡峭</td><td>平缓</td></tr><tr><td>生态支持</td><td>更完善（Spark、Flink）</td><td>正在快速发展</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-18">第三部分：整体架构设计思想</h3>
<h4 data-id="heading-19">分层架构模型</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "应用层 Application"
        A1["Python API"]
        A2["Java API"]
        A3["SQL Interface"]
    end
    
    subgraph "查询引擎层 Query Engine"
        B1["DataFusion"]
        B2["Scanner"]
        B3["Index Planner"]
    end
    
    subgraph "数据管理层 Data Management"
        C1["Dataset"]
        C2["Transaction"]
        C3["Version Control"]
    end
    
    subgraph "索引加速层 Index Acceleration"
        D1["向量索引&lt;br/&gt;IVF/HNSW"]
        D2["标量索引&lt;br/&gt;BTree/Bitmap"]
    end
    
    subgraph "存储编码层 Storage &amp; Encoding"
        E1["File Format"]
        E2["Compression"]
        E3["Encoding"]
    end
    
    subgraph "对象存储 Object Storage"
        F["S3/GCS/Local"]
    end
    
    A1 --&gt; B1
    A2 --&gt; B1
    A3 --&gt; B1
    B1 --&gt; B2
    B1 --&gt; B3
    B2 --&gt; C1
    B3 --&gt; C1
    C1 --&gt; C2
    C1 --&gt; C3
    C1 --&gt; D1
    C1 --&gt; D2
    D1 --&gt; E1
    D2 --&gt; E1
    E1 --&gt; E2
    E2 --&gt; E3
    E3 --&gt; F
</code></pre>
<h4 data-id="heading-20">核心设计思想解析</h4>
<h5 data-id="heading-21">1. <strong>模块化与关注点分离</strong></h5>
<p>Lance 遵循严格的分层设计：</p>
<pre><code class="hljs language-sql" lang="sql">┌──────────────────────────────────────────────────────────┐
│  应用层：提供用户友好的 API（Python、Java、<span class="hljs-keyword">SQL</span>）         │
├──────────────────────────────────────────────────────────┤
│  查询层：负责查询规划、优化、执行                        │
├──────────────────────────────────────────────────────────┤
│  数据层：Dataset、Transaction、版本管理                  │
├──────────────────────────────────────────────────────────┤
│  索引层：向量索引、标量索引的构建和查询                  │
├──────────────────────────────────────────────────────────┤
│  存储层：文件格式、编码、压缩、IO 调度                   │
├──────────────────────────────────────────────────────────┤
│  基础设施：对象存储、缓存、线程管理                      │
└──────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>每层可独立优化和扩展</li>
<li>清晰的接口边界便于理解和维护</li>
<li>便于新功能的添加（如新的索引类型）</li>
</ul>
<h5 data-id="heading-22">2. <strong>异步优先设计</strong></h5>
<p>Lance 大量使用 Rust 的异步编程（tokio 运行时）：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 不阻塞 IO 的写入</span>
<span class="hljs-keyword">await</span> dataset.<span class="hljs-title function_ invoke__">write</span>(data);

<span class="hljs-comment">// 并发读取多个 Fragment</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">futures</span> = fragments
    .<span class="hljs-title function_ invoke__">iter</span>()
    .<span class="hljs-title function_ invoke__">map</span>(|f| f.<span class="hljs-title function_ invoke__">read_async</span>())
    .collect::&lt;<span class="hljs-type">Vec</span>&lt;_&gt;&gt;();
futures::future::<span class="hljs-title function_ invoke__">join_all</span>(futures).<span class="hljs-keyword">await</span>;
</code></pre>
<p><strong>为什么？</strong></p>
<ul>
<li>I/O 不再阻塞计算线程</li>
<li>单个线程可处理数千个并发请求</li>
<li>在云环境中表现优异</li>
</ul>
<h5 data-id="heading-23">3. <strong>零拷贝与 Arrow 原生</strong></h5>
<p>Lance 与 Apache Arrow 深度集成：</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-comment">// 数据从文件解码直接变成 Arrow RecordBatch</span>
<span class="hljs-comment">// 无需中间转换或拷贝</span>
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">batch</span>: RecordBatch = decoder.<span class="hljs-title function_ invoke__">decode</span>().<span class="hljs-keyword">await</span>?;

<span class="hljs-comment">// RecordBatch 可直接传递给 NumPy、Pandas、Polars</span>
<span class="hljs-comment">// 共享内存地址，零拷贝</span>
</code></pre>
<h5 data-id="heading-24">4. <strong>索引透明化</strong></h5>
<p>索引对用户完全透明：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 用户编写简单的查询</span>
results = dataset.search(query_vector, k=<span class="hljs-number">10</span>)

<span class="hljs-comment"># 内部自动选择最优索引</span>
<span class="hljs-comment"># - 如果有向量索引 → 使用 IVF/HNSW</span>
<span class="hljs-comment"># - 如果有标量索引 → 使用谓词下推</span>
<span class="hljs-comment"># - 否则 → 全表扫描</span>
</code></pre>
<hr/>
<h3 data-id="heading-25">实战场景示例</h3>
<h4 data-id="heading-26">场景 1：电商推荐系统</h4>
<p><strong>需求</strong>：</p>
<ul>
<li>存储 1 亿个商品（ID、名称、描述、价格、分类）</li>
<li>每个商品有 768 维向量嵌入</li>
<li>需要基于向量的相似商品推荐</li>
<li>需要基于价格、分类的标量过滤</li>
</ul>
<p><strong>Lance 解决方案</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> lance
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">from</span> lance.vector_search <span class="hljs-keyword">import</span> IVF_PQ

<span class="hljs-comment"># 1. 初始数据加载</span>
products = pd.read_csv(<span class="hljs-string">"products.csv"</span>)
dataset = lance.write_dataset(products, <span class="hljs-string">"products.lance"</span>)

<span class="hljs-comment"># 2. 创建向量索引加速搜索</span>
dataset.create_index(<span class="hljs-string">"vector"</span>, index_type=IVF_PQ(num_partitions=<span class="hljs-number">256</span>))

<span class="hljs-comment"># 3. 推荐查询（向量 + SQL）</span>
query_vector = embed_text(<span class="hljs-string">"高端运动鞋"</span>)
results = dataset.search(
    query_vector,
    k=<span class="hljs-number">100</span>,
    where=<span class="hljs-string">"price &lt; 500 AND category == '鞋类'"</span>,  <span class="hljs-comment"># 标量过滤</span>
    metric=<span class="hljs-string">"cosine"</span>
)
<span class="hljs-comment"># 毫秒级返回最相关的 100 个商品</span>
</code></pre>
<p><strong>为什么 Lance 优于 Elasticsearch？</strong></p>
<ul>
<li>更紧凑的存储（编码优化）</li>
<li>更快的向量搜索（PQ 量化）</li>
<li>原生 SQL 支持（无需写 JSON 查询）</li>
<li>更低的学习成本</li>
</ul>
<h4 data-id="heading-27">场景 2：生物信息学分析</h4>
<p><strong>需求</strong>：</p>
<ul>
<li>存储基因序列数据（超大 BLOB）</li>
<li>存储 DNA 序列的向量化表示</li>
<li>支持相似性搜索和统计分析</li>
</ul>
<p><strong>Lance 优势</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 存储原始 DNA 序列 + 向量化表示</span>
dna_data = pd.DataFrame({
    <span class="hljs-string">'gene_id'</span>: [<span class="hljs-string">'BRCA1'</span>, <span class="hljs-string">'TP53'</span>, ...],
    <span class="hljs-string">'sequence'</span>: [dna_seq_1, dna_seq_2, ...],  <span class="hljs-comment"># 超大字符串</span>
    <span class="hljs-string">'embedding'</span>: [vec1, vec2, ...],  <span class="hljs-comment"># 768 维向量</span>
    <span class="hljs-string">'properties'</span>: [prop1, prop2, ...]  <span class="hljs-comment"># 元数据</span>
})

dataset = lance.write_dataset(dna_data, <span class="hljs-string">"dna.lance"</span>)

<span class="hljs-comment"># 直接支持混合查询</span>
results = dataset.search(
    query_embedding,
    k=<span class="hljs-number">10</span>,
    where=<span class="hljs-string">"properties.organism == 'human'"</span>
)
</code></pre>
<hr/>
<h3 data-id="heading-28">核心工作流概览</h3>
<h4 data-id="heading-29">一个完整的 Lance 使用周期</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User
    participant Python API
    participant Dataset
    participant Index
    participant Storage
    
    User-&gt;&gt;Python API: 1. 创建数据集
    Python API-&gt;&gt;Dataset: write_dataset(data)
    Dataset-&gt;&gt;Storage: 写入文件
    
    User-&gt;&gt;Python API: 2. 创建索引
    Python API-&gt;&gt;Dataset: create_index()
    Dataset-&gt;&gt;Index: 构建向量索引
    Index-&gt;&gt;Storage: 保存索引
    
    User-&gt;&gt;Python API: 3. 执行查询
    Python API-&gt;&gt;Dataset: search(query)
    Dataset-&gt;&gt;Index: 使用索引加速
    Index-&gt;&gt;Storage: 读取数据
    Python API--&gt;&gt;User: 返回结果
    
    User-&gt;&gt;Python API: 4. 更新数据
    Python API-&gt;&gt;Dataset: add_column()/update()
    Dataset-&gt;&gt;Storage: 原子性提交
    Dataset--&gt;&gt;User: 新版本号
</code></pre>
<hr/>
<h3 data-id="heading-30">关键设计决策总结</h3>








































<table><thead><tr><th>决策</th><th>原因</th><th>权衡</th></tr></thead><tbody><tr><td><strong>Rust 实现</strong></td><td>性能、内存安全</td><td>开发效率稍低</td></tr><tr><td><strong>Async First</strong></td><td>高并发、云原生</td><td>编程复杂度增加</td></tr><tr><td><strong>列式存储</strong></td><td>扫描性能、压缩率</td><td>不适合行级更新</td></tr><tr><td><strong>多种编码</strong></td><td>适应不同数据类型</td><td>编码/解码开销</td></tr><tr><td><strong>向量索引</strong></td><td>ML 工作流必需</td><td>索引构建成本</td></tr><tr><td><strong>零拷贝设计</strong></td><td>减少内存占用</td><td>依赖 Arrow 兼容性</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-31">总结</h3>
<p>Lance 通过以下创新解决了 AI 时代的数据存储难题：</p>
<ol>
<li><strong>性能优先</strong>：100 倍随机访问、毫秒级向量搜索</li>
<li><strong>功能全面</strong>：向量、SQL、多模态在一个系统中</li>
<li><strong>用户友好</strong>：自动索引选择、透明的优化</li>
<li><strong>生产就绪</strong>：ACID 事务、版本控制、云支持</li>
</ol>
<p>在接下来的章节中，我们将深入探讨 Lance 的内部实现细节，从项目结构、数据模型、文件格式、到索引和查询引擎，全面理解这个强大的系统是如何运作的。</p>
<hr/>
<h3 data-id="heading-32">关键概念速记</h3>
<ul>
<li><strong>列式存储</strong>：按列而非行组织数据</li>
<li><strong>向量索引</strong>：加速向量相似性搜索的数据结构</li>
<li><strong>IVF-PQ</strong>：乘积量化的倒排文件，Lance 中常用的索引方式</li>
<li><strong>Manifest</strong>：记录数据集版本信息的元数据文件</li>
<li><strong>Fragment</strong>：数据集中的数据分片单位</li>
<li><strong>零拷贝</strong>：数据在内存中传递而无需复制</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[问题记录 - Android IdleHandler 没有执行]]></title>    <link>https://juejin.cn/post/7577016562253398067</link>    <guid>https://juejin.cn/post/7577016562253398067</guid>    <pubDate>2025-11-27T10:13:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577016562253398067" data-draft-id="7576968345875496987" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="问题记录 - Android IdleHandler 没有执行"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-27T10:13:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Best_Jerry"/> <meta itemprop="url" content="https://juejin.cn/user/1099167360106999"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            问题记录 - Android IdleHandler 没有执行
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1099167360106999/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Best_Jerry
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T10:13:28.000Z" title="Thu Nov 27 2025 10:13:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    19
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 问题背景</h2>
<p>最近测试同学反馈了一个问题，有个自定义 View 的内容区域在某个特定场景下展示空白。</p>
<p>首先抓包看了后端下发的数据是正常的，同时数据也正确传给了 View，可以排除是数据问题。</p>
<p>接下来怀疑是 View 的初始化有问题，断点发现，View 内部的初始化方法的确没有执行到。由于这个 View 不是页面首屏必须展示的，为了提升首屏打开速度，它的初始化方法是通过 <code>addIdleHandler</code> 的方式去触发。</p>
<p>按理说，主线程处理完首屏的 UI 渲染以及其他计算工作之后，总会有空闲的时机执行 <code>IdleHandler</code> 任务。但这个 <code>IdleHandler</code> 一直得不到执行，那只能说明主线程一直处于繁忙的状态。</p>
<blockquote>
<p>这里先直接说原因：该场景下存在多个自定义 <code>TextView</code> 在 <code>onLayout()</code> 方法中调用 update 方法，update 方法又会使得 <code>onLayout()</code> 方法被调用，以此无限循环，向 MessageQueue 一直发送大量 Message，导致主线程根本没有空闲的时间执行 <code>IdleHandler</code> 任务。主线程虽然繁忙但没有卡顿，因为做的都是 UI 渲染工作。</p>
</blockquote>
<p>知道是主线程繁忙引起的不难，但是要定位到具体是哪段代码出的问题还是花了不少时间。过程中绕了很多弯路，最终才得知有快速定位的方法，在此分享给大家：</p>
<blockquote>
<p>通过 <code>Looper.setMessageLogging()</code> 方法监听主线程 MessageQueue 上的 Message 日志，观察日志便能很容易找出问题所在。</p>
</blockquote>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-number">2025</span>-<span class="hljs-number">11</span>-<span class="hljs-number">27</span> <span class="hljs-number">16</span><span class="hljs-symbol">:</span><span class="hljs-number">27</span><span class="hljs-symbol">:</span><span class="hljs-number">26.173</span> <span class="hljs-number">28376</span>-<span class="hljs-number">28494</span> xxx   D  [<span class="hljs-symbol">:</span><span class="hljs-number">0</span>, ]<span class="hljs-symbol">:</span><span class="hljs-number">28376</span> <span class="hljs-number">28376</span> &gt;&gt;&gt;&gt;&gt; <span class="hljs-title class_">Dispatching</span> to <span class="hljs-title class_">Handler</span> (android.view.<span class="hljs-title class_">ViewRootImpl</span><span class="hljs-variable">$ViewRootHandler</span>) {2da134c} com.xxx.yyy.zzz.customTextView<span class="hljs-variable">$$</span><span class="hljs-title class_">ExternalSyntheticLambda1</span><span class="hljs-variable">@82a6bb1</span>: <span class="hljs-number">0</span>
<span class="hljs-number">2025</span>-<span class="hljs-number">11</span>-<span class="hljs-number">27</span> <span class="hljs-number">16</span><span class="hljs-symbol">:</span><span class="hljs-number">27</span><span class="hljs-symbol">:</span><span class="hljs-number">26.174</span> <span class="hljs-number">28376</span>-<span class="hljs-number">28494</span> xxx   D  [<span class="hljs-symbol">:</span><span class="hljs-number">0</span>, ]<span class="hljs-symbol">:</span><span class="hljs-number">28376</span> <span class="hljs-number">28376</span> &lt;&lt;&lt;&lt;&lt; <span class="hljs-title class_">Finished</span> to <span class="hljs-title class_">Handler</span> (android.view.<span class="hljs-title class_">ViewRootImpl</span><span class="hljs-variable">$ViewRootHandler</span>) {2da134c} com.xxx.yyy.zzz.customTextView<span class="hljs-variable">$$</span><span class="hljs-title class_">ExternalSyntheticLambda1</span><span class="hljs-variable">@82a6bb1</span>
<span class="hljs-number">2025</span>-<span class="hljs-number">11</span>-<span class="hljs-number">27</span> <span class="hljs-number">16</span><span class="hljs-symbol">:</span><span class="hljs-number">27</span><span class="hljs-symbol">:</span><span class="hljs-number">26.189</span> <span class="hljs-number">28376</span>-<span class="hljs-number">28494</span> xxx   D  [<span class="hljs-symbol">:</span><span class="hljs-number">0</span>, ]<span class="hljs-symbol">:</span><span class="hljs-number">28376</span> <span class="hljs-number">28376</span> &gt;&gt;&gt;&gt;&gt; <span class="hljs-title class_">Dispatching</span> to <span class="hljs-title class_">Handler</span> (android.view.<span class="hljs-title class_">ViewRootImpl</span><span class="hljs-variable">$ViewRootHandler</span>) {2da134c} com.xxx.yyy.zzz.customTextView<span class="hljs-variable">$$</span><span class="hljs-title class_">ExternalSyntheticLambda1</span><span class="hljs-variable">@9854804</span>: <span class="hljs-number">0</span>
<span class="hljs-number">2025</span>-<span class="hljs-number">11</span>-<span class="hljs-number">27</span> <span class="hljs-number">16</span><span class="hljs-symbol">:</span><span class="hljs-number">27</span><span class="hljs-symbol">:</span><span class="hljs-number">26.189</span> <span class="hljs-number">28376</span>-<span class="hljs-number">28494</span> xxx   D  [<span class="hljs-symbol">:</span><span class="hljs-number">0</span>, ]<span class="hljs-symbol">:</span><span class="hljs-number">28376</span> <span class="hljs-number">28376</span> &lt;&lt;&lt;&lt;&lt; <span class="hljs-title class_">Finished</span> to <span class="hljs-title class_">Handler</span> (android.view.<span class="hljs-title class_">ViewRootImpl</span><span class="hljs-variable">$ViewRootHandler</span>) {2da134c} com.xxx.yyy.zzz.customTextView<span class="hljs-variable">$$</span><span class="hljs-title class_">ExternalSyntheticLambda1</span><span class="hljs-variable">@9854804</span>
<span class="hljs-number">2025</span>-<span class="hljs-number">11</span>-<span class="hljs-number">27</span> <span class="hljs-number">16</span><span class="hljs-symbol">:</span><span class="hljs-number">27</span><span class="hljs-symbol">:</span><span class="hljs-number">26.206</span> <span class="hljs-number">28376</span>-<span class="hljs-number">28494</span> xxx   D  [<span class="hljs-symbol">:</span><span class="hljs-number">0</span>, ]<span class="hljs-symbol">:</span><span class="hljs-number">28376</span> <span class="hljs-number">28376</span> &gt;&gt;&gt;&gt;&gt; <span class="hljs-title class_">Dispatching</span> to <span class="hljs-title class_">Handler</span> (android.view.<span class="hljs-title class_">ViewRootImpl</span><span class="hljs-variable">$ViewRootHandler</span>) {2da134c} com.xxx.yyy.zzz.customTextView<span class="hljs-variable">$$</span><span class="hljs-title class_">ExternalSyntheticLambda1</span><span class="hljs-variable">@d1702b3</span>: <span class="hljs-number">0</span>
<span class="hljs-number">2025</span>-<span class="hljs-number">11</span>-<span class="hljs-number">27</span> <span class="hljs-number">16</span><span class="hljs-symbol">:</span><span class="hljs-number">27</span><span class="hljs-symbol">:</span><span class="hljs-number">26.207</span> <span class="hljs-number">28376</span>-<span class="hljs-number">28494</span> xxx   D  [<span class="hljs-symbol">:</span><span class="hljs-number">0</span>, ]<span class="hljs-symbol">:</span><span class="hljs-number">28376</span> <span class="hljs-number">28376</span> &lt;&lt;&lt;&lt;&lt; <span class="hljs-title class_">Finished</span> to <span class="hljs-title class_">Handler</span> (android.view.<span class="hljs-title class_">ViewRootImpl</span><span class="hljs-variable">$ViewRootHandler</span>) {2da134c} com.xxx.yyy.zzz.customTextView<span class="hljs-variable">$$</span><span class="hljs-title class_">ExternalSyntheticLambda1</span><span class="hljs-variable">@d1702b3</span>
<span class="hljs-number">2025</span>-<span class="hljs-number">11</span>-<span class="hljs-number">27</span> <span class="hljs-number">16</span><span class="hljs-symbol">:</span><span class="hljs-number">27</span><span class="hljs-symbol">:</span><span class="hljs-number">26.223</span> <span class="hljs-number">28376</span>-<span class="hljs-number">28494</span> xxx   D  [<span class="hljs-symbol">:</span><span class="hljs-number">0</span>, ]<span class="hljs-symbol">:</span><span class="hljs-number">28376</span> <span class="hljs-number">28376</span> &gt;&gt;&gt;&gt;&gt; <span class="hljs-title class_">Dispatching</span> to <span class="hljs-title class_">Handler</span> (android.view.<span class="hljs-title class_">ViewRootImpl</span><span class="hljs-variable">$ViewRootHandler</span>) {2da134c} com.xxx.yyy.zzz.customTextView<span class="hljs-variable">$$</span><span class="hljs-title class_">ExternalSyntheticLambda1</span><span class="hljs-variable">@fab846e</span>: <span class="hljs-number">0</span>
<span class="hljs-number">2025</span>-<span class="hljs-number">11</span>-<span class="hljs-number">27</span> <span class="hljs-number">16</span><span class="hljs-symbol">:</span><span class="hljs-number">27</span><span class="hljs-symbol">:</span><span class="hljs-number">26.224</span> <span class="hljs-number">28376</span>-<span class="hljs-number">28494</span> xxx   D  [<span class="hljs-symbol">:</span><span class="hljs-number">0</span>, ]<span class="hljs-symbol">:</span><span class="hljs-number">28376</span> <span class="hljs-number">28376</span> &lt;&lt;&lt;&lt;&lt; <span class="hljs-title class_">Finished</span> to <span class="hljs-title class_">Handler</span> (android.view.<span class="hljs-title class_">ViewRootImpl</span><span class="hljs-variable">$ViewRootHandler</span>) {2da134c} com.xxx.yyy.zzz.customTextView<span class="hljs-variable">$$</span><span class="hljs-title class_">ExternalSyntheticLambda1</span><span class="hljs-variable">@fab846e</span>
<span class="hljs-number">2025</span>-<span class="hljs-number">11</span>-<span class="hljs-number">27</span> <span class="hljs-number">16</span><span class="hljs-symbol">:</span><span class="hljs-number">27</span><span class="hljs-symbol">:</span><span class="hljs-number">26.241</span> <span class="hljs-number">28376</span>-<span class="hljs-number">28494</span> xxx   D  [<span class="hljs-symbol">:</span><span class="hljs-number">0</span>, ]<span class="hljs-symbol">:</span><span class="hljs-number">28376</span> <span class="hljs-number">28376</span> &gt;&gt;&gt;&gt;&gt; <span class="hljs-title class_">Dispatching</span> to <span class="hljs-title class_">Handler</span> (android.view.<span class="hljs-title class_">ViewRootImpl</span><span class="hljs-variable">$ViewRootHandler</span>) {2da134c} com.xxx.yyy.zzz.customTextView<span class="hljs-variable">$$</span><span class="hljs-title class_">ExternalSyntheticLambda1</span><span class="hljs-variable">@a3f91a5</span>: <span class="hljs-number">0</span>
<span class="hljs-number">2025</span>-<span class="hljs-number">11</span>-<span class="hljs-number">27</span> <span class="hljs-number">16</span><span class="hljs-symbol">:</span><span class="hljs-number">27</span><span class="hljs-symbol">:</span><span class="hljs-number">26.242</span> <span class="hljs-number">28376</span>-<span class="hljs-number">28494</span> xxx   D  [<span class="hljs-symbol">:</span><span class="hljs-number">0</span>, ]<span class="hljs-symbol">:</span><span class="hljs-number">28376</span> <span class="hljs-number">28376</span> &lt;&lt;&lt;&lt;&lt; <span class="hljs-title class_">Finished</span> to <span class="hljs-title class_">Handler</span> (android.view.<span class="hljs-title class_">ViewRootImpl</span><span class="hljs-variable">$ViewRootHandler</span>) {2da134c} com.xxx.yyy.zzz.customTextView<span class="hljs-variable">$$</span><span class="hljs-title class_">ExternalSyntheticLambda1</span><span class="hljs-variable">@a3f91a5</span>
<span class="hljs-number">2025</span>-<span class="hljs-number">11</span>-<span class="hljs-number">27</span> <span class="hljs-number">16</span><span class="hljs-symbol">:</span><span class="hljs-number">27</span><span class="hljs-symbol">:</span><span class="hljs-number">26.256</span> <span class="hljs-number">28376</span>-<span class="hljs-number">28494</span> xxx   D  [<span class="hljs-symbol">:</span><span class="hljs-number">0</span>, ]<span class="hljs-symbol">:</span><span class="hljs-number">28376</span> <span class="hljs-number">28376</span> &gt;&gt;&gt;&gt;&gt; <span class="hljs-title class_">Dispatching</span> to <span class="hljs-title class_">Handler</span> (android.view.<span class="hljs-title class_">ViewRootImpl</span><span class="hljs-variable">$ViewRootHandler</span>) {2da134c} com.xxx.yyy.zzz.customTextView<span class="hljs-variable">$$</span><span class="hljs-title class_">ExternalSyntheticLambda1</span><span class="hljs-variable">@27c4d88</span>: <span class="hljs-number">0</span>ƒ
</code></pre>
<p>上面的日志中 <code>com.xxx.yyy.zzz.customTextView</code> 不断地大量出现，必然有问题，点进这个 TextView 里面寻找肯定能找到问题根源，过程这里就不赘述了。</p>
<p><code>Looper.setMessageLogging()</code> 的具体用法在下面的篇幅会有说明。</p>
<h2 data-id="heading-1">2. IdleHandler</h2>
<h3 data-id="heading-2">IdleHandler 简介</h3>
<p>应用中有些任务很重要必须被执行，但时机上又没有那么迫切。于是便有了 IdleHandler，它最适合处理这种场景，既能充分利用 CPU 但又不跟紧急任务争夺 CPU。当线程没有 message 需要处理而阻塞时，简单来说就是线程空闲，<code>IdleHandler.queueIdle()</code> 被回调。<code>queueIdle()</code> 返回 false 时将自动从 MessageQueue 中清理当前 IdleHandler。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * Callback interface for discovering when a thread is going to block
 * waiting for more messages.
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IdleHandler</span> {
    <span class="hljs-comment">/**
     * Called when the message queue has run out of messages and will now
     * wait for more.  Return true to keep your idle handler active, false
     * to have it removed.  This may be called if there are still messages
     * pending in the queue, but they are all scheduled to be dispatched
     * after the current time.
     */</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">queueIdle</span><span class="hljs-params">()</span>;
}
</code></pre>
<h3 data-id="heading-3">IdleHandler 用法</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">Looper.myQueue().addIdleHandler(<span class="hljs-keyword">object</span> : IdleHandler {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">queueIdle</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
        Log.d(<span class="hljs-string">"TAG"</span>, <span class="hljs-string">"addIdleHandler example"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
    }
})
</code></pre>
<p>上面这段代码输出 1 次 <code>addIdleHandler example</code>。不过要是将 <code>return false</code> 改成 <code>return true</code>，则会在空闲时间多次输出 <code>addIdleHandler example</code>，直到将这个 IdleHandler 移除。</p>
<p><strong>MessageQueue.addIdleHandler()</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * Add a new {<span class="hljs-doctag">@link</span> IdleHandler} to this message queue.  This may be
 * removed automatically for you by returning false from
 * {<span class="hljs-doctag">@link</span> IdleHandler#queueIdle IdleHandler.queueIdle()} when it is
 * invoked, or explicitly removing it with {<span class="hljs-doctag">@link</span> #removeIdleHandler}.
 *
 * &lt;p&gt;This method is safe to call from any thread.
 *
 * <span class="hljs-doctag">@param</span> handler The IdleHandler to be added.
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addIdleHandler</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> IdleHandler handler)</span> {
    <span class="hljs-keyword">if</span> (handler == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>(<span class="hljs-string">"Can't add a null IdleHandler"</span>);
    }
    <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
        mIdleHandlers.add(handler);
    }
}
</code></pre>
<p>Android 系统中也有用到 IdleHandler，详见 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Faosp-mirror%2Fplatform_frameworks_base%2Fblob%2Fmaster%2Fcore%2Fjava%2Fandroid%2Fapp%2FActivityThread.java%23L2192" target="_blank" title="https://github.com/aosp-mirror/platform_frameworks_base/blob/master/core/java/android/app/ActivityThread.java#L2192" ref="nofollow noopener noreferrer">ActivityThread.scheduleGcIdler()</a>。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GcIdler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MessageQueue</span>.IdleHandler {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">queueIdle</span><span class="hljs-params">()</span> {
        doGcIfNeeded();
        purgePendingResources();
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}

<span class="hljs-meta">@UnsupportedAppUsage</span>
<span class="hljs-keyword">void</span> <span class="hljs-title function_">scheduleGcIdler</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (!mGcIdlerScheduled) {
        mGcIdlerScheduled = <span class="hljs-literal">true</span>;
        Looper.myQueue().addIdleHandler(mGcIdler);
    }
    mH.removeMessages(H.GC_WHEN_IDLE);
}

<span class="hljs-keyword">void</span> <span class="hljs-title function_">unscheduleGcIdler</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">if</span> (mGcIdlerScheduled) {
        mGcIdlerScheduled = <span class="hljs-literal">false</span>;
        Looper.myQueue().removeIdleHandler(mGcIdler);
    }
    mH.removeMessages(H.GC_WHEN_IDLE);
}
</code></pre>
<h3 data-id="heading-4">源码分析</h3>
<p>看看 <code>MessageQueue.next()</code> 方法是如何处理 IdleHandler 的。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@UnsupportedAppUsage</span>
Message <span class="hljs-title function_">next</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// Return here if the message loop has already quit and been disposed.</span>
    <span class="hljs-comment">// This can happen if the application tries to restart a looper after quit</span>
    <span class="hljs-comment">// which is not supported.</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">ptr</span> <span class="hljs-operator">=</span> mPtr;
    <span class="hljs-keyword">if</span> (ptr == <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-type">int</span> <span class="hljs-variable">pendingIdleHandlerCount</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// -1 only during first iteration</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">nextPollTimeoutMillis</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-keyword">for</span> (;;) {
        <span class="hljs-keyword">if</span> (nextPollTimeoutMillis != <span class="hljs-number">0</span>) {
            Binder.flushPendingCommands();
        }

        nativePollOnce(ptr, nextPollTimeoutMillis);

        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
            <span class="hljs-comment">// Try to retrieve the next message.  Return if found.</span>
            <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> SystemClock.uptimeMillis();
            <span class="hljs-type">Message</span> <span class="hljs-variable">prevMsg</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
            <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> mMessages;
            <span class="hljs-keyword">if</span> (msg != <span class="hljs-literal">null</span> &amp;&amp; msg.target == <span class="hljs-literal">null</span>) {
                <span class="hljs-comment">// Stalled by a barrier.  Find the next asynchronous message in the queue.</span>
                <span class="hljs-keyword">do</span> {
                    prevMsg = msg;
                    msg = msg.next;
                } <span class="hljs-keyword">while</span> (msg != <span class="hljs-literal">null</span> &amp;&amp; !msg.isAsynchronous());
            }
            <span class="hljs-keyword">if</span> (msg != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">if</span> (now &lt; msg.when) {
                    <span class="hljs-comment">// Next message is not ready.  Set a timeout to wake up when it is ready.</span>
                    nextPollTimeoutMillis = (<span class="hljs-type">int</span>) Math.min(msg.when - now, Integer.MAX_VALUE);
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">// Got a message.</span>
                    mBlocked = <span class="hljs-literal">false</span>;
                    <span class="hljs-keyword">if</span> (prevMsg != <span class="hljs-literal">null</span>) {
                        prevMsg.next = msg.next;
                        <span class="hljs-keyword">if</span> (prevMsg.next == <span class="hljs-literal">null</span>) {
                            mLast = prevMsg;
                        }
                    } <span class="hljs-keyword">else</span> {
                        mMessages = msg.next;
                        <span class="hljs-keyword">if</span> (msg.next == <span class="hljs-literal">null</span>) {
                            mLast = <span class="hljs-literal">null</span>;
                        }
                    }
                    msg.next = <span class="hljs-literal">null</span>;
                    <span class="hljs-keyword">if</span> (DEBUG) Log.v(TAG, <span class="hljs-string">"Returning message: "</span> + msg);
                    msg.markInUse();
                    <span class="hljs-keyword">if</span> (msg.isAsynchronous()) {
                        mAsyncMessageCount--;
                    }
                    <span class="hljs-keyword">return</span> msg;
                }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// No more messages.</span>
                nextPollTimeoutMillis = -<span class="hljs-number">1</span>;
            }

            <span class="hljs-comment">// Process the quit message now that all pending messages have been handled.</span>
            <span class="hljs-keyword">if</span> (mQuitting) {
                dispose();
                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
            }

            <span class="hljs-comment">// If first time idle, then get the number of idlers to run.</span>
            <span class="hljs-comment">// Idle handles only run if the queue is empty or if the first message</span>
            <span class="hljs-comment">// in the queue (possibly a barrier) is due to be handled in the future.</span>
            <span class="hljs-keyword">if</span> (pendingIdleHandlerCount &lt; <span class="hljs-number">0</span>
                    &amp;&amp; (mMessages == <span class="hljs-literal">null</span> || now &lt; mMessages.when)) {
                pendingIdleHandlerCount = mIdleHandlers.size();
            }
            <span class="hljs-keyword">if</span> (pendingIdleHandlerCount &lt;= <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// No idle handlers to run.  Loop and wait some more.</span>
                <span class="hljs-comment">// 没有 IdleHandler，继续循环</span>
                mBlocked = <span class="hljs-literal">true</span>;
                <span class="hljs-keyword">continue</span>;
            }

            <span class="hljs-keyword">if</span> (mPendingIdleHandlers == <span class="hljs-literal">null</span>) {
                mPendingIdleHandlers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IdleHandler</span>[Math.max(pendingIdleHandlerCount, <span class="hljs-number">4</span>)];
            }
            mPendingIdleHandlers = mIdleHandlers.toArray(mPendingIdleHandlers);
        }

        <span class="hljs-comment">// Run the idle handlers.</span>
        <span class="hljs-comment">// We only ever reach this code block during the first iteration.</span>
        <span class="hljs-comment">// 运行 IdleHandler</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; pendingIdleHandlerCount; i++) {
            <span class="hljs-keyword">final</span> <span class="hljs-type">IdleHandler</span> <span class="hljs-variable">idler</span> <span class="hljs-operator">=</span> mPendingIdleHandlers[i];
            mPendingIdleHandlers[i] = <span class="hljs-literal">null</span>; <span class="hljs-comment">// release the reference to the handler</span>

            <span class="hljs-type">boolean</span> <span class="hljs-variable">keep</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">try</span> {
                keep = idler.queueIdle();
            } <span class="hljs-keyword">catch</span> (Throwable t) {
                Log.wtf(TAG, <span class="hljs-string">"IdleHandler threw exception"</span>, t);
            }

            <span class="hljs-comment">// 删除不被保留的 IdleHandler</span>
            <span class="hljs-keyword">if</span> (!keep) {
                <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
                    mIdleHandlers.remove(idler);
                }
            }
        }

        <span class="hljs-comment">// Reset the idle handler count to 0 so we do not run them again.</span>
        pendingIdleHandlerCount = <span class="hljs-number">0</span>;

        <span class="hljs-comment">// While calling an idle handler, a new message could have been delivered</span>
        <span class="hljs-comment">// so go back and look again for a pending message without waiting.</span>
        nextPollTimeoutMillis = <span class="hljs-number">0</span>;
    }
}
</code></pre>
<p>正如源码所述，IdleHandler 仅在线程空闲时才被执行。</p>
<ul>
<li>
<p>如果 <code>MessageQueue</code> 中有消息，不会执行 IdleHandler</p>
</li>
<li>
<p>每次 <code>next()</code> 调用时 IdleHandler 最多只有一次被执行的机会</p>
</li>
</ul>
<h2 data-id="heading-5">3. 解决方法</h2>
<p>为什么 IdleHandler 不被执行？当然是因为 <code>MessageQueue</code> 中的消息太多，每次 <code>next()</code> 调用时都能找到一个待处理的 Message，所以 IdleHandler 根本没有处理的机会。</p>
<p>那么怎么查看 <code>MessageQueue</code> 中有哪些消息呢？</p>
<h3 data-id="heading-6">setMessageLogging()</h3>
<p>注释文档中说，<code>setMessageLogging()</code> 用于当前 Looper 处理 Message 时打印日志。</p>
<ul>
<li>
<p>传 null 参数关闭日志功能，传非 null 的 <code>printer</code> 开启日志功能</p>
</li>
<li>
<p>开启日志功能后，会在每个 Message 分发的开始以及结束时输出日志信息到 <code>printer</code>，具体的日志信息包括区分 Message 的目标 Hander 以及 Message 内容</p>
</li>
</ul>
<p>对照 <code>Looper.loop()</code> 方法源码，跟上面描述一致。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * Run the message queue in this thread. Be sure to call
 * {<span class="hljs-doctag">@link</span> #quit()} to end the loop.
 */</span>
<span class="hljs-meta">@SuppressWarnings({"UnusedTokenOfOriginalCallingIdentity",
        "ClearIdentityCallNotFollowedByTryFinally",
        "ResultOfClearIdentityCallNotStoredInVariable"})</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">loop</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-type">Looper</span> <span class="hljs-variable">me</span> <span class="hljs-operator">=</span> myLooper();
    ...
    <span class="hljs-keyword">for</span> (;;) {
        <span class="hljs-keyword">if</span> (!loopOnce(me, ident, thresholdOverride)) {
            <span class="hljs-keyword">return</span>;
        }
    }
}

<span class="hljs-comment">/**
 * Poll and deliver single message, return true if the outer loop should continue.
 */</span>
<span class="hljs-meta">@SuppressWarnings({"UnusedTokenOfOriginalCallingIdentity",
        "ClearIdentityCallNotFollowedByTryFinally"})</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">loopOnce</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Looper me,
        <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> ident, <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> thresholdOverride)</span> {
    ...
    <span class="hljs-comment">// This must be in a local variable, in case a UI event sets the logger</span>
    <span class="hljs-keyword">final</span> <span class="hljs-type">Printer</span> <span class="hljs-variable">logging</span> <span class="hljs-operator">=</span> me.mLogging;
    <span class="hljs-keyword">if</span> (logging != <span class="hljs-literal">null</span>) {
        logging.println(<span class="hljs-string">"&gt;&gt;&gt;&gt;&gt; Dispatching to "</span> + msg.target + <span class="hljs-string">" "</span>
                + msg.callback + <span class="hljs-string">": "</span> + msg.what);
    }
    ...
        msg.target.dispatchMessage(msg);
    ...

    <span class="hljs-keyword">if</span> (logging != <span class="hljs-literal">null</span>) {
        logging.println(<span class="hljs-string">"&lt;&lt;&lt;&lt;&lt; Finished to "</span> + msg.target + <span class="hljs-string">" "</span> + msg.callback);
    }
    ...
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<h4 data-id="heading-7">使用示例</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">printer</span><span class="hljs-params">()</span></span> {
    Looper.getMainLooper().setMessageLogging { printer -&gt;
        <span class="hljs-keyword">if</span> (printer != <span class="hljs-literal">null</span> &amp;&amp; !printer.contains(<span class="hljs-string">"FrameDisplayEventReceiver"</span>)
            &amp;&amp; !printer.contains(<span class="hljs-string">"HardwareRendererObserver"</span>)
        ) {
            Log.d(<span class="hljs-string">"xxx"</span>, printer)
        }
    }
}
</code></pre>
<p>为了便于 logcat 中观察，这里将日志中包含 <code>FrameDisplayEventReceiver</code> 和 <code>HardwareRendererObserver</code> 都剔除了。</p>
<h3 data-id="heading-8">MessageHelper 工具类</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageHelper</span> : <span class="hljs-type">Choreographer.FrameCallback</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> messagesField: Field? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> nextField: Field? = <span class="hljs-literal">null</span>

    <span class="hljs-keyword">init</span> {
        <span class="hljs-keyword">try</span> {
            messagesField = MessageQueue::<span class="hljs-keyword">class</span>.java.getDeclaredField(<span class="hljs-string">"mMessages"</span>)
            messagesField?.isAccessible = <span class="hljs-literal">true</span>
            nextField = Message::<span class="hljs-keyword">class</span>.java.getDeclaredField(<span class="hljs-string">"next"</span>)
            nextField?.isAccessible = <span class="hljs-literal">true</span>
        } <span class="hljs-keyword">catch</span> (e: NoSuchFieldException) {
            e.printStackTrace()
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">printMessages</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> queue = Looper.myQueue()
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">var</span> msg: Message? = messagesField?.<span class="hljs-keyword">get</span>(queue) <span class="hljs-keyword">as</span> Message?
            <span class="hljs-keyword">val</span> sb = StringBuilder()
            <span class="hljs-keyword">while</span> (msg != <span class="hljs-literal">null</span>) {
                sb.append(msg.toString())
                sb.append(<span class="hljs-string">"\n"</span>)
                msg = nextField?.<span class="hljs-keyword">get</span>(msg) <span class="hljs-keyword">as</span> Message?
            }
            <span class="hljs-keyword">val</span> finalString = sb.toString()
            <span class="hljs-keyword">if</span> (!finalString.contains(<span class="hljs-string">"FrameDisplayEventReceiver"</span>)
                &amp;&amp; !finalString.contains(<span class="hljs-string">"HardwareRendererObserver"</span>)
            ) {
                Log.i(TAG, finalString)
            }
        } <span class="hljs-keyword">catch</span> (e: IllegalAccessException) {
            e.printStackTrace()
        }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doFrame</span><span class="hljs-params">(frameTimeNanos: <span class="hljs-type">Long</span>)</span></span> {
        Choreographer.getInstance().postFrameCallback(<span class="hljs-keyword">this</span>)

        printMessages()
    }

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TAG = <span class="hljs-string">"MessageHelper"</span>
    }
}
</code></pre>
<p>为了便于 logcat 中观察，这里将日志中包含 <code>FrameDisplayEventReceiver</code> 和 <code>HardwareRendererObserver</code> 都剔除了。</p>
<h4 data-id="heading-9">使用示例</h4>
<p>调用以下代码将输出每一帧 MessageQueue 中的消息。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">Choreographer.getInstance().postFrameCallback(MessageHelper())
</code></pre>
<h2 data-id="heading-10">4. 总结</h2>
<ul>
<li>
<p>IdleHandler 可以用来处理一些不紧急的任务，比如 ActivityThread 使用它来执行 gc 任务</p>
</li>
<li>
<p><code>Looper.setMessageLogging()</code>方法打印消息日志，观察是否有异常消息</p>
</li>
<li>
<p>使用上述 MessageHelper 类打印当前 MessageQueue 中的所有 Message，观察是否有异常消息</p>
</li>
</ul>
<h2 data-id="heading-11">5. 参考</h2>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.dreamtobe.cn%2F2016%2F03%2F11%2Fandroid_handler_looper%2F" target="_blank" title="https://blog.dreamtobe.cn/2016/03/11/android_handler_looper/" ref="nofollow noopener noreferrer">Android Handler Looper机制 | Jacks Blog</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmy.oschina.net%2Fyouranhongcha%2Fblog%2F492591" target="_blank" title="https://my.oschina.net/youranhongcha/blog/492591" ref="nofollow noopener noreferrer">聊一聊Android的消息机制 - 悠然红茶的个人页面 - 开源中国</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fcdecde111%2Farticle%2Fdetails%2F54670136" target="_blank" title="https://blog.csdn.net/cdecde111/article/details/54670136" ref="nofollow noopener noreferrer">android 利用Handler机制中SyncBarrier的特性实现预加载 - CSDN博客</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.dreamtobe.cn%2F2016%2F03%2F11%2Fandroid_handler_looper%2F" target="_blank" title="https://blog.dreamtobe.cn/2016/03/11/android_handler_looper/" ref="nofollow noopener noreferrer">Android Handler Looper机制 | Jacks Blog</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fsegmentfault.com%2Fa%2F1190000002982318" target="_blank" title="https://segmentfault.com/a/1190000002982318" ref="nofollow noopener noreferrer">Android应用程序消息处理机制 - 点点滴滴 - SegmentFault 思否</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kancloud.cn%2Falex_wsc%2Fandroid-deep2%2F413394" target="_blank" title="https://www.kancloud.cn/alex_wsc/android-deep2/413394" ref="nofollow noopener noreferrer">2.3.3 nativePollOnce函数分析 · 深入理解Android：卷2 · 看云</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jianshu.com%2Fp%2F9849026e7232" target="_blank" title="https://www.jianshu.com/p/9849026e7232" ref="nofollow noopener noreferrer">Android消息循环机制（二）Looper性能检测的缺陷 - 简书</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fdegwei%2Farticle%2Fdetails%2F50602445" target="_blank" title="https://blog.csdn.net/degwei/article/details/50602445" ref="nofollow noopener noreferrer">Android Barrier - CSDN博客</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fdasusu%2Fp%2F8311324.html" target="_blank" title="https://www.cnblogs.com/dasusu/p/8311324.html" ref="nofollow noopener noreferrer">Android 屏幕刷新机制 - 请叫我大苏 - 博客园</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sunmoonblog.com%2F2018%2F07%2F26%2Fhandler-sync-barrier%2F" target="_blank" title="https://www.sunmoonblog.com/2018/07/26/handler-sync-barrier/" ref="nofollow noopener noreferrer">Handler问题记录</a></p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在 React + React Router v7 SSR 项目里做多端适配，我踩的两个坑]]></title>    <link>https://juejin.cn/post/7577050643204374578</link>    <guid>https://juejin.cn/post/7577050643204374578</guid>    <pubDate>2025-11-27T15:27:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577050643204374578" data-draft-id="7577222731790696474" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在 React + React Router v7 SSR 项目里做多端适配，我踩的两个坑"/> <meta itemprop="keywords" content="前端,React.js"/> <meta itemprop="datePublished" content="2025-11-27T15:27:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="福大命大"/> <meta itemprop="url" content="https://juejin.cn/user/2154698523020205"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在 React + React Router v7 SSR 项目里做多端适配，我踩的两个坑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2154698523020205/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    福大命大
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T15:27:02.000Z" title="Thu Nov 27 2025 15:27:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">前言</h2>
<p>最近帮人维护一个 <code>SSR</code> 的 <code>React</code> 项目，需要在同一套代码里适配 <code>PC</code>、手机和平板。页面里大量逻辑是基于 <code>deviceType</code>（<code>desktop | tablet | mobile</code>）来做布局和交互差异的。</p>
<p>刚开始看上去只是“判断一下宽度 + 写点媒体查询”的小需求，但在 <code>SSR + iOS</code> 真机 这两个维度叠加之后，踩了不少兼容性的坑，特别是：</p>
<ol>
<li><code>SSR</code> 环境下拿不到 <code>window</code>，导致页面在客户端首次渲染时闪烁；</li>
<li><code>iOS</code> 真机上 <code>window.innerWidth</code> 获取存在延迟，导致偶发性识别错误。</li>
</ol>
<p>这篇文章主要记录一下这两个问题的具体表现、解决思路，以及最终抽出来的一个 <code>useDeviceType</code> <code>Hook</code>。</p>
<p>如果文章对你有帮助的话，<strong>记得一键三连哟</strong>。有问题和疑惑的话也可以在评论区留言。我会第一时间回复大家，如果觉得我的文章哪里有知识点错误的话，也恳请能够告知，把错的东西理解成对的，无论在什么行业，都是致命的。</p>
<h2 data-id="heading-1">问题背景</h2>
<p>因为是 <code>SSR</code> 项目，服务端初始会把页面 <code>HTML</code> 渲染出来，再由客户端进行 <code>hydration</code>。<br/>
同时，我们希望做到：</p>
<ul>
<li><code>PC</code> 端：展示完整布局；</li>
<li>手机端：展示精简布局，组件层级也有差异；</li>
<li>平板端：布局/交互介于两者之间。</li>
</ul>
<p>项目里有大量类似下面这样的逻辑：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> { deviceType } = <span class="hljs-title function_">useDeviceType</span>();

<span class="hljs-keyword">return</span> (
  <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
    {deviceType === "desktop" &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">DesktopLayout</span> /&gt;</span>}
    {deviceType === "tablet" &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">TabletLayout</span> /&gt;</span>}
    {deviceType === "mobile" &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">MobileLayout</span> /&gt;</span>}
  <span class="hljs-tag">&lt;/&gt;</span></span>
);
</code></pre>
<p>这意味着 <strong>初始渲染阶段的设备类型判断非常关键</strong>，一旦前后不一致，就会导致闪烁、<code>Hydration Mismatch</code> 等问题。</p>
<h2 data-id="heading-2">SSR 环境中拿不到 window 导致页面闪烁</h2>
<h3 data-id="heading-3">问题表现</h3>
<ul>
<li><code>deviceType</code> 默认假定为 <code>"desktop"</code>；</li>
<li>用户在 <strong>手机</strong> 上打开页面时：
<ul>
<li><code>SSR</code> 阶段：服务端根据默认值 <code>"desktop"</code> 渲染；</li>
<li>客户端 <code>hydration</code> 后：<code>useEffect</code> / <code>useLayoutEffect</code> 中根据 <code>window.innerWidth</code> 判断出其实是 <code>"mobile"</code>，然后状态更新；</li>
</ul>
</li>
<li>在这个切换的瞬间，布局会从 <code>desktop</code> 版“瞬间”跳为 <code>mobile</code> 版，非常明显的闪烁。</li>
</ul>
<p>如果你用的是 <code>useLayoutEffect</code>，在 SSR 环境下还会看到：</p>
<blockquote>
<p>Warning: useLayoutEffect does nothing on the server, because its effect cannot be encoded into the server renderer's output...</p>
</blockquote>
<h3 data-id="heading-4">问题根源</h3>
<ul>
<li><code>SSR</code> 环境没有 <code>window</code>，无法用宽度判断设备；</li>
<li>初始渲染的 <code>HTML</code> 是 <code>desktop</code> 版，客户端 <code>hydration</code> 时才“意识到”这是手机；</li>
<li>由于初始 <code>state</code> 和实际设备不匹配，导致：
<ul>
<li><code>UI</code> 闪烁；</li>
<li>以及 <code>hydration mismatch</code> 警告。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-5">解决思路：同构版的 useLayoutEffect</h3>
<ul>
<li><strong>在浏览器端</strong>：使用 <code>useLayoutEffect</code>，在浏览器绘制前完成 DOM 调整，尽量减少闪烁；</li>
<li>**在 <strong><code>SSR</code></strong> 端：不要使用 <code>useLayoutEffect</code>，避免警告，退化为普通的 <code>useEffect</code>。</li>
</ul>
<p>实现方式很简单，封装一个<code>Hook</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { useEffect, useLayoutEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">const</span> useIsomorphicLayoutEffect =
  <span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">"undefined"</span> ? useLayoutEffect : useEffect;
</code></pre>
<p>然后在需要做首屏布局调整的地方，统一用 <code>useIsomorphicLayoutEffect</code> 替换 <code>useLayoutEffect</code>。</p>
<h3 data-id="heading-6">再配合一个关键点：初始值保持一致</h3>
<p>为了避免<code> hydration mismatch</code>，初始 <code>state</code> 必须在 <code>SSR</code> 和客户端首次渲染时保持一致，所以可以这么写：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> [deviceInfo, setDeviceInfo] = useState&lt;<span class="hljs-title class_">DeviceInfo</span>&gt;({
  <span class="hljs-attr">deviceType</span>: <span class="hljs-string">"desktop"</span>,  <span class="hljs-comment">// 服务端 &amp; 客户端初始都认为是 desktop</span>
  <span class="hljs-attr">isMinWidth</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">currentWidth</span>: <span class="hljs-number">1024</span>,
});
</code></pre>
<p>挂载后，再通过 <code>window.innerWidth + UA</code> 去纠正这个默认值。</p>
<h2 data-id="heading-7">iOS 真机上 innerWidth 延迟导致设备误判</h2>
<p>这个坑比第一个更隐蔽一些。</p>
<h3 data-id="heading-8">问题表现</h3>
<p>在某些 <code>iOS</code> 版本的 <code>Safari / PWA </code>中，出现了这样的情况(我的是 <code>iOS26</code>)：</p>
<ol>
<li>页面刚加载时，<code>window.innerWidth</code> 返回的值偏大（类似平板或桌面宽度）；</li>
<li>在初次识别 <code>deviceType</code> 时，逻辑会认为是 <code>"tablet"</code> 或 <code>"desktop"</code>；</li>
<li>用户一滚动/点击，触发重排（<code>reflow</code>）后，<code>innerWidth</code> 才变成实际的手机宽度；</li>
<li>于是 <code>resize</code> 事件触发，又重新判了一次设备类型，这次才变成 <code>"mobile"</code>；</li>
<li>最终结果：页面偶发性地先渲染成平板布局，体验非常差。</li>
</ol>
<h3 data-id="heading-9">解决思路：UA 为主，宽度为辅</h3>
<p>单纯依赖 <code>window.innerWidth</code> 在 <code>iOS</code> 上不够稳。<br/>
更稳妥的方式是：</p>
<ol>
<li><strong>使用 UA 作为第一判断依据</strong><br/>
利用 <code>ua-parser-js</code> 获取设备类型，如果 <code>UA</code> 明确告诉你是 <code>mobile</code>，那就直接按 <code>mobile</code> 处理，明确是 <code>tablet</code>，就直接当平板。</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UAParser</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"ua-parser-js"</span>;

<span class="hljs-keyword">const</span> parser = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UAParser</span>(navigator.<span class="hljs-property">userAgent</span>);
<span class="hljs-keyword">const</span> result = parser.<span class="hljs-title function_">getResult</span>();
<span class="hljs-keyword">const</span> uaDeviceType = result.<span class="hljs-property">device</span>.<span class="hljs-property">type</span>; <span class="hljs-comment">// 'mobile' | 'tablet' | 'console' | 'smarttv' | 'wearable' | undefined</span>
</code></pre>
<ol start="2">
<li><strong>针对 <code>iPad Pro</code> 等 <code>pad</code> 设备做特殊识别</strong><br/>
<code>iPad Pro+Air</code>  <code>UA</code> 会伪装成 <code>Mac</code>，因此需要结合 <code>OS</code> + 能否触摸判断：</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> isIPadPro = result.<span class="hljs-property">os</span>.<span class="hljs-property">name</span> === <span class="hljs-string">"Mac OS"</span> &amp;&amp; navigator.<span class="hljs-property">maxTouchPoints</span> &gt; <span class="hljs-number">1</span>;
</code></pre>
<p>在这种情况下，即使 <code>UA</code> 看起来像 <code>Mac</code> 电脑，也要当平板处理。</p>
<ol start="3">
<li><strong>UA 不明确时，再用宽度兜底</strong><br/>
比如 <code>UA</code> 显示为桌面，或者 <code>UA</code> 不可靠时，可以退回到宽度判断：</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">if</span> (width &lt; <span class="hljs-number">768</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">"mobile"</span>;
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (width &gt;= <span class="hljs-number">768</span> &amp;&amp; width &lt; <span class="hljs-number">1280</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">"tablet"</span>;
}
<span class="hljs-keyword">return</span> <span class="hljs-string">"desktop"</span>;
</code></pre>
<ol start="4">
<li><strong>监听 resize 做矫正</strong><br/>
即使初次判断不完美，也可以在后续 <code>resize</code>（包括横竖屏切换、窗口变化等）时重新计算设备类型进行纠正。</li>
</ol>
<hr/>
<h2 data-id="heading-10">最终实现：useDeviceType Hook</h2>
<p>下面是一个最终整合后的 <code>Hook</code>，实现了：</p>
<ul>
<li>SSR 环境兼容（<code>useIsomorphicLayoutEffect</code>）；</li>
<li><code>UA</code> + 宽度组合判断设备类型；</li>
<li>动态设置 <code>viewport</code> / <code>minWidth</code> / 安全区域样式；</li>
<li>监听 <code>resize</code> 自动更新。</li>
</ul>
<h3 data-id="heading-11">设备类型判断逻辑</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// hooks/useDeviceType.ts</span>
<span class="hljs-keyword">import</span> { useState, useEffect, useLayoutEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UAParser</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"ua-parser-js"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> {
  <span class="hljs-title class_">DeviceInfo</span>,
  <span class="hljs-title class_">DeviceType</span>,
  <span class="hljs-title class_">UseDeviceTypeOptions</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">"~/types/GameDataType"</span>;

<span class="hljs-comment">// SSR 下避免 useLayoutEffect 警告</span>
<span class="hljs-keyword">const</span> useIsomorphicLayoutEffect =
  <span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> !== <span class="hljs-string">"undefined"</span> ? useLayoutEffect : useEffect;

<span class="hljs-comment">// UA + 宽度综合判断设备类型</span>
<span class="hljs-keyword">const</span> getDeviceType = (<span class="hljs-attr">width</span>: <span class="hljs-built_in">number</span>): <span class="hljs-function"><span class="hljs-params">DeviceType</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> parser = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UAParser</span>(navigator.<span class="hljs-property">userAgent</span>);
  <span class="hljs-keyword">const</span> result = parser.<span class="hljs-title function_">getResult</span>();
  <span class="hljs-keyword">const</span> uaDeviceType = result.<span class="hljs-property">device</span>.<span class="hljs-property">type</span>;

  <span class="hljs-comment">// iPad Pro 桌面模式的特殊处理：Mac OS + 支持触摸</span>
  <span class="hljs-keyword">const</span> isIPadPro = result.<span class="hljs-property">os</span>.<span class="hljs-property">name</span> === <span class="hljs-string">"Mac OS"</span> &amp;&amp; navigator.<span class="hljs-property">maxTouchPoints</span> &gt; <span class="hljs-number">1</span>;

  <span class="hljs-comment">// 1. UA 明确识别为 mobile</span>
  <span class="hljs-keyword">if</span> (uaDeviceType === <span class="hljs-string">"mobile"</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"mobile"</span>;
  }

  <span class="hljs-comment">// 2. UA 明确识别为 tablet（包括 iPad Pro）</span>
  <span class="hljs-keyword">if</span> (uaDeviceType === <span class="hljs-string">"tablet"</span> || isIPadPro) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"tablet"</span>;
  }

  <span class="hljs-comment">// 3. 其它情况用宽度兜底</span>
  <span class="hljs-keyword">if</span> (width &lt; <span class="hljs-number">768</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"mobile"</span>;
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (width &gt;= <span class="hljs-number">768</span> &amp;&amp; width &lt; <span class="hljs-number">1280</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"tablet"</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-string">"desktop"</span>;
};
</code></pre>
<h3 data-id="heading-12">Hook 主体</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useDeviceType = (
  <span class="hljs-attr">options</span>: <span class="hljs-title class_">UseDeviceTypeOptions</span> = {}
): <span class="hljs-function"><span class="hljs-params">DeviceInfo</span> =&gt;</span> {
  <span class="hljs-keyword">const</span> {
    minWidth = <span class="hljs-number">240</span>,
    preventZoom = <span class="hljs-literal">true</span>,
    enableSafeAreas = <span class="hljs-literal">true</span>,
  } = options;

  <span class="hljs-comment">// SSR &amp; 客户端初始保持一致，避免 Hydration Mismatch</span>
  <span class="hljs-keyword">const</span> [deviceInfo, setDeviceInfo] = useState&lt;<span class="hljs-title class_">DeviceInfo</span>&gt;({
    <span class="hljs-attr">deviceType</span>: <span class="hljs-string">"desktop"</span>,
    <span class="hljs-attr">isMinWidth</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">currentWidth</span>: <span class="hljs-number">1024</span>,
  });

  <span class="hljs-title function_">useIsomorphicLayoutEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">checkDevice</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">const</span> width = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>;
      <span class="hljs-keyword">const</span> isAtMinWidth = width &lt;= minWidth;

      <span class="hljs-keyword">const</span> deviceType = <span class="hljs-title function_">getDeviceType</span>(width);

      <span class="hljs-title function_">setDeviceInfo</span>({
        deviceType,
        <span class="hljs-attr">isMinWidth</span>: isAtMinWidth,
        <span class="hljs-attr">currentWidth</span>: width,
      });

      <span class="hljs-comment">// 如果有需要，可以持久化</span>
      <span class="hljs-comment">// localStorage.setItem("deviceType", deviceType);</span>
    };

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">setViewport</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">let</span> viewport = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'meta[name="viewport"]'</span>);

      <span class="hljs-keyword">if</span> (!viewport) {
        viewport = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"meta"</span>);
        viewport.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">"name"</span>, <span class="hljs-string">"viewport"</span>);
        <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(viewport);
      }

      <span class="hljs-keyword">if</span> (preventZoom) {
        viewport.<span class="hljs-title function_">setAttribute</span>(
          <span class="hljs-string">"content"</span>,
          <span class="hljs-string">"width=device-width, initial-scale=1.0, "</span> +
            <span class="hljs-string">"minimum-scale=1.0, maximum-scale=1.0, "</span> +
            <span class="hljs-string">"user-scalable=no, viewport-fit=cover"</span>
        );
      } <span class="hljs-keyword">else</span> {
        viewport.<span class="hljs-title function_">setAttribute</span>(
          <span class="hljs-string">"content"</span>,
          <span class="hljs-string">"width=device-width, initial-scale=1.0"</span>
        );
      }
    };

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">setMinWidthStyle</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-keyword">const</span> styleId = <span class="hljs-string">"min-width-style"</span>;
      <span class="hljs-keyword">let</span> styleElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(styleId) <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLStyleElement</span>;

      <span class="hljs-keyword">if</span> (!styleElement) {
        styleElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"style"</span>);
        styleElement.<span class="hljs-property">id</span> = styleId;
        <span class="hljs-variable language_">document</span>.<span class="hljs-property">head</span>.<span class="hljs-title function_">appendChild</span>(styleElement);
      }

      styleElement.<span class="hljs-property">textContent</span> = <span class="hljs-string">`
        body {
          min-width: <span class="hljs-subst">${minWidth}</span>px;
          overflow-x: auto;
        }
        .container-limit {
          min-width: <span class="hljs-subst">${minWidth}</span>px;
        }
        <span class="hljs-subst">${
          enableSafeAreas
            ? <span class="hljs-string">`
        .safe-area-bottom {
          padding-bottom: env(safe-area-inset-bottom);
        }
        .safe-area-left {
          padding-left: env(safe-area-inset-left);
        }
        .safe-area-right {
          padding-right: env(safe-area-inset-right);
        }
        `</span>
            : <span class="hljs-string">""</span>
        }</span>
      `</span>;
    };

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleResize</span> = (<span class="hljs-params"/>) =&gt; {
      <span class="hljs-title function_">checkDevice</span>();
      <span class="hljs-title function_">setViewport</span>();
      <span class="hljs-title function_">setMinWidthStyle</span>();
    };

    <span class="hljs-comment">// 挂载后立即执行一次，尽量在首屏绘制前完成</span>
    <span class="hljs-title function_">handleResize</span>();

    <span class="hljs-comment">// 监听 resize 做后续矫正，可以加防抖节流</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"resize"</span>, handleResize);

    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">"resize"</span>, handleResize);
    };
  }, [minWidth, preventZoom, enableSafeAreas]);

  <span class="hljs-keyword">return</span> deviceInfo;
};
</code></pre>
<p>使用时非常简单：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> { deviceType, currentWidth, isMinWidth } = <span class="hljs-title function_">useDeviceType</span>();

<span class="hljs-keyword">if</span> (deviceType === <span class="hljs-string">"desktop"</span>) {
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-13">一些兼容性和架构层面的思考</h2>
<p>即便上面这一套 <code>UA</code> + 宽度 + <code>resize</code> 的方案在大部分情况下能跑得比较稳，但仍有一些潜在问题：</p>
<ul>
<li><code>UA</code> 本身不可靠：被伪装、被浏览器修改；</li>
<li>新设备 / 新系统版本出现新的 UA 组合，需要不断维护规则；</li>
<li>某些嵌入式 <code>WebView</code> 或特殊浏览器的行为不确定。</li>
</ul>
<p>从长期维护成本和复杂度来看，如果业务允许，我更推荐下面这种方式：</p>
<ul>
<li><code>PC</code> 与 <code>Mobile</code>/<code>Pad</code> 分两套代码</li>
<li><code>Mobile</code> 内部用媒体查询区分 <code>Phone</code> / <code>Tablet</code></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kubernetes Deployment 配置简化实战：从复杂到高效]]></title>    <link>https://juejin.cn/post/7577228831138168875</link>    <guid>https://juejin.cn/post/7577228831138168875</guid>    <pubDate>2025-11-27T13:22:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577228831138168875" data-draft-id="7577198193216045099" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kubernetes Deployment 配置简化实战：从复杂到高效"/> <meta itemprop="keywords" content="Kubernetes"/> <meta itemprop="datePublished" content="2025-11-27T13:22:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kubernetes Deployment 配置简化实战：从复杂到高效
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T13:22:13.000Z" title="Thu Nov 27 2025 13:22:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言：Deployment 配置的复杂性挑战</h2>
<p>在 Kubernetes 中，Deployment 是管理无状态应用的核心资源对象，它通过声明式配置为我们提供了副本管理、滚动更新、版本回滚等强大功能。然而，随着应用复杂度的增加，Deployment 配置文件也变得愈发冗长和复杂，一个生产环境的 YAML 文件可能包含数十个参数，这给维护和正确性带来了严峻挑战。</p>
<p>本文将系统性地介绍多种简化 Kubernetes Deployment 配置的策略和工具，帮助您在保持功能完整性的同时，显著降低配置复杂度和出错概率。</p>
<h2 data-id="heading-1">一、问题根源：为什么 Deployment 配置如此复杂？</h2>
<p>在探讨解决方案前，我们首先需要理解 Deployment 配置复杂性的根源。一个典型的生产级 Deployment 配置可能包含以下多个维度的参数：</p>
<ul>
<li><strong>基础配置</strong>：副本数量、镜像标签、容器端口</li>
<li><strong>资源管理</strong>：CPU/内存请求和限制</li>
<li><strong>健康检查</strong>：就绪探针、存活探针、启动探针</li>
<li><strong>更新策略</strong>：滚动更新参数、最大不可用比例</li>
<li><strong>安全上下文</strong>：用户权限、安全策略</li>
<li><strong>环境配置</strong>：环境变量、配置映射、密钥</li>
</ul>
<p>这种复杂性源于生产环境对<strong>应用高可用性</strong>、<strong>可扩展性</strong>和<strong>可观测性</strong>的严格要求。直接修改这些冗长的 YAML 文件不仅容易出错，而且在多环境部署时难以保持一致性。</p>
<h2 data-id="heading-2">二、解决方案一：模板化与抽象化</h2>
<h3 data-id="heading-3">2.1 使用 Helm 进行应用打包</h3>
<p>Helm 作为 Kubernetes 的包管理器，通过模板化和值分离，极大地简化了多环境部署的复杂度。</p>
<p><strong>核心优势</strong>：</p>
<ul>
<li>模板引擎：使用 Go 模板语言，支持条件判断和循环</li>
<li>值覆盖：通过独立的 values.yaml 文件管理环境差异化配置</li>
<li>依赖管理：支持子图表和依赖关系解析</li>
</ul>
<p><strong>实战示例</strong>：</p>
<p>创建一个基本的 Helm 图表结构：</p>
<pre><code class="hljs language-markdown" lang="markdown">my-app-chart/
├── Chart.yaml
├── values.yaml
└── templates/
<span class="hljs-code">    ├── deployment.yaml
    ├── service.yaml
    └── configmap.yaml
</span></code></pre>
<p>在 <code>templates/deployment.yaml</code>中使用模板变量：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> {{ <span class="hljs-string">.Release.Name</span> }}<span class="hljs-string">-deployment</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> {{ <span class="hljs-string">.Values.replicaCount</span> }}
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> {{ <span class="hljs-string">.Chart.Name</span> }}
        <span class="hljs-attr">image:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ .Values.image.repository }}</span>:<span class="hljs-template-variable">{{ .Values.image.tag }}</span>"</span>
        <span class="hljs-attr">ports:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> {{ <span class="hljs-string">.Values.service.port</span> }}
</code></pre>
<p>对应的 <code>values.yaml</code>提供默认值：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">replicaCount:</span> <span class="hljs-number">3</span>
<span class="hljs-attr">image:</span>
  <span class="hljs-attr">repository:</span> <span class="hljs-string">nginx</span>
  <span class="hljs-attr">tag:</span> <span class="hljs-string">stable</span>
<span class="hljs-attr">service:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">80</span>
</code></pre>
<p>通过这种方式，我们可以为不同环境（开发、测试、生产）创建不同的 values 文件，而保持模板不变。</p>
<h3 data-id="heading-4">2.2 使用 Kustomize 进行配置覆盖</h3>
<p>Kustomize 采用"基础+覆盖"的模型，不需要学习模板语法即可实现配置差异化。</p>
<p><strong>项目结构示例</strong>：</p>
<pre><code class="hljs language-csharp" lang="csharp">my-app/
├── <span class="hljs-keyword">base</span>/
│   ├── kustomization.yaml
│   ├── deployment.yaml
│   └── service.yaml
└── overlays/
    ├── development/
    │   ├── kustomization.yaml
    │   └── replica-patch.yaml
    └── production/
        ├── kustomization.yaml
        ├── replica-patch.yaml
        └── hpa.yaml
</code></pre>
<p><strong>开发环境覆盖配置</strong>（overlays/development/kustomization.yaml）：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">apiVersion: kustomize.config.k8s.io/v1beta1</span>
<span class="hljs-section">kind: Kustomization</span>

<span class="hljs-section">resources:</span>
- ../../base

<span class="hljs-section">patchesStrategicMerge:</span>
- replica-patch.yaml

<span class="hljs-section">namePrefix: dev-</span>
</code></pre>
<p>这种方法避免了模板语法复杂度，直接使用原生 YAML 进行配置补丁。</p>
<h2 data-id="heading-5">三、解决方案二：自动化部署流程</h2>
<h3 data-id="heading-6">3.1 使用 Skaffold 实现持续开发</h3>
<p>Skaffold 是谷歌开发的 Kubernetes 开发工具，可以自动化构建、推送和部署流程。</p>
<p><strong>Skaffold 核心特性</strong>：</p>
<ul>
<li>自动检测代码变更并触发重新部署</li>
<li>支持多种部署工具（kubectl、Helm、Kustomize）</li>
<li>提供端到端的开发工作流</li>
</ul>
<p><strong>基础配置示例</strong>（skaffold.yaml）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">skaffold/v4beta13</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Config</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">my-app</span>
<span class="hljs-attr">build:</span>
  <span class="hljs-attr">artifacts:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">my-app</span>
    <span class="hljs-attr">context:</span> <span class="hljs-string">src</span>
    <span class="hljs-attr">docker:</span>
      <span class="hljs-attr">dockerfile:</span> <span class="hljs-string">Dockerfile</span>
<span class="hljs-attr">deploy:</span>
  <span class="hljs-attr">kubectl:</span>
    <span class="hljs-attr">manifests:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">k8s/*.yaml</span>
<span class="hljs-attr">profiles:</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">dev</span>
  <span class="hljs-attr">deploy:</span>
    <span class="hljs-attr">kustomize:</span>
      <span class="hljs-attr">paths:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">overlays/dev</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">prod</span>
  <span class="hljs-attr">deploy:</span>
    <span class="hljs-attr">helm:</span>
      <span class="hljs-attr">releases:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">my-app</span>
        <span class="hljs-attr">chartPath:</span> <span class="hljs-string">charts/my-app</span>
</code></pre>
<p>通过 Skaffold，开发者只需运行 <code>skaffold dev</code>即可进入自动化开发循环，大幅简化本地开发和调试流程。</p>
<h3 data-id="heading-7">3.2 GitOps 工作流</h3>
<p>结合 ArgoCD 或 Flux 实现 GitOps，将配置存储在版本控制系统内，实现声明式的基础设施管理。</p>
<p><strong>GitOps 核心原则</strong>：</p>
<ul>
<li>声明式：系统状态通过声明性描述定义</li>
<li>版本控制：所有配置变更版本化、可审计</li>
<li>自动同步：系统自动检测配置变更并应用</li>
<li>自愈：系统持续趋向期望状态</li>
</ul>
<h2 data-id="heading-8">四、解决方案三：配置最佳实践</h2>
<h3 data-id="heading-9">4.1 健康检查标准化</h3>
<p>正确配置健康检查探针是确保应用高可用的基础。</p>
<p><strong>探针配置示例</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">containers:</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app</span>
  <span class="hljs-attr">livenessProbe:</span>
    <span class="hljs-attr">httpGet:</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">/health</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
    <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">30</span>
    <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>
    <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">5</span>
  <span class="hljs-attr">readinessProbe:</span>
    <span class="hljs-attr">httpGet:</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">/ready</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
    <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">5</span>
    <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">5</span>
    <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">3</span>
  <span class="hljs-attr">startupProbe:</span>
    <span class="hljs-attr">httpGet:</span>
      <span class="hljs-attr">path:</span> <span class="hljs-string">/startup</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
    <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">30</span>
    <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>
</code></pre>
<p>健康检查确保 Kubernetes 能够准确判断应用状态，是实现自愈和滚动更新的基础。</p>
<h3 data-id="heading-10">4.2 资源管理与限制</h3>
<p>合理设置资源请求和限制是保证应用稳定运行的关键。</p>
<p><strong>资源限制示例</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">resources:</span>
  <span class="hljs-attr">requests:</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">"128Mi"</span>
    <span class="hljs-attr">cpu:</span> <span class="hljs-string">"250m"</span>
  <span class="hljs-attr">limits:</span>
    <span class="hljs-attr">memory:</span> <span class="hljs-string">"512Mi"</span>
    <span class="hljs-attr">cpu:</span> <span class="hljs-string">"1000m"</span>
</code></pre>
<p>资源管理最佳实践：</p>
<ul>
<li>始终设置资源请求和限制</li>
<li>通过 HPA 实现自动扩缩容</li>
<li>定期监控资源使用情况并优化</li>
</ul>
<h3 data-id="heading-11">4.3 命名空间与标签策略</h3>
<p>使用命名空间和标签实现逻辑隔离和资源组织。</p>
<p><strong>标签标准化示例</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">user-service</span>
    <span class="hljs-attr">version:</span> <span class="hljs-string">v1.2.3</span>
    <span class="hljs-attr">environment:</span> <span class="hljs-string">production</span>
    <span class="hljs-attr">tier:</span> <span class="hljs-string">backend</span>
</code></pre>
<p>统一的标签策略便于资源查询、监控和自动化管理。</p>
<h2 data-id="heading-12">五、渐进式配置策略</h2>
<h3 data-id="heading-13">5.1 从简单开始，逐步完善</h3>
<p>不要试图一次性创建完美的 Deployment 配置，而应采用渐进式方法：</p>
<ol>
<li><strong>基础阶段</strong>：仅包含必要字段（镜像、副本数、端口）</li>
<li><strong>增强阶段</strong>：添加健康检查、资源限制</li>
<li><strong>优化阶段</strong>：配置高级策略（网络、安全、存储）</li>
</ol>
<p><strong>基础配置示例</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">my-app</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">my-app</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">my-app</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">app</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">my-app:latest</span>
        <span class="hljs-attr">ports:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span>
</code></pre>
<h3 data-id="heading-14">5.2 配置验证与自动化测试</h3>
<p>将配置验证集成到 CI/CD 流水线中，确保变更安全可靠。</p>
<p><strong>验证步骤</strong>：</p>
<ol>
<li>语法验证：<code>kubectl apply --dry-run=client -f deployment.yaml</code></li>
<li>策略检查：使用 OPA/Conftest 验证安全策略</li>
<li>集成测试：在测试环境验证配置正确性</li>
</ol>
<h2 data-id="heading-15">六、工具链整合</h2>
<p>以下表格对比了不同简化方案的特点和适用场景：</p>



































<table><thead><tr><th>工具/方法</th><th>核心优势</th><th>适用场景</th><th>学习曲线</th></tr></thead><tbody><tr><td>Helm</td><td>强大的模板化、版本管理、依赖解决</td><td>复杂应用、多环境部署、应用分发</td><td>中等</td></tr><tr><td>Kustomize</td><td>无模板、纯 YAML、Kubernetes 原生</td><td>环境差异化、配置补丁、简单应用</td><td>平缓</td></tr><tr><td>Skaffold</td><td>自动化开发流程、快速反馈</td><td>本地开发、持续集成、微服务架构</td><td>中等</td></tr><tr><td>GitOps</td><td>声明式、版本控制、自愈能力</td><td>生产环境、团队协作、合规要求</td><td>陡峭</td></tr></tbody></table>
<h2 data-id="heading-16">七、实战案例：电商应用配置简化</h2>
<p>假设我们有一个电商应用，需要管理前端、后端和数据库多个组件。</p>
<p><strong>原始复杂配置</strong>（部分）：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 原始冗长且重复的配置</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">ecommerce-frontend</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">frontend</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">frontend:1.2.3</span>
        <span class="hljs-attr">env:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">DB_HOST</span>
          <span class="hljs-attr">value:</span> <span class="hljs-string">"db.example.com"</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">API_ENDPOINT</span>  
          <span class="hljs-attr">value:</span> <span class="hljs-string">"https://api.example.com"</span>
        <span class="hljs-comment"># ... 更多环境变量</span>
</code></pre>
<p><strong>简化后配置</strong>（使用 Kustomize + Helm）：</p>
<ol>
<li><strong>基础配置</strong>（base/deployment.yaml）：</li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> {{ <span class="hljs-string">.Release.Name</span> }}<span class="hljs-string">-frontend</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> {{ <span class="hljs-string">.Values.replicaCount</span> }}
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">frontend</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ .Values.image.repository }}</span>:<span class="hljs-template-variable">{{ .Values.image.tag }}</span>"</span>
        <span class="hljs-attr">envFrom:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">configMapRef:</span>
            <span class="hljs-attr">name:</span> {{ <span class="hljs-string">.Release.Name</span> }}<span class="hljs-string">-environment</span>
</code></pre>
<ol>
<li><strong>环境特定值</strong>（values/production.yaml）：</li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">replicaCount:</span> <span class="hljs-number">5</span>
<span class="hljs-attr">image:</span>
  <span class="hljs-attr">repository:</span> <span class="hljs-string">frontend</span>
  <span class="hljs-attr">tag:</span> <span class="hljs-number">2.0</span><span class="hljs-number">.0</span><span class="hljs-string">-prod</span>
</code></pre>
<ol>
<li><strong>配置映射生成</strong>：</li>
</ol>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">apiVersion:</span> v1
<span class="hljs-symbol">kind:</span> ConfigMap
<span class="hljs-symbol">metadata:</span>
  name: {{ .Release.Name }}-environment
<span class="hljs-symbol">data:</span>
  {{- range $<span class="hljs-keyword">key</span>, $value := .Values.environment }}
  {{ $<span class="hljs-keyword">key</span> }}: {{ $value | quote }}
  {{- <span class="hljs-keyword">end</span> }}
</code></pre>
<p>这种方法将配置分解为可管理的部分，大幅提升了可维护性。</p>
<h2 data-id="heading-17">八、总结</h2>
<p>Kubernetes Deployment 配置的复杂性是不可避免的，但通过合适的工具和方法，我们可以将这种复杂性有效管理起来。关键要点总结如下：</p>
<ol>
<li><strong>工具选择</strong>：根据团队规模和技术栈选择合适的工具组合（Helm + Kustomize + Skaffold）</li>
<li><strong>渐进采纳</strong>：从简单配置开始，逐步添加高级功能</li>
<li><strong>标准化</strong>：建立团队统一的配置规范和最佳实践</li>
<li><strong>自动化</strong>：将验证、测试和部署流程自动化</li>
<li><strong>文档化</strong>：为配置模板和值文件提供清晰的文档</li>
</ol>
<p>通过实施这些策略，您不仅能够降低 Kubernetes Deployment 的配置复杂度，还能提升部署效率和应用可靠性，真正发挥 Kubernetes 作为容器编排平台的强大能力。</p>
<blockquote>
<p>本文介绍的方法和工具可以单独或组合使用，建议团队根据具体需求和技能水平选择最适合的简化路径，逐步建立高效可靠的 Kubernetes 应用交付流程。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kubernetes滚动发布详解]]></title>    <link>https://juejin.cn/post/7577220965438406710</link>    <guid>https://juejin.cn/post/7577220965438406710</guid>    <pubDate>2025-11-27T14:24:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577220965438406710" data-draft-id="7577278843233353771" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kubernetes滚动发布详解"/> <meta itemprop="keywords" content="Kubernetes"/> <meta itemprop="datePublished" content="2025-11-27T14:24:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kubernetes滚动发布详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T14:24:07.000Z" title="Thu Nov 27 2025 14:24:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Kubernetes 中的滚动发布（Rolling Update）是一种非常优雅的部署策略，它能让你在更新应用时，实现<strong>零停机</strong>和<strong>用户无感知</strong>的平滑升级。下面这张图清晰地展示了它的核心工作流程：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/992c09ff7ece4fb0a77945fdf73376ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTmqZjlrZDnmq4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764858302&amp;x-signature=C0ZEOOBSCWEfjFdgOTYaXGkU79Y%3D" alt="image.png" loading="lazy"/></p>
<p>下面，我们详细解读这个过程，并看看如何掌控它。</p>
<h3 data-id="heading-0">🔄 滚动发布如何工作</h3>
<p>滚动发布的核心思想是<strong>逐步替换</strong>。它不是一次性停止所有旧版本的 Pod（实例），然后再启动所有新版本的 Pod。相反，它遵循一个精心控制的流程：</p>
<ol>
<li><strong>逐步更替</strong>：如流程图所示，系统会先启动一个<strong>新版本 Pod</strong>（V2），并等待其通过<strong>就绪探针</strong>检查，确认其已准备好接收流量。</li>
<li><strong>流量切换</strong>：一旦新的 Pod 就绪，负载均衡器（通常是 Kubernetes Service）就会将流量引导到它上面，同时<strong>终止一个旧版本 Pod</strong>（V1）。</li>
<li><strong>循环往复</strong>：这个过程循环进行，直到所有旧版本的 Pod 都被替换为新版本的 Pod。</li>
</ol>
<p>这种方式确保了在整个更新过程中，始终有可用的 Pod 实例在对外提供服务，从而实现了零停机。</p>
<h3 data-id="heading-1">⚙️ 核心配置参数</h3>
<p>滚动发布的精细控制，主要通过 Deployment 配置中的 <code>strategy.rollingUpdate</code>下的两个关键参数实现：</p>























<table><thead><tr><th>参数</th><th>作用</th><th>默认值</th><th>生产环境建议</th></tr></thead><tbody><tr><td>**<code>maxSurge</code>**​</td><td>控制<strong>最多能创建多少个超出期望副本数</strong>的 Pod。</td><td>25%</td><td>通常设置为 1 或 25%。这相当于更新过程中的“缓冲区”，允许新 Pod 提前启动。</td></tr><tr><td>**<code>maxUnavailable</code>**​</td><td>控制<strong>在更新过程中，最多允许多少个 Pod 不可用</strong>。</td><td>25%</td><td>对于要求高可用的服务，可设置为 0，确保更新期间服务容量不降低。</td></tr></tbody></table>
<p><strong>举个例子</strong>：如果你的应用有 4 个副本，并设置 <code>maxSurge=1</code>（最多可超 1 个 Pod），<code>maxUnavailable=0</code>（不允许任何 Pod 不可用）。那么滚动更新时，Kubernetes 会先创建一个新 Pod（此时总数为 5 个），待其就绪后，再终止一个旧 Pod（总数恢复 4 个），如此循环。这样，任何时候都至少有 4 个 Pod 是可用的。</p>
<h3 data-id="heading-2">🛠️ 实战操作指南</h3>
<p>掌握了原理后，你可以通过以下命令来管理和监控滚动发布：</p>

































<table><thead><tr><th>命令</th><th>功能</th></tr></thead><tbody><tr><td><code>kubectl set image deployment/&lt;部署名称&gt; &lt;容器名&gt;=&lt;新镜像&gt;:&lt;标签&gt;</code></td><td><strong>触发更新</strong>。这是最常用的触发方式。</td></tr><tr><td><code>kubectl rollout status deployment/&lt;部署名称&gt;</code></td><td><strong>实时查看</strong>更新状态和进度。</td></tr><tr><td><code>kubectl rollout pause deployment/&lt;部署名称&gt;</code></td><td><strong>暂停</strong>滚动更新。适用于想在某个中间状态进行验证的场景。</td></tr><tr><td><code>kubectl rollout resume deployment/&lt;部署名称&gt;</code></td><td><strong>继续</strong>被暂停的滚动更新。</td></tr><tr><td><code>kubectl rollout undo deployment/&lt;部署名称&gt;</code></td><td><strong>回滚</strong>到上一个版本。这是滚动发布带来的巨大优势之一。</td></tr><tr><td><code>kubectl get pods -w</code></td><td><strong>观察 Pod 的新旧替换过程</strong>，直观看到流程图中的每一步。</td></tr></tbody></table>
<h3 data-id="heading-3">💡 确保平滑发布的进阶技巧</h3>
<p>要让滚动发布真正丝滑，还需要注意以下几点：</p>
<ol>
<li><strong>配置就绪探针</strong>：这是最重要的配置！<code>readinessProbe</code>告诉 Kubernetes 你的应用<strong>何时真正准备好</strong>接收流量。如果没有它，Kubernetes 会在容器进程启动后立即发送流量，而此时你的应用（如 Spring Boot 项目）可能还在加载 Spring 上下文或连接数据库，导致请求失败。务必根据应用启动特点配置合理的路径和延迟时间。</li>
<li><strong>配置优雅终止</strong>：在 Pod 被终止时，Kubernetes 会向容器内的进程发送 SIGTERM 信号。你的应用应该捕获这个信号，然后停止接收新请求，并等待已有请求处理完成后再退出。这可以通过在 Deployment 中配置 <code>spec.template.spec.terminationGracePeriodSeconds</code>并结合 <code>preStop</code>钩子来实现，给应用一个清理和退出的缓冲时间。</li>
<li><strong>避免使用 <code>latest</code>标签</strong>：在 Deployment 的 YAML 中，明确指定镜像版本标签。使用 <code>latest</code>标签会导致无法清晰追踪当前运行的版本，也给回滚带来不确定性。</li>
</ol>
<h3 data-id="heading-4">⚖️ 优缺点与策略对比</h3>



































<table><thead><tr><th>特点</th><th>滚动发布</th><th>重建发布</th><th>蓝绿发布</th></tr></thead><tbody><tr><td><strong>发布方式</strong>​</td><td>逐步替换，新老版本<strong>同时存在</strong>一段时间</td><td>先<strong>全部停止</strong>旧版本，再启动新版本</td><td>部署<strong>两套完整环境</strong>，流量一次性切换</td></tr><tr><td><strong>资源占用</strong>​</td><td>低（只需运行一套环境）</td><td>低（只需运行一套环境）</td><td>高（需要两套环境的资源）</td></tr><tr><td><strong>发布风险</strong>​</td><td>中（风险被分散，可快速回滚）</td><td>高（服务有中断期）</td><td>低（回滚极快）</td></tr><tr><td><strong>复杂度</strong>​</td><td>低（Kubernetes 原生支持）</td><td>低</td><td>中（需要额外的流量控制能力）</td></tr></tbody></table>
<h3 data-id="heading-5">💎 总结</h3>
<p>总而言之，Kubernetes 的滚动发布是一种强大且实用的部署策略。理解其<strong>逐步替换</strong>的工作原理，熟练运用 <strong><code>maxSurge</code>和 <code>maxUnavailable</code><strong>​ 来控制节奏，并结合</strong>就绪探针和优雅终止</strong>等最佳实践，你就能真正掌握在 Kubernetes 上进行平滑、无损应用发布的艺术。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[火山引擎多媒体实验室AIGC视频画质理解大模型VQ-Insight入选AAAI 2025 Oral]]></title>    <link>https://juejin.cn/post/7577431644069036083</link>    <guid>https://juejin.cn/post/7577431644069036083</guid>    <pubDate>2025-11-28T08:25:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577431644069036083" data-draft-id="7577430671947644954" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="火山引擎多媒体实验室AIGC视频画质理解大模型VQ-Insight入选AAAI 2025 Oral"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-28T08:25:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="字节跳动视频云技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/3026268632912584"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            火山引擎多媒体实验室AIGC视频画质理解大模型VQ-Insight入选AAAI 2025 Oral
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3026268632912584/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    字节跳动视频云技术团队
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T08:25:39.000Z" title="Fri Nov 28 2025 08:25:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>会议背景</strong></p>
<p>近日，AAAI 2026公布了录用结果，该会议是是人工智能领域极具影响力的国际顶级学术会议之一。据悉本次会议共有23680篇投稿进入审稿阶段，最终4167篇论文被录用，录取率为17.6%。</p>
<p>火山引擎多媒体实验室和北京大学合作的论文<strong>VQ-Insight: Teaching VLMs for AI-Generated Video Quality Understanding via Progressive Visual Reinforcement Learning</strong> 被选为本次会议口头汇报文章。</p>
<p><strong>VQ-Insight：AIGC视频画质理解大模型</strong></p>
<p><strong>论文背景</strong></p>
<p>随着视频生成模型的涌现，仅凭一句提示词或一张图片生成逼真、生动的高质感视频正逐渐成为现实。随着 AIGC 视频技术加速演进，<strong>如何在后训练阶段进一步提升模型的生成质量</strong>变得尤为关键。可靠的质量评估与偏好选择不仅是评价工具，更是后训练的重要驱动力，它们能够精确引导视频生成模型向人眼感知对齐，从而显著提升画面质量与时序一致性。</p>
<p>此前，北京大学与火山引擎多媒体实验室联合提出了首个基于强化学习训练的多模态大模型图像画质理解方案 <strong>Q-Insight</strong>。该方法摆脱了对大规模文本标注的依赖，充分挖掘大模型的推理潜力，使其能够深入思考图像质量背后的本质因素。然而，将这一思路扩展到 AIGC 视频评估仍面临新的挑战，即：<strong>1）</strong> 如何更有效地激发大模型的时序感知能力与多维度画质理解能力；<strong>2）</strong> 如何建立评估模型与生成模型的反馈互动，使两者在优化过程中获得动态增强，相互促进。 </p>
<p><strong>渐进式视觉质量强化学习框架</strong></p>
<p>图像只捕捉视频的一个切片，用户真实的视频观看体验还取决于时间维度，例如运动是否自然？色彩是否在动态中稳定？因此，我们把Q-Insight的“推理式 + 强化学习”思路，拓展到自然视频和AIGC视频中，提出了推理式AIGC视频画质理解大模型<strong>VQ-Insight</strong>。该方法使用渐进式的视觉质量强化学习框架，包括图像打分预热阶段、任务驱动的通用时序学习阶段以及与视频生成模型的联合微调阶段。通过由易到难、由通用到具体的视频质量打分学习，仅使用少量数据就能教会AIGC视频偏好比较，AIGC视频多维度打分，自然视频打分等多项任务，并最终建立和下游生成模型的专项评估能力。同时，该方法引入时序建模奖励函数和长度控制奖励函数，鼓励大模型探索视频帧间的相关性和连贯性，并提供对于视频质量线索的丰富分析，增强偏好比较和分数回归的准确性。</p>
<p>进一步，该方法提出了一种生成模型与质量评估模型“共同进化”的联合训练方式：生成模型每一轮都会产生一批新视频，VQ-Insight自动从中挑选出更好的和更差的样本，构建高质量偏好数据；这些偏好数据既用于继续优化视频生成模型（如 DPO），也用于反向加强 VQ-Insight 的偏好理解能力，使其逐步适配并引导当前的生成模型。通过这种闭环式的协同优化，生成模型和评估模型会随着迭代不断变强，实现“越生成越懂、越懂越能生”的持续提升效果。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b0e7c3c3d834642b6d3fb7c02d4366a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo6KeG6aKR5LqR5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764923139&amp;x-signature=ZD%2FPfVZJlRKH%2FdphFmmeNL0I4vI%3D" alt="图片1.png" loading="lazy"/></p>
<p><strong>实验结果</strong></p>
<p>实验结果充分验证了VQ-Insight在AIGC视频偏好比较，多维度打分和自然视频打分任务中的卓越表现。</p>
<p>• 在AIGC偏好比较任务上，VQ-Insight在多个公开数据集上的表现均超过当前最先进的方法，并能够从视觉质量、时序一致性、动态程度和视频真实性方面提供完整详细的推理过程。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbec38ab5244400fb8725acf4c104c2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo6KeG6aKR5LqR5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764923139&amp;x-signature=EdxjUJwL5lBIovw7JBd3rrQ%2BREM%3D" alt="图片2.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1ded8bab34f4d2aa0f9757ae0df5568~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo6KeG6aKR5LqR5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764923139&amp;x-signature=1If2M1R3fIQIF%2BAuqUpAO0UqS5k%3D" alt="图片3.png" loading="lazy"/></p>
<p>• 在AIGC多维度打分任务上，VQ-Insight能够在空间质量、时序质量和文本视频一致性打分上都取得最优性能。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/61c2dc3f8c8f4ffe8d247a9e1c35e6d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo6KeG6aKR5LqR5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764923139&amp;x-signature=0bEYIA7SXxtKDxMET0w1coPBLAY%3D" alt="图片4.png" loading="lazy"/></p>
<p>• 在自然视频打分任务上，VQ-Insight同样表现出出色的分数拟合精确度，特别是在域外数据集上泛化能力突出。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff5da555e9a84f468e9e46825769e379~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo6KeG6aKR5LqR5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764923139&amp;x-signature=XLBYzxgd32q6cPd8VKqftyePpH8%3D" alt="图片5.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2af8022fbfc43248cbb2b946d786822~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo6KeG6aKR5LqR5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764923139&amp;x-signature=gwtYmlN99DRjXDx%2BsdaUaqZBH3A%3D" alt="图片6.png" loading="lazy"/></p>
<p>• VQ-Insight强大的AIGC视频偏好比较能力，可直接应用于视频生成模型的直接偏好优化（DPO）。如图所示，基于VQ-Insight的方案相比于生成模型基线和对比方法，有效地缓解了错误生成的问题，并有着更鲜艳的色彩和动态。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8535ff4bef26447fa02d2a436abdc326~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo6KeG6aKR5LqR5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764923139&amp;x-signature=NF65fTa6K1KbDewh7saWisHWzFE%3D" alt="图片7.png" loading="lazy"/>
<strong>总结</strong></p>
<p>VQ-Insight 将“推理式 + 强化学习”思路应用于AIGC视频画质理解任务中，在偏好比较、多维度画质打分与自然视频质量评估等任务上均取得了突破性表现。通过渐进式视觉质量强化学习框架与创新的时序奖励机制，VQ-Insight 能够以极少的数据实现强泛化和强解释性，精准捕捉视频的空间清晰度、动态一致性、内容真实性等多维度质量特征。更重要的是，VQ-Insight 已能直接用于生成模型的后训练，成为生成视频训练的可插拔奖励与偏好模块，把“看得准”转化为“生成得更好”，为未来的视频生成模型带来更稳定、更符合人眼感知的画面质量，为下一代 AIGC 视频生成技术的发展奠定了关键基础。</p>
<p><strong>相关链接</strong></p>
<p>��VQ-Insight: <a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2506.18564" target="_blank" title="https://arxiv.org/pdf/2506.18564" ref="nofollow noopener noreferrer">arxiv.org/pdf/2506.18…</a></p>
<p>��Q-Insight: <a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2503.22679" target="_blank" title="https://arxiv.org/pdf/2503.22679" ref="nofollow noopener noreferrer">arxiv.org/pdf/2503.22…</a></p>
<p>⭐️训练与推理代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbytedance%2FQ-Insight" target="_blank" title="https://github.com/bytedance/Q-Insight" ref="nofollow noopener noreferrer">github.com/bytedance/Q…</a></p>
<p>��开源模型：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2FByteDance%2FQ-Insight" target="_blank" title="https://huggingface.co/ByteDance/Q-Insight" ref="nofollow noopener noreferrer">huggingface.co/ByteDance/Q…</a></p>
<p><strong>团队介绍</strong></p>
<p>多媒体实验室是字节跳动旗下的研究团队，致力于探索多媒体领域的前沿技术，参与国际标准化工作，其众多创新算法及软硬件解决方案已经广泛应用在抖音、西瓜视频等产品的多媒体业务，并向火山引擎的企业级客户提供技术服务。实验室成立以来，多篇论文入选国际顶会和旗舰期刊，并获得数项国际级技术赛事冠军、行业创新奖及最佳论文奖。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HTML基本格式 - 第一个HTML网页]]></title>    <link>https://juejin.cn/post/7577439614953635892</link>    <guid>https://juejin.cn/post/7577439614953635892</guid>    <pubDate>2025-11-28T08:08:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577439614953635892" data-draft-id="7577378514401476643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HTML基本格式 - 第一个HTML网页"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-28T08:08:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GinoWi"/> <meta itemprop="url" content="https://juejin.cn/user/687651121011707"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HTML基本格式 - 第一个HTML网页
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/687651121011707/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GinoWi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T08:08:14.000Z" title="Fri Nov 28 2025 08:08:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><h2 data-id="heading-0">HTML基本格式 - 第一个HTML网页</h2>
<h3 data-id="heading-1">一、第一个HTML网页</h3>
<p><strong>编写网页的步骤：</strong></p>
<ol>
<li>创建一个新文件。</li>
<li>利用记事本打开。</li>
<li>编写HTML代码。</li>
<li>保存并且修改纯文本文档的扩展名为.html（文件命名一定要使用英文）。</li>
<li>利用浏览器打开编写好的文档.</li>
</ol>
<p><strong>使用HTML编写网页的基本结构（格式）：</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span> 
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><strong>HTML基本格式中每个标签的含义：</strong></p>
<p>通过观察，可以发现HTML基本结构中，所有标签都是成对出现的，这些成对出现的标签中，有一个带斜杠，有一个不带斜杠。</p>
<p>不带斜杠的标签是开始标签，带斜杠的标签是结束标签。</p>
<p><code>html</code>标签：</p>
<ul>
<li>
<p>作用：用于告诉浏览器这是一个网页（html文档）。</p>
</li>
<li>
<p>注意点：其他所有的标签都必须写在<code>html</code>标签里面。</p>
</li>
</ul>
<p><code>head</code>标签：</p>
<ul>
<li>
<p>作用：用于给网站添加一些配置信息。</p>
</li>
<li>
<p>使用场景：可以给网站规定标题；指定标签页中的小图标；还可以添加网站SEO相关信息（指定网站关键字/指定网站的描述信息）；外挂一些外部的<code>.css/.js</code>文件；添加一些浏览器适配相关的内容。</p>
</li>
<li>
<p>注意点：一般情况下，写在<code>head</code>标签当中的内容，都不是用来显示给用户查看。</p>
</li>
</ul>
<p><code>title</code>标签：</p>
<ul>
<li>
<p>作用：专门用于指定网站的标题，并且这个指定的标题将来还会作为用户保存网站的默认标题。</p>
</li>
<li>
<p>注意点：<code>title</code>标签必须写在<code>head</code>标签里面.</p>
</li>
</ul>
<p><code>body</code>标签：</p>
<ul>
<li>
<p>作用：专门用来定义HTML文档中需要显示给用户查看的内容（文字/图片/音频/视频……）</p>
</li>
<li>
<p>注意点：</p>
<ul>
<li>虽然有时候可能将内容写到了别的地方，在网页中也可以正常展示，但是最好不要这样写，最好将网页需要显示的内容写在<code>body</code>标签里面。</li>
<li>一对<code>html</code>标签中（一个<code>&lt;html&gt;</code>开始标签和一个<code>&lt;/html&gt;</code>结束标签中）只能有一对<code>body</code>标签。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2">二、字符集问题</h3>
<p>当使用浏览器打开html文件的时候，我们可能会发现网页展示的内容是乱码，往往可以通过修改浏览器设置当中的字符集选项，即可正确展示想要展示的内容。这个时候就需要我们在开发过程中给网页指定一个默认的字符集，使用<code>meta</code>标签。</p>
<p><strong>为什么网页会出现乱码现象？</strong></p>
<p>因为我们在编写网页的时候没有指定字符集。</p>
<p><strong>如何解决乱码现象？</strong></p>
<p>在<code>head</code>标签当中添加<code>&lt;meta charset = 'GBK' /&gt;</code>，指定字符集</p>
<p><strong>什么是字符集？</strong></p>
<p>字符集就是字符的集合。由于不同字符集，对于同一个字符映射的编码是不同的，故在浏览器渲染的时候，使用相同的编码到不同的字符集查找字符的时候，就有可能出现乱码的情况。</p>
<p>而我们指定字符集，就是为了明确告诉浏览器，我们在开发过程中使用的是哪个字符集，便于浏览器更好的映射，找到正确的字符。我们常见的字符集：GBK、UTF-8</p>
<p><strong>GBK（GB2312）和UTF-8的区别：</strong></p>
<ul>
<li>GBK（GB2312）里面存储的字符比较少，仅仅存储了汉字和一些常用的外文，体积比较小。</li>
<li>UTF-8存储了世界上所有的字符。体积比较大。</li>
<li>如果网站仅仅包含中文，推荐使用GB2312，因为体积更小，访问速度更快；如果网站除了中文以外，还包含了其他国家的语言，那么推荐使用UTF-8。</li>
</ul>
<p><code>meta</code>标签：</p>
<ul>
<li>
<p>作用：就是指定当前网页的字符集。</p>
</li>
<li>
<p>注意点：</p>
<ul>
<li>在html的文件中，指定的字符集必须和保存html文件时的字符集保持一致，否则还是会出现乱码。</li>
<li>仅仅指定字符集不一定能解决乱码问题，还需要保存文件的时候，文件保存时的字符集和指定的字符集保持一致，才能保证没有乱码问题。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-3">三、标签的分类</h3>
<p>分类：</p>
<ul>
<li>
<p><strong>单标签</strong>：只有开始标签，没有结束标签。</p>
</li>
<li>
<p><strong>双标签</strong>：有开始标签和结束标签的。常见的双标签：<code>html</code>、<code>body</code>……</p>
</li>
</ul>
<p>标签间的关系：</p>
<ul>
<li>
<p><strong>并列关系（兄弟/平级）</strong>：比如<code>head</code>和<code>body</code>标签就是并列关系。</p>
</li>
<li>
<p><strong>嵌套关系（父子/上下级）</strong>：比如<code>head</code>和<code>title</code>就是父子关系。</p>
</li>
</ul>
<h3 data-id="heading-4">四、DTD文档声明</h3>
<p><strong>什么是DTD文档声明？</strong></p>
<p>由于HTML有很多个版本规范，每个版本的规范之间又有一定的差异，所以为了让浏览器能够正确的编译、解析、渲染网页，我们需要在HTML文件第一行告诉浏览器，我们当前是用哪一个版本的规范来编写的，浏览器只要知道了我们是使用哪一个版本的规范编写之后，他就能正确的编译、解析、渲染网页。</p>
<p><strong>DTD文档声明的格式</strong></p>
<p>每一个不同版本的规范，都有不同的DTD文档声明。因为HTML5的DTD文档声明是向下兼容的，所以使用HTML5的DTD文档声明可以兼容渲染XHTML和HTML的其他版本。</p>
<p>格式：<code>&lt;!DOCTYPE html&gt;</code>或者<code>&lt;!doctype html&gt;</code></p>
<p><strong>DTD文档声明的注意点：</strong></p>
<ul>
<li>任何一个标准的HTML网页，第一行一定是DTD文档声明，也就是说DTD文档声明必须写在HTML网页第一行。</li>
<li>DTD文档声明不区分大小写。</li>
<li>DTD文档声明不是一个标签。</li>
<li>虽然DTD文档声明的作用是告诉浏览器，我们这个网页使用哪个版本资源编写，以便于方便浏览器解析和渲染，但是浏览器并不会完全依赖DTD文档声明，浏览器有一套自己的机制。故DTD文档声明不写网页也可以正常运行，但是根据规范，我们仍需在第一行进行声明。</li>
</ul>
<p><strong>其他DTD文档声明规范：</strong></p>
<p>HTML5之前有2大种规范, 每种规范中又有3小种规范</p>

































<table><thead><tr><th>大规范</th><th>小规范</th></tr></thead><tbody><tr><td>HTML</td><td>Strict (严格的)</td></tr><tr><td>HTML</td><td>Transitional(过度的,普通的,宽松的)</td></tr><tr><td>HTML</td><td>Frameset(带有框架的页面)</td></tr><tr><td>XHTML</td><td>Strict (严格的)</td></tr><tr><td>XHTML</td><td>Transitional(过度的,普通的,宽松的)</td></tr><tr><td>XHTML</td><td>Frameset(带有框架的页面)</td></tr></tbody></table>
<ul>
<li>
<p>HTML的DTD文档声明和XHTML的DTD文档声明有何区别?</p>
<ul>
<li>XHTML本身规定比如标签必须小写、必须严格闭合、必须使用引号引起属性等等, 而HTML会更加松散没有这么严格。</li>
</ul>
</li>
<li>
<p>什么是小规范？</p>
<ul>
<li>
<p>Strict表示严格的, 这种模式里面的要求更为严格.这种严格主要体现在有一些用于修改文本样式的标签不能使用，例如font标签/u标签等</p>
</li>
<li>
<p>Transitional表示普通的, 这种模式是没有一些别的要求，例如可以使用font标签、u标签等</p>
</li>
<li>
<p>Frameset表示框架, 在框架的页面使用</p>
</li>
</ul>
</li>
</ul>
<p><strong>常见的DTD文档声明：</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- HTML4.01 --&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">HTML</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">"-//W3C//DTD HTML 4.01 Transitional//EN"</span>
<span class="hljs-string">"http://www.w3.org/TR/html4/loose.dtd"</span>&gt;</span>
​
<span class="hljs-comment">&lt;!-- XHTML 1.0 --&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span> <span class="hljs-keyword">PUBLIC</span> <span class="hljs-string">"-//W3C//DTD XHTML 1.0 Transitional//EN"</span>
<span class="hljs-string">"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"</span>&gt;</span>
​
<span class="hljs-comment">&lt;!-- HTML5 --&gt;</span>
<span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-5">五、HTML、XHTML和HTML5的区别</h3>
<ul>
<li>HTML语法非常宽松容错性强。</li>
<li>XHTML更为严格，他要求标签必须小写，必须严格闭合，标题中的属性必须使用引号。</li>
<li>HTML5是HTML的下一个版本所以除了非常宽松容错性强以外，还增加许多新的特性。</li>
</ul>
<h3 data-id="heading-6">六、.htm和.html的区别</h3>
<p>DOS系统只允许后缀名有三位，但是后来Windows支持后缀名有四位，本质并无其他区别。</p>
<p><strong>参考链接：</strong></p>
<p>W3School官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3school.com.cn%2F" target="_blank" title="https://www.w3school.com.cn/" ref="nofollow noopener noreferrer">www.w3school.com.cn</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别用“设计感”掩盖无知：从一次 null == 0 的事故说起]]></title>    <link>https://juejin.cn/post/7577345758036475904</link>    <guid>https://juejin.cn/post/7577345758036475904</guid>    <pubDate>2025-11-28T08:26:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577345758036475904" data-draft-id="7577356848337977379" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别用“设计感”掩盖无知：从一次 null == 0 的事故说起"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-28T08:26:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="白气急"/> <meta itemprop="url" content="https://juejin.cn/user/3855363959685260"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别用“设计感”掩盖无知：从一次 null == 0 的事故说起
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3855363959685260/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    白气急
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T08:26:44.000Z" title="Fri Nov 28 2025 08:26:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>那天下午，我盯着一行再普通不过的代码，足足愣了三分钟：</p>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">value</span>.Equals(<span class="hljs-literal">null</span>)) 
{
    <span class="hljs-comment">// 这行居然执行了？！</span>
}
</code></pre>
<p><code>value</code> 是一个 <code>Value</code> 类型的对象，构造时传入的是整数 <code>0</code>——它明明不是 <code>null</code>。调试器里字段正常，内存地址也清清楚楚。可 <code>.Equals(null)</code> 却返回了 <code>true</code>。这已经不是“奇怪”了，这是在挑战我对编程语言的基本信任。</p>
<p>带着一丝不安，我点进了 <code>Value.Equals</code>：</p>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Value</span> : <span class="hljs-title">XXObject</span>, <span class="hljs-title">IObject</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">Equals</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> obj</span>)</span>
    {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">base</span>.Equals(obj);
    }
}
</code></pre>
<p>哦，它自己没实现，直接甩锅给父类 <code>XXObject</code>。那就继续追</p>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">XXObject</span> : <span class="hljs-title">IObject</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">Equals</span>(<span class="hljs-params"><span class="hljs-built_in">object</span>? obj</span>)</span>
    {
        <span class="hljs-keyword">return</span> XXEquals.Equals(_value, obj);
    }
}
</code></pre>
<p>看到这里，我心里咯噔一下： <strong>为什么一个 <code>Equals</code> 要委托给静态类？</strong> <strong>为什么 <code>Value</code> 和 <code>XXObject</code> 都要实现同一个接口 <code>IObject</code>？</strong> 感觉就是过度抽象+静态工具滥用</p>
<p>但 debug 不能停。我硬着头皮点进 <code>XXEquals.Equals</code>，眼前出现了一段堪称“史诗级轮子”的 switch 大法：</p>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">Equals</span>(<span class="hljs-params"><span class="hljs-built_in">object</span> <span class="hljs-keyword">value</span>, <span class="hljs-built_in">object</span>? obj</span>)</span>
{
    <span class="hljs-keyword">if</span> (obj <span class="hljs-keyword">is</span> IObject _obj)
    {
        <span class="hljs-keyword">return</span> Equals(<span class="hljs-keyword">value</span>, _obj.GetValue());
    }
    <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">value</span>)
    {
​
        <span class="hljs-keyword">case</span> <span class="hljs-built_in">int</span> v:
        {
            <span class="hljs-keyword">return</span> obj <span class="hljs-keyword">switch</span>
            {
                <span class="hljs-built_in">byte</span> v2 =&gt; v == v2,
                <span class="hljs-built_in">short</span> v2 =&gt; v == v2,
                <span class="hljs-comment">// ... 省略一堆类型</span>
                _ =&gt; v == XXConvert.ToInt(obj)
            };
    }
}
</code></pre>
<p>问题就出在最后那个兜底分支：<code>XXConvert.ToInt(obj)</code>。 当 <code>obj</code> 是 <code>null</code> 时，它居然没有抛异常，而是.....返回了 <code>0</code>？</p>
<p>我颤抖着手点进去：</p>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">int</span> <span class="hljs-title">ToInt</span>(<span class="hljs-params"><span class="hljs-built_in">object</span>? obj, <span class="hljs-built_in">int</span> def = <span class="hljs-literal">default</span></span>)</span>
{
    <span class="hljs-keyword">return</span> ToIntNull(obj) ?? def;
}
</code></pre>
<p>而 <code>def</code> 的默认值是 <code>default(int)</code>，也就是 <code>0</code>。 所以 <code>ToInt(null)</code> → <code>ToIntNull(null)</code> 返回 <code>null</code> → <code>?? 0</code> → 最终得到 <code>0</code>。</p>
<p>于是整个链条闭环了：</p>
<ul>
<li><code>value.Equals(null)</code></li>
<li>→ <code>XXEquals.Equals(0, null)</code></li>
<li>→ <code>0 == XXConvert.ToInt(null)</code></li>
<li>→ <code>0 == 0</code></li>
<li>→ <strong><code>true</code></strong></li>
</ul>
<p>那一刻，我悬着的心终于死了：</p>
<p><strong>这不是 bug，这是一个自以为“通用”的轮子，在用一套看似合理实则荒谬的逻辑，系统性地践踏语言最基本的契约。</strong></p>
<p>值得庆幸的是，在 .NET（C# 7.0+）中，我们<strong>不需要依赖可能被重写的 <code>Equals</code> 或 <code>==</code> 来判断 null</strong>。 官方早已提供了一种<strong>语义明确、无法被篡改</strong>的 null 检查方式</p>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">value</span> <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>)
{
    <span class="hljs-comment">// 中</span>
}
</code></pre>
<p>所以，即使底层有人造了“null 转 0”的轮子，只要上层用 <code>is null</code>，就能免疫这类静默错误</p>
<p>但这只是“止血”，不是“治病”</p>
<p>虽然 <code>is null</code> 能让我们暂时避开陷阱，但问题的根源依然存在</p>
<h3 data-id="heading-0">别用“设计”掩盖无知</h3>
<p>说实话，看到 <code>XXConvert.ToInt(null)</code> 返回 <code>0</code> 的那一刻，我气笑了</p>
<p>不是因为代码复杂，而是因为<strong>这种设计透露出一种令人不安的傲慢</strong>：</p>
<blockquote>
<p>“我知道用户可能会传 <code>null</code>，但我不想让他们处理异常——我替他们‘智能’地处理成默认值。”</p>
</blockquote>
<p>听起来很贴心？不，这是<strong>对语义的背叛</strong>。</p>
<p>在几乎所有主流编程语言中，<code>null</code> 都代表“无值”、“缺失”、“未初始化”。而 <code>0</code> 是一个<strong>明确的、有效的值</strong>。把“无”等同于“零”，就像把“没人来开会”理解成“来了一个人，他叫张三，职位是 0 号员工”一样荒谬。</p>
<p>更可怕的是，这种“智能”被包装在三层抽象之下：</p>
<ul>
<li>接口 <code>IObject</code>（看似规范）</li>
<li>基类 <code>XXObject</code>（看似复用）</li>
<li>静态工具类 <code>XXEquals</code> + <code>XXConvert</code>（看似解耦）</li>
</ul>
<p>结果呢？<strong>解耦不解祸，封装不封错</strong>。 所有调用者都被蒙在鼓里，直到某天某个 <code>if (obj.Equals(null))</code> 突然走错分支，系统在静默中走向崩溃。</p>
<hr/>
<p>这件事让我意识到： <strong>所谓专业，不是你会造多复杂的轮子，而是你清楚哪些边界绝不能碰——比如相等性、空值语义、类型安全这些设计底线。</strong></p>
<p>在这个行业，<strong>最昂贵的轮子，从来不是重复造的，而是造歪了还装上车的</strong>。</p>
<blockquote>
<p><strong>版权声明</strong>：本文为个人原创，首发于微信公众号、掘金平台、博客园，作者均为「白气急」。转载请标明出处并附带链接。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Astro 项目升级全栈：EdgeOne Pages 部署指南]]></title>    <link>https://juejin.cn/post/7577395040593330186</link>    <guid>https://juejin.cn/post/7577395040593330186</guid>    <pubDate>2025-11-28T08:17:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577395040593330186" data-draft-id="7577668116500430886" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Astro 项目升级全栈：EdgeOne Pages 部署指南"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-28T08:17:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="顶鲜花的牛粪"/> <meta itemprop="url" content="https://juejin.cn/user/2049145403352205"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Astro 项目升级全栈：EdgeOne Pages 部署指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2049145403352205/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    顶鲜花的牛粪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T08:17:46.000Z" title="Fri Nov 28 2025 08:17:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景介绍</h2>
<p>最近用腾讯云的 EdgeOne Pages （下文称 Pages）部署了个人站点，记录一下从 SSG 升级到 SSR 的过程。Pages 是腾讯云推出的网站托管服务，支持 SSR 和边缘函数，国内访问稳定性相比而言会更好一点。Astro 是一个"内容优先"的现代 Web 框架，特别适合博客、文档等内容型网站，默认输出零 JavaScript 的静态 HTML，同时也支持 SSR 模式。我的个人博客就是使用的 Pages 进行托管，Pages 之前只支持 SSG 模式，对初期来说我的站点完全够用了，但随着网站内容增多、访问量上升，我希望通过 SSR 获得更好的 SEO 效果。刚好最近看到 Pages 支持了 Astro 的 SSR 模式，正好借此机会升级并记录实践过程。</p>
<h2 data-id="heading-1">基本信息</h2>
<p><strong>示例项目</strong></p>
<p>本文使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnuonuo-888%2Fportfolio-sofidev-garrux" target="_blank" title="https://github.com/nuonuo-888/portfolio-sofidev-garrux" ref="nofollow noopener noreferrer">demo-portfolio</a> 项目作为示例，一个基于 Astro 的个人作品集网站。项目 fork 自原作者仓库，我对其进行了 Astro 版本升级和 bug 修复，以更好地适配 Pages 的 SSR 模式（欢迎给原作者 star）。</p>
<p><strong>Astro 适配器</strong></p>
<p>适配器（Adapter）是 Astro 用于适配不同部署平台的插件，负责将项目转换为目标平台所需的格式。Pages 提供了官方适配器 <code>@edgeone/astro</code>，支持在边缘计算环境中运行 SSR 模式。</p>
<p><strong>Pages 脚手架</strong></p>
<p>Pages 提供命令行工具，通过 <code>npm install edgeone -g</code> 安装，支持项目初始化、本地调试和一键部署。</p>
<h2 data-id="heading-2">实践过程</h2>
<h3 data-id="heading-3">项目准备</h3>
<p>首先从 GitHub 下载示例项目到本地：</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/nuonuo-888/portfolio-sofidev-garrux
<span class="hljs-built_in">cd</span> portfolio-sofidev-garrux
npm install
</code></pre>
<h3 data-id="heading-4">项目配置</h3>
<p><strong>原始 SSG 模式</strong></p>
<p>项目的核心配置文件是 <code>astro.config.mjs</code>，使用 SSG 模式时的配置如下：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">"astro/config"</span>;
<span class="hljs-keyword">import</span> react <span class="hljs-keyword">from</span> <span class="hljs-string">"@astrojs/react"</span>;
<span class="hljs-keyword">import</span> tailwind <span class="hljs-keyword">from</span> <span class="hljs-string">"@astrojs/tailwind"</span>;
<span class="hljs-keyword">import</span> sitemap <span class="hljs-keyword">from</span> <span class="hljs-string">"@astrojs/sitemap"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">site</span>: <span class="hljs-string">"https://examples.com/"</span>, <span class="hljs-comment">// 网站的部署URL，用于生成sitemap和RSS</span>
  <span class="hljs-attr">output</span>: <span class="hljs-string">"static"</span>, <span class="hljs-comment">// 输出模式：static表示静态站点生成(SSG)</span>
  <span class="hljs-attr">integrations</span>: [<span class="hljs-title function_">react</span>(), <span class="hljs-title function_">tailwind</span>(), <span class="hljs-title function_">sitemap</span>()], <span class="hljs-comment">// 集成插件：React组件支持、Tailwind CSS、站点地图生成</span>
});
</code></pre>
<p>使用 <code>npm run build</code> 构建后，会在 <code>dist/</code> 目录生成以下结构：</p>
<pre><code class="hljs language-bash" lang="bash">dist/
├── _astro/              <span class="hljs-comment"># Astro 构建生成的资源文件</span>
├── 404.html            <span class="hljs-comment"># 404 错误页面</span>
├── about/              <span class="hljs-comment"># 关于页面</span>
├── assets/             <span class="hljs-comment"># 静态资源文件（SVG 图标）</span>
├── blog/               <span class="hljs-comment"># 博客文章目录</span>
├── docs/               <span class="hljs-comment"># 文档文件</span>
├── img/                <span class="hljs-comment"># 图片资源</span>
├── index.html          <span class="hljs-comment"># 首页</span>
├── favicon.svg         <span class="hljs-comment"># 网站图标</span>
├── sitemap-0.xml       <span class="hljs-comment"># 站点地图文件</span>
└── sitemap-index.xml   <span class="hljs-comment"># 站点地图索引</span>
</code></pre>
<p>这些文件可以直接部署到任何静态托管服务（如 CDN、对象存储），无需服务器运行时支持。</p>
<p><strong>升级为 SSR 模式</strong></p>
<p>现在我们将项目从 SSG 模式升级为 SSR 模式。首先需要安装 Pages 的适配器：</p>
<pre><code class="hljs language-bash" lang="bash">npm install @edgeone/astro
</code></pre>
<p>然后修改 <code>astro.config.mjs</code> 配置文件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">"astro/config"</span>;
<span class="hljs-keyword">import</span> edgeone <span class="hljs-keyword">from</span> <span class="hljs-string">"@edgeone/astro"</span>; <span class="hljs-comment">// 引入EdgeOne适配器</span>
<span class="hljs-keyword">import</span> react <span class="hljs-keyword">from</span> <span class="hljs-string">"@astrojs/react"</span>;
<span class="hljs-keyword">import</span> tailwind <span class="hljs-keyword">from</span> <span class="hljs-string">"@astrojs/tailwind"</span>;
<span class="hljs-keyword">import</span> sitemap <span class="hljs-keyword">from</span> <span class="hljs-string">"@astrojs/sitemap"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">site</span>: <span class="hljs-string">"https://examples.com/"</span>,
  <span class="hljs-attr">output</span>: <span class="hljs-string">"server"</span>, <span class="hljs-comment">// 从 'static' 改为 'server' 启用SSR</span>
  <span class="hljs-attr">adapter</span>: <span class="hljs-title function_">edgeone</span>(), <span class="hljs-comment">// 配置EdgeOne适配器</span>
  <span class="hljs-attr">integrations</span>: [<span class="hljs-title function_">react</span>(), <span class="hljs-title function_">tailwind</span>(), <span class="hljs-title function_">sitemap</span>()],
});
</code></pre>
<p>升级为 SSR 模式需要修改两个配置：将 <code>output</code> 从 <code>'static'</code> 改为 <code>'server'</code> 来启用服务端渲染，以及添加 <code>adapter: edgeone()</code> 来配置 EdgeOne 适配器。</p>
<p>配置完成后，执行构建命令：</p>
<pre><code class="hljs language-bash" lang="bash">npm run build
</code></pre>
<p>构建完成后会在 <code>.edgeone/</code> 目录生成以下结构：</p>
<pre><code class="hljs language-bash" lang="bash">.edgeone/
├── assets/                    <span class="hljs-comment"># 静态资源文件</span>
└── server-handler/            <span class="hljs-comment"># 服务器端处理文件</span>
</code></pre>
<p>其中 <code>assets/</code> 目录包含所有静态文件（CSS、JS、图片等），<code>server-handler/</code> 目录包含服务端渲染代码，用于在 Pages 边缘节点上动态处理请求和渲染页面。</p>
<p>构建产物之所以生成到 <code>.edgeone/</code> 目录，是因为适配器的作用就是将 Astro 的构建结果转换为目标部署平台所需的格式和目录结构。不同平台的适配器会生成对应的目录，例如 <code>@astrojs/vercel</code> 适配器会生成 <code>.vercel/</code> 目录，<code>@astrojs/netlify</code> 适配器会生成 <code>.netlify/</code> 目录，这样各平台的部署工具就能识别并正确部署这些构建产物。</p>
<p><strong>适配器参数配置</strong></p>
<p><code>@edgeone/astro</code> 适配器支持传入以下参数来自定义构建行为：</p>
<ul>
<li><strong>includeFiles</strong>（可选）：强制包含的文件列表，支持 glob 模式匹配</li>
<li><strong>excludeFiles</strong>（可选）：排除的文件列表，主要用于排除 node_modules 中的特定文件，支持 glob 模式匹配</li>
</ul>
<p>配置示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> edgeone <span class="hljs-keyword">from</span> <span class="hljs-string">"@edgeone/astro"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">adapter</span>: <span class="hljs-title function_">edgeone</span>({
    <span class="hljs-attr">outDir</span>: <span class="hljs-string">".edgeone"</span>,
    <span class="hljs-attr">includeFiles</span>: [<span class="hljs-string">"src/locales/**"</span>, <span class="hljs-string">"public/config.json"</span>],
    <span class="hljs-attr">excludeFiles</span>: [<span class="hljs-string">"node_modules/.cache/**"</span>],
  }),
});
</code></pre>
<p><strong>注意</strong>：根据 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpages.edgeone.ai%2Fzh%2Fdocument%2Fframework-astro" target="_blank" title="https://pages.edgeone.ai/zh/document/framework-astro" ref="nofollow noopener noreferrer">Pages 官方文档</a> 说明，当前版本暂不支持 Astro 的 Image 组件，请使用常规的 <code>&lt;img&gt;</code> 标签来显示图片。</p>
<h3 data-id="heading-5">本地验证</h3>
<p>在部署前，建议先在本地运行项目确保一切正常：</p>
<pre><code class="hljs language-bash" lang="bash">npm run dev
</code></pre>
<p>启动成功后，访问 <code>http://localhost:4321</code> 即可预览网站效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9000e9d3c0514349a59fbd6d606ea2c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aG26bKc6Iqx55qE54mb57Kq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764922665&amp;x-signature=dSdz4wGBtwX%2F1NfP%2Fcqm2lQGOjo%3D" alt="首页预览" loading="lazy"/></p>
<p>确认本地运行无误后，就可以进行部署了。</p>
<h3 data-id="heading-6">部署步骤</h3>
<p>Pages 提供两种部署方式：</p>
<p><strong>方式一：命令行部署（推荐）</strong></p>
<p>首先全局安装命令行工具：</p>
<pre><code class="hljs language-bash" lang="bash">npm install edgeone -g
</code></pre>
<p>在项目根目录执行部署命令：</p>
<pre><code class="hljs language-bash" lang="bash">edgeone pages deploy --name my-personal-website --token &lt;your-token&gt;
</code></pre>
<p>参数说明：</p>
<ul>
<li><code>--name</code>：指定项目名称</li>
<li><code>--token</code>：EdgeOne API Token，用于身份验证（可在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fconsole.cloud.tencent.com%2Fedgeone%2Fpages%3Ftab%3Dapi" target="_blank" title="https://console.cloud.tencent.com/edgeone/pages?tab=api" ref="nofollow noopener noreferrer">Pages API 管理页面</a> 创建）</li>
</ul>
<p><strong>部署中的输出信息：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[cli]</span><span class="hljs-section">[✔]</span> Using provided API token for deployment...
<span class="hljs-section">[cli]</span><span class="hljs-section">[✔]</span> Deploying /Users/your-mac-account-name/*/portfolio-sofidev-garrux/.edgeone to project my-personal-website (Production environment, global area)...
<span class="hljs-section">[cli]</span>❗️ Project my-personal-website doesn't exist. Creating new project.
<span class="hljs-section">[cli]</span><span class="hljs-section">[CreatePagesProject]</span> Creating new project with name: my-personal-website in global area
<span class="hljs-section">[cli]</span><span class="hljs-section">[✔]</span> Using Project ID: pages-******
<span class="hljs-section">[cli]</span>No existing .env file found, will create new one
<span class="hljs-section">[cli]</span>Pulling environment variables...
<span class="hljs-section">[cli]</span>No environment variables found.
<span class="hljs-section">[cli]</span><span class="hljs-section">[Uploader]</span> Uploading file: <span class="hljs-section">[▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓]</span> 100%
<span class="hljs-section">[cli]</span><span class="hljs-section">[✔]</span> File uploaded successfully
<span class="hljs-section">[cli]</span><span class="hljs-section">[✔]</span> Creating deployment in Production environment...
<span class="hljs-section">[cli]</span><span class="hljs-section">[✔]</span> Created deployment with Deployment ID: ******
<span class="hljs-section">[cli]</span><span class="hljs-section">[DeployStatus]</span> Deploying.....
</code></pre>
<p><strong>部署成功后的输出信息：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[cli]</span><span class="hljs-section">[✔]</span> Deploy Success
<span class="hljs-section">[cli]</span><span class="hljs-section">[✔]</span> Deployment to EdgeOne Pages completed successfully! To view your project's live <span class="hljs-attr">URL.
EDGEONE_DEPLOY_URL</span>=https://my-personal-website.edgeone.site?eo_token=******
<span class="hljs-attr">EDGEONE_DEPLOY_TYPE</span>=preset
<span class="hljs-attr">EDGEONE_PROJECT_ID</span>=pages-******
<span class="hljs-section">[cli]</span><span class="hljs-section">[✔]</span> You can view your deployment in the EdgeOne Pages Console at:
https://console.cloud.tencent.com/edgeone/pages/project/*****
</code></pre>
<p>部署成功后，你可以访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fconsole.cloud.tencent.com%2Fedgeone%2Fpages%3Ftab%3Dprojects" target="_blank" title="https://console.cloud.tencent.com/edgeone/pages?tab=projects" ref="nofollow noopener noreferrer">Pages 控制台</a> 查看新部署的项目，看到项目列表中出现你的项目即表示发布成功。</p>
<p>在控制台的项目列表中，点击进入你的项目详情页，可以查看项目的预览地址（Preview URL），通过该地址即可访问你部署的网站。</p>
<p><strong>方式二：GitHub 自动部署</strong></p>
<p>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fconsole.cloud.tencent.com%2Fedgeone%2Fpages%2Fcreate%2Fgit" target="_blank" title="https://console.cloud.tencent.com/edgeone/pages/create/git" ref="nofollow noopener noreferrer">Git 项目部署页面</a>，关联 GitHub 账户并选择仓库，配置完成后每次推送代码即可自动触发部署，类似 Vercel、Netlify 的工作流程。</p>
<h3 data-id="heading-7">验证 SSR 部署</h3>
<p>部署完成后，你可以通过 <code>curl</code> 命令在终端验证 SSR 是否正常工作：</p>
<pre><code class="hljs language-bash" lang="bash">curl https://my-personal-website.edgeone.site
</code></pre>
<p>如果返回完整的 HTML 内容，说明服务端渲染已成功运行。</p>
<p><strong>通过中间件验证 SSR</strong></p>
<p>为了更直观地验证 SSR 是否正常工作，你可以在项目中添加 Astro 中间件，在响应头中加入自定义信息和服务端渲染时间。</p>
<p>在项目根目录创建 <code>src/middleware.js</code> 文件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">onRequest</span>(<span class="hljs-params">context, next</span>) {
  <span class="hljs-comment">// 记录请求开始时间</span>
  <span class="hljs-keyword">const</span> startTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();

  <span class="hljs-comment">// 继续处理请求</span>
  <span class="hljs-keyword">const</span> response = <span class="hljs-title function_">next</span>();

  <span class="hljs-comment">// 在响应头中添加自定义信息</span>
  response.<span class="hljs-property">headers</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">"X-Rendered-By"</span>, <span class="hljs-string">"EdgeOne-Pages-SSR"</span>);
  response.<span class="hljs-property">headers</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">"X-Render-Time"</span>, <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now() - startTime}</span>ms`</span>);

  <span class="hljs-keyword">return</span> response;
}
</code></pre>
<p>重新构建并部署项目后，使用 <code>curl</code> 命令查看响应头：</p>
<pre><code class="hljs language-bash" lang="bash">curl -I https://my-personal-website.edgeone.site
</code></pre>
<p>你会在响应头中看到：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">X-Rendered-By: EdgeOne-Pages-SSR</span>
<span class="hljs-section">X-Render-Time: 15ms</span>
</code></pre>
<p>这些自定义响应头证明了页面是在服务端动态渲染的，<code>X-Render-Time</code> 显示了服务端渲染所花费的时间。</p>
<h2 data-id="heading-8">总结</h2>
<p>以上就是使用 Pages 部署 Astro SSR 项目的全过程。从 SSG 升级到 SSR 的步骤比较简单：安装适配器、修改配置文件、重新构建部署。SSR 模式相比 SSG 在 SEO 和首屏加载上会有一些优势，适合内容型网站。</p>
<p>希望这篇文章能对同样想要将 Astro 项目部署到 Pages 的开发者提供参考，如果遇到问题欢迎在评论区交流。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[黑马《Java架构师实战训练营 (含完整资料)》]]></title>    <link>https://juejin.cn/post/7577431644069052467</link>    <guid>https://juejin.cn/post/7577431644069052467</guid>    <pubDate>2025-11-28T08:26:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577431644069052467" data-draft-id="7577668116500561958" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="黑马《Java架构师实战训练营 (含完整资料)》"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-28T08:26:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="赵大海"/> <meta itemprop="url" content="https://juejin.cn/user/2385264130397209"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            黑马《Java架构师实战训练营 (含完整资料)》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2385264130397209/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    赵大海
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T08:26:57.000Z" title="Fri Nov 28 2025 08:26:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"><strong>51CTO-AI大模型技术体系课：从Transformer到Agent的代码实践之旅</strong></h3>
<p>本文旨在通过关键代码片段，揭示“51CTO-AI大模型技术体系课”所涵盖的核心技术栈。我们将跳过泛泛而谈，直击技术本质，展示课程如何通过代码将复杂的理论落地。</p>
<h4 data-id="heading-1"><strong>一、基石：Transformer架构的代码解剖</strong></h4>
<p>任何大模型课程的核心都是Transformer。课程不会只给你看公式，而是带你用PyTorch搭建其核心组件——自注意力机制。</p>
<pre><code class="hljs language-ini" lang="ini">import torch
import torch.nn as nn
import torch.nn.functional as F

class SelfAttention(nn.Module):
    def __init__(self, d_model, heads):
        super().__init__()
        <span class="hljs-attr">self.d_model</span> = d_model
        <span class="hljs-attr">self.heads</span> = heads
        <span class="hljs-attr">self.head_dim</span> = d_model // heads
        
        assert d_model % <span class="hljs-attr">heads</span> == <span class="hljs-number">0</span>, <span class="hljs-string">"d_model must be divisible by number of heads"</span>
        
        <span class="hljs-comment"># 线性变换得到Q, K, V</span>
        <span class="hljs-attr">self.to_queries</span> = nn.Linear(d_model, d_model, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-attr">self.to_keys</span> = nn.Linear(d_model, d_model, bias=<span class="hljs-literal">False</span>)
        <span class="hljs-attr">self.to_values</span> = nn.Linear(d_model, d_model, bias=<span class="hljs-literal">False</span>)
        
        <span class="hljs-comment"># 输出线性层</span>
        <span class="hljs-attr">self.unify_heads</span> = nn.Linear(d_model, d_model)
        
    def forward(self, x):
        <span class="hljs-comment"># x shape: (batch, seq_len, d_model)</span>
        b, t, <span class="hljs-attr">d</span> = x.size()
        <span class="hljs-attr">h</span> = self.heads
        
        <span class="hljs-comment"># 生成Q, K, V，并分割成多头</span>
        <span class="hljs-attr">Q</span> = self.to_queries(x).view(b, t, h, self.head_dim).transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>) <span class="hljs-comment"># (b, h, t, head_dim)</span>
        <span class="hljs-attr">K</span> = self.to_keys(x).view(b, t, h, self.head_dim).transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
        <span class="hljs-attr">V</span> = self.to_values(x).view(b, t, h, self.head_dim).transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)
        
        <span class="hljs-comment"># 计算注意力分数 (Q * K^T) / sqrt(d_k)</span>
        <span class="hljs-attr">scores</span> = torch.matmul(Q, K.transpose(-<span class="hljs-number">2</span>, -<span class="hljs-number">1</span>)) / (self.head_dim ** <span class="hljs-number">0.5</span>)
        <span class="hljs-attr">attn_weights</span> = F.softmax(scores, dim=-<span class="hljs-number">1</span>)
        
        <span class="hljs-comment"># 应用注意力权重到V</span>
        <span class="hljs-attr">out</span> = torch.matmul(attn_weights, V) <span class="hljs-comment"># (b, h, t, head_dim)</span>
        
        <span class="hljs-comment"># 合并多头</span>
        <span class="hljs-attr">out</span> = out.transpose(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>).contiguous().view(b, t, d) <span class="hljs-comment"># (b, t, d_model)</span>
        
        <span class="hljs-comment"># 通过线性层</span>
        return self.unify_heads(out)

<span class="hljs-comment"># 示例：实例化一个8头，512维的自注意力层</span>
<span class="hljs-attr">attn_layer</span> = SelfAttention(d_model=<span class="hljs-number">512</span>, heads=<span class="hljs-number">8</span>)
<span class="hljs-attr">x</span> = torch.randn(<span class="hljs-number">2</span>, <span class="hljs-number">10</span>, <span class="hljs-number">512</span>) <span class="hljs-comment"># (batch_size, sequence_length, d_model)</span>
<span class="hljs-attr">output</span> = attn_layer(x)
print(f"Input shape: {x.shape}")
print(f"Output shape: {output.shape}")
</code></pre>
<p><strong>课程价值</strong>：通过手写SelfAttention，学员将深刻理解多头机制、缩放点积、维度变换等核心概念，为理解BERT、GPT等模型打下坚实基础。</p>
<h4 data-id="heading-2"><strong>二、预训练与微调：从零开始理解GPT的生成过程</strong></h4>
<p>课程会深入大模型的预训练目标——因果语言建模，并展示最朴素的文本生成代码。</p>
<pre><code class="hljs language-ini" lang="ini">def causal_lm_training_step(model, tokenizer, text_batch):
    """
    简化版的因果语言模型训练步骤
    """
    <span class="hljs-comment"># 1. 分词并构建输入和标签</span>
    <span class="hljs-attr">inputs</span> = tokenizer(text_batch, return_tensors=<span class="hljs-string">'pt'</span>, padding=<span class="hljs-literal">True</span>, truncation=<span class="hljs-literal">True</span>)
    <span class="hljs-attr">input_ids</span> = inputs[<span class="hljs-string">'input_ids'</span>]
    
    <span class="hljs-comment"># 标签是输入向右偏移一位</span>
    <span class="hljs-attr">labels</span> = input_ids[:, <span class="hljs-number">1</span>:].contiguous() <span class="hljs-comment"># 从第二个token开始作为标签</span>
    <span class="hljs-comment"># 需要将输入截断一位，与标签长度对齐</span>
    <span class="hljs-attr">input_ids</span> = input_ids[:, :-<span class="hljs-number">1</span>] <span class="hljs-comment"># 到倒数第二个token为止作为输入</span>
    
    <span class="hljs-comment"># 2. 前向传播</span>
    <span class="hljs-attr">outputs</span> = model(input_ids=input_ids)
    <span class="hljs-attr">logits</span> = outputs.logits <span class="hljs-comment"># (batch, seq_len, vocab_size)</span>
    
    <span class="hljs-comment"># 3. 计算损失（交叉熵）</span>
    <span class="hljs-attr">loss_fn</span> = nn.CrossEntropyLoss(ignore_index=tokenizer.pad_token_id)
    <span class="hljs-attr">loss</span> = loss_fn(logits.view(-<span class="hljs-number">1</span>, logits.size(-<span class="hljs-number">1</span>)), labels.view(-<span class="hljs-number">1</span>))
    
    return loss

def simple_generate(model, tokenizer, prompt, <span class="hljs-attr">max_length</span>=<span class="hljs-number">50</span>):
    """
    简单的自回归生成（贪婪解码）
    """
    model.eval()
    <span class="hljs-attr">input_ids</span> = tokenizer.encode(prompt, return_tensors=<span class="hljs-string">'pt'</span>)
    
    with torch.no_grad():
        for _ in range(max_length):
            <span class="hljs-attr">outputs</span> = model(input_ids)
            <span class="hljs-attr">next_token_logits</span> = outputs.logits[:, -<span class="hljs-number">1</span>, :] <span class="hljs-comment"># 取最后一个时间步的logits</span>
            <span class="hljs-attr">next_token_id</span> = torch.argmax(next_token_logits, dim=-<span class="hljs-number">1</span>).unsqueeze(-<span class="hljs-number">1</span>) <span class="hljs-comment"># 贪婪选择</span>
            
            <span class="hljs-comment"># 将新生成的token拼接到输入中</span>
            <span class="hljs-attr">input_ids</span> = torch.cat([input_ids, next_token_id], dim=<span class="hljs-number">1</span>)
            
            <span class="hljs-comment"># 如果生成了结束符，则停止</span>
            if <span class="hljs-attr">next_token_id</span> == tokenizer.eos_token_id:
                break
                
    <span class="hljs-attr">generated_text</span> = tokenizer.decode(input_ids.squeeze(), skip_special_tokens=<span class="hljs-literal">True</span>)
    return generated_text

<span class="hljs-comment"># 示例使用（假设model和tokenizer已加载）</span>
<span class="hljs-comment"># loss = causal_lm_training_step(model, tokenizer, [“今天天气真好”， “人工智能是未来的方向”])</span>
<span class="hljs-comment"># generated = simple_generate(model, tokenizer, “人工智能可以”)</span>
</code></pre>
<p><strong>课程价值</strong>：这段代码揭示了GPT家族模型“逐词生成”的本质。学员将明白预训练如何让模型学会语言规律，以及微调如何在此基础上适应特定任务。</p>
<h4 data-id="heading-3"><strong>三、核心技巧：指令微调与RLHF的关键代码逻辑</strong></h4>
<p>课程会深入大模型对齐的核心——指令微调和基于人类反馈的强化学习，展示其核心逻辑。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 指令微调（Instruction Tuning）的核心：构造指令-回答对</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">format_instruction_data</span>(<span class="hljs-params">instruction, response</span>):
    <span class="hljs-string">"""将指令和回答格式化为模型输入"""</span>
    <span class="hljs-comment"># 常用模板，如Alpaca格式</span>
    prompt_template = <span class="hljs-string">f"Below is an instruction that describes a task. Write a response that appropriately completes the request.\n\n### Instruction:\n<span class="hljs-subst">{instruction}</span>\n\n### Response:\n"</span>
    full_input = prompt_template
    full_target = response <span class="hljs-comment"># 模型需要生成的目标部分</span>
    <span class="hljs-keyword">return</span> full_input, full_target

<span class="hljs-comment"># RLHF中的奖励模型训练（简化版）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RewardModel</span>(nn.Module):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, base_model</span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.transformer = base_model
        <span class="hljs-comment"># 在基础模型上加一个回归头，输出一个标量分数</span>
        self.value_head = nn.Linear(base_model.config.hidden_size, <span class="hljs-number">1</span>)
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, input_ids</span>):
        outputs = self.transformer(input_ids=input_ids)
        hidden_states = outputs.last_hidden_state <span class="hljs-comment"># (batch, seq, hidden_size)</span>
        <span class="hljs-comment"># 取最后一个token的隐藏状态作为序列表示</span>
        last_token_hidden = hidden_states[:, -<span class="hljs-number">1</span>, :]
        reward_score = self.value_head(last_token_hidden).squeeze(-<span class="hljs-number">1</span>)
        <span class="hljs-keyword">return</span> reward_score

<span class="hljs-comment"># PPO训练循环的关键步骤（概念性代码）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">ppo_training_step</span>(<span class="hljs-params">policy_model, ref_model, reward_model, prompt</span>):
    <span class="hljs-comment"># 1. 策略模型根据prompt生成回答</span>
    generated_response = policy_model.generate(prompt)
    
    <span class="hljs-comment"># 2. 使用奖励模型为生成的回答打分</span>
    <span class="hljs-keyword">with</span> torch.no_grad():
        reward_score = reward_model(generated_response)
        
    <span class="hljs-comment"># 3. 计算当前策略模型和参考模型（旧策略）的KL散度，作为惩罚项</span>
    <span class="hljs-comment"># ... (涉及logits的复杂计算)</span>
    
    <span class="hljs-comment"># 4. 组合奖励和KL惩罚，形成PPO的优化目标</span>
    <span class="hljs-comment"># ... (PPO-Clip核心算法)</span>
    
    <span class="hljs-comment"># 5. 反向传播，更新策略模型</span>
    <span class="hljs-comment"># ...</span>
</code></pre>
<p><strong>课程价值</strong>：通过代码化的RLHF流程，学员将理解ChatGPT等对话模型为何能如此“听话”和“有用”，掌握让大模型与人类价值观对齐的关键技术。</p>
<h4 data-id="heading-4"><strong>四、应用落地：构建基于Function Calling的AI Agent</strong></h4>
<p>课程最后会引导学员将大模型转化为能调用工具、执行任务的智能体。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json

<span class="hljs-comment"># 定义工具（函数）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">city: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""获取指定城市的天气情况。"""</span>
    <span class="hljs-comment"># 这里是模拟实现</span>
    weather_data = {
        <span class="hljs-string">"北京"</span>: <span class="hljs-string">"晴，25°C"</span>,
        <span class="hljs-string">"上海"</span>: <span class="hljs-string">"多云，27°C"</span>,
        <span class="hljs-string">"深圳"</span>: <span class="hljs-string">"阵雨，30°C"</span>
    }
    <span class="hljs-keyword">return</span> weather_data.get(city, <span class="hljs-string">"未找到该城市天气信息"</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">calculator</span>(<span class="hljs-params">expression: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""计算数学表达式。"""</span>
    <span class="hljs-keyword">try</span>:
        result = <span class="hljs-built_in">eval</span>(expression) <span class="hljs-comment"># 注意：生产环境禁用eval，此处仅为示例</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{expression}</span> = <span class="hljs-subst">{result}</span>"</span>
    <span class="hljs-keyword">except</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"计算错误，请检查表达式。"</span>

<span class="hljs-comment"># 可供模型调用的工具列表</span>
available_functions = {
    <span class="hljs-string">"get_weather"</span>: get_weather,
    <span class="hljs-string">"calculator"</span>: calculator
}

<span class="hljs-comment"># 模拟大模型的Function Calling输出</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">mock_llm_function_call</span>(<span class="hljs-params">user_query</span>):
    <span class="hljs-string">"""模拟大模型分析用户意图并决定调用哪个函数。"""</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">"天气"</span> <span class="hljs-keyword">in</span> user_query:
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"reasoning"</span>: <span class="hljs-string">"用户询问天气，需要调用天气查询函数。"</span>,
            <span class="hljs-string">"function_name"</span>: <span class="hljs-string">"get_weather"</span>,
            <span class="hljs-string">"parameters"</span>: {<span class="hljs-string">"city"</span>: <span class="hljs-string">"北京"</span>} <span class="hljs-comment"># 简单起见，这里固定城市，实际应由模型提取</span>
        }
    <span class="hljs-keyword">elif</span> <span class="hljs-string">"计算"</span> <span class="hljs-keyword">in</span> user_query <span class="hljs-keyword">or</span> <span class="hljs-string">"+"</span> <span class="hljs-keyword">in</span> user_query <span class="hljs-keyword">or</span> <span class="hljs-string">"-"</span> <span class="hljs-keyword">in</span> user_query:
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"reasoning"</span>: <span class="hljs-string">"用户需要数学计算，调用计算器函数。"</span>,
            <span class="hljs-string">"function_name"</span>: <span class="hljs-string">"calculator"</span>,
            <span class="hljs-string">"parameters"</span>: {<span class="hljs-string">"expression"</span>: <span class="hljs-string">"3 + 5 * 2"</span>}
        }
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> {<span class="hljs-string">"reasoning"</span>: <span class="hljs-string">"无需调用函数，直接回答。"</span>, <span class="hljs-string">"action"</span>: <span class="hljs-string">"direct_response"</span>}

<span class="hljs-comment"># AI Agent 执行循环</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">run_ai_agent</span>(<span class="hljs-params">user_input</span>):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"用户: <span class="hljs-subst">{user_input}</span>"</span>)
    
    <span class="hljs-comment"># 1. 大模型分析意图，决定行动</span>
    decision = mock_llm_function_call(user_input)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"AI决策: <span class="hljs-subst">{decision[<span class="hljs-string">'reasoning'</span>]}</span>"</span>)
    
    <span class="hljs-comment"># 2. 如果决定调用函数</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">'function_name'</span> <span class="hljs-keyword">in</span> decision:
        func_name = decision[<span class="hljs-string">'function_name'</span>]
        params = decision[<span class="hljs-string">'parameters'</span>]
        func = available_functions[func_name]
        
        <span class="hljs-comment"># 执行函数</span>
        result = func(**params)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"执行工具 `<span class="hljs-subst">{func_name}</span>`: 输入 <span class="hljs-subst">{params}</span>, 输出 <span class="hljs-subst">{result}</span>"</span>)
        
        <span class="hljs-comment"># 3. （可选）将函数执行结果返回给大模型，让其生成最终的自然语言回答</span>
        final_response = <span class="hljs-string">f"根据查询，结果是：<span class="hljs-subst">{result}</span>"</span>
        <span class="hljs-keyword">return</span> final_response
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># 直接回答的逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"这是一个需要我直接回答的问题。"</span>

<span class="hljs-comment"># 运行Agent</span>
response = run_ai_agent(<span class="hljs-string">"今天北京天气怎么样？"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Agent: <span class="hljs-subst">{response}</span>"</span>)

response = run_ai_agent(<span class="hljs-string">"帮我算一下3加5乘以2等于多少？"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"Agent: <span class="hljs-subst">{response}</span>"</span>)
</code></pre>
<p><strong>课程价值</strong>：此代码构建了一个简易AI Agent的核心循环。学员将学会如何将大模型的推理能力与外部工具/API相结合，创造出能解决实际问题的应用，这是当前AI应用开发的最前沿。</p>
<hr/>
<h3 data-id="heading-5"><strong>总结</strong></h3>
<p>“51CTO-AI大模型技术体系课”的独特之处在于，它<strong>不是知识的罗列，而是通过层层递进的代码实践，将Transformer、预训练、微调、对齐、Agent化等宏大概念，逐一拆解为可运行、可调试、可扩展的工程模块</strong>。 从一行行代码中，您将真正<strong>构建</strong>出对大模型技术的深刻直觉和工程能力，而不仅仅是停留在理论层面。这正是成为一名合格的AI工程师或研究员所必需的硬核训练。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RBAC模型：像电影院选座一样管理权限，告别"一个用户配一个权限"的噩梦]]></title>    <link>https://juejin.cn/post/7577242285197344795</link>    <guid>https://juejin.cn/post/7577242285197344795</guid>    <pubDate>2025-11-27T14:34:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577242285197344795" data-draft-id="7577226119105658907" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RBAC模型：像电影院选座一样管理权限，告别&quot;一个用户配一个权限&quot;的噩梦"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-27T14:34:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无限大6"/> <meta itemprop="url" content="https://juejin.cn/user/2865758605422890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RBAC模型：像电影院选座一样管理权限，告别"一个用户配一个权限"的噩梦
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2865758605422890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无限大6
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T14:34:08.000Z" title="Thu Nov 27 2025 14:34:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🎭 RBAC模型：像电影院选座一样管理权限，告别"一个用户配一个权限"的噩梦！</h2>
<blockquote>
<p>欢迎来到无限大的频道，有段日子没更新了，因为拿了一个比较满意的offer，给自己放了个假，之后就慢慢恢复更新了</p>
</blockquote>
<h3 data-id="heading-1">🎬 引言：当你的系统权限管理变成了"散票黄牛"...</h3>
<blockquote>
<p>想象一下：你揣着爆米花🍿，哼着主题曲🎶，兴冲冲跑到电影院想看《复联5》，结果售票员面无表情地说："不好意思，我们这里没有座位分区，想看电影得单独买每个座位的票🎫"。</p>
<p>你当场石化——这哪是看电影？这分明是在买电影厅的马赛克地砖啊！😱</p>
<p>现实中，90%的系统权限管理就像这个"脑回路清奇的电影院"：</p>
<ul>
<li>给每个用户单独分配权限？改一次权限要改500个用户配置🙄</li>
<li>新员工入职要填8张权限申请表？HR小姐姐都快哭了😭</li>
<li>临时调岗？权限交接堪比二手房过户📋</li>
</ul>
<p>直到RBAC模型横空出世，才把我们从这种"手工作坊"式的权限管理里解放出来——
<strong>这就像是给电影院装了个智能分区售票系统！</strong> 🚀</p>
</blockquote>
<h3 data-id="heading-2">⏱️ 3分钟搞懂RBAC：从"散票黄牛"到"智能影院售票系统"的逆袭！</h3>
<p>RBAC（基于角色的访问控制）到底是个啥？说人话就是——<strong>权限管理界的"智能分区售票系统"！</strong> 🎫</p>
<p>让我们用看电影的例子来拆解这个神奇模型：</p>

























<table><thead><tr><th>RBAC术语</th><th>电影院类比</th><th>现实中的例子</th></tr></thead><tbody><tr><td><strong>用户（User）</strong></td><td>观众</td><td>你的系统里的张三、李四、王五</td></tr><tr><td><strong>角色（Role）</strong></td><td>座位区域</td><td>普通厅、IMAX厅、VIP厅</td></tr><tr><td><strong>权限（Permission）</strong></td><td>具体座位+服务</td><td>3排5座的座位+免费爆米花🍿+饮料🥤</td></tr></tbody></table>
<p>就像你买了IMAX厅的票，自然就能享受"巨幕体验+杜比音效"，而不用再单独为音效买张票——RBAC的核心就是这个**"用户→角色→权限"的三层映射关系**！</p>
<p>这样一来，不管有多少用户，只要把他们分到不同的"影厅"（角色），他们自然就能获得相应的"观影体验"（权限）。</p>
<p><strong>彻底告别"一人一权限"的噩梦！</strong> 👻</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    subgraph "🎬 用户层 (观影者)"
        A1["小明 👦\n普通用户"] --&gt; B1["分配角色"]
        A2["小红 💎\nVIP客户"] --&gt; B2["分配角色"]
        A3["老王 🧔\n管理员"] --&gt; B3["分配角色"]
        A4["小李 👤\n新用户"] --&gt; B4["分配角色"]
    end
  
    subgraph "🎫 角色层 (票种)"
        B1 --&gt; C1["普通会员 👥"]
        B2 --&gt; C2["VIP客户 💫"]
        B3 --&gt; C3["管理员 🛠️"]
        B4 --&gt; C1
    end
  
    subgraph "🍿 权限层 (影院服务)"
        C1 --&gt; D1["查看电影信息 📽️"]
        C1 --&gt; D2["购买电影票 🎟️"]
        C1 --&gt; D3["基础观影体验 🎥"]
    
        C2 --&gt; D1
        C2 --&gt; D2
        C2 --&gt; D3
        C2 --&gt; D4["免费爆米花 🍿"]
        C2 --&gt; D5["VIP休息室 🏠"]
        C2 --&gt; D6["优先选座 💺"]
    
        C3 --&gt; D1
        C3 --&gt; D2
        C3 --&gt; D3
        C3 --&gt; D7["添加电影 🎬"]
        C3 --&gt; D8["管理会员 💼"]
        C3 --&gt; D9["修改票价 💰"]
    
        D1 --&gt; E["访问资源"]
        D2 --&gt; E
        D3 --&gt; E
        D4 --&gt; E
        D5 --&gt; E
        D6 --&gt; E
        D7 --&gt; E
        D8 --&gt; E
        D9 --&gt; E
    end
  
    style A1 fill:#f9f,stroke:#333,stroke-width:2px
    style A2 fill:#bbf,stroke:#333,stroke-width:2px
    style A3 fill:#bfb,stroke:#333,stroke-width:2px
    style A4 fill:#fdd,stroke:#333,stroke-width:2px
  
    style C1 fill:#ddd,stroke:#333,stroke-width:2px
    style C2 fill:#aaf,stroke:#333,stroke-width:2px
    style C3 fill:#afa,stroke:#333,stroke-width:2px
</code></pre>
<h3 data-id="heading-3">🔐 Java版：给电影院装个智能安检系统</h3>
<p>如果你用Java开发，Spring Security早就给你准备好了"现成的权限管理安检门"！直接配置角色权限就行，简单到哭——</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableWebSecurity</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CinemaSecurityConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> SecurityFilterChain <span class="hljs-title function_">securityFilterChain</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception {
        http.authorizeHttpRequests()
            <span class="hljs-comment">// VIP厅只有VIP角色能进（就像VIP通道，普通观众进不去）</span>
            .antMatchers(<span class="hljs-string">"/cinema/vip/**"</span>).hasRole(<span class="hljs-string">"VIP"</span>)
            <span class="hljs-comment">// IMAX厅普通观众和VIP都能进（IMAX厅比较贵，但大家都能买）</span>
            .antMatchers(<span class="hljs-string">"/cinema/imax/**"</span>).hasAnyRole(<span class="hljs-string">"VIP"</span>, <span class="hljs-string">"NORMAL"</span>)
            <span class="hljs-comment">// 公共区域随便进（爆米花柜台、洗手间不需要权限）</span>
            .antMatchers(<span class="hljs-string">"/cinema/public/**"</span>).permitAll()
            <span class="hljs-comment">// 其他所有区域都需要认证</span>
            .anyRequest().authenticated()
            .and()
            <span class="hljs-comment">// 配置登录页面</span>
            .formLogin();

        <span class="hljs-keyword">return</span> http.build();
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> UserDetailsService <span class="hljs-title function_">userDetailsService</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 创建用户和角色（相当于电影票数据库）</span>
        <span class="hljs-type">UserDetails</span> <span class="hljs-variable">vipUser</span> <span class="hljs-operator">=</span> User.withUsername(<span class="hljs-string">"xiaoming"</span>)
            .password(<span class="hljs-string">"{bcrypt}$2a$10$dxj3sw6g7p50lgmmkkmwe.20cqqubk3.hzwzg3yb1tlry.fqvm/bg"</span>) <span class="hljs-comment">// 密码已加密</span>
            .roles(<span class="hljs-string">"VIP"</span>)  <span class="hljs-comment">// 小明是VIP观众</span>
            .build();

        <span class="hljs-type">UserDetails</span> <span class="hljs-variable">normalUser</span> <span class="hljs-operator">=</span> User.withUsername(<span class="hljs-string">"laowang"</span>)
            .password(<span class="hljs-string">"{bcrypt}$2a$10$dxj3sw6g7p50lgmmkkmwe.20cqqubk3.hzwzg3yb1tlry.fqvm/bg"</span>) <span class="hljs-comment">// 密码已加密</span>
            .roles(<span class="hljs-string">"NORMAL"</span>)  <span class="hljs-comment">// 老王是普通观众</span>
            .build();

        <span class="hljs-comment">// 内存用户管理器（实际项目中应该连接数据库）</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InMemoryUserDetailsManager</span>(vipUser, normalUser);
    }
}
</code></pre>
<p><strong>这段代码到底干了什么？</strong> 🤔</p>
<ol>
<li>定义了不同"影厅"（URL路径）的访问规则</li>
<li>创建了两个"观众"（用户）并分配了不同的"票种"（角色）</li>
<li>当用户访问系统时，Spring Security会自动检查他们的角色，决定他们能进哪些区域</li>
</ol>
<p>就像电影院门口的智能安检系统，刷一下票就知道你能进哪个厅！🚪</p>
<h3 data-id="heading-4">🎭 RBAC的四种"豪华影厅"：从经济舱到私人影院</h3>
<p>RBAC家族一共有四个成员，就像电影院里的四种不同档次的影厅，各有各的特点，满足不同规模系统的需求：</p>
<h4 data-id="heading-5">🛫 RBAC0：经济舱基础款 - 小影院首选！</h4>
<p><strong>核心特点</strong>：最简单的"用户-角色-权限"三层映射</p>
<ul>
<li>就像飞机的经济舱，虽然简单，但能满足基本需求✈️</li>
<li>80%的中小型系统用它就够了！</li>
<li><strong>适用场景</strong>：小型项目、初创公司、内部管理系统</li>
</ul>
<h4 data-id="heading-6">👑 RBAC1：VIP厅升级款 - 带继承功能的高级货！</h4>
<p><strong>核心特点</strong>：在RBAC0基础上增加了"角色继承"功能</p>
<ul>
<li>就像买了VIP厅的票，自然也能去普通厅（权限向下继承）</li>
<li>但普通厅观众绝对进不去VIP区（权限不能向上继承）</li>
<li>适合有明确职级体系的企业</li>
</ul>
<p>角色继承关系图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b73499f39ab410a9826947490946cd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6ZmQ5aSnNg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764858848&amp;x-signature=GuH6Yoz%2Bqt7EABv24P0uFoGR45g%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-7">🎫 RBAC2：带严格检票员的安全升级版</h4>
<p><strong>核心特点</strong>：增加了各种限制规则，就像电影院有了严格的检票员</p>





























<table><thead><tr><th>约束类型</th><th>电影院例子</th><th>系统中的应用</th><th>安全级别</th></tr></thead><tbody><tr><td><strong>角色互斥</strong></td><td>不能同时买"普通厅"和"VIP厅"的票</td><td>一个用户不能同时拥有"财务审核"和"财务付款"权限</td><td>🔐🔐🔐🔐🔐</td></tr><tr><td><strong>基数约束</strong></td><td>VIP厅最多卖20张票</td><td>管理员角色最多只能分配给5个用户</td><td>🔐🔐🔐</td></tr><tr><td><strong>先决条件</strong></td><td>买IMAX票必须先买过普通票</td><td>要获得"经理"角色必须先有"普通员工"角色</td><td>🔐🔐🔐🔐</td></tr></tbody></table>
<p>就像电影院规定"1米2以下儿童不能看R级片"，RBAC2让你的权限管理更安全🔒</p>
<h4 data-id="heading-8">🏆 RBAC3：私人定制影院 - 企业级豪华套餐！</h4>
<p><strong>核心特点</strong>：RBAC1 + RBAC2 = 宇宙无敌豪华版</p>
<ul>
<li>既有角色继承的便利性，又有严格的权限约束</li>
<li>就像私人定制影院，既能享受所有放映技术，又能严格控制入场人数</li>
<li><strong>适用场景</strong>：大型企业、金融系统、需要严格权限控制的复杂应用</li>
</ul>
<h3 data-id="heading-9">📊 RBAC四种模型详细对比表</h3>


















































<table><thead><tr><th align="left"><strong>模型版本</strong></th><th align="left"><strong>核心特点</strong></th><th align="left"><strong>复杂度</strong></th><th align="left"><strong>适用场景</strong></th><th align="left"><strong>开发难度</strong></th><th align="left"><strong>电影院类比</strong></th><th align="left"><strong>推荐指数</strong></th></tr></thead><tbody><tr><td align="left"><strong>RBAC0</strong></td><td align="left">用户-角色-权限三层映射</td><td align="left">⭐⭐</td><td align="left">小型项目、初创公司、内部管理系统</td><td align="left">💻</td><td align="left">经济舱/普通影厅</td><td align="left">🌟🌟🌟</td></tr><tr><td align="left"><strong>RBAC1</strong></td><td align="left">RBAC0 + 角色继承功能</td><td align="left">⭐⭐⭐</td><td align="left">有职级体系的企业</td><td align="left">💻💻</td><td align="left">VIP厅</td><td align="left">🌟🌟🌟🌟</td></tr><tr><td align="left"><strong>RBAC2</strong></td><td align="left">RBAC0 + 约束规则</td><td align="left">⭐⭐⭐</td><td align="left">安全要求高的系统</td><td align="left">💻💻💻</td><td align="left">带严格检票员的影厅</td><td align="left">🌟🌟🌟🌟</td></tr><tr><td align="left"><strong>RBAC3</strong></td><td align="left">RBAC1 + RBAC2</td><td align="left">⭐⭐⭐⭐⭐</td><td align="left">大型复杂企业系统</td><td align="left">💻💻💻💻💻</td><td align="left">私人定制影院</td><td align="left">🌟🌟🌟</td></tr></tbody></table>
<p><strong>选择建议</strong>：</p>
<ul>
<li>初创项目/小团队：从RBAC0开始，后期根据需求升级到RBAC1</li>
<li>中大型企业：RBAC1或RBAC2是平衡安全性和复杂度的最佳选择</li>
<li>金融/医疗等敏感行业：建议使用RBAC2以满足合规要求</li>
<li>超大系统：RBAC3虽然功能最全，但开发维护成本高，需谨慎选择</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/251b4cf15880403b82cd7755b968e824~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg6ZmQ5aSnNg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764858848&amp;x-signature=AMpU%2FOSy%2B3M6EZ6sb33LKWOeQHE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-10">⚠️ 避坑指南：别让你的RBAC变成"烂片"！</h3>
<h4 data-id="heading-11">🚨 坑一：角色爆炸 - 你的系统里有1000个角色吗？</h4>
<p>某银行系统的工程师突发奇想："把每个岗位都设成独立角色吧！"结果——</p>
<ul>
<li>"上海徐汇区客户经理"</li>
<li>"北京朝阳区客户经理"</li>
<li>"广州天河区客户经理"</li>
<li>...</li>
</ul>
<p>系统里出现了200多个类似角色，管理员都快被逼疯了！😵‍💫</p>
<p><strong>正确姿势</strong>：角色按职责划分，区域作为数据权限控制！🌍</p>
<h4 data-id="heading-12">🚨 坑二：权限粒度过粗 - "要么全有要么全无"的噩梦</h4>
<p>就像电影院只卖"观影权"，却不细分"3D眼镜租赁权"、"中途离场再入场权"...</p>
<p><strong>权限设计应该精细到按钮级别</strong>：</p>
<ul>
<li>"查看订单"和"导出订单"是两个完全不同的权限</li>
<li>"编辑个人资料"和"修改薪资数据"更是天壤之别</li>
</ul>
<h4 data-id="heading-13">🚨 坑三：忽视审计 - "谁动了我的权限蛋糕？"</h4>
<p>没有日志记录的RBAC就像没有监控的影院，出了问题找不到责任人！</p>
<p><strong>一定要记录</strong>：<strong>谁在什么时候用了什么权限</strong> 🕵️‍♂️</p>
<h3 data-id="heading-14">🏆 大厂都是怎么设计权限的？</h3>
<h4 data-id="heading-15">💰 SAP系统：财务权限的"分级售票窗口"</h4>
<p>SAP把财务系统分成了精细的权限层级：</p>
<ul>
<li>"会计"角色只能"录凭证"</li>
<li>"财务经理"角色能"录凭证+审批"</li>
<li>"财务总监"角色拥有全部权限</li>
</ul>
<p>就像电影院的售票窗口分"普通票窗口"和"VIP专属窗口"，既避免越权操作，又保证工作流顺畅。</p>
<h4 data-id="heading-16">☁️ AWS IAM：云资源的"动态座位图"</h4>
<p>AWS的权限系统精细到让人惊叹：</p>
<ul>
<li>管理员/开发/只读角色明确分离</li>
<li>EC2实例的"启动/停止/查看"权限精确到API级别</li>
<li>S3存储桶的"上传/下载/删除"权限可按文件夹设置</li>
</ul>
<p>这好比IMAX厅不仅分座位，还按座位提供不同服务（前排送耳机，后排送靠垫），实现了真正的精细化权限管控！</p>
<h4 data-id="heading-17">🚢 Kubernetes：容器集群的"影厅分区系统"</h4>
<p>K8s的权限控制堪称教科书级别：</p>
<ul>
<li>ClusterRole定义"pod-reader"角色，允许开发人员查看但不能删除容器</li>
<li>通过RoleBinding绑定到特定命名空间</li>
<li>即使都是"观众"，也严格限制在自己的"影厅"里</li>
</ul>
<p>就像电影院把"IMAX厅"和"普通厅"物理隔离，防止有人串厅搞事情！🔒</p>
<p><strong>划重点</strong>：就算是好模型，用不好也会翻车。上面这三个坑，一定要避开！</p>
<h3 data-id="heading-18">🚀 结语：从"手工作坊"到"智能影院"的权限管理进化！</h3>
<p>RBAC模型的伟大之处，在于它把权限管理从"卖散装座位"变成了"分区售票系统"。当你下次再为权限配置抓狂时，想想电影院的例子：<strong>用户是观众，角色是票种，权限是座位和服务</strong>。</p>
<p>最后送大家一个RBAC实施 Checklist：</p>
<p>✅ <strong>先梳理公司的组织架构</strong>（相当于影院平面图）
✅ <strong>按职责划分角色</strong>（设计票种）
✅ <strong>给角色分配最小必要权限</strong>（避免过度授权）
✅ <strong>定期审计角色和权限</strong>（查票根）</p>
<p>现在，是时候把你的系统权限管理从"黄牛票时代"升级到"智能影院时代"了！🎬 享受这种如丝般顺滑的权限管理体验吧！</p>
<blockquote>
<p>💡 <strong>思考题</strong>：如果把ABAC模型（基于属性的访问控制）比作"动态票价系统"（如周二半价、学生折扣），它和RBAC会擦出什么火花？评论区说说你的想法！👇 说不定你的想法会启发下一篇精彩文章哦！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Transporter 在 iOS 上架流程中的角色变化 本地上传工具的定位、局限与多工具协作趋势分析]]></title>    <link>https://juejin.cn/post/7577430671947841562</link>    <guid>https://juejin.cn/post/7577430671947841562</guid>    <pubDate>2025-11-28T08:38:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577430671947841562" data-draft-id="7577438119558692915" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Transporter 在 iOS 上架流程中的角色变化 本地上传工具的定位、局限与多工具协作趋势分析"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-28T08:38:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="疯狂的程序猴"/> <meta itemprop="url" content="https://juejin.cn/user/2760245749234147"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Transporter 在 iOS 上架流程中的角色变化 本地上传工具的定位、局限与多工具协作趋势分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2760245749234147/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    疯狂的程序猴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T08:38:40.000Z" title="Fri Nov 28 2025 08:38:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在苹果的生态体系里，Transporter 长期被视为开发者将 IPA 与 App 元数据上传至 App Store 的核心工具之一。它最初被设计用于替代 Application Loader，为非开发人员（如运营、内容团队）提供相对直观的可视化上传能力。
然而随着开发团队工作环境的多元化（跨平台构建、云端 CI、Windows 主力研发机等），Transporter 的地位正在悄然发生变化：它仍然重要，但不再是“唯一正途”。</p>
<p>本文试图从工程组织与工具链协作的角度，重新审视 Transporter 在现代 iOS 上架流程中的定位，同时拆解其局限、适用场景与与其他工具的协作方式。</p>
<hr/>
<h2 data-id="heading-0"><strong>一、Transporter 的设计初衷：弥补 Xcode Organizer 的不足</strong></h2>
<p>Xcode Organizer 一直是官方推荐的上传方式，但它存在三个显著局限：</p>
<ol>
<li>必须使用 Mac</li>
<li>必须安装 Xcode</li>
<li>更偏向开发者，而非运营团队</li>
</ol>
<p>Transporter 作为独立 Mac 应用，使命是：</p>
<ul>
<li><strong>让上传不依赖 Xcode</strong></li>
<li><strong>让运营人员也能执行上传</strong></li>
<li><strong>支持拖拽 IPA 与元数据</strong></li>
<li><strong>显示更直观的上传日志</strong></li>
</ul>
<p>在企业工作流中，Transporter 的出现意义在于：
<strong>它把“上传”从开发岗解放了出来。</strong></p>
<hr/>
<h2 data-id="heading-1"><strong>二、Transporter 的优势：清晰、稳定、官方、适合手工提交</strong></h2>
<p>Transporter 的强项很明确：</p>
<h3 data-id="heading-2"><strong>1. 操作清晰</strong></h3>
<ul>
<li>拖拽 ipa</li>
<li>填写 Apple ID</li>
<li>等待上传完成</li>
</ul>
<p>适合不熟悉命令行的人。</p>
<hr/>
<h3 data-id="heading-3"><strong>2. 官方支持，错误日志比较规范</strong></h3>
<p>上传失败时常见：</p>
<ul>
<li>证书问题</li>
<li>元数据问题</li>
<li>通道问题</li>
<li>包格式异常</li>
</ul>
<p>Transporter 的报错通常能准确指向问题来源。</p>
<hr/>
<h3 data-id="heading-4"><strong>3. 稳定适合作为“最终上传环节”</strong></h3>
<p>许多团队在构建自动化之后：</p>
<ul>
<li>构建 → 自动测试</li>
<li>上传 → 手工用 Transporter</li>
</ul>
<p>将上传与发布这一环节留给更可靠、人工确认的工具。</p>
<hr/>
<h2 data-id="heading-5"><strong>三、Transporter 的局限也明显：Mac 单平台是最大限制</strong></h2>
<p>随着团队规模扩大、跨平台技术增强、CI/CD 普及，本地 Mac 工具的限制越发明显：</p>
<hr/>
<h3 data-id="heading-6"><strong>1. 强依赖 Mac</strong></h3>
<p>这是 Transporter 最大的结构性问题。</p>
<ul>
<li>Windows 无法运行</li>
<li>Linux 无法运行</li>
<li>服务器环境无法运行</li>
</ul>
<p>这让 Transporter 无法融入自动化流水线。</p>
<hr/>
<h3 data-id="heading-7"><strong>2. 不适合高频发布或 TF 迭代</strong></h3>
<p>TestFlight 测试通常需要高频上传：</p>
<ul>
<li>Bug 修复一天发数次</li>
<li>小版本持续迭代</li>
<li>构建流水线自动触发上传</li>
</ul>
<p>Transporter 的拖拽模式并不适用。</p>
<hr/>
<h3 data-id="heading-8"><strong>3. 多人协作困难</strong></h3>
<p>因为 Transporter 运行在本地：</p>
<ul>
<li>无法保持上传历史统一</li>
<li>多台机器需要重复配置</li>
<li>不能进行集中化的发布管理</li>
</ul>
<p>这在大型团队中是明显短板。</p>
<hr/>
<h2 data-id="heading-9"><strong>四、现代团队的上传策略：Transporter + 跨平台 CLI 的分工协作</strong></h2>
<p>Transporter 并未被取代，但它的定位变得更加明确：</p>
<h3 data-id="heading-10"><strong>Transporter 的适用场景：</strong></h3>
<ul>
<li>本地调试构建上传</li>
<li>运营人员处理单次提交</li>
<li>版本发布前的人工确认</li>
<li>小团队低频发布</li>
</ul>
<h3 data-id="heading-11"><strong>开心上架（Appuploader）跨平台命令行工具的适用场景：</strong></h3>
<ul>
<li>Windows / Linux 上架</li>
<li>CI/CD 自动上传</li>
<li>高频 TF 构建提交</li>
<li>全球团队协作</li>
<li>无 Mac 环境</li>
</ul>
<p>例如：</p>
<pre><code class="hljs language-bash" lang="bash">appuploader_cli \
  -u ios@team.com \
  -p xxx-xxx-xxx-xxx \
  -c 1 \
  -f build/app.ipa
</code></pre>
<p>这种分工结构已成为许多跨端团队的主流模型。</p>
<p>图形化界面：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aceb4b9904534862a210a89351bcc7e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC55qE56iL5bqP54y0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764923919&amp;x-signature=FQD6IGq8tHl4sGR2rZ8k7MoeDO4%3D" alt="ipa上传" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-12"><strong>五、典型团队的“三段式上传链路”：Transporter 不再孤立存在</strong></h2>
<p>一个成熟的 iOS 上架链路通常会拆成三段：</p>
<hr/>
<h3 data-id="heading-13"><strong>第一段：构建（Build）</strong></h3>
<ul>
<li>本地 Xcode</li>
<li>CI（GitHub Actions / Codemagic）</li>
<li>Hybrid / uni-app 云打包</li>
<li>Unity / Cocos Windows 构建 + 云构建</li>
</ul>
<p>最终得到 ipa。</p>
<hr/>
<h3 data-id="heading-14"><strong>第二段：上传（Upload）</strong></h3>
<p>根据团队环境，有三种选择：</p>
<ol>
<li><strong>Transporter（Mac）</strong></li>
<li><strong>Xcode Organizer（Mac）</strong></li>
<li><strong>开心上架（Appuploader）跨平台 CLI（Windows / Linux / Mac）</strong></li>
</ol>
<p>这三者并不是互斥，而是并存。</p>
<hr/>
<h3 data-id="heading-15"><strong>第三段：发布（Release）</strong></h3>
<p>在 App Store Connect 完成：</p>
<ul>
<li>截图</li>
<li>版本说明</li>
<li>隐私标签</li>
<li>WWDR 配置</li>
<li>提交审核</li>
</ul>
<p>Transporter 仅负责第二段。</p>
<hr/>
<h2 data-id="heading-16"><strong>六、Transporter 的“未来价值”：从核心工具转向补位工具</strong></h2>
<p>Transporter 仍然重要，但其角色正在变化：</p>
<h3 data-id="heading-17"><strong>从必需工具 → 可选工具</strong></h3>
<p>上传通道不再仅有 Mac App，现代 CLI 工具已覆盖全平台。</p>
<hr/>
<h3 data-id="heading-18"><strong>从开发者工具 → 运营工具</strong></h3>
<p>运营、产品、测试成员常使用它完成：</p>
<ul>
<li>构建上载</li>
<li>元数据校验</li>
<li>人工确认环节</li>
</ul>
<p>开发者更常使用自动化方式上传。</p>
<hr/>
<h3 data-id="heading-19"><strong>从主力工具 → 审核前的人为复核节点</strong></h3>
<p>上传流程自动化之后，Transporter 成为补位工具，用于：</p>
<ul>
<li>手动校验构建</li>
<li>处理一次性临时版本</li>
<li>确认自动化通道异常时的 fallback</li>
</ul>
<p>它像机场备用跑道：
<strong>不是主跑道，但非常重要。</strong></p>
<hr/>
<h2 data-id="heading-20"><strong>Transporter 在现代 iOS 上架流程中的定位更清晰，而非被替代</strong></h2>
<p>Transporter 的核心价值依然存在：</p>
<ul>
<li>可靠</li>
<li>日志规范</li>
<li>适合人工审查</li>
<li>是 App Store 官方支持链的一部分</li>
</ul>
<p>但在多平台团队与自动化趋势下，它不再承担唯一职责，而是成为整个上架体系中的 <strong>“人工可控节点”</strong>，与自动化上传工具、CI 构建流程共同组成完整的工具链。</p>
<p>这是一种更加成熟、工程化的生态发展方向。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Day 17：03. 基于 Tauri 2.0 开发后台管理系统-登录页面开发]]></title>    <link>https://juejin.cn/post/7577587651893919785</link>    <guid>https://juejin.cn/post/7577587651893919785</guid>    <pubDate>2025-11-28T08:54:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577587651893919785" data-draft-id="7577563004481830966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Day 17：03. 基于 Tauri 2.0 开发后台管理系统-登录页面开发"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2025-11-28T08:54:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="申阳"/> <meta itemprop="url" content="https://juejin.cn/user/4353721775165486"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Day 17：03. 基于 Tauri 2.0 开发后台管理系统-登录页面开发
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4353721775165486/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    申阳
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T08:54:59.000Z" title="Fri Nov 28 2025 08:54:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/562fd52a738540aa908c891ad0b636ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764924898&amp;x-signature=511go3L9BU%2FZlSGF7p55LMRr%2FAU%3D" alt="image-20251128163616981" loading="lazy"/></p>
<h2 data-id="heading-0">一、前言</h2>
<p>前面我们已经完成了基础的整合工作，接下来开始具体业务的开发了，因为是个人项目，全干工程师，所以无论你从哪里开始都可以，我习惯从登录开始，前后端一起，先写页面，再写接口，然后调试，一个功能做完再开始下一个。这只是我个人习惯，你完全可以随性一点，先写后端再写前端，或者前端全部用静态数据，写完再写后端对接接口。</p>
<h2 data-id="heading-1">二、登录界面开发</h2>
<p>每次开始写前端的时候都会很纠结，脑子里全是想法，但是落实到具体页面又不知道从哪下手。首先 <code>UI</code> 从何而来就让人头大。经过这么多年的折腾，有了一些小的经验，分享给大家。</p>
<ul>
<li><strong>找个类似产品，直接照抄，抄的肯定比你一边做一边想要好的多，最终成品也更像一个产品</strong></li>
</ul>
<blockquote>
<p>早年的时候，我会有一点心理负担，觉得这样不太道德，也不屑于这么做，觉得靠自己设计出来的才是最完美。其实不然，术业有专攻，我们的思想早已经被同质化，如果凭借我们自己发挥，最终也还是会和我们见过的 <code>UI</code> 贴近，左边菜单，右边展示页面，在一些小样式上挣扎，最后花费大量时间。所以还不如直接放下心理包袱，直接借鉴，等完整产品出来后，再去打磨，调整出自己的风格。</p>
</blockquote>
<ul>
<li><strong>寻找专业的UI设计师设计</strong></li>
</ul>
<blockquote>
<p>当然个人开发最理想的情况是找到志同道合的设计师朋友一起合作，或者直接去某平台花钱买设计</p>
</blockquote>
<ul>
<li><strong>在一些设计平台找一些公开的设计作品</strong></li>
</ul>
<blockquote>
<p>这里我目前用的比较多的是 <strong>即时设计</strong>，这个项目我也打算在这个上面找一找。<a href="https://link.juejin.cn?target=https%3A%2F%2Fjs.design%2F" target="_blank" title="https://js.design/" ref="nofollow noopener noreferrer">js.design/</a></p>
</blockquote>
<p>在资源广场搜索即可，找到自己中意的即可。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/817a99083f1146e7ab39eec7160e3f9b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764924898&amp;x-signature=lBAJi%2FgfZxbxWtuBj1rGb17GFPk%3D" alt="image-20251127134431837" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a13f8169d444234b68e695a8fa0fa13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764924898&amp;x-signature=RVhHKr52mQypMCxTCmK99NEEA94%3D" alt="image-20251127134441968" loading="lazy"/></p>
<h3 data-id="heading-2">2.1. 页面编写</h3>
<p>这个具体怎么实现我就不赘述了，照着 <code>UI</code> 界面模仿即可。</p>
<p>这里有两个问题：</p>
<p>第一：登录的窗口应该小一点，登录成功之后跳转到主页面，窗口变大。</p>
<p>第二：登录窗口应该锁死不允许收缩，全屏等操作，主界面可以拖动放大缩小，并且可以全屏。</p>
<p>带着这两个问题我结合 <code>AI</code>，去官方文档找了一下解决方案。</p>
<p>如果你时间比较充裕，我希望你可以自己先探索研究一下，过程很有趣。</p>
<p>下面介绍具体实现方式：</p>
<blockquote>
<p>开发开发前，先将之前的测试代码全部清除。
顺便引入一下 <code>tailwindcss</code>，参考文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Ftailwind.nodejs.cn%2Fdocs%2Finstallation%2Fusing-vite" target="_blank" title="https://tailwind.nodejs.cn/docs/installation/using-vite" ref="nofollow noopener noreferrer">tailwind.nodejs.cn/docs/instal…</a></p>
</blockquote>
<blockquote>
<p>❗️<strong>注意：</strong> 在我开发完登录模块后，我发现 <strong>Ant Design Vue</strong> 使用起来很不顺手，可能是功能太强大了，做的太灵活了，我决定换成 <strong>Naive UI</strong> , 我平时用的比较多的其实还是 <strong>Element Plus</strong> ，但是我想要尝试一下其他的。如果你习惯于  <strong>Ant Design Vue</strong>  那就接着使用即可。<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.naiveui.com%2F" target="_blank" title="https://www.naiveui.com/" ref="nofollow noopener noreferrer">www.naiveui.com/</a></p>
</blockquote>
<h3 data-id="heading-3">2.2. 切换 Naive UI 组件库</h3>
<ul>
<li><strong>安装依赖</strong></li>
</ul>
<pre><code class="hljs language-bash" lang="bash">pnpm i -D naive-ui
</code></pre>
<ul>
<li><strong>字体</strong></li>
</ul>
<pre><code class="hljs language-bash" lang="bash">pnpm i -D vfonts
</code></pre>
<ul>
<li><strong>图标库/图标包装组件</strong></li>
</ul>
<pre><code class="hljs language-bash" lang="bash">npm i -D @vicons/antd @vicons/utils
</code></pre>
<ul>
<li><strong>配置按需自动导入</strong></li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">AutoImport</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-auto-import/vite'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NaiveUiResolver</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-vue-components/resolvers'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Components</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-vue-components/vite'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-comment">// ...</span>
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-comment">// ...</span>
     <span class="hljs-title class_">AutoImport</span>({ 
      <span class="hljs-attr">resolvers</span>: [<span class="hljs-title class_">NaiveUiResolver</span>()],
    }),
    <span class="hljs-title class_">Components</span>({ 
      <span class="hljs-attr">resolvers</span>: [<span class="hljs-title class_">NaiveUiResolver</span>()],
    }),
  ],
})
</code></pre>
<ul>
<li><strong>修改 request 中的 message 方法</strong></li>
</ul>
<blockquote>
<p>这里需要注意，<strong>Naive UI</strong> 的 <code>message</code>  如果要在 <code>setup</code> 外使用需要需要额外处理一下。<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.naiveui.com%2Fzh-CN%2Fos-theme%2Fcomponents%2Fmessage%23%25E5%259C%25A8-setup-%25E5%25A4%2596%25E4%25BD%25BF%25E7%2594%25A8" target="_blank" title="https://www.naiveui.com/zh-CN/os-theme/components/message#%E5%9C%A8-setup-%E5%A4%96%E4%BD%BF%E7%94%A8" ref="nofollow noopener noreferrer">www.naiveui.com/zh-CN/os-th…</a></p>
</blockquote>
<p>创建 <code>src/hooks/useMessagehook.ts</code></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { createDiscreteApi } <span class="hljs-keyword">from</span> <span class="hljs-string">'naive-ui'</span>


<span class="hljs-keyword">const</span> { message, notification, dialog, loadingBar, modal } = <span class="hljs-title function_">createDiscreteApi</span>(
    [<span class="hljs-string">'message'</span>, <span class="hljs-string">'dialog'</span>, <span class="hljs-string">'notification'</span>, <span class="hljs-string">'loadingBar'</span>, <span class="hljs-string">'modal'</span>]
)

<span class="hljs-keyword">export</span> { message, notification, dialog, loadingBar, modal }
</code></pre>
<p><code>request</code> 中改为使用 <code>hooks</code> 方法。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { message } <span class="hljs-keyword">from</span> <span class="hljs-string">'../hooks/useMessagehook'</span>
...
message.<span class="hljs-title function_">error</span>(msg)
</code></pre>
<h3 data-id="heading-4">2.3. 首页开发</h3>
<p>创建 <code>src/view/login/LoginPage.vue</code></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useUserInfoStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../stores/modules/user'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserOutlined</span>, <span class="hljs-title class_">LockOutlined</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@vicons/antd'</span>
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'../../router'</span>

interface <span class="hljs-title class_">LoginFormData</span> {
  <span class="hljs-attr">username</span>: string
  <span class="hljs-attr">password</span>: string
}

<span class="hljs-comment">// 登录表单数据</span>
<span class="hljs-keyword">const</span> loginFormData = reactive&lt;<span class="hljs-title class_">LoginFormData</span>&gt;({
  <span class="hljs-attr">username</span>: <span class="hljs-string">'admin'</span>,
  <span class="hljs-attr">password</span>: <span class="hljs-string">'admin123456'</span>,
})

<span class="hljs-comment">// 登录表单ref</span>
<span class="hljs-keyword">const</span> loginFormRef = <span class="hljs-title function_">ref</span>()
<span class="hljs-comment">// 加载动画</span>
<span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
<span class="hljs-comment">// 获取用户信息缓存仓库</span>
<span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserInfoStore</span>()

<span class="hljs-comment">// 表单验证规则</span>
<span class="hljs-keyword">const</span> rules = <span class="hljs-title function_">ref</span>({
  <span class="hljs-attr">username</span>: [{ <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'请输入用户名'</span>, <span class="hljs-attr">trigger</span>: <span class="hljs-string">'blur'</span> }],
  <span class="hljs-attr">password</span>: [{ <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'请输入密码'</span>, <span class="hljs-attr">trigger</span>: <span class="hljs-string">'blur'</span> }],
})

<span class="hljs-comment">// 登录</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLogin</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 表单验证</span>
  <span class="hljs-keyword">const</span> valid = <span class="hljs-keyword">await</span> loginFormRef.<span class="hljs-property">value</span>?.<span class="hljs-title function_">validate</span>()
  <span class="hljs-comment">// 校验不成功直接 return</span>
  <span class="hljs-keyword">if</span> (!valid) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }
  <span class="hljs-comment">// 校验成功进行后续操作</span>
  <span class="hljs-comment">// 1.加载 loading</span>
  loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>
  <span class="hljs-comment">// 2.登录请求 获取token</span>
  userStore
    .<span class="hljs-title function_">login</span>()
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 跳转</span>
      router.<span class="hljs-title function_">push</span>(<span class="hljs-string">'/'</span>)
    })
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 验证失败，重新加载验证码</span>
    })
    .<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 验证结束，隐藏loading</span>
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
    })
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"h-screen"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">n-grid</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"h-full"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">n-gi</span> <span class="hljs-attr">span</span>=<span class="hljs-string">"14"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"relative h-full bg-[url('../../images/login_bg.webp')] bg-center bg-cover bg-no-repeat"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"absolute top-5 left-5 text-2xl font-bold text-white"</span>&gt;</span> EZ-ADMIN <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"absolute bottom-30 left-1/2 -translate-x-1/2 text-xl text-nowrap text-white"</span>&gt;</span>
            相信自己我能行， 老天不会辜负你所付出的努力！
          <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">n-gi</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">n-gi</span> <span class="hljs-attr">span</span>=<span class="hljs-string">"10"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"h-full flex flex-col items-center justify-center px-15"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-3xl font-bold text-black text-center"</span>&gt;</span>欢迎登录<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"w-full flex items-center justify-center flex-nowrap gap-1 my-5"</span>&gt;</span>
            <span class="hljs-comment">&lt;!-- 分割线：更细腻的设计 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"w-16 h-px bg-slate-400"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-nowrap text-slate-400"</span>&gt;</span>账号密码登录<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"w-16 h-px bg-slate-400"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-comment">&lt;!-- 表单 --&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">n-form</span>
            <span class="hljs-attr">class</span>=<span class="hljs-string">"w-50 sm:w-50 md:w-75 lg:w-90"</span>
            <span class="hljs-attr">:show-label</span>=<span class="hljs-string">"false"</span>
            <span class="hljs-attr">ref</span>=<span class="hljs-string">"loginFormRef"</span>
            <span class="hljs-attr">:model</span>=<span class="hljs-string">"loginFormData"</span>
            <span class="hljs-attr">:rules</span>=<span class="hljs-string">"rules"</span>
            <span class="hljs-attr">size</span>=<span class="hljs-string">"large"</span>
          &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">n-form-item</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"username"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">n-input</span> <span class="hljs-attr">v-model:value</span>=<span class="hljs-string">"loginFormData.username"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入用户名"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">prefix</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">n-icon</span> <span class="hljs-attr">:component</span>=<span class="hljs-string">"UserOutlined"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-slate-400"</span> /&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">n-input</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">n-form-item</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">n-form-item</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"password"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">n-input</span>
                <span class="hljs-attr">v-model:value</span>=<span class="hljs-string">"loginFormData.password"</span>
                <span class="hljs-attr">show-password-on</span>=<span class="hljs-string">"mousedown"</span>
                <span class="hljs-attr">type</span>=<span class="hljs-string">"password"</span>
                <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入密码"</span>
              &gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">prefix</span>&gt;</span>
                  <span class="hljs-tag">&lt;<span class="hljs-name">n-icon</span> <span class="hljs-attr">:component</span>=<span class="hljs-string">"LockOutlined"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-slate-400"</span> /&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">n-input</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">n-form-item</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">n-form-item</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">n-button</span> <span class="hljs-attr">block</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"large"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleLogin"</span>&gt;</span>登 录<span class="hljs-tag">&lt;/<span class="hljs-name">n-button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">n-form-item</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">n-form</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">n-gi</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">n-grid</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"less"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>

</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/407c27b853b84505a886388c7b89d7ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz6Ziz:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764924898&amp;x-signature=ePbxcacOCgGmpEYKs9cx8ZAmt7Y%3D" alt="image-20251128163616981" loading="lazy"/></p>
<blockquote>
<p>这里简单提一下，页面写好后要配置好路由，以及路由出口。</p>
<p>在 <code>tauri.conf.json</code> 中定义初始打开窗口的大小。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-string">"app"</span>: {
    <span class="hljs-string">"windows"</span>: [
      {
        <span class="hljs-string">"title"</span>: <span class="hljs-string">"tauri-app"</span>,
        <span class="hljs-string">"width"</span>: <span class="hljs-number">800</span>,
        <span class="hljs-string">"height"</span>: <span class="hljs-number">600</span>
      }
    ],
    <span class="hljs-string">"security"</span>: {
      <span class="hljs-string">"csp"</span>: <span class="hljs-literal">null</span>
    }
  },
</code></pre>
</blockquote>
<h2 data-id="heading-5">三、总结</h2>
<p>因为其实最终还是 <code>web</code> 那一套，所以我直接沿用了之前开发的一套脚手架项目，不过为了寻求一些变化，我这次使用了 <strong>Tailwindcss</strong> 和 <strong>Naive UI</strong> 。 原项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FCaoshenyang%2Fez-admin-vue" target="_blank" title="https://github.com/Caoshenyang/ez-admin-vue" ref="nofollow noopener noreferrer">github.com/Caoshenyang…</a></p>
<p><strong>千里之行，始于足下。你的“个人公司”从这第一个2小时开始。欢迎在评论区分享你的进展或遇到的卡点，我会逐一查看，尽可能的帮助解决。我们下一篇文章见！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[源码解析：RustFS如何用“零拷贝”技术碾压传统文件系统？]]></title>    <link>https://juejin.cn/post/7577321767347372078</link>    <guid>https://juejin.cn/post/7577321767347372078</guid>    <pubDate>2025-11-28T06:56:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577321767347372078" data-draft-id="7577395040592723978" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="源码解析：RustFS如何用“零拷贝”技术碾压传统文件系统？"/> <!----> <meta itemprop="datePublished" content="2025-11-28T06:56:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="对象存储与RustFS"/> <meta itemprop="url" content="https://juejin.cn/user/652466093570057"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            源码解析：RustFS如何用“零拷贝”技术碾压传统文件系统？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/652466093570057/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    对象存储与RustFS
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T06:56:40.000Z" title="Fri Nov 28 2025 06:56:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">源码解析：RustFS如何用“零拷贝”技术碾压传统文件系统？</h2>
<blockquote>
<p>2025年，当RustFS在GitHub上斩获​<strong>10k+ Star</strong>​，其<strong>4K随机读1,580K IOPS</strong>的性能表现比MinIO快​<strong>42%</strong> ​，这一切的奥秘都源于其革命性的​<strong>零拷贝技术</strong>。本文将深入源码层面，揭秘RustFS如何重构存储性能边界。</p>
</blockquote>
<h3 data-id="heading-1">一、零拷贝技术：存储性能的革命性突破</h3>
<p>在传统文件系统中，数据从存储设备到应用程序需要经历多次拷贝：​<strong>硬盘→内核缓冲区→用户空间缓冲区→网络堆栈</strong>​。这个过程中，每次拷贝都意味着CPU周期和内存带宽的消耗。实测表明，在10G网络环境下，传统文件系统有多达<strong>70%</strong> 的CPU时间消耗在数据拷贝上。</p>
<p>RustFS通过​<strong>io_uring异步I/O</strong>​、<strong>内存映射</strong>和<strong>RDMA直接数据放置</strong>三项核心技术，实现了真正的零拷贝架构。在NVMe SSD测试中，RustFS的零拷贝设计将IOPS从传统的<strong>300K</strong>提升至​<strong>1,580K</strong>​，性能提升达​<strong>426%</strong> 。</p>
<h4 data-id="heading-2">1.1 传统文件系统的拷贝开销</h4>
<p>传统Linux文件系统使用read/write系统调用时，数据流向如下：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 传统读写的数据流向（4次拷贝）</span>
磁盘 → 内核缓冲区 → 用户空间缓冲区 → 网络堆栈 → 网卡
   ↓         ↓           ↓           ↓
 DMA拷贝    CPU拷贝      CPU拷贝     DMA拷贝
</code></pre>
<p>这个过程涉及<strong>2次CPU拷贝</strong>和​<strong>2次DMA拷贝</strong>​，在处理小文件时尤其低效。每次拷贝都增加<strong>1-3μs</strong>的延迟，在高速存储设备上，这种开销尤为明显。</p>
<h3 data-id="heading-3">二、RustFS的零拷贝架构设计</h3>
<h4 data-id="heading-4">2.1 io_uring的异步I/O革命</h4>
<p>RustFS使用Linux内核的<strong>io_uring</strong>接口替代传统同步I/O，实现了真正的异步零拷贝。其核心创新在于<strong>提交队列(SQ)</strong> 和<strong>完成队列(CQ)</strong> 的双环缓冲区设计。</p>
<pre><code class="hljs language-Rust" lang="Rust"><span class="hljs-comment">// RustFS中io_uring初始化的核心源码</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">IoUringRuntime</span> {
    submit_queue: Arc&lt;Mutex&lt;SubmissionQueue&gt;&gt;,
    complete_queue: Arc&lt;Mutex&lt;CompletionQueue&gt;&gt;,
    ring_fd: RawFd,  <span class="hljs-comment">// 指向内核的io_uring实例</span>
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">IoUringRuntime</span> {
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(entries: <span class="hljs-type">u32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-keyword">Self</span>&gt; {
        <span class="hljs-comment">// 创建io_uring实例</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">params</span> = io_uring_params::<span class="hljs-title function_ invoke__">default</span>();
        params.flags |= IORING_SETUP_SQPOLL;  <span class="hljs-comment">// 启用内核轮询模式</span>
        
        <span class="hljs-keyword">unsafe</span> {
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">ring_fd</span> = <span class="hljs-title function_ invoke__">io_uring_setup</span>(entries, &amp;<span class="hljs-keyword">mut</span> params);
            <span class="hljs-keyword">if</span> ring_fd &lt; <span class="hljs-number">0</span> { <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Err</span>(Error::<span class="hljs-title function_ invoke__">last_os_error</span>()); }
            
            <span class="hljs-comment">// 内存映射队列区域</span>
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">sq_ptr</span> = <span class="hljs-title function_ invoke__">mmap</span>(
                ptr::<span class="hljs-title function_ invoke__">null_mut</span>(),
                params.sq_off <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span> + params.sq_entries <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span> * size_of::&lt;io_uring_sqe&gt;(),
                PROT_READ | PROT_WRITE,
                MAP_SHARED | MAP_POPULATE,
                ring_fd,
                IORING_OFF_SQ_RING.<span class="hljs-title function_ invoke__">into</span>(),
            );
            
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">cq_ptr</span> = <span class="hljs-title function_ invoke__">mmap</span>(<span class="hljs-comment">/* 完成队列类似映射 */</span>);
            
            <span class="hljs-title function_ invoke__">Ok</span>(IoUringRuntime {
                submit_queue: Arc::<span class="hljs-title function_ invoke__">new</span>(Mutex::<span class="hljs-title function_ invoke__">new</span>(SubmissionQueue::<span class="hljs-title function_ invoke__">new</span>(sq_ptr))),
                complete_queue: Arc::<span class="hljs-title function_ invoke__">new</span>(Mutex::<span class="hljs-title function_ invoke__">new</span>(CompletionQueue::<span class="hljs-title function_ invoke__">new</span>(cq_ptr))),
                ring_fd,
            })
        }
    }
}
</code></pre>
<p>这种设计使得I/O请求的提交和完成完全在用户空间进行，​<strong>系统调用次数减少85%</strong> ，特别适合高并发场景。</p>
<h4 data-id="heading-5">2.2 内存映射与零拷贝文件访问</h4>
<p>RustFS使用内存映射技术将文件直接映射到进程地址空间，避免了用户空间与内核空间的数据拷贝：</p>
<pre><code class="hljs language-Rust" lang="Rust"><span class="hljs-comment">// 内存映射实现零拷贝文件访问</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">MappedFile</span> {
    mapping: *<span class="hljs-keyword">mut</span> libc::c_void,
    len: <span class="hljs-type">usize</span>,
    file: File,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">MappedFile</span> {
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">open</span>(path: &amp;Path) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-keyword">Self</span>&gt; {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">file</span> = OpenOptions::<span class="hljs-title function_ invoke__">new</span>().<span class="hljs-title function_ invoke__">read</span>(<span class="hljs-literal">true</span>).<span class="hljs-title function_ invoke__">open</span>(path)?;
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">metadata</span> = file.<span class="hljs-title function_ invoke__">metadata</span>()?;
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">len</span> = metadata.<span class="hljs-title function_ invoke__">len</span>() <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>;
        
        <span class="hljs-keyword">unsafe</span> {
            <span class="hljs-comment">// 创建内存映射</span>
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">mapping</span> = libc::<span class="hljs-title function_ invoke__">mmap</span>(
                ptr::<span class="hljs-title function_ invoke__">null_mut</span>(),
                len,
                PROT_READ,
                MAP_PRIVATE,
                file.<span class="hljs-title function_ invoke__">as_raw_fd</span>(),
                <span class="hljs-number">0</span>,
            );
            
            <span class="hljs-keyword">if</span> mapping == MAP_FAILED {
                <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Err</span>(Error::<span class="hljs-title function_ invoke__">last_os_error</span>());
            }
            
            <span class="hljs-comment">// 建议内核预读优化</span>
            libc::<span class="hljs-title function_ invoke__">madvise</span>(mapping, len, libc::MADV_SEQUENTIAL);
            
            <span class="hljs-title function_ invoke__">Ok</span>(MappedFile { mapping, len, file })
        }
    }
    
    <span class="hljs-comment">// 零拷贝数据访问</span>
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">as_slice</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> &amp;[<span class="hljs-type">u8</span>] {
        <span class="hljs-keyword">unsafe</span> { std::slice::<span class="hljs-title function_ invoke__">from_raw_parts</span>(<span class="hljs-keyword">self</span>.mapping <span class="hljs-keyword">as</span> *<span class="hljs-keyword">const</span> <span class="hljs-type">u8</span>, <span class="hljs-keyword">self</span>.len) }
    }
}
</code></pre>
<p>内存映射将文件I/O转化为内存访问，在大文件读取场景下，性能提升可达​<strong>300%</strong> 。</p>
<h3 data-id="heading-6">三、核心源码解析：零拷贝的实现机理</h3>
<h4 data-id="heading-7">3.1 零拷贝发送流程</h4>
<p>RustFS通过网络发送文件时，使用<strong>sendfile</strong>系统调用实现零拷贝传输：</p>
<pre><code class="hljs language-Rust" lang="Rust"><span class="hljs-comment">// 零拷贝文件发送实现</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">send_file_zero_copy</span>(
    source_fd: RawFd, 
    target_fd: RawFd,
    offset: <span class="hljs-type">i64</span>,
    <span class="hljs-keyword">mut</span> count: <span class="hljs-type">usize</span>
) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;<span class="hljs-type">usize</span>&gt; {
    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">total_sent</span> = <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">while</span> count &gt; <span class="hljs-number">0</span> {
        <span class="hljs-comment">// 使用sendfile系统调用，在内核层面直接传输</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">sent</span> = <span class="hljs-keyword">unsafe</span> {
            libc::<span class="hljs-title function_ invoke__">sendfile</span>(
                target_fd,    <span class="hljs-comment">// 目标socket文件描述符</span>
                source_fd,    <span class="hljs-comment">// 源文件描述符</span>
                &amp;<span class="hljs-keyword">mut</span> offset <span class="hljs-keyword">as</span> *<span class="hljs-keyword">const</span> <span class="hljs-type">i64</span> <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> <span class="hljs-type">i64</span>,
                count.<span class="hljs-title function_ invoke__">min</span>(libc::MAX_TRANSFER_UNIT) <span class="hljs-keyword">as</span> libc::size_t,
            )
        };
        
        <span class="hljs-keyword">if</span> sent &lt;= <span class="hljs-number">0</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> total_sent &gt; <span class="hljs-number">0</span> { <span class="hljs-title function_ invoke__">Ok</span>(total_sent) } 
                   <span class="hljs-keyword">else</span> { <span class="hljs-title function_ invoke__">Err</span>(Error::<span class="hljs-title function_ invoke__">last_os_error</span>()) };
        }
        
        total_sent += sent <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>;
        count -= sent <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>;
    }
    
    <span class="hljs-title function_ invoke__">Ok</span>(total_sent)
}
</code></pre>
<p><strong>sendfile</strong>系统调用允许数据直接从文件描述符传输到socket描述符，完全绕过用户空间，减少​<strong>2次数据拷贝</strong>。</p>
<h4 data-id="heading-8">3.2 智能缓冲区管理</h4>
<p>RustFS通过智能缓冲区复用机制，进一步减少内存分配开销：</p>
<pre><code class="hljs language-Rust" lang="Rust"><span class="hljs-comment">// 零拷贝缓冲区池</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ZeroCopyBufferPool</span> {
    buffers: <span class="hljs-type">Vec</span>&lt;Arc&lt;Buffer&gt;&gt;,
    buffer_size: <span class="hljs-type">usize</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">ZeroCopyBufferPool</span> {
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(buffer_size: <span class="hljs-type">usize</span>, initial_count: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">buffers</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">with_capacity</span>(initial_count);
        <span class="hljs-keyword">for</span> <span class="hljs-variable">_</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..initial_count {
            buffers.<span class="hljs-title function_ invoke__">push</span>(Arc::<span class="hljs-title function_ invoke__">new</span>(Buffer::<span class="hljs-title function_ invoke__">new</span>(buffer_size)));
        }
        
        ZeroCopyBufferPool { buffers, buffer_size }
    }
    
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">get_buffer</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> Arc&lt;Buffer&gt; {
        <span class="hljs-keyword">self</span>.buffers.<span class="hljs-title function_ invoke__">pop</span>()
            .<span class="hljs-title function_ invoke__">unwrap_or_else</span>(|| Arc::<span class="hljs-title function_ invoke__">new</span>(Buffer::<span class="hljs-title function_ invoke__">new</span>(<span class="hljs-keyword">self</span>.buffer_size)))
    }
    
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">return_buffer</span>(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, buffer: Arc&lt;Buffer&gt;) {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.buffers.<span class="hljs-title function_ invoke__">len</span>() &lt; MAX_POOL_SIZE {
            <span class="hljs-keyword">self</span>.buffers.<span class="hljs-title function_ invoke__">push</span>(buffer);
        }
        <span class="hljs-comment">// 超过大小时自动丢弃，由Arc自动回收</span>
    }
}

<span class="hljs-comment">// 使用DMA友好的内存对齐缓冲区</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Buffer</span> {
    data: *<span class="hljs-keyword">mut</span> <span class="hljs-type">u8</span>,
    size: <span class="hljs-type">usize</span>,
    dma_ready: <span class="hljs-type">bool</span>,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Buffer</span> {
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>(size: <span class="hljs-type">usize</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">unsafe</span> {
            <span class="hljs-comment">// 分配页对齐内存，便于DMA操作</span>
            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">data</span> = ptr::<span class="hljs-title function_ invoke__">null_mut</span>();
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">page_size</span> = libc::<span class="hljs-title function_ invoke__">sysconf</span>(libc::_SC_PAGESIZE) <span class="hljs-keyword">as</span> <span class="hljs-type">usize</span>;
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">aligned_size</span> = (size + page_size - <span class="hljs-number">1</span>) &amp; !(page_size - <span class="hljs-number">1</span>);
            
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">result</span> = libc::<span class="hljs-title function_ invoke__">posix_memalign</span>(
                &amp;<span class="hljs-keyword">mut</span> data, 
                page_size, 
                aligned_size
            );
            
            <span class="hljs-keyword">if</span> result != <span class="hljs-number">0</span> {
                <span class="hljs-built_in">panic!</span>(<span class="hljs-string">"Failed to allocate aligned memory"</span>);
            }
            
            <span class="hljs-comment">// 建议内核此内存将用于DMA</span>
            libc::<span class="hljs-title function_ invoke__">madvise</span>(data, aligned_size, libc::MADV_SEQUENTIAL);
            
            Buffer { data, size: aligned_size, dma_ready: <span class="hljs-literal">true</span> }
        }
    }
}
</code></pre>
<p>缓冲区池技术减少<strong>60%</strong> 的内存分配开销，页对齐内存使DMA效率提升​<strong>25%</strong> 。</p>
<h3 data-id="heading-9">四、RDMA与零拷贝的完美结合</h3>
<h4 data-id="heading-10">4.1 远程直接内存访问</h4>
<p>在分布式环境中，RustFS利用RDMA技术实现网络零拷贝：</p>
<pre><code class="hljs language-Rust" lang="Rust"><span class="hljs-comment">// RDMA零拷贝传输实现</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">RDMATransport</span> {
    queue_pair: QueuePair,
    memory_region: MemoryRegion,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">RDMATransport</span> {
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">post_rdma_write</span>(
        &amp;<span class="hljs-keyword">self</span>,
        remote_addr: <span class="hljs-type">u64</span>,
        local_buffer: &amp;Buffer,
        length: <span class="hljs-type">usize</span>
    ) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;()&gt; {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">work_request</span> = WorkRequest {
            opcode: Opcode::RdmaWrite,
            send_flags: SendFlags::SIGNALED,
            <span class="hljs-comment">// 源：本地缓冲区（已注册的MR）</span>
            <span class="hljs-comment">// 目标：远程内存地址</span>
            <span class="hljs-comment">// 数据直接从本地内存DMA到远程内存，零拷贝</span>
        };
        
        <span class="hljs-keyword">self</span>.queue_pair.<span class="hljs-title function_ invoke__">post_send</span>(work_request)?;
        <span class="hljs-title function_ invoke__">Ok</span>(())
    }
    
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">register_memory</span>(&amp;<span class="hljs-keyword">self</span>, buffer: &amp;[<span class="hljs-type">u8</span>]) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;MemoryRegion&gt; {
        <span class="hljs-comment">// 注册内存区域，使其可用于RDMA操作</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">mr</span> = <span class="hljs-keyword">self</span>.protection_domain.<span class="hljs-title function_ invoke__">register_memory</span>(
            buffer.<span class="hljs-title function_ invoke__">as_ptr</span>() <span class="hljs-keyword">as</span> *<span class="hljs-keyword">mut</span> _,
            buffer.<span class="hljs-title function_ invoke__">len</span>(),
            AccessFlags::LOCAL_WRITE | AccessFlags::REMOTE_READ,
        )?;
        
        <span class="hljs-title function_ invoke__">Ok</span>(mr)
    }
}
</code></pre>
<p>RDMA允许网卡直接访问应用内存，完全绕过CPU，将网络延迟从<strong>20μs</strong>降至​<strong>1μs</strong>。</p>
<h4 data-id="heading-11">4.2 内核旁路技术</h4>
<p>RustFS通过内核旁路进一步减少上下文切换：</p>
<pre><code class="hljs language-Rust" lang="Rust"><span class="hljs-comment">// 用户态IO调度器</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">UserspaceIOScheduler</span> {
    ring_buffer: *<span class="hljs-keyword">mut</span> io_ring,
    completion_poller: std::thread::JoinHandle&lt;()&gt;,
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">UserspaceIOScheduler</span> {
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">new</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">ring_buffer</span> = <span class="hljs-keyword">unsafe</span> { <span class="hljs-title function_ invoke__">setup_io_ring</span>() };
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">poller</span> = std::thread::<span class="hljs-title function_ invoke__">spawn</span>(<span class="hljs-keyword">move</span> || {
            <span class="hljs-comment">// 专用线程轮询完成队列，完全在内核外</span>
            <span class="hljs-keyword">loop</span> {
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">completed</span> = <span class="hljs-keyword">unsafe</span> { <span class="hljs-title function_ invoke__">check_completions</span>(ring_buffer) };
                <span class="hljs-keyword">if</span> completed &gt; <span class="hljs-number">0</span> {
                    <span class="hljs-title function_ invoke__">wake_waiting_tasks</span>(completed);
                } <span class="hljs-keyword">else</span> {
                    std::thread::<span class="hljs-title function_ invoke__">yield_now</span>();
                }
            }
        });
        
        UserspaceIOScheduler { ring_buffer, completion_poller: poller }
    }
}
</code></pre>
<p>内核旁路技术减少<strong>85%</strong> 的上下文切换，CPU利用率提升​<strong>40%</strong> 。</p>
<h3 data-id="heading-12">五、性能对比实测</h3>
<h4 data-id="heading-13">5.1 零拷贝与传统方式性能对比</h4>
<p>在不同工作负载下，RustFS的零拷贝技术展现出显著优势：</p>



































<table><thead><tr><th><strong>测试场景</strong></th><th><strong>传统文件系统</strong></th><th><strong>RustFS零拷贝</strong></th><th><strong>性能提升</strong></th></tr></thead><tbody><tr><td><strong>1GB顺序读</strong></td><td>320ms</td><td>80ms</td><td><strong>300%</strong></td></tr><tr><td><strong>4K随机读</strong></td><td>280K IOPS</td><td>1,580K IOPS</td><td><strong>464%</strong></td></tr><tr><td><strong>网络传输</strong></td><td>3.2Gbps</td><td>9.8Gbps</td><td><strong>206%</strong></td></tr><tr><td><strong>CPU占用</strong></td><td>70%</td><td>15%</td><td><strong>降低78%</strong></td></tr></tbody></table>
<p>数据来源：2025年存储性能基准测试</p>
<h4 data-id="heading-14">5.2 内存效率提升</h4>
<p>零拷贝技术大幅降低了内存带宽需求：</p>





























<table><thead><tr><th><strong>操作类型</strong></th><th><strong>传统方式内存带宽</strong></th><th><strong>零拷贝内存带宽</strong></th><th><strong>节省幅度</strong></th></tr></thead><tbody><tr><td><strong>文件读取</strong></td><td>2.1GB/s</td><td>0.7GB/s</td><td><strong>67%</strong></td></tr><tr><td><strong>网络发送</strong></td><td>1.8GB/s</td><td>0.3GB/s</td><td><strong>83%</strong></td></tr><tr><td><strong>数据处理</strong></td><td>3.2GB/s</td><td>1.1GB/s</td><td><strong>66%</strong></td></tr></tbody></table>
<p>更低的内存带宽消耗意味着更低的功耗和更高的系统整体效率。</p>
<h3 data-id="heading-15">六、实际应用场景与优化建议</h3>
<h4 data-id="heading-16">6.1 适合零拷贝的场景</h4>
<p>​<strong>大数据传输</strong>：处理大型媒体文件、科学数据集时，零拷贝优势明显</p>
<p>​<strong>高并发服务</strong>：Web服务器、文件服务器需要同时处理大量客户端请求</p>
<p>​<strong>低延迟应用</strong>：实时数据处理、金融交易系统对延迟敏感的场景</p>
<h4 data-id="heading-17">6.2 优化配置建议</h4>
<pre><code class="hljs language-Rust" lang="Rust"><span class="hljs-comment">// RustFS性能调优参数示例</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">PerformanceTuning</span> {
    <span class="hljs-keyword">pub</span> io_uring_entries: <span class="hljs-type">u32</span>,      <span class="hljs-comment">// 推荐：4096，提高并发能力</span>
    <span class="hljs-keyword">pub</span> buffer_pool_size: <span class="hljs-type">usize</span>,    <span class="hljs-comment">// 推荐：1024，减少分配开销</span>
    <span class="hljs-keyword">pub</span> rdma_queue_depth: <span class="hljs-type">u32</span>,      <span class="hljs-comment">// 推荐：256，优化网络传输</span>
    <span class="hljs-keyword">pub</span> enable_huge_pages: <span class="hljs-type">bool</span>,    <span class="hljs-comment">// 推荐：true，减少TLB缺失</span>
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Default</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">PerformanceTuning</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">default</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-keyword">Self</span> {
        PerformanceTuning {
            io_uring_entries: <span class="hljs-number">4096</span>,
            buffer_pool_size: <span class="hljs-number">1024</span>,
            rdma_queue_depth: <span class="hljs-number">256</span>,
            enable_huge_pages: <span class="hljs-literal">true</span>,
        }
    }
}
</code></pre>
<p>正确配置后，RustFS在NVMe存储上可达到​<strong>1.58M IOPS</strong>​，延迟低于​<strong>1ms</strong>。</p>
<h3 data-id="heading-18">七、未来展望</h3>
<p>零拷贝技术正在成为高性能存储系统的标配。随着硬件发展，我们预见以下趋势：</p>
<p>​<strong>computational storage</strong>：计算存储设备直接在存储层处理数据，进一步减少数据移动</p>
<p>​<strong>智能网卡</strong>：更强大的智能网卡可处理更复杂的网络协议，减轻CPU负担</p>
<p>​<strong>持久内存</strong>：持久内存与零拷贝结合，将重新定义存储层次结构</p>
<p>RustFS团队正在探索这些新技术，计划在下一版本中实现更深度的零拷贝优化。</p>
<h3 data-id="heading-19">结语</h3>
<p>通过深入分析RustFS的源码，我们看到零拷贝技术如何从根本上重构存储性能边界。从<strong>io_uring异步I/O</strong>到​<strong>RDMA网络传输</strong>，RustFS在各个环节消除不必要的数据拷贝，实现了近乎极致的性能表现。</p>
<p>对于开发者而言，理解这些底层技术原理至关重要。虽然日常开发中可能不会直接操作这些底层API，但理解其工作原理有助于设计出更高效的系统架构。</p>
<hr/>
<p>以下是深入学习 RustFS 的推荐资源：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frustfs%2Frustfs" target="_blank" title="https://github.com/rustfs/rustfs" ref="nofollow noopener noreferrer">RustFS</a></p>
<p>官方文档： <a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fdocs.rustfs.com%2F" target="_blank" title="https://link.zhihu.com/?target=https%3A//docs.rustfs.com/" ref="nofollow noopener noreferrer">RustFS 官方文档</a>- 提供架构、安装指南和 API 参考。</p>
<p>GitHub 仓库： <a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fdocs.rustfs.com%2F" target="_blank" title="https://link.zhihu.com/?target=https%3A//docs.rustfs.com/" ref="nofollow noopener noreferrer">GitHub 仓库</a> - 获取源代码、提交问题或贡献代码。</p>
<p>社区支持： <a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fgithub.com%2Forgs%2Frustfs%2Fdiscussions" target="_blank" title="https://link.zhihu.com/?target=https%3A//github.com/orgs/rustfs/discussions" ref="nofollow noopener noreferrer">GitHub Discussions</a>- 与开发者交流经验和解决方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <!----></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[探秘新一代向量存储格式Lance-format (二十二) 表达式与投影]]></title>    <link>https://juejin.cn/post/7577439614953422900</link>    <guid>https://juejin.cn/post/7577439614953422900</guid>    <pubDate>2025-11-28T07:27:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577439614953422900" data-draft-id="7577378514401755171" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="探秘新一代向量存储格式Lance-format (二十二) 表达式与投影"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-28T07:27:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="语落心生"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147955741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            探秘新一代向量存储格式Lance-format (二十二) 表达式与投影
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147955741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    语落心生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T07:27:41.000Z" title="Fri Nov 28 2025 07:27:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第22章：表达式与投影</h2>
<h3 data-id="heading-1">🎯 核心概览</h3>
<p>表达式和投影是查询执行的基础。表达式用于计算结果列的值（如函数调用、算术运算、条件判断），投影用于选择和转换输出的列。Lance 实现了一套高效的表达式求值和投影下推机制，使查询性能获得数倍提升。</p>
<p><strong>能力</strong>：从任意表达式高效计算结果，支持<strong>投影下推</strong>减少 IO。</p>
<hr/>
<h3 data-id="heading-2">📐 表达式类型与求值</h3>
<h4 data-id="heading-3">表达式体系</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Expr</span> {
    <span class="hljs-comment">// 字面值</span>
    <span class="hljs-title function_ invoke__">Literal</span>(ScalarValue),
    
    <span class="hljs-comment">// 列引用</span>
    Column {
        name: <span class="hljs-type">String</span>,
        index: <span class="hljs-type">usize</span>,  <span class="hljs-comment">// 在 RecordBatch 中的列索引</span>
    },
    
    <span class="hljs-comment">// 一元操作</span>
    UnaryOp {
        op: UnaryOperator,    <span class="hljs-comment">// NOT, -, 等</span>
        operand: <span class="hljs-type">Box</span>&lt;Expr&gt;,
    },
    
    <span class="hljs-comment">// 二元操作</span>
    BinaryOp {
        left: <span class="hljs-type">Box</span>&lt;Expr&gt;,
        op: BinaryOperator,   <span class="hljs-comment">// +, -, *, /, &lt;, &gt;, ==, AND, OR 等</span>
        right: <span class="hljs-type">Box</span>&lt;Expr&gt;,
    },
    
    <span class="hljs-comment">// 函数调用</span>
    Function {
        name: <span class="hljs-type">String</span>,
        args: <span class="hljs-type">Vec</span>&lt;Expr&gt;,
        return_type: DataType,
    },
    
    <span class="hljs-comment">// 条件表达式（CASE WHEN）</span>
    Case {
        operand: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">Box</span>&lt;Expr&gt;&gt;,
        when_then_expr: <span class="hljs-type">Vec</span>&lt;(<span class="hljs-type">Box</span>&lt;Expr&gt;, <span class="hljs-type">Box</span>&lt;Expr&gt;)&gt;,
        else_expr: <span class="hljs-type">Option</span>&lt;<span class="hljs-type">Box</span>&lt;Expr&gt;&gt;,
    },
    
    <span class="hljs-comment">// 投影（选择列）</span>
    <span class="hljs-title function_ invoke__">Project</span>(<span class="hljs-type">Vec</span>&lt;<span class="hljs-type">usize</span>&gt;),
    
    <span class="hljs-comment">// 向量搜索</span>
    VectorSearch {
        column: <span class="hljs-type">String</span>,
        query: <span class="hljs-type">Box</span>&lt;Expr&gt;,
        k: <span class="hljs-type">usize</span>,
    },
    
    <span class="hljs-comment">// 向量距离</span>
    VectorDistance {
        left: <span class="hljs-type">Box</span>&lt;Expr&gt;,
        right: <span class="hljs-type">Box</span>&lt;Expr&gt;,
        metric: <span class="hljs-type">String</span>,  <span class="hljs-comment">// "l2", "cosine", "dot"</span>
    },
}

<span class="hljs-keyword">pub</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">UnaryOperator</span> {
    Not,           <span class="hljs-comment">// !</span>
    Neg,           <span class="hljs-comment">// -</span>
    IsNull,        <span class="hljs-comment">// IS NULL</span>
    IsNotNull,     <span class="hljs-comment">// IS NOT NULL</span>
}

<span class="hljs-keyword">pub</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">BinaryOperator</span> {
    <span class="hljs-comment">// 算术</span>
    Add, Sub, Mul, Div, Rem,
    <span class="hljs-comment">// 比较</span>
    <span class="hljs-built_in">Eq</span>, Lt, Gt, LtEq, GtEq, NotEq,
    <span class="hljs-comment">// 逻辑</span>
    And, Or,
    <span class="hljs-comment">// 字符串</span>
    Concat,
}
</code></pre>
<h4 data-id="heading-4">表达式求值</h4>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">trait</span> <span class="hljs-title class_">Evaluator</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">evaluate</span>(&amp;<span class="hljs-keyword">self</span>, batch: &amp;RecordBatch) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;ArrayRef&gt;;
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Evaluator</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">Expr</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">evaluate</span>(&amp;<span class="hljs-keyword">self</span>, batch: &amp;RecordBatch) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;ArrayRef&gt; {
        <span class="hljs-keyword">match</span> <span class="hljs-keyword">self</span> {
            <span class="hljs-comment">// 字面值：广播到数组</span>
            Expr::<span class="hljs-title function_ invoke__">Literal</span>(val) =&gt; {
                <span class="hljs-title function_ invoke__">Ok</span>(Arc::<span class="hljs-title function_ invoke__">new</span>(val.<span class="hljs-title function_ invoke__">to_array</span>(batch.<span class="hljs-title function_ invoke__">num_rows</span>())))
            }
            
            <span class="hljs-comment">// 列引用：直接返回列</span>
            Expr::Column { name, index } =&gt; {
                <span class="hljs-title function_ invoke__">Ok</span>(batch.<span class="hljs-title function_ invoke__">column</span>(*index).<span class="hljs-title function_ invoke__">clone</span>())
            }
            
            <span class="hljs-comment">// 一元操作</span>
            Expr::UnaryOp { op, operand } =&gt; {
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">operand_val</span> = operand.<span class="hljs-title function_ invoke__">evaluate</span>(batch)?;
                <span class="hljs-keyword">match</span> op {
                    UnaryOperator::Not =&gt; {
                        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">bool_array</span> = operand_val.<span class="hljs-title function_ invoke__">as_boolean</span>();
                        <span class="hljs-title function_ invoke__">Ok</span>(Arc::<span class="hljs-title function_ invoke__">new</span>(compute::<span class="hljs-title function_ invoke__">not</span>(bool_array)?))
                    }
                    UnaryOperator::Neg =&gt; {
                        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">num_array</span> = operand_val.as_primitive::&lt;Float32Type&gt;();
                        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">neg</span> = num_array.<span class="hljs-title function_ invoke__">iter</span>()
                            .<span class="hljs-title function_ invoke__">map</span>(|v| <span class="hljs-title function_ invoke__">Some</span>(-v))
                            .collect::&lt;<span class="hljs-type">Vec</span>&lt;_&gt;&gt;();
                        <span class="hljs-title function_ invoke__">Ok</span>(Arc::<span class="hljs-title function_ invoke__">new</span>(Float32Array::<span class="hljs-title function_ invoke__">from</span>(neg)))
                    }
                    UnaryOperator::IsNull =&gt; {
                        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">is_null</span> = operand_val.<span class="hljs-title function_ invoke__">iter</span>()
                            .<span class="hljs-title function_ invoke__">map</span>(|v| <span class="hljs-title function_ invoke__">Some</span>(v.<span class="hljs-title function_ invoke__">is_none</span>()))
                            .collect::&lt;<span class="hljs-type">Vec</span>&lt;_&gt;&gt;();
                        <span class="hljs-title function_ invoke__">Ok</span>(Arc::<span class="hljs-title function_ invoke__">new</span>(BooleanArray::<span class="hljs-title function_ invoke__">from</span>(is_null)))
                    }
                    _ =&gt; <span class="hljs-title function_ invoke__">Err</span>(<span class="hljs-string">"Unsupported unary op"</span>.<span class="hljs-title function_ invoke__">into</span>()),
                }
            }
            
            <span class="hljs-comment">// 二元操作</span>
            Expr::BinaryOp { left, op, right } =&gt; {
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">left_val</span> = left.<span class="hljs-title function_ invoke__">evaluate</span>(batch)?;
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">right_val</span> = right.<span class="hljs-title function_ invoke__">evaluate</span>(batch)?;
                
                <span class="hljs-keyword">match</span> op {
                    <span class="hljs-comment">// 算术操作</span>
                    BinaryOperator::Add =&gt; {
                        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">binary_arithmetic</span>(&amp;left_val, &amp;right_val, |a, b| a + b)
                    }
                    BinaryOperator::Sub =&gt; {
                        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">binary_arithmetic</span>(&amp;left_val, &amp;right_val, |a, b| a - b)
                    }
                    BinaryOperator::Mul =&gt; {
                        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">binary_arithmetic</span>(&amp;left_val, &amp;right_val, |a, b| a * b)
                    }
                    
                    <span class="hljs-comment">// 比较操作</span>
                    BinaryOperator::Lt =&gt; {
                        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">binary_comparison</span>(&amp;left_val, &amp;right_val, |a, b| a &lt; b)
                    }
                    BinaryOperator::<span class="hljs-built_in">Eq</span> =&gt; {
                        <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">binary_comparison</span>(&amp;left_val, &amp;right_val, |a, b| a == b)
                    }
                    
                    <span class="hljs-comment">// 逻辑操作</span>
                    BinaryOperator::And =&gt; {
                        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">left_bool</span> = left_val.<span class="hljs-title function_ invoke__">as_boolean</span>();
                        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">right_bool</span> = right_val.<span class="hljs-title function_ invoke__">as_boolean</span>();
                        <span class="hljs-title function_ invoke__">Ok</span>(Arc::<span class="hljs-title function_ invoke__">new</span>(compute::<span class="hljs-title function_ invoke__">and</span>(left_bool, right_bool)?))
                    }
                    BinaryOperator::Or =&gt; {
                        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">left_bool</span> = left_val.<span class="hljs-title function_ invoke__">as_boolean</span>();
                        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">right_bool</span> = right_val.<span class="hljs-title function_ invoke__">as_boolean</span>();
                        <span class="hljs-title function_ invoke__">Ok</span>(Arc::<span class="hljs-title function_ invoke__">new</span>(compute::<span class="hljs-title function_ invoke__">or</span>(left_bool, right_bool)?))
                    }
                    
                    _ =&gt; <span class="hljs-title function_ invoke__">Err</span>(<span class="hljs-string">"Unsupported binary op"</span>.<span class="hljs-title function_ invoke__">into</span>()),
                }
            }
            
            <span class="hljs-comment">// 函数调用</span>
            Expr::Function { name, args, .. } =&gt; {
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">arg_values</span>: <span class="hljs-type">Result</span>&lt;<span class="hljs-type">Vec</span>&lt;_&gt;&gt; = args.<span class="hljs-title function_ invoke__">iter</span>()
                    .<span class="hljs-title function_ invoke__">map</span>(|arg| arg.<span class="hljs-title function_ invoke__">evaluate</span>(batch))
                    .<span class="hljs-title function_ invoke__">collect</span>();
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">arg_values</span> = arg_values?;
                
                <span class="hljs-comment">// 调用对应的函数</span>
                <span class="hljs-keyword">match</span> name.<span class="hljs-title function_ invoke__">as_str</span>() {
                    <span class="hljs-string">"LENGTH"</span> =&gt; <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">function_length</span>(&amp;arg_values[<span class="hljs-number">0</span>]),
                    <span class="hljs-string">"UPPER"</span> =&gt; <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">function_upper</span>(&amp;arg_values[<span class="hljs-number">0</span>]),
                    <span class="hljs-string">"LOWER"</span> =&gt; <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">function_lower</span>(&amp;arg_values[<span class="hljs-number">0</span>]),
                    <span class="hljs-string">"ROUND"</span> =&gt; <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">function_round</span>(&amp;arg_values[<span class="hljs-number">0</span>], &amp;arg_values[<span class="hljs-number">1</span>]),
                    <span class="hljs-string">"ABS"</span> =&gt; <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">function_abs</span>(&amp;arg_values[<span class="hljs-number">0</span>]),
                    _ =&gt; <span class="hljs-title function_ invoke__">Err</span>(<span class="hljs-built_in">format!</span>(<span class="hljs-string">"Unknown function: {}"</span>, name).<span class="hljs-title function_ invoke__">into</span>()),
                }
            }
            
            <span class="hljs-comment">// CASE WHEN 表达式</span>
            Expr::Case { operand, when_then_expr, else_expr } =&gt; {
                <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">evaluate_case</span>(batch, operand, when_then_expr, else_expr)
            }
            
            <span class="hljs-comment">// 向量搜索</span>
            Expr::VectorSearch { column, query, k } =&gt; {
                <span class="hljs-comment">// 特殊处理：返回搜索结果的行号</span>
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">query_vec</span> = query.<span class="hljs-title function_ invoke__">evaluate</span>(batch)?;
                <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">vector_search</span>(batch, column, &amp;query_vec, *k)
            }
            
            <span class="hljs-comment">// 向量距离</span>
            Expr::VectorDistance { left, right, metric } =&gt; {
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">left_vec</span> = left.<span class="hljs-title function_ invoke__">evaluate</span>(batch)?;
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">right_vec</span> = right.<span class="hljs-title function_ invoke__">evaluate</span>(batch)?;
                <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">vector_distance</span>(&amp;left_vec, &amp;right_vec, metric)
            }
            
            _ =&gt; <span class="hljs-title function_ invoke__">Err</span>(<span class="hljs-string">"Unknown expression type"</span>.<span class="hljs-title function_ invoke__">into</span>()),
        }
    }
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">Expr</span> {
    <span class="hljs-comment">// 二元算术操作的通用实现</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">binary_arithmetic</span>&lt;F&gt;(
        &amp;<span class="hljs-keyword">self</span>,
        left: &amp;ArrayRef,
        right: &amp;ArrayRef,
        op: F,
    ) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;ArrayRef&gt;
    <span class="hljs-keyword">where</span>
        F: <span class="hljs-title function_ invoke__">Fn</span>(<span class="hljs-type">f32</span>, <span class="hljs-type">f32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">f32</span>,
    {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">left_arr</span> = left.as_primitive::&lt;Float32Type&gt;();
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">right_arr</span> = right.as_primitive::&lt;Float32Type&gt;();
        
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">result</span>: <span class="hljs-type">Vec</span>&lt;_&gt; = left_arr.<span class="hljs-title function_ invoke__">iter</span>()
            .<span class="hljs-title function_ invoke__">zip</span>(right_arr.<span class="hljs-title function_ invoke__">iter</span>())
            .<span class="hljs-title function_ invoke__">map</span>(|(a, b)| {
                <span class="hljs-title function_ invoke__">match</span> (a, b) {
                    (<span class="hljs-title function_ invoke__">Some</span>(&amp;av), <span class="hljs-title function_ invoke__">Some</span>(&amp;bv)) =&gt; <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-title function_ invoke__">op</span>(av, bv)),
                    _ =&gt; <span class="hljs-literal">None</span>,
                }
            })
            .<span class="hljs-title function_ invoke__">collect</span>();
        
        <span class="hljs-title function_ invoke__">Ok</span>(Arc::<span class="hljs-title function_ invoke__">new</span>(Float32Array::<span class="hljs-title function_ invoke__">from</span>(result)))
    }
    
    <span class="hljs-comment">// 向量距离计算</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">vector_distance</span>(
        &amp;<span class="hljs-keyword">self</span>,
        left: &amp;ArrayRef,
        right: &amp;ArrayRef,
        metric: &amp;<span class="hljs-type">str</span>,
    ) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;ArrayRef&gt; {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">left_fsl</span> = left.<span class="hljs-title function_ invoke__">as_fixed_size_list</span>();
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">right_fsl</span> = right.<span class="hljs-title function_ invoke__">as_fixed_size_list</span>();
        
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">distances</span>: <span class="hljs-type">Vec</span>&lt;_&gt; = (<span class="hljs-number">0</span>..left_fsl.<span class="hljs-title function_ invoke__">len</span>())
            .<span class="hljs-title function_ invoke__">map</span>(|i| {
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">left_vec</span> = left_fsl.<span class="hljs-title function_ invoke__">value</span>(i);
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">right_vec</span> = right_fsl.<span class="hljs-title function_ invoke__">value</span>(i);
                
                <span class="hljs-keyword">match</span> metric {
                    <span class="hljs-string">"l2"</span> =&gt; {
                        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">left_arr</span> = left_vec.as_primitive::&lt;Float32Type&gt;();
                        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">right_arr</span> = right_vec.as_primitive::&lt;Float32Type&gt;();
                        
                        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">dist</span>: <span class="hljs-type">f32</span> = left_arr.<span class="hljs-title function_ invoke__">iter</span>()
                            .<span class="hljs-title function_ invoke__">zip</span>(right_arr.<span class="hljs-title function_ invoke__">iter</span>())
                            .<span class="hljs-title function_ invoke__">map</span>(|(a, b)| <span class="hljs-title function_ invoke__">match</span> (a, b) {
                                (<span class="hljs-title function_ invoke__">Some</span>(&amp;av), <span class="hljs-title function_ invoke__">Some</span>(&amp;bv)) =&gt; (av - bv).<span class="hljs-title function_ invoke__">powi</span>(<span class="hljs-number">2</span>),
                                _ =&gt; <span class="hljs-number">0.0</span>,
                            })
                            .<span class="hljs-title function_ invoke__">sum</span>();
                        
                        <span class="hljs-title function_ invoke__">Some</span>(dist.<span class="hljs-title function_ invoke__">sqrt</span>())
                    }
                    
                    <span class="hljs-string">"cosine"</span> =&gt; {
                        <span class="hljs-comment">// 余弦相似度实现</span>
                        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">left_arr</span> = left_vec.as_primitive::&lt;Float32Type&gt;();
                        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">right_arr</span> = right_vec.as_primitive::&lt;Float32Type&gt;();
                        
                        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">dot</span>: <span class="hljs-type">f32</span> = left_arr.<span class="hljs-title function_ invoke__">iter</span>()
                            .<span class="hljs-title function_ invoke__">zip</span>(right_arr.<span class="hljs-title function_ invoke__">iter</span>())
                            .<span class="hljs-title function_ invoke__">map</span>(|(a, b)| <span class="hljs-title function_ invoke__">match</span> (a, b) {
                                (<span class="hljs-title function_ invoke__">Some</span>(&amp;av), <span class="hljs-title function_ invoke__">Some</span>(&amp;bv)) =&gt; av * bv,
                                _ =&gt; <span class="hljs-number">0.0</span>,
                            })
                            .<span class="hljs-title function_ invoke__">sum</span>();
                        
                        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">left_norm</span>: <span class="hljs-type">f32</span> = left_arr.<span class="hljs-title function_ invoke__">iter</span>()
                            .<span class="hljs-title function_ invoke__">map</span>(|a| <span class="hljs-keyword">match</span> a {
                                <span class="hljs-title function_ invoke__">Some</span>(&amp;v) =&gt; v.<span class="hljs-title function_ invoke__">powi</span>(<span class="hljs-number">2</span>),
                                <span class="hljs-literal">None</span> =&gt; <span class="hljs-number">0.0</span>,
                            })
                            .sum::&lt;<span class="hljs-type">f32</span>&gt;()
                            .<span class="hljs-title function_ invoke__">sqrt</span>();
                        
                        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">right_norm</span>: <span class="hljs-type">f32</span> = right_arr.<span class="hljs-title function_ invoke__">iter</span>()
                            .<span class="hljs-title function_ invoke__">map</span>(|b| <span class="hljs-keyword">match</span> b {
                                <span class="hljs-title function_ invoke__">Some</span>(&amp;v) =&gt; v.<span class="hljs-title function_ invoke__">powi</span>(<span class="hljs-number">2</span>),
                                <span class="hljs-literal">None</span> =&gt; <span class="hljs-number">0.0</span>,
                            })
                            .sum::&lt;<span class="hljs-type">f32</span>&gt;()
                            .<span class="hljs-title function_ invoke__">sqrt</span>();
                        
                        <span class="hljs-keyword">if</span> left_norm &gt; <span class="hljs-number">0.0</span> &amp;&amp; right_norm &gt; <span class="hljs-number">0.0</span> {
                            <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-number">1.0</span> - dot / (left_norm * right_norm))
                        } <span class="hljs-keyword">else</span> {
                            <span class="hljs-title function_ invoke__">Some</span>(<span class="hljs-type">f32</span>::MAX)
                        }
                    }
                    
                    _ =&gt; <span class="hljs-literal">None</span>,
                }
            })
            .<span class="hljs-title function_ invoke__">collect</span>();
        
        <span class="hljs-title function_ invoke__">Ok</span>(Arc::<span class="hljs-title function_ invoke__">new</span>(Float32Array::<span class="hljs-title function_ invoke__">from</span>(distances)))
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-5">🎯 投影与列选择</h3>
<h4 data-id="heading-6">投影的作用</h4>
<p>投影操作用于：</p>
<ol>
<li><strong>选择列</strong>：从多列中选出需要的列</li>
<li><strong>列重排</strong>：改变列的顺序</li>
<li><strong>列转换</strong>：应用表达式转换列值</li>
<li><strong>去重</strong>：<code>SELECT DISTINCT</code></li>
</ol>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ProjectionPlan</span> {
    <span class="hljs-keyword">pub</span> input: Arc&lt;<span class="hljs-keyword">dyn</span> ExecutionPlan&gt;,
    <span class="hljs-keyword">pub</span> expressions: <span class="hljs-type">Vec</span>&lt;Expr&gt;,  <span class="hljs-comment">// 投影表达式</span>
    <span class="hljs-keyword">pub</span> output_names: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">String</span>&gt;,  <span class="hljs-comment">// 输出列名</span>
}

<span class="hljs-meta">#[async_trait]</span>
<span class="hljs-keyword">impl</span> <span class="hljs-title class_">ExecutionPlan</span> <span class="hljs-keyword">for</span> <span class="hljs-title class_">ProjectionPlan</span> {
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">execute</span>(
        &amp;<span class="hljs-keyword">self</span>,
        partition: <span class="hljs-type">usize</span>,
        state: Arc&lt;TaskContext&gt;,
    ) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;SendableRecordBatchStream&gt; {
        <span class="hljs-comment">// 1. 执行输入计划</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">input_stream</span> = <span class="hljs-keyword">self</span>.input.<span class="hljs-title function_ invoke__">execute</span>(partition, state).<span class="hljs-keyword">await</span>?;
        
        <span class="hljs-comment">// 2. 对每个 batch 应用投影</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">output_stream</span> = input_stream.<span class="hljs-title function_ invoke__">map</span>(|batch| {
            <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">project_batch</span>(&amp;batch)
        });
        
        <span class="hljs-title function_ invoke__">Ok</span>(<span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">pin</span>(output_stream))
    }
    
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">schema</span>(&amp;<span class="hljs-keyword">self</span>) <span class="hljs-punctuation">-&gt;</span> SchemaRef {
        <span class="hljs-comment">// 构建投影后的 schema</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">fields</span>: <span class="hljs-type">Vec</span>&lt;_&gt; = <span class="hljs-keyword">self</span>.output_names.<span class="hljs-title function_ invoke__">iter</span>()
            .<span class="hljs-title function_ invoke__">zip</span>(&amp;<span class="hljs-keyword">self</span>.expressions)
            .<span class="hljs-title function_ invoke__">map</span>(|(name, expr)| {
                Field::<span class="hljs-title function_ invoke__">new</span>(name.<span class="hljs-title function_ invoke__">clone</span>(), expr.<span class="hljs-title function_ invoke__">return_type</span>(), <span class="hljs-literal">true</span>)
            })
            .<span class="hljs-title function_ invoke__">collect</span>();
        Arc::<span class="hljs-title function_ invoke__">new</span>(Schema::<span class="hljs-title function_ invoke__">new</span>(fields))
    }
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">ProjectionPlan</span> {
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">project_batch</span>(&amp;<span class="hljs-keyword">self</span>, batch: &amp;RecordBatch) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;RecordBatch&gt; {
        <span class="hljs-comment">// 对 batch 中的每个表达式求值</span>
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">columns</span> = <span class="hljs-built_in">vec!</span>[];
        
        <span class="hljs-keyword">for</span> <span class="hljs-variable">expr</span> <span class="hljs-keyword">in</span> &amp;<span class="hljs-keyword">self</span>.expressions {
            <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">col_array</span> = expr.<span class="hljs-title function_ invoke__">evaluate</span>(batch)?;
            columns.<span class="hljs-title function_ invoke__">push</span>(col_array);
        }
        
        <span class="hljs-comment">// 构建新的 batch</span>
        <span class="hljs-title function_ invoke__">Ok</span>(RecordBatch::<span class="hljs-title function_ invoke__">try_new</span>(<span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">schema</span>(), columns)?)
    }
}
</code></pre>
<h4 data-id="heading-7">投影下推优化</h4>
<p>投影下推的目标是<strong>尽早减少列</strong>，减少 IO 和内存消耗。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ProjectionPushdown</span>;

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">ProjectionPushdown</span> {
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">optimize</span>(&amp;<span class="hljs-keyword">self</span>, plan: &amp;ExecutionPlan) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Result</span>&lt;Arc&lt;<span class="hljs-keyword">dyn</span> ExecutionPlan&gt;&gt; {
        <span class="hljs-keyword">match</span> plan {
            <span class="hljs-comment">// 投影 - 扫描：下推到扫描</span>
            ProjectionPlan {
                input: <span class="hljs-keyword">box</span> ScanPlan { table, .. },
                expressions,
                ..
            } =&gt; {
                <span class="hljs-comment">// 分析投影表达式中引用的列</span>
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">required_columns</span> = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">extract_columns</span>(expressions);
                
                <span class="hljs-comment">// 创建只扫描这些列的新 ScanPlan</span>
                <span class="hljs-title function_ invoke__">Ok</span>(Arc::<span class="hljs-title function_ invoke__">new</span>(ScanPlan {
                    table: table.<span class="hljs-title function_ invoke__">clone</span>(),
                    projection: <span class="hljs-title function_ invoke__">Some</span>(required_columns),
                    <span class="hljs-comment">// ...</span>
                }))
            }
            
            <span class="hljs-comment">// 投影 - 过滤：分析过滤中的列</span>
            ProjectionPlan {
                input: <span class="hljs-keyword">box</span> FilterPlan { predicate, .. },
                expressions,
                ..
            } =&gt; {
                <span class="hljs-comment">// 需要的列 = 投影列 + 过滤列</span>
                <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">required</span> = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">extract_columns</span>(expressions);
                required.<span class="hljs-title function_ invoke__">extend</span>(<span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">extract_columns_from_expr</span>(predicate));
                required.<span class="hljs-title function_ invoke__">sort</span>();
                required.<span class="hljs-title function_ invoke__">dedup</span>();
                
                <span class="hljs-comment">// ... 下推</span>
                <span class="hljs-title function_ invoke__">Ok</span>(Arc::<span class="hljs-title function_ invoke__">new</span>(...))
            }
            
            _ =&gt; <span class="hljs-title function_ invoke__">Ok</span>(Arc::<span class="hljs-title function_ invoke__">new</span>(plan.<span class="hljs-title function_ invoke__">clone</span>())),
        }
    }
    
    <span class="hljs-comment">// 从表达式中提取引用的列索引</span>
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">extract_columns</span>(&amp;<span class="hljs-keyword">self</span>, expressions: &amp;[Expr]) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">usize</span>&gt; {
        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">columns</span> = <span class="hljs-built_in">vec!</span>[];
        <span class="hljs-keyword">for</span> <span class="hljs-variable">expr</span> <span class="hljs-keyword">in</span> expressions {
            <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">extract_columns_from_expr_into</span>(expr, &amp;<span class="hljs-keyword">mut</span> columns);
        }
        columns
    }
    
    <span class="hljs-keyword">fn</span> <span class="hljs-title function_">extract_columns_from_expr_into</span>(&amp;<span class="hljs-keyword">self</span>, expr: &amp;Expr, columns: &amp;<span class="hljs-keyword">mut</span> <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">usize</span>&gt;) {
        <span class="hljs-keyword">match</span> expr {
            Expr::Column { index, .. } =&gt; {
                columns.<span class="hljs-title function_ invoke__">push</span>(*index);
            }
            Expr::BinaryOp { left, right, .. } =&gt; {
                <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">extract_columns_from_expr_into</span>(left, columns);
                <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">extract_columns_from_expr_into</span>(right, columns);
            }
            Expr::UnaryOp { operand, .. } =&gt; {
                <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">extract_columns_from_expr_into</span>(operand, columns);
            }
            Expr::Function { args, .. } =&gt; {
                <span class="hljs-keyword">for</span> <span class="hljs-variable">arg</span> <span class="hljs-keyword">in</span> args {
                    <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">extract_columns_from_expr_into</span>(arg, columns);
                }
            }
            _ =&gt; {}
        }
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-8">🔍 谓词分析与下推</h3>
<h4 data-id="heading-9">谓词分析</h4>
<p>谓词分析用于识别哪些条件可以在索引层面处理，以减少数据扫描。</p>
<pre><code class="hljs language-rust" lang="rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">PredicateAnalyzer</span> {
    schema: SchemaRef,
    index_info: IndexInfo,  <span class="hljs-comment">// 索引信息</span>
}

<span class="hljs-keyword">pub</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">PredicatePushdownSupport</span> {
    Unsupported,   <span class="hljs-comment">// 无法下推</span>
    Partial,       <span class="hljs-comment">// 部分支持（如需要额外过滤）</span>
    Full,          <span class="hljs-comment">// 完全支持</span>
}

<span class="hljs-keyword">impl</span> <span class="hljs-title class_">PredicateAnalyzer</span> {
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">analyze_pushdown</span>(&amp;<span class="hljs-keyword">self</span>, predicate: &amp;Expr) <span class="hljs-punctuation">-&gt;</span> PredicatePushdownSupport {
        <span class="hljs-keyword">match</span> predicate {
            <span class="hljs-comment">// 等值查询：column = value</span>
            Expr::BinaryOp {
                left: <span class="hljs-keyword">box</span> Expr::Column { name, .. },
                op: BinaryOperator::<span class="hljs-built_in">Eq</span>,
                right: <span class="hljs-keyword">box</span> Expr::<span class="hljs-title function_ invoke__">Literal</span>(_),
            } =&gt; {
                <span class="hljs-comment">// 检查列是否有索引</span>
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span>.index_info.<span class="hljs-title function_ invoke__">has_index</span>(name) {
                    PredicatePushdownSupport::Full
                } <span class="hljs-keyword">else</span> {
                    PredicatePushdownSupport::Partial
                }
            }
            
            <span class="hljs-comment">// 范围查询：column &gt; value AND column &lt; value</span>
            Expr::BinaryOp {
                left,
                op: BinaryOperator::And,
                right,
            } =&gt; {
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">left_support</span> = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">analyze_pushdown</span>(left);
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">right_support</span> = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">analyze_pushdown</span>(right);
                
                <span class="hljs-title function_ invoke__">match</span> (left_support, right_support) {
                    (PredicatePushdownSupport::Full, PredicatePushdownSupport::Full) =&gt; {
                        PredicatePushdownSupport::Full
                    }
                    (PredicatePushdownSupport::Unsupported, _) | (_, PredicatePushdownSupport::Unsupported) =&gt; {
                        PredicatePushdownSupport::Unsupported
                    }
                    _ =&gt; PredicatePushdownSupport::Partial,
                }
            }
            
            <span class="hljs-comment">// 向量搜索：特殊处理，不能普通下推</span>
            Expr::VectorSearch { .. } =&gt; {
                PredicatePushdownSupport::Unsupported
            }
            
            _ =&gt; PredicatePushdownSupport::Partial,
        }
    }
    
    <span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">split_predicate</span>(&amp;<span class="hljs-keyword">self</span>, predicate: &amp;Expr) <span class="hljs-punctuation">-&gt;</span> (<span class="hljs-type">Option</span>&lt;Expr&gt;, <span class="hljs-type">Option</span>&lt;Expr&gt;) {
        <span class="hljs-comment">// 将谓词分为两部分：</span>
        <span class="hljs-comment">// 1. 可以下推的（在索引层处理）</span>
        <span class="hljs-comment">// 2. 无法下推的（在执行器处理）</span>
        
        <span class="hljs-keyword">match</span> predicate {
            Expr::BinaryOp {
                left,
                op: BinaryOperator::And,
                right,
            } =&gt; {
                <span class="hljs-keyword">let</span> (push_left, no_push_left) = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">split_predicate</span>(left);
                <span class="hljs-keyword">let</span> (push_right, no_push_right) = <span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">split_predicate</span>(right);
                
                <span class="hljs-comment">// 合并可推的条件</span>
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">pushdown</span> = <span class="hljs-title function_ invoke__">match</span> (push_left, push_right) {
                    (<span class="hljs-title function_ invoke__">Some</span>(l), <span class="hljs-title function_ invoke__">Some</span>(r)) =&gt; <span class="hljs-title function_ invoke__">Some</span>(Expr::BinaryOp {
                        left: <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(l),
                        op: BinaryOperator::And,
                        right: <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(r),
                    }),
                    (<span class="hljs-title function_ invoke__">Some</span>(e), <span class="hljs-literal">None</span>) | (<span class="hljs-literal">None</span>, <span class="hljs-title function_ invoke__">Some</span>(e)) =&gt; <span class="hljs-title function_ invoke__">Some</span>(e),
                    (<span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>) =&gt; <span class="hljs-literal">None</span>,
                };
                
                <span class="hljs-comment">// 合并无法推的条件</span>
                <span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">no_pushdown</span> = <span class="hljs-title function_ invoke__">match</span> (no_push_left, no_push_right) {
                    (<span class="hljs-title function_ invoke__">Some</span>(l), <span class="hljs-title function_ invoke__">Some</span>(r)) =&gt; <span class="hljs-title function_ invoke__">Some</span>(Expr::BinaryOp {
                        left: <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(l),
                        op: BinaryOperator::And,
                        right: <span class="hljs-type">Box</span>::<span class="hljs-title function_ invoke__">new</span>(r),
                    }),
                    (<span class="hljs-title function_ invoke__">Some</span>(e), <span class="hljs-literal">None</span>) | (<span class="hljs-literal">None</span>, <span class="hljs-title function_ invoke__">Some</span>(e)) =&gt; <span class="hljs-title function_ invoke__">Some</span>(e),
                    (<span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>) =&gt; <span class="hljs-literal">None</span>,
                };
                
                (pushdown, no_pushdown)
            }
            
            _ =&gt; {
                <span class="hljs-comment">// 单个谓词：判断是否可推</span>
                <span class="hljs-keyword">if</span> matches!(<span class="hljs-keyword">self</span>.<span class="hljs-title function_ invoke__">analyze_pushdown</span>(predicate), PredicatePushdownSupport::Full) {
                    (<span class="hljs-title function_ invoke__">Some</span>(predicate.<span class="hljs-title function_ invoke__">clone</span>()), <span class="hljs-literal">None</span>)
                } <span class="hljs-keyword">else</span> {
                    (<span class="hljs-literal">None</span>, <span class="hljs-title function_ invoke__">Some</span>(predicate.<span class="hljs-title function_ invoke__">clone</span>()))
                }
            }
        }
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-10">📊 性能优化示例</h3>
<h4 data-id="heading-11">CASE WHEN 优化</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> lance
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

<span class="hljs-comment"># 创建示例数据</span>
data = {
    <span class="hljs-string">"id"</span>: np.arange(<span class="hljs-number">1000</span>),
    <span class="hljs-string">"price"</span>: np.random.randint(<span class="hljs-number">10</span>, <span class="hljs-number">1000</span>, <span class="hljs-number">1000</span>),
    <span class="hljs-string">"category"</span>: np.random.choice([<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>], <span class="hljs-number">1000</span>),
}

table = lance.write_table(data, uri=<span class="hljs-string">"data.lance"</span>)

<span class="hljs-comment"># SQL 查询：使用 CASE WHEN 进行分类</span>
result = table.search_sql(<span class="hljs-string">"""
    SELECT 
        id,
        price,
        CASE 
            WHEN price &lt; 100 THEN 'cheap'
            WHEN price &lt; 500 THEN 'medium'
            ELSE 'expensive'
        END as price_tier,
        CASE category
            WHEN 'A' THEN 1
            WHEN 'B' THEN 2
            WHEN 'C' THEN 3
            ELSE 0
        END as category_code
    FROM data
    WHERE price &gt; 50
"""</span>)

<span class="hljs-comment"># 转换为 Pandas</span>
df = result.to_pandas()
<span class="hljs-built_in">print</span>(df)
</code></pre>
<h4 data-id="heading-12">列投影优化</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 优化前：扫描所有列</span>
result = table.search_sql(<span class="hljs-string">"""
    SELECT * FROM data WHERE price &gt; 100
"""</span>)

<span class="hljs-comment"># 优化后：只扫描需要的列（投影下推）</span>
result = table.search_sql(<span class="hljs-string">"""
    SELECT id, price FROM data WHERE price &gt; 100
"""</span>)

<span class="hljs-comment"># 性能提升：假设表有 100 列，只需要 2 列</span>
<span class="hljs-comment"># 性能提升比例 ≈ 100 / 2 = 50x</span>
</code></pre>
<hr/>
<h3 data-id="heading-13">📚 总结</h3>
<p>表达式与投影是查询执行的核心：</p>
<ol>
<li><strong>表达式求值</strong>：支持所有常见的运算和函数</li>
<li><strong>投影下推</strong>：尽早减少列，减少 IO</li>
<li><strong>谓词分析</strong>：判断条件是否可在索引层处理</li>
<li><strong>性能优化</strong>：通过下推和融合大幅降低成本</li>
</ol>
<p>这些机制共同作用，使 Lance 能够高效地处理复杂的分析查询。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于C++从0到1手写Linux高性能网络编程框架(超清)]]></title>    <link>https://juejin.cn/post/7577668116500283430</link>    <guid>https://juejin.cn/post/7577668116500283430</guid>    <pubDate>2025-11-28T07:42:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577668116500283430" data-draft-id="7577431644068773939" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于C++从0到1手写Linux高性能网络编程框架(超清)"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-28T07:42:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="课程xingkeit与top"/> <meta itemprop="url" content="https://juejin.cn/user/1910275039560096"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于C++从0到1手写Linux高性能网络编程框架(超清)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1910275039560096/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    课程xingkeit与top
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T07:42:09.000Z" title="Fri Nov 28 2025 07:42:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Linux环境下，高性能网络编程的核心在于<strong>高效利用系统资源、减少拷贝、优化事件处理机制</strong>。本教程将带你从零实现一个基于<strong>Reactor模式+Epoll</strong>的C++网络框架，支持高并发（百万级连接）、低延迟（微秒级响应），并包含关键代码解析与完整实现步骤。</p>
<hr/>
<h3 data-id="heading-0"><strong>一、框架设计核心思想</strong></h3>
<ol>
<li>
<p><strong>Reactor模式</strong>：</p>
<ul>
<li>主线程（Reactor）监听所有事件（如连接、读写），通过回调函数将事件分发给工作线程处理。</li>
<li>避免多线程竞争，减少锁开销。</li>
</ul>
</li>
<li>
<p><strong>Epoll边缘触发（ET）</strong> ：</p>
<ul>
<li>相比水平触发（LT），ET模式仅在文件描述符状态变化时通知，减少重复事件处理。</li>
<li>需配合非阻塞IO（<code>fcntl(fd, F_SETFL, O_NONBLOCK)</code>）使用。</li>
</ul>
</li>
<li>
<p><strong>内存池与零拷贝</strong>：</p>
<ul>
<li>自定义内存池减少动态内存分配开销。</li>
<li>使用<code>sendfile</code>系统调用实现文件传输零拷贝。</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-1"><strong>二、关键组件实现</strong></h3>
<h4 data-id="heading-2"><strong>1. 基础结构定义</strong></h4>
<pre><code class="hljs language-arduino" lang="arduino">cpp
<span class="hljs-number">1</span><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/epoll.h&gt;</span></span>
<span class="hljs-number">2</span><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span>
<span class="hljs-number">3</span><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unordered_map&gt;</span></span>
<span class="hljs-number">4</span><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;functional&gt;</span></span>
<span class="hljs-number">5</span>
<span class="hljs-number">6</span><span class="hljs-comment">// 事件回调类型定义</span>
<span class="hljs-number">7u</span>sing EventCallback = std::function&lt;<span class="hljs-built_in">void</span>(<span class="hljs-type">int</span> fd)&gt;;
<span class="hljs-number">8</span>
<span class="hljs-number">9</span><span class="hljs-comment">// 连接对象（封装socket描述符与回调）</span>
<span class="hljs-number">10</span><span class="hljs-keyword">struct</span> Connection {
<span class="hljs-number">11</span>    <span class="hljs-type">int</span> fd;
<span class="hljs-number">12</span>    EventCallback onRead;
<span class="hljs-number">13</span>    EventCallback onWrite;
<span class="hljs-number">14</span>    <span class="hljs-comment">// 其他业务数据（如缓冲区、状态等）</span>
<span class="hljs-number">15</span>};
<span class="hljs-number">16</span>
<span class="hljs-number">17</span><span class="hljs-comment">// Reactor核心类</span>
<span class="hljs-number">18</span><span class="hljs-keyword">class</span> Reactor {
<span class="hljs-number">19</span><span class="hljs-keyword">private</span>:
<span class="hljs-number">20</span>    <span class="hljs-type">int</span> epoll_fd;
<span class="hljs-number">21</span>    std::unordered_map&lt;<span class="hljs-type">int</span>, Connection&gt; connections; <span class="hljs-comment">// fd到连接的映射</span>
<span class="hljs-number">22</span>
<span class="hljs-number">23</span><span class="hljs-keyword">public</span>:
<span class="hljs-number">24</span>    <span class="hljs-built_in">Reactor</span>() {
<span class="hljs-number">25</span>        epoll_fd = <span class="hljs-built_in">epoll_create1</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">// 创建epoll实例</span>
<span class="hljs-number">26</span>        <span class="hljs-keyword">if</span> (epoll_fd == <span class="hljs-number">-1</span>) {
<span class="hljs-number">27</span>            <span class="hljs-built_in">perror</span>(<span class="hljs-string">"epoll_create1 failed"</span>);
<span class="hljs-number">28</span>            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
<span class="hljs-number">29</span>        }
<span class="hljs-number">30</span>    }
<span class="hljs-number">31</span>
<span class="hljs-number">32</span>    ~<span class="hljs-built_in">Reactor</span>() { <span class="hljs-built_in">close</span>(epoll_fd); }
<span class="hljs-number">33</span>
<span class="hljs-number">34</span>    <span class="hljs-comment">// 添加事件监听</span>
<span class="hljs-number">35</span>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">addEvent</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">uint32_t</span> events, EventCallback onRead, EventCallback onWrite)</span></span>;
<span class="hljs-number">36</span>    
<span class="hljs-number">37</span>    <span class="hljs-comment">// 事件循环</span>
<span class="hljs-number">38</span>    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span>;
<span class="hljs-number">39</span>};
</code></pre>
<h4 data-id="heading-3"><strong>2. Epoll事件管理</strong></h4>
<pre><code class="hljs language-ini" lang="ini">cpp
1void Reactor::addEvent(int fd, uint32_t events, EventCallback onRead, EventCallback onWrite) {
2    // 设置socket为非阻塞
3    int <span class="hljs-attr">flags</span> = fcntl(fd, F_GETFL, <span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
4    fcntl(fd, F_SETFL, flags | O_NONBLOCK)<span class="hljs-comment">;</span>
5
6    // 注册事件到epoll
7    struct epoll_event ev<span class="hljs-comment">;</span>
8    <span class="hljs-attr">ev.events</span> = events | EPOLLET<span class="hljs-comment">; // 边缘触发</span>
9    <span class="hljs-attr">ev.data.fd</span> = fd<span class="hljs-comment">;</span>
10
11    if (epoll_ctl(epoll_fd, EPOLL_CTL_ADD, fd, &amp;ev) == -1) {
12        perror("epoll_ctl add failed")<span class="hljs-comment">;</span>
13        close(fd)<span class="hljs-comment">;</span>
14        return<span class="hljs-comment">;</span>
15    }
16
17    // 保存连接信息
18    connections<span class="hljs-section">[fd]</span> = {fd, onRead, onWrite}<span class="hljs-comment">;</span>
19}
</code></pre>
<h4 data-id="heading-4"><strong>3. 事件循环与回调分发</strong></h4>
<pre><code class="hljs language-ini" lang="ini">cpp
1void Reactor::run() {
2    const int <span class="hljs-attr">MAX_EVENTS</span> = <span class="hljs-number">1024</span><span class="hljs-comment">;</span>
3    struct epoll_event events<span class="hljs-section">[MAX_EVENTS]</span><span class="hljs-comment">;</span>
4
5    while (true) {
6        int <span class="hljs-attr">n</span> = epoll_wait(epoll_fd, events, MAX_EVENTS, -<span class="hljs-number">1</span>)<span class="hljs-comment">; // 阻塞等待事件</span>
7        if (<span class="hljs-attr">n</span> == -<span class="hljs-number">1</span>) {
8            perror("epoll_wait failed")<span class="hljs-comment">;</span>
9            break<span class="hljs-comment">;</span>
10        }
11
12        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; n; ++i) {</span>
13            int <span class="hljs-attr">fd</span> = events[i].data.fd<span class="hljs-comment">;</span>
14            auto&amp; <span class="hljs-attr">conn</span> = connections[fd]<span class="hljs-comment">;</span>
15
16            if (events<span class="hljs-section">[i]</span>.events &amp; EPOLLIN) { // 可读事件
17                if (conn.onRead) conn.onRead(fd)<span class="hljs-comment">;</span>
18            }
19
20            if (events<span class="hljs-section">[i]</span>.events &amp; EPOLLOUT) { // 可写事件
21                if (conn.onWrite) conn.onWrite(fd)<span class="hljs-comment">;</span>
22            }
23
24            // 处理错误或挂断事件
25            if (events<span class="hljs-section">[i]</span>.events &amp; (EPOLLERR | EPOLLHUP)) {
26                close(fd)<span class="hljs-comment">;</span>
27                connections.erase(fd)<span class="hljs-comment">;</span>
28            }
29        }
30    }
31}
</code></pre>
<hr/>
<h3 data-id="heading-5"><strong>三、完整服务端实现</strong></h3>
<h4 data-id="heading-6"><strong>1. 初始化与启动服务</strong></h4>
<pre><code class="hljs language-c" lang="c">cpp
<span class="hljs-number">1</span><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-number">2</span><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cstring&gt;</span></span>
<span class="hljs-number">3</span><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-number">4</span><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;arpa/inet.h&gt;</span></span>
<span class="hljs-number">5</span>
<span class="hljs-number">6</span><span class="hljs-comment">// 简单的读回调：回显数据</span>
<span class="hljs-number">7</span><span class="hljs-type">void</span> <span class="hljs-title function_">onRead</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span> {
<span class="hljs-number">8</span>    <span class="hljs-type">char</span> buf[<span class="hljs-number">1024</span>];
<span class="hljs-number">9</span>    <span class="hljs-type">ssize_t</span> n = recv(fd, buf, <span class="hljs-keyword">sizeof</span>(buf), <span class="hljs-number">0</span>);
<span class="hljs-number">10</span>    <span class="hljs-keyword">if</span> (n &gt; <span class="hljs-number">0</span>) {
<span class="hljs-number">11</span>        send(fd, buf, n, <span class="hljs-number">0</span>); <span class="hljs-comment">// 回显</span>
<span class="hljs-number">12</span>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (n == <span class="hljs-number">0</span>) { <span class="hljs-comment">// 客户端关闭连接</span>
<span class="hljs-number">13</span>        close(fd);
<span class="hljs-number">14</span>    }
<span class="hljs-number">15</span>}
<span class="hljs-number">16</span>
<span class="hljs-number">17</span><span class="hljs-comment">// 简单的写回调（示例中未使用）</span>
<span class="hljs-number">18</span><span class="hljs-type">void</span> <span class="hljs-title function_">onWrite</span><span class="hljs-params">(<span class="hljs-type">int</span> fd)</span> { <span class="hljs-comment">/* ... */</span> }
<span class="hljs-number">19</span>
<span class="hljs-number">20</span><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
<span class="hljs-number">21</span>    Reactor reactor;
<span class="hljs-number">22</span>
<span class="hljs-number">23</span>    <span class="hljs-comment">// 创建监听socket</span>
<span class="hljs-number">24</span>    <span class="hljs-type">int</span> listen_fd = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);
<span class="hljs-number">25</span>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">addr</span>;</span>
<span class="hljs-number">26</span>    <span class="hljs-built_in">memset</span>(&amp;addr, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(addr));
<span class="hljs-number">27</span>    addr.sin_family = AF_INET;
<span class="hljs-number">28</span>    addr.sin_port = htons(<span class="hljs-number">8080</span>);
<span class="hljs-number">29</span>    addr.sin_addr.s_addr = INADDR_ANY;
<span class="hljs-number">30</span>
<span class="hljs-number">31</span>    bind(listen_fd, (<span class="hljs-keyword">struct</span> sockaddr*)&amp;addr, <span class="hljs-keyword">sizeof</span>(addr));
<span class="hljs-number">32</span>    listen(listen_fd, SOMAXCONN);
<span class="hljs-number">33</span>
<span class="hljs-number">34</span>    <span class="hljs-comment">// 将监听socket设为非阻塞并添加到Reactor</span>
<span class="hljs-number">35</span>    <span class="hljs-type">int</span> flags = fcntl(listen_fd, F_GETFL, <span class="hljs-number">0</span>);
<span class="hljs-number">36</span>    fcntl(listen_fd, F_SETFL, flags | O_NONBLOCK);
<span class="hljs-number">37</span>
<span class="hljs-number">38</span>    <span class="hljs-comment">// 监听可读事件（新连接到达）</span>
<span class="hljs-number">39</span>    reactor.addEvent(listen_fd, EPOLLIN, [](<span class="hljs-type">int</span> fd) {
<span class="hljs-number">40</span>        <span class="hljs-keyword">struct</span> sockaddr_in client_addr;
<span class="hljs-number">41</span>        <span class="hljs-type">socklen_t</span> len = <span class="hljs-keyword">sizeof</span>(client_addr);
<span class="hljs-number">42</span>        <span class="hljs-type">int</span> client_fd = accept(fd, (<span class="hljs-keyword">struct</span> sockaddr*)&amp;client_addr, &amp;len);
<span class="hljs-number">43</span>        <span class="hljs-keyword">if</span> (client_fd &gt; <span class="hljs-number">0</span>) {
<span class="hljs-number">44</span>            <span class="hljs-comment">// 为新连接注册读事件（回显业务）</span>
<span class="hljs-number">45</span>            Reactor* reactor = Reactor::getInstance(); <span class="hljs-comment">// 假设Reactor为单例</span>
<span class="hljs-number">46</span>            reactor-&gt;addEvent(client_fd, EPOLLIN, onRead, onWrite);
<span class="hljs-number">47</span>        }
<span class="hljs-number">48</span>    }, nullptr);
<span class="hljs-number">49</span>
<span class="hljs-number">50</span>    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">"Server started on port 8080..."</span> &lt;&lt; <span class="hljs-built_in">std</span>::<span class="hljs-built_in">endl</span>;
<span class="hljs-number">51</span>    reactor.run(); <span class="hljs-comment">// 启动事件循环</span>
<span class="hljs-number">52</span>
<span class="hljs-number">53</span>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
<span class="hljs-number">54</span>}
</code></pre>
<h4 data-id="heading-7"><strong>2. 性能优化技巧</strong></h4>
<ol>
<li>
<p><strong>SO_REUSEPORT</strong>：允许多线程绑定同一端口，加速连接建立。</p>
<pre><code class="hljs language-ini" lang="ini">cpp
1int <span class="hljs-attr">opt</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
2setsockopt(listen_fd, SOL_SOCKET, SO_REUSEPORT, &amp;opt, sizeof(opt))<span class="hljs-comment">;</span>
</code></pre>
</li>
<li>
<p><strong>TCP_FASTOPEN</strong>：减少TCP握手延迟（需内核支持）。</p>
<pre><code class="hljs language-scss" lang="scss">cpp
<span class="hljs-number">1s</span><span class="hljs-built_in">etsockopt</span>(listen_fd, IPPROTO_TCP, TCP_FASTOPEN, &amp;opt, sizeof(opt));
</code></pre>
</li>
<li>
<p><strong>内存池优化</strong>：预分配缓冲区池，避免频繁<code>malloc/free</code>。</p>
</li>
</ol>
<hr/>
<h3 data-id="heading-8"><strong>四、测试与验证</strong></h3>
<ol>
<li>
<p><strong>使用<code>wrk</code>压测</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">bash
<span class="hljs-number">1</span>wrk -t4 -c1000 -d30s http:<span class="hljs-comment">//localhost:8080</span>
</code></pre>
<ul>
<li><code>-t4</code>：4个线程</li>
<li><code>-c1000</code>：1000个并发连接</li>
<li><code>-d30s</code>：持续30秒</li>
</ul>
</li>
<li>
<p><strong>监控系统指标</strong>：</p>
<ul>
<li><code>netstat -anp | grep 8080</code>：查看连接数</li>
<li><code>top -p &lt;pid&gt;</code>：观察CPU占用</li>
<li><code>strace -p &lt;pid&gt;</code>：跟踪系统调用</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-9"><strong>五、扩展功能建议</strong></h3>
<ol>
<li><strong>定时器支持</strong>：集成<code>timerfd</code>实现定时任务（如心跳检测）。</li>
<li><strong>线程池</strong>：将耗时业务逻辑（如数据库查询）放到工作线程池处理。</li>
<li><strong>SSL/TLS加密</strong>：集成OpenSSL支持HTTPS。</li>
</ol>
<hr/>
<h3 data-id="heading-10"><strong>六、总结</strong></h3>
<p>本教程实现了<strong>基于Reactor+Epoll的C++高性能网络框架</strong>，核心代码仅200余行，却具备以下特性：</p>
<ul>
<li><strong>百万级连接</strong>：通过Epoll边缘触发与非阻塞IO实现。</li>
<li><strong>低延迟</strong>：减少事件处理中的冗余拷贝与系统调用。</li>
<li><strong>易扩展</strong>：通过回调机制分离事件处理与业务逻辑。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[分布式订单系统：订单号编码设计实战]]></title>    <link>https://juejin.cn/post/7577438119558086707</link>    <guid>https://juejin.cn/post/7577438119558086707</guid>    <pubDate>2025-11-28T07:02:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577438119558086707" data-draft-id="7577307100130836530" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="分布式订单系统：订单号编码设计实战"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-11-28T07:02:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Carve_the_Code"/> <meta itemprop="url" content="https://juejin.cn/user/624178336105997"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            分布式订单系统：订单号编码设计实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/624178336105997/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Carve_the_Code
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T07:02:15.000Z" title="Fri Nov 28 2025 07:02:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">分布式订单系统：订单号编码设计实战</h2>
<blockquote>
<p><strong>作者</strong>: Carve_the_Code
<strong>标签</strong>: #分布式系统 #数据库分片 #性能优化 #架构设计</p>
</blockquote>
<blockquote>
<p><strong>声明</strong>：本文基于通用分布式系统实践总结，代码为简化示例，性能数据为典型场景参考值。</p>
</blockquote>
<h3 data-id="heading-1">一、背景：分库分表后的路由困境</h3>
<h4 data-id="heading-2">1.1 业务场景</h4>
<p>某大型 OTA 平台的订单系统支持多国家、多渠道业务，主要服务于：</p>
<ul>
<li><strong>EU_CHANNEL</strong>: 欧洲多国业务</li>
<li><strong>GLOBAL_CHANNEL</strong>: 国际站业务</li>
<li><strong>CN_CHANNEL</strong>: 国内站国际业务</li>
</ul>
<p>作为核心服务，订单详情查询是最高频的操作之一，每天处理千万级查询请求。</p>
<h3 data-id="heading-3">二、架构演进</h3>
<h4 data-id="heading-4">2.1 单库时代</h4>
<p><strong>订单号设计</strong>：</p>
<ul>
<li>使用公司统一的分布式 ID 服务（基于 Snowflake）</li>
<li>orderId 为 64 位 Long，全局唯一、趋势递增</li>
<li><strong>不包含任何业务路由信息</strong></li>
</ul>
<p><strong>查询方式</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> t_order <span class="hljs-keyword">WHERE</span> order_id <span class="hljs-operator">=</span> ?
</code></pre>
<p>简单高效，单库足以支撑初期业务量。</p>
<h4 data-id="heading-5">2.2 分库分表（路由困境浮现）</h4>
<p><strong>改造背景</strong>：订单量持续增长，单库性能瓶颈，必须分库分表。</p>
<p><strong>分片方案</strong>：</p>
<ul>
<li>按 channel + orderId % 4 拆分</li>
<li>不同渠道的数据物理隔离</li>
</ul>
<p><strong>问题来了</strong>：订单号仍然是普通 Snowflake ID，<strong>不包含路由信息</strong>！</p>
<p>查询订单时的困境：</p>
<ol>
<li>拿到 orderId，但不知道属于哪个渠道</li>
<li>必须先查询订单索引表，获取渠道信息</li>
<li>再根据渠道信息定位到具体分片</li>
</ol>
<p><strong>性能影响</strong>：</p>
<pre><code class="hljs language-arduino" lang="arduino">查询耗时：从几十毫秒 → 数百毫秒
P99 延迟：超过 <span class="hljs-number">1</span> 秒
原因：每次查询都要先<span class="hljs-string">"找分片"</span>
</code></pre>
<h4 data-id="heading-6">2.3 订单号编码优化（解决路由问题）</h4>
<p><strong>核心思路</strong>：改造 ID 生成逻辑，将路由信息编码到订单号中。</p>
<p><strong>灵感来源</strong>：身份证号</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">身份证号:</span> <span class="hljs-number">110101</span> <span class="hljs-number">1990 </span><span class="hljs-number">0101 </span><span class="hljs-string">001X</span>
          <span class="hljs-string">└──┬─┘</span> <span class="hljs-string">└───┬──┘</span> <span class="hljs-string">└┬┘</span>
           <span class="hljs-string">地区</span>  <span class="hljs-string">出生日期</span>  <span class="hljs-string">序列号</span>
          <span class="hljs-string">(北京)</span> <span class="hljs-string">(1990.01.01)</span>
</code></pre>
<p>看到身份证号前 6 位，就知道是哪个地区的人，<strong>无需查库</strong>！</p>
<p><strong>方案</strong>：在 64 位订单号中嵌入 4 位 routeKey，查询时直接解析，无需查库。</p>
<p><strong>核心收益</strong>：</p>
<ul>
<li>95% 的查询无需查库获取路由信息</li>
<li>查询性能显著提升（<strong>数十倍提升</strong>）</li>
<li>数据库负载降低 80%</li>
</ul>
<p><strong>兼容策略</strong>：</p>
<ul>
<li>新订单：编码了 routeKey，可直接解析</li>
<li>老订单：没有编码信息，走兜底查库</li>
<li>异常情况：三层降级策略保证可用性</li>
</ul>
<h3 data-id="heading-7">三、技术实现：订单号编码</h3>
<h4 data-id="heading-8">3.1 位结构设计</h4>
<blockquote>
<p>方案参考了业界成熟的分布式 ID 实践（如美团 Leaf），在此基础上增加了路由信息编码。</p>
</blockquote>
<p>原有 Snowflake 结构（64 位）：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────┬──────────────┬──────────────┬──────────────┐
│ 时间戳(<span class="hljs-number">41</span>位) │ 数据中心(<span class="hljs-number">5</span>位) │ 机器<span class="hljs-built_in">ID</span>(<span class="hljs-number">5</span>位)   │ 序列号(<span class="hljs-number">12</span>位)  │
└─────────────┴──────────────┴──────────────┴──────────────┘
</code></pre>
<p><strong>改造后</strong>：压缩机器ID，腾出 4 位给 routeKey</p>
<p><strong>64 位订单号结构</strong>：</p>
<pre><code class="hljs language-swift" lang="swift">block<span class="hljs-operator">-</span>beta
    columns <span class="hljs-number">4</span>
    block:timestamp[<span class="hljs-string">"时间戳<span class="hljs-subst">\n</span>41位<span class="hljs-subst">\n</span>bit63-23"</span>]
    end
    block:dc[<span class="hljs-string">"数据中心<span class="hljs-subst">\n</span>5位<span class="hljs-subst">\n</span>bit22-18"</span>]
    end
    block:routeKey[<span class="hljs-string">"routeKey<span class="hljs-subst">\n</span>4位<span class="hljs-subst">\n</span>bit17-14"</span>]
    end
    block:seq[<span class="hljs-string">"序列号<span class="hljs-subst">\n</span>14位<span class="hljs-subst">\n</span>bit13-0"</span>]
    end
</code></pre>
<pre><code class="hljs language-scss" lang="scss">┌──────────────┬──────────────┬──────────────┬──────────────┐
│  时间戳(<span class="hljs-number">41</span>位)  │ 数据中心(<span class="hljs-number">5</span>位) │ <span class="hljs-built_in">routeKey</span>(<span class="hljs-number">4</span>位) │  序列号(<span class="hljs-number">14</span>位)  │
├──────────────┼──────────────┼──────────────┼──────────────┤
│   bit <span class="hljs-number">63</span>-<span class="hljs-number">23</span>   │   bit <span class="hljs-number">22</span>-<span class="hljs-number">18</span>  │   bit <span class="hljs-number">17</span>-<span class="hljs-number">14</span>  │   bit <span class="hljs-number">13</span>-<span class="hljs-number">0</span>   │
└──────────────┴──────────────┴──────────────┴──────────────┘
  高位 ◄────────────────────────────────────────────► 低位
</code></pre>
<p><strong>关键设计点</strong>：</p>
<ul>
<li><strong>routeKey 占 4 位（4 bits）</strong>：可以表示 16 种渠道（2^4 = 16）</li>
<li><strong>位置选择</strong>：放在序列号之前（bit 17-14，从高到低），便于位运算提取</li>
<li><strong>编码映射</strong>：EU_CHANNEL → 5, GLOBAL_CHANNEL → 2, CN_CHANNEL → 1</li>
</ul>
<h4 data-id="heading-9">3.2 为什么是 4 位？</h4>
<p><strong>容量计算</strong>：</p>
<ul>
<li>当前业务有 3 个主要渠道</li>
<li>未来可能增加更多渠道</li>
<li>4 位可以表示 16 种渠道，<strong>预留 13 种扩展空间</strong></li>
</ul>
<p><strong>位数权衡</strong>：</p>
<ul>
<li>太少（2 位）：只能表示 4 种渠道，扩展性不足</li>
<li>太多（8 位）：浪费空间，挤压序列号位数，影响并发性能</li>
<li><strong>4 位刚好</strong>：满足当前需求 + 未来扩展</li>
</ul>
<h4 data-id="heading-10">3.3 编码过程（完整流程）</h4>
<p><strong>订单号生成时序图</strong>：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Client as 客户端
    participant OrderService as 订单服务
    participant IdGenerator as ID生成器
    participant UserDataService as 用户数据服务
    
    Client-&gt;&gt;OrderService: 下单请求(region=GB)
    OrderService-&gt;&gt;UserDataService: 查询 routeKey(region)
    UserDataService--&gt;&gt;OrderService: EU_CHANNEL
    OrderService-&gt;&gt;IdGenerator: 生成订单号(routeKey)
    Note over IdGenerator: 位运算编码 routeKey
    IdGenerator--&gt;&gt;OrderService: orderId(含路由信息)
    OrderService--&gt;&gt;Client: 订单创建成功
</code></pre>
<p><strong>步骤 1</strong>：用户传入 <code>region</code>（用户地区，国家代码）</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 用户下单时传入 region</span>
<span class="hljs-type">GenerateOrderIdRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenerateOrderIdRequest</span>();
request.setRegion(<span class="hljs-string">"GB"</span>);  <span class="hljs-comment">// 英国</span>
request.setUid(<span class="hljs-string">"user123"</span>);
</code></pre>
<p><strong>步骤 2</strong>：region → routeKey 映射</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 订单号生成服务内部会将 region 映射为 routeKey</span>
<span class="hljs-comment">// GB (英国) → EU_CHANNEL</span>
<span class="hljs-comment">// ES (西班牙) → EU_CHANNEL</span>
<span class="hljs-comment">// CN (中国) → CN_CHANNEL</span>
<span class="hljs-comment">// 这个映射关系由用户数据服务维护</span>

<span class="hljs-type">GenerateOrderIdRequest</span> <span class="hljs-variable">generateOrderIdRequest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GenerateOrderIdRequest</span>();
generateOrderIdRequest.setUid(request.getUid());
generateOrderIdRequest.setRegion(request.getRegion());

<span class="hljs-comment">// 调用订单号生成服务</span>
<span class="hljs-type">Long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> idGeneratorService.generateId(generateOrderIdRequest).getOrderId();
</code></pre>
<p><strong>步骤 3</strong>：routeKey → 4 位编码</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 订单号生成服务内部实现（简化示例）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderIdEncoder</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">encodeRouteKey</span><span class="hljs-params">(String routeKey)</span> {
        <span class="hljs-comment">// routeKey 映射为 4 位整数</span>
        <span class="hljs-keyword">switch</span> (routeKey) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">"EU_CHANNEL"</span>:     <span class="hljs-keyword">return</span> <span class="hljs-number">5</span>;   <span class="hljs-comment">// 0101</span>
            <span class="hljs-keyword">case</span> <span class="hljs-string">"GLOBAL_CHANNEL"</span>: <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>;   <span class="hljs-comment">// 0010</span>
            <span class="hljs-keyword">case</span> <span class="hljs-string">"BIZ_CHANNEL"</span>:    <span class="hljs-keyword">return</span> <span class="hljs-number">3</span>;   <span class="hljs-comment">// 0011</span>
            <span class="hljs-keyword">case</span> <span class="hljs-string">"CN_CHANNEL"</span>:     <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;   <span class="hljs-comment">// 0001</span>
            <span class="hljs-keyword">case</span> <span class="hljs-string">"CORP_CHANNEL"</span>:   <span class="hljs-keyword">return</span> <span class="hljs-number">4</span>;   <span class="hljs-comment">// 0100</span>
            <span class="hljs-keyword">default</span>:               <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;   <span class="hljs-comment">// 0000 (异常情况)</span>
        }
    }
}
</code></pre>
<p><strong>步骤 4</strong>：拼接到 orderId（位运算）</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Snowflake 改造版本（伪代码）</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">generateOrderId</span><span class="hljs-params">(String routeKey)</span> {
    <span class="hljs-comment">// 1. 获取当前时间戳（毫秒）</span>
    <span class="hljs-type">long</span> <span class="hljs-variable">timestamp</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - EPOCH;  <span class="hljs-comment">// 相对时间戳</span>

    <span class="hljs-comment">// 2. 获取数据中心 ID</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">datacenter</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;  <span class="hljs-comment">// 假设当前数据中心 ID 为 3</span>

    <span class="hljs-comment">// 3. 编码 routeKey</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">routeKeyBits</span> <span class="hljs-operator">=</span> encodeRouteKey(routeKey);  <span class="hljs-comment">// 5 (EU_CHANNEL)</span>

    <span class="hljs-comment">// 4. 获取序列号（同一毫秒内递增）</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">sequence</span> <span class="hljs-operator">=</span> getSequence();  <span class="hljs-comment">// 假设当前序列号为 123</span>

    <span class="hljs-comment">// 5. 位拼接：将各段信息拼接成 64 位 Long</span>
    <span class="hljs-comment">//    时间戳(41位) | 数据中心(5位) | routeKey(4位) | 序列号(14位)</span>
    <span class="hljs-type">long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    orderId |= (timestamp &lt;&lt; <span class="hljs-number">23</span>);        <span class="hljs-comment">// 时间戳左移 23 位（5+4+14）</span>
    orderId |= (datacenter &lt;&lt; <span class="hljs-number">18</span>);       <span class="hljs-comment">// 数据中心左移 18 位（4+14）</span>
    orderId |= (routeKeyBits &lt;&lt; <span class="hljs-number">14</span>);     <span class="hljs-comment">// routeKey 左移 14 位 ⬅️ 关键！</span>
    orderId |= sequence;                  <span class="hljs-comment">// 序列号占据低 14 位</span>

    <span class="hljs-keyword">return</span> orderId;
}
</code></pre>
<p><strong>生成的订单号示例</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">十进制:</span> <span class="hljs-number">1234567890123456789</span>
<span class="hljs-string">二进制:</span> <span class="hljs-number">0001 </span><span class="hljs-number">0001 </span><span class="hljs-number">0010 </span><span class="hljs-number">0011 </span><span class="hljs-number">0100 </span><span class="hljs-number">0101 </span><span class="hljs-number">0110 </span><span class="hljs-number">0111</span>
        <span class="hljs-number">1000 </span><span class="hljs-number">1001 </span><span class="hljs-number">0000 </span><span class="hljs-number">0001 </span><span class="hljs-number">0010 </span><span class="hljs-number">0011 </span><span class="hljs-number">0100 </span><span class="hljs-number">0101</span>
                                 <span class="hljs-string">↑</span> <span class="hljs-string">(bit</span> <span class="hljs-number">17</span><span class="hljs-number">-14</span><span class="hljs-string">)</span>
                           <span class="hljs-string">routeKey</span> <span class="hljs-string">=</span> <span class="hljs-number">0101</span>
                           <span class="hljs-string">(值</span> <span class="hljs-number">5</span> <span class="hljs-string">→</span> <span class="hljs-string">EU_CHANNEL)</span>
</code></pre>
<p><strong>关键技术</strong>：</p>
<ul>
<li><strong>左移运算（&lt;&lt;）</strong>：将数据移到指定位置</li>
<li><strong>或运算（|）</strong>：拼接多段数据</li>
<li><strong>无损编码</strong>：所有信息都保留在 64 位 Long 中</li>
</ul>
<h4 data-id="heading-11">3.4 解码过程（反向提取）</h4>
<p><strong>完整的 getRouteKey 方法</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getRouteKey</span><span class="hljs-params">(Long orderId)</span> {
    <span class="hljs-type">OrderIdDecoder</span> <span class="hljs-variable">orderIdDecoder</span> <span class="hljs-operator">=</span> OrderIdFactory.getOrderIdDecoder();

    <span class="hljs-comment">// 【第一层】优先从 orderId 解析</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">routeKey</span> <span class="hljs-operator">=</span> orderIdDecoder.decodeRouteKey(orderId);
    <span class="hljs-keyword">if</span> (StringUtils.isEmpty(routeKey)) {
        <span class="hljs-comment">// 【第二层】其次从请求上下文获取</span>
        routeKey = RequestContext.get(<span class="hljs-string">"routeKey"</span>);
    }

    <span class="hljs-keyword">if</span> (StringUtils.isEmpty(routeKey)) {
        <span class="hljs-comment">// 【第三层】最后从 region 推断</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">region</span> <span class="hljs-operator">=</span> RequestContext.get(<span class="hljs-string">"region"</span>);
        Optional&lt;String&gt; routeKeyByRegion = DataMappingService.getRouteKey(region);
        routeKey = routeKeyByRegion.orElse(<span class="hljs-string">""</span>);
    }

    <span class="hljs-keyword">return</span> routeKey;
}
</code></pre>
<p><strong>OrderIdDecoder 内部实现</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderIdDecoder</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">ROUTE_KEY_OFFSET</span> <span class="hljs-operator">=</span> <span class="hljs-number">14</span>;   <span class="hljs-comment">// 右移 14 位</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">ROUTE_KEY_MASK</span> <span class="hljs-operator">=</span> <span class="hljs-number">0xF</span>;   <span class="hljs-comment">// 低 4 位掩码（0b1111）</span>

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">decodeRouteKey</span><span class="hljs-params">(Long orderId)</span> {
        <span class="hljs-keyword">if</span> (orderId == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 位运算提取 routeKey（bit14-17，右移 14 位后取低 4 位）</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">routeKeyBits</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>)((orderId &gt;&gt; ROUTE_KEY_OFFSET) &amp; ROUTE_KEY_MASK);

            <span class="hljs-comment">// 解码为字符串</span>
            <span class="hljs-keyword">return</span> decodeRouteKeyBits(routeKeyBits);
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"解析 orderId 失败: {}"</span>, orderId, e);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">decodeRouteKeyBits</span><span class="hljs-params">(<span class="hljs-type">int</span> bits)</span> {
        <span class="hljs-keyword">switch</span> (bits) {
            <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">"EU_CHANNEL"</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">"GLOBAL_CHANNEL"</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">"BIZ_CHANNEL"</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">"CN_CHANNEL"</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>: <span class="hljs-keyword">return</span> <span class="hljs-string">"CORP_CHANNEL"</span>;
            <span class="hljs-keyword">default</span>: <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <span class="hljs-comment">// 解析失败</span>
        }
    }
}
</code></pre>
<p><strong>解码示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 示例订单号</span>
<span class="hljs-type">Long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> <span class="hljs-number">1234567890123456789L</span>;

<span class="hljs-comment">// 位运算过程：</span>
<span class="hljs-comment">// 1. 右移 14 位：orderId &gt;&gt; 14</span>
<span class="hljs-comment">// 2. 取低 4 位：&amp; 0xF (0b1111)</span>

<span class="hljs-type">int</span> <span class="hljs-variable">routeKeyBits</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>)((orderId &gt;&gt; <span class="hljs-number">14</span>) &amp; <span class="hljs-number">0xF</span>);  <span class="hljs-comment">// 提取 routeKey</span>
<span class="hljs-type">String</span> <span class="hljs-variable">routeKey</span> <span class="hljs-operator">=</span> decodeRouteKeyBits(routeKeyBits);  <span class="hljs-comment">// 映射为渠道名称</span>
</code></pre>
<h3 data-id="heading-12">四、三层路由策略</h3>
<h4 data-id="heading-13">4.1 设计理念</h4>
<p><strong>核心问题</strong>：不是所有订单都能解析成功</p>
<ul>
<li>新订单：编码了 routeKey，可以直接解析</li>
<li>老订单：没有编码信息，无法解析</li>
<li>异常情况：解析失败、数据异常等</li>
</ul>
<p><strong>解决方案</strong>：三层路由策略（逐层降级）</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[查询请求 orderId] --&gt; B{Layer 0: 缓存}
    B --&gt;|命中| C[返回分片索引]
    B --&gt;|未命中| D{Layer 1: orderId 解析}
    D --&gt;|解析成功| E[计算分片索引]
    E --&gt; F[写入缓存]
    F --&gt; C
    D --&gt;|解析失败| G{Layer 2: 请求上下文}
    G --&gt;|获取成功| E
    G --&gt;|获取失败| H{Layer 3: 查库兜底}
    H --&gt;|查询成功| E
    H --&gt;|查询失败| I[返回默认分片]
</code></pre>
<p><strong>各层职责</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">┌─────────────────────────────────────────────────────────────┐
│                     查询请求（orderId）                       │
└─────────────────────────────────────────────────────────────┘
<span class="hljs-code">                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 【Layer 0】缓存层                                            │
│ 命中 → 直接返回分片索引                                        │
│ 未命中 → 进入 Layer 1                                         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 【Layer 1】orderId 解析层                                     │
│ 从 orderId 位运算提取 routeKey                             │
│ 成功 → 计算分片索引，写入缓存，返回                              │
│ 失败 → 进入 Layer 2                                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 【Layer 2】上下文获取层                                        │
│ 从请求上下文获取 routeKey / region                             │
│ 成功 → 计算分片索引，写入缓存，返回                              │
│ 失败 → 进入 Layer 3                                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│ 【Layer 3】查库兜底层                                         │
│ 查询订单索引表获取渠道字段                                      │
│ 成功 → 计算分片索引，写入缓存，返回                              │
│ 失败 → 返回默认分片（兜底）                                     │
└─────────────────────────────────────────────────────────────┘
</span></code></pre>
<h4 data-id="heading-14">4.2 各层占比（实际数据）</h4>






























<table><thead><tr><th>路由层</th><th>占比</th><th>说明</th></tr></thead><tbody><tr><td><strong>Layer 0（缓存）</strong></td><td>95%+</td><td>绝大部分请求命中缓存</td></tr><tr><td><strong>Layer 1（orderId 解析）</strong></td><td>70-80%</td><td>新订单直接解析</td></tr><tr><td><strong>Layer 2（上下文）</strong></td><td>5-10%</td><td>链路中携带信息</td></tr><tr><td><strong>Layer 3（查库兜底）</strong></td><td>15-25%</td><td>老订单 + 异常情况</td></tr></tbody></table>
<p><strong>目标</strong>：逐步降低 Layer 3 占比，最终 &lt; 5%</p>
<h3 data-id="heading-15">五、核心代码实现</h3>
<h4 data-id="heading-16">5.1 缓存层实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShardingCacheHelper</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">CACHE_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"shard:"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">CACHE_EXPIRE_SECONDS</span> <span class="hljs-operator">=</span> <span class="hljs-number">24</span> * <span class="hljs-number">3600</span>;  <span class="hljs-comment">// 24小时</span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CacheService cacheService;

    <span class="hljs-comment">/**
     * 获取分片索引（带缓存）
     */</span>
    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">getShardIndex</span><span class="hljs-params">(Long orderId)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> CACHE_PREFIX + orderId;

        <span class="hljs-comment">// 1. 先查缓存</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">cachedValue</span> <span class="hljs-operator">=</span> cacheService.get(cacheKey);
        <span class="hljs-keyword">if</span> (StringUtils.isNotEmpty(cachedValue)) {
            <span class="hljs-keyword">return</span> Integer.parseInt(cachedValue);
        }

        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <span class="hljs-comment">// 缓存未命中</span>
    }

    <span class="hljs-comment">/**
     * 写入缓存
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setShardIndex</span><span class="hljs-params">(Long orderId, <span class="hljs-type">int</span> shardIndex)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> CACHE_PREFIX + orderId;
        cacheService.setEx(cacheKey, String.valueOf(shardIndex), CACHE_EXPIRE_SECONDS);
    }
}
</code></pre>
<h4 data-id="heading-17">5.2 分片定位器完整实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShardingRouter</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">SHARD_COUNT</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span>;  <span class="hljs-comment">// 每个渠道的分片数量</span>
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ShardingCacheHelper cacheHelper;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OrderDao orderDao;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ChannelShardConfig channelShardConfig;  <span class="hljs-comment">// 渠道分片配置</span>

    <span class="hljs-comment">/**
     * 定位订单所在分片
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">locate</span><span class="hljs-params">(Long orderId)</span> {
        <span class="hljs-comment">// 【Layer 0】缓存层</span>
        <span class="hljs-type">Integer</span> <span class="hljs-variable">cachedIndex</span> <span class="hljs-operator">=</span> cacheHelper.getShardIndex(orderId);
        <span class="hljs-keyword">if</span> (cachedIndex != <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> cachedIndex;
        }

        <span class="hljs-comment">// 【Layer 1】orderId 解析层</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">routeKey</span> <span class="hljs-operator">=</span> getRouteKey(orderId);
        <span class="hljs-keyword">if</span> (StringUtils.isNotEmpty(routeKey)) {
            <span class="hljs-type">int</span> <span class="hljs-variable">shardIndex</span> <span class="hljs-operator">=</span> calculateShardIndex(routeKey, orderId);
            cacheHelper.setShardIndex(orderId, shardIndex);
            <span class="hljs-keyword">return</span> shardIndex;
        }

        <span class="hljs-comment">// 【Layer 2 &amp; 3】上下文 + 查库兜底</span>
        <span class="hljs-keyword">return</span> fallbackLocate(orderId);
    }

    <span class="hljs-comment">/**
     * 计算分片索引
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">calculateShardIndex</span><span class="hljs-params">(String routeKey, Long orderId)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">baseIndex</span> <span class="hljs-operator">=</span> getBaseIndex(routeKey);
        <span class="hljs-type">int</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>)(orderId % SHARD_COUNT);  <span class="hljs-comment">// 分片数量</span>
        <span class="hljs-keyword">return</span> baseIndex + offset;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getBaseIndex</span><span class="hljs-params">(String routeKey)</span> {
        <span class="hljs-comment">// 不同渠道对应不同的分片基础索引</span>
        <span class="hljs-comment">// 具体映射关系根据业务配置</span>
        <span class="hljs-keyword">return</span> channelShardConfig.getBaseIndex(routeKey);
    }

    <span class="hljs-comment">/**
     * 兜底定位（查库）
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">fallbackLocate</span><span class="hljs-params">(Long orderId)</span> {
        <span class="hljs-comment">// 1. 查询订单索引表</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderDao.queryById(orderId);
        <span class="hljs-keyword">if</span> (order == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> ShardIndex.OTHER.getIndex();  <span class="hljs-comment">// 默认分片</span>
        }

        <span class="hljs-comment">// 2. 根据渠道字段计算分片索引</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> order.getChannel();
        <span class="hljs-type">int</span> <span class="hljs-variable">shardIndex</span> <span class="hljs-operator">=</span> calculateShardIndex(channel, orderId);

        <span class="hljs-comment">// 3. 写入缓存（避免重复查库）</span>
        cacheHelper.setShardIndex(orderId, shardIndex);

        <span class="hljs-keyword">return</span> shardIndex;
    }
}
</code></pre>
<h3 data-id="heading-18">六、踩坑与经验</h3>
<h4 data-id="heading-19">6.1 实际遇到的问题</h4>
<p><strong>问题 1：调用方未传 region 参数</strong></p>
<p><strong>现象</strong>：</p>
<ul>
<li>上线后发现兜底查库比例高达 25%+</li>
<li>监控显示大量订单号解析失败</li>
</ul>
<p><strong>原因</strong>：</p>
<ul>
<li>ID 生成服务升级后，需要调用方传入 region 参数</li>
<li>部分老接口、定时任务、消息消费者未及时改造</li>
<li>生成的订单号中 routeKey 位段为 0，无法解析</li>
</ul>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 在 ID 生成服务增加监控埋点</span>
<span class="hljs-keyword">if</span> (StringUtils.isEmpty(request.getRegion())) {
    <span class="hljs-comment">// 记录调用来源，便于推动改造</span>
    metric(<span class="hljs-string">"id_gen_no_region"</span>, getCallerService());
}

<span class="hljs-comment">// 2. 输出 Top N 未传 region 的服务，逐个推动改造</span>
<span class="hljs-comment">// 3. 设置 deadline，未改造的服务降低优先级</span>
</code></pre>
<p><strong>问题 2：历史订单兼容</strong></p>
<p><strong>现象</strong>：</p>
<ul>
<li>改造前已存在的订单（百万级）无法解析 routeKey</li>
<li>这些订单仍然有查询需求（售后、对账等）</li>
</ul>
<p><strong>解决方案</strong>：</p>
<ul>
<li>设计三层降级策略（见第四章）</li>
<li>历史订单走兜底查库 + 缓存</li>
<li>随着时间推移，历史订单查询占比自然下降</li>
</ul>
<p><strong>问题 3：灰度发布时的数据一致性</strong></p>
<p><strong>现象</strong>：</p>
<ul>
<li>灰度期间，部分机器用新版 ID 生成逻辑，部分用旧版</li>
<li>同一渠道的订单，有的能解析，有的不能</li>
</ul>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 按渠道灰度，而不是按机器灰度</span>
<span class="hljs-comment">// 确保同一渠道的订单要么全部新版，要么全部旧版</span>
<span class="hljs-keyword">if</span> (grayConfig.isNewVersionEnabled(routeKey)) {
    <span class="hljs-keyword">return</span> newIdGenerator.generate(request);
} <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> oldIdGenerator.generate(request);
}
</code></pre>
<h4 data-id="heading-20">6.2 设计权衡</h4>
<p><strong>权衡 1：为什么不用 UUID？</strong></p>























<table><thead><tr><th>方案</th><th>优点</th><th>缺点</th><th>结论</th></tr></thead><tbody><tr><td><strong>UUID</strong></td><td>• 全局唯一<br/>• 无需协调</td><td>• 128 位太长<br/>• 无序，影响 B+ 树性能<br/>• 无法编码业务信息</td><td>❌ 不采用</td></tr><tr><td><strong>Snowflake</strong></td><td>• 64 位紧凑<br/>• 单调递增<br/>• 可编码业务信息</td><td>• 需要协调机器 ID</td><td>✅ <strong>采用</strong></td></tr></tbody></table>
<p><strong>权衡 2：为什么只编码 routeKey？</strong></p>
<p><strong>考虑过的方案</strong>：</p>
<ul>
<li>方案 1：编码更多信息（国家、用户类型、业务线等）</li>
<li>方案 2：只编码最关键的路由信息（routeKey）</li>
</ul>
<p><strong>最终选择方案 2</strong>：</p>
<ul>
<li>64 位空间有限，每增加 1 位编码，序列号就减少 1 位</li>
<li>序列号越少，并发性能越差（同一毫秒内可生成的 ID 数量）</li>
<li>routeKey 是分片路由的唯一依据，优先保证路由性能</li>
<li>其他信息可以通过查询订单索引表获取</li>
</ul>
<p><strong>权衡 3：为什么保留兜底查库？</strong></p>
<p><strong>理想状态</strong>：100% 解析成功，完全不查库</p>
<p><strong>现实情况</strong>：</p>
<ul>
<li>老订单（10-20%）无法避免</li>
<li>老代码升级需要时间（5-10%）</li>
<li>异常情况难以杜绝（1-2%）</li>
</ul>
<p><strong>权衡结果</strong>：</p>
<ul>
<li>✅ 保留兜底查库，确保系统 100% 可用</li>
<li>✅ 通过监控推动解析成功率逐步提升</li>
<li>✅ 目标：Layer 3 占比从 25% → 10% → 5% → 1%</li>
</ul>
<h4 data-id="heading-21">6.3 监控与优化</h4>
<p><strong>关键监控指标</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 记录解析失败的订单号</span>
metricError(<span class="hljs-string">"orderId_decode_failed"</span>, orderId);

<span class="hljs-comment">// 2. 统计各层路由占比</span>
metric(<span class="hljs-string">"route_cache_hit"</span>, count);       <span class="hljs-comment">// 缓存命中</span>
metric(<span class="hljs-string">"route_layer_1"</span>, count);         <span class="hljs-comment">// orderId 解析</span>
metric(<span class="hljs-string">"route_layer_2"</span>, count);         <span class="hljs-comment">// 上下文获取</span>
metric(<span class="hljs-string">"route_layer_3"</span>, count);         <span class="hljs-comment">// 查库兜底</span>

<span class="hljs-comment">// 3. 统计解析失败原因</span>
metric(<span class="hljs-string">"decode_fail_no_region"</span>, count);    <span class="hljs-comment">// 没传 region</span>
metric(<span class="hljs-string">"decode_fail_old_order"</span>, count); <span class="hljs-comment">// 老订单</span>
metric(<span class="hljs-string">"decode_fail_exception"</span>, count); <span class="hljs-comment">// 解析异常</span>
</code></pre>
<p><strong>监控面板示例</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">订单号解析成功率（实时）</span>
<span class="hljs-string">┌────────────────────────────────────────┐</span>
<span class="hljs-string">│</span> <span class="hljs-string">总请求数:</span> <span class="hljs-number">1</span><span class="hljs-string">,000,000</span>                     <span class="hljs-string">│</span>
<span class="hljs-string">│</span> <span class="hljs-string">缓存命中:</span> <span class="hljs-number">950</span><span class="hljs-string">,000</span> <span class="hljs-string">(95%)</span>  <span class="hljs-string">✅</span>             <span class="hljs-string">│</span>
<span class="hljs-string">│</span> <span class="hljs-attr">Layer 1:</span>  <span class="hljs-number">750</span><span class="hljs-string">,000</span> <span class="hljs-string">(75%)</span>  <span class="hljs-string">✅</span>             <span class="hljs-string">│</span>
<span class="hljs-string">│</span> <span class="hljs-attr">Layer 2:</span>   <span class="hljs-number">50</span><span class="hljs-string">,000</span> <span class="hljs-string">(5%)</span>   <span class="hljs-string">✅</span>             <span class="hljs-string">│</span>
<span class="hljs-string">│</span> <span class="hljs-attr">Layer 3:</span>  <span class="hljs-number">200</span><span class="hljs-string">,000</span> <span class="hljs-string">(20%)</span>  <span class="hljs-string">⚠️</span>             <span class="hljs-string">│</span>
<span class="hljs-string">└────────────────────────────────────────┘</span>

<span class="hljs-string">解析失败原因分布</span>
<span class="hljs-string">┌────────────────────────────────────────┐</span>
<span class="hljs-string">│</span> <span class="hljs-string">没传</span> <span class="hljs-attr">region:</span>     <span class="hljs-number">80</span><span class="hljs-string">,000</span> <span class="hljs-string">(8%)</span>   <span class="hljs-string">⬅️</span> <span class="hljs-string">重点优化</span> <span class="hljs-string">│</span>
<span class="hljs-string">│</span> <span class="hljs-string">老订单:</span>      <span class="hljs-number">110</span><span class="hljs-string">,000</span> <span class="hljs-string">(11%)</span>  <span class="hljs-string">⬅️</span> <span class="hljs-string">历史包袱</span> <span class="hljs-string">│</span>
<span class="hljs-string">│</span> <span class="hljs-string">解析异常:</span>     <span class="hljs-number">10</span><span class="hljs-string">,000</span> <span class="hljs-string">(1%)</span>   <span class="hljs-string">⬅️</span> <span class="hljs-string">异常情况</span> <span class="hljs-string">│</span>
<span class="hljs-string">└────────────────────────────────────────┘</span>

<span class="hljs-string">Top</span> <span class="hljs-number">10</span> <span class="hljs-string">未传</span> <span class="hljs-string">region</span> <span class="hljs-string">的服务</span>
<span class="hljs-string">┌────────────────────────────────────────┐</span>
<span class="hljs-string">│</span> <span class="hljs-attr">1. xxx-refund-service:</span>  <span class="hljs-number">25</span><span class="hljs-string">,000</span> <span class="hljs-string">次</span>      <span class="hljs-string">│</span>
<span class="hljs-string">│</span> <span class="hljs-attr">2. xxx-cancel-job:</span>      <span class="hljs-number">18</span><span class="hljs-string">,000</span> <span class="hljs-string">次</span>      <span class="hljs-string">│</span>
<span class="hljs-string">│</span> <span class="hljs-attr">3. xxx-sync-task:</span>       <span class="hljs-number">15</span><span class="hljs-string">,000</span> <span class="hljs-string">次</span>      <span class="hljs-string">│</span>
<span class="hljs-string">│</span> <span class="hljs-string">...</span>                                    <span class="hljs-string">│</span>
<span class="hljs-string">└────────────────────────────────────────┘</span>
</code></pre>
<p><strong>持续优化</strong>：</p>
<ul>
<li><strong>阶段 1</strong>（当前）：识别问题代码，制定迁移计划</li>
<li><strong>阶段 2</strong>（1-3 个月）：逐步升级老代码，Layer 3 占比降到 10%</li>
<li><strong>阶段 3</strong>（3-6 个月）：继续优化，Layer 3 占比降到 5%</li>
<li><strong>阶段 4</strong>（6-12 个月）：最终目标，Layer 3 占比降到 1% 以下</li>
</ul>
<h3 data-id="heading-22">七、总结</h3>
<h4 data-id="heading-23">核心收益</h4>

























<table><thead><tr><th>指标</th><th>优化前</th><th>优化后</th></tr></thead><tbody><tr><td>查询耗时</td><td>数百毫秒</td><td>个位数毫秒</td></tr><tr><td>P99 延迟</td><td>超过 1 秒</td><td>百毫秒以内</td></tr><tr><td>免查库比例</td><td>0%</td><td>95%</td></tr></tbody></table>
<h4 data-id="heading-24">适用场景</h4>
<p><strong>适合</strong>：分库分表系统、有明确路由维度、可控制 ID 生成逻辑</p>
<p><strong>不适合</strong>：小数据量、路由维度频繁变化、使用第三方 ID 服务</p>
<h3 data-id="heading-25">八、参考资料</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftwitter-archive%2Fsnowflake" target="_blank" title="https://github.com/twitter-archive/snowflake" ref="nofollow noopener noreferrer">Snowflake 算法 - Twitter</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftech.meituan.com%2F2017%2F04%2F21%2Fmt-leaf.html" target="_blank" title="https://tech.meituan.com/2017/04/21/mt-leaf.html" ref="nofollow noopener noreferrer">分布式 ID 生成方案 - 美团 Leaf</a></li>
</ul>
<hr/>
<p><strong>Carve_the_Code</strong> - 大型 OTA 平台订单系统开发</p>
<p>欢迎留言交流！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[高性能多级网关与多级缓存架构落地实战(超清完结)]]></title>    <link>https://juejin.cn/post/7577430671947366426</link>    <guid>https://juejin.cn/post/7577430671947366426</guid>    <pubDate>2025-11-28T07:43:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577430671947366426" data-draft-id="7577430671947350042" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="高性能多级网关与多级缓存架构落地实战(超清完结)"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-28T07:43:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="课程xingkeit与top"/> <meta itemprop="url" content="https://juejin.cn/user/1910275039560096"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            高性能多级网关与多级缓存架构落地实战(超清完结)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1910275039560096/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    课程xingkeit与top
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T07:43:07.000Z" title="Fri Nov 28 2025 07:43:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在亿级流量、毫秒级响应、全球化部署成为常态的今天，单点架构早已无法支撑现代互联网系统的性能与可用性要求。面对突发流量洪峰、地域访问延迟、服务雪崩等复杂挑战，<strong>多级网关 + 多级缓存</strong>已成为构建高并发、高可用系统的核心架构范式。</p>
<p>本文将系统性地拆解这一高性能架构从<strong>理论设计、实战落地到生产优化</strong>的完整路径，结合真实业务场景，辅以少量关键代码与配置示例，帮助架构师与高级工程师掌握可复用的工程方法论。</p>
<hr/>
<h3 data-id="heading-0">一、为什么需要“多级”？—— 单点架构的三大瓶颈</h3>
<ol>
<li><strong>性能瓶颈</strong>：单个 Nginx 或 Redis 在高并发下 CPU/内存打满；</li>
<li><strong>容灾薄弱</strong>：任一组件宕机即引发全站不可用；</li>
<li><strong>体验割裂</strong>：海外用户访问国内中心节点，首屏加载超 2 秒。</li>
</ol>
<p>“多级”不是堆砌技术，而是通过<strong>分层卸载、就近处理、冗余容错</strong>，实现性能、可用性与成本的最优平衡。</p>
<hr/>
<h3 data-id="heading-1">二、多级网关：三层流量治理模型</h3>
<h4 data-id="heading-2">1. <strong>L1：边缘网关（Edge Gateway）</strong></h4>
<p>部署于 CDN 边缘（如 Cloudflare、阿里云 EdgeScript），处理静态资源与安全防护：</p>
<pre><code class="hljs language-ini" lang="ini">nginx
编辑
1<span class="hljs-comment"># 示例：边缘缓存静态资源 1 年</span>
2location ~* .(js|css|png|jpg|woff2)$ {
3    expires 1y<span class="hljs-comment">;</span>
4    add_header Cache-Control "public, immutable"<span class="hljs-comment">;</span>
5}
</code></pre>
<ul>
<li>终结 90% 静态请求，不回源；</li>
<li>WAF 规则拦截恶意爬虫；</li>
<li>按用户 IP 自动路由至最近区域中心。</li>
</ul>
<h4 data-id="heading-3">2. <strong>L2：区域网关（Regional Gateway）</strong></h4>
<p>每个可用区部署 Spring Cloud Gateway，负责认证与本地路由：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">yaml</span>
<span class="hljs-string">编辑</span>
<span class="hljs-number">1</span><span class="hljs-comment"># Spring Cloud Gateway 路由配置</span>
<span class="hljs-attr">2spring:</span>
<span class="hljs-attr">3  cloud:</span>
<span class="hljs-attr">4    gateway:</span>
<span class="hljs-attr">5      routes:</span>
<span class="hljs-attr">6        - id:</span> <span class="hljs-string">video-service</span>
<span class="hljs-attr">7          uri:</span> <span class="hljs-string">lb://video-service</span>
<span class="hljs-attr">8          predicates:</span>
<span class="hljs-number">9</span>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/api/video/**</span>
<span class="hljs-attr">10          filters:</span>
<span class="hljs-number">11</span>            <span class="hljs-bullet">-</span> <span class="hljs-string">TokenAuthFilter</span>  <span class="hljs-comment"># 自定义 JWT 校验</span>
</code></pre>
<ul>
<li>区域内服务调用，避免跨区延迟；</li>
<li>熔断限流（集成 Sentinel）；</li>
<li>注入 TraceID，支持全链路追踪。</li>
</ul>
<h4 data-id="heading-4">3. <strong>L3：核心网关（BFF Gateway）</strong></h4>
<p>聚合多个微服务接口，为前端提供定制化数据：</p>
<pre><code class="hljs language-ini" lang="ini">java
编辑
1// BFF 聚合示例
2public VideoDetailDTO getVideoDetail(Long videoId) {
3    VideoMeta <span class="hljs-attr">meta</span> = videoService.getMeta(videoId)<span class="hljs-comment">;</span>
4    List&lt;Comment&gt; <span class="hljs-attr">comments</span> = commentService.getTopComments(videoId)<span class="hljs-comment">;</span>
5    boolean <span class="hljs-attr">liked</span> = likeService.isLiked(currentUser(), videoId)<span class="hljs-comment">;</span>
6    return new VideoDetailDTO(meta, comments, liked)<span class="hljs-comment">;</span>
7}
</code></pre>
<blockquote>
<p>✅ 优势：前端只需一次请求，后端并行调用，降低交互次数。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">三、多级缓存：三层加速体系</h3>
<h4 data-id="heading-6">1. <strong>L1：本地缓存（Caffeine）—— 纳秒级响应</strong></h4>
<p>适用于高频读、低变更数据（如字典、配置）：</p>
<pre><code class="hljs language-scss" lang="scss">java
编辑
<span class="hljs-number">1</span>LoadingCache&lt;String, <span class="hljs-selector-tag">Object</span>&gt; localCache = Caffeine<span class="hljs-selector-class">.newBuilder</span>()
<span class="hljs-number">2</span>    <span class="hljs-selector-class">.maximumSize</span>(<span class="hljs-number">1000</span>)
<span class="hljs-number">3</span>    <span class="hljs-selector-class">.expireAfterWrite</span>(<span class="hljs-number">10</span>, TimeUnit.MINUTES)
<span class="hljs-number">4</span>    <span class="hljs-selector-class">.build</span>(key -&gt; loadFromRedis(key));
</code></pre>
<ul>
<li>零网络开销，访问速度达纳秒级；</li>
<li>需配合主动失效机制（如监听 Redis Pub/Sub）。</li>
</ul>
<h4 data-id="heading-7">2. <strong>L2：分布式缓存（Redis Cluster）—— 毫秒级共享</strong></h4>
<p>存储用户会话、视频元数据、排行榜等：</p>
<pre><code class="hljs language-python" lang="python">bash
编辑
<span class="hljs-number">1</span><span class="hljs-comment"># Redis Sorted Set 存储弹幕（按播放时间排序）</span>
2ZADD danmaku:video_123 <span class="hljs-number">15.234</span> <span class="hljs-string">"{"</span>text<span class="hljs-string">":"</span><span class="hljs-number">666</span><span class="hljs-string">","</span>colo<span class="hljs-string">r":"</span><span class="hljs-comment">#ff0000"}"</span>
</code></pre>
<ul>
<li>支持高吞吐、持久化、主从高可用；</li>
<li>关键：合理设置 TTL，避免缓存雪崩。</li>
</ul>
<h4 data-id="heading-8">3. <strong>L3：持久层缓存（Elasticsearch / ClickHouse）</strong></h4>
<p>用于复杂查询结果缓存，避免重复计算：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">sql</span>
编辑
<span class="hljs-number">1</span><span class="hljs-comment">-- ClickHouse 物化视图预聚合日活</span>
<span class="hljs-number">2</span><span class="hljs-keyword">CREATE</span> MATERIALIZED <span class="hljs-keyword">VIEW</span> daily_active_user
<span class="hljs-number">3</span>ENGINE <span class="hljs-operator">=</span> AggregatingMergeTree()
<span class="hljs-number">4</span><span class="hljs-keyword">AS</span> <span class="hljs-keyword">SELECT</span> toDate(event_time) <span class="hljs-keyword">AS</span> <span class="hljs-keyword">day</span>, uniqState(user_id) <span class="hljs-keyword">AS</span> uv
<span class="hljs-number">5</span><span class="hljs-keyword">FROM</span> user_events <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">day</span>;
</code></pre>
<hr/>
<h3 data-id="heading-9">四、网关与缓存的深度协同</h3>
<ul>
<li><strong>边缘网关 + 浏览器缓存</strong>：静态资源使用 <code>immutable</code> + 文件哈希，实现高效更新；</li>
<li><strong>区域网关 + 本地缓存</strong>：认证后预加载用户基本信息至 Caffeine；</li>
<li><strong>核心网关 + Redis</strong>：BFF 接口优先查 Redis，命中则直接返回；</li>
<li><strong>缓存穿透防护</strong>：网关层拦截非法 ID（如 <code>id=-1</code>），结合布隆过滤器提前过滤。</li>
</ul>
<hr/>
<h3 data-id="heading-10">五、生产部署与可观测性</h3>
<h4 data-id="heading-11">1. <strong>容器化部署</strong></h4>
<p>使用 Docker Compose 编排核心组件：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">yaml</span>
<span class="hljs-string">编辑</span>
<span class="hljs-attr">1services:</span>
<span class="hljs-attr">2  regional-gateway:</span>
<span class="hljs-attr">3    image:</span> <span class="hljs-string">gateway:latest</span>
<span class="hljs-attr">4    ports:</span> [<span class="hljs-string">"8080:8080"</span>]
<span class="hljs-attr">5    environment:</span>
<span class="hljs-number">6</span>      <span class="hljs-bullet">-</span> <span class="hljs-string">SPRING_PROFILES_ACTIVE=prod</span>
<span class="hljs-attr">7  redis-cluster:</span>
<span class="hljs-attr">8    image:</span> <span class="hljs-string">redis:7</span>
<span class="hljs-attr">9    command:</span> [<span class="hljs-string">"redis-server"</span>, <span class="hljs-string">"--cluster-enabled"</span>, <span class="hljs-string">"yes"</span>]
</code></pre>
<h4 data-id="heading-12">2. <strong>全链路监控</strong></h4>
<ul>
<li>Prometheus 采集指标：QPS、延迟、缓存命中率；</li>
<li>Grafana 可视化仪表盘；</li>
<li>ELK 收集日志，支持关键词告警。</li>
</ul>
<h4 data-id="heading-13">3. <strong>混沌工程验证</strong></h4>
<p>定期模拟 Redis 宕机、网关过载，验证系统是否具备：</p>
<ul>
<li>自动切换（哨兵/Cluster）</li>
<li>优雅降级（返回兜底数据）</li>
<li>快速恢复（自动重启 + 健康检查）</li>
</ul>
<hr/>
<h3 data-id="heading-14">六、优化技巧总结</h3>





























<table><thead><tr><th>场景</th><th>技巧</th></tr></thead><tbody><tr><td><strong>缓存雪崩</strong></td><td>设置随机 TTL（如基础值 ± 10%）</td></tr><tr><td><strong>缓存穿透</strong></td><td>布隆过滤器 + 空值缓存（TTL 短）</td></tr><tr><td><strong>热点 Key</strong></td><td>本地缓存 + 多副本分散压力</td></tr><tr><td><strong>大 Value</strong></td><td>压缩存储（如 Snappy）或拆分为多个 Key</td></tr><tr><td><strong>网关性能</strong></td><td>异步非阻塞（Reactor 模型）、连接池复用</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-15">七、结语：架构即取舍，多级即平衡</h3>
<p>多级网关与多级缓存并非“银弹”，其成功依赖三大原则：</p>
<ol>
<li><strong>按需分层</strong>：小型系统可能只需一级；</li>
<li><strong>一致性分级</strong>：明确哪些数据可容忍短暂不一致；</li>
<li><strong>运维先行</strong>：架构越复杂，对监控、告警、自愈能力要求越高。</li>
</ol>
<p>掌握这套从理论到部署的完整方法论，你便拥有了构建下一代高可用系统的“架构罗盘”。<br/>
<strong>超清完结，但探索不止——这不仅是一个方案的终点，更是你驾驭亿级流量的新起点。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot2 仿B站高性能前端+后端项目(完结)]]></title>    <link>https://juejin.cn/post/7577438119558332467</link>    <guid>https://juejin.cn/post/7577438119558332467</guid>    <pubDate>2025-11-28T07:34:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577438119558332467" data-draft-id="7577438119558316083" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot2 仿B站高性能前端+后端项目(完结)"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-28T07:34:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="课程xingkeit与top"/> <meta itemprop="url" content="https://juejin.cn/user/1910275039560096"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot2 仿B站高性能前端+后端项目(完结)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1910275039560096/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    课程xingkeit与top
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T07:34:41.000Z" title="Fri Nov 28 2025 07:34:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在全栈开发能力日益成为工程师核心竞争力的今天，一个贴近真实业务、涵盖高并发与强交互场景的综合性项目，无疑是技术成长的最佳载体。Bilibili（B站）作为集视频播放、弹幕互动、社区社交于一体的复杂平台，其产品形态和技术挑战极具代表性。</p>
<p>本文将系统梳理一个基于 <strong>Spring Boot 2 + Vue 3</strong> 的仿 B 站项目，从<strong>需求分析、架构设计、核心功能实现到部署上线</strong>的完整闭环。全文以工程实践为导向，辅以少量关键代码片段，帮助开发者理解“如何把想法变成可运行、可维护、可扩展的产品”。</p>
<hr/>
<h3 data-id="heading-0">一、需求拆解：聚焦 MVP 核心体验</h3>
<p>项目初期明确最小可行产品（MVP）范围，避免过度设计：</p>
<ul>
<li>用户注册/登录（含 JWT 鉴权）</li>
<li>视频上传、转码、多清晰度播放</li>
<li>实时弹幕互动</li>
<li>点赞、投币、收藏、评论</li>
<li>首页推荐 + 分区浏览 + 搜索</li>
<li>个人中心与 UP 主主页</li>
</ul>
<p>这些模块覆盖了内容生产、消费、互动三大核心链路，构成完整的用户闭环。</p>
<hr/>
<h3 data-id="heading-1">二、整体架构：前后端分离 + 模块化设计</h3>
<p>后端采用 Spring Boot 2，整合主流中间件；前端基于 Vue 3 + TypeScript + Vite 构建 SPA。虽未完全微服务化，但按业务域划分为清晰模块：</p>
<pre><code class="hljs language-arduino" lang="arduino">text
编辑
<span class="hljs-number">1b</span>ackend/
<span class="hljs-number">2</span>├── user-service      <span class="hljs-comment">// 用户中心</span>
<span class="hljs-number">3</span>├── video-service     <span class="hljs-comment">// 视频管理</span>
<span class="hljs-number">4</span>├── interact-service  <span class="hljs-comment">// 互动行为</span>
<span class="hljs-number">5</span>├── search-service    <span class="hljs-comment">// 搜索与推荐</span>
<span class="hljs-number">6</span>└── gateway           <span class="hljs-comment">// 统一网关（路由 + 认证）</span>
<span class="hljs-number">7</span>
<span class="hljs-number">8f</span>rontend/
<span class="hljs-number">9</span>├── views/
<span class="hljs-number">10</span>│   ├── Home.vue
<span class="hljs-number">11</span>│   ├── VideoDetail.vue
<span class="hljs-number">12</span>│   └── UserCenter.vue
<span class="hljs-number">13</span>├── api/              <span class="hljs-comment">// 接口封装</span>
<span class="hljs-number">14</span>└── store/            <span class="hljs-comment">// Pinia 状态管理</span>
</code></pre>
<p>这种结构便于团队协作，也为未来演进预留空间。</p>
<hr/>
<h3 data-id="heading-2">三、关键功能实现逻辑（附少量代码）</h3>
<h4 data-id="heading-3">1. <strong>JWT 无状态认证</strong></h4>
<p>后端生成 Token，前端拦截器自动携带：</p>
<pre><code class="hljs language-scss" lang="scss">java
编辑
<span class="hljs-number">1</span><span class="hljs-comment">// 后端：生成 Token</span>
<span class="hljs-number">2S</span>tring token = Jwts<span class="hljs-selector-class">.builder</span>()
<span class="hljs-number">3</span>    <span class="hljs-selector-class">.setSubject</span>(userId.toString())
<span class="hljs-number">4</span>    <span class="hljs-selector-class">.setExpiration</span>(new Date(System.currentTimeMillis() + <span class="hljs-number">86400000</span>))
<span class="hljs-number">5</span>    <span class="hljs-selector-class">.signWith</span>(SignatureAlgorithm.HS512, "secret-key")
<span class="hljs-number">6</span>    <span class="hljs-selector-class">.compact</span>();
</code></pre>
<pre><code class="hljs language-ini" lang="ini">javascript
编辑
1// 前端 Axios 拦截器
2axios.interceptors.request.use(<span class="hljs-attr">config</span> =&gt; {
3  const <span class="hljs-attr">token</span> = localStorage.getItem(<span class="hljs-string">'token'</span>)<span class="hljs-comment">;</span>
4  if (token) <span class="hljs-attr">config.headers.Authorization</span> = `Bearer <span class="hljs-variable">${token}</span>`<span class="hljs-comment">;</span>
5  return config<span class="hljs-comment">;</span>
6})<span class="hljs-comment">;</span>
</code></pre>
<blockquote>
<p>✅ 优势：无 Session 状态，天然支持水平扩展。</p>
</blockquote>
<h4 data-id="heading-4">2. <strong>分片上传 + 断点续传</strong></h4>
<p>前端计算文件 hash，按 5MB 分片上传：</p>
<pre><code class="hljs language-ini" lang="ini">javascript
编辑
1const <span class="hljs-attr">chunkSize</span> = <span class="hljs-number">5</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span><span class="hljs-comment">;</span>
2for (let <span class="hljs-attr">start</span> = <span class="hljs-number">0</span><span class="hljs-comment">; start &lt; file.size; start += chunkSize) {</span>
3  const <span class="hljs-attr">chunk</span> = file.slice(start, start + chunkSize)<span class="hljs-comment">;</span>
4  await uploadChunk(chunk, index++, fileHash)<span class="hljs-comment">;</span>
5}
</code></pre>
<p>后端合并分片并触发异步转码任务（通过 RabbitMQ 解耦）。</p>
<h4 data-id="heading-5">3. <strong>实时弹幕（WebSocket + Redis）</strong></h4>
<p>后端使用 <code>@ServerEndpoint</code> 建立连接，弹幕存入 Redis Sorted Set（按视频时间戳排序）：</p>
<pre><code class="hljs language-csharp" lang="csharp">java
编辑
<span class="hljs-number">1</span><span class="hljs-comment">// 弹幕存储：videoId 为 key，time 为 score</span>
<span class="hljs-number">2</span>redisTemplate.opsForZSet().<span class="hljs-keyword">add</span>(<span class="hljs-string">"danmaku:"</span> + videoId, danmakuJson, playTime);
</code></pre>
<p>前端通过 WebSocket 接收并渲染，确保低延迟展示。</p>
<h4 data-id="heading-6">4. <strong>互动操作的乐观更新</strong></h4>
<p>用户点击“点赞”后，前端立即更新 UI 并发送请求：</p>
<pre><code class="hljs language-ini" lang="ini">javascript
编辑
1// 前端乐观更新
2video.likeCount++<span class="hljs-comment">;</span>
<span class="hljs-attr">3video.liked</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
4
5// 发送请求，失败则回滚
6api.like(video.id).catch(() =&gt; {
7  video.likeCount--<span class="hljs-comment">;</span>
8  <span class="hljs-attr">video.liked</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
9})<span class="hljs-comment">;</span>
</code></pre>
<p>后端采用 Redis 计数器 + 异步持久化，保障高性能。</p>
<hr/>
<h3 data-id="heading-7">四、性能与体验优化</h3>
<ul>
<li><strong>多级缓存</strong>：Caffeine（本地） + Redis（分布式） + 浏览器缓存；</li>
<li><strong>静态资源 CDN</strong>：JS/CSS/图片部署至 CDN，视频通过对象存储 + CDN 加速；</li>
<li><strong>接口聚合</strong>：核心网关提供 BFF 接口，减少前端多次请求；</li>
<li><strong>虚拟滚动</strong>：长评论列表仅渲染可视区域，提升流畅度。</li>
</ul>
<hr/>
<h3 data-id="heading-8">五、部署与运维：从本地到生产</h3>
<ul>
<li><strong>容器化</strong>：Docker 打包 Spring Boot 应用与 Vue 前端；</li>
<li><strong>编排</strong>：docker-compose 管理 MySQL、Redis、RabbitMQ、Nginx；</li>
<li><strong>CI/CD</strong>：Git 提交 → Jenkins 自动构建 → 镜像推送 → 容器重启；</li>
<li><strong>监控</strong>：Prometheus + Grafana 监控 JVM、HTTP 延迟、队列堆积。</li>
</ul>
<p>Nginx 配置示例（反向代理 + 静态资源）：</p>
<pre><code class="hljs language-bash" lang="bash">nginx
编辑
1location /api {
2    proxy_pass http://backend:8080;
3}
4
5location / {
6    root /usr/share/nginx/html;
7    try_files <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /index.html;
8}
</code></pre>
<hr/>
<h3 data-id="heading-9">六、总结：全栈不仅是“会写”，更是“会想”</h3>
<p>这个仿 B 站项目的价值，远不止于复刻一个视频平台。它训练的是<strong>端到端的系统思维</strong>：</p>
<ul>
<li>如何设计一个既安全又易用的 API？</li>
<li>如何在保证数据一致性的同时提升用户体验？</li>
<li>如何让前后端在高速迭代中保持同步而不互相阻塞？</li>
</ul>
<p>真正的全栈工程师，不是前后端都会写，而是<strong>理解数据如何流动、用户如何感知、系统如何演进</strong>。</p>
<hr/>
<p><strong>结语</strong><br/>
项目完结，但成长不止。从一行需求到线上服务，每一步都是工程能力的锤炼。收藏本文，不仅是收藏一个实战案例，更是收藏一套从想法到产品的完整方法论——这，才是开发者最宝贵的资产。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vite联邦实现微前端（vite-plugin-federation）]]></title>    <link>https://juejin.cn/post/7577563004481470518</link>    <guid>https://juejin.cn/post/7577563004481470518</guid>    <pubDate>2025-11-28T07:18:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577563004481470518" data-draft-id="7577411657393094698" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vite联邦实现微前端（vite-plugin-federation）"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-11-28T07:18:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不努力也不会混"/> <meta itemprop="url" content="https://juejin.cn/user/1869583715670808"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vite联邦实现微前端（vite-plugin-federation）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1869583715670808/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不努力也不会混
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T07:18:15.000Z" title="Fri Nov 28 2025 07:18:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">使用<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Foriginjs%2Fvite-plugin-federation" target="_blank" title="https://github.com/originjs/vite-plugin-federation" ref="nofollow noopener noreferrer">vite-plugin-federation</a>实现微前端的搭建开发</h2>
<h3 data-id="heading-1">使用背景</h3>
<blockquote>
<p>老板说了，项目比较大，不好维护要拆分成多个子项目，这样每次维护发包时候及时报错了也不会影响其他的项目(我现在用的是microapp，因为之前他们用的iframe拆分了，只有弹框问题不好解决，用microapp改造下是最快的，插件那块microapp嵌套报错用了联邦实现了)。</p>
</blockquote>
<p>注意：联邦搭建微前端适合新项目，如果已经有用iframe拆分实现微前端过的老项目还是用microapp比较好，啥都不用改直接引入就能实现微前端。</p>
<ul>
<li>官方描述的是去中心画，我还是按照老板现在想法实现1+n+n，</li>
</ul>
<ol>
<li>1个框架（登录，接口封装，layout布局等）只要搭建好基本上不会在改的（新开项目这个也直接能拿去用）</li>
<li>n个应用（大屏，多个后台管理模块）就是改动相对较少的</li>
<li>n个插件（要给不同客户部署，他们都会提自己需求，例如大屏的某块展示，客户不提我们就展示默认的，客户提了就渲染他们个性化的内容）</li>
</ol>
<h3 data-id="heading-2">使用方法</h3>
<ol>
<li>首先创建两个项目：base，运营管理 全是vite+vue3 <code>pnpm create vue</code></li>
<li>安装联邦<code>pnpm add @originjs/vite-plugin-federation --save-dev</code></li>
<li>官方使用方法</li>
<li>
<div>base项目可以dev启动，运营管理必须build之后用preview预览</div>
</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// vite.config.js 运营管理</span>
<span class="hljs-keyword">import</span> federation <span class="hljs-keyword">from</span> <span class="hljs-string">"@originjs/vite-plugin-federation"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    <span class="hljs-attr">plugins</span>: [
        <span class="hljs-title function_">federation</span>({
            <span class="hljs-attr">name</span>: <span class="hljs-string">'remote-app'</span>,
            <span class="hljs-attr">filename</span>: <span class="hljs-string">'remoteEntry.js'</span>,
            <span class="hljs-comment">// Modules to expose</span>
            <span class="hljs-attr">exposes</span>: {
                <span class="hljs-string">'./Button'</span>: <span class="hljs-string">'./src/Button.vue'</span>,
            },
            <span class="hljs-attr">shared</span>: [<span class="hljs-string">'vue'</span>]
        })
    ]
}
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// vite.config.js base项目</span>
<span class="hljs-keyword">import</span> federation <span class="hljs-keyword">from</span> <span class="hljs-string">"@originjs/vite-plugin-federation"</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    <span class="hljs-attr">plugins</span>: [
        <span class="hljs-title function_">federation</span>({
            <span class="hljs-attr">name</span>: <span class="hljs-string">'host-app'</span>,
            <span class="hljs-attr">remotes</span>: {
                <span class="hljs-attr">remote_app</span>: <span class="hljs-string">"http://localhost:5001/assets/remoteEntry.js"</span>,
            },
            <span class="hljs-attr">shared</span>: [<span class="hljs-string">'vue'</span>]
        })
    ]
}
</code></pre>
<pre><code class="hljs language-vue" lang="vue">// 页面使用
const RemoteButton = defineAsyncComponent(() =&gt; import("remote_app/Button"));
&lt;template&gt;
    &lt;div&gt;
        &lt;RemoteButton /&gt;
    &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-3">推荐使用方法（超级坑：他们中文文档没有介绍，找了好久发现写在了英文文档的最下面）</h3>
<p>用上面这个方法，在做定制化时候，不好用，例如后台配置个性化接口时候，前端自动通过接口展示对应的个性化。所以需要有个能够动态加载组件方法。</p>
<p>运营管理那块导出不用修改，base的导入方式需要修改下</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// vite.config.js base项目</span>
<span class="hljs-title function_">federation</span>({
  <span class="hljs-attr">remotes</span>:{
    <span class="hljs-string">"None"</span>: <span class="hljs-string">""</span> <span class="hljs-comment">//这个不加就报错，他们issues里找到的别人的解决办法</span>
  },
  <span class="hljs-attr">shared</span>: [<span class="hljs-string">'vue'</span>, <span class="hljs-string">'pinia'</span>, <span class="hljs-string">'vue-router'</span>],
}),

</code></pre>
<p>先定一个公共的util方法获取动态组件和方法</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//util.ts</span>
<span class="hljs-keyword">import</span> {
  __federation_method_getRemote <span class="hljs-keyword">as</span> getRemote,
  __federation_method_setRemote <span class="hljs-keyword">as</span> setRemote,
  __federation_method_unwrapDefault <span class="hljs-keyword">as</span> unwrap,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'virtual:__federation__'</span>

interface <span class="hljs-title class_">RemoteOptions</span> {
  <span class="hljs-attr">url</span>: string
  <span class="hljs-attr">moduleName</span>: string,
  type?: <span class="hljs-string">'ts'</span> | <span class="hljs-string">'component'</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getRemoteComponent = <span class="hljs-keyword">async</span> (<span class="hljs-attr">options</span>: <span class="hljs-title class_">RemoteOptions</span>): <span class="hljs-title class_">Promise</span>&lt;any&gt; =&gt; {
  <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> { url, moduleName, type = <span class="hljs-string">'component'</span> } = options
      <span class="hljs-keyword">const</span> remoteName = <span class="hljs-string">`remote_<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random().toString(<span class="hljs-number">36</span>).slice(<span class="hljs-number">2</span>)}</span>`</span>
      <span class="hljs-comment">// 1. 注册 remote 信息</span>
      <span class="hljs-title function_">setRemote</span>(remoteName, {
        <span class="hljs-attr">url</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(url),
        <span class="hljs-attr">format</span>: <span class="hljs-string">'esm'</span>,
        <span class="hljs-attr">from</span>: <span class="hljs-string">'vite'</span>,
      })

      <span class="hljs-comment">// 2. 加载模块</span>
      <span class="hljs-keyword">const</span> mod = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getRemote</span>(remoteName, <span class="hljs-string">`./<span class="hljs-subst">${moduleName}</span>`</span>)
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'======'</span>, type)
      <span class="hljs-keyword">if</span>(type === <span class="hljs-string">'ts'</span>) <span class="hljs-keyword">return</span> mod
      <span class="hljs-comment">// 3. 解包模块</span>
      <span class="hljs-keyword">const</span> <span class="hljs-title class_">Comp</span> = <span class="hljs-keyword">await</span> <span class="hljs-title function_">unwrap</span>(mod)

      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Comp</span>
  } <span class="hljs-keyword">catch</span> (error) {

  }
}

</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//使用导出的方法</span>
<span class="hljs-keyword">const</span> util = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getRemoteComponent</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">'http://localhost:20001/assets/remoteEntry.js'</span>, 
    <span class="hljs-attr">moduleName</span>: <span class="hljs-string">'Util'</span>,
    <span class="hljs-attr">type</span>: <span class="hljs-string">'ts'</span>
})
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'util'</span>, util?.<span class="hljs-title function_">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>))
<span class="hljs-comment">//引入组件</span>
<span class="hljs-keyword">const</span> remoteButton = <span class="hljs-title function_">getRemoteComponent</span>({
  <span class="hljs-attr">url</span>: <span class="hljs-string">'http://localhost:5001/assets/remoteEntry.js'</span>,
  <span class="hljs-attr">moduleName</span>: <span class="hljs-string">"Button"</span>
})
&lt;template&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 具有深层异步依赖的组件 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">remoteButton</span> /&gt;</span>

  <span class="hljs-comment">&lt;!-- 在 #fallback 插槽中显示 “正在加载中” --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">fallback</span>&gt;</span>
    Loading...
  <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span>
&lt;/template&gt;
</code></pre>
<p>这样就可以通过base里面设置动态路由来加载不同子项目的组件了</p>
<h3 data-id="heading-4">我的示例</h3>
<h4 data-id="heading-5">base项目内容</h4>
<ol>
<li>登录页面</li>
<li>layout布局</li>
<li>获取用户菜单动态加载菜单路由</li>
<li>一些他自己的页面，用户管理，角色管理等</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//模拟的用户菜单</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getMenuList</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">resolve</span>([
        {
          <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
          <span class="hljs-attr">title</span>:<span class="hljs-string">'运营管理'</span>,
          <span class="hljs-attr">children</span>:[
            {
              <span class="hljs-attr">id</span>: <span class="hljs-number">11</span>,
              <span class="hljs-attr">title</span>:<span class="hljs-string">'车辆管理'</span>,
              <span class="hljs-attr">name</span>: <span class="hljs-string">'CarManage'</span>,
              <span class="hljs-attr">path</span>: <span class="hljs-string">'/business/CarManage'</span>,
              <span class="hljs-attr">component</span>: <span class="hljs-string">'CarManage'</span>,
              <span class="hljs-attr">source</span>: <span class="hljs-string">'http://localhost:20001/assets/remoteEntry.js'</span>
            },
            {
              <span class="hljs-attr">id</span>: <span class="hljs-number">12</span>,
              <span class="hljs-attr">title</span>:<span class="hljs-string">'车辆详情'</span>,
              <span class="hljs-attr">name</span>: <span class="hljs-string">'CarDetail'</span>,
              <span class="hljs-attr">path</span>: <span class="hljs-string">'/business/CarDetail'</span>,
              <span class="hljs-attr">component</span>: <span class="hljs-string">'CarDetail'</span>,
              <span class="hljs-attr">source</span>: <span class="hljs-string">'http://localhost:20001/assets/remoteEntry.js'</span>
            }
          ]
        },
        {
          <span class="hljs-attr">id</span>: <span class="hljs-number">2</span>,
          <span class="hljs-attr">title</span>:<span class="hljs-string">'用户管理'</span>,
          <span class="hljs-attr">children</span>:[
            {
              <span class="hljs-attr">id</span>: <span class="hljs-number">21</span>,
              <span class="hljs-attr">title</span>:<span class="hljs-string">'用户列表'</span>,
              <span class="hljs-attr">name</span>: <span class="hljs-string">'UserList'</span>,
              <span class="hljs-attr">path</span>: <span class="hljs-string">'/user/UserList'</span>,
              <span class="hljs-attr">component</span>: <span class="hljs-string">'/user/UserListView'</span>,
            },
            {
              <span class="hljs-attr">id</span>: <span class="hljs-number">22</span>,
              <span class="hljs-attr">title</span>:<span class="hljs-string">'用户角色'</span>,
              <span class="hljs-attr">name</span>: <span class="hljs-string">'UserRole'</span>,
              <span class="hljs-attr">path</span>: <span class="hljs-string">'/user/UserRole'</span>,
              <span class="hljs-attr">component</span>: <span class="hljs-string">'/user/UserRoleView'</span>,
            }
          ]
        }
      ])
    }, <span class="hljs-number">1000</span>)
  })
}
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 动态加载组件（支持本地和远程组件）
 */</span>
<span class="hljs-keyword">const</span> modules = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-title function_">glob</span>(<span class="hljs-string">"../views/**/*.vue"</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadDynamicComponent</span>(<span class="hljs-params">menu: MenuType</span>) {
  <span class="hljs-keyword">if</span> (menu.<span class="hljs-property">source</span> &amp;&amp; menu.<span class="hljs-property">component</span>) {
    <span class="hljs-comment">// 远程组件加载</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">getRemoteComponent</span>({
      <span class="hljs-attr">url</span>: menu.<span class="hljs-property">source</span> <span class="hljs-keyword">as</span> string,
      <span class="hljs-attr">moduleName</span>: menu.<span class="hljs-property">component</span>
    })
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (menu.<span class="hljs-property">component</span>) {
    <span class="hljs-comment">// 本地组件加载 - 使用 import.meta.glob</span>
    <span class="hljs-keyword">let</span> <span class="hljs-attr">componentPath</span>: string

    <span class="hljs-keyword">if</span> (menu.<span class="hljs-property">component</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'/'</span>)) {
      <span class="hljs-comment">// 如果是路径格式 (如 /user/UserList)，转换为相对路径</span>
      componentPath = <span class="hljs-string">`../views<span class="hljs-subst">${menu.component}</span>.vue`</span>
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 如果是组件名格式 (如 UserList)，添加路径前缀</span>
      componentPath = <span class="hljs-string">`../views/<span class="hljs-subst">${menu.component}</span>.vue`</span>
    }

    <span class="hljs-keyword">const</span> moduleLoader = modules[componentPath]

    <span class="hljs-keyword">if</span> (moduleLoader) {
      <span class="hljs-keyword">return</span> moduleLoader
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`组件未找到: <span class="hljs-subst">${componentPath}</span>，可用组件:`</span>, <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(modules))
      <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>({
        <span class="hljs-attr">template</span>: <span class="hljs-string">'&lt;div&gt;组件未找到&lt;/div&gt;'</span>
      })
    }
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>
}
</code></pre>
<h4 data-id="heading-6">运营管理内容</h4>
<p>只需要把要导出的东西都导出就行</p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> remoteExport = {
  <span class="hljs-title class_">CarManage</span>: <span class="hljs-string">'src/views/CarManage/CarManage.vue'</span>,
  <span class="hljs-title class_">CarDetail</span>: <span class="hljs-string">'src/views/CarManage/CarDetail.vue'</span>,
  <span class="hljs-title class_">Util</span>: <span class="hljs-string">'src/utils/index.ts'</span>
}
<span class="hljs-comment">// vite.config.ts</span>
<span class="hljs-title function_">federation</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'remote-business'</span>,
  <span class="hljs-attr">filename</span>: <span class="hljs-string">'remoteEntry.js'</span>,
  <span class="hljs-attr">exposes</span>: <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">fromEntries</span>(
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(remoteExport).<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> [<span class="hljs-string">`./<span class="hljs-subst">${key}</span>`</span>, value])
  ),
  <span class="hljs-attr">shared</span>: [<span class="hljs-string">'vue'</span>, <span class="hljs-string">'pinia'</span>, <span class="hljs-string">'vue-router'</span>]
}),
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d5b01249cea42128eaf5e8a7ee97e7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5Yqq5Yqb5Lmf5LiN5Lya5re3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764919094&amp;x-signature=4BHl%2F1ROu1Wl68ZH%2BjZVj8TNMNI%3D" alt="image.png" loading="lazy"/></p>
<p>到现在已经实现了微前端了</p>
<h3 data-id="heading-7">开发时候的优化</h3>
<p>现在子项目必须build之后才能生成remoteEntry，也就没办法热更新。</p>
<p>可以使用通知，base项目全局刷新，实现伪热更新效果</p>
<p>参考下下面的插件</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Options</span> {
  <span class="hljs-attr">role</span>: <span class="hljs-string">'remote'</span> | <span class="hljs-string">'host'</span>;
  host?: <span class="hljs-built_in">string</span>;
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">syncReloadPlugin</span>(<span class="hljs-params">options: Options</span>) {
  <span class="hljs-keyword">const</span> role = options.<span class="hljs-property">role</span>;
  <span class="hljs-keyword">const</span> hostUrl = options.<span class="hljs-property">host</span>;

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'vite-plugin-sync-reload'</span>,

    <span class="hljs-title function_">apply</span>(<span class="hljs-params">config: <span class="hljs-built_in">any</span>, { command }: <span class="hljs-built_in">any</span></span>) {
      <span class="hljs-keyword">if</span> (role !== <span class="hljs-string">'remote'</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'dev'</span>;
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Boolean</span>(command === <span class="hljs-string">'build'</span> &amp;&amp; config.<span class="hljs-property">build</span>?.<span class="hljs-property">watch</span>);
    },

    <span class="hljs-keyword">async</span> <span class="hljs-title function_">buildEnd</span>(<span class="hljs-params">error: <span class="hljs-built_in">any</span></span>) {
      <span class="hljs-keyword">if</span> (role !== <span class="hljs-string">'remote'</span>) <span class="hljs-keyword">return</span>;
      <span class="hljs-keyword">if</span> (error) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">${hostUrl}</span>/__fullReload`</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[remote] 已通知 host 刷新`</span>);
      } <span class="hljs-keyword">catch</span> (e) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[remote] 通知 host 失败（可能 host 未启动）`</span>);
      }
    },

    <span class="hljs-title function_">configureServer</span>(<span class="hljs-params">server: <span class="hljs-built_in">any</span></span>) {

      <span class="hljs-keyword">if</span> (role !== <span class="hljs-string">'host'</span>) <span class="hljs-keyword">return</span>;

      server.<span class="hljs-property">middlewares</span>.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req: <span class="hljs-built_in">any</span>, res: <span class="hljs-built_in">any</span>, next: <span class="hljs-built_in">any</span></span>) =&gt;</span> {

          <span class="hljs-comment">// remote build 后会访问这里</span>
          <span class="hljs-keyword">if</span> (req.<span class="hljs-property">url</span> === <span class="hljs-string">'/__fullReload'</span>) {

            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'[host] 收到 remote 通知，即将刷新页面'</span>);

            <span class="hljs-comment">// 触发浏览器刷新</span>
            <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span>{
              server.<span class="hljs-property">hot</span>.<span class="hljs-title function_">send</span>({
                <span class="hljs-attr">type</span>: <span class="hljs-string">'full-reload'</span>
              });
            },<span class="hljs-number">100</span>)

            res.<span class="hljs-title function_">end</span>(<span class="hljs-string">'Full reload triggered'</span>);
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-title function_">next</span>(); <span class="hljs-comment">// 继续下一个中间件</span>
          }
        });
    }
  };
}

<span class="hljs-title function_">syncReloadPlugin</span>({ <span class="hljs-attr">role</span>: <span class="hljs-string">'host'</span> }),
<span class="hljs-title function_">syncReloadPlugin</span>({
  <span class="hljs-attr">role</span>: <span class="hljs-string">'remote'</span>,
  <span class="hljs-attr">host</span>: <span class="hljs-string">'http://localhost:20000'</span>
})
</code></pre>
<h3 data-id="heading-8">我的示例代码</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F5563%2Ffederation-microapp" target="_blank" title="https://github.com/5563/federation-microapp" ref="nofollow noopener noreferrer">一个联邦实现微前端的示例代码</a> : <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F5563%2Ffederation-microapp" target="_blank" title="https://github.com/5563/federation-microapp" ref="nofollow noopener noreferrer">github.com/5563/federa…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[搭建简易版monorepo + turborepo]]></title>    <link>https://juejin.cn/post/7577298871005364258</link>    <guid>https://juejin.cn/post/7577298871005364258</guid>    <pubDate>2025-11-28T07:24:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577298871005364258" data-draft-id="7577378514401706019" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="搭建简易版monorepo + turborepo"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-28T07:24:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="凡人程序员"/> <meta itemprop="url" content="https://juejin.cn/user/3237375877059565"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            搭建简易版monorepo + turborepo
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3237375877059565/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    凡人程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T07:24:00.000Z" title="Fri Nov 28 2025 07:24:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<ul>
<li>项目结构：pnpm Monorepo</li>
</ul>

<ul>
<li>
<ul>
<li><code>packages/ui</code>：React 组件库（使用 Vite + TS 打包）</li>
<li><code>apps/react-demo</code>：React 应用，依赖 <code>@my-org/ui</code></li>
</ul>
</li>
</ul>

<ul>
<li>目标：</li>
</ul>

<ul>
<li>
<ul>
<li>✅ 开发环境：修改 <code>ui</code> 源码 → 自动热更新到 <code>react-demo</code></li>
<li>✅ 生产构建：<code>react-demo</code> 能正确打包 <code>@my-org/ui</code></li>
</ul>
</li>
</ul>
<h2 data-id="heading-1">遇到的问题 &amp; 解决方案</h2>
<h2 data-id="heading-2">❌ 问题 1：生产构建时报错 —— <code>@my-org/ui</code> 无法解析</h2>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 错误信息</span>
[vite]: Rolldown failed to resolve <span class="hljs-keyword">import</span> <span class="hljs-string">"@my-org/ui"</span> ...
</code></pre>
<h3 data-id="heading-3">🔎 根本原因：</h3>
<ul>
<li><code>react-demo</code> 的 <code>node_modules/@my-org/ui/</code> 中 <strong>没有</strong> ****<code>dist/ </code>****<strong>目录</strong></li>
<li>导致 Vite 找不到 JS 入口文件（如 <code>ui.js</code>）</li>
</ul>
<h3 data-id="heading-4">✅ 解决步骤：</h3>
<ol>
<li><strong>确认</strong> ****<code>packages/ui/package.json</code> ****<strong>包含</strong> ****<code>"files": ["dist"]</code><br/>
→ 否则 pnpm 不会把 <code>dist</code> 链接到 consumer 的 <code>node_modules</code></li>
<li><strong>先构建 UI 库</strong></li>
</ol>
<pre><code class="hljs language-css" lang="css">
pnpm <span class="hljs-attr">--filter</span> <span class="hljs-keyword">@my-org</span>/ui build
</code></pre>
<ol start="3">
<li><strong>确保</strong> ****<code>react-demo</code> ****<strong>声明了依赖</strong></li>
</ol>
<pre><code class="hljs language-sql" lang="sql">
pnpm <span class="hljs-keyword">add</span> <span class="hljs-variable">@my</span><span class="hljs-operator">-</span>org<span class="hljs-operator">/</span>ui<span class="hljs-variable">@workspace</span>:<span class="hljs-operator">*</span> <span class="hljs-comment">--filter react-demo</span>
</code></pre>
<ol start="4">
<li><strong>强制刷新链接</strong></li>
</ol>
<pre><code class="hljs language-css" lang="css">
pnpm install <span class="hljs-attr">--force</span>
</code></pre>
<p>💡 关键认知：<strong>pnpm workspace 链接 ≠ 实时目录映射</strong>，它只链接 <code>package.json</code> 中声明的文件（通过 <code>files</code>），且需在 <code>dist</code> 存在后执行 <code>install</code>。</p>
<h2 data-id="heading-5">❌ 问题 2：<code>package.json</code> 入口文件名与实际输出不一致</h2>
<ul>
<li>配置写的是：</li>
</ul>
<pre><code class="hljs language-json" lang="json">
<span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist/index.js"</span>
</code></pre>
<ul>
<li>但 Vite 默认输出：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">
dist/ui.js
dist/ui.mjs
</code></pre>
<h3 data-id="heading-6">🔎 后果：</h3>
<ul>
<li>即使 <code>dist</code> 被链接，Vite 仍尝试加载不存在的 <code>index.js</code> → 模块解析失败</li>
</ul>
<h3 data-id="heading-7">✅ 解决方案（二选一）：</h3>

















<table><thead><tr><th>方案</th><th>操作</th></tr></thead><tbody><tr><td><strong>A（推荐）</strong></td><td>修改 <code>package.json</code>指向真实文件： <code>"main": "./dist/ui.js"</code></td></tr><tr><td><strong>B</strong></td><td>修改 <code>vite.config.ts</code>强制输出 <code>index.js</code>： <code>fileName: (format) =&gt; </code>index.${format === 'es' ? 'mjs' : 'js'}``</td></tr></tbody></table>
<p>✅ 最终选择 <strong>方案 A</strong>，避免改构建配置，更简单直接。</p>
<h2 data-id="heading-8">❌ 问题 3：即使 <code>files</code> 正确，<code>dist</code> 仍不出现</h2>
<p>运行 <code>pnpm install --force</code> 后，<code>node_modules/@my-org/ui/dist</code> 依然不存在。</p>
<h3 data-id="heading-9">🔎 深层原因：</h3>
<ul>
<li><code>react-demo/package.json</code> <strong>未声明对</strong> ****<code>@my-org/ui</code> ****<strong>的依赖</strong></li>
<li>pnpm <strong>不会自动链接未声明的 workspace 包</strong></li>
</ul>
<h3 data-id="heading-10">✅ 解决：</h3>
<pre><code class="hljs language-sql" lang="sql">
pnpm <span class="hljs-keyword">add</span> <span class="hljs-variable">@my</span><span class="hljs-operator">-</span>org<span class="hljs-operator">/</span>ui<span class="hljs-variable">@workspace</span>:<span class="hljs-operator">*</span> <span class="hljs-comment">--filter react-demo</span>
</code></pre>
<p>→ 显式建立依赖关系，pnpm 才会创建 symlink 并包含 <code>dist/</code>。</p>
<p>📌 这是 Monorepo 的核心规则： <strong>“未声明 = 不存在”</strong></p>
<h2 data-id="heading-11">✅ 问题 4：开发环境如何实现热更新？</h2>
<p>生产构建成功后，需支持开发时实时编辑 <code>ui</code> 组件。</p>
<h3 data-id="heading-12">✅ 解决方案：</h3>
<ol>
<li><strong>在</strong> ****<code>react-demo/vite.config.ts</code> ****<strong>中添加 alias</strong>：</li>
</ol>
<pre><code class="hljs language-css" lang="css">
resolve: {
  alias: {
    '<span class="hljs-keyword">@my-org</span>/ui': path.resolve(__dirname, <span class="hljs-string">'../../packages/ui/src'</span>)
  }
}
</code></pre>
<ol start="2">
<li><strong>启动开发服务器</strong>：</li>
</ol>
<pre><code class="hljs language-css" lang="css">
pnpm <span class="hljs-attr">--filter</span> react-demo dev
</code></pre>
<p>💡 原理：Vite 直接编译 <code>ui/src</code> 源码（而非 <code>dist</code>），天然支持 HMR 和 TSX。</p>
<hr/>
<h2 data-id="heading-13">🧪 验证清单（最终状态）</h2>



































<table><thead><tr><th>检查项</th><th>命令</th><th>预期结果</th></tr></thead><tbody><tr><td>UI 库已构建</td><td><code>ls packages/ui/dist</code></td><td>有 <code>ui.js</code>, <code>ui.mjs</code>, <code>*.d.ts</code></td></tr><tr><td>依赖已声明</td><td><code>grep "@my-org/ui" apps/react-demo/package.json</code></td><td>有 <code>"@my-org/ui": "workspace:*"</code></td></tr><tr><td>链接已同步</td><td><code>ls apps/react-demo/node_modules/@my-org/ui/dist</code></td><td>文件存在</td></tr><tr><td>生产构建成功</td><td><code>pnpm --filter react-demo build</code></td><td>无报错，生成 <code>dist/</code></td></tr><tr><td>开发热更新</td><td>修改 <code>ui/src/Button.tsx</code>→ 浏览器自动刷新</td><td>✅ 实时生效</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-14">📚 经验总结</h2>

























<table><thead><tr><th>场景</th><th>关键配置</th></tr></thead><tbody><tr><td><strong>生产构建</strong></td><td><code>package.json</code>的 <code>main</code>/<code>module</code>必须匹配真实文件名 + <code>"files": ["dist"]</code></td></tr><tr><td><strong>依赖链接</strong></td><td>Consumer 必须在 <code>package.json</code>中显式声明 <code>workspace:*</code>依赖</td></tr><tr><td><strong>开发体验</strong></td><td>通过 Vite <code>alias</code>指向 <code>src</code>，绕过 <code>dist</code>，实现 HMR</td></tr><tr><td><strong>构建顺序</strong></td><td>先 <code>build ui</code>→ 再 <code>pnpm install</code>→ 最后 <code>build app</code></td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Uptime Kuma修改作为内嵌页面的自适应]]></title>    <link>https://juejin.cn/post/7577294037717909538</link>    <guid>https://juejin.cn/post/7577294037717909538</guid>    <pubDate>2025-11-28T06:05:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577294037717909538" data-draft-id="7577284968923627520" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Uptime Kuma修改作为内嵌页面的自适应"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-28T06:05:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="伍亿伍千万"/> <meta itemprop="url" content="https://juejin.cn/user/3651901500169884"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Uptime Kuma修改作为内嵌页面的自适应
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3651901500169884/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    伍亿伍千万
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T06:05:05.000Z" title="Fri Nov 28 2025 06:05:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="http://openwrite.cn/uploads/19960/56785/d9298a17-80c5-4259-8024-6ecef5b8c0ea.png" alt="8bd3c9d3a7ce456aa6cdd4d140de4d67.png" loading="lazy"/></p>
<pre><code class="hljs language-html" lang="html">/* ==================================
1. 基础样式重置（消除默认边距/溢出）
================================== */
/* 重置 html/body 默认边距，禁止页面自身滚动（由 iframe 控制滚动） */
html,
body {
  margin: 0;
  padding: 0;
  overflow: hidden;
}


/* ==================================
2. iframe 适配核心样式（页面缩放逻辑）
================================== */
/* 页面最外层容器缩放配置（适配 iframe 大小）
   注：若实际外层容器不是 .app，需替换为真实类名（如 .container、.status-page 等） */
.app {
  /* 1. 基准尺寸（需根据页面实际设计稿调整，此处为示例值） */
  width: 1000px;  /* 页面理想宽度（基准） */
  height: 600px;  /* 页面理想高度（基准） */
  margin: 0 auto; /* 可选：让容器水平居中（若 iframe 宽度大于基准宽度时生效） */

  /* 2. 按 iframe 宽度自动缩放（核心适配逻辑） */
  transform-origin: top left; /* 缩放原点：左上角（避免缩放偏移） */
  transform: scale(calc(100vw / 1000)); /* 缩放比例 = iframe 宽度 ÷ 基准宽度 */

  /* 3. 同步缩放高度（保证页面比例不变形） */
  height: calc(600 * (100vw / 1000) * 1px);
}


/* ==================================
3. 元素隐藏（按需隐藏指定标签/容器）
================================== */
/* 隐藏所有 h1 标签（全局） */
h1 {
  display: none !important;
}

/* 隐藏含“服务”文本的目标 h2 标签（精准匹配 data-v 属性和类名） */
h2.group-title[data-v-f71ca08e] {
  display: none !important;
}

/* 隐藏指定 alert 容器（匹配 data-v 属性和类名） */
div.alert-heading.p-2[data-v-b8247e57] {
  display: none !important;
}

/* 隐藏页面底部 footer 区域（全局） */
footer {
  display: none !important;
}


/* ==================================
4. 间距调整（覆盖默认 padding/margin）
================================== */
/* 清除 .p-4 类的所有内边距（上下左右均为 0） */
.p-4 {
  padding: 0 !important;
}

/* 清除 .mb-4 类的底部外边距（设为 0） */
.mb-4 {
  margin-bottom: 0 !important;
}

/* 调整 .mt-4 类的顶部外边距（从 1.5rem 改为 0.5rem） */
.mt-4 {
  margin-top: 0.5rem !important;
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MCP理论和实战，然后做个MCP脚手架吧]]></title>    <link>https://juejin.cn/post/7577461079598055443</link>    <guid>https://juejin.cn/post/7577461079598055443</guid>    <pubDate>2025-11-28T07:42:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577461079598055443" data-draft-id="7577461079597940755" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MCP理论和实战，然后做个MCP脚手架吧"/> <meta itemprop="keywords" content="前端,MCP,Node.js"/> <meta itemprop="datePublished" content="2025-11-28T07:42:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="疯狂踩坑人"/> <meta itemprop="url" content="https://juejin.cn/user/1011206430698574"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MCP理论和实战，然后做个MCP脚手架吧
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1011206430698574/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    疯狂踩坑人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T07:42:00.000Z" title="Fri Nov 28 2025 07:42:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>引言:  本文介绍了目前MCP Server的开发方式和原理，包括streamable HTTP和STDIO两种。并提供了一个npm脚手架工具帮你创建项目，每个模板项目都是可运行的。</p>
</blockquote>
<h2 data-id="heading-0">streamable HTTP</h2>
<h3 data-id="heading-1">原理分析</h3>
<h4 data-id="heading-2">抓包「握手」</h4>
<p>MCP Client总共发了三次请求，MCP Server响应2次。实际的握手流程是4次握手，第5次请求是为了通知后续的信息（比如进度，日志等。 目前规范实现来看，第5次握手不影响正常功能）</p>
<p>使用<code>wiresshark</code>抓包结果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/062da5b0a9fa41b1aa37038f0b9b2c25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764920520&amp;x-signature=FcUNFYf9H2TEZ9ACI4D7GoG4lp4%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eea2aecc794d4e738caa3175ffc0a78b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764920520&amp;x-signature=dhqJ6uz5suXZf4RNVb20XCknWao%3D" alt="image.png" loading="lazy"/></p>
<p>从官网的「initialization」流程来看，也就是4次（第5次未来应该会被普遍实现）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b8856cf742f4926a58a2cbfe8ef0b32~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764920520&amp;x-signature=pdqDqQREOaxHG4PgjxFbLBTVBUI%3D" alt="image.png" loading="lazy"/></p>
<p><strong>第1次</strong> Post请求，<code>initialize</code> 方法</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"initialize"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-06-18"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"capabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"sampling"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"elicitation"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"roots"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"listChanged"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"clientInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"inspector-client"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.17.2"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>第2次</strong> ：200 OK，响应体如下</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-06-18"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"capabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"listChanged"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"serverInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"weather"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"0.0.1"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>第3次</strong> ：Post请求，<code>notifications/initialized</code>方法</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"notifications/initialized"</span><span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>第4次</strong> ：202 Accepted，无响应体</p>
<p><strong>第5次</strong> ：Get请求，此时要求服务端一定是SSE传输了-<code>accept: text/event-stream</code></p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">GET</span> /mcp HTTP/<span class="hljs-number">1.1</span>
<span class="hljs-symbol">accept:</span> <span class="hljs-keyword">text</span>/<span class="hljs-keyword">event</span>-stream
</code></pre>
<h4 data-id="heading-3">总结「握手」流程</h4>
<ol>
<li>
<p><strong>POST /mcp (initialize)</strong></p>
<ul>
<li>客户端：你好，我是 Inspector Client，我想初始化。</li>
<li>服务器：收到，这是我的能力列表（200 OK）。</li>
<li>状态：JSON-RPC 会话开始。</li>
</ul>
</li>
<li>
<p><strong>POST /mcp (notifications/initialized)</strong></p>
<ul>
<li>客户端：我已经收到你的能力了，初始化完成。</li>
<li>服务器：收到 (202 Accepted)。</li>
<li>状态：逻辑握手完成。</li>
</ul>
</li>
<li>
<p><strong>GET /mcp (Header: accept: text/event-stream)</strong></p>
<ul>
<li><strong>目的</strong>：客户端现在试图建立<strong>长连接通道</strong>，以便在未来能收到服务器发来的通知（比如 notifications/message 或 roots/listChanged）。如果没有这个通道，服务器就变成了“哑巴”，无法主动联系客户端。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-4">后续通信</h4>
<h5 data-id="heading-5">tools/list (列出工具)</h5>
<p><strong>client-&gt;server 请求</strong></p>
<p>请求头：</p>
<pre><code class="hljs language-http" lang="http">POST /mcp HTTP/1.1
accept: application/json, text/event-stream
accept-encoding: gzip, deflate, br
content-length: 85
content-type: application/json
mcp-protocol-version: 2025-06-18
user-agent: node-fetch
Host: localhost:3000
Connection: keep-alive
</code></pre>
<p>请求数据：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tools/list"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"_meta"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"progressToken"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>P.S. <code>params</code>中的<code>progressToken</code>是可以用于后续的进度通知的（通过SSE）</p>
<p><strong>server-&gt;client 响应</strong></p>
<p>响应头：</p>
<pre><code class="hljs language-http" lang="http">HTTP/1.1 200 OK
X-Powered-By: Express
Content-Type: application/json
Date: Thu, 27 Nov 2025 11:52:31 GMT
Connection: keep-alive
Keep-Alive: timeout=5
Transfer-Encoding: chunked
</code></pre>
<p>响应体：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"get_weather_now"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Get Weather Now"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Get current weather for a location (city name)"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"inputSchema"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"$schema"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"http://json-schema.org/draft-07/schema#"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"object"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"location"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
              <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Location name or city (e.g. beijing, shanghai, new york, tokyo)"</span><span class="hljs-punctuation">,</span>
              <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span>
            <span class="hljs-punctuation">}</span>
          <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
            <span class="hljs-string">"location"</span>
          <span class="hljs-punctuation">]</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这里列出一个工具：</p>
<ul>
<li><code>get_weather_now</code>，我们自己定义/注册的工具。我们可以拿到它的<code>title</code>，<code>description</code>和<code>inputSchema</code>，这些语义信息可以帮助LLM理解这个工具。</li>
</ul>
<h5 data-id="heading-6">tools/call (调用tool)</h5>
<p>这里通过 mcp inspector 工具调用了<code>get_weather_now</code>，请求体如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tools/call"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"_meta"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"progressToken"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"get_weather_now"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"location"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"北京"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>响应体：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Weather for 北京, CN:\nCondition: 晴\nTemperature: 3°C\nLast Update: 2025-11-27T19:50:14+08:00"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-7">方法小总结</h5>
<p>上面我们列出了两种常见的方法</p>
<ul>
<li><code>tools/list</code>。MCP Client在向LLM发请求携带列出的tool，LLM会告诉客户端调用的tool name，然后由MCP client来触发tool调用。</li>
<li><code>tools/call</code>。MCP Client告诉MCP Server 调用哪个tool。</li>
</ul>
<p>可以结合官网的这张示意图，调用tool就是一次request/response。如果是长任务，可以通过<code>_meta.progressToken</code>作为关联，通过SSE持续通知进度（还记得「握手」流程的第5次握手吗）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b405223577d459a88ed0224fae26823~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764920520&amp;x-signature=8xuD9HU4MNNXfBcgP9QQBVvzcH0%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-8">代码实战 - 天气工具</h3>
<h4 data-id="heading-9">准备天气API</h4>
<p>这里我使用了<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.seniverse.com%2F" target="_blank" title="https://www.seniverse.com/" ref="nofollow noopener noreferrer">心知天气</a>的API，然后自己封装一个node API。
<code>src/core/seniverse.ts</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> crypto <span class="hljs-keyword">from</span> <span class="hljs-string">'node:crypto'</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> querystring <span class="hljs-keyword">from</span> <span class="hljs-string">'node:querystring'</span>;
<span class="hljs-comment">/**
 * 查询天气接口
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">API_URL</span> = <span class="hljs-string">'https://api.seniverse.com/v3/'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SeniverseApi</span> {
    publicKey;
    secretKey;
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">publicKey, secretKey</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">publicKey</span> = publicKey;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">secretKey</span> = secretKey;
    }
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">getWeatherNow</span>(<span class="hljs-params">location</span>) {
        <span class="hljs-keyword">const</span> params = {
            <span class="hljs-attr">ts</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() / <span class="hljs-number">1000</span>), <span class="hljs-comment">// Current timestamp (seconds)</span>
            <span class="hljs-attr">ttl</span>: <span class="hljs-number">300</span>, <span class="hljs-comment">// Expiration time</span>
            <span class="hljs-attr">public_key</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">publicKey</span>,
            <span class="hljs-attr">location</span>: location
        };
        <span class="hljs-comment">// Step 2: Sort keys and construct the string for signature</span>
        <span class="hljs-comment">// "key=value" joined by "&amp;", sorted by key</span>
        <span class="hljs-keyword">const</span> sortedKeys = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(params).<span class="hljs-title function_">sort</span>();
        <span class="hljs-keyword">const</span> str = sortedKeys.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">key</span> =&gt;</span> <span class="hljs-string">`<span class="hljs-subst">${key}</span>=<span class="hljs-subst">${params[key]}</span>`</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">'&amp;'</span>);
        <span class="hljs-comment">// Step 3: HMAC-SHA1 signature</span>
        <span class="hljs-keyword">const</span> signature = crypto
            .<span class="hljs-title function_">createHmac</span>(<span class="hljs-string">'sha1'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">secretKey</span>)
            .<span class="hljs-title function_">update</span>(str)
            .<span class="hljs-title function_">digest</span>(<span class="hljs-string">'base64'</span>);
        <span class="hljs-comment">// Step 4 &amp; 5: Add sig to params and encode for URL</span>
        <span class="hljs-comment">// querystring.encode will handle URL encoding of the signature and other params</span>
        params.<span class="hljs-property">sig</span> = signature;
        <span class="hljs-keyword">const</span> queryString = querystring.<span class="hljs-title function_">encode</span>(params);
        <span class="hljs-keyword">const</span> url = <span class="hljs-string">`<span class="hljs-subst">${API_URL}</span>weather/now.json?<span class="hljs-subst">${queryString}</span>`</span>;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url);
            <span class="hljs-keyword">if</span> (!response.<span class="hljs-property">ok</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`HTTP error! status: <span class="hljs-subst">${response.status}</span>`</span>);
            }
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
        }
        <span class="hljs-keyword">catch</span> (error) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Error making Seniverse request:"</span>, error);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }
    }
}
</code></pre>
<p><code>src/core/index.ts</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">SeniverseApi</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./seniverse.js'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> seniverseApi = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SeniverseApi</span>(
  process.<span class="hljs-property">env</span>.<span class="hljs-property">SENIVERSE_PUBLIC_KEY</span> || <span class="hljs-string">''</span>,
  process.<span class="hljs-property">env</span>.<span class="hljs-property">SENIVERSE_SECRET_KEY</span> || <span class="hljs-string">''</span>,
);
</code></pre>
<h4 data-id="heading-10">搭建streamable HTTP类型的MCP</h4>
<p>1.使用<code>express</code>提供后端服务，然后设置<code>/mcp</code> endpoint（一般来说MCP client默认就是访问这个endpoint）.
2.在MCP协议中，握手/工具调用等都是通过这个一个endpoint来完成的。</p>
<p>3.封装逻辑
封装了一个<code>MyServer</code>类</p>
<ul>
<li><code>run</code>方法启动HTTP服务</li>
<li><code>init</code>方法注册工具</li>
</ul>
<p>4.核心是<code>McpServer</code>和<code>StreamableHTTPServerTransport</code>两个API</p>
<ul>
<li><code>McpServer</code>： 负责注册tool.</li>
<li><code>StreamableHTTPServerTransport</code>： 接管了<code>/mcp</code> endpoint的通信逻辑</li>
</ul>
<pre><code class="hljs language-json" lang="json">import <span class="hljs-punctuation">{</span> McpServer <span class="hljs-punctuation">}</span> from <span class="hljs-string">"@modelcontextprotocol/sdk/server/mcp.js"</span>;
import <span class="hljs-punctuation">{</span> StreamableHTTPServerTransport <span class="hljs-punctuation">}</span> from <span class="hljs-string">"@modelcontextprotocol/sdk/server/streamableHttp.js"</span>;
import express from <span class="hljs-string">"express"</span>;
import <span class="hljs-punctuation">{</span> z <span class="hljs-punctuation">}</span> from <span class="hljs-string">"zod"</span>;
import <span class="hljs-string">"dotenv/config"</span>;
import <span class="hljs-punctuation">{</span> seniverseApi <span class="hljs-punctuation">}</span> from <span class="hljs-string">"./core/index.js"</span>;

export class MyServer <span class="hljs-punctuation">{</span>
  private mcpServer<span class="hljs-punctuation">:</span> McpServer;
  private app<span class="hljs-punctuation">:</span> express.Express
  constructor() <span class="hljs-punctuation">{</span>
    this.mcpServer = new McpServer(<span class="hljs-punctuation">{</span>
      name<span class="hljs-punctuation">:</span> <span class="hljs-string">"weather"</span><span class="hljs-punctuation">,</span>
      version<span class="hljs-punctuation">:</span> <span class="hljs-string">"0.0.1"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">}</span>);

    <span class="hljs-comment">// Set up Express and HTTP transport</span>
    this.app = express();
    this.app.use(express.json());

    this.app.use('/mcp'<span class="hljs-punctuation">,</span> async (req<span class="hljs-punctuation">:</span> express.Request<span class="hljs-punctuation">,</span> res<span class="hljs-punctuation">:</span> express.Response) =&gt; <span class="hljs-punctuation">{</span>
        <span class="hljs-comment">// Create a new transport for each request to prevent request ID collisions</span>
        const transport = new StreamableHTTPServerTransport(<span class="hljs-punctuation">{</span>
            sessionIdGenerator<span class="hljs-punctuation">:</span> undefined<span class="hljs-punctuation">,</span>
            enableJsonResponse<span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
        <span class="hljs-punctuation">}</span>);

        res.on('close'<span class="hljs-punctuation">,</span> () =&gt; <span class="hljs-punctuation">{</span>
            transport.close();
        <span class="hljs-punctuation">}</span>);

        await this.mcpServer.connect(transport);
        await transport.handleRequest(req<span class="hljs-punctuation">,</span> res<span class="hljs-punctuation">,</span> req.body);
    <span class="hljs-punctuation">}</span>);

  <span class="hljs-punctuation">}</span>

  <span class="hljs-comment">/**
   * 在端口运行Server, 通过HTTP stream传输数据
   */</span>
  async run()<span class="hljs-punctuation">:</span> Promise&lt;void&gt; <span class="hljs-punctuation">{</span>
    const port = parseInt(process.env.PORT || '<span class="hljs-number">3000</span>');
    this.app.listen(port<span class="hljs-punctuation">,</span> () =&gt; <span class="hljs-punctuation">{</span>
        console.log(`Demo MCP Server running on http<span class="hljs-punctuation">:</span><span class="hljs-comment">//localhost:${port}/mcp`);</span>
    <span class="hljs-punctuation">}</span>).on('error'<span class="hljs-punctuation">,</span> error =&gt; <span class="hljs-punctuation">{</span>
        console.error('Server error<span class="hljs-punctuation">:</span>'<span class="hljs-punctuation">,</span> error);
        process.exit(<span class="hljs-number">1</span>);
    <span class="hljs-punctuation">}</span>);
    
  <span class="hljs-punctuation">}</span>

  <span class="hljs-comment">/**
   * 初始化，注册工具
   */</span>
  async init()<span class="hljs-punctuation">:</span> Promise&lt;void&gt; <span class="hljs-punctuation">{</span>
    <span class="hljs-comment">// Register weather tool</span>
    this.mcpServer.registerTool(
      <span class="hljs-string">"get_weather_now"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        title<span class="hljs-punctuation">:</span> <span class="hljs-string">"Get Weather Now"</span><span class="hljs-punctuation">,</span>
        description<span class="hljs-punctuation">:</span> <span class="hljs-string">"Get current weather for a location (city name)"</span><span class="hljs-punctuation">,</span>
        inputSchema<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
          location<span class="hljs-punctuation">:</span> z.string().describe(<span class="hljs-string">"Location name or city (e.g. beijing, shanghai, new york, tokyo)"</span>)
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      async (<span class="hljs-punctuation">{</span> location <span class="hljs-punctuation">}</span>) =&gt; <span class="hljs-punctuation">{</span>
        
        const weatherData = await seniverseApi.getWeatherNow(location);
        if (!weatherData || !weatherData.results || weatherData.results.length === <span class="hljs-number">0</span>) <span class="hljs-punctuation">{</span>
          return <span class="hljs-punctuation">{</span>
            content<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
              <span class="hljs-punctuation">{</span>
                type<span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>
                text<span class="hljs-punctuation">:</span> `Failed to retrieve weather data for location<span class="hljs-punctuation">:</span> $<span class="hljs-punctuation">{</span>location<span class="hljs-punctuation">}</span>. Please check the location name and try again.`<span class="hljs-punctuation">,</span>
              <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
          <span class="hljs-punctuation">}</span>;
        <span class="hljs-punctuation">}</span>

        const result = weatherData.results<span class="hljs-punctuation">[</span><span class="hljs-number">0</span><span class="hljs-punctuation">]</span>;
        const weatherText = `Weather for $<span class="hljs-punctuation">{</span>result.location.name<span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span> $<span class="hljs-punctuation">{</span>result.location.country<span class="hljs-punctuation">}</span><span class="hljs-punctuation">:</span>\n` +
                            `Condition<span class="hljs-punctuation">:</span> $<span class="hljs-punctuation">{</span>result.now.text<span class="hljs-punctuation">}</span>\n` +
                            `Temperature<span class="hljs-punctuation">:</span> $<span class="hljs-punctuation">{</span>result.now.temperature<span class="hljs-punctuation">}</span>°C\n` +
                            `Last Update<span class="hljs-punctuation">:</span> $<span class="hljs-punctuation">{</span>result.last_update<span class="hljs-punctuation">}</span>`;
        return <span class="hljs-punctuation">{</span>
          content<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
            <span class="hljs-punctuation">{</span>
              type<span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>
              text<span class="hljs-punctuation">:</span> weatherText<span class="hljs-punctuation">,</span>
            <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
        <span class="hljs-punctuation">}</span>;
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    );
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>效果如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c1dc8ceb9ec40ed88b23abbcf3cbe8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764920520&amp;x-signature=kB563xB3UNi%2FYV8vgmILjmPnIto%3D" alt="image.png" loading="lazy"/></p>
<p>注意左侧侧边栏：</p>
<ul>
<li>Transport Type选择<code>Streamable HTTP</code></li>
<li>URL 填写你的express 服务地址和endpoint。</li>
</ul>
<h2 data-id="heading-11">stdio</h2>
<h3 data-id="heading-12">原理分析</h3>
<p>我在项目中，通过监听<code>process.stdin</code>，查看通信Message</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 监听 stdin 输入，可以在inspector面板的"notifications/message"中看到（作为debug用）</span>
    process.<span class="hljs-property">stdin</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">"data"</span>, <span class="hljs-keyword">async</span> (data) =&gt; {
      <span class="hljs-keyword">const</span> input = data.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">trim</span>();
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(input);
    });
</code></pre>
<p>通过<code>mcp-inspector</code>工具就可以观察到通信信息了，往下看👁</p>
<p><code>tools/list</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03c3662dbeca4b2497d2dc409e1f4800~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764920520&amp;x-signature=HweaG98Bbk0GCpR7RcUfYAeHdMo%3D" alt="image.png" loading="lazy"/></p>
<p><code>tools/call</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a76cddae7bc241f1b5962cec39dbefb8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764920520&amp;x-signature=FfQgmUV4ZGHcPKaZh9rejWYagq4%3D" alt="image.png" loading="lazy"/></p>
<p>结合官网的<code>stdio</code>通信原理图</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa8e88a4187e40d083e70a067b8aef40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764920520&amp;x-signature=ZFWgTteVrgQu2A6u%2FY3ZcYGAjMY%3D" alt="image.png" loading="lazy"/></p>
<p>可以总结如下：</p>
<ul>
<li>连接一个stdio MCP服务，不同于streamable HTTP MCP服务需要进行「握手」，只要开启一个子进程（subprocess），就表示连接成功。</li>
<li>后续的通信的信息格式遵循<code>json-rpc:2.0</code>，通过读写<code>process.stdin</code>和<code>process.stdout</code>完成通信。</li>
</ul>
<h3 data-id="heading-13">代码实战 - 统计文件数</h3>
<p>比较简单，可以参考我的这篇博客 <a href="https://juejin.cn/post/7576482238461001770" target="_blank" title="https://juejin.cn/post/7576482238461001770">Node写MCP入门教程</a>，基于<code>StdioServerTransport</code>实现的统计目录下文件夹的MCP Server，并且介绍了<code>mcp inspector</code>的调试和Trae安装使用。</p>
<h2 data-id="heading-14">创建MCP项目的脚手架</h2>
<p>每次写个新MCP Server都要搭建项目模板，这种重复的工作当然该做成工具辣！
我自己写了一个<code>create-mcp</code>脚手架 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffkcaikengren%2Fcreate-mcp" target="_blank" title="https://github.com/fkcaikengren/create-mcp" ref="nofollow noopener noreferrer">Github</a>。<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2F%40caikengren-cli%2Fcreate-mcp" target="_blank" title="https://www.npmjs.com/package/@caikengren-cli/create-mcp" ref="nofollow noopener noreferrer">create-mcp</a> cli工具已经发布在npm上了，可以npm安装使用。</p>
<h3 data-id="heading-15">cli 原理</h3>
<p>1.脚手架原理，首先准备两个模板项目</p>
<ul>
<li><code>template-stdio</code> 模板</li>
<li><code>template-streamable</code> 模板</li>
</ul>
<p>2.然后用Node写一个cli工具，使用了以下依赖，通过命令行交互的方式创建项目</p>
<pre><code class="hljs language-bash" lang="bash">pnpm i minimist prompts fs-extra chalk
</code></pre>
<p>3.根据你选择的项目名称和模板，帮你拷贝模板，修改为你的「项目名称」</p>
<p>觉得这个cli项目不错的话，给个免费的star吧~  👉  <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffkcaikengren%2Fcreate-mcp" target="_blank" title="https://github.com/fkcaikengren/create-mcp" ref="nofollow noopener noreferrer">Github</a></p>
<h3 data-id="heading-16">使用 cli</h3>
<p>使用<code>@caikengren-cli/create-mcp</code>创建项目</p>
<pre><code class="hljs language-bash" lang="bash">npx @caikengren-cli/create-mcp
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10a36b6fd13f411da881200c3d5aabeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55av54uC6Lip5Z2R5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764920520&amp;x-signature=P90Jfb0v9dheVQkHCeWYnEeDkNM%3D" alt="image.png" loading="lazy"/></p>
<p>然后依次分别运行下面两个命令</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编译ts/运行node</span>
pnpm dev

<span class="hljs-comment"># 打开 mcp-inspector工具调试</span>
pnpm inspect
</code></pre>
<h2 data-id="heading-17">参考</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fspecification%2F2025-11-25" target="_blank" title="https://modelcontextprotocol.io/specification/2025-11-25" ref="nofollow noopener noreferrer">mcp官网</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.info%2Fzh-tw%2F" target="_blank" title="https://modelcontextprotocol.info/zh-tw/" ref="nofollow noopener noreferrer">mcp中文网</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmodelcontextprotocol%2Ftypescript-sdk" target="_blank" title="https://github.com/modelcontextprotocol/typescript-sdk" ref="nofollow noopener noreferrer">mcp: typescript-sdk</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[原来Webpack在大厂中这样进行性能优化！]]></title>    <link>https://juejin.cn/post/7577356848337764387</link>    <guid>https://juejin.cn/post/7577356848337764387</guid>    <pubDate>2025-11-28T07:46:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577356848337764387" data-draft-id="7577417823341985827" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="原来Webpack在大厂中这样进行性能优化！"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-11-28T07:46:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="秀秀不只会前端"/> <meta itemprop="url" content="https://juejin.cn/user/1410009035452887"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            原来Webpack在大厂中这样进行性能优化！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1410009035452887/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    秀秀不只会前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T07:46:17.000Z" title="Fri Nov 28 2025 07:46:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">性能优化方案</h2>
<p>优化分类：</p>
<ol>
<li>优化打包后的结果（分包、减小包体积、CDN 服务器） ==&gt; 更重要</li>
<li>优化打包速度（exclude、cache-loader）</li>
</ol>
<h3 data-id="heading-1">代码分割（Code Splitting）</h3>
<h4 data-id="heading-2">一、主要目的</h4>
<ul>
<li>​<strong>减少首屏加载体积</strong>​：避免一次性加载全部代码</li>
<li>​<strong>利用浏览器缓存</strong>​：第三方库（如 React、Lodash）变动少，可单独缓存</li>
<li>​<strong>按需加载/并行请求</strong>​：路由、组件、功能模块只在需要时加载（按需加载或者并行加载文件，而不是一次性加载所有代码）</li>
</ul>
<h4 data-id="heading-3">二、三种主要的代码分割方式</h4>
<h5 data-id="heading-4">1. <strong>入口起点（Entry Points）手动分割</strong></h5>
<p>通过配置多个 entry 实现。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">entry</span>: {
    <span class="hljs-attr">main</span>: <span class="hljs-string">'./src/main.js'</span>,
    <span class="hljs-attr">vendor</span>: <span class="hljs-string">'./src/vendor.js'</span>, <span class="hljs-comment">// 手动引入公共依赖</span>
  },
  <span class="hljs-attr">output</span>: {
    <span class="hljs-attr">filename</span>: <span class="hljs-string">'[name].[contenthash].js'</span>,
    <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'dist'</span>),
  },
};
</code></pre>
<blockquote>
<p>缺点：</p>
<ul>
<li>无法自动提取公共依赖（比如 <code>main</code> 和 <code>vendor</code> 都用了 Lodash，会重复打包）</li>
<li>维护成本高</li>
</ul>
</blockquote>
<p>上面写的是通用配置，但我们在公司一般会分别配置开发和生产环境的配置。大多数项目中，<code>entry</code> 在 dev 和 prod 基本一致，无需差异化配置。差异主要体现在 <code>output</code> 和其他插件/加载器行为上。</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-comment">// webpack.config.prod.js</span>
<span class="hljs-keyword">module</span>.<span class="hljs-keyword">exports</span> = {
  mode: <span class="hljs-string">'production'</span>,
  entry: <span class="hljs-string">'./src/index.js'</span>,
  output: {
    filename: <span class="hljs-string">'js/[name].[contenthash:8].js'</span>, <span class="hljs-comment">// 生产环境用 [contenthash]（而非 [hash] 或 [chunkhash]），确保精准缓存</span>
    chunkFilename: <span class="hljs-string">'js/[name].[contenthash:8].js'</span>,
    path: path.resolve(__dirname, <span class="hljs-string">'dist'</span>), <span class="hljs-comment">// 必须输出到磁盘用于部署</span>
    publicPath: <span class="hljs-string">'/static/'</span>, <span class="hljs-comment">// 用于 CDN 或静态资源服务器</span>
    clean: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 清理旧文件</span>
  },
};
<span class="hljs-comment">// webpack.config.dev.js</span>
<span class="hljs-keyword">module</span>.<span class="hljs-keyword">exports</span> = {
  mode: <span class="hljs-string">'development'</span>,
  entry: <span class="hljs-string">'./src/index.js'</span>,
  output: {
    filename: <span class="hljs-string">'js/[name].js'</span>,  <span class="hljs-comment">// 开发环境若加 hash，每次保存都会生成新文件，可能干扰热更新或者devtools混乱</span>
    chunkFilename: <span class="hljs-string">'js/[name].js'</span>,
    path: path.resolve(__dirname, <span class="hljs-string">'dist'</span>), <span class="hljs-comment">// 通常仍写 dist，但实际不写入磁盘（webpack-dev-server 默认内存存储），节省IO，提高编译速度</span>
    publicPath: <span class="hljs-string">'/'</span>, <span class="hljs-comment">// 与 devServer 一致</span>
    <span class="hljs-comment">// clean: false (默认)</span>
  },
};
</code></pre>
<h5 data-id="heading-5">2. <strong>SplitChunksPlugin（推荐！自动代码分割）</strong></h5>
<p>自动提取公共模块和第三方库。webpack 已默认安装相关插件。</p>
<p>默认行为（仅在 production 模式生效）：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">optimization</span>: {
    <span class="hljs-attr">splitChunks</span>: {
      <span class="hljs-attr">chunks</span>: <span class="hljs-string">'async'</span>, <span class="hljs-comment">// 默认只分割异步模块</span>
    },
  },
};
</code></pre>
<p>常用配置：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// webpack.config.prod.js</span>
<span class="hljs-attr">optimization</span>: { 
  <span class="hljs-comment">// 自动分割</span>
​  ​<span class="hljs-comment">// https://twitter.com/wSokra/status/969633336732905474</span>
  <span class="hljs-comment">// https://medium.com/webpack/webpack-4-code-splitting-chunk-graph-and-the-splitchunks-optimization-be739a861366    </span>
  <span class="hljs-attr">splitChunks</span>: {
    <span class="hljs-comment">// chunks: async | initial(对通过的代码处理) | all(同步+异步都处理)</span>
    <span class="hljs-attr">chunks</span>: <span class="hljs-string">'initial'</span>,
    <span class="hljs-attr">minSize</span>: <span class="hljs-number">20000</span>, <span class="hljs-comment">// 模块大于 20KB 才分割（Webpack 5 默认值）</span>
    <span class="hljs-attr">maxSize</span>: <span class="hljs-number">244000</span>, <span class="hljs-comment">// 单个 chunk 最大不超过 244KB（可选）</span>
    <span class="hljs-attr">cacheGroups</span>: { <span class="hljs-comment">// 拆分分组规则</span>
      <span class="hljs-comment">// 提取 node_modules 中的第三方库</span>
      <span class="hljs-attr">vendor</span>: {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]node_modules[\\/]/</span>, <span class="hljs-comment">// 匹配符合规则的包</span>
        <span class="hljs-attr">name</span>: <span class="hljs-string">'vendors'</span>, <span class="hljs-comment">// 拆分包的name 属性</span>
        <span class="hljs-attr">chunks</span>: <span class="hljs-string">'initial'</span>,
        <span class="hljs-attr">priority</span>: <span class="hljs-number">10</span>, <span class="hljs-comment">// 优先级高于 default</span>
        <span class="hljs-attr">enforce</span>: <span class="hljs-literal">true</span>,
      },
      <span class="hljs-comment">// 提取多个 chunk 公共代码</span>
      <span class="hljs-attr">default</span>: {
        <span class="hljs-attr">minChunks</span>: <span class="hljs-number">2</span>, <span class="hljs-comment">// 至少被 2 个 chunk 引用</span>
        <span class="hljs-attr">priority</span>: -<span class="hljs-number">20</span>,
        <span class="hljs-attr">reuseExistingChunk</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 复用已存在的 chunk</span>
        <span class="hljs-attr">maxInitialRequests</span>: <span class="hljs-number">5</span>, <span class="hljs-comment">// 默认限制太小，无法显示效果</span>
        <span class="hljs-attr">minSize</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// 这个示例太小，无法创建公共块</span>
      },
    },
  },
  <span class="hljs-comment">// runtime相关的代码是否抽取到一个单独的chunk中，比如import动态加载的代码就是通过runtime 代码完成的</span>
  <span class="hljs-comment">// 抽离出来利于浏览器缓存，比如修改了业务代码，那么runtime加载的chunk无需重新加载</span>
  <span class="hljs-attr">runtimeChunk</span>: <span class="hljs-literal">true</span>,
}
</code></pre>
<p>在开发环境下 <code>splitChunks: false,</code> 即可。</p>
<blockquote>
<p>生产环境：</p>
<ul>
<li>生成 <code>vendors.xxxx.js</code>（第三方库）</li>
<li>生成 <code>default.xxxx.js</code>（项目公共代码）</li>
<li>主 bundle 体积显著减小</li>
</ul>
</blockquote>
<h5 data-id="heading-6">3. <strong>动态导入（Dynamic Imports）—— 按需加载</strong></h5>
<p>使用 <code>import()</code> 语法（符合 ES Module 规范），实现懒加载。</p>
<blockquote>
<p>Webpack 会为每个 <code>import()</code> 创建一个独立的 chunk，并自动处理加载逻辑。</p>
</blockquote>
<h4 data-id="heading-7">三、魔法注释（Magic Comments）—— 控制 chunk 名称等行为</h4>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 自定义 chunk 名称（便于调试和长期缓存）</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(
  <span class="hljs-comment">/* webpackChunkName: "my-module" */</span>
  <span class="hljs-string">'./my-module'</span>
);
</code></pre>
<p>其他常见注释：</p>
<ul>
<li><code>/* webpackPrefetch: true */</code>：空闲时预加载（提升后续访问速度）</li>
<li><code>/* webpackPreload: true */</code>：当前导航关键资源预加载（慎用）</li>
</ul>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 预加载“下一个可能访问”的页面</span>
<span class="hljs-keyword">import</span>(
  <span class="hljs-comment">/* webpackChunkName: "login-page" */</span>
  <span class="hljs-comment">/* webpackPrefetch: true */</span>
  <span class="hljs-string">'./LoginPage'</span>
);
</code></pre>
<p>详细比较：</p>
<ul>
<li>preload chunk 会在父 chunk 加载时，以并行方式开始加载。prefetch chunk 会在父 chunk 加载结束后开始加载。</li>
<li>preload chunk 具有中等优先级，并立即下载。prefetch chunk 在浏览器闲置时下载。</li>
</ul>
<h3 data-id="heading-8">CND</h3>
<p>内容分发网络（Content Delivery Network 或 Content Distribution Network）</p>
<p>它是指通过相互连接的网络系统，利用最靠近每个用户的服务器；更快、更可靠地将音乐、图片、视频、应用程序及其他文件发送给用户；提供高性能、可扩展性及低成本的网络内容传递。</p>
<p>工作中，我们使用 CDN 的主要方式有两种：</p>
<ol>
<li>打包所有静态资源，放到 CDN 服务器，用户所有资源都是通过 CND 服务器加载的
<ol>
<li>通过 <code>output.publicPath</code> 改为自己的的 CDN 服务器，打包后就可以从上面获取资源</li>
<li>如果是自己的话，一般会从阿里、腾讯等买 CDN 服务器。</li>
</ol>
</li>
<li>一些第三方资源放在 CDN 服务器上
<ol>
<li>一些库/框架会将打包后的源码放到一些免费的 CDN 上，比如 JSDeliver、bootcdn 等</li>
<li>这样的话，打包的时候就不需要对这些库进行打包，直接使用 CDN 服务器中的源码（通过 externals 配置排除某些包）</li>
</ol>
</li>
</ol>
<h3 data-id="heading-9">CSS 提取</h3>
<p>将 css 提取到一个独立的 css 文件。</p>
<pre><code class="hljs language-Plain" lang="Plain">npm install mini-css-extract-plugin -D
</code></pre>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// webpack.config.prod.js</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">MiniCssExtractPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mini-css-extract-plugin'</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">mode</span>: <span class="hljs-string">'production'</span>,
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      <span class="hljs-comment">// 生产环境：使用 MiniCssExtractPlugin.loader</span>
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.css$/i</span>,
        <span class="hljs-attr">use</span>: [
          <span class="hljs-title class_">MiniCssExtractPlugin</span>.<span class="hljs-property">loader</span>, <span class="hljs-comment">// 替换 style-loader</span>
          <span class="hljs-string">'css-loader'</span>,
          <span class="hljs-string">'postcss-loader'</span>,
        ],
      },
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.s[ac]ss$/i</span>,
        <span class="hljs-attr">use</span>: [
          <span class="hljs-title class_">MiniCssExtractPlugin</span>.<span class="hljs-property">loader</span>,
          <span class="hljs-string">'css-loader'</span>,
          <span class="hljs-string">'postcss-loader'</span>,
          <span class="hljs-string">'sass-loader'</span>,
        ],
      },
    ],
  },
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">MiniCssExtractPlugin</span>({
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'css/[name].[contenthash:8].css'</span>,
      <span class="hljs-attr">chunkFilename</span>: <span class="hljs-string">'css/[name].[contenthash:8].css'</span>,
    }),
  ],
};
</code></pre>
<h3 data-id="heading-10">Terser 代码压缩</h3>
<p>Terser 可以帮助我们压缩、丑化(混淆)我们的代码，让我们的 bundle 变得更小。</p>
<blockquote>
<p>Terser 是一个单独的工具，拥有非常多的配置，这里我们只讲工作中如何使用，以一个工程的角度学习这个工具。</p>
</blockquote>
<p>真实开发中，我们不需要手动的通过 terser 来处理我们的代码。webpack 中 minimizer 属性，在 production 模式下，默认就是使用的 TerserPlugin 来处理我们代码的。我们也可以手动创建 TerserPlugin 实例覆盖默认配置。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// webpack.prod.js </span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">TerserPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'terser-webpack-plugin'</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">mode</span>: <span class="hljs-string">'production'</span>,
  <span class="hljs-attr">optimization</span>: {
    <span class="hljs-attr">minimize</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">minimizer</span>: [
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">TerserPlugin</span>({
        <span class="hljs-attr">parallel</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 多核 CPU 并行压缩，默认为true，并发数默认为os.cpus().length-1</span>
        <span class="hljs-attr">terserOptions</span>: {
          <span class="hljs-attr">compress</span>: { <span class="hljs-comment">// 压缩配置</span>
            <span class="hljs-attr">drop_console</span>: <span class="hljs-literal">true</span>,
            <span class="hljs-attr">drop_debugger</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 删除debugger</span>
            <span class="hljs-attr">pure_funcs</span>: [<span class="hljs-string">'console.info'</span>, <span class="hljs-string">'console.debug'</span>], <span class="hljs-comment">// 只删除特定的函数调用</span>
          },
          <span class="hljs-attr">mangle</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否丑化代码（变量）</span>
          <span class="hljs-attr">toplevel</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 顶层变量是否进行转换</span>
          <span class="hljs-attr">keep_classnames</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否保留类的名称</span>
          <span class="hljs-attr">keep_fnames</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否保留函数的名称</span>
          <span class="hljs-attr">format</span>: {
            <span class="hljs-attr">comments</span>: <span class="hljs-regexp">/@license|@preserve/i</span>, <span class="hljs-comment">// 保留含 license/preserve 的注释（某些开源库要求保留版权注释）</span>
          },
        },
        <span class="hljs-attr">extractComments</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 默认为true会将注释提取到一个单独的文件（这里用于保留版权注释），false表示不希望保留注释</span>
        <span class="hljs-attr">sourceMap</span>: <span class="hljs-literal">true</span>,   <span class="hljs-comment">// 需要 webpack 配置 devtool 生成 source map</span>
      }),
    ],
  },
};
</code></pre>
<blockquote>
<p>不要在开发环境启动 terser，因为：</p>
<ul>
<li>压缩会拖慢构建速度</li>
<li>混淆后的代码无法调试</li>
<li>hmr 和 source-map 会失效</li>
</ul>
</blockquote>
<h3 data-id="heading-11">CSS 压缩</h3>
<p>CSS 压缩通常是去除无用的空格等，因为很难去修改选择器、属性的名称、值等；我们一般使用插件 <code>css-minimizer-webpack-plugin</code>；他的底层是使用 cssnano 工具来优化、压缩 CSS（也可以单独使用）。</p>
<p>使用也是非常简单：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-attr">minimizer</span>: [
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">CssMiniMizerPlugin</span>()({
    <span class="hljs-attr">parallel</span>: <span class="hljs-literal">true</span>
  })
]
</code></pre>
<h3 data-id="heading-12">Tree Shaking 摇树</h3>
<p>详情见之前文章：《简单聊聊 webpack 摇树的原理》</p>
<h3 data-id="heading-13">HTTP 压缩</h3>
<p>HTTP 压缩（HTTP Compression）是一种 <strong>在服务器和客户端之间传输数据时减小响应体体积 ​</strong>的技术，通过压缩 HTML、CSS、JavaScript、JSON 等文本资源，显著提升网页加载速度、节省带宽。</p>
<h4 data-id="heading-14">一、主流压缩算法</h4>

































<table><thead><tr><th>算法</th><th>兼容性</th><th>压缩率</th><th>速度</th><th>说明</th></tr></thead><tbody><tr><td><strong>gzip</strong></td><td>✅ 几乎所有浏览器（IE6+）</td><td>高</td><td>快</td><td>​<strong>最广泛使用</strong>​，Web 标准推荐</td></tr><tr><td><strong>Brotli (br)</strong></td><td>✅ 现代浏览器（Chrome 49+, Firefox 44+, Safari 11+）</td><td>⭐ 更高（比 gzip 高 15%~30%）</td><td>较慢（压缩），解压快</td><td><strong>推荐用于静态资源</strong></td></tr><tr><td><strong>deflate</strong></td><td>⚠️ 支持不一致（部分浏览器实现有问题）</td><td>中</td><td>中</td><td><strong>已基本淘汰，不推荐使用</strong></td></tr></tbody></table>
<h4 data-id="heading-15">二、工作原理（协商压缩）</h4>
<p>HTTP 压缩基于 请求头 ↔ 响应头协商机制：</p>
<ol>
<li>客户端请求（表明支持的压缩格式）</li>
</ol>
<pre><code class="hljs language-HTTP" lang="HTTP">GET /app.js HTTP/1.1
Host: example.com
Accept-Encoding: gzip, deflate, br // 客户端支持的压缩算法列表
</code></pre>
<ol start="2">
<li>服务端响应（返回压缩后的内容）</li>
</ol>
<pre><code class="hljs language-HTTP" lang="HTTP">HTTP/1.1 200 OK
Content-Encoding: br  // 服务端使用的压缩算法
Content-Type: application/javascript
Content-Length: 102400  // 注意：这是压缩后的大小！

...（二进制压缩数据）...
</code></pre>
<blockquote>
<ul>
<li>浏览器自动解压，开发者无感知</li>
</ul>
</blockquote>
<h4 data-id="heading-16">三、如何启用 HTTP 压缩？</h4>
<p>我们一般会优先使用 Nginx 配置做压缩（生产环境最常用），这样就无需应用层处理。</p>
<p><strong>除此之外，我们还会进行预压缩 + 静态文件服务，这主要就是 webpack 要做的工作。</strong></p>
<p>在构建阶段（Webpack/Vite）就生成 <code>.gz</code> 和 <code>.br</code> 文件，部署到 CDN 或静态服务器。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">CompressionPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'compression-webpack-plugin'</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-comment">// 生成 .gz 文件</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompressionPlugin</span>({
      <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'gzip'</span>,
      <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(js|css|html|svg)$/</span>,
      <span class="hljs-attr">threshold</span>: <span class="hljs-number">8192</span>, <span class="hljs-comment">// 大于 8KB 才压缩</span>
      <span class="hljs-attr">minRatio</span>: <span class="hljs-number">0.8</span>,  <span class="hljs-comment">// 至少的压缩比例</span>
    }),
    <span class="hljs-comment">// 生成 .br 文件（需额外安装）</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">CompressionPlugin</span>({
      <span class="hljs-attr">algorithm</span>: <span class="hljs-string">'brotliCompress'</span>,
      <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(js|css|html|svg)$/</span>,
      <span class="hljs-attr">compressionOptions</span>: { <span class="hljs-attr">level</span>: <span class="hljs-number">11</span> }, <span class="hljs-comment">// 最高压缩率</span>
    }),
  ],
};
</code></pre>
<p>Nginx 配合预压缩文件：</p>
<pre><code class="hljs language-Nginx" lang="Nginx">gzip_static on;    # 优先返回 .gz 文件
brotli_static on;  # 优先返回 .br 文件
</code></pre>
<h3 data-id="heading-17">打包分析</h3>
<h4 data-id="heading-18">打包时间分析</h4>
<p>我们需要借助一个插件 <code>speed-measure-webpack-plugin</code>，即可看到每个 loader、每个 plugin 消耗的打包时间。</p>
<pre><code class="hljs language-Java" lang="Java"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-type">const</span> <span class="hljs-variable">SpeedMeasurePlugin</span> <span class="hljs-operator">=</span> require(<span class="hljs-string">'speed-measure-webpack-plugin'</span>);

<span class="hljs-type">const</span> <span class="hljs-variable">smp</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpeedMeasurePlugin</span>();

<span class="hljs-type">const</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> {
  <span class="hljs-comment">// 你的正常 Webpack 配置</span>
  entry: <span class="hljs-string">'./src/index.js'</span>,
  <span class="hljs-keyword">module</span>: { <span class="hljs-comment">/* ... */</span> },
  plugins: [ <span class="hljs-comment">/* ... */</span> ],
};

<span class="hljs-comment">// 仅当环境变量 ANALYZE_SPEED=1 时包裹配置</span>
<span class="hljs-keyword">module</span>.<span class="hljs-keyword">exports</span> = process.env.ANALYZE_SPEED ? smp.wrap(config) : config;
</code></pre>
<h4 data-id="heading-19">打包文件分析</h4>
<h5 data-id="heading-20">方法一、生成 stats.json 文件</h5>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-string">"build:stats"</span>: <span class="hljs-string">"w--config ./config/webpack.common.js --env production --profile --json=stats.json"</span>,
</code></pre>
<p>运行 <code>npm run build:stats</code>，可以获取到一个 stats.json 文件，然后放到到 <a href="https://link.juejin.cn?target=http%3A%2F%2Fwebpack.github.com%2Fanalyse" target="_blank" title="http://webpack.github.com/analyse" ref="nofollow noopener noreferrer">webpack.github.com/analyse</a> 进行分析。</p>
<h5 data-id="heading-21">方法二、webpack-bundle-analyzer</h5>
<p>更常用的方式是使用 webpack-bundle-analyzer 插件分析。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// webpack.prod.js</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">BundleAnalyzerPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpack-bundle-analyzer'</span>).<span class="hljs-property">BundleAnalyzerPlugin</span>;

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">mode</span>: <span class="hljs-string">'production'</span>,
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-comment">// 其他插件...</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">BundleAnalyzerPlugin</span>({
      <span class="hljs-attr">analyzerMode</span>: <span class="hljs-string">'static'</span>, <span class="hljs-comment">// 生成静态 HTML 报告（默认）</span>
      <span class="hljs-attr">openAnalyzer</span>: <span class="hljs-literal">false</span>,    <span class="hljs-comment">// 不自动打开浏览器</span>
      <span class="hljs-attr">reportFilename</span>: <span class="hljs-string">'bundle-report.html'</span>,
      <span class="hljs-attr">generateStatsFile</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 可选：同时生成 stats.json</span>
      <span class="hljs-attr">statsFilename</span>: <span class="hljs-string">'stats.json'</span>,
    }),
  ],
};
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[会议透镜（Meeting Lens）：基于 Rokid CXR-M 的 AI 会议纪要实战]]></title>    <link>https://juejin.cn/post/7577461079597826067</link>    <guid>https://juejin.cn/post/7577461079597826067</guid>    <pubDate>2025-11-28T07:14:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577461079597826067" data-draft-id="7577394906161610806" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="会议透镜（Meeting Lens）：基于 Rokid CXR-M 的 AI 会议纪要实战"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-28T07:14:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LibSept24_"/> <meta itemprop="url" content="https://juejin.cn/user/537031153027213"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            会议透镜（Meeting Lens）：基于 Rokid CXR-M 的 AI 会议纪要实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/537031153027213/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LibSept24_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T07:14:27.000Z" title="Fri Nov 28 2025 07:14:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在这篇文章里，我想分享一个基于 Rokid CXR-M SDK + 大模型（ASR <strong>+</strong> LLM） 打造的实验项目——「会议透镜（Meeting Lens）」。</p>
<p>佩戴 Rokid AI 眼镜进入会议室，你只需要正常发言、讨论、举手、点头；</p>
<p>会议结束时：</p>
<ul>
<li>结构化纪要（议题、结论、行动项）已经生成</li>
<li>关键决策片段自动高亮</li>
<li>下一步 To-do 直接推送到你的手机 / 协作工具</li>
</ul>
<p>甚至在会议进行中，眼镜已经实时把「当前议题」「待确认事项」浮现在你眼前。</p>
<p>下面我会围绕 CXR-M SDK 的真实能力与接口*展开，从环境配置、设备连接、音频流采集，到端云协同的 AI 工作流，以及如何利用 提词器场景 + 自定义页面（Custom View），把实时要点和最终纪要回传到眼镜端显示。</p>
<h2 data-id="heading-0">从“做笔记”到“只开口”：会议纪要的重构</h2>
<h3 data-id="heading-1">1.1 传统会议纪要的瓶颈</h3>
<p>大多数人的会议体验大概是这样的：</p>
<ul>
<li>一边听，一边记，错过别人说了什么</li>
<li>会议结束堆满语音、照片、零散文档</li>
<li>真正有用的是那几条：<strong>决议 &amp; 行动项</strong> —— 却偏偏最难完整记录</li>
<li>远程 / 现场混合开会时，多人同时说话，回放和标注十分痛苦</li>
</ul>
<p>「会议透镜」想改变的是：</p>
<blockquote>
<p>让“会议纪要”不再是人的负担，而是 AI 的职责。 人只负责 <strong>表达</strong> 和 <strong>决策</strong>，记录、整理、分发全部自动完成。</p>
</blockquote>
<h3 data-id="heading-2">1.2 为什么选择 Rokid + CXR-M SDK 来做会议助手</h3>
<p>要做一个「只要戴上就能自动做纪要」的系统，需要同时满足：</p>
<ol>
<li>
<p><strong>第一视角 &amp; 免手持</strong></p>
<ol>
<li>眼镜自带麦克风，天然贴近发言者</li>
<li>屏幕就在视野里，适合实时展示要点、提醒「还有一个行动项没确认」</li>
</ol>
</li>
<li>
<p><strong>端云协同能力</strong></p>
<ol>
<li>眼镜通过 <strong>蓝牙 / Wi-Fi</strong> 与手机建立稳定链路</li>
<li>手机有充足算力跑本地 ASR / 噪声处理</li>
<li>云端大模型负责长期记忆、多轮推理、结构化输出</li>
</ol>
</li>
</ol>
<p>Rokid 的 <strong>CXR-M（Mobile SDK）</strong> 正好提供了这一整套基础设施：</p>
<ul>
<li>蓝牙扫描与连接、状态管理</li>
<li>Wi-Fi P2P 高速链路（适合同步录音文件、会议多媒体）</li>
<li>眼镜端音频流采集（<code>openAudioRecord</code> / <code>setAudioStreamListener</code>）</li>
<li>AI 场景事件监听（<code>AiEventListener</code>）</li>
<li>提词器 / 翻译 / 自定义页面等场景，用于在眼镜上展示文字与 UI</li>
</ul>
<p>对「会议透镜」这样的项目来说，最自然的架构是：</p>
<ul>
<li><strong>眼镜：</strong> 采集 &amp; 显示</li>
<li><strong>手机：</strong> 通信 + AI 工作流（ASR + LLM）</li>
<li><strong>云端：</strong> 大规模模型推理 &amp; 长期存储</li>
</ul>
<h2 data-id="heading-3">整体架构：端 – 云协同的「会议透镜」</h2>
<p>先看一眼 Meeting Lens 的数据流（加一张简易流程图方便读者理解整体链路）：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[用户佩戴 Rokid 眼镜]</span>
        │  <span class="hljs-number">1</span>. 讲话 / 讨论
        ▼
<span class="hljs-selector-attr">[眼镜麦克风]</span>
        │  <span class="hljs-number">2</span>. 音频流（蓝牙）
        ▼
<span class="hljs-selector-attr">[CXR-M SDK @ 手机]</span>
        │  <span class="hljs-number">3</span>. AudioStreamListener 接收音频
        │     分段 / 预处理
        ▼
<span class="hljs-selector-attr">[MeetingLensManager @ 手机]</span>
        │  <span class="hljs-number">4</span>. 调用后端 /asr/stream 做实时转写
        │     累积 transcript
        │  <span class="hljs-number">5</span>. 定时调用 /meeting/summarize 做中间 &amp; 最终纪要
        ▼
<span class="hljs-selector-attr">[后端 AI 服务]</span>
        │  <span class="hljs-built_in">ASR</span>(Whisper/讯飞…) + <span class="hljs-built_in">LLM</span>(大模型)
        │  输出：<span class="hljs-selector-tag">summary</span> / 决策 / To-do
        ▼
<span class="hljs-selector-attr">[MeetingLensManager]</span>
        │  <span class="hljs-number">6</span>. 通过 Custom View / 提词器
        │     把纪要 &amp; TODO 推回眼镜
        ▼
<span class="hljs-selector-attr">[眼镜显示层：Meeting View]</span>
        → 实时展示议题 / 结论 / 行动项
</code></pre>
<h3 data-id="heading-4">2.1 会议现场采集</h3>
<ul>
<li>佩戴 Rokid 眼镜，启动「会议助手」AI 场景</li>
<li>眼镜端麦克风启动录音，音频流通过 CXR-M 回传手机</li>
</ul>
<h3 data-id="heading-5">2.2 端侧预处理</h3>
<ul>
<li>手机端对音频做降噪、VAD（分段）、可能的说话人分离</li>
<li>分段音频送往本地 / 云端 ASR 服务（英文、中文或多语种）</li>
</ul>
<h3 data-id="heading-6">2.3 云端 AI 纪要引擎</h3>
<ul>
<li>
<p>基于 ASR 文本 + 说话人标签</p>
</li>
<li>
<p>使用 LLM 做：逐段总结 + 会议中期小结 + 会后全局总结</p>
</li>
<li>
<p>输出结构化结果：</p>
<ul>
<li>议题列表</li>
<li>讨论过程摘要</li>
<li>决策</li>
<li>待办（Owner + 截止时间）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-7">2.4 结果回传 &amp; 实时提示</h3>
<ul>
<li>
<p>会议进行中：</p>
<ul>
<li>当前议题 / 刚刚说的关键句被高亮为「候选决议」</li>
<li>经手动确认后固化为决议</li>
<li>通过 <strong>提词器</strong> <strong>/ Custom View</strong> 回传到眼镜显示</li>
</ul>
</li>
<li>
<p>会议结束：</p>
<ul>
<li>最终纪要发送手机 App / 邮件 / IM 群</li>
<li>眼镜屏幕展示「本次会议 X 项关键决策 + Y 个行动项」</li>
</ul>
</li>
</ul>
<h3 data-id="heading-8">2.5 循环刷新</h3>
<ul>
<li>每当检测到一个「新的议题块」开始（通过主持人语句、关键词或 UI 交互），重启一轮 ASR + 摘要，保证结构清晰。</li>
</ul>
<h2 data-id="heading-9">开发环境与 CXR-M 集成</h2>
<h3 data-id="heading-10">3.1 基础环境</h3>
<ul>
<li>Android Studio 2023.1+</li>
<li>Android 手机（Android 9.0+）</li>
<li>Rokid AR 眼镜（开启开发者模式）</li>
<li>JDK 8+</li>
<li>Kotlin 1.8+/1.9+（本文代码以 Kotlin 为主）</li>
</ul>
<h3 data-id="heading-11">3.2 添加 Rokid Maven 仓库与 CXR-M 依赖</h3>
<p>根据官方文档，CXR-M SDK 发布在 Rokid 自有 Maven 仓库，需要在 <code>settings.gradle.kts</code> 里添加：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// settings.gradle.kts</span>
dependencyResolutionManagement {
    repositoriesMode<span class="hljs-selector-class">.set</span>(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
    repositories {
        maven { url = <span class="hljs-built_in">uri</span>("https://maven.rokid.com/repository/maven-public/") }
        <span class="hljs-built_in">google</span>()
        <span class="hljs-built_in">mavenCentral</span>()
    }
}
</code></pre>
<p>在 <code>app/build.gradle.kts</code> 中引入 SDK：</p>
<pre><code class="hljs language-ini" lang="ini">android {
    <span class="hljs-attr">compileSdk</span> = <span class="hljs-number">34</span>
    defaultConfig {
        <span class="hljs-attr">applicationId</span> = <span class="hljs-string">"com.example.meetinglens"</span>
        <span class="hljs-attr">minSdk</span> = <span class="hljs-number">28</span>        // CXR-M 要求的最小版本
        <span class="hljs-attr">targetSdk</span> = <span class="hljs-number">34</span>
        <span class="hljs-attr">versionCode</span> = <span class="hljs-number">1</span>
        <span class="hljs-attr">versionName</span> = <span class="hljs-string">"1.0"</span>
    }
}
​
dependencies {
    implementation("com.rokid.cxr:client-m:1.0.1-20250812.080117-2")
    // Retrofit / OkHttp / Gson 等网络依赖按需添加
}
</code></pre>
<h3 data-id="heading-12">3.3 权限与动态申请</h3>
<p>CXR-M 涉及的最小权限集包括：蓝牙、Wi-Fi、网络等，典型配置：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- AndroidManifest.xml（节选） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.ACCESS_COARSE_LOCATION"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.ACCESS_FINE_LOCATION"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.BLUETOOTH"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.BLUETOOTH_ADMIN"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.BLUETOOTH_CONNECT"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.BLUETOOTH_SCAN"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.ACCESS_NETWORK_STATE"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.CHANGE_NETWORK_STATE"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.ACCESS_WIFI_STATE"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.CHANGE_WIFI_STATE"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.INTERNET"</span> /&gt;</span>
<span class="hljs-comment">&lt;!-- 录音权限，用于会议音频采集 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.RECORD_AUDIO"</span> /&gt;</span>
</code></pre>
<p>运行时建议一次性申请所有必要权限（包括 Android 12+ 的 <code>BLUETOOTH_SCAN</code> / <code>BLUETOOTH_CONNECT</code>），再初始化 CXR，否则 SDK 会直接不可用。</p>
<h2 data-id="heading-13">设备接入：用 CXR-M 打通眼镜与手机</h2>
<h3 data-id="heading-14">4.1 蓝牙扫描与连接</h3>
<p>官方通常会提供一个较完整的 <code>BluetoothHelper</code> 示例，用于：</p>
<ul>
<li>动态申请蓝牙相关权限</li>
<li>检测蓝牙开关状态</li>
<li>扫描 Rokid 眼镜（通过特定 Service UUID 过滤）</li>
<li>维护已配对 / 已连接设备列表</li>
</ul>
<p>在 Meeting Lens 中，我们可以复用这一套逻辑，扫描中通过 Service UUID 过滤 Rokid 设备：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 扫描时使用 Rokid Glasses 的 Service UUID 过滤</span>
ScanFilter<span class="hljs-selector-class">.Builder</span>()
    <span class="hljs-selector-class">.setServiceUuid</span>(
        ParcelUuid.fromString("<span class="hljs-number">00009100</span>-<span class="hljs-number">0000</span>-<span class="hljs-number">1000</span>-<span class="hljs-number">8000</span>-<span class="hljs-number">00805</span>f9b34fb")
    )
    <span class="hljs-selector-class">.build</span>()
</code></pre>
<p>找到目标设备后，调用：</p>
<ul>
<li><code>initBluetooth(context, device, callback)</code> 完成初始化</li>
<li>在 <code>onConnectionInfo</code> 获得 <code>socketUuid</code> 和 <code>macAddress</code>，再调用 <code>connectBluetooth()</code> 建立通信</li>
</ul>
<h3 data-id="heading-15">4.2 Wi-Fi P2P：为录音文件和附件留出通道</h3>
<p>会议中如果需要同步完整录音文件、演示资料、截图等，可以使用 Wi-Fi P2P 模块：</p>
<ul>
<li>初始化：<code>initWifiP2P(callback)</code></li>
<li>获取状态：<code>isWifiP2PConnected</code></li>
<li>反初始化：<code>deinitWifiP2P()</code></li>
</ul>
<p>策略上：</p>
<ul>
<li>实时 ASR：走蓝牙音频流</li>
<li>会后上传完整录音 / 媒体：走 Wi-Fi P2P + 文件同步接口（如 <code>startSync</code> / <code>syncSingleFile</code>）</li>
</ul>
<h2 data-id="heading-16">核心链路：从音频流到结构化会议纪要</h2>
<h3 data-id="heading-17">5.1 获取眼镜端音频流：<code>AudioStreamListener</code></h3>
<p>CXR-M 提供了一套完整的录音接口：</p>
<ul>
<li>开启录音：<code>openAudioRecord(codecType, streamType)</code></li>
<li>关闭录音：<code>closeAudioRecord(streamType)</code></li>
<li>设置监听：<code>setAudioStreamListener(callback)</code></li>
</ul>
<p>示例代码：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 设置音频流监听</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> audioStreamListener = <span class="hljs-keyword">object</span> : AudioStreamListener {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onStartAudioStream</span><span class="hljs-params">(codecType: <span class="hljs-type">Int</span>, streamType: <span class="hljs-type">String</span>?)</span></span> {
        <span class="hljs-comment">// 例如 streamType = "meeting"</span>
        <span class="hljs-comment">// 可以在这里重置缓冲区、时间戳等</span>
    }
​
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onAudioStream</span><span class="hljs-params">(<span class="hljs-keyword">data</span>: <span class="hljs-type">ByteArray</span>?, offset: <span class="hljs-type">Int</span>, length: <span class="hljs-type">Int</span>)</span></span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span> == <span class="hljs-literal">null</span> || length &lt;= <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>
        <span class="hljs-comment">// 将 PCM / Opus 数据推入本地 ASR Engine / 发送到云端</span>
        asrEngine.feed(<span class="hljs-keyword">data</span>, offset, length)
    }
}
​
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startMeetingAudioStream</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 注册监听</span>
    CxrApi.getInstance().setAudioStreamListener(audioStreamListener)
​
    <span class="hljs-comment">// 开启录音：codecType: 1=PCM, 2=OPUS（按文档约定）</span>
    CxrApi.getInstance().openAudioRecord(
        codecType = <span class="hljs-number">2</span>,
        streamType = <span class="hljs-string">"meeting_assistant"</span>
    )
}
​
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">stopMeetingAudioStream</span><span class="hljs-params">()</span></span> {
    CxrApi.getInstance().closeAudioRecord(<span class="hljs-string">"meeting_assistant"</span>)
    CxrApi.getInstance().setAudioStreamListener(<span class="hljs-literal">null</span>)
}
</code></pre>
<p>这一步完成后，我们就把「眼镜上的麦克风」变成了「AI 会议纪要系统的耳朵」。</p>
<h3 data-id="heading-18">5.2 ASR + 说话人分离：把“声”变成“谁说了什么”</h3>
<p>在端 / 云侧，可以使用你熟悉的 ASR 引擎（如 Whisper、讯飞等）：</p>
<ul>
<li>将 <code>onAudioStream</code> 中的音频切成 1～2 秒片段</li>
<li>送入流式 ASR</li>
<li>对每段打上时间戳，并结合麦克风阵列 / 外部麦 / 会议室麦克风做<strong>说话人分离</strong></li>
</ul>
<p>得到的数据结构大致是：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"segments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"speaker"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Alice"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">12.3</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"end"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">18.7</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我们这季度的核心目标是把留存提升到 35%。"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-19">5.3 LLM 纪要引擎：从文本到结构化结论</h3>
<p>基于上述 <code>segments</code>，你可以设计多层次总结流程：</p>
<ol>
<li>
<p><strong>分段摘要</strong></p>
<ol>
<li>每 2～3 分钟做一次小节，得到“当前议题的小结”</li>
</ol>
</li>
<li>
<p><strong>会议中期小结</strong></p>
<ol>
<li>当主持人切换议题时（“那下面讨论第二个问题”），触发一次自然段总结</li>
</ol>
</li>
<li>
<p><strong>会后总总结</strong></p>
<ol>
<li>
<p>聚合所有文本 + 中间小结</p>
</li>
<li>
<p>按如下结构输出：</p>
<ul>
<li>会议时间 / 地点 / 参与者</li>
<li>议题列表</li>
<li>每个议题的：背景 / 讨论过程 / 结论</li>
<li>待办事项（Owner + Deadline + 状态）</li>
</ul>
</li>
</ol>
</li>
</ol>
<h3 data-id="heading-20">5.4 把关键要点回传到眼镜：提词器 + 自定义页面</h3>
<p>方式一：用提词器场景做「会议 TODO 滚动条」</p>
<p>CXR-M 提供了 提词器（Word Tips）场景，可以：</p>
<ul>
<li>打开 / 关闭场景：<code>controlScene(ValueUtil.CxrSceneType.WORD_TIPS, toOpen, null)</code></li>
<li>用 <code>sendStream(ValueUtil.CxrStreamType.WORD_TIPS, ...)</code> 发送提词内容</li>
</ul>
<p>例如，把已经确认的行动项转成一段清单文本推送到眼镜：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">openTodosOnGlasses</span><span class="hljs-params">(text: <span class="hljs-type">String</span>, fileName: <span class="hljs-type">String</span> = <span class="hljs-string">"meeting_todos.txt"</span>)</span></span> {
    <span class="hljs-comment">// 打开提词器场景</span>
    CxrApi.getInstance().controlScene(
        ValueUtil.CxrSceneType.WORD_TIPS,
        <span class="hljs-literal">true</span>,
        <span class="hljs-literal">null</span>
    )
​
    <span class="hljs-comment">// 发送文字内容</span>
    CxrApi.getInstance().sendStream(
        ValueUtil.CxrStreamType.WORD_TIPS,
        text.toByteArray(),
        fileName,
        <span class="hljs-keyword">object</span> : SendStatusCallback {
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSendSucceed</span><span class="hljs-params">()</span></span> { }
            <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSendFailed</span><span class="hljs-params">(code: <span class="hljs-type">ValueUtil</span>.<span class="hljs-type">CxrSendErrorCode</span>?)</span></span> { }
        }
    )
}
</code></pre>
<p>再配合 <code>configWordTipsText</code> 调整字号、行距、显示区域，可以把「关键 TODO」像字幕一样滚动在视野边缘。</p>
<p><strong>方式二：用 Custom View 做「实时会议状态卡片」</strong></p>
<p>自定义页面（Custom View）允许用 JSON 描述一个界面，包含 <code>TextView</code> / <code>ImageView</code> / <code>LinearLayout</code> / <code>RelativeLayout</code> 等控件，眼镜端会根据 JSON 渲染。</p>
<p>典型用法：</p>
<ol>
<li>打开界面：<code>openCustomView(content)</code></li>
<li>更新：<code>updateCustomView(content)</code></li>
<li>监听状态：<code>setCustomViewListener(listener)</code></li>
</ol>
<p>例如构建一个简单的「会议状态卡片」：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"LinearLayout"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"props"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"layout_width"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"match_parent"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"layout_height"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"wrap_content"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"orientation"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"vertical"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"backgroundColor"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#80000000"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"paddingTop"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"8dp"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"paddingBottom"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"8dp"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"TextView"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"props"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tv_topic"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"当前议题：Q3 留存目标"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"textSize"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"14sp"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"textColor"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#FFFFFFFF"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"textStyle"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"bold"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"TextView"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"props"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tv_highlight"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Alice：我们需要把产品内推荐体系重构一遍。"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"textSize"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"12sp"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"textColor"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#FFDDDDDD"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"marginTop"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"4dp"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"TextView"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"props"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tv_todos"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"行动项：3 条（点头确认可记为已认领）"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"textSize"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"12sp"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"textColor"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#FF00FF00"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"marginTop"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"4dp"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>用 <code>openCustomView()</code> 推送一次，后续只需用 <code>updateCustomView()</code> 改 <code>tv_topic</code> / <code>tv_highlight</code> / <code>tv_todos</code> 的 <code>text</code> 即可。</p>
<h2 data-id="heading-21">实战：基于 CXR-M 的 Meeting Lens 开发实践（含完整代码）</h2>
<h3 data-id="heading-22">6.1 实战目标</h3>
<p>实现一个 <code>MeetingLensManager</code>：</p>
<ul>
<li>
<p><code>startMeeting()</code>：</p>
<ul>
<li>开启眼镜端录音（<code>openAudioRecord</code>）</li>
<li>注册 <code>AudioStreamListener</code> 接收音频流</li>
<li>打开 Custom View，在眼镜上显示「会议纪要生成中」</li>
<li>启动一个定时任务，每隔 N 秒把当前文本发给后端做中间总结</li>
</ul>
</li>
<li>
<p><code>stopMeeting()</code>：</p>
<ul>
<li>关闭录音</li>
<li>停止定时任务</li>
<li>把完整 transcript 发送给后端，生成最终纪要</li>
<li>把最终纪要回传眼镜显示</li>
</ul>
</li>
</ul>
<h3 data-id="heading-23">6.2 MeetingLensManager 核心类（完整代码）</h3>
<blockquote>
<p>下面这段 Kotlin 代码可以直接复制使用，记得把 <code>https://your.backend.com/...</code> 换成你自己的服务地址。</p>
</blockquote>
<pre><code class="hljs language-scss" lang="scss">package com<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.meetinglens</span>

import android<span class="hljs-selector-class">.content</span><span class="hljs-selector-class">.Context</span>
import android<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Base64</span>
import android<span class="hljs-selector-class">.util</span><span class="hljs-selector-class">.Log</span>
import androidx<span class="hljs-selector-class">.lifecycle</span><span class="hljs-selector-class">.LifecycleOwner</span>
import androidx<span class="hljs-selector-class">.lifecycle</span><span class="hljs-selector-class">.lifecycleScope</span>
import com<span class="hljs-selector-class">.rokid</span><span class="hljs-selector-class">.cxr</span><span class="hljs-selector-class">.client</span><span class="hljs-selector-class">.m</span><span class="hljs-selector-class">.CxrApi</span>
import com<span class="hljs-selector-class">.rokid</span><span class="hljs-selector-class">.cxr</span><span class="hljs-selector-class">.client</span><span class="hljs-selector-class">.m</span><span class="hljs-selector-class">.callback</span><span class="hljs-selector-class">.AudioStreamListener</span>
import com<span class="hljs-selector-class">.rokid</span><span class="hljs-selector-class">.cxr</span><span class="hljs-selector-class">.client</span><span class="hljs-selector-class">.m</span><span class="hljs-selector-class">.callback</span><span class="hljs-selector-class">.CustomViewListener</span>
import com<span class="hljs-selector-class">.rokid</span><span class="hljs-selector-class">.cxr</span><span class="hljs-selector-class">.client</span><span class="hljs-selector-class">.m</span><span class="hljs-selector-class">.utils</span><span class="hljs-selector-class">.ValueUtil</span>
import kotlinx<span class="hljs-selector-class">.coroutines</span>.*
import okhttp3<span class="hljs-selector-class">.MediaType</span><span class="hljs-selector-class">.Companion</span><span class="hljs-selector-class">.toMediaType</span>
import okhttp3<span class="hljs-selector-class">.OkHttpClient</span>
import okhttp3<span class="hljs-selector-class">.Request</span>
import okhttp3<span class="hljs-selector-class">.RequestBody</span><span class="hljs-selector-class">.Companion</span><span class="hljs-selector-class">.toRequestBody</span>
import org<span class="hljs-selector-class">.json</span><span class="hljs-selector-class">.JSONObject</span>

<span class="hljs-comment">/**
 * MeetingLensManager：会议透镜核心控制类
 * - 控制录音
 * - 调用后端 ASR / LLM
 * - 将纪要结果通过 Custom View 显示在眼镜上
 */</span>
class <span class="hljs-built_in">MeetingLensManager</span>(
    private val context: Context,
    private val owner: LifecycleOwner
) {

    companion <span class="hljs-selector-tag">object</span> {
        private const val TAG = "MeetingLens"
        private const val STREAM_TYPE = "meeting_assistant"
    }

    private val httpClient = <span class="hljs-built_in">OkHttpClient</span>()
    private val transcriptBuffer = <span class="hljs-built_in">StringBuilder</span>()
    private <span class="hljs-selector-tag">var</span> running = false
    private <span class="hljs-selector-tag">var</span> summaryJob: Job? = null

    // <span class="hljs-number">1</span>. 音频流监听器
    private val audioStreamListener = object : AudioStreamListener {
        override fun <span class="hljs-built_in">onStartAudioStream</span>(codecType: Int, streamType: String?) {
            Log<span class="hljs-selector-class">.d</span>(TAG, "Audio stream started: codec=$codecType, type=$streamType")
            transcriptBuffer<span class="hljs-selector-class">.clear</span>()
        }

        override fun <span class="hljs-built_in">onAudioStream</span>(data: ByteArray?, offset: Int, length: Int) {
            if (data == null || length &lt;= <span class="hljs-number">0</span>) return
            val chunk = data<span class="hljs-selector-class">.copyOfRange</span>(offset, offset + length)
            owner<span class="hljs-selector-class">.lifecycleScope</span><span class="hljs-selector-class">.launch</span>(Dispatchers.IO) {
                <span class="hljs-built_in">sendAudioChunkToAsr</span>(chunk)
            }
        }
    }

    <span class="hljs-comment">// 2. Custom View 状态监听（可选）</span>
    private val customViewListener = <span class="hljs-selector-tag">object</span> : CustomViewListener {
        override fun <span class="hljs-built_in">onOpened</span>() {
            Log<span class="hljs-selector-class">.d</span>(TAG, "CustomView opened")
        }

        override fun <span class="hljs-built_in">onClosed</span>() {
            Log<span class="hljs-selector-class">.d</span>(TAG, "CustomView closed")
        }

        override fun <span class="hljs-built_in">onOpenFailed</span>(code: Int) {
            Log<span class="hljs-selector-class">.e</span>(TAG, "CustomView open failed: $code")
        }

        override fun <span class="hljs-built_in">onIconsSent</span>() {}
        override fun <span class="hljs-built_in">onUpdated</span>() {}
    }

    <span class="hljs-comment">// ====================== 外部调用接口 ======================</span>

    <span class="hljs-comment">/** 开始一场会议 */</span>
    fun <span class="hljs-built_in">startMeeting</span>() {
        if (running) return
        running = true
        Log<span class="hljs-selector-class">.i</span>(TAG, "startMeeting()")

        <span class="hljs-comment">// 1. 设置音频监听</span>
        CxrApi<span class="hljs-selector-class">.getInstance</span>()<span class="hljs-selector-class">.setAudioStreamListener</span>(audioStreamListener)

        <span class="hljs-comment">// 2. 开启录音：2 = OPUS 编码</span>
        CxrApi<span class="hljs-selector-class">.getInstance</span>()<span class="hljs-selector-class">.openAudioRecord</span>(<span class="hljs-number">2</span>, STREAM_TYPE)

        <span class="hljs-comment">// 3. 打开眼镜端会议页面</span>
        <span class="hljs-built_in">openMeetingView</span>()

        <span class="hljs-comment">// 4. 设置 Custom View 监听（调试用）</span>
        CxrApi<span class="hljs-selector-class">.getInstance</span>()<span class="hljs-selector-class">.setCustomViewListener</span>(customViewListener)

        <span class="hljs-comment">// 5. 定时进行中间总结</span>
        summaryJob = owner<span class="hljs-selector-class">.lifecycleScope</span><span class="hljs-selector-class">.launch</span>(Dispatchers.IO) {
            while (running) {
                <span class="hljs-built_in">delay</span>(<span class="hljs-number">15</span>_000L) <span class="hljs-comment">// 每 15 秒总结一次</span>
                val text = transcriptBuffer<span class="hljs-selector-class">.toString</span>()
                if (text.isBlank()) continue
                val midSummary = <span class="hljs-built_in">summarizeOnBackend</span>(text, final = false)
                if (midSummary.isNotBlank()) {
                    <span class="hljs-built_in">updateSummaryOnGlasses</span>("中间小结：\n$midSummary")
                }
            }
        }

        <span class="hljs-built_in">updateSummaryOnGlasses</span>("纪要生成中，请自然发言…")
    }

    <span class="hljs-comment">/** 结束会议 */</span>
    fun <span class="hljs-built_in">stopMeeting</span>() {
        if (!running) return
        running = false
        Log<span class="hljs-selector-class">.i</span>(TAG, "stopMeeting()")

        <span class="hljs-comment">// 1. 停止录音</span>
        CxrApi<span class="hljs-selector-class">.getInstance</span>()<span class="hljs-selector-class">.closeAudioRecord</span>(STREAM_TYPE)
        CxrApi<span class="hljs-selector-class">.getInstance</span>()<span class="hljs-selector-class">.setAudioStreamListener</span>(null)

        <span class="hljs-comment">// 2. 停止中间总结任务</span>
        summaryJob?<span class="hljs-selector-class">.cancel</span>()
        summaryJob = null

        <span class="hljs-comment">// 3. 调用后端生成最终纪要</span>
        owner<span class="hljs-selector-class">.lifecycleScope</span><span class="hljs-selector-class">.launch</span>(Dispatchers.IO) {
            val finalText = transcriptBuffer<span class="hljs-selector-class">.toString</span>()
            val finalSummary = <span class="hljs-built_in">summarizeOnBackend</span>(finalText, final = true)
            if (finalSummary.isNotBlank()) {
                <span class="hljs-built_in">updateSummaryOnGlasses</span>("【本次会议最终纪要】\n$finalSummary")
            } else {
                <span class="hljs-built_in">updateSummaryOnGlasses</span>("本次会议纪要生成失败，请检查网络或后端服务")
            }
        }
    }

    <span class="hljs-comment">// ====================== 与后端交互 ======================</span>

    <span class="hljs-comment">/** 将音频切片发送到 ASR 后端，获取 partial_text */</span>
    private fun <span class="hljs-built_in">sendAudioChunkToAsr</span>(chunk: ByteArray) {
        try {
            val base64 = Base64<span class="hljs-selector-class">.encodeToString</span>(chunk, Base64.NO_WRAP)
            val json = <span class="hljs-built_in">JSONObject</span>()<span class="hljs-selector-class">.apply</span> {
                <span class="hljs-built_in">put</span>("audio_base64", base64)
                <span class="hljs-built_in">put</span>("stream_type", STREAM_TYPE)
            }<span class="hljs-selector-class">.toString</span>()

            val request = Request<span class="hljs-selector-class">.Builder</span>()
                <span class="hljs-selector-class">.url</span>("https://your.backend.com/asr/stream") <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 替换为你的 ASR 接口</span>
                <span class="hljs-selector-class">.post</span>(json.toRequestBody("application/json".toMediaType()))
                <span class="hljs-selector-class">.build</span>()

            httpClient<span class="hljs-selector-class">.newCall</span>(request)<span class="hljs-selector-class">.execute</span>()<span class="hljs-selector-class">.use</span> { resp -&gt;
                if (!resp.isSuccessful) return
                val <span class="hljs-selector-tag">body</span> = resp<span class="hljs-selector-class">.body</span>?<span class="hljs-selector-class">.string</span>()<span class="hljs-selector-class">.orEmpty</span>()
                if (body.isBlank()) return
                val obj = <span class="hljs-built_in">JSONObject</span>(body)
                val partial = obj<span class="hljs-selector-class">.optString</span>("partial_text", "")
                if (partial.isNotBlank()) {
                    transcriptBuffer<span class="hljs-selector-class">.append</span>(partial)<span class="hljs-selector-class">.append</span>('\n')
                }
            }
        } catch (e: Exception) {
            Log<span class="hljs-selector-class">.e</span>(TAG, "sendAudioChunkToAsr error: ${e.message}", e)
        }
    }

    <span class="hljs-comment">/** 调用 LLM 后端进行纪要总结 */</span>
    private fun <span class="hljs-built_in">summarizeOnBackend</span>(text: String, final: Boolean): String {
        if (text.isBlank()) return ""
        return try {
            val json = <span class="hljs-built_in">JSONObject</span>()<span class="hljs-selector-class">.apply</span> {
                <span class="hljs-built_in">put</span>("transcript", text)
                <span class="hljs-built_in">put</span>("final", final) <span class="hljs-comment">// final=true 使用更重模型</span>
            }<span class="hljs-selector-class">.toString</span>()

            val request = Request<span class="hljs-selector-class">.Builder</span>()
                <span class="hljs-selector-class">.url</span>("https://your.backend.com/meeting/summarize") <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 替换为你的 Summary 接口</span>
                <span class="hljs-selector-class">.post</span>(json.toRequestBody("application/json".toMediaType()))
                <span class="hljs-selector-class">.build</span>()

            httpClient<span class="hljs-selector-class">.newCall</span>(request)<span class="hljs-selector-class">.execute</span>()<span class="hljs-selector-class">.use</span> { resp -&gt;
                if (!resp.isSuccessful) return ""
                val <span class="hljs-selector-tag">body</span> = resp<span class="hljs-selector-class">.body</span>?<span class="hljs-selector-class">.string</span>()<span class="hljs-selector-class">.orEmpty</span>()
                if (body.isBlank()) return ""
                val obj = <span class="hljs-built_in">JSONObject</span>(body)
                obj<span class="hljs-selector-class">.optString</span>("summary", "")
            }
        } catch (e: Exception) {
            Log<span class="hljs-selector-class">.e</span>(TAG, "summarizeOnBackend error: ${e.message}", e)
            ""
        }
    }

    <span class="hljs-comment">// ====================== 眼镜端 UI：Custom View ======================</span>

    <span class="hljs-comment">/** 打开会议透镜的基础页面 */</span>
    private fun <span class="hljs-built_in">openMeetingView</span>() {
        val pageJson = """
        {
          "type": <span class="hljs-string">"LinearLayout"</span>,
          <span class="hljs-string">"props"</span>: {
            "id": <span class="hljs-string">"root_layout"</span>,
            <span class="hljs-string">"layout_width"</span>: <span class="hljs-string">"match_parent"</span>,
            <span class="hljs-string">"layout_height"</span>: <span class="hljs-string">"match_parent"</span>,
            <span class="hljs-string">"orientation"</span>: <span class="hljs-string">"vertical"</span>,
            <span class="hljs-string">"gravity"</span>: <span class="hljs-string">"top"</span>,
            <span class="hljs-string">"paddingTop"</span>: <span class="hljs-string">"40dp"</span>,
            <span class="hljs-string">"paddingStart"</span>: <span class="hljs-string">"12dp"</span>,
            <span class="hljs-string">"paddingEnd"</span>: <span class="hljs-string">"12dp"</span>,
            <span class="hljs-string">"backgroundColor"</span>: <span class="hljs-string">"#80000000"</span>
          },
          "children": [
            {
              "type": <span class="hljs-string">"TextView"</span>,
              <span class="hljs-string">"props"</span>: {
                "id": <span class="hljs-string">"tv_title"</span>,
                <span class="hljs-string">"layout_width"</span>: <span class="hljs-string">"wrap_content"</span>,
                <span class="hljs-string">"layout_height"</span>: <span class="hljs-string">"wrap_content"</span>,
                <span class="hljs-string">"text"</span>: <span class="hljs-string">"会议透镜 · Meeting Lens"</span>,
                <span class="hljs-string">"textSize"</span>: <span class="hljs-string">"16sp"</span>,
                <span class="hljs-string">"textColor"</span>: <span class="hljs-string">"#FFFFFFFF"</span>,
                <span class="hljs-string">"textStyle"</span>: <span class="hljs-string">"bold"</span>,
                <span class="hljs-string">"marginBottom"</span>: <span class="hljs-string">"8dp"</span>
              }
            },
            {
              "type": <span class="hljs-string">"TextView"</span>,
              <span class="hljs-string">"props"</span>: {
                "id": <span class="hljs-string">"tv_summary"</span>,
                <span class="hljs-string">"layout_width"</span>: <span class="hljs-string">"match_parent"</span>,
                <span class="hljs-string">"layout_height"</span>: <span class="hljs-string">"wrap_content"</span>,
                <span class="hljs-string">"text"</span>: <span class="hljs-string">"纪要生成中，请自然发言…"</span>,
                <span class="hljs-string">"textSize"</span>: <span class="hljs-string">"12sp"</span>,
                <span class="hljs-string">"textColor"</span>: <span class="hljs-string">"#FFDDDDDD"</span>
              }
            },
            {
              "type": <span class="hljs-string">"TextView"</span>,
              <span class="hljs-string">"props"</span>: {
                "id": <span class="hljs-string">"tv_hint"</span>,
                <span class="hljs-string">"layout_width"</span>: <span class="hljs-string">"wrap_content"</span>,
                <span class="hljs-string">"layout_height"</span>: <span class="hljs-string">"wrap_content"</span>,
                <span class="hljs-string">"text"</span>: <span class="hljs-string">"提示：结束前可口头确认关键决策"</span>,
                <span class="hljs-string">"textSize"</span>: <span class="hljs-string">"10sp"</span>,
                <span class="hljs-string">"textColor"</span>: <span class="hljs-string">"#FF00FF00"</span>,
                <span class="hljs-string">"marginTop"</span>: <span class="hljs-string">"8dp"</span>
              }
            }
          ]
        }
        """<span class="hljs-selector-class">.trimIndent</span>()

        CxrApi<span class="hljs-selector-class">.getInstance</span>()<span class="hljs-selector-class">.openCustomView</span>(pageJson)
    }

    <span class="hljs-comment">/** 更新眼镜上的纪要内容（只改 tv_summary） */</span>
    private fun <span class="hljs-built_in">updateSummaryOnGlasses</span>(summary: String) {
        val <span class="hljs-attribute">display</span> = if (summary.length &gt; <span class="hljs-number">400</span>) {
            <span class="hljs-selector-tag">summary</span><span class="hljs-selector-class">.substring</span>(<span class="hljs-number">0</span>, <span class="hljs-number">400</span>) + "..."
        } else <span class="hljs-selector-tag">summary</span>

        val updateJson = """
        <span class="hljs-selector-attr">[          {            <span class="hljs-string">"action"</span>: <span class="hljs-string">"update"</span>,            <span class="hljs-string">"id"</span>: <span class="hljs-string">"tv_summary"</span>,            <span class="hljs-string">"props"</span>: {              <span class="hljs-string">"text"</span>: ${JSONObject.quote(display)}            }          }        ]</span>
        """<span class="hljs-selector-class">.trimIndent</span>()

        CxrApi<span class="hljs-selector-class">.getInstance</span>()<span class="hljs-selector-class">.updateCustomView</span>(updateJson)
    }
}
</code></pre>
<h3 data-id="heading-24">6.3 在 Activity 中调用</h3>
<p>在你的 Activity 里，只需要实例化并调用即可：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MeetingActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> meetingLensManager: MeetingLensManager

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContentView(R.layout.activity_meeting)

        meetingLensManager = MeetingLensManager(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>)

        findViewById&lt;Button&gt;(R.id.btnStart).setOnClickListener {
            meetingLensManager.startMeeting()
        }

        findViewById&lt;Button&gt;(R.id.btnStop).setOnClickListener {
            meetingLensManager.stopMeeting()
        }
    }
}
</code></pre>
<p>前提：</p>
<ul>
<li>已经用 CXR-M 连接上眼镜（蓝牙已连）</li>
<li>权限已经申请完成</li>
<li>后端的 <code>/asr/stream</code> 和 <code>/meeting/summarize</code> 接口可用</li>
</ul>
<h3 data-id="heading-25">6.4 后端接口的最小约定（方便你自己实现）</h3>
<p>你可以先定义一个<strong>非常简单</strong>的协议：</p>
<ul>
<li>
<p><code>POST /asr/stream</code></p>
<ul>
<li>请求：<code>{ "audio_base64": "..." }</code></li>
<li>响应：<code>{ "partial_text": "我们这季度的核心目标是..." }</code></li>
</ul>
</li>
<li>
<p><code>POST /meeting/summarize</code></p>
<ul>
<li>请求：<code>{ "transcript": "...长文本...", "final": true/false }</code></li>
<li>响应：<code>{ "summary": "本次会议围绕 X 展开，形成 3 个决策，分别是..." }</code></li>
</ul>
</li>
</ul>
<p>后端可以用：</p>
<ul>
<li>Python + FastAPI + Whisper + 任意大模型</li>
<li>或者直接接云上的 ASR / LLM 服务（省事但花钱）</li>
</ul>
<h2 data-id="heading-26">踩坑与工程经验</h2>
<h3 data-id="heading-27">7.1 权限不全导致 SDK 静默失败</h3>
<ul>
<li>蓝牙相关权限必须一次性申请：<code>BLUETOOTH</code> / <code>BLUETOOTH_ADMIN</code> / <code>BLUETOOTH_SCAN</code> / <code>BLUETOOTH_CONNECT</code> / <code>FINE_LOCATION</code></li>
<li>未授权时 CXR-M 很多接口直接不可用，建议在初始化前加一层完整检查</li>
</ul>
<h3 data-id="heading-28">7.2 音频流与 ASR 的边界对齐</h3>
<ul>
<li><code>AudioStreamListener</code> 推来的数据是<strong>连续流</strong>，需要自己切片 + 时间戳管理</li>
<li>记得在 <code>onStartAudioStream</code> 重置缓冲区</li>
<li>建议使用 10～20ms 帧长的内部队列，对接大多数 ASR 引擎更友好</li>
</ul>
<h3 data-id="heading-29">7.3 Wi-Fi P2P 兼容与降级策略</h3>
<ul>
<li>
<p>部分机型对 Wi-Fi Direct 支持不好，CXR 回调里可能返回 <code>WIFI_CONNECT_FAILED</code></p>
</li>
<li>
<p>建议：</p>
<ul>
<li>实时纪要全部走音频流 + 文本，不依赖 Wi-Fi</li>
<li>会后录音备份 / 多媒体附件再尝试 Wi-Fi，同步失败则提示用户改为手机本地保存</li>
</ul>
</li>
</ul>
<h3 data-id="heading-30">7.4 Custom View 复杂度与性能</h3>
<ul>
<li>图片不超过 128×128 px，数量不要太多（&lt; 10 张）</li>
<li>布局树不要太深，多用 <code>LinearLayout</code> / <code>RelativeLayout</code> 做简单排版</li>
<li>更新时尽量用 <code>updateCustomView</code> 做局部更新，避免频繁 reopen</li>
</ul>
<p>会议助手场景下，最好只在视野边缘放一个小卡片，不要铺满屏幕，以免影响用户看人 / 看 PPT。</p>
<h3 data-id="heading-31">7.5 电量与亮度、音量管理</h3>
<p>CXR-M 提供了：</p>
<ul>
<li>亮度监听与设置：<code>setGlassBrightness</code> / <code>BrightnessUpdateListener</code></li>
<li>音量监听与设置：<code>setGlassVolume</code> / <code>VolumeUpdateListener</code></li>
<li>电量监听：<code>setBatteryLevelUpdateListener</code></li>
</ul>
<p>可以做一些自动优化，例如：</p>
<ul>
<li>进入会议后自动把亮度调到中档，减少干扰</li>
<li>电量低于 20% 时，在眼镜端弹出小提示</li>
</ul>
<h2 data-id="heading-32">小结：从「记录会议」到「为决策服务」</h2>
<p>「会议透镜（Meeting Lens）」本质上做了三件事：</p>
<ol start="0">
<li>用 <strong>CXR-M SDK</strong> 把 <strong>眼镜的麦克风 + 显示屏</strong> 接入到手机的 AI 工作流中；</li>
<li>用 <strong>ASR</strong> <strong>+</strong> <strong>LLM</strong>，把“谁在什么时间说了什么”变成“有哪些议题、结论和行动项”；</li>
<li>用 <strong>提词器</strong> <strong>/ 自定义页面</strong>，把真正重要的信息适时地浮现到用户眼前。</li>
</ol>
<p>从工程角度看，它验证了：</p>
<ul>
<li>手机 + 眼镜 可以像一个统一的「会议终端」：眼镜负责感知 &amp; 显示，手机负责计算与联网。</li>
<li>CXR 提供的场景能力（AI 场景、提词器、翻译、自定义页面）可以很好地承载「实时会议状态」这类信息。</li>
</ul>
<p>从体验角度看，它把开会这件事从：</p>
<blockquote>
<p>「我得边听边记，生怕漏掉一个数字」</p>
</blockquote>
<p>变成：</p>
<blockquote>
<p>「我只需要好好讨论，剩下的交给 AI 和眼镜。」</p>
</blockquote>
<p>如果你已经有一台 Rokid 眼镜和一台 Android 手机，那么你离自己的「会议透镜」其实只差几步：</p>
<ol start="0">
<li>用 CXR-M 把眼镜连到手机；</li>
<li>打开音频流，接入你熟悉的 ASR 服务；</li>
<li>设计一套适合你团队的 LLM 纪要 Prompt；</li>
<li>用提词器或 Custom View，把实时要点和最后纪要推回眼镜。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 DeepSeek + MateChat 的证券智能投顾技术实践：打造金融领域的专属大Q模型助手]]></title>    <link>https://juejin.cn/post/7577321767347355694</link>    <guid>https://juejin.cn/post/7577321767347355694</guid>    <pubDate>2025-11-28T06:53:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577321767347355694" data-draft-id="7577321767347339310" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 DeepSeek + MateChat 的证券智能投顾技术实践：打造金融领域的专属大Q模型助手"/> <meta itemprop="keywords" content="前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-28T06:53:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="中杯可乐多加冰"/> <meta itemprop="url" content="https://juejin.cn/user/3435306702347432"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 DeepSeek + MateChat 的证券智能投顾技术实践：打造金融领域的专属大Q模型助手
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3435306702347432/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    中杯可乐多加冰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T06:53:46.000Z" title="Fri Nov 28 2025 06:53:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>随着AI大模型技术的突破性发展，证券行业正经历从传统"人海战术"向"人机协同"的深刻转型。据IDC报告显示，2024年中国金融业对AI及生成式AI的投入规模达196.94亿元，预计到2027年将增长至415.48亿元。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e116e0a7fd2c409ea7cf96497a5eccba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764917626&amp;x-signature=4MQBn7EcZTsMNBdmUKLk7uM8Um4%3D" alt="" loading="lazy"/></p>
<p>然而，传统投顾服务效率低，标准化不高，个性化能力有限，如何基于金融领域数据构建安全可靠的智能投顾系统，成为证券行业数字化转型的关键课题。在这一背景下， MateChat 框架为证券智能投顾系统的快速构建提供了理想的解决方案。</p>
<p>本文将探索并实践基于 MateChat 框架的证券智能投顾技术方案，详细阐述其架构设计、训练流程和部署策略，为金融科技开发者提供一套可落地的技术解决方案。</p>
<h2 data-id="heading-0">一、架构解析</h2>
<h4 data-id="heading-1">1.1、MateChat 框架概览</h4>
<p>MateChat 是一款生成式人工智能体验设计系统，以及企业级前端解决方案。其基于OpenAI、Midjourney、Google、Claude等业界领先的AI大模型厂商提供的API，实现了一站式多模型AI应用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d758f0456e540eb8a0dde396461f65f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764917626&amp;x-signature=iMqtC7QN43ukaYZ2TSTXYYie%2FLI%3D" alt="" loading="lazy"/></p>
<p>它以Vue3和TypeScript为基础，结合了组件化设计理念，提供了如McBubble（消息气泡组件）、McLayout（对话布局容器）、McInput（输入组件）等一系列与对话交互相关的组件。不仅支持Markdown语法，还提供了代码高亮、复制、折叠等功能，极大地丰富了对话内容的表现形式。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0c6c0f14e6c4d7888469c74309906d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764917626&amp;x-signature=QwzhSDZUUcSrNCPp0AqxLpUHtFM%3D" alt="" loading="lazy"/></p>
<p>此外，MateChat还具备主题定制能力，支持明暗色模式切换以及通过CSS变量进行扩展，满足不同用户对于界面风格的需求。这些特性使得MateChat在构建智能对话界面时具有高度的灵活性和可扩展性，为证券智能投顾系统的前端开发提供了有力支持。</p>
<h4 data-id="heading-2">1.2、证券智能投顾平台定位</h4>
<p>构建证券智能投顾系统时，我们采用了分层架构设计，将整个系统分为数据层、服务层和应用层。数据层主要负责实时行情数据的接入、用户行为数据的收集、知识图谱的构建以及历史数据的存储，为系统提供丰富的数据支持。服务层则是整个系统的核心，集成了NLP语义理解、风险评估模型、投资组合优化以及合规风控引擎等功能模块，通过对数据层提供的数据进行分析和处理，生成智能投顾所需的各类服务。应用层则主要面向用户，提供了MateChat对话界面，实现了多轮对话管理、个性化推荐以及实时监控面板等功能，为用户提供了便捷、高效的智能投顾体验。</p>
<h4 data-id="heading-3">1.3、MateChat组件架构</h4>
<p>在前端实现方面，MateChat的组件架构发挥了关键作用。通过McLayout组件，我们搭建了一个简洁、清晰的对话布局容器，为用户与系统之间的对话提供了一个良好的交互环境。McBubble组件则负责以气泡形式展示对话内容，使得对话信息更加直观易读。McInput组件为用户提供了一个便捷的输入框，支持用户输入各种形式的问题或指令。此外，McPrompt组件提供了快捷提示功能，帮助用户快速触发一些常用的操作或查询。而McMarkdownCard组件则能够将Markdown格式的内容进行渲染，使得系统回复的内容可以包含丰富的格式和排版效果，如图表、代码等，进一步提升了用户体验。这些组件相互配合，构建了一个功能强大且具有高度可定制性的智能投顾对话界面。</p>
<h2 data-id="heading-4">二、打造金融领域的专属大模型助手</h2>
<h3 data-id="heading-5">2.1、环境准备</h3>
<p>首先进入控制台，输入<code>npm create vite@latest</code>使用vite首先初始化一个<code>vue+ts</code>项目，选择Vue和JS：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c452ed76bad64491897e7cf4f29ce53a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764917626&amp;x-signature=7zJjLAXVgw6KdFPoeGkEQ551Esw%3D" alt="" loading="lazy"/></p>
<p>然后输入：<code>npm i vue-devui @matechat/core @devui-design/icons</code> ，安装所需的依赖文件，这里要注意使用node 20.19+或者 22.12+的版本，否则无法使用vite。</p>
<p>然后，在<code>main.ts</code>文件中引入<code>matechat</code>, <code>图标库</code> 样式文件</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>;

<span class="hljs-keyword">import</span> <span class="hljs-title class_">MateChat</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@matechat/core'</span>;

<span class="hljs-keyword">import</span> <span class="hljs-string">'@devui-design/icons/icomoon/devui-icon.css'</span>;

<span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>).<span class="hljs-title function_">use</span>(<span class="hljs-title class_">MateChat</span>).<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>);
</code></pre>
<p>之后，就可以在任意文件中使用 MateChat 组件了，比如：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">McLayout</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">McHeader</span> <span class="hljs-attr">:title</span>=<span class="hljs-string">"'MateChat'"</span> <span class="hljs-attr">:logoImg</span>=<span class="hljs-string">"'https://matechat.gitcode.com/logo.svg'"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">operationArea</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"operations"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"icon-helping"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">McHeader</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">McLayoutContent</span>
      <span class="hljs-attr">v-if</span>=<span class="hljs-string">"startPage"</span>
      <span class="hljs-attr">style</span>=<span class="hljs-string">"display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px"</span>
    &gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">McIntroduction</span>
        <span class="hljs-attr">:logoImg</span>=<span class="hljs-string">"'https://matechat.gitcode.com/logo2x.svg'"</span>
        <span class="hljs-attr">:title</span>=<span class="hljs-string">"'MateChat'"</span>
        <span class="hljs-attr">:subTitle</span>=<span class="hljs-string">"'Hi，欢迎使用 MateChat'"</span>
        <span class="hljs-attr">:description</span>=<span class="hljs-string">"description"</span>
      &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">McIntroduction</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">McPrompt</span>
        <span class="hljs-attr">:list</span>=<span class="hljs-string">"introPrompt.list"</span>
        <span class="hljs-attr">:direction</span>=<span class="hljs-string">"introPrompt.direction"</span>
        <span class="hljs-attr">class</span>=<span class="hljs-string">"intro-prompt"</span>
        @<span class="hljs-attr">itemClick</span>=<span class="hljs-string">"onSubmit($event.label)"</span>
      &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">McPrompt</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">McLayoutContent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">McLayoutContent</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content-container"</span> <span class="hljs-attr">v-else</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">template</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(msg, idx) in messages"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"idx"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">McBubble</span>
          <span class="hljs-attr">v-if</span>=<span class="hljs-string">"msg.from === 'user'"</span>
          <span class="hljs-attr">:content</span>=<span class="hljs-string">"msg.content"</span>
          <span class="hljs-attr">:align</span>=<span class="hljs-string">"'right'"</span>
          <span class="hljs-attr">:avatarConfig</span>=<span class="hljs-string">"{ imgSrc: 'https://matechat.gitcode.com/png/demo/userAvatar.svg' }"</span>
        &gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">McBubble</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">McBubble</span> <span class="hljs-attr">v-else</span> <span class="hljs-attr">:content</span>=<span class="hljs-string">"msg.content"</span> <span class="hljs-attr">:avatarConfig</span>=<span class="hljs-string">"{ imgSrc: 'https://matechat.gitcode.com/logo.svg' }"</span> <span class="hljs-attr">:loading</span>=<span class="hljs-string">"msg.loading"</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">McBubble</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">McLayoutContent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"shortcut"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"display: flex; align-items: center; gap: 8px"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">McPrompt</span>
        <span class="hljs-attr">v-if</span>=<span class="hljs-string">"!startPage"</span>
        <span class="hljs-attr">:list</span>=<span class="hljs-string">"simplePrompt"</span>
        <span class="hljs-attr">:direction</span>=<span class="hljs-string">"'horizontal'"</span>
        <span class="hljs-attr">style</span>=<span class="hljs-string">"flex: 1"</span>
        @<span class="hljs-attr">itemClick</span>=<span class="hljs-string">"onSubmit($event.label)"</span>
      &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">McPrompt</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
        <span class="hljs-attr">style</span>=<span class="hljs-string">"margin-left: auto"</span>
        <span class="hljs-attr">icon</span>=<span class="hljs-string">"add"</span>
        <span class="hljs-attr">shape</span>=<span class="hljs-string">"circle"</span>
        <span class="hljs-attr">title</span>=<span class="hljs-string">"新建对话"</span>
        <span class="hljs-attr">size</span>=<span class="hljs-string">"md"</span>
        @<span class="hljs-attr">click</span>=<span class="hljs-string">"newConversation"</span>
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">McLayoutSender</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">McInput</span> <span class="hljs-attr">:value</span>=<span class="hljs-string">"inputValue"</span> <span class="hljs-attr">:maxLength</span>=<span class="hljs-string">"2000"</span> @<span class="hljs-attr">change</span>=<span class="hljs-string">"(e) =&gt; (inputValue = e)"</span> @<span class="hljs-attr">submit</span>=<span class="hljs-string">"onSubmit"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">extra</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"input-foot-wrapper"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"input-foot-left"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(item, index) in inputFootIcons"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"index"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">i</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"item.icon"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>
                {{ item.text }}
              <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"input-foot-dividing-line"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"input-foot-maxlength"</span>&gt;</span>{{ inputValue.length }}/2000<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"input-foot-right"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">icon</span>=<span class="hljs-string">"op-clearup"</span> <span class="hljs-attr">shape</span>=<span class="hljs-string">"round"</span> <span class="hljs-attr">:disabled</span>=<span class="hljs-string">"!inputValue"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"inputValue = ''"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"demo-button-content"</span>&gt;</span>清空输入<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">McInput</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">McLayoutSender</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">McLayout</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-devui/button'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'vue-devui/button/style.css'</span>;

<span class="hljs-keyword">const</span> description = [
  <span class="hljs-string">'MateChat 可以辅助研发人员编码、查询知识和相关作业信息、编写文档等。'</span>,
  <span class="hljs-string">'作为AI模型，MateChat 提供的答案可能不总是确定或准确的，但您的反馈可以帮助 MateChat 做的更好。'</span>,
];
<span class="hljs-keyword">const</span> introPrompt = {
  <span class="hljs-attr">direction</span>: <span class="hljs-string">'horizontal'</span>,
  <span class="hljs-attr">list</span>: [
    {
      <span class="hljs-attr">value</span>: <span class="hljs-string">'quickSort'</span>,
      <span class="hljs-attr">label</span>: <span class="hljs-string">'帮我写一个快速排序'</span>,
      <span class="hljs-attr">iconConfig</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'icon-info-o'</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'#5e7ce0'</span> },
      <span class="hljs-attr">desc</span>: <span class="hljs-string">'使用 js 实现一个快速排序'</span>,
    },
    {
      <span class="hljs-attr">value</span>: <span class="hljs-string">'helpMd'</span>,
      <span class="hljs-attr">label</span>: <span class="hljs-string">'你可以帮我做些什么？'</span>,
      <span class="hljs-attr">iconConfig</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'icon-star'</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'rgb(255, 215, 0)'</span> },
      <span class="hljs-attr">desc</span>: <span class="hljs-string">'了解当前大模型可以帮你做的事'</span>,
    },
    {
      <span class="hljs-attr">value</span>: <span class="hljs-string">'bindProjectSpace'</span>,
      <span class="hljs-attr">label</span>: <span class="hljs-string">'怎么绑定项目空间'</span>,
      <span class="hljs-attr">iconConfig</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'icon-priority'</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'#3ac295'</span> },
      <span class="hljs-attr">desc</span>: <span class="hljs-string">'如何绑定云空间中的项目'</span>,
    },
  ],
};
<span class="hljs-keyword">const</span> simplePrompt = [
  {
    <span class="hljs-attr">value</span>: <span class="hljs-string">'quickSort'</span>,
    <span class="hljs-attr">iconConfig</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'icon-info-o'</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'#5e7ce0'</span> },
    <span class="hljs-attr">label</span>: <span class="hljs-string">'帮我写一个快速排序'</span>,
  },
  {
    <span class="hljs-attr">value</span>: <span class="hljs-string">'helpMd'</span>,
    <span class="hljs-attr">iconConfig</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'icon-star'</span>, <span class="hljs-attr">color</span>: <span class="hljs-string">'rgb(255, 215, 0)'</span> },
    <span class="hljs-attr">label</span>: <span class="hljs-string">'你可以帮我做些什么？'</span>,
  },
];
<span class="hljs-keyword">const</span> startPage = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">true</span>);
<span class="hljs-keyword">const</span> inputValue = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>);
<span class="hljs-keyword">const</span> inputFootIcons = [
  { <span class="hljs-attr">icon</span>: <span class="hljs-string">'icon-at'</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'智能体'</span> },
  { <span class="hljs-attr">icon</span>: <span class="hljs-string">'icon-standard'</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'词库'</span> },
  { <span class="hljs-attr">icon</span>: <span class="hljs-string">'icon-add'</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'附件'</span> },
];

<span class="hljs-keyword">const</span> messages = ref&lt;any[]&gt;([]);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">newConversation</span> = (<span class="hljs-params"/>) =&gt; {
  startPage.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
  messages.<span class="hljs-property">value</span> = [];
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">onSubmit</span> = (<span class="hljs-params">evt</span>) =&gt; {
  inputValue.<span class="hljs-property">value</span>=<span class="hljs-string">''</span>;
  startPage.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  <span class="hljs-comment">// 用户发送消息</span>
  messages.<span class="hljs-property">value</span>.<span class="hljs-title function_">push</span>({
    <span class="hljs-attr">from</span>: <span class="hljs-string">'user'</span>,
    <span class="hljs-attr">content</span>: evt,
  });
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 模型返回消息</span>
    messages.<span class="hljs-property">value</span>.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">from</span>: <span class="hljs-string">'model'</span>,
      <span class="hljs-attr">content</span>: evt,
    });
  }, <span class="hljs-number">200</span>);
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">1000px</span>;
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">20px</span> auto;
  <span class="hljs-attribute">height</span>: <span class="hljs-built_in">calc</span>(<span class="hljs-number">100vh</span> - <span class="hljs-number">82px</span>);
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">8px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#fff</span>;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ddd</span>;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">16px</span>;
}

<span class="hljs-selector-class">.content-container</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: column;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">8px</span>;
  <span class="hljs-attribute">overflow</span>: auto;
}

<span class="hljs-selector-class">.input-foot-wrapper</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">justify-content</span>: space-between;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">8px</span>;

  <span class="hljs-selector-class">.input-foot-left</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">align-items</span>: center;
    <span class="hljs-attribute">gap</span>: <span class="hljs-number">8px</span>;

    <span class="hljs-selector-tag">span</span> {
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
      <span class="hljs-attribute">line-height</span>: <span class="hljs-number">18px</span>;
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#252b3a</span>;
      <span class="hljs-attribute">cursor</span>: pointer;
    }

    <span class="hljs-selector-class">.input-foot-dividing-line</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">1px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">14px</span>;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#d7d8da</span>;
    }

    <span class="hljs-selector-class">.input-foot-maxlength</span> {
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#71757f</span>;
    }
  }

  <span class="hljs-selector-class">.input-foot-right</span> {
    <span class="hljs-selector-class">.demo-button-content</span> {
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
    }

    &amp; &gt; *<span class="hljs-selector-pseudo">:not</span>(<span class="hljs-selector-pseudo">:first</span>-child) {
      <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">8px</span>;
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>显示出Hello，MateChat这样，即为安装成功：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/903e2f880b1c49b2850ef1c13a5b726b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764917626&amp;x-signature=8W%2ByGnUFwhKKtC%2FLB%2BRT9ChRtOE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">2.2、对接DeepSeek API</h3>
<p>首先要安装OpenAI支持，直接终端输入npm install openai安装依赖</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dee98992fc12463dbc62106f6d35aa7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764917626&amp;x-signature=IU9A%2BjndTcU%2BKZl5qBoVI8UmzQE%3D" alt="" loading="lazy"/></p>
<p>然后需要对接API，这里我们以DeepSeek为例，DeepSeek API 使用与 OpenAI 兼容的 API 格式，首先，前往DeepSeek开发平台，创建API Key：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4c87c83082c4a14916daaf4542c1701~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764917626&amp;x-signature=h%2Fycna71wIlrTWH9QTlTOMuGjNE%3D" alt="" loading="lazy"/></p>
<p>然后将代码中onSubmit方法替换成接入DeepSeek的代码：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df8d0ddf1f0841b9b70da4fc21bece28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764917626&amp;x-signature=L18xjaHvdBMJ0%2FAg75w08nG%2F%2Bmw%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">client</span> = ref&lt;OpenAI&gt;()<span class="hljs-comment">;</span>

<span class="hljs-attr">client.value</span> = new OpenAI({
  apiKey: '', // 模型APIKey
  baseURL: '', // 模型API地址
  dangerouslyAllowBrowser: true, // 浏览器环境使用需要开启
})<span class="hljs-comment">;</span>

const <span class="hljs-attr">onSubmit</span> = (evt) =&gt; {
  <span class="hljs-attr">inputValue.value</span> = <span class="hljs-string">''</span><span class="hljs-comment">;</span>
  <span class="hljs-attr">startPage.value</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
  // 用户发送消息
  messages.value.push({
    from: 'user',
    content: evt,
    avatarConfig: { name: 'user' },
  })<span class="hljs-comment">;</span>

  fetchData(evt)<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

const <span class="hljs-attr">fetchData</span> = async (ques) =&gt; {
  messages.value.push({
    from: 'model',
    content: '',
    avatarConfig: { name: 'model' },
    id: '',
    loading: true,
  })<span class="hljs-comment">;</span>
  const <span class="hljs-attr">completion</span> = await client.value!.chat.completions.create({
    model: 'deepseek-reasoner', // 根据deepseek模型列表进行替换
    messages: <span class="hljs-section">[{ role: 'user', content: ques }]</span>,
    stream: true, // 为 true 则开启接口的流式返回
  })<span class="hljs-comment">;</span>
  messages.value<span class="hljs-section">[messages.value.length - 1]</span>.<span class="hljs-attr">loading</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
  for await (const chunk of completion) {
    const <span class="hljs-attr">content</span> = chunk.choices[<span class="hljs-number">0</span>]?.delta?.content || <span class="hljs-string">''</span><span class="hljs-comment">;</span>
    const <span class="hljs-attr">chatId</span> = chunk.id<span class="hljs-comment">;</span>
    messages.value<span class="hljs-section">[messages.value.length - 1]</span>.content += content<span class="hljs-comment">;</span>
    messages.value<span class="hljs-section">[messages.value.length - 1]</span>.<span class="hljs-attr">id</span> = chatId<span class="hljs-comment">;</span>
  }
}<span class="hljs-comment">;</span>
</code></pre>
<p>并且填入刚刚复制的API key，baseURL就填<a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.deepseek.com%2Fv1%25E5%258D%25B3%25E5%258F%25AF%25E6%2588%2590%25E5%258A%259F%25E8%25B0%2583%25E7%2594%25A8deepseek" target="_blank" title="https://api.deepseek.com/v1%E5%8D%B3%E5%8F%AF%E6%88%90%E5%8A%9F%E8%B0%83%E7%94%A8deepseek" ref="nofollow noopener noreferrer">api.deepseek.com/v1即可成功调用dee…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d05db67b3c44a548affdc91cd6c122f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764917626&amp;x-signature=lxhv6zSmHdApfZ4%2B5U4gzuZZsZQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">2.3、开始改造</h3>
<p>在完成基础API对接后，参考金融领域的特点，借鉴MateChat在智能对话和业务集成方面的设计理念，对金融助手进行全面的功能增强和业务逻辑优化：</p>
<p>首先针对金融领域构建对应的提示词，让模型在分析当前对话，能够自动根据金融话题类型（如股票分析、风险评估、财务规划），自动构建领域特定的提示词模板，提示词库如下：</p>
<pre><code class="hljs language-css" lang="css">// 提示词库
export const PROMPT_TEMPLATES: Record&lt;FinancialTopic, FinancialPromptTemplate&gt; = {
  <span class="hljs-selector-attr">[FinancialTopic.STOCK_ANALYSIS]</span>: {
    topic: <span class="hljs-string">'股票分析'</span>,
    template: `作为专业金融分析师，请对{stockName}进行全面的投资价值分析。

请按照以下框架进行分析：
<span class="hljs-number">1</span>. 基本面分析：包括财务指标（市盈率、市净率、ROE等）、盈利能力、成长性
<span class="hljs-number">2</span>. 技术面分析：价格走势、成交量、技术指标
<span class="hljs-number">3</span>. 行业分析：行业地位、竞争格局、发展前景
<span class="hljs-number">4</span>. 估值分析：合理估值区间、投资建议

要求：
- 提供具体数据支撑
- 分析要客观全面
- 给出明确的风险提示
- 建议要具有可操作性`,
    requiredMetrics: [<span class="hljs-string">'市盈率'</span>, <span class="hljs-string">'市净率'</span>, <span class="hljs-string">'ROE'</span>, <span class="hljs-string">'营收增长率'</span>, <span class="hljs-string">'净利润增长率'</span>],
    qualityCriteria: [<span class="hljs-string">'数据准确性'</span>, <span class="hljs-string">'分析深度'</span>, <span class="hljs-string">'风险提示'</span>, <span class="hljs-string">'可操作性'</span>]
  },
  <span class="hljs-selector-attr">[FinancialTopic.INVESTMENT_STRATEGY]</span>: {
    topic: <span class="hljs-string">'投资策略'</span>,
    template: `作为专业投资顾问，请为{riskProfile}风险偏好的投资者制定投资策略。

投资目标：{investmentGoal}
投资期限：{timeHorizon}

请提供：
<span class="hljs-number">1</span>. 资产配置建议（股票、债券、现金等比例）
<span class="hljs-number">2</span>. 具体投资标的推荐
<span class="hljs-number">3</span>. 风险管理措施
<span class="hljs-number">4</span>. 定期调整策略

要求：
- 策略要符合风险偏好
- 提供历史回测数据
- 考虑市场环境因素
- 给出明确的执行步骤`,
    requiredMetrics: [<span class="hljs-string">'预期收益率'</span>, <span class="hljs-string">'最大回撤'</span>, <span class="hljs-string">'夏普比率'</span>, <span class="hljs-string">'资产相关性'</span>],
    qualityCriteria: [<span class="hljs-string">'风险匹配度'</span>, <span class="hljs-string">'历史表现'</span>, <span class="hljs-string">'适应性'</span>, <span class="hljs-string">'执行可行性'</span>]
  },
  <span class="hljs-selector-attr">[FinancialTopic.RISK_ASSESSMENT]</span>: {
    topic: <span class="hljs-string">'风险评估'</span>,
    template: `作为专业风险评估师，请对{investmentTarget}进行全面的风险评估。

评估维度：
<span class="hljs-number">1</span>. 市场风险：价格波动、系统性风险
<span class="hljs-number">2</span>. 信用风险：违约概率、信用评级
<span class="hljs-number">3</span>. 流动性风险：变现能力、交易成本
<span class="hljs-number">4</span>. 操作风险：管理风险、技术风险

要求：
- 使用量化风险评估方法
- 提供风险等级评分
- 给出风险控制建议
- 考虑极端市场情况`,
    requiredMetrics: [<span class="hljs-string">'波动率'</span>, <span class="hljs-string">'VAR值'</span>, <span class="hljs-string">'最大回撤'</span>, <span class="hljs-string">'信用评级'</span>],
    qualityCriteria: [<span class="hljs-string">'量化程度'</span>, <span class="hljs-string">'全面性'</span>, <span class="hljs-string">'实用性'</span>, <span class="hljs-string">'前瞻性'</span>]
  },
  <span class="hljs-selector-attr">[FinancialTopic.FINANCIAL_PLANNING]</span>: {
    topic: <span class="hljs-string">'财务规划'</span>,
    template: `作为专业财务规划师，请为{clientProfile}制定个性化的财务规划方案。

当前财务状况：{currentSituation}
财务目标：{financialGoals}

规划内容：
<span class="hljs-number">1</span>. 现金流管理：收入支出优化
<span class="hljs-number">2</span>. 资产配置：投资组合建议
<span class="hljs-number">3</span>. 风险管理：保险规划
<span class="hljs-number">4</span>. 税务优化：合理避税策略

要求：
- 方案要个性化定制
- 考虑生命周期阶段
- 提供具体执行计划
- 包含定期评估机制`,
    requiredMetrics: [<span class="hljs-string">'现金流'</span>, <span class="hljs-string">'资产负债率'</span>, <span class="hljs-string">'储蓄率'</span>, <span class="hljs-string">'投资回报率'</span>],
    qualityCriteria: [<span class="hljs-string">'个性化程度'</span>, <span class="hljs-string">'全面性'</span>, <span class="hljs-string">'可执行性'</span>, <span class="hljs-string">'长期性'</span>]
  }
};
</code></pre>
<p>其次，通过预设的金融专业知识图谱和关键指标检查清单，对AI返回的内容进行自动质量评分。当检测到回答过于笼统或缺乏具体数据支撑时，系统会触发自动追问机制，要求补充具体案例或数据依据，确保输出内容达到金融专业标准部分核心代码如下；</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 话题检测函数</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">detectFinancialTopic</span>(<span class="hljs-params">userInput: <span class="hljs-built_in">string</span></span>): <span class="hljs-title class_">FinancialTopic</span> | <span class="hljs-literal">null</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">topicKeywords</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">FinancialTopic</span>, <span class="hljs-built_in">string</span>[]&gt; = {
    [<span class="hljs-title class_">FinancialTopic</span>.<span class="hljs-property">STOCK_ANALYSIS</span>]: [<span class="hljs-string">'股票'</span>, <span class="hljs-string">'股价'</span>, <span class="hljs-string">'市盈率'</span>, <span class="hljs-string">'市净率'</span>, <span class="hljs-string">'财报'</span>, <span class="hljs-string">'估值'</span>],
    [<span class="hljs-title class_">FinancialTopic</span>.<span class="hljs-property">INVESTMENT_STRATEGY</span>]: [<span class="hljs-string">'投资'</span>, <span class="hljs-string">'策略'</span>, <span class="hljs-string">'组合'</span>, <span class="hljs-string">'配置'</span>, <span class="hljs-string">'资产'</span>, <span class="hljs-string">'收益'</span>],
    [<span class="hljs-title class_">FinancialTopic</span>.<span class="hljs-property">RISK_ASSESSMENT</span>]: [<span class="hljs-string">'风险'</span>, <span class="hljs-string">'评估'</span>, <span class="hljs-string">'波动'</span>, <span class="hljs-string">'回撤'</span>, <span class="hljs-string">'安全'</span>, <span class="hljs-string">'稳健'</span>],
    [<span class="hljs-title class_">FinancialTopic</span>.<span class="hljs-property">FINANCIAL_PLANNING</span>]: [<span class="hljs-string">'财务'</span>, <span class="hljs-string">'规划'</span>, <span class="hljs-string">'理财'</span>, <span class="hljs-string">'储蓄'</span>, <span class="hljs-string">'退休'</span>, <span class="hljs-string">'税务'</span>],
    [<span class="hljs-title class_">FinancialTopic</span>.<span class="hljs-property">MARKET_TREND</span>]: [<span class="hljs-string">'市场'</span>, <span class="hljs-string">'趋势'</span>, <span class="hljs-string">'行情'</span>, <span class="hljs-string">'预测'</span>, <span class="hljs-string">'宏观'</span>, <span class="hljs-string">'经济'</span>],
    [<span class="hljs-title class_">FinancialTopic</span>.<span class="hljs-property">PORTFOLIO_MANAGEMENT</span>]: [<span class="hljs-string">'组合'</span>, <span class="hljs-string">'管理'</span>, <span class="hljs-string">'优化'</span>, <span class="hljs-string">'再平衡'</span>, <span class="hljs-string">'分散'</span>]
  };

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> [topic, keywords] <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(topicKeywords)) {
    <span class="hljs-keyword">if</span> (keywords.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">keyword</span> =&gt;</span> userInput.<span class="hljs-title function_">includes</span>(keyword))) {
      <span class="hljs-keyword">return</span> topic <span class="hljs-keyword">as</span> <span class="hljs-title class_">FinancialTopic</span>;
    }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}

<span class="hljs-comment">// 提示词生成器</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateFinancialPrompt</span>(<span class="hljs-params">topic: FinancialTopic, context: Record&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; = {}</span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">const</span> template = <span class="hljs-variable constant_">PROMPT_TEMPLATES</span>[topic];
  <span class="hljs-keyword">if</span> (!template) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;

  <span class="hljs-keyword">let</span> prompt = template.<span class="hljs-property">template</span>;

  <span class="hljs-comment">// 替换模板中的变量</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(context).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {
    prompt = prompt.<span class="hljs-title function_">replace</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-string">`{<span class="hljs-subst">${key}</span>}`</span>, <span class="hljs-string">'g'</span>), value);
  });

  <span class="hljs-keyword">return</span> prompt;
}

<span class="hljs-comment">// 质量评分函数</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">assessAnswerQuality</span>(<span class="hljs-params">answer: <span class="hljs-built_in">string</span>, topic: FinancialTopic</span>): {
  <span class="hljs-attr">score</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">feedback</span>: <span class="hljs-built_in">string</span>[];
  <span class="hljs-attr">needsFollowUp</span>: <span class="hljs-built_in">boolean</span>;
} {
  <span class="hljs-keyword">const</span> template = <span class="hljs-variable constant_">PROMPT_TEMPLATES</span>[topic];
  <span class="hljs-keyword">if</span> (!template) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">score</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">feedback</span>: [<span class="hljs-string">'无法评估该话题的回答质量'</span>], <span class="hljs-attr">needsFollowUp</span>: <span class="hljs-literal">false</span> };
  }

  <span class="hljs-keyword">const</span> <span class="hljs-attr">feedback</span>: <span class="hljs-built_in">string</span>[] = [];
  <span class="hljs-keyword">let</span> score = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">let</span> criteriaMet = <span class="hljs-number">0</span>;

  <span class="hljs-comment">// 检查是否包含必要指标</span>
  template.<span class="hljs-property">requiredMetrics</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">metric</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (answer.<span class="hljs-title function_">includes</span>(metric)) {
      criteriaMet++;
      score += <span class="hljs-number">20</span>;
    } <span class="hljs-keyword">else</span> {
      feedback.<span class="hljs-title function_">push</span>(<span class="hljs-string">`缺少<span class="hljs-subst">${metric}</span>相关分析`</span>);
    }
  });

  <span class="hljs-comment">// 检查数据支撑</span>
  <span class="hljs-keyword">const</span> hasDataSupport = <span class="hljs-regexp">/\d+(.\d+)?%?/</span>.<span class="hljs-title function_">test</span>(answer) ||
    answer.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'数据'</span>) ||
    answer.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'统计'</span>) ||
    answer.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'报告'</span>);

  <span class="hljs-keyword">if</span> (hasDataSupport) {
    criteriaMet++;
    score += <span class="hljs-number">20</span>;
  } <span class="hljs-keyword">else</span> {
    feedback.<span class="hljs-title function_">push</span>(<span class="hljs-string">'回答缺乏具体数据支撑'</span>);
  }

  <span class="hljs-comment">// 检查分析深度</span>
  <span class="hljs-keyword">const</span> analysisDepth = (answer.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/\n/g</span>) || []).<span class="hljs-property">length</span> &gt; <span class="hljs-number">5</span>;
  <span class="hljs-keyword">if</span> (analysisDepth) {
    criteriaMet++;
    score += <span class="hljs-number">20</span>;
  } <span class="hljs-keyword">else</span> {
    feedback.<span class="hljs-title function_">push</span>(<span class="hljs-string">'分析深度不足，建议提供更详细的分析'</span>);
  }

  <span class="hljs-keyword">const</span> needsFollowUp = criteriaMet &lt; template.<span class="hljs-property">requiredMetrics</span>.<span class="hljs-property">length</span> / <span class="hljs-number">2</span>;

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">score</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-number">100</span>, score),
    feedback,
    needsFollowUp
  };
}

<span class="hljs-comment">// 自动追问生成器</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateFollowUpQuestion</span>(<span class="hljs-params">topic: FinancialTopic, missingMetrics: <span class="hljs-built_in">string</span>[]</span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">const</span> knowledge = <span class="hljs-variable constant_">FINANCIAL_KNOWLEDGE_GRAPH</span>[topic];
  <span class="hljs-keyword">if</span> (!knowledge) <span class="hljs-keyword">return</span> <span class="hljs-string">'请提供更详细的信息以便进行专业分析。'</span>;

  <span class="hljs-keyword">if</span> (missingMetrics.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`为了更好地进行<span class="hljs-subst">${PROMPT_TEMPLATES[topic]?.topic || <span class="hljs-string">'专业'</span>}</span>分析，请提供以下信息：<span class="hljs-subst">${missingMetrics.join(<span class="hljs-string">'、'</span>)}</span>相关的具体数据或情况。`</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-string">`为了提供更精准的分析，能否分享更多关于<span class="hljs-subst">${knowledge.keyMetrics.slice(<span class="hljs-number">0</span>, <span class="hljs-number">3</span>).join(<span class="hljs-string">'、'</span>)}</span>的信息？`</span>;
}
</code></pre>
<p>最后，在交互设计上，参考华为MateChat的工具集成思路，在对话流中无缝嵌入金融工具模块。用户可以在不中断对话的情况下，直接调用复利计算器进行收益测算，使用风险评估问卷进行风险承受能力评估，或者启动收益模拟器进行投资情景分析。这种深度集成的设计大大提升了用户体验和操作效率。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52e15c94f8564173b4d27f27e1ac8b7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764917626&amp;x-signature=OjzurRLJWxkPJCBh%2FWSL9jtG4zY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49ff42d240d44f568096df8a29096705~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764917626&amp;x-signature=uaVTItrrPyfUcjcsVB1kXIlMSts%3D" alt="" loading="lazy"/></p>
<p>当然，还可以进一步基于现有架构进行模块化扩展，提升金融助手的专业服务能力：</p>
<ul>
<li>实时行情监控功能 - 集成股票、基金、指数的实时价格数据，支持设置价格预警阈值，当标的达到目标价位时主动推送提醒。</li>
<li>财报智能解读功能 - 自动解析上市公司财务报表，提取关键财务比率，进行同业对比分析，生成通俗易懂的财务健康度报告。</li>
<li>市场情绪分析功能 - 整合网络舆情数据，运用自然语言处理技术分析市场情绪指数，为投资决策提供参考依据。</li>
</ul>
<h2 data-id="heading-8">三、总结</h2>
<p>在AI大模型技术迅猛发展的背景下，证券行业正经历着从传统服务模式向智能化、个性化服务的深刻转型。华为MateChat作为业界领先的AI对话组件库，以其完善的技术架构和灵活的组件化设计，为证券智能投顾系统的快速构建提供了理想的技术基础。</p>
<p>其专为GenAI对话打造的输入区域支持多模态内容输入和丰富的扩展功能。可配置的快捷指令、模板化输入和智能补全能力，让用户能够自由、准确地表达复杂需求。输入区域的模块化设计便于快速适配不同业务的特定需求，保持核心体验一致的同时支持灵活扩展。</p>
<p>在探索这一技术的过程中，我们也发现DevUI设计系统为构建高质量的用户界面提供了强大的支持。DevUI不仅提供了丰富的组件和灵活的定制能力，还注重设计的一致性和用户体验，能够帮助开发者更好地实现金融领域的复杂交互需求。如果你对MateChat框架的深度应用感兴趣，或者想了解如何通过DevUI打造更优质的用户交互体验，深入了解DevUI的丰富组件和设计理念，不妨关注<a href="https://link.juejin.cn?target=https%3A%2F%2Fmatechat.gitcode.com%2F" target="_blank" title="https://matechat.gitcode.com/" ref="nofollow noopener noreferrer">MateChat官网</a>和<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevui.design%2F" target="_blank" title="https://devui.design/" ref="nofollow noopener noreferrer">DevUI官网</a>，获取更多实用信息和技术支持，共同推动金融科技的创新与发展。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e348041bbb5482992d97d9356949f02~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lit5p2v5Y-v5LmQ5aSa5Yqg5Yaw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764917626&amp;x-signature=WRWzO2dn3s%2FqxOpjqJn6IlU0754%3D" alt="" loading="lazy"/></p>
<p>展望未来，随着多模态交互、实时数据处理等技术的持续演进，MateChat将在智能投顾领域展现出更大潜力，华为MateChat有望成为连接AI技术与金融服务的重要桥梁，推动整个行业向智能化、个性化服务的新阶段迈进。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[python学习之不同储存方式的操作方法]]></title>    <link>https://juejin.cn/post/7577395040593018890</link>    <guid>https://juejin.cn/post/7577395040593018890</guid>    <pubDate>2025-11-28T07:32:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577395040593018890" data-draft-id="7577438119558004787" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="python学习之不同储存方式的操作方法"/> <meta itemprop="keywords" content="Python,代码规范"/> <meta itemprop="datePublished" content="2025-11-28T07:32:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="李晨卓"/> <meta itemprop="url" content="https://juejin.cn/user/3053762234038564"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            python学习之不同储存方式的操作方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3053762234038564/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    李晨卓
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T07:32:07.000Z" title="Fri Nov 28 2025 07:32:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">知识清单</h2>
<p>字符串转义、数字类型操作、布尔类型的特征、列表的操作方法、元组的操作方法、集合的操作方法</p>
<h3 data-id="heading-1">字符串转义</h3>
<p>常用的有<code>\n</code>，表示换行，<code>\t</code>，表示在字符串之间加一个'TAB'键，相当于4个空格。而当我们不想转义时，不让<code>\n</code>、<code>\t</code>发挥作用，就要\n与\t，只表示普通的字符串\n与\t，没有其他特殊含义。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f6d4c05726c48509d4eb5411824026d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5pmo5Y2T:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764919927&amp;x-signature=KXCnW7nvlwyebgkEbrX%2FRnnwfek%3D" alt="Snipaste_2025-11-28_14-43-15.png" loading="lazy"/></p>
<h3 data-id="heading-2">数字类型操作</h3>
<p>赋值运算符与前端基础学习的基本一致，注意<code>\\=</code>是除法向下取整，而<code>**=n</code>这个n就是多少次幂。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa40a50f571b448c831818747b1a50e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5pmo5Y2T:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764919927&amp;x-signature=wb3Zqx4vnTbO0QTHSosXqYvjkUM%3D" alt="Snipaste_2025-11-28_14-46-49.png" loading="lazy"/></p>
<h3 data-id="heading-3">布尔类型的特征</h3>
<p>布尔类型的作用：用来作为判断的条件去用，布尔值只有True与False，不仅仅是真假，还是数据的有无，并且每个数据类型都有自己的布尔值，当出现None，0，空（空字符串、空列表、空字典）时，三种情况下布尔值为False。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/805dca9df5c14298affbd172df163779~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5pmo5Y2T:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764919927&amp;x-signature=6OGNh%2FYwvWBTZhrzN3OqEvTXe1A%3D" alt="Snipaste_2025-11-28_14-52-15.png" loading="lazy"/></p>
<h3 data-id="heading-4">列表的操作方法：增删改查</h3>
<h4 data-id="heading-5">增</h4>
<p>append(元素) -- 往列表末尾追加一个元素；要在末尾增加多个元素时，就要用到extend([元素])；而要在自定义位置加元素时，就要用到insert('索引','在索引前面新加的元素')</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bfa701f4c88d48d8827c1b4a6f39a0b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5pmo5Y2T:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764919927&amp;x-signature=UxSW2LUW8MSYVKEfzbdz0gwfmTk%3D" alt="Snipaste_2025-11-28_14-58-30.png" loading="lazy"/></p>
<h4 data-id="heading-6">删</h4>
<p>除了<code>del(索引)</code>之外，还有指定删除的<code>remove(元素)</code>，还有<code>pop(索引)</code>，即从列表中取走一个值等。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69afb6261b9a4a6ea3aaeaba09d7b4a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5pmo5Y2T:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764919927&amp;x-signature=QN3%2FWE14kSAajZpOy3OalbawVQI%3D" alt="Snipaste_2025-11-28_15-05-18.png" loading="lazy"/></p>
<h4 data-id="heading-7">改</h4>
<p><code>sort()</code> -- 排序(默认从低到高排序)，若添加反序，即 <code>名称.sort(reverse = True)</code>，则按从大到小的顺序排列。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e899900dc1844e7a9fe0a44702806ed5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5pmo5Y2T:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764919927&amp;x-signature=VCPg0vBXAgoOxrzsPe86O5Hi75s%3D" alt="Snipaste_2025-11-28_15-09-41.png" loading="lazy"/></p>
<h4 data-id="heading-8">查</h4>
<p>查看列表某个元素的个数，<code>count(元素)</code>，以及<code>index(元素)</code>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6f3db12014e4aaf9221795e1196dd70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5pmo5Y2T:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764919927&amp;x-signature=J707D0mHU9cF1gecIUBwEwgMrtc%3D" alt="Snipaste_2025-11-28_15-13-33.png" loading="lazy"/></p>
<h3 data-id="heading-9">元组的操作方法</h3>
<p>我们都知道，元组中的元素是不能以索引修改的，但元组里的列表中的元素是可以用索引修改的，为此，我们将元组转换为列表以后再修改就可以了，具体流程如下:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca4fc4ed6bc44a45a57296e713994f1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5pmo5Y2T:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764919927&amp;x-signature=6ljz58TqyNGjBzpODU5Or%2BPf2Ao%3D" alt="Snipaste_2025-11-28_15-18-47.png" loading="lazy"/></p>
<h3 data-id="heading-10">集合的操作方法：增删改查</h3>
<h4 data-id="heading-11">增</h4>
<p><code>add()</code>，括号里不能不填</p>
<h4 data-id="heading-12">删</h4>
<p><code>remove()</code>，括号里不能不填</p>
<h4 data-id="heading-13">改</h4>
<p><code>update()</code>，括号里可以不填,输出的还是原来的集合，但里面要加<code>[]</code>
还有集合转化为列表、列表转化为集合的方法如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/302f1b0bdd984985a4832898f0b7b276~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2O5pmo5Y2T:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764919927&amp;x-signature=p%2BXFmvKd%2BRhJVxv2OCQKNMOkP8Q%3D" alt="Snipaste_2025-11-28_15-23-48.png" loading="lazy"/></p>
<p>开源代码在<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2F" target="_blank" title="https://gitee.com/" ref="nofollow noopener noreferrer">gitee.com/</a>    点击代码片段的python3即可看到。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[实战：爬取某联招聘职位需求并生成词云——从零开始的完整指南]]></title>    <link>https://juejin.cn/post/7577668116499972134</link>    <guid>https://juejin.cn/post/7577668116499972134</guid>    <pubDate>2025-11-28T07:24:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577668116499972134" data-draft-id="7577668116499939366" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="实战：爬取某联招聘职位需求并生成词云——从零开始的完整指南"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-11-28T07:24:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="站大爷IP"/> <meta itemprop="url" content="https://juejin.cn/user/2905353241759261"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            实战：爬取某联招聘职位需求并生成词云——从零开始的完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2905353241759261/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    站大爷IP
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T07:24:01.000Z" title="Fri Nov 28 2025 07:24:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、项目背景：为什么我们要做这件事？</h2>
<p>在求职季，你是否曾对着成百上千的招聘信息发呆？HR每天要筛选数百份简历，求职者要在海量岗位中找方向。如果能用技术手段快速提取岗位核心需求，无论是求职者优化简历还是企业分析人才市场，都能事半功倍。</p>
<p>本文将手把手教你用Python爬取某联招聘的职位需求，并通过词云可视化展示高频关键词。整个过程分为三个阶段：数据采集（爬虫）、数据处理（清洗）、数据可视化（词云），即使没有编程基础也能跟着操作。</p>
<h2 data-id="heading-1">二、工具准备：需要哪些武器？</h2>
<h3 data-id="heading-2">1. 开发环境</h3>
<ul>
<li>Python 3.8+（推荐Anaconda集成环境）</li>
<li>代码编辑器：VS Code/PyCharm（选你顺手的）</li>
<li>浏览器：Chrome（用于查看网页结构）</li>
</ul>
<h3 data-id="heading-3">2. 核心库安装</h3>
<pre><code class="hljs">pip install requests beautifulsoup4 pandas wordcloud jieba matplotlib
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<ul>
<li><code>requests</code>：发送HTTP请求</li>
<li><code>BeautifulSoup</code>：解析HTML</li>
<li><code>pandas</code>：数据处理</li>
<li><code>wordcloud</code>：生成词云</li>
<li><code>jieba</code>：中文分词</li>
<li><code>matplotlib</code>：绘图展示</li>
</ul>
<h3 data-id="heading-4">3. 辅助工具</h3>
<ul>
<li>代理IP池（应对反爬）</li>
<li>Chrome开发者工具（按F12打开）</li>
</ul>
<h2 data-id="heading-5">三、数据采集：突破反爬陷阱</h2>
<h3 data-id="heading-6">1. 目标分析</h3>
<p>打开某联招聘官网（<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.***.com%25EF%25BC%2589%25EF%25BC%258C%25E4%25BB%25A5%2522Python%25E5%25BC%2580%25E5%258F%2591%2522%25E4%25B8%25BA%25E4%25BE%258B%25E6%2590%259C%25E7%25B4%25A2%25EF%25BC%259A" target="_blank" title="https://www.***.com%EF%BC%89%EF%BC%8C%E4%BB%A5%22Python%E5%BC%80%E5%8F%91%22%E4%B8%BA%E4%BE%8B%E6%90%9C%E7%B4%A2%EF%BC%9A" ref="nofollow noopener noreferrer">https://www.***.com），以"Python开发"为例搜索：</a></p>
<ol>
<li>观察URL结构：<code>https://sou.***.com/?kw=Python开发&amp;page=1</code></li>
<li>翻页规律：每页参数<code>page</code>递增</li>
<li>职位列表容器：通过开发者工具找到<code>.job-list ul li</code></li>
</ol>
<h3 data-id="heading-7">2. 基础爬虫代码</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">from</span> bs4 <span class="hljs-keyword">import</span> BeautifulSoup

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_job_list</span>(<span class="hljs-params">keyword, page</span>):
    url = <span class="hljs-string">f"https://sou.***.com/?kw=<span class="hljs-subst">{keyword}</span>&amp;page=<span class="hljs-subst">{page}</span>"</span>
    headers = {
        <span class="hljs-string">"User-Agent"</span>: <span class="hljs-string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"</span>
    }
    <span class="hljs-keyword">try</span>:
        response = requests.get(url, headers=headers, timeout=<span class="hljs-number">10</span>)
        <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>:
            soup = BeautifulSoup(response.text, <span class="hljs-string">'html.parser'</span>)
            jobs = []
            <span class="hljs-keyword">for</span> li <span class="hljs-keyword">in</span> soup.select(<span class="hljs-string">'.job-list ul li'</span>):
                title = li.select_one(<span class="hljs-string">'.job-title'</span>).text.strip()
                company = li.select_one(<span class="hljs-string">'.company-name'</span>).text.strip()
                salary = li.select_one(<span class="hljs-string">'.salary'</span>).text.strip() <span class="hljs-keyword">if</span> li.select_one(<span class="hljs-string">'.salary'</span>) <span class="hljs-keyword">else</span> <span class="hljs-string">"面议"</span>
                requirement = li.select_one(<span class="hljs-string">'.job-requirements'</span>).text.strip() <span class="hljs-keyword">if</span> li.select_one(<span class="hljs-string">'.job-requirements'</span>) <span class="hljs-keyword">else</span> <span class="hljs-string">""</span>
                jobs.append({
                    <span class="hljs-string">'title'</span>: title,
                    <span class="hljs-string">'company'</span>: company,
                    <span class="hljs-string">'salary'</span>: salary,
                    <span class="hljs-string">'requirement'</span>: requirement
                })
            <span class="hljs-keyword">return</span> jobs
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"请求失败，状态码：<span class="hljs-subst">{response.status_code}</span>"</span>)
            <span class="hljs-keyword">return</span> []
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"发生错误：<span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> []
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-8">3. 反爬策略升级</h3>
<p><strong>问题1：直接请求返回403</strong></p>
<ul>
<li>
<p>解决方案：添加更多请求头字段</p>
<pre><code class="hljs language-makefile" lang="makefile">headers = {
    <span class="hljs-string">"User-Agent"</span>: <span class="hljs-string">"..."</span>,
    <span class="hljs-string">"Referer"</span>: <span class="hljs-string">"https://www.***.com/"</span>,
    <span class="hljs-string">"Accept-Language"</span>: <span class="hljs-string">"zh-CN,zh;q=0.9"</span>,
    <span class="hljs-string">"Cookie"</span>: <span class="hljs-string">"你的浏览器cookie（可选）"</span>
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
</li>
</ul>
<p><strong>问题2：频繁请求被封IP</strong></p>
<ul>
<li>
<p>解决方案：使用代理IP池</p>
<pre><code class="hljs language-ini" lang="ini">import random

<span class="hljs-attr">proxies</span> = [
    {<span class="hljs-string">"http"</span>: <span class="hljs-string">"http://123.123.123.123:8080"</span>},
    {<span class="hljs-string">"http"</span>: <span class="hljs-string">"http://124.124.124.124:8081"</span>}
]

<span class="hljs-attr">response</span> = requests.get(url, headers=headers, proxies=random.choice(proxies), timeout=<span class="hljs-number">10</span>)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
</li>
</ul>
<p><strong>进阶技巧</strong>：</p>
<ul>
<li>使用<code>time.sleep(random.uniform(1,3))</code>添加随机延迟</li>
<li>购买付费代理服务（如快代理、芝麻代理）</li>
<li>分布式爬取（多线程/多进程）</li>
</ul>
<h3 data-id="heading-9">4. 完整采集流程</h3>
<pre><code class="hljs language-ini" lang="ini">def crawl_all_pages(keyword, <span class="hljs-attr">max_pages</span>=<span class="hljs-number">5</span>):
    <span class="hljs-attr">all_jobs</span> = []
    for page in range(1, max_pages+1):
        print(f"正在爬取第{page}页...")
        <span class="hljs-attr">jobs</span> = get_job_list(keyword, page)
        if not jobs:
            break
        all_jobs.extend(jobs)
        time.sleep(2)  <span class="hljs-comment"># 礼貌性延迟</span>
    return all_jobs

<span class="hljs-comment"># 执行爬取</span>
<span class="hljs-attr">jobs_data</span> = crawl_all_pages(<span class="hljs-string">"Python开发"</span>, <span class="hljs-number">3</span>)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-10">四、数据处理：提取核心需求</h2>
<h3 data-id="heading-11">1. 数据清洗</h3>
<pre><code class="hljs language-ini" lang="ini">import pandas as pd

<span class="hljs-attr">df</span> = pd.DataFrame(jobs_data)
<span class="hljs-comment"># 去除空值</span>
<span class="hljs-attr">df</span> = df.dropna(subset=[<span class="hljs-string">'requirement'</span>])
<span class="hljs-comment"># 保存原始数据（可选）</span>
df.to_csv('zhaopin_raw.csv', <span class="hljs-attr">index</span>=<span class="hljs-literal">False</span>, encoding=<span class="hljs-string">'utf_8_sig'</span>)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-12">2. 需求文本提取</h3>
<p>观察发现，职位描述通常包含：</p>
<ul>
<li>
<p>岗位职责（以"岗位职责："开头）</p>
</li>
<li>
<p>任职要求（以"任职要求："开头）</p>
</li>
<li>
<p>其他信息（公司福利等）</p>
<pre><code class="hljs language-scss" lang="scss">def <span class="hljs-built_in">extract_requirements</span>(text):
    if not text:
        return <span class="hljs-string">""</span>
    # 简单分割（实际可能需要更复杂的正则）
    parts = text.<span class="hljs-built_in">split</span>(<span class="hljs-string">'任职要求：'</span>)
    if <span class="hljs-built_in">len</span>(parts) &gt; <span class="hljs-number">1</span>:
        return parts[<span class="hljs-number">1</span>].<span class="hljs-built_in">split</span>(<span class="hljs-string">'职位福利：'</span>)[<span class="hljs-number">0</span>].<span class="hljs-built_in">strip</span>()
    else:
        return text.<span class="hljs-built_in">split</span>(<span class="hljs-string">'岗位职责：'</span>)[-<span class="hljs-number">1</span>].<span class="hljs-built_in">split</span>(<span class="hljs-string">'职位福利：'</span>)[<span class="hljs-number">0</span>].<span class="hljs-built_in">strip</span>()

df[<span class="hljs-string">'clean_require'</span>] = df[<span class="hljs-string">'requirement'</span>].<span class="hljs-built_in">apply</span>(extract_requirements)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
</li>
</ul>
<h3 data-id="heading-13">3. 合并所有需求文本</h3>
<pre><code class="hljs language-bash" lang="bash">all_requirements = <span class="hljs-string">' '</span>.<span class="hljs-built_in">join</span>(<span class="hljs-built_in">df</span>[<span class="hljs-string">'clean_require'</span>].tolist())
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-14">五、词云生成：可视化核心技能</h2>
<h3 data-id="heading-15">1. 中文分词处理</h3>
<pre><code class="hljs language-csharp" lang="csharp">import jieba

<span class="hljs-meta"># 添加自定义词典（可选）</span>
jieba.load_userdict(<span class="hljs-string">"tech_terms.txt"</span>)  <span class="hljs-meta"># 可自行准备技术术语词典</span>

<span class="hljs-meta"># 分词并过滤停用词</span>
stopwords = <span class="hljs-keyword">set</span>()
<span class="hljs-function"><span class="hljs-keyword">with</span> <span class="hljs-title">open</span>(<span class="hljs-params"><span class="hljs-string">'stopwords.txt'</span>, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span></span>) <span class="hljs-keyword">as</span> f:  # 停用词表
    <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> f:
        stopwords.<span class="hljs-title">add</span>(<span class="hljs-params">line.strip(</span>))

words</span> = [word <span class="hljs-keyword">for</span> word <span class="hljs-keyword">in</span> jieba.cut(all_requirements) 
         <span class="hljs-function"><span class="hljs-keyword">if</span> <span class="hljs-title">len</span>(<span class="hljs-params">word</span>) &gt; 1 <span class="hljs-keyword">and</span> word <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> stopwords <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> word.<span class="hljs-title">isspace</span>()]
word_str</span> = <span class="hljs-string">' '</span>.<span class="hljs-keyword">join</span>(words)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-16">2. 生成词云</h3>
<pre><code class="hljs language-ini" lang="ini">from wordcloud import WordCloud
import matplotlib.pyplot as plt

<span class="hljs-comment"># 设置词云参数</span>
<span class="hljs-attr">wc</span> = WordCloud(
    <span class="hljs-attr">font_path</span>=<span class="hljs-string">'simhei.ttf'</span>,  <span class="hljs-comment"># 中文字体文件路径</span>
    <span class="hljs-attr">background_color</span>=<span class="hljs-string">'white'</span>,
    <span class="hljs-attr">width</span>=<span class="hljs-number">800</span>,
    <span class="hljs-attr">height</span>=<span class="hljs-number">600</span>,
    <span class="hljs-attr">max_words</span>=<span class="hljs-number">100</span>,
    <span class="hljs-attr">max_font_size</span>=<span class="hljs-number">100</span>
)

<span class="hljs-comment"># 生成词云</span>
wc.generate(word_str)

<span class="hljs-comment"># 显示词云</span>
plt.figure(<span class="hljs-attr">figsize</span>=(<span class="hljs-number">10</span>, <span class="hljs-number">8</span>))
plt.imshow(wc, <span class="hljs-attr">interpolation</span>=<span class="hljs-string">'bilinear'</span>)
plt.axis('off')
plt.savefig('zhaopin_wordcloud.png', <span class="hljs-attr">dpi</span>=<span class="hljs-number">300</span>, bbox_inches=<span class="hljs-string">'tight'</span>)
plt.show()
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-17">3. 结果优化技巧</h3>
<ul>
<li>
<p><strong>调整形状</strong>：使用图片蒙版（需Pillow库）</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

mask = np.array(Image.<span class="hljs-built_in">open</span>(<span class="hljs-string">"python_logo.png"</span>))
wc = WordCloud(mask=mask, ...)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
</li>
<li>
<p><strong>颜色定制</strong>：通过<code>colormap</code>参数选择matplotlib配色方案</p>
</li>
<li>
<p><strong>词频统计</strong>：用<code>collections.Counter</code>查看高频词</p>
</li>
</ul>
<h2 data-id="heading-18">六、完整代码整合</h2>
<pre><code class="hljs language-ini" lang="ini">import requests
from bs4 import BeautifulSoup
import pandas as pd
import jieba
from wordcloud import WordCloud
import matplotlib.pyplot as plt
import time
import random

<span class="hljs-comment"># 1. 数据采集</span>
def get_job_list(keyword, page):
    <span class="hljs-attr">url</span> = f<span class="hljs-string">"https://sou.***.com/?kw={keyword}&amp;page={page}"</span>
    <span class="hljs-attr">headers</span> = {
        "User-Agent": "Mozilla/5.0...",
        "Referer": "https://www.***.com/"
    }
    try:
        <span class="hljs-attr">response</span> = requests.get(url, headers=headers, timeout=<span class="hljs-number">10</span>)
        if <span class="hljs-attr">response.status_code</span> == <span class="hljs-number">200</span>:
            <span class="hljs-attr">soup</span> = BeautifulSoup(response.text, <span class="hljs-string">'html.parser'</span>)
            <span class="hljs-attr">jobs</span> = []
            for li in soup.select('.job-list ul li'):
                <span class="hljs-comment"># 解析逻辑同上...</span>
            return jobs
        return <span class="hljs-section">[]</span>
    except:
        return <span class="hljs-section">[]</span>

<span class="hljs-comment"># 2. 数据处理</span>
def process_data(jobs_data):
    <span class="hljs-attr">df</span> = pd.DataFrame(jobs_data)
    <span class="hljs-attr">df</span> = df.dropna(subset=[<span class="hljs-string">'requirement'</span>])
    
    def extract_req(text):
        <span class="hljs-comment"># 提取逻辑同上...</span>
        pass
    
    df<span class="hljs-section">['clean_require']</span> = df<span class="hljs-section">['requirement']</span>.apply(extract_req)
    <span class="hljs-attr">all_text</span> = <span class="hljs-string">' '</span>.join(df[<span class="hljs-string">'clean_require'</span>].tolist())
    return all_text

<span class="hljs-comment"># 3. 生成词云</span>
def generate_wordcloud(text):
    <span class="hljs-attr">stopwords</span> = set([<span class="hljs-string">'可以'</span>, <span class="hljs-string">'能够'</span>, <span class="hljs-string">'具有'</span>, <span class="hljs-string">'等'</span>])  <span class="hljs-comment"># 示例停用词</span>
    <span class="hljs-attr">words</span> = [word for word in jieba.cut(text) 
             if len(word) &gt; <span class="hljs-number">1</span> and word not in stopwords]
    
    <span class="hljs-attr">wc</span> = WordCloud(
        <span class="hljs-attr">font_path</span>=<span class="hljs-string">'simhei.ttf'</span>,
        <span class="hljs-attr">width</span>=<span class="hljs-number">800</span>,
        <span class="hljs-attr">height</span>=<span class="hljs-number">600</span>
    ).generate(' '.join(words))
    
    plt.figure(<span class="hljs-attr">figsize</span>=(<span class="hljs-number">10</span>, <span class="hljs-number">8</span>))
    plt.imshow(wc)
    plt.axis('off')
    plt.savefig('output.png')
    plt.show()

<span class="hljs-comment"># 主流程</span>
if <span class="hljs-attr">__name__</span> == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-attr">keyword</span> = <span class="hljs-string">"Python开发"</span>
    <span class="hljs-attr">jobs</span> = []
    for page in range(1, 4):
        jobs.extend(get_job_list(keyword, page))
        time.sleep(2)
    
    <span class="hljs-attr">text</span> = process_data(jobs)
    generate_wordcloud(text)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-19">七、常见问题Q&amp;A</h2>
<p><strong>Q1：被网站封IP怎么办？</strong><br/>
A：立即启用备用代理池，建议使用住宅代理（如站大爷IP代理），配合每请求更换IP策略。更稳妥的方式是购买付费代理服务，这类代理通常有更高的匿名度和稳定性。</p>
<p><strong>Q2：如何获取更精准的职位描述？</strong><br/>
A：某联招聘的HTML结构可能变化，建议：</p>
<ol>
<li>按F12打开开发者工具</li>
<li>在Elements面板搜索关键词如"职责"</li>
<li>更新CSS选择器路径（如<code>.job-description &gt; p</code>）</li>
</ol>
<p><strong>Q3：词云中出现无关词汇怎么过滤？</strong><br/>
A：三步解决：</p>
<ol>
<li>扩充停用词表（添加"工作"、"经验"等常见词）</li>
<li>在分词后添加词性过滤（保留名词/动词）</li>
<li>设置<code>min_font_size</code>参数过滤低频词</li>
</ol>
<p><strong>Q4：如何爬取其他招聘网站？</strong><br/>
A：核心流程相同，需注意：</p>
<ol>
<li>分析目标网站的URL结构</li>
<li>调整CSS选择器匹配新页面</li>
<li>可能需要处理验证码（建议使用打码平台）</li>
</ol>
<p><strong>Q5：代码运行报错怎么办？</strong><br/>
A：按这个顺序排查：</p>
<ol>
<li>检查网络连接是否正常</li>
<li>确认目标网站是否改版（更新选择器）</li>
<li>查看完整错误信息（用try-except捕获异常）</li>
<li>在GitHub搜索类似错误解决方案</li>
</ol>
<h2 data-id="heading-20">八、进阶建议</h2>
<ol>
<li><strong>定时任务</strong>：用<code>schedule</code>库实现每天自动爬取</li>
<li><strong>数据存储</strong>：将结果存入MySQL/MongoDB</li>
<li><strong>分析扩展</strong>：统计不同城市的技能需求差异</li>
<li><strong>部署上线</strong>：用Flask搭建简单数据看板</li>
</ol>
<p>通过这个项目，你不仅掌握了网络爬虫和数据分析的基本技能，更重要的是建立了从数据采集到价值输出的完整思维链条。下次面对海量招聘信息时，你就可以用代码快速提炼关键信息，让技术真正服务于实际需求。</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OceanBase 年度发布会 Hands-on AI Workshop 回顾]]></title>    <link>https://juejin.cn/post/7577417823342100515</link>    <guid>https://juejin.cn/post/7577417823342100515</guid>    <pubDate>2025-11-28T07:56:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577417823342100515" data-draft-id="7577356848337813539" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OceanBase 年度发布会 Hands-on AI Workshop 回顾"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-11-28T07:56:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="老纪的技术唠嗑局"/> <meta itemprop="url" content="https://juejin.cn/user/2394058441104739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OceanBase 年度发布会 Hands-on AI Workshop 回顾
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2394058441104739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    老纪的技术唠嗑局
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T07:56:29.000Z" title="Fri Nov 28 2025 07:56:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"><strong>简介</strong></h3>
<p>本次 Workshop 是 OceanBase 新品发布会期间的特别活动，主要关注如何基于 OceanBase seekdb 快速构建 AI 原生应用。活动打破了常规的 PPT 宣讲模式，重点在于代码实操。在来自 LangChain Community、Dify 和 OceanBase 的技术专家指导下，现场数百名开发者在两小时内，基于 seekdb 实际动手完成了从环境部署、Agentic RAG 搭建到构建具备“长期记忆”智能体的完整开发流程。</p>
<p>现场小伙伴直观感受到了具备原生 AI 能力的轻量数据库是如何有效降低应用开发门槛的。本文将详细回顾这场实战 Workshop。</p>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/jpeg/32756313/1764316026243-adc1b9c9-3311-4737-95ad-29d41548fc49.jpeg" alt="" loading="lazy"/></p>
<h3 data-id="heading-1"><strong>一、OceanBase seekdb 介绍</strong></h3>
<p>本次 Workshop 的所有实验均基于 <strong>OceanBase seekdb</strong> 进行，这是 OceanBase 推出的面向 AI 应用场景的轻量嵌入式数据库。</p>
<p><strong>解决什么问题</strong>？在目前的 AI 应用开发架构中，开发者通常需要同时维护关系型数据库（存储结构化数据）和向量数据库（存储非结构化向量数据）。这种架构不仅带来了较高的数据一致性维护成本，还可能产生跨系统查询的延迟。seekdb 的设计目标是实现“结构化数据”与“非结构化向量数据”的统一存储与检索，并以 1C2G 轻量的方式简化 AI 应用的数据架构。</p>
<h3 data-id="heading-2"><strong>二、Workshop 环境配置环境指南</strong></h3>
<p>Workshop 的第一个环节是基础环境配置。现场为了规避 Wi-Fi 网络高并发可能带来的延迟，我们为每位参会者都准备了阿里云 ECS 云服务器作为实验环境。以下是本地电脑(Mac/Windows)详细安装流程(以 CLI 为主）：</p>
<ol>
<li>Docker (用于三个实验)
Mac: 下载 Docker Desktop 并安装。
Windows: 同样下载 Docker Desktop，需开启 WSL2，安装后启动 Docker 应用。</li>
<li>Python 3.10+ (用于三个实验)
下载 Python 官方安装包 进行安装。
安装完成后检查：</li>
</ol>
<pre><code class="hljs language-plain" lang="plain">python --version # 应输出 3.10 或更高
</code></pre>
<ol start="3">
<li>uv (Python 包管理器)</li>
</ol>
<pre><code class="hljs language-plain" lang="plain">pip install uv
</code></pre>
<ol start="4">
<li>seekdb (用于三个实验)</li>
</ol>
<p>我们将使用 Docker 快速启动一个 seekdb 实例。针对国内网络环境和不同的芯片架构，提供了相应的镜像源。</p>
<pre><code class="hljs language-plain" lang="plain"># 获取docker 镜像
docker pull swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/oceanbase/seekdb:latest
docker tag  swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/oceanbase/seekdb:latest  docker.io/oceanbase/seekdb:latest

# arm机器
docker pull swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/oceanbase/seekdb:latest-linuxarm64
docker tag  swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/oceanbase/seekdb:latest-linuxarm64  docker.io/oceanbase/seekdb:latest

# 方式一: docker 方式安装
docker run -d \
  --name seekdb \
  -p 2881:2881 \
  -v ./data:/var/lib/oceanbase/store \
  oceanbase/seekdb:latest
</code></pre>
<ol start="5">
<li>powermem (用于实验三)</li>
</ol>
<pre><code class="hljs language-plain" lang="plain">pip install powermem
</code></pre>
<ol start="6">
<li>Dify(用于实验二)</li>
</ol>
<pre><code class="hljs language-plain" lang="plain">git clone https://github.com/langgenius/dify.git
cd dify/docker
docker-compose up -d
</code></pre>
<ol start="7">
<li>Jupyter(用于实验一)</li>
</ol>
<pre><code class="hljs language-plain" lang="plain">pip install jupyter
</code></pre>
<ol start="8">
<li>Qoder:  下载: <a href="https://link.juejin.cn?target=https%3A%2F%2Fqoder.com%2Fdownload" target="_blank" title="https://qoder.com/download" ref="nofollow noopener noreferrer">qoder.com/download</a> (选择适合自己的电脑的qoder包下载，请注意 qoder 需要注册方可使用。）</li>
</ol>
<h3 data-id="heading-3"><strong>三、基于 LangChain V1 和 OceanBase seekdb</strong></h3>
<h3 data-id="heading-4"><strong>快速构建 Agentic RAG</strong></h3>
<p>讲师：LangChain Ambassador 张海立</p>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/jpeg/32756313/1764316026098-cab726cf-8dda-4e3c-aca7-d2b3dcfb64a9.jpeg" alt="" loading="lazy"/></p>
<p>本实验基于 <strong>LangChain v1</strong> 的最新 Agent 构建标准和 <strong>OceanBase seekdb</strong> 的向量存储和混合检索能力，让 AI 读懂一份 Nike 2023 财报（PDF），并能回答相关财务问题。 <strong>核心逻辑：</strong> 文档切片 -&gt; 存入 seekdb -&gt; 封装为 Tool -&gt; 绑定 Agent。</p>
<ul>
<li>将一份非结构化的 Nike 2023 财报 PDF 文档转化为计算机可理解的向量数据</li>
<li>通过定义检索工具并调用 LangChain v1 的 <code>create_agent</code> 接口，打造具备<strong>推理能力</strong>的 AI Agent。</li>
</ul>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/png/32756313/1764316026163-548e82b3-a30f-4861-946d-85631962196d.png" alt="" loading="lazy"/></p>
<h5 data-id="heading-5"><strong>核心操作步骤</strong></h5>
<p><strong>步骤 1：文档处理与向量化</strong> 首先，我们需要将 PDF 文档加载并切割成适合模型处理的小块（Chunks）。 在 LangChain 中，我们使用 <code>PyPDFLoader</code> 加载文档，然后使用 <code>RecursiveCharacterTextSplitter</code> 进行切分。</p>
<pre><code class="hljs language-plain" lang="plain">from langchain_community.vectorstores import OceanBase

# 初始化 OceanBase 向量存储
docsearch = OceanBase.from_documents(
    documents, 
    embeddings, 
    connection_string="127.0.0.1:2881..."
)
</code></pre>
<p>这一步在后台，seekdb 会自动创建一张表，并将文本的向量（Embedding Vector）和原始内容存储在同一行记录中。</p>
<p><strong>步骤 2：构建检索工具</strong> 我们将上一步生成的 <code>docsearch</code> 封装为一个 LangChain Tool。</p>
<pre><code class="hljs language-plain" lang="plain">retriever_tool = create_retriever_tool(
    docsearch.as_retriever(),
    "nike_financial_report",
    "搜索并返回关于 Nike 2023 财报的详细信息。"
)
</code></pre>
<p>注意 <code>description</code> 参数非常重要，LLM 会根据这段描述来判断何时调用这个工具。</p>
<p><strong>步骤 3：初始化 Agent 并执行</strong> 使用 LangChain V1 的 <code>create_tool_calling_agent</code> 接口，将 LLM（如 GPT-4 或通义千问）与我们定义的工具绑定。</p>
<p>详细步骤请参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fask.oceanbase.com%2Ft%2Ftopic%2F35634850" target="_blank" title="https://ask.oceanbase.com/t/topic/35634850" ref="nofollow noopener noreferrer">ask.oceanbase.com/t/topic/356…</a></p>
<h3 data-id="heading-6"><strong>四、基于 Dify 和 OceanBase，快速构建 AI 应用</strong></h3>
<p>讲师：郑立，Sr. Developer Relations, Dify</p>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/jpeg/32756313/1764316025998-dd697c4b-e177-4949-95b7-ab551a29cf65.jpeg" alt="" loading="lazy"/></p>
<p>本实验旨在验证 OceanBase seekdb 对 AI 应用的一体化支撑能力。通过部署 seekdb 并修改 Dify 核心配置，将原本分离的向量库与元数据库统一替换为 seekdb。在简化架构的同时，验证在 RAG 场景下的完整可用性。</p>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/png/32756313/1764316026165-93202818-adb1-4536-b933-2aac8ae5277e.png" alt="" loading="lazy"/></p>
<h5 data-id="heading-7"><strong>核心操作步骤</strong></h5>
<p><strong>步骤 1：修改 Docker Compose 配置</strong> 进入 Dify 的 <code>docker</code> 目录，编辑 <code>.env</code> 文件或 <code>docker-compose.yaml</code>。需要将 Dify 的数据库连接指向我们启动的 seekdb 容器。</p>
<p><strong>步骤 2：配置向量后端</strong> 在 Dify 的系统设置文件或环境变量中，将 Vector Store 的类型指定为 <code>OceanBase</code>。当用户在 Dify 界面上传知识库文件时，Dify 会将切片后的向量数据写入 seekdb 的向量表中。</p>
<p><strong>步骤 3：构建知识库应用</strong> 重启 Dify 容器组后，进入 Web 界面：</p>
<p>详细步骤请参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fask.oceanbase.com%2Ft%2Ftopic%2F35634856" target="_blank" title="https://ask.oceanbase.com/t/topic/35634856" ref="nofollow noopener noreferrer">ask.oceanbase.com/t/topic/356…</a></p>
<h3 data-id="heading-8"><strong>五、让 AI 记住你，基于 OceanBase 构建具备上下文记忆的智能体实践</strong></h3>
<p>讲师：汤庆 OceanBase 技术专家</p>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/jpeg/32756313/1764316026668-2d87f189-d25d-4b1e-ae54-fce75f62842c.jpeg" alt="" loading="lazy"/></p>
<p>本实验核心目标是解决 AI 智能体“遗忘”对话上下文的问题。通过集成 <strong>OceanBase seekdb</strong> 作为向量与结构化数据的混合存储底座，并使用 <strong>PowerMem</strong> 进行记忆管理，展示了如何让 AI 拥有“长期记忆”。</p>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2025/png/32756313/1764316062121-803695fb-31e9-486c-b57e-02b1fb2bead9.png" alt="" loading="lazy"/></p>
<p><strong>步骤 1：部署 PowerMem，Dify + PowerMem MCP 环境集成</strong>，我们在 Dify 环境中配置 PowerMem MCP，打通底层记忆通道。这一步也使其具备了访问 OceanBase seekdb 进行长久记忆存储与检索的能力。</p>
<p><strong>步骤 2：Vibe Coding 挑战</strong>，我们将一段提示词复制到 AI 编程助手 <strong>Qoder</strong> 中，要求它参照 PowerMem 的官方示例，自动生成一套代码审查智能体。</p>
<p>详细步骤请参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fask.oceanbase.com%2Ft%2Ftopic%2F35634483" target="_blank" title="https://ask.oceanbase.com/t/topic/35634483" ref="nofollow noopener noreferrer">ask.oceanbase.com/t/topic/356…</a></p>
<h2 data-id="heading-9"><strong>最后</strong></h2>
<p>通过上述三个实验，我们从不同维度验证了 OceanBase seekdb 在 AI 应用开发中的实际能力。本次 Workshop 只是一个起点。seekdb 的轻量化和易用性，旨在让每一位开发者都能在自己的笔记本上，以最低的成本探索 AI 原生应用的开发。</p>
<p>在此，我们要特别致谢参与本次社区生态共建的开源伙伴，感谢 Dify, LangChain Community, Qoder 的鼎力支持，感谢每一位参与的开发者。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[3小时快速集成：用Node.js + 星析API为你的SaaS项目添加跨境收款功能]]></title>    <link>https://juejin.cn/post/7577321767347093550</link>    <guid>https://juejin.cn/post/7577321767347093550</guid>    <pubDate>2025-11-28T06:27:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577321767347093550" data-draft-id="7577321767347060782" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="3小时快速集成：用Node.js + 星析API为你的SaaS项目添加跨境收款功能"/> <meta itemprop="keywords" content="运营,掘金日报"/> <meta itemprop="datePublished" content="2025-11-28T06:27:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="星析互联"/> <meta itemprop="url" content="https://juejin.cn/user/1370462103538153"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            3小时快速集成：用Node.js + 星析API为你的SaaS项目添加跨境收款功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1370462103538153/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    星析互联
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T06:27:00.000Z" title="Fri Nov 28 2025 06:27:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为全栈开发者，当你产品的第一个国际客户询问“能否用信用卡支付？”时，你知道是时候为你的SaaS项目集成跨境收款了。别担心，这并不需要数月之久。利用<strong>星析API</strong>和你熟悉的<strong>Node.js</strong>，我们可以在<strong>3小时内</strong>搭建一个健壮的生产级支付集成。</p>
<p>本教程将带你从零开始，完成从创建支付订单到安全接收支付通知的完整流程。</p>
<h4 data-id="heading-0"><strong>第一步：准备工作（15分钟）</strong></h4>
<ol>
<li>
<p><strong>注册星析账号</strong>：访问星析官网，注册商户账号并完成企业认证。</p>
</li>
<li>
<p><strong>获取API密钥</strong>：在开发者后台，你将获得两个关键信息：</p>
<ul>
<li><code>API_KEY</code>：用于身份验证的密钥。</li>
<li><code>WEBHOOK_SECRET</code>：用于验证Webhook请求签名的密钥。</li>
</ul>
</li>
<li>
<p><strong>初始化Node.js项目</strong>：</p>
<p>bash</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> payment-integration &amp;&amp; <span class="hljs-built_in">cd</span> payment-integration
npm init -y
npm install express axios crypto
</code></pre>
</li>
</ol>
<h4 data-id="heading-1"><strong>第二步：创建支付订单（核心代码，45分钟）</strong></h4>
<p>我们在服务端创建一个API端点，用于向星析发起支付请求。</p>
<p><strong>代码片段：<code>server.js</code></strong></p>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> axios = <span class="hljs-built_in">require</span>(<span class="hljs-string">'axios'</span>);
<span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>);

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();
app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">json</span>());

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">API_BASE_URL</span> = <span class="hljs-string">'https://api.starsee.io/v1'</span>; <span class="hljs-comment">// 星析API地址</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">API_KEY</span> = <span class="hljs-string">'your_api_key_here'</span>; <span class="hljs-comment">// 替换为你的API_KEY</span>

<span class="hljs-comment">// 创建支付订单接口</span>
app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/create-payment'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> paymentPayload = {
      <span class="hljs-attr">amount</span>: <span class="hljs-number">1999</span>, <span class="hljs-comment">// 金额（单位：分，例如$19.99）</span>
      <span class="hljs-attr">currency</span>: <span class="hljs-string">'USD'</span>, <span class="hljs-comment">// 货币代码</span>
      <span class="hljs-attr">order_id</span>: <span class="hljs-string">`ORDER_<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>, <span class="hljs-comment">// 你的系统内唯一订单号</span>
      <span class="hljs-attr">product_name</span>: <span class="hljs-string">'Pro Plan Subscription'</span>,
      <span class="hljs-attr">customer</span>: {
        <span class="hljs-attr">email</span>: <span class="hljs-string">'customer@example.com'</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">'John Doe'</span>
      },
      <span class="hljs-attr">success_url</span>: <span class="hljs-string">'https://yourapp.com/success'</span>, <span class="hljs-comment">// 支付成功跳转地址</span>
      <span class="hljs-attr">cancel_url</span>: <span class="hljs-string">'https://yourapp.com/cancel'</span>   <span class="hljs-comment">// 支付取消跳转地址</span>
    };

    <span class="hljs-comment">// 调用星析API创建支付会话</span>
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">post</span>(<span class="hljs-string">`<span class="hljs-subst">${API_BASE_URL}</span>/payment_links`</span>, paymentPayload, {
      <span class="hljs-attr">headers</span>: {
        <span class="hljs-string">'Authorization'</span>: <span class="hljs-string">`Bearer <span class="hljs-subst">${API_KEY}</span>`</span>,
        <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>
      }
    });

    <span class="hljs-comment">// 返回支付链接给前端，引导用户跳转</span>
    res.<span class="hljs-title function_">json</span>({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">payment_url</span>: response.<span class="hljs-property">data</span>.<span class="hljs-property">payment_url</span> <span class="hljs-comment">// 用户在此完成支付</span>
    });

  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// 错误处理最佳实践</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Error creating payment:'</span>, error.<span class="hljs-property">response</span>?.<span class="hljs-property">data</span> || error.<span class="hljs-property">message</span>);
    
    <span class="hljs-comment">// 根据星析API返回的错误码进行精细化处理</span>
    <span class="hljs-keyword">const</span> statusCode = error.<span class="hljs-property">response</span>?.<span class="hljs-property">status</span>;
    <span class="hljs-keyword">let</span> userMessage = <span class="hljs-string">'Payment system is temporarily unavailable.'</span>;

    <span class="hljs-keyword">if</span> (statusCode &gt;= <span class="hljs-number">400</span> &amp;&amp; statusCode &lt; <span class="hljs-number">500</span>) {
      <span class="hljs-comment">// 客户端错误：如参数错误、身份验证失败</span>
      userMessage = <span class="hljs-string">'Invalid payment request. Please check your information.'</span>;
    }
    <span class="hljs-comment">// 5xx错误我们已记录，返回通用错误信息</span>

    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">json</span>({
      <span class="hljs-attr">success</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">message</span>: userMessage
    });
  }
});

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PORT</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span> || <span class="hljs-number">3000</span>;
app.<span class="hljs-title function_">listen</span>(<span class="hljs-variable constant_">PORT</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Server running on port <span class="hljs-subst">${PORT}</span>`</span>));
</code></pre>
<p><strong>前端调用示例（简单版）：</strong><br/>
前端只需调用你自己的 <code>/api/create-payment</code> 接口，然后跳转至返回的 <code>payment_url</code> 即可。</p>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 前端代码 (例如React组件)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handlePayment</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/create-payment'</span>, { <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span> });
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
    
    <span class="hljs-keyword">if</span> (data.<span class="hljs-property">success</span>) {
      <span class="hljs-comment">// 跳转到星析支付页面</span>
      <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = data.<span class="hljs-property">payment_url</span>;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">alert</span>(data.<span class="hljs-property">message</span>);
    }
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-title function_">alert</span>(<span class="hljs-string">'Failed to initiate payment.'</span>);
  }
}
</code></pre>
<h4 data-id="heading-2"><strong>第三步：处理Webhook（支付通知，60分钟）</strong></h4>
<p>用户支付成功后，星析会通过Webhook异步通知你的服务器。这是<strong>确保订单状态最终一致性的关键</strong>，比依赖前端回调更可靠。</p>
<p><strong>代码片段：在<code>server.js</code>中添加</strong></p>
<p>javascript</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 处理星析Webhook</span>
app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/api/webhook/starsee'</span>, express.<span class="hljs-title function_">raw</span>({<span class="hljs-attr">type</span>: <span class="hljs-string">'application/json'</span>}), <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">WEBHOOK_SECRET</span> = <span class="hljs-string">'your_webhook_secret_here'</span>; <span class="hljs-comment">// 替换为你的WEBHOOK_SECRET</span>

  <span class="hljs-keyword">const</span> signature = req.<span class="hljs-property">headers</span>[<span class="hljs-string">'x-starsee-signature'</span>];
  <span class="hljs-keyword">const</span> payload = req.<span class="hljs-property">body</span>;

  <span class="hljs-comment">// **安全关键：验证Webhook请求来源**</span>
  <span class="hljs-keyword">const</span> expectedSignature = crypto
    .<span class="hljs-title function_">createHmac</span>(<span class="hljs-string">'sha256'</span>, <span class="hljs-variable constant_">WEBHOOK_SECRET</span>)
    .<span class="hljs-title function_">update</span>(payload)
    .<span class="hljs-title function_">digest</span>(<span class="hljs-string">'hex'</span>);

  <span class="hljs-keyword">if</span> (signature !== expectedSignature) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Invalid webhook signature.'</span>);
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">401</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">'Invalid signature'</span>);
  }

  <span class="hljs-comment">// 签名验证通过，解析 payload</span>
  <span class="hljs-keyword">const</span> event = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(payload.<span class="hljs-title function_">toString</span>());

  <span class="hljs-comment">// 处理不同的事件类型</span>
  <span class="hljs-keyword">switch</span> (event.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'payment.succeeded'</span>:
      <span class="hljs-comment">// 核心业务逻辑：支付成功</span>
      <span class="hljs-keyword">const</span> { order_id, payment_id, amount } = event.<span class="hljs-property">data</span>;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Order <span class="hljs-subst">${order_id}</span> (Payment: <span class="hljs-subst">${payment_id}</span>) paid <span class="hljs-subst">${amount}</span> successfully.`</span>);
      
      <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 更新你数据库中的订单状态</span>
      <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 发送确认邮件、开通服务权限等</span>
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">case</span> <span class="hljs-string">'payment.failed'</span>:
      <span class="hljs-comment">// 处理支付失败逻辑</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Payment for order <span class="hljs-subst">${event.data.order_id}</span> failed.`</span>);
      <span class="hljs-keyword">break</span>;

    <span class="hljs-attr">default</span>:
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Unhandled event type: <span class="hljs-subst">${event.<span class="hljs-keyword">type</span>}</span>`</span>);
  }

  <span class="hljs-comment">// 成功处理，返回200状态码</span>
  res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">json</span>({ <span class="hljs-attr">received</span>: <span class="hljs-literal">true</span> });
});
</code></pre>
<p><strong>Webhook配置指南：</strong></p>
<ol>
<li>在星析开发者后台，配置你的Webhook URL（例如 <code>https://yourdomain.com/api/webhook/starsee</code>）。</li>
<li><strong>务必使用<code>express.raw</code>中间件</strong>，因为我们需要原始的请求体来计算签名。</li>
<li><strong>签名验证是必须的</strong>，否则可能会处理恶意伪造的请求。</li>
<li>处理逻辑中<strong>一定要做好幂等性处理</strong>，因为Webhook可能会重试发送。</li>
</ol>
<h4 data-id="heading-3"><strong>第四步：测试与上线（60分钟）</strong></h4>
<ol>
<li><strong>使用测试模式</strong>：星析提供测试环境和模拟银行卡号，让你在不产生真实交易的情况下完成全流程测试。</li>
<li><strong>测试各种场景</strong>：成功支付、支付失败、异常数据、Webhook重试等。</li>
<li><strong>部署上线</strong>：将你的代码部署到服务器，并确保你的Webhook端点能被公网访问。</li>
</ol>
<h4 data-id="heading-4"><strong>总结</strong></h4>
<p>至此，你已经成功地为你的SaaS项目接入了专业的跨境收款能力。我们回顾一下集成的核心：</p>
<ul>
<li><strong>一个服务端接口</strong>：用于创建支付。</li>
<li><strong>一个Webhook处理器</strong>：用于异步接收支付结果。</li>
<li><strong>完善的错误处理与安全验证</strong>：保障系统稳定与资金安全。</li>
</ul>
<p>这套架构足以应对真实的业务场景。现在，你节省下了原本需要数月自研支付系统的时间，可以完全专注于你的核心产品逻辑了。</p>
<p><strong>立即查看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.starsee.io%2F" target="_blank" title="https://docs.starsee.io/" ref="nofollow noopener noreferrer">星析官方Node.js SDK及文档</a></strong>，获取更多高级功能（如订阅支付、退款处理）的详细指南，加速你的业务全球化！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[8 个最佳 Google Sheets 替代方案（附成本与能力分析）]]></title>    <link>https://juejin.cn/post/7577439614953570356</link>    <guid>https://juejin.cn/post/7577439614953570356</guid>    <pubDate>2025-11-28T07:59:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577439614953570356" data-draft-id="7577439614953553972" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="8 个最佳 Google Sheets 替代方案（附成本与能力分析）"/> <meta itemprop="keywords" content="开源,低代码,GitHub"/> <meta itemprop="datePublished" content="2025-11-28T07:59:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="NocoBase"/> <meta itemprop="url" content="https://juejin.cn/user/180779873743566"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            8 个最佳 Google Sheets 替代方案（附成本与能力分析）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/180779873743566/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    NocoBase
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T07:59:09.000Z" title="Fri Nov 28 2025 07:59:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读22分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>原文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fthe-8-best-google-sheets-alternatives-with-full-cost-and-capability-analysis" target="_blank" title="https://www.nocobase.com/cn/blog/the-8-best-google-sheets-alternatives-with-full-cost-and-capability-analysis" ref="nofollow noopener noreferrer">www.nocobase.com/cn/blog/the…</a></p>
<p>你们团队现在或者曾经使用过 Google Sheets 吗？</p>
<p>它轻量、易上手、协作方便，是许多团队在数字化初期最常选择的工具。在数据记录、任务跟踪、内容管理或基础统计等场景中，表格的确能快速解决问题。</p>
<p>但随着团队规模扩大、参与者增多、业务逻辑变得复杂，表格在结构和协作方面的限制会逐渐显现。跨部门协作、细粒度权限管理、流程化操作等需求越来越多时，Google Sheets 往往难以满足后续的扩展。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e4a0b1b621a441ca1277a8af9e10d92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764921548&amp;x-signature=b80f9zhzx3yCv4X%2BT7OeSNmjYH0%3D" alt="Hacker News.png" loading="lazy"/></p>
<p>在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnews.ycombinator.com%2Fitem%3Fid%3D39155449" target="_blank" title="https://news.ycombinator.com/item?id=39155449" ref="nofollow noopener noreferrer">Hacker News</a> 的讨论里，也有不少用户在寻找 Google Sheets 的替代方案。一些用户提到，它在复杂场景下显得更像是工具链里的“临时选项”，难以承担严肃的数据工作；面对更大的数据规模或更复杂的模型构建时，也容易力不从心，难以支持完整的数据分析流程。</p>
<p>本质上，Google Sheets 的定位始终是电子表格，而不是业务系统。</p>
<p>因此，当团队尝试用它承载 CRM、项目管理、资产登记或审批流程时，往往会遇到数据关系难以维护、权限管理受限、自动化链路难以扩展等问题。</p>
<p>基于这些真实的使用背景，我整理了几类常见的替代工具，希望能帮助你在不同阶段、不同需求下，找到比 Google Sheets 更适合的选择。</p>
<p>接下来会从三个关键维度展开介绍：</p>
<ul>
<li><strong>团队规模成本</strong>：按 10 / 50 / 100 人团队计算的年度预估投入</li>
<li><strong>最佳使用场景</strong>：最适合什么团队与什么业务需求</li>
<li><strong>能力表现</strong>：数据结构、协作权限、扩展性、自动化、使用门槛等核心能力</li>
</ul>
<h2 data-id="heading-0">Google Sheets 替代方案</h2>
<p>在进入正文前，我根据常见业务需求将今天要介绍的 8 个工具做了分类，你可以先快速浏览下面的工具类型~</p>
<p><strong>① 构建业务系统型工具</strong></p>
<p><strong>NocoBase、Retool、Appsmith、Budibase</strong></p>
<p>适合从“表格混乱”升级到“真正的内部系统”，需要数据模型、权限、自动化流转或模块化应用的团队。</p>
<p><strong>② 结构化数据型工具</strong></p>
<p><strong>Airtable、Smartsheet、Baserow、NocoDB</strong></p>
<p>适合已经不满足传统表格，但还不需要完整业务系统的团队；提供结构化数据模型、多视图、基础权限协作、自托管选项（部分工具），用于更规范地管理数据。</p>
<h3 data-id="heading-1">价格对比表格</h3>
































































































<table><thead><tr><th>工具名称</th><th>版本 / 模式</th><th>10 人团队每年成本</th><th>50 人团队每年成本</th><th>100 人团队每年成本</th></tr></thead><tbody><tr><td>Airtable</td><td>Team</td><td>$2,400</td><td>$12,000</td><td>$24,000</td></tr><tr><td>Airtable</td><td>Business</td><td>🔴$5,400</td><td>🔴$27,000</td><td>🔴$54,000</td></tr><tr><td>NocoBase</td><td>Standard（一次性）</td><td>✅$800</td><td>✅$800</td><td>✅$800</td></tr><tr><td>NocoBase</td><td>Professional（一次性）</td><td>$8,000</td><td>$8,000</td><td>$8,000</td></tr><tr><td>NocoDB</td><td>Team</td><td>✅$228</td><td>✅$1,140</td><td>✅$2,280</td></tr><tr><td>NocoDB</td><td>Business</td><td>$1,188</td><td>$5,940</td><td>$11,880</td></tr><tr><td>Baserow</td><td>Premium</td><td>$1,200</td><td>$6,000</td><td>$12,000</td></tr><tr><td>Baserow</td><td>Advanced</td><td>$2,160</td><td>$9,000</td><td>$18,000</td></tr><tr><td>Retool</td><td>Standard</td><td>$1,200</td><td>$6,000</td><td>$12,000</td></tr><tr><td>Budibase</td><td>Premium</td><td>约$2,700</td><td>约$5,850</td><td>约$8,700</td></tr><tr><td>Appsmith</td><td>Business</td><td>$1,800</td><td>$9,000</td><td>$18,000</td></tr><tr><td>Teable</td><td>Professional</td><td>$1,200</td><td>$6,000</td><td>$12,000</td></tr></tbody></table>
<p>💡 从上表可以看出几个重要趋势：</p>
<ul>
<li>随着团队规模扩大，采用按用户计费的工具（如 Baserow、Appsmith、Retool、Teable 等）成本都会快速上升，小团队负担可控，但到了 50 人、100 人规模时，年度投入会成倍增长。</li>
<li>NocoBase 是其中唯一不随用户增加而变动价格的方案，Standard 年成本保持在 $800，Professional 固定为 $8,000，这种模式在需要多人协作或跨部门使用的场景下更具可预测性。</li>
<li>NocoDB、Baserow 等数据库型工具的成本相对稳定，但仍基于人数计费，适合作为从 Google Sheets 过渡到结构化数据管理的中间路线。</li>
<li>Budibase、Teable 等工具保持中等成本区间，界面体验对习惯电子表格的用户较友好，适合从 Google Sheets 升级但不需要完整业务系统的团队。</li>
<li>整体而言，自托管工具在团队人数越多时越具成本优势，适合计划将原本依赖 Google Sheets 的数据逐步迁移为更结构化、长期稳定使用的系统；而 SaaS 类工具更适合小团队或短期项目。</li>
</ul>
<p>💡推荐阅读：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2F7-self-hosted-ai-tools-build-business-app" target="_blank" title="https://www.nocobase.com/cn/blog/7-self-hosted-ai-tools-build-business-app" ref="nofollow noopener noreferrer">7 款最佳自托管 AI 工具，快速构建业务应用</a></p>
<h3 data-id="heading-2">NocoBase</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/968c061e942f4fe391b58b50d1e0d580~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764921548&amp;x-signature=MEtEKpAmKw7npbofoQ79FGkC%2Bdk%3D" alt="NocoBase.PNG" loading="lazy"/></p>
<p>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2F" target="_blank" title="https://www.nocobase.com/cn/" ref="nofollow noopener noreferrer">www.nocobase.com/cn/</a></p>
<p>NocoBase 是一个开源的无代码／低代码业务应用构建平台，用于搭建内部系统、管理后台以及以数据为中心的业务流程。支持自托管，也提供官方托管方案，适合希望从表格迁移到系统化管理的团队。平台基于可视化配置构建应用，并可通过插件和 API 扩展能力，部分场景还可以结合官方提供的 AI 功能提升数据录入与流程效率。</p>
<p><strong>使用场景</strong></p>
<p>适合已经不满足于用表格管理数据，希望构建更结构化、更可控的内部系统的团队。  典型场景包括：</p>
<ul>
<li>以数据管理为核心的业务，如客户管理、库存管理、资产管理</li>
<li>依赖流程流转的场景，如审批、项目协作、任务推进</li>
<li>需要多人协作、分角色使用的后台系统</li>
<li>对数据安全、自托管或内部部署有要求的企业环境</li>
</ul>
<p><strong>能力表现</strong></p>
<ul>
<li><strong>数据结构能力</strong> 可以通过界面创建数据表、字段和关系，把业务数据整理为清晰的结构化模型，并在视图中灵活展示。</li>
<li><strong>协作与权限能力</strong> 提供多层级权限，包括角色、表、字段和页面层面的访问控制，适合团队间协作与权限隔离。</li>
</ul>
<p>💡推荐阅读：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2F6-in-depth-comparison-rbac-no-code-low-code-platforms" target="_blank" title="https://www.nocobase.com/cn/blog/6-in-depth-comparison-rbac-no-code-low-code-platforms" ref="nofollow noopener noreferrer">6 大企业级无代码低代码平台 RBAC 权限体系深度对比</a></p>
<ul>
<li><strong>自动化能力</strong> 支持基于事件的流程配置，可以在数据变更时触发通知、审核和跨系统动作，减少手工操作。</li>
<li><strong>扩展能力</strong> 具备插件体系和开放接口，可以安装或开发插件，也能集成外部系统，使功能随着业务扩展而增长。</li>
<li><strong>自托管与部署能力</strong> 可以在本地或云服务器部署，团队能够自主掌控数据与运行环境。</li>
<li><strong>API 与集成能力</strong> 平台提供可由数据模型自动生成的 API，并支持通过插件或配置与外部系统集成，适合在更大的业务体系中衔接前端、移动端或其他服务。</li>
<li><strong>使用门槛</strong>  非技术人员可以通过界面创建业务应用，而技术团队可以基于插件、接口和自托管做更深入的扩展。</li>
</ul>
<p><strong>总结</strong>  如果团队正在从电子表格转向系统化管理，并希望在数据结构、权限、流程和扩展性上有更完整的能力，同时希望系统能随业务规模逐步增长，NocoBase 是一个适合长期投入的选择。它兼顾可视化易用性与深度扩展能力，适合从小团队到企业的不同阶段。</p>
<h3 data-id="heading-3">Retool</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bbc0e75eb3f4cfa95759ad78dc543da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764921548&amp;x-signature=Do3MHm7tUAPtmMF15CvoSQRsEUs%3D" alt="Retool.png" loading="lazy"/></p>
<p>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fretool.com%2F" target="_blank" title="https://retool.com/" ref="nofollow noopener noreferrer">retool.com/</a></p>
<p>Retool 是一个用于快速构建内部工具的闭源 SaaS 平台，也提供自托管版本（企业计划）。它主要面向工程团队，通过拖拽组件和少量代码，将数据库、API 和后台逻辑快速组合成可用的内部应用，例如运营后台、数据面板、审核系统或客服支持工具。</p>
<p><strong>使用场景</strong></p>
<p>适合拥有工程师团队、需要快速构建内部业务工具的公司。  典型场景包括：</p>
<ul>
<li>后台运营工具，例如订单管理、申诉处理、内容审核</li>
<li>数据运营与支持团队使用的数据面板或工具化界面</li>
<li>工程团队搭建内部控制台、运营系统、管理界面</li>
<li>接入现有数据库或 API 的轻量业务流程工具</li>
</ul>
<p><strong>能力表现</strong></p>
<ul>
<li><strong>扩展能力</strong>  Retool 在扩展方面非常灵活，可以通过 JavaScript 直接处理数据、调用 API、组合逻辑，也能与数据库、消息队列或第三方服务集成。对于需要将多个系统整合到一个操作界面的团队来说，它能显著减少开发成本，是工程团队常用的内部工具框架。</li>
<li><strong>数据连接能力</strong>  Retool 支持连接大量数据源，包括 SQL、NoSQL、REST API、GraphQL 等，也允许开发者在界面上直接编写查询语句、处理逻辑、进行数据绑定。它并不负责数据结构本身，而是作为上层应用界面，把不同系统的数据接入进来并统一展示。</li>
<li><strong>使用门槛</strong>  虽然有拖拽和可视化编辑，但 Retool 的核心仍然依赖工程能力。实际使用中需要编写 JavaScript、SQL 或配置 API，产品、运营团队较难独立完成复杂应用。对于开发者来说，上手快；但对于不懂代码的用户来说，门槛较高。</li>
<li><strong>局限性</strong>  Retool 能快速产出内部工具，但不适合做外部产品或真正的业务系统。它也不负责数据建模、业务流程或系统级权限架构，只能依赖底层系统实现。同时，Retool 项目与逻辑较多时，管理和维护的复杂度会上升。</li>
</ul>
<p><strong>总结</strong>  如果团队拥有工程师，并且核心诉求是快速搭建内部工具或运营后台，而不是构建完整业务系统，Retool 会是效率非常高的选择。但如果团队没有开发人员，或希望从数据结构到流程自动化都可视化完成，它可能不是最合适的工具。</p>
<h3 data-id="heading-4">Appsmith</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cf95193b225f4604b2e7760c2f583d61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764921548&amp;x-signature=h8YgJsTRgk%2FgX0Z3VWJ4S0TLaUU%3D" alt="Appsmith.png" loading="lazy"/></p>
<p>官网：<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">appsmith.com/</a></p>
<p>Appsmith 是一个开源低代码／无代码平台，专为构建内部工具、后台系统和管理面板设计。它允许用户通过拖拽组件、连接数据库或 API、编写少量脚本，快速搭建业务界面，也支持自托管部署，对数据安全和隐私有更好控制。</p>
<p><strong>使用场景</strong>  适合以下情况：</p>
<ul>
<li>团队需要快速构建后台管理系统、运营工具、审核系统、客服后台等内部工具</li>
<li>希望连接数据库、API，但不想从零开始写代码的公司或团队</li>
<li>对数据安全或合规敏感，需要自托管或对数据基础设施有控制权的组织</li>
</ul>
<p><strong>能力表现</strong></p>
<ul>
<li><strong>数据连接与多数据源支持能力</strong>  Appsmith 支持连接 SQL、NoSQL 数据库、REST / GraphQL API、多种数据源。它能够把已有的数据源“拉进来”，然后通过 UI 组件展示、操作、过滤、修改数据。这样即使是复杂或者异构的数据体系，也能被整合到一个统一界面中，方便非工程师也能使用和管理。</li>
<li><strong>扩展与定制能力</strong>  作为开源工具，Appsmith 支持完全自托管，也允许用户自定义界面组件、脚本逻辑、权限设置与用户角色管理。对于需要高度定制、系统集成、多团队协作的企业，它可以作为内部系统平台基础，提供比普通具更灵活、更可控的长期方案。</li>
<li><strong>使用门槛</strong>  对于没有技术背景的团队来说，Appsmith 的界面相对友好，但要充分利用它的数据连接、逻辑定制、自托管等能力，仍需要一定技术能力（至少了解数据库或 API、基本脚本/逻辑）。相比纯表格工具，上手门槛更高；但对于有技术储备的团队，它比从零开发更快、更省力。</li>
<li><strong>局限性</strong>  虽然 Appsmith 提供 UI + 数据连接 + 自托管，但它并不是“无需任何代码”的 100% 无代码解决方案。对于极为复杂的业务需求（高度定制业务逻辑、大量并发、复杂权限系统等），仍可能需要工程资源进行二次开发或扩展。同时，对于完全不懂技术的团队，其学习曲线比纯 SaaS 表格工具更陡峭。</li>
</ul>
<p><strong>总结</strong>  如果你的团队有一定技术基础，或者你们重视数据安全和可控性，并希望快速搭建内部工具（后台管理、运营面板、审核系统等），Appsmith 是一个性价比高、灵活、适合长期使用的平台。但如果团队完全没有工程资源，也不愿意做运维和维护，那么就要慎重考虑它的使用门槛和长期投入。 💡推荐阅读：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fnocobase-vs-appsmith" target="_blank" title="https://www.nocobase.com/cn/blog/nocobase-vs-appsmith" ref="nofollow noopener noreferrer">NocoBase 与 Appsmith：哪个开源低代码平台更适合你？</a></p>
<h3 data-id="heading-5">Budibase</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/acb300f832454d6e83b3fedd9524b491~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764921548&amp;x-signature=soEfdszy9QlRZKTYG8QoCYfjdJY%3D" alt="Budibase.png" loading="lazy"/></p>
<p>官网：<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">budibase.com/</a></p>
<p>Budibase 是一个开源的低代码平台，用于构建内部工具和管理后台。它支持自托管，也支持部署到云端，对于需要掌控数据安全或希望在本地运行系统的团队来说更加灵活。</p>
<p><strong>使用场景</strong>  适合希望快速搭建后台管理系统、数据录入工具或简单业务系统的团队。典型场景包括：</p>
<ul>
<li>客户信息、库存、资产等数据的录入和管理</li>
<li>小型内部 CRM、审批流或运营后台</li>
<li>希望具备自托管能力的小型团队或初创公司</li>
</ul>
<p><strong>能力表现</strong></p>
<ul>
<li><strong>数据管理能力</strong>  Budibase 支持连接外部数据库，也可以在平台内创建结构化的数据表，定义字段类型、记录关系、表单和列表视图。对于中小规模的数据管理任务，它比普通表格提供更清晰的结构和更规范的组织方式。</li>
<li><strong>扩展能力与自托管支持</strong>  提供角色和权限定义、触发器和动作配置，可以在系统中加入简单的自动化逻辑。作为开源工具，它允许团队自托管，从而在数据安全性和系统自主性方面更可控，这一点在许多团队的内部工具场景中具备吸引力。</li>
<li><strong>使用门槛</strong>  Budibase 对没有前端经验的用户来说比传统开发方式更易用，但要熟练使用数据库连接、自定义视图或部署自托管服务，需要一定的技术基础。对于完全没有技术背景的团队，上手会有一定学习成本。</li>
<li><strong>局限性</strong>  虽然 Budibase 可以覆盖数据录入、基础权限、简单自动化，但对于复杂的多表关系、细粒度权限体系、大型流程编排或高并发场景而言，它的能力有限。如果团队需要构建更复杂的应用或业务系统，Budibase 往往只能作为基础框架使用。</li>
</ul>
<p><strong>总结</strong>  如果你需要一款能够快速搭建内部工具、具备结构化数据管理、自托管能力和基础权限控制的平台，Budibase 是一个灵活且成本相对较低的选择。但对于更复杂的业务场景，它更适合作为轻量级框架，而不是完整的系统解决方案。</p>
<h3 data-id="heading-6">Baserow</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5cdd93cd521246e7baa0ba4178b8e090~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764921548&amp;x-signature=DeWY6MarnaLbST5HcM82qfiDNvU%3D" alt="Baserow.png" loading="lazy"/></p>
<p>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fbaserow.io%2F" target="_blank" title="https://baserow.io/" ref="nofollow noopener noreferrer">baserow.io/</a></p>
<p>Baserow 是一个开源、以数据库为核心的数据管理工具。它提供类似表格的界面，但本质是结构化数据管理平台，支持自托管部署，也提供云端服务。相比传统表格工具，它更强调数据模型清晰度和可扩展性，适合希望掌握数据所有权或需要本地部署的团队。</p>
<p><strong>使用场景</strong>  适用于希望从电子表格升级到结构化数据库，但不想直接进入工程型数据库工具的团队。典型场景包括：</p>
<ul>
<li>团队内部的轻量数据管理、表格结构化、数据录入</li>
<li>需要自托管的中小企业，用于数据整理、数据看板</li>
<li>作为前端系统或应用的后端数据源（REST API）</li>
</ul>
<p><strong>能力表现</strong></p>
<ul>
<li><strong>数据结构能力</strong>  Baserow 提供比电子表格更明确的字段类型、表之间的关联关系、记录引用等数据库特性。它保留了表格的直观体验，同时让数据结构具备更好的可维护性，更适用于中等规模的数据建模。</li>
<li><strong>扩展能力</strong>  作为开源工具，Baserow 拥有良好的扩展性，支持自建插件、定制字段类型、Webhook，以及用于开发场景的 API 接口。对于有一定技术能力的团队，Baserow 可以作为轻量数据库使用，也能成为内部系统的基础数据层。</li>
<li><strong>使用门槛</strong>  对非技术用户来说比传统数据库更易上手，但需要一定的结构化思维，尤其在表关系、多表管理上的学习成本高于普通电子表格。对技术团队而言，它比 Airtable 等 SaaS 工具更灵活，但需要负责部署和维护。</li>
<li><strong>局限性</strong>  Baserow 是数据管理工具，不提供应用界面构建、复杂自动化或业务流程能力。如果团队希望构建完整的业务系统，Baserow 往往只能作为数据后端，需要搭配其他工具使用。</li>
</ul>
<p><strong>总结</strong>  如果团队目标是从表格升级到更可维护的结构化数据管理，同时希望掌握数据所有权、支持自托管或进行二次开发，Baserow 是一个合适的选择。但如果需要业务流程、自动化或界面构建能力，它更适合作为系统的数据层，而非完整的应用平台。</p>
<h3 data-id="heading-7">NocoDB</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e94ff06d40834512880d3ff696f53e9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764921548&amp;x-signature=1VN0tNCxb23OK4AMt1mNjG2ON8s%3D" alt="NocoDB.png" loading="lazy"/></p>
<p>官网：<a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">nocodb.com/</a></p>
<p>NocoDB 是一个开源的电子表格风格数据库管理工具。它提供类似 Airtable 的界面体验，但底层使用真实的关系型数据库，并支持自托管部署。团队可以将现有的 MySQL、PostgreSQL 或其他数据库直接连接到 NocoDB，让原本需要工程师才能管理的数据库以更可视化的方式呈现。</p>
<p><strong>使用场景</strong>  适用于希望从表格过渡到数据库，同时又希望保持类表格界面的团队。  典型场景包括：</p>
<ul>
<li>数据量较大、需要用关系型数据库承载的业务数据管理</li>
<li>中小团队希望可视化管理数据库，而无需直接操作 SQL</li>
<li>将 NocoDB 作为 API 数据源，提供给内部工具或前端系统使用</li>
</ul>
<p><strong>能力表现</strong></p>
<ul>
<li><strong>数据结构能力</strong>  NocoDB 底层基于真实的关系型数据库，支持更多字段类型、外键关系和结构化操作。相比普通表格或类表格工具，它在数据一致性、多表关联和数据规模上都有更强的表现。对已有数据库的可视化管理是它的重要优势。</li>
<li><strong>扩展能力</strong>  支持 API 自动生成、Webhook、多种数据库连接和自定义视图，适合作为系统的数据后端。开发者可以通过其自动生成的 REST API 快速集成到其他工具或内部项目中，使其在多系统协作环境中具有较高灵活度。</li>
<li><strong>使用门槛</strong>  对非技术用户来说，界面与表格较为接近，基本功能容易理解。不过如果涉及数据库迁移、连接或复杂结构设计，仍需要一定的技术能力。对工程团队来说，使用成本相对低，但需要负责部署与维护。</li>
<li><strong>局限性</strong>  NocoDB 的核心是数据管理和数据库可视化，它不包含业务系统构建、流程编排或复杂自动化内容。如果团队希望构建 CRM、审批流、库存系统等完整应用，NocoDB 更适合作为数据后端，而不是满足完整业务需求。</li>
</ul>
<p><strong>总结</strong>  对于需要管理结构化数据、希望以可视化方式操作数据库、并且需要自托管或 API 输出能力的团队，NocoDB 是优于表格工具的选择。但如果团队的需求已经延伸到流程编排、多模块业务系统或更完整的应用构建，需要再搭配其他平台联合使用。💡推荐阅读：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fnocobase-vs-nocodb" target="_blank" title="https://www.nocobase.com/cn/blog/nocobase-vs-nocodb" ref="nofollow noopener noreferrer">NocoBase 与 NocoDB：开源无代码（零代码）工具深度对比</a></p>
<h3 data-id="heading-8">Airtable</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/86077f2cdc65455888ec4a6ba16e2b6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764921548&amp;x-signature=A9athdR3AmWmhRR4u2h2CKEXaI0%3D" alt="Airtable" loading="lazy"/></p>
<p>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fairtable.com%2F" target="_blank" title="https://airtable.com/" ref="nofollow noopener noreferrer">airtable.com</a></p>
<p>Airtable 是一个集电子表格、数据库和协作能力于一体的闭源 SaaS 工具。它提供灵活的数据结构、直观的界面设计和多人在线协作，但不支持自托管或本地部署，所有数据均托管在 Airtable 的云端。</p>
<p><strong>使用场景</strong>  适合需要比普通表格更结构化的数据管理，但又不希望投入后端开发或搭建数据库的团队。典型场景包括：</p>
<ul>
<li>内容和运营团队用于内容日历、任务分配、状态追踪</li>
<li>小型项目或活动管理，用于统筹人员、进度和交付物</li>
<li>初创企业用于联系人管理、轻量 CRM、会员运营等</li>
</ul>
<p><strong>能力表现</strong></p>
<ul>
<li><strong>数据结构能力</strong>  Airtable 支持表与表之间建立关联，数据结构比传统电子表格更清晰，更适合管理轻量到中等复杂度的数据模型。💡推荐阅读：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fairtable-data-limit-reached-3-common-solutions" target="_blank" title="https://www.nocobase.com/cn/blog/airtable-data-limit-reached-3-common-solutions" ref="nofollow noopener noreferrer">Airtable 的数据超出上限，3 种常见应对方式</a></li>
<li><strong>协作与权限</strong>  提供基础的多人协作功能，包括查看、编辑、评论和权限分配。相比本地表格，它在协作场景中的体验更为顺畅，也更容易保持数据一致。</li>
<li><strong>使用门槛</strong>  对非技术用户非常友好，不需要写代码即可搭建基础的数据结构和视图。界面直观，学习成本较低。</li>
<li><strong>局限性</strong>  当数据量增大、业务需要更多表结构、更加细致的权限控制或自动化流程时，Airtable 的能力会逐渐受到限制。</li>
</ul>
<p><strong>总结</strong>  如果团队需要一套比 Google Sheets 更结构化、更便于协作的工具，而不涉及复杂逻辑或自动化场景，Airtable 是一个实用的选择。但如果业务逐渐扩大，需要更精细的权限、更多表之间的关系或更完整的自动化体系，Airtable 可能无法满足后续的发展需求。</p>
<p>💡推荐阅读：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2F5-self-hosted-airtable-alternatives" target="_blank" title="https://www.nocobase.com/cn/blog/5-self-hosted-airtable-alternatives" ref="nofollow noopener noreferrer">Airtable 太贵了？5 个自托管替代方案成本&amp;功能对比</a></p>
<h3 data-id="heading-9">Smartsheet</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6e2639b18e345ea804fc24baebc522e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTm9jb0Jhc2U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764921548&amp;x-signature=iUSQWnPopr1yaygsT4Jm8YQxQVk%3D" alt="Smartsheet.png" loading="lazy"/></p>
<p>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.smartsheet.com%2F" target="_blank" title="https://www.smartsheet.com/" ref="nofollow noopener noreferrer">www.smartsheet.com/</a></p>
<p>Smartsheet 是一款面向企业级项目管理和协作的闭源 SaaS 工具。它以电子表格为基础界面，但强化了任务管理、甘特图、自动化流程与企业权限能力，适用于更规范化的团队协作场景。Smartsheet 同样不支持自托管，所有数据存储在其云端服务中。</p>
<p><strong>使用场景</strong>  适合需要在表格基础上进一步规范任务管理、流程协作和跨部门项目推进的团队。  典型场景包括：</p>
<ul>
<li>中大型团队的项目计划、进度管理、资源排期</li>
<li>运营团队的活动管理、审批流、任务分配</li>
<li>企业 PMO/运营管理部门的多项目协同、进度可视化</li>
</ul>
<p><strong>能力表现</strong></p>
<ul>
<li><strong>协作与权限</strong> Smartsheet 提供较为完善的权限体系，包含行级共享、查看/编辑控制、审批流、以及基于角色的访问设置，适合多人并行协作的项目管理环境。在权限细粒度和流程管理上，相比一般的表格类工具更成熟。</li>
<li><strong>自动化与流程管理</strong> 具有基于触发条件的自动化功能，如任务提醒、状态更新、审批流、跨表同步等，降低手工更新的成本。对于需要将任务流、审批、项目节点串联起来的团队，它能提供相对稳定的流程支持。</li>
<li><strong>使用门槛</strong> 界面依旧是表格风格，基础使用不需要技术背景，但要充分发挥其项目管理和自动化能力，需要一定的学习成本。对于不熟悉结构化项目管理的团队，前期可能会感到偏“重”和复杂。</li>
<li><strong>局限性</strong>  Smartsheet 的结构灵活度不及数据库型或应用型平台，在数据之间的关系表达上能力有限；自定义程度也受到工具自身框架限制。此外，由于其定位偏企业级，整体体验和价格相比轻量工具更“重”，在小团队场景下可能不够轻便。</li>
</ul>
<p><strong>总结</strong>  如果团队的核心需求是以表格为界面，开展更规范化的项目管理、资源排期和协作流程，Smartsheet 会比 Google Sheets 更稳定、功能更全面。但如果你希望在数据结构、灵活建模或自定义应用上有更深的能力，它的框架可能会显得较为固定。</p>
<h2 data-id="heading-10">结语</h2>
<p>Google Sheets 是一个优秀的表格工具，但并不是为业务系统而设计的。</p>
<p>当数据规模变大、协作复杂度提升、流程开始依赖结构化管理时，团队往往会需要明确的数据模型、更细致的权限控制、自动化的业务流转、可控的数据环境，以及能够随业务扩展的系统能力。</p>
<p>希望这一份工具清单，能够让团队在评估替代方案时有更清晰的视角——从使用场景、核心能力到价格与成本，帮助你在早期就判断哪种工具更贴近自己的实际需求。</p>
<p>如果这些内容对你有启发，也欢迎你分享给同样在寻找工具的团队，也许能帮助更多人更快地找到合适的方案。</p>
<p>相关阅读：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2F6-open-source-no-low-code-tools-for-building-pocs" target="_blank" title="https://www.nocobase.com/cn/blog/6-open-source-no-low-code-tools-for-building-pocs" ref="nofollow noopener noreferrer">6个适合做 PoC 的开源无代码/低代码工具推荐 </a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fa-developers-technical-decision-guide-to-no-code-and-low-code" target="_blank" title="https://www.nocobase.com/cn/blog/a-developers-technical-decision-guide-to-no-code-and-low-code" ref="nofollow noopener noreferrer">给开发者的无代码/低代码技术决策指南（2026）</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2F6-in-depth-comparison-rbac-no-code-low-code-platforms" target="_blank" title="https://www.nocobase.com/cn/blog/6-in-depth-comparison-rbac-no-code-low-code-platforms" ref="nofollow noopener noreferrer">6 大企业级无代码低代码平台 RBAC 权限体系深度对比</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2F14-ai-low-code-platforms-github" target="_blank" title="https://www.nocobase.com/cn/blog/14-ai-low-code-platforms-github" ref="nofollow noopener noreferrer">GitHub 上最值得关注的 14 个开源 AI 低代码工具 </a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Ftop-11-github-open-source-no-code-ai-tools" target="_blank" title="https://www.nocobase.com/cn/blog/top-11-github-open-source-no-code-ai-tools" ref="nofollow noopener noreferrer">11 个在 GitHub 上最受欢迎的开源无代码 AI 工具 </a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fgithub-open-source-ai-agent-projects" target="_blank" title="https://www.nocobase.com/cn/blog/github-open-source-ai-agent-projects" ref="nofollow noopener noreferrer">GitHub 上 Star 数量前 18 的开源 AI Agent 项目</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.nocobase.com%2Fcn%2Fblog%2Fgithub-open-source-ai-projects" target="_blank" title="https://www.nocobase.com/cn/blog/github-open-source-ai-projects" ref="nofollow noopener noreferrer">GitHub 上 Star 数量前 20 的开源 AI 项目</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[朝阳永续基于阿里云 Milvus 构建金融智能投研产品“AI 小二”]]></title>    <link>https://juejin.cn/post/7577356848337846307</link>    <guid>https://juejin.cn/post/7577356848337846307</guid>    <pubDate>2025-11-28T07:59:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577356848337846307" data-draft-id="7577345758036049920" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="朝阳永续基于阿里云 Milvus 构建金融智能投研产品“AI 小二”"/> <meta itemprop="keywords" content="人工智能,数据库"/> <meta itemprop="datePublished" content="2025-11-28T07:59:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            朝阳永续基于阿里云 Milvus 构建金融智能投研产品“AI 小二”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T07:59:57.000Z" title="Fri Nov 28 2025 07:59:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、客户简介</h2>
<p>朝阳永续是先进的金融数据与智能服务提供商，致力于为基金管理公司、证券研究机构及专业投资者提供高质量、精准和全面的数据分析与决策支持工具。依托多年深耕金融行业的数据积累与投研经验，朝阳永续推出其核心产品——AI 小二，一款融合大模型技术的 AI 金融投研智能体。</p>
<p>AI 小二基于生成式 AI 能力，结合阿里云向量检索服务 Milvus 版（简称阿里云 Milvus），打造了集“智能问答、极速研究、深度分析、主题推荐、报表生成”于一体的智能化投研平台，全面赋能投资研究流程，显著提升用户的研究效率与决策质量。</p>
<p><img src="https://static001.geekbang.org/infoq/01/0131dd7e6fe68254a4f00b38dc34da63.png" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">二、业务背景与诉求</h2>
<p>在金融投研领域，信息的准确性、权威性和时效性至关重要。AI 小二作为面向专业用户的严谨型 AI 应用，要求所有输出内容必须具备可追溯的信源依据，并确保引用观点来自权威、合规的数据来源。</p>
<p>然而，在面对日益增长的多源异构金融数据时，传统技术架构面临四大核心挑战：</p>
<h4 data-id="heading-2">1. 数据规模庞大且复杂度高</h4>
<p>朝阳永续需处理包括上市公司公告、财报、卖方研究报告、新闻资讯、基金数据在内的海量非结构化与半结构化数据，日均新增数据量持续攀升。传统的关键词检索方式难以理解语义关联，无法满足用户对精准匹配的需求。</p>
<h4 data-id="heading-3">2. 检索精度与召回率难以兼顾</h4>
<p>用户常以自然语言提出复杂查询需求，例如：“某公司在过去四个财报季中管理层表述的变化趋势”。此类问题涉及跨文档、跨时间维度的语义理解，传统系统因缺乏上下文感知能力，导致漏检率高、误判频发，严重影响研究结果的可靠性。</p>
<h4 data-id="heading-4">3. 系统性能与稳定性压力巨大</h4>
<p>金融市场具有极强的实时性要求，尤其在交易时段，任何延迟都可能影响投资决策。原有自建检索系统在数据量达到亿级后，出现查询延迟波动、节点负载不均等问题，部分复杂查询响应时间超过数分钟，已无法满足高频、低延迟的业务需求。</p>
<h4 data-id="heading-5">4. 运维成本高昂，资源管理复杂</h4>
<p>随着集群规模扩大，运维团队需投入大量人力进行监控、调优、故障恢复和版本升级。这不仅增加了运营负担，也严重挤占了核心技术研发的时间与资源。</p>
<h2 data-id="heading-6">三、阿⾥云的解决⽅案</h2>
<p>为突破上述瓶颈，朝阳永续携手阿里云，引入 阿里云向量检索服务 Milvus 版，构建高性能、高可用的金融级语义检索底座，支撑 AI 小二实现从“数据到洞察”的高效转化。</p>
<p><img src="https://static001.geekbang.org/infoq/72/7265a112666875b85445d5d97f830171.png" alt="" loading="lazy"/></p>
<p>系统采用分层架构：</p>
<ul>
<li>
<p>底层：存储汇聚上市公司公告、研报、财报等原始文本数据；</p>
</li>
<li>
<p>中间层：通过经由 PDF 解析、 Embedding 等处理环节形成向量化数据，并存入阿里云 Milvus；</p>
</li>
<li>
<p>上层：利用阿里云 Milvus 强大的语义检索与条件过滤能力，实现多模态召回；</p>
</li>
<li>
<p>接入层：通过标准化接口为 AI 小二提供低延迟、高并发的检索服务。</p>
</li>
</ul>
<p>整个系统实现了从数据摄入、向量化、存储到检索的全链路自动化，为金融级 AI 应用提供了坚实的技术支撑。</p>
<h2 data-id="heading-7">四、典型应用场景与效果验证</h2>
<p><strong>案例一：追踪上市公司“互动易”表述变化（上市公司互动易数据）</strong></p>
<p>上市公司在历史多时期内的互动易表述，往往隐含管理层对未来业绩、行业趋势的前瞻性判断。这类非结构化文本难以通过关键词检索准确提取。</p>
<p>借助阿里云 Milvus 的高精度语义匹配能力，AI 小二能够快速定位并召回特定时间段内相关问答内容，帮助研究员高效捕捉企业战略动向与情绪变化，显著提升信息挖掘效率。</p>
<p><strong>案例二：分析卖方分析师观点演变（卖方研报数据）</strong></p>
<p>朝阳永续累计收录超300万份经合规授权的卖方研究报告，每日新增数千篇。投资者常需分析某分析师对某一公司的长期观点演变。</p>
<p>阿里云 Milvus 支持大规模向量实时写入与高效检索，在财报披露高峰期仍能稳定响应复杂查询，确保用户及时获取最新市场研判，强化投研时效性。</p>
<p><img src="https://static001.geekbang.org/infoq/af/af70581abbec1d653beed1b7f46366ea.png" alt="" loading="lazy"/></p>
<p><strong>案例三：解读财报中的管理层表述（上市公司财报数据）</strong></p>
<p>财报信息是众多专业投资者关注的重要一手信息，其中，管理层在财报中的经营表述可能蕴含重要的投资信息。AI 小二通过将百万级财报文本向量化，并基于阿里云 Milvus 实现精准语义召回，可快速提取与用户问题相关的段落，再由大模型进行情感分析与趋势提炼，大幅提升专业投资者财报研究效率。</p>
<h2 data-id="heading-8">五、为什么选择阿⾥云 Milvus</h2>
<p>在向量数据库选型过程中，朝阳永续曾长期使用开源 PostgreSQL 向量扩展方案，但在实际应用中暴露出性能瓶颈与运维难题。最终全面迁移至 阿里云 Milvus 向量检索服务，主要基于以下三大关键考量：</p>
<p><strong>1. 性能飞跃：查询速度提升十倍以上</strong></p>
<ul>
<li>
<p>经验证：开源 PG 库平均响应速度600ms，阿里云Milvus平均响应速度50ms</p>
</li>
<li>
<p>已有的上市公司公告、基金公司公告、卖方研究报告，专利及法律文档等，Embedding完成后，向量的数量级已达到十亿量级。开源 PG 库在结合标量条件筛选，并开启向量检索和全文检索的混合检索模式下，平均响应时间已冲到600ms，极端情况长达数分钟。切换至阿里云 Milvus 后，同样规模的数据，类似的检索方式，平均响应速度提升至50ms，提速十倍以上，充分满足金融业务对实时性的严苛要求。</p>
</li>
</ul>
<p><strong>2. 运维大幅降低，工作量下降80%</strong></p>
<ul>
<li>
<p>开源 PG 方案遵循一切自己动手的原则，大量监控框架均需要搭配其他开源项目进行部署，需要花费运维人员大量的时间调研，且不完全符合运维需要，须定制整合，成本高，运维难度大。</p>
</li>
<li>
<p>阿里云 Milvus 具备完善的监控能力，提供包括 CPU 和内存使用率在内的逾百项监控指标，并支持自定义报警规则，可灵活适应多样化的业务需求。这一全方位的监控体系有效帮助朝阳用户技术实现对集群运行状态的精准感知与及时响应。同时，阿里云 Milvus 还支持灵活的资源调整机制，可根据业务负载变化，平滑实现资源的扩容或缩容，保障服务持续稳定运行。</p>
</li>
</ul>
<p><strong>3. 生产级稳定性：历经百次高峰冲击，零故障运行</strong></p>
<p>在开盘、重大政策发布等流量高峰期间，原有 PG 集群频繁出现CPU打满、服务卡顿甚至宕机现象。</p>
<p>切换至阿里云 Milvus 后，面对这些投研及投顾领域的热点事件及开盘、收盘时间点的高频应用时间。阿里云 Milvus 历经半年<strong>百余次</strong>瞬时访问峰值考验，始终保持 <strong>0 故障、0 中断</strong>，展现出卓越的高可用性与抗压能力，真正达到金融级标准。</p>
<h2 data-id="heading-9">六、总结</h2>
<p>通过采用 阿里云向量检索服务 Milvus 版，朝阳永续成功构建了高性能、高可靠的金融语义检索引擎，有效解决了海量非结构化数据下的检索效率、精度与稳定性难题，为“AI 小二”提供了强大的底层支撑，显著提升了智能投研服务的用户体验与商业价值。</p>
<p>未来，朝阳永续期待与阿里云在大模型、向量检索、Agent 记忆系统等领域深化合作，共同探索其在智能风控、资产配置、合规审查等更多金融场景的创新应用，携手推动中国金融行业的数字化转型与智能化升级。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Promise.withResolvers】发现这个api还挺有用]]></title>    <link>https://juejin.cn/post/7577583653728010278</link>    <guid>https://juejin.cn/post/7577583653728010278</guid>    <pubDate>2025-11-28T08:01:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577583653728010278" data-draft-id="7577345758036279296" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Promise.withResolvers】发现这个api还挺有用"/> <meta itemprop="keywords" content="前端,JavaScript,TypeScript"/> <meta itemprop="datePublished" content="2025-11-28T08:01:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="珑墨"/> <meta itemprop="url" content="https://juejin.cn/user/3069492194710797"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Promise.withResolvers】发现这个api还挺有用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3069492194710797/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    珑墨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T08:01:34.000Z" title="Fri Nov 28 2025 08:01:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Jym好😘，我是珑墨。</p>
<p>在 es 的异步编程世界中，Promise 已经成为处理异步操作的标准方式。然而，在某些场景下，传统的 Promise 构造函数模式显得不够灵活。<code>Promise.withResolvers</code> 是 ES2024（ES14）中引入的一个静态方法，它提供了一种更优雅的方式来创建 Promise，并同时获得其 resolve 和 reject 函数的引用。</p>
<h2 data-id="heading-0">look:</h2>
<h2 data-id="heading-1">什么是 Promise.withResolvers</h2>
<p><code>Promise.withResolvers</code> 是一个静态方法，它返回一个对象，包含三个属性：</p>
<ul>
<li><code>promise</code>: 一个 Promise 对象</li>
<li><code>resolve</code>: 用于解决（fulfill）该 Promise 的函数</li>
<li><code>reject</code>: 用于拒绝（reject）该 Promise 的函数</li>
</ul>
<h3 data-id="heading-2">基本语法</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { promise, resolve, reject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();
</code></pre>
<p>这个方法的核心优势在于：<strong>你可以在 Promise 外部控制其状态</strong>，这在许多场景下非常有用。</p>
<hr/>
<h2 data-id="heading-3">为什么 Promise.withResolvers挺实用？</h2>
<h3 data-id="heading-4">先看传统 Promise 的局限性</h3>
<p>在 <code>Promise.withResolvers</code> 出现之前，如果我们想要在 Promise 外部控制其状态，通常需要这样做：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> resolvePromise;
<span class="hljs-keyword">let</span> rejectPromise;

<span class="hljs-keyword">const</span> myPromise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
  resolvePromise = resolve;
  rejectPromise = reject;
});

<span class="hljs-comment">// 现在可以在外部使用 resolvePromise 和 rejectPromise</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">resolvePromise</span>(<span class="hljs-string">'成功！'</span>);
}, <span class="hljs-number">1000</span>);
</code></pre>
<p>这种方法虽然可行，但存在以下问题：</p>
<ol>
<li><strong>代码冗余</strong>：每次都需要创建临时变量，会导致一坨地雷</li>
<li><strong>作用域污染</strong>：需要在外部作用域声明变量</li>
<li><strong>不够优雅</strong>：代码结构不够清晰</li>
<li><strong>容易出错</strong>：如果忘记赋值，会导致运行时错误</li>
</ol>
<h3 data-id="heading-5">Promise.withResolvers解决了啥？</h3>
<p><code>Promise.withResolvers</code> 解决了上述所有问题：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { promise, resolve, reject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();

<span class="hljs-comment">// 简洁、清晰、安全</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'成功！'</span>);
}, <span class="hljs-number">1000</span>);
</code></pre>
<hr/>
<h2 data-id="heading-6">语法和用法</h2>
<h3 data-id="heading-7">基本语法</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { promise, resolve, reject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();
</code></pre>
<h3 data-id="heading-8">返回值</h3>
<p><code>Promise.withResolvers()</code> 返回一个普通对象，包含：</p>
<ul>
<li><strong>promise</strong>: 一个处于 pending 状态的 Promise 对象</li>
<li><strong>resolve</strong>: 一个函数，调用时会将 promise 变为 fulfilled 状态</li>
<li><strong>reject</strong>: 一个函数，调用时会将 promise 变为 rejected 状态</li>
</ul>
<h3 data-id="heading-9">基本示例</h3>
<h4 data-id="heading-10">示例 1：简单的延迟解析</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { promise, resolve } = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();

<span class="hljs-comment">// 1 秒后解析 Promise</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'数据加载完成'</span>);
}, <span class="hljs-number">1000</span>);

promise.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value); <span class="hljs-comment">// 1 秒后输出: "数据加载完成"</span>
});
</code></pre>
<h4 data-id="heading-11">示例 2：处理错误</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { promise, resolve, reject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();

<span class="hljs-comment">// 模拟异步操作</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> success = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &gt; <span class="hljs-number">0.5</span>;
  <span class="hljs-keyword">if</span> (success) {
    <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'操作成功'</span>);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'操作失败'</span>));
  }
}, <span class="hljs-number">1000</span>);

promise
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value))
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error));
</code></pre>
<h4 data-id="heading-12">示例 3：多次调用 resolve/reject 的行为</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { promise, resolve, reject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();

<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'第一次'</span>);
<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'第二次'</span>); <span class="hljs-comment">// 无效，Promise 状态已确定</span>
<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'错误'</span>)); <span class="hljs-comment">// 无效，Promise 状态已确定</span>

promise.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value); <span class="hljs-comment">// 输出: "第一次"</span>
});
</code></pre>
<p><strong>重要提示</strong>：一旦 Promise 被 resolve 或 reject，其状态就确定了，后续的 resolve 或 reject 调用将被忽略。</p>
<hr/>
<h2 data-id="heading-13">与传统方法的对比</h2>
<h3 data-id="heading-14">场景 1：事件监听器中的 Promise</h3>
<h4 data-id="heading-15">传统方法</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">waitForClick</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> resolveClick;
  <span class="hljs-keyword">let</span> rejectClick;
  
  <span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    resolveClick = resolve;
    rejectClick = reject;
  });
  
  <span class="hljs-keyword">const</span> button = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'myButton'</span>);
  <span class="hljs-keyword">const</span> timeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    button.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'click'</span>, onClick);
    <span class="hljs-title function_">rejectClick</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'超时'</span>));
  }, <span class="hljs-number">5000</span>);
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">onClick</span>(<span class="hljs-params">event</span>) {
    <span class="hljs-built_in">clearTimeout</span>(timeout);
    button.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'click'</span>, onClick);
    <span class="hljs-title function_">resolveClick</span>(event);
  }
  
  button.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, onClick);
  
  <span class="hljs-keyword">return</span> promise;
}
</code></pre>
<h4 data-id="heading-16">使用 Promise.withResolvers</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">waitForClick</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { promise, resolve, reject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();
  
  <span class="hljs-keyword">const</span> button = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'myButton'</span>);
  <span class="hljs-keyword">const</span> timeout = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    button.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'click'</span>, onClick);
    <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'超时'</span>));
  }, <span class="hljs-number">5000</span>);
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">onClick</span>(<span class="hljs-params">event</span>) {
    <span class="hljs-built_in">clearTimeout</span>(timeout);
    button.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'click'</span>, onClick);
    <span class="hljs-title function_">resolve</span>(event);
  }
  
  button.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, onClick);
  
  <span class="hljs-keyword">return</span> promise;
}
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>代码更简洁</li>
<li>不需要在外部作用域声明变量</li>
<li>结构更清晰</li>
</ul>
<h3 data-id="heading-17">场景 2：流式数据处理</h3>
<h4 data-id="heading-18">传统方法</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createStreamProcessor</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> resolveStream;
  <span class="hljs-keyword">let</span> rejectStream;
  
  <span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    resolveStream = resolve;
    rejectStream = reject;
  });
  
  <span class="hljs-comment">// 模拟流式处理</span>
  <span class="hljs-keyword">const</span> chunks = [];
  <span class="hljs-keyword">let</span> isComplete = <span class="hljs-literal">false</span>;
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">processChunk</span>(<span class="hljs-params">chunk</span>) {
    <span class="hljs-keyword">if</span> (isComplete) <span class="hljs-keyword">return</span>;
    chunks.<span class="hljs-title function_">push</span>(chunk);
    
    <span class="hljs-keyword">if</span> (chunk.<span class="hljs-property">isLast</span>) {
      isComplete = <span class="hljs-literal">true</span>;
      <span class="hljs-title function_">resolveStream</span>(chunks);
    }
  }
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleError</span>(<span class="hljs-params">error</span>) {
    <span class="hljs-keyword">if</span> (isComplete) <span class="hljs-keyword">return</span>;
    isComplete = <span class="hljs-literal">true</span>;
    <span class="hljs-title function_">rejectStream</span>(error);
  }
  
  <span class="hljs-keyword">return</span> { promise, processChunk, handleError };
}
</code></pre>
<h4 data-id="heading-19">使用 Promise.withResolvers</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createStreamProcessor</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { promise, resolve, reject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();
  
  <span class="hljs-keyword">const</span> chunks = [];
  <span class="hljs-keyword">let</span> isComplete = <span class="hljs-literal">false</span>;
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">processChunk</span>(<span class="hljs-params">chunk</span>) {
    <span class="hljs-keyword">if</span> (isComplete) <span class="hljs-keyword">return</span>;
    chunks.<span class="hljs-title function_">push</span>(chunk);
    
    <span class="hljs-keyword">if</span> (chunk.<span class="hljs-property">isLast</span>) {
      isComplete = <span class="hljs-literal">true</span>;
      <span class="hljs-title function_">resolve</span>(chunks);
    }
  }
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleError</span>(<span class="hljs-params">error</span>) {
    <span class="hljs-keyword">if</span> (isComplete) <span class="hljs-keyword">return</span>;
    isComplete = <span class="hljs-literal">true</span>;
    <span class="hljs-title function_">reject</span>(error);
  }
  
  <span class="hljs-keyword">return</span> { promise, processChunk, handleError };
}
</code></pre>
<hr/>
<h2 data-id="heading-20">实际应用场景</h2>
<h3 data-id="heading-21">场景 1：用户交互等待</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 等待用户确认操作</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">waitForUserConfirmation</span>(<span class="hljs-params">message</span>) {
  <span class="hljs-keyword">const</span> { promise, resolve, reject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();
  
  <span class="hljs-keyword">const</span> modal = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
  modal.<span class="hljs-property">className</span> = <span class="hljs-string">'confirmation-modal'</span>;
  modal.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
    &lt;p&gt;<span class="hljs-subst">${message}</span>&lt;/p&gt;
    &lt;button class="confirm"&gt;确认&lt;/button&gt;
    &lt;button class="cancel"&gt;取消&lt;/button&gt;
  `</span>;
  
  modal.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.confirm'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (modal.<span class="hljs-property">parentNode</span>) {
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(modal);
    }
    <span class="hljs-title function_">resolve</span>(<span class="hljs-literal">true</span>);
  });
  
  modal.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.cancel'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (modal.<span class="hljs-property">parentNode</span>) {
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(modal);
    }
    <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'用户取消'</span>));
  });
  
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(modal);
  
  <span class="hljs-keyword">return</span> promise;
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-title function_">waitForUserConfirmation</span>(<span class="hljs-string">'确定要删除这个文件吗？'</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'用户确认'</span>))
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'用户取消'</span>));
</code></pre>
<h3 data-id="heading-22">场景 2：WebSocket 消息等待</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">WebSocketManager</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">url</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(url);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingRequests</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestId</span> = <span class="hljs-number">0</span>;
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(event.<span class="hljs-property">data</span>);
      <span class="hljs-keyword">const</span> { requestId, response, error } = data;
      
      <span class="hljs-keyword">const</span> pending = <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingRequests</span>.<span class="hljs-title function_">get</span>(requestId);
      <span class="hljs-keyword">if</span> (pending) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingRequests</span>.<span class="hljs-title function_">delete</span>(requestId);
        <span class="hljs-keyword">if</span> (error) {
          pending.<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(error));
        } <span class="hljs-keyword">else</span> {
          pending.<span class="hljs-title function_">resolve</span>(response);
        }
      }
    };
  }
  
  <span class="hljs-title function_">sendRequest</span>(<span class="hljs-params">message</span>) {
    <span class="hljs-keyword">const</span> { promise, resolve, reject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();
    <span class="hljs-keyword">const</span> requestId = ++<span class="hljs-variable language_">this</span>.<span class="hljs-property">requestId</span>;
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingRequests</span>.<span class="hljs-title function_">set</span>(requestId, { resolve, reject });
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">ws</span>.<span class="hljs-title function_">send</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      requestId,
      message
    }));
    
    <span class="hljs-comment">// 设置超时</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingRequests</span>.<span class="hljs-title function_">has</span>(requestId)) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">pendingRequests</span>.<span class="hljs-title function_">delete</span>(requestId);
        <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'请求超时'</span>));
      }
    }, <span class="hljs-number">5000</span>);
    
    <span class="hljs-keyword">return</span> promise;
  }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">const</span> wsManager = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocketManager</span>(<span class="hljs-string">'ws://example.com'</span>);
wsManager.<span class="hljs-title function_">sendRequest</span>(<span class="hljs-string">'获取用户信息'</span>)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'收到响应:'</span>, data))
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'错误:'</span>, error));
</code></pre>
<h3 data-id="heading-23">场景 3：文件上传进度</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">uploadFileWithProgress</span>(<span class="hljs-params">file, url</span>) {
  <span class="hljs-keyword">const</span> { promise, resolve, reject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();
  
  <span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();
  <span class="hljs-keyword">const</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>();
  formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'file'</span>, file);
  
  xhr.<span class="hljs-property">upload</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'progress'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (event.<span class="hljs-property">lengthComputable</span>) {
      <span class="hljs-keyword">const</span> percentComplete = (event.<span class="hljs-property">loaded</span> / event.<span class="hljs-property">total</span>) * <span class="hljs-number">100</span>;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`上传进度: <span class="hljs-subst">${percentComplete.toFixed(<span class="hljs-number">2</span>)}</span>%`</span>);
    }
  });
  
  xhr.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">status</span> === <span class="hljs-number">200</span>) {
      <span class="hljs-title function_">resolve</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(xhr.<span class="hljs-property">responseText</span>));
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`上传失败: <span class="hljs-subst">${xhr.status}</span>`</span>));
    }
  });
  
  xhr.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'网络错误'</span>));
  });
  
  xhr.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'abort'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'上传已取消'</span>));
  });
  
  xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'POST'</span>, url);
  xhr.<span class="hljs-title function_">send</span>(formData);
  
  <span class="hljs-comment">// 返回 Promise 和取消函数</span>
  <span class="hljs-keyword">return</span> {
    promise,
    <span class="hljs-attr">cancel</span>: <span class="hljs-function">() =&gt;</span> xhr.<span class="hljs-title function_">abort</span>()
  };
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">const</span> { promise, cancel } = <span class="hljs-title function_">uploadFileWithProgress</span>(file, <span class="hljs-string">'/api/upload'</span>);
promise
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'上传成功:'</span>, result))
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'上传失败:'</span>, error));
</code></pre>
<h3 data-id="heading-24">场景 4：可取消的异步操作</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createCancellableOperation</span>(<span class="hljs-params">operation</span>) {
  <span class="hljs-keyword">const</span> { promise, resolve, reject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();
  <span class="hljs-keyword">let</span> cancelled = <span class="hljs-literal">false</span>;
  
  <span class="hljs-title function_">operation</span>()
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (!cancelled) {
        <span class="hljs-title function_">resolve</span>(result);
      }
    })
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (!cancelled) {
        <span class="hljs-title function_">reject</span>(error);
      }
    });
  
  <span class="hljs-keyword">return</span> {
    promise,
    <span class="hljs-attr">cancel</span>: <span class="hljs-function">() =&gt;</span> {
      cancelled = <span class="hljs-literal">true</span>;
      <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'操作已取消'</span>));
    }
  };
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">const</span> { promise, cancel } = <span class="hljs-title function_">createCancellableOperation</span>(
  <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-title function_">json</span>())
);

<span class="hljs-comment">// 3 秒后取消</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">cancel</span>(), <span class="hljs-number">3000</span>);

promise
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'数据:'</span>, data))
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'错误:'</span>, error));
</code></pre>
<h3 data-id="heading-25">场景 5：队列处理</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskQueue</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span> = [];
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">processing</span> = <span class="hljs-literal">false</span>;
  }
  
  <span class="hljs-title function_">add</span>(<span class="hljs-params">task</span>) {
    <span class="hljs-keyword">const</span> { promise, resolve, reject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span>.<span class="hljs-title function_">push</span>({
      task,
      resolve,
      reject
    });
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">process</span>();
    
    <span class="hljs-keyword">return</span> promise;
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">process</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">processing</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">processing</span> = <span class="hljs-literal">true</span>;
    
    <span class="hljs-keyword">while</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">const</span> { task, resolve, reject } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span>.<span class="hljs-title function_">shift</span>();
      
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">task</span>();
        <span class="hljs-title function_">resolve</span>(result);
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-title function_">reject</span>(error);
      }
    }
    
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">processing</span> = <span class="hljs-literal">false</span>;
  }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">const</span> queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TaskQueue</span>();

queue.<span class="hljs-title function_">add</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/task1'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-title function_">json</span>()))
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'任务1完成:'</span>, result));

queue.<span class="hljs-title function_">add</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/task2'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-title function_">json</span>()))
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'任务2完成:'</span>, result));
</code></pre>
<hr/>
<h2 data-id="heading-26">深入理解：工作原理</h2>
<h3 data-id="heading-27">Promise.withResolvers 的实现原理</h3>
<p>虽然 <code>Promise.withResolvers</code> 是原生 API，但我们可以通过理解其等价实现来加深理解：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Promise.withResolvers 的等价实现</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">withResolvers</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> resolve, reject;
  <span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">res, rej</span>) =&gt;</span> {
    resolve = res;
    reject = rej;
  });
  <span class="hljs-keyword">return</span> { promise, resolve, reject };
}
</code></pre>
<h3 data-id="heading-28">内存和性能考虑</h3>
<p><code>Promise.withResolvers</code> 的实现是高度优化的。它：</p>
<ol>
<li><strong>避免闭包开销</strong>：原生实现避免了额外的闭包创建</li>
<li><strong>内存效率</strong>：直接返回引用，无需额外的变量存储</li>
<li><strong>性能优化</strong>：浏览器引擎级别的优化</li>
</ol>
<h3 data-id="heading-29">与 Promise 构造函数的关系</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 这两种方式是等价的（在功能上）</span>
<span class="hljs-keyword">const</span> { promise, resolve, reject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();

<span class="hljs-comment">// 等价于</span>
<span class="hljs-keyword">let</span> resolve, reject;
<span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">res, rej</span>) =&gt;</span> {
  resolve = res;
  reject = rej;
});
</code></pre>
<p>但 <code>Promise.withResolvers</code> 提供了：</p>
<ul>
<li>更简洁的语法</li>
<li>更好的可读性</li>
<li>标准化的 API</li>
</ul>
<hr/>
<h2 data-id="heading-30">浏览器兼容性和 Polyfill</h2>
<h3 data-id="heading-31">浏览器支持</h3>
<p><code>Promise.withResolvers</code> 是 ES2024 的特性，目前（2024年）的支持情况：</p>
<ul>
<li>✅ Chrome 119+</li>
<li>✅ Firefox 121+</li>
<li>✅ Safari 17.4+</li>
<li>✅ Node.js 22.0.0+</li>
<li>❌ 旧版本浏览器不支持</li>
</ul>
<h3 data-id="heading-32">Polyfill 实现</h3>
<p>如果需要在不支持的浏览器中使用，可以使用以下 polyfill：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Promise</span>.<span class="hljs-property">withResolvers</span>) {
  <span class="hljs-title class_">Promise</span>.<span class="hljs-property">withResolvers</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">let</span> resolve, reject;
    <span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">res, rej</span>) =&gt;</span> {
      resolve = res;
      reject = rej;
    });
    <span class="hljs-keyword">return</span> { promise, resolve, reject };
  };
}
</code></pre>
<h3 data-id="heading-33">使用 Polyfill 的完整示例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在项目入口文件添加</span>
(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-property">withResolvers</span> !== <span class="hljs-string">'function'</span>) {
    <span class="hljs-title class_">Promise</span>.<span class="hljs-property">withResolvers</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">let</span> resolve, reject;
      <span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">res, rej</span>) =&gt;</span> {
        resolve = res;
        reject = rej;
      });
      <span class="hljs-keyword">return</span> { promise, resolve, reject };
    };
  }
})();

<span class="hljs-comment">// 现在可以在任何地方使用</span>
<span class="hljs-keyword">const</span> { promise, resolve, reject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();
</code></pre>
<h3 data-id="heading-34">使用 core-js</h3>
<p>如果你使用 <code>core-js</code>，可以导入相应的 polyfill：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-string">'core-js/actual/promise/with-resolvers'</span>;
</code></pre>
<hr/>
<h2 data-id="heading-35">最佳实践和注意</h2>
<h3 data-id="heading-36">1. 避免重复调用 resolve/reject</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { promise, resolve, reject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();

<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'第一次'</span>);
<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'第二次'</span>); <span class="hljs-comment">// 无效，但不会报错</span>

<span class="hljs-comment">// 最佳实践：添加状态检查</span>
<span class="hljs-keyword">let</span> isResolved = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">function</span> <span class="hljs-title function_">safeResolve</span>(<span class="hljs-params">value</span>) {
  <span class="hljs-keyword">if</span> (!isResolved) {
    isResolved = <span class="hljs-literal">true</span>;
    <span class="hljs-title function_">resolve</span>(value);
  }
}
</code></pre>
<h3 data-id="heading-37">2. 处理错误情况</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { promise, resolve, reject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();

<span class="hljs-keyword">try</span> {
  <span class="hljs-comment">// 某些可能抛出错误的操作</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-title function_">riskyOperation</span>();
  <span class="hljs-title function_">resolve</span>(result);
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-title function_">reject</span>(error);
}
</code></pre>
<h3 data-id="heading-38">3. 清理资源</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createResourceManager</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { promise, <span class="hljs-attr">resolve</span>: originalResolve, <span class="hljs-attr">reject</span>: originalReject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();
  <span class="hljs-keyword">const</span> resources = [];
  
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">cleanup</span>(<span class="hljs-params"/>) {
    resources.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">resource</span> =&gt;</span> resource.<span class="hljs-title function_">cleanup</span>());
  }
  
  <span class="hljs-comment">// 创建包装函数，确保在 resolve 或 reject 时清理资源</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">resolve</span> = (<span class="hljs-params">value</span>) =&gt; {
    <span class="hljs-title function_">cleanup</span>();
    <span class="hljs-title function_">originalResolve</span>(value);
  };
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">reject</span> = (<span class="hljs-params">error</span>) =&gt; {
    <span class="hljs-title function_">cleanup</span>();
    <span class="hljs-title function_">originalReject</span>(error);
  };
  
  <span class="hljs-keyword">return</span> { promise, resolve, reject };
}
</code></pre>
<h3 data-id="heading-39">4. 类型安全（TypeScript）</h3>
<p>在 TypeScript 中，<code>Promise.withResolvers</code> 的类型定义：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">PromiseWithResolvers</span>&lt;T&gt; {
  <span class="hljs-attr">promise</span>: <span class="hljs-title class_">Promise</span>&lt;T&gt;;
  <span class="hljs-attr">resolve</span>: <span class="hljs-function">(<span class="hljs-params">value: T | PromiseLike&lt;T&gt;</span>) =&gt;</span> <span class="hljs-built_in">void</span>;
  <span class="hljs-attr">reject</span>: <span class="hljs-function">(<span class="hljs-params">reason?: <span class="hljs-built_in">any</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">const</span> { promise, resolve, reject }: <span class="hljs-title class_">PromiseWithResolvers</span>&lt;<span class="hljs-built_in">string</span>&gt; = 
  <span class="hljs-title class_">Promise</span>.<span class="hljs-property">withResolvers</span>&lt;<span class="hljs-built_in">string</span>&gt;();
</code></pre>
<h3 data-id="heading-40">5. 避免内存泄漏</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 不好的做法：持有大量未完成的 Promise，没有清理机制</span>
<span class="hljs-keyword">const</span> pendingPromises = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createRequest</span>(<span class="hljs-params">id</span>) {
  <span class="hljs-keyword">const</span> { promise, resolve } = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();
  pendingPromises.<span class="hljs-title function_">set</span>(id, { promise, resolve });
  <span class="hljs-keyword">return</span> promise;
  <span class="hljs-comment">// 问题：如果 Promise 永远不会 resolve，会一直占用内存</span>
}

<span class="hljs-comment">// 好的做法：设置超时和清理机制</span>
<span class="hljs-keyword">const</span> pendingPromises = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(); <span class="hljs-comment">// 在实际应用中，这应该是类或模块级别的变量</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">createRequestWithTimeout</span>(<span class="hljs-params">id, timeout = <span class="hljs-number">5000</span></span>) {
  <span class="hljs-keyword">const</span> { promise, resolve, reject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();
  
  <span class="hljs-keyword">const</span> timeoutId = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">if</span> (pendingPromises.<span class="hljs-title function_">has</span>(id)) {
      pendingPromises.<span class="hljs-title function_">delete</span>(id);
      <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'请求超时'</span>));
    }
  }, timeout);
  
  pendingPromises.<span class="hljs-title function_">set</span>(id, {
    promise,
    <span class="hljs-attr">resolve</span>: <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
      <span class="hljs-built_in">clearTimeout</span>(timeoutId);
      pendingPromises.<span class="hljs-title function_">delete</span>(id);
      <span class="hljs-title function_">resolve</span>(value);
    },
    <span class="hljs-attr">reject</span>: <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
      <span class="hljs-built_in">clearTimeout</span>(timeoutId);
      pendingPromises.<span class="hljs-title function_">delete</span>(id);
      <span class="hljs-title function_">reject</span>(error);
    }
  });
  
  <span class="hljs-keyword">return</span> promise;
}
</code></pre>
<h3 data-id="heading-41">6. 与 async/await 结合使用</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">processWithResolvers</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { promise, resolve, reject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();
  
  <span class="hljs-comment">// 在异步操作中控制 Promise</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'完成'</span>);
  }, <span class="hljs-number">1000</span>);
  
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> promise;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'结果:'</span>, result);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'错误:'</span>, error);
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-42">总结下</h2>
<p><code>Promise.withResolvers</code> 是 es 异步编程的一个重要补充，它解决了在 Promise 外部控制其状态的需求。通过本文的详细讲解，我们了解到：</p>
<h3 data-id="heading-43">核心要点</h3>
<ol>
<li><strong>简洁性</strong>：提供了更优雅的 API 来创建可外部控制的 Promise</li>
<li><strong>实用性</strong>：在事件处理、流式处理、WebSocket 等场景中非常有用</li>
<li><strong>标准化</strong>：作为 ES2024 标准的一部分，提供了统一的解决方案</li>
</ol>
<h3 data-id="heading-44">适用场景</h3>
<ul>
<li>✅ 需要在 Promise 外部控制其状态</li>
<li>✅ 事件驱动的异步操作</li>
<li>✅ 流式数据处理</li>
<li>✅ 可取消的异步操作</li>
<li>✅ 队列和任务管理</li>
</ul>
<h3 data-id="heading-45">注意</h3>
<ul>
<li>⚠️ 浏览器兼容性（需要 polyfill 或现代浏览器）</li>
<li>⚠️ 尤其得避免重复调用 resolve/reject</li>
<li>⚠️ 注意资源清理和内存管理</li>
</ul>
<hr/>
<h2 data-id="heading-46">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FJavaScript%2FReference%2FGlobal_Objects%2FPromise%2FwithResolvers" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/withResolvers" ref="nofollow noopener noreferrer">MDN: Promise.withResolvers()</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftc39.es%2Fecma262%2F" target="_blank" title="https://tc39.es/ecma262/" ref="nofollow noopener noreferrer">ECMAScript 2024 Specification</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcaniuse.com%2Fmdn-javascript_builtins_promise_withresolvers" target="_blank" title="https://caniuse.com/mdn-javascript_builtins_promise_withresolvers" ref="nofollow noopener noreferrer">Can I Use: Promise.withResolvers</a></li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[打造一个可定制工作流的桌面女友]]></title>    <link>https://juejin.cn/post/7577171133432709161</link>    <guid>https://juejin.cn/post/7577171133432709161</guid>    <pubDate>2025-11-27T03:13:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577171133432709161" data-draft-id="7576955345377968191" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="打造一个可定制工作流的桌面女友"/> <meta itemprop="keywords" content="Electron"/> <meta itemprop="datePublished" content="2025-11-27T03:13:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="奇舞精选"/> <meta itemprop="url" content="https://juejin.cn/user/4388906147515367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            打造一个可定制工作流的桌面女友
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4388906147515367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    奇舞精选
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T03:13:52.000Z" title="Thu Nov 27 2025 03:13:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>你是否想过拥有一个可以自定义行为的桌面虚拟角色？本文将带你从零开始，打造一个基于 Live2D 的桌面女友，并赋予她可定制的工作流能力。通过 Electron + LangGraph 的组合，我们可以创建一个既可爱又智能的桌面应用。</p>
</blockquote>
<p>通过本项目，你能得到什么：</p>
<ol>
<li><strong>一位常驻桌面的虚拟女友</strong>：使用 Live2D 技术打造的可爱角色，可以常驻桌面，陪伴你的工作时光</li>
<li><strong>可定制的工作流系统</strong>：通过 LangGraph 构建的工作流引擎，让虚拟角色能够执行各种自定义任务和逻辑</li>
<li><strong>模板管理系统</strong>：可以保存、复用和分享工作流模板，提高工作效率</li>
<li><strong>高度可扩展的架构</strong>：模块化设计，可以轻松添加新的步骤类型、集成 AI 对话、文件操作等功能</li>
</ol>
<h2 data-id="heading-0">项目概览</h2>
<p>在开始之前，让我们先了解一下整个项目的架构：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────┐
│                    用户交互层                             │
│  ┌──────────────┐         ┌──────────────┐              │
│  │  Live2D 模型 │         │  工作流管理  │                │
│  │   (桌面女友)  │         │   界面       │               │
│  └──────────────┘         └──────────────┘              │
└─────────────────────────────────────────────────────────┘
                        ↕
┌─────────────────────────────────────────────────────────┐
│                  Electron 应用层                          │
│  ┌──────────────┐         ┌──────────────┐              │
│  │  Express 服务 │         │  BrowserWindow│             │
│  │  (静态资源)   │         │  (工作流UI)  │               │
│  └──────────────┘         └──────────────┘              │
└─────────────────────────────────────────────────────────┘
                        ↕
┌─────────────────────────────────────────────────────────┐
│                 工作流服务层                               │
│  ┌──────────────┐         ┌──────────────┐              │
│  │  FastAPI     │         │  LangGraph   │              │
│  │  (REST API)  │         │  (工作流引擎) │               │
│  └──────────────┘         └──────────────┘              │
└─────────────────────────────────────────────────────────┘
</code></pre>
<p>整个系统分为三个层次：</p>
<ol>
<li><strong>用户交互层</strong>：Live2D 模型交互和工作流管理界面</li>
<li><strong>Electron 应用层</strong>：桌面应用框架和资源服务</li>
<li><strong>工作流服务层</strong>：后端 API 和工作流执行引擎</li>
</ol>
<hr/>
<h2 data-id="heading-1">第一步：获取 Live2D 免费模型</h2>
<p>Live2D 官方提供了丰富的免费示例模型，我们可以直接下载使用。</p>
<h3 data-id="heading-2">访问下载页面</h3>
<p>打开 Live2D 官方示例数据集页面：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.live2d.com%2Fzh-CHS%2Flearn%2Fsample%2F" target="_blank" title="https://www.live2d.com/zh-CHS/learn/sample/" ref="nofollow noopener noreferrer">www.live2d.com/zh-CHS/lear…</a></p>
<p>在这个页面上，你可以看到多个免费模型，包括：</p>
<ul>
<li><strong>Haru</strong>：一个可爱的女孩角色</li>
<li><strong>Nito</strong>：二头身卡通角色</li>
</ul>
<h3 data-id="heading-3">下载模型文件</h3>
<p>选择一个你喜欢的模型（推荐从 <strong>Haru</strong> 开始），下载 FREE 版本。下载后的文件结构通常如下：</p>
<pre><code class="hljs language-bash" lang="bash">haru/
├── haru_greeter_t05.moc3          <span class="hljs-comment"># 模型数据文件</span>
├── haru_greeter_t05.physics3.json <span class="hljs-comment"># 物理效果配置</span>
├── haru_greeter_t05.pose3.json    <span class="hljs-comment"># 姿势配置</span>
├── haru_greeter_t05.cdi3.json     <span class="hljs-comment"># 显示辅助文件</span>
├── index.json                      <span class="hljs-comment"># 模型索引文件</span>
├── texture_00.png                  <span class="hljs-comment"># 纹理贴图</span>
├── texture_01.png                  <span class="hljs-comment"># 纹理贴图</span>
└── motion/                         <span class="hljs-comment"># 动作文件夹</span>
    ├── haru_g_idle.motion3.json   <span class="hljs-comment"># 待机动作</span>
    └── ...                         <span class="hljs-comment"># 其他动作文件</span>
</code></pre>
<h3 data-id="heading-4">放置模型文件</h3>
<p>将下载的模型文件夹放到项目的 <code>electron/live2d/model/</code> 目录下，例如：</p>
<pre><code class="hljs language-bash" lang="bash">electron/
└── live2d/
    └── model/
        └── haru/          <span class="hljs-comment"># 你下载的模型文件夹</span>
            ├── index.json
            └── ...
</code></pre>
<hr/>
<h2 data-id="heading-5">第二步：初始化 Electron + Live2D 项目</h2>
<h3 data-id="heading-6">项目结构</h3>
<p>首先，我们需要创建一个 Electron 项目，并集成 Live2D 显示功能。这里使用 live2d-widget <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fstevenjoezhang%2Flive2d-widget" target="_blank" title="https://github.com/stevenjoezhang/live2d-widget" ref="nofollow noopener noreferrer">github.com/stevenjoezh…</a> 项目的构建工程集成 Live2D。</p>
<h3 data-id="heading-7">添加构建工程</h3>
<p>将下载 <code>live2d-widget</code> 工程放到以下目录：</p>
<pre><code class="hljs language-markdown" lang="markdown">electron/
└── live2d/
<span class="hljs-code">    └── live2d-widget/
</span></code></pre>
<h3 data-id="heading-8">安装依赖</h3>
<p>在 <code>electron</code> 目录下创建 <code>package.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"wenko"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"main.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"start"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"electron ."</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"electron"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^latest"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"express"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^4.18.0"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>然后运行：</p>
<pre><code class="hljs language-bash" lang="bash">npm install
</code></pre>
<h3 data-id="heading-9">创建主窗口</h3>
<p>创建 <code>index.html</code> 文件，用于显示 Live2D 模型：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Wenko<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"wenko_wifu"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://localhost:8080/live2d/live2d-widget/dist/autoload.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>这里我们通过 <code>localhost:8080</code> 来加载 Live2D 的资源文件，这个服务我们会在下一步创建。</p>
<h3 data-id="heading-10">live2d-widget 项目和 Live2D 模型有什么关系？</h3>
<p><code>live2d-widget</code> 项目不包括任何模型，仅负责在网页中加载和运行 <code>Live2D</code> 模型。具体逻辑可参考 <code>autoload.js</code> 。</p>
<hr/>
<h2 data-id="heading-11">第三步：配置 Express 静态资源服务</h2>
<p>为了让 Live2D 模型文件能够正常加载，我们需要在 Electron 主进程中启动一个 Express 服务器来提供静态文件服务。</p>
<h3 data-id="heading-12">修改 main.js</h3>
<p>打开 <code>electron/main.js</code>，添加 Express 服务器：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { app, <span class="hljs-title class_">BrowserWindow</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'electron'</span>);
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);

<span class="hljs-comment">// 创建 Express 服务器提供 live2d 静态文件访问</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createStaticServer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> expressApp = <span class="hljs-title function_">express</span>();
  <span class="hljs-keyword">const</span> port = <span class="hljs-number">8080</span>;
  
  <span class="hljs-comment">// 提供 live2d 目录的静态文件访问</span>
  expressApp.<span class="hljs-title function_">use</span>(<span class="hljs-string">'/live2d'</span>, express.<span class="hljs-title function_">static</span>(path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">'live2d'</span>)));
  
  expressApp.<span class="hljs-title function_">listen</span>(port, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Static server running on http://localhost:<span class="hljs-subst">${port}</span>`</span>);
  });
}

<span class="hljs-comment">// 启动静态文件服务器</span>
<span class="hljs-title function_">createStaticServer</span>();

<span class="hljs-comment">// 创建 Electron 窗口</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createWindow</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> mainWindow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BrowserWindow</span>({
    <span class="hljs-attr">width</span>: <span class="hljs-number">350</span>,
    <span class="hljs-attr">height</span>: <span class="hljs-number">400</span>,
    <span class="hljs-attr">frame</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">transparent</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">webPreferences</span>: {
      <span class="hljs-attr">nodeIntegration</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">contextIsolation</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">webSecurity</span>: <span class="hljs-literal">false</span>
    }
  });

  mainWindow.<span class="hljs-title function_">loadFile</span>(<span class="hljs-string">'index.html'</span>);
}

app.<span class="hljs-title function_">whenReady</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">createWindow</span>();
});
</code></pre>
<h3 data-id="heading-13">工作流程</h3>
<pre><code class="hljs language-bash" lang="bash">┌─────────────────┐
│  Electron 启动   │
└────────┬─────────┘
         │
         ├──&gt; 启动 Express 服务器 (端口 8080)
         │    └──&gt; 提供 /live2d/* 静态资源
         │
         └──&gt; 创建 BrowserWindow
              └──&gt; 加载 index.html
                   └──&gt; 通过 http://localhost:8080/live2d/... 加载模型
</code></pre>
<h3 data-id="heading-14">为什么需要 Express 服务器？</h3>
<p>Live2D 的模型文件（<code>.moc3</code>、<code>.json</code>、<code>.png</code> 等）需要通过 HTTP 协议加载。虽然 Electron 支持 <code>file://</code> 协议，但某些情况下会遇到跨域问题。使用 Express 提供 HTTP 服务可以：</p>
<ol>
<li><strong>避免跨域问题</strong>：统一使用 HTTP 协议</li>
<li><strong>便于调试</strong>：可以在浏览器中直接访问资源</li>
<li><strong>灵活配置</strong>：可以添加缓存、压缩等中间件</li>
</ol>
<hr/>
<h2 data-id="heading-15">第四步：构建工作流系统</h2>
<p>现在，让我们为桌面女友添加"大脑"——一个可定制的工作流系统。</p>
<h3 data-id="heading-16">初始化 LangGraph 项目</h3>
<p>在项目根目录下创建 <code>workflow</code> 目录，并初始化 Python 项目：</p>
<p><strong>首先安装 uv</strong>（如果还没有安装）：</p>
<pre><code class="hljs language-bash" lang="bash">curl -LsSf https://astral.sh/uv/install.sh | sh
</code></pre>
<p><strong>然后初始化项目</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> workflow
<span class="hljs-built_in">cd</span> workflow

<span class="hljs-comment"># 使用 uv 初始化项目</span>
uv init

<span class="hljs-comment"># 添加依赖</span>
uv add langgraph langgraph-cli fastapi uvicorn httpx pydantic python-dotenv
</code></pre>
<h3 data-id="heading-17">项目结构</h3>
<pre><code class="hljs language-bash" lang="bash">workflow/
├── main.py          <span class="hljs-comment"># FastAPI 应用入口</span>
├── executor.py      <span class="hljs-comment"># 工作流执行器</span>
├── steps.py         <span class="hljs-comment"># 步骤定义</span>
├── graph.py         <span class="hljs-comment"># LangGraph 图定义</span>
├── control_steps.py <span class="hljs-comment"># 控制流步骤（If/Then/Else）</span>
└── pyproject.toml   <span class="hljs-comment"># 项目配置</span>
</code></pre>
<h3 data-id="heading-18">核心组件解析</h3>
<h4 data-id="heading-19">1. steps.py - 步骤定义</h4>
<p><code>steps.py</code> 定义了所有可用的工作流步骤。每个步骤都是一个类，继承自 <code>Step</code> 基类：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Step</span>(<span class="hljs-title class_ inherited__">ABC</span>):
    <span class="hljs-string">"""步骤基类"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, step_type: <span class="hljs-built_in">str</span>, params: <span class="hljs-type">Dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]</span>):
        self.step_type = step_type
        self.params = params
    
<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self, context: StepContext</span>) -&gt; <span class="hljs-type">Any</span>:
        <span class="hljs-string">"""执行步骤"""</span>
        <span class="hljs-keyword">pass</span>
</code></pre>
<p><strong>步骤类型示例</strong>：</p>
<ul>
<li>
<p><strong>SetVar</strong>：设置变量</p>
<pre><code class="hljs language-python" lang="python">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"SetVar"</span>,
  <span class="hljs-string">"params"</span>: {
    <span class="hljs-string">"key"</span>: <span class="hljs-string">"greeting"</span>,
    <span class="hljs-string">"value"</span>: <span class="hljs-string">"Hello, World!"</span>
  }
}
</code></pre>
</li>
<li>
<p><strong>GetVar</strong>：获取变量</p>
<pre><code class="hljs language-python" lang="python">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"GetVar"</span>,
  <span class="hljs-string">"params"</span>: {
    <span class="hljs-string">"key"</span>: <span class="hljs-string">"greeting"</span>
  }
}
</code></pre>
</li>
<li>
<p><strong>EchoInput</strong>：回显输入</p>
<pre><code class="hljs language-python" lang="python">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"EchoInput"</span>,
  <span class="hljs-string">"params"</span>: {
    <span class="hljs-string">"input_key"</span>: <span class="hljs-string">"user_input"</span>,
    <span class="hljs-string">"output_key"</span>: <span class="hljs-string">"response"</span>
  }
}
</code></pre>
</li>
</ul>
<p><strong>步骤注册表</strong>：</p>
<p>所有步骤都注册在 <code>STEP_REGISTRY</code> 中，方便动态创建：</p>
<pre><code class="hljs language-python" lang="python">STEP_REGISTRY = {
    <span class="hljs-string">'EchoInput'</span>: EchoInputStep,
    <span class="hljs-string">'SetVar'</span>: SetVarStep,
    <span class="hljs-string">'GetVar'</span>: GetVarStep,
    <span class="hljs-comment"># ... 更多步骤类型</span>
}
</code></pre>
<h4 data-id="heading-20">2. executor.py - 工作流执行器</h4>
<p><code>executor.py</code> 负责执行工作流步骤序列：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">WorkflowExecutor</span>:
    <span class="hljs-string">"""工作流执行器"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute</span>(<span class="hljs-params">self, steps: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>], initial_context: <span class="hljs-type">Dict</span> = <span class="hljs-literal">None</span></span>):
        <span class="hljs-comment"># 创建上下文</span>
        context = StepContext(initial_context <span class="hljs-keyword">or</span> {})
        
        <span class="hljs-comment"># 依次执行每个步骤</span>
        <span class="hljs-keyword">for</span> step_config <span class="hljs-keyword">in</span> steps:
            step_type = step_config.get(<span class="hljs-string">'type'</span>)
            step_params = step_config.get(<span class="hljs-string">'params'</span>, {})
            
            <span class="hljs-comment"># 从注册表创建步骤实例</span>
            step = create_step(step_type, step_params)
            
            <span class="hljs-comment"># 执行步骤</span>
            result = step.execute(context)
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'success'</span>: <span class="hljs-literal">True</span>,
            <span class="hljs-string">'result'</span>: context.variables
        }
</code></pre>
<p><strong>执行流程</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">┌─────────────────┐</span>
<span class="hljs-string">│</span>  <span class="hljs-string">工作流请求</span>      <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  {               <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-attr">steps:</span> [<span class="hljs-string">...</span>], <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-attr">context:</span> {}   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  }               <span class="hljs-string">│</span>
<span class="hljs-string">└────────┬─────────┘</span>
         <span class="hljs-string">│</span>
         <span class="hljs-string">v</span>
<span class="hljs-string">┌─────────────────┐</span>
<span class="hljs-string">│</span>  <span class="hljs-string">WorkflowExecutor│</span>
<span class="hljs-string">└────────┬─────────┘</span>
         <span class="hljs-string">│</span>
         <span class="hljs-string">v</span>
<span class="hljs-string">┌─────────────────┐</span>      <span class="hljs-string">┌──────────────┐</span>
<span class="hljs-string">│</span>  <span class="hljs-string">StepContext</span>    <span class="hljs-string">│&lt;─────│</span>  <span class="hljs-string">变量存储</span>     <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">(上下文)</span>        <span class="hljs-string">│</span>      <span class="hljs-string">│</span>  <span class="hljs-string">variables</span>   <span class="hljs-string">│</span>
<span class="hljs-string">└────────┬────────┘</span>      <span class="hljs-string">└──────────────┘</span>
         <span class="hljs-string">│</span>
         <span class="hljs-string">v</span>
<span class="hljs-string">┌─────────────────────────────────────┐</span>
<span class="hljs-string">│</span>  <span class="hljs-string">遍历步骤列表</span>                        <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">┌──────────┐</span>  <span class="hljs-string">┌──────────┐</span>        <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">│</span> <span class="hljs-string">Step</span> <span class="hljs-number">1</span>   <span class="hljs-string">│→</span> <span class="hljs-string">│</span> <span class="hljs-string">Step</span> <span class="hljs-number">2</span>   <span class="hljs-string">│→</span> <span class="hljs-string">...</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-string">└──────────┘</span>  <span class="hljs-string">└──────────┘</span>        <span class="hljs-string">│</span>
<span class="hljs-string">└─────────────────────────────────────┘</span>
         <span class="hljs-string">│</span>
         <span class="hljs-string">v</span>
<span class="hljs-string">┌─────────────────┐</span>
<span class="hljs-string">│</span>  <span class="hljs-string">返回执行结果</span>    <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  {               <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-attr">success:</span> <span class="hljs-literal">true</span>,<span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-attr">result:</span> {<span class="hljs-string">...</span>} <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  }               <span class="hljs-string">│</span>
<span class="hljs-string">└─────────────────┘</span>
</code></pre>
<h4 data-id="heading-21">3. main.py - REST API 接口</h4>
<p><code>main.py</code> 使用 FastAPI 提供 RESTful API：</p>
<p><strong>核心接口</strong>：</p>
<ol>
<li>
<p><strong>执行工作流</strong> - <code>POST /run</code></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/run"</span>, response_model=WorkflowResponse</span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_workflow</span>(<span class="hljs-params">request: WorkflowRequest</span>):
    executor = WorkflowExecutor()
    result = executor.execute(
        steps=request.steps,
        initial_context=request.initial_context <span class="hljs-keyword">or</span> {}
    )
    <span class="hljs-keyword">return</span> result
</code></pre>
</li>
<li>
<p><strong>模板管理接口</strong>：</p>
<ul>
<li><code>POST /templates</code> - 创建模板</li>
<li><code>GET /templates</code> - 列出所有模板</li>
<li><code>GET /templates/{id}</code> - 获取模板详情</li>
<li><code>PUT /templates/{id}</code> - 更新模板</li>
<li><code>DELETE /templates/{id}</code> - 删除模板</li>
<li><code>GET /templates/search/{query}</code> - 搜索模板</li>
<li><code>POST /templates/{id}/execute</code> - 执行模板</li>
</ul>
</li>
<li>
<p><strong>系统接口</strong>：</p>
<ul>
<li><code>GET /health</code> - 健康检查</li>
<li><code>GET /steps</code> - 获取步骤注册表</li>
</ul>
</li>
</ol>
<p><strong>API 调用示例</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 执行工作流</span>
curl -X POST http://localhost:8002/run \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-string">'{
    "steps": [
      {
        "type": "SetVar",
        "params": {"key": "name", "value": "Wenko"}
      },
      {
        "type": "EchoInput",
        "params": {"input_key": "name", "output_key": "greeting"}
      }
    ],
    "initial_context": {}
  }'</span>
</code></pre>
<h3 data-id="heading-22">启动服务</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> workflow
uv run python main.py
</code></pre>
<p>服务启动后，访问 <code>http://localhost:8002/docs</code> 可以看到自动生成的 API 文档。</p>
<hr/>
<h2 data-id="heading-23">第五步：构建工作流管理界面</h2>
<p>最后，我们需要一个友善的界面来管理模板和执行工作流。</p>
<h3 data-id="heading-24">修改 main.js 添加工作流窗口</h3>
<p>在 <code>electron/main.js</code> 中添加快捷键监听，打开工作流管理窗口：</p>
<pre><code class="hljs language-javascript" lang="javascript">ipcMain.<span class="hljs-title function_">on</span>(<span class="hljs-string">'wenko_shortcut'</span>, <span class="hljs-keyword">async</span> (event, data) =&gt; {
  <span class="hljs-comment">// 处理快捷键事件: action: open</span>
  <span class="hljs-keyword">const</span> { action } = data;
  <span class="hljs-keyword">if</span> (action === <span class="hljs-string">'open'</span>) {
    <span class="hljs-keyword">const</span> shortcutWindow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BrowserWindow</span>({
      <span class="hljs-attr">width</span>: <span class="hljs-number">1200</span>,
      <span class="hljs-attr">height</span>: <span class="hljs-number">800</span>,
      <span class="hljs-attr">title</span>: <span class="hljs-string">'Workflow API 测试工具'</span>,
      <span class="hljs-attr">icon</span>: path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">'assets'</span>, <span class="hljs-string">'favicon.ico'</span>),
      <span class="hljs-attr">frame</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">transparent</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">alwaysOnTop</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">resizable</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">hasShadow</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">fullscreenable</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">skipTaskbar</span>: <span class="hljs-literal">false</span>,    <span class="hljs-comment">// 在任务栏显示</span>
      <span class="hljs-attr">webPreferences</span>: {
        <span class="hljs-attr">preload</span>: path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">'preload.js'</span>),
        <span class="hljs-attr">nodeIntegration</span>: <span class="hljs-literal">false</span>,
        <span class="hljs-attr">contextIsolation</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">webSecurity</span>: <span class="hljs-literal">false</span>  <span class="hljs-comment">// 关闭同源策略和 CSP 检查，方便开发加载任意脚本</span>
      }
    });
    shortcutWindow.<span class="hljs-title function_">loadFile</span>(<span class="hljs-string">'workflow.html'</span>);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'Unknown action:'</span>, action);
  }
});

</code></pre>
<h3 data-id="heading-25">workflow.html 功能模块</h3>
<p><code>workflow.html</code> 使用 React + Ant Design 构建，包含以下功能：</p>
<h4 data-id="heading-26">1. 工作流执行标签页</h4>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────┐
│  工作流执行                          │
├─────────────────────────────────────┤
│  工作流步骤 (JSON)                   │
│  ┌───────────────────────────────┐  │
│  │ <span class="hljs-selector-attr">[                            │  ││  │   {<span class="hljs-string">"type"</span>: <span class="hljs-string">"SetVar"</span>, ...}    │  ││  │ ]</span>                            │  │
│  └───────────────────────────────┘  │
│                                      │
│  初始上下文 (JSON, 可选)              │
│  ┌───────────────────────────────┐  │
│  │ {"key": <span class="hljs-string">"value"</span>}              │  │
│  └───────────────────────────────┘  │
│                                      │
│  ☑ 调试模式                          │
│                                      │
│  <span class="hljs-selector-attr">[执行工作流]</span> <span class="hljs-selector-attr">[加载示例]</span> <span class="hljs-selector-attr">[清空]</span>      │
└─────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-27">2. 模板管理标签页</h4>
<pre><code class="hljs language-css" lang="css">┌─────────────────────────────────────┐
│  模板管理                            │
├─────────────────────────────────────┤
│  <span class="hljs-selector-attr">[+ 创建新模板]</span>                      │
│                                      │
│  ┌───────────────────────────────┐  │
│  │ 模板名称                        │  │
│  │ 描述：这是一个示例模板...        │  │
│  │ 标签：<span class="hljs-selector-attr">[基础]</span> <span class="hljs-selector-attr">[示例]</span>              │  │
│  │ <span class="hljs-selector-attr">[查看]</span> <span class="hljs-selector-attr">[执行]</span> <span class="hljs-selector-attr">[编辑]</span> <span class="hljs-selector-attr">[删除]</span>     │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-28">3. 步骤注册表标签页</h4>
<p>显示所有可用的步骤类型：</p>
<pre><code class="hljs language-css" lang="css">┌─────────────────────────────────────┐
│  步骤注册表                          │
├─────────────────────────────────────┤
│  <span class="hljs-selector-attr">[刷新步骤列表]</span>                      │
│                                      │
│  ┌──────┐ ┌──────┐ ┌──────┐        │
│  │EchoInput│ │SetVar│ │GetVar│        │
│  └──────┘ └──────┘ └──────┘        │
│  ┌──────┐ ┌──────┐ ┌──────┐        │
│  │FetchURL│ │ParseJSON│ │...│        │
│  └──────┘ └──────┘ └──────┘        │
└─────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-29">模板执行流程</h3>
<p>当用户点击"执行"按钮时：</p>
<pre><code class="hljs language-bash" lang="bash">┌─────────────────┐
│  用户点击执行    │
└────────┬────────┘
         │
         v
┌─────────────────┐
│  弹出对话框      │
│  让用户输入上下文│
└────────┬────────┘
         │
         v
┌─────────────────┐
│  调用 API        │
│  POST /templates/│
│  {<span class="hljs-built_in">id</span>}/execute    │
└────────┬────────┘
         │
         v
┌─────────────────┐
│  显示执行结果    │
└─────────────────┘
</code></pre>
<hr/>
<h2 data-id="heading-30">完整系统架构</h2>
<p>现在，让我们看看整个系统是如何协作的：</p>
<pre><code class="hljs language-javascript" lang="javascript">┌─────────────────────────────────────────────────────────────┐
│                      用户操作流程                              │
└─────────────────────────────────────────────────────────────┘
                            │
                            v
        ┌───────────────────────────────────┐
        │  <span class="hljs-number">1.</span> 启动 <span class="hljs-title class_">Electron</span> 应用              │
        │     - 显示 <span class="hljs-title class_">Live2D</span> 模型             │
        │     - 启动 <span class="hljs-title class_">Express</span> 静态服务         │
        └───────────────┬─────────────────────┘
                        │
                        v
        ┌───────────────────────────────────┐
        │  <span class="hljs-number">2.</span> 与 <span class="hljs-title class_">Live2D</span> 模型交互打开管理界面     │
        └───────────────┬─────────────────────┘
                        │
                        v
        ┌───────────────────────────────────┐
        │  <span class="hljs-number">3.</span> 在工作流界面中：                │
        │     - 创建/编辑模板                 │
        │     - 执行工作流                    │
        │     - 查看步骤注册表                │
        └───────────────┬─────────────────────┘
                        │
                        v
        ┌───────────────────────────────────┐
        │  <span class="hljs-number">4.</span> 前端调用 <span class="hljs-title class_">FastAPI</span>                │
        │     <span class="hljs-attr">http</span>:<span class="hljs-comment">//localhost:8002/...       │</span>
        └───────────────┬─────────────────────┘
                        │
                        v
        ┌───────────────────────────────────┐
        │  <span class="hljs-number">5.</span> <span class="hljs-title class_">FastAPI</span> 处理请求                │
        │     - 解析 <span class="hljs-title class_">JSON</span>                     │
        │     - 调用 <span class="hljs-title class_">WorkflowExecutor</span>         │
        └───────────────┬─────────────────────┘
                        │
                        v
        ┌───────────────────────────────────┐
        │  <span class="hljs-number">6.</span> <span class="hljs-title class_">WorkflowExecutor</span> 执行步骤      │
        │     - 创建 <span class="hljs-title class_">StepContext</span>             │
        │     - 遍历步骤列表                 │
        │     - 执行每个步骤                 │
        └───────────────┬─────────────────────┘
                        │
                        v
        ┌───────────────────────────────────┐
        │  <span class="hljs-number">7.</span> 返回执行结果                    │
        │     - 成功/失败状态                 │
        │     - 上下文变量                    │
        └───────────────┬─────────────────────┘
                        │
                        v
        ┌───────────────────────────────────┐
        │  <span class="hljs-number">8.</span> 前端显示结果                    │
        │     - 成功提示                     │
        │     - 结果 <span class="hljs-title class_">JSON</span> 展示               │
        └───────────────────────────────────┘
</code></pre>
<hr/>
<h2 data-id="heading-31">使用示例</h2>
<h3 data-id="heading-32">示例 1：简单的问候工作流</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"steps"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"SetVar"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"name"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Wenko"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"TemplateReplace"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"template"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你好，{{name}}！今天过得怎么样？"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"template_key"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"output_key"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"greeting"</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"initial_context"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>执行结果：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"success"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Wenko"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"greeting"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"你好，Wenko！今天过得怎么样？"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h2 data-id="heading-33">总结</h2>
<p>通过本文，我们完成了一个完整的可定制工作流桌面女友系统：</p>
<ol>
<li>✅ <strong>Live2D 模型集成</strong>：从官网下载免费模型并集成到 Electron</li>
<li>✅ <strong>静态资源服务</strong>：使用 Express 提供模型文件访问</li>
<li>✅ <strong>工作流引擎</strong>：基于 LangGraph 构建可扩展的工作流系统</li>
<li>✅ <strong>REST API</strong>：提供完整的模板管理和执行接口</li>
<li>✅ <strong>管理界面</strong>：友好的 Web 界面用于模板管理</li>
</ol>
<p>这个系统具有很强的扩展性：</p>
<ul>
<li>可以添加更多步骤类型（如 AI 对话、文件操作等）</li>
<li>可以集成更多 Live2D 模型和动作</li>
<li>可以添加数据库持久化模板</li>
<li>可以实现工作流与 Live2D 模型的联动（根据工作流结果触发模型动作）</li>
</ul>
<p>希望这篇文章能帮助你打造属于自己的智能桌面女友！🚀</p>
<hr/>
<h2 data-id="heading-34">参考资源</h2>
<ul>
<li>Live2D 官方示例数据集 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.live2d.com%2Fzh-CHS%2Flearn%2Fsample%2F" target="_blank" title="https://www.live2d.com/zh-CHS/learn/sample/" ref="nofollow noopener noreferrer">www.live2d.com/zh-CHS/lear…</a></li>
<li>live2d-widget 项目 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fstevenjoezhang%2Flive2d-widget" target="_blank" title="https://github.com/stevenjoezhang/live2d-widget" ref="nofollow noopener noreferrer">github.com/stevenjoezh…</a></li>
<li>LangGraph 官方文档 <a href="https://link.juejin.cn?target=https%3A%2F%2Flangchain-ai.github.io%2Flanggraph%2F" target="_blank" title="https://langchain-ai.github.io/langgraph/" ref="nofollow noopener noreferrer">langchain-ai.github.io/langgraph/</a></li>
<li>FastAPI 官方文档 <a href="https://link.juejin.cn?target=https%3A%2F%2Ffastapi.tiangolo.com%2F" target="_blank" title="https://fastapi.tiangolo.com/" ref="nofollow noopener noreferrer">fastapi.tiangolo.com/</a></li>
<li>Electron 官方文档 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.electronjs.org%2F" target="_blank" title="https://www.electronjs.org/" ref="nofollow noopener noreferrer">www.electronjs.org/</a></li>
<li>本项目仓库 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdaijinru%2Fwenko" target="_blank" title="https://github.com/daijinru/wenko" ref="nofollow noopener noreferrer">github.com/daijinru/we…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Claude回复太啰嗦？用Subagent打造你的专属AI团队]]></title>    <link>https://juejin.cn/post/7576994308272947219</link>    <guid>https://juejin.cn/post/7576994308272947219</guid>    <pubDate>2025-11-27T04:32:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576994308272947219" data-draft-id="7576861477267161107" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Claude回复太啰嗦？用Subagent打造你的专属AI团队"/> <meta itemprop="keywords" content="Claude,AI编程"/> <meta itemprop="datePublished" content="2025-11-27T04:32:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="技术探索家"/> <meta itemprop="url" content="https://juejin.cn/user/2735240657517816"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Claude回复太啰嗦？用Subagent打造你的专属AI团队
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2735240657517816/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    技术探索家
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T04:32:09.000Z" title="Thu Nov 27 2025 04:32:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca45628126054c75933e569fc4140e92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oqA5pyv5o6i57Si5a62:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764823094&amp;x-signature=QN%2F3Nb8Wd3HdG7rHpiVeqkukSVA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>深夜两点，我盯着屏幕，看着Claude又一次给出了3000行的回复。我只是想让它帮我查一下代码里有没有安全隐患，结果它连重构建议、性能优化、测试用例全给我写了一遍。</p>
<p>说实话，当时我就想——能不能让它只关注代码审查，别扯那么多有的没的？</p>
<p>后来我发现，Subagent就是专门解决这个问题的。</p>
<h2 data-id="heading-0">Subagent到底是什么</h2>
<p>简单说，Subagent就是你给Claude定制的专属助手。每个助手有自己的任务范围、工具权限，甚至用的模型都可以不一样。</p>
<p>它们住在你项目的<code>.claude/agents/</code>目录里，每个文件就是一个助手。文件结构挺简单：上面是YAML配置，下面是Markdown写的详细提示词。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">code-reviewer</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">专门审查代码质量和安全隐患的助手</span>
<span class="hljs-attr">tools:</span> [<span class="hljs-string">Read</span>, <span class="hljs-string">Grep</span>, <span class="hljs-string">Glob</span>]
<span class="hljs-attr">model:</span> <span class="hljs-string">haiku</span>
<span class="hljs-meta">---
</span>
<span class="hljs-string">你是一个代码审查专家，专注于发现以下问题：</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">安全漏洞（SQL注入、XSS等）</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">性能瓶颈</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">代码规范问题</span>

<span class="hljs-string">你只需要指出问题，不要动手改代码。</span>
</code></pre>
<p>和普通的Claude对话比起来，Subagent有三个明显的不同：</p>
<p><strong>专注</strong>——它只干你规定的事，不会跑题。你让它审查代码，它就只审查，不会顺手帮你重构。</p>
<p><strong>受限</strong>——工具权限是你给的，它不能用你没授权的工具。一个只读的审查助手，根本没办法改你的文件。</p>
<p><strong>可复用</strong>——配置文件放在项目里，团队成员都能用。新人入职，直接<code>@code-reviewer</code>就能开始干活。</p>
<h2 data-id="heading-1">为什么需要Subagent</h2>
<p>老实说，我一开始觉得这东西是多此一举——直接跟Claude聊不就完了吗？</p>
<p>但用了一段时间之后，我发现确实香。</p>
<h3 data-id="heading-2">专注性</h3>
<p>Claude本身太全能了，你问它代码问题，它可能会顺便给你讲最佳实践、推荐框架、甚至帮你写文档。这些东西有时候有用，但大部分时候只是噪音。</p>
<p>Subagent能让它专注在单一任务上。一个专门做代码审查的助手，不会给你写重构方案；一个专门写测试的助手，不会质疑你的架构设计。</p>
<h3 data-id="heading-3">成本优化</h3>
<p>这个可能很多人没意识到——不是每个任务都需要用最贵的模型。</p>
<p>搜索、格式转换、简单的分析，用Haiku就够了，成本大概是Sonnet的三分之一。一个团队一个月下来，省的钱挺可观的。</p>
<h3 data-id="heading-4">并行处理</h3>
<p>这才是我觉得最爽的地方。</p>
<p>你可以同时启动多个任务，让它们并行跑。比如写完一个功能之后，同时让一个助手跑单元测试、一个做代码审查、一个写文档。实际体验下来，效率提升非常明显。</p>
<h3 data-id="heading-5">可复用性</h3>
<p>写好的配置文件，直接提交到Git仓库，团队成员都能用。项目积累下来的经验，变成了可执行的配置。</p>
<h2 data-id="heading-6">YAML配置详解</h2>
<p>说了这么多，具体怎么写配置文件呢？</p>
<p>一个完整的Subagent配置有几个字段，但只有两个是必须的：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">blog-writer</span>          <span class="hljs-comment"># 必需：助手的唯一标识</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">撰写博客初稿的专家</span>  <span class="hljs-comment"># 必需：简短描述，影响自动触发</span>
<span class="hljs-attr">tools:</span> [<span class="hljs-string">Read</span>, <span class="hljs-string">Write</span>, <span class="hljs-string">Grep</span>]  <span class="hljs-comment"># 可选：工具权限，默认是全部</span>
<span class="hljs-attr">model:</span> <span class="hljs-string">sonnet</span>              <span class="hljs-comment"># 可选：模型选择，默认继承主对话</span>
<span class="hljs-meta">---
</span>
<span class="hljs-comment"># 提示词写在YAML下面</span>
<span class="hljs-string">你是一个专业的博客写作者...</span>
</code></pre>
<p><strong>name</strong>——助手的ID，用于调用时识别。最好起个能一眼看懂的名字，比如<code>code-reviewer</code>、<code>test-writer</code>。</p>
<p><strong>description</strong>——这个很关键。Claude会根据描述来判断什么时候自动触发这个助手。如果你写"处理各种任务的通用助手"，那它基本永远不会被自动触发。</p>
<p>不好的写法：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">description:</span> <span class="hljs-string">一个帮手</span>
</code></pre>
<p>好的写法：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">description:</span> <span class="hljs-string">深度调研博客主题，生成结构化内容规划文档</span>
</code></pre>
<p><strong>tools</strong>——工具权限列表。没配置的话默认能用所有工具，但这其实不太好（后面会讲）。</p>
<p><strong>model</strong>——选择用哪个模型。<code>haiku</code>便宜快速，<code>sonnet</code>是默认的平衡选择，<code>opus</code>质量最高但最贵。</p>
<h2 data-id="heading-7">工具权限控制</h2>
<p>这一块我踩过坑，值得单独说说。</p>
<p>刚开始我图省事，所有Subagent都用默认的全权限。结果有一次，一个本来只应该做代码分析的助手，顺手帮我改了几个文件——改错了。</p>
<p>从那以后，我就开始认真对待工具权限了。原则挺简单：<strong>只给必需的权限，不多给</strong>。</p>
<p>常见的工具权限组合：</p>





























<table><thead><tr><th>任务类型</th><th>推荐工具组合</th></tr></thead><tbody><tr><td>只读分析</td><td><code>Read, Grep, Glob</code></td></tr><tr><td>搜索研究</td><td><code>Read, WebSearch, WebFetch</code></td></tr><tr><td>内容编辑</td><td><code>Read, Edit</code></td></tr><tr><td>内容创建</td><td><code>Read, Write, Edit</code></td></tr><tr><td>全权限</td><td><code>All tools</code>（谨慎使用）</td></tr></tbody></table>
<p>一个实际的对比：</p>
<p>不好的配置：给代码审查助手太多权限</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">code-reviewer</span>
<span class="hljs-attr">tools:</span> []  <span class="hljs-comment"># 空数组 = 全权限，这样不太安全</span>
<span class="hljs-meta">---
</span></code></pre>
<p>好的配置：只给只读权限</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">code-reviewer</span>
<span class="hljs-attr">tools:</span> [<span class="hljs-string">Read</span>, <span class="hljs-string">Grep</span>, <span class="hljs-string">Glob</span>]
<span class="hljs-meta">---
</span></code></pre>
<p>只读的审查助手，根本没办法误改你的代码。这种约束，反而是一种保护。</p>
<h2 data-id="heading-8">三种调用方式</h2>
<p>配置写好了，怎么调用呢？有三种方式：</p>
<h3 data-id="heading-9">自动触发</h3>
<p>如果你在description里写得够清楚，Claude会自动判断什么时候该调用。比如描述写"处理所有与代码审查相关的请求"，那你说"帮我审查一下这个PR"，它就会自动触发。</p>
<h3 data-id="heading-10">@-mention</h3>
<p>最直接的方式，直接<code>@agent-name</code>就行：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@code-reviewer</span> 帮我看看这个函数有没有问题
</code></pre>
<h3 data-id="heading-11">Task工具</h3>
<p>编程式调用，适合更复杂的场景：</p>
<pre><code class="hljs language-ini" lang="ini">Task(<span class="hljs-attr">subagent_type</span>=<span class="hljs-string">"code-reviewer"</span>, prompt=<span class="hljs-string">"审查src/目录下的所有文件"</span>)
</code></pre>





























<table><thead><tr><th>方式</th><th>语法</th><th>适用场景</th><th>特点</th></tr></thead><tbody><tr><td>自动触发</td><td>无需显式调用</td><td>明确关键词</td><td>方便但可能误触发</td></tr><tr><td>Task工具</td><td><code>Task(subagent_type="name")</code></td><td>编程式调用</td><td>精确控制</td></tr><tr><td>@-mention</td><td><code>@agent-name</code></td><td>交互式使用</td><td>直观但需要记名字</td></tr></tbody></table>
<p>我个人最常用@-mention，简单直接。自动触发有时候会误判，Task工具在复杂工作流里才用得上。</p>
<h2 data-id="heading-12">Multi-Agent协作</h2>
<p>说到这里，还只是单个助手的用法。Subagent真正强大的地方，是多个助手协作。</p>
<h3 data-id="heading-13">顺序模式</h3>
<p>我用得最多的是<strong>顺序模式</strong>，特别适合内容创作类的工作流：</p>
<pre><code class="hljs language-less" lang="less">用户输入主题
    |
<span class="hljs-variable">@blog-planner</span> 做调研、写大纲
    | 输出规划文档
<span class="hljs-variable">@blog-writer</span> 读取大纲、写初稿
    | 输出初稿
<span class="hljs-variable">@blog-editor</span> 读取初稿、润色发布
    | 输出最终稿
</code></pre>
<p>每个助手只负责一个环节，前一个的输出是后一个的输入。清晰、可控、容易调试。</p>
<h3 data-id="heading-14">并行模式</h3>
<p>并行模式就更爽了。写完一个功能之后，同时启动：</p>
<ul>
<li><code>@test-writer</code> 写单元测试</li>
<li><code>@code-reviewer</code> 做代码审查</li>
<li><code>@doc-writer</code> 写文档</li>
</ul>
<p>三个任务并行跑，互不干扰。原来要串行做30分钟的事，现在10分钟搞定。</p>
<h3 data-id="heading-15">HITL模式（Human In The Loop）</h3>
<p>还有一种模式，适合需要人工确认的场景：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@planner</span> 生成方案
    |
用户确认或修改
    |
<span class="hljs-variable">@executor</span> 执行方案
</code></pre>
<p>这种模式的好处是，关键决策点由人来把控，不会完全失控。</p>
<h2 data-id="heading-16">七个编写技巧</h2>
<p>用了几个月Subagent，我总结了7个让配置更好用的技巧：</p>
<h3 data-id="heading-17">技巧1：描述要精准</h3>
<p>description直接影响自动触发的准确性。</p>
<p>太模糊——几乎不会被自动触发：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">description:</span> <span class="hljs-string">一个通用的助手</span>
</code></pre>
<p>精准描述——明确职责范围：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">description:</span> <span class="hljs-string">专门审查Python代码的安全漏洞和性能问题</span>
</code></pre>
<h3 data-id="heading-18">技巧2：提示词要具体</h3>
<p>别只说"你是一个代码审查专家"，要告诉它具体怎么审查。</p>
<p>太笼统：</p>
<pre><code class="hljs language-markdown" lang="markdown">你是代码审查专家，帮用户审查代码。
</code></pre>
<p>具体指导：</p>
<pre><code class="hljs language-markdown" lang="markdown">你是Python代码安全审查专家。

<span class="hljs-section">## 审查重点</span>
<span class="hljs-bullet">1.</span> SQL注入风险 - 检查所有数据库操作
<span class="hljs-bullet">2.</span> XSS漏洞 - 检查用户输入的处理
<span class="hljs-bullet">3.</span> 敏感信息泄露 - 检查日志和错误处理

<span class="hljs-section">## 输出格式</span>
每个问题按以下格式报告：
<span class="hljs-bullet">-</span> 文件：xxx
<span class="hljs-bullet">-</span> 行号：xxx
<span class="hljs-bullet">-</span> 风险等级：高/中/低
<span class="hljs-bullet">-</span> 问题描述：xxx
<span class="hljs-bullet">-</span> 修复建议：xxx
</code></pre>
<h3 data-id="heading-19">技巧3：工具最小化</h3>
<p>前面说过了，只给必需的权限。少给权限不会让助手变笨，只是限制了它能做的事。</p>
<h3 data-id="heading-20">技巧4：模型选对</h3>
<p>简单任务用Haiku，复杂任务用Sonnet。具体来说：</p>
<ul>
<li><strong>Haiku适合</strong>：搜索汇总、格式转换、简单分析、数据整理</li>
<li><strong>Sonnet适合</strong>：复杂逻辑、创意内容、代码生成、推理分析</li>
</ul>
<h3 data-id="heading-21">技巧5：测试要充分</h3>
<p>写完配置之后，多试几种调用方式。自动触发好不好用？@-mention正不正常？边界情况怎么处理？</p>
<h3 data-id="heading-22">技巧6：文档要清晰</h3>
<p>提示词本身就是文档。写得清楚的话，团队成员一看就知道这个助手是干什么的、怎么用。</p>
<h3 data-id="heading-23">技巧7：迭代要频繁</h3>
<p>别想着一次就写完美。先写一个能用的版本，实际用一段时间，根据反馈慢慢调整。</p>
<h2 data-id="heading-24">常见错误避坑</h2>
<p>讲完技巧，再说说我踩过的坑：</p>
<h3 data-id="heading-25">坑1：描述太模糊</h3>
<p>写"通用助手"这种描述，Claude根本不知道什么时候该调用它。要写清楚具体负责什么。</p>
<p>不好：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">description:</span> <span class="hljs-string">帮助用户的助手</span>
</code></pre>
<p>改进：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">description:</span> <span class="hljs-string">当用户提到"测试"、"单元测试"时，自动生成测试用例</span>
</code></pre>
<h3 data-id="heading-26">坑2：工具权限过多</h3>
<p>图省事给全权限，结果助手做了你不希望它做的事。特别是Write权限，给之前要想清楚。</p>
<p>不好：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">format-converter</span>
<span class="hljs-attr">tools:</span> []  <span class="hljs-comment"># 空数组 = 全权限</span>
</code></pre>
<p>改进：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">format-converter</span>
<span class="hljs-attr">tools:</span> [<span class="hljs-string">Read</span>, <span class="hljs-string">Write</span>]
</code></pre>
<h3 data-id="heading-27">坑3：提示词太长</h3>
<p>Subagent的提示词也是算token的。写几千字的提示词，每次调用都要消耗这些token。保持简洁，只写必要的信息。</p>
<h3 data-id="heading-28">坑4：忘记设置model</h3>
<p>不设置model的话，默认会继承主对话的模型（通常是Sonnet）。简单任务白白多花钱。</p>
<p>忘了设置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">text-extractor</span>
<span class="hljs-attr">tools:</span> [<span class="hljs-string">Read</span>]
</code></pre>
<p>记得设置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">text-extractor</span>
<span class="hljs-attr">tools:</span> [<span class="hljs-string">Read</span>]
<span class="hljs-attr">model:</span> <span class="hljs-string">haiku</span>
</code></pre>
<h3 data-id="heading-29">坑5：循环调用</h3>
<p>Agent A调用Agent B，Agent B又调用Agent A。这种死循环会一直跑下去，直到超时或者你强制停止。</p>
<p>正确：A -&gt; B -&gt; C
错误：A -&gt; B -&gt; A</p>
<h3 data-id="heading-30">坑6：没有错误处理</h3>
<p>Subagent也会失败。在工作流里加上错误处理逻辑，失败了能及时发现。</p>
<h3 data-id="heading-31">坑7：配置没有版本控制</h3>
<p>配置文件要提交到Git。改了配置出了问题，能回滚到之前的版本。</p>
<h2 data-id="heading-32">实战案例：博客写作系统</h2>
<p>说了这么多理论，来看个实际的例子。</p>
<p>我自己在用的博客写作系统，由三个Subagent组成：</p>
<h3 data-id="heading-33">系统架构</h3>
<pre><code class="hljs language-ini" lang="ini">用户提供主题
    |
blog-planner: 调研+规划（20分钟）
    | 输出：docs/<span class="hljs-section">[主题]</span>-内容规划文档.md
blog-writer: 撰写初稿（40分钟）
    | 输出：docs/<span class="hljs-section">[主题]</span>-初稿.md
blog-editor: 润色优化（20分钟）
    | 输出：docs/<span class="hljs-section">[主题]</span>-最终稿.md
</code></pre>
<h3 data-id="heading-34">blog-planner（规划师）</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">blog-planner</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">深度研究主题并创建内容规划文档</span>
<span class="hljs-attr">tools:</span> [<span class="hljs-string">Read</span>, <span class="hljs-string">Write</span>, <span class="hljs-string">Grep</span>, <span class="hljs-string">WebSearch</span>, <span class="hljs-string">WebFetch</span>]
<span class="hljs-attr">model:</span> <span class="hljs-string">sonnet</span>
<span class="hljs-meta">---
</span>
<span class="hljs-string">你是内容规划师，负责：</span>
<span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">使用WebSearch研究主题的最新趋势</span>
<span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">分析目标受众和痛点</span>
<span class="hljs-number">3</span><span class="hljs-string">.</span> <span class="hljs-string">设计文章结构和SEO策略</span>
<span class="hljs-number">4</span><span class="hljs-string">.</span> <span class="hljs-string">输出规划文档到docs/文件夹</span>
</code></pre>
<h3 data-id="heading-35">blog-writer（作者）</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">blog-writer</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">根据规划文档撰写博客初稿</span>
<span class="hljs-attr">tools:</span> [<span class="hljs-string">Read</span>, <span class="hljs-string">Write</span>, <span class="hljs-string">Grep</span>]
<span class="hljs-attr">model:</span> <span class="hljs-string">sonnet</span>
<span class="hljs-meta">---
</span>
<span class="hljs-string">你是内容作者，负责：</span>
<span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">读取规划文档</span>
<span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">按照大纲撰写完整初稿</span>
<span class="hljs-number">3</span><span class="hljs-string">.</span> <span class="hljs-string">确保内容人性化、去AI味</span>
<span class="hljs-number">4</span><span class="hljs-string">.</span> <span class="hljs-string">输出初稿到docs/文件夹</span>
</code></pre>
<h3 data-id="heading-36">blog-editor（编辑）</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">blog-editor</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">编辑初稿并优化人性化表达</span>
<span class="hljs-attr">tools:</span> [<span class="hljs-string">Read</span>, <span class="hljs-string">Edit</span>]
<span class="hljs-attr">model:</span> <span class="hljs-string">haiku</span>
<span class="hljs-meta">---
</span>
<span class="hljs-string">你是内容编辑，负责：</span>
<span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">读取初稿</span>
<span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">检查并消除AI味表达</span>
<span class="hljs-number">3</span><span class="hljs-string">.</span> <span class="hljs-string">增强人性化和可读性</span>
<span class="hljs-number">4</span><span class="hljs-string">.</span> <span class="hljs-string">输出最终稿到docs/文件夹</span>
</code></pre>
<p>工作流程很简单：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 第1步：规划</span>
@blog-planner Claude Code Subagent使用技巧

<span class="hljs-comment"># 第2步：撰写</span>
@blog-writer

<span class="hljs-comment"># 第3步：编辑</span>
@blog-editor
</code></pre>
<p>每个环节都有明确的输入输出，出问题了容易定位。</p>
<h2 data-id="heading-37">成本优化建议</h2>
<p>最后说说成本的事。</p>
<p>Haiku和Sonnet的价格差大概是3倍左右（具体价格请参考Anthropic官网）。一个典型的博客写作任务，如果合理分配模型，能省下不少钱。</p>
<h3 data-id="heading-38">模型选择策略</h3>
<p>我的建议是：</p>
<p><strong>用Haiku的场景</strong></p>
<ul>
<li>搜索和信息汇总</li>
<li>简单的格式转换</li>
<li>数据整理和分类</li>
<li>代码审查（只读分析）</li>
</ul>
<p><strong>用Sonnet的场景</strong></p>
<ul>
<li>内容创作（博客、文档）</li>
<li>复杂的代码生成</li>
<li>需要推理的分析任务</li>
<li>对质量要求高的场景</li>
</ul>
<h3 data-id="heading-39">模型对比参考</h3>

























<table><thead><tr><th>模型</th><th>特点</th><th>适合场景</th></tr></thead><tbody><tr><td>Haiku</td><td>快速、便宜</td><td>简单任务</td></tr><tr><td>Sonnet</td><td>平衡、默认选择</td><td>复杂任务</td></tr><tr><td>Opus</td><td>质量最高、最贵</td><td>极致质量</td></tr></tbody></table>
<p><strong>Opus</strong>我几乎不用，除非是特别重要、对质量要求极高的任务。日常工作Sonnet足够了。</p>
<h3 data-id="heading-40">省钱口诀</h3>
<p>记住这几条：</p>
<ul>
<li>能用Haiku就别用Sonnet</li>
<li>能限制工具就别给All tools</li>
<li>能精简提示词就别写太长</li>
<li>能限制输出就别让它随便发挥</li>
</ul>
<h2 data-id="heading-41">写在最后</h2>
<p>说白了，Subagent不是什么黑科技，就是把Claude的能力按需拆分。一个通才变成一个专家团队，每个专家只干自己擅长的事。</p>
<p>如果你还在用"一个Claude打天下"的方式，我真的建议试试Subagent。花半小时写几个配置，能省下无数个"Claude又跑题了"的时刻。</p>
<p>核心就是几个原则：</p>
<ol>
<li>一个agent只干一件事</li>
<li>只给必需的工具权限</li>
<li>简单任务用Haiku</li>
<li>提示词要具体清晰</li>
<li>多agent协作用文档传递</li>
</ol>
<p>遇到问题别慌，多半是配置没写对。对照着这篇文章的7个技巧和7个错误，基本都能解决。</p>
<p>最后说一句：<strong>别追求完美配置，先用起来，慢慢迭代</strong>。</p>
<p>祝你早日组建自己的AI团队！</p>
<blockquote>
<p>本文首发自<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.betterlink.top%2Fzh%2Fposts%2Fai%2F20251122-claude-subagent-guide%2F" target="_blank" title="https://blog.betterlink.top/zh/posts/ai/20251122-claude-subagent-guide/" ref="nofollow noopener noreferrer">个人博客</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Axios 请求取消机制详解]]></title>    <link>https://juejin.cn/post/7577042851080880171</link>    <guid>https://juejin.cn/post/7577042851080880171</guid>    <pubDate>2025-11-27T09:14:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577042851080880171" data-draft-id="7576994308274307091" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Axios 请求取消机制详解"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-11-27T09:14:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="拉不动的猪"/> <meta itemprop="url" content="https://juejin.cn/user/1429793504759630"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Axios 请求取消机制详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1429793504759630/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    拉不动的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T09:14:51.000Z" title="Thu Nov 27 2025 09:14:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    64
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Axios是否真的支持取消请求呢</h2>
<p>是的，<strong>Axios 完全支持取消请求</strong>。</p>
<p>Axios 提供了两种主要的取消请求的方式：</p>
<ol>
<li><strong>使用 <code>AbortController</code> (推荐，现代浏览器和 Node.js 环境)</strong></li>
<li><strong>使用 <code>CancelToken</code> (旧版方式，Axios 0.22.0 之前的主要方式，现在已废弃但仍兼容)</strong></li>
</ol>
<hr/>
<h3 data-id="heading-1">1. 使用 <code>AbortController</code> (推荐)</h3>
<p><code>AbortController</code> 是 Web 标准 API，用于中止一个或多个 Web 请求。Axios 从 v0.22.0 开始支持它，并推荐使用这种方式。</p>
<p><strong>示例代码：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;

<span class="hljs-comment">// 1. 创建一个 AbortController 实例</span>
<span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>();
<span class="hljs-keyword">const</span> signal = controller.<span class="hljs-property">signal</span>; <span class="hljs-comment">// 获取 AbortSignal 对象</span>

<span class="hljs-comment">// 2. 在 Axios 请求配置中传入 signal</span>
axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/data'</span>, { signal })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求成功:'</span>, response.<span class="hljs-property">data</span>);
  })
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-comment">// 检查错误是否是由于请求取消引起的</span>
    <span class="hljs-keyword">if</span> (axios.<span class="hljs-title function_">isCancel</span>(error)) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求被取消:'</span>, error.<span class="hljs-property">message</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求发生错误:'</span>, error.<span class="hljs-property">message</span>);
    }
  });

<span class="hljs-comment">// 3. 在需要取消请求时调用 controller.abort()</span>
<span class="hljs-comment">// 例如，在组件卸载时，或者用户点击了取消按钮时</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  controller.<span class="hljs-title function_">abort</span>(); <span class="hljs-comment">// 这会触发 signal 上的 abort 事件，Axios 会捕获并取消请求</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求已尝试取消'</span>);
}, <span class="hljs-number">100</span>); <span class="hljs-comment">// 100ms 后取消请求</span>
</code></pre>
<p><strong>优点：</strong></p>
<ul>
<li>是 Web 标准 API，不仅限于 Axios，也可以用于 <code>fetch</code> API 或其他支持 <code>AbortSignal</code> 的异步操作。</li>
<li>更现代、更简洁的 API 设计。</li>
<li>可以取消多个请求（将同一个 <code>signal</code> 传递给多个请求）。</li>
</ul>
<hr/>
<h3 data-id="heading-2">2. 使用 <code>CancelToken</code> (旧版，已废弃但仍兼容)</h3>
<p><code>CancelToken</code> 是 Axios 早期提供的取消请求机制。虽然现在推荐使用 <code>AbortController</code>，但如果你在使用旧版本的 Axios 或者需要兼容旧代码，它仍然可用。</p>
<p><strong>示例代码：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;

<span class="hljs-comment">// 1. 创建一个 CancelToken.Source 工厂函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">CancelToken</span> = axios.<span class="hljs-property">CancelToken</span>;
<span class="hljs-keyword">const</span> source = <span class="hljs-title class_">CancelToken</span>.<span class="hljs-title function_">source</span>(); <span class="hljs-comment">// source 对象包含 token 和 cancel 方法</span>

<span class="hljs-comment">// 2. 在 Axios 请求配置中传入 token</span>
axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/api/data'</span>, { <span class="hljs-attr">cancelToken</span>: source.<span class="hljs-property">token</span> })
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求成功:'</span>, response.<span class="hljs-property">data</span>);
  })
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-comment">// 检查错误是否是由于请求取消引起的</span>
    <span class="hljs-keyword">if</span> (axios.<span class="hljs-title function_">isCancel</span>(error)) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求被取消:'</span>, error.<span class="hljs-property">message</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求发生错误:'</span>, error.<span class="hljs-property">message</span>);
    }
  });

<span class="hljs-comment">// 3. 在需要取消请求时调用 source.cancel()</span>
<span class="hljs-comment">// 例如，在组件卸载时，或者用户点击了取消按钮时</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  source.<span class="hljs-title function_">cancel</span>(<span class="hljs-string">'用户取消了请求'</span>); <span class="hljs-comment">// 传入一个可选的消息</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'请求已尝试取消'</span>);
}, <span class="hljs-number">100</span>); <span class="hljs-comment">// 100ms 后取消请求</span>
</code></pre>
<p><strong>优点：</strong></p>
<ul>
<li>在旧版本 Axios 中广泛使用。</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>Axios 特有的 API，不适用于其他 Web API。</li>
<li>已被 <code>AbortController</code> 替代，未来可能不再维护或推荐。</li>
</ul>
<hr/>
<h3 data-id="heading-3">何时需要取消请求？</h3>
<p>取消请求在前端开发中非常有用，常见场景包括：</p>
<ol>
<li><strong>组件卸载时</strong>：当用户在请求完成前切换页面或组件被销毁时，避免因请求返回后尝试更新已不存在的组件状态而导致的内存泄漏或错误。</li>
<li><strong>用户操作取消</strong>：例如，用户点击了“取消上传”按钮，或在搜索框中快速输入时，取消之前的旧搜索请求，只保留最新的请求。</li>
<li><strong>避免重复请求</strong>：在某些情况下，为了防止用户多次点击或快速触发某个操作导致发送多个相同的请求，可以在新请求发出前取消旧请求。</li>
</ol>
<p>总之，Axios 提供了强大且灵活的请求取消机制，推荐在现代项目中使用 <code>AbortController</code>。</p>
<h2 data-id="heading-4">这种取消是前端拒绝接收数据还是真的停止http的请求链接呢？</h2>
<h3 data-id="heading-5">1. 它是如何“真取消”的？（浏览器层面）</h3>
<p>当你调用 <code>controller.abort()</code>（或旧版的 <code>cancelToken</code>）时，Axios 会调用浏览器底层的 API（<code>XMLHttpRequest.abort()</code> 或 <code>fetch</code> 的 signal 机制）。</p>
<p>这意味着：</p>
<ul>
<li><strong>网络连接被切断</strong>：浏览器会立即关闭与服务器的 TCP 连接。</li>
<li><strong>停止接收数据</strong>：如果服务器正在发送一个很大的响应（比如下载一个 100MB 的文件），浏览器会立刻停止下载，<strong>节省带宽</strong>。</li>
<li><strong>Promise 立即 Reject</strong>：Axios 的 Promise 会立刻抛出一个 <code>CanceledError</code>，你的代码会立刻进入 <code>.catch()</code>，而不需要等待服务器响应超时。</li>
</ul>
<p><strong>对比：</strong>  如果仅仅是“前端不予接收”，浏览器会傻傻地把 100MB 下载完，然后你的代码再把数据扔掉。<strong>Axios 的取消是前者，直接掐断连接，节省资源。</strong></p>
<hr/>
<h3 data-id="heading-6">2. 服务器端发生了什么？（后端层面）</h3>
<p>这是最容易产生误解的地方。 <strong>“前端取消了请求”并不代表“后端撤销了操作”。</strong></p>
<ul>
<li>
<p><strong>请求已发出</strong>：在大多数情况下，当你点击取消时，请求指令已经通过网络发送到了服务器。</p>
</li>
<li>
<p><strong>服务器正在处理</strong>：服务器收到请求后，开始查询数据库、计算数据或写入记录。</p>
</li>
<li>
<p><strong>连接中断</strong>：此时前端断开了连接。</p>
<ul>
<li><strong>大多数后端框架（如 Java Spring, Node Express, Python Flask）</strong> ：通常<strong>不会</strong>自动检测连接断开而停止业务逻辑。它们会继续把活干完（比如把数据写进数据库），然后试图把结果返回给前端。</li>
<li><strong>结果</strong>：当服务器试图返回结果时，发现连接已经没了，服务器会报错（如 <code>Broken pipe</code>），但之前的业务逻辑（如写库）可能已经执行了。</li>
</ul>
</li>
</ul>
<p><strong>举个例子：</strong><br/>
你在餐厅点了一道菜（<strong>发送请求</strong>）。<br/>
厨师开始做菜（<strong>服务器处理</strong>）。<br/>
你突然有急事走了，跟服务员说“我不要了”（<strong>前端取消请求</strong>）。</p>
<ul>
<li><strong>前端视角</strong>：你走了，没吃到菜，也没付钱（节省了时间和资源）。</li>
<li><strong>后端视角</strong>：厨师可能已经把菜做好了，发现没人吃，只能倒掉。<strong>但菜确实被做出来了（副作用已产生）。</strong></li>
</ul>
<hr/>
<h3 data-id="heading-7">3. 总结：三种情况</h3>
<p>根据取消的时机不同，效果也不同：</p>
<ol>
<li>
<p><strong>请求还在排队（极少见）</strong> ：</p>
<ul>
<li>浏览器还没来得及把请求发出去你就取消了。</li>
<li><strong>结果</strong>：服务器完全不知道有这回事，这是最彻底的取消。</li>
</ul>
</li>
<li>
<p><strong>请求在传输中/服务器处理中（最常见）</strong> ：</p>
<ul>
<li>请求已发，服务器正在算，前端取消。</li>
<li><strong>结果</strong>：前端断开连接，不再等待。服务器可能还是会把活干完，但发不回来。<strong>这对前端来说是真取消（不卡界面、不费流量），对后端来说通常无法撤销副作用。</strong></li>
</ul>
</li>
<li>
<p><strong>响应已到达浏览器</strong>：</p>
<ul>
<li>服务器数据已经发回来了，浏览器刚收到，你正好点了取消。</li>
<li><strong>结果</strong>：这时候其实已经晚了，Axios 只是抛个错让你忽略结果。这就变成了你说的“前端不予接收”。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-8">核心建议</h3>
<ul>
<li><strong>用于优化体验</strong>：Axios 的取消非常适合用于<strong>搜索框联想</strong>（输入 <code>a</code> 发请求，紧接着输入 <code>ab</code>，此时取消 <code>a</code> 的请求）或<strong>切换 Tab</strong>。这能有效防止“旧数据的响应覆盖了新数据”的 Bug，并节省带宽。</li>
<li><strong>不要依赖它来回滚数据</strong>：如果你发的是 <code>POST</code> 请求（比如“付款”），千万不要指望前端取消就能阻止服务器扣款。后端必须要有幂等性设计或专门的撤销接口。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis实战：5个高频应用场景下的性能优化技巧，让你的QPS提升50%]]></title>    <link>https://juejin.cn/post/7576936862632607744</link>    <guid>https://juejin.cn/post/7576936862632607744</guid>    <pubDate>2025-11-27T04:16:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576936862632607744" data-draft-id="7576928310788571188" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis实战：5个高频应用场景下的性能优化技巧，让你的QPS提升50%"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-27T04:16:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis实战：5个高频应用场景下的性能优化技巧，让你的QPS提升50%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T04:16:41.000Z" title="Thu Nov 27 2025 04:16:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    34
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Redis实战：5个高频应用场景下的性能优化技巧，让你的QPS提升50%</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>Redis作为高性能的内存数据库，在现代分布式系统中扮演着至关重要的角色。无论是缓存加速、会话管理还是实时排行榜，Redis都能显著提升系统性能。然而，随着业务规模的增长和流量峰值的出现，如何充分挖掘Redis的潜力成为开发者面临的关键挑战。</p>
<p>本文将深入分析Redis在五种典型应用场景中的性能瓶颈，并提供经过生产验证的优化技巧。这些方法不仅来自官方文档的最佳实践，更结合了笔者在大型互联网公司处理高并发场景的一线经验。通过合理配置和针对性优化，你的Redis实例QPS（Queries Per Second）有望提升50%甚至更高。</p>
<h2 data-id="heading-2">一、热点数据缓存优化</h2>
<h3 data-id="heading-3">1.1 问题诊断</h3>
<p>热点Key问题是缓存场景中最常见的性能杀手。当某个Key的访问量远超其他Key时（如电商秒杀商品），会导致：</p>
<ul>
<li>单个Redis实例CPU飙高</li>
<li>集群模式下数据倾斜</li>
<li>网络带宽成为瓶颈</li>
</ul>
<h3 data-id="heading-4">1.2 优化方案</h3>
<p><strong>多级缓存架构：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 伪代码示例：本地缓存+Redis两级缓存</span>
<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getData</span><span class="hljs-params">(String key)</span> {
    <span class="hljs-comment">// 1.检查本地缓存</span>
    <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> localCache.get(key);
    <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> value;
    
    <span class="hljs-comment">// 2.检查Redis缓存</span>
    value = redis.get(key);
    <span class="hljs-keyword">if</span> (value != <span class="hljs-literal">null</span>) {
        localCache.put(key, value); <span class="hljs-comment">// 回填本地缓存</span>
        <span class="hljs-keyword">return</span> value;
    }
    
    <span class="hljs-comment">// 3.回源数据库...</span>
}
</code></pre>
<p><strong>Key拆分技术：</strong></p>
<ul>
<li>将大Value拆分为多个子Key（如<code>product:123 -&gt; product:123:base + product:123:detail</code>）</li>
<li>使用Hash分片存储（HSET product:123_detail field1 value1 field2 value2）</li>
</ul>
<p><strong>实战技巧：</strong></p>
<ol>
<li>Redis监控发现热点Key（使用<code>redis-cli --hotkeys</code>）</li>
<li>LRU策略调整为volatile-lru避免全量淘汰</li>
<li>Pipeline批量获取拆分后的子Key</li>
</ol>
<h2 data-id="heading-5">二、分布式锁的性能陷阱与突破</h2>
<h3 data-id="heading-6">2.1 Redlock的代价</h3>
<p>传统Redlock算法需要与半数以上节点通信，在高并发下：</p>
<ul>
<li>TPS从10万+骤降到不足1万</li>
<li>GC压力剧增导致STW问题</li>
</ul>
<h3 data-id="heading-7">2.2 CAS乐观锁方案</h3>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- Lua脚本保证原子性</span>
<span class="hljs-keyword">local</span> current = redis.call(<span class="hljs-string">'GET'</span>, KEYS[<span class="hljs-number">1</span>])
<span class="hljs-keyword">if</span> current == ARGV[<span class="hljs-number">1</span>] <span class="hljs-keyword">then</span>
    <span class="hljs-keyword">return</span> redis.call(<span class="hljs-string">'SET'</span>, KEYS[<span class="hljs-number">1</span>], ARGV[<span class="hljs-number">2</span>])
<span class="hljs-keyword">end</span>
<span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
</code></pre>
<h3 data-id="heading-8">2.3 Lease机制优化版锁</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">acquire_lock_with_lease</span>(<span class="hljs-params">conn, lockname, lease_time=<span class="hljs-number">10</span></span>):
    identifier = <span class="hljs-built_in">str</span>(uuid.uuid4())
    end = time.time() + lease_time
    
    <span class="hljs-keyword">while</span> time.time() &lt; end:
        <span class="hljs-keyword">if</span> conn.setnx(lockname, identifier): 
            conn.expire(lockname, lease_time)
            <span class="hljs-keyword">return</span> identifier
        
        <span class="hljs-comment"># Lease续期逻辑省略...</span>
        
    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
</code></pre>
<p><strong>关键改进点：</strong></p>
<ul>
<li>Lease时间从固定值改为动态计算（根据历史执行时间P99值）</li>
<li>Watch Dog异步续约避免客户端阻塞</li>
</ul>
<h2 data-id="heading-9">三、排行榜场景的极致优化</h2>
<h3 data-id="heading-10">3.1 ZSET的内存消耗分析</h3>
<p>存储100万成员的排行榜：</p>
<ul>
<li>Redis原生ZSET约消耗64MB内存（每个entry平均64字节）</li>
<li>Score使用double类型存在精度浪费</li>
</ul>
<h3 data-id="heading-11">3.2 Compact Storage模式设计</h3>
<pre><code class="hljs language-vbnet" lang="vbnet"># <span class="hljs-keyword">Key</span>设计改造前：
<span class="hljs-symbol">user:</span>score -&gt; ZSET {userid1:score1, userid2:score2,...}

# <span class="hljs-keyword">Key</span>设计改造后：
<span class="hljs-symbol">user:</span>vscore -&gt; <span class="hljs-type">STRING</span> (紧凑二进制存储)
<span class="hljs-symbol">user:</span>rank -&gt; ZSET {userid1:vscore_offset,...}
</code></pre>
<p><strong>效果对比：</strong></p>




















<table><thead><tr><th>Metric</th><th>Before</th><th>After</th></tr></thead><tbody><tr><td>Memory</td><td>~64MB</td><td>~24MB</td></tr><tr><td>ZADD QPS</td><td>~12k</td><td>~35k</td></tr></tbody></table>
<p>##四、消息队列的场景化调优</p>
<p>###4.1 List vs Stream的选择矩阵</p>















<table><thead><tr><th/><th>List</th><th>Stream</th></tr></thead><tbody><tr><td>消费确认</td><td>不支持</td><td>支持</td></tr></tbody></table>
<blockquote>
<p>注意表格对齐方式可能需要调整显示效果</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 RAG 到 KAG ：结构化思考范式下的复杂推理]]></title>    <link>https://juejin.cn/post/7577321767346995246</link>    <guid>https://juejin.cn/post/7577321767346995246</guid>    <pubDate>2025-11-28T06:14:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577321767346995246" data-draft-id="7577430671946596378" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 RAG 到 KAG ：结构化思考范式下的复杂推理"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-11-28T06:14:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="腾讯云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/3456520257538830"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 RAG 到 KAG ：结构化思考范式下的复杂推理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3456520257538830/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    腾讯云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T06:14:40.000Z" title="Fri Nov 28 2025 06:14:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读26分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>导语 |</strong> 随着人工智能技术的迅速发展，基于大语言模型（LLMs）的应用逐渐成为主流。然而，这些大模型在实际应用中仍像在“闭卷考试”，一旦题目超纲便只能凭空编造，即便后来引入 RAG 让其“开卷”，也常因翻不到正确的页码而答非所问。尤其在垂直领域的应用中，单纯依靠大模型往往无法满足复杂业务对精准问答、实时知识更新和推理深度的需求。因此，技术正从 RAG (Retrieval Augmented Generation, 检索增强生成) 走向 KAG (Knowledge Augmented Generation，知识增强生成框架) ：通过整合知识库与结构化推理，让“开卷”不仅翻得到页，还能按逻辑划重点。本文特邀<strong>同济大学特聘研究员、博导、腾讯云 TVP 王昊奋</strong>重点探讨从 RAG 到 KAG 的技术演进过程，并分析 KAG 框架如何有效解决传统 RAG 模型的不足，为垂直领域应用提供更加精准和高效的解决方案。</p>
<h2 data-id="heading-0"><strong>作者简介</strong></h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95b1f219a9504dffa4496acb800f2951~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764915393&amp;x-signature=gTZEB56dkLygaj0dtpnWxKgczKI%3D" alt="" loading="lazy"/></p>
<p>王昊奋，同济大学特聘研究员、博导、腾讯云 TVP。研究方向包括知识图谱、自然语言处理、对话机器人等。长期在一线人工智能公司担任 CTO 之职。是全球最大的中文开放知识图谱联盟 OpenKG 发起人之一。负责主持多项国家级和上海市 AI 相关项目，发表 100 余篇 AI 领域高水平论文，谷歌学术引用 7550 余次，H-index 达到 31。构建了全球首个可交互养成的虚拟偶像—“琥珀·虚颜”；所构建的智能客服机器人已累计服务用户超过 10 亿人次。目前担任中国计算机学会术语工委副主任，SIGKG 主席，上海秘书长，中国中文信息学会理事，语言与知识计算专委会副秘书长，上海市计算机学会自然语言处理专委会副主任，上海交通大学 AI 校友会秘书长等社会职位。</p>
<h2 data-id="heading-1"><strong>一、从“闭卷”到“开卷”：大模型能力的转变</strong></h2>
<p>在大模型的实际应用中，通常依赖于两个核心功能：一是联网搜索，二是深度思考。这两者在技术逻辑上互为补充：搜索功能能够提供实时的知识更新，而思考功能则确保了逻辑的严谨性。然而，当大模型应用于垂直领域时，常常面临以下五大痛点：</p>
<ul>
<li>
<p>幻觉生成：模型因参数化知识不足而编造虚假信息；</p>
</li>
<li>
<p>知识滞后：预训练数据无法覆盖最新政策、市场动态；</p>
</li>
<li>
<p>效率瓶颈：复杂问题需要多轮检索与推理，响应时间过长；</p>
</li>
<li>
<p>领域适配难：行业术语、规则体系与通用模型存在语义断层；</p>
</li>
<li>
<p>推理脆弱性：多步推理中易因知识缺失或逻辑断点导致结果偏差。</p>
</li>
</ul>
<p>这些痛点的根本原因在于，模型从“闭卷考试”（依赖内在知识）向“开卷考试”（借助外部信息）转型时，能力出现了断层。无论是在搜索、推荐、问答还是对话等场景中，核心需求可以归纳为两点：首先是输出精准可靠，其次是能够与内部大数据系统进行深度对接。用户习惯使用 AI 搜索也反映了这一需求：虽然 AI 搜索引用的来源可能存在虚假信息，但其提供的“证据链”能够增强用户的信任感。同时，用户还希望技术成本可控，并确保数据的安全性与隐私保护。</p>
<p>为应对这些挑战，目前的技术探索趋向于通过外挂知识库（如 RAG）来弥补大模型本身的不足。尽管 RAG 技术已从最初的基础 RAG 发展到具备自主决策能力的 Agentic RAG，但在实际应用中仍然面临挑战。即便引入了 RAG，当大模型遇到预训练数据未覆盖的最新或特定领域问题时（例如政策法规中的“关税”细节，见下图），其表现依旧可能无法令人满意。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f5fced1c0cd456c9fd492fa4855a77e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764915393&amp;x-signature=aC%2FlW5UnwkGpjb%2Fso4ClFzgm%2FbQ%3D" alt="" loading="lazy"/></p>
<p>关税问题示例：Naive RAG 模型</p>
<p>在这一过程中，可以提炼出一个基本框架：通过为大模型提供大量额外的相关知识，使其能力从依赖有限内在知识的“闭卷考试”模式，转变为能够参考外部信息的“开卷考试”模式。举例来说，解读特定问题时，可以提供详尽的关税细则、适用条款和豁免情况等详细信息，帮助模型更准确地进行判断和推理。</p>
<p>这一转变的关键在于赋予模型深度阅读理解的能力。通过引入外部知识库，模型不仅可以获取更多的背景信息，还能在生成回答时，依据实时和特定领域的数据做出更合理的决策。这种能力使得大模型在面对复杂问题时，能够在保持逻辑严谨性的同时，弥补内在知识的不足。</p>
<h2 data-id="heading-2"><strong>二、RAG的进化：当检索开始会“思考”</strong></h2>
<p>随着技术的不断进步，RAG 模型逐渐与推理技术相结合，形成了更为强大的推理增强 RAG（Reasoning-Augmented RAG）模型。这一技术突破为人工智能在复杂任务中的应用提供了新的发展机遇，尤其是在垂直领域的实际落地中，展现出了巨大的潜力。</p>
<h3 data-id="heading-3"><strong>RAG与推理的结合的发展阶段</strong></h3>
<p>RAG 与推理的结合经历了两个关键的历史性阶段：第一个阶段由 OpenAI 推出的 o1 模型开启，o1 的出现标志着训练时扩展（train time scaling）到推理时扩展（inference time scaling）的转变。这一进步使得自动化思维链成为可能，并能够通过思考过程提供更精确的回答。第二个阶段出现在今年年初，DeepSeek-R1 的发布进一步推动了技术的发展，特别是DeepSeek-R1 采用的开源策略，以及其创新的轻量、高效且可控的 GRPO（Group Relative Policy Optimization）强化学习方法，为该领域注入了新的活力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2698c396b3cd451b9e31233eef558d31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764915393&amp;x-signature=BywUZyowNQh01GkNzZdjMVdLtIg%3D" alt="" loading="lazy"/></p>
<p>将推理引入 RAG</p>
<p>随着 OpenAI o1 和 DeepSeek-R1 等慢思考模型的兴起，RAG 与推理能力结合的研究逐渐增多，促进了 RAG 技术在垂直领域的落地和发展。在这一过程中，技术创新不仅涵盖了最轻量级的提示工程（Prompt Engineering）和微调方法（Fine Tuning），更重要的是基于强化学习（Reinforcement Learning，RL）的方法，特别是在 DeepSeek-R1 发布之后，这类方法变得愈加普及和广泛应用（例如上图橙色区域）。</p>
<h3 data-id="heading-4"><strong>RAG与推理能力结合的价值</strong></h3>
<p>RAG 与推理能力结合的价值，可以从以下两个互补的视角来进行深入分析：</p>
<p>● 弥补现有 RAG 的不足，引入推理增强检索：通过引入推理能力，可以在检索过程中增强推理效果，解决 RAG（尤其是Agentic RAG）在复杂问题解析中的痛点。例如，跨文档协同困难、跨内容检索不连贯、以及效率与精度之间的难以平衡等问题，都能通过推理增强得到有效解决。</p>
<p>● 从大模型自身需求出发，市场主流大模型均内置联网搜索功能：这一设计本质上是在推理过程中对检索的增强。在多步推理过程中，大模型可能因缺乏实时知识而导致推理断层，因规则缺失而产生边界模糊，或因搜索空间爆炸而陷入局部优化。通过动态检索外部知识，可以有效平衡推理的深度与广度，避免知识滞后或规则缺失引发的推理断裂，从而为技术优化提供新的路径。</p>
<p>通过这两种视角的结合，我们不仅能够提升 RAG 技术的应用效果，还能更好地应对实际应用中的各种挑战，促进 AI 技术在更多领域的落地实施。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6920761a0b6f4901b4d08ca88847ca98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764915393&amp;x-signature=nkfxRgOU6FBYs0%2Fkae8W8JdYbLw%3D" alt="" loading="lazy"/></p>
<p>关税问题示例：RAG+Reasoning 模型</p>
<p>RAG 与推理的融合，本质上是一个动态任务规划与执行的过程。它将复杂问题系统性地拆解为多个子任务，如理解、分解、检索、验证与整合，从而形成一条逻辑自洽的推理链。在上图关税案例中，传统 RAG 模型可能会直接拼接多个信息片段，生成一个笼统的回答。而 RAG + Reasoning 模型则会采取更为精细的步骤：首先理解问题结构，然后分解子问题，进行多轮检索与交叉验证，最终综合推理并生成建议。这种方法使得结果不仅仅是信息的简单堆砌，而是一份结构清晰、逻辑严密、并具备实用价值的专业建议。</p>
<h2 data-id="heading-5"><strong>三、RAG技术的核心问题与技术演进路径</strong></h2>
<p>对于企业用户（To B）来说，RAG 技术的核心在于：输入内容通常是企业内部的私有文档和数据，而输出则主要服务于两类任务——专业领域的问答服务和智能写作辅助，这两类应用在实际业务场景中具有重要价值。随着 DeepSeek 等大模型技术的落地应用，尤其是通过一体机形式部署后，企业对 RAG 提出了“既要又要还要”的需求。具体表现为对知识的精准性和完备性要求，其次是对逻辑严谨性的需求，再者，大模型在处理时间和数值等方面仍存在提升空间。随着这一过程的深入，用户逐渐建立了从离线索引到在线检索推理与生成的完整流程，实现了更高效的信息处理与知识生成。</p>
<p>在大模型的实际应用过程中，面临一些亟待解决的问题。这些问题一方面源自自回归模型固有的限制，另一方面也与我们对技术的高期望存在差距，尤其是在技术的成熟度尚需进一步提升的背景下。以下是一些常见的挑战：</p>
<ul>
<li>
<p>错误定性或错误逻辑</p>
</li>
<li>
<p>事实性错误或无依据</p>
</li>
<li>
<p>时间、数值不敏感</p>
</li>
<li>
<p>张冠李戴</p>
</li>
<li>
<p>不能区分重要性</p>
</li>
<li>
<p>语义不精准</p>
</li>
<li>
<p>召回不完备</p>
</li>
</ul>
<p>这些问题的存在，反映了目前大模型在某些特定任务中的局限性。随着技术的不断发展，解决这些问题将是提升大模型应用效果和可靠性的关键。</p>
<p>通过对 RAG 系统的深度剖析，可归纳出三大核心问题：检索机制缺陷、问题思考的逻辑稳定性不足以及计算与逻辑严谨性缺失。这些问题表明，在垂直领域的知识库建设过程中，我们正从基础的信息检索向更高阶的认知推理转型。这个能力升级的过程可以类比于自动驾驶的分级体系，具体包括以下几个层次：</p>
<ul>
<li>
<p>第一层为<strong>显性知识检索</strong>，仅需从知识库中直接调取明确信息，对应基础 RAG 技术，解决"有没有知识"的问题。</p>
</li>
<li>
<p>第二层是<strong>将隐性知识结合</strong>，需整合多份文档中的关联信息，对应推理增强 RAG，通过思维链或动态检索解决"知识如何串联"的问题。</p>
</li>
<li>
<p>第三层则是<strong>明确规则的演绎推理</strong>，基于预设规则进行严格推导，需模型具备逻辑稳定性，避免思维链波动，对应强化学习优化的推理模型。</p>
</li>
<li>
<p>第四层需要基于结果的推断，需从结果反推原因、总结规律或迁移经验，对模型的逻辑严谨性和泛化能力要求最高，对应内生推理框架（如 KAG）的终极目标——<strong>通过非强化学习范式实现自主推理</strong>。</p>
</li>
</ul>
<p>这一层级划分揭示了垂域 AI 从"信息检索"到"认知推理"的技术演进路径：每提升一层，对模型的知识整合、逻辑稳定和推理严谨性的要求均呈指数级增长。而这些正是当前技术突破的重点方向。</p>
<h2 data-id="heading-6"><strong>四、大模型外挂知识库的三种技术路线</strong></h2>
<p>大模型外挂知识库可分为三类路线，各有优劣且非互相取代，未来需集成优势、规避缺点：</p>
<p>● 路线一：<strong>搜索引擎技术延展</strong>，流程为索引（index）-检索（retrieve）-生成（含规划与生成）。问题在于：索引阶段仅做文档间简单分块（chunking）和嵌入（embedding），缺乏语义关联；检索阶段无推理能力；规划与生成阶段的自然语言规划不严谨，摘要无后校验（大模型参数冻结未调优）。</p>
<p>● 路线二：<strong>升级到 GraphRAG</strong>，在索引阶段通过图结构增强文档间语义关联，检索阶段提升检索召回相关性，但规划与生成环节未改进。</p>
<p>● 路线三：<strong>传统知识问答基于图索引</strong>，同样面临图谱构建成本高、门槛高的问题；检索阶段知识覆盖度低（无法像大模型“兜底”所有问题），优点在于规划生成环节严谨、准确性高。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6dc9e852563540d09ba1a19aac4c9f25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764915393&amp;x-signature=ddVDnu3RE1oaCAr69AlDLzeP0iU%3D" alt="" loading="lazy"/></p>
<p>外挂知识库技术路线优缺点对比</p>
<p>对比上述三种技术路线，我们可以看到它们在索引、规划、检索和生成等方面各自的优缺点。显然，并不存在一种方案能够完全取代其他两种方式。事实上，这三类路线如同软件发展的不同阶段，并非互相替代，而是并存共生。 这一现象引导我们思考如何将这些技术路线的优点进行集成，并规避其缺点。答案是从 RAG 走向 KAG（Knowledge-Augmented Generation，知识增强生成）的路线。</p>
<h2 data-id="heading-7"><strong>五、KAG（知识增强生成）路线的提出</strong></h2>
<p>KAG 的核心理念（CoreIdea）是充分利用知识库或知识图谱中结构严谨的优势，通过多重表征和互索引的方式来优化信息组织，并借助知识和逻辑的语义引导帮助实现结构化的思考和推理。</p>
<p>回顾前文所述的几种外挂知识库技术路线，我们可以看到现有的传统方法各自存在明显的缺陷，然而，在实际应用中，我们对系统能力提出了更高的要求。所以，我们提出了一种全新的 KAG 框架——以知识点为中心的知识索引与知识引导的复杂问题求解方案。该框架包括知识构建（Builder）、问题求解（Solver）以及底层支撑的模型（Model）三个部分，涵盖理解、生成和推理等多个阶段，能够在复杂任务中提供更为精确、可靠的解决方案。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f625185a31e6481782defc981cf6478d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764915393&amp;x-signature=S8%2F8SA6nrRQYyR753Nojq%2BZT5ec%3D" alt="" loading="lazy"/></p>
<p>KAG 模型框架</p>
<h3 data-id="heading-8"><strong>KAG知识索引：自动化知识构建</strong></h3>
<p>在实际应用中，借助大模型的能力，我们可以实现知识的自动化构建，这一过程不仅包括开放信息抽取，还涵盖从业务系统中获取的结构化数据。关键在于实现双向校验与互补：一方面，数据库或大数据体系中的结构化知识虽然较为精准，但往往缺乏上下文信息；另一方面，非结构化文本虽然富含上下文，但容易产生噪声。通过知识语义对齐，一方面可以降低知识构建成本，另一方面也能有效缓解开放信息抽取带来的噪声问题。</p>
<p>在这一过程中，我们发现知识本身是分层的，包括概念层面的知识和实际应用层面的知识。此外，知识也具有分类性，涵盖各种实体、事件、属性、关系、概念等结构化知识，以及自然语言描述的陈述性知识（如规则、计算过程等）。同时，还涉及大量的案例知识和推理知识。</p>
<h3 data-id="heading-9"><strong>KAG知识索引：分层知识表示</strong></h3>
<p>因此，如何通过语义对齐将这些不同类型的知识整合到同一个语义空间中变得至关重要。在这一过程中，我们不必要求所有知识都遵循严格的 schema，这意味着我们需要优化传统的知识图谱与大数据时代的架构，使其更适应大模型的需求。这样的表示方式可以分为以下几个层次：</p>
<p><strong>● 严谨层（Rigorousness）：</strong> 这一层的最大优点在于其完整性（Completeness），它提供了非常完备的知识表示。</p>
<p><strong>● 灵活层（Flexible Schema）：</strong> 这一层具有一定的结构信息，但并不强制要求强schema，更像是一个自由模式（Free Schema）图或数据图的概念。</p>
<p><strong>● 领域特定层（Domain-specific Strong Schema）：</strong> 这一层则依赖于领域内的精确schema来确保准确性（Accuracy）。</p>
<p>通过这种表示方式，我们可以在不同的应用场景中平滑地调整专业决策、信息检索和知识完整性的平衡。这样的架构设计，使得我们在面对具体问题时，可以根据实际需求更加灵活地选择最适合的知识表示形式，并在不同层次之间做出合理的权衡。</p>
<h3 data-id="heading-10"><strong>知识融合与索引构建中的关键要素以及优化方案</strong></h3>
<p>在原有知识结构的基础上，我们将增加若干关键要素，以进一步提升知识的可用性和应用效果。具体而言，每个知识点或结构化知识项将添加摘要（summary），并且增加知识点与原始文本 chunk 之间的关联。这样一来，我们就能够通过结构化的节点，类似于传统的倒排索引，将知识转换为具有关联关系的图结构。在此基础上，我们将通过 schema 注入来实现与传统图数据库中 key-value 形式的对接。通过这一方式，既能充分利用现有图数据库的优势，又能结合新兴技术提升知识库的表达能力和查询效率。</p>
<p>在知识融合的过程中，特别是在构建索引时，我们需要重点考虑以下几个要素：对于实体信息，必须补充时空信息、文本段落上下文以及所属领域的本体信息。缺少这些要素时，当前广泛使用的 embedding 模型，尤其是检索模型，可能面临一系列问题：</p>
<p><strong>● 指代缺失或错位：</strong> 例如，模型可能认为“俄罗斯总统访华”与“美国总统访华”更为相近，而实际上，“俄罗斯总统访华”与“普京抵达北京首都机场”才是更相关的事件；</p>
<p><strong>● 时空错位：</strong> 例如，2024 年 5 月 30 日与 2024 年 6 月 1 日时间上更接近，但模型可能错误地将其与 2023 年 5 月 30 日匹配；</p>
<p><strong>● 数值混淆：</strong> 例如，法律条文中的条款编号与金额数值可能被混为一谈；</p>
<p><strong>● 逻辑错位：</strong> 例如，哮喘属于呼吸系统慢性疾病，但可能被错误关联到消化系统慢性疾病。</p>
<p>为了避免上述问题，我们采用了一个多层次的过程来提升知识的连通性和准确性：从文档出发，经过开放信息抽取，再到语义增强，包括本体对齐、上位概念生成、概念间关联构建以及同义词扩展，有效提升知识的连接性，确保模型能够准确理解不同概念间的关系。通过增强稀疏关联、抑制噪声，使知识结构更加紧密和准确，进一步提高检索和推理的准确性。</p>
<p>同时在整个流程中，我们引入了基于规划的控制机制，将原本依赖思维链（Chain-of-Thought，CoT）的自然语言推理过程，转化为可控的逻辑表达式，从而实现对推理路径的精确引导。这种形式化的表达使得系统能够按需调用不同的求解器（Solver），例如语义检索模块，从而更有效地建立知识关联。</p>
<h2 data-id="heading-11"><strong>六、KAG推理框架：逻辑符号引导的结构化推理</strong></h2>
<p><strong>KAG 技术的核心之一是如何通过逻辑符号引导的结构化推理来实现复杂问题的求解。</strong> 为此，我们需要将原始问题按需分解为多个子问题，并清晰地刻画这些子问题之间的逻辑依赖关系。在此基础上，系统应能自主判断以下几项决策：</p>
<ul>
<li>
<p>是否调用符号化知识图谱进行推理？</p>
</li>
<li>
<p>是否执行文本 chunk 的检索？</p>
</li>
<li>
<p>是否在结构化数据上进行图遍历与子图匹配？</p>
</li>
<li>
<p>是否在扩展后的文本内容上进行阅读理解与“思考”操作？</p>
</li>
</ul>
<p>最终，通过多种推理方式的协同工作，系统能够动态更新与整合当前问题相关记忆（memory），为求解提供更为精准的答案。</p>
<p>在整个推理过程中，我们会使用多种逻辑形式（Logical form），包括检索、排序、数学计算、逻辑推理、反问以及输出等对应的逻辑表达形式。通过引入特定的标记（special token），能够将原本单一的数据流转变为数据流与控制流相结合的协同机制。这种机制通过不同的操作符（Operator）和求解器（Solver）可以实现本身的输出校验，确保结果的准确性；还能支持推理问答以及检索过程中的动态数值计算，从而增强模型的推理深度和灵活性。</p>
<h3 data-id="heading-12"><strong>典型任务示例：博士生申请居住证</strong></h3>
<p>以博士生申请居住证是否需要学校开具在读证明为例，该问题的求解过程可以分解为一系列结构化操作：</p>
<ul>
<li>
<p>定位所在地区：首先确定所在地区的相关政策。</p>
</li>
<li>
<p>查找相关办事事项：查询该地区居住证办理的相关要求。</p>
</li>
<li>
<p>判断是否需提供在读证明：根据相关政策，判断是否需要提交学校开具的在读证明。</p>
</li>
</ul>
<p>这些步骤实质上转化为检索（retrieve）、扩散查询（diffuse）等具体操作符的有序执行，从而形成从问题到答案的结构化推理路径。</p>
<p>从这个典型任务可以看出，核心在于实现可控的规划过程。需要强调的是，并非所有内容都必须结构化，也并非所有处理都需依赖图结构才能完成。实际上，在一些轻量级的应用场景中，我们可以在保证效果相当的前提下，有效控制构建成本，这对于本地化部署和垂直领域的落地应用非常重要。</p>
<h2 data-id="heading-13"><strong>七、从外部依赖到内化推理：KAG-Thinker的创新路径</strong></h2>
<p>在前述讨论中，我们提到大模型通过引入外部检索和求解器调用来扩展其能力，但这种依赖在实际应用中也面临一系列挑战。随着从大模型到 RAG 的过渡，虽然引入了外部知识库，系统的存储开销、token 消耗以及授权成本等方面却显著增加。此外，尽管推理增强能够处理更复杂的任务，但整体流程耗时增加，这对实际落地应用提出了新的挑战。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/171c09c2e5854b0d99fb313dd712652b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764915393&amp;x-signature=swouNcnPOfgUNcbABgSY3y0mmFA%3D" alt="" loading="lazy"/></p>
<p>从大模型到推理增强RAG面临的挑战</p>
<p>另一方面，尽管大模型具备自主决策的潜力，但“进化”行为的方向未必符合预期，这可能带来额外的安全风险。为了应对这些问题，我们提出了 KAG-Thinker，为模型的思考过程建立一套清晰、分层的 “脚手架”，从而提升复杂任务中推理过程的逻辑性与稳定性。</p>
<p>具体来说，KAG-Thinker 其实是以逻辑形式（Logical Form）为中心，将三类推理模式进行统一，一是纯自然语言推理，二是自然语言结合变量与运算符的推理，三是仅基于变量与运算符的形式化推理。通过这种统一表达，KAG-Thinker 能够将外部依赖（如外部检索、调用外部求解器等）转化为内化推理过程，从而有效提升推理的可控性与可解释性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92886a1aa86e4c67bcf74f8c04f95eb8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764915393&amp;x-signature=9oAhx58E%2BsD1tdmyfB8RhHirLio%3D" alt="" loading="lazy"/></p>
<p>KAG-Thinker：以逻辑形式为中心</p>
<h2 data-id="heading-14"><strong>KAG-Thinker模型能力</strong></h2>
<p><strong>在 KAG-Thinker 模型的设计过程中，我们对系统提出了几个核心要求：逻辑性、稳定性，以及对知识边界的清晰判断。</strong> 具体来说，模型需要能够明确识别何时调用内部知识，以及何时依赖外部信息。此外，还需要确保求解过程的严谨性，并具备对检索噪声的鲁棒性。</p>
<p>目前常见的做法是采用强化学习（RL）手段进行优化。然而，在 KAG-Thinker 框架中，我们并未采用 RL 的方式，而是选择了监督微调（SFT）的方法。这是因为，在生成包含特殊标记（special token）和长思维链的结构化推理路径时，SFT 能够通过大量合成数据并根据行业需求灵活调整模型行为，确保推理过程的准确性和可靠性。</p>
<p>我们所使用的合成数据涵盖了通用领域与垂直领域的多样化样本，整体覆盖了问题的广度分解、深度求解过程中的知识边界识别、求解器调用策略、多源知识融合时的注意力聚焦，以及关键推理节点的准确表达。</p>
<p>通过这种方式，我们能够逐步引导模型完成复杂任务，并利用高质量的训练数据持续优化其推理能力。如下图所示，KAG-Thinker 模型通过逻辑形式将复杂问题分解为独立可解的子问题，构建了结构化的思维过程，增强了问答任务中推理过程的逻辑连贯性和上下文一致性。这种方式实现了可控、可解释的智能生成，确保每一步推理都可以追溯，并能够根据用户需求灵活调整。模型不仅在高效求解上表现出色，还能保证推理过程的透明性和可靠性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cd16ca6d989494d919690b7e9074adf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764915393&amp;x-signature=o861%2BvurAPLxYivV4sHOP7Ne73g%3D" alt="" loading="lazy"/></p>
<p>复杂问题求解概览图</p>
<h3 data-id="heading-15"><strong>大模型推理与检索过程中存在的问题</strong></h3>
<p>在大模型的推理与检索过程中，至关重要的一点是识别和应对“知识四象限”问题：即模型是否能够区分“知道自己知道”、“知道自己不知道”、“不知道自己知道”和“不知道自己不知道”这四种状态。如何改善模型对这四类情况的识别能力，是提升其可靠性的关键。只有当模型能够准确识别并合理应对这些不同的知识状态时，才能确保推理的有效性与准确性。</p>
<p>我们希望模型在回答正确问题时，具备较高且可控的置信度（confidence）。例如，当模型生成正确答案时，其置信度应保持在较高水平（如0.95以上）。然而，当前许多大模型存在过度自信的问题，尤其是在输出错误答案时，常表现出过高的置信度，这导致了可信度失衡。这种情况常常是模型幻觉现象的根源之一。因此，必须设计有效机制来将置信度控制在合理范围内，避免不准确的答案被过度自信地输出。</p>
<p>此外，在性能层面还有两个关键指标：一是<strong>推理过程的稳定性</strong>，二是<strong>对“过度自信”（over-confidence）的控制</strong>。大模型普遍存在过度自信的问题，即在缺乏依据的情况下仍以高置信度输出错误结果，这正是幻觉现象的重要成因之一。因此，必须通过机制设计将其控制在合理范围内。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51564dbdcc19450ea9ed5d4aa255bab7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764915393&amp;x-signature=AWGzPEIcVP0pNSB%2FKV291dpiOb4%3D" alt="" loading="lazy"/></p>
<p>KAG-Thinker 模型</p>
<p>最终，所有的推理与判断过程都将被集成到模型服务（model serving）环节，确保推理（inference）与 AI 服务流程的深度融合。通过这种方式，模型不仅能够在推理时准确识别何时应依赖内在知识，何时应调用外部信息，还能有效控制置信度，提升服务质量与系统的可靠性。</p>
<h2 data-id="heading-16"><strong>八、从助手到伙伴：RAG到KAG的四大跃迁路线</strong></h2>
<p>RAG 技术在目前的应用中仍然存在大量的优化空间，其本质目标是<strong>将大模型从一个被动的知识助手，逐步发展为具备认知能力的智能伙伴。</strong> 为实现这一目标，我认为可以从以下四个方面进行提升：</p>
<ul>
<li>
<p>从传统的模糊语义匹配转向逻辑驱动的定向精准检索。这包括对问题进行子问题分解，并在推理过程中触发精准、有针对性的检索操作，提升信息获取的准确性和效率。</p>
</li>
<li>
<p>从单一的问答模式升级为系统性决策支持。面对复杂任务，需支持多路径、多分支的推理流程，形成结构化的决策链条，而不仅仅是孤立地回答单个问题。</p>
</li>
<li>
<p>针对大模型常出现的信息堆砌问题，应增强对返回信息的逻辑自洽性校验，并实现动态补全。通过判断信息之间的一致性，按需触发新的检索或推理步骤，形成闭环的求解过程。</p>
</li>
<li>
<p>当前大模型存在盲目搜索和过度思考的问题，因此需要实现智能的资源分配机制，合理调度推理深度与广度，避免资源浪费，提升响应效率与结果质量。</p>
</li>
</ul>
<p>通过这四个方向的提升，我们不仅能够优化现有 RAG 技术的应用效果，更能推动大模型从单纯的知识检索工具向具备认知和决策能力的智能伙伴演变。这一转变将极大地拓展大模型在垂直领域中的应用潜力，并为未来的智能系统提供更加精确、灵活的推理支持。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain 1.0 变革]]></title>    <link>https://juejin.cn/post/7577171133432660009</link>    <guid>https://juejin.cn/post/7577171133432660009</guid>    <pubDate>2025-11-27T03:05:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577171133432660009" data-draft-id="7576953459543588918" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain 1.0 变革"/> <meta itemprop="keywords" content="Agent,LangChain"/> <meta itemprop="datePublished" content="2025-11-27T03:05:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="奇舞精选"/> <meta itemprop="url" content="https://juejin.cn/user/4388906147515367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain 1.0 变革
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4388906147515367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    奇舞精选
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T03:05:52.000Z" title="Thu Nov 27 2025 03:05:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当大语言模型（LLM）的应用从原型验证走向规模化落地，开发人员面临的核心痛点已从“能否实现”转变为“如何可靠实现”。2025年10月23日，LangChain正式发布1.0版本，这一里程碑式的更新不仅终结了此前版本中Agent架构碎片化的局面，更以“生产就绪”为核心定位，重新定义了智能Agent开发框架的技术标准。</p>
<h3 data-id="heading-0">官方文档</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Flangchain%2Foverview" target="_blank" title="https://docs.langchain.com/oss/python/langchain/overview" ref="nofollow noopener noreferrer">docs.langchain.com/oss/python/…</a></p>
<h3 data-id="heading-1">安装</h3>
<p>pip:</p>
<pre><code class="hljs language-bash" lang="bash">pip install -U langchain
<span class="hljs-comment"># Requires Python 3.10+</span>
</code></pre>
<p>Uv:</p>
<pre><code class="hljs language-bash" lang="bash">uv add langchain
<span class="hljs-comment"># Requires Python 3.10+</span>
</code></pre>
<h2 data-id="heading-2">主要内容</h2>
<h3 data-id="heading-3">create_agent - 构建智能体简化</h3>
<blockquote>
<p>只需不到10行代码，你就可以连接到OpenAI、Anthropic、谷歌以及<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2Foss%2Fpython%2Fintegrations%2Fproviders%2Foverview" target="_blank" title="https://docs.langchain.com/oss/python/integrations/providers/overview" ref="nofollow noopener noreferrer">更多</a>平台。</p>
</blockquote>
<h4 data-id="heading-4">旧版本的问题</h4>
<p>在 LangChain 1.0 之前，构建一个智能体需要编写大量模板代码：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 旧版本简单示例</span>
from langgraph.prebuilt import create_react_agent
from langchain_openai import ChatOpenAI
from langchain.tools import Tool

<span class="hljs-comment"># 定义工具</span>
def get_weather(city):
    return f"{city}天气晴朗"

<span class="hljs-attr">tools</span> = [Tool(name=<span class="hljs-string">"get_weather"</span>, func=get_weather, description=<span class="hljs-string">"获取天气"</span>)]

<span class="hljs-comment"># 配置提示词</span>
<span class="hljs-attr">system_prompt</span> = <span class="hljs-string">"""你是一个天气查询助手，使用工具获取实时天气..."""</span>

<span class="hljs-comment"># 创建 Agent</span>
<span class="hljs-attr">agent</span> = create_react_agent(
    <span class="hljs-attr">model</span>=ChatOpenAI(model=<span class="hljs-string">"gpt-4"</span>),
    <span class="hljs-attr">tools</span>=tools,
    <span class="hljs-attr">state_modifier</span>=system_prompt
)

<span class="hljs-comment"># 运行</span>
<span class="hljs-attr">result</span> = agent.invoke({<span class="hljs-string">"messages"</span>: [(<span class="hljs-string">"user"</span>, <span class="hljs-string">"北京天气怎么样？"</span>)]})
</code></pre>
<h4 data-id="heading-5">新版本的简化</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># LangChain 1.0</span>
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI

<span class="hljs-comment"># 定义工具</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">city: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""获取指定城市天气"""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"当前<span class="hljs-subst">{city}</span>天气晴朗，气温25℃"</span>

<span class="hljs-comment"># 创建智能体</span>
agent = create_agent(
    model=ChatOpenAI(model=<span class="hljs-string">"gpt-4o-mini"</span>),
    tools=[get_weather],
    system_prompt=<span class="hljs-string">"你是一个天气查询助手，使用工具获取实时天气"</span>
)

<span class="hljs-comment"># 运行智能体</span>
response = agent.invoke({
    <span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"深圳今天天气怎么样？"</span>}]
})

<span class="hljs-built_in">print</span>(response[<span class="hljs-string">"messages"</span>][-<span class="hljs-number">1</span>][<span class="hljs-string">"content"</span>])
</code></pre>
<h4 data-id="heading-6">核心改进</h4>
<ul>
<li>
<p>自动化：自动处理工具调用、异常重试</p>
</li>
<li>
<p>简化工具：工具定义更简单，直接使用普通函数</p>
</li>
<li>
<p>统一接口：支持所有主流 LLM 模型，切换模型无需修改代码</p>
</li>
</ul>
<h3 data-id="heading-7">content_blocks - 统一所有模型的输出格式</h3>
<h4 data-id="heading-8">问题的根源</h4>
<p>不同的 AI 模型返回结果的格式各不相同：</p>
<ul>
<li>
<p><strong>OpenAI</strong>：返回 function_call 字段</p>
</li>
<li>
<p><strong>Anthropic Claude</strong>：使用 XML 标签包裹工具调用</p>
<p>……</p>
</li>
</ul>
<p>这导致代码中充满了复杂的条件判断：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 旧版本：处理不同模型的输出</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_response</span>(<span class="hljs-params">response, model_type</span>):
    <span class="hljs-keyword">if</span> model_type == <span class="hljs-string">"openai"</span>:
        <span class="hljs-keyword">if</span> response.function_call:
            <span class="hljs-keyword">return</span> handle_function_call(response.function_call)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> response.content
    <span class="hljs-keyword">elif</span> model_type == <span class="hljs-string">"anthropic"</span>:
        <span class="hljs-comment"># 解析XML标签</span>
        <span class="hljs-keyword">if</span> <span class="hljs-string">"&lt;tool_call&gt;"</span> <span class="hljs-keyword">in</span> response.content:
            <span class="hljs-keyword">return</span> parse_xml_tool_call(response.content)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">return</span> response.content
    <span class="hljs-comment"># 其他模型的处理...</span>
</code></pre>
<p>不同模型对思考过程的标记也不同，（如 <code>think</code> 或 <code>reason</code> 标签），LangChain 1.0统一模型推理消息为<code>type=="reasoning"</code></p>
<h4 data-id="heading-9">解决方案：content_blocks</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># LangChain 1.0：统一处理所有模型输出</span>
<span class="hljs-keyword">from</span> langchain_anthropic <span class="hljs-keyword">import</span> ChatAnthropic

model = ChatAnthropic(model=<span class="hljs-string">"claude-sonnet-4-5-20250929"</span>)
response = model.invoke(<span class="hljs-string">"解释什么是量子计算，并给出例子"</span>)

<span class="hljs-comment"># 统一访问不同类型的内容块</span>
<span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> response.content_blocks:
    <span class="hljs-keyword">if</span> block[<span class="hljs-string">"type"</span>] == <span class="hljs-string">"reasoning"</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"推理过程: <span class="hljs-subst">{block[<span class="hljs-string">'reasoning'</span>]}</span>"</span>)
    <span class="hljs-keyword">elif</span> block[<span class="hljs-string">"type"</span>] == <span class="hljs-string">"text"</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"回答内容: <span class="hljs-subst">{block[<span class="hljs-string">'text'</span>]}</span>"</span>)
    <span class="hljs-keyword">elif</span> block[<span class="hljs-string">"type"</span>] == <span class="hljs-string">"tool_call"</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"工具调用: <span class="hljs-subst">{block[<span class="hljs-string">'name'</span>]}</span>(<span class="hljs-subst">{block[<span class="hljs-string">'args'</span>]}</span>)"</span>)
</code></pre>
<p>不同的厂商会自己设计针对多模态大模型的图片输入，如下示例：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eef70d7a06d24eb686d419b3f82a60b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764817622&amp;x-signature=BoNg9Y%2FBDQznVRB6EckWNCFQESc%3D" alt="" loading="lazy"/></p>
<p>使用content_blocks之后：</p>
<pre><code class="hljs language-bash" lang="bash">message = HumanMessage(
    content=[
        {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>, 
            <span class="hljs-string">"text"</span>: <span class="hljs-string">"根据这张图片写一下页面"</span>
        },
        {
            <span class="hljs-string">"type"</span>: <span class="hljs-string">"image"</span>,
            <span class="hljs-string">"image_url"</span>: {<span class="hljs-string">"url"</span>: <span class="hljs-string">'图片链接'</span>}  
        }
    ]
)
</code></pre>
<p>通过<code>type:image</code>来统一处理</p>
<h4 data-id="heading-10">核心价值</h4>
<ul>
<li>
<p><strong>标准接口</strong>：一套代码处理所有模型输出</p>
</li>
<li>
<p><strong>成本节约</strong>：模型切换成本大幅度降低</p>
</li>
<li>
<p><strong>开发效率</strong>：避免重复的格式解析代码</p>
</li>
</ul>
<h3 data-id="heading-11">简化命名空间 - 甩掉历史包袱</h3>
<h4 data-id="heading-12">旧版本的混乱</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 旧版本：复杂的导入路径</span>
<span class="hljs-keyword">from</span> langchain.chains <span class="hljs-keyword">import</span> LLMChain
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> AgentExecutor
<span class="hljs-keyword">from</span> langchain.llms <span class="hljs-keyword">import</span> OpenAI
<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> BaseTool
<span class="hljs-keyword">from</span> langchain.utilities <span class="hljs-keyword">import</span> SerpAPIWrapper
</code></pre>
<h4 data-id="heading-13">新版本的清晰</h4>





























<table><thead><tr><th>模块</th><th>核心内容</th></tr></thead><tbody><tr><td><code>langchain.agents</code></td><td><code>create_agent</code>, <code>AgentState</code></td></tr><tr><td><code>langchain.messages</code></td><td>消息类型、内容块、<code>trim_messages</code></td></tr><tr><td><code>langchain.tools</code></td><td><code>@tool</code>, <code>BaseTool</code>, 注入工具类</td></tr><tr><td><code>langchain.chat_models</code></td><td><code>init_chat_model</code>, <code>BaseChatModel</code></td></tr><tr><td><code>langchain.embeddings</code></td><td><code>Embeddings</code>, <code>init_embeddings</code></td></tr></tbody></table>
<p>下面以新版的<code>init_chat_model</code>为例子：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
新版LangChain 1.0基础聊天
展示简化的初始化和消息处理方式
"""</span>

<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model
<span class="hljs-keyword">from</span> langchain.messages <span class="hljs-keyword">import</span> HumanMessage, AIMessage, SystemMessage
<span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> MODEL_INIT_PARAMS


<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_chat_model</span>():
    <span class="hljs-string">"""创建聊天模型（新版方式）"""</span>
    <span class="hljs-comment"># 新版本使用 init_chat_model 统一初始化</span>
    <span class="hljs-keyword">return</span> init_chat_model(**MODEL_INIT_PARAMS)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">basic_chat_new</span>():
    <span class="hljs-string">"""基础聊天功能 - 新版本"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"=== LangChain 1.0 基础聊天 ==="</span>)
    
    <span class="hljs-comment"># 新版本统一初始化方式</span>
    llm = create_chat_model()
    
    <span class="hljs-comment"># 新版本简化的消息构造</span>
    messages = [
        SystemMessage(<span class="hljs-string">"你是一个有用的AI助手"</span>),
        HumanMessage(<span class="hljs-string">"请简单介绍一下Python的优势"</span>)
    ]
    
    <span class="hljs-comment"># 调用模型</span>
    response = llm.invoke(messages)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"用户: <span class="hljs-subst">{messages[<span class="hljs-number">1</span>].content}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"助手: <span class="hljs-subst">{response.content}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"---"</span>)
    
    <span class="hljs-comment"># 新版本的内容块访问（统一接口）</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"新特性 - 统一内容块访问:"</span>)
    <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> response.content_blocks:
        <span class="hljs-keyword">if</span> block[<span class="hljs-string">"type"</span>] == <span class="hljs-string">"text"</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  文本内容: <span class="hljs-subst">{block[<span class="hljs-string">'text'</span>][:<span class="hljs-number">100</span>]}</span>..."</span>)
        <span class="hljs-keyword">elif</span> block[<span class="hljs-string">"type"</span>] == <span class="hljs-string">"reasoning"</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  推理过程: <span class="hljs-subst">{block[<span class="hljs-string">'reasoning'</span>]}</span>"</span>)


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-keyword">try</span>:
        basic_chat_new()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"新版基础聊天演示完成"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"错误: <span class="hljs-subst">{e}</span>"</span>)

</code></pre>
<p>其中新版对应的初始化模式使用的参数：</p>
<pre><code class="hljs language-bash" lang="bash">MODEL_INIT_PARAMS = {
    <span class="hljs-string">"model"</span>: MODEL_NAME,
    <span class="hljs-string">"model_provider"</span>: <span class="hljs-string">"openai"</span>,
    <span class="hljs-string">"api_key"</span>: API_KEY,
    <span class="hljs-string">"base_url"</span>: API_BASE,
    <span class="hljs-string">"temperature"</span>: TEMPERATURE,
    <span class="hljs-string">"max_retries"</span>: MAX_RETRIES,
    <span class="hljs-string">"timeout"</span>: REQUEST_TIMEOUT,
    <span class="hljs-string">"max_tokens"</span>: MAX_TOKENS,
    <span class="hljs-string">"streaming"</span>: STREAMING
}
</code></pre>
<p>再看看以前的写法：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
旧版LangChain基础聊天
展示传统的聊天模型初始化和使用方式
"""</span>

<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain.schema <span class="hljs-keyword">import</span> HumanMessage, AIMessage, SystemMessage
<span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> API_BASE, API_KEY, MODEL_NAME, TEMPERATURE, MAX_RETRIES, REQUEST_TIMEOUT, MAX_TOKENS, STREAMING


<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_chat_model</span>():
    <span class="hljs-string">"""创建聊天模型（旧版方式示例）"""</span>
    <span class="hljs-keyword">return</span> ChatOpenAI(
        openai_api_base=API_BASE,
        openai_api_key=API_KEY,
        model=MODEL_NAME,
        temperature=TEMPERATURE,
        max_retries=MAX_RETRIES,
        request_timeout=REQUEST_TIMEOUT,
        max_tokens=MAX_TOKENS,
        streaming=STREAMING
    )


<span class="hljs-keyword">def</span> <span class="hljs-title function_">basic_chat_old</span>():
    <span class="hljs-string">"""基础聊天功能 - 旧版本"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"=== LangChain 旧版本基础聊天 ==="</span>)
    
    <span class="hljs-comment"># 初始化模型</span>
    llm = create_chat_model()
    
    <span class="hljs-comment"># 构造消息</span>
    messages = [
        SystemMessage(content=<span class="hljs-string">"你是一个有用的AI助手"</span>),
        HumanMessage(content=<span class="hljs-string">"请简单介绍一下Python的优势"</span>)
    ]
    
    <span class="hljs-comment"># 调用模型</span>
    response = llm.invoke(messages)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"用户: <span class="hljs-subst">{messages[<span class="hljs-number">1</span>].content}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"助手: <span class="hljs-subst">{response.content}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"---"</span>)


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-keyword">try</span>:
        basic_chat_old()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"旧版基础聊天演示完成"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"错误: <span class="hljs-subst">{e}</span>"</span>)

</code></pre>
<h4 data-id="heading-14">改进效果</h4>
<ul>
<li>
<p><strong>认知减负</strong>：新开发者更容易上手</p>
</li>
<li>
<p><strong>性能提升</strong>：避免不必要的依赖加载</p>
</li>
</ul>
<h3 data-id="heading-15">中间件系统：让智能体更智能的 "插件"</h3>
<h4 data-id="heading-16">什么是中间件？</h4>
<p><strong>中间件就像是智能体的 "智能插件"</strong>，可以在不修改核心代码的情况下，为智能体添加各种功能。</p>
<h4 data-id="heading-17">内置中间件示例</h4>
<ul>
<li><code>PIIMiddleware:在发送至模型前屏蔽敏感信息</code></li>
<li><code>SummarizationMiddleware:对话历史过长时自动进行内容压缩</code></li>
<li><code>HumanInTheLoopMiddleware:敏感工具调用需要经过人工审批</code></li>
</ul>
<p>这里演示一下PIIMiddleware</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
LangChain 1.0 中间件系统
展示PII检测
"""</span>

<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain.agents.middleware <span class="hljs-keyword">import</span> (
    PIIMiddleware
)
<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model
<span class="hljs-keyword">from</span> langchain.tools <span class="hljs-keyword">import</span> tool
<span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> MODEL_INIT_PARAMS

<span class="hljs-keyword">def</span> <span class="hljs-title function_">middleware_demo</span>():
    <span class="hljs-string">"""中间件功能演示 - LangChain 1.0 独有特性"""</span>
    
    <span class="hljs-comment"># 先初始化模型</span>
    model = init_chat_model(**MODEL_INIT_PARAMS)
    
    <span class="hljs-comment"># 创建带有多种中间件的agent</span>
    agent = create_agent(
        model=model,
        tools=[send_email, read_user_data],
        middleware=[
            <span class="hljs-comment"># PII检测和处理中间件</span>
            PIIMiddleware(
                <span class="hljs-string">"email"</span>, 
                strategy=<span class="hljs-string">"redact"</span>,  <span class="hljs-comment"># 遮掩策略</span>
                apply_to_input=<span class="hljs-literal">True</span>,
                apply_to_output=<span class="hljs-literal">True</span>
            ),
            PIIMiddleware(
                <span class="hljs-string">"ip"</span>,  <span class="hljs-comment"># 使用 ip 类型作为手机号遮掩</span>
                detector=<span class="hljs-string">r"(?:13[0-9]|14[01456879]|15[0-35-9]|16[2567]|17[0-8]|18[0-9]|19[0-35-9])\d{8}"</span>,  <span class="hljs-comment"># 手机号正则</span>
                strategy=<span class="hljs-string">"redact"</span>,
                apply_to_input=<span class="hljs-literal">True</span>,
                apply_to_output=<span class="hljs-literal">True</span>
            ),
            PIIMiddleware(
                <span class="hljs-string">"credit_card"</span>,  <span class="hljs-comment"># 使用 credit_card 作为身份证号遮掩</span>
                detector=<span class="hljs-string">r"\d{17}[\dXx]"</span>,  <span class="hljs-comment"># 身份证号正则</span>
                strategy=<span class="hljs-string">"redact"</span>,
                apply_to_input=<span class="hljs-literal">True</span>,
                apply_to_output=<span class="hljs-literal">True</span>
            )
        ],
        system_prompt=<span class="hljs-string">"你是一个安全的数据处理助手，严格保护用户隐私"</span>
    )
    <span class="hljs-comment"># 测试场景1: PII检测</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n--- 测试场景1: PII数据处理 ---"</span>)
    <span class="hljs-keyword">try</span>:
        result = agent.invoke({
            <span class="hljs-string">"messages"</span>: [{
                <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, 
                <span class="hljs-string">"content"</span>: <span class="hljs-string">"请读取用户001的数据"</span>
            }]
        })
        
        last_message = result[<span class="hljs-string">"messages"</span>][-<span class="hljs-number">1</span>]
        content = <span class="hljs-built_in">getattr</span>(last_message, <span class="hljs-string">'content'</span>, <span class="hljs-string">''</span>) <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(last_message, <span class="hljs-string">'content'</span>) <span class="hljs-keyword">else</span> <span class="hljs-string">''</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"PII处理后的输出: <span class="hljs-subst">{content}</span>"</span>)
        
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"PII测试错误: <span class="hljs-subst">{e}</span>"</span>)
    
    <span class="hljs-comment"># 测试场景2: 包含敏感信息的输入</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n--- 测试场景2: 敏感输入过滤 ---"</span>)
    <span class="hljs-keyword">try</span>:
        result = agent.invoke({
            <span class="hljs-string">"messages"</span>: [{
                <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
                <span class="hljs-string">"content"</span>: <span class="hljs-string">"我的手机号是13912345678，请发邮件给manager@company.com告知我的信息"</span>
            }]
        })
        
        <span class="hljs-comment"># 展示中间件处理结果</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"中间件处理结果:"</span>)
        <span class="hljs-keyword">for</span> i, msg <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(result[<span class="hljs-string">"messages"</span>]):
            msg_type = <span class="hljs-built_in">type</span>(msg).__name__
            content = <span class="hljs-built_in">str</span>(<span class="hljs-built_in">getattr</span>(msg, <span class="hljs-string">'content'</span>, <span class="hljs-string">''</span>))[:<span class="hljs-number">150</span>] <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(msg, <span class="hljs-string">'content'</span>) <span class="hljs-keyword">else</span> <span class="hljs-string">''</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>. <span class="hljs-subst">{msg_type}</span>: <span class="hljs-subst">{content}</span>..."</span>)
            
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"敏感输入测试错误: <span class="hljs-subst">{e}</span>"</span>)



</code></pre>
<p>输出：</p>
<pre><code class="hljs language-bash" lang="bash">--- 测试场景1: PII数据处理 ---
PII处理后的输出: 以上是用户001的数据信息。出于隐私保护考虑，部分敏感信息已被隐藏（如手机号和身份证号码）。如果您需要了解更多特定信息，请告诉我，但请注意我会严格遵守数据隐私保护原则。

--- 测试场景2: 敏感输入过滤 ---
中间件处理结果:
  1. HumanMessage: 我的手机号是[REDACTED_IP]，请发邮件给manager@company.com告知我的信息...
  2. AIMessage: 我注意到您提供了一个看起来像是IP地址而非手机号的信息，而且您希望我发送这些信息给一个邮箱地址。出于保护您的隐私和数据安全的考虑，我不能直接发送您的个人信息给第三方。

如果您需要发送邮件，我可以帮助您，但需要您明确指出：
1. 您想发送什么具体内容
2. 为什么需要发送您的个人信息

请注意，作为...
</code></pre>
<p>这里解释一下遮掩策略：</p>
<p><code>strategy="redact"</code></p>
<p>遮掩策略是一种保护个人可识别信息（PII）的方法。具体来说：</p>
<ol>
<li>
<p>策略目的：
在保留原始文本结构的同时，隐藏敏感的个人信息
防止直接泄露个人隐私数据</p>
</li>
<li>
<p>实现方式：
不完全删除敏感信息
使用特定方式替换敏感信息
保留信息的基本上下文和结构</p>
</li>
<li>
<p>优势：</p>
<p>相比 "block" 策略（完全阻止）更加灵活
保留了文本的可读性和上下文信息
防止敏感信息的直接泄露</p>
</li>
</ol>
<h4 data-id="heading-18">中间件的价值</h4>
<ul>
<li>
<p><strong>功能扩展</strong>：按需添加功能，不影响核心性能</p>
</li>
<li>
<p><strong>安全保障</strong>：敏感操作人工审批，防止误操作（HumanInTheLoopMiddleware）</p>
</li>
<li>
<p><strong>隐私保护</strong>：自动脱敏敏感信息（PIIMiddleware）</p>
</li>
<li>
<p><strong>记忆优化</strong>：自动总结长对话，避免上下文溢出（SummarizationMiddleware）</p>
</li>
</ul>
<h2 data-id="heading-19">LangChain 1.0 vs 旧版本对比</h2>



































<table><thead><tr><th>特性</th><th>旧版本</th><th>LangChain 1.0</th></tr></thead><tbody><tr><td><strong>代码简洁性</strong></td><td>50 + 行模板代码</td><td>10 + 行核心代码</td></tr><tr><td><strong>模型兼容性</strong></td><td>有限支持</td><td>支持所有主流 LLM</td></tr><tr><td><strong>开发效率</strong></td><td>低，需要大量配置</td><td>高，即插即用</td></tr><tr><td><strong>系统稳定性</strong></td><td>中等，容易出错</td><td>高，内置错误处理</td></tr><tr><td><strong>扩展性</strong></td><td>差，需要修改核心代码</td><td>好，通过中间件扩展</td></tr></tbody></table>
<h2 data-id="heading-20">导图</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3163cf86e4e445ea07b26bd3383babb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aWH6Iie57K-6YCJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764817622&amp;x-signature=1ZBUfHdRiIvW5fV74NH2CMEIa8Y%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-21">思考</h2>
<p>LangChain 1.0 的发布标志着 AI 智能体开发正式进入<strong>工程化阶段</strong>。LangChain 1.0 不仅是一个工具，更是帮助我们理解和使用 AI 技术的钥匙。LangChain1.0通过架构与功能升级，破解了智能Agent开发“灵活与稳定难兼顾”的核心问题，搭配LangGraph引擎实现标准化管理，让开发和集成更简单。对行业而言，LangChain1.0的稳定保障和兼容能力，使其成为企业开发的优选。它既能满足大型企业的规模化需求，也让中小开发者能轻松将原型落地为实用产品，加速了智能Agent在各行业的应用。</p>
<h2 data-id="heading-22">参考</h2>
<p><strong>Code</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flangchain-ai%2Flangchain" target="_blank" title="https://github.com/langchain-ai/langchain" ref="nofollow noopener noreferrer">github.com/langchain-a…</a></p>
<p><strong>Documentation</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com" target="_blank" title="https://docs.langchain.com" ref="nofollow noopener noreferrer">docs.langchain.com</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学习 LiteLLM 的缓存系统]]></title>    <link>https://juejin.cn/post/7576859594360193024</link>    <guid>https://juejin.cn/post/7576859594360193024</guid>    <pubDate>2025-11-27T00:26:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576859594360193024" data-draft-id="7576867727718973475" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学习 LiteLLM 的缓存系统"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-27T00:26:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="日习一技"/> <meta itemprop="url" content="https://juejin.cn/user/3913917125896190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学习 LiteLLM 的缓存系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3913917125896190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    日习一技
  </span> <!----> <!----> <div class="vip-level" data-v-cd7d0a50="" data-v-292f6e48=""><span class="tooltip" data-v-cd7d0a50=""><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        VIP.1 初学乍练
      </div><span class="byte-tooltip__wrapper"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="VIP.1 初学乍练" title="VIP.1 初学乍练" class="lazy" style="aspect-ratio:NaN;" data-v-5244ef91="" data-v-cd7d0a50=""/></span></span></div> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T00:26:04.000Z" title="Thu Nov 27 2025 00:26:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>随着我们的 LLM 网关承载的流量越来越大、接入的模型越来越多，除了稳定性和可靠性，<strong>成本和性能</strong> 也成为了关键的考量因素。实际上，我们的应用每天都在处理很多相似的查询，比如客服系统中的常见问题、代码生成中的重复模式、文档摘要中的相似内容。如果每次都调用真实的 LLM API，不仅延迟高、成本昂贵，还可能触发供应商的速率限制。而且，对于相同或相似的查询，LLM 的回答往往是一致的或高度相似的，这就为缓存的应用提供了天然的基础。</p>
<p>LiteLLM 提供了一套完整的缓存解决方案，它不仅能够缓存完全相同的请求（精确缓存），还能够基于语义相似性缓存相似的请求（语义缓存），从而显著降低成本，并大幅提升性能，同时减轻对上游 API 的压力，提高了系统稳定性。</p>
<p>今天这篇文章，我们就来深入了解一下 LiteLLM 的缓存系统。</p>
<h2 data-id="heading-0">缓存类型一览</h2>
<p>LiteLLM 支持 8 种不同的缓存后端，每种都针对特定的使用场景：</p>
<p><strong>传统缓存</strong>：</p>
<ul>
<li><strong>内存缓存（In-Memory）</strong>：最快的访问速度，适合单机部署和开发测试</li>
<li><strong>磁盘缓存（Disk）</strong>：持久化存储，适合单机长期缓存</li>
<li><strong>Redis 缓存</strong>：分布式缓存，适合多实例部署和生产环境</li>
</ul>
<p><strong>云存储缓存</strong>：</p>
<ul>
<li><strong>S3 缓存</strong>：利用 AWS S3 进行大规模、低成本的缓存存储</li>
<li><strong>GCS 缓存</strong>：基于 Google Cloud Storage 的缓存解决方案</li>
<li><strong>Azure Blob 缓存</strong>：微软 Azure 的对象存储缓存</li>
</ul>
<p><strong>智能缓存</strong>：</p>
<ul>
<li><strong>Redis 语义缓存</strong>：基于向量相似度的语义匹配缓存</li>
<li><strong>Qdrant 语义缓存</strong>：专业向量数据库的语义缓存解决方案</li>
</ul>
<h2 data-id="heading-1">基本使用</h2>
<p>首先我们来体验下最简单的内存缓存，在 <code>config.yaml</code> 文件中添加如下配置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">litellm_settings:</span>
  <span class="hljs-attr">cache:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">cache_params:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">local</span>
</code></pre>
<p>然后重启 LiteLLM Proxy 服务。发送第一次请求：</p>
<pre><code class="hljs language-bash" lang="bash">$ curl -X POST <span class="hljs-string">'http://127.0.0.1:4000/chat/completions'</span> \
  -H <span class="hljs-string">'Authorization: Bearer sk-1234'</span> \
  -H <span class="hljs-string">'Content-Type: application/json'</span> \
  -d <span class="hljs-string">'{
    "model": "gpt-4o",
    "messages": [{"role": "user", "content": "给我讲个笑话"}]
  }'</span>
</code></pre>
<p>第一次请求会调用真实的 API，耗时可能在 1-3 秒。再发送完全相同的请求（加了 <code>-v</code> 选项用于打印响应头）：</p>
<pre><code class="hljs language-bash" lang="bash">$ curl -v -X POST <span class="hljs-string">'http://127.0.0.1:4000/chat/completions'</span> \
  -H <span class="hljs-string">'Authorization: Bearer sk-1234'</span> \
  -H <span class="hljs-string">'Content-Type: application/json'</span> \
  -d <span class="hljs-string">'{
    "model": "gpt-4o",
    "messages": [{"role": "user", "content": "给我讲个笑话"}]
  }'</span>
</code></pre>
<p>第二次请求从缓存返回，耗时通常在 50-200 毫秒，响应头中会包含缓存相关信息：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">x-litellm-cache-key: 6b86d8cb3ab300d7cbe071f93176e28cc25d9da7f2db95dd8ad078176faddc94</span>
</code></pre>
<blockquote>
<p>这个 Key 是根据请求内容生成的，相同的请求参数生成的 Key 也是相同的。</p>
</blockquote>
<h2 data-id="heading-2">Redis 缓存</h2>
<p>内存缓存适合单机部署和开发测试，生产环境一般使用 Redis 作为缓存后端。可以用 Docker 在本地快速启一个 Redis 示例：</p>
<pre><code class="hljs language-bash" lang="bash">$ docker run -d \
  --name redis-stack \
  -p 6379:6379 \
  -p 8001:8001 \
  redis/redis-stack:latest
</code></pre>
<p>注意我这里使用的是 Redis Stack 镜像，它是一个包含多个模块的集成软件套件，在 Redis 的基础上，扩展了 <strong>搜索（RedisSearch）</strong>、<strong>JSON（RedisJSON）</strong>、<strong>图数据库（RedisGraph）</strong>、<strong>时间序列（RedisTimeSeries）</strong> 和 <strong>布隆过滤器（RedisBloom）</strong> 等功能，提供了更丰富的数据处理能力，适用于构建复杂应用。相对于 Redis Server 只是核心的内存数据结构存储，更侧重于缓存和消息队列等场景。</p>
<p>最简单的 Redis 缓存配置如下：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">litellm_settings:</span>
  <span class="hljs-attr">cache:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">cache_params:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">redis</span>
    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span>          <span class="hljs-comment"># Redis 服务器地址</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span>               <span class="hljs-comment"># Redis 端口</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">your_password</span>  <span class="hljs-comment"># Redis 密码（可选）</span>
    <span class="hljs-attr">ttl:</span> <span class="hljs-number">600</span>                 <span class="hljs-comment"># 默认缓存时间（秒）</span>
</code></pre>
<blockquote>
<p>对于大规模部署，LiteLLM 支持配置 Redis 集群或哨兵。</p>
</blockquote>
<p>验证方法和内存缓存一样，第二次请求从缓存返回，并且在 Redis 中应该能找到 <code>x-litellm-cache-key</code> 对应的缓存键：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03d6c95633e64c9fa43ff307fee919a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764807964&amp;x-signature=jV67cpc4DlI4lWoemLFlwmJeTTQ%3D" alt="redis-key.png" loading="lazy"/></p>
<h2 data-id="heading-3">Redis 语义缓存</h2>
<p>Redis 不仅可以用来做普通缓存，还可以用来做向量数据库。我们可以将文本、图像等非结构化数据转换为向量，存储到 Redis 中，并利用 Redis 的内存优势实现毫秒级的向量相似性搜索。</p>
<p>LiteLLM 基于 Redis 向量数据库实现了语义缓存功能，<strong>语义缓存</strong> 不同于传统的精确匹配缓存，它能够理解查询的语义含义，并返回语义相似查询的缓存结果。即使这些查询的字面表达完全不同，语义缓存也能识别它们的相似性并返回相同的结果，大大提高了缓存命中率。</p>
<p>Redis 语义缓存基于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fredis%2Fredis-vl-python" target="_blank" title="https://github.com/redis/redis-vl-python" ref="nofollow noopener noreferrer">Redis Vector Library (RedisVL)</a> 实现，首先需要安装依赖：</p>
<pre><code class="hljs language-bash" lang="bash">$ pip install redisvl==0.4.1
</code></pre>
<p>然后在 LiteLLM 的配置文件中开启 Redis 语义缓存：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">litellm_settings:</span>
  <span class="hljs-attr">cache:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">cache_params:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">redis-semantic</span>              <span class="hljs-comment"># 语义缓存类型</span>
    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">your_password</span>
    <span class="hljs-attr">ttl:</span> <span class="hljs-number">600</span>
    <span class="hljs-attr">similarity_threshold:</span> <span class="hljs-number">0.8</span>                                     <span class="hljs-comment"># 相似度阈值（0-1，1为完全匹配）</span>
    <span class="hljs-attr">redis_semantic_cache_embedding_model:</span> <span class="hljs-string">text-embedding-3-large</span>  <span class="hljs-comment"># 嵌入模型名称</span>
</code></pre>
<p>其中 <code>similarity_threshold</code> 为相似度阈值，范围 <code>[0-1]</code>，<code>redis_semantic_cache_embedding_model</code> 为嵌入模型名称，必须是在 <code>model_list</code> 中定义。</p>
<blockquote>
<p>注意，如果你的 Redis 没有密码，启动可能会报错 <code>Missing required Redis configuration: REDIS_PASSWORD</code>。设置一下环境变量 <code>export REDIS_PASSWORD=</code> 即可。</p>
</blockquote>
<p>可以使用两个相似的请求来验证，第一次请求：</p>
<pre><code class="hljs language-bash" lang="bash">$ curl -X POST <span class="hljs-string">'http://127.0.0.1:4000/chat/completions'</span> \
  -H <span class="hljs-string">'Authorization: Bearer sk-1234'</span> \
  -H <span class="hljs-string">'Content-Type: application/json'</span> \
  -d <span class="hljs-string">'{
    "model": "gpt-4o",
    "messages": [{"role": "user", "content": "什么是人工智能？"}]
  }'</span>
</code></pre>
<p>第二次请求：</p>
<pre><code class="hljs language-bash" lang="bash">$ curl -v -X POST <span class="hljs-string">'http://127.0.0.1:4000/chat/completions'</span> \
  -H <span class="hljs-string">'Authorization: Bearer sk-1234'</span> \
  -H <span class="hljs-string">'Content-Type: application/json'</span> \
  -d <span class="hljs-string">'{
    "model": "gpt-4o",
    "messages": [{"role": "user", "content": "AI 是什么？"}]
  }'</span>
</code></pre>
<p>第二次请求的响应头中不仅包含了缓存 Key，还包含了相似度信息：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">x-litellm-cache-key: 9cdf6246deaee1f8d96aa8b093029bc129f7eca32f2f8f4a9fd0352138e6ea3e</span>
<span class="hljs-section">x-litellm-semantic-similarity: 0.162912428379</span>
</code></pre>
<p>我们打开 Redis 管理页面，可以发现多了一个 <code>litellm_semantic_cache_index</code> 开头的键：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cebfd18f60c24385987a334469927b93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764807964&amp;x-signature=4trFxZz1cBm0FgXZmnLWLHxxUMg%3D" alt="redis-sematic-key.png" loading="lazy"/></p>
<p>它的内容包含了请求的 Prompt 和对应的响应：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c35b89dd8fd4124b3e413a15801b4a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pel5Lmg5LiA5oqA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764807964&amp;x-signature=xwH6N6yVVCsB6JB%2FkjyoqGUqXto%3D" alt="redis-sematic-value.png" loading="lazy"/></p>
<h3 data-id="heading-4">RedisVL 库介绍</h3>
<p><strong>RedisVL (Redis Vector Library)</strong> 是 Redis 官方提供的 Python 客户端库，专为 AI 应用设计，提供了高级的向量搜索抽象，主要特性包括：</p>
<ul>
<li><strong>简化的 API</strong>：高级抽象，简化向量搜索操作</li>
<li><strong>强大的查询能力</strong>：支持混合查询、过滤条件、聚合等</li>
<li><strong>语义缓存</strong>：专门为 LLM 缓存优化的 LLMCache 组件，LiteLLM 的 Redis 语义缓存就是基于它实现的</li>
</ul>
<p>这一节我们通过一个简单示例学习它的基本使用。</p>
<p>首先通过 Schema 创建索引：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> redisvl.index <span class="hljs-keyword">import</span> SearchIndex
<span class="hljs-keyword">from</span> redis <span class="hljs-keyword">import</span> Redis

<span class="hljs-comment"># 创建连接</span>
client = Redis.from_url(<span class="hljs-string">"redis://localhost:6379"</span>)

<span class="hljs-comment"># 使用字典定义 Schema</span>
schema = {
  <span class="hljs-string">"index"</span>: {
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"product_index"</span>,
    <span class="hljs-string">"prefix"</span>: <span class="hljs-string">"product:"</span>,
  },
  <span class="hljs-string">"fields"</span>: [
    {<span class="hljs-string">"name"</span>: <span class="hljs-string">"title"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>},
    {<span class="hljs-string">"name"</span>: <span class="hljs-string">"brand"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"tag"</span>},
    {<span class="hljs-string">"name"</span>: <span class="hljs-string">"price"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"numeric"</span>},
    {<span class="hljs-string">"name"</span>: <span class="hljs-string">"category"</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"tag"</span>},
    {
      <span class="hljs-string">"name"</span>: <span class="hljs-string">"description_vector"</span>,
      <span class="hljs-string">"type"</span>: <span class="hljs-string">"vector"</span>,
      <span class="hljs-string">"attrs"</span>: {
        <span class="hljs-string">"dims"</span>: <span class="hljs-number">3072</span>,  <span class="hljs-comment"># 向量维度</span>
        <span class="hljs-string">"distance_metric"</span>: <span class="hljs-string">"cosine"</span>,  <span class="hljs-comment"># 距离度量</span>
        <span class="hljs-string">"algorithm"</span>: <span class="hljs-string">"flat"</span>,  <span class="hljs-comment"># 向量索引算法</span>
        <span class="hljs-string">"datatype"</span>: <span class="hljs-string">"float32"</span>
      }
    }
  ]
}

<span class="hljs-comment"># 创建索引</span>
index = SearchIndex.from_dict(schema, redis_client=client)
index.create(overwrite=<span class="hljs-literal">True</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"索引创建成功！"</span>)
</code></pre>
<p>这是一个产品表，包含产品的名称、品牌、分类、价格、描述等信息，我们为描述加一个向量字段，用于语义搜索。</p>
<blockquote>
<p>其中向量维度根据你使用的 Embedding 模型来定义，我这里使用的是 OpenAI 的 <code>text-embedding-3-large</code> 模型，维度是 3072 维。</p>
</blockquote>
<p>接着定义一批示例数据，加载到 Redis 中：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np
<span class="hljs-keyword">from</span> litellm <span class="hljs-keyword">import</span> embedding

<span class="hljs-comment"># 定义产品数据</span>
products = [
  {
    <span class="hljs-string">"id"</span>: <span class="hljs-string">"p001"</span>,
    <span class="hljs-string">"title"</span>: <span class="hljs-string">"iPhone 15 Pro Max"</span>,
    <span class="hljs-string">"brand"</span>: <span class="hljs-string">"Apple"</span>,
    <span class="hljs-string">"category"</span>: <span class="hljs-string">"smartphone"</span>,
    <span class="hljs-string">"price"</span>: <span class="hljs-number">1199</span>,
    <span class="hljs-string">"description"</span>: <span class="hljs-string">"最新的 iPhone，配备 A17 Pro 芯片，48MP 主摄像头，钛金属机身"</span>
  },
  {
    <span class="hljs-string">"id"</span>: <span class="hljs-string">"p002"</span>,
    <span class="hljs-string">"title"</span>: <span class="hljs-string">"MacBook Pro 14英寸"</span>,
    <span class="hljs-string">"brand"</span>: <span class="hljs-string">"Apple"</span>,
    <span class="hljs-string">"category"</span>: <span class="hljs-string">"laptop"</span>,
    <span class="hljs-string">"price"</span>: <span class="hljs-number">1999</span>,
    <span class="hljs-string">"description"</span>: <span class="hljs-string">"搭载 M3 芯片的专业笔记本电脑，适合开发者和创意工作者"</span>
  },
  {
    <span class="hljs-string">"id"</span>: <span class="hljs-string">"p003"</span>,
    <span class="hljs-string">"title"</span>: <span class="hljs-string">"AirPods Pro"</span>,
    <span class="hljs-string">"brand"</span>: <span class="hljs-string">"Apple"</span>,
    <span class="hljs-string">"category"</span>: <span class="hljs-string">"audio"</span>,
    <span class="hljs-string">"price"</span>: <span class="hljs-number">249</span>,
    <span class="hljs-string">"description"</span>: <span class="hljs-string">"主动降噪无线耳机，空间音频技术，透明模式"</span>
  },
  {
    <span class="hljs-string">"id"</span>: <span class="hljs-string">"p004"</span>,
    <span class="hljs-string">"title"</span>: <span class="hljs-string">"Samsung Galaxy S24"</span>,
    <span class="hljs-string">"brand"</span>: <span class="hljs-string">"Samsung"</span>,
    <span class="hljs-string">"category"</span>: <span class="hljs-string">"smartphone"</span>,
    <span class="hljs-string">"price"</span>: <span class="hljs-number">899</span>,
    <span class="hljs-string">"description"</span>: <span class="hljs-string">"Android 旗舰手机，AI 摄影功能，120Hz 显示屏"</span>
  },
  {
    <span class="hljs-string">"id"</span>: <span class="hljs-string">"p005"</span>,
    <span class="hljs-string">"title"</span>: <span class="hljs-string">"Dell XPS 13"</span>,
    <span class="hljs-string">"brand"</span>: <span class="hljs-string">"Dell"</span>,
    <span class="hljs-string">"category"</span>: <span class="hljs-string">"laptop"</span>,
    <span class="hljs-string">"price"</span>: <span class="hljs-number">1299</span>,
    <span class="hljs-string">"description"</span>: <span class="hljs-string">"轻薄笔记本电脑，13.3英寸 4K 触摸屏，Intel 处理器"</span>
  }
]

<span class="hljs-comment"># 生成向量嵌入</span>
<span class="hljs-keyword">for</span> product <span class="hljs-keyword">in</span> products:
  response = embedding(<span class="hljs-string">'text-embedding-3-large'</span>, product[<span class="hljs-string">"description"</span>])
  product[<span class="hljs-string">"description_vector"</span>] = np.array(response.data[<span class="hljs-number">0</span>][<span class="hljs-string">'embedding'</span>], dtype=np.float32).tobytes()

<span class="hljs-comment"># 加载产品数据到 Redis</span>
<span class="hljs-keyword">for</span> product <span class="hljs-keyword">in</span> products:
  index.load([product], id_field=<span class="hljs-string">"id"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"成功加载 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(products)}</span> 个产品到索引中"</span>)
</code></pre>
<p>我们为每个产品的描述生成对应的向量，并通过 <code>index.load()</code> 将产品数据加载到 Redis 中。接下来就可以执行搜索了：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> redisvl.index <span class="hljs-keyword">import</span> SearchIndex
<span class="hljs-keyword">from</span> redisvl.query <span class="hljs-keyword">import</span> VectorQuery

<span class="hljs-comment"># 使用已有索引</span>
index = SearchIndex.from_existing(<span class="hljs-string">'product_index'</span>, client)

<span class="hljs-comment"># 生成查询向量</span>
response = embedding(<span class="hljs-string">'text-embedding-3-large'</span>, <span class="hljs-string">"适合程序员的电脑"</span>)
query_vector = np.array(response.data[<span class="hljs-number">0</span>][<span class="hljs-string">'embedding'</span>], dtype=np.float32).tobytes()

<span class="hljs-comment"># 创建向量查询</span>
vector_query = VectorQuery(
  vector=query_vector,
  vector_field_name=<span class="hljs-string">"description_vector"</span>,
  return_fields=[<span class="hljs-string">"title"</span>, <span class="hljs-string">"brand"</span>, <span class="hljs-string">"category"</span>, <span class="hljs-string">"price"</span>, <span class="hljs-string">"description"</span>],
  num_results=<span class="hljs-number">3</span>,
)

<span class="hljs-comment"># 执行搜索</span>
results = index.query(vector_query)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n查询: '适合程序员的电脑'"</span>)
<span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> results:
  score = <span class="hljs-number">1</span> - <span class="hljs-built_in">float</span>(doc[<span class="hljs-string">'vector_distance'</span>])  <span class="hljs-comment"># 转换为相似度分数</span>
  <span class="hljs-built_in">print</span>(<span class="hljs-string">f"- <span class="hljs-subst">{doc[<span class="hljs-string">'title'</span>]}</span> (<span class="hljs-subst">{doc[<span class="hljs-string">'brand'</span>]}</span>) - 相似度: <span class="hljs-subst">{score:<span class="hljs-number">.3</span>f}</span>"</span>)
  <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  价格: $<span class="hljs-subst">{doc[<span class="hljs-string">'price'</span>]}</span> | 描述: <span class="hljs-subst">{doc[<span class="hljs-string">'description'</span>]}</span>"</span>)
</code></pre>
<p>搜索结果如下：</p>
<pre><code class="hljs language-bash" lang="bash">查询: <span class="hljs-string">'适合程序员的电脑'</span>
- MacBook Pro 14英寸 (Apple) - 相似度: 0.570
  价格: <span class="hljs-variable">$1999</span> | 描述: 搭载 M3 芯片的专业笔记本电脑，适合开发者和创意工作者
- Dell XPS 13 (Dell) - 相似度: 0.435
  价格: <span class="hljs-variable">$1299</span> | 描述: 轻薄笔记本电脑，13.3英寸 4K 触摸屏，Intel 处理器
- iPhone 15 Pro Max (Apple) - 相似度: 0.293
  价格: <span class="hljs-variable">$1199</span> | 描述: 最新的 iPhone，配备 A17 Pro 芯片，48MP 主摄像头，钛金属机身
</code></pre>
<h2 data-id="heading-5">缓存控制参数</h2>
<p>LiteLLM 提供了灵活的缓存控制机制，允许在请求级别动态控制缓存行为。这些控制参数借鉴了 HTTP 缓存控制的设计理念，提供了细粒度的缓存管理能力。</p>









































<table><thead><tr><th>参数</th><th>类型</th><th>说明</th><th>使用场景</th></tr></thead><tbody><tr><td><code>ttl</code></td><td>int</td><td>指定缓存时间（秒）</td><td>短期缓存、时效性内容</td></tr><tr><td><code>s-maxage</code></td><td>int</td><td>只接受指定时间内的缓存（秒）</td><td>强制刷新、数据一致性</td></tr><tr><td><code>no-cache</code></td><td>bool</td><td>跳过缓存读取，强制调用 API</td><td>需要最新数据</td></tr><tr><td><code>no-store</code></td><td>bool</td><td>不存储响应到缓存</td><td>敏感内容、一次性查询</td></tr><tr><td><code>namespace</code></td><td>str</td><td>自定义缓存命名空间</td><td>多租户、环境隔离</td></tr></tbody></table>
<h3 data-id="heading-6">动态 TTL 控制</h3>
<p>参数 <code>ttl</code> 用于控制缓存时间，我们可以为不同类型的请求设置不同的缓存时间：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 长期缓存：百科类知识</span>
response = client.chat.completions.create(
  model=<span class="hljs-string">"gpt-4o"</span>,
  messages=[{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"什么是量子计算？"</span>}],
  extra_body={
    <span class="hljs-string">"cache"</span>: {
      <span class="hljs-string">"ttl"</span>: <span class="hljs-number">86400</span>  <span class="hljs-comment"># 缓存 24 小时</span>
    }
  }
)

<span class="hljs-comment"># 短期缓存：实时性要求较高的内容</span>
response = client.chat.completions.create(
  model=<span class="hljs-string">"gpt-4o"</span>,
  messages=[{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"今天的股市表现如何？"</span>}],
  extra_body={
    <span class="hljs-string">"cache"</span>: {
      <span class="hljs-string">"ttl"</span>: <span class="hljs-number">300</span>  <span class="hljs-comment"># 缓存 5 分钟</span>
    }
  }
)
</code></pre>
<h3 data-id="heading-7">缓存年龄控制</h3>
<p>参数 <code>s-maxage</code> 控制只接受指定年龄内的缓存：</p>
<pre><code class="hljs language-python" lang="python">response = client.chat.completions.create(
  model=<span class="hljs-string">"gpt-4o"</span>,
  messages=[{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"最新的股票价格"</span>}],
  extra_body={
    <span class="hljs-string">"cache"</span>: {
      <span class="hljs-string">"s-maxage"</span>: <span class="hljs-number">60</span>  <span class="hljs-comment"># 只接受 1 分钟内的缓存</span>
    }
  }
)
</code></pre>
<h3 data-id="heading-8">强制刷新缓存</h3>
<p>当需要获取最新结果时，可以使用 <code>no-cache</code> 强制绕过缓存：</p>
<pre><code class="hljs language-python" lang="python">response = client.chat.completions.create(
  model=<span class="hljs-string">"gpt-4o"</span>,
  messages=[{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"最新的股票价格"</span>}],
  extra_body={
    <span class="hljs-string">"cache"</span>: {
      <span class="hljs-string">"no-cache"</span>: <span class="hljs-literal">True</span>  <span class="hljs-comment"># 跳过缓存检查</span>
    }
  }
)
</code></pre>
<h3 data-id="heading-9">禁用缓存存储</h3>
<p>对于包含敏感信息的查询，可以使用 <code>no-store</code> 不缓存当前响应：</p>
<pre><code class="hljs language-python" lang="python">response = client.chat.completions.create(
  model=<span class="hljs-string">"gpt-4o"</span>,
  messages=[{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"敏感信息查询"</span>}],
  extra_body={
    <span class="hljs-string">"cache"</span>: {
      <span class="hljs-string">"no-store"</span>: <span class="hljs-literal">True</span>  <span class="hljs-comment"># 不存储此响应</span>
    }
  }
)
</code></pre>
<h3 data-id="heading-10">命名空间隔离</h3>
<p>在多租户或多环境场景中，LiteLLM 支持命名空间来实现缓存隔离：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">litellm_settings:</span>
  <span class="hljs-attr">cache:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">cache_params:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">redis</span>
    <span class="hljs-attr">namespace:</span> <span class="hljs-string">"litellm.production"</span>  <span class="hljs-comment"># 命名空间前缀</span>
</code></pre>
<p>这样存储在 Redis 中的键将变成 <code>{namespace}:&lt;hash&gt;</code> 格式，我们也可以在请求参数中动态控制，为不同的用户或应用使用独立的缓存空间：</p>
<pre><code class="hljs language-python" lang="python">response = client.chat.completions.create(
  model=<span class="hljs-string">"gpt-4o"</span>,
  messages=[{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Hello"</span>}],
  extra_body={
    <span class="hljs-string">"cache"</span>: {
      <span class="hljs-string">"namespace"</span>: <span class="hljs-string">"user:12345"</span>  <span class="hljs-comment"># 用户专用命名空间</span>
    }
  }
)
</code></pre>
<h3 data-id="heading-11">默认关闭模式</h3>
<p>对于需要严格控制的场景，可以将缓存设置为默认关闭，只在需要时显式启用：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">litellm_settings:</span>
  <span class="hljs-attr">cache:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">cache_params:</span>
    <span class="hljs-attr">mode:</span> <span class="hljs-string">default_off</span>  <span class="hljs-comment"># 缓存默认关闭</span>
</code></pre>
<p>客户端需要显式启用缓存：</p>
<pre><code class="hljs language-python" lang="python">response = client.chat.completions.create(
  model=<span class="hljs-string">"gpt-4o"</span>,
  messages=[{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"Hello"</span>}],
  extra_body={
    <span class="hljs-string">"cache"</span>: {<span class="hljs-string">"use-cache"</span>: <span class="hljs-literal">True</span>}  <span class="hljs-comment"># 显式启用缓存</span>
  }
)
</code></pre>
<h2 data-id="heading-12">小结</h2>
<p>我们今天简单学习了 LiteLLM 的缓存系统。LiteLLM 提供了从简单的内存缓存到复杂的语义缓存等多种选择，每种缓存都有其特定的适用场景，可以根据业务需求灵活选择最合适的缓存策略。此外，LiteLLM 的缓存控制参数提供了细粒度的缓存管理能力，使开发者能够动态调整缓存行为，以适应不同场景的需求。</p>
<p>通过合理配置和使用这些缓存功能，应用可以更好地处理重复性和相似性的查询，有效降低对上游 LLM API 的压力，提升系统的稳定性与响应速度。</p>
<h2 data-id="heading-13">欢迎关注</h2>
<p>如果这篇文章对您有所帮助，欢迎关注我的同名公众号：<a href="https://link.juejin.cn?target=https%3A%2F%2Fi-study-everyday.online%2Fabout-me.html" target="_blank" title="https://i-study-everyday.online/about-me.html" ref="nofollow noopener noreferrer">日习一技，每天学一点新技术</a>。</p>
<p>我会每天花一个小时，记录下我学习的点点滴滴。内容包括但不限于：</p>
<ul>
<li>某个产品的使用小窍门</li>
<li>开源项目的实践和心得</li>
<li>技术点的简单解读</li>
</ul>
<p>目标是让大家用5分钟读完就能有所收获，不需要太费劲，但却可以轻松获取一些干货。不管你是技术新手还是老鸟，欢迎给我提建议，如果有想学习的技术，也欢迎交流！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Angular开发者必看：深度解析单元测试核心技巧与最佳实践]]></title>    <link>https://juejin.cn/post/7576859594360471552</link>    <guid>https://juejin.cn/post/7576859594360471552</guid>    <pubDate>2025-11-27T01:21:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576859594360471552" data-draft-id="7570243451725725723" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Angular开发者必看：深度解析单元测试核心技巧与最佳实践"/> <meta itemprop="keywords" content="Angular.js,前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-27T01:21:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="DevUI团队"/> <meta itemprop="url" content="https://juejin.cn/user/712139267650141"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Angular开发者必看：深度解析单元测试核心技巧与最佳实践
            <!----> <!----></h1> <div class="container team-follow" data-v-d326b38e="" data-v-61fb5e44=""><div class="left" data-v-d326b38e=""><a href="/team/6930890095402844163/posts" data-v-d326b38e=""><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6975547f58f744ae8fa9c79ba0a60c3b~tplv-k3u1fbpfcp-watermark.image" class="icon" data-v-d326b38e=""/></a> <div class="content" data-v-d326b38e=""><div style="display: flex" data-v-d326b38e=""><a href="/team/6930890095402844163/posts" data-v-d326b38e=""><p class="title-line" data-v-d326b38e=""><span title="DevUI团队" class="title" data-v-d326b38e="">DevUI团队</span> <img src="//lf-web-assets.juejin.cn/obj/juejin-web/xitu_juejin_web/255e400027b783cbad76dc41527e7695.svg" alt="team icon" class="team-icon" data-v-d326b38e=""/></p></a></div> <div class="meta-box team" data-v-d326b38e="" data-v-61fb5e44=""><time datetime="2025-11-27T01:21:00.000Z" title="Thu Nov 27 2025 01:21:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-d326b38e="" data-v-61fb5e44="">
                2025-11-27
              </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-d326b38e="" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/></svg> <span class="views-count" style="display:none;" data-v-d326b38e="" data-v-61fb5e44="">
                7
              </span> <span class="read-time" data-v-d326b38e="" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-d326b38e="" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-d326b38e="" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-d326b38e="" data-v-61fb5e44=""/></svg>
                阅读6分钟
              </span> <!----> <!----></div></div></div> <button class="jj-follow-button follow-btn" style="display:none;" data-v-b60b2868="" data-v-d326b38e=""><span data-v-b60b2868="" data-v-d326b38e=""><i class="byte-icon byte-icon--plus" data-v-d326b38e=""><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 48 48"><path fill="none" d="M0 0h48v48H0z"/><path d="M24.7 4c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8V22h16.7c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8v1.4c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1H26v16.7c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1h-1.4c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8V26H5.3c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8v-1.4c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1H22V5.3c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1h1.4z"/></svg></i>
        关注
      </span></button></div> <div class="team-user block-hidden" data-v-61fb5e44=""><div class="avatar jj-avatar avatar" data-v-03256cc6="" data-v-61fb5e44=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="avatar" class="lazy avatar-img" data-v-5244ef91="" data-v-03256cc6=""/> </div> <!----> <span class="position ellipsis" data-v-61fb5e44="">
              前端解决方案集 @华为
            </span></div> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>感谢DevUI社区贡献者 <strong><a href="https://juejin.cn/user/649151231836217" target="_blank" title="https://juejin.cn/user/649151231836217">tian_ya</a></strong> 提供的优质好文！</p>
</blockquote>
<h2 data-id="heading-0">Angular开发者必看：深度解析单元测试核心技巧与最佳实践</h2>
<h3 data-id="heading-1">一、前言</h3>
<p><strong>1. 什么是单元测试</strong></p>
<ul>
<li>定义：单元测试是针对软件中的最小可测试单元（如函数、方法或类）进行的测试，以验证其是否符合预期。</li>
<li>目标：确保代码的正确性、可靠性和可维护性。</li>
<li>不同测试阶段的区别：
<ul>
<li>单元测试：测试代码的最小单元。</li>
<li>集成测试：测试不同模块之间的交互。</li>
<li>系统测试：整体系统是否满足需求。</li>
<li>验收测试：从用户角度测试功能是否符合需求。</li>
</ul>
</li>
</ul>
<p><strong>2. 为什么需要单元测试</strong></p>
<ul>
<li>提升代码质量：通过自动化测试发现潜在的bug。</li>
<li>支持重构安全：确保代码行为在重构后保持一致。</li>
</ul>
<h3 data-id="heading-2">二、Angular的单元测试</h3>
<p><strong>1. 配置 Karma + Jasmine测试环境</strong></p>
<p>使用 Angular CLI 创建项目时，默认已集成 Jasmine 和 Karma。</p>
<ul>
<li>Karma：为前端自动化测试提供了跨浏览器测试的能力，集成像<code>Jasmine</code>等测试框架，启动一个Web服务器将测试脚本放到浏览器中执行。还有一些其他比如生成代码覆盖率的报告等功能。</li>
<li>Jasmine：一个 JavaScript 测试框架，它不依赖于浏览器、dom 或其它 JavaScript 框架。</li>
</ul>
<p>配置文件：</p>
<ul>
<li><code>karma.conf.js</code>：Karma 配置文件，控制浏览器启动、测试报告生成等；</li>
<li><code>test.ts</code>：入口文件，用于加载所有测试文件；</li>
<li><code>tsconfig.spec.json</code>：编译测试文件所需的 TypeScript 配置。</li>
</ul>
<p><strong>2. 编写单元测试用例</strong></p>
<p>创建一个<code>.spec.ts</code>后缀的测试文件，写一个简单的测试用例，如下：</p>
<p>demo.spec.ts</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">describe</span>(<span class="hljs-string">'Demo UT'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">'1+1=2'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">expect</span>(<span class="hljs-number">1</span> + <span class="hljs-number">1</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">2</span>);
  });
});
</code></pre>
<p>推荐使用AI自动生成基础测试用例，减少重复劳动，提高效率。</p>
<p>提示词</p>
<pre><code class="hljs language-md" lang="md">为文件：src\app\demo.ts 生成UT用例。

命名方式：
<span class="hljs-bullet">-</span> 测试套命名：[文件名]；
<span class="hljs-bullet">-</span> 内层测试套命名：[方法名]；
<span class="hljs-bullet">-</span> 用例命名：场景[序号]：[场景名]

测试文件保存路径：当前文件路径下
</code></pre>
<p><strong>3. 运行测试</strong></p>
<p>运行下面命令，默认会打开浏览器并实时运行所有测试：</p>
<pre><code class="hljs language-bash" lang="bash">ng <span class="hljs-built_in">test</span>
</code></pre>
<p>也可指定参数运行单个单元测试文件，适用于调试特定组件或服务。</p>
<pre><code class="hljs language-bash" lang="bash">ng <span class="hljs-built_in">test</span> --include src/app/demo.spec.ts
</code></pre>
<p>浏览器页面上会显示所有用例的执行结果。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02428f77cdf84d0e90859846013b823c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGV2VUnlm6LpmJ8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764811834&amp;x-signature=Us5wRSRYRcMF7tO5gvlftmfA6Q0%3D" alt="test-result.png" loading="lazy"/></p>
<h3 data-id="heading-3">三、Jasmine 框架入门</h3>
<p><strong>1. 核心概念</strong></p>





























<table><thead><tr><th>概念</th><th>描述</th></tr></thead><tbody><tr><td>describe()</td><td>定义一组相关的测试用例（测试套件）</td></tr><tr><td>it()</td><td>定义单个测试用例（规格）</td></tr><tr><td>beforeEach() / afterEach()</td><td>每次执行测试前后运行的初始化/清理代码</td></tr><tr><td>beforeAll() / afterAll()</td><td>整个测试套件开始前/结束后运行一次</td></tr><tr><td>expect()</td><td>断言表达式，判断实际值与期望值是否一致</td></tr></tbody></table>
<p>常用断言方法如下：</p>
<p><strong>值相等性断言</strong></p>
<ul>
<li><code>toBe(expected)</code>：判断两个值是否严格相等（<code>===</code>）。</li>
<li><code>toEqual(expected)</code>：判断两个对象或值是否相等。</li>
<li><code>not</code>：与其他匹配器使用，表示不符合该条件。</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">expect</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-number">1</span>); <span class="hljs-comment">// success</span>

<span class="hljs-title function_">expect</span>({ <span class="hljs-attr">a</span>: <span class="hljs-number">1</span> }).<span class="hljs-property">not</span>.<span class="hljs-title function_">toBe</span>({ <span class="hljs-attr">a</span>: <span class="hljs-number">1</span> }); <span class="hljs-comment">// success</span>
<span class="hljs-title function_">expect</span>({ <span class="hljs-attr">a</span>: <span class="hljs-number">1</span> }).<span class="hljs-title function_">toEqual</span>({ <span class="hljs-attr">a</span>: <span class="hljs-number">1</span> }); <span class="hljs-comment">// success</span>

<span class="hljs-title function_">expect</span>(<span class="hljs-number">0</span>).<span class="hljs-property">not</span>.<span class="hljs-title function_">toBe</span>(<span class="hljs-literal">null</span>); <span class="hljs-comment">// success</span>
</code></pre>
<p><strong>真假值和定义性断言</strong></p>
<ul>
<li><code>toBeDefined()</code>:断言值已定义。</li>
<li><code>toBeUndefined()</code>:断言值未定义。</li>
<li><code>toBeNull()</code>:断言值为 null。</li>
<li><code>toBeTruthy()</code>:断言值为真值。</li>
<li><code>toBeFalsy()</code>:断言值为假值。</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">expect</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">toBeDefined</span>(); <span class="hljs-comment">// success</span>

<span class="hljs-title function_">expect</span>(<span class="hljs-literal">undefined</span>).<span class="hljs-title function_">toBeUndefined</span>(); <span class="hljs-comment">// success</span>

<span class="hljs-title function_">expect</span>(<span class="hljs-literal">null</span>).<span class="hljs-title function_">toBeNull</span>(); <span class="hljs-comment">// success</span>

<span class="hljs-title function_">expect</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">toBeTruthy</span>(); <span class="hljs-comment">// success</span>
<span class="hljs-title function_">expect</span>(<span class="hljs-literal">true</span>).<span class="hljs-title function_">toBeTruthy</span>(); <span class="hljs-comment">// success</span>
<span class="hljs-title function_">expect</span>({}).<span class="hljs-title function_">toBeTruthy</span>(); <span class="hljs-comment">// success</span>

<span class="hljs-title function_">expect</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_">toBeFalsy</span>(); <span class="hljs-comment">// success</span>
<span class="hljs-title function_">expect</span>(<span class="hljs-string">''</span>).<span class="hljs-title function_">toBeFalsy</span>(); <span class="hljs-comment">// success</span>
<span class="hljs-title function_">expect</span>(<span class="hljs-literal">false</span>).<span class="hljs-title function_">toBeFalsy</span>(); <span class="hljs-comment">// success</span>
<span class="hljs-title function_">expect</span>(<span class="hljs-title class_">NaN</span>).<span class="hljs-title function_">toBeFalsy</span>(); <span class="hljs-comment">// success</span>
</code></pre>
<p><strong>数值范围断言</strong></p>
<ul>
<li><code>toBeLessThan(number)</code>: 断言值小于指定的数字。</li>
<li><code>toBeGreaterThan(number)</code>: 断言值大于指定的数字。</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">expect</span>(<span class="hljs-number">5</span>).<span class="hljs-title function_">toBeLessThan</span>(<span class="hljs-number">10</span>); <span class="hljs-comment">// success</span>

<span class="hljs-title function_">expect</span>(<span class="hljs-number">10</span>).<span class="hljs-title function_">toBeGreaterThan</span>(<span class="hljs-number">5</span>); <span class="hljs-comment">// success</span>
</code></pre>
<p><strong>其他常用断言</strong></p>
<ul>
<li><code>toContain(item)</code>: 断言数组或字符串中包含某个元素或子串。</li>
<li><code>toBeCloseTo(number, precision)</code>: 断言在指定的精度范围内相似。</li>
<li><code>toMatch(RegExp)</code>: 断言符合正则表达式。</li>
<li><code>toThrow()</code>: 断言函数执行时抛出错误。</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">expect</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]).<span class="hljs-title function_">toContain</span>(<span class="hljs-number">2</span>); <span class="hljs-comment">// success</span>

<span class="hljs-title function_">expect</span>(<span class="hljs-number">1.24</span>).<span class="hljs-title function_">toBeCloseTo</span>(<span class="hljs-number">1</span>, <span class="hljs-number">0.24</span>); <span class="hljs-comment">//success</span>

<span class="hljs-title function_">expect</span>(<span class="hljs-string">'123'</span>).<span class="hljs-title function_">toMatch</span>(<span class="hljs-regexp">/\d+/</span>); <span class="hljs-comment">// success</span>

<span class="hljs-title function_">expect</span>(<span class="hljs-function">() =&gt;</span> { <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(); }).<span class="hljs-title function_">toThrow</span>(); <span class="hljs-comment">// success</span>
</code></pre>
<p><strong>2. Mock 与 Spy</strong></p>
<ul>
<li><strong>Mock</strong>：创建模拟对象，代替实际依赖。</li>
</ul>
<p>使用<code>jasmine.createSpy()</code>创建模拟函数，示例：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> mockService = jasmine.<span class="hljs-title function_">createSpyObj</span>(<span class="hljs-string">'Service'</span>, [<span class="hljs-string">'methodName'</span>]);
</code></pre>
<ul>
<li><strong>Spy</strong>：监视方法调用，记录调用次数、参数等。</li>
</ul>
<p>使用 <code>spyOn()</code> 方法来创建一个Spy对象，该对象会监控指定的方法。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> myObject = {
  <span class="hljs-attr">myMethod</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">arg</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">'real return'</span>;
  }
};
<span class="hljs-title function_">spyOn</span>(myObject, <span class="hljs-string">'myMethod'</span>);
</code></pre>
<p>模拟方法行为：</p>
<ul>
<li><code>and.returnValue()</code>: 让Spy在被调用时返回一个预设的值。</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">spyOn</span>(myObject, <span class="hljs-string">'myMethod'</span>).<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(<span class="hljs-string">'fake return'</span>);
</code></pre>
<ul>
<li><code>and.callFake()</code>: 提供一个模拟函数，该函数将代替原始函数执行。</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">spyOn</span>(myObject, <span class="hljs-string">'myMethod'</span>).<span class="hljs-property">and</span>.<span class="hljs-title function_">callFake</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">arg</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">'mocked: '</span> + arg;
});
</code></pre>
<ul>
<li><code>and.throwError()</code>: 模拟抛出一个异常。</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">spyOn</span>(myObject, <span class="hljs-string">'myMethod'</span>).<span class="hljs-property">and</span>.<span class="hljs-title function_">throwError</span>(<span class="hljs-string">'Something went wrong'</span>);
</code></pre>
<p>验证调用：在测试中调用被Spy的函数后，可以使用Spy对象的方法来验证它的行为，例如：</p>





















<table><thead><tr><th>方法</th><th>描述</th></tr></thead><tbody><tr><td>toHaveBeenCalled()</td><td>检查函数是否被调用过</td></tr><tr><td>toHaveBeenCalledTimes(number)</td><td>检查函数被调用的次数</td></tr><tr><td>toHaveBeenCalledWith(arg1, arg2, ...)</td><td>检查函数是否用特定的参数被调用过</td></tr></tbody></table>
<ul>
<li><strong>依赖注入</strong>：利用Angular 的TestBed 来创建一个隔离的测试环境，并提供模拟的依赖项。
<ul>
<li><code>TestBed.configureTestingModule</code>: 配置测试模块</li>
<li><code>TestBed.inject</code>：获取和测试需要注入的服务。</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">TestBed</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core/testing'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MyComponent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./my.component'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MyService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./my.service'</span>; <span class="hljs-comment">// 你的服务</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MockMyService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./mock-my.service'</span>; <span class="hljs-comment">// Mock服务</span>

<span class="hljs-title function_">describe</span>(<span class="hljs-string">'MyComponent'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">component</span>: <span class="hljs-title class_">MyComponent</span>;
  <span class="hljs-keyword">let</span> <span class="hljs-attr">service</span>: <span class="hljs-title class_">MyService</span>; <span class="hljs-comment">// 实际服务类型</span>

  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">configureTestingModule</span>({
      <span class="hljs-attr">declarations</span>: [<span class="hljs-title class_">MyComponent</span>],
      <span class="hljs-attr">providers</span>: [
        <span class="hljs-comment">// 提供 Mock 服务</span>
        { <span class="hljs-attr">provide</span>: <span class="hljs-title class_">MyService</span>, <span class="hljs-attr">useClass</span>: <span class="hljs-title class_">MockMyService</span> }
      ]
    }).<span class="hljs-title function_">compileComponents</span>();

    service = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">inject</span>(<span class="hljs-title class_">MyService</span>); <span class="hljs-comment">// 使用 TestBed.inject 获取 Mock 服务</span>
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should create'</span>, <span class="hljs-function">() =&gt;</span> {
    component = <span class="hljs-title class_">TestBed</span>.<span class="hljs-title function_">createComponent</span>(<span class="hljs-title class_">MyComponent</span>).<span class="hljs-property">componentInstance</span>;
    <span class="hljs-title function_">expect</span>(component).<span class="hljs-title function_">toBeTruthy</span>();
  });

  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should call service method'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 假设 MockMyService 有一个 getData 方法</span>
    <span class="hljs-title function_">spyOn</span>(service, <span class="hljs-string">'getData'</span>).<span class="hljs-property">and</span>.<span class="hljs-title function_">returnValue</span>(<span class="hljs-string">'mock data'</span>);

    component.<span class="hljs-title function_">ngOnInit</span>(); <span class="hljs-comment">// 触发依赖注入的服务方法</span>

    <span class="hljs-title function_">expect</span>(service.<span class="hljs-property">getData</span>).<span class="hljs-title function_">toHaveBeenCalled</span>(); <span class="hljs-comment">// 验证服务方法是否被调用</span>
    <span class="hljs-title function_">expect</span>(component.<span class="hljs-property">data</span>).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'mock data'</span>); <span class="hljs-comment">// 验证组件是否正确使用了服务返回的数据</span>
  });
});
</code></pre>
<p><strong>3. 异步测试处理</strong></p>
<ul>
<li>使用 <code>done()</code> 回调</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Promise</span>
<span class="hljs-title function_">it</span>(<span class="hljs-string">'应异步获取数据'</span>, <span class="hljs-function">(<span class="hljs-params">done: DoneFn</span>) =&gt;</span> {
  <span class="hljs-title function_">fetchData</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
    <span class="hljs-title function_">expect</span>(data).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'expected result'</span>);
    <span class="hljs-title function_">done</span>();
  });
});

<span class="hljs-comment">// Observable</span>
<span class="hljs-title function_">it</span>(<span class="hljs-string">'应使用Observable获取数据'</span>, <span class="hljs-function">(<span class="hljs-params">done: DoneFn</span>) =&gt;</span> {
  <span class="hljs-title function_">queryData</span>().<span class="hljs-title function_">subscribe</span>({
    <span class="hljs-attr">next</span>: <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
      <span class="hljs-title function_">expect</span>(data).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'expected result'</span>);
    },
    <span class="hljs-attr">complete</span>: <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">done</span>();
    },
  });
});
</code></pre>
<ul>
<li>使用 async/await 处理Promise</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-title function_">it</span>(<span class="hljs-string">'应该使用 async/await 获取数'</span>, <span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchData</span>();
  <span class="hljs-title function_">expect</span>(data).<span class="hljs-title function_">toEqual</span>(<span class="hljs-string">'expected result'</span>);
});
</code></pre>
<h3 data-id="heading-4">四、测试覆盖率</h3>
<p><strong>1. 测试覆盖率的概念</strong></p>
<p>测试覆盖率是指测试用例执行过程中访问到的源代码行数占总代码的比例，用来衡量测试用例覆盖代码的程度。</p>
<p>高覆盖率确保代码的关键部分被充分测试，有助于发现潜在缺陷。</p>
<p><strong>2. 配置覆盖率插件</strong></p>
<ul>
<li>安装插件：</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">npm install karma-coverage --save-dev
</code></pre>
<ul>
<li>修改配置文件<code>karma.conf.js</code>，添加以下配置：</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">config</span>) {
  config.<span class="hljs-title function_">set</span>({
    <span class="hljs-attr">plugins</span>: [
      <span class="hljs-built_in">require</span>(<span class="hljs-string">'karma-coverage'</span>)
    ],
    <span class="hljs-attr">reporters</span>: [<span class="hljs-string">'progress'</span>, <span class="hljs-string">'coverage'</span>],
    <span class="hljs-attr">coverageReporter</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-string">'html'</span>,
      <span class="hljs-attr">dir</span>: <span class="hljs-string">'coverage/'</span>
    }
  });
};
</code></pre>
<p><strong>3. 解读覆盖率报告</strong></p>
<ul>
<li>生成报告：运行命令</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">ng <span class="hljs-built_in">test</span> --code-coverage
</code></pre>
<p>如果希望每次运行<code>ng test</code>都同步刷新覆盖率，可以修改<code>angular.json</code>中的<code>architect.test.options</code>添加配置：<code>"codeCoverage": true</code></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"options"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"main"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"src/test.ts"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"polyfills"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"zone.js"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"zone.js/testing"</span>
  <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"tsConfig"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tsconfig.spec.json"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"karmaConfig"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"karma.conf.js"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"codeCoverage"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  ...
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li>查看报告：在<code>coverage</code>目录下打开<code>index.html</code>，分析哪些代码未被覆盖。
<ul>
<li>行覆盖率（Lines）</li>
<li>分支覆盖率（Branches）</li>
<li>函数覆盖率（Functions）</li>
<li>语句覆盖率（Statements）</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26f728b1780943cabb4d49582063aa5f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRGV2VUnlm6LpmJ8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764811834&amp;x-signature=iAfIEn0hwZ%2BWKekz3dzawjQimgg%3D" alt="coverage.png" loading="lazy"/></p>
<h3 data-id="heading-5">加入我们</h3>
<blockquote>
<p>DevUI团队重磅推出~<strong>前端智能化场景解决方案MateChat</strong>，为项目添加智能化助手~</p>
<p>源码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FDevCloudFE%2FMateChat%2Foverview" target="_blank" title="https://gitcode.com/DevCloudFE/MateChat/overview" ref="nofollow noopener noreferrer">gitcode.com/DevCloudFE/…</a>（欢迎star~）</p>
<p>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmatechat.gitcode.com" target="_blank" title="https://matechat.gitcode.com" ref="nofollow noopener noreferrer">matechat.gitcode.com</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TinyEngine 低代码实时协作揭秘：原理 +实操，看完直接用！]]></title>    <link>https://juejin.cn/post/7577229187896573987</link>    <guid>https://juejin.cn/post/7577229187896573987</guid>    <pubDate>2025-11-27T12:04:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577229187896573987" data-draft-id="7577226553286524963" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TinyEngine 低代码实时协作揭秘：原理 +实操，看完直接用！"/> <meta itemprop="keywords" content="前端,Vue.js,低代码"/> <meta itemprop="datePublished" content="2025-11-27T12:04:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OpenTiny社区"/> <meta itemprop="url" content="https://juejin.cn/user/3808325101432983"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TinyEngine 低代码实时协作揭秘：原理 +实操，看完直接用！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808325101432983/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OpenTiny社区
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T12:04:39.000Z" title="Thu Nov 27 2025 12:04:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文由周天意同学原创。</p>
<p>一般的多人协作业务需求一般是针对文档，表格或者是制图之类的，场景比较简单，协同操作的对象为文字或者图片，对象比较单一。
乍一看低代码的多人协作看似无从下手，因为低代码不仅涉及到页面 canvas 中一些文字属性的同步，还涉及到<strong>组件拖拽，样式，绑定事件，高级属性，甚至是代码协同编辑</strong>的编辑与同步。那我们是如何在低代码这个场景下实现多人协同编辑的呢。</p>
<h2 data-id="heading-0">TinyEngine低代码引擎多人协同技术详解</h2>
<h3 data-id="heading-1">CRDT</h3>
<p>我们首先来介绍一下实现低代码编辑的协同编辑的底层逻辑 —— CRDT（Conflict-free Replicated Data Type，无冲突复制数据类型）是一种<strong>允许并发修改、自动合并且永不冲突的数据结构</strong>。
即使多个用户同时编辑同一份文档、表格或图形，系统也能在之后自动合并出一致的结果，<strong>不需要“锁”或“人工解决冲突”</strong>。</p>
<h4 data-id="heading-2">一个例子</h4>
<p>假设你有一个协作文本编辑器有两个用户：
A	插入“Hello ”
B	插入“World!”</p>
<p>在普通系统中，如果两个操作几乎同时发生，可能导致冲突（比如：谁的改动算数？）。但在 CRDT 模型下，每个操作都是可合并的：系统会基于操作的逻辑时间或唯一标识符自动确定合并顺序；最终所有节点都会收敛到相同的状态，比如 "Hello World!"。</p>
<h4 data-id="heading-3">CRDT 的两种主要类型</h4>
<ol>
<li>
<p>State-based（状态型 CRDT）
每个节点维护完整的状态副本，并定期将状态合并：
local_state = merge(local_state, remote_state)</p>
</li>
<li>
<p>Operation-based（操作型 CRDT）
每个节点只传播“操作”，比如“加1”“插入字符X”，
其他节点按相同逻辑执行该操作。</p>
</li>
</ol>
<p>在我们的项目中，我们采用的是 <strong>操作型 CRDT（Operation-based CRDT）库 Yjs</strong>。
在 Yjs 中，每个协同文档对应一个<strong>根对象 Y.Doc</strong>，它可以包含多种可协同的数据结构，例如 <strong>Y.Array、Y.Map、Y.Text</strong> 等。<strong>每个客户端都维护一份本地的 Y.Doc 副本</strong>，这些副本通过 Yjs 的同步机制保持一致。
当多个客户端通过 y-websocket provider 连接到同一个房间（room）时，它们会共享相同的文档数据。<strong>任何客户端对文档的修改（如插入、删除、更新）都会被编码为操作（operation）</strong>，并广播到其他客户端，从而实现实时的数据同步。</p>
<h3 data-id="heading-4">从数据结构到协同模型：tiny-engine 的页面 Schema 与 Yjs 的结合</h3>
<p>通过前面的讨论我们可以发现，无论是哪一种类型的 <strong>CRDT（Conflict-free Replicated Data Type）</strong>，其核心都离不开一个<strong>健全且完备的数据结构</strong>。
对于我们的 <strong>tiny-engine</strong> 来说，低代码页面本身也是由一套结构化的数据所描述的。
这套数据结构不仅要支持页面的层级关系（如区块、组件、插槽），还要能够表达页面的动态逻辑（如循环、条件、生命周期、数据源等）。</p>
<p>在 tiny-engine 中，页面的基础结构可以抽象为以下两个 TypeScript 接口：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 节点类型</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Node</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">componentName</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">props</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt; &amp; { columns?: { slots?: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt; }[] }
  children?: <span class="hljs-title class_">Node</span>[]
  componentType?: <span class="hljs-string">'Block'</span> | <span class="hljs-string">'PageStart'</span> | <span class="hljs-string">'PageSection'</span>
  slot?: <span class="hljs-built_in">string</span> | <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;
  params?: <span class="hljs-built_in">string</span>[]
  loop?: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;
  loopArgs?: <span class="hljs-built_in">string</span>[]
  condition?: <span class="hljs-built_in">boolean</span> | <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;
}
  
<span class="hljs-comment">// 根节点类型，即页面 Schema</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">RootNode</span> = <span class="hljs-title class_">Omit</span>&lt;<span class="hljs-title class_">Node</span>, <span class="hljs-string">'id'</span>&gt; &amp; {
  id?: <span class="hljs-built_in">string</span>
  css?: <span class="hljs-built_in">string</span>
  fileName?: <span class="hljs-built_in">string</span>
  methods?: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;
  state?: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;
  lifeCycles?: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt;
  dataSource?: <span class="hljs-built_in">any</span>
  bridge?: <span class="hljs-built_in">any</span>
  inputs?: <span class="hljs-built_in">any</span>[]
  outputs?: <span class="hljs-built_in">any</span>[]
  schema?: <span class="hljs-built_in">any</span>
}
</code></pre>
<p>我们可以把它理解为：</p>
<ul>
<li><strong>Node</strong> 代表页面中的一个通用组件节点；</li>
<li><strong>RootNode</strong> 则是整个页面的根节点（Schema），在 Node 的基础上扩展了页面级的属性，如 <code>state</code>、<code>methods</code>、<code>lifeCycles</code> 等。</li>
</ul>
<h3 data-id="heading-5">从数据结构到协同对象</h3>
<p>在使用 <strong>CRDT（这里是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fyjs.dev%2F" target="_blank" title="https://yjs.dev/" ref="nofollow noopener noreferrer">Yjs</a>）</strong> 进行实时协作时，我们的“协作单元”就是上述的这类数据结构。换句话说，Yjs 需要在内部维护一份与 <code>RootNode</code> 对应的共享状态副本。</p>
<p>然而，Yjs 并不能直接理解复杂的 TypeScript 对象结构，我们需要将其<strong>转化为 Yjs 能够识别和同步的类型系统</strong>。
例如：</p>
<ul>
<li>普通对象 → <code>Y.Map</code></li>
<li>数组 → <code>Y.Array</code></li>
<li>字符串、数字、布尔值 → <code>Y.Text</code> / 基本类型</li>
<li>嵌套结构（如 children）则需要递归地转化为嵌套的 Y 类型。</li>
</ul>
<p>因此，我们的第一步工作是：</p>
<blockquote>
<p>根据已有的 <code>Node</code> 和 <code>RootNode</code> 数据结构，将其映射为等价的 Yjs 类型（如 Y.Map、Y.Array 等）。</p>
</blockquote>
<p>这一过程可以抽象为一个通用的 “schema → YDoc” 转换函数。项目中：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">UNDEFINED_PLACEHOLDER</span> = <span class="hljs-string">'__undefined__'</span>
  
<span class="hljs-comment">/**
 * 将普通对象/数组递归转换成 Yjs 对象
 * <span class="hljs-doctag">@param</span> target Y.Map 或 Y.Array
 * <span class="hljs-doctag">@param</span> obj 要转换的对象
 */</span>
<span class="hljs-comment">// toYjs 函数优化后的版本</span>
  
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">toYjs</span>(<span class="hljs-params">target: Y.<span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">any</span>&gt; | Y.<span class="hljs-built_in">Array</span>&lt;<span class="hljs-built_in">any</span>&gt;, obj: <span class="hljs-built_in">any</span></span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(obj)) {
    <span class="hljs-keyword">if</span> (!(target <span class="hljs-keyword">instanceof</span> Y.<span class="hljs-property">Array</span>)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Expected Y.Array as target for array input'</span>)
    }
    obj.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (item === <span class="hljs-literal">undefined</span>) {
        target.<span class="hljs-title function_">push</span>([<span class="hljs-variable constant_">UNDEFINED_PLACEHOLDER</span>])
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (item === <span class="hljs-literal">null</span>) {
        target.<span class="hljs-title function_">push</span>([<span class="hljs-literal">null</span>])
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(item)) {
        <span class="hljs-keyword">const</span> childArr = <span class="hljs-keyword">new</span> Y.<span class="hljs-title class_">Array</span>()
        <span class="hljs-title function_">toYjs</span>(childArr, item)
        target.<span class="hljs-title function_">push</span>([childArr])
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> item === <span class="hljs-string">'object'</span> &amp;&amp; item !== <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 明确排除 null</span>
        <span class="hljs-keyword">const</span> childMap = <span class="hljs-keyword">new</span> Y.<span class="hljs-title class_">Map</span>()
        <span class="hljs-title function_">toYjs</span>(childMap, item)
        target.<span class="hljs-title function_">push</span>([childMap])
      } <span class="hljs-keyword">else</span> {
        target.<span class="hljs-title function_">push</span>([item])
      }
    })
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> obj === <span class="hljs-string">'object'</span> &amp;&amp; obj !== <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">if</span> (!(target <span class="hljs-keyword">instanceof</span> Y.<span class="hljs-property">Map</span>)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Expected Y.Map as target for object input'</span>)
    }
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(obj).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, val]</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (val === <span class="hljs-literal">undefined</span>) {
        target.<span class="hljs-title function_">set</span>(key, <span class="hljs-variable constant_">UNDEFINED_PLACEHOLDER</span>)
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (val === <span class="hljs-literal">null</span>) {
        target.<span class="hljs-title function_">set</span>(key, <span class="hljs-literal">null</span>)
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(val)) {
        <span class="hljs-keyword">const</span> yArr = <span class="hljs-keyword">new</span> Y.<span class="hljs-title class_">Array</span>()
        target.<span class="hljs-title function_">set</span>(key, yArr)
        <span class="hljs-title function_">toYjs</span>(yArr, val)
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> val === <span class="hljs-string">'object'</span> &amp;&amp; val !== <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 明确排除 null</span>
        <span class="hljs-keyword">const</span> yMap = <span class="hljs-keyword">new</span> Y.<span class="hljs-title class_">Map</span>()
        target.<span class="hljs-title function_">set</span>(key, yMap)
        <span class="hljs-title function_">toYjs</span>(yMap, val)
      } <span class="hljs-keyword">else</span> {
        target.<span class="hljs-title function_">set</span>(key, val)
      }
    })
  }
  <span class="hljs-comment">// 注意：如果 obj 不是对象或数组（如 string, number），函数将静默地不做任何事。这是符合预期的。</span>
}
  
<span class="hljs-comment">// 将 Yjs Map 转回普通对象（递归）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fromYjs</span>(<span class="hljs-params">value: <span class="hljs-built_in">any</span></span>): <span class="hljs-built_in">any</span> {
  <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> Y.<span class="hljs-property">Map</span>) {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">obj</span>: <span class="hljs-built_in">any</span> = {}
    value.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">v, k</span>) =&gt;</span> {
      obj[k] = <span class="hljs-title function_">fromYjs</span>(v)
    })
    <span class="hljs-keyword">return</span> obj
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> Y.<span class="hljs-property">Array</span>) {
    <span class="hljs-keyword">return</span> value.<span class="hljs-title function_">toArray</span>().<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> <span class="hljs-title function_">fromYjs</span>(item))
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> Y.<span class="hljs-property">Text</span>) {
    <span class="hljs-keyword">return</span> value.<span class="hljs-title function_">toString</span>()
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (value === <span class="hljs-variable constant_">UNDEFINED_PLACEHOLDER</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span> <span class="hljs-comment">// 还原 undefined</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> value
  }
}
</code></pre>
<p>这样，当我们通过 Yjs 对这些 Y 类型进行修改（例如修改 props、插入/删除 children、更新 state），Yjs 就会自动维护 CRDT 冲突合并逻辑，并将变更同步到所有协作客户端。</p>
<h3 data-id="heading-6">监听机制实现 —— 从 Yjs 变更到多人协同视图更新</h3>
<p>前面的步骤成功让我们借助 <strong>Yjs</strong> 实现了数据层面的实时同步：
无论是哪位协作者修改了页面中的某个节点、属性或层级结构，这些变更都能被同步传播到所有客户端。</p>
<p>但是，仅仅让数据“同步”还不够。
在 <strong>tiny-engine</strong> 中，页面渲染与编辑的核心状态仍然依赖于本地的 <strong>Schema</strong>（即 <code>RootNode</code> 和 <code>Node</code> 的结构树）。
换句话说：</p>
<blockquote>
<p>Yjs 负责维护协作的共享状态，但页面的实际渲染与交互仍是基于本地内存中的 Schema。</p>
</blockquote>
<p>因此，我们必须建立一套监听机制，让 Yjs 的变更<strong>能够驱动 Schema 与视图的更新</strong>，形成如下的完整同步链路：</p>
<pre><code class="hljs">Yjs 数据变化 → 更新本地 Schema → 触发渲染引擎刷新视图
</code></pre>
<p>非常好 👍，你这里实际上引出了多人协同中最关键的一个设计点——<strong>“操作意图层”和“数据层”的解耦”</strong>。
你的思路已经非常正确：用事件总线处理结构性变更（如节点插入/删除），用 meta 元数据追踪属性变更。下面我帮你把这一节内容完整、系统地扩写成技术博客风格，同时保留你的原始语义与工程感。👇</p>
<h4 data-id="heading-7">实现思路：Yjs observe 机制</h4>
<p>Yjs 为我们提供了非常强大的变更监听机制：</p>
<ul>
<li><strong><code>observe</code></strong>：监听单个 <code>Y.Map</code> 或 <code>Y.Array</code> 的变更；</li>
<li><strong><code>observeDeep</code></strong>：递归监听整个文档中的所有嵌套结构（常用于复杂 Schema）。</li>
</ul>
<p>通过这些监听器，我们可以捕获到所有节点层面的增删改事件（包括 props、children 等），然后将这些变化<strong>同步回本地 Schema</strong>。</p>
<h4 data-id="heading-8">问题：结构性操作缺乏语义信息</h4>
<p>在理论上，<code>observe</code> 能告诉我们「有节点被插入」，但在实际业务逻辑中，这个信息远远不够。</p>
<p>以节点插入为例，tiny-engine 中的插入函数如下所示：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-title function_">insertAfter</span> = (<span class="hljs-params">{ parent, node, data }: InsertOptions</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!data.<span class="hljs-property">id</span>) {
    data.<span class="hljs-property">id</span> = utils.<span class="hljs-title function_">guid</span>()
  }
  
  <span class="hljs-title function_">useCanvas</span>().<span class="hljs-title function_">operateNode</span>({
    <span class="hljs-attr">type</span>: <span class="hljs-string">'insert'</span>,
    <span class="hljs-attr">parentId</span>: parent.<span class="hljs-property">id</span> || <span class="hljs-string">''</span>,
    <span class="hljs-attr">newNodeData</span>: data,
    <span class="hljs-attr">position</span>: <span class="hljs-string">'after'</span>,
    <span class="hljs-attr">referTargetNodeId</span>: node.<span class="hljs-property">id</span>
  })
}
</code></pre>
<p>可以看到，<strong>插入一个节点</strong>不仅仅是向 children 数组中多 push 一个元素，而是依赖一系列上下文信息：</p>
<ul>
<li>插入到哪个父节点（<code>parentId</code>）；</li>
<li>相对哪个参考节点（<code>referTargetNodeId</code>）；</li>
<li>插入位置（<code>position</code>：before/after/append 等）；</li>
</ul>
<p>但是在 Yjs 的底层结构中，这些上下文信息在同步时都会<strong>丢失</strong>。
我们只会收到一条 “<code>children</code> 数组新增了一个元素” 的事件：</p>
<pre><code class="hljs language-ts" lang="ts">event.<span class="hljs-property">changes</span>.<span class="hljs-property">added</span> <span class="hljs-comment">// =&gt; [Y.Map({ id: 'new-node-id', ... })]</span>
</code></pre>
<p>这时我们无法推断出节点是“如何插入”的，也就无法还原编辑器层面的真实操作。
换句话说，<strong>Yjs 提供了数据变化的结果，但我们需要的是操作的意图</strong>。</p>
<h4 data-id="heading-9">解决方案：事件总线 + meta 元数据</h4>
<p>为了解决这一问题，我们在架构中引入了两个关键机制：</p>




















<table><thead><tr><th>机制</th><th>主要负责</th><th>作用范围</th></tr></thead><tbody><tr><td><strong>事件总线（Event Bus）</strong></td><td>传播节点级操作的语义，如新增、删除、移动等</td><td>结构性操作</td></tr><tr><td><strong>Meta 元数据（Metadata）</strong></td><td>描述节点属性、状态等细粒度变化</td><td>属性级操作</td></tr></tbody></table>
<h4 data-id="heading-10">1. 事件总线：同步操作意图</h4>
<p>事件总线的设计目标是让每一个“可复现的操作”都能以事件的形式传播到协作层中。</p>
<p>我们会在 Yjs 文档中专门创建一个 <strong><code>__app_events__</code></strong> 通道，用于通信：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 创建事件通道</span>
<span class="hljs-keyword">const</span> eventsMap = <span class="hljs-variable language_">this</span>.<span class="hljs-property">yDoc</span>.<span class="hljs-title function_">getMap</span>(<span class="hljs-string">'__app_events__'</span>)
  
<span class="hljs-comment">// 开启事务保证原子性</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">yDoc</span>.<span class="hljs-title function_">transact</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 在目标节点上设置软删除标志，防止幽灵事件</span>
  targetNode.<span class="hljs-title function_">set</span>(<span class="hljs-string">'_node_deleted'</span>, <span class="hljs-literal">true</span>)
  
  <span class="hljs-comment">// 获取事件总线</span>
  <span class="hljs-keyword">const</span> eventsMap = <span class="hljs-variable language_">this</span>.<span class="hljs-property">yDoc</span>.<span class="hljs-title function_">getMap</span>(<span class="hljs-string">'__app_events__'</span>)
  
  <span class="hljs-comment">// 准备事件负载</span>
  <span class="hljs-keyword">const</span> eventPayload = {
    <span class="hljs-attr">op</span>: <span class="hljs-string">'delete'</span>,
    <span class="hljs-attr">deletedNodeId</span>: id,
    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 可以在负载中包含被删除前的数据，便于远程客户端做一些高级处理（如 "恢复" 功能）</span>
    previousNodeData,
    <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
  }
  
  <span class="hljs-comment">// 使用唯一 ID 发布事件</span>
  <span class="hljs-keyword">const</span> eventId = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>-<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random().toString(<span class="hljs-number">36</span>).substring(<span class="hljs-number">2</span>, <span class="hljs-number">9</span>)}</span>`</span>
  eventsMap.<span class="hljs-title function_">set</span>(eventId, eventPayload)
}, <span class="hljs-string">'local-delete-operation'</span>)
</code></pre>
<p><strong>监听器设计</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 设置一个专门的监听器来处理来自“事件总线”的自定义操作</span>
<span class="hljs-comment">// 处理无法被 initObserver 监听器很好处理的事件</span>
<span class="hljs-keyword">public</span> <span class="hljs-title function_">setupEventListeners</span>(<span class="hljs-attr">docName</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-comment">// 解绑旧的监听器，防止重复</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">eventListeners</span>.<span class="hljs-title function_">has</span>(docName)) {
    <span class="hljs-keyword">const</span> { map, cb } = <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventListeners</span>.<span class="hljs-title function_">get</span>(docName)
    map.<span class="hljs-title function_">unobserve</span>(cb)
  }
  
  <span class="hljs-keyword">const</span> docManager = <span class="hljs-title class_">DocManager</span>.<span class="hljs-title function_">getInstance</span>()
  <span class="hljs-keyword">const</span> ydoc = docManager.<span class="hljs-title function_">getOrCreateDoc</span>(docName)
  <span class="hljs-keyword">const</span> eventsMap = ydoc.<span class="hljs-title function_">getMap</span>(<span class="hljs-string">'__app_events__'</span>)
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">eventCallback</span> = (<span class="hljs-params">event: Y.YMapEvent&lt;<span class="hljs-built_in">any</span>&gt;, transaction: Y.Transaction</span>) =&gt; {
    <span class="hljs-keyword">if</span> (transaction.<span class="hljs-property">local</span>) <span class="hljs-keyword">return</span>
  
    event.<span class="hljs-property">changes</span>.<span class="hljs-property">keys</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">change, key</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (change.<span class="hljs-property">action</span> === <span class="hljs-string">'add'</span>) {
        <span class="hljs-keyword">const</span> <span class="hljs-attr">payload</span>: <span class="hljs-built_in">any</span> = eventsMap.<span class="hljs-title function_">get</span>(key)
  
        <span class="hljs-keyword">if</span> (payload &amp;&amp; payload.<span class="hljs-property">op</span> === <span class="hljs-string">'move'</span>) {
          <span class="hljs-keyword">const</span> <span class="hljs-attr">patch</span>: <span class="hljs-title class_">DiffPatch</span> = {
            <span class="hljs-attr">type</span>: <span class="hljs-string">'array-swap'</span>,
            <span class="hljs-attr">parentId</span>: payload.<span class="hljs-property">parentId</span>,
            <span class="hljs-attr">schemaId</span>: payload.<span class="hljs-property">schemaId</span>,
            <span class="hljs-attr">swapId</span>: payload.<span class="hljs-property">swapId</span>
          }
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyPatches</span>(docName, [patch])
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (payload &amp;&amp; payload.<span class="hljs-property">op</span> === <span class="hljs-string">'insert'</span>) {
          <span class="hljs-keyword">const</span> <span class="hljs-attr">patch</span>: <span class="hljs-title class_">DiffPatch</span> = {
            <span class="hljs-attr">type</span>: <span class="hljs-string">'array-insert'</span>,
            <span class="hljs-attr">parentId</span>: payload.<span class="hljs-property">parentId</span>,
            <span class="hljs-attr">newNodeData</span>: payload.<span class="hljs-property">newNodeData</span>,
            <span class="hljs-attr">position</span>: payload.<span class="hljs-property">position</span>,
            <span class="hljs-attr">referTargetNodeId</span>: payload.<span class="hljs-property">referTargetNodeId</span>
          }
  
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyPatches</span>(docName, [patch])
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (payload &amp;&amp; payload.<span class="hljs-property">op</span> === <span class="hljs-string">'delete'</span>) {
          <span class="hljs-keyword">const</span> <span class="hljs-attr">patch</span>: <span class="hljs-title class_">DiffPatch</span> = {
            <span class="hljs-attr">type</span>: <span class="hljs-string">'array-delete'</span>,
            <span class="hljs-attr">deletedId</span>: payload.<span class="hljs-property">deletedNodeId</span>,
            <span class="hljs-attr">previousNodeData</span>: payload.<span class="hljs-property">previousNodeData</span>
          }
  
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">applyPatches</span>(docName, [patch])
        }
      }
  
      eventsMap.<span class="hljs-title function_">delete</span>(key)
    })
  }
  
  <span class="hljs-comment">// 绑定监听器</span>
  eventsMap.<span class="hljs-title function_">observe</span>(eventCallback)
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">eventListeners</span>.<span class="hljs-title function_">set</span>(docName, { <span class="hljs-attr">map</span>: eventsMap, <span class="hljs-attr">cb</span>: eventCallback })
}
</code></pre>
<p>这样，每当一个用户在本地执行节点插入或删除操作时：</p>
<p>a. 编辑器会向事件总线发送一条“操作意图”；
b. 该事件会被同步到 Yjs 的 <code>__app_events__</code>；
c. 所有协作者客户端的监听器收到事件后，调用 <code>operateNode</code> 重放操作；
d. 从而保持逻辑一致性与结构同步。</p>
<p>这种做法本质上是 <strong>“Yjs 同步结果 + EventBus 同步语义”</strong> 的结合。</p>
<h4 data-id="heading-11">2. Meta 元数据：追踪节点属性变化</h4>
<p>而对于节点属性（如 <code>props</code>、<code>style</code>、<code>loop</code>、<code>condition</code> 等）而言，我们并不需要同步操作意图，只需同步最终结果即可。
因此我们在每个节点的 Yjs 表示中增加一份 <strong>meta 元数据</strong>：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> yNode = <span class="hljs-keyword">new</span> Y.<span class="hljs-title class_">Map</span>()
yNode.<span class="hljs-title function_">set</span>(<span class="hljs-string">'meta'</span>, <span class="hljs-keyword">new</span> Y.<span class="hljs-title class_">Map</span>({
  <span class="hljs-attr">lastModifiedBy</span>: userId,
  <span class="hljs-attr">lastModifiedAt</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
  <span class="hljs-attr">changeType</span>: <span class="hljs-string">'props'</span>
}))
</code></pre>
<p>当属性发生修改时，我们更新对应的 meta 字段，这样协作者就能知道：</p>
<ul>
<li>是哪个用户修改的；</li>
<li>修改了什么部分；</li>
<li>修改时间等信息。</li>
</ul>
<p>并通过 <code>observeDeep</code> 自动捕获变化，实现属性级别的实时同步。</p>
<p>这种模式下，结构操作（增删节点）和属性操作（节点内部更新）各司其职，不会互相干扰。</p>
<h4 data-id="heading-12">架构小结</h4>
<p>通过事件总线与 meta 元数据的结合，我们实现了 Yjs 协同编辑的完整闭环：</p>
<pre><code class="hljs language-markdown" lang="markdown">用户操作 → 发布事件（EventBus）
<span class="hljs-code">          ↓
     同步到 Yjs (__app_events__)
          ↓
     其他客户端接收 → 重放操作
          ↓
     Schema &amp; 视图更新
</span></code></pre>
<p>而对于属性更新的路径：</p>
<pre><code class="hljs language-markdown" lang="markdown">用户编辑属性 → 更新节点 meta + props
<span class="hljs-code">          ↓
     Yjs observeDeep 监听到变化
          ↓
     同步到其他客户端 → 更新本地 Schema
          ↓
     触发视图重绘
</span></code></pre>
<p>这种分层架构既保持了 <strong>Yjs 的一致性特性</strong>，又补上了协同编辑中至关重要的 <strong>操作语义层</strong>，让多人实时协同真正具备“人理解的上下文逻辑”。</p>
<p>非常好，这一节正是整个 <strong>反向同步链路（Schema → Yjs）</strong> 的核心部分。下面是经过润色和扩展后的完整博客内容片段，可以直接用于技术文档或博客文章中👇</p>
<h3 data-id="heading-13">反向同步机制 —— 从 Schema 改动更新 Yjs</h3>
<p>在前面我们已经介绍了如何通过 Yjs 的变更来驱动本地 Schema 的更新，实现了**“远端 → 本地”** 的同步逻辑。
而这一节要讲的，则是反向过程：<strong>当本地用户操作导致 Schema 发生变化时，如何将这些变更同步到 Yjs 文档，从而广播给其他协作者。</strong></p>
<h4 data-id="heading-14">基本思路</h4>
<p>反向同步的核心理念是：</p>
<blockquote>
<p>当本地 Vue 响应式状态（Schema）发生变化时，我们通过 Vue Hook 捕获到变更，并将这些变更同步到 Yjs 的共享结构中。</p>
</blockquote>
<p>这一机制的关键在于对 <strong>操作意图（Operation Intent）</strong> 的捕获，而不是单纯地对数据差异做比对。
也就是说，我们并不是在检测“数据变了多少”，而是在监听“用户执行了什么操作”——比如插入节点、删除节点、修改属性等。</p>
<h4 data-id="heading-15">添加节点的示例</h4>
<p>以“添加节点”为例，当用户在编辑器中执行插入操作时，实际的 Schema 改动会通过以下函数完成：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">insertNode</span> = (<span class="hljs-params">
  node: { node: Node; parent: Node; data: Node },
  position: PositionType = POSITION.IN,
  select = <span class="hljs-literal">true</span>
</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!node.<span class="hljs-property">parent</span>) {
    <span class="hljs-title function_">insertInner</span>({ <span class="hljs-attr">node</span>: <span class="hljs-title function_">useCanvas</span>().<span class="hljs-property">pageState</span>.<span class="hljs-property">pageSchema</span>!, <span class="hljs-attr">data</span>: node.<span class="hljs-property">data</span> }, position)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">switch</span> (position) {
      <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">TOP</span>:
      <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">LEFT</span>:
        <span class="hljs-title function_">insertBefore</span>(node)
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">BOTTOM</span>:
      <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">RIGHT</span>:
        <span class="hljs-title function_">insertAfter</span>(node)
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">IN</span>:
        <span class="hljs-title function_">insertInner</span>(node)
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">OUT</span>:
        <span class="hljs-title function_">insertContainer</span>(node)
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">REPLACE</span>:
        <span class="hljs-title function_">insertReplace</span>(node)
        <span class="hljs-keyword">break</span>
      <span class="hljs-attr">default</span>:
        <span class="hljs-title function_">insertInner</span>(node)
        <span class="hljs-keyword">break</span>
    }
  }
  
  <span class="hljs-keyword">if</span> (select) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">selectNode</span>(node.<span class="hljs-property">data</span>.<span class="hljs-property">id</span>))
  }
  
  <span class="hljs-title function_">getController</span>().<span class="hljs-title function_">addHistory</span>()
}
</code></pre>
<p>我们重点关注 <code>insertBefore</code> 函数的实现：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-title function_">insertBefore</span> = (<span class="hljs-params">{ parent, node, data }: InsertOptions</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!data.<span class="hljs-property">id</span>) {
    data.<span class="hljs-property">id</span> = utils.<span class="hljs-title function_">guid</span>()
  }
  
  <span class="hljs-comment">// 更新本地 Schema</span>
  <span class="hljs-title function_">useCanvas</span>().<span class="hljs-title function_">operateNode</span>({
    <span class="hljs-attr">type</span>: <span class="hljs-string">'insert'</span>,
    <span class="hljs-attr">parentId</span>: parent.<span class="hljs-property">id</span> || <span class="hljs-string">''</span>,
    <span class="hljs-attr">newNodeData</span>: data,
    <span class="hljs-attr">position</span>: <span class="hljs-string">'before'</span>,
    <span class="hljs-attr">referTargetNodeId</span>: node.<span class="hljs-property">id</span>
  })
  
  <span class="hljs-comment">// 多人协作同步</span>
  <span class="hljs-title function_">useRealtimeCollab</span>().<span class="hljs-title function_">insertSharedNode</span>({ node, parent, data }, <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">TOP</span>)
}
</code></pre>
<p>可以看到，当本地 Schema 执行节点插入后，接下来就通过
<code>useRealtimeCollab().insertSharedNode(...)</code>
来完成与 Yjs 的同步。</p>
<h4 data-id="heading-16">核心逻辑：<code>insertSharedNode</code></h4>
<p><code>insertSharedNode</code> 是整个反向同步机制的关键函数，它的主要职责是：</p>
<ol>
<li>
<p><strong>确定 Yjs 结构中目标位置</strong>
通过 <code>parent.id</code> 获取共享文档中对应的 <code>Y.Map</code> 或 <code>Y.Array</code>，找到应插入的目标节点。</p>
</li>
<li>
<p><strong>构造 Yjs 节点对象</strong>
将本地的 <code>Node</code> 数据结构序列化为对应的 Yjs 类型（<code>Y.Map</code>），并递归地将 <code>props</code>、<code>children</code> 等字段映射为 Yjs 可操作的数据结构。</p>
</li>
<li>
<p><strong>执行事务性插入</strong>
使用 <code>ydoc.transact()</code> 进行原子操作，保证一次插入在所有协作者中状态一致。</p>
</li>
</ol>
<p>下面是一个简化后的核心示例逻辑：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 拖拽行为产生的节点插入</span>
<span class="hljs-keyword">public</span> <span class="hljs-title function_">insertNode</span>(<span class="hljs-params">{ node, parent, data }: InsertOptions, position: PositionType</span>) {
  <span class="hljs-keyword">let</span> insertPos
  <span class="hljs-keyword">let</span> insertPosFinal
  
  <span class="hljs-keyword">if</span> (!parent) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">insert</span>(<span class="hljs-title function_">useCanvas</span>().<span class="hljs-property">pageState</span>.<span class="hljs-property">pageSchema</span>!.<span class="hljs-property">id</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>, data, position)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">switch</span> (position) {
      <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">TOP</span>:
      <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">LEFT</span>:
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">insert</span>(parent.<span class="hljs-property">id</span> || <span class="hljs-string">''</span>, data, <span class="hljs-string">'before'</span>, node.<span class="hljs-property">id</span>)
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">BOTTOM</span>:
      <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">RIGHT</span>:
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">insert</span>(parent.<span class="hljs-property">id</span> || <span class="hljs-string">''</span>, data, <span class="hljs-string">'after'</span>, node.<span class="hljs-property">id</span>)
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">IN</span>:
        insertPos = ([<span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">TOP</span>, <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">LEFT</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>[]).<span class="hljs-title function_">includes</span>(position) ? <span class="hljs-string">'before'</span> : <span class="hljs-string">'after'</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">insert</span>(node.<span class="hljs-property">id</span> || <span class="hljs-string">''</span>, data, insertPos)
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">OUT</span>:
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">insert</span>(parent.<span class="hljs-property">id</span> || <span class="hljs-string">''</span>, data, <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">OUT</span>, node.<span class="hljs-property">id</span>)
        <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">REPLACE</span>:
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">insert</span>(parent.<span class="hljs-property">id</span> || <span class="hljs-string">''</span>, data, <span class="hljs-string">'replace'</span>, node.<span class="hljs-property">id</span>)
        <span class="hljs-keyword">break</span>
      <span class="hljs-attr">default</span>:
        insertPosFinal = ([<span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">TOP</span>, <span class="hljs-variable constant_">POSITION</span>.<span class="hljs-property">LEFT</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>[]).<span class="hljs-title function_">includes</span>(position) ? <span class="hljs-string">'before'</span> : <span class="hljs-string">'after'</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">insert</span>(node.<span class="hljs-property">id</span> || <span class="hljs-string">''</span>, data, insertPosFinal)
        <span class="hljs-keyword">break</span>
    }
  }
}
  
<span class="hljs-comment">// insert 操作</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">insert</span>(<span class="hljs-params">parentId: <span class="hljs-built_in">string</span>, newNodeData: Node, position: <span class="hljs-built_in">string</span>, referTargetNodeId?: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">operationHandler</span>.<span class="hljs-title function_">insert</span>({
    <span class="hljs-attr">type</span>: <span class="hljs-string">'insert'</span>,
    parentId,
    newNodeData,
    position,
    referTargetNodeId
  })
}
</code></pre>
<p>其实就相当于重写了 <code>insertNode</code> 来实现 Yjs 的变动</p>
<h4 data-id="heading-17">Vue Hook 的作用</h4>
<p>在实际工程中，我们通常会将这类同步逻辑封装在一个组合式 Hook 中，比如：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * useCollabSchema Composable
 * 职责:
 * 1. 整合 Y.Doc (持久化数据) 和 Y.Awareness (瞬时状态) 的同步。
 * 2. 提供对共享文档结构 (Schema) 的增删改 API。
 * 3. 提供对远程用户实时状态的响应式数据和更新 API。
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useCollabSchema</span>(<span class="hljs-params">options: UseCollabSchemaOptions</span>) {
  <span class="hljs-keyword">const</span> { roomId, currentUser } = options
  <span class="hljs-keyword">const</span> { awareness, provider } = <span class="hljs-title function_">useYjs</span>(roomId, { <span class="hljs-attr">websocketUrl</span>: <span class="hljs-string">`ws://localhost:<span class="hljs-subst">${PORT}</span>`</span> })
  <span class="hljs-keyword">const</span> { remoteStates, updateLocalStateField } = useAwareness&lt;<span class="hljs-title class_">SchemaAwarenessState</span>&gt;(awareness, currentUser)
  
  <span class="hljs-comment">// 获取 NodeSchemaModel 实例</span>
  <span class="hljs-keyword">const</span> schemaManager = <span class="hljs-title class_">SchemaManager</span>.<span class="hljs-title function_">getInstance</span>()
  <span class="hljs-keyword">const</span> schemaModel = schemaManager.<span class="hljs-title function_">createSchema</span>(roomId, provider.<span class="hljs-property">value</span>!)
  
  <span class="hljs-comment">// 拖拽节点</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">insertSharedNode</span> = (<span class="hljs-params">
    node: { node: Node | RootNode; parent: Node | RootNode; data: Node },
    position: PositionType = POSITION.IN
  </span>) =&gt; {
    <span class="hljs-comment">// ...上面提到的核心逻辑</span>
  }
  
  <span class="hljs-comment">// ... 其他核心函数</span>
  
  <span class="hljs-comment">// 组件卸载时取消监听</span>
  <span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
    schemaManager.<span class="hljs-title function_">destroyObserver</span>(roomId)
    provider.<span class="hljs-property">value</span>?.<span class="hljs-title function_">off</span>(<span class="hljs-string">'sync'</span>, <span class="hljs-function">() =&gt;</span> {})
    <span class="hljs-comment">// awareness.value?.destroy()</span>
  })
  
  <span class="hljs-keyword">return</span> {
    remoteStates,
    insertSharedNode,
    <span class="hljs-comment">// ... 其他核心函数</span>
  }
}
  
</code></pre>
<p>这样，任何时候 Schema 层执行了插入、删除、修改等操作，都可以直接通过 <code>useCollabSchema()</code> 来同步到共享文档。</p>
<h3 data-id="heading-18">总结</h3>
<p>在整个多人协同体系中，<strong>Yjs 与 Schema 的双向同步机制</strong>是 tiny-engine 协作的核心。</p>
<ul>
<li>
<p><strong>正向同步（Yjs → Schema）</strong>：
通过 <code>observe</code> 与 <code>observeDeep</code> 监听 Yjs 的数据变更，当远端协作者修改文档时，本地自动更新 Schema，从而触发界面刷新。</p>
</li>
<li>
<p><strong>反向同步（Schema → Yjs）</strong>：
通过 Vue Hook 捕获本地用户操作（如插入、删除、修改节点等），再调用封装的 <code>useRealtimeCollab()</code> 方法，将变更同步回 Yjs 文档。</p>
</li>
<li>
<p><strong>事件总线与 Meta 元数据</strong>：
用于解决单纯数据变更中无法还原操作意图的问题。事件总线负责节点级别的创建与删除同步，而 Meta 则用于监听属性与状态的更改。</p>
</li>
</ul>
<p>最终，我们构建出了一条完整的数据同步链路：</p>
<pre><code class="hljs">Yjs 改动 → Schema 更新 → 视图刷新
Schema 改动 → Yjs 更新 → 远端同步
</code></pre>
<p>这条链路确保了多人协同环境下的数据一致性与实时响应能力，让每一个编辑动作都能即时地被所有协作者感知与呈现。
它既保证了操作的语义化，也为后续的冲突解决与版本管理打下了坚实的基础。</p>
<h2 data-id="heading-19">实操上手：</h2>
<p>接下来，我们将引导您在本地环境中，仅需几条命令，就能启动一个功能完备的协同设计画布，并见证实时同步的“魔法”。</p>
<h3 data-id="heading-20">预备工作：你的开发环境</h3>
<p>在开始之前，请确保您的本地环境满足以下条件，这是保证顺利运行的基础：</p>
<ul>
<li><strong>Node.js</strong>: 版本需 <code>≥ 16</code>。我们推荐使用 <code>nvm</code> 或 <code>fnm</code> 等工具来管理 Node.js 版本，以避免环境冲突。
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查你的 Node.js 版本</span>
node -v 
</code></pre>
</li>
<li><strong>pnpm</strong>: <code>tiny-engine</code> 采用 pnpm 作为包管理器，以充分利用其在 monorepo（多包仓库）项目中的高效依赖管理能力。
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 如果尚未安装 pnpm，请运行以下命令</span>
npm install -g pnpm
</code></pre>
</li>
</ul>
<h3 data-id="heading-21">第一步：克隆 <code>tiny-engine</code> 源码</h3>
<p>首先，将 <code>tiny-engine</code> 的官方仓库克隆到您的本地。</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/opentiny/tiny-engine.git
<span class="hljs-built_in">cd</span> tiny-engine
</code></pre>
<p>进入项目目录后，您会发现这是一个结构清晰的 monorepo 项目，所有功能模块（如编辑器核心、物料面板、协作服务等）都作为独立的子包存在于 <code>packages/</code> 目录下。</p>
<h3 data-id="heading-22">2️⃣ 第二步：安装项目依赖</h3>
<p>在项目根目录下，执行 <code>pnpm install</code>。pnpm 会智能地解析并安装所有子包的依赖，并建立它们之间的符号链接（symlinks）。</p>
<pre><code class="hljs language-bash" lang="bash">pnpm install
</code></pre>
<blockquote>
<p><strong>💡 为什么是 pnpm？</strong>
在 monorepo 架构中，pnpm 通过其独特的非扁平化 <code>node_modules</code> 结构和内容寻址存储，可以极大地节省磁盘空间，并避免“幻影依赖”问题，保证了开发环境的纯净与一致性。</p>
</blockquote>
<h3 data-id="heading-23">3️⃣ 第三步：启动开发服务，见证奇迹！</h3>
<p>一切准备就绪，现在只需运行 <code>dev</code> 命令，即可一键启动整个 <code>tiny-engine</code> 开发环境。</p>
<pre><code class="hljs language-bash" lang="bash">pnpm dev
</code></pre>
<p>这个命令背后发生了什么？</p>
<ul>
<li>它会同时启动多个服务，包括：
<ul>
<li><strong>Vite 前端开发服务器</strong>: 负责构建和热更新您在浏览器中看到的编辑器界面。</li>
<li><strong>协作后端服务器 (y-websocket)</strong>: 一个轻量级的 WebSocket 服务器，负责接收、广播和持久化 Y.js 的协同数据。</li>
</ul>
</li>
<li>终端会输出编辑器前端的访问地址，通常默认为 <code>http://localhost:7007</code>（请以您终端的实际输出为准）。</li>
</ul>
<h3 data-id="heading-24">4️⃣ 第四步：开启你的“多人协作”剧本</h3>
<p>现在，是时候扮演不同的协作者了！</p>
<ol>
<li><strong>打开第一个窗口</strong>: 在您的浏览器（推荐 Chrome）中打开上一步获取的地址，例如 <code>http://localhost:7007</code>。您会看到 <code>tiny-engine</code> 的低代码设计器界面。这就是我们的<strong>用户A</strong>。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73c46d1b252a42319099d33d96da2ea2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlblRpbnnnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764849879&amp;x-signature=kqRqJGP82o1tNqidGhjKO%2FLSLLE%3D" alt="image-2.png" loading="lazy"/></p>
<ol start="2">
<li>
<p><strong>打开第二个窗口</strong>: <strong>打开一个新的浏览器隐身窗口</strong>，或者使用<strong>另一台连接到同一局域网的设备</strong>，再次访问相同的地址。这个窗口将扮演<strong>用户B</strong>。</p>
</li>
<li>
<p><strong>开始实时协同！</strong>: 将两个窗口并排摆放，现在开始您的表演：</p>
<ul>
<li><strong>在用户A的画布上拖入一个按钮组件</strong>。观察用户B的画布，几乎在拖拽完成的瞬间，同样的按钮就会“凭空出现”在相同的位置。</li>
<li><strong>在用户B的界面上，选中刚刚同步过来的按钮，修改它的“按钮内容”属性</strong>。观察用户A的界面，按钮的文本会实时地、逐字地发生变化。</li>
<li><strong>在用户A的大纲树面板中，拖拽一个组件来改变其层级结构</strong>。观察用户B的大纲树，节点会立即移动到新的位置。</li>
<li><strong>在任意一个窗口中，尝试同时操作</strong>。比如，用户A修改组件的颜色，用户B修改其边距。您会发现，由于 CRDT 的特性，所有的修改最终都会被正确合并，达到最终一致的状态，而不会产生冲突或覆盖。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-25">进阶探索与调试技巧</h3>
<p>如果您对背后的原理感到好奇，可以尝试以下操作来深入探索：</p>
<ul>
<li>
<p><strong>查看协同状态</strong>: 打开浏览器的开发者工具，进入 控制台，你会看到相应的协同状态数据</p>
</li>
<li>
<p><strong>网络“时光机”</strong>: 在开发者工具的 <code>Network</code> 标签页，筛选 <code>WS</code> (WebSocket) 连接。您可以看到客户端与 <code>y-websocket</code> 服务器之间流动的二进制消息。尝试断开网络再重连，观察 Y.js 是如何利用 CRDT 的能力，在重连后自动同步所有离线期间的变更的。</p>
</li>
<li>
<p><strong>扮演“上帝”</strong>: 在控制台中，您可以访问 Y.js 的 <code>doc</code> 和 <code>awareness</code> 实例，尝试手动修改数据或广播自定义状态，来更深入地理解数据驱动的协同模型。</p>
</li>
</ul>
<p>通过以上步骤，您已经成功在本地完整地体验了 <code>tiny-engine</code> 先进的多人协作能力。这不仅仅是一个功能演示，它背后融合了 <strong>CRDT (Y.js)、实时通信 (WebSocket)、元数据驱动和事件总线</strong> 等一系列现代前端工程化的最佳实践。</p>
<h2 data-id="heading-26">演示</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48a2d5c95a0a4e93b44d525add444549~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT3BlblRpbnnnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764849879&amp;x-signature=SNzsGXjimOx6A4VPEBLMD4Bblwk%3D" alt="20251026152240_rec_.gif" loading="lazy"/></p>
<p>（本项目为开源之夏活动贡献，欢迎大家体验并使用）
源码可参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-engine%2Ftree%2Fospp-2025%2Fmultiplayer-collaboration" target="_blank" title="https://github.com/opentiny/tiny-engine/tree/ospp-2025/multiplayer-collaboration" ref="nofollow noopener noreferrer">github.com/opentiny/ti…</a></p>
<h2 data-id="heading-27">关于 OpenTiny</h2>
<p>欢迎加入 OpenTiny 开源社区。添加微信小助手：opentiny-official 一起参与交流前端技术～</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fopentiny.design%2F" target="_blank" title="https://opentiny.design/" ref="nofollow noopener noreferrer">OpenTiny 官网</a>：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fopentiny.design" target="_blank" title="https://opentiny.design" ref="nofollow noopener noreferrer">opentiny.design</a></strong><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny" target="_blank" title="https://github.com/opentiny" ref="nofollow noopener noreferrer">OpenTiny 代码仓库</a>：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny" target="_blank" title="https://github.com/opentiny" ref="nofollow noopener noreferrer">github.com/opentiny</a></strong><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-vue" target="_blank" title="https://github.com/opentiny/tiny-vue" ref="nofollow noopener noreferrer">TinyVue 源码</a>：<strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-vue" target="_blank" title="https://github.com/opentiny/tiny-vue" ref="nofollow noopener noreferrer">github.com/opentiny/ti…</a></strong><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-engine" target="_blank" title="https://github.com/opentiny/tiny-engine" ref="nofollow noopener noreferrer">TinyEngine 源码</a>： <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopentiny%2Ftiny-engine" target="_blank" title="https://github.com/opentiny/tiny-engine" ref="nofollow noopener noreferrer">github.com/opentiny/ti…</a></strong><br/>
欢迎进入代码仓库 Star🌟TinyEngine、TinyVue、TinyNG、TinyCLI、TinyEditor~
如果你也想要共建，可以进入代码仓库，找到 good first issue 标签，一起参与开源贡献~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[栈（Stack）：从“弹夹”到算法面试题的进阶之路]]></title>    <link>https://juejin.cn/post/7577284968923676672</link>    <guid>https://juejin.cn/post/7577284968923676672</guid>    <pubDate>2025-11-28T06:07:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577284968923676672" data-draft-id="7577189654489186354" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="栈（Stack）：从“弹夹”到算法面试题的进阶之路"/> <meta itemprop="keywords" content="JavaScript,面试,算法"/> <meta itemprop="datePublished" content="2025-11-28T06:07:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南山安"/> <meta itemprop="url" content="https://juejin.cn/user/1795929588117962"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            栈（Stack）：从“弹夹”到算法面试题的进阶之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1795929588117962/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南山安
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T06:07:33.000Z" title="Fri Nov 28 2025 06:07:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>今天我们要聊的是数据结构界的“老实人”——<strong>栈（Stack）</strong> 。为什么说它老实？因为它只有一条规矩，而且死守到底：<strong>先进后出（FILO - First In, Last Out）</strong> 。</p>
<p>想象一下你洗盘子，洗好的盘子一个接一个往上摞（入栈），取盘子时只能从最上面拿（出栈）。如果你非要抽中间的盘子？抱歉，那叫“塌方”，不叫数据结构。</p>
<p>本文将带你从 JS 数组的原生操作开始，利用 ES6 Class 封装高逼格的栈，对比数组与链表的底层优劣，最后用一道经典面试题来实战演练。</p>
<hr/>
<h2 data-id="heading-1">一、JS 数组——天生的“栈”</h2>
<p>在 JavaScript 的世界里，数组（Array）就是一个开箱即用的超级工具。它不仅能当列表用，配合几个 API，它立刻就能变身成一个栈。</p>
<h3 data-id="heading-2">核心操作</h3>
<p>JS 数组提供了完美适配栈语义的方法：</p>
<ul>
<li><strong>push(element)</strong> ：入栈（压栈）。往数组尾部塞东西。</li>
<li><strong>pop()</strong> ：出栈（弹栈）。把数组尾部的东西扔出来。</li>
<li><strong>peek (手动实现)</strong> ：偷看一眼栈顶是谁（array[length - 1]）。</li>
</ul>
<pre><code class="hljs language-codeJavaScript" lang="codeJavaScript">
const stack = [];

// 入栈：像是往弹夹里压子弹
stack.push(1);
stack.push(2);
stack.push(3);

console.log(stack); // [1, 2, 3]

// 访问栈顶（不删除）：看看下一发子弹是什么
const peek = stack[stack.length - 1];
console.log(`栈顶元素: ${peek}`); // 3

// 出栈：发射！
const popped = stack.pop(); 
console.log(`弹出的元素: ${popped}`); // 3
console.log(stack); // [1, 2]

// 警告：不要用 shift/unshift 模拟栈！
// 虽然 stack.unshift(val) 和 stack.shift() 也能实现先进后出（在头部操作）
// 但会导致数组内所有元素下标移动，时间复杂度是 O(n)，效率极低。
// 请认准 push/pop 组合，它们通常是 O(1) 的。
</code></pre>
<hr/>
<h2 data-id="heading-3">二、面向对象封装——做个有“边界感”的栈</h2>
<p>虽然数组很好用，但在大型项目中，直接暴露数组是很危险的。万一哪个实习生手抖写了个 stack[2] = 'hack'，破坏了栈的结构怎么办？</p>
<p>我们需要用 ES6 的 <strong>Class</strong> 把实现细节藏起来，只暴露标准接口。这叫<strong>封装</strong>，也是 ADT（抽象数据类型）的精神所在。</p>
<h3 data-id="heading-4">数组实现版 (ArrayStack)</h3>
<p>我们要用到 ES6 的黑科技：<strong>私有属性（Private Fields）</strong> 。</p>
<ul>
<li><strong>#stack</strong>：加了 # 号，外部就无法通过 instance.#stack 访问。这是真正的“隐私保护”。</li>
<li><strong>get size()</strong> ：访问器属性，让你像访问变量一样访问方法。</li>
</ul>
<pre><code class="hljs language-codeJavaScript" lang="codeJavaScript">
class ArrayStack {
  // 私有属性，底层是一个数组
  #stack;

  constructor() {
    this.#stack = [];
  }

  // 入栈
  push(val) {
    this.#stack.push(val);
  }

  // 出栈
  pop() {
    if (this.isEmpty()) throw new Error('栈为空，没东西给你弹了');
    return this.#stack.pop();
  }

  // 查看栈顶
  peek() {
    if (this.isEmpty()) throw new Error('栈为空');
    return this.#stack[this.size - 1];
  }

  // 这里的 get 关键字，让我们能用 stack.size 而不是 stack.size()
  get size() {
    return this.#stack.length;
  }

  isEmpty() {
    return this.size === 0;
  }

  // 为了调试方便，允许转换成普通数组查看
  // 使用扩展运算符复制一份，防止外部修改内部引用
  toArray() {
    return [...this.#stack];
  }
}

const s = new ArrayStack();
s.push(100);
s.push(200);
console.log(s.size); // 2
// console.log(s.#stack); // 报错！SyntaxError，保护成功
</code></pre>
<hr/>
<h2 data-id="heading-5">三、链表实现版——底层的“浪漫”</h2>
<p>如果我们不准用数组呢？或者我们需要极致的扩容性能呢？这时 **链表（Linked List）**就登场了。</p>
<p>我们通过节点（Node）的指针连接来实现栈。</p>
<ul>
<li><strong>栈顶指针 (stackPeek)</strong> ：永远指向链表的头部（Head）。</li>
<li><strong>入栈</strong>：新建节点 -&gt; 指向原栈顶 -&gt; 更新栈顶指针。</li>
<li><strong>出栈</strong>：保存原栈顶值 -&gt; 栈顶指针后移。</li>
</ul>
<pre><code class="hljs language-codeJavaScript" lang="codeJavaScript">

// 节点类：链表的最小单元
class ListNode {
  constructor(val) {
    this.val = val;
    this.next = null;
  }
}

class LinkedListStack {
  #stackPeek; // 这是一个指针，指向栈顶节点
  #size = 0;

  constructor() {
    this.#stackPeek = null;
  }

  push(num) {
    const node = new ListNode(num);
    // 关键步骤：把新节点“骑”在旧栈顶头上
    node.next = this.#stackPeek;
    this.#stackPeek = node;
    this.#size++;
  }

  pop() {
    if (!this.#stackPeek) throw new Error('栈为空');
    const num = this.#stackPeek.val;
    // 关键步骤：丢弃头节点，让下一个节点上位
    this.#stackPeek = this.#stackPeek.next;
    this.#size--;
    return num;
  }

  peek() {
    if (!this.#stackPeek) throw new Error('栈为空');
    return this.#stackPeek.val;
  }

  get size() {
    return this.#size;
  }

  toArray() {
    const res = [];
    let node = this.#stackPeek;
    while (node) {
      res.push(node.val);
      node = node.next;
    }
    return res; // 注意：这里生成的数组，索引0是栈顶元素
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-6">四、巅峰对决——数组 vs 链表</h2>
<p>这两种实现各有千秋。这是一个非常经典的面试考点。</p>
<h3 data-id="heading-7">1. 时间效率（Time Complexity）</h3>
<ul>
<li>
<p><strong>数组实现</strong>：</p>
<ul>
<li>
<p><strong>平均情况</strong>：  O(1)</p>
<p>：入栈出栈极快，因为内存是连续的。</p>
</li>
<li>
<p><strong>最坏情况</strong>：O(n)</p>
<p>：<strong>扩容（Resizing）</strong> 当数组满了，JS 引擎需要在内存中找一块更大的地盘，把旧数据全部复制过去，这一瞬间，性能会“卡顿”一下。</p>
</li>
</ul>
</li>
<li>
<p><strong>链表实现</strong>：</p>
<ul>
<li>
<p><strong>稳定</strong>： O(1)，不管有多少数据，入栈永远只是改个指针指向，没有“扩容”的烦恼。</p>
</li>
<li>
<p><strong>缺点</strong>：虽然理论上是  O(1) ，但每次 new ListNode 都有内存分配的开销，且不像数组那样对 CPU 缓存友好。</p>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-8">2. 空间效率（Space Complexity）</h3>
<ul>
<li><strong>数组</strong>：可能有<strong>空间浪费</strong>。为了防止频繁扩容，数组通常会预分配比实际需要更多的内存（比如你存了5个，它实际占了10个坑）。</li>
<li><strong>链表</strong>：<strong>额外开销</strong>。每个数据不仅要存值，还要存一个 next 指针（引用）。如果存的是简单的整数，指针占用的内存可能比数据本身还大。</li>
</ul>
<p><strong>结论</strong>：在前端开发中，数据量通常不会大到让数组扩容成为瓶颈，且 JS 引擎对数组做了极致优化，<strong>首选数组实现</strong>。但在系统级编程或对时延极其敏感的场景下，链表更稳定。</p>
<hr/>
<h2 data-id="heading-9">五、实战应用——有效的括号</h2>
<p>光说不练假把式，我们来看一个经典的算法题：<a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fvalid-parentheses%2Fdescription%2F" target="_blank" title="https://leetcode.cn/problems/valid-parentheses/description/" ref="nofollow noopener noreferrer">LeetCode 20. 有效的括号</a></p>
<p><strong>题目</strong>：判断字符串中的括号 (), [], {} 是否合法闭合。<br/>
<strong>思路</strong>：</p>
<ol>
<li>
<p>遇到左括号：压入栈。</p>
</li>
<li>
<p>遇到右括号：弹出栈顶，看看是不是配套的左括号，如果不配套，或者栈已经空了，说明不合法。</p>
</li>
<li>
<p>遍历结束：栈必须为空（所有左括号都找到了归宿）。</p>
</li>
</ol>
<pre><code class="hljs language-codeJavaScript" lang="codeJavaScript">

const isValid = function (str) {
  if (!str) return true;
  
  // 映射表：右括号 -&gt; 对应的左括号
  // 这样我们可以通过右括号快速查找它期待的“另一半”
  const rightToLeft = {
    ')': '(',
    '}': '{',
    ']': '['
  };
  
  const stack = [];
  
  for (let i = 0; i &lt; str.length; i++) { // 原代码 bug: str.len -&gt; str.length
    const ch = str[i];
    
    // 如果是左括号，入栈
    if (ch === '(' || ch === '[' || ch === '{') {
      stack.push(ch);
    } 
    // 如果是右括号
    else {
      // 1. 栈里是空的（说明前面没有左括号，居然先来了个右括号？） -&gt; 也就是 false
      // 2. 弹出的左括号和当前的右括号不匹配 -&gt; false
      // 原代码 bug: leftToright.ch -&gt; rightToLeft[ch] (属性访问要用[])
      if (!stack.length || stack.pop() !== rightToLeft[ch]) {
        return false;
      }
    }
  }
  
  // 遍历完了，栈里必须干净才算赢
  return stack.length === 0;
};

// 测试用例
console.log(isValid("()[]{}")); // true
console.log(isValid("(]"));     // false
console.log(isValid("([)]"));   // false
console.log(isValid("{[]}"));   // true
</code></pre>
<hr/>
<h2 data-id="heading-10">六、 写在最后：如何在面试中优雅地聊栈？</h2>
<p>面试官：“用 JavaScript 实现一个栈呗？”</p>
<p>你（面不改色）：</p>
<p>“看需求哈～ 日常开发我直接用数组，三行搞定，性能拉满。 如果需要严格私有属性和防篡改，我就写个 class 封装。 真要聊底层实现，我还能甩个链表版，时间复杂度永远 O(1)，不过实际项目里基本不用，因为缓存不友好。 哦对了，顺手还能写个括号匹配玩玩～”</p>
<p>说完淡定喝一口水，面试官已经在狂点头了。</p>
<h2 data-id="heading-11">总结</h2>
<ol>
<li><strong>栈（Stack）<strong>是</strong>先进后出</strong>的线性结构，就像堆盘子。</li>
<li><strong>JS 数组</strong>通过 push/pop 原生支持栈操作，简单高效。</li>
<li><strong>ES6 Class</strong> 可以让我们封装出更安全（私有属性）、更规范的栈数据结构。</li>
<li><strong>链表实现</strong>避免了数组扩容的性能抖动，但牺牲了空间去存指针。</li>
<li><strong>算法应用</strong>：遇到“配对”、“回溯”、“撤销操作”类的问题，第一时间想到栈。</li>
</ol>
<p>栈是数据结构里最“单纯”的一个家伙：只有一头开口，像个死心眼的管子。但就是这么个简单的东西，撑起了递归、表达式解析、DFS……整个计算机世界的半壁江山。</p>
<p><strong>记住一句话：“当你不知道用啥数据结构的时候，先试试栈，八成能行。”</strong></p>
<p>希望这篇整理能让你对栈的理解更上一层楼！Happy Coding!</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[XLog debug 开启打印日志，release 关闭打印日志]]></title>    <link>https://juejin.cn/post/7577430671946629146</link>    <guid>https://juejin.cn/post/7577430671946629146</guid>    <pubDate>2025-11-28T06:10:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577430671946629146" data-draft-id="7577321767346929710" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="XLog debug 开启打印日志，release 关闭打印日志"/> <meta itemprop="keywords" content="前端,Java,Android"/> <meta itemprop="datePublished" content="2025-11-28T06:10:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="lichong951"/> <meta itemprop="url" content="https://juejin.cn/user/1486195453865687"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            XLog debug 开启打印日志，release 关闭打印日志
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1486195453865687/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    lichong951
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T06:10:18.000Z" title="Fri Nov 28 2025 06:10:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 <strong>XLog</strong> 里实现 <strong>debug 开启 / release 关闭</strong> 日志，<strong>不需要自己写开关</strong>，官方已提供 <strong>编译期 + 运行时</strong> 两级方案，<strong>零运行时开销</strong>。
下面给出 <strong>Java &amp; Kotlin</strong> 两种写法，<strong>直接拷贝</strong>即可。</p>
<hr/>
<p>一、build.gradle 里利用 <strong>BuildConfig.DEBUG</strong> 自动切换</p>
<pre><code class="hljs language-gradle" lang="gradle">android {
    ...
    buildTypes {
        debug {
            // debug 版打开 XLog
            buildConfigField "boolean", "LOG_OPEN", "true"
        }
        release {
            // release 版彻底关闭（编译期优化）
            buildConfigField "boolean", "LOG_OPEN", "false"
        }
    }
}
</code></pre>
<hr/>
<p>二、Application 里一行代码初始化</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Application</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">()</span> {
        <span class="hljs-built_in">super</span>.onCreate();
        <span class="hljs-comment">// 只在 debug 编译时生效，release 版不会打印也不会初始化</span>
        <span class="hljs-keyword">if</span> (BuildConfig.LOG_OPEN) {
            XLog.init(LogLevel.ALL);   <span class="hljs-comment">// 调试版全开</span>
        } <span class="hljs-keyword">else</span> {
            XLog.init(LogLevel.NONE);  <span class="hljs-comment">// 发布版全关（0 开销）</span>
        }
    }
}
</code></pre>
<hr/>
<p>三、Kotlin 更简洁</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">App</span> : <span class="hljs-type">Application</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onCreate()
        XLog.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">if</span> (BuildConfig.LOG_OPEN) LogLevel.ALL <span class="hljs-keyword">else</span> LogLevel.NONE)
    }
}
</code></pre>
<hr/>
<p>四、运行时动态关闭（可选）</p>
<p>若 <strong>同一份 APK</strong> 想 <strong>后台远程关闭日志</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 远程配置下发 false</span>
<span class="hljs-keyword">if</span> (!RemoteConfig.isLogOpen()) {
    XLog.init(LogLevel.NONE);   <span class="hljs-comment">// 立即停打</span>
}
</code></pre>
<hr/>
<p>五、一行总结</p>
<p><strong>debug / release 双包场景</strong>：
<strong>gradle 里 BuildConfig.LOG_OPEN + XLog.init(LogLevel.ALL/NONE)</strong> 即可 <strong>编译期彻底关闭 XLog</strong>，<strong>release 版 0 性能损耗</strong>。</p>
<p><strong>单包场景</strong>：
<strong>远程配置 → XLog.init(LogLevel.NONE)</strong> 随时关闭。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[图片标签用 img 还是 picture？很多人彻底弄混了！]]></title>    <link>https://juejin.cn/post/7577298871005036578</link>    <guid>https://juejin.cn/post/7577298871005036578</guid>    <pubDate>2025-11-28T06:21:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577298871005036578" data-draft-id="7570058831559344163" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="图片标签用 img 还是 picture？很多人彻底弄混了！"/> <meta itemprop="keywords" content="前端,HTML"/> <meta itemprop="datePublished" content="2025-11-28T06:21:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刘大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            图片标签用 img 还是 picture？很多人彻底弄混了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刘大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T06:21:44.000Z" title="Fri Nov 28 2025 06:21:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在网页开发中，图片处理是每个前端开发者都会遇到的基础任务。面对 <code>&lt;img&gt;</code> 和 <code>&lt;picture&gt;</code> 这两个标签，很多人存在误解：要么认为它们是互相替代的关系，要么在不合适的场景下使用了复杂的解决方案。今天，我们来彻底理清这两个标签的真正用途。</p>
<h3 data-id="heading-0"><code>&lt;img&gt;</code> 标签</h3>
<p><code>&lt;img&gt;</code> 是 HTML 中最基础且强大的图片标签，但它远比很多人想象的要智能。</p>
<p><strong>基本语法：</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"image.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"图片描述"</span>&gt;</span>
</code></pre>
<p><strong>核心属性：</strong></p>
<ul>
<li><code>src</code>：图片路径（必需）</li>
<li><code>alt</code>：替代文本（无障碍必需）</li>
<li><code>srcset</code>：提供多分辨率图片源</li>
<li><code>sizes</code>：定义图片显示尺寸</li>
<li><code>loading</code>：懒加载控制</li>
</ul>
<h4 data-id="heading-1"><code>&lt;img&gt;</code> 的响应式能力被低估了</h4>
<p>很多人认为 <code>&lt;img&gt;</code> 不具备响应式能力，这是错误的认知：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> 
  <span class="hljs-attr">src</span>=<span class="hljs-string">"image-800w.jpg"</span>
  <span class="hljs-attr">srcset</span>=<span class="hljs-string">"image-320w.jpg 320w,
          image-480w.jpg 480w,
          image-800w.jpg 800w"</span>
  <span class="hljs-attr">sizes</span>=<span class="hljs-string">"(max-width: 600px) 100vw,
         (max-width: 1200px) 50vw,
         33vw"</span>
  <span class="hljs-attr">alt</span>=<span class="hljs-string">"响应式图片示例"</span>
&gt;</span>
</code></pre>
<p><strong>这种写法的优势：</strong></p>
<ul>
<li>浏览器自动选择最适合当前屏幕分辨率的图片</li>
<li>根据视口大小动态调整加载的图片尺寸</li>
<li>代码简洁，性能优秀</li>
</ul>
<h3 data-id="heading-2"><code>&lt;picture&gt;</code> 标签</h3>
<p><code>&lt;picture&gt;</code> 不是为了替代 <code>&lt;img&gt;</code>，而是为了解决 <code>&lt;img&gt;</code> 无法处理的特定场景。</p>
<h4 data-id="heading-3"><code>&lt;picture&gt;</code> 解决的三大核心问题</h4>
<p><strong>1. 艺术指导（Art Direction）</strong>
在不同设备上显示不同构图或裁剪的图片：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">picture</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 桌面端：宽屏全景 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">media</span>=<span class="hljs-string">"(min-width: 1200px)"</span> <span class="hljs-attr">srcset</span>=<span class="hljs-string">"hero-desktop.jpg"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 平板端：适中裁剪 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">media</span>=<span class="hljs-string">"(min-width: 768px)"</span> <span class="hljs-attr">srcset</span>=<span class="hljs-string">"hero-tablet.jpg"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 移动端：竖版特写 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"hero-mobile.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"产品展示"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">picture</span>&gt;</span>
</code></pre>
<p><strong>2. 现代格式降级</strong>
优先使用高效格式，同时兼容老旧浏览器：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">picture</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/avif"</span> <span class="hljs-attr">srcset</span>=<span class="hljs-string">"image.avif"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/webp"</span> <span class="hljs-attr">srcset</span>=<span class="hljs-string">"image.webp"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"image.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"格式优化示例"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">picture</span>&gt;</span>
</code></pre>
<p><strong>3. 复杂条件组合</strong>
同时考虑屏幕尺寸和图片格式：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">picture</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 大屏 + AVIF --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">media</span>=<span class="hljs-string">"(min-width: 1200px)"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/avif"</span> <span class="hljs-attr">srcset</span>=<span class="hljs-string">"large.avif"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 大屏 + WebP --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">media</span>=<span class="hljs-string">"(min-width: 1200px)"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/webp"</span> <span class="hljs-attr">srcset</span>=<span class="hljs-string">"large.webp"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 大屏降级 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">media</span>=<span class="hljs-string">"(min-width: 1200px)"</span> <span class="hljs-attr">srcset</span>=<span class="hljs-string">"large.jpg"</span>&gt;</span>
  
  <span class="hljs-comment">&lt;!-- 移动端方案 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"small.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"复杂条件图片"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">picture</span>&gt;</span>
</code></pre>
<h3 data-id="heading-4">关键区别与选择指南</h3>



































<table><thead><tr><th>场景</th><th>推荐方案</th><th>原因</th></tr></thead><tbody><tr><td><strong>同一图片，不同分辨率</strong></td><td><code>&lt;img&gt;</code> + <code>srcset</code> + <code>sizes</code></td><td>代码简洁，浏览器自动优化</td></tr><tr><td><strong>不同构图或裁剪</strong></td><td><code>&lt;picture&gt;</code></td><td>艺术指导必需</td></tr><tr><td><strong>现代格式兼容</strong></td><td><code>&lt;picture&gt;</code></td><td>格式降级必需</td></tr><tr><td><strong>简单静态图片</strong></td><td><code>&lt;img&gt;</code></td><td>无需复杂功能</td></tr><tr><td><strong>兼容老旧浏览器</strong></td><td><code>&lt;img&gt;</code></td><td>最广泛支持</td></tr></tbody></table>
<h3 data-id="heading-5">常见误区纠正</h3>
<p><strong>误区一：<code>&lt;picture&gt;</code> 用于响应式图片</strong></p>
<ul>
<li><strong>事实：</strong> <code>&lt;img&gt;</code> 配合 <code>srcset</code> 和 <code>sizes</code> 已经能处理大多数响应式需求</li>
<li><strong>真相：</strong> <code>&lt;picture&gt;</code> 主要用于艺术指导和格式降级</li>
</ul>
<p><strong>误区二：<code>&lt;picture&gt;</code> 更现代，应该优先使用</strong></p>
<ul>
<li><strong>事实：</strong> 在不需要艺术指导或格式降级的场景下，<code>&lt;img&gt;</code> 是更好的选择</li>
<li><strong>真相：</strong> 合适的工具用在合适的场景才是最佳实践</li>
</ul>
<p><strong>误区三：响应式图片一定要用 <code>&lt;picture&gt;</code></strong></p>
<ul>
<li><strong>事实：</strong> 很多响应式场景用 <code>&lt;img&gt;</code> + <code>srcset</code> 更合适</li>
<li><strong>真相：</strong> 评估需求，选择最简单的解决方案</li>
</ul>
<h3 data-id="heading-6">场景分析</h3>
<h4 data-id="heading-7">应该使用 <code>&lt;img&gt;</code> 的场景</h4>
<p><strong>网站Logo：</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"logo.svg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"公司Logo"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"120"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"60"</span>&gt;</span>
</code></pre>
<p><strong>用户头像：</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> 
  <span class="hljs-attr">src</span>=<span class="hljs-string">"avatar.jpg"</span>
  <span class="hljs-attr">srcset</span>=<span class="hljs-string">"avatar.jpg 1x, avatar@2x.jpg 2x"</span>
  <span class="hljs-attr">alt</span>=<span class="hljs-string">"用户头像"</span>
  <span class="hljs-attr">width</span>=<span class="hljs-string">"80"</span> 
  <span class="hljs-attr">height</span>=<span class="hljs-string">"80"</span>
&gt;</span>
</code></pre>
<p><strong>文章配图：</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> 
  <span class="hljs-attr">src</span>=<span class="hljs-string">"article-image.jpg"</span>
  <span class="hljs-attr">srcset</span>=<span class="hljs-string">"article-image-600w.jpg 600w,
          article-image-1200w.jpg 1200w"</span>
  <span class="hljs-attr">sizes</span>=<span class="hljs-string">"(max-width: 768px) 100vw, 600px"</span>
  <span class="hljs-attr">alt</span>=<span class="hljs-string">"文章插图"</span>
  <span class="hljs-attr">loading</span>=<span class="hljs-string">"lazy"</span>
&gt;</span>
</code></pre>
<h4 data-id="heading-8">应该使用 <code>&lt;picture&gt;</code> 的场景</h4>
<p><strong>英雄横幅（不同裁剪）：</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">picture</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">media</span>=<span class="hljs-string">"(min-width: 1024px)"</span> <span class="hljs-attr">srcset</span>=<span class="hljs-string">"hero-wide.jpg"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">media</span>=<span class="hljs-string">"(min-width: 768px)"</span> <span class="hljs-attr">srcset</span>=<span class="hljs-string">"hero-square.jpg"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"hero-mobile.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"产品横幅"</span> <span class="hljs-attr">loading</span>=<span class="hljs-string">"eager"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">picture</span>&gt;</span>
</code></pre>
<p><strong>产品展示（格式优化）：</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">picture</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/avif"</span> <span class="hljs-attr">srcset</span>=<span class="hljs-string">"product.avif"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/webp"</span> <span class="hljs-attr">srcset</span>=<span class="hljs-string">"product.webp"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"product.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"产品详情"</span> <span class="hljs-attr">loading</span>=<span class="hljs-string">"lazy"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">picture</span>&gt;</span>
</code></pre>
<h3 data-id="heading-9">最佳实践</h3>
<h4 data-id="heading-10">1. 始终遵循的规则</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 正确：始终提供 alt 属性 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"photo.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"描述文本"</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 错误：缺少 alt 属性 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"photo.jpg"</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 装饰性图片使用空 alt --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"decoration.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
</code></pre>
<h4 data-id="heading-11">2. 性能优化策略</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 优先加载关键图片 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"hero.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"重要图片"</span> <span class="hljs-attr">loading</span>=<span class="hljs-string">"eager"</span> <span class="hljs-attr">fetchpriority</span>=<span class="hljs-string">"high"</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 非关键图片延迟加载 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"content-image.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"内容图片"</span> <span class="hljs-attr">loading</span>=<span class="hljs-string">"lazy"</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 指定尺寸避免布局偏移 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"product.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"商品"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"400"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"300"</span>&gt;</span>
</code></pre>
<h4 data-id="heading-12">3. 现代图片格式策略</h4>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">picture</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 优先使用AVIF，压缩率最高 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/avif"</span> <span class="hljs-attr">srcset</span>=<span class="hljs-string">"image.avif"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 其次WebP，广泛支持 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/webp"</span> <span class="hljs-attr">srcset</span>=<span class="hljs-string">"image.webp"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 最终回退到JPEG --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"image.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"现代格式示例"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">picture</span>&gt;</span>
</code></pre>
<h3 data-id="heading-13">总结</h3>
<p><code>&lt;img&gt;</code> 和 <code>&lt;picture&gt;</code> 不是竞争关系，而是互补的工具：</p>
<ul>
<li><strong><code>&lt;img&gt;</code></strong>：处理大多数日常图片需求，特别是分辨率适配</li>
<li><strong><code>&lt;picture&gt;</code></strong>：解决特定复杂场景，如艺术指导和格式降级</li>
</ul>
<p><strong>核心建议：</strong></p>
<ol>
<li>从最简单的 <code>&lt;img&gt;</code> 开始，只在必要时升级到 <code>&lt;picture&gt;</code></li>
<li>充分利用 <code>&lt;img&gt;</code> 的 <code>srcset</code> 和 <code>sizes</code> 属性</li>
<li>为关键图片使用 <code>&lt;picture&gt;</code> 进行格式优化</li>
<li>始终考虑性能和用户体验</li>
</ol>
<p>掌握这两个标签的正确用法，你就能在各种场景下都做出最合适的技术选择，既保证用户体验，又避免过度工程化。</p>
<p>希望这篇指南能帮助你彻底理解这两个重要的HTML标签！</p>
<blockquote>
<p>本文首发于公众号：程序员刘大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote>
<h4 data-id="heading-14">📌往期精彩</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F72THiVPtsrA2xvtHmdDLmA" target="_blank" title="https://mp.weixin.qq.com/s/72THiVPtsrA2xvtHmdDLmA" ref="nofollow noopener noreferrer">《SpringBoot+Vue3 整合 SSE 实现实时消息推送》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FP7SMincYFKERZbNKAFtzGQ" target="_blank" title="https://mp.weixin.qq.com/s/P7SMincYFKERZbNKAFtzGQ" ref="nofollow noopener noreferrer">《这20条SQL优化方案，让你的数据库查询速度提升10倍》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FgQK9L1TxKL50FUVMcgh6JQ" target="_blank" title="https://mp.weixin.qq.com/s/gQK9L1TxKL50FUVMcgh6JQ" ref="nofollow noopener noreferrer">《SpringBoot 动态菜单权限系统设计的企业级解决方案》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FPQ_w7CDVoIZPn-CVH2DKJg" target="_blank" title="https://mp.weixin.qq.com/s/PQ_w7CDVoIZPn-CVH2DKJg" ref="nofollow noopener noreferrer">《Vue3和Vue2的核心区别？很多开发者都没完全搞懂的10个细节》</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI独孤九剑：AI没有场景，无法落地？不存在的。]]></title>    <link>https://juejin.cn/post/7577307100130689074</link>    <guid>https://juejin.cn/post/7577307100130689074</guid>    <pubDate>2025-11-28T06:30:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577307100130689074" data-draft-id="7577395040592379914" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI独孤九剑：AI没有场景，无法落地？不存在的。"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-28T06:30:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="腾讯云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/3456520257538830"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI独孤九剑：AI没有场景，无法落地？不存在的。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3456520257538830/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    腾讯云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-28T06:30:15.000Z" title="Fri Nov 28 2025 06:30:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-28
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>*本文节选自架构师技术同盟交流圈 作者为腾讯云架构师同盟名人堂专家&amp;中国信息通信研究院低代码/无代码推荐中心技术专家｜沈欣</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19ce352c0fde4de79d23a521a865125d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764916215&amp;x-signature=O1w2Wnpa1qkLQAJYKU%2BwbJ%2F8bLs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0"><strong>引言</strong></h2>
<p>S.H.E有首歌的歌词是“全世界都在说中国话”，而今，全世界的CIO们都在找AI的落地场景。</p>
<p>因为不去落地AI，老板会认为你已经过时，跟不上新事物，应该淘汰；去落地AI，万一没有好的高回报场景，老板会认为你能力不足，应该淘汰。正所谓不上AI是等死，上AI是找死。</p>
<p>AI的场景真的很难找，真的无法落地么？不存在的。假如说AI这种工具是一把利剑，那么我们就溯本追源，从中国智慧的故纸堆里找一找解决方案。</p>
<h2 data-id="heading-1">01</h2>
<p>众所周知，金庸世界最强的剑法是独孤九剑（金庸说他小说里面最厉害的人物有三个：独孤求败、达摩、张三丰，他们三个武功不相上下 如果非要选一个就是独孤求败）。</p>
<p>那么如果AI是剑，我们怎样炼成独孤九剑呢？</p>
<p>我们先来看一下，独孤九剑有九式：总诀式、破剑式、破刀式、破枪式、破鞭式、破索式、破箭式、破掌式以及破气式。独孤九剑有三大要诀：无招胜有招，料敌机先，有进无退。总纲内容：周易有云「归妹趋无妄、无妄趋同人、同人趋大有、甲转丙、丙转庚、庚转癸、子丑之交、辰巳之交、午未之 交、风雷是一变、山泽是一变、水火是一变、乾坤相激、震兑相激、离巽相激、三增而成五、五增而成九……」九剑其实不是一般概念中的剑法招式，而是一套武学理论，所以风清扬会说要看悟性。</p>
<p>好吧，看起来，独孤九剑就是一套应对变化的体系。嗯嗯，熟悉我的同学都知道，我也有一套应对变化的体系，称之为ITPAO，在其中AI以数字员工身份起到了非常大的作用，刚好我们就此一一对照，来帮助大家找到更好的AI落地场景。</p>
<p>我们先简单回顾一下ITPAO，本质就是建立一套从输入到输出的动态过程，核心节点是TPA，也即 <em>“目标设定”，“执行规划”，“具体执行”</em> ，而这三部分在实际工作中，都会时不时的发生变化，从而导致输出结果不理想。在ITPAO流程中，通过合馈制引入了数字员工后，由数字员工来发现和理解<em>变化</em>，并且针对<em>变化</em>进行及时调整，也就是所谓的：<em>动态设定目标、动态调整规划、动态跟踪执行</em>。</p>
<p>从这个维度，我们可以把独孤九剑的每一式都看作应对某一类变化的手段：</p>























































<table><thead><tr><th>剑式</th><th>特点</th><th>现实映射</th></tr></thead><tbody><tr><td>破剑</td><td>剑以刺为主；可以理解为单点突变，某个变量突然变化，0维变化，会持续积累伤势</td><td>突发的单点问题，例如某个流程中重要岗位资源突然消失；某个客户突然取消订单。</td></tr><tr><td>破刀</td><td>刀以劈砍为主；一维变化，一旦命中，就是较大的伤害</td><td>突发的线状问题，例如某条产品线遇到了强劲的竞争对手新品；高管出现负面舆情</td></tr><tr><td>破枪</td><td>长兵刃，以挑、扫为主；起初是点状攻击会演变为片状，势大，从二维变化，很容易扩大到三维变化</td><td>政策法规变化；某批原料出现供应链问题；突然出现的现金流问题</td></tr><tr><td>破索</td><td>索是软兵刃，中途拦截无用，末端还是会打上来</td><td>竞对高薪挖人，人员流失</td></tr><tr><td>破鞭</td><td>钢鞭 、铁锏、蛾眉刺、板斧等等短兵刃…攻速慢，但是碰到要害杀伤力强</td><td>针对我们的主力软件产品，出现了开源的免费产品；临时限电，工厂需要停工一天</td></tr><tr><td>破箭</td><td>远程攻击——速度快，大多为小伤害,但有迹可循</td><td>某批次产品质量出现问题； 来客数持续降低</td></tr><tr><td>破掌</td><td>手极为灵活，组合拳，竞争对手</td><td>对手的新营销方案针锋相对，导致我们销量下降</td></tr><tr><td>破气</td><td>上乘内功，就像强大的行业龙头</td><td>挑战行业龙头时面临的各种不可知变化</td></tr><tr><td>总诀</td><td>周易有云「归妹趋无妄、无妄趋同人、同人趋大有、甲转丙、丙转庚、庚转癸、子丑之交、辰巳之交、午未之 交、风雷是一变、山泽是一变、水火是一变、乾坤相激、震兑相激、离巽相激、三增而成五、五增而成九……」 万事都在变化，变化过程是有规律的，变化的发生是无规律的</td><td>ITPAO： 上游资源可能变化 目标可能变化 计划可能变化 执行过程可能变化 冲突点是有规律的，变化会互相影响，最后形成不可预料的结果。</td></tr></tbody></table>
<h2 data-id="heading-2">02</h2>









































<table><thead><tr><th>内容</th><th>说明</th><th>数据及知识支持</th><th>逻辑关系</th></tr></thead><tbody><tr><td>I—输入</td><td>三类输入：资源、边界，结构； 资源、边界由上一环节流入，结构定义输出的结构</td><td>数据、资源、存储</td><td>可被跟踪，可被拆解，可被汇总，快速发现冲突问题</td></tr><tr><td>T—目标</td><td>外部输入转变为内部可清晰定义的目标。由于输入条件的变化，输出范围的变化可进行动态调整</td><td>知识库，清晰无歧义，可量化的目标</td><td>动态目标调整、预测、资源冲突，时间冲突</td></tr><tr><td>P—计划</td><td>根据目标和能力，进行拆解，核心是资源和边界，规划用什么资源在什么时间做什么最合理和高效</td><td>可用资源、冲突关系、时序、实时计划表</td><td>时序冲突、空间冲突、资源冲突、目标节点</td></tr><tr><td>A—行动</td><td>具体的行动，通过对资源和时间的消耗，进行具体的行动，以达到输出结果</td><td>可用资源、组织、实际行动能力、执行对象</td><td>现有资源、现有产出、偏差、预测</td></tr><tr><td>O—输出</td><td>输出资源变化，传导给下一层，并对I定义的输出进行反馈。</td><td>资源、边界，结构</td><td>作为下一层的输入</td></tr></tbody></table>
<p>基于ITPAO的系统结构，我们可以把业务中可能产生的冲突与变化（绿色部分）等同于不同招式对我们的攻击（<em><strong>有种种变化，用以体演总诀，共有三百六十种变化。临敌时，可以此为基础，将八式剑意，融入其中，达到九剑归一的程度</strong></em>）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d83f241122f4889ad8f8530a06d4ee8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764916215&amp;x-signature=5m7fWMiE3leQ8QNHNwjz6wqnysw%3D" alt="" loading="lazy"/></p>
<p>另外，独孤九剑有三大要诀</p>

























<table><thead><tr><th>要诀</th><th>表象</th><th>AI应用逻辑</th></tr></thead><tbody><tr><td>无招胜有招</td><td>不要急着出手，先找招式中的破绽</td><td>守正出奇，有自己的基础流程，有应对外部变化的能力</td></tr><tr><td>料敌机先</td><td>能找到敌人的破绽</td><td>AI的能力需要知识支撑</td></tr><tr><td>有进无退</td><td>只攻不守，攻其必救</td><td>解决问题的优先级很重要，还要有关于创新的勇气</td></tr></tbody></table>
<p>真正的武功，是自洽的，是可以迭代的复杂体系，而不是简单的“化转发、闪电五连鞭”。</p>
<p>其他的一些思考：</p>
<ul>
<li><em><strong>“独孤前辈是绝顶聪明之人，学他的剑法，要旨是在一个‘悟’字，决不在死记硬背。等到通晓了这九剑的剑意，则无所施而不可，无所不出，无所不入，便是将全部变化尽数忘记，也不相干，临敌之际，更是忘记得越干净彻底，越不受原来剑法的拘束。”</strong></em></li>
</ul>
<p>从数据，信息，变成肌肉记忆——&gt; 经验——&gt;知识，最后AI高效调用知识。</p>
<ul>
<li><em><strong>“在华山山洞中，因眼不见物，无法找到对手破绽，最后意外靠魔教十长老的腿骨中的<a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fcloud.tencent.com%2Fdeveloper%2Ftools%2Fblog-entry%253Ftarget%253Dhttps%25253A%25252F%25252Fbaike.baidu.com%25252Fitem%25252F%252525E7%252525A3%252525B7%252525E5%25252585%25252589%25252F2942760%25253FfromModule%25253Dlemma_inlink%2526objectId%253D2528557%2526objectType%253D1%2526contentType%253Dundefined" target="_blank" title="https://link.zhihu.com/?target=https%3A//cloud.tencent.com/developer/tools/blog-entry%3Ftarget%3Dhttps%253A%252F%252Fbaike.baidu.com%252Fitem%252F%2525E7%2525A3%2525B7%2525E5%252585%252589%252F2942760%253FfromModule%253Dlemma_inlink%26objectId%3D2528557%26objectType%3D1%26contentType%3Dundefined" ref="nofollow noopener noreferrer">磷光</a>得以见到 对手武功，才得以施展剑法。”......“独狐九剑”的要旨，在于一眼见到对方招式中的破绽，便即乘虚而入，后发先至，一招制胜。</strong></em></li>
</ul>
<p>信息系统的数据是基础，缺少数据，成了瞎子，再好的剑法也没用。</p>
<ul>
<li><em><strong>“令狐冲学会独孤九剑后棋逢对手甚至差点落败的是东方不败。”</strong></em></li>
</ul>
<p>就像今天的美国，把自己割了以后，各种招式诡异多变，关税政策一日多变，各种强权压制，这也是变化带来的最大挑战。</p>
<p>令狐冲是怎么打赢东方不败？任盈盈在边上对杨莲亭下手干扰了东方不败……当AI的利剑遇到了无法斩断的敌人，我们需要人机结合进行兜底。某企业上线AI客服后效果很棒，因此裁掉了大量的真人客服，后来新品出现时，AI针对这个新品的客服出现问题，立刻陷入焦头烂额的局面。因此，在AI落地时，必须考虑兜底的问题，而好的合作伙伴能够拯救你于水火之中。</p>
<ul>
<li><em><strong>黄钟公不知对令狐冲的剑法却也是高估了。“独孤九剑”是敌强愈强，敌人如果武功不高，“独孤九剑”的精要处也就用不上。</strong></em></li>
</ul>
<p>AI的效率提升，更适合做一些复杂的，人脑无法处理的工作，例如，需要连续高强度思考，需要综合很多信息，需要在复杂的关系中找到逻辑。在这些场景，AI才能够发挥更大的作用。</p>
<p>剑只是工具，AI也只是工具，用来干什么才是关键。所有的应用和场景都应该从管理维度出发，而不仅是提高效率，因为一味提高效率，并不一定能够完成企业真正的目标。</p>
<p>今天，我们以独孤九剑为例，介绍了在ITPAO体系使用AI辅助管理，应对变化的应用，一旦我们在这个层面使用AI，而不是仅仅把AI当成一个问答器，一个画图工，让AI发挥AI的长处，通过建立完备的知识体系，准确的数据供给，可以承载变化的流程架构，就可以做到“随风潜入夜，润物细无声”，这时候的AI无处不在，再也不用去苦苦地寻找AI场景。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1836911b82dc48bb8d626784969435c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764916215&amp;x-signature=bEmXy4vJ4IYZD1pqh%2F2Ch4RokoM%3D" alt="" loading="lazy"/></p>
<p>AI无处不在，应对变化就是最大的场景</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>