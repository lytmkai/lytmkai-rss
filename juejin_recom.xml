<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[多智能体设计模式和智能体框架，你会了么？]]></title>    <link>https://juejin.cn/post/7571416207972483122</link>    <guid>https://juejin.cn/post/7571416207972483122</guid>    <pubDate>2025-11-12T07:58:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571416207972483122" data-draft-id="7571637614202667035" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="多智能体设计模式和智能体框架，你会了么？"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-11-12T07:58:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            多智能体设计模式和智能体框架，你会了么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T07:58:43.000Z" title="Wed Nov 12 2025 07:58:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、新闻</h2>
<p>先播放一条最新新闻，通义团队官宣开源了两个智能体<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagentscope-ai%2Fagentscope-samples%2Ftree%2Fmain%2Falias" target="_blank" title="https://github.com/agentscope-ai/agentscope-samples/tree/main/alias" ref="nofollow noopener noreferrer"><strong>Alias-Agent</strong></a>和<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagentscope-ai%2Fagentscope-samples%2Ftree%2Fmain%2Fdata_juicer_agent" target="_blank" title="https://github.com/agentscope-ai/agentscope-samples/tree/main/data_juicer_agent" ref="nofollow noopener noreferrer"><strong>Data-Juicer Agent</strong></a>。</p>
<p><strong>Alias-Agent</strong>提供了RaAct，Planner，DeepResearch三种模式，以实现灵活的任务执行 <strong>。</strong></p>
<p><strong>DataJuicer</strong> 智能体是一个数据专员，由<strong>数据处理智能体，代码开发智能体，MCP 智能体，数据分析与可视化智能体，问答智能体</strong>五个智能体组成。</p>
<p>﻿</p>
<p>看到这里已经相当炸裂了！可能很多伙伴对智能体（Agent）的范式不熟悉，还不理解ReAct、Planner、反思叭叭这些名词。那你们就来对了地方，我用最容易理解的方式带大家一起看下智能体内部是什么样子的。</p>
<p>﻿</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32a2633e165549189d6271a17f8531a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763539123&amp;x-signature=hg29fGuoPSTltE0t0GxuXhs3Uaw%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p><strong>产品化的智能体</strong>由多Agent，反思，计划，推理与行动，记忆，RAG，工具，MCP组成的。首先聊下“Multi-Agent”，它非常好玩！</p>
<p>﻿</p>
<h2 data-id="heading-1">二、Multi-Agent 的7种设计模式</h2>
<p>要让AI代替人工作，现阶段的单体智能体（仅通过系统提示词赋能的LLM）是很难实现的。我们很快意识到，要构建高效的系统，需要多个专业化智能体协同工作、自主组织。为实现这一目标，AI 智能体领域已涌现出多种架构模式。多个智能体组成实现的，也就是Multi-Agent，发展到现在有7种实现方式。</p>
<p><strong>1. 工作流模式</strong></p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b29e7d219a6481da1484711e561bf5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763539123&amp;x-signature=Jca3%2BoFBwDHbwOb63iufFX8iWsw%3D" alt="" loading="lazy"/></p>
<p>﻿在《Agentic Design Patterns》中叫Prompt Chaining，每个智能体都逐步地完成输出，比如一个生成代码，另一个审核代码，第三个部署代码。每一步的输出作为下一步的输入。这种信息传递建立了依赖链，前序操作的上下文和结果会引导后续处理，使 LLM 能够在前一步基础上不断完善理解，逐步逼近目标解。</p>
<p>他非常适合应用在工作流自动化、ETL和多步骤推理pipeline场景。</p>
<p>﻿</p>
<p><strong>2. 路由模式</strong></p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/791058c930ea4255973f54b17b3291c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763539123&amp;x-signature=yEK5nxow6lTOSq1BJzfB0CFtQVk%3D" alt="" loading="lazy"/></p>
<p>﻿路由模式为智能体的操作框架引入了条件逻辑，使其从固定执行路径转变为动态评估标准，从一组可能的后续动作中进行选择的模式，从而实现一套更灵活，并且具备上下文感知的。一个控制器智能体将任务分配给合适的专业智能体，这是上下文感知智能体路由的基础，正如在MCP、A2A框架中所看到的那样。</p>
<p>路由模式的实现有四种：</p>
<p>•<strong>根据LLM路由</strong>，通过提示语言模型分析输入，并输出指示下一步或目标的标识符或指令。这里有显式路由和隐式路由两类，显示直接使用智能体的结构化输出来确定将消息路由到哪个智能体。隐式路由是将下游智能体包装成工具函数，这样路由智能体就可以根据用户查询决定调用哪个工具。</p>
<pre><code class="hljs language-ini" lang="ini">""" 伪代码示例 """
<span class="hljs-attr">router</span> = ReActAgent(
    <span class="hljs-attr">name</span>=<span class="hljs-string">"Router"</span>,
    <span class="hljs-attr">sys_prompt</span>=<span class="hljs-string">"#角色#你是一个路由智能体。你的目标是将用户查询路由到正确的后续任务，注意你不需要回答用户的问题。
                #任务#选择正确的后续任务，如果任务太简单或没有合适的任务，则选择 ``None``"</span>,
    <span class="hljs-attr">model</span>=ChatModel(
        <span class="hljs-attr">model_name</span>=<span class="hljs-string">"gpt-4"</span>,
        <span class="hljs-attr">api_key</span>=<span class="hljs-string">""</span>,
        <span class="hljs-attr">stream</span>=<span class="hljs-literal">False</span>,
    )
)
</code></pre>
<p><strong>根据Embedding路由</strong>，利用嵌入能力，将查询路由到最相似的路径上，适用于语义路由，即决策基于输入的含义而非关键词。</p>
<pre><code class="hljs language-python" lang="python">     <span class="hljs-string">""" 伪代码示例 """</span>
     <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 使用轻量级的句子编码模型</span>
        self.model = ChatModel( model_name=<span class="hljs-string">"gpt-4"</span>, api_key=<span class="hljs-string">""</span>, stream=<span class="hljs-literal">False</span>, )
        
        <span class="hljs-comment"># 定义不同的路由能力和对应的处理函数</span>
        self.routes = {
            <span class="hljs-string">'code_help'</span>: {
                <span class="hljs-string">'description'</span>: <span class="hljs-string">'编程，代码'</span>,
                <span class="hljs-string">'handler'</span>: self.handle_code_question
            },
            <span class="hljs-string">'general_chat'</span>: {
                <span class="hljs-string">'description'</span>: <span class="hljs-string">'聊天，日常对话'</span>,
                <span class="hljs-string">'handler'</span>: self.handle_general_chat
            }
        }
        
        <span class="hljs-comment"># 预计算所有路由描述的嵌入向量</span>
        self.route_embeddings = {}
        <span class="hljs-keyword">for</span> route_name, route_info <span class="hljs-keyword">in</span> self.routes.items():
            embedding = self.model.encode([route_info[<span class="hljs-string">'description'</span>]])
            self.route_embeddings[route_name] = embedding
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">route_query</span>(<span class="hljs-params">self, user_question</span>):        
        <span class="hljs-comment"># 1. 将用户问题转换为嵌入向量</span>
        question_embedding = self.model.encode([user_question])
        
        <span class="hljs-comment"># 2. 使用余弦计算与各个路由的相似度</span>
        similarities = {}
        <span class="hljs-keyword">for</span> route_name, route_embedding <span class="hljs-keyword">in</span> self.route_embeddings.items():
            similarity = cosine_similarity(question_embedding, route_embedding)[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]
            similarities[route_name] = similarity
        
        <span class="hljs-comment"># 3. 选择相似度最高的路由</span>
        best_route = <span class="hljs-built_in">max</span>(similarities, key=similarities.get)
        best_score = similarities[best_route]
        
        <span class="hljs-comment"># 4. 调用对应的处理器</span>
        handler = self.routes[best_route][<span class="hljs-string">'handler'</span>]
        response = handler(user_question)
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'route'</span>: best_route,
            <span class="hljs-string">'confidence'</span>: best_score,
            <span class="hljs-string">'response'</span>: response
        }
        ....
</code></pre>
<p>•<strong>根据定义规则路由，</strong> 硬编码方式，根据关键词、模式或结构化数据进行路由。此方法比 LLM 路由更快、更确定，但灵活性较低。</p>
<p>•<strong>根据自训小模型路由</strong>，采用如分类器等判别模型，在小规模标注数据集上专门训练以实现路由任务。与向量嵌入方法类似，但其特点是监督微调过程，路由逻辑编码在模型权重中。与 LLM 路由不同，决策组件不是推理时执行提示的生成模型，而是已微调的判别模型。LLM 可用于生成合成训练数据，但不参与实时路由决策。</p>
<p>﻿</p>
<p><strong>3. 并行模式</strong></p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a0760cae984462cadb2725a22d3bd22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763539123&amp;x-signature=qxi9QKyJ2RbpwcrjpR2N2Mu9TZY%3D" alt="" loading="lazy"/></p>
<p>﻿每个智能体负责处理不同的子任务，例如数据爬虫、网络检索和摘要生成，它们的输出会合并为一个单一结果。非常适合减少高吞吐量管道中的延迟。（如文档解析或API编排）</p>
<p><strong>4. 循环模式</strong></p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1955d4f02b7d4832bb7df9d75a734473~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763539123&amp;x-signature=VoOMXFDXXhkRIQN5qguLzwOEzqo%3D" alt="" loading="lazy"/></p>
<p>﻿智能体不断优化自身输出，直到达到预期质量。非常适合校对、报告生成或创意迭代，在这些场景中，系统会在确定最终结果前再次思考。反思就是在此模式上进行的优化。</p>
<p>﻿</p>
<p><strong>5. 聚合模式</strong></p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef43677e09264f5d93d28a91a4ac7bbf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763539123&amp;x-signature=EjwIxrBOLC4qQaGsOQRrek2uVtg%3D" alt="" loading="lazy"/></p>
<p>﻿许多智能体生成部分结果，由主智能体将这些结果整合为一个最终输出。因此，每个智能体都形成一个观点，而一个Master智能体将这些观点汇总成共识。在RAG的检索融合、投票系统等场景中很常见。</p>
<p>﻿</p>
<p><strong>6. 网络模式</strong></p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95345f9fe471436a9c99c528aa81a938~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763539123&amp;x-signature=9SxdSimSZMh2BvR10DbqGZQMGpM%3D" alt="" loading="lazy"/></p>
<p>﻿这里没有明确的层级结构，智能体之间可以自由交流，动态共享上下文。用于模拟、多智能体游戏以及需要自由形式行为的集体推理系统中。<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fagentscope-ai%2Fagentscope-samples" target="_blank" title="https://github.com/agentscope-ai/agentscope-samples" ref="nofollow noopener noreferrer">agentscope-samples</a> ，模拟了9个智能体的狼人杀游戏。</p>
<p>﻿</p>
<p><strong>7. 层级模式</strong></p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0589f741bc64ec597857873ca2057ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763539123&amp;x-signature=dPpeTug9Eo2ZX1HGtj%2BTjWQVZf4%3D" alt="" loading="lazy"/></p>
<p>﻿一个顶级规划智能体，将子任务分配给工作智能体，跟踪它们的进度，并做出最终决策。这和经理及其团队的工作方式完全一样（很多中间件的架构也是类似这种模式如Redis、ES、Nocas）。意图识别就是采用此模式。</p>
<p>﻿</p>
<p><strong>小节：</strong></p>
<p>我们一直在思考的一件事，不是哪种模式看起来最酷，而是哪种模式能最大限度地减少智能体之间的摩擦。启动10个智能体并称之为一个团队很容易。难的是设计沟通流程，以确保：没有两个智能体会做重复工作。每个智能体都知道何时行动何时等待，使这个系统作为一个整体，比其任何单个部分都更智能。为此我们遵循 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fengineering%2Fbuilding-effective-agents" target="_blank" title="https://www.anthropic.com/engineering/building-effective-agents" ref="nofollow noopener noreferrer">building-effective-agents</a> 设计。</p>
<p>﻿</p>
<h2 data-id="heading-2">三、Multi-Agent 框架</h2>
<p>多智能体模式将人工智能工作流构建为一个智能体团队，它们相互协作，每个智能体都有明确的角色。每个智能体能够感知输入、进行推理（通过思维链）并执行操作以完成子任务。每个智能体通常都配置有特定角色，并且只能访问该角色所需的工具或信息。例如，PM AGent负责需求判断是否需要其他智能体参与，若需要技术决策则联动Tech lead agent。智能体将循环进行思考（“思考……”）和行动（“行动……”），直到完成其工作部分的任务。如下图</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0f5f3041605465fba6a5713fdadcf5d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763539123&amp;x-signature=W6NDveQJo3JrhBxAHr%2F3vBGgjnU%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<p>以上简单介绍了多智能体的设计模式，那么当下是不是已经有了成熟的架构供我们使用呢？答案是肯定的！</p>
<p>﻿</p>
<p><strong>1.AutoGPT：</strong> Github 180k Star</p>
<p><strong>2.Dify：</strong> Github 118k Star</p>
<p><strong>3.AutoGen：</strong> Github 51.4k Star</p>
<p><strong>4.CrewAI：</strong> Github 40.1k Star</p>
<p>5.<strong>LangGraph：</strong> Github 20.6k Star</p>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/193b057d5e6c4c5291851bb8e91ced89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763539123&amp;x-signature=%2BztdFmyc0IR%2FgxuPsUgWJIvlVFo%3D" alt="" loading="lazy"/></p>
<p>﻿﻿</p>
<h3 data-id="heading-3"><strong>为什么需要使用Agent框架？</strong></h3>
<p>只要“问题不可完全穷举、要跨多系统查证、并且需要在对话中澄清、协商、决策”，就更应该用 Agent 框架，而不是纯 Workflow。</p>
<h3 data-id="heading-4"><strong>纯 Workflow 的“天花板”</strong></h3>
<p>Workflow 在<strong>对话中的“澄清—再决策—再行动”</strong> 并不天然友好，需要把每一步提问、回答、重试都画成节点，复杂而脆弱。</p>
<p><strong>场景</strong>：用户发起：“我的包裹还没到，怎么办？”</p>
<p>通过Workflow创建如下智能体：(先不期待GPT-6 会自主思考的智能体)</p>
<p>•<strong>意图识别智能体</strong>：识别用户诉求（查询进度/催促/投诉/报损/退货等）</p>
<p>•<strong>物流状态智能体</strong>：实时拉取承运商状态，判断包裹位置、异常</p>
<p>•<strong>政策规则智能体</strong>：查询当前时段政策（节假日、大促、平日），判断是否特殊处理</p>
<p>•<strong>用户画像智能体</strong>：判断用户等级、历史行为、是否会员</p>
<p>•<strong>异常检测智能体</strong>：分析是否有报损、拒收、欺诈等信号</p>
<p>•<strong>澄清与补充智能体</strong>：信息不全时自动向用户提问，补齐决策所需信息</p>
<p>•<strong>解决方案生成智能体</strong>：综合所有智能体结果，输出最优处理方案（比如：建议等待/补发/赔偿/升级处理/转人工等）</p>
<p>智能体数量✖️物流状态✖️用户等级✖️物流政策....你的分支会爆炸。所以需要用Dify这类的可以支持动态决策，动态推理和澄清的智能体框架。</p>
<p>﻿</p>
<h3 data-id="heading-5"><strong>Agent 框架解决的核心问题</strong></h3>
<p>以 AutoGen、CrewAI 这类 Agent 框架为例，它们把“<strong>在对话里动态规划与调用工具</strong>”作为第一性能力：</p>
<p><strong>场景：</strong> 用户说“我10.1买的手机现在还没到，给我退货！另外，你们的运费险的保账期是多久？”</p>
<p>一个合格的客服 Agent 团队会做什么？</p>
<p><strong>没有路由决策</strong>，首先会动态匹配所有Query，对Query进行改写成“查询用户的订单”，“用户想要退货”，“运费险的保账范围和条款”。</p>
<p>1.<strong>意图识别 + 澄清</strong></p>
<p>◦ Planner Agent：拆出多意图（物流异常、退货、计费异常、运费险条款），先问关键（订单号、地址）。</p>
<p>2.<strong>跨系统取证</strong></p>
<p>◦ OMS/物流工具：查轨迹与 SLA；</p>
<p>◦ 计费/支付工具：核对重复扣款交易；</p>
<p>◦ CRM：看是否 Plus、是否有历史补偿记录；</p>
<p>◦保库：查询运费险</p>
<p>3.<strong>政策推理与合规</strong></p>
<p>Policy Agent：套用“假期延误 + Plus + 运费险”的组合条款，评估可给的补偿区间、是否触发风控人工复核。</p>
<p>这些动作里，很多步骤<strong>无法事先“画”成固定分支，需要在对话上下文里做决策、需要跨工具动态组合、需要“问一句 → 查一下 → 再决定”，</strong> 这正是 Agent 的强项。</p>
<p>﻿</p>
<h2 data-id="heading-6">结尾：</h2>
<p>以上是对多智能体的总结，你会了吗？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TypeScript超越Python成GitHub上使用最广语言，AI是主要驱动力]]></title>    <link>https://juejin.cn/post/7571475192490295306</link>    <guid>https://juejin.cn/post/7571475192490295306</guid>    <pubDate>2025-11-12T09:04:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571475192490295306" data-draft-id="7571655312798171162" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TypeScript超越Python成GitHub上使用最广语言，AI是主要驱动力"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-11-12T09:04:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TypeScript超越Python成GitHub上使用最广语言，AI是主要驱动力
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T09:04:38.000Z" title="Wed Nov 12 2025 09:04:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>开发者最常使用的编程语言是什么？相信很多人都会不假思索地选择 Python。</p>
<p>但 GitHub 近日发布的《Octoverse 2025》报告却给出了一个不一样的答案：TypeScript。</p>
<p>根据 GitHub 的贡献者数量统计，2025 年 8 月，Python 的贡献者数量在连续霸榜 16 个月之后首次跌落到第二名，TypeScript 首次成为 GitHub 上使用最广泛的语言，以约 4.2 万名贡献者的优势超越了 Python。JavaScripst 紧随其后，四五六名则是名次超级稳定的 Java、C# 和 PHP。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a78c13b18c034bde939ea3b702cc65c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543078&amp;x-signature=3FWnQTCDLZGKBqoauiKFYcI8Cwk%3D" alt="图片" loading="lazy"/></p>
<p>GitHub 报告表示：「这一里程碑事件是过去十年来开发者转向类型化 JavaScript （typed JavaScript）趋势的集中体现，也标志着 TypeScript 正在成为现代开发的新默认选项。」</p>
<p>更具体而言，TypeScript 在 2025 年的贡献者数量增长了超过 100 万（同比增长 66%）。其主要驱动力一方面来自那些默认使用 TypeScript 搭建项目的开发框架，另一方面则来自 AI 辅助开发，因为 TypeScript 那更严格的类型系统让 AI 辅助开发受益匪浅。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f745b4b83156408a88b9a6a308db9f81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543078&amp;x-signature=oRVyGn%2BJQ%2BuMn3xdIfoZz5DOk0w%3D" alt="图片" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aef8b7ae56c64884914638c3d5b6362f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543078&amp;x-signature=8MyB91zT9vAnDePXEZAnrJGzGMI%3D" alt="图片" loading="lazy"/></p>
<p>不过，GitHub 也指出，Python 在 AI 和数据科学领域仍然保持着主导地位，拥有 260 万贡献者（同比增长 48%）。Jupyter Notebook 依旧是 AI 领域的首选探索性环境（相关仓库约 40.3 万个；在 AI 标签的项目中，同比增长 17.8%）。</p>
<p>JavaScript 的贡献者体量依然庞大（215 万），但随着开发者逐渐转向 TypeScript，其增长已经放缓。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/414165e754e64543a4210d5c3922e084~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543078&amp;x-signature=GA6Nh9Bngp0C%2Bp3XIQSg3hDZj0c%3D" alt="图片" loading="lazy"/></p>
<p>总而言之，TypeScript 和 Python 两者目前共拥有超过 520 万贡献者（约占 2025 年 8 月 GitHub 所有活跃开发者的 3%）。类型化语言的崛起表明：AI 不仅在改变编码的速度，同时也在影响开发团队在「信任并采纳 AI 生成的代码进入生产环境」时，会选择哪些语言。</p>
<p>另外，根据 GitHub 统计，过去 12 月新增的软件库有 80% 都集中在 6 大核心语言：Python、JavaScript、TypeScript、Java、C++ 和 C#。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34552d8d25b442b5a1457b5b1ed33857~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543078&amp;x-signature=g5v3STkX5s1FL%2BuoI%2B3nzVUneGI%3D" alt="图片" loading="lazy"/></p>
<p>为什么 TypeScript 在 2025 年胜出？</p>
<p>TypeScript 在 2025 年 8 月以 2,636,006 名月度贡献者（同比增长 105 万；+66.6%）的成绩在 GitHub 上排名第一，并在新增仓库数量上处于领先地位。</p>
<p>原因是「类型（Type）」对 AI 系统的辅助：类型系统可减少代码的模糊性，并在（AI 生成的）代码进入生产环境前提早捕获大型语言模型（LLM）的错误。</p>
<p>另外，许多框架也默认内置 TypeScript。 Next.js 15、Astro 3、SvelteKit 2、Qwik、SolidStart、Angular 18 和 Remix 均默认（通过 npm create、pnpm dlx 或 bunx create 命令）生成 TypeScript 代码库。</p>
<p>并且类型系统也有助于在开发流程中更早地识别 LLM 生成的编译错误。2025 年的一项学术研究发现，LLM 生成的编译错误中有 94% 是类型检查失败。</p>
<p>TypeScript 的入门门槛也比较低。诸如 Vite、ts-node、Bun 和 IDE 自动配置等工具隐藏了（繁琐的）样板文件（boilerplate），因此初级开发者也可以快速启动类型化的技术栈。</p>
<p>Python 依然主导 AI 项目</p>
<p>即便 TypeScript 崛起了，但在所有 AI 标签的仓库中，Python 仍然是当之无愧的领导者。其中，Jupyter Notebook 的使用量在 2025 年几乎翻了一番，这充分证明了 Python 作为 AI 工作负载原型设计、模型训练和任务编排的首选语言的地位。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ef57a2655a24a8aa19cbe70574fb4c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543078&amp;x-signature=azUWDegf1tOZvjlUzvOLgPkbnnc%3D" alt="图片" loading="lazy"/></p>
<p>具体来看，Python 驱动了近一半的新增 AI 仓库（582,196 个；同比增长 50.7%），突显了它作为应用型 AI 工作（从训练、推理到编排和部署）的支柱地位。Jupyter Notebook 依旧是用于实验的首选探索性环境（402,643 个；同比增长 17.8%），但（贡献者）向 Python 代码库的转移表明，有更多项目正在摆脱原型阶段，进入生产技术栈。</p>
<p>前端和应用层语言在较小的基数上实现了急剧增长：TypeScript 增长 77.9%（85,746 个）和 JavaScript 增长 24.8%（88,023 个）。</p>
<p>这表明围绕模型 API 接口（model endpoints）构建的演示、仪表盘和轻量级应用正在崛起。</p>
<p>Shell 脚本（+324%）成为增长最快的类别，反映了团队如何将评估工具、数据准备和部署流程代码化。C++ 则跨越了 7,800 个仓库（+11%），稳步提醒着人们它在性能攸关的推理引擎、运行时和近硬件（hardware-close）系统中所扮演的角色。</p>
<p>其它趋势和要点</p>
<p>GitHub 还在报告中总结了其它一些趋势和要点。</p>
<p>今年，开源开发活动达到了创纪录的水平，公共仓库的贡献总量达到了 11.2 亿次（同比增长 13%）。2025 年 3 月是 GitHub 历史上新增开源贡献者数量最多的一个月。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/972ce7ee040e4209ae61732281bb83dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543078&amp;x-signature=0YT7Ip2cUJTj2%2BwDn6sy%2BZraIZg%3D" alt="图片" loading="lazy"/></p>
<p>印度增长迅猛，该国在 2025 年新增了超过 520 万名开发者，占 GitHub 2025 年新增 3600 万开发者总数的 14% 以上。这使得印度成为今年 GitHub 上新增开发者的最大单一来源国，延续了其自 2020 年以来的迅猛增长势头。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/044518fb4b7f4293a3dc007e03032572~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543078&amp;x-signature=5ZKOxe7VelgOa6b%2BPBeowWCm1Ro%3D" alt="图片" loading="lazy"/></p>
<p>企业级技术栈保持稳固。Java 和 C# 今年的贡献者均增长了超过 10 万人，这表明即便 AI 正在重塑整个行业格局，它们在大型企业和游戏开发（game-dev）环境中的增长依旧稳定。</p>
<p>旧语言的实验性项目涌现。COBOL 语言也出现在 GitHub 的数据集中，拥有近 3,000 名活跃开发者。这很可能是由一些组织和爱好者所推动的，他们创建了许多 AI 辅助的教程仓库，旨在帮助实现遗留代码库的现代化。</p>
<p>性能和系统语言正随 AI 崛起（但增长不均）。C 语言同比增长约 20.9%，C++ 同比增长约 11.8%，这反映了市场对更快的运行时、推理引擎和硬件优化 Loop 的需求。</p>
<p>生成式 AI 正日益成为基础设施。现在有超过 110 万个公开仓库导入了 LLM SDK（同比增长 178%，对比 2025 年 8 月与 2024 年 8 月），由超过 105 万名贡献者支持，月度提交量（monthly commits）达到 175 万次（自 2023 年以来增长了 4.8 倍）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c478c4418f7414ca293723326c08c1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543078&amp;x-signature=8bz9rgrZ86oy4l%2FqDFwJ7AWdfv0%3D" alt="图片" loading="lazy"/></p>
<p>AI 在开源领域的应用。半数（50%）的开源项目至少有一名维护者（maintainer）在使用 GitHub Copilot。</p>
<p>.NET 保持强劲。 C# 同比增长约 10.6%，与企业级和游戏 / 工具生态系统的（增长）保持一致。这表明 AI 功能正被集成到现有的 .NET 工作流中，而不是在驱动（开发者）进行彻底的语言转移。</p>
<p>增长最快的语言是 Luau。Luau 是 Roblox 的脚本语言，也是一个逐步类型化的语言，体现了整个行业向「类型灵活性」发展的趋势。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f0865434aae4981aca662a27f42720c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543078&amp;x-signature=QDk0hQCwE%2FYj7zsfQyFymrIYd40%3D" alt="图片" loading="lazy"/></p>
<p>可复现性和依赖清洁（dependency hygiene）备受关注。 astral-sh/uv 和 NixOS/nixpkgs 的崛起，表明开发者对确定性构建（deterministic builds）、更快的安装速度以及直接运行的渴望。</p>
<p>以性能为中心的开发者工具赢得关注。 Ghostty、Tailwind CSS 和 uv 的共同点都是关于速度、紧凑的反馈循环和最小化的（开发）阻力。</p>
<p>更多详情请参阅原报告：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca37bce31fe84f9e93b46b3cce384bed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543078&amp;x-signature=iJ%2BW%2B7k9Qs8wqPnDl6y%2BnG7EEAk%3D" alt="图片" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.blog%2Fnews-insights%2Foctoverse%2Foctoverse-a-new-developer-joins-github-every-second-as-ai-leads-typescript-to-1%2F" target="_blank" title="https://github.blog/news-insights/octoverse/octoverse-a-new-developer-joins-github-every-second-as-ai-leads-typescript-to-1/" ref="nofollow noopener noreferrer">github.blog/news-insigh…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[最新MCP规范解读，看这篇就够了！]]></title>    <link>https://juejin.cn/post/7571456639477006346</link>    <guid>https://juejin.cn/post/7571456639477006346</guid>    <pubDate>2025-11-12T07:59:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571456639477006346" data-draft-id="7571416207972499506" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="最新MCP规范解读，看这篇就够了！"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-11-12T07:59:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            最新MCP规范解读，看这篇就够了！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T07:59:53.000Z" title="Wed Nov 12 2025 07:59:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读26分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、MCP是什么? 为什么需要它?</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d67c9ad979a2434989229286027f7185~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763539193&amp;x-signature=AvWJDuUolC0sslAql0%2FE8bjN4jg%3D" alt="" loading="lazy"/><br/>
想象一下，你正在开发一个 AI 编程助手，它需要:</p>
<ul>
<li>读取和修改项目文件</li>
<li>查询数据库Schema</li>
<li>搜索代码仓库</li>
<li>执行Git操作</li>
</ul>
<p>传统做法是为每个数据源写一套专用代码，不同团队重复造轮子。<strong>Model Context Protocol(MCP)</strong> 就是为了解决这个问题而生的开放标准协议。</p>
<p><strong>通俗理解</strong>: MCP就像是「AI应用的USB接口标准」。就像USB让不同设备都能接入电脑一样，MCP让不同的数据源和工具都能以统一方式接入AI应用。</p>
<p><strong>实际案例</strong>: 在Claude Desktop中，你可以配置多个官方MCP服务器:</p>
<ul>
<li><strong>Filesystem服务器</strong>: 安全地读写本地文件，有权限控制</li>
<li><strong>SQLite服务器</strong>: 查询和分析SQLite数据库，自动生成SQL</li>
<li><strong>GitHub服务器</strong>: 搜索仓库、创建Issue、管理PR</li>
</ul>
<p>你的AI应用只需实现一个MCP客户端，就能连接所有服务器，无需为每个服务器写专用代码。</p>
<h2 data-id="heading-1">二、架构设计： 三个角色的分工</h2>
<p>MCP采用<strong>宿主-客户端-服务器</strong>三层架构，就像一家公司的组织结构:</p>
<p><strong>宿主(Host)</strong> = 总经理</p>
<ul>
<li>管理所有客户端</li>
<li>控制安全策略和权限</li>
<li>负责AI模型的调用</li>
</ul>
<p><strong>客户端(Client)</strong> = 部门经理</p>
<ul>
<li>客户端负责连接服务器</li>
<li>负责双方的沟通协调</li>
<li>转发消息和通知</li>
</ul>
<p><strong>服务器(Server)</strong> = 业务专员</p>
<ul>
<li>提供具体功能(资源、工具、提示模板)</li>
<li>可以是本地程序或远程服务</li>
<li>不知道其他服务器的存在</li>
</ul>
<h2 data-id="heading-2">三、协议约定：统一规范与个性化扩展</h2>
<p><strong>每个MCP服务器提供的工具、资源都不一样，但它们都遵循相同的MCP协议规范。</strong></p>
<h3 data-id="heading-3">3.1 协议的分层设计</h3>
<p>MCP采用 <strong>基础协议 + 功能扩展</strong> 的设计，就像HTTP协议一样:</p>
<p><strong>核心层(所有实现必须支持)</strong> :</p>
<ul>
<li>JSON-RPC 2.0消息格式</li>
<li>初始化握手流程(initialize/initialized)</li>
<li>基本错误处理</li>
</ul>
<p><strong>功能层(按需选择)</strong> :</p>
<ul>
<li>Resources、Prompts、Tools(服务器端)</li>
<li>Roots、Sampling、Elicitation(客户端)</li>
</ul>
<p><strong>这样设计的好处</strong>:</p>
<pre><code class="hljs language-markdown" lang="markdown">统一的基础协议 → 保证互操作性
<span class="hljs-bullet">     +</span>
灵活的功能选择 → 满足不同场景需求
<span class="hljs-code">     ↓
既标准化又可扩展
</span></code></pre>
<h3 data-id="heading-4">3.2 协议约定的过程</h3>
<p><strong>步骤1: 基础协议是固定的</strong><br/>
所有MCP服务器和客户端都遵循相同的JSON-RPC 2.0格式:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 请求格式(固定)</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// 必须是2.0</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>                <span class="hljs-comment">// 唯一标识</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"方法名"</span><span class="hljs-punctuation">,</span>     <span class="hljs-comment">// 要调用的方法</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>...<span class="hljs-punctuation">}</span>         <span class="hljs-comment">// 参数对象</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// 响应格式(固定)</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>                <span class="hljs-comment">// 对应请求的ID</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>...<span class="hljs-punctuation">}</span>         <span class="hljs-comment">// 成功结果</span>
  <span class="hljs-comment">// 或 "error": {...}    // 错误信息</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>步骤2: 能力在初始化时协商</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 客户端发起初始化</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"initialize"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"capabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"sampling"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>       <span class="hljs-comment">// 我支持LLM采样</span>
      <span class="hljs-attr">"roots"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>           <span class="hljs-comment">// 我支持根目录</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"clientInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MyClient"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.0"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// 服务器响应</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"capabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>          <span class="hljs-comment">// 我提供工具</span>
      <span class="hljs-attr">"resources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>       <span class="hljs-comment">// 我提供资源</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"serverInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"SQLiteServer"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>协商完成后，双方都知道对方支持什么功能，<strong>只使用交集部分</strong>。</p>
<p><strong>步骤3: 方法名称是标准化的</strong><br/>
MCP规范定义了标准方法名:</p>








































<table><thead><tr><th>功能</th><th>方法名</th><th>说明</th></tr></thead><tbody><tr><td>列出资源</td><td><code>resources/list</code></td><td>固定方法名</td></tr><tr><td>读取资源</td><td><code>resources/read</code></td><td>固定方法名</td></tr><tr><td>列出工具</td><td><code>tools/list</code></td><td>固定方法名</td></tr><tr><td>调用工具</td><td><code>tools/call</code></td><td>固定方法名</td></tr><tr><td>列出提示</td><td><code>prompts/list</code></td><td>固定方法名</td></tr><tr><td>获取提示</td><td><code>prompts/get</code></td><td>固定方法名</td></tr></tbody></table>
<p><strong>步骤4: 具体内容是个性化的</strong><br/>
虽然方法名固定，但每个服务器返回的<strong>具体数据</strong>不同:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// SQLite服务器的工具</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"query"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"执行SQL查询"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"list_tables"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"列出所有表"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// Filesystem服务器的工具</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"read_file"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"读取文件"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"write_file"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"写入文件"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"search_files"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"搜索文件"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-5">3.3 协议发现机制</h3>
<p>客户端如何知道服务器有哪些工具?</p>
<p><strong>第一步：列举</strong></p>
<pre><code class="hljs language-css" lang="css">客户端 → 服务器: {"method": <span class="hljs-string">"tools/list"</span>}
服务器 → 客户端: {
  "tools": [
    {
      "name": <span class="hljs-string">"query"</span>,
      <span class="hljs-string">"description"</span>: <span class="hljs-string">"执行SQL查询"</span>,
      <span class="hljs-string">"inputSchema"</span>: {           // JSON Schema定义输入格式
        "type": <span class="hljs-string">"object"</span>,
        <span class="hljs-string">"properties"</span>: {
          "sql": {"type": <span class="hljs-string">"string"</span>}
        }
      }
    }
  ]
}
</code></pre>
<p><strong>第二步：调用</strong></p>
<pre><code class="hljs language-json" lang="json">客户端 → 服务器<span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tools/call"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"query"</span><span class="hljs-punctuation">,</span>           <span class="hljs-comment">// 使用第一步获得的工具名</span>
    <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"sql"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"SELECT * FROM users"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>关键点</strong>:通过JSON Schema，客户端知道如何正确调用工具，无需硬编码。</p>
<h2 data-id="heading-6">四、协议基础：如何通信?</h2>
<p>MCP基于JSON-RPC 2.0构建，这是一个成熟的远程过程调用协议。理解这一层对掌握MCP至关重要。</p>
<h3 data-id="heading-7">4.1 JSON-RPC 2.0基础</h3>
<p><strong>消息类型</strong></p>
<p>MCP中有三种基本消息类型。<br/>
<strong>1. 请求(Request)</strong> - 期待响应</p>
<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>,           <span class="hljs-regexp">//</span> 协议版本,必须是<span class="hljs-string">"2.0"</span>
  <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,                     <span class="hljs-regexp">//</span> 请求唯一标识(字符串或数字)
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"tools/list"</span>,     <span class="hljs-regexp">//</span> 要调用的方法名
  <span class="hljs-string">"params"</span>: {                  <span class="hljs-regexp">//</span> 可选的参数对象
    <span class="hljs-string">"cursor"</span>: <span class="hljs-string">"page2"</span>
  }
}
</code></pre>
<p><strong>2. 响应(Response)</strong> - 对请求的回复</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 成功响应</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>                     <span class="hljs-comment">// 必须与请求的id相同</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                  <span class="hljs-comment">// 成功结果</span>
    <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"query"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"执行查询"</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// 错误响应</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"error"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                   <span class="hljs-comment">// 错误对象</span>
    <span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">-32602</span><span class="hljs-punctuation">,</span>            <span class="hljs-comment">// 错误码(整数)</span>
    <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"参数无效"</span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// 错误描述</span>
    <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                  <span class="hljs-comment">// 可选的额外信息</span>
      <span class="hljs-attr">"field"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"cursor"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"reason"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"格式错误"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>3. 通知(Notification)</strong> - 单向消息,无需响应</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"notifications/resources/updated"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 通知方法名</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                                   <span class="hljs-comment">// 通知参数</span>
    <span class="hljs-attr">"uri"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file:///project/data.json"</span>
  <span class="hljs-punctuation">}</span>
  <span class="hljs-comment">// 注意:没有id字段</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>标准错误码</strong></p>
<p>MCP使用JSON-RPC 2.0的标准错误码:</p>








































<table><thead><tr><th>错误码</th><th>含义</th><th>说明</th></tr></thead><tbody><tr><td>-32700</td><td>Parse error</td><td>JSON解析错误</td></tr><tr><td>-32600</td><td>Invalid Request</td><td>无效的请求格式</td></tr><tr><td>-32601</td><td>Method not found</td><td>方法不存在</td></tr><tr><td>-32602</td><td>Invalid params</td><td>参数无效</td></tr><tr><td>-32603</td><td>Internal error</td><td>服务器内部错误</td></tr><tr><td>-32002</td><td>Resource not found</td><td>资源未找到(MCP扩展)</td></tr></tbody></table>
<h3 data-id="heading-8">4.2 能力协商详解</h3>
<p>能力协商是MCP连接建立的第一步，决定了整个会话中可用的功能。</p>
<p><strong>初始化流程详解</strong></p>
<p><strong>阶段1: 客户端发起初始化</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"initialize"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 客户端支持的协议版本</span>
    <span class="hljs-attr">"capabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                  <span class="hljs-comment">// 客户端能力声明</span>
      <span class="hljs-attr">"roots"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                       <span class="hljs-comment">// 支持根目录</span>
        <span class="hljs-attr">"listChanged"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>            <span class="hljs-comment">// 支持根目录变更通知</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"sampling"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>                  <span class="hljs-comment">// 支持LLM采样</span>
      <span class="hljs-attr">"elicitation"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>               <span class="hljs-comment">// 支持用户询问</span>
      <span class="hljs-attr">"experimental"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                <span class="hljs-comment">// 实验性功能</span>
        <span class="hljs-attr">"customFeature"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>            <span class="hljs-comment">// 自定义功能</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"clientInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                    <span class="hljs-comment">// 客户端信息</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"MyAIApp"</span><span class="hljs-punctuation">,</span>               <span class="hljs-comment">// 程序名(必填)</span>
      <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.2.0"</span><span class="hljs-punctuation">,</span>              <span class="hljs-comment">// 版本号(必填)</span>
      <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我的AI应用"</span>             <span class="hljs-comment">// 显示名称(可选)</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>阶段2: 服务器响应能力</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 服务器选择的协议版本</span>
    <span class="hljs-attr">"capabilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                  <span class="hljs-comment">// 服务器能力声明</span>
      <span class="hljs-attr">"resources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                   <span class="hljs-comment">// 支持资源</span>
        <span class="hljs-attr">"subscribe"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>             <span class="hljs-comment">// 支持资源订阅</span>
        <span class="hljs-attr">"listChanged"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>            <span class="hljs-comment">// 支持资源列表变更通知</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"tools"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                       <span class="hljs-comment">// 支持工具</span>
        <span class="hljs-attr">"listChanged"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"prompts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                     <span class="hljs-comment">// 支持提示模板</span>
        <span class="hljs-attr">"listChanged"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>           <span class="hljs-comment">// 不支持列表变更通知</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"logging"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-punctuation">}</span>                    <span class="hljs-comment">// 支持日志输出</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"serverInfo"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>                    <span class="hljs-comment">// 服务器信息</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sqlite-mcp-server"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"version"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.1.0"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"SQLite MCP服务器"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"instructions"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"此服务器提供SQLite数据库访问能力"</span>  <span class="hljs-comment">// 可选的使用说明</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>阶段3: 客户端确认就绪</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"notifications/initialized"</span>  <span class="hljs-comment">// 无id,这是通知</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>协议版本协商规则</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">客户端请求版本: <span class="hljs-string">"2024-11-05"</span>
         ↓
    服务器支持?
    ↙        ↘
  支持        不支持
   ↓            ↓
返回相同版本  返回服务器支持的最新版本
   ↓            ↓
协商成功    客户端检查是否支持
              ↙        ↘
           支持        不支持
            ↓            ↓
         协商成功     断开连接
</code></pre>
<p><strong>实际示例</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 场景1: 版本匹配</span>
客户端<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span>
服务器<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span>  ✅ 成功

<span class="hljs-comment">// 场景2: 服务器版本更新</span>
客户端<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-06-01"</span>
服务器<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span>  
→ 客户端检查是否支持<span class="hljs-number">2024</span><span class="hljs-number">-11</span><span class="hljs-number">-05</span> → 如果不支持则断开

<span class="hljs-comment">// 场景3: 客户端版本更新</span>
客户端<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-01-01"</span>
服务器<span class="hljs-punctuation">:</span> <span class="hljs-attr">"protocolVersion"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2024-11-05"</span>  
→ 客户端检查是否支持<span class="hljs-number">2024</span><span class="hljs-number">-11</span><span class="hljs-number">-05</span> → 如果支持则降级使用
</code></pre>
<p><strong>能力交集计算</strong></p>
<p>初始化后,双方只能使用<strong>共同支持的能力</strong>:</p>
<pre><code class="hljs language-css" lang="css">客户端能力: {roots, sampling, elicitation}
服务器能力: {resources, tools, prompts}
         ↓
   可用功能集合
   ├─ 客户端 → 服务器: resources, tools, prompts
   └─ 服务器 → 客户端: roots, sampling, elicitation
</code></pre>
<p><strong>示例</strong>:</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 客户端代码示例</span>
<span class="hljs-keyword">if</span> server_capabilities.<span class="hljs-keyword">get</span>(<span class="hljs-string">"tools"</span>):
    <span class="hljs-meta"># 服务器支持工具,可以调用</span>
    tools = <span class="hljs-keyword">await</span> session.list_tools()
<span class="hljs-keyword">else</span>:
    <span class="hljs-meta"># 服务器不支持工具,跳过</span>
    print(<span class="hljs-string">"服务器不提供工具功能"</span>)

<span class="hljs-keyword">if</span> client_capabilities.<span class="hljs-keyword">get</span>(<span class="hljs-string">"sampling"</span>):
    <span class="hljs-meta"># 客户端支持采样,服务器可以请求</span>
    <span class="hljs-meta"># (服务器端会检查这个能力)</span>
    pass
</code></pre>
<h3 data-id="heading-9">4.3 连接生命周期深入</h3>
<p><strong>完整的消息时序图</strong></p>
<pre><code class="hljs language-scss" lang="scss">客户端                                            服务器
  │                                              │
  │  <span class="hljs-number">1</span>. initialize (请求)                         │
  ├──────────────────────────────────────&gt;│
  │     {protocolVersion, capabilities}          │
  │                                              │
  │  <span class="hljs-number">2</span>. initialize (响应)                         │
  │&lt;──────────────────────────────────────┤
  │     {protocolVersion, capabilities}          │
  │                                              │
  │  <span class="hljs-number">3</span>. initialized (通知)                        │ 
  ├──────────────────────────────────────&gt;│
  │                                              │
  │═══════════ 正常操作阶段 ════════════        │
  │                                              │
  │  <span class="hljs-number">4</span>. tools/list (请求)                         │
  ├──────────────────────────────────────&gt;│
  │                                              │
  │  <span class="hljs-number">5</span>. tools/list (响应)                         │
  │&lt;──────────────────────────────────────┤
  │     {tools: [...]}                           │
  │                                              │
  │  <span class="hljs-number">6</span>. tools/call (请求)                         │
  ├──────────────────────────────────────&gt;│
  │     {name: <span class="hljs-string">"query"</span>, arguments: {...}}        │
  │                                              │
  │  <span class="hljs-number">7</span>. notifications/progress (通知)             │
  │&lt;──────────────────────────────────────┤
  │     {progress: <span class="hljs-number">50</span>, total: <span class="hljs-number">100</span>}               │
  │                                              │
  │  <span class="hljs-number">8</span>. tools/call (响应)                         │
  │&lt;──────────────────────────────────────┤
  │     {<span class="hljs-attribute">content</span>: [...]}                         │
  │                                              │
  │  <span class="hljs-number">9</span>. notifications/resources/updated          │
  │&lt;──────────────────────────────────────┤
  │     {uri: <span class="hljs-string">"file://..."</span>}                      │
  │                                              │
  │═══════════ 关闭阶段 ═══════════           │
  │                                              │
  │  <span class="hljs-number">10</span>. 关闭stdin                               │
  ├─────────────X                             │
  │                                             │
  │                                          服务器退出
</code></pre>
<p><strong>初始化前的限制</strong></p>
<p>在<code>initialized</code>通知发送前:</p>
<p><strong>客户端只能发送</strong>:</p>
<ul>
<li>✅ <code>initialize</code>请求</li>
<li>✅ <code>ping</code>请求(用于保活)</li>
<li>❌ 其他任何请求</li>
</ul>
<p><strong>服务器只能发送</strong>:</p>
<ul>
<li>✅ <code>initialize</code>响应</li>
<li>✅ <code>ping</code>请求</li>
<li>✅ <code>logging</code>通知(日志)</li>
<li>❌ 其他任何消息</li>
</ul>
<p><strong>违反限制的后果</strong>:</p>
<pre><code class="hljs language-css" lang="css">// 客户端在初始化前调用tools/list
请求: {"method": <span class="hljs-string">"tools/list"</span>}
响应: {
  "error": {
    "<span class="hljs-selector-tag">code</span>": -<span class="hljs-number">32600</span>,
    <span class="hljs-string">"message"</span>: <span class="hljs-string">"会话未初始化"</span>
  }
}
</code></pre>
<p><strong>超时和重试机制</strong></p>
<p><strong>请求超时</strong>:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio

<span class="hljs-comment"># 设置30秒超时</span>
<span class="hljs-keyword">try</span>:
    result = <span class="hljs-keyword">await</span> asyncio.wait_for(
        session.call_tool(<span class="hljs-string">"slow_operation"</span>, {}),
        timeout=<span class="hljs-number">30.0</span>
    )
<span class="hljs-keyword">except</span> asyncio.TimeoutError:
    <span class="hljs-comment"># 发送取消通知</span>
    <span class="hljs-keyword">await</span> session.send_notification(
        <span class="hljs-string">"notifications/cancelled"</span>,
        {<span class="hljs-string">"requestId"</span>: <span class="hljs-string">"123"</span>, <span class="hljs-string">"reason"</span>: <span class="hljs-string">"超时"</span>}
    )
</code></pre>
<p><strong>进度通知重置超时</strong>:</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 当收到进度通知时,可以重置超时计时器</span>
<span class="hljs-attr">timeout</span> = <span class="hljs-number">30</span>  <span class="hljs-comment"># 基础超时</span>
<span class="hljs-attr">max_timeout</span> = <span class="hljs-number">300</span>  <span class="hljs-comment"># 最大超时(5分钟)</span>

while True:
    try:
        <span class="hljs-attr">msg</span> = await wait_for_message(timeout)
        if <span class="hljs-attr">msg.method</span> == <span class="hljs-string">"notifications/progress"</span>:
            <span class="hljs-comment"># 收到进度,重置超时</span>
            <span class="hljs-attr">timeout</span> = <span class="hljs-number">30</span>
    except TimeoutError:
        <span class="hljs-comment"># 超时处理</span>
        break
</code></pre>
<h3 data-id="heading-10">4.4 传输方式对比</h3>
<p><strong>stdio传输详解</strong></p>
<p><strong>优点</strong>:</p>
<ul>
<li>✅ 简单直接,适合本地开发</li>
<li>✅ 进程隔离,安全性好</li>
<li>✅ 自动管理生命周期</li>
<li>✅ 无需网络配置</li>
</ul>
<p><strong>缺点</strong>:</p>
<ul>
<li>❌ 只能本地使用</li>
<li>❌ 不支持多客户端</li>
<li>❌ 调试相对困难</li>
</ul>
<p><strong>消息格式</strong>:</p>
<pre><code class="hljs">消息1\n
消息2\n
消息3\n
</code></pre>
<p>每个JSON对象占一行,以<code>\n</code>分隔。</p>
<p><strong>HTTP传输详解</strong></p>
<p><strong>架构</strong>:</p>
<pre><code class="hljs language-bash" lang="bash">┌─────────┐         HTTP POST         ┌─────────┐
│         ├──────────────────────────&gt;│         │
│ 客户端  │  请求/通知/响应(JSON-RPC) │ 服务器  │
│         │&lt;──────────────────────────┤         │
└─────────┘     HTTP 响应/SSE流       └─────────┘
             (application/json 或
              text/event-stream)
</code></pre>
<p><strong>发送消息(POST)</strong> :</p>
<pre><code class="hljs language-bash" lang="bash">POST /mcp HTTP/1.1
Host: localhost:8080
Content-Type: application/json
Accept: application/json, text/event-stream
Mcp-Session-Id: abc123

{<span class="hljs-string">"jsonrpc"</span>:<span class="hljs-string">"2.0"</span>,<span class="hljs-string">"id"</span>:1,<span class="hljs-string">"method"</span>:<span class="hljs-string">"tools/list"</span>}
</code></pre>
<p><strong>立即响应(JSON)</strong> :</p>
<pre><code class="hljs language-css" lang="css">HTTP/<span class="hljs-number">1.1</span> <span class="hljs-number">200</span> OK
<span class="hljs-attribute">Content</span>-Type: application/json

{"jsonrpc":<span class="hljs-string">"2.0"</span>,<span class="hljs-string">"id"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"result"</span>:{"tools":[...]}}
</code></pre>
<p><strong>流式响应(SSE)</strong> :</p>
<pre><code class="hljs language-vbnet" lang="vbnet">HTTP/<span class="hljs-number">1.1</span> <span class="hljs-number">200</span> OK
Content-Type: <span class="hljs-keyword">text</span>/<span class="hljs-keyword">event</span>-stream
Mcp-Session-Id: abc123

<span class="hljs-symbol">id:</span> <span class="hljs-number">1</span>
<span class="hljs-symbol">data:</span> {<span class="hljs-string">"jsonrpc"</span>:<span class="hljs-string">"2.0"</span>,<span class="hljs-string">"method"</span>:<span class="hljs-string">"notifications/progress"</span>,<span class="hljs-string">"params"</span>:{<span class="hljs-string">"progress"</span>:<span class="hljs-number">25</span>}}

<span class="hljs-symbol">id:</span> <span class="hljs-number">2</span>  
<span class="hljs-symbol">data:</span> {<span class="hljs-string">"jsonrpc"</span>:<span class="hljs-string">"2.0"</span>,<span class="hljs-string">"method"</span>:<span class="hljs-string">"notifications/progress"</span>,<span class="hljs-string">"params"</span>:{<span class="hljs-string">"progress"</span>:<span class="hljs-number">50</span>}}

<span class="hljs-symbol">id:</span> <span class="hljs-number">3</span>
<span class="hljs-symbol">data:</span> {<span class="hljs-string">"jsonrpc"</span>:<span class="hljs-string">"2.0"</span>,<span class="hljs-string">"id"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"result"</span>:{<span class="hljs-string">"content"</span>:[...]}}
</code></pre>
<p><strong>接收服务器消息(GET)</strong> :</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">GET</span> /mcp HTTP/<span class="hljs-number">1.1</span>
<span class="hljs-symbol">Host:</span> localhost:<span class="hljs-number">8080</span>
<span class="hljs-symbol">Accept:</span> <span class="hljs-keyword">text</span>/<span class="hljs-keyword">event</span>-stream
Mcp-Session-Id: abc123
Last-<span class="hljs-keyword">Event</span>-ID: <span class="hljs-number">42</span>
</code></pre>
<p><strong>会话管理</strong>:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 服务器端设置会话ID</span>
<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/mcp"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">handle_mcp</span>(<span class="hljs-params">request</span>):
    <span class="hljs-keyword">if</span> request.method == <span class="hljs-string">"initialize"</span>:
        session_id = generate_session_id()
        <span class="hljs-keyword">return</span> Response(
            content=json.dumps(result),
            headers={<span class="hljs-string">"Mcp-Session-Id"</span>: session_id}
        )

<span class="hljs-comment"># 客户端后续请求携带会话ID</span>
<span class="hljs-meta">@client.request</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">send_request</span>(<span class="hljs-params">method, params</span>):
    headers = {}
    <span class="hljs-keyword">if</span> self.session_id:
        headers[<span class="hljs-string">"Mcp-Session-Id"</span>] = self.session_id
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> http.post(
        <span class="hljs-string">"/mcp"</span>,
        json={<span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>, <span class="hljs-string">"method"</span>: method, <span class="hljs-string">"params"</span>: params},
        headers=headers
    )
</code></pre>
<p><strong>断线重连</strong>:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">connect_sse</span>(<span class="hljs-params">last_event_id=<span class="hljs-literal">None</span></span>):
    headers = {<span class="hljs-string">"Accept"</span>: <span class="hljs-string">"text/event-stream"</span>}
    <span class="hljs-keyword">if</span> last_event_id:
        headers[<span class="hljs-string">"Last-Event-ID"</span>] = last_event_id
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> httpx.stream(<span class="hljs-string">"GET"</span>, <span class="hljs-string">"/mcp"</span>, headers=headers) <span class="hljs-keyword">as</span> stream:
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> stream.aiter_lines():
            <span class="hljs-keyword">if</span> line.startswith(<span class="hljs-string">"id:"</span>):
                last_event_id = line[<span class="hljs-number">3</span>:].strip()
            <span class="hljs-keyword">elif</span> line.startswith(<span class="hljs-string">"data:"</span>):
                data = json.loads(line[<span class="hljs-number">5</span>:])
                <span class="hljs-keyword">yield</span> data, last_event_id
</code></pre>
<h3 data-id="heading-11">4.5 实际通信示例</h3>
<p>让我们看一个完整的SQLite查询场景:</p>
<pre><code class="hljs language-css" lang="css">// <span class="hljs-number">1</span>. 列出工具
客户端 → 服务器:
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"tools/list"</span>
}

服务器 → 客户端:
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,
  <span class="hljs-string">"result"</span>: {
    "tools": [
      {
        "name": <span class="hljs-string">"query"</span>,
        <span class="hljs-string">"description"</span>: <span class="hljs-string">"执行SQL查询"</span>,
        <span class="hljs-string">"inputSchema"</span>: {
          "type": <span class="hljs-string">"object"</span>,
          <span class="hljs-string">"properties"</span>: {
            "sql": {"type": <span class="hljs-string">"string"</span>}
          },
          "required": [<span class="hljs-string">"sql"</span>]
        }
      }
    ]
  }
}

// <span class="hljs-number">2</span>. 调用查询工具
客户端 → 服务器:
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"tools/call"</span>,
  <span class="hljs-string">"params"</span>: {
    "name": <span class="hljs-string">"query"</span>,
    <span class="hljs-string">"arguments"</span>: {
      "sql": <span class="hljs-string">"SELECT COUNT(*) FROM users WHERE active = 1"</span>
    },
    "_meta": {
      "progressToken": <span class="hljs-string">"query-123"</span>  // 请求进度通知
    }
  }
}

// <span class="hljs-number">3</span>. 服务器发送进度(异步通知)
服务器 → 客户端:
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"notifications/progress"</span>,
  <span class="hljs-string">"params"</span>: {
    "progressToken": <span class="hljs-string">"query-123"</span>,
    <span class="hljs-string">"progress"</span>: <span class="hljs-number">50</span>,
    <span class="hljs-string">"total"</span>: <span class="hljs-number">100</span>,
    <span class="hljs-string">"message"</span>: <span class="hljs-string">"正在扫描users表..."</span>
  }
}

// <span class="hljs-number">4</span>. 返回查询结果
服务器 → 客户端:
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"result"</span>: {
    "<span class="hljs-attribute">content</span>": [
      {
        "type": <span class="hljs-string">"text"</span>,
        <span class="hljs-string">"text"</span>: <span class="hljs-string">"查询结果: 1,234个活跃用户"</span>
      }
    ],
    "isError": false
  }
}

// <span class="hljs-number">5</span>. 如果查询出错
服务器 → 客户端(错误情况):
{
  "jsonrpc": <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"error"</span>: {
    "<span class="hljs-selector-tag">code</span>": -<span class="hljs-number">32603</span>,
    <span class="hljs-string">"message"</span>: <span class="hljs-string">"SQL语法错误"</span>,
    <span class="hljs-string">"data"</span>: {
      "sql": <span class="hljs-string">"SELECT COUNT(*) FROM users WHERE active = 1"</span>,
      <span class="hljs-string">"error"</span>: <span class="hljs-string">"near "</span>WHERE<span class="hljs-string">": syntax error"</span>,
      <span class="hljs-string">"position"</span>: <span class="hljs-number">35</span>
    }
  }
}
</code></pre>
<p>这就是MCP通信的完整过程!通过JSON-RPC 2.0，客户端和服务器可以进行结构化、类型安全的通信。</p>
<h2 data-id="heading-12">五、服务器能力：三种核心功能</h2>
<p>MCP服务器可以提供三种功能。</p>
<h3 data-id="heading-13">5.1 Resources(资源)：应用决定用什么</h3>
<p><strong>资源就是数据</strong>，比如文件内容、数据库记录、API响应。</p>
<p><strong>谁控制</strong>: 应用程序决定把哪些资源提供给AI</p>
<p><strong>如何使用</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 列出所有可用资源</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"resources/list"</span><span class="hljs-punctuation">}</span>

<span class="hljs-comment">// 读取某个资源</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"resources/read"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"uri"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file:///project/main.py"</span><span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>资源URI示例</strong>:</p>
<ul>
<li><code>file:///project/src/main.py</code> - 文件</li>
<li><code>db://schema/users</code> - 数据库表结构</li>
<li><code>git://commits/main</code> - Git提交历史</li>
<li><code>https://api.example.com/data</code> - Web API</li>
</ul>
<p><strong>订阅变更</strong>: 可以订阅资源,当它变化时自动收到通知。</p>
<p><strong>实际案例</strong>: Filesystem服务器暴露资源</p>
<pre><code class="hljs language-swift" lang="swift">{
  <span class="hljs-string">"uri"</span>: <span class="hljs-string">"file:///Users/alice/project/src/main.py"</span>,  <span class="hljs-comment">// Python源文件</span>
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"main.py"</span>,                                  <span class="hljs-comment">// 文件名</span>
  <span class="hljs-string">"mimeType"</span>: <span class="hljs-string">"text/x-python"</span>,                        <span class="hljs-comment">// 文件类型</span>
  <span class="hljs-string">"text"</span>: <span class="hljs-string">"import os<span class="hljs-subst">\n</span>def main()..."</span>                  <span class="hljs-comment">// 文件内容</span>
}
</code></pre>
<p>客户端AI可以读取这个资源，理解代码结构后提供重构建议或生成测试。</p>
<h3 data-id="heading-14">5.2 Prompts(提示模板)：用户选择用什么</h3>
<p><strong>什么是Prompt?</strong></p>
<p>Prompt就像是「对话模板」或「快捷指令」，把常用的复杂指令预设好，用户一键调用。用生活中的例子类比，就像微信的「快捷回复」或IDE中的「代码片段(Snippet)」。</p>
<p><strong>为什么需要Prompt?</strong><br/>
场景1:没有Prompt时</p>
<pre><code class="hljs language-markdown" lang="markdown">用户每次都要输入:
"请分析这个Git仓库最近一周的提交,统计:
<span class="hljs-bullet">1.</span> 总提交次数
<span class="hljs-bullet">2.</span> 每个作者的贡献
<span class="hljs-bullet">3.</span> 修改的主要文件
<span class="hljs-bullet">4.</span> 是否有破坏性变更
请用表格格式输出"
</code></pre>
<p>场景2:有Prompt后</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">用户只需:</span>
1. 点击 <span class="hljs-string">"/analyze-commits"</span> 命令
2. 选择分支 <span class="hljs-string">"main"</span>
3. AI自动执行完整分析
</code></pre>
<p><strong>Prompt的数据结构</strong></p>
<p><strong>定义一个Prompt</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"analyze_commits"</span><span class="hljs-punctuation">,</span>              <span class="hljs-comment">// Prompt的唯一标识</span>
  <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"提交历史分析"</span><span class="hljs-punctuation">,</span>                  <span class="hljs-comment">// 用户界面显示的名称</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"分析Git提交并生成报告"</span><span class="hljs-punctuation">,</span>    <span class="hljs-comment">// 功能说明</span>
  <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>                          <span class="hljs-comment">// 需要的参数列表</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"branch"</span><span class="hljs-punctuation">,</span>                   <span class="hljs-comment">// 参数名</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"要分析的分支名"</span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// 参数说明</span>
      <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>                    <span class="hljs-comment">// 是否必填</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"since"</span><span class="hljs-punctuation">,</span>                    <span class="hljs-comment">// 时间范围</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"起始日期(如:7 days ago)"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>                   <span class="hljs-comment">// 可选参数</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"author"</span><span class="hljs-punctuation">,</span>                   <span class="hljs-comment">// 作者过滤</span>
      <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"只看某个作者的提交"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>实际使用示例</strong></p>
<p><strong>步骤1: 列出所有可用的Prompt</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 客户端请求</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"prompts/list"</span>
<span class="hljs-punctuation">}</span>

<span class="hljs-comment">// 服务器响应</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsonrpc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"result"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"prompts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"analyze_commits"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"📊 提交历史分析"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"分析指定分支的提交历史,生成统计报告"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"branch"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"since"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"review_code"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"🔍 代码审查"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"对代码进行质量审查和改进建议"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file_path"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"focus"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"explain_error"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"🐛 错误诊断"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"解释错误信息并提供修复建议"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"error_message"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>步骤2: 用户在界面上看到这些选项</strong></p>
<pre><code class="hljs language-bash" lang="bash">━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  可用命令:
  
  📊 /analyze-commits
     分析指定分支的提交历史
     
  🔍 /review-code  
     对代码进行质量审查
     
  🐛 /explain-error
     解释错误信息并修复
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
</code></pre>
<p><strong>步骤3: 用户选择并填写参数</strong></p>
<pre><code class="hljs language-ini" lang="ini">用户输入: /analyze-commits

系统弹窗:
┌─────────────────────────┐
│ 提交历史分析            │
├─────────────────────────┤
│ 分支名 *: <span class="hljs-section">[main      ]</span> │
│ 时间范围: <span class="hljs-section">[7 days ago]</span> │
│ 作者:     <span class="hljs-section">[          ]</span> │
│                         │
│      <span class="hljs-section">[取消]</span>  <span class="hljs-section">[确定]</span>     │
└─────────────────────────┘
</code></pre>
<p><strong>步骤4: 获取完整的Prompt内容</strong></p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 客户端请求</span>
{
  <span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"method"</span>: <span class="hljs-string">"prompts/get"</span>,
  <span class="hljs-string">"params"</span>: {
    <span class="hljs-string">"name"</span>: <span class="hljs-string">"analyze_commits"</span>,       <span class="hljs-comment">// 使用哪个模板</span>
    <span class="hljs-string">"arguments"</span>: {                    <span class="hljs-comment">// 用户填写的参数</span>
      <span class="hljs-string">"branch"</span>: <span class="hljs-string">"main"</span>,
      <span class="hljs-string">"since"</span>: <span class="hljs-string">"7 days ago"</span>
    }
  }
}

<span class="hljs-comment">// 服务器响应 - 返回完整的对话消息</span>
{
  <span class="hljs-string">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"result"</span>: {
    <span class="hljs-string">"description"</span>: <span class="hljs-string">"分析main分支最近7天的提交"</span>,
    <span class="hljs-string">"messages"</span>: [                     <span class="hljs-comment">// 发送给AI的完整对话</span>
      {
        <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,               <span class="hljs-comment">// 用户角色</span>
        <span class="hljs-string">"content"</span>: {
          <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
          <span class="hljs-string">"text"</span>: <span class="hljs-string">"请分析main分支在过去7天的Git提交历史。<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>需要统计:<span class="hljs-subst">\n</span>1. 总提交次数<span class="hljs-subst">\n</span>2. 每个作者的贡献次数和代码行数<span class="hljs-subst">\n</span>3. 主要修改的文件列表<span class="hljs-subst">\n</span>4. 是否包含breaking changes<span class="hljs-subst">\n</span>5. 提交消息的规范性<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>请用表格格式输出结果,并在最后给出改进建议。"</span>
        }
      }
    ]
  }
}
</code></pre>
<p><strong>步骤5: 客户端将消息发送给AI</strong></p>
<pre><code class="hljs language-bash" lang="bash">用户看到AI正在分析...

AI返回:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📊 main分支提交分析报告(最近7天)

总提交次数: 23

作者贡献统计:
┌────────────┬────────┬──────────┐
│ 作者       │ 提交数 │ 代码行数  │
├────────────┼────────┼──────────┤
│ Alice      │   12   │  +543/-89│
│ Bob        │    8   │  +234/-45│
│ Charlie    │    3   │  +123/-12│
└────────────┴────────┴──────────┘

主要修改文件:
- src/api/users.py (8次修改)
- src/models/user.py (5次修改)
- tests/test_user.py (4次修改)

Breaking Changes: 无

提交规范性: 良好 (91%符合Conventional Commits)

改进建议:
1. 建议增加单元测试覆盖率
2. 部分提交消息过于简短
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
</code></pre>
<p><strong>Prompt的内容类型</strong></p>
<p>Prompt消息中可以包含多种内容:<br/>
<strong>1. 纯文本</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"请审查这段代码..."</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>2. 嵌入图片</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"image"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"base64-encoded-image-data"</span><span class="hljs-punctuation">,</span>     <span class="hljs-comment">// 图片数据</span>
    <span class="hljs-attr">"mimeType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"image/png"</span>                  <span class="hljs-comment">// 图片类型</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>3. 嵌入资源</strong>(引用MCP资源)</p>
<pre><code class="hljs language-swift" lang="swift">{
  <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
  <span class="hljs-string">"content"</span>: {
    <span class="hljs-string">"type"</span>: <span class="hljs-string">"resource"</span>,
    <span class="hljs-string">"resource"</span>: {
      <span class="hljs-string">"uri"</span>: <span class="hljs-string">"file:///project/src/user.py"</span>,  <span class="hljs-comment">// 资源URI</span>
      <span class="hljs-string">"mimeType"</span>: <span class="hljs-string">"text/x-python"</span>,
      <span class="hljs-string">"text"</span>: <span class="hljs-string">"class User:<span class="hljs-subst">\n</span>    def __init__..."</span>  <span class="hljs-comment">// 资源内容</span>
    }
  }
}
</code></pre>
<p><strong>4. 多轮对话</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"messages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我想优化这段代码"</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"assistant"</span><span class="hljs-punctuation">,</span>                    <span class="hljs-comment">// AI的回复</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"请提供代码内容"</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"resource"</span><span class="hljs-punctuation">,</span>                   <span class="hljs-comment">// 用户提供代码</span>
        <span class="hljs-attr">"resource"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>...<span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>Prompt vs Tool vs Resource 对比</strong></p>
<pre><code class="hljs language-scss" lang="scss">特性          Prompt              Tool                Resource
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
控制者        用户主动选择         AI自动决定           应用程序控制

触发方式      用户点击命令         AI判断需要调用       应用自动附加
              /analyze                              或用户选择
              
返回内容      对话消息            执行结果             数据内容
              (给AI的指令)        (函数返回值)         (上下文信息)
              
典型用途      工作流模板          执行操作             提供背景信息
              快捷指令            查询数据             文件内容
              
示例          代码审查模板        执行SQL查询          项目README
              错误诊断向导        发送邮件             数据库Schema
              
用户感知      ✅ 明显             ❓ 可能不知道         ❓ 透明的
              (用户点击)          (AI决定)            (自动加载)
</code></pre>
<p>Prompt是预设的对话模板，通过参数化实现灵活应用，提升用户体验，并能与MCP其他能力组合形成完整工作流。</p>
<p><strong>代码实现示例</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 服务器端:注册Prompt</span>
<span class="hljs-meta">@server.list_prompts()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">list_prompts</span>():
    <span class="hljs-keyword">return</span> [
        Prompt(
            name=<span class="hljs-string">"analyze_commits"</span>,
            title=<span class="hljs-string">"📊 提交历史分析"</span>,
            description=<span class="hljs-string">"分析Git提交历史并生成统计报告"</span>,
            arguments=[
                {<span class="hljs-string">"name"</span>: <span class="hljs-string">"branch"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"分支名"</span>, <span class="hljs-string">"required"</span>: <span class="hljs-literal">True</span>},
                {<span class="hljs-string">"name"</span>: <span class="hljs-string">"since"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"时间范围"</span>, <span class="hljs-string">"required"</span>: <span class="hljs-literal">False</span>}
            ]
        )
    ]

<span class="hljs-meta">@server.get_prompt()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_prompt</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span>, arguments: <span class="hljs-built_in">dict</span></span>):
    <span class="hljs-keyword">if</span> name == <span class="hljs-string">"analyze_commits"</span>:
        branch = arguments[<span class="hljs-string">"branch"</span>]
        since = arguments.get(<span class="hljs-string">"since"</span>, <span class="hljs-string">"7 days ago"</span>)
        
        <span class="hljs-comment"># 构建完整的提示消息</span>
        prompt_text = <span class="hljs-string">f"""
请分析<span class="hljs-subst">{branch}</span>分支在<span class="hljs-subst">{since}</span>的Git提交历史。

需要统计:
1. 总提交次数
2. 每个作者的贡献
3. 主要修改的文件
4. 是否有breaking changes

请用表格格式输出。
        """</span>
        
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"messages"</span>: [
                {
                    <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
                    <span class="hljs-string">"content"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>, <span class="hljs-string">"text"</span>: prompt_text}
                }
            ]
        }

<span class="hljs-comment"># 客户端:使用Prompt</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">use_prompt</span>(<span class="hljs-params">session, prompt_name, arguments</span>):
    <span class="hljs-comment"># 获取Prompt内容</span>
    prompt = <span class="hljs-keyword">await</span> session.get_prompt(
        name=prompt_name,
        arguments=arguments
    )
    
    <span class="hljs-comment"># 将消息发送给AI</span>
    <span class="hljs-keyword">for</span> message <span class="hljs-keyword">in</span> prompt.messages:
        ai_response = <span class="hljs-keyword">await</span> send_to_ai(message)
        <span class="hljs-built_in">print</span>(ai_response)
</code></pre>
<h3 data-id="heading-15">5.3 Tools(工具)：AI 自己决定用什么</h3>
<p><strong>Tool就是可执行的函数</strong>，比如查询数据库、调用API、写文件。</p>
<p><strong>谁控制</strong>：AI模型根据对话内容自己决定调用哪个工具</p>
<p><strong>如何使用</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// 列出可用工具</span>
<span class="hljs-punctuation">{</span><span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tools/list"</span><span class="hljs-punctuation">}</span>

<span class="hljs-comment">// AI调用工具</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"tools/call"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"get_weather"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"city"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"北京"</span><span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>返回结果</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"北京天气:晴,温度22°C"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"isError"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-16">5.4 其他功能</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fspecification%2F2025-06-18%2Fserver%2Futilities%2Fcompletion" target="_blank" title="https://modelcontextprotocol.io/specification/2025-06-18/server/utilities/completion" ref="nofollow noopener noreferrer"><strong>补全</strong></a></p>
<p>MCP提供标准化的参数自动补全功能，支持为提示和资源URI提供上下文相关的建议，实现类似IDE的交互体验。服务器通过声明<code>completions</code>能力，支持对<code>ref/prompt</code>和<code>ref/resource</code>两种引用类型的补全，每次最多返回100个按相关性排序的建议值，并可通过<code>completion/complete</code>请求获取补全结果。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fspecification%2F2025-06-18%2Fserver%2Futilities%2Flogging" target="_blank" title="https://modelcontextprotocol.io/specification/2025-06-18/server/utilities/logging" ref="nofollow noopener noreferrer"><strong>日志</strong></a></p>
<p>MCP提供结构化日志消息传递机制，允许服务器向客户端发送包含严重性级别、可选记录器名称和任意JSON可序列化数据的日志通知。服务器需声明<code>logging</code>能力，支持遵循RFC 5424标准的日志级别（从debug到emergency），客户端可通过<code>logging/setLevel</code>请求配置最低日志级别，服务器通过<code>notifications/message</code>通知发送日志消息。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fspecification%2F2025-06-18%2Fserver%2Futilities%2Fpagination" target="_blank" title="https://modelcontextprotocol.io/specification/2025-06-18/server/utilities/pagination" ref="nofollow noopener noreferrer"><strong>分页</strong></a></p>
<p>MCP支持对可能返回大量结果集的列表操作进行分页处理，使用基于不透明游标的分页模型而非数字页码。服务器在响应中包含当前页结果和可选的<code>nextCursor</code>字段（表示更多结果存在），客户端可通过在请求中包含游标继续分页。支持分页的操作包括<code>resources/list</code>、<code>resources/templates/list</code>、<code>prompts/list</code>和<code>tools/list</code>，客户端必须将游标视为不透明令牌。</p>
<h2 data-id="heading-17">六、客户端能力：反向请求</h2>
<p>客户端不仅接收服务器的数据，也可以提供能力给服务器使用:</p>
<h3 data-id="heading-18">6.1 Sampling(采样)：服务器请求客户端调用AI</h3>
<p><strong>场景</strong>: 服务器在处理任务时，需要AI帮忙分析中间结果。</p>
<p><strong>如何使用</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"sampling/createMessage"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"messages"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"user"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"text"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"这个数据正常吗?"</span><span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"modelPreferences"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"hints"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"claude-3-sonnet"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>  <span class="hljs-comment">// 建议用的模型</span>
      <span class="hljs-attr">"intelligencePriority"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.8</span><span class="hljs-punctuation">,</span>             <span class="hljs-comment">// 要求智能程度</span>
      <span class="hljs-attr">"speedPriority"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0.5</span>                     <span class="hljs-comment">// 速度要求</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>实际案例</strong>:Filesystem服务器在搜索大量文件时,请求AI判断哪些文件最相关。</p>
<h3 data-id="heading-19">6.2 Roots(目录)：告诉服务器工作范围</h3>
<p><strong>场景</strong>: 让服务器知道可以访问哪些目录。</p>
<p><strong>如何使用</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"roots/list"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>返回</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"roots"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"uri"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file:///home/user/project"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"我的项目"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>服务器知道只能在这个目录里操作，保护其他文件安全。</p>
<h3 data-id="heading-20">6.3 Elicitation(引导)：服务器向用户询问信息</h3>
<p><strong>场景</strong>: 服务器需要用户提供额外信息才能继续。</p>
<p><strong>如何使用</strong>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"elicitation/create"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"请提供您的GitHub用户名"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"requestedSchema"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"object"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"username"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span><span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span><span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>用户响应</strong>:</p>
<pre><code class="hljs language-perl" lang="perl">{
  <span class="hljs-string">"action"</span>: <span class="hljs-string">"accept"</span>,  <span class="hljs-regexp">//</span> 或<span class="hljs-string">"decline"</span>拒绝, <span class="hljs-string">"cancel"</span>取消
  <span class="hljs-string">"content"</span>: {
    <span class="hljs-string">"username"</span>: <span class="hljs-string">"octocat"</span>
  }
}
</code></pre>
<p><strong>实际案例</strong>: Git服务器需要知道提交信息格式，弹窗问用户:"请选择提交规范:Conventional Commits/Angular/Custom?"</p>
<h2 data-id="heading-21">七、完整实战：从零构建天气查询MCP</h2>
<p>下面让我们从头到尾构建一个完整的MCP系统，包含服务器和客户端。</p>
<h3 data-id="heading-22">7.1 需求分析</h3>
<p><strong>目标</strong>: 构建一个天气查询MCP服务器,提供:</p>
<ul>
<li><strong>资源</strong>: 城市列表</li>
<li><strong>工具</strong>: 查询天气、获取预报</li>
<li><strong>提示</strong>: 天气分析模板</li>
</ul>
<h3 data-id="heading-23">7.2 服务器实现(Python)</h3>
<p><strong>第一步: 安装MCP SDK</strong></p>
<pre><code class="hljs">pip install mcp
</code></pre>
<p><strong>第二步: 创建服务器 (weather_server.py)</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> mcp.server <span class="hljs-keyword">import</span> Server
<span class="hljs-keyword">from</span> mcp.types <span class="hljs-keyword">import</span> Resource, Tool, Prompt, TextContent
<span class="hljs-keyword">import</span> mcp.server.stdio
<span class="hljs-keyword">import</span> httpx

<span class="hljs-comment"># 创建MCP服务器实例</span>
server = Server(<span class="hljs-string">"weather-server"</span>)

<span class="hljs-comment"># 1. 定义资源:支持的城市列表</span>
<span class="hljs-meta">@server.list_resources()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">list_resources</span>():
    <span class="hljs-string">"""返回可用的资源列表"""</span>
    <span class="hljs-keyword">return</span> [
        Resource(
            uri=<span class="hljs-string">"weather://cities"</span>,
            name=<span class="hljs-string">"支持的城市列表"</span>,
            mimeType=<span class="hljs-string">"application/json"</span>,
            description=<span class="hljs-string">"查询天气支持的所有城市"</span>
        )
    ]

<span class="hljs-meta">@server.read_resource()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_resource</span>(<span class="hljs-params">uri: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""读取具体资源内容"""</span>
    <span class="hljs-keyword">if</span> uri == <span class="hljs-string">"weather://cities"</span>:
        cities = [<span class="hljs-string">"北京"</span>, <span class="hljs-string">"上海"</span>, <span class="hljs-string">"广州"</span>, <span class="hljs-string">"深圳"</span>, <span class="hljs-string">"杭州"</span>]
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"contents"</span>: [{
                <span class="hljs-string">"uri"</span>: uri,
                <span class="hljs-string">"mimeType"</span>: <span class="hljs-string">"application/json"</span>,
                <span class="hljs-string">"text"</span>: <span class="hljs-built_in">str</span>(cities)
            }]
        }

<span class="hljs-comment"># 2. 定义工具:天气查询</span>
<span class="hljs-meta">@server.list_tools()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">list_tools</span>():
    <span class="hljs-string">"""返回可用的工具列表"""</span>
    <span class="hljs-keyword">return</span> [
        Tool(
            name=<span class="hljs-string">"get_current_weather"</span>,
            description=<span class="hljs-string">"获取指定城市的当前天气"</span>,
            inputSchema={
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
                <span class="hljs-string">"properties"</span>: {
                    <span class="hljs-string">"city"</span>: {
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
                        <span class="hljs-string">"description"</span>: <span class="hljs-string">"城市名称,如'北京'"</span>
                    }
                },
                <span class="hljs-string">"required"</span>: [<span class="hljs-string">"city"</span>]
            }
        ),
        Tool(
            name=<span class="hljs-string">"get_forecast"</span>,
            description=<span class="hljs-string">"获取未来3天天气预报"</span>,
            inputSchema={
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"object"</span>,
                <span class="hljs-string">"properties"</span>: {
                    <span class="hljs-string">"city"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"城市名称"</span>},
                    <span class="hljs-string">"days"</span>: {<span class="hljs-string">"type"</span>: <span class="hljs-string">"number"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"预报天数(1-3)"</span>, <span class="hljs-string">"default"</span>: <span class="hljs-number">3</span>}
                },
                <span class="hljs-string">"required"</span>: [<span class="hljs-string">"city"</span>]
            }
        )
    ]

<span class="hljs-meta">@server.call_tool()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">call_tool</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span>, arguments: <span class="hljs-built_in">dict</span></span>):
    <span class="hljs-string">"""执行工具调用"""</span>
    <span class="hljs-keyword">if</span> name == <span class="hljs-string">"get_current_weather"</span>:
        city = arguments[<span class="hljs-string">"city"</span>]
        <span class="hljs-comment"># 实际项目中这里调用真实的天气API</span>
        <span class="hljs-comment"># 示例:使用模拟数据</span>
        weather_data = {
            <span class="hljs-string">"city"</span>: city,
            <span class="hljs-string">"temperature"</span>: <span class="hljs-number">22</span>,
            <span class="hljs-string">"condition"</span>: <span class="hljs-string">"晴"</span>,
            <span class="hljs-string">"humidity"</span>: <span class="hljs-number">45</span>
        }
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"content"</span>: [{
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-string">"text"</span>: <span class="hljs-string">f"<span class="hljs-subst">{city}</span>当前天气:\n温度: <span class="hljs-subst">{weather_data[<span class="hljs-string">'temperature'</span>]}</span>°C\n天气: <span class="hljs-subst">{weather_data[<span class="hljs-string">'condition'</span>]}</span>\n湿度: <span class="hljs-subst">{weather_data[<span class="hljs-string">'humidity'</span>]}</span>%"</span>
            }]
        }
    
    <span class="hljs-keyword">elif</span> name == <span class="hljs-string">"get_forecast"</span>:
        city = arguments[<span class="hljs-string">"city"</span>]
        days = arguments.get(<span class="hljs-string">"days"</span>, <span class="hljs-number">3</span>)
        <span class="hljs-comment"># 模拟预报数据</span>
        forecast = <span class="hljs-string">f"<span class="hljs-subst">{city}</span>未来<span class="hljs-subst">{days}</span>天预报:\n第1天: 晴,20-25°C\n第2天: 多云,18-23°C\n第3天: 小雨,16-20°C"</span>
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"content"</span>: [{<span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>, <span class="hljs-string">"text"</span>: forecast}]
        }

<span class="hljs-comment"># 3. 定义提示模板:天气分析</span>
<span class="hljs-meta">@server.list_prompts()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">list_prompts</span>():
    <span class="hljs-string">"""返回可用的提示模板"""</span>
    <span class="hljs-keyword">return</span> [
        Prompt(
            name=<span class="hljs-string">"analyze_weather"</span>,
            description=<span class="hljs-string">"分析天气趋势并给出建议"</span>,
            arguments=[
                {<span class="hljs-string">"name"</span>: <span class="hljs-string">"city"</span>, <span class="hljs-string">"description"</span>: <span class="hljs-string">"城市名称"</span>, <span class="hljs-string">"required"</span>: <span class="hljs-literal">True</span>}
            ]
        )
    ]

<span class="hljs-meta">@server.get_prompt()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_prompt</span>(<span class="hljs-params">name: <span class="hljs-built_in">str</span>, arguments: <span class="hljs-built_in">dict</span></span>):
    <span class="hljs-string">"""获取提示模板内容"""</span>
    <span class="hljs-keyword">if</span> name == <span class="hljs-string">"analyze_weather"</span>:
        city = arguments[<span class="hljs-string">"city"</span>]
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">"messages"</span>: [
                {
                    <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
                    <span class="hljs-string">"content"</span>: {
                        <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                        <span class="hljs-string">"text"</span>: <span class="hljs-string">f"请分析<span class="hljs-subst">{city}</span>的天气情况,并给出出行建议。包括:\n1. 温度是否适宜\n2. 是否需要带伞\n3. 穿衣建议"</span>
                    }
                }
            ]
        }

<span class="hljs-comment"># 启动服务器</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 使用stdio传输(本地)</span>
    mcp.server.stdio.run_stdio_server(server)
</code></pre>
<h3 data-id="heading-24">7.3 配置服务器(Claude Desktop)</h3>
<p>创建配置文件 <code>~/Library/Application Support/Claude/claude_desktop_config.json</code>:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"mcpServers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"weather"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"command"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"python"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"args"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"/path/to/weather_server.py"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-25">7.4 客户端实现(Python)</h3>
<p>如果要自己实现客户端:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> mcp <span class="hljs-keyword">import</span> ClientSession
<span class="hljs-keyword">from</span> mcp.client.stdio <span class="hljs-keyword">import</span> stdio_client
<span class="hljs-keyword">import</span> asyncio

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-comment"># 连接到服务器</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> stdio_client(
        command=<span class="hljs-string">"python"</span>,
        args=[<span class="hljs-string">"/path/to/weather_server.py"</span>]
    ) <span class="hljs-keyword">as</span> (read, write):
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> ClientSession(read, write) <span class="hljs-keyword">as</span> session:
            
            <span class="hljs-comment"># 1. 初始化连接</span>
            <span class="hljs-keyword">await</span> session.initialize()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 连接成功!"</span>)
            
            <span class="hljs-comment"># 2. 列出可用资源</span>
            resources = <span class="hljs-keyword">await</span> session.list_resources()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n📁 可用资源: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(resources.resources)}</span>"</span>)
            <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> resources.resources:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  - <span class="hljs-subst">{r.name}</span>: <span class="hljs-subst">{r.uri}</span>"</span>)
            
            <span class="hljs-comment"># 3. 读取城市列表资源</span>
            cities_resource = <span class="hljs-keyword">await</span> session.read_resource(
                uri=<span class="hljs-string">"weather://cities"</span>
            )
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n🌍 城市列表: <span class="hljs-subst">{cities_resource.contents[<span class="hljs-number">0</span>].text}</span>"</span>)
            
            <span class="hljs-comment"># 4. 列出可用工具</span>
            tools = <span class="hljs-keyword">await</span> session.list_tools()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n🔧 可用工具: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(tools.tools)}</span>"</span>)
            <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> tools.tools:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  - <span class="hljs-subst">{t.name}</span>: <span class="hljs-subst">{t.description}</span>"</span>)
            
            <span class="hljs-comment"># 5. 调用工具查询天气</span>
            result = <span class="hljs-keyword">await</span> session.call_tool(
                name=<span class="hljs-string">"get_current_weather"</span>,
                arguments={<span class="hljs-string">"city"</span>: <span class="hljs-string">"北京"</span>}
            )
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n🌤️  查询结果:\n<span class="hljs-subst">{result.content[<span class="hljs-number">0</span>].text}</span>"</span>)
            
            <span class="hljs-comment"># 6. 获取预报</span>
            forecast = <span class="hljs-keyword">await</span> session.call_tool(
                name=<span class="hljs-string">"get_forecast"</span>,
                arguments={<span class="hljs-string">"city"</span>: <span class="hljs-string">"上海"</span>, <span class="hljs-string">"days"</span>: <span class="hljs-number">3</span>}
            )
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n📅 天气预报:\n<span class="hljs-subst">{forecast.content[<span class="hljs-number">0</span>].text}</span>"</span>)
            
            <span class="hljs-comment"># 7. 列出提示模板</span>
            prompts = <span class="hljs-keyword">await</span> session.list_prompts()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n💡 提示模板: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(prompts.prompts)}</span>"</span>)
            <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> prompts.prompts:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  - <span class="hljs-subst">{p.name}</span>: <span class="hljs-subst">{p.description}</span>"</span>)
            
            <span class="hljs-comment"># 8. 获取提示内容</span>
            prompt = <span class="hljs-keyword">await</span> session.get_prompt(
                name=<span class="hljs-string">"analyze_weather"</span>,
                arguments={<span class="hljs-string">"city"</span>: <span class="hljs-string">"广州"</span>}
            )
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n📝 生成的提示:\n<span class="hljs-subst">{prompt.messages[<span class="hljs-number">0</span>][<span class="hljs-string">'content'</span>][<span class="hljs-string">'text'</span>]}</span>"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    asyncio.run(main())
</code></pre>
<h3 data-id="heading-26">7.5 运行效果</h3>
<pre><code class="hljs language-makefile" lang="makefile">$ python weather_client.py

✅ 连接成功!

📁 可用资源: 1
  - 支持的城市列表: weather://cities

🌍 城市列表: ['北京', '上海', '广州', '深圳', '杭州']

🔧 可用工具: 2
  - get_current_weather: 获取指定城市的当前天气
  - get_forecast: 获取未来3天天气预报

🌤️  查询结果:
<span class="hljs-section">北京当前天气:</span>
<span class="hljs-section">温度: 22°C</span>
<span class="hljs-section">天气: 晴</span>
<span class="hljs-section">湿度: 45%</span>

📅 天气预报:
<span class="hljs-section">上海未来3天预报:</span>
<span class="hljs-section">第1天: 晴,20-25°C</span>
<span class="hljs-section">第2天: 多云,18-23°C</span>
<span class="hljs-section">第3天: 小雨,16-20°C</span>

💡 提示模板: 1
  - analyze_weather: 分析天气趋势并给出建议

📝 生成的提示:
<span class="hljs-section">请分析广州的天气情况,并给出出行建议。包括:</span>
1. 温度是否适宜
2. 是否需要带伞
3. 穿衣建议
</code></pre>
<h2 data-id="heading-27">八、其他部分：MCP基础协议的另一半</h2>
<h3 data-id="heading-28">8.1 授权（Authorization）</h3>
<p>MCP授权规范定义了基于HTTP传输的安全授权机制，使MCP客户端能够代表资源所有者向受限制的MCP服务器发出请求。该规范基于OAuth 2.1及相关标准，实现了授权服务器发现、动态客户端注册和访问令牌管理。例如，客户端通过<code>resource</code>参数明确指定目标MCP服务器（如<code>https://mcp.example.com</code>），服务器则验证令牌是否专门为其颁发，确保令牌不会被误用于其他服务，从而防止"令牌传递"安全漏洞。</p>
<h3 data-id="heading-29">8.2 取消（Cancellation）</h3>
<p>MCP取消机制允许通过通知消息中止正在进行的请求，任何一方都可以发送<code>notifications/cancelled</code>通知来终止先前发出的请求。例如，当用户取消长时间运行的操作时，客户端可以发送包含请求ID和可选原因的取消通知，接收方应停止处理、释放资源且不发送响应。该机制考虑了网络延迟导致的竞态条件，允许接收方在请求已完成或无法取消时忽略通知，同时建议双方记录取消原因以便调试。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"notifications/cancelled"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"requestId"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"123"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"reason"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"用户取消"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-30">8.3 Ping机制</h3>
<p>MCP提供了可选的ping机制，允许任何一方验证对方是否仍然响应且连接存活。该机制通过简单的请求/响应模式实现，例如客户端发送<code>{"jsonrpc":"2.0","id":"123","method":"ping"}</code>，服务器必须立即响应<code>{"jsonrpc":"2.0","id":"123","result":{}}</code>。如果在合理超时时间内未收到响应，发送方可以将连接视为陈旧并终止连接或尝试重新连接。实现应定期发送ping以检测连接健康状况，但应避免过度ping以减少网络开销。</p>
<h3 data-id="heading-31">8.4 进度跟踪（Progress）</h3>
<p>MCP支持通过通知消息对长时间运行的操作进行可选的进度跟踪。请求方可以在请求元数据中包含唯一的<code>progressToken</code>（如字符串"task123"）来接收进度更新，接收方则可以发送包含进度值、可选总值和消息的<code>notifications/progress</code>通知。例如，文件上传操作可以发送<code>{"progress":50,"total":100,"message":"正在上传文件..."}</code>来指示完成百分比。进度值必须随每个通知递增，双方应实现速率限制以防止消息泛滥，并在操作完成后停止发送进度通知。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"method"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"notifications/progress"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"params"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"progressToken"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"task123"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"progress"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">50</span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// 当前进度</span>
    <span class="hljs-attr">"total"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span>        <span class="hljs-comment">// 总量</span>
    <span class="hljs-attr">"message"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"正在上传文件..."</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-32">九、安全实践：必须重视</h2>
<h3 data-id="heading-33">9.1 核心原则</h3>
<p><strong>1. 用户同意优先</strong></p>
<ul>
<li>所有数据访问必须经用户明确同意</li>
<li>所有工具调用前必须让用户确认</li>
</ul>
<p><strong>2. 数据隐私保护</strong></p>
<ul>
<li>服务器只能看到必要的信息</li>
<li>完整对话历史保留在宿主,不发给服务器</li>
</ul>
<p><strong>3. 工具安全</strong></p>
<ul>
<li>工具代表代码执行,必须谨慎</li>
<li>显示工具要做什么,让用户批准</li>
</ul>
<p><strong>4. 输入验证</strong></p>
<ul>
<li>服务器必须验证所有输入</li>
<li>客户端必须验证工具返回的结果</li>
</ul>
<h3 data-id="heading-34">9.2 实际建议</h3>
<p><strong>服务器开发者</strong>:</p>
<ul>
<li>验证所有输入参数</li>
<li>实现访问控制和速率限制</li>
<li>记录操作日志供审计</li>
</ul>
<p><strong>客户端开发者</strong>:</p>
<ul>
<li>显示清晰的权限请求界面</li>
<li>在调用工具前展示参数</li>
<li>实现工具调用超时机制</li>
</ul>
<h2 data-id="heading-35">十、MCP生态：谁开发客户端?</h2>
<p><strong>关键认知</strong>: 在MCP生态中，<strong>客户端通常不是由下游开发者开发的</strong>，而是<strong>内置在AI应用平台中</strong>。</p>
<pre><code class="hljs language-css" lang="css">  开发者开发MCP服务器
       ↓
  配置到AI平台(Claude/<span class="hljs-attribute">Cursor</span>等)
       ↓
  AI平台内置的MCP客户端自动连接
</code></pre>
<p>对于软件开发者来说，在MCP生态中的位置如下。</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">角色定位:</span>
┌─────────────────────────────────────────┐
│ AI平台开发者(Anthropic, Cursor等)       │
│ ────────────────────────────────        │
│ 职责:                                   │
│  ✅ 开发MCP客户端SDK                    │
│  ✅ 集成到自己的AI应用中                │
│  ✅ 提供配置界面                        │
│  ✅ 管理MCP服务器生命周期               │
│  ✅ 处理AI与MCP的交互逻辑               │
└─────────────────────────────────────────┘
                 ↓ 提供平台
┌─────────────────────────────────────────┐
│ MCP服务器开发者(你、我、社区)           │
│ ────────────────────────────────        │
│ 职责:                                   │
│  ✅ 开发MCP服务器                       │
│  ✅ 实现Resources/Tools/Prompts        │
│  ✅ 编写使用文档                        │
│  ✅ 发布到npm/PyPI                      │
│  ❌ 不需要开发客户端                    │
│  ❌ 不需要关心AI如何调用                │
└─────────────────────────────────────────┘
                 ↓ 使用服务
┌─────────────────────────────────────────┐
│ 最终用户(开发者、分析师等)               │
│ ────────────────────────────────        │
│ 职责:                                   │
│  ✅ 安装需要的MCP服务器                 │
│  ✅ 配置到AI平台                        │
│  ✅ 使用AI完成任务                      │
│  ❌ 不需要写代码                        │
└─────────────────────────────────────────┘
</code></pre>
<h2 data-id="heading-36">后记</h2>
<p>MCP 让 AI 应用开发变得更简单、更安全、更强大。它不是银弹，但为构建可靠的AI系统提供了坚实基础。<strong>本文全部内容基于提示编写，欢迎交流讨论！</strong></p>
<h2 data-id="heading-37">参考文献</h2>
<ol>
<li>MCP官方规范: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2Fspecification%2F2025-06-18" target="_blank" title="https://modelcontextprotocol.io/specification/2025-06-18" ref="nofollow noopener noreferrer">modelcontextprotocol.io/specificati…</a></li>
<li>JSON-RPC 2.0: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.jsonrpc.org%2F" target="_blank" title="https://www.jsonrpc.org/" ref="nofollow noopener noreferrer">www.jsonrpc.org/</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vibe Coze-企业 AI 应用赛道开启]]></title>    <link>https://juejin.cn/post/7571475192489951242</link>    <guid>https://juejin.cn/post/7571475192489951242</guid>    <pubDate>2025-11-12T08:07:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571475192489951242" data-draft-id="7571395183943991305" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vibe Coze-企业 AI 应用赛道开启"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-12T08:07:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火山引擎开发者社区"/> <meta itemprop="url" content="https://juejin.cn/user/3307770588439422"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vibe Coze-企业 AI 应用赛道开启
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3307770588439422/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火山引擎开发者社区
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T08:07:51.000Z" title="Wed Nov 12 2025 08:07:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f079723185014bd98aef19582bfb26b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5bGx5byV5pOO5byA5Y-R6ICF56S-5Yy6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763539670&amp;x-signature=U1nrQQwpLA6X6ThX7AHK1TBC2ZE%3D" alt="" loading="lazy"/></p>
<p><strong>赛道详情</strong></p>
<p>参赛选手需从企业真实需求（如数据分析、办公助手、知识查询/管理、营销推广等场景）出发，基于扣子（coze.cn) /扣子空间的能力创建一个 H5 或其他可复现的成品项目，<strong>推荐结合使用豆包编程模型 Doubao-Seed-Code、火山引擎 veCLI。使用推荐工具将是加分项</strong>，详见评分规则。</p>
<p>豆包编程模型 Doubao-Seed-Code 专为 Agentic 编程任务深度优化，在 SWE-Bench-Verified 榜单中刷新SOTA，更兼容 Anthropic API 等主流开发环境。</p>
<p>对于个人开发者，豆包编程模型推出 Coding Plan 订阅服务，首月订购优惠价低至 9.9 元！如订阅 Coding Plan 使用豆包编程模型参赛，可通过链接提交信息，将获得额外礼品一份：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fbytedance.larkoffice.com%2Fshare%2Fbase%2Fform%2FshrcnwIxtFAkm4gEh1fIl3TanJc" target="_blank" title="https://bytedance.larkoffice.com/share/base/form/shrcnwIxtFAkm4gEh1fIl3TanJc" ref="nofollow noopener noreferrer">bytedance.larkoffice.com/share/base/…</a></p>
<p><strong>学习资料：</strong></p>
<ul>
<li>
<p>AI 编程实战技巧分享，30分钟从入门到沉迷｜Vibe Coze！扣子 AI 挑战赛教程：<a href="https://link.juejin.cn?target=https%3A%2F%2Fbytedance.larkoffice.com%2Fwiki%2FHt37wE7wbiPAJpkpQooc4EYenKd%3Ffrom%3Dfrom_copylink" target="_blank" title="https://bytedance.larkoffice.com/wiki/Ht37wE7wbiPAJpkpQooc4EYenKd?from=from_copylink" ref="nofollow noopener noreferrer">bytedance.larkoffice.com/wiki/Ht37wE…</a></p>
</li>
<li>
<p>VeCLI 文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.volcengine.com%2Fdocs%2F83927%2F1826757" target="_blank" title="https://www.volcengine.com/docs/83927/1826757" ref="nofollow noopener noreferrer">www.volcengine.com/docs/83927/…</a></p>
</li>
<li>
<p>豆包编程模型文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fconsole.volcengine.com%2Fark%2Fregion%3Aark%2Bcn-beijing%2Fmodel%2Fdetail%3FId%3Ddoubao-seed-code" target="_blank" title="https://console.volcengine.com/ark/region:ark+cn-beijing/model/detail?Id=doubao-seed-code" ref="nofollow noopener noreferrer">console.volcengine.com/ark/region:…</a></p>
</li>
<li>
<p>Coding Plan 详情：szacq.cn/F5JBG/</p>
</li>
</ul>
<p><strong>时间</strong></p>
<p>「2025/11/12-2025/12/13」</p>
<ul>
<li>
<p>11.12-11.30 报名&amp;作品提交。报名详情页：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.volcengine.com%2Factivities%2F7569894904566906907" target="_blank" title="https://developer.volcengine.com/activities/7569894904566906907" ref="nofollow noopener noreferrer">developer.volcengine.com/activities/…</a></p>
</li>
<li>
<p>12.1-12.5 作品初筛</p>
</li>
<li>
<p>12.6 初赛路演。初赛路演将在北京、上海、成都、深圳 4 个城市举行，每个区域初筛前 10 名进行路演，各城市初赛前 3 名将进入决赛。</p>
</li>
<li>
<p>12.13 决赛路演</p>
</li>
</ul>
<p><strong>奖项设置</strong></p>
<p>一等奖 1 名：5000 元奖金+获奖证书+扣子周边+流量扶持</p>
<p>二等奖 2 名：4000 元奖金+获奖证书+扣子周边+流量扶持</p>
<p>三等奖 3 名：3000 元奖金+获奖证书+扣子周边+流量扶持</p>
<p>最佳 AI 实践奖 6 名：1000 元奖金+获奖证书+扣子周边+流量扶持</p>
<p><strong>评分标准</strong></p>
<p>评审规则：</p>
<ul>
<li>
<p>评审方：扣子、火山引擎 ADG、火山方舟、火山引擎 veCLI</p>
</li>
<li>
<p>分数构成：总分（100分）= 作品评分（70%）+说明文档评分（30%）</p>
</li>
</ul>
<p><strong>评分维度：</strong></p>
<ul>
<li>
<p>「实用性」20分：作品是否有实用的落地场景，能否解决所属专业领域内的问题。</p>
</li>
<li>
<p>「技术性」40分 ： 作品功能设计的逻辑性、技术实现的成熟度以及整体方案的稳定性。同时考察作品使用的工具丰富性，使用豆包编程模型 Doubao-Seed-Code、 VeCLI 分别得 10 分。</p>
</li>
<li>
<p>「体验性」30分： 考察作品的用户体验质量，包括交互自然度、响应及时性和准确性等。</p>
</li>
</ul>
<p><strong>说明文档评分维度：</strong></p>
<ul>
<li>
<p>作品创意（40 分）：作品的创意思路。</p>
</li>
<li>
<p>实现原理与功能（40分）：各功能实现原理。</p>
</li>
<li>
<p>文档结构（20分）：结构完整，语言简洁，逻辑清晰。</p>
</li>
</ul>
<p>作品说明文档模版：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fbytedance.larkoffice.com%2Fwiki%2FZyopwHYLHiUbS3k79A6ci0Sbndd%3Ffrom%3Dfrom_copylink" target="_blank" title="https://bytedance.larkoffice.com/wiki/ZyopwHYLHiUbS3k79A6ci0Sbndd?from=from_copylink" ref="nofollow noopener noreferrer">bytedance.larkoffice.com/wiki/ZyopwH…</a></p>
<p><strong>作品提交</strong></p>
<p>点击链接填写信息提交您的作品：
<a href="https://link.juejin.cn?target=https%3A%2F%2Fbytedance.larkoffice.com%2Fshare%2Fbase%2Fform%2Fshrcn39zYBrefgIBMiOVQ5wC8ih" target="_blank" title="https://bytedance.larkoffice.com/share/base/form/shrcn39zYBrefgIBMiOVQ5wC8ih" ref="nofollow noopener noreferrer">bytedance.larkoffice.com/share/base/…</a></p>
<hr/>
<p>大赛完整活动包含 3 大赛道，用户可参与多个赛道，最多提交 5 个作品，每个作品参与者不超过 3 人。点击查看其他赛道及完整活动信息：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FQY0trtEFQs5vghGUgLE0aw" target="_blank" title="https://mp.weixin.qq.com/s/QY0trtEFQs5vghGUgLE0aw" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/QY0trtEFQ…</a></p>
<p>此外，大赛还设置了如下特别奖项👇</p>
<p><strong>公益特别奖：最佳 AI 公益奖5名（全赛道）</strong></p>
<ul>
<li>
<p>三大赛道均可参与，形式不限，你可以选择公益场景，或守护银发数字生活与青少年健康成长，或助力乡村教师教学能力提升。让AI不仅能够激发创意、提升效率，更能传递温度，助力科技普惠与创新。</p>
</li>
<li>
<p>奖金 <strong>3000</strong> 元+<strong>公益周边</strong></p>
</li>
</ul>
<p><strong>传播特别奖：最佳 AI 创意奖20名（全赛道）</strong></p>
<ul>
<li>
<p>三大赛道均可参与，形式不限，你可以选择帮你的作品/开发过程等等瞬间发布到抖音、小红书、即刻、B站、公众号、社群等任意社交平台上，艾特@扣子Coze，打上#扣子AI工坊 #扣子空间 两个tag，即可参与评选。</p>
</li>
<li>
<p>我们将根据您的作品互动数据量（点赞、收藏、评论等相关数据）作为评选标准，为您送上<strong>扣子周边三件套</strong>（扣子捏捏、扣子卡套、扣子贴纸）</p>
</li>
</ul>
<p><strong>优秀奖：优秀 AI 实践奖100名（全赛道）</strong></p>
<ul>
<li>三大赛道均可参与，形式不限，符合标准的 Top 100 的作品，将获得优秀 AI 实践奖</li>
</ul>
<p>点击【阅读原文】了解活动详情</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JDK 8 Stream API 教程文档]]></title>    <link>https://juejin.cn/post/7571644531608043566</link>    <guid>https://juejin.cn/post/7571644531608043566</guid>    <pubDate>2025-11-12T09:20:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571644531608043566" data-draft-id="7571644531607846958" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JDK 8 Stream API 教程文档"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-12T09:20:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Main12138"/> <meta itemprop="url" content="https://juejin.cn/user/124660844331034"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JDK 8 Stream API 教程文档
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/124660844331034/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Main12138
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T09:20:09.000Z" title="Wed Nov 12 2025 09:20:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body cache result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Stream 简介</h2>
<p>Stream 是 JDK 8 中处理集合（Collection）数据的新抽象，它可以让你以声明式的方式处理数据，类似于使用 SQL 语句进行数据库查询。</p>
<p>List names = Arrays.asList("Alice", "Bob", "Charlie", "David");</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 传统方式</span>
List&lt;String&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
<span class="hljs-keyword">for</span> (String name : names) {
    <span class="hljs-keyword">if</span> (name.startsWith(<span class="hljs-string">"A"</span>)) {
        result.add(name.toUpperCase());
    }
}

<span class="hljs-comment">// Stream 方式</span>
List&lt;String&gt; streamResult = names.stream()
    .filter(name -&gt; name.startsWith(<span class="hljs-string">"A"</span>))
    .map(String::toUpperCase)
    .collect(Collectors.toList());
</code></pre>
<h2 data-id="heading-1">Stream 的特点</h2>
<ol>
<li><strong>不是数据结构</strong>：Stream 不会存储数据，只是对数据源进行计算</li>
<li><strong>不修改源数据</strong>：对 Stream 的操作不会影响原始数据源</li>
<li><strong>惰性执行</strong>：中间操作是惰性的，只有在终止操作时才会执行</li>
<li><strong>可消费性</strong>：Stream 只能被消费一次</li>
</ol>
<h2 data-id="heading-2">Stream 操作分类</h2>























<table><thead><tr><th>操作类型</th><th>方法示例</th><th>返回值</th><th>特点</th></tr></thead><tbody><tr><td>中间操作</td><td>filter(), map(), sorted()</td><td>Stream</td><td>惰性执行，可链式调用</td></tr><tr><td>终止操作</td><td>forEach(), collect(), count()</td><td>非Stream</td><td>立即执行，关闭流</td></tr></tbody></table>
<h2 data-id="heading-3">创建 Stream</h2>
<h3 data-id="heading-4">1. 从集合创建</h3>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; list = Arrays.asList(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>);
Stream&lt;String&gt; stream = list.stream();
</code></pre>
<h3 data-id="heading-5">2. 从数组创建</h3>
<pre><code class="hljs language-java" lang="java">String[] array = {<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>};
Stream&lt;String&gt; stream = Arrays.stream(array);
</code></pre>
<h3 data-id="heading-6">3. 使用 Stream.of()</h3>
<pre><code class="hljs language-java" lang="java">Stream&lt;String&gt; stream = Stream.of(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>);
</code></pre>
<h3 data-id="heading-7">4. 创建数值流</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">IntStream</span> <span class="hljs-variable">intStream</span> <span class="hljs-operator">=</span> IntStream.range(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>);     <span class="hljs-comment">// 1,2,3,4</span>
<span class="hljs-type">IntStream</span> <span class="hljs-variable">closedStream</span> <span class="hljs-operator">=</span> IntStream.rangeClosed(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>); <span class="hljs-comment">// 1,2,3,4,5</span>
</code></pre>
<h3 data-id="heading-8">5. 创建无限流</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 生成10个随机数</span>
Stream&lt;Double&gt; randomStream = Stream.generate(Math::random).limit(<span class="hljs-number">10</span>);

<span class="hljs-comment">// 创建斐波那契数列</span>
Stream.iterate(<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]{<span class="hljs-number">0</span>, <span class="hljs-number">1</span>}, t -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]{t[<span class="hljs-number">1</span>], t[<span class="hljs-number">0</span>] + t[<span class="hljs-number">1</span>]})
      .limit(<span class="hljs-number">10</span>)
      .map(t -&gt; t[<span class="hljs-number">0</span>])
      .forEach(System.out::println);
</code></pre>
<h2 data-id="heading-9">中间操作</h2>
<h3 data-id="heading-10">1. filter() - 过滤</h3>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; names = Arrays.asList(<span class="hljs-string">"Alice"</span>, <span class="hljs-string">"Bob"</span>, <span class="hljs-string">"Charlie"</span>, <span class="hljs-string">"David"</span>);
List&lt;String&gt; result = names.stream()
    .filter(name -&gt; name.length() &gt; <span class="hljs-number">3</span>)
    .collect(Collectors.toList());
<span class="hljs-comment">// 结果: [Alice, Charlie, David]</span>
</code></pre>
<h3 data-id="heading-11">2. map() - 映射</h3>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; names = Arrays.asList(<span class="hljs-string">"Alice"</span>, <span class="hljs-string">"Bob"</span>, <span class="hljs-string">"Charlie"</span>);
List&lt;Integer&gt; nameLengths = names.stream()
    .map(String::length)
    .collect(Collectors.toList());
<span class="hljs-comment">// 结果: [5, 3, 7]</span>
</code></pre>
<h3 data-id="heading-12">3. flatMap() - 扁平化映射</h3>
<pre><code class="hljs language-java" lang="java">List&lt;List&lt;String&gt;&gt; listOfLists = Arrays.asList(
    Arrays.asList(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>),
    Arrays.asList(<span class="hljs-string">"c"</span>, <span class="hljs-string">"d"</span>)
);

List&lt;String&gt; flatList = listOfLists.stream()
    .flatMap(List::stream)
    .collect(Collectors.toList());
<span class="hljs-comment">// 结果: [a, b, c, d]</span>
</code></pre>
<h3 data-id="heading-13">4. distinct() - 去重</h3>
<pre><code class="hljs language-java" lang="java">List&lt;Integer&gt; numbers = Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>);
List&lt;Integer&gt; distinctNumbers = numbers.stream()
    .distinct()
    .collect(Collectors.toList());
<span class="hljs-comment">// 结果: [1, 2, 3]</span>
</code></pre>
<h3 data-id="heading-14">5. sorted() - 排序</h3>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; names = Arrays.asList(<span class="hljs-string">"Charlie"</span>, <span class="hljs-string">"Alice"</span>, <span class="hljs-string">"Bob"</span>);
List&lt;String&gt; sortedNames = names.stream()
    .sorted()
    .collect(Collectors.toList());
<span class="hljs-comment">// 结果: [Alice, Bob, Charlie]</span>

<span class="hljs-comment">// 自定义排序</span>
List&lt;String&gt; customSorted = names.stream()
    .sorted((a, b) -&gt; b.length() - a.length())
    .collect(Collectors.toList());
<span class="hljs-comment">// 结果: [Charlie, Alice, Bob]</span>
</code></pre>
<h3 data-id="heading-15">6. limit() 和 skip() - 限制和跳过</h3>
<pre><code class="hljs language-java" lang="java">List&lt;Integer&gt; numbers = Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>);

List&lt;Integer&gt; limited = numbers.stream()
    .limit(<span class="hljs-number">5</span>)
    .collect(Collectors.toList());
<span class="hljs-comment">// 结果: [1, 2, 3, 4, 5]</span>

List&lt;Integer&gt; skipped = numbers.stream()
    .skip(<span class="hljs-number">5</span>)
    .collect(Collectors.toList());
<span class="hljs-comment">// 结果: [6, 7, 8, 9, 10]</span>
</code></pre>
<h3 data-id="heading-16">7. peek() - 查看元素（主要用于调试）</h3>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; result = Stream.of(<span class="hljs-string">"one"</span>, <span class="hljs-string">"two"</span>, <span class="hljs-string">"three"</span>)
    .filter(s -&gt; s.length() &gt; <span class="hljs-number">3</span>)
    .peek(s -&gt; System.out.println(<span class="hljs-string">"Filtered value: "</span> + s))
    .map(String::toUpperCase)
    .peek(s -&gt; System.out.println(<span class="hljs-string">"Mapped value: "</span> + s))
    .collect(Collectors.toList());
</code></pre>
<h2 data-id="heading-17">终止操作</h2>
<h3 data-id="heading-18">1. forEach() - 遍历</h3>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; names = Arrays.asList(<span class="hljs-string">"Alice"</span>, <span class="hljs-string">"Bob"</span>, <span class="hljs-string">"Charlie"</span>);
names.stream().forEach(System.out::println);
</code></pre>
<h3 data-id="heading-19">2. collect() - 收集</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 转换为List</span>
List&lt;String&gt; list = stream.collect(Collectors.toList());

<span class="hljs-comment">// 转换为Set</span>
Set&lt;String&gt; set = stream.collect(Collectors.toSet());

<span class="hljs-comment">// 转换为Map</span>
Map&lt;String, Integer&gt; map = stream.collect(
    Collectors.toMap(s -&gt; s, String::length)
);

<span class="hljs-comment">// 连接字符串</span>
<span class="hljs-type">String</span> <span class="hljs-variable">joined</span> <span class="hljs-operator">=</span> stream.collect(Collectors.joining(<span class="hljs-string">", "</span>));

<span class="hljs-comment">// 分组</span>
Map&lt;Integer, List&lt;String&gt;&gt; grouped = names.stream()
    .collect(Collectors.groupingBy(String::length));

<span class="hljs-comment">// 分区</span>
Map&lt;Boolean, List&lt;String&gt;&gt; partitioned = names.stream()
    .collect(Collectors.partitioningBy(s -&gt; s.length() &gt; <span class="hljs-number">3</span>));
</code></pre>
<h3 data-id="heading-20">3. reduce() - 归约</h3>
<pre><code class="hljs language-java" lang="java">List&lt;Integer&gt; numbers = Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>);

<span class="hljs-comment">// 求和</span>
Optional&lt;Integer&gt; sum = numbers.stream().reduce(Integer::sum);
<span class="hljs-comment">// 或</span>
<span class="hljs-type">Integer</span> <span class="hljs-variable">sum2</span> <span class="hljs-operator">=</span> numbers.stream().reduce(<span class="hljs-number">0</span>, Integer::sum);

<span class="hljs-comment">// 求最大值</span>
Optional&lt;Integer&gt; max = numbers.stream().reduce(Integer::max);

<span class="hljs-comment">// 字符串连接</span>
Optional&lt;String&gt; concat = Stream.of(<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>).reduce(String::concat);
</code></pre>
<h3 data-id="heading-21">4. 匹配操作</h3>
<pre><code class="hljs language-java" lang="java">List&lt;Integer&gt; numbers = Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>);

<span class="hljs-type">boolean</span> <span class="hljs-variable">allEven</span> <span class="hljs-operator">=</span> numbers.stream().allMatch(n -&gt; n % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>); <span class="hljs-comment">// false</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">anyEven</span> <span class="hljs-operator">=</span> numbers.stream().anyMatch(n -&gt; n % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>); <span class="hljs-comment">// true</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">noneEven</span> <span class="hljs-operator">=</span> numbers.stream().noneMatch(n -&gt; n % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>); <span class="hljs-comment">// false</span>
</code></pre>
<h3 data-id="heading-22">5. 查找操作</h3>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; names = Arrays.asList(<span class="hljs-string">"Alice"</span>, <span class="hljs-string">"Bob"</span>, <span class="hljs-string">"Charlie"</span>);

Optional&lt;String&gt; first = names.stream().findFirst();
Optional&lt;String&gt; any = names.stream().findAny();
</code></pre>
<h3 data-id="heading-23">6. 统计操作</h3>
<pre><code class="hljs language-java" lang="java">List&lt;Integer&gt; numbers = Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>);

<span class="hljs-type">long</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> numbers.stream().count();
<span class="hljs-type">IntSummaryStatistics</span> <span class="hljs-variable">stats</span> <span class="hljs-operator">=</span> numbers.stream()
    .mapToInt(Integer::intValue)
    .summaryStatistics();

System.out.println(<span class="hljs-string">"最大值: "</span> + stats.getMax());
System.out.println(<span class="hljs-string">"最小值: "</span> + stats.getMin());
System.out.println(<span class="hljs-string">"总和: "</span> + stats.getSum());
System.out.println(<span class="hljs-string">"平均值: "</span> + stats.getAverage());
</code></pre>
<h2 data-id="heading-24">并行流</h2>
<h3 data-id="heading-25">创建并行流</h3>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; names = Arrays.asList(<span class="hljs-string">"Alice"</span>, <span class="hljs-string">"Bob"</span>, <span class="hljs-string">"Charlie"</span>);

<span class="hljs-comment">// 方法1：从集合创建</span>
Stream&lt;String&gt; parallelStream = names.parallelStream();

<span class="hljs-comment">// 方法2：将顺序流转为并行流</span>
Stream&lt;String&gt; parallel = names.stream().parallel();
</code></pre>
<h3 data-id="heading-26">并行流示例</h3>
<pre><code class="hljs language-java" lang="java">List&lt;Integer&gt; numbers = Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>);

<span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
<span class="hljs-type">long</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> numbers.parallelStream()
    .mapToLong(Integer::longValue)
    .sum();
<span class="hljs-type">long</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();

System.out.println(<span class="hljs-string">"总和: "</span> + sum);
System.out.println(<span class="hljs-string">"执行时间: "</span> + (endTime - startTime) + <span class="hljs-string">"ms"</span>);
</code></pre>
<h3 data-id="heading-27">并行流注意事项</h3>
<ol>
<li><strong>线程安全</strong>：确保操作是线程安全的</li>
<li><strong>状态无关</strong>：避免有状态的lambda表达式</li>
<li><strong>顺序敏感</strong>：某些操作（如findFirst）在并行流中性能可能更差</li>
<li><strong>数据量</strong>：小数据量使用并行流可能适得其反</li>
</ol>
<h2 data-id="heading-28">实战示例</h2>
<h3 data-id="heading-29">示例1：员工数据处理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Employee</span> {
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> String department;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> salary;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;
    
    <span class="hljs-comment">// 构造方法、getter、setter省略</span>
}

List&lt;Employee&gt; employees = Arrays.asList(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Employee</span>(<span class="hljs-string">"Alice"</span>, <span class="hljs-string">"IT"</span>, <span class="hljs-number">5000</span>, <span class="hljs-number">25</span>),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Employee</span>(<span class="hljs-string">"Bob"</span>, <span class="hljs-string">"HR"</span>, <span class="hljs-number">4000</span>, <span class="hljs-number">30</span>),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Employee</span>(<span class="hljs-string">"Charlie"</span>, <span class="hljs-string">"IT"</span>, <span class="hljs-number">6000</span>, <span class="hljs-number">35</span>),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Employee</span>(<span class="hljs-string">"David"</span>, <span class="hljs-string">"Finance"</span>, <span class="hljs-number">5500</span>, <span class="hljs-number">28</span>)
);

<span class="hljs-comment">// 1. 按部门分组，计算每个部门的平均工资</span>
Map&lt;String, Double&gt; avgSalaryByDept = employees.stream()
    .collect(Collectors.groupingBy(
        Employee::getDepartment,
        Collectors.averagingDouble(Employee::getSalary)
    ));

<span class="hljs-comment">// 2. 找出IT部门工资最高的员工</span>
Optional&lt;Employee&gt; highestPaidInIT = employees.stream()
    .filter(e -&gt; <span class="hljs-string">"IT"</span>.equals(e.getDepartment()))
    .max(Comparator.comparingDouble(Employee::getSalary));

<span class="hljs-comment">// 3. 按年龄排序，获取前3名员工</span>
List&lt;Employee&gt; top3ByAge = employees.stream()
    .sorted(Comparator.comparingInt(Employee::getAge).reversed())
    .limit(<span class="hljs-number">3</span>)
    .collect(Collectors.toList());

<span class="hljs-comment">// 4. 统计每个部门的员工数量</span>
Map&lt;String, Long&gt; employeeCountByDept = employees.stream()
    .collect(Collectors.groupingBy(
        Employee::getDepartment, 
        Collectors.counting()
    ));
</code></pre>
<h3 data-id="heading-30">示例2：文件处理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 读取文件并统计单词频率</span>
<span class="hljs-keyword">try</span> (Stream&lt;String&gt; lines = Files.lines(Paths.get(<span class="hljs-string">"file.txt"</span>))) {
    Map&lt;String, Long&gt; wordCount = lines
        .flatMap(line -&gt; Arrays.stream(line.split(<span class="hljs-string">"\s+"</span>)))
        .map(word -&gt; word.replaceAll(<span class="hljs-string">"[^a-zA-Z]"</span>, <span class="hljs-string">""</span>).toLowerCase())
        .filter(word -&gt; !word.isEmpty())
        .collect(Collectors.groupingBy(
            word -&gt; word, 
            Collectors.counting()
        ));
    
    <span class="hljs-comment">// 按频率排序</span>
    wordCount.entrySet().stream()
        .sorted(Map.Entry.&lt;String, Long&gt;comparingByValue().reversed())
        .limit(<span class="hljs-number">10</span>)
        .forEach(entry -&gt; 
            System.out.println(entry.getKey() + <span class="hljs-string">": "</span> + entry.getValue())
        );
} <span class="hljs-keyword">catch</span> (IOException e) {
    e.printStackTrace();
}
</code></pre>
<h3 data-id="heading-31">示例3：复杂数据转换</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 多层数据转换和聚合</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> {
    <span class="hljs-keyword">private</span> String customer;
    <span class="hljs-keyword">private</span> List&lt;OrderItem&gt; items;
    <span class="hljs-keyword">private</span> LocalDate orderDate;
    <span class="hljs-comment">// 构造方法、getter、setter省略</span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderItem</span> {
    <span class="hljs-keyword">private</span> String product;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> quantity;
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> price;
    <span class="hljs-comment">// 构造方法、getter、setter省略</span>
}

List&lt;Order&gt; orders = <span class="hljs-comment">// 初始化订单数据</span>

<span class="hljs-comment">// 计算每个客户的总消费金额</span>
Map&lt;String, Double&gt; customerTotal = orders.stream()
    .collect(Collectors.groupingBy(
        Order::getCustomer,
        Collectors.summingDouble(order -&gt; 
            order.getItems().stream()
                .mapToDouble(item -&gt; item.getQuantity() * item.getPrice())
                .sum()
        )
    ));

<span class="hljs-comment">// 找出最畅销的产品</span>
Optional&lt;String&gt; bestSellingProduct = orders.stream()
    .flatMap(order -&gt; order.getItems().stream())
    .collect(Collectors.groupingBy(
        OrderItem::getProduct,
        Collectors.summingInt(OrderItem::getQuantity)
    ))
    .entrySet().stream()
    .max(Map.Entry.comparingByValue())
    .map(Map.Entry::getKey);
</code></pre>
<h2 data-id="heading-32">最佳实践</h2>
<ol>
<li><strong>优先使用方法引用</strong>：使代码更简洁</li>
<li><strong>避免副作用</strong>：保持函数的纯粹性</li>
<li><strong>合理使用并行流</strong>：根据数据量和操作复杂度决定</li>
<li><strong>及时关闭资源</strong>：使用try-with-resources处理IO相关的Stream</li>
<li><strong>合理使用Optional</strong>：避免空指针异常</li>
</ol>
<h2 data-id="heading-33">总结</h2>
<p>JDK 8 的 Stream API 为集合操作提供了强大的函数式编程能力，通过链式调用和惰性求值等特性，可以写出更简洁、易读、高效的代码。掌握 Stream API 对于现代 Java 开发至关重要。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🐳 Docker Compose 项目目录被删除后，如何安全关停残留容器]]></title>    <link>https://juejin.cn/post/7571594817223966771</link>    <guid>https://juejin.cn/post/7571594817223966771</guid>    <pubDate>2025-11-12T09:19:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571594817223966771" data-draft-id="7571475192490393610" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🐳 Docker Compose 项目目录被删除后，如何安全关停残留容器"/> <meta itemprop="keywords" content="Docker"/> <meta itemprop="datePublished" content="2025-11-12T09:19:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Allenz"/> <meta itemprop="url" content="https://juejin.cn/user/1081575170128279"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🐳 Docker Compose 项目目录被删除后，如何安全关停残留容器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1081575170128279/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Allenz
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T09:19:07.000Z" title="Wed Nov 12 2025 09:19:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🐳 Docker Compose 项目目录被删除后，如何安全关停残留容器</h2>
<p>在日常使用 Docker Compose 时，我们经常会遇到一种情况：<br/>
项目目录被删除了，但容器依然在运行，<code>docker compose down</code> 也失效了。<br/>
本文总结了如何安全地清理这些“失联”的 Compose 项目。</p>
<hr/>
<h3 data-id="heading-1">一、发现问题：项目目录已丢失</h3>
<p>我们可以先列出所有 Compose 项目：</p>
<pre><code class="hljs language-bash" lang="bash">docker compose <span class="hljs-built_in">ls</span>
</code></pre>
<p>输出示例：</p>
<pre><code class="hljs language-scss" lang="scss">NAME            STATUS         CONFIG_FILES
webapp          <span class="hljs-built_in">running</span>(<span class="hljs-number">3</span>)     /home/user/webapp/docker-compose<span class="hljs-selector-class">.yml</span>
oldservice      <span class="hljs-built_in">running</span>(<span class="hljs-number">2</span>)     &lt;no such file or directory&gt;
</code></pre>
<p>可以看到 <code>oldservice</code> 的目录已经不存在，但容器还在运行。</p>
<hr/>
<h3 data-id="heading-2">二、确认该项目对应的容器</h3>
<p>Docker Compose 启动的容器都有一个统一的 label：<br/>
<code>com.docker.compose.project=&lt;project_name&gt;</code></p>
<p>通过它可以筛选出所有属于该项目的容器：</p>
<pre><code class="hljs language-css" lang="css">docker ps -<span class="hljs-selector-tag">a</span> <span class="hljs-attr">--filter</span> "<span class="hljs-selector-tag">label</span>=com<span class="hljs-selector-class">.docker</span><span class="hljs-selector-class">.compose</span><span class="hljs-selector-class">.project</span>=oldservice"
</code></pre>
<p>这会列出所有 <code>oldservice</code> 的容器。</p>
<hr/>
<h3 data-id="heading-3">三、关闭并删除这些容器</h3>
<p>停掉容器：</p>
<pre><code class="hljs language-css" lang="css">docker stop $(docker ps -<span class="hljs-selector-tag">q</span> <span class="hljs-attr">--filter</span> "<span class="hljs-selector-tag">label</span>=com<span class="hljs-selector-class">.docker</span><span class="hljs-selector-class">.compose</span><span class="hljs-selector-class">.project</span>=oldservice")
</code></pre>
<p>删除容器：</p>
<pre><code class="hljs language-bash" lang="bash">docker <span class="hljs-built_in">rm</span> $(docker ps -aq --filter <span class="hljs-string">"label=com.docker.compose.project=oldservice"</span>)
</code></pre>
<hr/>
<h3 data-id="heading-4">四、清理残留的网络和卷（可选）</h3>
<p>Compose 会创建网络和卷，也可以用 label 删除：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 删除网络</span>
docker network <span class="hljs-built_in">rm</span> $(docker network <span class="hljs-built_in">ls</span> -q --filter <span class="hljs-string">"label=com.docker.compose.project=oldservice"</span>)

<span class="hljs-comment"># 删除卷（⚠️ 慎用，会删除数据）</span>
docker volume <span class="hljs-built_in">rm</span> $(docker volume <span class="hljs-built_in">ls</span> -q --filter <span class="hljs-string">"label=com.docker.compose.project=oldservice"</span>)
</code></pre>
<p>执行前可以先查看确认：</p>
<pre><code class="hljs language-bash" lang="bash">docker network <span class="hljs-built_in">ls</span>
docker volume <span class="hljs-built_in">ls</span>
</code></pre>
<hr/>
<h3 data-id="heading-5">五、验证清理结果</h3>
<p>再次查看：</p>
<pre><code class="hljs language-bash" lang="bash">docker compose <span class="hljs-built_in">ls</span>
</code></pre>
<p>如果 <code>oldservice</code> 已经不在列表中，说明清理干净 ✅。</p>
<hr/>
<h3 data-id="heading-6">六、一键清理“失效项目”（可选脚本）</h3>
<p>如果有多个项目目录丢失，可以用下面的脚本自动检测并清理：</p>
<pre><code class="hljs language-bash" lang="bash">docker compose <span class="hljs-built_in">ls</span> --format json | jq -r <span class="hljs-string">'.[] | select(.ConfigFiles | test("no such file") or test("null")) | .Name'</span> |
<span class="hljs-keyword">while</span> <span class="hljs-built_in">read</span> name; <span class="hljs-keyword">do</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"Cleaning project: <span class="hljs-variable">$name</span>"</span>
  docker stop $(docker ps -q --filter <span class="hljs-string">"label=com.docker.compose.project=<span class="hljs-variable">$name</span>"</span>) 2&gt;/dev/null
  docker <span class="hljs-built_in">rm</span> $(docker ps -aq --filter <span class="hljs-string">"label=com.docker.compose.project=<span class="hljs-variable">$name</span>"</span>) 2&gt;/dev/null
  docker network <span class="hljs-built_in">rm</span> $(docker network <span class="hljs-built_in">ls</span> -q --filter <span class="hljs-string">"label=com.docker.compose.project=<span class="hljs-variable">$name</span>"</span>) 2&gt;/dev/null
<span class="hljs-keyword">done</span>
</code></pre>
<p>保存为 <code>docker-compose-clean.sh</code>，添加执行权限：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">chmod</span> +x docker-compose-clean.sh
</code></pre>
<p>运行即可批量清理失效的 Compose 项目。</p>
<hr/>
<h3 data-id="heading-7">✅ 总结</h3>








































<table><thead><tr><th>操作</th><th>命令 / 方法</th><th>说明</th></tr></thead><tbody><tr><td>查看项目</td><td><code>docker compose ls</code></td><td>检查是否有目录丢失</td></tr><tr><td>查看容器</td><td><code>docker ps -a --filter label=com.docker.compose.project=xxx</code></td><td>找到相关容器</td></tr><tr><td>停止容器</td><td><code>docker stop ...</code></td><td>关闭运行的容器</td></tr><tr><td>删除容器</td><td><code>docker rm ...</code></td><td>移除容器</td></tr><tr><td>删除网络和卷</td><td><code>docker network/volume rm ...</code></td><td>可选清理</td></tr><tr><td>批量清理脚本</td><td><code>docker-compose-clean.sh</code></td><td>一键清理失效项目</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[翻译界的 ChatGPT 时刻！Meta 发布新模型，几段示例学会冷门新语言]]></title>    <link>https://juejin.cn/post/7571655312798187546</link>    <guid>https://juejin.cn/post/7571655312798187546</guid>    <pubDate>2025-11-12T09:04:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571655312798187546" data-draft-id="7571594817223819315" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="翻译界的 ChatGPT 时刻！Meta 发布新模型，几段示例学会冷门新语言"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-11-12T09:04:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新智元"/> <meta itemprop="url" content="https://juejin.cn/user/952600743642312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            翻译界的 ChatGPT 时刻！Meta 发布新模型，几段示例学会冷门新语言
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/952600743642312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新智元
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T09:04:36.000Z" title="Wed Nov 12 2025 09:04:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"/>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35289ab50c1343c5ae82eb2d08fc5856~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543076&amp;x-signature=7s4ov%2BYyFOTClN666t4tf%2BWM%2Foc%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-1"><strong>「【新智元导读】在 7000 多种人类语言中，只有少数被现代语音技术听见，如今这种不平等或将被打破。Meta 发布的 Omnilingual ASR 系统能识别 1600 多种语言，并可通过少量示例快速学会新语言。以开源与社区共创为核心，这项技术让每一种声音都有机会登上 AI 的舞台。」</strong></h5>
<p>你或许很难想象，在世界上 7000 多种活跃语言中，只有几百种享受过现代语音技术的「宠爱」。</p>
<p>绝大多数人类语言的使用者——从非洲部落的土著、亚马逊雨林的族群，到乡野小镇仍讲着古老方言的老人—— 一直生活在数字时代的旁白之外。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8385a2a59613471e8d84945ce630f7e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543076&amp;x-signature=%2BzyFmllhH5FXPbKuVRKxbuqs8Ew%3D" alt="" loading="lazy"/></p>
<p>语音助手、自动字幕、实时翻译，这些 AI 带来的便利仿佛只为少数「主流」语言而生，其余的语言社区仍被挡在技术大门之外。</p>
<p>这种数字鸿沟如今迎来了破局者。</p>
<p>Meta 人工智能研究团队日前发布了 Omnilingual ASR 系统，一个可自动识别转录 1600 多种语言语音的 AI 模型族，让几乎所有人类语言都能被机器「听懂」。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70bda614815a488ab485b8cb8c9a8f6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543076&amp;x-signature=juImunc4tN8uadBg438jrKZc92Q%3D" alt="" loading="lazy"/></p>
<p>这套系统以开源方式共享给全世界，并能由社区亲手拓展新的语言，让每一种声音都有机会登上 AI 的舞台。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8b0e708033a4de6b46e779c9d16db6a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543076&amp;x-signature=z4vP4gaKh%2FcTFLa1jiVYB5rAMyU%3D" alt="" loading="lazy"/></p>
<p>论文地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fai.meta.com%2Fresearch%2Fpublications%2Fomnilingual-asr-open-source-multilingual-speech-recognition-for-1600-languages%2F" target="_blank" title="https://ai.meta.com/research/publications/omnilingual-asr-open-source-multilingual-speech-recognition-for-1600-languages/" ref="nofollow noopener noreferrer">ai.meta.com/research/pu…</a></p>
<p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffacebookresearch%2Fomnilingual-asr%3Ftab%3Dreadme-ov-file" target="_blank" title="https://github.com/facebookresearch/omnilingual-asr?tab=readme-ov-file" ref="nofollow noopener noreferrer">github.com/facebookres…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0cb6f41908cb475c955b24b02d23122c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543076&amp;x-signature=H6vCf4i1zAPW8PXXDzzKTH6u5o4%3D" alt="" loading="lazy"/></p>
<p><strong>「1600 种语言，只是开始」</strong></p>
<p>Meta 此次推出的 Omnilingual ASR 创造了语音识别覆盖语言数量的新纪录，支持超过 1600 种语言，其中包括 500 种此前从未被任何 AI 系统转录过的语言。</p>
<p>相比之下，OpenAI 开源的 Whisper 模型只支持 99 种语言，而 Omnilingual ASR 几乎将这一数字提升了一个数量级。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b88fb1635b564555931fc7fbde9b0c53~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543076&amp;x-signature=OJyAyTNYq3zAnTbKiZbuGhRpn5M%3D" alt="" loading="lazy"/></p>
<p>对于全球众多使用小语种的人来说，这无疑是一次「数字雪耻」：他们的母语第一次有了被 AI 流利听懂的可能性。</p>
<p>这套系统的识别性能在很多语种上已达到领先水平。</p>
<p>据 Meta 提供的数据，在所测试的 1600 多种语言中，有 78% 的语种其识别错误率（CER）低于 10%，若以 10 小时以上语音数据训练的语种来看，这一比例更是达到 95%。</p>
<p>即使对于训练语料极其稀少的低资源语言，仍有 36% 实现了 CER 低于 10% 的效果。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5bfe9ee07c47406f9c869a9ba3722975~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543076&amp;x-signature=xxw%2FXHHfK5Tc38OSxuGD%2FXlX4VY%3D" alt="" loading="lazy"/></p>
<p>这些数字意味着，Omnilingual ASR 不仅覆盖面广，而且在大多数语言上都能给出实用且高质量的转录结果。</p>
<p>然而，1600 种语言还不是 Omnilingual ASR 的终点。</p>
<p>更大的意义在于，它打破了以往 ASR 模型支持语言范围固定死板的局限，让语言覆盖从「定量」走向「可扩展」。</p>
<p>Omnilingual ASR 借鉴了大语言模型（LLM）的思路，引入了零样本的「上下文学习」机制。</p>
<p>这意味着即便某种语言最初不在支持列表中，用户也可以通过提供几段该语言的音频和对应文本作为示例，在推理过程中即时让模型学会一种新语言。</p>
<p>无需耗费数月收集大型语料、无需专业深度学习训练，只需简单的少样本学习（few-shot）即可学会新语言。</p>
<p>凭借这种革新性的范式，Omnilingual ASR 的潜在语言覆盖能力骤然扩张。</p>
<p>官方表示，理论上该系统可以扩展到超过 5400 种语言，几乎涵盖所有有文字记录的人类语言！</p>
<p>无论多冷门的口语，只要有对应的书写体系和几句示例，它就有机会被 Omnilingual ASR 捕捉记录。</p>
<p>在 AI 语音识别领域，这是从静态封闭走向动态自适应的范式转变——模型不再束缚于训练时预设的语言清单，而成为一个灵活开放的框架，鼓励各地社区自行加入新语言。</p>
<p>对于那些长期缺席于技术版图的族群来说，这无异于掌握了一把可以随时亲手「解锁」新语言的大门钥匙。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45cb950026544062a56224dbb63de755~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543076&amp;x-signature=PFiiO0esWWoXUY4DytwUlpxK6LU%3D" alt="" loading="lazy"/></p>
<p><strong>「开源与社区」</strong></p>
<p><strong>「打破语言鸿沟」</strong></p>
<p>Omnilingual ASR 的另一个显著特点在于其开源和社区驱动的属性。</p>
<p>Meta 选择将这一庞大的多语种 ASR 系统在 GitHub 上完全开源，采用 Apache 2.0 许可发布模型和代码。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e5d6eeb2e774ce5ad1a9db010859706~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543076&amp;x-signature=dRKP4NetL220b0bxe4WKBQbcU%2Bs%3D" alt="" loading="lazy"/></p>
<p>无论是研究人员、开发者还是企业机构，都可以免费使用、修改、商用这套模型，而无需担心繁琐的授权限制。</p>
<p>对比此前一些 AI 模型带有附加条款的「半开源」模式，Omnilingual ASR 的开放姿态可谓十分坦荡，为技术民主化树立了榜样。</p>
<p>为了让各语言社区都能受益，Meta 不仅开放了模型，还同步释放了一个巨大的多语言语音数据集——Omnilingual ASR 语料库。</p>
<p>该语料库包含了 350 种语料稀缺的语言的转录语音数据，覆盖了许多以前在数字世界中「失声」的语言。</p>
<p>所有数据以 CC-BY 协议开放提供。</p>
<p>开发者和学者可以利用这些宝贵资源，去训练改进适合本地需求的语音识别模型。</p>
<p>这一举措无疑将帮助那些缺乏大规模标注语料的语言跨越数据门槛，让「小语言」也有大作为的机会。</p>
<p>Omnilingual ASR 能够囊括前所未有的语言广度，离不开全球合作的支撑。</p>
<p>在开发过程中，Meta 与各地的语言组织和社区携手收集了大量语音样本。</p>
<p>他们与 Mozilla 基金会的 Common Voice 项目、非洲的 Lanfrica/NaijaVoices 等机构合作，从偏远地区招募母语人士录制语音。</p>
<p>为确保数据多样且贴近生活，这些录音往往采用开放式提问，让说话人自由表达日常想法。</p>
<p>所有参与者都获得了合理报酬，并遵循文化敏感性的指导进行采集。</p>
<p>这种社区共创的模式赋予了 Omnilingual ASR 深厚的语言学知识和文化理解，也彰显了项目的人文关怀：技术开发并没有也不应该居高临下地「拯救」小语种，而是与当地社区合作，让他们自己成为语言数字化的主角。</p>
<p>技术规格上，Meta 提供了一系列不同规模的模型以适配多样化的应用场景：从参数量约 3 亿的轻量级模型（适合手机等低功耗设备）到高达 70 亿参数的强力模型（追求极致准确率）一应俱全。</p>
<p>模型架构采用自监督预训练的 wav2vec 2.0 语音编码器（拓展到 70 亿参数规模）提取通用音频特征，并结合两种解码器策略：一种是传统的 CTC 解码，另一种则是融入 Transformer 的大模型文本解码器，后者赋予了模型强大的上下文学习能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/deb9adaa872842d7b4b1d8a4947e7caa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543076&amp;x-signature=4hD54n%2Fbro7nBUj8flJV2%2BHOL44%3D" alt="" loading="lazy"/></p>
<p>庞大的模型需要海量数据来支撑——Omnilingual ASR 训练使用了超过 430 万小时的语音音频，涵盖 1239 种语言的素材。</p>
<p>这是有史以来最大规模、多样性最高的语音训练语料之一。如此大体量的数据加上社区贡献的长尾语言语料，确保了模型对各种语言都学到稳健的语音表示，甚至对完全没见过的语言也有良好的泛化基础。</p>
<p>正如研究论文所指出的，「没有任何模型能预先涵盖世界上所有语言，但 Omnilingual ASR 让社区能够用自己的数据持续拓展这份清单」。</p>
<p>这标志着语音 AI 从此具备了自我生长的生命力，能够与人类语言的丰富多样性共同进化。</p>
<p>当技术放下傲慢，以开源姿态拥抱多元，当每一种语言的声音都有机会被聆听和记录，当没有任何一种语言被数字世界遗忘，我们离真正消弭语言鸿沟又近了一大步，人类的连接才能真正开始消除边界。</p>
<p>参考资料：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fai.meta.com%2Fblog%2Fomnilingual-asr-advancing-automatic-speech-recognition" target="_blank" title="https://ai.meta.com/blog/omnilingual-asr-advancing-automatic-speech-recognition" ref="nofollow noopener noreferrer">ai.meta.com/blog/omnili…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[全球第二、国内第一！钉钉发布DeepResearch多智能体框架，已在真实企业部署]]></title>    <link>https://juejin.cn/post/7571655312798203930</link>    <guid>https://juejin.cn/post/7571655312798203930</guid>    <pubDate>2025-11-12T09:07:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571655312798203930" data-draft-id="7571644531607814190" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="全球第二、国内第一！钉钉发布DeepResearch多智能体框架，已在真实企业部署"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-11-12T09:07:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="机器之心"/> <meta itemprop="url" content="https://juejin.cn/user/1873223543167902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            全球第二、国内第一！钉钉发布DeepResearch多智能体框架，已在真实企业部署
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223543167902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    机器之心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T09:07:40.000Z" title="Wed Nov 12 2025 09:07:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在数字经济浪潮中，企业对于高效、精准的信息获取与决策支持的需求日益迫切。从前沿科学探索到行业趋势分析，再到企业级决策支持，一个能够从海量异构数据源中提取关键知识、执行多步骤推理并生成结构化或多模态输出的「深度研究系统」正变得不可或缺。</p>
<p>然而，现有的研究系统，尽管各自在特定领域有所建树，却普遍面临着难以适应真实世界企业环境的挑战：</p>
<ul>
<li>
<p><strong>静态架构与缺乏适应性：</strong>  多数系统依赖静态提示或固定脚本，缺乏从真实世界反馈中学习和优化的机制，难以适应不断变化的业务需求和数据分布。</p>
</li>
<li>
<p><strong>私有数据集成与动态优化不足：</strong>  现有的研究型智能体，如 OpenAI 的 GPT 代理，在集成公共信息源方面表现出色，但往往难以安全、高效地整合企业私有数据，也缺乏动态优化能力。</p>
</li>
<li>
<p><strong>缺乏自动化评估与持续优化：</strong>  像 Anthropic 的 Claude Research Workbench 虽然强调安全性与人机协作，但缺少自动评估和连续优化机制，难以在部署环境中实现持续改进。</p>
</li>
<li>
<p><strong>长短期记忆与动态演进机制缺失：</strong>  多数系统缺乏有效的长短期记忆能力，无法积累和重用历史经验，导致智能体在处理复杂、长期任务时效率低下且无法持续进步。</p>
</li>
<li>
<p><strong>表格结构化推理与文本合成的脱节：</strong>  企业数据中包含大量半结构化或复杂表格，但现有系统往往难以将表格的精确符号推理与非结构化文本的生成合成有效结合。</p>
</li>
<li>
<p><strong>缺乏评估驱动的闭环迭代：</strong>  许多系统缺少一个评估驱动的闭环优化流程，无法系统性地识别低性能案例、进行有针对性的改进并防止性能退化。</p>
</li>
</ul>
<p>为了填补这些空白，阿里巴巴钉钉（Dingtalk）团队提出了 Dingtalk-DeepResearch，一个为复杂、演进的企业任务设计的统一多智能体智能框架，旨在整合深度研究生成、异构表格推理和多模态报告合成，从而提供一个适应性强、可部署、企业级的解决方案。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/16c8be25baeb4a36ae48dee4bfb54e6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543259&amp;x-signature=U5MTR7TrHGfd2FdmbRIFmvEmHLU%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>
<p>论文标题：Dingtalk DeepResearch: A Unified Multi Agent Framework for Adaptive Intelligence in Enterprise Environments</p>
</li>
<li>
<p>论文地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2510.24760" target="_blank" title="https://arxiv.org/abs/2510.24760" ref="nofollow noopener noreferrer">arxiv.org/abs/2510.24…</a></p>
</li>
</ul>
<p>Dingtalk-DeepResearch 在国际权威深度研究评测 DeepResearch Bench 中取得 48.49 高分（全球第二、国内第一），显著超越包括 OpenAI、Claude 在内的主流系统；并在 ResearcherBench 达到 0.6050 平均覆盖率（全球第三、国内第一）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5eb7319ad06f46d58474c0790462ed47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543259&amp;x-signature=Lpk6QpNI5fUhPryveF%2FPVI6cNYM%3D" alt="图片" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/067e089e80ba466b9475dc03521a06d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543259&amp;x-signature=wo2YYRyjTqW8WUBa2Ip6Jnyn8Ec%3D" alt="图片" loading="lazy"/></p>
<p>更关键的是，该框架已稳定部署于制造业、供应链等真实企业场景，能够在复杂异构表格、多阶段推理与多模态生成任务中保持行业领先的准确性和稳健性，实现了国际顶级基准与实际生产落地的双重突破。</p>
<h3 data-id="heading-0">总体架构：</h3>
<h3 data-id="heading-1">构建企业智能的大脑</h3>
<p>Dingtalk-DeepResearch 框架采用分层设计，旨在为企业提供一个全面而灵活的智能中枢：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d91dd5fca2446b1a41597e53c721b93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543259&amp;x-signature=Fb0bdpWPSuxh15O1IL%2F6qSBFyfo%3D" alt="图片" loading="lazy"/></p>
<p><strong>Dingtalk-DeepResearch Agent Studio：这一层提供了专业的智能体，专门用于深度研究、表格数据处理和数据分析。同时，它也支持可定制的个人智能体，以满足不同用户的特定需求。这体现了框架的 flexibility 和个性化能力。</strong></p>
<p><strong>Dingtalk-DeepResearch Core：这一层</strong>作为框架的「大脑」，它集成了上下文压缩、推理与规划、长短期记忆和人机协作控制等关键功能。该核心还包括一个自演进引擎 (DingAutoEvaluator)和一套丰富的集成工具，支持代码执行、网络搜索、文件与表格检索及多模态处理。值得注意的是，它能与钉钉生态系统连接，并在用户授权下安全访问个人工作文档。所有这些能力均由经过 CPT、SFT 和 RL 训练的 LLM 驱动。<br/>
<strong>Dingtalk-DeepResearch Data Layer：这一层是</strong>一个统一的数据骨干。它整合了知识图谱、数据库、缓存以及包括对话、音视频、图、文本和表格在内的多模态数据集。该层汇集了业务、行业、个人及合成数据，为智能体检索和关联多样化的企业及行业数据提供了基础。</p>
<h3 data-id="heading-2">详细方法：</h3>
<h3 data-id="heading-3">自适应智能的核心机制</h3>
<p>Dingtalk-DeepResearch 的创新之处在于其独特的方法论，尤其是在文档生成、在线学习和表格推理方面。</p>
<p><strong>大规模多阶段文档强化学习：构建文档生成专家</strong></p>
<p>为了赋予 Dingtalk-DeepResearch 强大的文档生成能力，该框架设计了一个多阶段训练管道，结合了大规模奖励建模、结构化查询格式的监督微调以及在静态和实时内容流上的强化学习，并通过真实用户数据进行在线偏好优化。</p>
<ul>
<li>阶段 1：奖励模型（Doc-RM）训练</li>
</ul>
<p>此阶段的目标是训练一个文档专属的奖励模型（Doc-RM）。团队使用了约 80 万个人工标注的正负样本对 ，这些样本根据事实准确性、语义覆盖、逻辑结构和呈现清晰度进行评估 。该模型将作为后续强化学习阶段的评分骨干 。</p>
<ul>
<li>阶段 2：结构化查询格式的冷启动监督微调 (SFT)</li>
</ul>
<p>为使模型掌握特定的输出格式，团队使用了 3,200 个精选样本进行 SFT 。这些样本涵盖四大类格式：视觉呈现生成（如 Markdown 格式的 PPT）、结构化数据解释（如表格解析）、综合多章节叙述 和领域特定模板 。此阶段会奖励兼具内容准确性、逻辑结构和美观文本格式的输出 ，为后续 RL 调优奠定基础 。</p>
<ul>
<li>阶段 3：静态文档集合上的强化学习 (RL)</li>
</ul>
<p>利用训练好的 Doc-RM 作为奖励函数 ，智能体在大型离线文档库上进行强化学习。它通过检索静态文档、合成答案，并根据覆盖范围、事实正确性和连贯性获得奖励 ，从而在受控环境中建立稳定的合成能力基线 。</p>
<ul>
<li>阶段 4：实时文档获取上的强化学习 (RL)</li>
</ul>
<p>为处理时效性信息，RL 被扩展到实时内容检索 。团队设计了 10,000 个时间敏感查询 ，覆盖了需要避免「事后偏见」的场景（如财务预测）和需要最新信息的「过时信息」场景（如突发新闻）。系统通过实时搜索获取最新文档，并由 Doc-RM 结合定制的奖惩结构（强调时间正确性）进行评分 。</p>
<ul>
<li>阶段 5：基于 Copilot 的真实用户交互在线直接偏好优化 (DPO)</li>
</ul>
<p>在实际部署中，系统作为用户 Copilot 运行 。通过收集模型的原始输出和用户的编辑版本，系统会提取高影响力的差异 ，并将其构造成在线 DPO 数据集，从而持续向用户的特定偏好进行微调 。</p>
<p>通过这一多阶段方法，Dingtalk-DeepResearch 不仅获得了强大的文档生成能力，还实现了对不断变化的真实世界信息需求的自适应响应。</p>
<p><strong>熵引导记忆检索自适应在线学习：无需微调 LLM 的持续演进</strong></p>
<p>Dingtalk-DeepResearch 的一个显著特点是其熵引导、记忆感知的在线学习机制。该机制允许智能体在不微调底层 LLM 参数的情况下，持续适应不断演变的任务。系统并非依赖静态提示，而是从一个外部的 episodic memory bank 中动态选择和重用先前的案例 ，平衡了对高价值经验的利用和对多样化历史情境的探索。</p>
<p>智能体会根据当前任务状态计算存储案例的概率分布，该分布受其估计的 Q 值和温度参数的调节 。这鼓励了对替代案例的探索，减轻了对早期经验的过拟合 。同时，记忆感知组件通过学习到的语义相似性来确保上下文相关性，从而准确地重新应用多步骤推理模式和工具调用序列 。</p>
<p>该机制被集成到规划器-执行器循环中 ，每次执行都会更新案例库，在线重新训练检索策略，并逐步提高推理性能 。此外，该系统将这种记忆驱动的范式扩展到个性化层面，通过构建用户画像、文档交互历史和先前工作流的长期结构化记忆 ，智能体能够更深入地理解用户的工作风格和需求，从而提供日益相关和高效的辅助。</p>
<p><strong>结构感知异构表格解析、检索与推理：企业级数据处理的利器</strong></p>
<p>在企业环境中，表格数据往往与文本叙述混合，形式多样且结构复杂。Dingtalk-DeepResearch 的表格问答模块通过结合布局感知表格建模和异构检索-执行，实现了精确且可解释的推理。</p>
<ul>
<li><strong>数据摄入 (Data Ingestion)</strong></li>
</ul>
<p>系统在摄入半结构化表格时会保留其原始布局，而非扁平化为纯文本。表格被解析为捕获了标题、合并单元格和嵌套关系的层次化表示。同时，表格也以标准化模式存储在关系数据库中，其 Markdown 渲染版本则加入文本知识库。这种双存储方法保持了结构完整性，并同时支持符号查询和向量检索。</p>
<ul>
<li><strong>结构化解析 (Structural Parsing)</strong></li>
</ul>
<p>系统应用多模态检测器来区分标题和内容单元格 ，推断列类型（如离散、连续），并分析布局以识别嵌入的子表 。这些丰富的模式注解为精确推理奠定了基础 。</p>
<ul>
<li><strong>语义理解 (Semantic Understanding)</strong></li>
</ul>
<p>系统会将用户问题分解为感知文本和表格上下文的特定模态子查询 。查询词汇通过嵌入相似性和类型感知标记与数据库模式及文本实体对齐 。这种分解能确保表格相关子查询被直接用于符号执行，而文本子查询则交由文档检索器处理 。</p>
<ul>
<li><strong>表格推理 (Tabular Reasoning)</strong></li>
</ul>
<p>对于表格子查询，系统会调用 NL2SQL 生成器 ，在关系数据库上生成可执行的 SQL 语句，以执行聚合、过滤或多跳连接 。得益于评估驱动的开发范式，DingAutoEvaluator 会持续发现低准确度的案例 ，并将其反馈到专用训练循环中以重新训练 NL2SQL 生成器 ，从而提高其鲁棒性和执行可靠性 。</p>
<ul>
<li><strong>表格检索 (Table Retrieval)</strong></li>
</ul>
<p>系统采用混合的自顶向下和自底向上检索策略 。检索过程分两阶段：首先从文本知识库和 Markdown 渲染的表格中进行密集向量召回 ，然后使用模式感知的相关性模型进行语义重排序 。</p>
<p>这种紧密集成结构保留摄入、精确解析、上下文感知分解、符号 SQL 推理和自适应检索的方法，使 Dingtalk-DeepResearch 能够大规模处理真实世界中的异构数据，提供稳健的企业级表格问答能力。</p>
<p><strong>DingAutoEvaluator：数据飞轮与持续优化的核心驱动</strong></p>
<p>DingAutoEvaluator 是 Dingtalk-DeepResearch 实现持续演进的关键。它是一个自动化评估平台，作为数据飞轮和性能演进的核心驱动力，将开发范式从启发式迭代和零星手动检查转变为完全评估驱动的方法。</p>
<p>该过程始于不确定性感知案例挖掘。系统会持续监控模型在检索和生成层面的认知不确定性峰值 ，这些「灰色地带」的输出（即模型能力边缘的推理）会被自动识别并优先提交给专家标注者 。</p>
<p>随后，平台中精心策划的多个「教师模型」会根据一系列多维度评估指标全面检查框架的输出 。这个统一的测量框架 涵盖了 RAG、LLM、推理、智能体框架和知识库健康度等多个方面 。关键指标类别包括：</p>
<ul>
<li>
<p>RAG 评估：如上下文精度和答案忠实度。</p>
</li>
<li>
<p>LLM 评估：如响应准确性和意图识别。</p>
</li>
<li>
<p>推理评估：如逻辑连贯性和思维一致性。</p>
</li>
<li>
<p>智能体框架评估：如任务依从性和工具使用正确性。</p>
</li>
<li>
<p>知识库评估：如知识过时率 。</p>
</li>
</ul>
<p>这些指标不仅用于离线基准测试，还作为在线监控循环中的实时信号，为数据飞轮提供高价值案例，并为奖励建模和持续优化提供信号。</p>
<h3 data-id="heading-4">实验结果与案例展示：</h3>
<h3 data-id="heading-5">能力验证与实际应用</h3>
<p>论文通过多个实际案例展示了 Dingtalk-DeepResearch 的端到端能力，特别是在复杂表格数据解析、检索、推理以及多模态文档生成方面。</p>
<p><strong>复杂表格解析、检索与推理案例</strong></p>
<p>在案例 A 中，系统处理了一个包含库存、多周预测和多式联运计划的复杂表格。Dingtalk-DeepResearch 能够准确解析多节生产记录、发货计划和物流说明，实现精确的信息检索与合成。该方法可扩展到多个大型文件（如案例中 8 个相似的 1200 行文件），显示了其鲁棒性和实用性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d00494f8564544daade9f3172dcbfe06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543259&amp;x-signature=l9Jh1y045BJrSC5NBu21uoqxjkY%3D" alt="图片" loading="lazy"/></p>
<p>在案例 B 中，系统处理了一个 1200 行的周生产记录 103，并回答了关于 2025 年第一季度总产量的提问 104。系统清晰地展示了其端到端流程：</p>
<ul>
<li>
<p>问题分解：将复杂问题分解为四个步骤，包括定位表格、识别时间范围、提取数据和汇总。</p>
</li>
<li>
<p>表格检索与模式链接：系统成功定位到「YF Seat Weekly Production Statistics on Dec 30, 2024」表格 106，并将「Q1 2025」链接到 13 个具体的周次列。</p>
</li>
<li>
<p>SQL 生成与执行：系统生成了精确的 SUM 聚合 SQL 语句 108，并成功执行得出 total_production = 245036。</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f28bdd2f14e4f9f8e9447ef73a69b3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543259&amp;x-signature=ZAiREWG6si78B8UtvluiByzVAmA%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>最终答案：基于执行结果，系统给出了「...2025 年第一季度...所有产品的总产量为 245036 件」的准确回答。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e77a5cdd33ac4fc5bf00a551f448ecaa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543259&amp;x-signature=Q7Qyi5pPJiEcsfD4GovJxSbMEpg%3D" alt="图片" loading="lazy"/></p>
<p><strong>语义对齐的视觉-语言融合多模态文档生成</strong></p>
<p>该框架还展示了其在 Kaggle 竞赛案例（厄瓜多尔超市销售预测）中的端到端自动化能力 。从源代码、数据处理、统计可视化到最终的分析报告，全部由 Dingtalk-DeepResearch 自动生成和执行，无需任何人工干预 。</p>
<p>这证明了系统在一个统一的深度研究工作流中，集成了代码合成、执行和多模态结果呈现的能力 。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03cc4bfbb46642d1bb70bee758055497~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543259&amp;x-signature=nvOvOVNwjKi6N9PFsnf%2FwcCUpR4%3D" alt="图片" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05f481ef57cb4a2ab7289626e33368ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5py65Zmo5LmL5b-D:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763543259&amp;x-signature=FKtnerw1jW6XMG9D0mv0hgOF9Ik%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-6">结论：</h3>
<h3 data-id="heading-7">面向未来的企业级自适应智能</h3>
<p>Dingtalk-DeepResearch 提出了一种统一的多智能体智能框架，专为企业环境设计，其核心优势在于：</p>
<ul>
<li>
<p>熵引导在线学习，实现无需频繁微调 LLM 的自适应能力。</p>
</li>
<li>
<p>大规模多阶段文档强化学习，显著提升文档生成的事实准确性、结构质量和用户对齐度。</p>
</li>
<li>
<p>结构感知异构表格推理，能够有效处理真实世界中复杂多样的表格数据。</p>
</li>
<li>
<p>DingAutoEvaluator 自动化评估引擎，通过不确定性感知案例挖掘和多维度指标，形成数据飞轮，驱动模型的持续优化和防范性能退化。</p>
</li>
</ul>
<p>Dingtalk-DeepResearch 已经成功部署在企业内部工作流程中，并即将作为钉钉的服务对外开放，这将为更广泛的企业用户提供适应性强、评估驱动、多模态推理的复杂任务解决方案。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 PVE 8.1 的 CentOS / Ubuntu / Docker / Kubernetes 部署手册]]></title>    <link>https://juejin.cn/post/7571650164843233314</link>    <guid>https://juejin.cn/post/7571650164843233314</guid>    <pubDate>2025-11-12T09:13:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571650164843233314" data-draft-id="7571636682694918184" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 PVE 8.1 的 CentOS / Ubuntu / Docker / Kubernetes 部署手册"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-12T09:13:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="微学网络"/> <meta itemprop="url" content="https://juejin.cn/user/1216516089188397"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 PVE 8.1 的 CentOS / Ubuntu / Docker / Kubernetes 部署手册
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1216516089188397/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    微学网络
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T09:13:38.000Z" title="Wed Nov 12 2025 09:13:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">基于 PVE 8.1 的 CentOS / Ubuntu / Docker / Kubernetes 部署手册</h2>
<blockquote>
<p>适用场景：一台已安装 Proxmox VE 8.1 的物理服务器，需要同时运行多个 CentOS 虚拟机（或 LXC 容器）以部署 Docker 环境，并部署一个 Ubuntu 虚拟机用于 Docker 与 Kubernetes（K8s）集群的搭建与管理。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">1. 前提条件与规划</h3>
<ul>
<li><strong>硬件资源</strong>：至少 8 核 CPU、32 GB 内存、500 GB SSD/NVMe（根据实际业务扩展，K8s 建议 64 GB+ 内存）。</li>
<li><strong>网络规划</strong>：</li>
<li>管理网段：<code>192.168.10.0/24</code>（PVE 管理、SSH）</li>
<li>生产网段：<code>192.168.20.0/24</code>（虚拟机业务流量，可选）</li>
<li>Kubernetes Pod 网段：<code>10.244.0.0/16</code>（以 Flannel 为例）</li>
<li>Service 网段：<code>10.96.0.0/12</code></li>
<li><strong>PVE 存储</strong>：建议划分 <code>local</code>（镜像/ISO）、<code>local-lvm</code>（VM 磁盘），如使用 Ceph/NFS 需提前配置。</li>
<li><strong>镜像准备</strong>：</li>
<li><code>CentOS 7/Stream 8/9</code> ISO（官方）</li>
<li><code>Ubuntu Server 22.04 LTS</code> ISO</li>
<li><strong>账号与权限</strong>：准备至少一个有 PVE <code>root@pam</code> 权限的账号 &amp; SSH 公钥。</li>
</ul>
<hr/>
<h3 data-id="heading-2">2. PVE 8.1 基础配置</h3>
<h4 data-id="heading-3">2.1 更新 PVE 与订阅设置</h4>
<pre><code class="hljs language-bash" lang="bash">apt update &amp;&amp; apt full-upgrade -y  
sed -i <span class="hljs-string">'s/enterprise/no-subscription/g'</span> /etc/apt/sources.list.d/pve-enterprise.list  
<span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">'EOF'</span> &gt;/etc/apt/sources.list.d/pve-no-subscription.list  
deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription  
EOF  
apt update &amp;&amp; apt full-upgrade -y  
</code></pre>
<h4 data-id="heading-4">2.2 创建桥接网络</h4>
<ol>
<li>登录 PVE Web 界面 → <code>数据中心</code> → <code>节点</code> → <code>系统</code> → <code>网络</code></li>
<li>创建 <code>vmbr1</code> 作为业务网桥（如需要）：</li>
</ol>
<ul>
<li>类型：Linux Bridge</li>
<li>物理接口：<code>enp3s0</code>（示例）</li>
<li>IPv4/IPv6 配置：按规划填写或留空</li>
</ul>
<ol start="3">
<li>应用更改并重启网络服务：<code>ifreload -a</code></li>
</ol>
<hr/>
<h3 data-id="heading-5">3. 安装多个 CentOS + Docker</h3>
<h4 data-id="heading-6">3.1 创建 CentOS 模板虚拟机</h4>
<ol>
<li>上传 ISO：<code>数据中心</code> → <code>存储</code> → <code>local</code> → <code>内容</code> → <code>上传</code> ISO。</li>
<li>新建 VM 参数建议：</li>
</ol>
<ul>
<li>ID：<code>2001</code></li>
<li>名称：<code>tmpl-centos7</code></li>
<li>BIOS：<code>OVMF (UEFI)</code> 或 <code>SeaBIOS</code>（取决于需求）</li>
<li>SCSI 控制器：<code>VirtIO SCSI</code></li>
<li>磁盘：<code>32 GB</code>（Thin provision）</li>
<li>CPU：<code>4 cores</code>，类型 <code>host</code></li>
<li>内存：<code>8 GB</code></li>
<li>网络：<code>vmbr0</code>，型号 <code>VirtIO (paravirtualized)</code></li>
</ul>
<ol start="3">
<li>启动 VM，按常规流程安装 CentOS（Minimal）。</li>
<li>安装基础工具与 QEMU Guest Agent：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo yum install -y epel-release  
sudo yum install -y qemu-guest-agent vim curl wget net-tools  
sudo systemctl <span class="hljs-built_in">enable</span> --now qemu-guest-agent  
</code></pre>
<ol start="5">
<li>配置静态 IP（示例）：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">nmcli con mod ens18 ipv4.addresses 192.168.10.101/24  
nmcli con mod ens18 ipv4.gateway 192.168.10.1  
nmcli con mod ens18 ipv4.dns <span class="hljs-string">"8.8.8.8 114.114.114.114"</span>  
nmcli con mod ens18 ipv4.method manual  
nmcli con up ens18  
</code></pre>
<ol start="6">
<li>更新系统并清理：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo yum update -y  
sudo yum clean all  
</code></pre>
<ol start="7">
<li>关机后在 PVE Web 上右键 VM → <code>转换为模板</code>。</li>
</ol>
<h4 data-id="heading-7">3.2 快速克隆多个 CentOS 实例</h4>
<ol>
<li>右键模板 <code>tmpl-centos7</code> → <code>克隆</code></li>
<li>设置：</li>
</ol>
<ul>
<li>VM ID：依次递增 <code>2010</code>, <code>2011</code>, …</li>
<li>名称：<code>centos-docker-01</code> 等</li>
<li>选择 <code>完整克隆</code> 或 <code>链接克隆</code>（使用 Ceph/ZFS 建议链接克隆）</li>
</ul>
<ol start="3">
<li>克隆完成后启动 VM，修改主机名与 IP：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo hostnamectl set-hostname centos-docker-01  
nmcli con mod ens18 ipv4.addresses 192.168.10.110/24  
nmcli con mod ens18 ipv4.gateway 192.168.10.1  
nmcli con up ens18  
</code></pre>
<h4 data-id="heading-8">3.3 安装 Docker CE（CentOS）</h4>
<pre><code class="hljs language-bash" lang="bash">sudo yum install -y yum-utils device-mapper-persistent-data lvm2  
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo  
sudo yum install -y docker-ce docker-ce-cli containerd.io  
sudo <span class="hljs-built_in">mkdir</span> -p /etc/docker  
<span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">'EOF'</span> | sudo <span class="hljs-built_in">tee</span> /etc/docker/daemon.json  
{  
<span class="hljs-string">"registry-mirrors"</span>: [  
<span class="hljs-string">"https://docker.m.daocloud.io"</span>,  
<span class="hljs-string">"https://hub-mirror.c.163.com"</span>  
],  
<span class="hljs-string">"exec-opts"</span>: [<span class="hljs-string">"native.cgroupdriver=systemd"</span>],  
<span class="hljs-string">"log-driver"</span>: <span class="hljs-string">"json-file"</span>,  
<span class="hljs-string">"log-opts"</span>: {  
<span class="hljs-string">"max-size"</span>: <span class="hljs-string">"100m"</span>  
},  
<span class="hljs-string">"storage-driver"</span>: <span class="hljs-string">"overlay2"</span>  
}  
EOF  
sudo systemctl <span class="hljs-built_in">enable</span> --now docker  
sudo usermod -aG docker <span class="hljs-variable">$USER</span>  
</code></pre>
<blockquote>
<p><strong>提示</strong>：批量节点可通过 <code>cloud-init</code> 或 <code>Ansible</code> 推送上述配置。</p>
</blockquote>
<hr/>
<h3 data-id="heading-9">4. 部署 Ubuntu + Docker 用于 Kubernetes</h3>
<h4 data-id="heading-10">4.1 创建 Ubuntu 虚拟机</h4>
<ol>
<li>新建 VM（示例 ID：<code>3001</code>，名称 <code>ubuntu-master</code>），参数：</li>
</ol>
<ul>
<li>CPU：<code>6 cores</code></li>
<li>内存：<code>16 GB</code></li>
<li>磁盘：<code>64 GB</code></li>
<li>网络：<code>vmbr0</code>（管理），必要时添加第二块网卡 <code>vmbr1</code></li>
</ul>
<ol start="2">
<li>安装 Ubuntu Server 22.04，开启 <code>OpenSSH Server</code> 组件。</li>
<li>配置静态 IP（<code>netplan</code>）：</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">sudo nano /etc/netplan/01-netcfg.yaml  
</code></pre>
<p>示例：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">network:</span>  
<span class="hljs-attr">version:</span> <span class="hljs-number">2</span>  
<span class="hljs-attr">renderer:</span> <span class="hljs-string">networkd</span>  
<span class="hljs-attr">ethernets:</span>  
<span class="hljs-attr">ens18:</span>  
<span class="hljs-attr">addresses:</span>  
<span class="hljs-bullet">-</span> <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.120</span><span class="hljs-string">/24</span>  
<span class="hljs-attr">gateway4:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.10</span><span class="hljs-number">.1</span>  
<span class="hljs-attr">nameservers:</span>  
<span class="hljs-attr">addresses:</span> [<span class="hljs-number">8.8</span><span class="hljs-number">.8</span><span class="hljs-number">.8</span>, <span class="hljs-number">223.5</span><span class="hljs-number">.5</span><span class="hljs-number">.5</span>]  
</code></pre>
<p>应用：<code>sudo netplan apply</code></p>
<h4 data-id="heading-11">4.2 安装 Docker CE（Ubuntu）</h4>
<pre><code class="hljs language-bash" lang="bash">sudo apt update  
sudo apt install -y ca-certificates curl gnupg lsb-release  
sudo <span class="hljs-built_in">mkdir</span> -p /etc/apt/keyrings  
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg  
<span class="hljs-built_in">echo</span> \  
<span class="hljs-string">"deb [arch=<span class="hljs-subst">$(dpkg --print-architecture)</span> signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \  
<span class="hljs-subst">$(lsb_release -cs)</span> stable"</span> | sudo <span class="hljs-built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null  
sudo apt update  
sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin  
sudo systemctl <span class="hljs-built_in">enable</span> --now docker  
sudo usermod -aG docker <span class="hljs-variable">$USER</span>  
</code></pre>
<hr/>
<h3 data-id="heading-12">5. 使用 kubeadm 构建 K8s 集群</h3>
<blockquote>
<p>建议使用 Ubuntu 节点作为控制平面；工作节点可选择 CentOS 或 Ubuntu。以下示例：1 Master + 2 Worker。</p>
</blockquote>
<h4 data-id="heading-13">5.1 节点规划</h4>





























<table><thead><tr><th>角色</th><th>主机名</th><th>IP</th><th>系统</th></tr></thead><tbody><tr><td>Master</td><td><code>k8s-master-01</code></td><td><code>192.168.10.120</code></td><td>Ubuntu 22.04</td></tr><tr><td>Worker 01</td><td><code>k8s-worker-01</code></td><td><code>192.168.10.130</code></td><td>CentOS 7/Stream</td></tr><tr><td>Worker 02</td><td><code>k8s-worker-02</code></td><td><code>192.168.10.131</code></td><td>CentOS 7/Stream</td></tr></tbody></table>
<h4 data-id="heading-14">5.2 通用系统设置</h4>
<pre><code class="hljs language-bash" lang="bash">sudo swapoff -a  
sudo sed -i <span class="hljs-string">'/ swap / s/^/#/'</span> /etc/fstab  
sudo modprobe br_netfilter  
<span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">'EOF'</span> | sudo <span class="hljs-built_in">tee</span> /etc/modules-load.d/k8s.conf  
br_netfilter  
EOF  
<span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">'EOF'</span> | sudo <span class="hljs-built_in">tee</span> /etc/sysctl.d/k8s.conf  
net.bridge.bridge-nf-call-iptables = 1  
net.bridge.bridge-nf-call-ip6tables = 1  
net.ipv4.ip_forward = 1  
EOF  
sudo sysctl --system  
</code></pre>
<h4 data-id="heading-15">5.3 安装容器运行时（containerd）</h4>
<blockquote>
<p>Kubernetes 官方推荐使用 containerd。可沿用 Docker 安装包内的 containerd，或单独安装。</p>
</blockquote>
<pre><code class="hljs language-bash" lang="bash">sudo <span class="hljs-built_in">mkdir</span> -p /etc/containerd  
containerd config default | sudo <span class="hljs-built_in">tee</span> /etc/containerd/config.toml  
sudo sed -i <span class="hljs-string">'s/SystemdCgroup = false/SystemdCgroup = true/'</span> /etc/containerd/config.toml  
sudo systemctl restart containerd  
sudo systemctl <span class="hljs-built_in">enable</span> containerd  
</code></pre>
<h4 data-id="heading-16">5.4 安装 Kubernetes 组件</h4>
<h5 data-id="heading-17">在 Ubuntu 节点：</h5>
<pre><code class="hljs language-bash" lang="bash">sudo apt update  
sudo apt install -y apt-transport-https ca-certificates curl  
sudo curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg  
<span class="hljs-built_in">echo</span> <span class="hljs-string">"deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main"</span> | \  
sudo <span class="hljs-built_in">tee</span> /etc/apt/sources.list.d/kubernetes.list  
sudo apt update  
sudo apt install -y kubelet kubeadm kubectl  
sudo apt-mark hold kubelet kubeadm kubectl  
</code></pre>
<h5 data-id="heading-18">在 CentOS 节点：</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> &lt;&lt;<span class="hljs-string">'EOF'</span> | sudo <span class="hljs-built_in">tee</span> /etc/yum.repos.d/kubernetes.repo  
[kubernetes]  
name=Kubernetes  
baseurl=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/  
enabled=1  
gpgcheck=1  
gpgkey=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/repodata/repomd.xml.key  
EOF  
sudo yum install -y kubelet kubeadm kubectl  
sudo systemctl <span class="hljs-built_in">enable</span> --now kubelet  
</code></pre>
<blockquote>
<p>注意：保持所有节点的 <code>kubelet/kubeadm/kubectl</code> 版本一致。</p>
</blockquote>
<h4 data-id="heading-19">5.5 初始化控制平面</h4>
<p>在 Master 节点执行：</p>
<pre><code class="hljs language-bash" lang="bash">sudo kubeadm init \  
--apiserver-advertise-address=192.168.10.120 \  
--pod-network-cidr=10.244.0.0/16 \  
--service-cidr=10.96.0.0/12  
</code></pre>
<p>初始化完成后，按提示配置 <code>kubectl</code>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$HOME</span>/.kube  
sudo <span class="hljs-built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="hljs-variable">$HOME</span>/.kube/config  
sudo <span class="hljs-built_in">chown</span> $(<span class="hljs-built_in">id</span> -u):$(<span class="hljs-built_in">id</span> -g) <span class="hljs-variable">$HOME</span>/.kube/config  
</code></pre>
<h4 data-id="heading-20">5.6 安装网络插件（Flannel 示例）</h4>
<pre><code class="hljs language-bash" lang="bash">kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml  
</code></pre>
<h4 data-id="heading-21">5.7 加入 Worker 节点</h4>
<p>在每个 Worker 上执行 Master 输出的 <code>kubeadm join</code> 命令（如丢失可重新生成）：</p>
<pre><code class="hljs language-bash" lang="bash">sudo kubeadm token create --print-join-command  
</code></pre>
<p>执行后检查集群状态：</p>
<pre><code class="hljs language-bash" lang="bash">kubectl get nodes  
kubectl get pods -A  
</code></pre>
<hr/>
<h3 data-id="heading-22">6. Docker / Kubernetes 常见运维</h3>
<ul>
<li><strong>镜像加速</strong>：在 <code>/etc/docker/daemon.json</code> 与 <code>/etc/containerd/config.toml</code> 中配置国内镜像。</li>
<li><strong>权限管理</strong>：创建 <code>docker</code> 组，使用 <code>sudo usermod -aG docker username</code>。</li>
<li><strong>日志轮转</strong>：Docker 自带 <code>json-file</code> 日志，必要时结合 <code>logrotate</code>。</li>
<li><strong>资源控制</strong>：在 PVE 中设定 CPU/内存限制，K8s 中使用 <code>LimitRange</code>/<code>ResourceQuota</code>。</li>
<li><strong>备份</strong>：</li>
<li>VM：使用 PVE <code>备份</code> 功能到 NFS/Ceph。</li>
<li>集群：使用 <code>velero</code>/<code>etcdctl snapshot</code>。</li>
<li><strong>升级策略</strong>：</li>
<li>PVE：每季度计划升级；确保订阅源稳定。</li>
<li>Docker：先测试环境节点后生产；遵循 <code>docker-ce</code> LTS。</li>
<li>K8s：按小版本滚动升级，先控制平面再工作节点。</li>
</ul>
<hr/>
<h3 data-id="heading-23">7. 常见问题排查</h3>



































<table><thead><tr><th>问题</th><th>可能原因</th><th>解决建议</th></tr></thead><tbody><tr><td>VM 网络不通</td><td>虚拟交换机未绑定物理口、VLAN 配置缺失</td><td>核对 <code>vmbr</code> 绑定与上联交换机 VLAN</td></tr><tr><td>克隆 VM 后 IP 冲突</td><td>未修改 <code>ifcfg</code>/<code>netplan</code> MAC/IP</td><td>克隆后立即变更 MAC 或重启获取 DHCP</td></tr><tr><td>Docker 启动失败</td><td>cgroup 驱动不匹配</td><td>确保 <code>systemd</code>，配置 <code>daemon.json</code></td></tr><tr><td>kubeadm 初始化失败</td><td>swap 未关闭、端口被占用</td><td><code>swapoff -a</code>，检查 <code>6443</code>、<code>10250</code> 等端口</td></tr><tr><td>节点 <code>NotReady</code></td><td>网络插件异常</td><td>重装 CNI，检查 <code>kube-flannel</code> Pod 日志</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-24">8. 批量自动化建议</h3>
<ul>
<li><strong>Ansible</strong>：编写 <code>playbook</code> 批量安装 Docker/K8s，维护 <code>inventory</code>。</li>
<li><strong>Cloud-Init</strong>：使用 <code>cloud-init</code> 模板，减少克隆后手工步骤。</li>
<li><strong>Packer</strong>：自动构建 VM 模板，结合 PVE API 批量部署。</li>
<li><strong>CI/CD</strong>：将 YAML 清单、Ansible Playbooks 存入 Git，使用 GitLab CI/Argo CD 自动化。</li>
</ul>
<hr/>
<h3 data-id="heading-25">9. 附录</h3>
<h4 data-id="heading-26">9.1 常用命令速查</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># PVE CLI 创建 VM 示例  </span>
qm create 2010 --name centos-docker-01 --memory 8192 --cores 4 --net0 virtio,bridge=vmbr0  
qm importdisk 2010 centos.qcow2 local-lvm  
qm <span class="hljs-built_in">set</span> 2010 --scsihw virtio-scsi-pci --scsi0 local-lvm:vm-2010-disk-0  
qm <span class="hljs-built_in">set</span> 2010 --boot c --bootdisk scsi0  
qm <span class="hljs-built_in">set</span> 2010 --ide2 <span class="hljs-built_in">local</span>:iso/CentOS-7-x86_64-Minimal.iso,media=cdrom  
  
<span class="hljs-comment"># PVE 克隆  </span>
qm <span class="hljs-built_in">clone</span> 2001 2011 --name centos-docker-02 --full  
  
<span class="hljs-comment"># 管理 VM  </span>
qm start 2010  
qm stop 2010  
qm status 2010  
  
<span class="hljs-comment"># Docker 常用  </span>
docker info  
docker ps -a  
docker system <span class="hljs-built_in">df</span>  
  
<span class="hljs-comment"># Kubernetes 常用  </span>
kubectl get nodes -o wide  
kubectl get pods -A  
kubectl describe node k8s-worker-01  
</code></pre>
<h4 data-id="heading-27">9.2 端口与服务</h4>
<ul>
<li>PVE Web：<code>8006</code></li>
<li>SSH：<code>22</code></li>
<li>Docker API：<code>2375</code>（禁用或限制）</li>
<li>Kubernetes：</li>
<li>API Server：<code>6443</code></li>
<li>kubelet：<code>10250</code></li>
<li>NodePort：<code>30000-32767</code></li>
</ul>
<hr/>
<h3 data-id="heading-28">10. 维护与安全建议</h3>
<ul>
<li>定期更新 PVE 与虚拟机系统；配置企业级镜像源。</li>
<li>使用防火墙（PVE <code>iptables</code>/<code>pf</code>、K8s <code>NetworkPolicy</code>）。</li>
<li>为 Docker Registry 配置 HTTPS 与鉴权；避免默认 <code>latest</code> 标签。</li>
<li>启用 PVE 备份（快照 + 定时备份），并测试恢复流程。</li>
<li>K8s 集群启用 RBAC、审计日志；定期轮换证书。</li>
<li>监控：部署 <code>Prometheus + Grafana</code>、<code>Loki</code>，结合 PVE 自带监控。</li>
</ul>
<hr/>
<h3 data-id="heading-29">11. PVE Web 前端操作手册（初学者版）</h3>
<blockquote>
<p>《基于 PVE8.1 快速搭建 K8s 集群》</p>
</blockquote>
<h4 data-id="heading-30">11.1 登录与界面认识</h4>
<ol>
<li>浏览器访问 <code>https://&lt;PVE主机IP&gt;:8006</code>，选择登录域 <code>Linux PAM standard authentication</code>，使用 <code>root@pam</code> 或授权账户登录。</li>
<li>左侧 <code>数据中心</code> 树展示所有节点与虚拟资源；右侧为详细面板。</li>
<li>顶部状态栏：</li>
</ol>
<ul>
<li><code>搜索</code>：快速定位 VM / 存储。</li>
<li><code>Shell</code>：打开节点 CLI。</li>
<li><code>帮助</code>：查看官方文档。</li>
</ul>
<ol start="4">
<li>常用面板：</li>
</ol>
<ul>
<li><code>概览</code>：资源使用、订阅状态。</li>
<li><code>任务历史</code>：实时查看正在执行的操作（创建 VM、备份等）。</li>
</ul>
<h4 data-id="heading-31">11.2 Web 前端基础配置</h4>
<ul>
<li><strong>订阅源切换</strong>：在 <code>节点 → Shell</code> 执行本文第 2.1 节命令，或在 <code>Shell</code> 面板直接粘贴。</li>
<li><strong>时区与时间</strong>：<code>节点 → 系统 → 时间</code>，同步 NTP 服务器（如 <code>ntp.aliyun.com</code>）。</li>
<li><strong>网络桥配置</strong>：</li>
</ul>
<ol>
<li><code>节点 → 系统 → 网络 → 创建 → Linux Bridge</code>。</li>
<li>设置名称（例：<code>vmbr1</code>）、绑定物理网卡、是否配置 VLAN。</li>
<li>点击 <code>应用配置</code>，系统提示重启网络，确认即可。</li>
</ol>
<h4 data-id="heading-32">11.3 ISO / 容器模板管理</h4>
<ol>
<li>选中 <code>数据中心 → 存储 → local</code>。</li>
<li>切换到 <code>内容</code> 标签：</li>
</ol>
<ul>
<li><code>上传</code>：选择 CentOS / Ubuntu ISO。</li>
<li><code>模板</code>：可下载官方 LXC 模板，如 <code>centos-7-default_20240625_amd64.tar.xz</code>。</li>
</ul>
<ol start="3">
<li>上传进度可在右上角任务栏查看，如失败可点进日志排错。</li>
</ol>
<h4 data-id="heading-33">11.4 创建 KVM 虚拟机（以 CentOS 为例）</h4>
<ol>
<li>选中目标节点 → 点击右上 <code>创建虚拟机</code>。</li>
<li><strong>常规</strong>：填写 VM ID、名称（例：<code>centos-docker-01</code>），可选备注。</li>
<li><strong>操作系统</strong>：选择已上传的 ISO；<code>Guest OS</code> 选 <code>Linux</code>。</li>
<li><strong>系统</strong>：BIOS 选 <code>OVMF (UEFI)</code> 或默认 <code>SeaBIOS</code>；勾选 <code>Qemu Agent</code>。</li>
<li><strong>磁盘</strong>：<code>总线/设备</code> 建议 <code>SCSI</code>，存储选 <code>local-lvm</code>，勾选 <code>精简</code> 节省空间。</li>
<li><strong>CPU</strong>：类型选 <code>host</code>，分配核心数（例：2）。</li>
<li><strong>内存</strong>：设置动态内存（例：最小 2 GB，最大 4 GB），也可关闭气球内存固定值。</li>
<li><strong>网络</strong>：模型选 <code>VirtIO (paravirtualized)</code>，桥接 <code>vmbr0</code>。</li>
<li><strong>确认</strong>：检查配置后点击 <code>完成</code>，等待任务完成。</li>
<li>在 VM 页面点击 <code>控制台</code>，选择 <code>noVNC</code> 或 <code>SPICE</code> 进入安装界面。</li>
</ol>
<h4 data-id="heading-34">11.5 创建 LXC 容器（可用于轻量 Docker 节点）</h4>
<ol>
<li>选中节点 → <code>创建 LXC</code>。</li>
<li>填写容器 ID、主机名，勾选 <code>无密码</code> 并上传 SSH 公钥或设置密码。</li>
<li>选择模板（例：<code>ubuntu-22.04-standard_20240715_amd64.tar.zst</code>）。</li>
<li>配置根磁盘大小（例：20 GB）、CPU/内存限制。</li>
<li>网络设置：桥接到 <code>vmbr0</code>，指派 IPv4（DHCP/静态）。</li>
<li>确认创建后，即可在容器内使用 Docker（二进制安装或 apt/yum）。</li>
</ol>
<h4 data-id="heading-35">11.6 虚拟机前端常规操作</h4>
<ul>
<li><strong>启动/关闭/重启</strong>：选中 VM → <code>摘要</code> 页面左上操作按钮。</li>
<li><strong>快照</strong>：</li>
</ul>
<ol>
<li><code>快照</code> 标签 → <code>拍摄</code>，填写描述。</li>
<li>可选择 <code>包含内存</code>（用于热备份），容量大时谨慎使用。</li>
<li><code>还原</code> 会恢复到快照状态，注意可能导致未写入数据丢失。</li>
</ol>
<ul>
<li><strong>克隆</strong>：</li>
</ul>
<ol>
<li>选中模板或现有 VM → <code>更多</code> → <code>克隆</code>。</li>
<li>选择 <code>完整克隆</code>（独立磁盘）或 <code>链接克隆</code>（共享基础镜像）。</li>
<li>创建后记得修改网卡 MAC 或操作系统内部 IP。</li>
</ol>
<ul>
<li><strong>迁移</strong>：在多节点环境可通过 <code>迁移</code> 按钮在线迁移 VM 至其他节点。</li>
</ul>
<h4 data-id="heading-36">11.7 Docker / K8s 节点的 GUI 辅助操作</h4>
<ul>
<li><strong>上传 SSH 密钥</strong>：<code>数据中心 → 权限 → SSH 密钥</code>，方便在 Web Console 内一键登录。</li>
<li><strong>资源监控</strong>：<code>节点 → 摘要</code>、<code>VM → 监控</code> 可查看实时 CPU/内存/磁盘/网络曲线。</li>
<li><strong>备份与还原</strong>：</li>
</ul>
<ol>
<li><code>数据中心 → 备份</code> 创建备份任务，选择存储（如 NFS）。</li>
<li>支持 <code>停止模式</code>（关机快照）或 <code>快照模式</code>（需启用 Qemu Agent）。</li>
<li>恢复时在目标节点 <code>更多 → 恢复</code> 选择备份文件。</li>
</ol>
<ul>
<li><strong>调度任务</strong>：<code>数据中心 → 任务计划</code>，可设定定时备份、快照、更新等操作。</li>
</ul>
<h4 data-id="heading-37">11.8 常见前端操作问题</h4>

























<table><thead><tr><th>症状</th><th>处理建议</th></tr></thead><tbody><tr><td>Web 无法访问</td><td>检查浏览器证书、宿主防火墙，必要时重启 <code>pveproxy</code>：<code>systemctl restart pveproxy</code></td></tr><tr><td>上传 ISO 失败</td><td>确认存储剩余空间、网络稳定，查看任务日志（右上角）</td></tr><tr><td>控制台黑屏</td><td>切换 <code>noVNC/SPICE</code>，或在 VM <code>选项</code> 中启用 <code>显卡</code>、确认 OS 安装完成</td></tr><tr><td>克隆后网络异常</td><td>在 OS 内重置 <code>udev</code> 网卡规则、重新配置 IP，或删除旧的 <code>ifcfg</code> 文件</td></tr></tbody></table>
<hr/>
<blockquote>
<p>文档建议结合企业内部 IP、账号、存储、网络实际情况进行二次调整，并与变更管理流程同步。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[el-input数字类型禁止+-符号输入]]></title>    <link>https://juejin.cn/post/7571646669201342506</link>    <guid>https://juejin.cn/post/7571646669201342506</guid>    <pubDate>2025-11-12T09:33:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571646669201342506" data-draft-id="7571648135584612395" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="el-input数字类型禁止+-符号输入"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-11-12T09:33:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Lyuing"/> <meta itemprop="url" content="https://juejin.cn/user/3404535031412190"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            el-input数字类型禁止+-符号输入
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3404535031412190/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Lyuing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T09:33:09.000Z" title="Wed Nov 12 2025 09:33:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>使用 <code>el-input</code> 的数字类型输入时，会默认开放<code>-</code>，<code>+</code>，<code>e</code>符号输入，且无法通过<code>onInput</code>进行拦截。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">el-input</span>
    <span class="hljs-attr">v-model</span>=<span class="hljs-string">"input"</span>
    <span class="hljs-attr">type</span>=<span class="hljs-string">"number"</span>
    <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入内容"</span>
    @<span class="hljs-attr">input</span>=<span class="hljs-string">"onInput"</span>
&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">onInput</span> (value) {
    <span class="hljs-keyword">const</span> val = value.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/[^\d/.]/g</span>, <span class="hljs-string">''</span>);
    input.<span class="hljs-property">value</span> = val
}
</code></pre>
<p>以上方法无法正确响应，原因有二：</p>
<ol>
<li><code>number</code>类型将 <code>-</code>，<code>+</code>，<code>e</code> 识别为数字符号，不做限制，且符号的输入不会精确触发<code>input</code>响应；</li>
<li>首次接收到 <code>-</code>，<code>+</code>，<code>e</code> 输入后，返回剔除掉的文本回显，无法正确显示，原生<code>input</code>会内部转义，导致无法即显。</li>
</ol>
<h3 data-id="heading-0">方案</h3>
<p>可监听原生<code>input</code>方法，即可规避问题1；回显赋值时，同时更改原生<code>input</code>的<code>value</code>值，即可。
需要注意的是，该方案依赖<code>Event</code>中的属性<code>data</code>，对于兼容性要求高的场景，需谨慎处理。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">el-input</span>
    <span class="hljs-attr">v-model</span>=<span class="hljs-string">"input"</span>
    <span class="hljs-attr">type</span>=<span class="hljs-string">"number"</span>
    <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入内容"</span>
    @<span class="hljs-attr">input.native</span>=<span class="hljs-string">"onInput"</span>
&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">onInput</span> (e) {
    <span class="hljs-keyword">const</span> target = e.<span class="hljs-property">target</span>;
    <span class="hljs-keyword">const</span> value = target.<span class="hljs-property">value</span>;
  
    <span class="hljs-keyword">if</span>( [ <span class="hljs-string">'-'</span>, <span class="hljs-string">'+'</span>, <span class="hljs-string">'e'</span> ].<span class="hljs-title function_">includes</span>(e.<span class="hljs-property">data</span>) ) {
        target.<span class="hljs-property">value</span> = offset.<span class="hljs-property">value</span>[key] + <span class="hljs-string">''</span>;
    }
    <span class="hljs-keyword">const</span> val = value.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/[^\d/.]/g</span>, <span class="hljs-string">''</span>);
    input.<span class="hljs-property">value</span> = val
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[65 岁图灵巨头离职创业！LeCun 愤然与小扎决裂，Meta 巨震]]></title>    <link>https://juejin.cn/post/7571594817223770163</link>    <guid>https://juejin.cn/post/7571594817223770163</guid>    <pubDate>2025-11-12T09:02:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571594817223770163" data-draft-id="7571594817223737395" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="65 岁图灵巨头离职创业！LeCun 愤然与小扎决裂，Meta 巨震"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-11-12T09:02:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新智元"/> <meta itemprop="url" content="https://juejin.cn/user/952600743642312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            65 岁图灵巨头离职创业！LeCun 愤然与小扎决裂，Meta 巨震
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/952600743642312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新智元
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T09:02:50.000Z" title="Wed Nov 12 2025 09:02:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c9ae6cff7ea4eb5baa4b93ff37b83fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=s3BynxVHpG%2F5ceTuYvBScvpYM8A%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-0"><strong>「【新智元导读】AI 圈爆出大瓜！65 岁图灵巨头 LeCun 即将离职 Meta，与小扎正式决裂。接下来，他将投身「世界模型」开启创业下半场。」</strong></h5>
<p>图灵巨头 LeCun 真的要跑路了！</p>
<p>刚刚，FT 独家爆料，现任 Meta 首席 AI 科学家 LeCun，决定将在未来几个月离职。</p>
<p>下一步，开启人生创业的第二阶段。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b2274f99f924da5b73126ec4954af80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=De8KAQa025nPs6aL1IzIbZDt02s%3D" alt="" loading="lazy"/></p>
<p>消息一出，瞬间引爆全网。此前，坊间传闻称，LeCun 因不满内部架构调整想要离职。</p>
<p>如今，65 岁的图灵巨头，终于做出了这个决定。</p>
<p>扩展阅读：</p>
<p><em><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzI3MTA0MTk1MA%3D%3D%26mid%3D2652631905%26idx%3D1%26sn%3Db94ad542794dda5eed5b06d61232d0ba%26token%3D958537801%26lang%3Dzh_CN%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzI3MTA0MTk1MA==&amp;mid=2652631905&amp;idx=1&amp;sn=b94ad542794dda5eed5b06d61232d0ba&amp;token=958537801&amp;lang=zh_CN&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">LeCun 考虑辞职！Meta AI 百亿豪赌引爆「内战」，逼走首席科学家</a></em></p>
<p><em><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzI3MTA0MTk1MA%3D%3D%26mid%3D2652638822%26idx%3D1%26sn%3D6a8fe70b408c774eb0c8ce4d1bc04f88%26token%3D958537801%26lang%3Dzh_CN%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzI3MTA0MTk1MA==&amp;mid=2652638822&amp;idx=1&amp;sn=6a8fe70b408c774eb0c8ce4d1bc04f88&amp;token=958537801&amp;lang=zh_CN&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">LeCun 怒揭机器人最大骗局，坦白 Llama 与我无瓜！</a></em></p>
<p>据称，LeCun 将要成立的新公司主要推进「世界模型」，目标直指真正的人类级智能。</p>
<p>目前，他正在进行早期的融资洽谈。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50c8fd9db6d848f8b507499cfbb8dda4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=9cfDWznPGCj1f3dCMZUwza3fqfM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/220f3c8a478c4f69bffafed4d0299572~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=U0z65tLMdaO6qoM8dpovzBfmQjc%3D" alt="" loading="lazy"/></p>
<p>网友盲猜，LeCun 离职可能和会见吴恩达有所关联</p>
<p>任职 12 年，从创办 FAIR 实验室，到拿下图灵奖，再到笃定的世界模型，LeCun 出走对于 Meta 来说，是一次巨震。</p>
<p>或许，小扎的超级智能梦，真的要碎了。</p>
<p>有网友表示，这并不意外。另有人调侃道，「要始终向一个孩子汇报工作，LeCun 的自尊心怎么不会受到伤害呢」。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/061772d29496462183455d014bd59b67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=fbMvAWoXuTmzNInaMVnq5YHbv2o%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06214cd349cb47d4bc9cd46f8aa57090~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=prgmYHDqpNQocppaMX%2BZaxDJv5s%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45604033ebf34166895159edd1e4fc14~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=IC%2FoiwC1sVYHgy5muxY1iEkzVyE%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/801f3b6093e24518af72d607bd68e681~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=Q7jacF%2BhSsHi2ScFCjN%2Fhs2r1pA%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e45a5544f5c4ba883f72a279eee229a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=m550ebaKMQHbVzY7y0PDvHN7rrY%3D" alt="" loading="lazy"/></p>
<p>上下滑动查看</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/631e86199f97483487e9603121ffbfe0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=T5wgpjILTFOiihsgWC1Ruqf8EjM%3D" alt="" loading="lazy"/></p>
<p><strong>「效力 12 年决裂，LeCun 愤然离职」</strong></p>
<p>不得不说，这事儿来的太突然，但却早有苗头。</p>
<p>当前，正值 Meta 对公司 AI 业务进行大刀阔斧的改革之际，希望开发出更强大的 AI，挑战 OpenAI、谷歌等竞争对手。</p>
<p>今年初，Llama 4 发布翻车，且性能远不及 ChatGPT、Gemini 等模型。而且，Meta AI 聊天机器人推出后，许多人并不买账。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2343f0fbcbab45029676122853e3eff7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=IY5DTDzvyWIiBmRRz5i94G7XzQQ%3D" alt="" loading="lazy"/></p>
<p>在认定 Meta 在竞争中落后之后，小扎的战略重心也随之改变——</p>
<p>从 LeCun 领军的 FAIR 实验室，转向更快推出模型和 AI 产品。</p>
<p>先是今年 4 月，小扎斥资 143 亿美元聘请了 28 岁 Alexandr Wang，去领导全新「超级智能」团队。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe08b7b00c85446cb075c9a9e37e422f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=YRzo2z9ZLMIm%2FgZpV72n2YuGYVY%3D" alt="" loading="lazy"/></p>
<p>在此过程中，他亲自组建 TBD Lab，开出高达 1 亿美元的薪酬包，从谷歌、OpenAI 抢人。</p>
<p>其中包括，ChatGPT 的核心研究员 Shengjia Zhao，被挖来出任 MSL 首席科学家。</p>
<p>目标很简单，推动其下一代大语言模型的开发。</p>
<p>仅在今年，Meta 内部就进行了超 4 次架构调整和优化，并将 MSL 分立出四大部门，全部由 Alexandr Wang 掌舵：</p>
<ol>
<li>TBD Lab （To Be Determined，待确定，负责探索 / 先导研究）</li>
<li>FAIR （Fundamental AI Research，长期前沿研究）</li>
<li>产品和应用团队 （含 Meta AI 助手等）</li>
<li>基础设施 （训练与推理的算力、数据与平台）</li>
</ol>
<p>因此，此前向首席产品官 Chris Cox 汇报的 LeCun，现在转而向 Wang 汇报。</p>
<p>不仅如此，LeCun 长期领导的 FAIR 也逐渐被边缘化，向比他小 30 多岁的 Wang 汇报，包括论文，也需得到审批后才可发表。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5257e88895074c8aac88d463116e4de5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=Kq36WpX%2B1cnOIzblpulg%2BeAEmpA%3D" alt="" loading="lazy"/></p>
<p>另一方面，LeCun 认为小扎置于其战略核心的 LLM 虽然「有用」，但永远无法像人类一样进行推理和规划。</p>
<p>在 FAIR 内部，LeCun 也一直专注于开发「世界模型」，但在短期内，是看不到 KPI 的。</p>
<p>而小扎现在要的是，立即就能变现的 AI 产品。</p>
<p>看得出，LeCun 所坚持的路线和个人观点，与 Meta 的 AI 愿景出现了明显的分歧。</p>
<p>种种因素的叠加，早已成为 LeCun 离职的导火索。而现在，就是最好的时机。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2611de3112fb4d06bedc5d4c7c26c63a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=uwcDi3Tj9KP6v9tly0gPAGt2qQQ%3D" alt="" loading="lazy"/></p>
<p><strong>「全力押注「世界模型」」</strong></p>
<p>庆幸的是，LeCun 终于可以在「世界模型」上大展身手了。</p>
<p>一直以来，他坚信大模型最终没有出路，永远学不会真正的推理和规划，也根本无法通往 AGI。</p>
<p>LLM 不如阿猫阿狗，LeCun 已在多种公开场合中多次提出。</p>
<p>在他看来，AI 的终局就是「世界模型」。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e0835db6cedf482b872ea25b532faf55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=N%2BPLO1RJJw7QP8uCWFF1AaMlQWo%3D" alt="" loading="lazy"/></p>
<p>前段时间，他在 MIT 访谈中直言，未来 3-5 年内，「世界模型」会成为 AI 架构的主流模型。</p>
<p>这话可让我在硅谷得罪了不少人，包括某些巨头公司。</p>
<p>到那时候，但凡头脑清醒的人，都不会再用现在这种生成式 LLM 的路子了。</p>
<p>世界模型不仅仅学习语言，还通过视频和空间数据，来理解物理世界。</p>
<p>直白讲，它让 AI 可以像婴儿一样，从观察中学习世界的规律。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dfc60ec60302426d83aaea37e3990c1a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=iIGgUYsLmNTe5kUbRhywkp4ZSWI%3D" alt="" loading="lazy"/></p>
<p>不过，LeCun 表示，开发出这个架构需要十年的时间才能成熟。</p>
<p>即便时间漫长，他终于可以坚定按着目标方向前进了。</p>
<p>未来几个月，LeCun 将正式离职 Meta，下一步计划将专注于深化在「世界模型」领域的研究。</p>
<p>AI 掌舵人出走，这意味着，FAIR 实验室就彻底被边缘化了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35b5e2d5e1974bbd9d616cf542ce55a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=CM4EEuUPdBodh3yDUSJf4B2f2pc%3D" alt="" loading="lazy"/></p>
<p><strong>「图灵巨头，开启 AI 革命」</strong></p>
<p>1960 年 7 月 8 日出生的 Yann LeCun，在法国巴黎的郊区长大。</p>
<p>他的姓氏原本是 Le Cun，但他发现美国人常对此感到困惑，将 Le 误作他的中间名，于是便去掉了中间的空格。</p>
<p>他的父亲是一名工程师，在 LeCun 充满修补创造的童年中，将自己对电子和机械的热爱传给了他。</p>
<p>青少年时期，LeCun 既喜欢在乐队中演奏，也热爱科学与工程。</p>
<p>后来，他在法国精英工程师学校之一的巴黎高等电子与电工工程师学院（ESIEE Paris）获得了相当于硕士的学位。在那里，他专注于微芯片设计与自动化。</p>
<p>他从本科时代就开始独立进行机器学习研究，并将其作为他在索邦大学（当时称为皮埃尔和玛丽 · 居里大学）博士阶段的核心工作。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0edc6ec9354f4e419618b11217f39be9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=7eMCmy2Bc09t8XcbRKA1dm5J3kw%3D" alt="" loading="lazy"/></p>
<p>LeCun 的研究与 Geoffrey Hinton 独立做出的发现高度相似。</p>
<ul>
<li>与 Hinton 一样，他被当时尚属非主流的神经网络人工智能方法所吸引；</li>
<li>也与 Hinton 一样，他发现可以通过使用后来被称为「反向传播」的算法来有效训练输入和输出节点之间中间层的「隐藏」神经元，从而克服简单神经网络众所周知的局限性。</li>
</ul>
<p>1985 年在法国阿尔卑斯山区举办的一场研讨会，首次让 LeCun 与从事相关研究的国际学术界有了直接接触。</p>
<p>正是在那里，他结识了 Hinton 的密切合作者 Terry Sejnowski。当时，Sejnowski 关于反向传播的研究尚未发表。</p>
<p>几个月后，Hinton 到访巴黎，并主动向 LeCun 作了自我介绍。</p>
<p>再之后，LeCun 则受邀参加卡内基梅隆大学的夏季研讨会，并在多伦多 Hinton 新成立的研究小组进行了一年的博士后研究。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f32cc9f763da42a9a119ea76e1f9da8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=rRIgVMn8dDXBwdepQKCpWS05gmk%3D" alt="" loading="lazy"/></p>
<p>1988 年，博士后研究结束时，LeCun 加入了著名的计算机科学研究中心——贝尔实验室。</p>
<p>在贝尔实验室，LeCun 的工作专注于神经网络架构和学习算法。</p>
<p>他影响最为深远的贡献是一种名为「卷积神经网络」的新方法。这是他早期成就的延伸，因为卷积网络依赖反向传播技术来训练其隐藏层。</p>
<p>除了开发卷积方法，LeCun 还率先将其应用于「图 Transformer 网络」，用于识别印刷体和手写文本。这项技术被用于一个广泛部署的系统，以读取支票上的手写数字。</p>
<p>他在贝尔实验室的另一项主要贡献是开发了「最佳脑损伤」（Optimal Brain Damage）正则化方法。</p>
<p>这个名字生动的概念旨在通过移除神经网络中不必要的连接来简化网络。如果操作得当，这种「脑损伤」可以产生更简单、更快速的网络，其性能与完整版本相当甚至更优。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d77f5ad18094d43aaaf6cb37caa9477~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=Q0tSyBvug%2FbURAV88AmhZUfd5MQ%3D" alt="" loading="lazy"/></p>
<p>1996 年，在计算机行业未能立足的 AT&amp;T 公司，将贝尔实验室的大部分业务及其电信硬件业务分拆成立了一家新公司——朗讯科技。</p>
<p>LeCun 留在了 AT&amp;T，负责一个专注于图像处理研究的实验室小组。</p>
<p>在那里，他的主要成就是 DjVu 图像压缩技术。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d450fa31e1640438713b77d81ba4973~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=CwI5F83Du6m4WqZndIpEUoPOlXg%3D" alt="" loading="lazy"/></p>
<p>2003 年，LeCun 离开工业界，前往纽约大学库朗数学科学研究所担任计算机科学教授。</p>
<p>在纽约大学，LeCun 负责计算与生物学习实验室，继续他在机器学习算法和计算机视觉应用方面的工作。</p>
<p>他至今仍在纽约大学任教，尽管随着声誉日隆，他又增添了几个新头衔和额外职位。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b5bc1a1219e443a89fea734c13383a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=ABQabRu0KICtSQ2sekCwcvwOUio%3D" alt="" loading="lazy"/></p>
<p>到 2010 年代初，各大科技公司竞相部署基于神经网络的机器学习系统。与其他顶尖研究人员一样，LeCun 也受到了科技巨头的青睐。</p>
<p>2013 年 12 月，他加入 Facebook 并创建了 FAIR（Facebook AI Research），同时，他也还兼顾在纽约大学的工作。</p>
<p>2018 年，他卸任主任一职，转任 Facebook 首席人工智能科学家，专注于战略规划和科学领导力。</p>
<p>同年，他与 Geoffrey Hinton 和 Yoshua Bengio，共同获得了图灵奖。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb089d529bc3488081619e67d11db779~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=kyFe1z%2B27b8X7%2Fs66F6pgS2hBMM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e45aa40a00b49e180ea118e912084a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763542970&amp;x-signature=VjQwo43bN9CoPIlKN0%2FyGh6Bi2s%3D" alt="" loading="lazy"/></p>
<p>时至今日，LeCun 一直保持着对动手创造的热爱，他的爱好包括制造飞机、电子乐器和机器人。</p>
<p>或许，这也是他在 65 岁时，毅然决定下海创业的动力之一。</p>
<p>参考资料：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ft.com%2Fcontent%2Fc586eb77-a16e-4363-ab0b-e877898b70de" target="_blank" title="https://www.ft.com/content/c586eb77-a16e-4363-ab0b-e877898b70de" ref="nofollow noopener noreferrer">www.ft.com/content/c58…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【AI绘图新手必看】Nano Banana实战教学：从提示词到画面构图！]]></title>    <link>https://juejin.cn/post/7571637614203387931</link>    <guid>https://juejin.cn/post/7571637614203387931</guid>    <pubDate>2025-11-12T09:27:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571637614203387931" data-draft-id="7571655979255726120" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【AI绘图新手必看】Nano Banana实战教学：从提示词到画面构图！"/> <meta itemprop="keywords" content="AIGC,Gemini"/> <meta itemprop="datePublished" content="2025-11-12T09:27:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户815091607260"/> <meta itemprop="url" content="https://juejin.cn/user/2042264015120554"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【AI绘图新手必看】Nano Banana实战教学：从提示词到画面构图！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2042264015120554/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户815091607260
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T09:27:34.000Z" title="Wed Nov 12 2025 09:27:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Nano Banana，大香蕉模型小名“纳米香蕉”是 Google/DeepMind 推出的图像生成/编辑子模型（Gemini 2.5 Flash Image 系列的俗称），以强大的一步/迭代图像编辑能力著称，特别擅长在保持主体一致性的前提下对已有照片进行复杂改造（如把真人变成微型摆件、换背景、服装替换、连贯的人物系列编辑等）。</p>
<p>单张/多张图像编辑、one-shot 风格替换、持续迭代保持角色一致、从照片生成风格化3D/半3D小模型/摆件、与 Photoshop等工具集成等。</p>
<p>下面给你一份 <strong>详尽的 Nano-banana（即 Google Gemini 的 “Nano Banana / Gemini 2.5 Flash Image”）使用教程</strong>，包含：功能概览、逐步上手教程、Prompt 工程与技巧、10 个「神级玩法」案例（含提示词与步骤）、以及如何通过 <strong>神马中转 API</strong> 直接使用和配置并调用 Nano-banana（含示例代码）。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7484a1e1e27d4a1e8cff035bb4d6f609~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763544453&amp;x-signature=Wqft1iPoDwU72Y1pxeoaKyBeNiY%3D" alt="【Nano-banana超详细使用教程】：从入门到精通，一文搞懂Gemini 2.5 Flash Image全流程！Nano-banana怎么用/提示词/实战教程AI图像生成" loading="lazy"/></p>
<h2 data-id="heading-0">1. Nano Banana提示词Prompt工程（实战要点）</h2>
<p>成功的图像编辑 prompt 通常要“分层、简洁、指向明确”——建议使用下面结构化模板（可复制粘贴改写），也可以直接复制下一部分提示词的示例直接快速上手：</p>
<pre><code class="hljs">主体描述（谁 / 物）；
动作或姿态（在做什么）；
风格/细节（写明风格：写实 / 插画 / 纸雕 / 3D 小摆件）；
光照/环境（时间/光源/相机角度）；
材质/纹理（例如陶瓷、塑料、金属、迷你木雕）；
保留或限制（“保留面部表情/不要改变背景中 XX”）；
输出格式与修饰（“高细节、4k、自然阴影、无文字”）。
</code></pre>
<p>示例（将自拍变成太空宇航服风格）：</p>
<pre><code class="hljs">主体：正面自拍，微笑，年约25岁女性；
动作：面向镜头，头戴透明头盔，身体穿宇航服；
风格：科幻写实，细节丰富；
环境：太空背景，地球在远处，可见星云光晕；
光照：来自右上方的冷色主光，柔和反射；
保留：保留眼睛和面部特征；
输出：可用于头像，裁剪为方形
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7d42215ec32416c913745a52c8d69c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763544453&amp;x-signature=3Gc6Vf7e3P7wWatsbTAiS%2BRYUyo%3D" alt="" loading="lazy"/></p>
<p><strong>实用技巧</strong></p>
<ul>
<li>
<p>分句写提示，短句比长段更稳定。</p>
</li>
<li>
<p>使用否定短语（avoid / 不要）明确排除元素。</p>
</li>
<li>
<p>用“参考图”或“参考关键词”提高风格一致性（如给出风格参考图或写“像 Studio Ghibli 风格”）。</p>
</li>
<li>
<p>若要多次迭代，记录每次 prompt 的改动点，方便复现与微调。</p>
</li>
</ul>
<h2 data-id="heading-1">2. 10 个 Nano-banana「神级玩法」与示例提示词（每条含操作步骤与提示词）</h2>
<blockquote>
<p>下列玩法兼顾创意与可实现性，适用于社交媒体、商业设计、影视概念、个人创作等场景。</p>
</blockquote>
<h4 data-id="heading-2">微型摆件 / 人像“摆件化”</h4>
<p><strong>思路</strong>：把真人照片转成桌面小摆件（mini figurine）风格，保留面部特征且做出“塑料/陶瓷”质感。</p>
<p><strong>示例 prompt</strong>：</p>
<pre><code class="hljs">把主体变为一个桌面微型摆件，类似精致陶瓷人偶，头部细节保留，面部光滑有微光，底座木质，尺寸迷你，浅景深相机镜头，柔和环境光，背景为书桌模糊。保持面部表情不变。
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40ec4b7030e8455d8e385d2e1c2e8668~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763544453&amp;x-signature=49nDdVN2dGEpFm%2FV7ucxbqeZLFk%3D" alt="" loading="lazy"/></p>
<p><strong>步骤</strong>：上传清晰正面照 → 指定 mask（身体或背景）→ 选择“塑料/陶瓷”质感 → 迭代调整材质和阴影。</p>
<h4 data-id="heading-3">更换多种发型</h4>
<p>输入: 需上传一张需要更换发型的人像图片</p>
<p>提示词:</p>
<pre><code class="hljs">以九宫格的方式生成这个人不同发型的头像
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dc8752a045784b38ad0251574f187570~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763544453&amp;x-signature=j0uaQUaqZK%2FvUjYqBSJIqaFgpV4%3D" alt="【Nano-banana超详细使用教程】：从入门到精通，一文搞懂Gemini 2.5 Flash Image全流程！Nano-banana怎么用/提示词/实战教程AI图像生成" loading="lazy"/></p>
<h4 data-id="heading-4">电影海报级别场景重塑</h4>
<p><strong>示例 prompt</strong>：</p>
<pre><code class="hljs">把这张城市街拍重制为赛博朋克电影海报风格：霓虹灯、雨滴反射、冷暖对比、宽银幕构图、加深阴影、电影颗粒，保留主体姿态。
</code></pre>
<p><strong>步骤</strong>：上传原图 → 指定 “风格：赛博朋克” → 要求“宽银幕构图+高对比”。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b91252e22070425ea85e884252647391~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763544453&amp;x-signature=0L6G3PPfXT1bLED2s1Mzhpmc%2FdA%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-5">电影分镜</h4>
<p><strong>思路</strong>：需上传参考图像</p>
<p><strong>提示</strong>：</p>
<pre><code class="hljs">用这两个角色创作一个令人上瘾的12部分故事，包含12张图像，讲述经典的黑色电影侦探故事。故事关于他们寻找线索并最终发现的失落的宝藏。整个故事充满刺激，有情感的高潮和低谷，以精彩的转折和高潮结尾。不要在图像中包含任何文字或文本，纯粹通过图像本身讲述故事在这张模特图上尝试三种未来感服装：1) 轻质反光外套 2) 高腰结构连衣 3) 层叠功能性战术装。每个输出保持模型脸部与姿态一致。
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3991bc2af0de4c0bb20f949ba3bf60d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763544453&amp;x-signature=Evv7T9QZ1%2BeBxZ18XhyRF8v08xI%3D" alt="【Nano Banana超详细使用教程】：从入门到精通，一文搞懂Gemini 2.5 Flash Image全流程！Nano-banana怎么用/提示词/实战教程AI图像生成" loading="lazy"/></p>
<h4 data-id="heading-6">人物姿势修改</h4>
<p><strong>提示</strong>：</p>
<pre><code class="hljs">让图片中的人直视前方
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7dde9c4e37e84dccb8f0b906aad9f466~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763544453&amp;x-signature=36kwRg6LkGdOfJeQZaM6X8ac%2F2k%3D" alt="【Nano Banana超详细使用教程】：从入门到精通，一文搞懂Gemini 2.5 Flash Image全流程！Nano-banana怎么用/提示词/实战教程AI图像生成" loading="lazy"/></p>
<h4 data-id="heading-7">线稿图生成图像</h4>
<p><strong>提示</strong>：</p>
<pre><code class="hljs">将图一人物换成图二姿势，专业摄影棚拍摄
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0062f5fc741400b9fb06755f8bf679b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763544453&amp;x-signature=b59LA7URe2V3mXHJMW6iFwgioRc%3D" alt="【Nano Banana超详细使用教程】：从入门到精通，一文搞懂Gemini 2.5 Flash Image全流程！Nano-banana怎么用/提示词/实战教程AI图像生成" loading="lazy"/></p>
<h4 data-id="heading-8">物品包装生成</h4>
<p><strong>思路</strong>：需上传一张物品参考图像和一张包装参考图片</p>
<p><strong>提示</strong>：</p>
<pre><code class="hljs">把图一贴在图二易拉罐上，并放在极简设计的布景中，专业摄影
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be527b44a3ae40de842c59fbabdfe118~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763544453&amp;x-signature=GS0rZkV%2FsP10g%2F4Kf1bU5a963t0%3D" alt="【Nano Banana超详细使用教程】：从入门到精通，一文搞懂Gemini 2.5 Flash Image全流程！Nano-banana怎么用/提示词/实战教程AI图像生成" loading="lazy"/></p>
<h4 data-id="heading-9">动漫转真人Coser</h4>
<p><strong>输入:</strong> 需上传一张插画图像</p>
<p><strong>提示词:</strong></p>
<pre><code class="hljs">生成一个女孩cosplay这张插画的照片，背景设置在Comiket
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d460018b21134a87a33c2b8b85eb78ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763544453&amp;x-signature=%2BGlvGI%2B5mjDI%2FNDy%2FnZWlzT7fM8%3D" alt="【Nano Banana超详细使用教程】：从入门到精通，一文搞懂Gemini 2.5 Flash Image全流程！Nano-banana怎么用/提示词/实战教程AI图像生成" loading="lazy"/></p>
<h4 data-id="heading-10">生成角色设定</h4>
<p><strong>输入:</strong> 需上传一张角色参考图像</p>
<p><strong>提示词:</strong></p>
<pre><code class="hljs language-sql" lang="sql">为我生成人物的角色设定（<span class="hljs-type">Character</span> Design）

比例设定（不同身高对比、头身比等）

三视图（正面、侧面、背面）

表情设定（Expression Sheet） → 就是你发的那种图

动作设定（Pose Sheet） → 各种常见姿势

服装设定（Costume Design）
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d58201e5620d4de2b0bf8ac56733be07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763544453&amp;x-signature=yWlCAMlnwpOaDTuU1VKszJrZvoA%3D" alt="【Nano Banana超详细使用教程】：从入门到精通，一文搞懂Gemini 2.5 Flash Image全流程！Nano-banana怎么用/提示词/实战教程AI图像生成" loading="lazy"/></p>
<h4 data-id="heading-11">OOTD穿搭</h4>
<p><strong>输入:</strong> 需上传一张人物图片和服装图片</p>
<p><strong>提示词:</strong></p>
<pre><code class="hljs">选择图1中的人，让他们穿上图2中的所有服装和配饰。在户外拍摄一系列写实的OOTD风格照片，使用自然光线，时尚的街头风格，清晰的全身镜头。保持图1中人物的身份和姿势，但以连贯时尚的方式展示图2中的完整服装和配饰
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e6249d485a748178b8f5d76ed7e243e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763544453&amp;x-signature=dmidXscN%2BefhKgRvsLBOSzwc4a0%3D" alt="【Nano Banana超详细使用教程】：从入门到精通，一文搞懂Gemini 2.5 Flash Image全流程！Nano-banana怎么用/提示词/实战教程AI图像生成" loading="lazy"/></p>
<h2 data-id="heading-12">3. Nano-banana怎么用：四种常见使用方式（含操作步骤）</h2>
<p>下面给出最常见的四种上手方式（带具体步骤）——如果你已经有图像，直接按其中一种走即可。</p>
<h3 data-id="heading-13">方式 A：在 Google Gemini / AI Studio 中使用（官方渠道）</h3>
<ol>
<li>
<p>打开 Gemini Image 编辑页面或 AI Studio（gemini.google / AI Studio）。选择 <strong>Gemini 2.5 Flash Image / Nano-banana</strong> 模型（有时称“Nano-banana”或“gemini-2-5-flash-image”）。</p>
</li>
<li>
<p>上传你的原图（单张或多张参考图）。</p>
</li>
<li>
<p>在文本框输入你的编辑提示（prompt）。可分句写清楚要点：主体、动作/表情、风格、背景、光照、材质、要保留/删除的元素。</p>
</li>
<li>
<p>若支持 mask（蒙版），可用画笔圈出希望变动的区域，或标注需保留细节（例如“保留左耳环细节”）。</p>
</li>
<li>
<p>生成后使用“迭代”或“变体”功能微调；每轮在 prompt 里加上“更强的光照/更逼真的阴影/保留脸部特征”等指示。</p>
</li>
</ol>
<blockquote>
<p>备注：通过官方界面通常能得到最佳一致性与合规性（并可能带有不可见的 SynthID 水印用于标识 AI 生成图像）。</p>
</blockquote>
<h3 data-id="heading-14">方式 B：通过第三方应用或插件（例如 Photoshop 集成）</h3>
<ul>
<li>如果你是设计师，Nano-banana 已被部分工具支持为模型选项，直接在 Photoshop 内选择对应模型即可进行本地化工作流编辑。</li>
</ul>
<h3 data-id="heading-15">方式 C：通过 CLI / SDK / 自建前端 调用模型 API</h3>
<ul>
<li>若你要做批量或自动化：可使用官方或第三方神马中转API（如 Gemini 的模型名 gemini-2-5-flash-image），把图片上传并附带 prompt 发起请求，接收返回的编辑结果（base64 / URL）。</li>
</ul>
<h3 data-id="heading-16">方式 D：使用神马中转API调用Nano-banana：配置与示例</h3>
<blockquote>
<p>说明：国内常用的「中转 / 聚合」服务（例如“神马中转 API（api.whatai.cc）等”）通常作为代理，把你对 OpenAI / Gemini / 其它模型的调用统一转发处理。下面给出神马中转API可视化和<strong>文生图示例</strong></p>
</blockquote>
<h4 data-id="heading-17">神马中转API可视化操作</h4>
<p>神马中转API上方菜单-聊天-Nano Banner画图-输入提示词、上传参考图、生成保存图片</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/adae23fb00474961aecb03e3419a9838~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODE1MDkxNjA3MjYw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763544453&amp;x-signature=38v5sPVJ4eSBDlYw0cw83e6Cai4%3D" alt="【Nano Banana超详细使用教程】：从入门到精通，一文搞懂Gemini 2.5 Flash Image全流程！Nano-banana怎么用/提示词/实战教程AI图像生成" loading="lazy"/></p>
<h4 data-id="heading-18">Python文生图示例</h4>
<p>Dalle 格式介绍<br/>
Generations 通用 (图生图 &amp; 文生图)<br/>
用途：用文字或文字+图片来生成一张全新的图片。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> http.client
<span class="hljs-keyword">import</span> json

conn = http.client.HTTPSConnection(<span class="hljs-string">""</span>)
payload = json.dumps({
   <span class="hljs-string">"prompt"</span>: <span class="hljs-string">"cat"</span>,
   <span class="hljs-string">"model"</span>: <span class="hljs-string">"nano-banana"</span>
})
headers = {
   <span class="hljs-string">'Authorization'</span>: <span class="hljs-string">'Bearer {{YOUR_API_KEY}}'</span>,
   <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>
}
conn.request(<span class="hljs-string">"POST"</span>, <span class="hljs-string">"/v1/images/generations"</span>, payload, headers)
res = conn.getresponse()
<span class="hljs-keyword">data</span> = res.read()
print(<span class="hljs-keyword">data</span>.decode(<span class="hljs-string">"utf-8"</span>))
</code></pre>
<h2 data-id="heading-19">4. 常见问题与可复用策略</h2>
<ul>
<li>
<p><strong>如何保持人物一致性？</strong> 上传原始图并在每次请求中把上一次输出也作为参考图；在 prompt 中明确写 “保持面部特征 / 保持发色 / 保持脸型”。</p>
</li>
<li>
<p><strong>结果不理想怎么办？</strong> 逐步微调 prompt、使用 mask 精确控制修改区域、或降低生成风格强度（写“more photorealistic / less stylized”）。</p>
</li>
<li>
<p><strong>速度与成本</strong>：通过中转平台可能更便宜/稳定，但要留意延迟与图片大小带来的费用。</p>
</li>
<li>
<p><strong>法律/道德</strong>：避免未经授权修改他人肖像作商业用途，注意隐私与肖像权。官方模型/平台可能会对某些敏感内容进行限制与检测。</p>
</li>
</ul>
<h2 data-id="heading-20">5. 快速贴士清单（10 条）</h2>
<ol>
<li>
<p>用短句分层写 prompt。</p>
</li>
<li>
<p>首轮先要广，后续再微调细节。</p>
</li>
<li>
<p>用参考图胜过长篇风格描述。</p>
</li>
<li>
<p>用 mask 精确改动区域。</p>
</li>
<li>
<p>保存每次 prompt 便于复现。</p>
</li>
<li>
<p>若要一致性，提供多张参考角度的原图。</p>
</li>
<li>
<p>避免在 prompt 中加入模棱两可的词。</p>
</li>
<li>
<p>使用神马中转API时先做小尺寸测试再放量。</p>
</li>
<li>
<p>尊重被摄者权限和版权。</p>
</li>
<li>
<p>关注模型输出中的合规信息（如 SynthID）。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Qoder 降价，立即生效！首购 2 美金/月]]></title>    <link>https://juejin.cn/post/7571594817224196147</link>    <guid>https://juejin.cn/post/7571594817224196147</guid>    <pubDate>2025-11-12T09:53:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571594817224196147" data-draft-id="7571594817224179763" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Qoder 降价，立即生效！首购 2 美金/月"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-12T09:53:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="LucianaiB"/> <meta itemprop="url" content="https://juejin.cn/user/1269294586664749"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Qoder 降价，立即生效！首购 2 美金/月
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1269294586664749/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    LucianaiB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T09:53:39.000Z" title="Wed Nov 12 2025 09:53:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Qoder 全球上线仅两个月，已获得全球数十万开发者的信赖与支持。</h2>
<p>为了让每一位开发者都能轻松用上顶尖的 AI 编程工具，Qoder 面向全球开发者推出首购优惠：由原价 10 美元/月直降至 2 美元/月（折合人民币约14.2元），一杯咖啡的钱，即可解锁 Qoder 全部核心功能的完整体验！
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/415b29e528ea4c6db06a590d05be4837~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763546019&amp;x-signature=MSfRWoGhDKpP6GuH57k6oVAVYsU%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>除了极具吸引力的价格，Qoder 在功能上也实现了全面进化：</p>
<p>首先，Qoder 集成了全球顶尖的编程模型，并新上线模型分级选择器，提供四类高性能模型池：基础轻量（Lite）、经济高效（Efficient）、极致性能（Performance）与智能路由（Auto），不同任务由最适合的模型无缝切换执行，开发者无需理解模型差异，从而减少认知负担并提升效率。</p>
<p>其次，在上下文工程能力方面，Qoder 提供最强的上下文工程能力，可一次检索 10 万个代码文件，结合全球顶尖的大模型能力与 Agent，对大规模代码进行深度语义检索与持续上下文理解，将复杂、多阶段的开发任务拆解并由智能体迭代完成，以“仓库级理解 + 任务化执行”正面应对真实工程的复杂度。</p>
<p>自上线开始，Qoder 持续通过技术升级，比如：工程检索准确率提升、智能体工具并行化优化、上下文智能压缩等能力，在保证效果的前提下持续优化单任务的 token 消耗，让开发真切感受到 Credits 越来越耐用。</p>
<p>在公测期备受开发者关注的 Repo Wiki 和 Quest 模式，也迎来了重磅升级：</p>
<p>Repo Wiki：基于代码库，自动生成结构化项目文档与知识库，将代码中的隐性经验转化为团队共享的显性知识，支持多人编辑、共享与导出，以及一键修复。</p>
<p>Quest 模式：可将复杂耗时的开发任务一键委派至云端沙箱异步执行，彻底释放本地算力。原本需数天完成的任务，现在最快十分钟内交付。</p>
<p>Qoder CLI：开箱即用的智能终端
上个月，Qoder CLI 正式发布，让开发者通过自然语言在终端完成代码生成、调试、部署等任务，实现随处集成，效果不打折。
无需复杂初始化，安装即可使用，确保跨环境一致的编程体验。</p>
<p>内置轻量级 Agent 框架，空闲内存占用比同类工具低 70%，常见命令响应时间 &lt; 200ms。</p>
<p>集成 Quest 模式（自主编程） 与 CodeReview 功能，轻松实现基于 Spec 的任务委派，让 AI 自主完成开发流程。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ead147f3b30c44ba86278a3fc47728ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTHVjaWFuYWlC:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763546019&amp;x-signature=lAfYQq6MNPKQ51twcC6gxRepfUs%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>此外，Qoder JetBrains 插件也即将上线，全方位覆盖各类开发者的使用场景。</p>
<p>现在，Qoder以一杯咖啡的诚意，向每一位开发者发出了邀请，这是一次对个人工作流的根本性升级以及一张通往更高效率、更多创造力的门票。</p>
<p>这场由 AI Coding 驱动的效率革命已经到来，你准备好解锁全新开发体验了吗？</p>
<p>下载体验：<a href="https://link.juejin.cn?target=https%3A%2F%2Fqoder.com%2Fdownload" target="_blank" title="https://qoder.com/download" ref="nofollow noopener noreferrer">qoder.com/download</a></p>
<p>FAQ：关于降价，你可能会关心的问题：
1、新用户首购 2 美元/月是长期的吗？</p>
<p>是的，我们期望为全球开发者提供低门槛上手的订阅方式。</p>
<p>2、什么是新用户？</p>
<p>新用户是指未购买过任何订阅计划、首次订阅 Qoder Pro 并有资格享受折扣价的用户。</p>
<p>3、此前参加过 Qoder 公测但是没有付费的用户，可以参与吗？</p>
<p>可以参与。</p>
<p>4、首购优惠后如何续费？</p>
<p>按 10 美金每月续费。</p>
<p>5、退款后还能再次享受首购优惠吗？</p>
<p>发生过付费，即使退款也不能再次享受首购优惠了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端代码规范体系建设与团队落地实践]]></title>    <link>https://juejin.cn/post/7571650164843479074</link>    <guid>https://juejin.cn/post/7571650164843479074</guid>    <pubDate>2025-11-12T10:02:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571650164843479074" data-draft-id="7571655979255955496" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端代码规范体系建设与团队落地实践"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-11-12T10:02:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大知闲闲i"/> <meta itemprop="url" content="https://juejin.cn/user/3799545205237111"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端代码规范体系建设与团队落地实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3799545205237111/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大知闲闲i
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T10:02:39.000Z" title="Wed Nov 12 2025 10:02:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、为什么需要前端代码规范？</h2>
<p>在现代前端开发中，代码规范是团队协作的基石。随着项目规模扩大和团队成员增多，统一的代码规范能够带来显著的收益：</p>
<h3 data-id="heading-1">核心价值</h3>
<ul>
<li>
<p><strong>提升代码可读性</strong>：一致的代码风格让团队成员能够快速理解他人代码</p>
</li>
<li>
<p><strong>降低维护成本</strong>：规范的代码结构便于后续维护和功能迭代</p>
</li>
<li>
<p><strong>减少低级错误</strong>：静态检查工具能够捕捉潜在的代码问题</p>
</li>
<li>
<p><strong>提高开发效率</strong>：自动化的格式化和检查节省手动调整时间</p>
</li>
<li>
<p><strong>促进团队协作</strong>：统一的规范减少代码合并冲突和沟通成本</p>
</li>
</ul>
<h2 data-id="heading-2">二、代码规范设计体系</h2>
<h3 data-id="heading-3">1. 基础代码规范（技术核心层）</h3>
<h4 data-id="heading-4">JavaScript/TypeScript 规范 (ESLint + Prettier)</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// .eslintrc.js</span>
<span class="hljs-keyword">module</span>.exports = {
  extends: [
    <span class="hljs-string">'eslint:recommended'</span>,
    <span class="hljs-string">'plugin:@typescript-eslint/recommended'</span>,
    <span class="hljs-string">'plugin:react/recommended'</span>,
    <span class="hljs-string">'plugin:prettier/recommended'</span>
  ],
  parser: <span class="hljs-string">'@typescript-eslint/parser'</span>,
  plugins: [<span class="hljs-string">'@typescript-eslint'</span>, <span class="hljs-string">'react'</span>, <span class="hljs-string">'react-hooks'</span>],
  rules: {
    <span class="hljs-comment">// React Hooks 规则</span>
    <span class="hljs-string">'react-hooks/rules-of-hooks'</span>: <span class="hljs-string">'error'</span>,
    <span class="hljs-string">'react-hooks/exhaustive-deps'</span>: <span class="hljs-string">'warn'</span>,
    
    <span class="hljs-comment">// 代码风格</span>
    <span class="hljs-string">'indent'</span>: [<span class="hljs-string">'error'</span>, <span class="hljs-number">2</span>],
    <span class="hljs-string">'quotes'</span>: [<span class="hljs-string">'error'</span>, <span class="hljs-string">'single'</span>],
    <span class="hljs-string">'semi'</span>: [<span class="hljs-string">'error'</span>, <span class="hljs-string">'always'</span>],
    
    <span class="hljs-comment">// 生产环境限制</span>
    <span class="hljs-string">'no-console'</span>: process.env.NODE_ENV === <span class="hljs-string">'production'</span> ? <span class="hljs-string">'warn'</span> : <span class="hljs-string">'off'</span>,
    <span class="hljs-string">'no-debugger'</span>: process.env.NODE_ENV === <span class="hljs-string">'production'</span> ? <span class="hljs-string">'warn'</span> : <span class="hljs-string">'off'</span>,
    
    <span class="hljs-comment">// TypeScript 规则</span>
    <span class="hljs-string">'@typescript-eslint/explicit-function-return-type'</span>: <span class="hljs-string">'off'</span>,
    <span class="hljs-string">'@typescript-eslint/no-unused-vars'</span>: [<span class="hljs-string">'error'</span>, { 
      argsIgnorePattern: <span class="hljs-string">'^_'</span> 
    }]
  },
  settings: {
    react: {
      version: <span class="hljs-string">'detect'</span>
    }
  }
};
</code></pre>
<h4 data-id="heading-5">Prettier 格式化配置</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"printWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"tabWidth"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"useTabs"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"semi"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"singleQuote"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"trailingComma"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"all"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"bracketSpacing"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"jsxSingleQuote"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"arrowParens"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"always"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"endOfLine"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"lf"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-6">2. 样式规范（视觉统一层）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// stylelint.config.js</span>
<span class="hljs-keyword">module</span>.<span class="hljs-keyword">exports</span> = {
  extends: [
    <span class="hljs-string">'stylelint-config-standard'</span>,
    <span class="hljs-string">'stylelint-config-recess-order'</span>,
    <span class="hljs-string">'stylelint-config-prettier'</span>
  ],
  rules: {
    <span class="hljs-string">'selector-class-pattern'</span>: <span class="hljs-string">'^[a-z][a-zA-Z0-9]*$'</span>,
    <span class="hljs-string">'no-descending-specificity'</span>: <span class="hljs-literal">null</span>,
    <span class="hljs-string">'declaration-block-trailing-semicolon'</span>: <span class="hljs-string">'always'</span>
  }
};
</code></pre>
<h3 data-id="heading-7">3. 项目结构规范（组织架构层）</h3>
<pre><code class="hljs language-bash" lang="bash">src/
├── components/          <span class="hljs-comment"># 公共组件</span>
│   ├── common/         <span class="hljs-comment"># 通用基础组件</span>
│   └── business/       <span class="hljs-comment"># 业务组件</span>
├── pages/              <span class="hljs-comment"># 页面组件</span>
├── hooks/              <span class="hljs-comment"># 自定义 Hooks</span>
├── utils/              <span class="hljs-comment"># 工具函数</span>
├── services/           <span class="hljs-comment"># API 服务</span>
├── store/              <span class="hljs-comment"># 状态管理</span>
├── styles/             <span class="hljs-comment"># 全局样式</span>
├── types/              <span class="hljs-comment"># 类型定义</span>
└── assets/             <span class="hljs-comment"># 静态资源</span>
</code></pre>
<h2 data-id="heading-8">三、规范实施技术方案</h2>
<h3 data-id="heading-9">1. Git Hooks 自动化守护</h3>
<h4 data-id="heading-10">依赖安装</h4>
<pre><code class="hljs language-css" lang="css">npm install husky lint-staged <span class="hljs-attr">--save-dev</span>
</code></pre>
<h4 data-id="heading-11">package.json 配置</h4>
<pre><code class="hljs language-sql" lang="sql">{
  "scripts": {
    "prepare": "husky install",
    "lint": "eslint . --ext .js,.jsx,.ts,.tsx",
    "lint:fix": "eslint . --ext .js,.jsx,.ts,.tsx --fix",
    "format": "prettier --write \"src<span class="hljs-comment">/**/</span><span class="hljs-operator">*</span>.{js,jsx,ts,tsx,json,css,scss,md}\"",
    "type-check": "tsc --noEmit"
  },
  "lint-staged": {
    "*.{js,jsx,ts,tsx}": [
      "eslint --fix",
      "prettier --write",
      "git add"
    ],
    "*.{json,css,scss,md}": [
      "prettier --write",
      "git add"
    ]
  }
}
</code></pre>
<h4 data-id="heading-12">Commit Message 规范</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// commitlint.config.js</span>
<span class="hljs-keyword">module</span>.<span class="hljs-keyword">exports</span> = {
  extends: [<span class="hljs-string">'@commitlint/config-conventional'</span>],
  rules: {
    <span class="hljs-string">'type-enum'</span>: [
      <span class="hljs-number">2</span>,
      <span class="hljs-string">'always'</span>,
      [<span class="hljs-string">'feat'</span>, <span class="hljs-string">'fix'</span>, <span class="hljs-string">'docs'</span>, <span class="hljs-string">'style'</span>, <span class="hljs-string">'refactor'</span>, <span class="hljs-string">'perf'</span>, <span class="hljs-string">'test'</span>, <span class="hljs-string">'chore'</span>, <span class="hljs-string">'revert'</span>]
    ],
    <span class="hljs-string">'subject-case'</span>: [<span class="hljs-number">2</span>, <span class="hljs-string">'always'</span>, <span class="hljs-string">'sentence-case'</span>]
  }
};
</code></pre>
<h3 data-id="heading-13">2. 编辑器统一配置</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># .editorconfig</span>
<span class="hljs-attr">root</span> = <span class="hljs-literal">true</span>

<span class="hljs-section">[*]</span>
<span class="hljs-attr">charset</span> = utf-<span class="hljs-number">8</span>
<span class="hljs-attr">indent_style</span> = space
<span class="hljs-attr">indent_size</span> = <span class="hljs-number">2</span>
<span class="hljs-attr">end_of_line</span> = lf
<span class="hljs-attr">insert_final_newline</span> = <span class="hljs-literal">true</span>
<span class="hljs-attr">trim_trailing_whitespace</span> = <span class="hljs-literal">true</span>

<span class="hljs-section">[*.md]</span>
<span class="hljs-attr">trim_trailing_whitespace</span> = <span class="hljs-literal">false</span>
</code></pre>
<h2 data-id="heading-14">四、团队协作与规范落地策略</h2>
<h3 data-id="heading-15">1. 规范文档化体系</h3>
<p>创建 <code>CODEGUIDE.md</code> 文档，包含：</p>
<h4 data-id="heading-16">📋 核心原则</h4>
<ul>
<li>
<p><strong>一致性</strong>：团队代码风格统一</p>
</li>
<li>
<p><strong>可读性</strong>：代码清晰易懂</p>
</li>
<li>
<p><strong>可维护性</strong>：便于后续修改扩展</p>
</li>
<li>
<p><strong>安全性</strong>：避免常见安全问题</p>
</li>
</ul>
<h4 data-id="heading-17">💻 代码风格规范</h4>
<p><strong>JavaScript/TypeScript</strong></p>
<ul>
<li>
<p>缩进：2个空格</p>
</li>
<li>
<p>引号：优先单引号</p>
</li>
<li>
<p>分号：语句结尾必须</p>
</li>
<li>
<p>命名：</p>
<ul>
<li>
<p>变量/函数：camelCase</p>
</li>
<li>
<p>常量：UPPER_SNAKE_CASE</p>
</li>
<li>
<p>组件：PascalCase</p>
</li>
</ul>
</li>
</ul>
<p><strong>React 组件规范</strong></p>
<ul>
<li>
<p>文件组织：一个组件一个文件</p>
</li>
<li>
<p>Props 命名：语义化，避免缩写</p>
</li>
<li>
<p>State 管理：合理使用 useState/useReducer</p>
</li>
<li>
<p>副作用：使用 useEffect 管理</p>
</li>
</ul>
<h4 data-id="heading-18">📦 项目结构标准</h4>
<pre><code class="hljs language-bash" lang="bash">src/
├── components/ <span class="hljs-comment"># 组件目录</span>
├── pages/      <span class="hljs-comment"># 页面目录  </span>
├── hooks/      <span class="hljs-comment"># 自定义 Hooks</span>
├── utils/      <span class="hljs-comment"># 工具函数</span>
└── ...
</code></pre>
<h4 data-id="heading-19">🤝 Git 提交规范</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>(<span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>): <span class="hljs-tag">&lt;<span class="hljs-name">subject</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">footer</span>&gt;</span>
</code></pre>
<p><strong>提交类型说明：</strong></p>
<ul>
<li>
<p><code>feat</code>: 新功能</p>
</li>
<li>
<p><code>fix</code>: 修复bug</p>
</li>
<li>
<p><code>docs</code>: 文档更新</p>
</li>
<li>
<p><code>style</code>: 代码格式调整</p>
</li>
<li>
<p><code>refactor</code>: 代码重构</p>
</li>
<li>
<p><code>perf</code>: 性能优化</p>
</li>
<li>
<p><code>test</code>: 测试相关</p>
</li>
<li>
<p><code>chore</code>: 构建工具变动</p>
</li>
</ul>
<h3 data-id="heading-20">2. 新成员入职引导</h3>
<h4 data-id="heading-21">环境配置清单</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 1. 基础环境</span>
- <span class="hljs-section">[ ]</span> Node.js (指定版本)
- <span class="hljs-section">[ ]</span> 包管理器 (npm/yarn/pnpm)

<span class="hljs-comment"># 2. 项目初始化  </span>
- <span class="hljs-section">[ ]</span> git clone &lt;项目地址&gt;
- <span class="hljs-section">[ ]</span> cd &lt;项目目录&gt;
- <span class="hljs-section">[ ]</span> npm install

<span class="hljs-comment"># 3. 开发环境设置</span>
- <span class="hljs-section">[ ]</span> npm run setup
- <span class="hljs-section">[ ]</span> 配置 IDE 插件
</code></pre>
<h4 data-id="heading-22">规范培训重点</h4>
<ul>
<li>
<p>代码提交流程</p>
</li>
<li>
<p>代码审查标准</p>
</li>
<li>
<p>例外处理机制</p>
</li>
</ul>
<h2 data-id="heading-23">五、面试回答策略</h2>
<h3 data-id="heading-24">问题1：如何设计前端代码规范？</h3>
<p><strong>专业回答：</strong></p>
<blockquote>
<p>"我设计前端代码规范时采用分层架构思维，从技术实现到团队文化全方位考虑：</p>
</blockquote>
<p><strong>第一层：基础代码规范</strong></p>
<ul>
<li>
<p>代码风格：ESLint + Prettier 统一格式</p>
</li>
<li>
<p>最佳实践：组件设计原则、状态管理规范</p>
</li>
<li>
<p>质量保障：TypeScript 类型检查、单元测试</p>
</li>
</ul>
<p><strong>第二层：工具链配置</strong></p>
<ul>
<li>
<p>静态分析：ESLint 检查代码质量</p>
</li>
<li>
<p>格式化：Prettier 自动格式化</p>
</li>
<li>
<p>提交规范：Commitlint 强制规范提交</p>
</li>
</ul>
<p><strong>第三层：执行机制</strong></p>
<ul>
<li>
<p>Git Hooks：Husky + lint-staged 自动化检查</p>
</li>
<li>
<p>CI/CD 集成：流水线代码质量门禁</p>
</li>
<li>
<p>文档化：详细的指南和示例代码</p>
</li>
</ul>
<p><strong>设计原则：</strong></p>
<ul>
<li>
<p>渐进式：新项目严格，老项目逐步引入</p>
</li>
<li>
<p>自动化：工具自动检查和修复</p>
</li>
<li>
<p>可配置：合理的例外处理机制</p>
</li>
<li>
<p>团队参与：共同制定提高接受度"</p>
</li>
</ul>
<h3 data-id="heading-25">问题2：如何确保团队成员遵守代码规范？</h3>
<p><strong>专业回答：</strong></p>
<blockquote>
<p>"确保规范执行需要技术手段和管理策略结合：</p>
</blockquote>
<p><strong>技术层 - 自动化强制</strong></p>
<ul>
<li>
<p>Git Hooks 守护：pre-commit 自动修复，pre-push 全量检查</p>
</li>
<li>
<p>提交信息规范：commitlint 确保符合约定式提交</p>
</li>
<li>
<p>IDE 实时提示：开发时实时发现问题</p>
</li>
</ul>
<p><strong>流程层 - 制度保障</strong></p>
<ul>
<li>
<p>代码审查：规范遵守作为 PR 必要审查项</p>
</li>
<li>
<p>CI/CD 检查：流水线设置质量门禁</p>
</li>
</ul>
<p><strong>管理层 - 文化建设</strong></p>
<ul>
<li>
<p>新人引导：专门的规范培训</p>
</li>
<li>
<p>定期回顾：讨论执行情况和改进建议</p>
</li>
<li>
<p>规范进化：根据反馈适时调整</p>
</li>
</ul>
<p><strong>关键技术实现：</strong></p>
<p>json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"*.{js,jsx,ts,tsx}"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-string">"eslint --fix"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-string">"prettier --write"</span><span class="hljs-punctuation">,</span> 
    <span class="hljs-string">"git add"</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>通过这种多层次体系，既保证规范执行，又不影响开发效率，最终形成团队自发的规范意识。"</p>
<h3 data-id="heading-26">问题3：遇到团队成员不遵守规范怎么办？</h3>
<p><strong>应对策略：</strong></p>
<blockquote>
<p>"面对这种情况，我采取循序渐进的策略：</p>
</blockquote>
<p><strong>1. 理解原因</strong></p>
<ul>
<li>
<p>私下了解具体原因</p>
</li>
<li>
<p>区分是工具使用问题还是规范理解问题</p>
</li>
</ul>
<p><strong>2. 技术辅助</strong></p>
<ul>
<li>
<p>提供详细工具使用指南</p>
</li>
<li>
<p>帮助配置开发环境</p>
</li>
<li>
<p>对复杂规范提供具体示例</p>
</li>
</ul>
<p><strong>3. 渐进式要求</strong></p>
<ul>
<li>
<p>历史代码：新修改部分遵守规范</p>
</li>
<li>
<p>特殊情况：Code Review 讨论后有条件豁免</p>
</li>
</ul>
<p><strong>4. 正向激励</strong></p>
<ul>
<li>
<p>代码审查中给予正面反馈</p>
</li>
<li>
<p>将规范遵守作为能力评估参考</p>
</li>
<li>
<p>分享规范带来的实际收益案例</p>
</li>
</ul>
<p><strong>5. 制度保障</strong></p>
<ul>
<li>
<p>通过代码审查流程强制要求</p>
</li>
<li>
<p>作为团队协作基本要求强调</p>
</li>
</ul>
<p><strong>关键点：</strong> 规范的目的是提高团队效率，不是惩罚。通过理解、引导、支持，帮助团队成员从被动遵守转变为主动认同。"</p>
<p>通过这套完整的代码规范体系，团队可以建立统一的开发标准，提升代码质量和协作效率，为项目的长期健康发展奠定坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vite 库模式输出 ESM 格式时的依赖处理方案]]></title>    <link>https://juejin.cn/post/7571594817224146995</link>    <guid>https://juejin.cn/post/7571594817224146995</guid>    <pubDate>2025-11-12T09:50:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571594817224146995" data-draft-id="7571594817224130611" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vite 库模式输出 ESM 格式时的依赖处理方案"/> <meta itemprop="keywords" content="前端,Vite"/> <meta itemprop="datePublished" content="2025-11-12T09:50:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户7405463994309"/> <meta itemprop="url" content="https://juejin.cn/user/2828394730381693"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vite 库模式输出 ESM 格式时的依赖处理方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2828394730381693/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户7405463994309
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T09:50:00.000Z" title="Wed Nov 12 2025 09:50:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🧩 环境信息</h2>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"vite"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"5.4.15"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"vue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"2.7.16"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-1">📖 背景说明</h2>
<p>当前项目是一个<strong>前端框架型宿主项目</strong>，主要负责：</p>
<ul>
<li>
<p>管理功能菜单与用户模块；</p>
</li>
<li>
<p>通过 <code>iframe</code> 嵌入多个<strong>子前端项目</strong>；</p>
</li>
<li>
<p>在“工作台”页面中动态加载来自其他前端项目的<strong>小组件（Widget）</strong>。</p>
</li>
</ul>
<p>为了便于这些小组件的动态加载与复用，我们使用了 <strong>Vite 的库模式（Library Mode）</strong> 来进行打包。</p>
<hr/>
<h2 data-id="heading-2">⚙️ 初始配置</h2>
<p>最早的 <code>widget.vite.config.js</code> 如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">return</span> {
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">lib</span>: {
      <span class="hljs-attr">entry</span>: {
        <span class="hljs-attr">customReport</span>: <span class="hljs-string">'widgets/custom_report/index.js'</span>
      },
      <span class="hljs-attr">fileName</span>: <span class="hljs-function">(<span class="hljs-params">_, entryName</span>) =&gt;</span> <span class="hljs-string">`<span class="hljs-subst">${entryName}</span>.js`</span>,
      <span class="hljs-attr">formats</span>: [<span class="hljs-string">'es'</span>]
    },
    <span class="hljs-attr">rollupOptions</span>: {
      <span class="hljs-attr">output</span>: {
        <span class="hljs-attr">chunkFileNames</span>: <span class="hljs-string">'js/[name]-[hash].js'</span>,
        <span class="hljs-attr">assetFileNames</span>: <span class="hljs-string">'[name].[ext]'</span>,
        <span class="hljs-attr">manualChunks</span>: <span class="hljs-function"><span class="hljs-params">id</span> =&gt;</span> {
          <span class="hljs-keyword">if</span> (id.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'node_modules'</span>)) {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> chunk <span class="hljs-keyword">of</span> chunks) {
              <span class="hljs-keyword">if</span> (id.<span class="hljs-title function_">includes</span>(<span class="hljs-string">`node_modules/<span class="hljs-subst">${chunk}</span>`</span>)) <span class="hljs-keyword">return</span> chunk
            }
          }
        }
      }
    }
  }
}
</code></pre>
<p>起初并没有将 <code>vue</code> 从打包中排除，因为<strong>看似一切正常</strong>，直到后来出现了严重问题👇</p>
<hr/>
<h2 data-id="heading-3">💥 问题分析：Vue 多实例导致渲染死循环</h2>
<p>在某个小组件中使用函数式组件渲染 <code>VNode</code> 数组时，页面发生<strong>死循环渲染</strong>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;VNode :data="bottomInst" /&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  components: {
    VNode: {
      functional: true,
      render: (h, ctx) =&gt;
        isFunction(ctx.props.data) ? ctx.props.data() : ctx.props.data
    }
  }
}
&lt;/script&gt;
</code></pre>
<ul>
<li>
<p>页面会不断触发 <code>render()</code>，导致浏览器卡死。</p>
</li>
<li>
<p>后续测试发现是因为<strong>宿主项目与子组件中使用的 Vue 实例不一致</strong>。</p>
</li>
</ul>
<p>换句话说，小组件自己又打包进了一份 <code>vue</code>，与宿主项目的 Vue 实例“冲突”了。</p>
<hr/>
<h2 data-id="heading-4">🧠 回到根源：Vue 外部化问题</h2>
<p>Vite 官方文档明确建议：</p>
<blockquote>
<p>当你的库要被宿主项目引用时，应使用 <code>build.lib</code> 并<strong>外部化处理依赖</strong>，例如 <code>vue</code> 或 <code>react</code>。</p>
</blockquote>
<p>官方示例：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">lib</span>: {
      <span class="hljs-attr">entry</span>: {
        <span class="hljs-string">'my-lib'</span>: <span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'lib/main.js'</span>),
        <span class="hljs-attr">secondary</span>: <span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'lib/secondary.js'</span>)
      },
      <span class="hljs-attr">name</span>: <span class="hljs-string">'MyLib'</span>
    },
    <span class="hljs-attr">rollupOptions</span>: {
      <span class="hljs-attr">external</span>: [<span class="hljs-string">'vue'</span>],
      <span class="hljs-attr">output</span>: {
        <span class="hljs-attr">globals</span>: {
          <span class="hljs-attr">vue</span>: <span class="hljs-string">'Vue'</span>
        }
      }
    }
  }
})
</code></pre>
<hr/>
<h2 data-id="heading-5">⚠️ 实际遇到的问题</h2>
<p>当配置为<strong>多入口</strong>时：</p>
<ul>
<li>
<p>默认打包格式会变为 <code>['es', 'cjs']</code>；</p>
</li>
<li>
<p>如果强制设置 <code>formats: ['umd']</code>，Rollup 会报错；</p>
</li>
<li>
<p>而在 <strong>ESM 模式下</strong>，<code>globals</code> 配置不会生效（即不会转成全局变量访问）。</p>
</li>
</ul>
<p>因此，当外部化 <code>vue</code> 后，代码仍然保留：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
</code></pre>
<p>浏览器在执行时会报错：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Uncaught</span> <span class="hljs-title class_">TypeError</span>: <span class="hljs-title class_">Failed</span> to resolve <span class="hljs-variable language_">module</span> specifier <span class="hljs-string">"vue"</span>.
</code></pre>
<p>因为浏览器根本不知道 <code>"vue"</code> 这个导入路径应该从哪里加载。</p>
<hr/>
<h2 data-id="heading-6">✅ 正确的解决方案</h2>
<h3 data-id="heading-7">方法一：使用 HTML Import Map（推荐，前提是宿主环境支持）</h3>
<p>如果不需要兼容 Chrome 89 以下版本，可以在宿主项目的 HTML 中声明：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"importmap"</span>&gt;</span><span class="javascript">
{
  <span class="hljs-string">"imports"</span>: {
    <span class="hljs-string">"vue"</span>: <span class="hljs-string">"https://example.com/vue.js"</span>
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>这样浏览器在解析到：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
</code></pre>
<p>时，会自动从 <code>/vue.js</code> 加载，而不是去找 <code>node_modules</code>。</p>
<p>✅ 优点：</p>
<ul>
<li>
<p>符合原生 ES Module 机制；</p>
</li>
<li>
<p>适合现代浏览器；</p>
</li>
<li>
<p>简洁直观。</p>
</li>
</ul>
<p>❌ 缺点：</p>
<ul>
<li>
<p>Chrome 89 以下（含 IE）不支持 <code>importmap</code>；</p>
</li>
<li>
<p>需要在宿主 HTML 中维护映射。</p>
</li>
</ul>
<hr/>
<h3 data-id="heading-8">方法二：使用 Rollup 的 <code>output.paths</code> 配置</h3>
<p>如果你希望在构建阶段就将路径转换成一个可访问的 URL，可使用：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">return</span> {
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">lib</span>: {
      <span class="hljs-attr">entry</span>: {
        <span class="hljs-attr">customReport</span>: <span class="hljs-string">'widgets/custom_report/index.js'</span>
      },
      <span class="hljs-attr">fileName</span>: <span class="hljs-function">(<span class="hljs-params">_, entryName</span>) =&gt;</span> <span class="hljs-string">`<span class="hljs-subst">${entryName}</span>.js`</span>,
      <span class="hljs-attr">formats</span>: [<span class="hljs-string">'es'</span>]
    },
    <span class="hljs-attr">rollupOptions</span>: {
      <span class="hljs-attr">external</span>: [<span class="hljs-string">'vue'</span>],
      <span class="hljs-attr">output</span>: {
        <span class="hljs-attr">paths</span>: {
          <span class="hljs-attr">vue</span>: <span class="hljs-string">'/dist/assets/vue.js'</span>
        }
      }
    }
  }
}
</code></pre>
<p>打包后：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// ✅ 自动替换成可访问路径</span>
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'/dist/assets/vue.js'</span>
</code></pre>
<p>宿主项目只需确保 <code>/dist/assets/vue.js</code> 存在（即宿主与子项目共享同一份 Vue 文件）。</p>
<p>✅ 优点：</p>
<ul>
<li>
<p>不依赖 importmap；</p>
</li>
<li>
<p>可控制精确路径；</p>
</li>
<li>
<p>浏览器 100% 可识别。</p>
</li>
</ul>
<p>❌ 缺点：</p>
<ul>
<li>
<p>宿主项目需要在相同路径下提供该文件；</p>
</li>
<li>
<p>一旦路径变更，需要同步更新。</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-9">🧾 总结对比</h2>


























<table><thead><tr><th>方案</th><th>关键配置</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>方法一</strong> ImportMap</td><td><code>&lt;script type="importmap"&gt;</code></td><td>原生 ESM 支持、配置简单</td><td>浏览器兼容性要求高</td><td>现代浏览器环境</td></tr><tr><td><strong>方法二</strong> Rollup paths</td><td><code>rollupOptions.output.paths</code></td><td>无需 importmap，构建期解决</td><td>路径需宿主一致</td><td>自定义部署结构、多版本环境</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-10">🚀 实践建议</h2>
<ol>
<li>
<p><strong>统一宿主与子项目的 Vue 实例来源</strong>。<br/>
→ 不要在子组件中重复打包 <code>vue</code>。</p>
</li>
<li>
<p><strong>打包时外部化 Vue</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">external</span>: [<span class="hljs-string">'vue'</span>]
</code></pre>
</li>
<li>
<p><strong>根据浏览器兼容性选择方案</strong>：</p>
<ul>
<li>
<p>支持现代浏览器 → ✅ ImportMap；</p>
</li>
<li>
<p>需要兼容旧环境 → ✅ Rollup <code>paths</code>。</p>
</li>
</ul>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 vLLM 原生部署 PaddleOCR-VL：高性能、OpenAI 兼容的多模态 OCR 服务]]></title>    <link>https://juejin.cn/post/7571650164843331618</link>    <guid>https://juejin.cn/post/7571650164843331618</guid>    <pubDate>2025-11-12T09:28:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571650164843331618" data-draft-id="7571650164843282466" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 vLLM 原生部署 PaddleOCR-VL：高性能、OpenAI 兼容的多模态 OCR 服务 "/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-12T09:28:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="上官胡闹"/> <meta itemprop="url" content="https://juejin.cn/user/641770523725374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 vLLM 原生部署 PaddleOCR-VL：高性能、OpenAI 兼容的多模态 OCR 服务 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/641770523725374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    上官胡闹
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T09:28:53.000Z" title="Wed Nov 12 2025 09:28:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">序言</h2>
<p>笔者此前曾撰写过一篇关于使用 Paddle 官方提供的 <code>paddlex-genai-vllm-server</code> 部署 <code>PaddleOCR-VL</code> 模型的文章，其中简要介绍了该模型的特性，并对比了其与 <code>DeepSeek-OCR</code> 的差异。</p>
<p>近期，笔者持续关注 vLLM 官方社区对 <code>PaddleOCR-VL</code> 的支持进展——社区已于 2025 年 10 月 30 日正式合并了对该模型的支持 PR。</p>
<p>因此，本文将介绍如何基于 <strong>vLLM 官方版本</strong>直接部署 <code>PaddleOCR-VL</code> 模型。</p>
<blockquote>
<p>💡 当前 vLLM 的代码同样支持 <code>DeepSeek-OCR</code>，用户可根据需求灵活选择。</p>
</blockquote>
<h2 data-id="heading-1">介绍</h2>
<p><code>PaddleOCR-VL</code> 是一个专为文档解析设计的<strong>最先进（SOTA）且资源高效</strong>的多模态模型。
其核心组件是 <code>PaddleOCR-VL-0.9B</code> —— 一个紧凑而强大的视觉-语言模型（VLM），集成了基于 <strong>NaViT 风格的动态分辨率视觉编码器</strong> 与 <strong>ERNIE-4.5-0.3B 语言模型</strong>，从而实现对文档中文字、表格、公式等元素的高精度识别。</p>
<h2 data-id="heading-2">部署</h2>
<p>本文介绍两种部署方式：裸机部署与 Kubernetes（k8s）部署。</p>
<h3 data-id="heading-3">裸机部署</h3>
<pre><code class="hljs language-bash" lang="bash">uv venv
<span class="hljs-built_in">source</span> .venv/bin/activate

<span class="hljs-comment"># v0.11.1 尚未正式发布，需安装 nightly 版本</span>
uv pip install -U vllm \
    --pre \
    --extra-index-url https://wheels.vllm.ai/nightly \
    --extra-index-url https://download.pytorch.org/whl/cu129 \
    --index-strategy unsafe-best-match
</code></pre>
<blockquote>
<p>⚠️ 注意：截至本文撰写时，vLLM v0.11.1 尚未发布，因此必须使用 nightly 构建版本以获得 <code>PaddleOCR-VL</code> 支持。</p>
</blockquote>
<p>启动服务：</p>
<pre><code class="hljs language-bash" lang="bash">vllm serve PaddlePaddle/PaddleOCR-VL \
    --trust-remote-code \
    --max-num-batched-tokens 16384 \
    --no-enable-prefix-caching \
    --mm-processor-cache-gb 0
</code></pre>
<h4 data-id="heading-4">参数说明：</h4>
<ul>
<li><code>--trust-remote-code</code>：因模型包含自定义代码，需显式启用。</li>
<li><code>--no-enable-prefix-caching</code>：OCR 任务通常无重复前缀，关闭可节省显存。</li>
<li><code>--mm-processor-cache-gb 0</code>：禁用多模态处理器缓存，适用于单次推理场景；若需高频调用，可适当调高此值。</li>
</ul>
<h3 data-id="heading-5">Kubernetes（k8s）部署</h3>
<p>在生产环境中，大多数场景采用 Kubernetes 进行部署。以下是基于 k8s 的部署方案。</p>
<h4 data-id="heading-6">1. 构建镜像</h4>
<p>由于 v0.11.1 尚未正式发布，目前需通过源码构建镜像（也可关注官方 nightly 镜像）：</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/vllm-project/vllm.git
<span class="hljs-built_in">cd</span> vllm
docker build -t vllm:latest-test -f docker/Dockerfile .
</code></pre>
<blockquote>
<p>📌 待 v0.11.1 正式发布后，可直接使用官方 PyPI 或 Docker Hub 镜像，无需手动构建。</p>
</blockquote>
<h4 data-id="heading-7">2. 创建 Deployment</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">paddleocr-vl</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">paddleocr-vl</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">paddleocr-vl</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">paddleocr-vl</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">paddleocr-vl</span>
          <span class="hljs-attr">image:</span> <span class="hljs-string">vllm:latest-test</span>
          <span class="hljs-attr">command:</span> [<span class="hljs-string">"vllm"</span>]
          <span class="hljs-attr">args:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">"serve"</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">"/models/PaddleOCR-VL"</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">"--served-model-name=PaddleOCR-VL"</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">"--host=0.0.0.0"</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">"--port=8000"</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">"--trust-remote-code"</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">"--revision=v1"</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">"--max-num-batched-tokens=16384"</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">"--no-enable-prefix-caching"</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">"--mm-processor-cache-gb=0"</span>
          <span class="hljs-attr">ports:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8000</span>
              <span class="hljs-attr">name:</span> <span class="hljs-string">http</span>
              <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
          <span class="hljs-attr">resources:</span>
            <span class="hljs-attr">limits:</span>
              <span class="hljs-attr">nvidia.com/gpu:</span> <span class="hljs-number">1</span>
              <span class="hljs-attr">memory:</span> <span class="hljs-string">"16Gi"</span>
              <span class="hljs-attr">cpu:</span> <span class="hljs-string">"4"</span>
            <span class="hljs-attr">requests:</span>
              <span class="hljs-attr">memory:</span> <span class="hljs-string">"12Gi"</span>
              <span class="hljs-attr">cpu:</span> <span class="hljs-string">"2"</span>
              <span class="hljs-attr">nvidia.com/gpu:</span> <span class="hljs-number">1</span>
          <span class="hljs-attr">readinessProbe:</span>
            <span class="hljs-attr">tcpSocket:</span>
              <span class="hljs-attr">port:</span> <span class="hljs-number">8000</span>
            <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">60</span>
            <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>
            <span class="hljs-attr">failureThreshold:</span> <span class="hljs-number">5</span>
          <span class="hljs-attr">volumeMounts:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">shm</span>
              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/dev/shm</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">model-storage</span>
              <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/models/PaddleOCR-VL</span>
      <span class="hljs-attr">volumes:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">shm</span>
          <span class="hljs-attr">emptyDir:</span>
            <span class="hljs-attr">medium:</span> <span class="hljs-string">Memory</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">model-storage</span>
          <span class="hljs-attr">hostPath:</span>
            <span class="hljs-attr">path:</span> <span class="hljs-string">/mnt/data/paddleocr-vl/models</span>
            <span class="hljs-attr">type:</span> <span class="hljs-string">Directory</span>
</code></pre>
<h4 data-id="heading-8">配置说明：</h4>
<ul>
<li><code>/models/PaddleOCR-VL</code>：模型本地挂载路径，请根据实际环境调整。</li>
<li><code>--no-enable-prefix-caching</code>：OCR 场景通常不需要前缀缓存，关闭可减少内存开销。</li>
<li><code>--mm-processor-cache-gb</code>：控制多模态预处理缓存大小，设为 <code>0</code> 表示禁用。</li>
</ul>
<blockquote>
<p>🔔 建议在 GPU 节点上部署，并确保已安装 NVIDIA Device Plugin。</p>
</blockquote>
<h2 data-id="heading-9">测试</h2>
<p>测试用例参考自 vLLM 官方社区文档，代码如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> openai <span class="hljs-keyword">import</span> OpenAI

client = OpenAI(
    api_key=<span class="hljs-string">"EMPTY"</span>,
    base_url=<span class="hljs-string">"http://localhost:8000/v1"</span>,
    timeout=<span class="hljs-number">3600</span>
)

<span class="hljs-comment"># 任务类型提示词</span>
TASKS = {
    <span class="hljs-string">"ocr"</span>: <span class="hljs-string">"OCR:"</span>,
    <span class="hljs-string">"table"</span>: <span class="hljs-string">"Table Recognition:"</span>,
    <span class="hljs-string">"formula"</span>: <span class="hljs-string">"Formula Recognition:"</span>,
    <span class="hljs-string">"chart"</span>: <span class="hljs-string">"Chart Recognition:"</span>,
}

messages = [
    {
        <span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>,
        <span class="hljs-string">"content"</span>: [
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"image_url"</span>,
                <span class="hljs-string">"image_url"</span>: {
                    <span class="hljs-string">"url"</span>: <span class="hljs-string">"https://ofasys-multimodal-wlcb-3-toshanghai.oss-accelerate.aliyuncs.com/wpf272043/keepme/image/receipt.png"</span>
                }
            },
            {
                <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>,
                <span class="hljs-string">"text"</span>: TASKS[<span class="hljs-string">"ocr"</span>]
            }
        ]
    }
]

response = client.chat.completions.create(
    model=<span class="hljs-string">"PaddlePaddle/PaddleOCR-VL"</span>,
    messages=messages,
    temperature=<span class="hljs-number">0.0</span>,
)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"识别结果: <span class="hljs-subst">{response.choices[<span class="hljs-number">0</span>].message.content}</span>"</span>)
</code></pre>
<blockquote>
<p>✅ 该接口完全兼容 OpenAI 格式，可无缝集成到现有 AI 应用栈中。</p>
</blockquote>
<h2 data-id="heading-10">总结</h2>
<p>通过原生 vLLM 部署 <code>PaddleOCR-VL</code> 模型，具备以下显著优势：</p>
<ul>
<li>✅ <strong>OpenAI API 兼容</strong>：自动提供 <code>/v1/chat/completions</code> 接口，可直接接入企业现有的 AI 网关（如 Kong、Traefik、自研网关等）。</li>
<li>✅ <strong>高性能推理</strong>：依托 vLLM 的 PagedAttention、连续批处理（continuous batching）等优化技术，实现<strong>高吞吐、低延迟</strong>的 OCR 服务。</li>
<li>✅ <strong>灵活部署</strong>：支持裸机、Docker、Kubernetes 等多种部署形态，适配开发、测试与生产全链路。</li>
<li>✅ <strong>社区驱动</strong>：作为 vLLM 官方支持的模型，未来将持续获得性能优化与新功能更新。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hilt 和依赖注入]]></title>    <link>https://juejin.cn/post/7571636682695114792</link>    <guid>https://juejin.cn/post/7571636682695114792</guid>    <pubDate>2025-11-12T10:03:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571636682695114792" data-draft-id="7570793903847915535" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hilt 和依赖注入"/> <meta itemprop="keywords" content="Android,Android Jetpack"/> <meta itemprop="datePublished" content="2025-11-12T10:03:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨白"/> <meta itemprop="url" content="https://juejin.cn/user/2549135752044601"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hilt 和依赖注入
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2549135752044601/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨白
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T10:03:40.000Z" title="Wed Nov 12 2025 10:03:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么需要依赖注入？</h2>
<p>依赖注入（Dependency Injection，简称 DI）是一种设计模式，我们为什么需要它呢？</p>
<p>为了实现类之间的<strong>解耦</strong>，以及依赖关系的管理。</p>
<h3 data-id="heading-1">高耦合</h3>
<p>我们来看一个人和咖啡机的例子：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 只能做美式咖啡的咖啡机</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">SpecificCoffeeMachine</span> {

    <span class="hljs-keyword">init</span> {
        println(<span class="hljs-string">"(An expensive SpecificCoffeeMachine was built...)"</span>)
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeAmericano</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Making... Americano"</span>) <span class="hljs-comment">// ☕️</span>
    }
}

<span class="hljs-comment">// 人</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {

    <span class="hljs-comment">// 硬编码了咖啡机的创建</span>
    <span class="hljs-comment">// Person 和 SpecificCoffeeMachine 被耦合在了一起</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> myCoffeeMachine: SpecificCoffeeMachine = SpecificCoffeeMachine()

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startMorning</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Good morning, I need coffee..."</span>)
        myCoffeeMachine.makeAmericano()
        println(<span class="hljs-string">"The coffee is finished and work is done."</span>)
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> bob = Person()
    bob.startMorning()
}
</code></pre>
<p>看似没什么问题，但如果有一天，Bob 想喝拿铁了，我们只能修改 <code>Person</code> 类的代码，去<strong>强行修改它的内部结构</strong>。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 只能做拿铁的咖啡机</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LatteMachine</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeLatte</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Making... Latte"</span>) <span class="hljs-comment">// 🥛☕️</span>
    }
}

<span class="hljs-comment">// 人</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> myCoffeeMachine: LatteMachine = LatteMachine()

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startMorning</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Good morning, I need coffee..."</span>)
        myCoffeeMachine.makeLatte() <span class="hljs-comment">// 甚至调用的方法名也需要修改</span>
        println(<span class="hljs-string">"The coffee is finished and work is done."</span>)
    }
}
</code></pre>
<p>如果有 100 个类使用了 <code>SpecificCoffeeMachine</code>，我们就得去修改 100 个类。</p>
<p>并且无法对 <code>Person</code> 的 <code>startMorning()</code> 进行单元测试。</p>
<p>在创建 <code>Person</code> 对象时，其内部一定会创建一个 <code>SpecificCoffeeMachine</code> 实例，如果 <code>SpecificCoffeeMachine</code> 在创建时存在复杂操作，单元测试就会变慢。测试失败时不清楚是谁的原因，不清楚 <code>startMorning()</code> 内部是否真的调用了 <code>makeAmericano()</code>，单元测试变得无法验证。</p>
<h3 data-id="heading-2">低耦合</h3>
<p>我们使用依赖注入来解耦，现在 <code>Person</code> 不主动创建咖啡机，而是由外部创建。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">CoffeeMaker</span> {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeCoffee</span><span class="hljs-params">()</span></span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AmericanoMachine</span> : <span class="hljs-type">CoffeeMaker</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeCoffee</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Making... Americano"</span>) <span class="hljs-comment">// ☕️</span>
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">LatteMachine</span> : <span class="hljs-type">CoffeeMaker</span> {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeCoffee</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Making... Latte"</span>) <span class="hljs-comment">// 🥛☕️</span>
    }
}


<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>(
    <span class="hljs-comment">// 咖啡制造机由外部注入</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> coffeeMaker: CoffeeMaker
) {

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startMorning</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Good morning, I need coffee..."</span>)
        coffeeMaker.makeCoffee()
        println(<span class="hljs-string">"The coffee is finished and work is done."</span>)
    }
}


<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// Bob 想喝美式了</span>
    <span class="hljs-keyword">val</span> americanoDay = Person(AmericanoMachine())
    americanoDay.startMorning()

    println(<span class="hljs-string">"--- Day 2 ---"</span>)

    <span class="hljs-comment">// Bob 想喝拿铁了</span>
    <span class="hljs-keyword">val</span> latteDay = Person(LatteMachine())
    latteDay.startMorning()
}
</code></pre>
<p>此时 <code>Person</code> 就变得很灵活了，当需要不同的咖啡机时，无需修改 <code>Person</code> 类的代码。</p>
<p>并且很容易进行测试：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ExampleUnitTest</span> {

    <span class="hljs-keyword">class</span> <span class="hljs-title class_">FakeTestMachine</span> : <span class="hljs-type">CoffeeMaker</span> {
        <span class="hljs-keyword">var</span> coffeeWasMade = <span class="hljs-literal">false</span>
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeCoffee</span><span class="hljs-params">()</span></span> {
            println(<span class="hljs-string">"(Test: Pretend to be making coffee)"</span>)
            coffeeWasMade = <span class="hljs-literal">true</span>
        }
    }

    <span class="hljs-meta">@Test</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">person_startMorning</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">val</span> testMachine = FakeTestMachine()
        <span class="hljs-keyword">val</span> testPerson = Person(testMachine)
        testPerson.startMorning()

        assertTrue(testMachine.coffeeWasMade)
        println(<span class="hljs-string">"Test passed!"</span>)
    }
}
</code></pre>
<h2 data-id="heading-3">Hilt 依赖注入框架</h2>
<p>Hilt 是一个依赖注入框架，我想大家对于它已不再陌生。</p>
<h3 data-id="heading-4">添加依赖和启用 Hilt</h3>
<p>首先，在项目配置文件中添加 Hilt 和 KSP 插件。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Top-level build file where you can add configuration options common to all sub-projects/modules.</span>
plugins {
    ...

    id(<span class="hljs-string">"com.google.dagger.hilt.android"</span>) version <span class="hljs-string">"2.57.1"</span> apply <span class="hljs-literal">false</span>
    id(<span class="hljs-string">"com.google.devtools.ksp"</span>) version <span class="hljs-string">"2.0.21-1.0.27"</span> apply <span class="hljs-literal">false</span> 
}
</code></pre>
<blockquote>
<p>注意：KSP 的版本需要和当前的 Kotlin 版本（<code>2.0.21</code>）保持一致：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgoogle%2Fksp%2Freleases" target="_blank" title="https://github.com/google/ksp/releases" ref="nofollow noopener noreferrer">KSP 所有版本</a>。</p>
</blockquote>
<p>然后，在应用配置文件中添加以下依赖项：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">plugins {
    id(<span class="hljs-string">"com.google.devtools.ksp"</span>)
    id(<span class="hljs-string">"com.google.dagger.hilt.android"</span>)
}

dependencies {
    implementation(<span class="hljs-string">"com.google.dagger:hilt-android:2.57.1"</span>)
    ksp(<span class="hljs-string">"com.google.dagger:hilt-android-compiler:2.57.1"</span>)
}
</code></pre>
<p>最后，在 <code>Application</code> 类上添加 <code>@HiltAndroidApp</code> 注解，以启用 Hilt 的功能。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@HiltAndroidApp</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApplication</span> : <span class="hljs-type">Application</span>()
</code></pre>
<p>别忘了将这个 <code>Application</code> 注册到清单文件中：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">application</span>
    <span class="hljs-attr">android:name</span>=<span class="hljs-string">".MyApplication"</span>&gt;</span>
</code></pre>
<h3 data-id="heading-5">简单用法</h3>
<p>Hilt 的注入功能（提供依赖项），支持以下 Android 类：</p>
<ul>
<li><code>Application</code>（通过 <code>@HiltAndroidApp</code>）</li>
<li><code>ViewModel</code>（通过 <code>@HiltViewModel</code>）</li>
<li><code>Activity</code></li>
<li><code>Fragment</code></li>
<li><code>View</code></li>
<li><code>Service</code></li>
<li><code>BroadcastReceiver</code></li>
</ul>
<p>除了 <code>Application</code> 和 <code>ViewModel</code> 外，其他的类都是通过 <code>@AndroidEntryPoint</code> 注解来声明的。</p>
<p>以 <code>Activity</code> 为例，我们来简单使用一下：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@AndroidEntryPoint</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">ComponentActivity</span>() {

    <span class="hljs-comment">// 拿铁制造机由 Hilt 注入</span>
    <span class="hljs-meta">@Inject</span>
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> latteMachine: LatteMachine

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContent {}

        latteMachine.makeCoffee()
    }

}
</code></pre>
<blockquote>
<p>注意：使用 <code>@Inject</code> 进行字段注入，被注入的字段不能是 <code>private</code> 的。而通过构造函数注入的参数，则可以是 <code>private</code> 的。</p>
</blockquote>
<p>在 <code>LatteMachine</code> 类的无参构造函数上添加 <code>@Inject</code>，让 Hilt 知道拿铁机的“制造”方法。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LatteMachine</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>() : CoffeeMaker {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeCoffee</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Making... Latte"</span>) <span class="hljs-comment">// 🥛☕️   </span>
    }
}
</code></pre>
<p>运行程序，结果如下：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">Making</span>... <span class="hljs-selector-tag">Latte</span>
</code></pre>
<p>咖啡机确实制作了一杯拿铁。</p>
<h3 data-id="heading-6">带参的依赖注入</h3>
<p>我们再来看看带参数的构造函数的注入，给 <code>LatteMachine</code> 的构造函数添加一个牛奶起泡器的参数：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LatteMachine</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> milkFrother: MilkFrother
) : CoffeeMaker {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeCoffee</span><span class="hljs-params">()</span></span> {
        milkFrother.frothMilk()
        println(<span class="hljs-string">"Making... Latte"</span>) <span class="hljs-comment">// 🥛☕️</span>
    }
}
</code></pre>
<p>对于参数 <code>milkFrother</code>，Hilt 会自动寻找并尝试注入它。</p>
<p>我们只需让 Hilt 知道牛奶起泡器的“制造”方法即可，和之前一样：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 添加 <span class="hljs-doctag">@Inject</span> constructor，让 Hilt 知道如何创建它
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MilkFrother</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">frothMilk</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"(The milk is frothing...)"</span>)
    }
}
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-less" lang="less">(<span class="hljs-selector-tag">The</span> <span class="hljs-selector-tag">milk</span> <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">frothing</span>...)
<span class="hljs-selector-tag">Making</span>... <span class="hljs-selector-tag">Latte</span>
</code></pre>
<p>只有 <code>LatteMachine</code> 构造函数所依赖的参数都能被注入，<code>LatteMachine</code> 才能被注入。</p>
<h2 data-id="heading-7">复杂注入</h2>
<h3 data-id="heading-8">接口</h3>
<p>以之前的 <code>Person</code> 类为例，我们来完成 <code>CoffeeMaker</code> 接口的注入。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-comment">// 咖啡制造机由 Hilt 注入</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> coffeeMaker: CoffeeMaker
) {

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startMorning</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Good morning, I need coffee..."</span>)
        coffeeMaker.makeCoffee()
        println(<span class="hljs-string">"The coffee is finished and work is done."</span>)
    }
}
</code></pre>
<p>因为接口没有构造函数，所以 Hilt 并不知道如何创建该接口的实例。</p>
<p>这时，我们可以创建一个抽象类 <code>CoffeeMakerModule</code>，在其中提供该实例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@InstallIn(ActivityComponent::class)</span> <span class="hljs-comment">// 暂时先安装在 ActivityComponent</span>
<span class="hljs-meta">@Module</span> <span class="hljs-comment">// 表示这是一个用来提供依赖注入实例的模块</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CoffeeMakerModule</span> {

    <span class="hljs-meta">@Binds</span>
    <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bindCoffeeMaker</span><span class="hljs-params">(americanoMachine: <span class="hljs-type">AmericanoMachine</span>)</span></span>: CoffeeMaker <span class="hljs-comment">// 给 CoffeeMaker 接口提供实现，提供的实例为 americanoMachine 参数</span>

}
</code></pre>
<p>再告诉 Hilt 美式咖啡机的“制造”方法即可。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AmericanoMachine</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>() : CoffeeMaker {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeCoffee</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Making... Americano"</span>) <span class="hljs-comment">// ☕️</span>
    }
}
</code></pre>
<p>现在 <code>Person</code> 中的 <code>CoffeeMaker</code> 接口对象就能被注入了。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@AndroidEntryPoint</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">ComponentActivity</span>() {
    <span class="hljs-meta">@Inject</span>
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> person: Person

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContent {}

        person.startMorning()
    }
}
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">Good</span> <span class="hljs-selector-tag">morning</span>, <span class="hljs-selector-tag">I</span> <span class="hljs-selector-tag">need</span> <span class="hljs-selector-tag">coffee</span>...
<span class="hljs-selector-tag">Making</span>... <span class="hljs-selector-tag">Americano</span>
<span class="hljs-selector-tag">The</span> <span class="hljs-selector-tag">coffee</span> <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">finished</span> <span class="hljs-selector-tag">and</span> <span class="hljs-selector-tag">work</span> <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">done</span>.
</code></pre>
<p>如果现在需要两台咖啡机，一台美式咖啡机，一台拿铁咖啡机，该怎么办？</p>
<p>这时，我们可以使用 <code>@Qualifier</code> 注解，来给相同的类或接口注入不同的实例：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 定义两个注解</span>
<span class="hljs-meta">@Qualifier</span>
<span class="hljs-meta">@Retention(AnnotationRetention.BINARY)</span> <span class="hljs-comment">// 注解只能被编译器读取，不能被运行时反射读取</span>
<span class="hljs-keyword">annotation</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BindAmericanoMachine</span>

<span class="hljs-meta">@Qualifier</span>
<span class="hljs-meta">@Retention(AnnotationRetention.BINARY)</span>
<span class="hljs-keyword">annotation</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BindLatteMachine</span>


<span class="hljs-meta">@InstallIn(ActivityComponent::class)</span>
<span class="hljs-meta">@Module</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CoffeeMakerModule</span> {

    <span class="hljs-meta">@Binds</span>
    <span class="hljs-meta">@BindAmericanoMachine</span>
    <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bindCoffeeMaker</span><span class="hljs-params">(americanoMachine: <span class="hljs-type">AmericanoMachine</span>)</span></span>: CoffeeMaker

    <span class="hljs-meta">@Binds</span>
    <span class="hljs-meta">@BindLatteMachine</span>
    <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bindLatteMachine</span><span class="hljs-params">(latteMachine: <span class="hljs-type">LatteMachine</span>)</span></span>: CoffeeMaker

}
</code></pre>
<p>在用到的地方，通过这两个注解来声明当前注入的实例类型：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>() {

    <span class="hljs-meta">@BindAmericanoMachine</span>
    <span class="hljs-meta">@Inject</span>
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> americanoCM: CoffeeMaker

    <span class="hljs-meta">@BindLatteMachine</span>
    <span class="hljs-meta">@Inject</span>
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> latteCM: CoffeeMaker

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startMorning</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Good morning, I need americano and latte coffee..."</span>)
        americanoCM.makeCoffee()
        latteCM.makeCoffee()
        println(<span class="hljs-string">"The coffee is finished and work is done."</span>)
    }
}
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">Good</span> <span class="hljs-selector-tag">morning</span>, <span class="hljs-selector-tag">I</span> <span class="hljs-selector-tag">need</span> <span class="hljs-selector-tag">americano</span> <span class="hljs-selector-tag">and</span> <span class="hljs-selector-tag">latte</span> <span class="hljs-selector-tag">coffee</span>...
<span class="hljs-selector-tag">Making</span>... <span class="hljs-selector-tag">Americano</span>
(The milk is frothing...)
<span class="hljs-selector-tag">Making</span>... <span class="hljs-selector-tag">Latte</span>
<span class="hljs-selector-tag">The</span> <span class="hljs-selector-tag">coffee</span> <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">finished</span> <span class="hljs-selector-tag">and</span> <span class="hljs-selector-tag">work</span> <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">done</span>.
</code></pre>
<h3 data-id="heading-9">第三方库的类</h3>
<p>对于第三方库提供的类，我们无法修改其源码，自然不能在其构造函数上添加 <code>@Inject</code> 注解。</p>
<p>对于这种情况的注入，我们也要使用 <code>@Module</code> 注解。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Module</span>
<span class="hljs-meta">@InstallIn(ActivityComponent::class)</span> <span class="hljs-comment">// 暂时先安装在 ActivityComponent</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkModule</span> {

    <span class="hljs-meta">@Provides</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">provideOkHttpClient</span><span class="hljs-params">()</span></span>: OkHttpClient {
        <span class="hljs-keyword">return</span> OkHttpClient.Builder()
            .connectTimeout(<span class="hljs-number">20</span>, TimeUnit.SECONDS)
            .readTimeout(<span class="hljs-number">20</span>, TimeUnit.SECONDS)
            .writeTimeout(<span class="hljs-number">20</span>, TimeUnit.SECONDS)
            .build()
    }

}
</code></pre>
<blockquote>
<p>引入依赖：<code>implementation("com.squareup.okhttp3:okhttp:4.12.0")</code></p>
</blockquote>
<p>这里没有抽象函数，自然 <code>NetworkModule</code> 不是抽象类。</p>
<p>现在，我们就可以在任何地方注入这个 <code>OkHttpClient</code> 实例了，比如说：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@AndroidEntryPoint</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">ComponentActivity</span>() {
    <span class="hljs-meta">@Inject</span>
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> okHttpClient: OkHttpClient

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContent {}

        <span class="hljs-keyword">val</span> url = <span class="hljs-string">"https://juejin.cn/"</span>
        <span class="hljs-keyword">val</span> request = Request.Builder()
            .url(url)
            .build()
        <span class="hljs-keyword">val</span> call = okHttpClient.newCall(request)

        lifecycleScope.launch(Dispatchers.IO) {
            <span class="hljs-keyword">val</span> response = call.execute()
            println(response.body?.string())
        }
    }
}
</code></pre>
<p>如果遇到需要提供的实例，依赖于其他实例。这和【带参的依赖注入】是一样的，只需将所依赖的实例放到函数参数中，Hilt 会自动去寻找并注入。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Module</span>
<span class="hljs-meta">@InstallIn(ActivityComponent::class)</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkModule</span> {
    
    <span class="hljs-comment">// ...</span>

    <span class="hljs-meta">@Provides</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">provideRetrofit</span><span class="hljs-params">(okHttpClient: <span class="hljs-type">OkHttpClient</span>)</span></span>: Retrofit {
        <span class="hljs-keyword">return</span> Retrofit.Builder()
            .baseUrl(<span class="hljs-string">"https://juejin.cn/"</span>)
            .client(okHttpClient)
            .addConverterFactory(GsonConverterFactory.create())
            .build()
    }

    <span class="hljs-meta">@Provides</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">provideApiService</span><span class="hljs-params">(retrofit: <span class="hljs-type">Retrofit</span>)</span></span>: ApiService {
        <span class="hljs-keyword">return</span> retrofit.create(ApiService::<span class="hljs-keyword">class</span>.java)
    }

}
</code></pre>
<blockquote>
<p>添加依赖：<code>implementation("com.squareup.retrofit2:retrofit:2.9.0")</code>、<code>implementation("com.squareup.retrofit2:converter-gson:2.9.0")</code></p>
</blockquote>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApiService</span> {
    <span class="hljs-meta">@GET(<span class="hljs-string">"/"</span>)</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getHomepage</span><span class="hljs-params">()</span></span>: retrofit2.Response&lt;ResponseBody&gt;
}

<span class="hljs-meta">@AndroidEntryPoint</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">ComponentActivity</span>() {

    <span class="hljs-meta">@Inject</span>
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> apiService: ApiService

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContent {}

        lifecycleScope.launch {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">val</span> response = apiService.getHomepage()
                <span class="hljs-keyword">if</span> (response.isSuccessful) {
                    println(response.body()?.string())
                } <span class="hljs-keyword">else</span> {
                    println(<span class="hljs-string">"API request failed:<span class="hljs-subst">${response.code()}</span>"</span>)
                }
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                println(<span class="hljs-string">"Network request exceptions:<span class="hljs-subst">${e.message}</span>"</span>)
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-10">全局单例</h3>
<p>我们都知道 <code>OkHttpClient</code> 内部管理着连接池和线程池，为了复用资源，必须将其作为单例。</p>
<p>对于全局单例，也是在 <code>Module</code> 中进行配置：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Module</span>
<span class="hljs-meta">@InstallIn(SingletonComponent::class)</span> <span class="hljs-comment">// 模块安装到 SingletonComponent 组件</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkModule</span> {

    <span class="hljs-meta">@Provides</span>
    <span class="hljs-meta">@Singleton</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">provideOkHttpClient</span><span class="hljs-params">()</span></span>: OkHttpClient {
        <span class="hljs-keyword">return</span> OkHttpClient.Builder()
            .connectTimeout(<span class="hljs-number">20</span>, TimeUnit.SECONDS)
            .readTimeout(<span class="hljs-number">20</span>, TimeUnit.SECONDS)
            .writeTimeout(<span class="hljs-number">20</span>, TimeUnit.SECONDS)
            .build()
    }

    <span class="hljs-meta">@Provides</span>
    <span class="hljs-meta">@Singleton</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">provideRetrofit</span><span class="hljs-params">(okHttpClient: <span class="hljs-type">OkHttpClient</span>)</span></span>: Retrofit { <span class="hljs-comment">// 为了一致性和效率，Retrofit 也应该为单例</span>
        <span class="hljs-keyword">return</span> Retrofit.Builder()
            .baseUrl(<span class="hljs-string">"https://juejin.cn/"</span>)
            .client(okHttpClient)
            .addConverterFactory(GsonConverterFactory.create())
            .build()
    }

    <span class="hljs-meta">@Provides</span>
    <span class="hljs-meta">@Singleton</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">provideApiService</span><span class="hljs-params">(retrofit: <span class="hljs-type">Retrofit</span>)</span></span>: ApiService { <span class="hljs-comment">// create() 方法开销较高（它需要解析 ApiService 接口的所有注解，并动态创建一个实现该接口的对象），必须为单例</span>
        <span class="hljs-keyword">return</span> retrofit.create(ApiService::<span class="hljs-keyword">class</span>.java)
    }

}
</code></pre>
<h2 data-id="heading-11">核心层级：组件和组件作用域</h2>
<p>我们之前在 <code>@Module</code> 上使用了 <code>@InstallIn</code> 注解，比如 <code>@InstallIn(ActivityComponent::class)</code> 或 <code>@InstallIn(SingletonComponent::class)</code>，它是用于将当前模块安装到对应组件中的。</p>
<p>Hilt 组件（Component）可以理解成一个<strong>容器</strong>，它持有了它能提供的实例（依赖），每个容器都有着自己的生命周期。</p>
<h3 data-id="heading-12">生命周期</h3>
<p>Hilt 组件和作用域注解是严格对应的，两者决定了实例的生命周期：</p>
<blockquote>
<p>在同一个模块中，模块所在的组件和使用的作用域注解不一致，编译会出错。</p>
</blockquote>



































<table><thead><tr><th><strong>生成的组件</strong></th><th><strong>作用域注解</strong></th><th><strong>生命周期</strong></th></tr></thead><tbody><tr><td><code>SingletonComponent</code></td><td><code>@Singleton</code></td><td><strong>App 整个生命周期</strong></td></tr><tr><td><code>ActivityRetainedComponent</code></td><td><code>@ActivityRetainedScoped</code></td><td>跨越配置更改的 <code>Activity</code> 生命周期（<code>ViewModel</code> 依附于此）</td></tr><tr><td><code>ActivityComponent</code></td><td><code>@ActivityScoped</code></td><td><code>Activity</code> 的生命周期（<code>Activity</code> 销毁，它也销毁）</td></tr><tr><td><code>FragmentComponent</code></td><td><code>@FragmentScoped</code></td><td><code>Fragment</code> 的生命周期</td></tr><tr><td><code>ViewModelComponent</code></td><td><code>@ViewModelScoped</code></td><td><code>ViewModel</code> 的生命周期</td></tr></tbody></table>
<p>以 <code>@ActivityScoped</code> 为例，它表示 Hilt 会为每一个新的 Activity 创建一个新的实例。</p>
<p>为什么我们使用 <code>@Singleton</code> 注解来修饰 <code>OkHttpClient</code>，是因为这样 Hilt 才会创建唯一的 <code>OkHttpClient</code> 实例，并且整个应用运行期间，都能复用这个实例。</p>
<p>如果只是安装到了 <code>SingletonComponent</code> 组件，Hilt 默认每次注入时，都会创建新的实例。只有添加了作用域注解，比如 <code>@Singleton</code>，<code>OkHttpClient</code> 实例才会在 <code>SingletonComponent</code> 组件复用同一个实例。</p>
<h3 data-id="heading-13">层级与可见性</h3>
<p>Hilt 的组件之间有着严格的<strong>父子</strong>关系：</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbe8ee8decb84f15bc4e2fe50a9ec8e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zuo55m9:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763546620&amp;x-signature=tQguYgllQGY1%2BdjQOO7sJwTlRIc%3D" alt="Snipaste_2025-11-12_13-49-25.png" width="90%" loading="lazy"/>
<p>一个组件可以访问其所有父组件中的依赖，反之则不行。</p>
<p>作用域注解也可以在注入类上方使用，比如：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Singleton</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>() {

    <span class="hljs-meta">@BindAmericanoMachine</span>
    <span class="hljs-meta">@Inject</span>
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> americanoCM: CoffeeMaker

    <span class="hljs-meta">@BindLatteMachine</span>
    <span class="hljs-meta">@Inject</span>
    <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> latteCM: CoffeeMaker

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startMorning</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Good morning, I need americano and latte coffee..."</span>)
        americanoCM.makeCoffee()
        latteCM.makeCoffee()
        println(<span class="hljs-string">"The coffee is finished and work is done."</span>)
    }
}
</code></pre>
<p><code>Person</code> 会自动添加到 <code>SingletonComponent</code> 组件中，并带有 <code>@Singleton</code> 注解。这样，这个 <code>Person</code> 实例会变为全局唯一，且全局可用。</p>
<p>但此时运行程序，Hilt 会直接编译报错。</p>
<p>因为 <code>Person</code> 被 <code>@Singleton</code> 修饰，Hilt 会在 <code>SingletonComponent</code> 中创建并持有这个 <code>Person</code> 实例。它所依赖的 <code>CoffeeMaker</code> 安装到了 <code>ActivityComponent</code> 组件，当 <code>Person</code> 被创建时，<code>SingletonComponent</code>（父）是不可能获取得到 <code>ActivityComponent</code>（儿）中的实例的。</p>
<p>所以，我们应该让 <code>CoffeeMakerModule</code> 是 <code>SingletonComponent</code> 父辈，但 <code>SingletonComponent</code> 已经是最顶层了，所以就只能安装到 <code>SingletonComponent</code>：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@InstallIn(SingletonComponent::class)</span> <span class="hljs-comment">// 必须为 SingletonComponent</span>
<span class="hljs-meta">@Module</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CoffeeMakerModule</span> {

    <span class="hljs-meta">@Binds</span>
    <span class="hljs-meta">@Singleton</span> <span class="hljs-comment">// 最好设为单例</span>
    <span class="hljs-meta">@BindAmericanoMachine</span>
    <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bindCoffeeMaker</span><span class="hljs-params">(americanoMachine: <span class="hljs-type">AmericanoMachine</span>)</span></span>: CoffeeMaker

    <span class="hljs-meta">@Binds</span>
    <span class="hljs-meta">@Singleton</span>
    <span class="hljs-meta">@BindLatteMachine</span>
    <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">bindLatteMachine</span><span class="hljs-params">(latteMachine: <span class="hljs-type">LatteMachine</span>)</span></span>: CoffeeMaker

}
</code></pre>
<p>小结一下：</p>
<p><code>@InstallIn</code> 决定了模块被安装到了哪一层，作用域注解决定了实例在该层中是否复用。</p>
<p>要遵循父级不能依赖子级的规则。</p>
<h2 data-id="heading-14">预置 Qualifier</h2>
<p>对于 <code>Context</code> 等系统组件，它们的实例由系统创建。如果要进行依赖注入，就要使用系统提供的 Qualifier（限定符）。</p>
<p>例如 <code>@ApplicationContext</code> 注解可以提供 <code>ApplicationContext</code>。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AmericanoMachine</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-meta">@ApplicationContext</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> context: Context
) : CoffeeMaker {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">makeCoffee</span><span class="hljs-params">()</span></span> {
        println(<span class="hljs-string">"Making... Americano"</span>) <span class="hljs-comment">// ☕️</span>
        showMessage(<span class="hljs-string">"Americano is ready!"</span>)
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">showMessage</span><span class="hljs-params">(text: <span class="hljs-type">String</span>)</span></span> {
        Toast.makeText(context, text, Toast.LENGTH_SHORT).show()
    }
}
</code></pre>
<blockquote>
<p>注意：<code>CoffeeMakerModule</code> 被安装到了 <code>SingletonComponent</code> 中，所以只能注入 <code>@ApplicationContext</code>，不能注入 <code>@ActivityContext</code>。（<code>SingletonComponent</code> 是 <code>ActivityComponent</code> 的父级）</p>
</blockquote>
<p>如果需要 <code>Activity</code> 类型的 <code>Context</code>，就使用 <code>@ActivityContext</code> 注解。但要确保注入它的类是在 <code>ActivityComponent</code> 组件或其子组件。</p>
<p>对于 <code>Application</code> 和 <code>Activity</code> 实例的注入，我们无需使用注解，Hilt 已经预置了注入功能。</p>
<p>但声明这两个类型的子类型，就会编译出错，如果我们需要 <code>MyApplication</code> 实例，就要去手动提供：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Module</span>
<span class="hljs-meta">@InstallIn(SingletonComponent::class)</span>
<span class="hljs-keyword">object</span> ApplicationModule { 

    <span class="hljs-meta">@Provides</span>
    <span class="hljs-meta">@Singleton</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">provideMyApplication</span><span class="hljs-params">(app: <span class="hljs-type">Application</span>)</span></span>: MyApplication {
        <span class="hljs-keyword">return</span> app <span class="hljs-keyword">as</span> MyApplication
    }
    
}
</code></pre>
<p>如果 <code>Module</code> 中只有 <code>@Provides</code>，没有 <code>@Binds</code>，可以改为 <code>object</code>。</p>
<h2 data-id="heading-15">ViewModel 的依赖注入</h2>
<p><code>ViewModel</code> 是一个特殊的 Jetpack 组件，它的生命周期和注入方式由 Hilt 专门管理。我们使用 <code>@HiltViewModel</code> 注解即可：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@HiltViewModel</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MyViewModel</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>(<span class="hljs-comment">/*依赖也可以在这里注入*/</span>) : ViewModel() {

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doSomething</span><span class="hljs-params">()</span></span> {
        viewModelScope.launch {
            println(<span class="hljs-string">"MyViewModel: I'm doing something..."</span>)
            delay(<span class="hljs-number">1000</span>)
            println(<span class="hljs-string">"MyViewModel: I'm done!"</span>)
        }
    }
}


<span class="hljs-meta">@AndroidEntryPoint</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">ComponentActivity</span>() {
    <span class="hljs-keyword">val</span> viewModel: MyViewModel <span class="hljs-keyword">by</span> viewModels()

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContent {}
        viewModel.doSomething()
    }
}
</code></pre>
<p><code>ViewModel</code> 的生命周期和 <code>ActivityRetainedComponent</code> 组件一样。</p>
<h3 data-id="heading-16">Compose 集成</h3>
<p>在 Jetpack Compose 中，我们调用 <code>hiltViewModel()</code> Composable 函数来提供一个 <code>ViewModel</code> 实例。</p>
<blockquote>
<p>添加依赖：<code>implementation("androidx.hilt:hilt-navigation-compose:1.2.0")</code></p>
</blockquote>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@AndroidEntryPoint</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">ComponentActivity</span>() {

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContent {
            HelloWorld()
        }
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">HelloWorld</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> viewModel: MyViewModel = hiltViewModel()

    Button(
        onClick = {
            viewModel.doSomething()
        }
    ) {
        Text(text = <span class="hljs-string">"Click me"</span>)
    }
}
</code></pre>
<h3 data-id="heading-17">传递运行时参数：SavedStateHandle 模式</h3>
<p>在真实项目中，<code>ViewModel</code> 在创建时，常常会依赖于一个从 Activity/Fragment 中传入的参数。</p>
<p>这个参数无法由 Hilt 在编译期提供，但和 <code>Navigation</code> 结合使用时，我们可以使用 <code>SavedStateHandle</code> 来完成。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@HiltViewModel</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDetailViewModel</span> <span class="hljs-meta">@Inject</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> apiService: ApiService,           <span class="hljs-comment">// 由 Hilt 注入</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> savedStateHandle: SavedStateHandle  <span class="hljs-comment">// 由 Hilt 自动提供的、包含路由参数的句柄</span>
) : ViewModel() {

    <span class="hljs-comment">// userId 必须和 NavHost 路由中的参数名 detail/{userId} 匹配</span>
    <span class="hljs-keyword">val</span> userId: String = savedStateHandle[<span class="hljs-string">"userId"</span>]!!

    <span class="hljs-keyword">init</span> {
        println(<span class="hljs-string">"UserDetailViewModel created for user: <span class="hljs-variable">$userId</span>"</span>)
        loadUser()
    }

    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadUser</span><span class="hljs-params">()</span></span> {
        viewModelScope.launch {
            <span class="hljs-comment">// 使用 apiService 和 userId 加载数据</span>
            println(<span class="hljs-string">"Loading data for <span class="hljs-variable">$userId</span>..."</span>)
        }
    }
}
</code></pre>
<pre><code class="hljs language-KOTLIN" lang="KOTLIN"><span class="hljs-meta">@AndroidEntryPoint</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">ComponentActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        setContent {
            MyNavHost()
        }
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MyNavHost</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">val</span> navController = rememberNavController()
    NavHost(navController = navController, startDestination = <span class="hljs-string">"list"</span>) {

        <span class="hljs-comment">// 列表页</span>
        composable(<span class="hljs-string">"list"</span>) {
            Button(
                onClick = {
                    navController.navigate(<span class="hljs-string">"detail/1"</span>)
                }
            ) {
                Text(<span class="hljs-string">"List 1"</span>)
            }
        }

        <span class="hljs-comment">// 详情页路由</span>
        composable(<span class="hljs-string">"detail/{userId}"</span>) {
            <span class="hljs-comment">// 不需要从 backStackEntry 手动提取 userId</span>

            <span class="hljs-comment">// 直接调用 hiltViewModel()</span>
            <span class="hljs-comment">//    Hilt 会自动获取当前的 NavBackStackEntry，</span>
            <span class="hljs-comment">//    创建 SavedStateHandle，并将其注入 ViewModel。</span>
            <span class="hljs-keyword">val</span> detailViewModel: UserDetailViewModel = hiltViewModel()

            Box(modifier = Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
                Text(text = <span class="hljs-string">"Detail <span class="hljs-subst">${detailViewModel.userId}</span>"</span>)
            }
        }
    }
}
</code></pre>
<blockquote>
<p>添加依赖：<code>implementation("androidx.navigation:navigation-compose:2.9.6")</code></p>
</blockquote>
<h2 data-id="heading-18">参考</h2>
<p>参考郭霖大神的博客：<a href="https://juejin.cn/post/6902009428633698312#heading-6" target="_blank" title="https://juejin.cn/post/6902009428633698312#heading-6">Jetpack新成员，一篇文章带你玩转Hilt和依赖注入</a></p>
<p>参考 Google 官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Ftraining%2Fdependency-injection%2Fhilt-android%3Fhl%3Dzh-cn%23kotlin" target="_blank" title="https://developer.android.com/training/dependency-injection/hilt-android?hl=zh-cn#kotlin" ref="nofollow noopener noreferrer">使用 Hilt 实现依赖项注入</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何防止重复提交订单？——从踩坑到优雅落地的实战指南]]></title>    <link>https://juejin.cn/post/7571272874846109748</link>    <guid>https://juejin.cn/post/7571272874846109748</guid>    <pubDate>2025-11-11T08:28:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571272874846109748" data-draft-id="7571237750730522658" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何防止重复提交订单？——从踩坑到优雅落地的实战指南"/> <meta itemprop="keywords" content="架构,Java"/> <meta itemprop="datePublished" content="2025-11-11T08:28:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="狼爷"/> <meta itemprop="url" content="https://juejin.cn/user/2418581314208279"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何防止重复提交订单？——从踩坑到优雅落地的实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2418581314208279/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    狼爷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T08:28:15.000Z" title="Tue Nov 11 2025 08:28:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="srcery">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1b19;color:#fce8c3}.hljs-emphasis,.hljs-strong{color:#918175}.hljs-bullet,.hljs-link,.hljs-literal,.hljs-number,.hljs-quote,.hljs-regexp{color:#ff5c8f}.hljs-code,.hljs-selector-class{color:#68a8e4}.hljs-emphasis{font-style:italic}.hljs-attribute,.hljs-keyword,.hljs-section,.hljs-selector-tag,.hljs-variable{color:#ef2f27}.hljs-name,.hljs-title{color:#fbb829}.hljs-params,.hljs-type{color:#0aaeb3}.hljs-string{color:#98bc37}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-selector-attr,.hljs-selector-id,.hljs-selector-pseudo,.hljs-subst,.hljs-symbol,.hljs-template-tag,.hljs-template-variable{color:#c07abe}.hljs-comment,.hljs-deletion,.hljs-meta{color:#918175}</style><blockquote>
<p>一次点击，下单成功；两次点击，客服崩溃。<br/>
重复提交订单的问题，几乎每个后端都遇到过。今天咱们就从底层逻辑到实战代码，聊聊这个老生常谈却又暗藏玄机的话题。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">💡 一、背景：为什么会重复提交？</h2>
<p>先说场景。</p>
<p>用户点了一次“立即支付”，发现没反应，再点一次，结果悲剧发生：</p>
<ul>
<li>生成了两笔订单；</li>
<li>扣了两次库存；</li>
<li>财务对账炸了锅。</li>
</ul>
<p>这还只是正常用户，有的还会：</p>
<ul>
<li>前端按钮没禁用，点个爽；</li>
<li>支付网关超时自动重试；</li>
<li>脚本自动刷单接口。</li>
</ul>
<p>于是，后端同学开始加锁、加幂等、加约束，最后一看，代码又胖了一圈。</p>
<hr/>
<h2 data-id="heading-1">🧱 二、常见的防重复提交方案</h2>
<p>其实防重复提交的核心目标就一句话：</p>
<blockquote>
<p><strong>在一定时间内，确保同一个请求只被处理一次。</strong></p>
</blockquote>
<p>从架构层次看，可以分为：</p>



































<table><thead><tr><th>层次</th><th>方案</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>前端层</td><td>按钮防抖 / 禁用</td><td>简单直观</td><td>不可靠，易被跳过</td></tr><tr><td>网关层</td><td>幂等性Key</td><td>通用</td><td>实现复杂</td></tr><tr><td>服务层</td><td>Redis分布式锁</td><td>高性能</td><td>需要良好锁管理</td></tr><tr><td>数据库层</td><td>唯一索引 / 状态判断</td><td>最稳</td><td>执行慢，影响性能</td></tr></tbody></table>
<p>实际生产中，<strong>一般会前后端双保险</strong>：<br/>
👉 前端防抖 + 后端幂等控制。</p>
<hr/>
<h2 data-id="heading-2">🔑 三、服务端防重复提交的常见思路</h2>
<p>来点干货。<br/>
后端层面常用的方案主要有三种。</p>
<hr/>
<h3 data-id="heading-3">✅ 方案一：幂等性 Token 机制（推荐）</h3>
<p><strong>核心逻辑：</strong></p>
<ol>
<li>前端先调用 <code>/token</code> 接口，获取一个随机 <code>token</code>；</li>
<li>请求下单时携带该 token；</li>
<li>后端校验 token 是否已使用；</li>
<li>没用过 → 处理业务并标记“已使用”；<br/>
用过 → 拒绝请求。</li>
</ol>
<p>👉 非常适合「表单类接口」或「下单支付类接口」。</p>
<p><strong>伪流程：</strong></p>
<pre><code class="hljs language-rust" lang="rust">前端请求 token <span class="hljs-punctuation">-&gt;</span> 缓存保存 token <span class="hljs-punctuation">-&gt;</span> 请求接口时携带 token <span class="hljs-punctuation">-&gt;</span> 校验通过一次后删除 token
</code></pre>
<hr/>
<h3 data-id="heading-4">✅ 方案二：Redis 分布式锁机制</h3>
<p>使用 Redis 的 <code>SETNX</code>（或 Redisson）实现业务级互斥锁：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-type">boolean</span> lock = redis.setIfAbsent(<span class="hljs-keyword">key</span>, <span class="hljs-string">"1"</span>, <span class="hljs-number">5</span>, TimeUnit.SECONDS);
<span class="hljs-keyword">if</span> (!lock) {
    <span class="hljs-keyword">throw</span> <span class="hljs-built_in">new</span> BusinessException(<span class="hljs-string">"请勿重复提交"</span>);
}
<span class="hljs-keyword">try</span> {
    createOrder();
} <span class="hljs-keyword">finally</span> {
    redis.delete(<span class="hljs-keyword">key</span>);
}
</code></pre>
<p>比如 key 可设计为：</p>
<pre><code class="hljs language-less" lang="less">lock:<span class="hljs-attribute">order</span>:<span class="hljs-attribute">create</span>:<span class="hljs-attribute">userId</span>:<span class="hljs-number">123</span>
</code></pre>
<p>优点：</p>
<ul>
<li>性能高</li>
<li>实现简单</li>
<li>适合短时间的防重需求</li>
</ul>
<p>缺点：</p>
<ul>
<li>需要注意锁过期与释放问题。</li>
</ul>
<hr/>
<h3 data-id="heading-5">✅ 方案三：数据库层幂等约束</h3>
<p>老实人的方案——数据库唯一索引。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> t_order <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">UNIQUE</span> KEY uk_order_no (order_no);
</code></pre>
<p>或者逻辑判断：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">if</span> (orderRepository.existsByOrderNo(orderNo)) {
    <span class="hljs-built_in">log</span>.info(<span class="hljs-string">"订单重复提交: {}"</span>, orderNo);
    <span class="hljs-keyword">return</span>;
}
</code></pre>
<p>优点：稳如老狗。<br/>
缺点：性能不高，适合作为兜底。</p>
<hr/>
<h2 data-id="heading-6">🧭 四、综合方案流程图</h2>
<p>下面是一个比较推荐的方案：<br/>
<strong>幂等Token + Redis锁 双层防护</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/126e8a2341b4461492d0804cf2582f3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54u854i3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763455349&amp;x-signature=0mW4Ex1axTDpgO3hAHdcDSPwUFo%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-7">💻 五、实战代码（Spring Boot）</h2>
<h3 data-id="heading-8">🧩 1. 获取幂等 Token 接口</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/api/token"</span>)
public class TokenController {

    <span class="hljs-variable">@Autowired</span>
    private StringRedisTemplate redisTemplate;

    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">"/generate"</span>)
    public String <span class="hljs-built_in">generateToken</span>() {
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">token</span> = <span class="hljs-selector-tag">UUID</span><span class="hljs-selector-class">.randomUUID</span>()<span class="hljs-selector-class">.toString</span>();
        <span class="hljs-selector-tag">redisTemplate</span><span class="hljs-selector-class">.opsForValue</span>()<span class="hljs-selector-class">.set</span>(<span class="hljs-string">"token:"</span> + token, <span class="hljs-string">"1"</span>, <span class="hljs-number">10</span>, TimeUnit.MINUTES);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">token</span>;
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-9">🧩 2. 下单接口（幂等 + Redis锁）</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/api/order"</span>)
public class OrderController {

    <span class="hljs-variable">@Autowired</span>
    private StringRedisTemplate redisTemplate;

    <span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/create"</span>)
    public String <span class="hljs-built_in">createOrder</span>(<span class="hljs-variable">@RequestHeader</span>(<span class="hljs-string">"Idempotency-Token"</span>) String token,
                              <span class="hljs-variable">@RequestBody</span> OrderRequest request) {
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">key</span> = "<span class="hljs-selector-tag">token</span>:" + <span class="hljs-selector-tag">token</span>;

        <span class="hljs-comment">// 校验token是否存在</span>
        <span class="hljs-selector-tag">Boolean</span> <span class="hljs-selector-tag">exists</span> = <span class="hljs-selector-tag">redisTemplate</span><span class="hljs-selector-class">.hasKey</span>(key);
        <span class="hljs-selector-tag">if</span> (Boolean.FALSE.<span class="hljs-built_in">equals</span>(exists)) {
            <span class="hljs-selector-tag">throw</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">BusinessException</span>(<span class="hljs-string">"请勿重复提交"</span>);
        }

        <span class="hljs-comment">// 删除token，确保一次性</span>
        <span class="hljs-selector-tag">redisTemplate</span><span class="hljs-selector-class">.delete</span>(key);

        <span class="hljs-comment">// 加锁防并发</span>
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">lockKey</span> = "<span class="hljs-selector-tag">lock</span>:<span class="hljs-selector-tag">order</span>:<span class="hljs-selector-tag">create</span>:" + <span class="hljs-selector-tag">request</span><span class="hljs-selector-class">.getUserId</span>();
        <span class="hljs-selector-tag">Boolean</span> <span class="hljs-selector-tag">locked</span> = <span class="hljs-selector-tag">redisTemplate</span><span class="hljs-selector-class">.opsForValue</span>()
                <span class="hljs-selector-class">.setIfAbsent</span>(lockKey, <span class="hljs-string">"1"</span>, <span class="hljs-number">5</span>, TimeUnit.SECONDS);

        <span class="hljs-selector-tag">if</span> (Boolean.FALSE.<span class="hljs-built_in">equals</span>(locked)) {
            <span class="hljs-selector-tag">throw</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">BusinessException</span>(<span class="hljs-string">"请勿重复点击"</span>);
        }

        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 创建订单逻辑</span>
            <span class="hljs-selector-tag">return</span> "下单成功";
        } <span class="hljs-selector-tag">finally</span> {
            <span class="hljs-selector-tag">redisTemplate</span><span class="hljs-selector-class">.delete</span>(lockKey);
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-10">⚙️ 六、最佳实践经验总结</h2>





























<table><thead><tr><th>项目</th><th>建议</th></tr></thead><tbody><tr><td>Token有效期</td><td>建议 5～10 分钟</td></tr><tr><td>锁粒度</td><td>以用户ID 或 业务单号为单位</td></tr><tr><td>幂等Key传递方式</td><td>推荐放在 Header 中，例如 <code>Idempotency-Token</code></td></tr><tr><td>数据库层兜底</td><td>唯一约束防止极端情况</td></tr><tr><td>日志</td><td>建议记录 Token 与锁状态，方便排查</td></tr></tbody></table>
<p>一句话总结：</p>
<blockquote>
<p><strong>Redis防快点，数据库防慢点，前端防乱点。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-11">🧠 七、总结</h2>





























<table><thead><tr><th>层级</th><th>手段</th><th>优点</th><th>备注</th></tr></thead><tbody><tr><td>前端</td><td>按钮防抖</td><td>用户体验好</td><td>仅表层防护</td></tr><tr><td>Redis</td><td>Token + Lock</td><td>性能高</td><td>推荐主力方案</td></tr><tr><td>数据库</td><td>唯一约束</td><td>稳定</td><td>最终兜底</td></tr></tbody></table>
<p>最终结论：</p>
<blockquote>
<p>没有银弹，只有多层防御。<br/>
前端防抖 + 后端幂等 + 数据库约束 = 才是真正的生产级防重复方案。</p>
</blockquote>
<hr/>
<h2 data-id="heading-12">✨ 写在最后</h2>
<p>防重复提交这事，说简单也简单，说复杂也复杂。<br/>
它考验的不是写代码的能力，而是你对<strong>业务一致性</strong>和<strong>系统幂等性</strong>的理解。</p>
<p>下次再有人问你“为什么我点两次下单按钮扣了两次钱”，<br/>
你可以淡定地说一句——</p>
<blockquote>
<p>“兄弟，我们系统现在有幂等锁，不怕你点三次。”</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[硬核安利一个监控告警开源项目Nightingale]]></title>    <link>https://juejin.cn/post/7570975737634734121</link>    <guid>https://juejin.cn/post/7570975737634734121</guid>    <pubDate>2025-11-11T01:37:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570975737634734121" data-draft-id="7570908785294344211" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 硬核安利一个监控告警开源项目Nightingale"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T01:37:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="shark_chili"/> <meta itemprop="url" content="https://juejin.cn/user/2858385964801672"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             硬核安利一个监控告警开源项目Nightingale
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2858385964801672/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    shark_chili
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T01:37:21.000Z" title="Tue Nov 11 2025 01:37:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">写在文章开头</h2>
<p>夜莺是笔者近期了解到的一款比较强大的日志监控告警工具，按照官网的说法它可对接多种既有的主流数据源包括但不限于：</p>
<ol>
<li>ClickHouse</li>
<li>elasticsearch</li>
<li>Loki</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddf650a011c0440b99e44e3f0068eb9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=SpV2AVOQexzTITDaTaarvGWEo2M%3D" alt="" loading="lazy"/></p>
<p>然后我们只需按照夜莺配置模板即可完成监控指标、日志监控告警功能，而本文笔者所着重要介绍的，是这款系统中最强大的日志告警，笔者将通过一个es日志的示例逐步演示并结合源码分析的方式全方位带读者了解夜莺监控的使用和工作机制。</p>
<p>我是 <strong>SharkChili</strong> ，Java 开发者，<strong>Java Guide</strong> 开源项目维护者。欢迎关注我的公众号：<strong>写代码的SharkChili</strong>，也欢迎您了解我的开源项目 mini-redis：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fshark-ctrl%2Fmini-redis" target="_blank" title="https://github.com/shark-ctrl/mini-redis" ref="nofollow noopener noreferrer">github.com/shark-ctrl/…</a>。</p>
<p>为方便与读者交流，现已创建读者群。关注下方公众号获取我的联系方式，添加时备注<strong>加群</strong>即可加入。</p>
<h2 data-id="heading-1">详解Nightingale安装与配置</h2>
<h3 data-id="heading-2">前置准备</h3>
<p>主流的日志采集都是通过<code>skywalking</code>采集日志到<code>elasticsearch</code>，如下架构图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2d03e5254194838846cf29073d6212d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=Cu4gqLKJ9lmaCJIBjsLXF823ucI%3D" alt="" loading="lazy"/></p>
<p>而本文的案例则是通过<code>elasticsearch</code>采集系统程序运行日志，并按照<code>Nightingale</code>协定的规则配置定时采集任务，一旦感知到<code>elasticsearch</code>日志中存在错误日志则发出告警：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13481e5280ad4f74be6aad2caa9525cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=K%2Bmh5MOjkFaiuljj210vYUP7TE8%3D" alt="" loading="lazy"/></p>
<p>为了更好的演示夜莺如何根据采集日志并发出告警，笔者这里也简单介绍一下本文数据源<code>elasticsearch</code>的的配置。本文<code>elasticsearch</code>选用版本为<code>7.12.0</code>，在该版本的es上笔者刷入如下索引，可以看到这款索引很好的模拟了日常采集日志的常见数据：</p>
<ol>
<li>微服务名称</li>
<li>日志消息</li>
<li>日志时间</li>
<li>日志级别</li>
</ol>

<pre><code class="hljs language-vbnet" lang="vbnet">--  创建索引
curl -X PUT <span class="hljs-string">"localhost:9200/java_app_logs"</span> -H <span class="hljs-comment">'Content-Type: application/json' -d'</span>
{
  <span class="hljs-string">"mappings"</span>: {
    <span class="hljs-string">"properties"</span>: {
      <span class="hljs-string">"service_name"</span>: {
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"keyword"</span>
      },
      <span class="hljs-string">"log_message"</span>: {
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span>
      },
      <span class="hljs-string">"timestamp"</span>: {
        <span class="hljs-string">"type"</span>: <span class="hljs-string">"date"</span>
      }
    }
  }
}
<span class="hljs-comment">'</span>

-- 添加日志级别
curl -X PUT <span class="hljs-string">"localhost:9200/java_app_logs/_mapping"</span> -H <span class="hljs-comment">'Content-Type: application/json' -d'</span>
{
  <span class="hljs-string">"properties"</span>: {
    <span class="hljs-string">"log_level"</span>: {
      <span class="hljs-string">"type"</span>: <span class="hljs-string">"keyword"</span>
    }
  }
}
<span class="hljs-comment">'</span>
</code></pre>
<p>完成必要的索引创建后，我们就可以按需刷入如下请求建立文档模拟用户登录成功和失败的消息：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">-- 添加日志

curl -X POST <span class="hljs-string">"localhost:9200/java_app_logs/_doc"</span> -H <span class="hljs-comment">'Content-Type: application/json' -d'</span>
{
  <span class="hljs-string">"service_name"</span>: <span class="hljs-string">"user-service"</span>,
  <span class="hljs-string">"log_message"</span>: <span class="hljs-string">"用户登录成功，用户ID: 12345"</span>,
  <span class="hljs-string">"log_level"</span>: <span class="hljs-string">"INFO"</span>,
  <span class="hljs-string">"timestamp"</span>: <span class="hljs-string">"'$(date -u +"</span>%Y-%m-%dT%H:%M:%S.%<span class="hljs-number">3</span>NZ<span class="hljs-string">")'"</span>
}
<span class="hljs-comment">'</span>

-- 登录失败的日志
curl -X POST <span class="hljs-string">"localhost:9200/java_app_logs/_doc"</span> -H <span class="hljs-comment">'Content-Type: application/json' -d'</span>
{
  <span class="hljs-string">"service_name"</span>: <span class="hljs-string">"user-service"</span>,
  <span class="hljs-string">"log_message"</span>: <span class="hljs-string">"用户登录失败，用户名: testuser，原因: 密码错误"</span>,
  <span class="hljs-string">"log_level"</span>: <span class="hljs-string">"ERROR"</span>, 
  <span class="hljs-string">"timestamp"</span>: <span class="hljs-string">"'$(date -u +"</span>%Y-%m-%dT%H:%M:%S.%<span class="hljs-number">3</span>NZ<span class="hljs-string">")'"</span>
}
<span class="hljs-comment">'</span>
</code></pre>
<p>自此，我们就有了一份可进行采集监控的es数据源，就可以开始通过夜莺进行日志监控告警配置了。</p>
<h3 data-id="heading-3">二进制安装</h3>
<p>因为笔者采用<code>Linux</code>服务器部署且采用二进制的方式安装，所以我们需要到<code>github</code>下载最新版本，对应的下载地址为：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fccfos%2Fnightingale%2Freleases" target="_blank" title="https://github.com/ccfos/nightingale/releases" ref="nofollow noopener noreferrer">github.com/ccfos/night…</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/901979c6ca2d407ba08876053d080789~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=sOshTaKAV5hhNrUVp05Rd%2FkpVG8%3D" alt="" loading="lazy"/></p>
<p>将下载好的压缩包进行解压：</p>
<pre><code class="hljs">tar zxvf n9e-v8.4.0-linux-amd64.tar.gz
</code></pre>
<p>然后我们直接进入<code>bin</code>目录键入如下指令就可以将夜莺启动了：</p>
<pre><code class="hljs language-bash" lang="bash">./n9e
</code></pre>
<p>随后我们通过<code>17000</code>端口即可访问<code>Nightingale</code>登录界面，默认情况下<code>Nightingale</code>的账户和密码分别是：</p>
<pre><code class="hljs">账户：root
密码：root.2020
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a1a5c0c1062a49ac8a6d4b244d261427~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=GnewQh4wcTd9p7vSCHTV75KbXM8%3D" alt="" loading="lazy"/></p>
<p>明确可以正常启动，读者可以使用如下指令以后台的方式启动：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> /opt/n9e &amp;&amp; <span class="hljs-built_in">nohup</span> ./n9e &amp;&gt; n9e.log &amp;
</code></pre>
<h3 data-id="heading-4">数据源配置</h3>
<p>登录管理界面之后，就可以将es数据源引入进行监控告警管理了，通过集成中心定位到数据源，点击进入数据源配置界面：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a65fbde4b4f84f60b94e86102c128eb3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=wgnIhmKGRazEGaysISlkxo11ZiA%3D" alt="" loading="lazy"/></p>
<p>随后点击新增并选择<code>ElasticSearch</code>数据源：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e5d955efb2641c4867a43f9a2a1c369~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=aA04us1vk046TsC%2Bcrt8vqKzNfY%3D" alt="" loading="lazy"/></p>
<p>根据提示依次配置：</p>
<ol>
<li>数据源名称</li>
<li>访问地址</li>
<li>版本信息</li>
</ol>
<p>明确无误后，点击测试连通性并保存：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1013a67d5e08429bb7dc401afc5b6164~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=IJoN5zGRy%2BK3otPVomHkNWDA3W4%3D" alt="" loading="lazy"/></p>
<p>如下图所示，这样就说明数据源添加成功了，自此我们的<code>Nightingale</code>就可以针对日志数据源进行监控告警规则配置了：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e820df428054323ae4c19a558c969f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=R74t5D2GGjc57dA0IPRw1VcfEUw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">日志查询</h3>
<p>为了明确我们<code>es</code>写入的日志能够被准确的查询到，我们可以先通过<code>Nightingale</code>的日志页面针对针对该数据源进行日志查询，以笔者为例，对应的配置为：</p>
<ol>
<li>数据源选择<code>elasticsearch</code>数据源</li>
<li>选择索引模式即<code>indices</code></li>
<li>索引使用<code>java_app_logs</code></li>
<li>日志过滤条件为日志级别为错误级别的即<code>log_level:"ERROR"</code></li>
</ol>
<p>对应的配置和输出结果如下，由此可确定笔者的配置没有任何问题：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/461f89a59a9c49328129b5151853ec49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=DxrD0LdHyS8US9vhAgxNlBKHhXY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">告警规则配置与调测</h3>
<p>重头戏来了，明确错误日志查询无误后，我们就可以按照我们上述的调测针对<code>error</code>级别的日志配置相应告警规则了，按照我们需求的说法，即一旦查询到错误级别的日志超过1条则直接发出告警，我们可以到告警面板选择规则管理配置监控告警，以笔者为例首先指明规则为错误日志监控告警：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/188496dc29dc40eba07680ab06fa779d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=l%2FHe7I4NTqROQ2sZareQFoE24y8%3D" alt="" loading="lazy"/></p>
<p>针对规则配置，相应配置为：</p>
<ol>
<li>选择数据源类型为<code>elasticsearch</code>数据源</li>
<li>选择精确匹配指定数据源为我们的<code>elasticsearch</code>数据源</li>
<li>查询统计项指明索引为<code>java_app_logs</code>且过滤条件为过滤出错误类型日志<code>log_level:"ERROR"</code></li>
<li>时间间隔设置为<code>30min</code>以内的数据 <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5da9b48558b547d88f5aa19940b9d3bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=tjTDnQ78owQv0klpaeh%2FdunpZas%3D" alt="" loading="lazy"/></li>
</ol>
<p>明确这个时间后，我们可以在es上刷几条错误日志看看规则配置是否可以正确执行：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">curl -X POST <span class="hljs-string">"localhost:9200/java_app_logs/_doc"</span> -H <span class="hljs-comment">'Content-Type: application/json' -d'</span>
{
  <span class="hljs-string">"service_name"</span>: <span class="hljs-string">"user-service"</span>,
  <span class="hljs-string">"log_message"</span>: <span class="hljs-string">"用户登录失败，用户名: testuser，原因: 密码错误"</span>,
  <span class="hljs-string">"log_level"</span>: <span class="hljs-string">"ERROR"</span>, 
  <span class="hljs-string">"timestamp"</span>: <span class="hljs-string">"'$(date -u +"</span>%Y-%m-%dT%H:%M:%S.%<span class="hljs-number">3</span>NZ<span class="hljs-string">")'"</span>
}
<span class="hljs-comment">'</span>
</code></pre>
<p>可以看到通过表达式我们拿到了30条数据，说明这个规则配置没有问题： <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/608370c39cb24359bd8bb746bc355934~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=lbAfls2RsucfFaoZWIBsX%2BDqCwU%3D" alt="" loading="lazy"/></p>
<p>针对阈值判断，笔者指定规则为上述规则大于1也就是错误日志大于0条则触发告警，对应这个监控频率为<code>1min</code>一次，持续时长设置为0即代表只要出现一次直接告警。</p>
<p>这里我们也补充说明一下持续时长的概念，按照官网的说法持续时长即代表该规则为真时且持续配置的时间后才触发告警，例如我们1min执行一次，持续时长配置为120s即代表定时任务两次采集都收到错误级别日志大于1才触发告警。</p>
<p>当然笔者这里也是出于简单，直接配置为0：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dff99a88132a4c5aa517874ff266129d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=OQKlhkCkc%2FyI37q4Mbx2e2JmOKk%3D" alt="" loading="lazy"/></p>
<p>其他配置全部默认保存即可。</p>
<h3 data-id="heading-7">告警验收</h3>
<p>此时，一旦触发告警我们就可以在告警事件上看到事件，因为夜莺默认情况下都会将事件存储在缓存中，基于这种设计理念我们可以将实时告警在夜莺平台上对接各种方式通知用户：</p>
<ol>
<li>企业微信</li>
<li>阿里云短信</li>
<li>邮件</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7af8f962ced140c493573eb79644dac5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=R59vyeB4ggQBlIaciz%2F%2FS%2Fr2Q%2BA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">基于源码详解夜莺工作机制</h2>
<h3 data-id="heading-9">日志告警预览查询原理</h3>
<p>通过上述的实践，我们基本了解了夜莺的基本使用方式，为了更好的帮助读者理解夜莺这个开源告警的工作原理，笔者也将<code>Nightingale</code>的源码克隆到本地针对几个比较核心的部分进入深入的拆解分析。</p>
<p>首先我们先来说说数据预览这一块，因为<code>Nightingale</code>的数值提取针对支持对es日志进行<code>count</code>、max、min等多种日志数据收敛提取方式，然后通过数据源预览即可得到查询结果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/498c1955f1014d8a8d1c22f799944f6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=lKfWwkuLRBP0rb3EAkQCPHlm7%2Fs%3D" alt="" loading="lazy"/></p>
<p>通过浏览器控台，笔者定位到对应的请求映射为<code>http://127.0.0.1:17000/api/n9e/ds-query</code>，同时我们也可以看到请求参数，如下所示，这里笔者也针对说明一下如下几个参数的含义：</p>
<ol>
<li><code>cate</code>：指明数据源类型为<code>elasticsearch</code></li>
<li><code>datasource_id</code>：规则配置使用的数据源为id为1，也就是我们首次配置的<code>elasticsearch</code>数据源</li>
<li><code>query</code>：这个<code>json</code>块比较重要，它说明我们配置的规则名为A，索引类型<code>index_type</code>为索引类型而非索引匹配模式，然后<code>index</code>指明为<code>java_app_logs</code>，然后就是kql配置规则和提取方式为<code>count</code></li>
<li><code>date_field</code>：指明采集的时间字段用索引中的<code>timestamp</code></li>
</ol>
<p>其他参数则是轮询间隔和基于这个间隔生成的起止时间：</p>
<pre><code class="hljs language-python" lang="python">{
  <span class="hljs-string">"cate"</span>: <span class="hljs-string">"elasticsearch"</span>,
  <span class="hljs-string">"datasource_id"</span>: <span class="hljs-number">1</span>,
  <span class="hljs-string">"query"</span>: [
    {
      <span class="hljs-string">"ref"</span>: <span class="hljs-string">"A"</span>,
      <span class="hljs-string">"index_type"</span>: <span class="hljs-string">"index"</span>,
      <span class="hljs-string">"index"</span>: <span class="hljs-string">"java_app_logs"</span>,
      <span class="hljs-string">"filter"</span>: <span class="hljs-string">"log_level:"</span>ERRO<span class="hljs-string">R""</span>,
      <span class="hljs-string">"value"</span>: {
        <span class="hljs-string">"func"</span>: <span class="hljs-string">"count"</span>
      },
      <span class="hljs-string">"date_field"</span>: <span class="hljs-string">"timestamp"</span>,
      <span class="hljs-string">"interval"</span>: <span class="hljs-number">1800</span>,
      <span class="hljs-string">"start"</span>: <span class="hljs-number">1762532762</span>,
      <span class="hljs-string">"end"</span>: <span class="hljs-number">1762534562</span>
    }
  ]
}
</code></pre>
<p>返回结果如下，通过整体结构我们可以看出，对应A规则的在<code>1762531200</code>即<code>2025年11月8日</code> <code>00:00:00</code>查出<code>count</code>为<code>22</code>：</p>
<pre><code class="hljs language-python" lang="python">{
    <span class="hljs-string">"dat"</span>: [
        {
            <span class="hljs-string">"ref"</span>: <span class="hljs-string">"A"</span>,
            <span class="hljs-string">"metric"</span>: {
                <span class="hljs-string">"__name__"</span>: <span class="hljs-string">"A__count"</span>
            },
            <span class="hljs-string">"values"</span>: [
                [
                    <span class="hljs-number">1762531200</span>,
                    <span class="hljs-number">22</span>
                ]
            ],
            <span class="hljs-string">"query"</span>: <span class="hljs-string">"map[date_field:timestamp end:1.762534562e+09 filter:log_level:"</span>ERRO<span class="hljs-string">R" index:java_app_logs index_type:index interval:1800 ref:A start:1.762532762e+09 value:map[func:count]]"</span>
        }
    ],
    <span class="hljs-string">"err"</span>: <span class="hljs-string">""</span>
}
</code></pre>
<p>明确这个接口出参和入参之后，我们就可以针对该接口进行深入分析了，本质上Nightingale数值提取查询就是通过上述请求参数生成es的restful请求参数，并通过返回结果中的聚合通提取到规则对应的count、max、min等信息然后返回给用户：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f774d648bf544d1583cbee80e2292d28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=c9zOO%2FSipiGA1wt48GZXfywF%2B4Y%3D" alt="" loading="lazy"/></p>
<p>对应的我们可以在<code>router.go</code>文件中看到这个请求的入口，可以看到该请求映射本质上都是通过<code>QueryData</code>这个函数处理的：</p>
<pre><code class="hljs language-arduino" lang="arduino">  <span class="hljs-comment">//告警规则配置请求入口</span>
   pages.<span class="hljs-built_in">POST</span>(<span class="hljs-string">"/ds-query"</span>, rt.QueryData)
</code></pre>
<p>步入QueryData，即可看到如下几个步骤：</p>
<ol>
<li>将请求参数绑定到变量f这个<code>QueryParam</code>结构体上，本质上就是将上述的入参进行一个一一对应的封装</li>
<li>通过QueryDataConcurrently发起es查询请求</li>
<li>将查询结果返回</li>
</ol>

<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rt *Router)</span></span> QueryData(c *gin.Context) {
 
 <span class="hljs-keyword">var</span> f models.QueryParam
 <span class="hljs-comment">//解析绑定参数</span>
 ginx.BindJSON(c, &amp;f)
 <span class="hljs-comment">//发起es restful请求然后返回结果resp</span>
 resp, err := QueryDataConcurrently(rt.Center.AnonymousAccess.PromQuerier, c, f)
 
 <span class="hljs-comment">//......</span>
 <span class="hljs-comment">//将结果返回给用户</span>
 ginx.NewRender(c).Data(resp, <span class="hljs-literal">nil</span>)
}
</code></pre>
<p>而QueryDataConcurrently内部逻辑也比较简单，因为我们的http请求入参中的query是个数组，所以该函数会拿到QueryParam中的query数组进行遍历，生成一个个协程发起请求并通过倒计时门栓阻塞等待，当所有请求结果写入切片后，直接将切片resp返回：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72848a1320524cba818ca1301f835e6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=L16dUTl3ldV%2Bfc%2BqI%2FFraC1iEGw%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">QueryDataConcurrently</span><span class="hljs-params">(anonymousAccess <span class="hljs-type">bool</span>, ctx *gin.Context, f models.QueryParam)</span></span> ([]models.DataResp, <span class="hljs-type">error</span>) {
 <span class="hljs-comment">//声明一个结果切片</span>
 <span class="hljs-keyword">var</span> resp []models.DataResp
 <span class="hljs-comment">//......</span>
 <span class="hljs-keyword">for</span> _, q := <span class="hljs-keyword">range</span> f.Querys {
  <span class="hljs-comment">//......</span>

 
  <span class="hljs-comment">//针对查询请求添加一个倒计时门栓</span>
  wg.Add(<span class="hljs-number">1</span>)
  <span class="hljs-comment">//起个协程发起es查询</span>
  <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(query <span class="hljs-keyword">interface</span>{})</span></span> {
   <span class="hljs-keyword">defer</span> wg.Done()
   <span class="hljs-comment">//执行查询,实际调用es的地方,将数组内部的query参数传入</span>
   datas, err := plug.QueryData(ctx.Request.Context(), query)
   <span class="hljs-comment">//......</span>

  
   <span class="hljs-comment">//将结果写入resp这个切片中</span>
   resp = <span class="hljs-built_in">append</span>(resp, datas...)
   mu.Unlock()
  }(q)
 }
 <span class="hljs-comment">//等待所有协程查询结束</span>
 wg.Wait()

 <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(errs) &gt; <span class="hljs-number">0</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, errs[<span class="hljs-number">0</span>]
 }

 <span class="hljs-comment">//......</span>
 <span class="hljs-comment">//返回执行结果的切片</span>
 <span class="hljs-keyword">return</span> resp, <span class="hljs-literal">nil</span>
}
</code></pre>
<p>通过上述源码可以看到每一个协程都是通过<code>plug.QueryData(ctx.Request.Context(), query)</code>发起es请求的，实际上这段逻辑都是在eslike.go上完成的，对应的执行步骤为就是：</p>
<ol>
<li>基于filter生成es的must表达式</li>
<li>基于timestamp和interval生成range查询</li>
<li>基于1、2构建一个bool查询</li>
<li>通过参数value指明的count聚合，构建出一个桶聚合，指明不同时间区间的符合要求的文档数</li>
</ol>
<p>对应的参数解析映射如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/369206d6bde74b4ab39b83ed592b99ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=ClaDwzcYEMWS163yAMB3kGLged0%3D" alt="" loading="lazy"/> 最后es会返回类似如下的一个结构体，Nightingale就会拿出这个doc_count作为结果封装返回：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"aggregations"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"ts"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"buckets"</span> <span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-punctuation">{</span>
          <span class="hljs-attr">"key_as_string"</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">"2025-11-05T14:30:00.000Z"</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"key"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">1762353000000</span><span class="hljs-punctuation">,</span>
          <span class="hljs-attr">"doc_count"</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">10</span>
        <span class="hljs-punctuation">}</span>
      <span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
</code></pre>
<p>对应的逻辑参见如下eslike.go的QueryData，和上述说明一致，读者可结合注释阅读理解：</p>
<pre><code class="hljs language-python" lang="python">func QueryData(ctx context.Context, queryParam interface{}, cliTimeout int64, version string, search SearchFunc) ([]models.DataResp, error) {
 //......
 //生成<span class="hljs-built_in">range</span>对象,结构体类似于
 /**
 <span class="hljs-built_in">range</span><span class="hljs-string">": {
           "</span>timestamp<span class="hljs-string">": {
             "</span><span class="hljs-built_in">format</span><span class="hljs-string">": "</span>epoch_millis<span class="hljs-string">",
             "</span><span class="hljs-keyword">from</span><span class="hljs-string">": 1762353000000,
             "</span>include_lowe<span class="hljs-string">r": true,
             "</span>include_uppe<span class="hljs-string">r": true,
             "</span>to<span class="hljs-string">": 1762353600000
           }
         }
 */
 q := elastic.NewRangeQuery(param.DateField)
 //......
 //生成时间范围并给出返回对应的时间单位
 q.Gte(time.Unix(start, 0).UnixMilli())
 q.Lte(time.Unix(end, 0).UnixMilli())
 q.Format("</span>epoch_millis<span class="hljs-string">")

  //......
 //生成bool查询并基于fiter构建出must子句,传入q即将range查询存入filter子句中
 /**
 "</span>query<span class="hljs-string">": {
     "</span><span class="hljs-built_in">bool</span><span class="hljs-string">": {
       "</span>filte<span class="hljs-string">r": {
         "</span><span class="hljs-built_in">range</span><span class="hljs-string">": {
           "</span>timestamp<span class="hljs-string">": {
             "</span><span class="hljs-built_in">format</span><span class="hljs-string">": "</span>epoch_millis<span class="hljs-string">",
             "</span><span class="hljs-keyword">from</span><span class="hljs-string">": 1762353000000,
             "</span>include_lowe<span class="hljs-string">r": true,
             "</span>include_uppe<span class="hljs-string">r": true,
             "</span>to<span class="hljs-string">": 1762353600000
           }
         }
       },
       "</span>must<span class="hljs-string">": {
         "</span>query_string<span class="hljs-string">": {
           "</span>query<span class="hljs-string">": "</span>log_level:<span class="hljs-string">"ERROR"</span><span class="hljs-string">"
         }
       }
     }
   }
  */
 queryString := GetQueryString(param.Filter, q)

 var aggr elastic.Aggregation
 switch param.MetricAggr.Func {
 case "</span>avg<span class="hljs-string">":
  aggr = elastic.NewAvgAggregation().Field(field)
 //......
  aggr = elastic.NewSumAggregation().Field(field)
 case "</span>count<span class="hljs-string">":
  
  aggr = elastic.NewValueCountAggregation().Field(field)
//......
 default:
  return nil, fmt.Errorf("</span>func %s <span class="hljs-keyword">not</span> support<span class="hljs-string">", param.MetricAggr.Func)
 }
 //生成聚合桶查询,每个桶至少要有一个文档,少了就不显示
 tsAggr := elastic.NewDateHistogramAggregation().
  Field(param.DateField).
  MinDocCount(1)

 //......
 //构建查询参数
 searchSource := elastic.NewSearchSource().
  Query(queryString).
  Aggregation("</span>ts<span class="hljs-string">", tsAggr) //设置自定义聚合名称为ts
 //......
 //发起请求
 result, err := search(ctx, indexArr, searchSource, param.Timeout, param.MaxShard)
 //......
 /** 提取ts中的bucket桶提取count和key也就是时间生成item返回
 "</span>aggregations<span class="hljs-string">" : {
     "</span>ts<span class="hljs-string">" : {
       "</span>buckets<span class="hljs-string">" : [
         {
           "</span>key_as_string<span class="hljs-string">" : "</span><span class="hljs-number">2025</span>-<span class="hljs-number">11</span>-05T14:<span class="hljs-number">30</span>:<span class="hljs-number">00.000</span>Z<span class="hljs-string">",
           "</span>key<span class="hljs-string">" : 1762353000000,
           "</span>doc_count<span class="hljs-string">" : 10
         }
       ]
     }
   }
  */
 js, err := simplejson.NewJson(result.Aggregations["</span>ts<span class="hljs-string">"])
 //......
 bucketsData, err := js.Get("</span>buckets<span class="hljs-string">").Array()
 return items, nil
}
</span></code></pre>
<h3 data-id="heading-10">告警规则添加</h3>
<p>了解了规则配置解析之后，我们再来了解后续步骤，即如何将规则持久化到<code>Nightingale</code>底层的数据库中，让告警监控的工作协程能够获取到这个规则进行定时查询和告警消息缓存。</p>
<p>对应的我们通过浏览器控台定位到接口映射为<code>http://127.0.0.1:17000/api/n9e/busi-group/1/alert-rules</code>，请求参数为一个比较大的<code>JSON</code>数组，为了更好的说明和解析，这里笔者也给出几个比较核心的部分以便于读者更准确的理解规则的存储过程。</p>
<p>先来看看参数的第一部分，可以看到这个规则通过cate即category指明数据源类型为elasticsearch，并通过datasource这个数组块指明等价匹配数据源-1也就是elasticsearch</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"cate"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"elasticsearch"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"datasource_queries"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"match_type"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">//精确匹配</span>
    <span class="hljs-attr">"op"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"in"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">//包含关系</span>
    <span class="hljs-attr">"values"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-number">1</span> <span class="hljs-comment">//数据源1也就是我们配置的elasticsearch</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
</code></pre>
<p>然后就是规则配置，对应的<code>rule_config</code>的<code>JSON</code>参数如下，这里笔者抽出核心的两个部分，第一个部分也就是上面规则查询的参数，对应的明细笔者上文已经详细解释过了，这里就不多做赘述，这里我们着重说明一下trigger，其内部有个expressions结合3个参数语义和浏览器界面即知晓这个就是触发条件的配置，他告知<code>Nightingale</code>在查询<code>count</code>大于0的时候即可触发告警：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"rule_config"</span>: {
    <span class="hljs-string">"queries"</span>: [{ //查询条件参数
      <span class="hljs-string">"prom_ql"</span>: <span class="hljs-string">""</span>,
      <span class="hljs-string">"severity"</span>: <span class="hljs-number">2</span>,
      <span class="hljs-string">"ref"</span>: <span class="hljs-string">"A"</span>,
      <span class="hljs-string">"index_type"</span>: <span class="hljs-string">"index"</span>,
      <span class="hljs-string">"value"</span>: {
        <span class="hljs-string">"func"</span>: <span class="hljs-string">"count"</span>
      },
      <span class="hljs-string">"unit"</span>: <span class="hljs-string">"none"</span>,
      <span class="hljs-string">"index"</span>: <span class="hljs-string">"java_app_logs"</span>,
      <span class="hljs-string">"date_field"</span>: <span class="hljs-string">"timestamp"</span>,
      <span class="hljs-string">"filter"</span>: <span class="hljs-string">"log_level:"</span>ERRO<span class="hljs-string">R""</span>,
      <span class="hljs-string">"interval"</span>: <span class="hljs-number">1800</span>
    }],
   //.......
    <span class="hljs-string">"triggers"</span>: [{
      <span class="hljs-string">"mode"</span>: <span class="hljs-number">0</span>,
      <span class="hljs-string">"expressions"</span>: [{ //当规则A查出来的值大于<span class="hljs-number">0</span>时触发告警
        <span class="hljs-string">"ref"</span>: <span class="hljs-string">"A"</span>,
        <span class="hljs-string">"comparisonOperator"</span>: <span class="hljs-string">"&gt;"</span>,
        <span class="hljs-string">"value"</span>: <span class="hljs-number">0</span>,
        <span class="hljs-string">"logicalOperator"</span>: <span class="hljs-string">"&amp;&amp;"</span>
      }],
      <span class="hljs-string">"severity"</span>: <span class="hljs-number">1</span>, //一级告警
      <span class="hljs-string">"recover_config"</span>: {
        <span class="hljs-string">"judge_type"</span>: <span class="hljs-number">0</span>
      },
      <span class="hljs-string">"join_ref"</span>: <span class="hljs-string">"A"</span>,
      <span class="hljs-string">"exp"</span>: <span class="hljs-string">"$A &gt; 0"</span>
    }],
    //.......
  },
</code></pre>
<p>最后一个部分也就是规则配置的调度算法，对应参数如下：</p>
<ol>
<li><code>cron_pattern</code>指明每15s执行一次</li>
<li><code>prom_for_duration</code>：持续时间为60s也就是4次调度都触发告警与之则告警</li>
<li><code>enable_days_of_weeks</code>:执行周期为一整周即周一到周日都有</li>
<li><code>enable_stimes</code>: 开始时间</li>
<li><code>enable_etimes</code>：结束时间</li>
</ol>

<pre><code class="hljs language-perl" lang="perl"> <span class="hljs-string">"cron_pattern"</span>: <span class="hljs-string">"@every 15s"</span>,
  <span class="hljs-string">"prom_for_duration"</span>: <span class="hljs-number">60</span>,
  <span class="hljs-string">"enable_days_of_weeks"</span>: [
    [
      <span class="hljs-string">"0"</span>,
      <span class="hljs-string">"1"</span>,
      <span class="hljs-string">"2"</span>,
      <span class="hljs-string">"3"</span>,
      <span class="hljs-string">"4"</span>,
      <span class="hljs-string">"5"</span>,
      <span class="hljs-string">"6"</span>
    ]
  ],
  <span class="hljs-string">"enable_stimes"</span>: [
    <span class="hljs-string">"00:00"</span>
  ],
  <span class="hljs-string">"enable_etimes"</span>: [
    <span class="hljs-string">"00:00"</span>
  ],
</code></pre>
<p>明确参数后，我们通过接口映射定位到后端的执行函数，也就是<code>alertRuleAddByFE</code>方法，这里笔者也贴出接口对应的映射配置和实际执行函数，保存规则的逻辑比较简单，即：</p>
<ol>
<li>解析参数并判空</li>
<li>调用<code>alertRuleAdd</code>保存规则</li>
<li>返回执行结果</li>
</ol>

<pre><code class="hljs language-go" lang="go">pages.POST(<span class="hljs-string">"/busi-group/:id/alert-rules"</span>, rt.auth(), rt.user(), rt.perm(<span class="hljs-string">"/alert-rules/add"</span>), rt.bgrw(), rt.alertRuleAddByFE)


<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rt *Router)</span></span> alertRuleAddByFE(c *gin.Context) {
 username := c.MustGet(<span class="hljs-string">"username"</span>).(<span class="hljs-type">string</span>)

 <span class="hljs-keyword">var</span> lst []models.AlertRule
 <span class="hljs-comment">//解析参数列表存储到lst这个规则结构体中</span>
 ginx.BindJSON(c, &amp;lst)
 <span class="hljs-comment">//如果参数为空直接返回异常</span>
 count := <span class="hljs-built_in">len</span>(lst)
 <span class="hljs-keyword">if</span> count == <span class="hljs-number">0</span> {
  ginx.Bomb(http.StatusBadRequest, <span class="hljs-string">"input json is empty"</span>)
 }

 bgid := ginx.UrlParamInt64(c, <span class="hljs-string">"id"</span>) <span class="hljs-comment">//获取对应group id</span>
 <span class="hljs-comment">//调用alertRuleAdd保存规则</span>
 reterr := rt.alertRuleAdd(lst, username, bgid, c.GetHeader(<span class="hljs-string">"X-Language"</span>))
 <span class="hljs-comment">//将结果渲染返回</span>
 ginx.NewRender(c).Data(reterr, <span class="hljs-literal">nil</span>)
}
</code></pre>
<p>宏观的了解整个流程之后，我们还是需要深入细节了解<code>alertRuleAdd</code>实现细节，其实这段逻辑和我们java开发日常的crud接口都差不多，本质上就是将参数绑定到go语言的dto上保存到数据库(默认为sqllite)，对应的映射转换细节如下：</p>
<ol>
<li>EnableStime和EnableEtime作为任务起止时间直接平迁</li>
<li>执行周期转为空格分隔</li>
<li>核心的告警规则查询条件和调度时间配置json即rule config直接序列化为JSON写入</li>
</ol>
<p>几个核心转换过程笔者也已图解的方式展示了一下，读者结合说明了解一下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/263142cd75f947a29278b82ebf34ddcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=cfCHrNPIXBXvmvLcZy4sq3d%2B2VI%3D" alt="" loading="lazy"/></p>
<p>对应笔者也给出<code>router_alert_rule.go</code>中<code>alertRuleAdd</code>的实现，可以看到如下步骤：</p>
<ol>
<li>这个函数内部设置了<code>alertRule</code>对象的<code>CreateBy</code>和<code>UpdateBy</code></li>
<li>调用<code>FE2DB</code>生执行前端参数转为上图所示的数据结构</li>
<li>然后<code>AlertRule</code>调用<code>Add</code>写入<code>db</code>中，很明显这种设计让<code>AlertRule</code>具备持久化的能力，是一种具备充血模型的设计理念</li>
</ol>

<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(rt *Router)</span></span> alertRuleAdd(lst []models.AlertRule, username <span class="hljs-type">string</span>, bgid <span class="hljs-type">int64</span>, lang <span class="hljs-type">string</span>) <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span> {
 count := <span class="hljs-built_in">len</span>(lst) <span class="hljs-comment">//获取对应的规则切片长度</span>
 <span class="hljs-comment">// alert rule name -&gt; error string</span>
 reterr := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>)
 <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; count; i++ {
  lst[i].Id = <span class="hljs-number">0</span> <span class="hljs-comment">//设置规则id和配置用户名信息</span>
  lst[i].GroupId = bgid
  <span class="hljs-keyword">if</span> username != <span class="hljs-string">""</span> {
   lst[i].CreateBy = username <span class="hljs-comment">//绑定创建人username也就是root</span>
   lst[i].UpdateBy = username <span class="hljs-comment">//绑定修改人username也就是root</span>
  }
  <span class="hljs-comment">//价格lst转为封装db字段信息,例如起止时间 执行规则配置等信息,如果某条报错直接结束循环</span>
  <span class="hljs-keyword">if</span> err := lst[i].FE2DB(); err != <span class="hljs-literal">nil</span> {
   reterr[lst[i].Name] = i18n.Sprintf(lang, err.Error())
   <span class="hljs-keyword">continue</span>
  }
  <span class="hljs-comment">//存入数据库,返回写入结果</span>
  <span class="hljs-keyword">if</span> err := lst[i].Add(rt.Ctx); err != <span class="hljs-literal">nil</span> {
   reterr[lst[i].Name] = i18n.Sprintf(lang, err.Error())
  } <span class="hljs-keyword">else</span> {
   reterr[lst[i].Name] = <span class="hljs-string">""</span>
  }
 }
 <span class="hljs-keyword">return</span> reterr
}
</code></pre>
<p>结合上述的整体说明笔者也给出FE2DB的函数实现细节，大体就是上图所示的映射转换，读者可结合注释回顾一下：</p>
<pre><code class="hljs language-perl" lang="perl">func (ar *AlertRule) FE2DB() error {
 <span class="hljs-regexp">//</span>如果起止时间存在则将起止时间设置到调用的ar上,也就是我们配置的enable_stimes和enable_etimes
 <span class="hljs-keyword">if</span> len(ar.EnableStimesJSON) &gt; <span class="hljs-number">0</span> {
  ar.EnableStime = strings.Join(ar.EnableStimesJSON, <span class="hljs-string">" "</span>)
  ar.EnableEtime = strings.Join(ar.EnableEtimesJSON, <span class="hljs-string">" "</span>)
 } <span class="hljs-keyword">else</span> {
  ar.EnableStime = ar.EnableStimeJSON
  ar.EnableEtime = ar.EnableEtimeJSON
 }
 //按照空格设置启用的星期,按照空格进行拼接,对应参数为 <span class="hljs-string">"enable_days_of_weeks"</span>: [
 <span class="hljs-regexp">//</span>      [
 <span class="hljs-regexp">//</span>        <span class="hljs-string">"0"</span>,
 <span class="hljs-regexp">//</span>        <span class="hljs-string">"1"</span>,
 <span class="hljs-regexp">//</span>        <span class="hljs-string">"2"</span>,
 <span class="hljs-regexp">//</span>        <span class="hljs-string">"3"</span>,
 <span class="hljs-regexp">//</span>        <span class="hljs-string">"4"</span>,
 <span class="hljs-regexp">//</span>        <span class="hljs-string">"5"</span>,
 <span class="hljs-regexp">//</span>        <span class="hljs-string">"6"</span>
 //      ]
 //    ],
 <span class="hljs-keyword">if</span> len(ar.EnableDaysOfWeeksJSON) &gt; <span class="hljs-number">0</span> {
  <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; len(ar.EnableDaysOfWeeksJSON); i++ {
   <span class="hljs-keyword">if</span> len(ar.EnableDaysOfWeeksJSON) == <span class="hljs-number">1</span> {
    ar.EnableDaysOfWeek = strings.Join(ar.EnableDaysOfWeeksJSON[i], <span class="hljs-string">" "</span>)
   } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span> i == len(ar.EnableDaysOfWeeksJSON)-<span class="hljs-number">1</span> {
     ar.EnableDaysOfWeek += strings.Join(ar.EnableDaysOfWeeksJSON[i], <span class="hljs-string">" "</span>)
    } <span class="hljs-keyword">else</span> {
     ar.EnableDaysOfWeek += strings.Join(ar.EnableDaysOfWeeksJSON[i], <span class="hljs-string">" "</span>) + <span class="hljs-string">";"</span>
    }
   }
  }
 } <span class="hljs-keyword">else</span> {
  ar.EnableDaysOfWeek = strings.Join(ar.EnableDaysOfWeekJSON, <span class="hljs-string">" "</span>)
 }

 //......

 

 //将rule_config转为json串绑定到RuleConfig上
 <span class="hljs-keyword">if</span> ar.RuleConfigJson != nil {
  b, err := json.Marshal(ar.RuleConfigJson)
  <span class="hljs-keyword">if</span> err != nil {
   <span class="hljs-keyword">return</span> fmt.Errorf(<span class="hljs-string">"marshal rule_config err:%v"</span>, err)
  }
  //绑定rule规则 <span class="hljs-string">"rule_config"</span>: {
  <span class="hljs-regexp">//</span>    <span class="hljs-string">"queries"</span>: [{
  <span class="hljs-regexp">//</span>      <span class="hljs-string">"prom_ql"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-regexp">//</span>      <span class="hljs-string">"severity"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-regexp">//</span>      <span class="hljs-string">"ref"</span>: <span class="hljs-string">"A"</span>,
  <span class="hljs-regexp">//</span>      <span class="hljs-string">"index_type"</span>: <span class="hljs-string">"index"</span>,
  <span class="hljs-regexp">//</span>      <span class="hljs-string">"value"</span>: {
  <span class="hljs-regexp">//</span>        <span class="hljs-string">"func"</span>: <span class="hljs-string">"count"</span>
  //      },
  <span class="hljs-regexp">//</span>      <span class="hljs-string">"unit"</span>: <span class="hljs-string">"none"</span>,
  <span class="hljs-regexp">//</span>      <span class="hljs-string">"index"</span>: <span class="hljs-string">"java_app_logs"</span>,
  <span class="hljs-regexp">//</span>      <span class="hljs-string">"date_field"</span>: <span class="hljs-string">"timestamp"</span>,
  <span class="hljs-regexp">//</span>      <span class="hljs-string">"filter"</span>: <span class="hljs-string">"log_level:"</span>ERROR<span class="hljs-string">""</span>,
  <span class="hljs-regexp">//</span>      <span class="hljs-string">"interval"</span>: <span class="hljs-number">1800</span>
  //    }],
  ar.RuleConfig = string(b)
  ar.PromQl = <span class="hljs-string">""</span>
 }

 //......

 <span class="hljs-keyword">return</span> nil
}
</code></pre>
<p>基于<code>FE2DB</code>生成数据映射对象后，就需要进行持久化，按照笔者的说法该模型会调用内置的Add将结构体持久化，对应的方法也位于<code>alert_rule.go</code>文件的<code>Add</code>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(ar *AlertRule)</span></span> Add(ctx *ctx.Context) <span class="hljs-type">error</span> {
 <span class="hljs-comment">//......</span>
 
 <span class="hljs-comment">//设置创建时间和更新时间</span>
 now := time.Now().Unix()
 ar.CreateAt = now
 ar.UpdateAt = now
 <span class="hljs-comment">//写入数据库 写入到alert_rule表</span>
 <span class="hljs-keyword">return</span> Insert(ctx, ar)
}
</code></pre>
<p>最终我们也可以在alert_rule看到这份信息：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c344bc2c117241dc8dc79f8419618886~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=pk7SEGqFyT6gP9PAQimrgFVWthc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">轮询监控告警工作过程</h3>
<p>完成的查询的任务创建之后，就到了<code>Nightingale</code>中最重要的一环，即基于规则进行告警监控，这个过程本质就是上述两个步骤的综合配置结果，即通过规则配置和插入，结合用户调测配置的查询规则进行周期性轮询并，针对查到的数据进行阈值判断，一旦发现结果超出阈值，则将结果写入缓存队列中，后续各种告警手段都会基于这个缓存进行告警输出。</p>
<p>这里笔者也给出<code>Nightingale</code>告警的宏观流程：</p>
<ol>
<li>基于之前写入数据库且缓存的rule对象生成job提交到调取器<code>scheduler</code>中</li>
<li><code>scheduler</code>定期执行这个<code>job</code></li>
<li><code>job</code>向<code>elasticsearch</code>发起请求获取结果</li>
<li>将触发阈值的结果封装成<code>DataResp</code>写入缓存<code>seriesStore</code>中</li>
<li>遍历<code>seriesStore</code>将其封装成事件写入一个协程安全的队列<code>eventQueue</code>中</li>
<li>后续<code>Nightingale</code>就会基于这个队列缓存进行数据库持久化或者告警操作</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d15b6f4d06324bef83b443b72244081f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763429841&amp;x-signature=HO%2Bo13J89UVYVe4i11hWrJxdP20%3D" alt="" loading="lazy"/></p>
<p>对应的我们先给出从缓存中获取rule并将其提交到调度器scheduler的代码，即位于alert_rule.go下的syncAlertRules函数，逻辑比较简单，从alertRuleCache拉取到规则后调用NewAlertRuleWorker提交到调度器即可：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(s *Scheduler)</span></span> syncAlertRules() {
 <span class="hljs-comment">//从缓存中拿到rule</span>
 ids := s.alertRuleCache.GetRuleIds() 
 <span class="hljs-comment">//.....</span>
 <span class="hljs-comment">//基于id拿到rule具体信息</span>
 <span class="hljs-keyword">for</span> _, id := <span class="hljs-keyword">range</span> ids { 
  rule := s.alertRuleCache.Get(id)
  <span class="hljs-comment">//.....</span>

  ruleType := rule.GetRuleType()
  <span class="hljs-keyword">if</span> rule.IsPrometheusRule() || rule.IsInnerRule() {
    <span class="hljs-comment">//.....</span>
   <span class="hljs-keyword">for</span> _, dsId := <span class="hljs-keyword">range</span> datasourceIds {
    <span class="hljs-comment">//.....</span>
    <span class="hljs-comment">//封装成cronjob添加</span>
    alertRule := NewAlertRuleWorker(rule, dsId, processor, s.promClients, s.ctx) 
    alertRuleWorkers[alertRule.Hash()] = alertRule
   }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> rule.IsHostRule() {
   <span class="hljs-comment">//.....</span>
  } <span class="hljs-keyword">else</span> {
   <span class="hljs-comment">//.....</span>
  }
 }
</code></pre>
<p>后续就会有一个协程定时调用eval.go的Eval方法，通过GetAnomalyPoint发起es查询，如果存在异常端点事件，则将其通过Processor.Handle封装成event缓存起来，等待Nightingale底层各种协程进行持久化、告警操作,对应笔者给出这几个步骤的核心代码断，读者可以结合注释了解一下：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(arw *AlertRuleWorker)</span></span> Eval() {
 <span class="hljs-comment">//......</span>
 <span class="hljs-comment">//根据数据源类型获取异常点anomalyPoints</span>
 <span class="hljs-keyword">switch</span> typ {
 <span class="hljs-keyword">case</span> models.PROMETHEUS:
 <span class="hljs-comment">//......</span>
 <span class="hljs-keyword">default</span>:
  <span class="hljs-comment">//触发es查询,anomalyPoints就是异常的端点信息(如果存在的话)</span>
  anomalyPoints, recoverPoints, err = arw.GetAnomalyPoint(cachedRule, arw.Processor.DatasourceId())
 }

 <span class="hljs-comment">//......</span>

 

 
 } <span class="hljs-keyword">else</span> {
 <span class="hljs-comment">//......</span>
 }
 <span class="hljs-comment">//处理异端点数据anomalyPoints,将其封装成event缓存,等待后续告警 持久化等各种操作</span>
 arw.Processor.Handle(anomalyPoints, <span class="hljs-string">"inner"</span>, arw.Inhibit)
}
</code></pre>
<p>对应的笔者也给出<code>GetAnomalyPoint</code>的实现细节，逻辑比较简单，整体就是触发es查询即<code>QueryData(上文告警规则调测介绍过，其底层es查询的逻辑)</code>，然后将其写入<code>seriesStore</code>中，然后结合rule对象通过<code>parser.CalcWithRid</code>查看结果是否触发阈值，如果触发则存入异常端点的切片<code>points</code>中返回：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(arw *AlertRuleWorker)</span></span> GetAnomalyPoint(rule *models.AlertRule, dsId <span class="hljs-type">int64</span>) ([]models.AnomalyPoint, []models.AnomalyPoint, <span class="hljs-type">error</span>) {
 <span class="hljs-comment">//......</span>

   <span class="hljs-comment">//触发es查询即可得到 异常端点的时间点和count</span>
   series, err := plug.QueryData(ctx, query)
   
  <span class="hljs-comment">//......</span>

  
   <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">len</span>(series); i++ {
    <span class="hljs-comment">//计算es结果的hash</span>
    serieHash := hash.GetHash(series[i].Metric, series[i].Ref)
    <span class="hljs-comment">//计算tag hash</span>
    tagHash := hash.GetTagHash(series[i].Metric)
    <span class="hljs-comment">//将本次count查询结果存储到序列桶中</span>
    seriesStore[serieHash] = series[i]

    <span class="hljs-comment">//......</span>
    <span class="hljs-comment">//将series的hash写入到seriesTagIndex中</span>
    seriesTagIndex[tagHash] = <span class="hljs-built_in">append</span>(seriesTagIndex[tagHash], serieHash) 
   }
   <span class="hljs-comment">//......</span>
  }

  <span class="hljs-comment">//......</span>

  <span class="hljs-keyword">if</span> !ruleQuery.ExpTriggerDisable {
   <span class="hljs-keyword">for</span> _, trigger := <span class="hljs-keyword">range</span> ruleQuery.Triggers {
    <span class="hljs-comment">//......</span>
    <span class="hljs-comment">//从标签seriesTagIndex中获取series的hash值</span>
    <span class="hljs-keyword">for</span> _, seriesHash := <span class="hljs-keyword">range</span> seriesTagIndex {
     <span class="hljs-comment">//......</span>
     
     <span class="hljs-comment">//通过表达式结合查询结果查看是否满足条件</span>
     isTriggered := parser.CalcWithRid(trigger.Exp, m, rule.Id)
     <span class="hljs-comment">//......</span>
     <span class="hljs-comment">//将结果封装成point,并追加到切片中</span>
     point := models.AnomalyPoint{
      Key:           sample.MetricName(),
      Labels:        sample.Metric,
      Timestamp:     <span class="hljs-type">int64</span>(ts),
      Value:         value,
      Values:        values,
      Severity:      trigger.Severity,
      Triggered:     isTriggered,
      Query:         fmt.Sprintf(<span class="hljs-string">"query:%+v trigger:%+v"</span>, queries, trigger),
      RecoverConfig: trigger.RecoverConfig,
      ValuesUnit:    valuesUnitMap,
     }
     <span class="hljs-comment">//如果符合条件则将其追加到points中</span>
     <span class="hljs-keyword">if</span> isTriggered {
      points = <span class="hljs-built_in">append</span>(points, point)
     } <span class="hljs-keyword">else</span> {
     <span class="hljs-comment">//......</span>
     }
    }
   }
  }

  <span class="hljs-comment">//......</span>
 <span class="hljs-comment">//返回point</span>
 <span class="hljs-keyword">return</span> points, recoverPoints, <span class="hljs-literal">nil</span>
}
</code></pre>
<p>最后就是事件告警了，逻辑比较简单，基于上一步的异常端点<code>anomalyPoints</code>遍历生成<code>event</code>写入缓存中：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(p *Processor)</span></span> Handle(anomalyPoints []models.AnomalyPoint, from <span class="hljs-type">string</span>, inhibit <span class="hljs-type">bool</span>) {
  <span class="hljs-comment">//......</span>

 <span class="hljs-comment">// 遍历anomalyPoints，根据 event 的 tag 将 events 分组，处理告警抑制的情况</span>
 eventsMap := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>][]*models.AlertCurEvent)
 <span class="hljs-keyword">for</span> _, anomalyPoint := <span class="hljs-keyword">range</span> anomalyPoints {
  <span class="hljs-comment">//封装成事件</span>
  event := p.BuildEvent(anomalyPoint, from, now, ruleHash) <span class="hljs-comment">//基于异常点生成告警事件</span>
  <span class="hljs-comment">//......</span>

  

  
  }

  <span class="hljs-comment">//......</span>
  <span class="hljs-comment">//将anomalyPoint哈希运算存入eventsMap</span>
  tagHash := TagHash(anomalyPoint)
  <span class="hljs-comment">//追加到对应tagHash(也就是我们的规则标签的hash)</span>
  eventsMap[tagHash] = <span class="hljs-built_in">append</span>(eventsMap[tagHash], event)
 }
 <span class="hljs-comment">//遍历告警事件的map并处理事件，其底层就是将其存入到一个协程安全的缓存队列中</span>
 <span class="hljs-keyword">for</span> _, events := <span class="hljs-keyword">range</span> eventsMap {
  p.handleEvent(events)
 }

  <span class="hljs-comment">//......</span>
}
</code></pre>
<h2 data-id="heading-12">小结</h2>
<p>本文详细的介绍了<code>Nightingale</code>的日志告警规则配置和实现细节，基于这个契机，笔者也来谈谈读者常问的一个问题——如何较好的去掌握一门技术，作为一个计算机从业者，私以为学习一门技术的本质无非是想尽一切去了解它，让自己拥有白盒的视角去看待这些原本黑盒的技术。</p>
<p>以本次<code>Nightingale</code>这个告警框架为例，读者可以非常直观的看到笔者的学习过程，本质上就是：</p>
<ol>
<li>结合一手官网的文档去学习和应用</li>
<li>通过这些应用找到请求入口</li>
<li>结合入口定位到源码入口并针对每个接口的实现细节进行阅读和具象化梳理</li>
</ol>
<p>最终读者眼中的这些工具，在笔者眼里就变为一个<code>http</code>请求在<code>go</code>应用框架的协程中的各种数据流扭转和<code>es</code>交互请求和响应，后续无论是运用还是问题排查也都是以这种视角游刃有余的去使用和排查。</p>
<p>总结源码 结合接口推断保存查询 数据流向哪里来 推测告警或者动作的源头 从而了解源码原理</p>
<p>我是 <strong>SharkChili</strong> ，Java 开发者，<strong>Java Guide</strong> 开源项目维护者。欢迎关注我的公众号：<strong>写代码的SharkChili</strong>，也欢迎您了解我的开源项目 mini-redis：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fshark-ctrl%2Fmini-redis" target="_blank" title="https://github.com/shark-ctrl/mini-redis" ref="nofollow noopener noreferrer">github.com/shark-ctrl/…</a>。</p>
<p>为方便与读者交流，现已创建读者群。关注下方公众号获取我的联系方式，添加时备注<strong>加群</strong>即可加入。</p>
<h2 data-id="heading-13">参考</h2>
<p>夜莺监控官网:<a href="https://link.juejin.cn?target=https%3A%2F%2Fn9e.github.io%2Fzh%2Fdocs%2Fprologue%2Fintroduction%2F" target="_blank" title="https://n9e.github.io/zh/docs/prologue/introduction/" ref="nofollow noopener noreferrer">n9e.github.io/zh/docs/pro…</a></p>
<p>夜莺告警规则配置:<a href="https://link.juejin.cn?target=https%3A%2F%2Fflashcat.cloud%2Fdocs%2Fcontent%2Fflashcat-monitor%2Fnightingale-v7%2Fusage%2Falarm-management%2Falert-rules%2Frule-configuration%2Fbusiness%2Fes-alarm-rules%2F" target="_blank" title="https://flashcat.cloud/docs/content/flashcat-monitor/nightingale-v7/usage/alarm-management/alert-rules/rule-configuration/business/es-alarm-rules/" ref="nofollow noopener noreferrer">flashcat.cloud/docs/conten…</a></p>
<p>夜莺日志告警:<a href="https://link.juejin.cn?target=https%3A%2F%2Fn9e.github.io%2Fzh%2Fdocs%2Fusage%2Flogs-alerting%2F" target="_blank" title="https://n9e.github.io/zh/docs/usage/logs-alerting/" ref="nofollow noopener noreferrer">n9e.github.io/zh/docs/usa…</a></p>
<p>使用SkyWalking和Elasticsearch实现全链路监控 :<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fes%2Fuse-cases%2Fuse-skywalking-to-implement-end-to-end-monitoring-on-elasticsearch" target="_blank" title="https://help.aliyun.com/zh/es/use-cases/use-skywalking-to-implement-end-to-end-monitoring-on-elasticsearch" ref="nofollow noopener noreferrer">help.aliyun.com/zh/es/use-c…</a></p>
<p>《Elasticsearch实战第二版》</p>
<p>一篇文章学会黑盒测试、白盒测试（含实操） :<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fu010924879%2Farticle%2Fdetails%2F146502076" target="_blank" title="https://blog.csdn.net/u010924879/article/details/146502076" ref="nofollow noopener noreferrer">blog.csdn.net/u010924879/…</a></p>
<p>DDD领域驱动设计：贫血模型和充血模型 :<a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F464914100" target="_blank" title="https://zhuanlan.zhihu.com/p/464914100" ref="nofollow noopener noreferrer">zhuanlan.zhihu.com/p/464914100</a></p>
<p>JSON文件加注释的7种方法 :<a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2FDream_fengyuefei%2Farticle%2Fdetails%2F92626804" target="_blank" title="https://blog.csdn.net/Dream_fengyuefei/article/details/92626804" ref="nofollow noopener noreferrer">blog.csdn.net/Dream_fengy…</a></p>
<p>本文使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarkdown.com.cn" target="_blank" title="https://markdown.com.cn" ref="nofollow noopener noreferrer">markdown.com.cn</a> 排版</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【高斯泼溅】从一张好照片开始：Mapmost 3DGS建模之图像采集指南]]></title>    <link>https://juejin.cn/post/7571429745231511588</link>    <guid>https://juejin.cn/post/7571429745231511588</guid>    <pubDate>2025-11-12T08:27:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571429745231511588" data-draft-id="7571475192489852938" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【高斯泼溅】从一张好照片开始：Mapmost 3DGS建模之图像采集指南"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-12T08:27:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mapmost"/> <meta itemprop="url" content="https://juejin.cn/user/1679709496936343"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【高斯泼溅】从一张好照片开始：Mapmost 3DGS建模之图像采集指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1679709496936343/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mapmost
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T08:27:15.000Z" title="Wed Nov 12 2025 08:27:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Mapmost 3DGS 建模工具自上线以来，已帮助不少用户生成高保真3DGS模型。</p>
<p>但在实际使用中，部分用户对如何采集合适的图像数据仍有疑问：<strong>拍多少张？用什么设备？怎么拍才能保证效果？</strong></p>
<p>别担心——<strong>高质量建模，从一张好照片开始</strong>。3DGS技术完全依赖彩色图像重建几何与纹理。图像拍得好，模型才精细；覆盖不完整，细节就丢失。<br/>
为此，我们整理了一份简单易用的<strong>图像采集指南</strong>，无论你是用无人机航拍园区，还是拿手机拍一个玩偶，都能轻松上手！</p>
<h2 data-id="heading-0">通用原则：所有设备都适用</h2>
<p><strong><em>1.</em> 只拍静态场景</strong><br/>
被拍摄物体或场景应当尽量保持<strong>静止状态</strong>。行人、车辆、飘动的旗帜……动态元素会导致“鬼影”或空洞，建议规避。</p>
<p><strong><em>2.</em> 光线要稳，别忽明忽暗</strong></p>
<ul>
<li><strong>户外：<strong>选</strong>阴天或多云</strong>， 避免强光直射造成高光过曝、阴影过重或光照闪烁；</li>
<li><strong>室内：<strong>用</strong>稳定的人工光源</strong>， 避免频繁开关或闪烁光源，防止图像间光照不一致。</li>
<li><strong>曝光模式：锁定 ISO、快门、白平衡</strong>，避免光照跳变。</li>
</ul>
<p><strong><em>3.</em></strong> <strong>画质要清晰</strong><br/>
模糊、过曝、抖动的照片直接拖累重建效果。有条件的话，<strong>上三脚架</strong>，或者<strong>开启相机防抖</strong>。</p>
<p><em>｜小贴士：不需要深度图、激光点云——<strong>普通彩色照片即可</strong>！</em></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39e133bae4e349429372399a69bf7aac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=4EnoM9XNCZpbvNcxbPXQpXvyCJ4%3D" alt="" loading="lazy"/></p>
<p><em>通用的拍摄原则</em></p>
<h2 data-id="heading-1">典型场景推荐采集方案</h2>
<h3 data-id="heading-2"><strong>方案一： 大场景？交给无人机！</strong></h3>
<p><strong>适用场景</strong>：园区、建筑群、景区、线性工程等大地理范围场景。</p>
<p><strong>推荐设备：</strong></p>
<ul>
<li>大疆 Mavic / Air 系列（2000 万像素以上）；</li>
<li>建议配备 RTK 模块（非必需）：厘米级定位，让模型几何更准、拼接更稳。</li>
</ul>
<p><strong>怎么飞？记住这几点</strong></p>
<ul>
<li><strong>航线类型：<strong>推荐使用大疆飞控软件DJI Pilot自带的</strong>面状倾斜航线</strong>，参数与传统测绘行业标准的五向及多视角倾斜摄影航线基本一致；</li>
<li><strong>飞行高度：120 米以下</strong>（按场景灵活调整），更低的飞行高度往往意味着更多的采集数据与更高的模型质量；</li>
<li>**航线重叠率：**航向与旁向重叠度均设置在 <strong>70%-80% 区间</strong> ；</li>
<li><strong>云台俯仰倾角：-45°，</strong> 可根据场景在 -30° 至 -60° 范围内微调 <strong>；</strong></li>
<li><strong>拍照模式：<strong>建议选择</strong>等距间隔拍摄。</strong></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c4e3d524ce8492c99b78de2a31c41a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=q1iKrZH1SrrcYzlDrhroJ%2FDewtg%3D" alt="" loading="lazy"/></p>
<p><em>大疆飞控航线设置界面</em></p>
<p><strong>进阶技巧</strong></p>
<ul>
<li>
<p>若追求更高精度，可结合<strong>手动飞行或立体环绕航线</strong>（围绕重点建筑做多圈、多高度环绕），同样保证70%以上的重叠度，增强侧面与顶部细节；</p>
</li>
<li>
<p>对于复杂结构（如古建筑、雕塑），可以<strong>手动近距离补拍</strong>，以提升局部分辨率。</p>
<p><strong><em>01 面状倾斜航线及建模效果</em></strong></p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/753906e68e1c49b9a07959118e9bd1ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=jvOGojDooK5zMfYQkYXW7aqrPKc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89f28e3837934f72955a141d32599e00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=VXz1kTG%2BlC6T72rhCFF0zsTUq5o%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef29bb6311844c5fa79bc4ac9f1a8e3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=TCBGDvAFDeFwXEtFdTr4QgpnUh0%3D" alt="动图封面" loading="lazy"/></p>
<p><em>华谊</em></p>
<p><em><strong>02 面状倾斜+立体环绕的复合航点及建模效果</strong></em></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dbd4b2d2c46144e081927266932cf262~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=KM6z4C%2F9zqbeOU5djzXQr15HbCM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bdafed29b964f149cbe0dc4c8b4843b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=DFfPNzqce0vTW3AMA17fpCx5uxE%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad0a5fc6e73b4fc6883ddc4dc6d535e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=luJ3NOlcMrAiWj4%2F6xDBBYqWFGA%3D" alt="动图封面" loading="lazy"/></p>
<p><em>月光码头</em></p>
<p><em><strong>03 面状倾斜+手动补拍的复合航点及建模效果</strong></em></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d753d7dba4d4927bb7d97537d2a7b97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=Ez4nvVBwcZPygUElT7I9dxOeJjs%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19013eb55991478a8d5b546a20557a12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=JwVk77mdnXLDu06F%2Bpy34HOkI34%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6da1ee78812c4fc8bf1c9a5090ae22cd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=N5k3NQyfpJv1qqCk4itVY8%2FNtpU%3D" alt="动图封面" loading="lazy"/></p>
<p><em>石狮子</em></p>
<h3 data-id="heading-3"><strong>方案二：小场景？手机也能搞定！</strong></h3>
<p><strong>适用场景</strong>：室内空间、文物、设备、小型建筑等。</p>
<p>**支持设备：**智能手机、运动相机、数码相机均可，<strong>无需专业设备</strong>！</p>
<p><strong>拍摄口诀：绕着拍 + 多角度 + 高重叠</strong></p>
<ul>
<li><strong>360°环绕目标，<strong>每张与前一张重叠</strong>50%以上；</strong></li>
<li>**高低结合：**蹲下拍底部，举高拍顶部，别留死角；</li>
<li>**对象必须静止：**拍花瓶可以， 拍猫不可以——如果它乱动的话。</li>
</ul>
<p><strong>建议数量</strong>：50–500 张，视场景复杂度而定。<br/>
<strong>避坑提醒</strong>：关闭 HDR、美颜、夜景模式——这些“智能优化”反而会干扰重建！</p>
<p><strong><em>手持设备推荐采集点位及建模效果</em></strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7039a367e9674f6e9e3ba0947fd08e63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=MP9Z54WjvifMF33AdCGKCNYmVBk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7bf79844f35645529e46c87de2c316c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=TIep6eH3SouOY463eQwkzdeEWn8%3D" alt="动图封面" loading="lazy"/></p>
<p>玩偶</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1194f6130481430e91cc83691edca541~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=2JQrljhvWotWA46cNvbTXK%2BybOo%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b96ddd8c4e7241c5b85682754a32658a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=9mkokWzwSZge1MPmc2K%2FIPwUizM%3D" alt="动图封面" loading="lazy"/></p>
<p><em>人物</em></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25623265d238453c80c3225c0eadcb45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=5A97BzceN8EuqWW%2Fy0k5zVsRn%2FI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a79c93d0d09b49ffb4b138b3b62ec23c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=KbhX5e7Nmoty7zmCnZJ%2FtkvwU4U%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4db2888bb53f4a18922e95f6a9b6915d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWFwbW9zdA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763540835&amp;x-signature=NFiFWwJnL1vBUYC4W%2FzLdqqTtKM%3D" alt="动图封面" loading="lazy"/></p>
<p><em>活动室</em></p>
<h2 data-id="heading-4"><strong>现在就开始吧！</strong></h2>
<p>在导入 Mapmost 3DGS 建模工具前，请确认：</p>
<ul>
<li>所有图像放在<strong>一个文件夹</strong>；</li>
<li>无严重模糊、过曝、遮挡及光照变化；</li>
<li>无人机照片<strong>保留 EXIF 元信息</strong>（如经纬高、姿态角等）；</li>
<li>手持设备采集时已确保目标对象在拍摄过程中未移动。</li>
</ul>
<p>确认完毕后，<strong>一键上传至 Mapmost 3DGS 建模工具</strong>，剩下的交给我们——无需调参，无需干预，自动输出<strong>高质量 3DGS 模型</strong>。</p>
<p>申请试用，请至<a href="https://link.juejin.cn?target=http%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fwww.mapmost.com%2F%2523%2F" target="_blank" title="http://link.zhihu.com/?target=https%3A//www.mapmost.com/%23/" ref="nofollow noopener noreferrer">Mapmost</a>官网联系客服</p>
<p>**特别预告：**Mapmost Model Online 在线体验版 ，11月上线倒计时～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kubernetes无缝集成Harbor，实现CI/CD流水线]]></title>    <link>https://juejin.cn/post/7571005216910917651</link>    <guid>https://juejin.cn/post/7571005216910917651</guid>    <pubDate>2025-11-11T06:45:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571005216910917651" data-draft-id="7571304204720521270" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kubernetes无缝集成Harbor，实现CI/CD流水线"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T06:45:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kubernetes无缝集成Harbor，实现CI/CD流水线
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T06:45:57.000Z" title="Tue Nov 11 2025 06:45:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    12
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Harbor 作为企业级的容器镜像仓库，在 Kubernetes 生态中扮演着核心的镜像管理角色。下面这个表格能帮你快速抓住其核心价值和在案例中的体现：</p>






























<table><thead><tr><th>特性维度</th><th>核心价值</th><th>在线书店案例体现</th></tr></thead><tbody><tr><td><strong>统一镜像源</strong></td><td>为集群所有节点提供稳定、快速的私有镜像拉取源，避免依赖公网。</td><td>所有服务镜像（如<code>book-service</code>, <code>user-service</code>）均从内部Harbor拉取。</td></tr><tr><td><strong>基于项目的访问控制 (RBAC)</strong></td><td>实现镜像的权限隔离，不同团队管理各自项目。</td><td>为前端、后端团队创建独立项目，成员只能访问被授权的项目。</td></tr><tr><td><strong>安全扫描</strong></td><td>集成漏洞扫描工具，提升供应链安全。</td><td>推送镜像时自动扫描，阻止含高危漏洞的镜像部署。</td></tr><tr><td><strong>高可用与持久化</strong></td><td>确保镜像仓库稳定运行，数据不丢失。</td><td>采用外部对象存储和数据库，即使Pod重建数据也完好。</td></tr></tbody></table>
<p>下面，我们以一个名为“BookStore”的<strong>在线书店微服务项目</strong>为例，详细介绍如何从零搭建Harbor，并将其无缝集成到Kubernetes集群中，实现CI/CD流水线。</p>
<h3 data-id="heading-0">🔧 安装与配置 Harbor</h3>
<h4 data-id="heading-1">1. 选择部署模式与前提准备</h4>
<p>首先，根据你的环境选择最合适的部署方式：</p>




















<table><thead><tr><th>部署方式</th><th>适用场景</th><th>关键步骤/命令</th></tr></thead><tbody><tr><td><strong>Helm Chart (K8s内)</strong></td><td>生产环境，希望与K8s统一管理。</td><td><code>helm repo add harbor https://helm.goharbor.io</code></td></tr><tr><td><strong>Docker Compose</strong></td><td>开发、测试环境，快速独立部署。</td><td>下载离线包，编辑<code>harbor.yml</code>，运行<code>./install.sh</code>。</td></tr></tbody></table>
<p><strong>前提准备</strong>：确保你的服务器已安装符合版本的 Docker 和 Docker Compose 。</p>
<h4 data-id="heading-2">2. 关键配置详解</h4>
<p>在启动安装前，需要仔细配置 <code>harbor.yml</code>（Docker Compose方式）或自定义的 <code>values.yaml</code>（Helm方式）。以下是几个关键配置点：</p>
<ul>
<li><strong>外部访问与证书</strong>：生产环境<strong>必须启用HTTPS</strong>。</li>
<li><strong>持久化存储</strong>：必须为 Harbor 配置持久化存储，以防止数据丢失 。</li>
<li><strong>管理员密码</strong>：<strong>务必修改</strong>默认的管理员密码（<code>harborAdminPassword</code>）。</li>
</ul>
<p>配置完成后，执行安装脚本（Docker Compose方式）或 Helm 命令即可启动所有服务。通过 <code>docker-compose ps</code>或 <code>kubectl get pods -n harbor</code>确认所有组件状态为 <code>Running</code>或 <code>Ready</code>。</p>
<h3 data-id="heading-3">📥 集成 Harbor 与 Kubernetes</h3>
<p>要让 Kubernetes 集群能够从私有的 Harbor 仓库拉取镜像，需要进行如下配置，其核心流程是通过创建一个包含 Harbor 认证信息的 Secret 来实现的：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/133069af87f241478f63a34349a6ca97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTmqZjlrZDnmq4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449386&amp;x-signature=kZ%2FcDl5oriUEeH35KHZ2Pbvea1w%3D" alt="image.png" loading="lazy"/></p>
<p>具体操作步骤如下：</p>
<ol>
<li>
<p><strong>创建镜像拉取密钥（ImagePullSecret）</strong></p>
<p>在打算部署应用的命名空间下，创建一个 <code>docker-registry</code>类型的 Secret 。</p>
<pre><code class="hljs language-ini" lang="ini">kubectl create secret docker-registry harbor-regcred \
  <span class="hljs-attr">--docker-server</span>=harbor.yourcompany.com \
  <span class="hljs-attr">--docker-username</span>=admin \
  <span class="hljs-attr">--docker-password</span>=yourpassword \
  <span class="hljs-attr">--namespace</span>=your-namespace
</code></pre>
</li>
<li>
<p><strong>在应用部署中引用该 Secret</strong></p>
<p>在你的 Deployment YAML 中，通过 <code>imagePullSecrets</code>字段指明使用刚才创建的 Secret 。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">book-service</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">book-service</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">harbor.yourcompany.com/bookstore/book-service:v1.0.0</span> <span class="hljs-comment"># 必须是完整地址</span>
      <span class="hljs-attr">imagePullSecrets:</span> <span class="hljs-comment"># 引用密钥</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">harbor-regcred</span>
</code></pre>
<p>请注意，<code>image</code>字段必须是 <strong>完整的镜像地址</strong>，包含仓库地址、项目路径和标签 。</p>
</li>
</ol>
<h3 data-id="heading-4">🚀 项目实战：在线书店的镜像管理</h3>
<p>假设你正在部署上述“在线书店”应用，它包含 <code>book-service</code>（图书服务）和 <code>user-service</code>（用户服务）。</p>
<ol>
<li>
<p><strong>在 Harbor 中创建项目</strong></p>
<p>登录 Harbor Web UI，为“在线书店”创建两个项目：<code>bookstore/backend</code>和 <code>bookstore/frontend</code>，并分别为后端和前端开发团队配置推送和拉取权限。</p>
</li>
<li>
<p><strong>推送镜像到 Harbor</strong></p>
<p>在 CI/CD 流水线或开发者本地，构建好镜像后，将其推送到 Harbor 对应的项目中 。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 为本地镜像打上符合Harbor规范的标签</span>
docker tag book-service:latest harbor.yourcompany.com/bookstore/backend/book-service:v1.0.0
<span class="hljs-comment"># 2. 登录Harbor（需要先在客户端配置信任证书或insecure-registry）</span>
docker login harbor.yourcompany.com
<span class="hljs-comment"># 3. 推送镜像</span>
docker push harbor.yourcompany.com/bookstore/backend/book-service:v1.0.0
</code></pre>
</li>
<li>
<p><strong>在 Kubernetes 中部署</strong></p>
<p>编写 Deployment YAML 文件，<code>image</code>字段指定为 Harbor 中的镜像地址，并正确引用 <code>imagePullSecrets</code>，然后应用配置 。</p>
<pre><code class="hljs">kubectl apply -f book-service-deployment.yaml -n bookstore
</code></pre>
</li>
</ol>
<h3 data-id="heading-5">🛡️ 企业级增强功能与高可用</h3>
<ul>
<li><strong>启用漏洞扫描</strong>：在 Harbor 中启用 Trivy 等扫描器，并配置策略，阻止携带高危漏洞的镜像被拉取 。</li>
<li><strong>高可用与性能优化</strong>：对于生产环境，应考虑 Harbor 组件本身的高可用 。</li>
</ul>
<h3 data-id="heading-6">🧩 常见问题排查 (Troubleshooting)</h3>
<ul>
<li>
<p><strong>Pod 状态为 <code>ImagePullBackOff</code>或 <code>ErrImagePull</code></strong>：</p>
<ul>
<li><strong>检查镜像地址和标签</strong>：使用 <code>docker pull &lt;镜像完整地址&gt;</code>在节点上手动测试。</li>
<li><strong>检查 Secret</strong>：确认 Secret 所在命名空间与 Pod 一致，且用户名密码正确。</li>
<li><strong>检查证书</strong>：确保 Kubernetes 节点信任 Harbor 的 HTTPS 证书 。</li>
</ul>
</li>
<li>
<p><strong>Harbor 服务无法访问</strong>：</p>
<ul>
<li>检查 Ingress Controller 或 NodePort 服务是否正常 。</li>
</ul>
</li>
<li>
<p><strong>推送镜像失败</strong>：</p>
<ul>
<li>检查客户端 Docker 守护进程的 <code>insecure-registries</code>配置（仅限 HTTP 或自签名证书测试环境）或是否信任了 Harbor 的 CA 证书 。</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 的内存是怎么回事儿，简单给你讲明白——它给那些Widget分配和释放内存的机制]]></title>    <link>https://juejin.cn/post/7570984257666564142</link>    <guid>https://juejin.cn/post/7570984257666564142</guid>    <pubDate>2025-11-11T01:41:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570984257666564142" data-draft-id="7569087944159526938" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 的内存是怎么回事儿，简单给你讲明白——它给那些Widget分配和释放内存的机制"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-11T01:41:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JarvanMo"/> <meta itemprop="url" content="https://juejin.cn/user/2348212565845704"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 的内存是怎么回事儿，简单给你讲明白——它给那些Widget分配和释放内存的机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2348212565845704/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JarvanMo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T01:41:24.000Z" title="Tue Nov 11 2025 01:41:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果你发布 Flutter 应用，那你肯定关心这些：<strong>画面不卡顿</strong>（不掉帧）、<strong>屏幕打开要够快</strong>，以及<strong>用户能留得住</strong>。</p>
<p>但大多数人忽略了一个<strong>不起眼却非常关键</strong>的点：<strong>你的应用是怎么分配和释放内存的</strong>。</p>
<p><strong>如果你不理它</strong>，你会一直追着那些<strong>治标不治本</strong>的“假优化”跑（比如狂写 <code>setState</code>、搞各种“小聪明”），但你的应用<strong>依然会卡顿</strong>。</p>
<p><strong>如果你搞懂了它</strong>，你就能<strong>彻底消除界面卡顿</strong>，<strong>阻止内存泄漏</strong>，然后<strong>自信满满地发布你的应用！</strong></p>
<p><strong>来都来了，快关注公众号：OpenFlutter吧</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6afd8a9a467b42ce9ae79b5aedf95399~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFydmFuTW8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763430084&amp;x-signature=3JAFvt74K1KVb%2FbvdsFo%2BuVnQoU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">🏗️ 快速真相：Widgets 是<strong>蓝图</strong>，不是<strong>大石头</strong>！</h2>
<p>Flutter 的 <strong>Widgets</strong>（小部件）其实只是<strong>界面的“不可变描述”</strong> ，相当于<strong>设计图纸</strong>。真正<strong>又重又“长寿”</strong> （长时间存在）的东西，都藏在底层的 <strong>Element</strong>（元素）和 <strong>RenderObject</strong>（渲染对象）层。</p>
<p>框架会<strong>重复使用</strong>这些底层对象，所以就算你<strong>频繁重建</strong>（rebuild）界面，也不会让内存爆炸。</p>
<hr/>
<h2 data-id="heading-1">❓ 随堂测验 #1</h2>
<p><strong>Q：</strong> <code>StatelessWidget</code> 和 <code>StatefulWidget</code> 哪个更耗内存？</p>
<p><strong>A：</strong> <strong><code>StatefulWidget</code></strong> 更耗内存。因为它多了一个 <strong><code>State</code></strong> 对象，这个对象会一直<strong>粘在元素树</strong>上，并且它会<strong>持有</strong>（引用）<strong>控制器、监听器</strong>和<strong>数据</strong>等等。</p>
<h3 data-id="heading-2">🛠️ 今天就试试这样做：</h3>
<ul>
<li>尽量使用 <strong><code>const</code> 构造函数</strong>。这样可以避免重复创建完全一样的 Widget 对象来浪费内存。</li>
<li>能用<strong>无状态</strong>（Stateless）就用无状态；真需要<strong>有状态</strong>（Stateful）时，要<strong>有意识地</strong>控制你在 <code>State</code> 里放了什么东西。</li>
</ul>
<hr/>
<h2 data-id="heading-3">💨 为什么你不该再害怕重建（Rebuilds）</h2>
<p>如果你想要<strong>更流畅的画面</strong>（smoother frames），你就应该放下对重建的恐惧。</p>
<p>Dart 语言的<strong>垃圾回收机制（GC）<strong>是</strong>“分代”</strong> （generational）的：</p>
<ul>
<li>它会把<strong>小而短命</strong>的对象放在**“新生代”**（new space），用一个很快的“清道夫”机制迅速清理掉。</li>
<li>那些**“长寿”<strong>的对象会被提升到</strong>“老年代”**（old space），用一个并发的“标记-清除/整理”机制来收集。</li>
</ul>
<p><strong>翻译一下：</strong> 创建<strong>大量短命的 Widget 对象是没问题的</strong>！真正伤内存的是那些<strong>体积大</strong>、<strong>被提升</strong>（Promoted）到老年代，然后<strong>长期存在</strong>或<strong>不断地创建/销毁</strong>的分配。</p>
<h3 data-id="heading-4">📝 举个例子：</h3>
<ul>
<li>在 <code>build()</code> 方法里<strong>创建一个小 Widget</strong> ≈ <strong>很便宜</strong>（内存消耗低）。</li>
<li>在 <code>build()</code> 里<strong>创建一个 10k 项的模型列表</strong>，或者<strong>解码一张 4K 大图</strong> ≈ <strong>很昂贵</strong>（内存消耗高），而且<strong>很可能被提升到老年代</strong>。</li>
</ul>
<h3 data-id="heading-5">🛠️ 今天就试试这样做：</h3>
<ul>
<li>
<p>把<strong>重度分配</strong>（heavy allocations）<strong>移出热点路径</strong>（off the hot path）：</p>
<ul>
<li>在 <code>initState</code> 里提前算好列表。</li>
<li>使用 <strong><code>memoized selectors</code></strong>（记忆化选择器，避免重复计算）。</li>
<li><strong>不要</strong>在渲染时（paint time）才去解码巨大的图片。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-6">🗑️ 2025 年依然能拯救应用的“神技”：<code>dispose()</code></h2>
<p>任何你创建出来、用于<strong>监听、计时</strong>，或者<strong>持有原生资源</strong>（native resources）的对象，都<strong>必须</strong>在 <strong><code>dispose()</code></strong> 方法里释放掉！</p>
<p>这包括：<code>AnimationController</code>、<code>ScrollController</code>、<code>TextEditingController</code>、<code>FocusNode</code>、<code>StreamSubscription</code>、<code>Timer</code>、<code>platform channels</code>等等。</p>
<p><strong>做不到这点</strong>，就会导致<strong>内存泄漏</strong>，以及烦人的 <strong><code>"setState() called after dispose()"</code></strong> 错误。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProfileScreenState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">ProfileScreen</span>&gt; </span>{
  <span class="hljs-keyword">final</span> _controller = ScrollController();
  StreamSubscription&lt;User&gt;? _sub;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    _sub = userStream.listen((u) =&gt; setState(() =&gt; _user = u));
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    _sub?.cancel();
    _controller.dispose();
    <span class="hljs-keyword">super</span>.dispose();
  }
}
}
</code></pre>
<p><strong>针对</strong>（异步/非同步）<strong>更新的</strong>一个<strong>额外保护措施</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">if</span> (!mounted) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// before setState after an await</span>
</code></pre>
<ul>
<li><strong>图片</strong>是你应用中<strong>偷偷占用大量内存</strong>的东西，很多人都忽略了它。</li>
</ul>
<p>Flutter 的 <strong><code>ImageCache</code></strong>（图片缓存）采用的是 <strong>LRU</strong>（最近最少使用）机制，默认情况下最多能存 <strong>1,000 张图片</strong>，总大小约 <strong>100 MB</strong>。</p>
<p><strong>注意！</strong> 这个 100 MB 只是<strong>压缩后</strong>的缓存大小；图片<strong>解码</strong>成位图（bitmap）后，在内存中会<strong>大得多</strong>！</p>
<p>举个例子，一张 <strong>7,500x5,000 像素</strong>的图片，一旦解码，它在内存中的占用能<strong>膨胀到 100+ MB</strong>，直接<strong>撑爆</strong>你的内存预算，并可能导致应用<strong>不得不重新解码</strong>（re-decodes）或者<strong>卡顿</strong>（jank）。你必须管理好它。</p>
<h3 data-id="heading-7">🛠️ 今天就试试这样做：</h3>
<ul>
<li>在加载图片时，提供 <strong><code>cacheWidth</code></strong> 或 <strong><code>cacheHeight</code></strong> 参数。这能让 Flutter <strong>按设备需要的尺寸</strong>来解码图片，而不是解码图片的完整尺寸。</li>
</ul>
<pre><code class="hljs language-dart" lang="dart">Image.network(url, cacheWidth: <span class="hljs-number">1080</span>)
</code></pre>
<ul>
<li>如果你的应用有很多图片，就**（应该）<strong>调整</strong>（图片）**缓存的大小。</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> main() {  
PaintingBinding.instance.imageCache.maximumSizeBytes = <span class="hljs-number">80</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;  
runApp(<span class="hljs-keyword">const</span> MyApp());  
}
</code></pre>
<hr/>
<h2 data-id="heading-8">优化实战篇：让列表更高效、消除“神秘”卡顿</h2>
<h3 data-id="heading-9">📜 列表与内存优化</h3>
<ul>
<li><strong>列表创建：</strong> 优先使用 <strong><code>ListView.builder</code></strong>，而不是一次性创建巨大的子部件列表 (<code>ListView(children: [...])</code>)。前者只会创建屏幕上可见的部分，大幅节省内存。</li>
<li><strong>别滥用 <code>KeepAlive</code>：</strong> 避免过度使用 <strong><code>AutomaticKeepAliveClientMixin</code></strong>。它会把那些已经滑出屏幕的 Widget “钉”在内存里不释放。</li>
</ul>
<hr/>
<h3 data-id="heading-10">🔑 Keys：防止无谓的重建和“抽搐”</h3>
<p><strong>Key</strong> 是一个**防止无意中“汰旧换新”**的小细节。</p>
<ul>
<li>
<p><strong>问题：</strong> 错误或缺失的 Key 会让 Flutter <strong>误以为</strong>组件变了，然后把 Element 扔掉，并<strong>重建</strong>你原本想保留的 <code>State</code>。</p>
</li>
<li>
<p><strong>作用：</strong> 正确的 Key 能<strong>稳定</strong>子树结构，<strong>减少</strong>内存分配，<strong>避免</strong>滚动位置丢失和控制器被重复绑定。</p>
</li>
<li>
<p><strong>用法：</strong></p>
<ul>
<li>需要稳定 ID 时，用 <strong><code>ValueKey</code></strong>。</li>
<li>滚动组件需要保存滚动位置时，用 <strong><code>PageStorageKey</code></strong>。</li>
<li><strong>别</strong>在每次构建时都用<strong>随机</strong>（Random）的 Key。</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-11">📝 两则来自日志的小故事</h3>
<h4 data-id="heading-12">1. 2025 年 1 月 14 日 — 聊天界面的“神秘膨胀”</h4>
<ul>
<li><strong>现象：</strong> 经过 10 次页面进出（push-pops）后，内存<strong>增加了 42 MB</strong>，垃圾回收（GC）每 2 秒就运行一次。内存图表显示 <strong><code>AnimationController</code> 实例从未被释放</strong>。</li>
<li><strong>修复：</strong> 释放（<code>dispose</code>）了两个控制器，并取消了一个 <strong><code>StreamSubscription</code></strong>。</li>
<li><strong>结果：</strong> 内存稳定下来，GC 间隔延长到 12 秒，卡顿帧数从 2.8% 降到 0.4%。</li>
</ul>
<h4 data-id="heading-13">2. 2025 年 4 月 3 日 — 低端安卓机的引导轮播图</h4>
<ul>
<li><strong>现象：</strong> 加载 4K PNG 图片时，内存<strong>飙升到 410 MB</strong>；图片<strong>重复解码</strong>导致画面长时间卡顿。</li>
<li><strong>修复：</strong> 添加了 <strong><code>cacheWidth: 1080</code></strong>（按需解码），并将 <strong><code>ImageCache</code></strong> 上限设为 <strong>80 MB</strong>。</li>
<li><strong>结果：</strong> 内存稳定在 170 MB 左右，<strong>零卡顿</strong>，滑动流畅。</li>
</ul>
<blockquote>
<p><strong>可选工具：</strong> <strong><code>leak_tracker</code></strong> 可以在<strong>测试</strong>时帮你找出那些漏掉 <code>dispose</code> 的对象。在 <code>debug/profile</code> 模式下启用，及早发现问题。</p>
</blockquote>
<hr/>
<h3 data-id="heading-14">🛑 大多数人会忽略的 3 个内存“坑”</h3>
<ol>
<li><strong>在 <code>build()</code> 里做大量耗时工作：</strong> 它重复运行的次数比你想象的要多得多。请<strong>提前计算</strong>（Precompute）、<strong>使用记忆化</strong>（Memoize），或者<strong>移到 <code>initState</code></strong> 里去做。</li>
<li><strong>让图片全尺寸解码：</strong> 设置解码尺寸到你实际需要的像素大小。你的 <strong>GPU</strong> 和<strong>内存堆</strong>（Heap）会感谢你。</li>
<li><strong>忘了释放“隐形”对象：</strong> <strong><code>StreamSubscription</code></strong> 和 <strong><code>Timer</code></strong> 造成的内存泄漏，跟控制器一样严重。错误往往晚点才爆发成<strong>随机卡顿或崩溃</strong>。</li>
</ol>
<hr/>
<h3 data-id="heading-15">⏰ 10 分钟快速行动计划 (现在就做！)</h3>
<ol>
<li>打开 <strong>DevTools → Memory</strong> 视图，在你最<strong>卡顿</strong>的屏幕上<strong>导航 30 秒</strong>。寻找<strong>持续上升</strong>或<strong>基线不断抬高</strong>的锯齿状内存图。</li>
<li>在你的代码库中搜索所有<strong>需要释放</strong>的对象：<code>AnimationController</code>|<code>ScrollController</code>|<code>TextEditingController</code>|<code>FocusNode</code>|<code>StreamSubscription</code>|<code>Timer</code>。确保每个都有对应的 <strong><code>dispose()</code> 或 <code>cancel()</code></strong> 。</li>
<li>给你最大的几张图片加上 <strong><code>cacheWidth/cacheHeight</code></strong>；如果媒体内容多，就设置 <strong><code>ImageCache.maximumSizeBytes</code></strong> 上限。</li>
<li>把那些超大的 <strong><code>ListView(children: [...])</code></strong> 替换成 <strong><code>ListView.builder</code></strong>。</li>
<li>在稳定的子树构造函数上<strong>加上 <code>const</code></strong>，并在需要保持身份稳定性的地方<strong>修复缺失的 Key</strong>。</li>
</ol>
<hr/>
<h3 data-id="heading-16">🗓️ 本周计划 (3 个重点步骤)</h3>
<ol>
<li><strong>性能分析 (Profile)：</strong> 在 <code>profile</code> 模式下，针对两个**“慢”<strong>的屏幕，捕捉 <strong>30–60 秒</strong>的内存和性能时间线。记录</strong>内存峰值**、<strong>GC 运行频率</strong>和<strong>掉帧百分比</strong>。</li>
<li><strong>修复泄漏：</strong> 用 <strong><code>leak_tracker</code></strong> 给一个模块（如聊天或媒体）添加单元测试/Widget 测试。当控制器或订阅在 <code>dispose</code> 后仍然存活时，让测试<strong>失败</strong>。</li>
<li><strong>调整媒体尺寸：</strong> 检查<strong>前 10 大</strong>的图片和视频缩略图。添加<strong>解码尺寸限制</strong>，并根据需要调整缓存。<strong>重新测量</strong>。</li>
</ol>
<hr/>
<h3 data-id="heading-17">✅ 可粘贴的自检清单 (一行版)</h3>
<blockquote>
<p>性能分析内存 → 搜索需要释放的对象 → 添加/确认 <code>dispose()</code> → 用 <code>cacheWidth/height</code> 调整图片大小 → 如有需要，限制 <code>ImageCache</code> → 修复 Keys → 将重度工作移出 <code>build()</code> → 在 DevTools 中重新测量。</p>
</blockquote>
<hr/>
<h3 data-id="heading-18">🔄 最终总结：带走这个观念</h3>
<blockquote>
<p><strong>重建 (Rebuilds) 不是敌人</strong>。</p>
<p><strong>“泄漏”的状态</strong>（Leaky state）和<strong>尺寸过大的媒体资源</strong>才是！</p>
</blockquote>
<p>您觉得哪个优化点对您当前的项目最实用，需要我提供更多示例代码吗？</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何在CI/CD流水线中自动化实现镜像扫描和推送到Harbor？]]></title>    <link>https://juejin.cn/post/7570999443446923300</link>    <guid>https://juejin.cn/post/7570999443446923300</guid>    <pubDate>2025-11-11T07:04:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570999443446923300" data-draft-id="7571304204721012790" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何在CI/CD流水线中自动化实现镜像扫描和推送到Harbor？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T07:04:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何在CI/CD流水线中自动化实现镜像扫描和推送到Harbor？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T07:04:41.000Z" title="Tue Nov 11 2025 07:04:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在CI/CD流水线中自动化实现镜像扫描和推送到Harbor，是提升容器安全性和部署效率的关键。下面这张流程图直观展示了其核心步骤与决策点，你可以结合后续的详细说明来实践。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94b9604b4baa4bf088abc8a3772fead3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTmqZjlrZDnmq4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449480&amp;x-signature=bByXskMjs3tfCWNg1yO6umvpwAk%3D" alt="image.png" loading="lazy"/></p>
<p>下面，我们详细解析每个阶段的关键操作。</p>
<h3 data-id="heading-0">🔧 阶段一：代码编译与镜像构建</h3>
<p>这个阶段负责将源代码构建成Docker镜像。</p>
<ul>
<li><strong>基础环境配置</strong>：确保你的CI/CD环境（如Jenkins、GitLab Runner）已安装Docker，并配置为可访问你的Harbor私有仓库。通常需要在Docker配置中声明Harbor仓库地址为非安全注册表（<code>insecure-registries</code>）或配置正确的CA证书。</li>
<li><strong>构建与标记镜像</strong>：在流水线脚本中，使用<code>docker build</code>命令构建镜像，并使用<code>docker tag</code>为镜像打上符合Harbor规范的标签，格式通常为<code>&lt;harbor-server&gt;/&lt;project-name&gt;/&lt;image-name&gt;:&lt;tag&gt;</code>。</li>
</ul>
<h3 data-id="heading-1">🔍 阶段二：镜像安全扫描与质量门禁</h3>
<p>这是保障安全的核心环节，通常在构建之后、推送之前进行。</p>
<ul>
<li>
<p><strong>集成扫描工具</strong>：在流水线中集成漏洞扫描工具，如开源的<strong>Trivy</strong>、Clair或商业工具。将这些工具的命令直接添加到流水线脚本中。一个典型的Trivy扫描命令如下：</p>
<pre><code class="hljs language-arduino" lang="arduino"># 扫描镜像并生成报告，如果发现高危或严重漏洞则使构建失败
trivy image --exit-code <span class="hljs-number">1</span> --severity <span class="hljs-literal">HIGH</span>,CRITICAL &lt;your-image-tag&gt;
</code></pre>
</li>
<li>
<p><strong>设置质量门禁</strong>：通过工具的退出代码（如Trivy的<code>--exit-code 1</code>）或策略检查，在发现超过预设严重级别的漏洞时，<strong>主动让CI/CD流水线失败</strong>，从而阻断不安全的镜像流入后续环节。你还可以配置只阻断新引入的高危漏洞，这对于初步建立流程的团队非常有用。</p>
</li>
</ul>
<h3 data-id="heading-2">📤 阶段三：推送镜像至Harbor</h3>
<p>通过安全扫描后，镜像可以被推送到Harbor。</p>
<ul>
<li>
<p><strong>登录Harbor</strong>：在流水线脚本中使用<code>docker login</code>命令认证Harbor。<strong>务必使用凭证管理工具（如Jenkins的Credentials Binding插件）安全地处理用户名和密码</strong>，避免硬编码。</p>
<pre><code class="hljs language-bash" lang="bash">docker login -u <span class="hljs-variable">$HARBOR_USER</span> -p <span class="hljs-variable">$HARBOR_PASSWORD</span> <span class="hljs-variable">$HARBOR_SERVER</span>
</code></pre>
</li>
<li>
<p><strong>推送镜像</strong>：使用<code>docker push</code>命令将打好标签的镜像推送到Harbor的指定项目中。</p>
</li>
</ul>
<h3 data-id="heading-3">🚀 阶段四：部署到Kubernetes</h3>
<p>镜像推送成功后，流水线可自动或手动触发部署步骤。</p>
<ul>
<li><strong>更新部署清单</strong>：通常需要更新Kubernetes的YAML文件或Helm Chart中的镜像标签，指向刚刚推送到Harbor的新镜像。</li>
<li><strong>执行部署命令</strong>：使用<code>kubectl apply</code>或Helm命令来更新Kubernetes中的部署。确保CI/CD系统拥有操作K8s集群的必要权限（可通过ServiceAccount等方式配置）。</li>
</ul>
<h3 data-id="heading-4">💡 进阶实践与建议</h3>
<ul>
<li><strong>使用Harbor的机器人账户</strong>：为CI/CD流程创建专门的Harbor“机器人账户”，并赋予最小必要权限（通常仅限指定项目的推送权限），这比使用个人管理员账户更安全。</li>
<li><strong>定期扫描与策略管理</strong>：除了推送前扫描，还可以利用Harbor内置的漏洞扫描功能设置<strong>镜像标签不可变、自动扫描、阻止运行有严重漏洞的镜像</strong>等策略。同时，可设置定时任务（如每晚）重新扫描仓库中的旧镜像，以应对新披露的漏洞。</li>
<li><strong>遵循Dockerfile最佳实践</strong>：安全始于构建。在Dockerfile中尽量使用<strong>轻量级基础镜像</strong>，以非root用户运行应用，并进行<strong>多阶段构建</strong>以减少最终镜像的攻击面。</li>
</ul>
<h3 data-id="heading-5">🧩 示例流水线脚本片段 (Jenkins Pipeline)</h3>
<p>以下是一个简化的Jenkins Pipeline脚本示例，它串联了上述主要步骤：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">pipeline {
    agent any
    environment {
        HARBOR_SERVER = <span class="hljs-string">'your-harbor.com'</span>
        PROJECT_NAME = <span class="hljs-string">'your-project'</span>
        IMAGE_NAME = <span class="hljs-string">'your-app'</span>
    }
    stages {
        stage(<span class="hljs-string">'Build'</span>) {
            steps {
                script {
                    docker.build(<span class="hljs-string">"<span class="hljs-subst">${IMAGE_NAME}</span>:<span class="hljs-subst">${env.BUILD_ID}</span>"</span>)
                }
            }
        }
        stage(<span class="hljs-string">'Security Scan'</span>) {
            steps {
                script {
                    <span class="hljs-comment">// 使用Trivy扫描，如果发现HIGH/CRITICAL漏洞则失败</span>
                    sh <span class="hljs-string">"trivy image --exit-code 1 --severity HIGH,CRITICAL <span class="hljs-subst">${IMAGE_NAME}</span>:<span class="hljs-subst">${env.BUILD_ID}</span>"</span>
                }
            }
        }
        stage(<span class="hljs-string">'Push to Harbor'</span>) {
            steps {
                script {
                    withCredentials([usernamePassword(credentialsId: <span class="hljs-string">'harbor-cred'</span>, usernameVariable: <span class="hljs-string">'HARBOR_USER'</span>, passwordVariable: <span class="hljs-string">'HARBOR_PASSWORD'</span>)]) {
                        sh <span class="hljs-string">"docker tag <span class="hljs-subst">${IMAGE_NAME}</span>:<span class="hljs-subst">${env.BUILD_ID}</span> <span class="hljs-subst">${HARBOR_SERVER}</span>/<span class="hljs-subst">${PROJECT_NAME}</span>/<span class="hljs-subst">${IMAGE_NAME}</span>:<span class="hljs-subst">${env.BUILD_ID}</span>"</span>
                        sh <span class="hljs-string">"docker login -u <span class="hljs-variable">$HARBOR_USER</span> -p <span class="hljs-variable">$HARBOR_PASSWORD</span> <span class="hljs-variable">$HARBOR_SERVER</span>"</span>
                        sh <span class="hljs-string">"docker push <span class="hljs-subst">${HARBOR_SERVER}</span>/<span class="hljs-subst">${PROJECT_NAME}</span>/<span class="hljs-subst">${IMAGE_NAME}</span>:<span class="hljs-subst">${env.BUILD_ID}</span>"</span>
                    }
                }
            }
        }
        stage(<span class="hljs-string">'Deploy to K8s'</span>) {
            steps {
                sh <span class="hljs-string">"sed -i 's|IMAGE_TAG|<span class="hljs-subst">${env.BUILD_ID}</span>|g' k8s-deployment.yaml"</span>
                sh <span class="hljs-string">"kubectl apply -f k8s-deployment.yaml"</span>
            }
        }
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深度解析 Android 崩溃捕获原理及从崩溃到归因的闭环实践]]></title>    <link>https://juejin.cn/post/7571068689764925480</link>    <guid>https://juejin.cn/post/7571068689764925480</guid>    <pubDate>2025-11-11T03:37:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571068689764925480" data-draft-id="7571068689764843560" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深度解析 Android 崩溃捕获原理及从崩溃到归因的闭环实践"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-11T03:37:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深度解析 Android 崩溃捕获原理及从崩溃到归因的闭环实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T03:37:55.000Z" title="Tue Nov 11 2025 03:37:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：路锦（小蘭）</p>
<h2 data-id="heading-0">背景：Android 应用崩溃的挑战</h2>
<p>在移动应用的世界里，稳定性是用户体验的基石。任何异常都可能导致用户失望、给出差评，并最终卸载应用。对于开发者而言，快速识别、定位和修复这些问题至关重要。正如线上应用崩溃了，我们收到的却往往只是一个无情的“已停止运行”提示。尤其面对 Native 崩溃和代码混淆，堆栈信息如同一本“天书”，让问题定位变得异常困难。本文将系统性地拆解 Android 崩溃捕获的底层原理与核心技术难点，并提供一套统一的框架设计思路，旨在点亮线上崩溃的“盲区”，实现从捕获到精准归因的闭环。</p>
<h2 data-id="heading-1">崩溃采集的技术原理与方案调研</h2>
<p>要捕获崩溃，我们首先需要理解 Android 系统中两类主要崩溃的底层触发机制。</p>
<h3 data-id="heading-2">2.1 Java/Kotlin 崩溃采集原理</h3>
<p>Java 和 Kotlin 代码都运行在 ART (Android Runtime) 上，当代码中抛出一个异常（如 <code>NullPointerException</code>）而没有被任何 <code>try-catch</code> 块捕获时，这个异常会沿着调用栈一路向上传递。如果最终抵达线程的顶部仍未被处理，ART 就会终止该线程。在终止前，ART 会调用一个可供开发者设置的回调接口——<code>Thread.UncaughtExceptionHandler</code>。</p>
<p>这正是我们捕获 Java 崩溃的入口。通过调用 Thread.setDefaultUncaughtExceptionHandler()，我们可以注册一个全局处理器。当任何线程发生未捕获异常时，我们的处理器便会接管，从而获得在进程完全死亡前的宝贵时机，用以记录崩溃现场的关键信息。</p>
<h3 data-id="heading-3">2.2 Native 崩溃原理：深入信号处理与现场捕获</h3>
<p>Native 崩溃发生在 C/C++ 代码层，它不受 ART 虚拟机管理，因此 <code>UncaughtExceptionHandler</code> 对其无能为力。Native 崩溃的本质是 CPU 执行了非法指令，进而被操作系统内核检测到。内核会向对应的进程发送一个 Linux 信号 (Signal) 来通知这一事件，这是一种内核与进程之间进行异步通信的机制。</p>
<h4 data-id="heading-4">常见致命信号详解</h4>
<ul>
<li><code>SIGSEGV</code> (Segmentation Fault)：段错误。这是最常见的 Native 崩溃原因，本质是程序试图访问一块它无权访问的内存。例如：解引用一个 NULL 指针、访问已释放对象的内存（Use-After-Free）、数组越界、试图写入只读内存段等。</li>
<li><code>SIGILL</code> (Illegal Instruction)：非法指令。当 CPU 的指令指针指向一个无效或包含损坏数据的地址时，CPU 无法识别将要执行的指令，便会触发此信号。例如：函数指针错误导致跳转到非代码区、栈被破坏导致返回地址错误等。</li>
<li><code>SIGABRT</code> (Abort)：程序异常终止。这通常是程序“主动”选择的崩溃，一般由调用 <code>abort()</code> 函数触发。在 C/C++ 中，很多断言库（<code>assert</code>）在断言失败后会调用<code>abort()</code>，表明程序进入了一个绝对不应存在的状态。</li>
<li><code>SIGFPE</code> (Floating-Point Exception)：浮点数异常。例如：整数除以零、浮点数上溢或下溢等。</li>
</ul>
<h4 data-id="heading-5">捕获流程四部曲</h4>
<p>捕获这些信号并还原现场，是一个精细且严谨的过程：</p>
<ol>
<li>
<p><strong>注册处理器</strong> (<code>sigaction</code>)：这是捕获流程的第一步。我们使用 <code>sigaction()</code> 系统调用来为我们关心的信号（如 <code>SIGSEGV</code>）注册一个自定义的回调函数。相比于老旧的 <code>signal()</code> 函数，<code>sigaction</code> 提供了更丰富的功能，特别是通过设置 <code>SA_SIGINFO</code> 标志，可以让我们的回调函数接收到一个包含详细上下文的 <code>siginfo_t</code> 结构体，其中包括了导致崩溃的具体内存地址 (<code>si_addr</code>) 等宝贵信息。</p>
</li>
<li>
<p><strong>安全第一</strong>：<code>async-signal-safe</code> 环境: 信号处理器函数在一个非常特殊且严苛的环境中执行。在这个环境中，我们不能假定全局数据结构是完好无损的，也不能调用绝大多数标准库函数（如 <code>malloc, free, printf, strcpy</code>），因为它们不是“异步信号安全”的，调用它们极易导致二次崩溃或死锁。我们能做的，只有调用少数被明确标记为“安全”的函数（如 <code>write, open, read</code>）。</p>
</li>
<li>
<p><strong>堆栈回溯</strong> (Stack Unwinding)：为了得到函数调用链，我们需要在信号处理器中进行堆栈回溯。这是一个通过分析当前线程的栈指针（SP）、帧指针（FP）以及栈上的返回地址，来逐层还原函数调用关系的过程。<code>libunwind</code> 等库被广泛用于此目的。然而，在 Native 崩溃场景下，栈本身可能已经被破坏，这使得实时回溯的成功率并非 100%。</p>
</li>
<li>
<p><strong>生成报告</strong> (Minidump)：正因为实时回溯的不可靠性，业界最佳实践（如 Google Breakpad）并非在信号处理器中直接进行复杂的堆栈回溯。更可靠的做法是：在信号处理器这个“安全环境”中，只做最少、最核心的操作——即收集所有线程的寄存器上下文、原始的堆栈内存片段、已加载的模块列表等信息，并将它们“打包”成一个结构化的 Minidump 文件。这个过程不涉及复杂的逻辑，失败风险低。真正的堆栈回溯和符号化分析，则被推迟到服务端，在更安全、资源更充裕的环境中离线进行。</p>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa815971c2034488ac7b03284b3e9c0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763437075&amp;x-signature=ZXyVDAeQwymoDV8zlfGpUeDRDfw%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-6">2.3 业界方案调研</h3>
<p>基于以上原理，业界涌现了众多优秀的开源及商业化方案。它们本质上都是对上述原理的工程化封装。</p>
<ul>
<li><strong>Google Breakpad/Crashpad</strong>：它们是 Native 崩溃捕获的“黄金标准”，提供了从信号捕获、Minidump 生成到后台解析的全套工具链。它们是许多商业方案的技术基石，但自行集成和后台搭建成本较高。</li>
<li><strong>Firebase Crashlytics &amp; Sentry</strong>：这类商业化平台（SaaS）提供了“SDK + 后台”的一站式服务。它们封装了底层的捕获逻辑，并提供了强大的后台用于报告聚合、符号化解析和统计分析，极大地降低了开发者的使用门槛。</li>
<li><strong>xCrash</strong>：这是一个功能强大的开源库，不仅支持 Native 和 Java 崩溃，还对各种复杂场景下的堆栈回溯做了深度优化，信息采集能力非常出色。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b55446b629264948bc8525c909e88f0d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763437075&amp;x-signature=LZKVAQngOqFcfI6U4t7IN19Ix68%3D" alt="图片" loading="lazy"/></p>
<p>经过对比分析，本文选择 Google Breakpad 作为 Native 崩溃采集的核心技术。Breakpad 采用业界标准的 Minidump 格式，这一格式已被 Chrome、Firefox 等全球主流产品广泛采用，技术成熟。从能力覆盖角度看，Breakpad 在 Native 崩溃捕获、多架构支持、跨平台兼容等核心场景上表现完整，配套的符号化工具链（如 dump_syms、minidump_stackwalk）也十分成熟。虽然 Breakpad 专注于 Native 层面，但 Java 崩溃可通过上述 UncaughtExceptionHandler 机制补齐，整体能力覆盖性满足崩溃采集的要求。</p>
<h2 data-id="heading-7">核心技术难点解析</h2>
<p>实现一个可靠的崩溃采集方案，需要克服以下三大技术难点。</p>
<h3 data-id="heading-8">难点一：捕获时机与信息保存的可靠性</h3>
<p>崩溃发生时，整个进程已处于极不稳定的濒死状态。此时执行复杂操作（如网络请求）风险极高。我们必须确保信息记录的过程足够快且绝对可靠。因此，“同步写入、延迟上报”是最佳策略。即在捕获到崩溃的瞬间，以最快的同步方式将信息写入本地文件，然后等到应用下一次正常启动时，再从容地读取文件并上报到服务器。</p>
<h3 data-id="heading-9">难点二：Native 崩溃的“黑盒”特性</h3>
<p>相比于 Java 崩溃，Native 崩溃现场更易遭到破坏。非法的内存操作可能已污染了堆栈，导致传统的堆栈回溯方法失效。因此，简单地记录几个寄存器值是远远不够的。我们需要的是一个包含线程、寄存器、堆栈内存、已加载模块等信息的完整“现场快照”。这正是 Breakpad 提出的 Minidump（小型转储）概念的价值所在。</p>
<h3 data-id="heading-10">难点三：堆栈的“天书”——混淆与符号化</h3>
<p>为了安全和包体大小，线上代码通常经过了混淆（ProGuard/R8）。这会导致崩溃堆栈中的类名和方法名变成无意义的 <code>a, b, c</code>，如同天书。对于 Native 代码，发布的是不含符号信息的二进制文件，其堆栈也是一串无意义的内存地址。因此，符号化 (Symbolication)是必不可少的一环。我们必须在编译时生成并保留对应的符号表文件（Java 的 <code>mapping.txt</code>，Native 的 <code>.so</code> 文件），在服务端利用这些文件将“天书”翻译回可读的、有意义的堆栈信息。</p>
<h2 data-id="heading-11">Android 应用崩溃采集及堆栈解析实践</h2>
<p>为了全面应对这些挑战，我们设计了一个统一的异常采集方案，遵循“捕获-持久化-上报-解析”的生命周期。无论是 Java 还是 Native 崩溃，客户端的核心任务都是可靠地将现场信息保存到本地。真正的解析和分析工作则交由服务端完成。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0563040a4db244c1bff8bcce67916f6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763437075&amp;x-signature=egu5eF9Iysnbn93hXn%2BCFA4tQa8%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-12">4.1 Java/Kotlin 崩溃处理</h3>
<p>我们使用 <code>Thread.setDefaultUncaughtExceptionHandler</code> 来捕获 Java/Kotlin 的异常。这是一个回调接口，无论是 Java 还是 Kotlin，其编译后的字节码均由 ART 执行。当抛出未捕获异常时，ART 会触发当前线程的异常分发机制，最终调用注册的 uncaughtException 方法。因此 <code>Thread.setDefaultUncaughtExceptionHandler</code> 能够实现全局 Java/Kotlin 异常捕获。</p>
<p>首先需要设置一个全局的未捕获异常处理器来捕获 Java 崩溃，通过实现<code>Thread.setDefaultUncaughtExceptionHandler</code> 的 uncaughtException 方法实现一个处理器，我们可以将自己实现的 handler 设置为所有线程的默认处理器。这就给了我们在应用彻底崩溃前的最后一刻“力挽狂澜”的机会——记录下导致崩溃的元凶。需要注意我们要保留原始的处理器：originalHandler。</p>
<p>当崩溃发生时，该处理器会收集异常及堆栈关键信息，最终将其同步持久化到 <code>SharedPreferences</code>。由于进程即将终止，当前的步骤必须保证同步完成，因此我们持久化写缓存也使用同步提交 (<code>editor.commit()</code>) ，异步的 <code>apply()</code> 可能无法确保成功持久化。关键的异常信息例如：</p>
<ul>
<li><strong>时间戳 (Timestamp)</strong>：崩溃发生的精确时间。</li>
<li><strong>异常类型 (Exception Type)</strong>：是 <code>NullPointerException</code> 还是 <code>IndexOutOfBoundsException</code> 等。</li>
<li><strong>异常信息 (Exception Message)</strong>：异常对象中包含的描述性信息。</li>
<li><strong>堆栈轨迹 (Stack Trace)</strong>：这是最重要的部分，它告诉我们崩溃发生在哪个类的哪一行代码。</li>
<li><strong>线程信息 (Thread Name)</strong>：崩溃发生在主线程还是某个后台线程。</li>
</ul>
<p>“下次启动时上报”是核心策略。它避免了在应用崩溃时不稳定的网络环境中尝试上报数据，大大提高了成功率。我们在 <code>start()</code> 方法中调用此检查。这个方法可以在后台线程中执行，防止阻塞应用主线程。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7cdac604cf44b2c9eebc8bed99c514b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763437075&amp;x-signature=wVT4IAD8xputPi%2FQobo1vj6r3qY%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Override</span>
public void uncaughtException(Thread thread, Throwable throwable) {
    try {
        <span class="hljs-comment">// 核心难点1：收集崩溃信息</span>
        CrashData crashData = <span class="hljs-built_in">collectCrashData</span>(thread, throwable);
        <span class="hljs-comment">// 核心难点2：保证濒死前数据能被同步、可靠地保存</span>
        <span class="hljs-built_in">saveCrashData</span>(crashData);
    } finally {
        <span class="hljs-comment">// 核心难点3：将控制权交还，确保系统默认行为（如弹窗）执行</span>
        if (originalHandler != null) {
            originalHandler<span class="hljs-selector-class">.uncaughtException</span>(thread, throwable);
        }
    }
}
private void <span class="hljs-built_in">saveCrashData</span>(CrashData data) {
    <span class="hljs-comment">// 使用 SharedPreferences 的同步 commit() 方法</span>
    prefs<span class="hljs-selector-class">.edit</span>()<span class="hljs-selector-class">.putString</span>("last_crash", data.toJson())<span class="hljs-selector-class">.commit</span>(); 
}
</code></pre>
<h3 data-id="heading-13">4.2 Native 崩溃处理</h3>
<p>对于 Native 崩溃，我们集成了一个基于 Breakpad 的解决方案。在启动时加载一个 Native 库，该库为常见的崩溃信号设置了信号处理器。</p>
<p><strong>1. 初始化</strong>：在 App 启动时，我们初始化 Native 库，并为其提供一个专用的目录来写入崩溃转储文件（crash dump）。</p>
<p><strong>2. 崩溃发生</strong>：当 Native 崩溃发生时，信号处理器会捕获它，并将一个 <code>.dmp</code> (minidump) 文件写入指定目录。</p>
<p><strong>3. 下次启动时处理</strong>：在下一次 App 启动时，我们的框架会检查此目录中是否有任何 <code>.dmp</code> 文件。如果找到，它会调用一个 Native 方法来解析 minidump，提取堆栈信息和其他相关信息。解析后的数据随后被上报到我们的后端，并且转储文件被删除。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ef3f0d1b02c4636904d4ddb8bc7c2bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763437075&amp;x-signature=u9AAvnLyAUN%2FoMUq7Cgq%2FDzl8ds%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-scss" lang="scss">public void <span class="hljs-built_in">start</span>() {
    <span class="hljs-comment">// 核心难点1：尽早初始化 Native 层的信号处理器</span>
    NativeBridge<span class="hljs-selector-class">.initialize</span>(crashDir.getAbsolutePath());
    <span class="hljs-comment">// 核心难点2：在下次启动时，异步检查并处理上次崩溃留下的产物</span>
    new <span class="hljs-built_in">Thread</span>(this::processExistingDumps)<span class="hljs-selector-class">.start</span>();
}
private void <span class="hljs-built_in">processExistingDumps</span>() {
    <span class="hljs-comment">// 遍历指定目录下的 .dmp 文件</span>
    File<span class="hljs-selector-attr">[]</span> dumpFiles = crashDir<span class="hljs-selector-class">.listFiles</span>();
    for (File dumpFile : dumpFiles) {
        <span class="hljs-comment">// 此处无需解析，直接将原始 .dmp 文件上报</span>
        <span class="hljs-built_in">reportToServer</span>(dumpFile);
        dumpFile<span class="hljs-selector-class">.delete</span>();
    }
}
<span class="hljs-comment">// JNI 桥接，是 Java 层与 C++ 层通信的唯一途径</span>
static class NativeBridge {
    <span class="hljs-comment">// 加载实现了信号捕获和 minidump 写入的 so 库</span>
    static { System<span class="hljs-selector-class">.loadLibrary</span>("crash-handler"); }
    <span class="hljs-comment">// JNI 方法，通知 C++ 层开始工作</span>
    public static native void <span class="hljs-built_in">initialize</span>(String dumpPath);
}
</code></pre>
<p>转储文件中我们能获取到的异常信息有很多，使用时我们通常需要关注以下的关键信息：</p>
<p><strong>1. 异常信息 (Exception Information)</strong></p>
<ul>
<li>异常流 (Exception Stream)：
<ul>
<li>崩溃线程 ID (Thread ID)：明确指出是哪一个线程引发了这次崩溃。</li>
<li>崩溃信号（Signal），例如 SIGSEGV（段错误) 和 SIGILL (非法指令)。</li>
<li>异常地址 (Exception Address)：异常发生时，CPU 指令指针（Program Counter）所在的内存地址。这直接指向了导致崩溃的那一行机器码。</li>
</ul>
</li>
</ul>
<p><strong>2. 线程列表与状态 (Thread List &amp; States)</strong></p>
<ul>
<li>线程 ID (Thread ID)：该线程的唯一标识符。</li>
<li>线程上下文。</li>
<li>线程堆栈内存 (Stack Memory Dump)：包含了每个线程栈上一部分内存的原始二进制拷贝。</li>
</ul>
<p><strong>3. 模块列表 (Module List)：</strong> 崩溃时进程加载的所有动态链接库（在 Android 上是 .so 文件）和可执行文件</p>
<p><strong>4. 系统信息 (System Information)</strong></p>
<ul>
<li>操作系统信息：操作系统类型（如 Linux）、版本号（如 Android 12, API 31）。</li>
<li>CPU 信息：CPU 架构（如 ARM64, x86）、CPU 型号、核心数量等。</li>
</ul>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 崩溃信息</span>
Caused <span class="hljs-keyword">by</span>: SIGSEGV /SEGV_ACCERR
<span class="hljs-comment">// 系统信息</span>
Kernel version: <span class="hljs-string">'0.0.0 Linux 6.6.66-android15-8-g807ce3b4f02f-ab12996908-4k #1 SMP PREEMPT Fri Jan 31 21:59:26 UTC 2025 aarch64'</span>  ABI: <span class="hljs-string">'arm64'</span> 
</code></pre>
<p>堆栈样例：<a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">#00</a> pc 0x3538 libtest-native.so</p>
<h3 data-id="heading-14">4.3 应用混淆堆栈解析</h3>
<p>当前很多线上应用为了安全和包体大小，代码通常经过了混淆（如 ProGuard/R8），这使得原始的崩溃堆栈变得几乎无法阅读。</p>
<h4 data-id="heading-15">混淆 Java 堆栈解析</h4>
<p>当线上应用发生崩溃时，你捕获到的堆栈信息是经过混淆的，看起来就像这样，这个堆栈对我们来说几乎是无用的：</p>
<ul>
<li>类名 a.b.c.a 和方法名 a 毫无意义。</li>
<li>行号信息也丢失了，显示为 Unknown Source。</li>
</ul>

<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.NullPointerException</span>: <span class="hljs-selector-tag">Attempt</span> <span class="hljs-selector-tag">to</span> <span class="hljs-selector-tag">invoke</span> <span class="hljs-selector-tag">virtual</span> <span class="hljs-selector-tag">method</span> '<span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.b</span><span class="hljs-selector-class">.d</span><span class="hljs-selector-class">.a</span><span class="hljs-selector-class">.a</span>(a.b.e.a)' <span class="hljs-selector-tag">on</span> <span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">null</span> <span class="hljs-selector-tag">object</span> <span class="hljs-selector-tag">reference</span>
       <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.b</span><span class="hljs-selector-class">.c</span><span class="hljs-selector-class">.a</span><span class="hljs-selector-class">.a</span>(Unknown <span class="hljs-attribute">Source</span>:<span class="hljs-number">8</span>)
       <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.b</span><span class="hljs-selector-class">.c</span><span class="hljs-selector-class">.b</span><span class="hljs-selector-class">.onClick</span>(Unknown <span class="hljs-attribute">Source</span>:<span class="hljs-number">2</span>)
       <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">android</span><span class="hljs-selector-class">.view</span><span class="hljs-selector-class">.View</span><span class="hljs-selector-class">.performClick</span>(View.<span class="hljs-attribute">java</span>:<span class="hljs-number">7448</span>)
</code></pre>
<p>接下来我们了解一下混淆堆栈的解析原理：</p>
<p>当你在 Android 项目中启用代码混淆（通常是在 release 构建类型中设置 minifyEnabled true）并进行打包时，R8 工具会在处理你的代码的同时，在 build/outputs/mapping/release/ 目录下生成一个 mapping.txt 文件，这个文件我们可以理解为“字典”。</p>
<p>而解析工具会读取上述文件，将混淆后的堆栈逐行翻译为原始文件和方法名。</p>
<p><strong>1. 逐行读取堆栈：</strong> 工具读取混淆堆栈的每一行，例如 at a.b.c.a.a(Unknown Source:8)。</p>
<p><strong>2. 解析关键信息：</strong> 它从这行中提取出关键部分：</p>
<ul>
<li>类名：a.b.c.a</li>
<li>方法名：a</li>
<li>（可能的）行号：8</li>
</ul>
<p><strong>3. 查询</strong> <code>mapping.txt</code>：</p>
<ul>
<li>工具在 mapping.txt 中查找 a.b.c.a: 这一行，找到它对应的原始类名，例如：com.example.myapp.ui.MainActivity。</li>
<li>接着，在 MainActivity 的映射条目下，它会继续查找哪个原始方法被混淆成了a。假设它找到了 void updateUserProfile(com.example.myapp.model.User) -&gt; a。</li>
</ul>
<p><strong>4. 恢复行号：</strong> R8 在优化过程中可能会内联方法或移除代码，导致行号变化。mapping.txt中也包含了行号的映射信息。Retrace 工具会利用这些信息，将混淆后的行号（如：8）精确地还原为原始的源文件行号。</p>
<p><strong>5. 替换与输出：</strong> 工具将混淆的行替换为解析后的、可读的行。</p>
<h4 data-id="heading-16">Native 堆栈解析</h4>
<p>这是一个我们采集到的 Native 堆栈其中的一行，分别包含以下信息：</p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">#00</a>：堆栈帧序号。00 代表栈顶，是程序崩溃的直接位置。</li>
<li>pc 0x3538：程序计数器地址 (Program Counter)。这是我们需要解析的关键信息，代表 CPU 在 libtest-native.so 这个库中执行到的指令的相对地址。</li>
<li>libtest-native.so：动态库路径。指明了崩溃发生在哪一个 .so 文件中。这是设备上运行时的路径。</li>
</ul>

<pre><code class="hljs language-bash" lang="bash"> <span class="hljs-comment">#00 pc 0x3538 libtest-native.so</span>
</code></pre>
<p>然而我们拿到这个堆栈仍然无法解析出具体发生崩溃的文件和方法，因此我们需要解析 C++ 堆栈，还原为可读的崩溃真实信息。</p>
<p>与 Java 堆栈解析的核心思想一致，Native 堆栈解析也是一个“查表翻译”的过程。只不过它的“密码本”不再是 mapping.txt，而是包含了 DWARF 调试信息的、与线上版本完全一致的 <code>unstripped</code> 库文件：libtest-native.so 文件；“翻译工具”则是 NDK 提供的 addr2line 等命令行程序。执行类似如下的命令：</p>
<pre><code class="hljs language-bash" lang="bash"> <span class="hljs-comment"># 使用 NDK 中的 addr2line 工具</span>
 <span class="hljs-comment"># -C: Demangle C++ 的函数名 (例如将 _Z... 还原成 MyClass::MyMethod)</span>
 <span class="hljs-comment"># -f: 显示函数名</span>
 <span class="hljs-comment"># -e: 指定带符号的库文件</span>
addr2line -C -f -e /path/to/unstripped/libtest-native.so 0x3538
</code></pre>
<p>工作原理：</p>
<ul>
<li>
<p>addr2line 工具加载 unstripped 的 .so 文件。</p>
</li>
<li>
<p>它解析文件中的 DWARF 调试信息段，这些信息段中存储了从机器码地址到源代码行号的映射表。</p>
</li>
<li>
<p>它在映射表中查找地址 0x3538 落在哪个函数地址范围之内。</p>
</li>
<li>
<p>找到函数后，它进一步在行号表中查找该地址精确对应的文件名和行号。</p>
</li>
<li>
<p>同时，它利用 -C 参数对 C++ 的“符号修饰名”（mangled name）进行“解修饰”（demangle），将其还原成我们代码中编写的、可读的命名空间::类名::方法名(参数) 形式。</p>
</li>
</ul>
<p>addr2line 工具执行完毕后，就会解析出我们期望得到的结果，因此我们能够定位到发生崩溃的具体文件和方法：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">CrashCore::makeArrayIndexOutOfBoundsException()</span>
<span class="hljs-section">/xxx/xxx/xxx/android-demo/app/src/main/cpp/CrashCore.cpp:51</span>
</code></pre>
<h2 data-id="heading-17">总结</h2>
<p>通过本文的探讨，我们解构了 Android 崩溃捕获的底层原理，并围绕三大核心技术难点（<strong>捕获时机、黑盒现场、堆栈混淆</strong>）设计了一套捕获方案。无论是 Java 层的 UncaughtExceptionHandler 机制，还是 Native 层的信号处理与 Minidump 技术，其最终目的都是在进程“灰飞烟灭”前，尽可能可靠地抢救出最有价值的现场信息。阿里云 RUM 针对 Android 端实现了对应用性能、稳定性、和用户行为的无侵入式采集 SDK。可以参考接入文档 <strong>[</strong> <strong>1]</strong> 体验使用。相关问题可以加入“RUM 用户体验监控支持群”（<strong>钉钉群号：67370002064</strong>）进行咨询。</p>
<p><strong>相关链接：</strong></p>
<p>[1] 接入文档</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Farms%2Fuser-experience-monitoring%2Faccess-to-android-applications" target="_blank" title="https://help.aliyun.com/zh/arms/user-experience-monitoring/access-to-android-applications" ref="nofollow noopener noreferrer">help.aliyun.com/zh/arms/use…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 原生 app 和 WebView 如何交互？]]></title>    <link>https://juejin.cn/post/7571051830710779954</link>    <guid>https://juejin.cn/post/7571051830710779954</guid>    <pubDate>2025-11-11T07:54:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571051830710779954" data-draft-id="7571028035018866714" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 原生 app 和 WebView 如何交互？"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-11T07:54:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Vic_wkx"/> <meta itemprop="url" content="https://juejin.cn/user/1116759545357182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 原生 app 和 WebView 如何交互？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759545357182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Vic_wkx
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T07:54:10.000Z" title="Tue Nov 11 2025 07:54:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前言</h2>
<p>在移动开发中，我们有时候会遇到这样的需求：</p>
<ul>
<li>有一部分功能需要网页实现（比如登录页、主页，已经有网页端了，不希望在 app 中再写一遍）</li>
<li>另一部分功能需要原生实现（比如硬件访问、获取系统权限、或者一些注重性能的逻辑）</li>
</ul>
<p>这时候 <strong>Hybrid App（原生 + WebView 混合应用）</strong> 就派上用场了。</p>
<p>本文带你全面了解 <strong>Android 原生 App 和 WebView 的交互方式</strong>，并附上实战示例。</p>
<hr/>
<h2 data-id="heading-1">二、交互</h2>
<p>WebView 与原生 App 的交互也就两种：</p>
<ol>
<li><strong>网页调用 App 原生方法</strong>（JS → Native）</li>
<li><strong>App 调用网页 JS 方法</strong>（Native → JS）</li>
</ol>
<p>双向通信的典型场景：</p>

























<table><thead><tr><th>场景</th><th>方向</th><th>示例</th></tr></thead><tbody><tr><td>网页点击按钮调用 app 功能</td><td>JS → Native</td><td><code>window.myApp.nativeMethod('a')</code></td></tr><tr><td>App 收集设备信息反馈给网页</td><td>Native → JS</td><td><code>webView.evaluateJavascript("jsMethod('a', 'b')")</code></td></tr><tr><td>登录状态同步</td><td>双向</td><td>网页通知 App 用户登录了，App 也可以主动查询网页是否已登录</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-2">2.1 编写本地 html</h3>
<p>写一个本地的 html 文件 test_login.html，内容如下：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"utf-8"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Login Demo<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>Hybrid Login Demo<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"login()"</span>&gt;</span>Login<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"logout()"</span>&gt;</span>Logout<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">loginState</span> = { <span class="hljs-attr">isLoggedIn</span>: <span class="hljs-literal">false</span> };

    <span class="hljs-variable language_">window</span>.<span class="hljs-property">isUserLoggedIn</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"isUserLoggedIn = "</span> + <span class="hljs-variable language_">window</span>.<span class="hljs-property">loginState</span>.<span class="hljs-property">isLoggedIn</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">loginState</span>.<span class="hljs-property">isLoggedIn</span>;
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">login</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">window</span>.<span class="hljs-property">loginState</span>.<span class="hljs-property">isLoggedIn</span> = <span class="hljs-literal">true</span>;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Login success!"</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">myApp</span> &amp;&amp; <span class="hljs-variable language_">window</span>.<span class="hljs-property">myApp</span>.<span class="hljs-property">onLoginStateChanged</span>) {
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">myApp</span>.<span class="hljs-title function_">onLoginStateChanged</span>(<span class="hljs-literal">true</span>);
      }
    }

    <span class="hljs-keyword">function</span> <span class="hljs-title function_">logout</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">window</span>.<span class="hljs-property">loginState</span>.<span class="hljs-property">isLoggedIn</span> = <span class="hljs-literal">false</span>;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Logout success!"</span>);
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">myApp</span> &amp;&amp; <span class="hljs-variable language_">window</span>.<span class="hljs-property">myApp</span>.<span class="hljs-property">onLoginStateChanged</span>) {
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">myApp</span>.<span class="hljs-title function_">onLoginStateChanged</span>(<span class="hljs-literal">false</span>);
      }
    }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>运行效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc58a5cc910044f484bf4e55a4151dd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmljX3dreA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763452449&amp;x-signature=pmu9gv%2Bfk0BzD5Eqr5KThN7C31k%3D" alt="loginHtml.png" loading="lazy"/></p>
<p>可以看到，页面内容很简单，一个 title，两个按钮。一个用于登入，一个用于登出。</p>
<p>html 中维护了一个 loginState.isLoggedIn 属性，表示用户是否已登录。</p>
<p>提供了一个 isUserLoggedIn 函数，用于查询当前登录状态。</p>
<p>另外，还有一个 login 和一个 logout 方法，分别用于模拟登入登出，当状态改变后，通过 <code>window.myApp.onLoginStateChanged</code> 回调通知 app 登陆状态发生了改变。</p>
<h3 data-id="heading-3">2.2 编写 app</h3>
<p>为了便于测试，我们将 test_login.html 文件，放在 assets 文件夹下，app 上的 WebView 直接加载本地 url 即可。</p>
<p>MainActivity 完整代码：</p>
<pre><code class="hljs language-Kotlin" lang="Kotlin"><span class="hljs-keyword">package</span> com.example.interaction

<span class="hljs-keyword">import</span> android.os.Bundle
<span class="hljs-keyword">import</span> android.webkit.CookieManager
<span class="hljs-keyword">import</span> android.webkit.WebChromeClient
<span class="hljs-keyword">import</span> android.webkit.WebSettings
<span class="hljs-keyword">import</span> android.webkit.WebView
<span class="hljs-keyword">import</span> android.webkit.WebViewClient
<span class="hljs-keyword">import</span> android.widget.Toast
<span class="hljs-keyword">import</span> androidx.activity.ComponentActivity
<span class="hljs-keyword">import</span> androidx.activity.compose.setContent
<span class="hljs-keyword">import</span> androidx.activity.enableEdgeToEdge
<span class="hljs-keyword">import</span> androidx.compose.foundation.layout.*
<span class="hljs-keyword">import</span> androidx.compose.material3.Button
<span class="hljs-keyword">import</span> androidx.compose.material3.Scaffold
<span class="hljs-keyword">import</span> androidx.compose.material3.Text
<span class="hljs-keyword">import</span> androidx.compose.runtime.*
<span class="hljs-keyword">import</span> androidx.compose.ui.Modifier
<span class="hljs-keyword">import</span> androidx.compose.ui.platform.LocalContext
<span class="hljs-keyword">import</span> androidx.compose.ui.unit.dp
<span class="hljs-keyword">import</span> androidx.compose.ui.viewinterop.AndroidView
<span class="hljs-keyword">import</span> com.example.interaction.ui.theme.WebViewJsInteractionDemoTheme

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">ComponentActivity</span>() {

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        enableEdgeToEdge()
        setContent {
            WebViewJsInteractionDemoTheme {
                Scaffold(modifier = Modifier.fillMaxSize()) { innerPadding -&gt;
                    LoginWebView(modifier = Modifier.padding(innerPadding))
                }
            }
        }
    }
}

<span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">LoginWebView</span><span class="hljs-params">(modifier: <span class="hljs-type">Modifier</span> = Modifier)</span></span> {
    <span class="hljs-keyword">var</span> loginStatus <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-string">"Unknown"</span>) }
    <span class="hljs-keyword">val</span> context = LocalContext.current
    <span class="hljs-keyword">val</span> webViewRef = remember { mutableStateOf&lt;WebView?&gt;(<span class="hljs-literal">null</span>) }

    Column(modifier = modifier.fillMaxSize()) {
        AndroidView(
            modifier = Modifier
                .weight(<span class="hljs-number">1f</span>)
                .fillMaxWidth(),
            factory = { context -&gt;
                WebView(context).apply {
                    settings.apply {
                        javaScriptEnabled = <span class="hljs-literal">true</span>
                        domStorageEnabled = <span class="hljs-literal">true</span>
                        allowFileAccess = <span class="hljs-literal">true</span>
                        allowContentAccess = <span class="hljs-literal">true</span>
                        cacheMode = WebSettings.LOAD_DEFAULT
                    }
                    webChromeClient = WebChromeClient()

                    webViewClient = <span class="hljs-keyword">object</span> : WebViewClient() {
                        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onPageFinished</span><span class="hljs-params">(view: <span class="hljs-type">WebView</span>?, url: <span class="hljs-type">String</span>?)</span></span> {
                            <span class="hljs-keyword">super</span>.onPageFinished(view, url)
                            <span class="hljs-comment">// Query login status when page is loaded</span>
                            evaluateJavascript(<span class="hljs-string">"isUserLoggedIn()"</span>) { result -&gt;
                                <span class="hljs-keyword">val</span> isLoggedIn = result?.contains(<span class="hljs-string">"true"</span>) == <span class="hljs-literal">true</span>
                                loginStatus = <span class="hljs-keyword">if</span> (isLoggedIn) <span class="hljs-string">"Logged In"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"Logged Out"</span>
                            }
                        }
                    }

                    <span class="hljs-comment">// Register the JavaScript interface</span>
                    addJavascriptInterface(<span class="hljs-keyword">object</span> {
                        <span class="hljs-meta">@android</span>.webkit.JavascriptInterface
                        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onLoginStateChanged</span><span class="hljs-params">(isLoggedIn: <span class="hljs-type">Boolean</span>)</span></span> {
                            (context <span class="hljs-keyword">as</span> ComponentActivity).runOnUiThread {
                                loginStatus = <span class="hljs-keyword">if</span> (isLoggedIn) <span class="hljs-string">"Logged In"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"Logged Out"</span>
                                Toast.makeText(context, <span class="hljs-string">"Login status changed: <span class="hljs-variable">$loginStatus</span>"</span>, Toast.LENGTH_SHORT).show()
                            }
                        }
                    }, <span class="hljs-string">"myApp"</span>)

                    WebView.setWebContentsDebuggingEnabled(<span class="hljs-literal">true</span>)
                    CookieManager.getInstance().setAcceptCookie(<span class="hljs-literal">true</span>)

                    loadUrl(<span class="hljs-string">"file:///android_asset/test_login.html"</span>)
                    webViewRef.value = <span class="hljs-keyword">this</span>
                }
            }
        )

        Spacer(modifier = Modifier.height(<span class="hljs-number">16.</span>dp))

        <span class="hljs-comment">// Check login status button</span>
        Button(
            onClick = {
                webViewRef.value?.evaluateJavascript(<span class="hljs-string">"isUserLoggedIn()"</span>) { result -&gt;
                    <span class="hljs-keyword">val</span> isLoggedIn = result?.contains(<span class="hljs-string">"true"</span>) == <span class="hljs-literal">true</span>
                    loginStatus = <span class="hljs-keyword">if</span> (isLoggedIn) <span class="hljs-string">"Logged In"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"Logged Out"</span>
                    Toast.makeText(context, <span class="hljs-string">"Login status: <span class="hljs-variable">$loginStatus</span>"</span>, Toast.LENGTH_SHORT).show()
                }
            },
            modifier = Modifier
                .fillMaxWidth()
                .padding(horizontal = <span class="hljs-number">16.</span>dp)
        ) {
            Text(<span class="hljs-string">"Check Login Status"</span>)
        }

        Spacer(modifier = Modifier.height(<span class="hljs-number">8.</span>dp))

        Text(
            text = <span class="hljs-string">"Current Status: <span class="hljs-variable">$loginStatus</span>"</span>,
            modifier = Modifier.padding(horizontal = <span class="hljs-number">16.</span>dp)
        )
    }
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5380cf1266934b0b9f6aeb7da6897c15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmljX3dreA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763452449&amp;x-signature=LBEryz%2B02B%2BN%2F1uqSnU02IOIZuk%3D" alt="loginDemo.gif" loading="lazy"/></p>
<p>可以看到，在 MainActivity 中，通过 addJavascriptInterface 函数添加了 onLoginStateChanged 接口供 Web 端调用，添加接口时，第二个参数是 name，Web 端将通过 <code>name.接口名</code> 来调用对应的接口，例如：<code>window.myApp.onLoginStateChanged(true);</code>。</p>
<p>在点击 Check Login Status 按钮后，通过 WebView 的 evaluateJavascript 函数调用网页端的 isUserLoggedIn 函数，收到 result 后，更新 loginStatus 变量。</p>
<p>另外，还自定义了 WebViewClient，在 onPageFinished 调用后，主动调用一次 isUserLoggedIn 函数，完成 Current Status 的初始化。</p>
<h2 data-id="heading-4">三、后话</h2>
<p>有一些需要注意的点：</p>
<ul>
<li>调用 js 方法时，结果是异步返回的，通过 listener 接收结果。</li>
<li><code>@JavascriptInterface</code> 的方法在 <strong>非 UI 线程</strong> 执行，如果要更新 UI，需要使用 <code>runOnUiThread</code>。</li>
<li>设置了 <code>WebView.setWebContentsDebuggingEnabled(true)</code> 之后，通过 Chrome DevTools 可直接调试 WebView。方法是在 app 加载了网页后，在 Chrome 浏览器访问 <code>chrome://inspect/#devices</code>，在这里找到自己的设备，点击 inspect。我对这种方式不是很熟悉，就不过多介绍了。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db2ea15ecbc34ed0b9002afbd76172dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVmljX3dreA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763452449&amp;x-signature=DI%2Bvvqwxu%2BQZ9Xsygf1GxP0dCDM%3D" alt="chrome.png" loading="lazy"/></p>
<h2 data-id="heading-5">附：一些常见的问题</h2>
<blockquote>
<p>注：这一节是 AI 总结的，不保真：</p>
</blockquote>
<p>在 WebView 中，通过 webView.settings 可以获取到 WebSettings，它可以用来配置一系列网页渲染与访问能力。以下是关键属性解释：</p>

























































































<table><thead><tr><th>属性</th><th>作用</th><th>是否常用</th><th>注意事项</th></tr></thead><tbody><tr><td><code>javaScriptEnabled = true</code></td><td>启用网页中的 JavaScript 执行。没有这个，网页的交互和动态内容几乎全失效。</td><td>✅ 必须</td><td>启用 JS 后要配合 <code>addJavascriptInterface</code> 谨慎使用，否则存在安全隐患。</td></tr><tr><td><code>domStorageEnabled = true</code></td><td>启用 HTML5 的 DOM Storage（<code>localStorage</code> / <code>sessionStorage</code>）。网页才能保存本地状态。</td><td>✅ 常用</td><td>现代 Web 必备。</td></tr><tr><td><code>databaseEnabled = true</code></td><td>启用 Web SQL 数据库（旧标准）。</td><td>⚠️ 较旧</td><td>新网页一般用 IndexedDB。</td></tr><tr><td><code>allowFileAccess = true</code></td><td>允许访问本地文件（<code>file://</code>）。</td><td>✅ 常用</td><td>某些 WebView 资源加载或本地调试需要。</td></tr><tr><td><code>allowContentAccess = true</code></td><td>允许访问 <code>content://</code> URI 内容（如系统媒体）。</td><td>✅ 常用</td><td>安全风险低。</td></tr><tr><td><code>allowFileAccessFromFileURLs = true</code></td><td>允许网页 JS 从 file:// 页面访问其他本地文件。</td><td>⚠️ 慎用</td><td>容易被恶意网页利用本地文件。</td></tr><tr><td><code>allowUniversalAccessFromFileURLs = true</code></td><td>允许 file:// 页面访问任意网络资源（http/https）。</td><td>⚠️ 高风险</td><td>建议仅限调试环境启用。</td></tr><tr><td><code>useWideViewPort = true</code></td><td>启用自适应宽度，让网页以「网页比例」显示而非手机分辨率。</td><td>✅ 常用</td><td>与 <code>loadWithOverviewMode</code> 一起使用更佳。</td></tr><tr><td><code>loadWithOverviewMode = true</code></td><td>缩放网页以适配屏幕宽度。</td><td>✅ 常用</td><td>常配合 responsive 页面。</td></tr><tr><td><code>setSupportZoom(true)</code></td><td>支持缩放。</td><td>✅ 常用</td><td>可搭配手势操作。</td></tr><tr><td><code>builtInZoomControls = true</code></td><td>启用内建缩放按钮。</td><td>✅ 可选</td><td>通常在调试或旧网页中启用。</td></tr><tr><td><code>displayZoomControls = false</code></td><td>隐藏默认的缩放控件（仅保留手势缩放）。</td><td>✅ 推荐</td><td>提升视觉体验。</td></tr><tr><td><code>cacheMode = WebSettings.LOAD_DEFAULT</code></td><td>启用缓存策略。</td><td>✅ 常用</td><td>可选 <code>LOAD_NO_CACHE</code> 禁止缓存。</td></tr></tbody></table>
<p>WebViewClient 和 WebChromeClient 的区别：</p>



































<table><thead><tr><th>对比项</th><th><code>WebViewClient</code></th><th><code>WebChromeClient</code></th></tr></thead><tbody><tr><td>职责</td><td>控制页面导航与加载逻辑</td><td>控制网页中“浏览器行为”与 UI 事件</td></tr><tr><td>常用回调</td><td><code>shouldOverrideUrlLoading</code>、<code>onPageStarted</code>、<code>onPageFinished</code>、<code>onReceivedError</code></td><td><code>onProgressChanged</code>、<code>onReceivedTitle</code>、<code>onConsoleMessage</code>、<code>onJsAlert</code></td></tr><tr><td>场景举例</td><td>拦截跳转、处理自定义 URL Scheme、控制加载动画</td><td>显示网页标题、监控加载进度、拦截 JS 弹窗、打印调试信息</td></tr><tr><td>比喻</td><td>浏览器“司机”</td><td>浏览器“仪表盘”</td></tr><tr><td>建议</td><td>必须设置一个（否则无法处理跳转）</td><td>可选（但调试与交互建议加）</td></tr></tbody></table>
<p>👉 <strong>总结一句话</strong>：</p>
<blockquote>
<p><code>WebViewClient</code> 负责“页面去哪”，<code>WebChromeClient</code> 负责“页面看起来怎样”。</p>
</blockquote>
<p>其他关键配置：</p>

























<table><thead><tr><th>配置</th><th>作用</th></tr></thead><tbody><tr><td><code>setLayerType(View.LAYER_TYPE_HARDWARE, null)</code></td><td>启用硬件加速，提升渲染性能（尤其是视频或动画）。</td></tr><tr><td><code>setOnLongClickListener { true }</code> + <code>isLongClickable = false</code></td><td>禁用长按（防止复制或保存图片）。</td></tr><tr><td><code>WebView.setWebContentsDebuggingEnabled(true)</code></td><td>允许通过 Chrome 调试网页内容（chrome://inspect）。</td></tr><tr><td><code>CookieManager.getInstance().setAcceptThirdPartyCookies(...)</code></td><td/></tr></tbody></table>
<p>以上就是本文的全部内容了，如果你喜欢本文的内容，欢迎点赞、投币、收藏、转发，更重要的是点一个大大的关注，这对我们有非常大的帮助......</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么我的react项目启动后，dom上的类名里没有代码位置信息]]></title>    <link>https://juejin.cn/post/7571279513247825946</link>    <guid>https://juejin.cn/post/7571279513247825946</guid>    <pubDate>2025-11-11T13:35:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571279513247825946" data-draft-id="7571351275976015923" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么我的react项目启动后，dom上的类名里没有代码位置信息"/> <meta itemprop="keywords" content="React.js,前端"/> <meta itemprop="datePublished" content="2025-11-11T13:35:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么我的react项目启动后，dom上的类名里没有代码位置信息
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T13:35:54.000Z" title="Tue Nov 11 2025 13:35:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近在写一个新的 React 项目，打开浏览器开发者工具，发现个有意思的事：之前团队一起写的项目在 Elements 面板里，每个 DOM 元素都带着一堆 <code>data-component-*</code> 属性，能直接看到是哪个文件的哪一行代码。而这个我自己新起的项目就只有普通的 HTML 标签。</p>
<p>这到底咋回事？是不是有什么调试神器？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1941db24d5df4402a5a59b95bf33328a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763472954&amp;x-signature=mWHd1MY8FRhsr9Xm6Yqzpj%2F1NEs%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">React 的 DOM 为啥看不到组件名？</h2>
<p>先说个基础知识：React 组件最终会被编译成普通 HTML。你在 Elements 面板看到的是<strong>真实 DOM</strong>，不是 React 的虚拟 DOM。</p>
<p>比如这个组件：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">MyButton</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"my-btn"</span>&gt;</span>Click me<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>;
}
</code></pre>
<p>浏览器里只会看到：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"my-btn"</span>&gt;</span>Click me<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<p>组件名 <code>MyButton</code> 根本不会出现在 DOM 里，因为它只是个 JavaScript 函数，最后返回的就是这个 <code>button</code> 元素。</p>
<h2 data-id="heading-1">那些能看到组件信息的项目是怎么做到的？</h2>
<p>看了别人的项目代码，发现都用了 Vite 调试插件。这类插件会给每个 React 元素注入调试属性：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
  <span class="hljs-attr">data-inspector</span>=<span class="hljs-string">"src/pages/HomePage.tsx:42:7"</span>
  <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>
&gt;</span>
  <span class="hljs-comment">&lt;!-- 内容 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>属性格式是 <code>文件路径:行号:列号</code>，一眼就能看出组件来源。</p>
<p>更强大的是，有些插件还支持<strong>点击页面元素直接跳转到 VS Code 源码</strong>！这才是真正的效率神器。</p>
<h2 data-id="heading-2">解决方案：vite-plugin-react-inspector</h2>
<p><code>vite-plugin-react-inspector</code> 是专门为 Vite + React 项目设计的调试工具，功能强大且易用。</p>
<h3 data-id="heading-3">安装</h3>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D vite-plugin-react-inspector
<span class="hljs-comment"># 或</span>
npm install -D vite-plugin-react-inspector
</code></pre>
<h3 data-id="heading-4">配置很简单</h3>
<p>在 <code>vite.config.ts</code> 里添加：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>;
<span class="hljs-keyword">import</span> react <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-react'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Inspector</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-react-inspector'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(<span class="hljs-function">(<span class="hljs-params">{ mode }</span>) =&gt;</span> ({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">react</span>(),
    <span class="hljs-comment">// 只在开发模式启用</span>
    mode === <span class="hljs-string">'development'</span> &amp;&amp;
      <span class="hljs-title class_">Inspector</span>({
        <span class="hljs-attr">toggleButtonVisibility</span>: <span class="hljs-string">'always'</span>,
        <span class="hljs-attr">toggleComboKey</span>: <span class="hljs-string">'alt-shift'</span>,
      }),
  ].<span class="hljs-title function_">filter</span>(<span class="hljs-title class_">Boolean</span>),
}));
</code></pre>
<p>配置说明：</p>
<ul>
<li><code>toggleButtonVisibility: 'always'</code> - 始终显示检查器按钮</li>
<li><code>toggleComboKey: 'alt-shift'</code> - 使用 Alt+Shift 快捷键激活</li>
<li><code>mode === 'development'</code> - 生产环境自动禁用</li>
</ul>
<h3 data-id="heading-5">实际效果</h3>
<p>启动开发服务器后，在浏览器里看到的 DOM：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1221e687568c4d508cbee6eb65abca39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lmf5peg6aOO6Zuo5Lmf6Zu-5pm0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763472954&amp;x-signature=1Mnmxe%2BvP%2BBax%2FqeBL4mUT9T%2FMg%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">data-inspector</span>=<span class="hljs-string">"src/pages/HomePage.tsx:42:7"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 内容 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>属性格式是 <code>文件路径:行号:列号</code>，一眼就能看出来源。</p>
<p>然后复制在vscode搜索，直接就跳转到源码位置了。</p>
<h3 data-id="heading-6">仓库地址</h3>
<p><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsudongyuer%2Fvite-plugin-react-inspector" target="_blank" title="https://github.com/sudongyuer/vite-plugin-react-inspector" ref="nofollow noopener noreferrer">vite-plugin-react-inspector</a></strong> - GitHub 仓库，查看完整文档</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 AI 驱动的威胁狩猎提升公共部门的网络防御]]></title>    <link>https://juejin.cn/post/7571399272496447551</link>    <guid>https://juejin.cn/post/7571399272496447551</guid>    <pubDate>2025-11-12T07:10:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571399272496447551" data-draft-id="7571621555512590390" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 AI 驱动的威胁狩猎提升公共部门的网络防御"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2025-11-12T07:10:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 AI 驱动的威胁狩猎提升公共部门的网络防御
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T07:10:58.000Z" title="Wed Nov 12 2025 07:10:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：来自 Elastic <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fblog%2Fauthor%2Fbrixton-pizzuti" title="https://www.elastic.co/blog/author/brixton-pizzuti" target="_blank" ref="nofollow noopener noreferrer">Brixton Pizzuti</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d056f4b089f44559075186d6f2463ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763536258&amp;x-signature=sWqrqKfOEmPYbkMJoY0NIKNfDYU%3D" alt="" loading="lazy"/></p>
<p>公共部门组织面临复杂且持久的威胁 — 38% 的公共部门组织表示他们的<a href="https://link.juejin.cn?target=https%3A%2F%2Freports.weforum.org%2Fdocs%2FWEF_Global_Cybersecurity_Outlook_2025.pdf" title="https://reports.weforum.org/docs/WEF_Global_Cybersecurity_Outlook_2025.pdf" target="_blank" ref="nofollow noopener noreferrer">网络弹性不足</a>，而中大型私营企业中这一比例仅为 10%。由于敏感数据和关键基础设施面临风险，各机构需要能够主动检测和快速调查的工具，同时确保数据始终处于安全边界内。</p>
<p>Elastic Security —— 最近在 <a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F153396179" title="https://elasticstack.blog.csdn.net/article/details/153396179" target="_blank" ref="nofollow noopener noreferrer">2025 年 Gartner SIEM 魔力象限中被评为 “远见者”</a>—— 提供了一个综合平台，帮助公共部门组织强化<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsecurity%2Fthreat-hunting" title="https://www.elastic.co/security/threat-hunting" target="_blank" ref="nofollow noopener noreferrer">威胁狩猎能力</a>。在这篇博客中，我们将探讨真实案例、经过验证的工作流程以及 AI 驱动的功能，展示 Elastic 如何在威胁狩猎中成为变革者。</p>
<h2 data-id="heading-0">公共部门进行威胁狩猎的必要性</h2>
<p>威胁狩猎是一种主动的网络安全策略，旨在寻找可能绕过传统安全防御的威胁。与被动措施不同，威胁狩猎专注于预判、识别并消除威胁于未然。对于公共部门组织而言，这种主动方式对保护敏感数据和维持关键基础设施的韧性至关重要。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9a80079baae842be98e3360a28bef6f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763536258&amp;x-signature=XWQAohBoy3f0pnc7LE9iCtiXsas%3D" alt="" loading="lazy"/></p>
<p>上面的选项是 - 哪种说法更准确地描述了你所在组织的网络安全状况？：</p>
<ul>
<li>
<p>Cyber security is a proactive endeavor, using offensive tactics to hunt, discover, and eliminate threats before or during an attack - 网络安全是一项主动的工作，利用进攻性策略在攻击发生前或进行中狩猎、发现并消除威胁</p>
</li>
<li>
<p>Cybersecurity is a reactive endeavor, using defensive methods to detect anomalies in network, application, data, and user behavior associated with threats- 网络安全是一项被动的工作，利用防御性方法检测与威胁相关的网络、应用、数据和用户行为中的异常</p>
</li>
<li>
<p>Dont know - 不知道</p>
</li>
</ul>
<h2 data-id="heading-1">技术支撑</h2>
<p>Elastic 提供了一套非常适合主动<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsecurity%2Fthreat-hunting" title="https://www.elastic.co/security/threat-hunting" target="_blank" ref="nofollow noopener noreferrer">威胁检测和调查的工具</a>。让我们深入了解使其不可或缺的技术特性：</p>
<p>1）<strong>分布式数据网格架构</strong>：Elastic 实现了来自多种来源的大规模数据的无缝摄取和处理。在公共部门中，分布式数据网格方法使安全团队能够快速摄取、处理并分析来自多个机构和地区的庞大且多样的数据流，从而确保关键基础设施上的威胁检测具有可扩展性、弹性和实时性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/321c86849fc7475a914732278acc87bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763536258&amp;x-signature=KfVukbX1wv0q0Iki7jHaZey1W5M%3D" alt="" loading="lazy"/></p>
<p>2）<strong>用于可视化的 Kibana</strong>：Kibana 是 Elastic 直观的仪表板和可视化工具，使公共部门组织能够快速发现复杂安全数据中的异常、趋势和关联。这种可视化能力帮助他们在不同系统、管辖区和机密级别间做出更有依据的威胁狩猎决策。</p>
<p>3）Elastic 的性能：对于公共部门机构而言，Elastic 强大且可靠的搜索能力使其能够对来自不同部门、管辖区和关键基础设施系统的庞大多源数据集进行查询和关联。这使得对协同攻击的检测更快，并显著缩短了对可能影响公共安全或国家安全的威胁的响应时间。Elastic Security 帮助客户实现了<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fblog%2Fgovernment-cybersecurity-consolidating-ai-ml" title="https://www.elastic.co/blog/government-cybersecurity-consolidating-ai-ml" target="_blank" ref="nofollow noopener noreferrer">以下成果</a>：</p>
<ul>
<li>年风险暴露减少 36%</li>
<li>安全事件和事故减少 90%</li>
<li>全职安全人员工时回收 74%，让团队能够专注于更具战略性的任务</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b583fec3a9b4c5e96b9267739218765~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763536258&amp;x-signature=Y3EXFkubTr3jANary9kLAdTzl0U%3D" alt="" loading="lazy"/></p>
<p>4）用于异常检测的机器学习（ML）：Elastic 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Felasticsearch%2Fmachine-learning" title="https://www.elastic.co/elasticsearch/machine-learning" target="_blank" ref="nofollow noopener noreferrer">ML</a> 功能能自动识别偏离正常行为的情况，帮助公共部门安全团队发现威胁、减少误报，并及早检测出细微的攻击模式。通过持续适应不断变化的环境，ML 加强了关键基础设施和公共服务的防御能力。事实上，客户报告称，借助 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsecurity" title="https://www.elastic.co/security" target="_blank" ref="nofollow noopener noreferrer">Elastic Security</a> 的机器学习驱动异常检测，误报率降低了 75%。</p>
<h2 data-id="heading-2"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58bb9cbb0f5d4026bb6ee7625c568fb0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763536258&amp;x-signature=l4InKO2iyCYY2paOxbkQjhiJeuQ%3D" alt="" loading="lazy"/></h2>
<h2 data-id="heading-3">使用 Elastic Security 的 AI 功能进行威胁狩猎</h2>
<p>Elastic Security 集成了 <strong>AI 驱动的功能</strong>，加速了检测、调查和响应。在探索 Elastic 的 AI 功能之前，了解 <strong>Elastic Managed 大型语言模型（LLM）的基础</strong>非常重要。</p>
<h3 data-id="heading-4">Elastic Managed LLM：用于安全工作流的安全可扩展 AI</h3>
<p>除了可以部署你自己的 LLM 模型外，Elastic Managed LLM 还将<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fgenerative-ai" title="https://www.elastic.co/generative-ai" target="_blank" ref="nofollow noopener noreferrer">生成式 AI</a> 的能力直接引入你的安全操作中，而无需承担托管或维护 AI 基础设施的复杂性。</p>
<p>Elastic Managed LLM 的主要功能包括：</p>
<ul>
<li>
<p><strong>完全托管且安全</strong>：托管于 Elastic Cloud 内，设计满足公共部门的合规和安全要求。注意：所有数据在传输中均加密。LLM 配置为零数据保留——模型不会存储任何提示或输出。</p>
</li>
<li>
<p><strong>针对安全用例优化</strong>：经过微调以理解威胁情报、日志数据和事件响应工作流程</p>
</li>
<li>
<p><strong>无缝集成</strong>：与 Elastic Security 的功能如 Attack Discovery 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Felasticsearch%2Fai-assistant" title="https://www.elastic.co/elasticsearch/ai-assistant" target="_blank" ref="nofollow noopener noreferrer">Elastic AI Assistant</a> 原生兼容</p>
</li>
<li>
<p><strong>可扩展性能</strong>：处理大量数据和查询而不影响操作速度</p>
</li>
</ul>
<p>借助 Elastic Managed LLM，公共部门安全团队可以在保持控制、隐私和合规的同时使用先进的 AI 功能。</p>
<h3 data-id="heading-5">攻击发现：用 AI 揭示协同威胁</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdemo-gallery%2Fsecurity-attack-discovery" title="https://www.elastic.co/demo-gallery/security-attack-discovery" target="_blank" ref="nofollow noopener noreferrer">Elastic 的 Attack Discovery</a> 功能利用 AI 揭示事件之间隐藏的联系，暴露可能被忽视的协同威胁。通过及早发现这些关联，公共部门安全团队可以打断复杂攻击，保护关键系统，并保障社区依赖的服务。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38e818c6f86a4b32b2ba55c94334aeed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763536258&amp;x-signature=xqV%2FJ1%2FbWJGRkG1nATN4BjP42kg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">Elastic AI Assistant：你的安全操作副驾</h2>
<p>Elastic AI Assistant 使公共部门安全团队能够将复杂数据转化为清晰、可操作的情报。通过指导调查、突出可疑活动并提供即时背景，它帮助分析师更快地从检测转向解决——加强关键基础设施和市民日常依赖服务的防御。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f101bc32711c46a18e3401553133ff55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763536258&amp;x-signature=jofJOwuR0v7AgbNkrbRR2wdTXUQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">Elastic 如何检测和应对协同钓鱼攻击</h2>
<p>以下是 Elastic 的能力如何协同工作以检测和应对协同钓鱼攻击的方式。</p>
<p>1）<strong>ML 标记异常登录</strong>：你的 ML 任务检测到来自外国区域的失败登录激增，随后同一账户在几分钟内的成功登录突然增加。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48eb87dfb8764ec5a8affa4ddc962cba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763536258&amp;x-signature=CFswAh9VExA%2BfvHhEYhJPXL6cSU%3D" alt="" loading="lazy"/></p>
<p>2）时间线和仪表板确认模式：在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fkibana" title="https://www.elastic.co/kibana" target="_blank" ref="nofollow noopener noreferrer">Kibana</a> 中，时间线视图显示多个用户和终端的协同登录尝试。你识别出共同的用户代理和重叠的 IP 范围，确认这些活动是更大范围有组织行动的一部分。</p>
<p><img alt="转存失败，建议直接上传图片文件" src="" loading="lazy"/></p>
<p>3）<strong>攻击发现连接活动</strong>：Attack Discovery 将失败和成功的登录、相关的邮件网关警报以及终端登录聚合为单一的关联事件。它识别出可能的钓鱼诱饵、凭证收集活动以及随后的内部资源访问。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffd7e989d53543acbded443eb11c9ca1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763536258&amp;x-signature=wmBd9eY59xZd6qCHkYBehXgHqzM%3D" alt="" loading="lazy"/></p>
<p>4）<strong>Elastic AI Assistant 加速调查</strong>：该助手生成结构化事件简报，详细说明受影响的账户、入侵途径、时间窗口以及高风险后续活动。它还会推荐遏制措施，如强制密码重置、会话撤销以及多因素认证（MFA）注册审查。</p>
<p>此外，Elastic AI Assistant 与你组织的上下文深度集成。你可以用它查询过去的事件、审查防火墙配置，并访问特定于组织的运营数据，确保每条建议和洞察都与独特环境相关。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cda4416456a94b62b23068e7d4f1f88b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763536258&amp;x-signature=VgxW3n1VZG7YIkFO8wlzkZypXB8%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/589ea844e56e4ef09a4f11f6e2ccfe8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763536258&amp;x-signature=FW2%2FbiGOuFEPqfwPJUuXdF1k0Kw%3D" alt="" loading="lazy"/></p>
<p>5）<strong>分析师验证并遏制</strong>：分析师使用 Discover 通过审查 MFA 绕过事件、新创建的邮箱规则和异常 OAuth 授权来验证 Elastic AI Assistant 的建议。基于这些信息，安全分析师可以禁用受损账户、撤销令牌、隔离受影响终端，并阻止恶意 IP。</p>
<p>6）<strong>调查以正式报告结束</strong>：调查以简明报告收尾，涵盖范围、影响范围、当前状态以及推荐的后续步骤。该总结为合规、管理层审查以及持续提升安全态势提供了清晰记录。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6779d5a7d8ad41328297d5c33491e691~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763536258&amp;x-signature=GRpsu13FScZ1uvkfEnL7Vzzc9LY%3D" alt="" loading="lazy"/></p>
<p>7）<strong>分析师增强未来检测流程</strong>：分析师标记相关痕迹，针对诱饵指标创建新的检测规则，并使用新示例调整 ML 任务以提高准确性。他们还将检测时间和响应时间作为关键指标进行跟踪。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f700a367f6334a3cb942dd9757c7fd4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763536258&amp;x-signature=Js%2FbwmfC648BPA96YJ89uHoqQ8E%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8">公共部门 Elastic 威胁狩猎的关键要点</h2>
<p>Elastic Security 为公共部门组织提供了一个全面的、增强 AI 的平台，以提升其威胁狩猎能力。通过结合分布式数据网格架构、强大的搜索、先进的 ML 以及 Attack Discovery 和 Elastic AI Assistant 等 AI 功能，各机构能够主动识别和缓解威胁 —— 保护敏感数据和关键基础设施，同时维持公众信任。</p>
<p>Elastic Managed LLM 旨在满足公共部门组织的独特需求。它将先进的 AI 能力与政府环境所需的安全性、合规性和可扩展性相结合。在 Elastic 的安全架构内运行，它支持自然语言查询、上下文威胁分析和自动化调查辅助，同时不会将敏感数据暴露给外部系统。通过针对公共部门威胁狩猎中常见的多源、多样化数据集定制模型，Elastic 确保各机构能够利用 AI 加速检测和响应，同时保持严格的数据治理和法规合规。</p>
<p><strong>相关资源</strong>：</p>
<ul>
<li>
<p>博客：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fblog%2Fgovernment-cybersecurity-consolidating-ai-ml" title="https://www.elastic.co/blog/government-cybersecurity-consolidating-ai-ml" target="_blank" ref="nofollow noopener noreferrer">政府网络安全：使用 AI &amp; ML 整合工具和成本</a></p>
</li>
<li>
<p>电子书：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fpublic-sector%2Fsecurity-in-action-in-public-sector" title="https://www.elastic.co/public-sector/security-in-action-in-public-sector" target="_blank" ref="nofollow noopener noreferrer">Elastic Security 在公共部门的实际应用</a></p>
</li>
<li>
<p>网页：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fsecurity%2Fthreat-hunting" title="https://www.elastic.co/security/threat-hunting" target="_blank" ref="nofollow noopener noreferrer">Elastic Security 威胁狩猎</a></p>
</li>
</ul>
<p><em>本篇博客中描述的任何功能或特性发布及时间完全由 Elastic 自行决定。任何当前不可用的功能或特性可能无法按时或根本无法提供。</em></p>
<p><em>在本博客中，我们可能使用或引用了第三方生成式 AI 工具，这些工具由其各自所有者拥有和运营。Elastic 对第三方工具没有控制权，也不对其内容、操作或使用承担任何责任或义务，也不对你使用这些工具可能产生的任何损失或损害负责。在使用 AI 工具处理个人、敏感或机密信息时，请谨慎操作。你提交的任何数据可能会被用于 AI 训练或其他用途。无法保证你提供的信息将被安全或保密地保存。你在使用任何生成式 AI 工具前，应熟悉其隐私政策和使用条款。</em></p>
<p><em>Elastic、Elasticsearch 及相关标识是 Elasticsearch B.V. 在美国及其他国家的商标、标识或注册商标。所有其他公司和产品名称均为其各自所有者的商标、标识或注册商标。</em></p>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fblog%2Fpublic-sector-cyber-defense-ai-threat-hunting" title="https://www.elastic.co/blog/public-sector-cyber-defense-ai-threat-hunting" target="_blank" ref="nofollow noopener noreferrer">www.elastic.co/blog/public…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring事务隔离级别全解析：从读未提交到序列化]]></title>    <link>https://juejin.cn/post/7571427088072736794</link>    <guid>https://juejin.cn/post/7571427088072736794</guid>    <pubDate>2025-11-12T08:38:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571427088072736794" data-draft-id="7570978150009569318" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring事务隔离级别全解析：从读未提交到序列化"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-12T08:38:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大头an"/> <meta itemprop="url" content="https://juejin.cn/user/618374030438861"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring事务隔离级别全解析：从读未提交到序列化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/618374030438861/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大头an
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T08:38:01.000Z" title="Wed Nov 12 2025 08:38:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p>在并发访问的数据库系统中，多个事务同时操作相同数据时，会出现各种并发问题。Spring事务隔离级别正是为了解决这些问题而设计。但你是否真正理解脏读、不可重复读、幻读的区别？是否知道如何为你的业务场景选择合适的隔离级别？本文将深入探讨事务隔离级别的原理、问题场景和实战应用。</p>
</blockquote>
<h2 data-id="heading-1">什么是事务隔离级别？</h2>
<p>事务隔离级别定义了一个事务可能受其他并发事务影响的程度。SQL标准定义了4种隔离级别，Spring在此基础上提供了相应的配置支持。</p>
<h3 data-id="heading-2">并发访问的三大问题</h3>
<p>在深入隔离级别之前，我们先了解需要解决的三大并发问题：</p>
<h4 data-id="heading-3">1. 脏读（Dirty Read）</h4>
<p>一个事务读取了另一个未提交事务修改的数据。</p>
<p><strong>场景示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 事务1</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transaction1</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 更新用户余额为500（未提交）</span>
    userMapper.updateBalance(userId, <span class="hljs-number">500</span>);
    
    <span class="hljs-comment">// 此时事务2读取到余额500（脏读）</span>
    <span class="hljs-comment">// 然后事务1回滚，余额恢复为1000</span>
    <span class="hljs-comment">// 事务2读到了不存在的数据</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"业务异常"</span>);
}

<span class="hljs-comment">// 事务2  </span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transaction2</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 读取到未提交的余额500（脏数据）</span>
    <span class="hljs-type">Integer</span> <span class="hljs-variable">balance</span> <span class="hljs-operator">=</span> userMapper.selectBalance(userId);
    System.out.println(balance); <span class="hljs-comment">// 输出：500（实际应该是1000）</span>
}
</code></pre>
<h4 data-id="heading-4">2. 不可重复读（Non-repeatable Read）</h4>
<p>同一个事务中，多次读取同一数据得到不同结果。</p>
<p><strong>场景示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkAndProcess</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 第一次读取</span>
    <span class="hljs-type">Integer</span> <span class="hljs-variable">balance1</span> <span class="hljs-operator">=</span> userMapper.selectBalance(userId);
    System.out.println(<span class="hljs-string">"第一次查询余额："</span> + balance1); <span class="hljs-comment">// 1000</span>
    
    <span class="hljs-comment">// 此时其他事务修改了余额并提交</span>
    <span class="hljs-comment">// 事务2：userMapper.updateBalance(userId, 800);</span>
    
    <span class="hljs-comment">// 第二次读取（相同事务内）</span>
    <span class="hljs-type">Integer</span> <span class="hljs-variable">balance2</span> <span class="hljs-operator">=</span> userMapper.selectBalance(userId);
    System.out.println(<span class="hljs-string">"第二次查询余额："</span> + balance2); <span class="hljs-comment">// 800</span>
    
    <span class="hljs-comment">// 两次读取结果不一致！</span>
    <span class="hljs-keyword">if</span> (!balance1.equals(balance2)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"数据在事务期间被修改"</span>);
    }
}
</code></pre>
<h4 data-id="heading-5">3. 幻读（Phantom Read）</h4>
<p>同一个事务中，多次查询同一范围的数据，返回的记录数量不同。</p>
<p><strong>场景示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchProcessUsers</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 第一次查询：统计待处理用户</span>
    List&lt;User&gt; users1 = userMapper.selectByStatus(<span class="hljs-string">"PENDING"</span>);
    <span class="hljs-type">int</span> <span class="hljs-variable">count1</span> <span class="hljs-operator">=</span> users1.size();
    System.out.println(<span class="hljs-string">"待处理用户数："</span> + count1); <span class="hljs-comment">// 5</span>
    
    <span class="hljs-comment">// 此时其他事务插入了新的待处理用户并提交</span>
    <span class="hljs-comment">// 事务2：userMapper.insert(new User("PENDING"));</span>
    
    <span class="hljs-comment">// 第二次查询（相同事务内）</span>
    List&lt;User&gt; users2 = userMapper.selectByStatus(<span class="hljs-string">"PENDING"</span>); 
    <span class="hljs-type">int</span> <span class="hljs-variable">count2</span> <span class="hljs-operator">=</span> users2.size();
    System.out.println(<span class="hljs-string">"待处理用户数："</span> + count2); <span class="hljs-comment">// 6</span>
    
    <span class="hljs-comment">// 记录数量发生变化！</span>
    <span class="hljs-keyword">if</span> (count1 != count2) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"查询结果集在事务期间发生变化"</span>);
    }
}
</code></pre>
<h2 data-id="heading-6">Spring事务隔离级别详解</h2>
<p>Spring提供了5种隔离级别配置，对应不同的并发控制强度。</p>
<h3 data-id="heading-7">1. ISOLATION_READ_UNCOMMITTED（读未提交）</h3>
<p><strong>定义</strong>：允许读取未提交的数据变更。</p>
<p><strong>解决的问题</strong>：无</p>
<p><strong>存在的问题</strong>：脏读、不可重复读、幻读</p>
<p><strong>使用场景</strong>：对数据一致性要求极低的场景，如实时统计监控。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StatisticsService</span> {
    
    <span class="hljs-meta">@Transactional(isolation = Isolation.READ_UNCOMMITTED)</span>
    <span class="hljs-keyword">public</span> RealTimeStats <span class="hljs-title function_">getRealTimeStats</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 实时统计，可以接受读取未提交数据</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">totalUsers</span> <span class="hljs-operator">=</span> userMapper.countAll(); <span class="hljs-comment">// 可能包含未提交的插入</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">activeOrders</span> <span class="hljs-operator">=</span> orderMapper.countByStatus(<span class="hljs-string">"ACTIVE"</span>); <span class="hljs-comment">// 可能包含未提交的订单</span>
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RealTimeStats</span>(totalUsers, activeOrders);
    }
}
</code></pre>
<p><strong>配置示例</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableTransactionManagement</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> PlatformTransactionManager <span class="hljs-title function_">transactionManager</span><span class="hljs-params">(DataSource dataSource)</span> {
        <span class="hljs-type">DataSourceTransactionManager</span> <span class="hljs-variable">transactionManager</span> <span class="hljs-operator">=</span> 
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSourceTransactionManager</span>(dataSource);
        transactionManager.setDefaultTimeout(<span class="hljs-number">30</span>);
        <span class="hljs-keyword">return</span> transactionManager;
    }
}
</code></pre>
<h3 data-id="heading-8">2. ISOLATION_READ_COMMITTED（读已提交）</h3>
<p><strong>定义</strong>：只能读取已提交的数据变更。</p>
<p><strong>解决的问题</strong>：脏读</p>
<p><strong>存在的问题</strong>：不可重复读、幻读</p>
<p><strong>使用场景</strong>：大多数业务系统的默认选择，平衡了性能和数据一致性。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccountService</span> {
    
    <span class="hljs-meta">@Transactional(isolation = Isolation.READ_COMMITTED)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transferMoney</span><span class="hljs-params">(Long fromUserId, Long toUserId, BigDecimal amount)</span> {
        <span class="hljs-comment">// 读取已提交的余额数据</span>
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">fromBalance</span> <span class="hljs-operator">=</span> accountMapper.selectBalance(fromUserId);
        
        <span class="hljs-keyword">if</span> (fromBalance.compareTo(amount) &lt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InsufficientBalanceException</span>(<span class="hljs-string">"余额不足"</span>);
        }
        
        <span class="hljs-comment">// 扣款和加款操作</span>
        accountMapper.deductBalance(fromUserId, amount);
        accountMapper.addBalance(toUserId, amount);
        
        <span class="hljs-comment">// 此时其他事务看到的是已提交的余额变化</span>
    }
}
</code></pre>
<p><strong>MySQL默认隔离级别</strong>，通过MVCC（多版本并发控制）实现。</p>
<h3 data-id="heading-9">3. ISOLATION_REPEATABLE_READ（可重复读）</h3>
<p><strong>定义</strong>：保证在同一个事务中多次读取同一数据的结果一致。</p>
<p><strong>解决的问题</strong>：脏读、不可重复读</p>
<p><strong>存在的问题</strong>：幻读</p>
<p><strong>使用场景</strong>：需要保证数据读取一致性的场景，如对账系统、财务计算。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReconciliationService</span> {
    
    <span class="hljs-meta">@Transactional(isolation = Isolation.REPEATABLE_READ)</span>
    <span class="hljs-keyword">public</span> ReconciliationResult <span class="hljs-title function_">dailyReconciliation</span><span class="hljs-params">(LocalDate date)</span> {
        <span class="hljs-comment">// 第一次查询交易总额</span>
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">totalAmount</span> <span class="hljs-operator">=</span> transactionMapper.sumAmountByDate(date);
        
        <span class="hljs-comment">// 执行复杂的对账逻辑（耗时操作）</span>
        processReconciliationLogic();
        
        <span class="hljs-comment">// 第二次查询交易总额（保证与第一次一致）</span>
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">totalAmount2</span> <span class="hljs-operator">=</span> transactionMapper.sumAmountByDate(date);
        
        <span class="hljs-keyword">if</span> (!totalAmount.equals(totalAmount2)) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReconciliationException</span>(<span class="hljs-string">"对账期间数据发生变化"</span>);
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReconciliationResult</span>(totalAmount);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processReconciliationLogic</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 模拟耗时操作</span>
        <span class="hljs-keyword">try</span> {
            Thread.sleep(<span class="hljs-number">5000</span>);
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
}
</code></pre>
<p><strong>MySQL的InnoDB引擎在可重复读级别下通过Next-Key Locking解决了幻读问题</strong>。</p>
<h3 data-id="heading-10">4. ISOLATION_SERIALIZABLE（序列化）</h3>
<p><strong>定义</strong>：最高隔离级别，完全串行化执行事务。</p>
<p><strong>解决的问题</strong>：脏读、不可重复读、幻读</p>
<p><strong>存在的问题</strong>：性能最低，并发性差</p>
<p><strong>使用场景</strong>：对数据一致性要求极高的场景，如银行核心系统、资金清算。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BankCoreService</span> {
    
    <span class="hljs-meta">@Transactional(isolation = Isolation.SERIALIZABLE)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">criticalFundTransfer</span><span class="hljs-params">(TransferRequest request)</span> {
        <span class="hljs-comment">// 严格的资金转账，保证绝对的数据一致性</span>
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">fromBalance</span> <span class="hljs-operator">=</span> accountMapper.selectBalance(request.getFromAccount());
        
        <span class="hljs-keyword">if</span> (fromBalance.compareTo(request.getAmount()) &lt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InsufficientBalanceException</span>(<span class="hljs-string">"余额不足"</span>);
        }
        
        <span class="hljs-comment">// 序列化执行，其他事务无法并发修改相关数据</span>
        accountMapper.deductBalance(request.getFromAccount(), request.getAmount());
        accountMapper.addBalance(request.getToAccount(), request.getAmount());
        transactionMapper.insertTransferRecord(request);
    }
}
</code></pre>
<h3 data-id="heading-11">5. ISOLATION_DEFAULT（默认）</h3>
<p><strong>定义</strong>：使用底层数据库的默认隔离级别。</p>
<p><strong>使用场景</strong>：大多数情况下的推荐选择，保持与数据库配置一致。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultIsolationService</span> {
    
    <span class="hljs-meta">@Transactional(isolation = Isolation.DEFAULT)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">defaultIsolationOperation</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 使用数据库默认隔离级别</span>
        <span class="hljs-comment">// MySQL: REPEATABLE_READ</span>
        <span class="hljs-comment">// Oracle: READ_COMMITTED</span>
        <span class="hljs-comment">// PostgreSQL: READ_COMMITTED</span>
        performBusinessLogic();
    }
}
</code></pre>
<h2 data-id="heading-12">隔离级别对比总结</h2>













































<table><thead><tr><th>隔离级别</th><th>脏读</th><th>不可重复读</th><th>幻读</th><th>性能</th><th>使用场景</th></tr></thead><tbody><tr><td>READ_UNCOMMITTED</td><td>❌ 可能</td><td>❌ 可能</td><td>❌ 可能</td><td>🚀 最高</td><td>实时监控、统计分析</td></tr><tr><td>READ_COMMITTED</td><td>✅ 防止</td><td>❌ 可能</td><td>❌ 可能</td><td>⚡ 较高</td><td>大多数业务系统</td></tr><tr><td>REPEATABLE_READ</td><td>✅ 防止</td><td>✅ 防止</td><td>❌ 可能</td><td>🐢 中等</td><td>对账系统、财务计算</td></tr><tr><td>SERIALIZABLE</td><td>✅ 防止</td><td>✅ 防止</td><td>✅ 防止</td><td>🐌 最低</td><td>银行核心、资金清算</td></tr></tbody></table>
<h2 data-id="heading-13">实战场景分析</h2>
<h3 data-id="heading-14">场景一：电商库存管理</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InventoryService</span> {
    
    <span class="hljs-comment">// 高并发库存扣减 - 使用读已提交</span>
    <span class="hljs-meta">@Transactional(isolation = Isolation.READ_COMMITTED)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">deductInventory</span><span class="hljs-params">(Long productId, Integer quantity)</span> {
        <span class="hljs-type">Integer</span> <span class="hljs-variable">availableStock</span> <span class="hljs-operator">=</span> inventoryMapper.selectStock(productId);
        
        <span class="hljs-keyword">if</span> (availableStock &gt;= quantity) {
            <span class="hljs-type">int</span> <span class="hljs-variable">rows</span> <span class="hljs-operator">=</span> inventoryMapper.deductStock(productId, quantity);
            <span class="hljs-keyword">return</span> rows &gt; <span class="hljs-number">0</span>;
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    
    <span class="hljs-comment">// 库存盘点 - 使用可重复读</span>
    <span class="hljs-meta">@Transactional(isolation = Isolation.REPEATABLE_READ)</span>  
    <span class="hljs-keyword">public</span> InventoryReport <span class="hljs-title function_">generateInventoryReport</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 保证盘点期间库存数据一致</span>
        List&lt;Inventory&gt; inventories = inventoryMapper.selectAll();
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">totalValue</span> <span class="hljs-operator">=</span> calculateTotalValue(inventories);
        
        <span class="hljs-comment">// 长时间处理，保证数据一致性</span>
        processReportGeneration(inventories);
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InventoryReport</span>(inventories, totalValue);
    }
}
</code></pre>
<h3 data-id="heading-15">场景二：订单状态流转</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderStateService</span> {
    
    <span class="hljs-comment">// 订单状态更新 - 使用读已提交</span>
    <span class="hljs-meta">@Transactional(isolation = Isolation.READ_COMMITTED)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateOrderStatus</span><span class="hljs-params">(Long orderId, OrderStatus newStatus)</span> {
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> orderMapper.selectById(orderId);
        
        <span class="hljs-comment">// 基于当前状态进行流转</span>
        <span class="hljs-keyword">if</span> (order.getStatus().canTransitionTo(newStatus)) {
            orderMapper.updateStatus(orderId, newStatus);
            orderStatusHistoryMapper.insertHistory(orderId, newStatus);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"状态流转不合法"</span>);
        }
    }
    
    <span class="hljs-comment">// 订单批量处理 - 使用可重复读</span>
    <span class="hljs-meta">@Transactional(isolation = Isolation.REPEATABLE_READ)</span>
    <span class="hljs-keyword">public</span> BatchProcessResult <span class="hljs-title function_">batchProcessOrders</span><span class="hljs-params">(OrderStatus status)</span> {
        <span class="hljs-comment">// 保证处理期间订单集合不变</span>
        List&lt;Order&gt; orders = orderMapper.selectByStatus(status);
        <span class="hljs-type">int</span> <span class="hljs-variable">successCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">failureCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-keyword">for</span> (Order order : orders) {
            <span class="hljs-keyword">try</span> {
                processSingleOrder(order);
                successCount++;
            } <span class="hljs-keyword">catch</span> (Exception e) {
                failureCount++;
                log.error(<span class="hljs-string">"处理订单失败: {}"</span>, order.getId(), e);
            }
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BatchProcessResult</span>(orders.size(), successCount, failureCount);
    }
}
</code></pre>
<h3 data-id="heading-16">场景三：财务对账系统</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FinancialReconciliationService</span> {
    
    <span class="hljs-comment">// 关键财务对账 - 使用序列化</span>
    <span class="hljs-meta">@Transactional(isolation = Isolation.SERIALIZABLE, timeout = 120)</span>
    <span class="hljs-keyword">public</span> ReconciliationResult <span class="hljs-title function_">financialReconciliation</span><span class="hljs-params">(LocalDate date)</span> {
        <span class="hljs-comment">// 保证对账期间财务数据绝对一致</span>
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">bankAmount</span> <span class="hljs-operator">=</span> bankStatementMapper.sumAmountByDate(date);
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">systemAmount</span> <span class="hljs-operator">=</span> transactionMapper.sumAmountByDate(date);
        
        <span class="hljs-keyword">if</span> (bankAmount.compareTo(systemAmount) != <span class="hljs-number">0</span>) {
            <span class="hljs-comment">// 详细差异分析</span>
            List&lt;Discrepancy&gt; discrepancies = findDiscrepancies(date);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReconciliationException</span>(<span class="hljs-string">"对账不平"</span>, discrepancies);
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReconciliationResult</span>(bankAmount, systemAmount);
    }
    
    <span class="hljs-comment">// 日常统计 - 使用读已提交</span>
    <span class="hljs-meta">@Transactional(isolation = Isolation.READ_COMMITTED, readOnly = true)</span>
    <span class="hljs-keyword">public</span> DailyStats <span class="hljs-title function_">getDailyStats</span><span class="hljs-params">(LocalDate date)</span> {
        <span class="hljs-comment">// 统计查询，接受数据变更</span>
        <span class="hljs-keyword">return</span> dailyStatsMapper.selectByDate(date);
    }
}
</code></pre>
<h2 data-id="heading-17">常见陷阱与解决方案</h2>
<h3 data-id="heading-18">陷阱一：隔离级别与锁的误解</h3>
<p><strong>问题</strong>：认为提高隔离级别就能解决所有并发问题。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误理解：认为SERIALIZABLE能解决所有问题</span>
<span class="hljs-meta">@Transactional(isolation = Isolation.SERIALIZABLE)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">problematicMethod</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// 实际上可能造成严重的性能问题和死锁</span>
    processLargeDataset();
}
</code></pre>
<p><strong>解决方案</strong>：合理选择隔离级别，结合业务逻辑。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OptimizedService</span> {
    
    <span class="hljs-comment">// 根据业务需求选择合适的隔离级别</span>
    <span class="hljs-meta">@Transactional(isolation = Isolation.READ_COMMITTED)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">optimizedMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 结合业务逻辑处理并发问题</span>
        processWithOptimisticLock();
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processWithOptimisticLock</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 使用乐观锁处理并发</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">version</span> <span class="hljs-operator">=</span> getCurrentVersion();
        <span class="hljs-comment">// 业务处理...</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">updated</span> <span class="hljs-operator">=</span> updateWithVersion(version);
        <span class="hljs-keyword">if</span> (updated == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OptimisticLockingException</span>(<span class="hljs-string">"数据已被其他事务修改"</span>);
        }
    }
}
</code></pre>
<h3 data-id="heading-19">陷阱二：混合隔离级别的问题</h3>
<p><strong>问题</strong>：在同一个事务中混合不同隔离级别的操作。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 潜在问题：混合隔离级别</span>
<span class="hljs-meta">@Transactional(isolation = Isolation.REPEATABLE_READ)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">mixedIsolationMethod</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// REPEATABLE_READ 操作</span>
    consistentOperation();
    
    <span class="hljs-comment">// 调用其他服务的READ_COMMITTED操作</span>
    otherService.readCommittedOperation();
    
    <span class="hljs-comment">// 隔离级别可能不一致</span>
}
</code></pre>
<p><strong>解决方案</strong>：保持事务内隔离级别一致。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsistentIsolationService</span> {
    
    <span class="hljs-meta">@Transactional(isolation = Isolation.REPEATABLE_READ)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">consistentIsolationMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 所有操作在相同隔离级别下执行</span>
        operation1();
        operation2();
        operation3();
    }
    
    <span class="hljs-meta">@Transactional(isolation = Isolation.READ_COMMITTED)</span>  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readCommittedMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 明确指定隔离级别</span>
        readCommittedOperation1();
        readCommittedOperation2();
    }
}
</code></pre>
<h3 data-id="heading-20">陷阱三：忽略数据库实现的差异</h3>
<p><strong>问题</strong>：不同数据库对隔离级别的实现有差异。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// MySQL vs Oracle 差异</span>
<span class="hljs-meta">@Transactional(isolation = Isolation.REPEATABLE_READ)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">databaseSpecificMethod</span><span class="hljs-params">()</span> {
    <span class="hljs-comment">// MySQL: 通过MVCC解决幻读</span>
    <span class="hljs-comment">// Oracle: 不支持REPEATABLE_READ，实际使用READ_COMMITTED</span>
    performOperations();
}
</code></pre>
<p><strong>解决方案</strong>：了解底层数据库特性。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseAwareService</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String databaseType;
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">databaseAwareMethod</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"MySQL"</span>.equals(databaseType)) {
            mySQLSpecificLogic();
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">"Oracle"</span>.equals(databaseType)) {
            oracleSpecificLogic();
        } <span class="hljs-keyword">else</span> {
            defaultLogic();
        }
    }
    
    <span class="hljs-comment">// MySQL特定优化</span>
    <span class="hljs-meta">@Transactional(isolation = Isolation.REPEATABLE_READ)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">mySQLSpecificLogic</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 利用MySQL的REPEATABLE_READ特性</span>
    }
    
    <span class="hljs-comment">// Oracle特定处理</span>
    <span class="hljs-meta">@Transactional(isolation = Isolation.READ_COMMITTED)</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">oracleSpecificLogic</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// Oracle使用READ_COMMITTED，需要额外处理</span>
        handleOracleConcurrency();
    }
}
</code></pre>
<h2 data-id="heading-21">性能优化建议</h2>
<h3 data-id="heading-22">1. 合理设置超时时间</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TimeoutOptimizedService</span> {
    
    <span class="hljs-comment">// 短事务：设置较短超时</span>
    <span class="hljs-meta">@Transactional(isolation = Isolation.READ_COMMITTED, timeout = 10)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fastOperation</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 快速操作，10秒超时</span>
        performQuickUpdate();
    }
    
    <span class="hljs-comment">// 长事务：设置合适超时</span>
    <span class="hljs-meta">@Transactional(isolation = Isolation.REPEATABLE_READ, timeout = 60)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">longRunningOperation</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 长时间操作，60秒超时</span>
        performBatchProcessing();
    }
    
    <span class="hljs-comment">// 只读事务：不设置超时</span>
    <span class="hljs-meta">@Transactional(isolation = Isolation.READ_COMMITTED, readOnly = true)</span>
    <span class="hljs-keyword">public</span> List&lt;Data&gt; <span class="hljs-title function_">readOnlyOperation</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 只读查询，无超时限制</span>
        <span class="hljs-keyword">return</span> dataMapper.selectAll();
    }
}
</code></pre>
<h3 data-id="heading-23">2. 使用只读事务优化查询</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReadOnlyOptimizedService</span> {
    
    <span class="hljs-meta">@Transactional(isolation = Isolation.READ_COMMITTED, readOnly = true)</span>
    <span class="hljs-keyword">public</span> List&lt;ReportData&gt; <span class="hljs-title function_">generateComplexReport</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 复杂报表查询，使用只读事务</span>
        <span class="hljs-comment">// 可能路由到只读数据库副本</span>
        <span class="hljs-keyword">return</span> reportMapper.generateComplexReport();
    }
    
    <span class="hljs-meta">@Transactional(readOnly = true)</span>
    <span class="hljs-keyword">public</span> PaginationResult&lt;Order&gt; <span class="hljs-title function_">searchOrders</span><span class="hljs-params">(OrderQuery query)</span> {
        <span class="hljs-comment">// 搜索查询，只读事务</span>
        List&lt;Order&gt; orders = orderMapper.searchByQuery(query);
        <span class="hljs-type">int</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> orderMapper.countByQuery(query);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PaginationResult</span>&lt;&gt;(orders, total);
    }
}
</code></pre>
<h3 data-id="heading-24">3. 隔离级别与锁的平衡</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LockOptimizedService</span> {
    
    <span class="hljs-comment">// 使用合适的隔离级别避免过度锁</span>
    <span class="hljs-meta">@Transactional(isolation = Isolation.READ_COMMITTED)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">optimizedWithAppLevelLock</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 应用级锁配合数据库隔离级别</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"resource_"</span> + resourceId;
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">if</span> (redisLockService.tryLock(lockKey, <span class="hljs-number">5000</span>)) {
                performCriticalOperation();
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentAccessException</span>(<span class="hljs-string">"资源被占用"</span>);
            }
        } <span class="hljs-keyword">finally</span> {
            redisLockService.unlock(lockKey);
        }
    }
    
    <span class="hljs-comment">// 需要时使用悲观锁</span>
    <span class="hljs-meta">@Transactional(isolation = Isolation.READ_COMMITTED)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pessimisticLockOperation</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-comment">// SELECT FOR UPDATE 悲观锁</span>
        <span class="hljs-type">Entity</span> <span class="hljs-variable">entity</span> <span class="hljs-operator">=</span> entityMapper.selectForUpdate(id);
        updateEntity(entity);
    }
}
</code></pre>
<h2 data-id="heading-25">监控与调试</h2>
<h3 data-id="heading-26">事务监控配置</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionMonitor</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(<span class="hljs-string">"TRANSACTION_MONITOR"</span>);
    
    <span class="hljs-meta">@EventListener</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">monitorTransaction</span><span class="hljs-params">(TransactionEvent event)</span> {
        <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> TransactionStartedEvent) {
            logger.info(<span class="hljs-string">"事务开始: {}"</span>, event.getTransactionName());
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> TransactionCompletedEvent) {
            logger.info(<span class="hljs-string">"事务完成: {}"</span>, event.getTransactionName());
        }
    }
}
</code></pre>
<h3 data-id="heading-27">隔离级别调试</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IsolationDebugService</span> {
    
    <span class="hljs-meta">@Transactional(isolation = Isolation.READ_COMMITTED)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">debugIsolationLevel</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 查看当前事务隔离级别</span>
        <span class="hljs-type">TransactionStatus</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> TransactionAspectSupport.currentTransactionStatus();
        
        <span class="hljs-comment">// 获取数据库连接查看实际隔离级别</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> DataSourceUtils.getConnection(dataSource)) {
            <span class="hljs-type">int</span> <span class="hljs-variable">isolationLevel</span> <span class="hljs-operator">=</span> conn.getTransactionIsolation();
            logger.debug(<span class="hljs-string">"当前事务隔离级别: {}"</span>, isolationLevel);
            
            <span class="hljs-comment">// 1: READ_UNCOMMITTED, 2: READ_COMMITTED, </span>
            <span class="hljs-comment">// 4: REPEATABLE_READ, 8: SERIALIZABLE</span>
        } <span class="hljs-keyword">catch</span> (SQLException e) {
            logger.error(<span class="hljs-string">"获取隔离级别失败"</span>, e);
        }
    }
}
</code></pre>
<h3 data-id="heading-28">日志配置</h3>
<pre><code class="hljs language-properties" lang="properties"># application.properties
# 事务相关日志
logging.level.org.springframework.transaction=DEBUG
logging.level.org.springframework.orm.jpa.JpaTransactionManager=DEBUG
logging.level.org.springframework.jdbc.datasource.DataSourceTransactionManager=DEBUG

# SQL日志（查看锁和隔离级别效果）
logging.level.org.springframework.jdbc.core.JdbcTemplate=DEBUG
logging.level.org.apache.ibatis=TRACE
</code></pre>
<h2 data-id="heading-29">总结</h2>
<p>事务隔离级别是保证数据一致性的重要手段，但需要根据具体业务场景进行权衡选择：</p>
<ol>
<li><strong>READ_UNCOMMITTED</strong> - 性能最高，一致性最差，适用于实时监控</li>
<li><strong>READ_COMMITTED</strong> - 平衡选择，适用于大多数业务系统</li>
<li><strong>REPEATABLE_READ</strong> - 保证读取一致性，适用于财务对账</li>
<li><strong>SERIALIZABLE</strong> - 最高一致性，性能最低，适用于银行核心</li>
</ol>
<p><strong>最佳实践建议</strong>：</p>
<ul>
<li>默认使用READ_COMMITTED</li>
<li>只在必要时提升隔离级别</li>
<li>结合应用级锁解决特定并发问题</li>
<li>考虑数据库特定的实现差异</li>
<li>合理设置事务超时时间</li>
</ul>
<p>记住，没有完美的隔离级别，只有在特定场景下的最优选择。</p>
<hr/>
<p><strong>下期预告</strong>：《Spring声明式事务与编程式事务的深度对比》</p>
<p>如果觉得本文对你有帮助，请点赞、收藏、关注！欢迎在评论区分享你在事务隔离级别方面的实战经验。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Windows搭建MongoDB(4)：服务器部署及远程访问]]></title>    <link>https://juejin.cn/post/7571641339688321024</link>    <guid>https://juejin.cn/post/7571641339688321024</guid>    <pubDate>2025-11-12T08:40:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571641339688321024" data-draft-id="7571068689766154280" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Windows搭建MongoDB(4)：服务器部署及远程访问"/> <meta itemprop="keywords" content="MongoDB,Mongoose"/> <meta itemprop="datePublished" content="2025-11-12T08:40:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="WangHappy"/> <meta itemprop="url" content="https://juejin.cn/user/2137106336976183"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Windows搭建MongoDB(4)：服务器部署及远程访问
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2137106336976183/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    WangHappy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T08:40:23.000Z" title="Wed Nov 12 2025 08:40:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>大家好，我是WangHappy，一名<code>主业前端，副业全栈</code>的程序员，在这里我会分享关于<code>前端进阶全栈的常用技术</code> 和 <code>基本入门操作</code>。 如果我的文章能让您有所收获，欢迎一键三连（评论，点赞，关注）。</p>
<h3 data-id="heading-1">入站规则配置</h3>
<p>本章我们来讲述一下如何在windows服务器下部署MongoDB数据库，并使用外部计算机远程连接访问数据库， 我们以阿里云服务器windows系统为例。</p>
<h5 data-id="heading-2">1.1</h5>
<p>首先我们登录服务器，安装MongoDB数据库，可参考 <a href="https://juejin.cn/post/7568405112269602852" target="_blank" title="https://juejin.cn/post/7568405112269602852">MongoDB基础安装</a></p>
<p>安装完成后配置防火墙入站规则，打开 <code>设置</code>, 搜索防火墙， 点击 <code>高级设置</code>，</p>
<p>左侧选择 <code>入站规则</code>， 在右侧点击 <code>新建规则</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af3d79cf45c84ccb982833e924dc0266~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2FuZ0hhcHB5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763541647&amp;x-signature=q1nBxlsEwBVxzbhQuhpj5b52dMI%3D" alt="QQ截图20251111173138.png" loading="lazy"/></p>
<p>选择 <code>端口</code>， 点击下一步，</p>
<p>再选择 <code>TCP</code>， 在下方 <code>特定本地端口</code> 输入 <code>27017</code>, 27017是MongoDB的默认端口。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38499119d504454a8062d17bd2b76786~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2FuZ0hhcHB5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763541647&amp;x-signature=7yszJbLoAq4AVXXRKk%2Fd8ggaaGA%3D" alt="QQ截图20251112105853.png" loading="lazy"/></p>
<p>之后一路默认配置，直至最后为 <code>入站规则</code> 设置一个名称，完成配置。</p>
<h5 data-id="heading-3">1.2</h5>
<p>登录阿里云服官网，在控制台服务器配置 <code>安全组规则</code>， 如下图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc0c7b3e518647ffa06b9966b04e575a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2FuZ0hhcHB5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763541647&amp;x-signature=nv05NskUqoNjpAxeCOkPjL3Oj08%3D" alt="QQ截图20251112114235.png" loading="lazy"/></p>
<p>这样我们就完成了入站规则的配置，使得我们在通过外部IP访问远程数据库时，不会因为防火墙对端口的阻止而无法访问。</p>
<h3 data-id="heading-4">cfg文件的配置修改</h3>
<p>找到MongoDB安装目录下cfg配置文件， 修改MongoDB的网络接口配置，将 <code>bindIp</code> 地址修改为 <code>0.0.0.0</code>。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># network interfaces </span>
<span class="hljs-attr">net:</span> 
 <span class="hljs-attr">port:</span> <span class="hljs-number">27017</span> 
 <span class="hljs-attr">bindIp:</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>
 
</code></pre>
<p><code>0.0.0.0</code> 代表允许外部任何IP地址访问MongoDB数据库。</p>
<p><code>127.0.0.1</code> 则代表只接受来自本地机器的连接。</p>
<p>如果希望指定客户端IP地址访问MongoDB数据库，可以将网络接口同时设置为服务器的IP地址和该客户端的IP地址。</p>
<p>例如服务器地址为192.168.0.0，客户端地址为192.168.1.1，我们可以这样配置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">net:</span>
 <span class="hljs-attr">port:</span> <span class="hljs-number">27017</span>
 <span class="hljs-attr">bindIp:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">,192.168.1.1</span>  <span class="hljs-comment"># 允许来自服务器和外部计算机的连接</span>
 
</code></pre>
<h3 data-id="heading-5">开启远程连接</h3>
<p>完成cfg文件的配置后，我们在服务器上启动终端，执行以下命令启动服务：</p>
<p><code>mongod --config "path/mogod.cfg" --dbpath "path/data"</code></p>
<p>其中 <code>config </code>后面跟随的路径是MongoDB配置文件，<code>dbpath</code> 后的路径是数据存储路径。</p>
<p>服务开启后，我们回到外部访问的计算机，同样打开终端，使用 mongosh 连接服务器上的数据库</p>
<p>执行 <code>mongosh "mongodb://&lt;ip address&gt;:27017"</code> ip address 是数据库所在的服务器地址。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f36d80fc3c7e47919af138d0bee37f6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgV2FuZ0hhcHB5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763541647&amp;x-signature=yqx3PFbxvYImciywS0HixZtMdVE%3D" alt="QQ截图20251112154720.png" loading="lazy"/></p>
<p>从图片返回的信息可以看到，我们成功连接到了服务器上的数据库。</p>
<h3 data-id="heading-6">开启认证权限</h3>
<p>最后，我们来开启数据库权限认证，这样就可以使用账户和密码授权用户远程访问操作数据库，提升安全性。</p>
<p>数据库认证权限开启的具体步骤，可以参考上一篇文章 <a href="https://juejin.cn/post/7569239765763129398" target="_blank" title="https://juejin.cn/post/7569239765763129398">开启数据库认证权限</a>，此处不再赘述。</p>
<p>创建完管理员账户，同时在数据库配置文件中开启权限认证后，不要忘记重启一下数据库服务</p>
<p>重启服务时的执行命令依然是 <code>mongod --config "path/mogod.cfg" --dbpath "path/data"</code>。</p>
<p>然后我们切换回客户端电脑，在终端执行 <code>mongosh "mongodb://username:password@ip address:27017"</code></p>
<p>执行命令中的 <code>username</code> 和 <code>password</code> 就是开启认证权限时设置的用户名和密码。</p>
<p>如果担心数据库密码暴露，不想在命令中体现，可以先执行：</p>
<p><code>mongosh "mongodb://username@ip address:27017"</code>，回车后，再输入密码也可以成功连接数据库。</p>
<p>到此，我们实现了将数据库部署到正式的服务器环境下，并可以通过客户端电脑远程访问操作。</p>
<p>下一篇我们来讲述一下 <code>mongosh</code> 操作数据库的一些常用命令。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第3章：基础组件 —— 3.6 进度指示器]]></title>    <link>https://juejin.cn/post/7571477608392884224</link>    <guid>https://juejin.cn/post/7571477608392884224</guid>    <pubDate>2025-11-12T07:21:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571477608392884224" data-draft-id="7571559178742202403" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第3章：基础组件 —— 3.6 进度指示器"/> <meta itemprop="keywords" content="Flutter"/> <meta itemprop="datePublished" content="2025-11-12T07:21:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="旧时光_"/> <meta itemprop="url" content="https://juejin.cn/user/4442458669718279"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第3章：基础组件 —— 3.6 进度指示器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4442458669718279/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    旧时光_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T07:21:21.000Z" title="Wed Nov 12 2025 07:21:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">3.6 进度指示器</h2>
<h3 data-id="heading-1">📚 章节概览</h3>
<p>进度指示器用于显示任务的进度状态。Flutter 的 Material 库提供了两种进度指示器，本章节将学习：</p>
<ul>
<li><strong>LinearProgressIndicator</strong> - 线性进度条</li>
<li><strong>CircularProgressIndicator</strong> - 圆形进度条</li>
<li><strong>确定进度</strong> - 显示具体进度值</li>
<li><strong>不确定进度</strong> - 循环动画</li>
<li><strong>自定义尺寸</strong> - 控制进度条大小</li>
<li><strong>进度色动画</strong> - 颜色渐变效果</li>
</ul>
<hr/>
<h3 data-id="heading-2">🎯 核心知识点</h3>
<h4 data-id="heading-3">进度指示器的两种模式</h4>
<ol>
<li>
<p><strong>确定进度（Determinate）</strong>：进度可以计算和预估</p>
<ul>
<li>用于：文件下载、数据加载、任务完成度</li>
<li>特征：显示具体的进度百分比</li>
</ul>
</li>
<li>
<p><strong>不确定进度（Indeterminate）</strong>：进度无法准确获得</p>
<ul>
<li>用于：下拉刷新、数据提交、等待响应</li>
<li>特征：循环动画，不显示具体进度</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-4">1️⃣ LinearProgressIndicator</h3>
<p><code>LinearProgressIndicator</code> 是线性、条状的进度条。</p>
<h4 data-id="heading-5">构造函数</h4>
<pre><code class="hljs language-dart" lang="dart">LinearProgressIndicator({
  <span class="hljs-built_in">double?</span> value,                    <span class="hljs-comment">// 进度值 [0.0, 1.0]</span>
  Color? backgroundColor,           <span class="hljs-comment">// 背景色</span>
  Animation&lt;Color?&gt;? valueColor,    <span class="hljs-comment">// 进度条颜色</span>
  <span class="hljs-built_in">String?</span> semanticsLabel,           <span class="hljs-comment">// 语义标签</span>
  <span class="hljs-built_in">String?</span> semanticsValue,          <span class="hljs-comment">// 语义值</span>
})
</code></pre>
<h4 data-id="heading-6">属性说明</h4>

























<table><thead><tr><th>属性</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><code>value</code></td><td>double?</td><td>进度值，null=不确定进度，[0.0-1.0]=确定进度</td></tr><tr><td><code>backgroundColor</code></td><td>Color?</td><td>背景色</td></tr><tr><td><code>valueColor</code></td><td>Animation&lt;Color?&gt;?</td><td>进度条颜色（支持动画）</td></tr></tbody></table>
<h4 data-id="heading-7">基本用法</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 不确定进度（循环动画）</span>
LinearProgressIndicator(
  backgroundColor: Colors.grey[<span class="hljs-number">200</span>],
  valueColor: AlwaysStoppedAnimation(Colors.blue),
)

<span class="hljs-comment">// 确定进度（50%）</span>
LinearProgressIndicator(
  backgroundColor: Colors.grey[<span class="hljs-number">200</span>],
  valueColor: AlwaysStoppedAnimation(Colors.blue),
  value: <span class="hljs-number">0.5</span>,  <span class="hljs-comment">// 50%</span>
)
</code></pre>
<h4 data-id="heading-8">AlwaysStoppedAnimation</h4>
<p><code>valueColor</code> 的类型是 <code>Animation&lt;Color?&gt;</code>，如果不需要动画效果，可以使用 <code>AlwaysStoppedAnimation</code> 来指定固定颜色：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 固定颜色</span>
valueColor: AlwaysStoppedAnimation(Colors.blue)

<span class="hljs-comment">// 相当于创建一个始终停止的动画，颜色固定为蓝色</span>
</code></pre>
<hr/>
<h3 data-id="heading-9">2️⃣ CircularProgressIndicator</h3>
<p><code>CircularProgressIndicator</code> 是圆形进度条。</p>
<h4 data-id="heading-10">构造函数</h4>
<pre><code class="hljs language-dart" lang="dart">CircularProgressIndicator({
  <span class="hljs-built_in">double?</span> value,                    <span class="hljs-comment">// 进度值 [0.0, 1.0]</span>
  Color? backgroundColor,           <span class="hljs-comment">// 背景色</span>
  Animation&lt;Color?&gt;? valueColor,    <span class="hljs-comment">// 进度条颜色</span>
  <span class="hljs-built_in">double</span> strokeWidth = <span class="hljs-number">4.0</span>,         <span class="hljs-comment">// 线条粗细</span>
  <span class="hljs-built_in">String?</span> semanticsLabel,           <span class="hljs-comment">// 语义标签</span>
  <span class="hljs-built_in">String?</span> semanticsValue,          <span class="hljs-comment">// 语义值</span>
})
</code></pre>
<h4 data-id="heading-11">额外属性</h4>

















<table><thead><tr><th>属性</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>strokeWidth</code></td><td>double</td><td>4.0</td><td>圆形进度条的粗细</td></tr></tbody></table>
<h4 data-id="heading-12">基本用法</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 不确定进度（旋转动画）</span>
CircularProgressIndicator(
  backgroundColor: Colors.grey[<span class="hljs-number">200</span>],
  valueColor: AlwaysStoppedAnimation(Colors.blue),
)

<span class="hljs-comment">// 确定进度（50%，显示半圆）</span>
CircularProgressIndicator(
  backgroundColor: Colors.grey[<span class="hljs-number">200</span>],
  valueColor: AlwaysStoppedAnimation(Colors.blue),
  value: <span class="hljs-number">0.5</span>,
)

<span class="hljs-comment">// 自定义粗细</span>
CircularProgressIndicator(
  backgroundColor: Colors.grey[<span class="hljs-number">200</span>],
  valueColor: AlwaysStoppedAnimation(Colors.blue),
  value: <span class="hljs-number">0.7</span>,
  strokeWidth: <span class="hljs-number">8.0</span>,  <span class="hljs-comment">// 更粗</span>
)
</code></pre>
<hr/>
<h3 data-id="heading-13">3️⃣ 自定义尺寸</h3>
<p>进度指示器本身不提供尺寸参数，它们会<strong>继承父容器的尺寸</strong>。</p>
<p>可以使用 <code>SizedBox</code> 或 <code>ConstrainedBox</code> 来控制尺寸。</p>
<h4 data-id="heading-14">LinearProgressIndicator 尺寸</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 高度为 2</span>
SizedBox(
  height: <span class="hljs-number">2</span>,
  child: LinearProgressIndicator(
    backgroundColor: Colors.grey[<span class="hljs-number">200</span>],
    valueColor: AlwaysStoppedAnimation(Colors.blue),
    value: <span class="hljs-number">0.5</span>,
  ),
)

<span class="hljs-comment">// 高度为 10</span>
SizedBox(
  height: <span class="hljs-number">10</span>,
  child: LinearProgressIndicator(
    backgroundColor: Colors.grey[<span class="hljs-number">200</span>],
    valueColor: AlwaysStoppedAnimation(Colors.blue),
    value: <span class="hljs-number">0.5</span>,
  ),
)
</code></pre>
<h4 data-id="heading-15">CircularProgressIndicator 尺寸</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 直径为 30</span>
SizedBox(
  height: <span class="hljs-number">30</span>,
  width: <span class="hljs-number">30</span>,
  child: CircularProgressIndicator(
    backgroundColor: Colors.grey[<span class="hljs-number">200</span>],
    valueColor: AlwaysStoppedAnimation(Colors.blue),
    value: <span class="hljs-number">0.7</span>,
    strokeWidth: <span class="hljs-number">3</span>,
  ),
)

<span class="hljs-comment">// 直径为 100</span>
SizedBox(
  height: <span class="hljs-number">100</span>,
  width: <span class="hljs-number">100</span>,
  child: CircularProgressIndicator(
    backgroundColor: Colors.grey[<span class="hljs-number">200</span>],
    valueColor: AlwaysStoppedAnimation(Colors.blue),
    value: <span class="hljs-number">0.7</span>,
  ),
)
</code></pre>
<h4 data-id="heading-16">椭圆形进度条</h4>
<p>如果 <code>CircularProgressIndicator</code> 的宽高不相等，会显示为椭圆形：</p>
<pre><code class="hljs language-dart" lang="dart">SizedBox(
  height: <span class="hljs-number">60</span>,
  width: <span class="hljs-number">100</span>,  <span class="hljs-comment">// 宽度大于高度</span>
  child: CircularProgressIndicator(
    backgroundColor: Colors.grey[<span class="hljs-number">200</span>],
    valueColor: AlwaysStoppedAnimation(Colors.purple),
    value: <span class="hljs-number">0.7</span>,
  ),
)
</code></pre>
<hr/>
<h3 data-id="heading-17">4️⃣ 进度色动画</h3>
<p>通过 <code>Animation&lt;Color&gt;</code> 实现颜色渐变效果。</p>
<h4 data-id="heading-18">完整示例</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProgressColorAnimation</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _ProgressColorAnimationState createState() =&gt; _ProgressColorAnimationState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_ProgressColorAnimationState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">ProgressColorAnimation</span>&gt;
    <span class="hljs-title">with</span> <span class="hljs-title">SingleTickerProviderStateMixin</span> </span>{
  <span class="hljs-keyword">late</span> AnimationController _animationController;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    <span class="hljs-comment">// 动画执行时间 3 秒</span>
    _animationController = AnimationController(
      vsync: <span class="hljs-keyword">this</span>,
      duration: <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">3</span>),
    );
    _animationController.forward();
    _animationController.addListener(() =&gt; setState(() {}));
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    _animationController.dispose();
    <span class="hljs-keyword">super</span>.dispose();
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> LinearProgressIndicator(
      backgroundColor: Colors.grey[<span class="hljs-number">200</span>],
      <span class="hljs-comment">// 颜色从灰色渐变到蓝色</span>
      valueColor: ColorTween(
        begin: Colors.grey,
        end: Colors.blue,
      ).animate(_animationController),
      <span class="hljs-comment">// 进度从 0% 到 100%</span>
      value: _animationController.value,
    );
  }
}
</code></pre>
<h4 data-id="heading-19">关键点</h4>
<ol>
<li><strong>SingleTickerProviderStateMixin</strong>：提供动画帧计时器</li>
<li><strong>AnimationController</strong>：控制动画的执行</li>
<li><strong>ColorTween</strong>：定义颜色的起始和结束值</li>
<li><strong>animate()</strong>：将 Tween 绑定到 AnimationController</li>
</ol>
<hr/>
<h3 data-id="heading-20">💡 最佳实践</h3>
<h4 data-id="heading-21">1. 选择合适的进度类型</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// ✅ 文件下载 - 使用确定进度</span>
<span class="hljs-built_in">double</span> _downloadProgress = <span class="hljs-number">0.7</span>;
LinearProgressIndicator(
  value: _downloadProgress,
)

<span class="hljs-comment">// ✅ 下拉刷新 - 使用不确定进度</span>
CircularProgressIndicator()  <span class="hljs-comment">// value = null</span>
</code></pre>
<h4 data-id="heading-22">2. 添加文字说明</h4>
<pre><code class="hljs language-dart" lang="dart">Column(
  children: [
    LinearProgressIndicator(value: <span class="hljs-number">0.65</span>),
    SizedBox(height: <span class="hljs-number">8</span>),
    Text(<span class="hljs-string">'65%'</span>),  <span class="hljs-comment">// 显示具体进度</span>
  ],
)
</code></pre>
<h4 data-id="heading-23">3. 加载状态的完整示例</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoadingWidget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> isLoading;
  <span class="hljs-keyword">final</span> Widget child;

  <span class="hljs-keyword">const</span> LoadingWidget({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.isLoading,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.child,
  });

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Stack(
      children: [
        child,
        <span class="hljs-keyword">if</span> (isLoading)
          Container(
            color: Colors.black.withOpacity(<span class="hljs-number">0.3</span>),
            child: Center(
              child: CircularProgressIndicator(),
            ),
          ),
      ],
    );
  }
}

<span class="hljs-comment">// 使用</span>
LoadingWidget(
  isLoading: _isLoading,
  child: YourContent(),
)
</code></pre>
<h4 data-id="heading-24">4. 按钮中的加载状态</h4>
<pre><code class="hljs language-dart" lang="dart">ElevatedButton(
  onPressed: _isLoading ? <span class="hljs-keyword">null</span> : _handleSubmit,
  child: _isLoading
      ? SizedBox(
          height: <span class="hljs-number">20</span>,
          width: <span class="hljs-number">20</span>,
          child: CircularProgressIndicator(
            strokeWidth: <span class="hljs-number">2</span>,
            valueColor: AlwaysStoppedAnimation(Colors.white),
          ),
        )
      : Text(<span class="hljs-string">'提交'</span>),
)
</code></pre>
<hr/>
<h3 data-id="heading-25">🤔 常见问题（FAQ）</h3>
<h4 data-id="heading-26">Q1: 如何实现环形进度条（带百分比文字）？</h4>
<p><strong>A:</strong> 使用 <code>Stack</code> 叠加显示：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CircularPercentIndicator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> percent;

  <span class="hljs-keyword">const</span> CircularPercentIndicator({<span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.percent});

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> SizedBox(
      height: <span class="hljs-number">100</span>,
      width: <span class="hljs-number">100</span>,
      child: Stack(
        alignment: Alignment.center,
        children: [
          CircularProgressIndicator(
            backgroundColor: Colors.grey[<span class="hljs-number">200</span>],
            valueColor: AlwaysStoppedAnimation(Colors.blue),
            value: percent,
            strokeWidth: <span class="hljs-number">8</span>,
          ),
          Text(
            <span class="hljs-string">'<span class="hljs-subst">${(percent * <span class="hljs-number">100</span>).toInt()}</span>%'</span>,
            style: TextStyle(
              fontSize: <span class="hljs-number">20</span>,
              fontWeight: FontWeight.bold,
            ),
          ),
        ],
      ),
    );
  }
}

<span class="hljs-comment">// 使用</span>
CircularPercentIndicator(percent: <span class="hljs-number">0.65</span>)
</code></pre>
<h4 data-id="heading-27">Q2: 如何改变进度条的颜色？</h4>
<p><strong>A:</strong> 使用 <code>valueColor</code> 属性：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 方法1：固定颜色</span>
LinearProgressIndicator(
  valueColor: AlwaysStoppedAnimation(Colors.red),
)

<span class="hljs-comment">// 方法2：根据进度改变颜色</span>
LinearProgressIndicator(
  valueColor: AlwaysStoppedAnimation(
    _progress &lt; <span class="hljs-number">0.5</span> ? Colors.orange : Colors.green,
  ),
  value: _progress,
)

<span class="hljs-comment">// 方法3：动画颜色</span>
valueColor: ColorTween(
  begin: Colors.red,
  end: Colors.green,
).animate(_animationController)
</code></pre>
<h4 data-id="heading-28">Q3: 如何实现多段进度条（不同颜色的分段）？</h4>
<p><strong>A:</strong> 使用 <code>Stack</code> 叠加多个进度条：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SegmentedProgress</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Stack(
      children: [
        <span class="hljs-comment">// 底层：总背景</span>
        LinearProgressIndicator(
          backgroundColor: Colors.grey[<span class="hljs-number">200</span>],
          valueColor: AlwaysStoppedAnimation(Colors.transparent),
          value: <span class="hljs-number">1.0</span>,
        ),
        <span class="hljs-comment">// 第一段：0-30% 绿色</span>
        LinearProgressIndicator(
          backgroundColor: Colors.transparent,
          valueColor: AlwaysStoppedAnimation(Colors.green),
          value: <span class="hljs-number">0.3</span>,
        ),
        <span class="hljs-comment">// 第二段：30-60% 黄色</span>
        ClipRect(
          child: Align(
            alignment: Alignment.centerLeft,
            widthFactor: <span class="hljs-number">0.6</span>,
            child: LinearProgressIndicator(
              backgroundColor: Colors.transparent,
              valueColor: AlwaysStoppedAnimation(Colors.yellow),
              value: <span class="hljs-number">1.0</span>,
            ),
          ),
        ),
      ],
    );
  }
}
</code></pre>
<h4 data-id="heading-29">Q4: 如何实现下载进度条？</h4>
<p><strong>A:</strong> 完整示例：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DownloadProgress</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _DownloadProgressState createState() =&gt; _DownloadProgressState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_DownloadProgressState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">DownloadProgress</span>&gt; </span>{
  <span class="hljs-built_in">double</span> _progress = <span class="hljs-number">0.0</span>;
  <span class="hljs-built_in">bool</span> _isDownloading = <span class="hljs-keyword">false</span>;

  Future&lt;<span class="hljs-keyword">void</span>&gt; _startDownload() <span class="hljs-keyword">async</span> {
    setState(() {
      _isDownloading = <span class="hljs-keyword">true</span>;
      _progress = <span class="hljs-number">0.0</span>;
    });

    <span class="hljs-comment">// 模拟下载</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">100</span>; i++) {
      <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-built_in">Duration</span>(milliseconds: <span class="hljs-number">50</span>));
      <span class="hljs-keyword">if</span> (!mounted) <span class="hljs-keyword">return</span>;
      setState(() {
        _progress = i / <span class="hljs-number">100</span>;
      });
    }

    setState(() {
      _isDownloading = <span class="hljs-keyword">false</span>;
    });
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Column(
      children: [
        LinearProgressIndicator(
          backgroundColor: Colors.grey[<span class="hljs-number">200</span>],
          valueColor: AlwaysStoppedAnimation(
            _progress == <span class="hljs-number">1.0</span> ? Colors.green : Colors.blue,
          ),
          value: _progress,
        ),
        SizedBox(height: <span class="hljs-number">8</span>),
        Text(<span class="hljs-string">'<span class="hljs-subst">${(_progress * <span class="hljs-number">100</span>).toStringAsFixed(<span class="hljs-number">0</span>)}</span>%'</span>),
        SizedBox(height: <span class="hljs-number">16</span>),
        ElevatedButton(
          onPressed: _isDownloading ? <span class="hljs-keyword">null</span> : _startDownload,
          child: Text(_isDownloading ? <span class="hljs-string">'下载中...'</span> : <span class="hljs-string">'开始下载'</span>),
        ),
      ],
    );
  }
}
</code></pre>
<h4 data-id="heading-30">Q5: 为什么我的进度条不动？</h4>
<p><strong>A:</strong> 检查以下几点：</p>
<ol>
<li><strong>忘记 setState</strong>：更新进度值时必须调用 <code>setState</code></li>
</ol>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// ❌ 错误：没有调用 setState</span>
<span class="hljs-keyword">void</span> _updateProgress(<span class="hljs-built_in">double</span> value) {
  _progress = value;
}

<span class="hljs-comment">// ✅ 正确：调用 setState</span>
<span class="hljs-keyword">void</span> _updateProgress(<span class="hljs-built_in">double</span> value) {
  setState(() {
    _progress = value;
  });
}
</code></pre>
<ol start="2">
<li><strong>value 没有变化</strong>：确保 value 的值确实在改变</li>
</ol>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 检查值是否在变化</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">'Progress: <span class="hljs-subst">$_progress</span>'</span>);
</code></pre>
<ol start="3">
<li><strong>value 超出范围</strong>：value 必须在 [0.0, 1.0] 范围内</li>
</ol>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// ❌ 错误：超出范围</span>
LinearProgressIndicator(value: <span class="hljs-number">50</span>)  <span class="hljs-comment">// 应该是 0.5，不是 50</span>

<span class="hljs-comment">// ✅ 正确</span>
LinearProgressIndicator(value: <span class="hljs-number">50</span> / <span class="hljs-number">100</span>)  <span class="hljs-comment">// 0.5</span>
</code></pre>
<hr/>
<h3 data-id="heading-31">🎯 跟着做练习</h3>
<h4 data-id="heading-32">练习1：实现一个文件上传组件</h4>
<p><strong>目标：</strong> 创建文件上传UI，显示上传进度</p>
<p><strong>步骤：</strong></p>
<ol>
<li>显示文件图标和文件名</li>
<li>显示线性进度条</li>
<li>显示上传百分比</li>
<li>上传完成后显示成功提示</li>
</ol>
<details>
<summary>💡 查看答案</summary>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileUploadWidget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> FileUploadWidget({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  State&lt;FileUploadWidget&gt; createState() =&gt; _FileUploadWidgetState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_FileUploadWidgetState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">FileUploadWidget</span>&gt; </span>{
  <span class="hljs-built_in">double</span> _uploadProgress = <span class="hljs-number">0.0</span>;
  <span class="hljs-built_in">bool</span> _isUploading = <span class="hljs-keyword">false</span>;
  <span class="hljs-built_in">bool</span> _uploadComplete = <span class="hljs-keyword">false</span>;

  Future&lt;<span class="hljs-keyword">void</span>&gt; _startUpload() <span class="hljs-keyword">async</span> {
    setState(() {
      _isUploading = <span class="hljs-keyword">true</span>;
      _uploadProgress = <span class="hljs-number">0.0</span>;
      _uploadComplete = <span class="hljs-keyword">false</span>;
    });

    <span class="hljs-comment">// 模拟上传</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">100</span>; i++) {
      <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(milliseconds: <span class="hljs-number">30</span>));
      <span class="hljs-keyword">if</span> (!mounted) <span class="hljs-keyword">return</span>;
      setState(() {
        _uploadProgress = i / <span class="hljs-number">100</span>;
      });
    }

    setState(() {
      _isUploading = <span class="hljs-keyword">false</span>;
      _uploadComplete = <span class="hljs-keyword">true</span>;
    });
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Card(
      child: Padding(
        padding: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">16</span>),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Row(
              children: [
                Icon(
                  _uploadComplete ? Icons.check_circle : Icons.insert_drive_file,
                  size: <span class="hljs-number">40</span>,
                  color: _uploadComplete ? Colors.green : Colors.blue,
                ),
                <span class="hljs-keyword">const</span> SizedBox(width: <span class="hljs-number">16</span>),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      <span class="hljs-keyword">const</span> Text(
                        <span class="hljs-string">'document.pdf'</span>,
                        style: TextStyle(fontWeight: FontWeight.bold),
                      ),
                      <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">4</span>),
                      Text(
                        _uploadComplete
                            ? <span class="hljs-string">'上传完成'</span>
                            : _isUploading
                                ? <span class="hljs-string">'正在上传...'</span>
                                : <span class="hljs-string">'准备上传'</span>,
                        style: <span class="hljs-keyword">const</span> TextStyle(fontSize: <span class="hljs-number">12</span>, color: Colors.grey),
                      ),
                    ],
                  ),
                ),
                <span class="hljs-keyword">if</span> (_uploadComplete)
                  <span class="hljs-keyword">const</span> Icon(Icons.done, color: Colors.green),
              ],
            ),
            <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">12</span>),
            LinearProgressIndicator(
              backgroundColor: Colors.grey[<span class="hljs-number">200</span>],
              valueColor: AlwaysStoppedAnimation(
                _uploadComplete ? Colors.green : Colors.blue,
              ),
              value: _uploadProgress,
            ),
            <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">8</span>),
            Text(
              <span class="hljs-string">'<span class="hljs-subst">${(_uploadProgress * <span class="hljs-number">100</span>).toStringAsFixed(<span class="hljs-number">0</span>)}</span>%'</span>,
              style: <span class="hljs-keyword">const</span> TextStyle(fontSize: <span class="hljs-number">12</span>, color: Colors.grey),
            ),
            <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">12</span>),
            <span class="hljs-keyword">if</span> (!_uploadComplete)
              SizedBox(
                width: <span class="hljs-built_in">double</span>.infinity,
                child: ElevatedButton(
                  onPressed: _isUploading ? <span class="hljs-keyword">null</span> : _startUpload,
                  child: Text(_isUploading ? <span class="hljs-string">'上传中...'</span> : <span class="hljs-string">'开始上传'</span>),
                ),
              ),
          ],
        ),
      ),
    );
  }
}
</code></pre>
</details>
<hr/>
<h4 data-id="heading-33">练习2：实现一个技能等级展示组件</h4>
<p><strong>目标：</strong> 使用进度条展示多项技能的等级</p>
<p><strong>步骤：</strong></p>
<ol>
<li>创建技能列表</li>
<li>为每个技能显示名称和进度条</li>
<li>不同等级使用不同颜色</li>
</ol>
<details>
<summary>💡 查看答案</summary>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SkillLevel</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> skillName;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> level; <span class="hljs-comment">// 0.0 - 1.0</span>

  <span class="hljs-keyword">const</span> SkillLevel({
    <span class="hljs-keyword">super</span>.key,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.skillName,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.level,
  });

  Color _getColor() {
    <span class="hljs-keyword">if</span> (level &gt;= <span class="hljs-number">0.8</span>) <span class="hljs-keyword">return</span> Colors.green;
    <span class="hljs-keyword">if</span> (level &gt;= <span class="hljs-number">0.5</span>) <span class="hljs-keyword">return</span> Colors.orange;
    <span class="hljs-keyword">return</span> Colors.red;
  }

  <span class="hljs-built_in">String</span> _getLevelText() {
    <span class="hljs-keyword">if</span> (level &gt;= <span class="hljs-number">0.8</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'精通'</span>;
    <span class="hljs-keyword">if</span> (level &gt;= <span class="hljs-number">0.5</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'熟悉'</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-string">'了解'</span>;
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Padding(
      padding: <span class="hljs-keyword">const</span> EdgeInsets.symmetric(vertical: <span class="hljs-number">8</span>),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(
                skillName,
                style: <span class="hljs-keyword">const</span> TextStyle(
                  fontSize: <span class="hljs-number">14</span>,
                  fontWeight: FontWeight.bold,
                ),
              ),
              Text(
                _getLevelText(),
                style: TextStyle(
                  fontSize: <span class="hljs-number">12</span>,
                  color: _getColor(),
                  fontWeight: FontWeight.bold,
                ),
              ),
            ],
          ),
          <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">4</span>),
          LinearProgressIndicator(
            backgroundColor: Colors.grey[<span class="hljs-number">200</span>],
            valueColor: AlwaysStoppedAnimation(_getColor()),
            value: level,
          ),
        ],
      ),
    );
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SkillsPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">const</span> SkillsPage({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> ListView(
      padding: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">16</span>),
      children: <span class="hljs-keyword">const</span> [
        SkillLevel(skillName: <span class="hljs-string">'Flutter'</span>, level: <span class="hljs-number">0.9</span>),
        SkillLevel(skillName: <span class="hljs-string">'Dart'</span>, level: <span class="hljs-number">0.85</span>),
        SkillLevel(skillName: <span class="hljs-string">'React'</span>, level: <span class="hljs-number">0.7</span>),
        SkillLevel(skillName: <span class="hljs-string">'Vue'</span>, level: <span class="hljs-number">0.6</span>),
        SkillLevel(skillName: <span class="hljs-string">'Node.js'</span>, level: <span class="hljs-number">0.5</span>),
      ],
    );
  }
}
</code></pre>
</details>
<hr/>
<h3 data-id="heading-34">📋 小结</h3>
<h4 data-id="heading-35">核心要点</h4>




















<table><thead><tr><th>组件</th><th>特点</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>LinearProgressIndicator</strong></td><td>线性、条状</td><td>下载、加载、任务进度</td></tr><tr><td><strong>CircularProgressIndicator</strong></td><td>圆形、旋转</td><td>加载中、等待响应</td></tr></tbody></table>
<h4 data-id="heading-36">进度模式</h4>























<table><thead><tr><th>模式</th><th>value 值</th><th>表现</th><th>使用场景</th></tr></thead><tbody><tr><td><strong>确定进度</strong></td><td>0.0 - 1.0</td><td>静止或增长</td><td>可预估的任务</td></tr><tr><td><strong>不确定进度</strong></td><td>null</td><td>循环动画</td><td>不可预估的任务</td></tr></tbody></table>
<h4 data-id="heading-37">记忆技巧</h4>
<ol>
<li><strong>value = null</strong>：不知道进度 → 循环动画</li>
<li><strong>value ∈ [0, 1]</strong>：知道进度 → 显示具体值</li>
<li><strong>AlwaysStoppedAnimation</strong>：固定颜色不需要动画</li>
<li><strong>SizedBox 包裹</strong>：控制进度条尺寸</li>
</ol>
<hr/>
<h3 data-id="heading-38">🔗 相关资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.flutter.dev%2Fflutter%2Fmaterial%2FLinearProgressIndicator-class.html" target="_blank" title="https://api.flutter.dev/flutter/material/LinearProgressIndicator-class.html" ref="nofollow noopener noreferrer">LinearProgressIndicator 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fapi.flutter.dev%2Fflutter%2Fmaterial%2FCircularProgressIndicator-class.html" target="_blank" title="https://api.flutter.dev/flutter/material/CircularProgressIndicator-class.html" ref="nofollow noopener noreferrer">CircularProgressIndicator 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Fflutter_spinkit" target="_blank" title="https://pub.dev/packages/flutter_spinkit" ref="nofollow noopener noreferrer">flutter_spinkit</a> - 多种风格的进度指示器</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Fpercent_indicator" target="_blank" title="https://pub.dev/packages/percent_indicator" ref="nofollow noopener noreferrer">percent_indicator</a> - 带百分比的进度指示器</li>
</ul>
<hr/>
<p><strong>🎉 恭喜完成第3章！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第三方物流接口优选：快递鸟物流 API，打破单一快递对接壁垒]]></title>    <link>https://juejin.cn/post/7571637614203076635</link>    <guid>https://juejin.cn/post/7571637614203076635</guid>    <pubDate>2025-11-12T08:53:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571637614203076635" data-draft-id="7571644531607683118" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第三方物流接口优选：快递鸟物流 API，打破单一快递对接壁垒"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-12T08:53:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="快递鸟"/> <meta itemprop="url" content="https://juejin.cn/user/4279725171674573"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第三方物流接口优选：快递鸟物流 API，打破单一快递对接壁垒
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4279725171674573/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    快递鸟
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T08:53:07.000Z" title="Wed Nov 12 2025 08:53:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在物流数字化深度渗透的今天，企业对物流接口的需求早已超越 “单一快递公司对接”。传统模式下，企业需逐一对接不同快递公司的原生接口，面临开发繁琐、数据割裂、维护成本高等多重困境。快递鸟作为国内领先的第三方物流 API 供应商，以 “聚合整合、标准化服务、全场景适配” 为核心，为企业提供一站式物流数字化解决方案，无需重复对接多家快递公司，即可快速接入全域物流资源，成为企业降本提效、优化物流体验的核心支撑。本文从行业痛点、核心优势、应用场景与落地价值四大维度，详解快递鸟物流 API 的独特价值。</p>
<h2 data-id="heading-0">一、传统直接对接快递公司接口的核心痛点</h2>
<p>企业若选择直接对接快递公司原生接口，往往陷入 “投入大、效率低、体验差” 的困境，具体痛点集中在四大方面：</p>
<h3 data-id="heading-1">1. 多接口开发成本高，周期长</h3>
<p>不同快递公司的接口协议、数据格式、认证方式各异，企业需为每家快递公司单独开发对接模块。以合作 10 家主流快递公司为例，开发周期可能长达 3-6 个月，投入大量技术人力；后续新增或更换快递公司时，需重新开发适配，重复投入成本。</p>
<h3 data-id="heading-2">2. 数据割裂严重，协同效率低</h3>
<p>各快递公司的物流数据分散在独立接口中，企业无法实现统一监控与整合分析。商家需在不同系统中查询不同快递公司的包裹轨迹，客服回应用户咨询时需反复切换平台；物流数据与企业 ERP、仓储、财务系统难以联动，对账、统计需手动整理数据，易出错且效率低。</p>
<h3 data-id="heading-3">3. 维护难度大，稳定性不足</h3>
<p>快递公司接口可能因系统升级、政策调整而变更，企业需安排专人持续跟进维护，否则可能出现接口失效、数据同步异常等问题；部分中小快递公司的接口稳定性较差，高并发场景（如大促）易出现响应卡顿、调用失败，影响物流运作。</p>
<h3 data-id="heading-4">4. 功能单一，场景适配有限</h3>
<p>快递公司原生接口多聚焦基础物流服务（如打单、查轨迹），缺乏针对企业实际运营的增值功能。例如，智能分单、异常预警、批量对账、跨境清关协同等功能难以实现，无法满足企业规模化、精细化运营需求。</p>
<h2 data-id="heading-5">二、快递鸟物流 API 的核心优势：第三方聚合接口的价值重构</h2>
<p>快递鸟作为第三方物流 API 供应商，通过 “聚合整合 + 标准化服务”，从根本上破解传统对接痛点，为企业提供更高效、灵活、全面的物流接口解决方案。</p>
<h3 data-id="heading-6">1. 全域物流资源聚合，一次对接覆盖全场景</h3>
<p>快递鸟已预先整合国内外 2700 + 物流服务商资源，涵盖顺丰、中通、圆通等国内主流快递，DHL、FedEx 等国际物流巨头，以及冷链、大件、跨境专线、同城即时物流等细分领域服务商。企业只需完成一次对接快递鸟 API，即可兼容所有合作物流商的服务，无需单独对接每家快递公司。无论是国内零散订单、跨境大货运输，还是生鲜冷链配送、同城即时取件，都能通过快递鸟 API 快速匹配适配运力，服务覆盖无死角。</p>
<h3 data-id="heading-7">2. 标准化对接体系，大幅降低开发与维护成本</h3>
<p>快递鸟将不同快递公司的接口协议、数据格式、认证规则统一为标准化规范，形成 “一次对接、多物流商通用” 的高效模式。企业技术团队无需研究不同快递公司的接口文档，只需按快递鸟的统一标准完成开发，对接周期从数月缩短至数天，开发成本降低 60% 以上。后续新增物流商合作时，仅需在快递鸟后台简单配置即可快速接入，无需额外开发；快递鸟负责跟进各快递公司的接口更新与维护，企业无需投入专人对接，维护成本大幅降低。</p>
<h3 data-id="heading-8">3. 全流程功能覆盖，满足企业多元化需求</h3>
<p>快递鸟物流 API 不仅提供基础物流服务，更覆盖物流全流程的增值功能，适配企业不同运营场景：</p>
<ul>
<li>基础核心功能：电子面单生成、物流轨迹实时查询、运费自动核算、预约取件，支持批量处理，满足日常发货需求；</li>
<li>智能运营功能：智能分单（按地址、重量、时效需求自动匹配最优物流商）、异常预警（监控揽收超时、中转滞留等 40 + 异常场景，主动推送通知）、地址智能解析（纠正错误地址、补全省市区信息）；</li>
<li>数据协同功能：物流数据与 ERP、仓储、财务系统无缝对接，自动同步物流单号、运费明细、签收状态，生成标准化对账报表，实现 “订单 - 物流 - 财务” 闭环；</li>
<li>专项场景功能：跨境物流清关数据同步、冷链温湿度监控、大件物流搬运预约，适配跨境、生鲜、家居等细分行业需求。</li>
</ul>
<h3 data-id="heading-9">4. 稳定与安全双保障，支撑企业规模化运营</h3>
<p>快递鸟依托分布式架构与多节点部署，具备强大的并发处理能力，可支撑每秒万级接口调用，轻松应对电商大促、直播带货等峰值场景，历经多年双 11、618 考验，接口可用性保持 99.99% 以上。在数据安全方面，采用 HTTPS 加密传输、签名认证、IP 白名单、敏感数据脱敏等多重防护机制，符合《个人信息保护法》《数据安全法》等合规要求，日均处理物流数据超 5.8 亿次，确保数据传输与存储安全。</p>
<h3 data-id="heading-10">5. 专业服务支持，全程保驾护航</h3>
<p>快递鸟为企业提供全周期服务支持，从对接前的需求梳理、方案设计，到对接中的技术指导、问题排查，再到上线后的运营优化、功能迭代，均有专业团队跟进。提供 7×24 小时技术咨询通道，响应时效快，常见问题 1 小时内可解决；定期收集企业反馈，迭代优化功能，适配行业发展新需求，确保 API 服务持续贴合企业业务增长。</p>
<h2 data-id="heading-11">三、典型应用场景：快递鸟 API 适配多元企业需求</h2>
<p>快递鸟物流 API 的灵活性与全面性，使其能精准适配不同行业、不同规模企业的物流数字化需求，在核心场景中发挥关键作用：</p>
<h3 data-id="heading-12">1. 中小电商日常运营场景</h3>
<p>中小电商人手有限、技术资源不足，传统对接模式难以落地。通过快递鸟 API，企业无需专业技术团队，即可快速接入多家快递公司，实现批量打单、轨迹集中查询、自动对账，1 人即可完成日均千单的物流操作；智能分单功能帮助中小电商以最优成本选择物流服务，单票运费平均降低 10%-15%；客服无需切换平台即可快速回应用户物流咨询，咨询量下降 40% 以上。</p>
<h3 data-id="heading-13">2. 跨境电商物流协同场景</h3>
<p>跨境电商面临国际物流对接难、清关流程复杂的问题。快递鸟 API 对接 DHL、FedEx 等国际物流商与清关系统，支持生成国际标准电子面单、自动同步清关申报信息、全链路国际轨迹追踪；清关异常时主动预警，帮助企业快速协调处理，跨境包裹清关延误率下降 70%，丢失率降低 65%；运费核算功能支持国际物流费用精准预估，帮助企业优化定价策略。</p>
<h3 data-id="heading-14">3. 多仓库企业统筹管理场景</h3>
<p>拥有多个仓库的制造型、贸易型企业，需统筹各仓库物流数据。快递鸟 API 支持多仓库绑定，可根据订单收件地址与仓库库存状态，自动推荐最近的发货仓库与适配物流商，减少跨区域运输成本与时间；所有仓库的物流数据集中管理，企业在后台即可实时查看各仓库发货进度、物流成本、异常情况，统筹调度效率提升 50%。</p>
<h3 data-id="heading-15">4. 大促峰值订单处理场景</h3>
<p>电商大促期间，订单量可能激增数十倍，传统接口易出现卡顿、失效。快递鸟 API 的高并发处理能力，支持万级订单批量打单、批量轨迹同步，打单效率提升 80% 以上；智能分流功能自动将订单分配至不同快递公司，避免单一物流商爆仓；实时监控各物流商运力状态，对拥堵线路及时调整物流方案，大促发货延迟率从 30% 降至 5% 以下。</p>
<h2 data-id="heading-16">四、落地价值：企业物流数字化的核心增益</h2>
<p>企业接入快递鸟物流 API 后，可在运营效率、成本控制、用户体验、决策科学性等多维度获得显著价值提升：</p>
<h3 data-id="heading-17">1. 降本增效，释放人力</h3>
<ul>
<li>开发与维护成本降低 60% 以上，无需投入大量资源对接多家快递公司；</li>
<li>自动化操作替代 80% 的人工重复劳动，打单、对账、查件等流程效率提升 50%-70%；</li>
<li>大促等峰值场景无需额外加班，即可高效处理海量订单，人力成本减少 30%。</li>
</ul>
<h3 data-id="heading-18">2. 优化体验，提升口碑</h3>
<ul>
<li>物流轨迹实时同步、异常主动预警，用户物流咨询量下降 40%-60%，满意度提升 30%-40%；</li>
<li>智能分单与最优物流方案推荐，包裹配送时效提升 15%-20%，破损率、丢失率大幅降低；</li>
<li>标准化对账与售后处理，用户纠纷率下降 70%，复购率提升 15%-25%。</li>
</ul>
<h3 data-id="heading-19">3. 数据驱动，科学决策</h3>
<ul>
<li>物流数据集中整合，生成时效、成本、异常率等多维度报表，为企业优化物流合作方案、调整发货策略提供客观依据；</li>
<li>智能分单、仓库调度等功能，帮助企业优化资源配置，物流成本平均降低 10%-20%；</li>
<li>数据与业务系统深度协同，推动企业物流管理从 “经验驱动” 转向 “数据驱动”。</li>
</ul>
<h2 data-id="heading-20">结语</h2>
<p>在物流数字化竞争日益激烈的今天，选择第三方物流 API 供应商已成为企业提升物流效率、降低运营成本的必然选择。快递鸟作为行业领先的物流 API 供应商，以 “多物流商聚合、标准化对接、全场景功能、稳定安全服务” 为核心优势，彻底打破了传统直接对接快递公司的壁垒，为企业提供一站式物流数字化解决方案。无论是中小电商的轻量化需求，还是大型企业的规模化运营，无论是国内物流还是跨境运输，快递鸟都能精准适配，助力企业实现物流管理的质的飞跃。</p>
<p>随着物流行业向 “智能化、协同化” 发展，快递鸟将持续融合 AI、物联网等新技术，迭代优化功能，拓展服务边界，为企业物流数字化注入更强动力。选择快递鸟，企业无需在物流接口对接上耗费过多精力，可聚焦核心业务增长，在市场竞争中构建核心竞争力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[5大排序算法&2大搜索&4大算法思想]]></title>    <link>https://juejin.cn/post/7571621555513327670</link>    <guid>https://juejin.cn/post/7571621555513327670</guid>    <pubDate>2025-11-12T08:55:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571621555513327670" data-draft-id="7571429745231609892" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="5大排序算法&amp;2大搜索&amp;4大算法思想"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-12T08:55:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="林太白"/> <meta itemprop="url" content="https://juejin.cn/user/1874034273300919"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            5大排序算法&amp;2大搜索&amp;4大算法思想
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1874034273300919/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    林太白
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T08:55:36.000Z" title="Wed Nov 12 2025 08:55:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读26分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">5大排序算法&amp;2大搜索&amp;4大算法思想</h2>
<p>完整源码地址，开源不易,你的star是我努力的动力！（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Flintaibai%2FTG" target="_blank" title="https://gitee.com/lintaibai/TG" ref="nofollow noopener noreferrer">gitee.com/lintaibai/T…</a>）</p>
<h3 data-id="heading-1">介绍</h3>
<p>介绍数据结构与算法中的的<code>5大排序算法</code>、<code>2大搜索算法</code>以及我们刷算法面试题常见的<code>4大算法思想</code></p>
<p><strong>包含以下内容：</strong></p>
<ul>
<li>冒泡排序</li>
<li>快速排序</li>
<li>插入排序</li>
<li>归并排序</li>
<li>选择排序</li>
<li>顺序搜索</li>
<li>二分搜素</li>
<li>分而治之</li>
<li>动态规划</li>
<li>贪心算法</li>
<li>回溯算法</li>
</ul>
<h3 data-id="heading-2">5大排序</h3>
<h3 data-id="heading-3">1.冒泡排序（常考）</h3>
<h5 data-id="heading-4">认识</h5>
<p>冒泡排序（Bubble Sort）是一种非常直观且简单的排序算法，主要用于对一组数据进行排序。它的名字来源于这样一个过程：在每一轮遍历中，最大的元素会“像气泡一样”逐渐上浮到数组的末端，故称为“冒泡排序”。</p>
<h5 data-id="heading-5">原理如下</h5>
<ol>
<li>比较相邻的元素。如果第一个比第二个大，就交换他们两个，如果不是相等的就跳过比下面的元素 ，这样依次的循环下去 直到所有的元素都比较完成才结束。</li>
<li>针对所有的元素重复以上的步骤，除了最后一个。</li>
<li>持续每次对越来越少的元素重复上面的步骤，直到没有任何一对数字需要比较。</li>
</ol>
<h5 data-id="heading-6">思路</h5>
<pre><code class="hljs language-javascript" lang="javascript">冒泡排序其实核心是对比里面的一层，就是谁大排后面
加一层外面的排序步骤，因为两个对比，所以最后一个不需要对比，对比次数就是数组长度减一
</code></pre>
<h5 data-id="heading-7">实际手写</h5>
<pre><code class="hljs language-plain" lang="plain">function bubbleSort(arr) {
    const len = arr.length
    if (len &lt;= 1) return

    for (let i = 0; i &lt; len - 1; i++) {
        for (let j = 0; j &lt; len - i - 1; j++) {
            if (arr[j] &gt; arr[j + 1]) {
                const temp = arr[j]
                arr[j] = arr[j + 1]
                arr[j + 1] = temp
            }
        }
    }
}

// 功能测试
const arr = [4, 3, 6, 2, 5, 7, 9, 8, 1]
bubbleSort(arr)
console.log(arr) // [1, 2, 3, 4, 5, 6, 7, 8, 9]
</code></pre>
<p>整个交换过程比较,分别对比</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 14 34  46 62 65 98 </span>
<span class="hljs-comment">// 1 3 4 2 5 6 7 8 9 </span>
<span class="hljs-comment">// 1 3 2 4 56789</span>
</code></pre>
<h5 data-id="heading-8">优化写法</h5>
<pre><code class="hljs language-javascript" lang="javascript"> <span class="hljs-comment">// 优化1 写法</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">bubbleSort</span>(<span class="hljs-params">arr</span>) {
      <span class="hljs-keyword">const</span> len = arr.<span class="hljs-property">length</span>
      <span class="hljs-keyword">if</span> (len &lt;= <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; len - <span class="hljs-number">1</span>; i++) {
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; len - i - <span class="hljs-number">1</span>; j++) {
              <span class="hljs-keyword">if</span> (arr[j] &gt; arr[j + <span class="hljs-number">1</span>]) {
                [arr[j], arr[j + <span class="hljs-number">1</span>]] = [arr[j + <span class="hljs-number">1</span>], arr[j]]
              }
          }
      }
  }
</code></pre>
<p>我们可以添加一个计算步数的看看我们的步数走了多少，这个过程可以看出我们部署总共走了36步</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">bubbleSort</span>(<span class="hljs-params">arr</span>) {
        <span class="hljs-keyword">const</span> len = arr.<span class="hljs-property">length</span>
        <span class="hljs-keyword">let</span> stepCount = <span class="hljs-number">0</span>; <span class="hljs-comment">// 步数计数器</span>
        <span class="hljs-keyword">if</span> (len &lt;= <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; len - <span class="hljs-number">1</span>; i++) {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; len - i - <span class="hljs-number">1</span>; j++) {
                stepCount++; <span class="hljs-comment">// 每次比较都算一步</span>
                <span class="hljs-keyword">if</span> (arr[j] &gt; arr[j + <span class="hljs-number">1</span>]) {
                  [arr[j], arr[j + <span class="hljs-number">1</span>]] = [arr[j + <span class="hljs-number">1</span>], arr[j]]
                }
            }
        }
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(stepCount,<span class="hljs-string">'步数'</span>);
        <span class="hljs-keyword">return</span> arr
}

<span class="hljs-comment">// 输出</span>
<span class="hljs-number">36</span> <span class="hljs-string">'步数'</span>
</code></pre>
<h5 data-id="heading-9">优化逻辑-添加有序标志减少遍历次数</h5>
<p>我们发现，虽然我们一直对比，但是后面其实我们已经排序好的并不需要太多的对比，所以我们可以添加一个有序标志</p>
<p>如果一轮遍历中没有发生任何交换，说明数组已经有序，可以提前结束排序</p>
<p>这个时候我们优化一下可以发现，步数已经缩减到了26步</p>
<p><strong>原理</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">这个标志用来判断在某一轮遍历中是否发生了元素交换
如果一轮遍历中没有发生任何交换，说明数组已经有序，可以提前结束排序

例子：
假设数组是 [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]，在第一轮遍历时：

比较<span class="hljs-number">1</span>和<span class="hljs-number">2</span>，不交换
比较<span class="hljs-number">2</span>和<span class="hljs-number">3</span>，不交换
比较<span class="hljs-number">3</span>和<span class="hljs-number">4</span>，不交换
比较<span class="hljs-number">4</span>和<span class="hljs-number">5</span>，不交换
整个过程中 isSorted 始终为<span class="hljs-literal">true</span>
因此排序提前结束，不需要进行后续的遍历
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 优化2 标志上一次移动的下标 有序标志 (isSorted)</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">bubbleSort</span>(<span class="hljs-params">arr</span>) {
      <span class="hljs-keyword">const</span> len = arr.<span class="hljs-property">length</span>;
      <span class="hljs-keyword">let</span> stepCount = <span class="hljs-number">0</span>; <span class="hljs-comment">// 步数计数器</span>
      <span class="hljs-keyword">if</span> (len &lt;= <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; len - <span class="hljs-number">1</span>; i++) {
          <span class="hljs-keyword">let</span> isSorted = <span class="hljs-literal">true</span> <span class="hljs-comment">// 有序标志</span>
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; len - i - <span class="hljs-number">1</span>; j++) {
              stepCount++; <span class="hljs-comment">// 每次比较都算一步</span>
              <span class="hljs-keyword">if</span> (arr[j] &gt; arr[j + <span class="hljs-number">1</span>]) {
                [arr[j], arr[j + <span class="hljs-number">1</span>]] = [arr[j + <span class="hljs-number">1</span>], arr[j]]
                isSorted = <span class="hljs-literal">false</span>
              }
          }
          <span class="hljs-keyword">if</span> (isSorted) {
              <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(isSorted, <span class="hljs-string">'交换结束===isSorted'</span>);
              <span class="hljs-keyword">break</span>
          } <span class="hljs-comment">// 如果没有发生交换，说明已经有序</span>
      }
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(stepCount,<span class="hljs-string">'步数'</span>);
      <span class="hljs-keyword">return</span> arr
  }
<span class="hljs-comment">// 输出 26 '步数'</span>
</code></pre>
<h5 data-id="heading-10">优化逻辑-添加无序边界 (sortBorder) 减少每次遍历的比较次数</h5>
<p>标记上一轮已经有序的位置  ,我们可以通过记录无序数列的边界位置</p>
<p>下一轮遍历时只需要比较到这个位置即可，因为后面的元素已经有序</p>
<pre><code class="hljs language-javascript" lang="javascript">例子： 
假设数组是 [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>]：

第一轮遍历：

<span class="hljs-number">3</span>和<span class="hljs-number">4</span>比较，不交换
<span class="hljs-number">4</span>和<span class="hljs-number">2</span>比较，交换，数组变为 [<span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>]，lastSwapIndex = <span class="hljs-number">2</span>
<span class="hljs-number">4</span>和<span class="hljs-number">1</span>比较，交换，数组变为 [<span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]，lastSwapIndex = <span class="hljs-number">3</span>
<span class="hljs-number">4</span>和<span class="hljs-number">5</span>比较，不交换
第一轮结束后，sortBorder = <span class="hljs-number">3</span>，因为最后一次交换发生在索引<span class="hljs-number">3</span>
此时我们知道，索引<span class="hljs-number">3</span>之后的元素(<span class="hljs-number">4</span>,<span class="hljs-number">5</span>)已经有序
第二轮遍历：

只需要比较到索引<span class="hljs-number">3</span>即可，不需要比较到最后
<span class="hljs-number">3</span>和<span class="hljs-number">2</span>比较，交换，数组变为 [<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]，lastSwapIndex = <span class="hljs-number">1</span>
<span class="hljs-number">3</span>和<span class="hljs-number">1</span>比较，交换，数组变为 [<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]，lastSwapIndex = <span class="hljs-number">2</span>
<span class="hljs-number">3</span>和<span class="hljs-number">4</span>比较，不交换
第二轮结束后，sortBorder = <span class="hljs-number">2</span>，因为最后一次交换发生在索引<span class="hljs-number">2</span>
此时我们知道，索引<span class="hljs-number">2</span>之后的元素(<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>)已经有序


</code></pre>
<p>这个时候输出我们发现，步数已经优化到了18步，也就是刚刚开始时候我们36步的一般，效率提升100%</p>
<pre><code class="hljs language-javascript" lang="javascript">
    <span class="hljs-comment">// 优化3 标记上一轮已经有序的位置  无序边界 (sortBorder) </span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">bubbleSort</span>(<span class="hljs-params">arr</span>) {
        <span class="hljs-keyword">let</span> stepCount = <span class="hljs-number">0</span>; <span class="hljs-comment">// 步数计数器</span>
        <span class="hljs-keyword">const</span> len = arr.<span class="hljs-property">length</span>;
        <span class="hljs-keyword">if</span> (len &lt;= <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> arr;

        <span class="hljs-keyword">let</span> sortBorder = len - <span class="hljs-number">1</span>; <span class="hljs-comment">// 初始时无序边界为数组末尾</span>
        <span class="hljs-keyword">let</span> lastSwapIndex = <span class="hljs-number">0</span>; <span class="hljs-comment">// 记录最后一次交换的位置</span>

        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; len - <span class="hljs-number">1</span>; i++) {
            <span class="hljs-keyword">let</span> isSorted = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 有序标志</span>

            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; sortBorder; j++) {
                stepCount++; <span class="hljs-comment">// 每次比较都算一步</span>
                <span class="hljs-keyword">if</span> (arr[j] &gt; arr[j + <span class="hljs-number">1</span>]) {
                    [arr[j], arr[j + <span class="hljs-number">1</span>]] = [arr[j + <span class="hljs-number">1</span>], arr[j]];
                    isSorted = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 发生了交换，说明还不是完全有序</span>
                    lastSwapIndex = j; <span class="hljs-comment">// 记录最后一次交换的位置</span>
                }
            }

            sortBorder = lastSwapIndex; <span class="hljs-comment">// 更新无序边界，边界之后的元素已经有序</span>
            <span class="hljs-keyword">if</span> (isSorted) {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(isSorted, <span class="hljs-string">'交换结束===isSorted'</span>);
                <span class="hljs-keyword">break</span>; <span class="hljs-comment">// 如果没有发生交换，说明已经有序</span>
            }
        }

        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(stepCount, <span class="hljs-string">'步数'</span>);
        <span class="hljs-keyword">return</span> arr;
    }

    <span class="hljs-comment">// 测试代码</span>
    <span class="hljs-keyword">const</span> testArr = [<span class="hljs-number">64</span>, <span class="hljs-number">34</span>, <span class="hljs-number">25</span>, <span class="hljs-number">12</span>, <span class="hljs-number">22</span>, <span class="hljs-number">11</span>, <span class="hljs-number">90</span>];
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'原始数组:'</span>, testArr);
    <span class="hljs-title function_">bubbleSort</span>(testArr);


<span class="hljs-comment">//输出 18 '步数'</span>

</code></pre>
<p>添加上我们计算步数以及以及交换和对比的计数</p>
<pre><code class="hljs language-javascript" lang="javascript"> <span class="hljs-comment">// 优化3 标记上一轮已经有序的位置  无序边界 (sortBorder) </span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">bubbleSort</span>(<span class="hljs-params">arr</span>) {
        <span class="hljs-keyword">let</span> stepCount = <span class="hljs-number">0</span>; <span class="hljs-comment">// 步数计数器</span>
        <span class="hljs-keyword">let</span> compareCount = <span class="hljs-number">0</span>; <span class="hljs-comment">// 比较次数计数器</span>
        <span class="hljs-keyword">let</span> swapCount = <span class="hljs-number">0</span>; <span class="hljs-comment">// 交换次数计数器</span>

        <span class="hljs-keyword">const</span> len = arr.<span class="hljs-property">length</span>;
        <span class="hljs-keyword">if</span> (len &lt;= <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> arr;
        <span class="hljs-keyword">let</span> sortBorder = len - <span class="hljs-number">1</span>; <span class="hljs-comment">// 初始时无序边界为数组末尾</span>
        <span class="hljs-keyword">let</span> lastSwapIndex = <span class="hljs-number">0</span>; <span class="hljs-comment">// 记录最后一次交换的位置</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; len - <span class="hljs-number">1</span>; i++) {

            <span class="hljs-keyword">let</span> isSorted = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 有序标志</span>

            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = <span class="hljs-number">0</span>; j &lt; sortBorder; j++) {

                stepCount++; <span class="hljs-comment">// 每次比较都算一步</span>
                compareCount++; <span class="hljs-comment">// 每次比较都计数</span>

                <span class="hljs-keyword">if</span> (arr[j] &gt; arr[j + <span class="hljs-number">1</span>]) {
                    [arr[j], arr[j + <span class="hljs-number">1</span>]] = [arr[j + <span class="hljs-number">1</span>], arr[j]];
                    isSorted = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 发生了交换，说明还不是完全有序</span>
                    lastSwapIndex = j; <span class="hljs-comment">// 记录最后一次交换的位置</span>
                    swapCount++; <span class="hljs-comment">// 每次交换都计数</span>
                }
            }
            sortBorder = lastSwapIndex; <span class="hljs-comment">// 更新无序边界，边界之后的元素已经有序</span>
            <span class="hljs-keyword">if</span> (isSorted) {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(isSorted, <span class="hljs-string">'交换结束isSorted'</span>);
                <span class="hljs-keyword">break</span>; <span class="hljs-comment">// 如果没有发生交换，说明已经有序</span>
            }
        }

        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(stepCount, <span class="hljs-string">'步数'</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'比较次数:'</span>, compareCount);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'交换次数:'</span>, swapCount);
        <span class="hljs-keyword">return</span> arr;
    }

    <span class="hljs-comment">// 功能测试</span>
    <span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">6</span>, <span class="hljs-number">2</span>, <span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">9</span>, <span class="hljs-number">8</span>]
    <span class="hljs-title function_">bubbleSort</span>(arr)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr) <span class="hljs-comment">// [1, 2, 3, 4, 5, 6, 7, 8, 9]</span>
</code></pre>
<h3 data-id="heading-11">2.快速排序（Quick Sort常考）</h3>
<p>认识</p>
<p>快速排序（Quick Sort）是一种经典的排序算法，广泛应用于实际工程中。主要特点是利用<strong>分治法</strong>来排序，能够在大多数情况下实现 <code>&lt;font style="color:rgb(36, 41, 47);"&gt;O(n log n)</code> 的时间复杂度。</p>
<p>通过一趟排序将要排序的数据分割成独立的两部分，其中一部分的所有数据都比另外一部分的所有数据都要小，然后再按此方法对这两部分数据分别进行快速排序，整个排序过程可以递归进行，以此达到整个数据变成有序序列。</p>
<pre><code class="hljs language-plain" lang="plain">/**
 * @description 快速排序
 * @author hovinghuang
 */

/**
 * 快速排序 (splice)
 * @param arr 
 * @returns 
 */
function quickSort1(arr: number[]): number[] {
    const len = arr.length
    if (len === 0) return arr

    const midIndex = Math.floor(len / 2)
    const midValue = arr.splice(midIndex, 1)[0]

    const left: number[] = []
    const right: number[] = []

    // 注意： splice 会修改原数组，所以用 arr.length
    for (let i = 0; i &lt; arr.length; i++) {
        const n = arr[i]
        if (n &lt; midValue) {
            left.push(n)
        } else {
            right.push(n)
        }
    }
    return quickSort1(left).concat([midValue], quickSort1(right))
}

/**
 * 快速排序 (slice)
 * @param arr 
 * @returns 
 */
 function quickSort2(arr: number[]): number[] {
    const len = arr.length
    if (len === 0) return arr

    const midIndex = Math.floor(len / 2)
    const midValue = arr.slice(midIndex, midIndex + 1)[0]

    const left: number[] = []
    const right: number[] = []

    for (let i = 0; i &lt; len; i++) {
        if (i === midIndex) continue
        const n = arr[i]
        if (n &lt; midValue) {
            left.push(n)
        } else {
            right.push(n)
        }
    }
    
    return quickSort2(left).concat([midValue], quickSort2(right))
}

// 功能测试
const testArr3 = [3, 2, 5, 1, 8, 7]
console.info('quickSort2:', quickSort2(testArr3))
</code></pre>
<h5 data-id="heading-12"><strong>基本概念</strong></h5>
<p>快速排序的核心思想是通过“<strong>分治法</strong>”将问题拆解为更小的子问题来递归解决。</p>
<ol>
<li><strong>分治法</strong>：快速排序每次通过选择一个元素作为基准（pivot），将数组分为两部分。左边部分的元素比基准小，右边部分的元素比基准大。然后，分别对左右两部分递归地进行排序。</li>
<li><strong>选择基准元素</strong>：可以选择第一个元素、最后一个元素或中间元素作为基准，或者通过随机选择基准来避免最坏情况。</li>
</ol>
<h5 data-id="heading-13"><strong>工作过程</strong></h5>
<ol>
<li><strong>选择基准元素（Pivot）</strong>：从待排序的数组中选择一个元素作为基准（可以是第一个元素、最后一个元素，或通过其他方法选择）。</li>
<li><strong>划分操作</strong>：将数组分为两部分。左边部分的元素都小于等于基准元素，右边部分的元素都大于基准元素。基准元素在划分过程中会被放到正确的位置。</li>
<li><strong>递归排序</strong>：对基准元素左边和右边的子数组继续进行快速排序。</li>
</ol>
<h5 data-id="heading-14">例子</h5>
<p>假设我们要对以下数组进行排序：</p>
<pre><code class="hljs language-plain" lang="plain">[6, 3, 8, 2, 7, 5, 1, 4]
</code></pre>
<ol>
<li><strong>选择基准元素</strong>：假设选择第一个元素 <code>6</code> 作为基准。</li>
<li><strong>划分操作</strong>：将数组划分为左边部分（小于等于6）和右边部分（大于6）。</li>
</ol>
<pre><code class="hljs language-plain" lang="plain">左边：[3, 2, 5, 1, 4]
基准：[6]
右边：[8, 7]
</code></pre>
<ol>
<li>对左右子数组递归进行快速排序：
<ul>
<li>左边 <code>[3, 2, 5, 1, 4]</code> 选择 <code>3</code> 为基准，再进行划分。</li>
<li>右边 <code>[8, 7]</code> 选择 <code>8</code> 为基准，再进行划分。</li>
</ul>
</li>
</ol>
<p>最终，经过递归排序后，得到排序后的数组：</p>
<pre><code class="hljs language-plain" lang="plain">[1, 2, 3, 4, 5, 6, 7, 8]
</code></pre>
<h5 data-id="heading-15"><strong>时间复杂度</strong></h5>
<ul>
<li><strong>最优情况</strong>：当每次基准元素将数组均匀分割时，时间复杂度为 <code>O(n log n)</code>，其中 <code>n</code> 是数组的长度。</li>
<li><strong>平均情况</strong>：在大多数实际情况下，快速排序的平均时间复杂度也是 <code>O(n log n)</code>。</li>
<li><strong>最坏情况</strong>：当选择的基准总是数组中的最大或最小元素（例如，数组已经排好序或完全逆序），导致每次分割只有一个元素时，时间复杂度退化为 <code>O(n^2)</code>。</li>
</ul>
<h5 data-id="heading-16"><strong>快速排序的空间复杂度</strong></h5>
<p>快速排序的空间复杂度是 <strong>O(log n)</strong>，这主要是由递归调用栈所占用的空间决定的。每次划分时，递归深度最多为 <code>log n</code>。</p>
<p>如果使用原地排序（即直接在原数组上修改，而不使用额外数组），空间复杂度可以降到 <strong>O(log n)</strong>。但如果每次划分时创建新的数组，空间复杂度则是 <strong>O(n)</strong>。</p>
<h5 data-id="heading-17"><strong>优缺点</strong></h5>
<h6 data-id="heading-18"><strong>优点</strong>：</h6>
<ol>
<li><strong>高效性</strong>：在大多数情况下，快速排序的性能非常优越，时间复杂度为 <code>O(n log n)</code>，适用于大规模数据排序。</li>
<li><strong>原地排序</strong>：快速排序是一种原地排序算法，不需要额外的存储空间（除了递归栈）。</li>
<li><strong>分治法</strong>：通过递归和分治法来处理复杂问题，适用于大规模数据集。</li>
</ol>
<h6 data-id="heading-19"><strong>缺点</strong>：</h6>
<ol>
<li>
<p><strong>最坏情况性能差</strong>：当数据已经接近有序或是逆序时，快速排序的性能会退化为 <code>O(n^2)</code>。这个问题可以通过随机选择基准元素或使用三数取中的方法来减少。</p>
</li>
<li>
<p><strong>不稳定排序</strong>：与冒泡排序、插入排序等稳定排序算法不同，快速排序会改变相等元素的顺序。</p>
</li>
</ol>
<h5 data-id="heading-20"><strong>优化策略</strong></h5>
<ol>
<li><strong>基准选择优化</strong>：
<ul>
<li><strong>随机选择基准</strong>：通过随机选择基准元素，可以避免在已经排序或逆序的数组上出现最坏情况。</li>
<li><strong>三数取中法</strong>：选择数组首、尾和中间三个元素的中位数作为基准，可以减少最坏情况的概率。</li>
</ul>
</li>
<li><strong>递归深度限制</strong>：
<ul>
<li>当子数组的长度较小时（如小于10），可以切换为其他排序算法，如插入排序，因为插入排序对小规模数据的排序更高效。</li>
</ul>
</li>
<li><strong>尾递归优化</strong>：
<ul>
<li>在递归过程中，可以选择递归较小的子数组，然后迭代处理较大的子数组，减少递归的深度。</li>
</ul>
</li>
</ol>
<h5 data-id="heading-21"><strong>快速排序核心</strong></h5>
<ol>
<li><strong>理解分治法</strong>：核心是分治法的思想。通过选择基准将问题划分成两个子问题，并通过递归解决它们。</li>
<li><strong>实现多种方式</strong>：尝试实现快速排序的不同版本，例如使用递归实现、使用随机基准、三数取中法等。</li>
<li><strong>分析时间复杂度</strong>：理解快速排序的时间复杂度分析，尤其是最坏情况和平均情况的区别，以及如何优化。</li>
<li><strong>与其他排序算法比较</strong>：将快速排序与其他排序算法（如冒泡排序、选择排序、归并排序等）比较其优缺点和场景。</li>
</ol>
<h5 data-id="heading-22">写法</h5>
<h6 data-id="heading-23">基础写法</h6>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 解法1 快速排序</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">quickSort</span>(<span class="hljs-params">arr</span>) {
        <span class="hljs-keyword">if</span> (arr.<span class="hljs-property">length</span> &lt;= <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> arr
        }
        <span class="hljs-comment">// 选择基准元素，这里我们选择第一个元素作为基准</span>
        <span class="hljs-keyword">let</span> pivot = arr[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">let</span> left = [];
        <span class="hljs-keyword">let</span> right = [];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) {
            <span class="hljs-keyword">if</span> (arr[i] &lt;= pivot) {
                left.<span class="hljs-title function_">push</span>(arr[i]);
            } <span class="hljs-keyword">else</span> {
                right.<span class="hljs-title function_">push</span>(arr[i]);
            }
        }
        <span class="hljs-keyword">return</span> [...<span class="hljs-title function_">quickSort</span>(left), pivot,...<span class="hljs-title function_">quickSort</span>(right)]
    }
    <span class="hljs-comment">// 测试数据</span>
    <span class="hljs-keyword">let</span> arr = [<span class="hljs-number">6</span>, <span class="hljs-number">3</span>, <span class="hljs-number">8</span>, <span class="hljs-number">2</span>, <span class="hljs-number">7</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>];
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"排序前："</span>, arr);
    <span class="hljs-keyword">let</span> sortedArr = <span class="hljs-title function_">quickSort</span>(arr);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"排序后："</span>, sortedArr);
</code></pre>
<h6 data-id="heading-24">整个过程</h6>
<pre><code class="hljs language-javascript" lang="javascript">选择一个基准元素（pivot），这里选择数组的第一个元素
将小于等于基准元素的元素放到左数组
将大于基准元素的元素放到右数组
递归地对左数组和右数组进行同样的排序
最后将排序后的左数组、基准元素和排序后的右数组合并

执行过程：
对于数组 [<span class="hljs-number">6</span>, <span class="hljs-number">3</span>, <span class="hljs-number">8</span>, <span class="hljs-number">2</span>, <span class="hljs-number">7</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>]
第一次选择<span class="hljs-number">6</span>为基准，分成 [<span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>] 和 [<span class="hljs-number">8</span>, <span class="hljs-number">7</span>]
然后对 [<span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>] 选择<span class="hljs-number">3</span>为基准，分成 [<span class="hljs-number">2</span>, <span class="hljs-number">1</span>] 和 [<span class="hljs-number">5</span>, <span class="hljs-number">4</span>]
对 [<span class="hljs-number">2</span>, <span class="hljs-number">1</span>] 选择<span class="hljs-number">2</span>为基准，分成 [<span class="hljs-number">1</span>] 和 []
对 [<span class="hljs-number">5</span>, <span class="hljs-number">4</span>] 选择<span class="hljs-number">5</span>为基准，分成 [<span class="hljs-number">4</span>] 和 []
对 [<span class="hljs-number">8</span>, <span class="hljs-number">7</span>] 选择<span class="hljs-number">8</span>为基准，分成 [<span class="hljs-number">7</span>] 和 []
然后按照相同的方式递归处理其他子数组


输出：
排序前：[<span class="hljs-number">6</span>, <span class="hljs-number">3</span>, <span class="hljs-number">8</span>, <span class="hljs-number">2</span>, <span class="hljs-number">7</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>]
排序后：[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>]

</code></pre>
<h6 data-id="heading-25">优化-使用随机基准选择</h6>
<p>添加注释以后我们更加容易看出添加基准以后，进行的步数大概平均下来在25步左右</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 写法优化1-使用随机基准选择</span>
   <span class="hljs-keyword">let</span> stepCount = <span class="hljs-number">0</span>; <span class="hljs-comment">// 全局步数计数器</span>
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`步骤 <span class="hljs-subst">${stepCount}</span>: 进入`</span>);
   <span class="hljs-keyword">function</span> <span class="hljs-title function_">quickSort</span>(<span class="hljs-params">arr</span>) {
      <span class="hljs-keyword">if</span> (arr.<span class="hljs-property">length</span> &lt;= <span class="hljs-number">1</span>) {
          <span class="hljs-keyword">return</span> arr
      }
      stepCount++; <span class="hljs-comment">// 基准选择计数</span>
      <span class="hljs-comment">// 选择基准元素，这里我们选择第一个元素作为基准</span>
      <span class="hljs-keyword">const</span> randomIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * arr.<span class="hljs-property">length</span>);
      [arr[<span class="hljs-number">0</span>], arr[randomIndex]] = [arr[randomIndex], arr[<span class="hljs-number">0</span>]]; <span class="hljs-comment">// 交换到第一个位置</span>
      <span class="hljs-keyword">let</span> pivot = arr[<span class="hljs-number">0</span>];
      <span class="hljs-keyword">let</span> left = [];
      <span class="hljs-keyword">let</span> right = [];
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) {
          stepCount++; <span class="hljs-comment">// 循环迭代计数</span>
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`步骤 <span class="hljs-subst">${stepCount}</span>: 检查元素 <span class="hljs-subst">${arr[i]}</span>, 当前基准: <span class="hljs-subst">${pivot}</span>`</span>);
          <span class="hljs-keyword">if</span> (arr[i] &lt;= pivot) {
              left.<span class="hljs-title function_">push</span>(arr[i]);
          } <span class="hljs-keyword">else</span> {
              right.<span class="hljs-title function_">push</span>(arr[i]);
          }
      }
      stepCount++; <span class="hljs-comment">// 递归调用计数</span>

      <span class="hljs-keyword">return</span> [...<span class="hljs-title function_">quickSort</span>(left), pivot,...<span class="hljs-title function_">quickSort</span>(right)]
  }
</code></pre>
<h6 data-id="heading-26">优化-使用三数取中法选择基准</h6>
<p>这个时候我们优化下来，在14步左右</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 优化2-使用三数取中法选择基准（带步数计算）</span>
     <span class="hljs-keyword">let</span> stepCount = <span class="hljs-number">0</span>; <span class="hljs-comment">// 全局步数计数器</span>
     <span class="hljs-keyword">function</span> <span class="hljs-title function_">quickSort</span>(<span class="hljs-params">arr</span>) {
        <span class="hljs-keyword">if</span> (arr.<span class="hljs-property">length</span> &lt;= <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> arr
        }
        stepCount++; <span class="hljs-comment">// 基准选择计数</span>
        <span class="hljs-comment">// 选择基准元素，这里我们选择第一个元素作为基准</span>
        <span class="hljs-keyword">const</span> mid = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(arr.<span class="hljs-property">length</span> / <span class="hljs-number">2</span>);

        <span class="hljs-comment">// 比较三个数</span>
        <span class="hljs-keyword">if</span> (arr[<span class="hljs-number">0</span>] &gt; arr[mid]) {
            [arr[<span class="hljs-number">0</span>], arr[mid]] = [arr[mid], arr[<span class="hljs-number">0</span>]];
        }
        <span class="hljs-keyword">if</span> (arr[<span class="hljs-number">0</span>] &gt; arr[arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>]) {
            [arr[<span class="hljs-number">0</span>], arr[arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>]] = [arr[arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>], arr[<span class="hljs-number">0</span>]];
        }
        <span class="hljs-keyword">if</span> (arr[mid] &gt; arr[arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>]) {
            [arr[mid], arr[arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>]] = [arr[arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>], arr[mid]];
        }
        <span class="hljs-keyword">let</span> pivot = arr[mid];;
        <span class="hljs-keyword">let</span> left = [];
        <span class="hljs-keyword">let</span> right = [];
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) {
            <span class="hljs-keyword">if</span> (i === mid) <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// 跳过基准元素</span>
            stepCount++; <span class="hljs-comment">// 循环迭代计数</span>
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`步骤 <span class="hljs-subst">${stepCount}</span>: 检查元素 <span class="hljs-subst">${arr[i]}</span>, 当前基准: <span class="hljs-subst">${pivot}</span>`</span>);
            <span class="hljs-keyword">if</span> (arr[i] &lt;= pivot) {
                left.<span class="hljs-title function_">push</span>(arr[i]);
            } <span class="hljs-keyword">else</span> {
                right.<span class="hljs-title function_">push</span>(arr[i]);
            }
        }
        stepCount++; <span class="hljs-comment">// 递归调用计数</span>
        <span class="hljs-keyword">return</span> [...<span class="hljs-title function_">quickSort</span>(left), pivot,...<span class="hljs-title function_">quickSort</span>(right)]
}
</code></pre>
<h6 data-id="heading-27">优化3-使用原地分区</h6>
<p>这里一定得去看看原理分区的概念才能理解这个原地分区，其实就是不借助于额外存储进行位置的不断交换</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 优化3-使用原地分区</span>
    <span class="hljs-keyword">let</span> stepCount = <span class="hljs-number">0</span>; <span class="hljs-comment">// 全局步数计数器</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">quickSort</span>(<span class="hljs-params">arr, left = <span class="hljs-number">0</span>, right = arr.length - <span class="hljs-number">1</span></span>) {
        <span class="hljs-keyword">if</span> (left &lt; right) {
            stepCount++; <span class="hljs-comment">// 递归调用计数</span>
            <span class="hljs-keyword">const</span> mid = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((left + right) / <span class="hljs-number">2</span>);
            <span class="hljs-comment">// 比较三个数</span>
            <span class="hljs-keyword">if</span> (arr[left] &gt; arr[mid]) {
                [arr[left], arr[mid]] = [arr[mid], arr[left]];
            }
            <span class="hljs-keyword">if</span> (arr[left] &gt; arr[right]) {
                [arr[left], arr[right]] = [arr[right], arr[left]];
            }
            <span class="hljs-keyword">if</span> (arr[mid] &gt; arr[right]) {
                [arr[mid], arr[right]] = [arr[right], arr[mid]];
            }

            [arr[mid], arr[right]] = [arr[right], arr[mid]];
            <span class="hljs-keyword">const</span> pivot = arr[right];
            <span class="hljs-keyword">let</span> i = left - <span class="hljs-number">1</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = left; j &lt; right; j++) {
                stepCount++; <span class="hljs-comment">// 循环迭代计数</span>
                <span class="hljs-keyword">if</span> (arr[j] &lt;= pivot) {
                    i++;
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
            }
            [arr[mid], arr[right]] = [arr[right], arr[mid]];
            <span class="hljs-keyword">const</span> partitionIndex = i + <span class="hljs-number">1</span>;
            <span class="hljs-title function_">quickSort</span>(arr, left, partitionIndex - <span class="hljs-number">1</span>);
            <span class="hljs-title function_">quickSort</span>(arr, partitionIndex + <span class="hljs-number">1</span>, right);
        }
        <span class="hljs-keyword">return</span> arr;
    }

    <span class="hljs-comment">// 测试数据</span>
    <span class="hljs-keyword">let</span> arr = [<span class="hljs-number">6</span>, <span class="hljs-number">3</span>, <span class="hljs-number">8</span>, <span class="hljs-number">2</span>, <span class="hljs-number">7</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>];
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"排序前："</span>, arr);
    <span class="hljs-keyword">let</span> sortedArr = <span class="hljs-title function_">quickSort</span>(arr);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"排序后："</span>, sortedArr);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"总步数："</span>, stepCount);
</code></pre>
<h6 data-id="heading-28">优化4-添加小数组插入排序优化</h6>
<p>这个时候我们又能感觉到步数明显确实加快了</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 优化4-添加小数组插入排序优化</span>
     <span class="hljs-keyword">let</span> stepCount = <span class="hljs-number">0</span>; <span class="hljs-comment">// 全局步数计数器</span>
     <span class="hljs-keyword">function</span> <span class="hljs-title function_">quickSort</span>(<span class="hljs-params">arr, left = <span class="hljs-number">0</span>, right = arr.length - <span class="hljs-number">1</span></span>) {

         <span class="hljs-comment">// 对小数组使用插入排序</span>
        <span class="hljs-keyword">if</span> (right - left &lt; <span class="hljs-number">10</span>) {
            <span class="hljs-title function_">insertionSort</span>(arr, left, right);
            stepCount++;
            <span class="hljs-keyword">return</span> arr;
        }

        <span class="hljs-keyword">if</span> (left &lt; right) {
            stepCount++; <span class="hljs-comment">// 递归调用计数</span>
            <span class="hljs-keyword">const</span> mid = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((left + right) / <span class="hljs-number">2</span>);
            <span class="hljs-comment">// 比较三个数</span>
            <span class="hljs-keyword">if</span> (arr[left] &gt; arr[mid]) {
                [arr[left], arr[mid]] = [arr[mid], arr[left]];
            }
            <span class="hljs-keyword">if</span> (arr[left] &gt; arr[right]) {
                [arr[left], arr[right]] = [arr[right], arr[left]];
            }
            <span class="hljs-keyword">if</span> (arr[mid] &gt; arr[right]) {
                [arr[mid], arr[right]] = [arr[right], arr[mid]];
            }
            [arr[mid], arr[right]] = [arr[right], arr[mid]];
            <span class="hljs-keyword">const</span> pivot = arr[right];
            <span class="hljs-keyword">let</span> i = left - <span class="hljs-number">1</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = left; j &lt; right; j++) {
                stepCount++; <span class="hljs-comment">// 循环迭代计数</span>
                <span class="hljs-keyword">if</span> (arr[j] &lt;= pivot) {
                    i++;
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
            }
             [arr[i + <span class="hljs-number">1</span>], arr[right]] = [arr[right], arr[i + <span class="hljs-number">1</span>]];
            <span class="hljs-keyword">const</span> partitionIndex = i + <span class="hljs-number">1</span>;
            <span class="hljs-title function_">quickSort</span>(arr, left, partitionIndex - <span class="hljs-number">1</span>);
            <span class="hljs-title function_">quickSort</span>(arr, partitionIndex + <span class="hljs-number">1</span>, right);
        }
        <span class="hljs-keyword">return</span> arr;
    }


    <span class="hljs-comment">// 辅助函数：插入排序（带步数计算）</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">insertionSort</span>(<span class="hljs-params">arr, left, right</span>) {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = left + <span class="hljs-number">1</span>; i &lt;= right; i++) {
            <span class="hljs-keyword">const</span> key = arr[i];
            <span class="hljs-keyword">let</span> j = i - <span class="hljs-number">1</span>;
            <span class="hljs-keyword">while</span> (j &gt;= left &amp;&amp; arr[j] &gt; key) {
                arr[j + <span class="hljs-number">1</span>] = arr[j];
                j--;
            }
            arr[j + <span class="hljs-number">1</span>] = key;
        }
        <span class="hljs-keyword">return</span> arr;
    }
</code></pre>
<h6 data-id="heading-29">优化5-尾递归优化的原理</h6>
<p>优化前（普通递归）：</p>
<pre><code class="hljs language-plain" lang="plain">复制 插入 新文件

factorial(3)
→ 3 * factorial(2)
→ 3 * (2 * factorial(1))
→ 3 * (2 * 1)
→ 3 * 2
→ 6
</code></pre>
<p>优化后（尾递归）：</p>
<pre><code class="hljs language-plain" lang="plain">复制 插入 新文件

factorial(3, 1)
→ factorial(2, 3)
→ factorial(1, 6)
→ 6
</code></pre>
<p>这里我们进行一下尾递归优化的写法，核心就是下面的代码</p>
<p>优点：避免递归深度过大，从而引发栈溢出</p>
<p>传统的快速排序</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">quickSort</span>(arr, left, partitionIndex - <span class="hljs-number">1</span>);  <span class="hljs-comment">// 递归处理左子数组</span>
<span class="hljs-title function_">quickSort</span>(arr, partitionIndex + <span class="hljs-number">1</span>, right); <span class="hljs-comment">// 递归处理右子数组</span>
</code></pre>
<p>尾递归</p>
<pre><code class="hljs language-javascript" lang="javascript"> <span class="hljs-comment">// 先处理较小的子数组，减少递归深度</span>
  <span class="hljs-keyword">if</span> (partitionIndex - left &lt; right - partitionIndex) {
      <span class="hljs-title function_">quickSort</span>(arr, left, partitionIndex - <span class="hljs-number">1</span>);
      left = partitionIndex + <span class="hljs-number">1</span>;
  } <span class="hljs-keyword">else</span> {
      <span class="hljs-title function_">quickSort</span>(arr, partitionIndex + <span class="hljs-number">1</span>, right);
      right = partitionIndex - <span class="hljs-number">1</span>;
  }
</code></pre>
<p>尾递归优化完整</p>
<pre><code class="hljs language-javascript" lang="javascript"> <span class="hljs-comment">// 优化5 - 尾递归优化</span>
    <span class="hljs-keyword">let</span> stepCount = <span class="hljs-number">0</span>; <span class="hljs-comment">// 全局步数计数器</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">quickSort</span>(<span class="hljs-params">arr, left = <span class="hljs-number">0</span>, right = arr.length - <span class="hljs-number">1</span></span>) {

        <span class="hljs-comment">// 对小数组使用插入排序</span>
        <span class="hljs-keyword">if</span> (right - left &lt; <span class="hljs-number">10</span>) {
            <span class="hljs-title function_">insertionSort</span>(arr, left, right);
            stepCount++;
            <span class="hljs-keyword">return</span> arr;
        }

        <span class="hljs-keyword">while</span> (left &lt; right) {
            stepCount++; <span class="hljs-comment">// 递归调用计数</span>
            <span class="hljs-keyword">const</span> mid = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((left + right) / <span class="hljs-number">2</span>);

            <span class="hljs-comment">// 比较三个数</span>
            <span class="hljs-keyword">if</span> (arr[left] &gt; arr[mid]) {
                [arr[left], arr[mid]] = [arr[mid], arr[left]];
            }
            <span class="hljs-keyword">if</span> (arr[left] &gt; arr[right]) {
                [arr[left], arr[right]] = [arr[right], arr[left]];
            }
            <span class="hljs-keyword">if</span> (arr[mid] &gt; arr[right]) {
                [arr[mid], arr[right]] = [arr[right], arr[mid]];
            }

            <span class="hljs-comment">// 将基准放到right位置</span>
            [arr[mid], arr[right]] = [arr[right], arr[mid]];
            <span class="hljs-keyword">const</span> pivot = arr[right];


            <span class="hljs-keyword">let</span> i = left - <span class="hljs-number">1</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> j = left; j &lt; right; j++) {
                stepCount++; <span class="hljs-comment">// 循环迭代计数</span>
                <span class="hljs-keyword">if</span> (arr[j] &lt;= pivot) {
                    i++;
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
            }
            [arr[i + <span class="hljs-number">1</span>], arr[right]] = [arr[right], arr[i + <span class="hljs-number">1</span>]];


            <span class="hljs-comment">// </span>
            <span class="hljs-keyword">const</span> partitionIndex = i + <span class="hljs-number">1</span>;


            <span class="hljs-comment">// 先处理较小的子数组，减少递归深度</span>
            <span class="hljs-keyword">if</span> (partitionIndex - left &lt; right - partitionIndex) {
                <span class="hljs-title function_">quickSort</span>(arr, left, partitionIndex - <span class="hljs-number">1</span>);
                left = partitionIndex + <span class="hljs-number">1</span>;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-title function_">quickSort</span>(arr, partitionIndex + <span class="hljs-number">1</span>, right);
                right = partitionIndex - <span class="hljs-number">1</span>;
            }

        }
        <span class="hljs-keyword">return</span> arr;
    }


    <span class="hljs-comment">// 辅助函数：插入排序（带步数计算）</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">insertionSort</span>(<span class="hljs-params">arr, left, right</span>) {
        stepCount++;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`步骤 <span class="hljs-subst">${stepCount}</span>: 进入insertionSort, 范围: [<span class="hljs-subst">${left}</span>, <span class="hljs-subst">${right}</span>]`</span>);

        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = left + <span class="hljs-number">1</span>; i &lt;= right; i++) {
            stepCount++;
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`步骤 <span class="hljs-subst">${stepCount}</span>: 处理元素arr[<span class="hljs-subst">${i}</span>](<span class="hljs-subst">${arr[i]}</span>)`</span>);
            <span class="hljs-keyword">const</span> key = arr[i];
            <span class="hljs-keyword">let</span> j = i - <span class="hljs-number">1</span>;

            stepCount++;
            <span class="hljs-keyword">while</span> (j &gt;= left &amp;&amp; arr[j] &gt; key) {
                stepCount++;
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`步骤 <span class="hljs-subst">${stepCount}</span>: 移动arr[<span class="hljs-subst">${j}</span>]到arr[<span class="hljs-subst">${j + <span class="hljs-number">1</span>}</span>]`</span>);
                arr[j + <span class="hljs-number">1</span>] = arr[j];
                j--;
            }

            stepCount++;
            arr[j + <span class="hljs-number">1</span>] = key;
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`步骤 <span class="hljs-subst">${stepCount}</span>: 将<span class="hljs-subst">${key}</span>放到位置<span class="hljs-subst">${j + <span class="hljs-number">1</span>}</span>，数组变为:`</span>, arr);
        }

        stepCount++;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`步骤 <span class="hljs-subst">${stepCount}</span>: 插入排序完成`</span>);
        <span class="hljs-keyword">return</span> arr;
    }
</code></pre>
<h3 data-id="heading-30">3.插入排序（Insertion Sort）</h3>
<h5 data-id="heading-31">认识</h5>
<p>插入排序是一种最简单直观的排序算法，它的工作原理是通过构建有序序列，对于未排序数据，在已排序序列中从后向前扫描，找到相应位置并插入,类似于我们整理手中的扑克牌 ,一次只处理一个元素，每次都将当前元素插入到已排序部分的正确位置。</p>
<pre><code class="hljs language-plain" lang="plain">function insertionSort(arr) {
    for (let i = 1; i &lt; arr.length; i++) {
        const temp = arr[i];
        let j = i;
        while (j &gt; 0) {
            if (arr[j - 1] &gt; temp) {
                arr[j] = arr[j - 1];
            } else {
                break;
            }
            j--;
        }
        arr[j] = temp;
    }
}

// 功能测试
const arr = [4, 3, 6, 2, 5, 7, 9, 8, 1]
insertionSort(arr)
console.log(arr) // [1, 2, 3, 4, 5, 6, 7, 8, 9]
</code></pre>
<h5 data-id="heading-32">核心思想</h5>
<p>将数组分为两个部分：</p>
<p>已排序部分：初始时只包含第一个元素</p>
<p>未排序部分：包含其余所有元素</p>
<p>算法通过从未排序部分取出一个元素，并将其插入到已排序部分的适当位置，从而不断扩大已排序部分，直到整个数组排序完成。</p>
<h6 data-id="heading-33">时间复杂度</h6>
<ul>
<li>最坏时间复杂度：O(n²) - 当数组是逆序时</li>
<li>平均时间复杂度：O(n²)</li>
<li>最好时间复杂度：O(n) - 当数组已经有序时</li>
</ul>
<h6 data-id="heading-34">空间复杂度</h6>
<ul>
<li>O(1) - 只需要常数级别的额外空间</li>
</ul>
<h5 data-id="heading-35">优缺点</h5>
<h5 data-id="heading-36">优点</h5>
<ol>
<li>实现简单，容易理解</li>
<li>对于小规模数据或基本有序的数据效率较高</li>
<li>是稳定排序算法（相等元素的相对顺序不变）</li>
<li>是原地排序算法，不需要额外空间</li>
</ol>
<h5 data-id="heading-37">缺点</h5>
<ol>
<li>对于大规模数据效率较低</li>
<li>最坏情况下时间复杂度为O(n²)</li>
</ol>
<h5 data-id="heading-38">适用场景</h5>
<ol>
<li>数据规模较小</li>
<li>数据基本有序</li>
<li>需要稳定排序的场景</li>
<li>内存受限的场景</li>
</ol>
<h3 data-id="heading-39">4.归并排序（Merge Sort）</h3>
<h4 data-id="heading-40">认识</h4>
<p>归并排序（Merge Sort）是一种基于分治法（Divide and Conquer）的高效排序算法。它将数组分成两半，分别对两半进行排序，然后将排序好的两半合并成一个有序数组。归并排序是稳定排序算法，时间复杂度为O(n log n)。</p>
<p>大致实现如下</p>
<pre><code class="hljs language-plain" lang="plain">function mergeSort(arr) {
    if(arr.length === 1) return arr
    
    let mid = Math.floor(arr.length / 2)
    let left = arr.slice(0, mid)
    let right = arr.slice(mid)
    
    return merge(mergeSort(left), mergeSort(right))
}

function merge(a, b) {
    let res = []
    
    while (a.length &amp;&amp; b.length) {
        if (a[0] &lt; b[0]) {
            res.push(a[0])
            a.shift()
        } else {
            res.push(b[0])
            b.shift()
        }
    }
    
    if(a.length){
        res = res.concat(a)
    } else {
        res = res.concat(b)
    }
    
    return res
}

// 功能测试
const arr = [4, 3, 6, 2, 5, 7, 9, 8, 1]
console.log(mergeSort(arr)) // [1, 2, 3, 4, 5, 6, 7, 8, 9]
</code></pre>
<h4 data-id="heading-41">原理</h4>
<p>归并排序的核心思想是"分而治之"，主要包含两个步骤：</p>
<ol>
<li>分：将数组不断二分，直到每个子数组只有一个元素（单个元素自然是有序的）</li>
<li>治：将有序的子数组两两合并，直到合并成一个完整的有序数组</li>
</ol>
<p>主要就是分为两步</p>
<ul>
<li>分割：将待排序的线性表不断地切分成若干个子表，直到每个子表只包含一个元素，这时，可以认为只包含一个元素的子表是有序表。</li>
<li>归并：将子表两两合并，每合并一次，就会产生一个新的且更长的有序表，重复这一步骤，直到最后只剩下一个子表，这个子表就是排好序的线性表。</li>
</ul>
<h4 data-id="heading-42">算法步骤</h4>
<ol>
<li>分解阶段：
<ul>
<li>将数组从中间分成两个子数组</li>
<li>递归地对每个子数组进行分解，直到每个子数组只有一个元素</li>
</ul>
</li>
<li>合并阶段：
<ul>
<li>将两个有序的子数组合并成一个有序数组</li>
<li>比较两个子数组的元素，按顺序取出较小的元素放入结果数组</li>
<li>如果其中一个子数组已经全部取出，则将另一个子数组的剩余元素直接复制到结果数组</li>
</ul>
</li>
</ol>
<h4 data-id="heading-43">时间复杂度分析</h4>
<ul>
<li>最好时间复杂度：O(n log n)</li>
<li>平均时间复杂度：O(n log n)</li>
<li>最坏时间复杂度：O(n log n)</li>
<li>空间复杂度：O(n) - 需要额外的空间来存储合并的数组</li>
</ul>
<h4 data-id="heading-44">优缺点分析</h4>
<h4 data-id="heading-45">优点</h4>
<ol>
<li>时间复杂度稳定：在各种情况下都是O(n log n)</li>
<li>稳定排序：相等元素的相对顺序保持不变</li>
<li>适合大规模数据：对于大数据集效率较高</li>
<li>可并行化：分解阶段可以并行处理</li>
</ol>
<h4 data-id="heading-46">缺点</h4>
<ol>
<li>空间复杂度高：需要O(n)的额外空间</li>
<li>小规模数据性能不如插入排序：对于小数组，插入排序可能更高效</li>
<li>不是原地排序：需要额外的存储空间</li>
</ol>
<h4 data-id="heading-47">JavaScript实现</h4>
<h5 data-id="heading-48">基础实现</h5>
<pre><code class="hljs language-javascript" lang="javascript">&lt;!<span class="hljs-variable constant_">DOCTYPE</span> html&gt;
&lt;html lang="en"&gt;

&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;title&gt;归并排序&lt;/title&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;script&gt;
    // 解法1 归并排序
    const merge=(left,right)=&gt;{
        let result = [];
        let leftIndex = 0;
        let rightIndex = 0;
        while (leftIndex &lt; left.length &amp;&amp; rightIndex &lt; right.length) {
            if(left[leftIndex]&lt;right[rightIndex]){
                result.push(left[leftIndex])
                leftIndex++;
            }else{
                result.push(right[rightIndex])
                rightIndex++;
            }
        }
        return result.concat(left.slice(leftIndex)).concat(right.slice(rightIndex));
    };
    const  mergeSort=(arr)=&gt; {
        // 数组长度小于等于1，则已经有序
        if(arr.length&lt;=1){
            return arr;
        }
        // 分解阶段：将数组分成两半
        const middle=Math.floor(arr.length / 2);
        const left =arr.slice(0,middle);
        const right =arr.slice(middle);
        return merge(mergeSort(left),mergeSort(right))
    }

    // 示例使用
    const arr = [38, 27, 43, 3, 9, 82, 10];
    console.log("原始数组:", arr);
    console.log("排序后数组:", mergeSort(arr));
    &lt;/script&gt;
&lt;/body&gt;

&lt;/html&gt;
</code></pre>
<h5 data-id="heading-49">优化1-对小数组使用插入排序</h5>
<p>归并排序的方式比较适合于大数组，这种时候小数组我们可以额外使用插入排序进行优化</p>
<pre><code class="hljs language-javascript" lang="javascript">当数组长度小于某个阈值（如<span class="hljs-number">10</span>-<span class="hljs-number">20</span>）时，使用插入排序而不是继续递归归并排序
插入排序在小数组上表现通常比归并排序更好
</code></pre>
<p>设置阈值以后</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 2 优化-小数组使用插入排序</span>
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">INSERTION_SORT_THRESHOLD</span> = <span class="hljs-number">10</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">insertionSort</span> = (<span class="hljs-params">arr</span>) =&gt; {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) {
            <span class="hljs-keyword">let</span> key = arr[i];
            <span class="hljs-keyword">let</span> j = i - <span class="hljs-number">1</span>;
            <span class="hljs-keyword">while</span> (j &gt;= <span class="hljs-number">0</span> &amp;&amp; arr[j] &gt; key) {
                arr[j + <span class="hljs-number">1</span>] = arr[j];
                j--;
            }
            arr[j + <span class="hljs-number">1</span>] = key;
        }
        <span class="hljs-keyword">return</span> arr;
    };
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">merge</span>=(<span class="hljs-params">left,right</span>)=&gt;{
        <span class="hljs-keyword">let</span> result = [];
        <span class="hljs-keyword">let</span> leftIndex = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">let</span> rightIndex = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">while</span> (leftIndex &lt; left.<span class="hljs-property">length</span> &amp;&amp; rightIndex &lt; right.<span class="hljs-property">length</span>) {
            <span class="hljs-keyword">if</span>(left[leftIndex]&lt;right[rightIndex]){
                result.<span class="hljs-title function_">push</span>(left[leftIndex])
                leftIndex++;
            }<span class="hljs-keyword">else</span>{
                result.<span class="hljs-title function_">push</span>(right[rightIndex])
                rightIndex++;
            }
        }
        <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">concat</span>(left.<span class="hljs-title function_">slice</span>(leftIndex)).<span class="hljs-title function_">concat</span>(right.<span class="hljs-title function_">slice</span>(rightIndex));
    };
    <span class="hljs-keyword">const</span>  <span class="hljs-title function_">mergeSort</span>=(<span class="hljs-params">arr</span>)=&gt; {
        <span class="hljs-comment">// 数组长度小于等于1，则已经有序</span>
        <span class="hljs-keyword">if</span>(arr.<span class="hljs-property">length</span>&lt;=<span class="hljs-variable constant_">INSERTION_SORT_THRESHOLD</span>){
            <span class="hljs-keyword">return</span> <span class="hljs-title function_">insertionSort</span>([...arr]);
        }
        <span class="hljs-comment">// 分解阶段：将数组分成两半</span>
        <span class="hljs-keyword">const</span> middle=<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(arr.<span class="hljs-property">length</span> / <span class="hljs-number">2</span>);
        <span class="hljs-keyword">const</span> left =arr.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>,middle);
        <span class="hljs-keyword">const</span> right =arr.<span class="hljs-title function_">slice</span>(middle);
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">merge</span>(<span class="hljs-title function_">mergeSort</span>(left), <span class="hljs-title function_">mergeSort</span>(right));
    }
</code></pre>
<h5 data-id="heading-50">优化合并过程</h5>
<p>检查左右数组是否已经有序，避免不必要的比较</p>
<pre><code class="hljs language-javascript" lang="javascript"> <span class="hljs-comment">// 3-优化合并过程</span>
    <span class="hljs-comment">// 检查左右数组是否已经有序，避免不必要的比较</span>
    <span class="hljs-comment">// 这里感觉其实就是各种排序之间的特性进行优化</span>
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">INSERTION_SORT_THRESHOLD</span> = <span class="hljs-number">10</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">insertionSort</span> = (<span class="hljs-params">arr</span>) =&gt; {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) {
            <span class="hljs-keyword">let</span> key = arr[i];
            <span class="hljs-keyword">let</span> j = i - <span class="hljs-number">1</span>;
            <span class="hljs-keyword">while</span> (j &gt;= <span class="hljs-number">0</span> &amp;&amp; arr[j] &gt; key) {
                arr[j + <span class="hljs-number">1</span>] = arr[j];
                j--;
            }
            arr[j + <span class="hljs-number">1</span>] = key;
        }
        <span class="hljs-keyword">return</span> arr;
    };
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">merge</span>=(<span class="hljs-params">left,right</span>)=&gt;{
        <span class="hljs-comment">// 检查是否可以直接合并</span>
        <span class="hljs-keyword">if</span> (left[left.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>] &lt;= right[<span class="hljs-number">0</span>]) {
            <span class="hljs-keyword">return</span> left.<span class="hljs-title function_">concat</span>(right);
        }
        <span class="hljs-keyword">if</span> (right[right.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>] &lt;= left[<span class="hljs-number">0</span>]) {
            <span class="hljs-keyword">return</span> right.<span class="hljs-title function_">concat</span>(left);
        }
        <span class="hljs-keyword">let</span> result = [];
        <span class="hljs-keyword">let</span> leftIndex = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">let</span> rightIndex = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">while</span> (leftIndex &lt; left.<span class="hljs-property">length</span> &amp;&amp; rightIndex &lt; right.<span class="hljs-property">length</span>) {
            <span class="hljs-keyword">if</span>(left[leftIndex]&lt;right[rightIndex]){
                result.<span class="hljs-title function_">push</span>(left[leftIndex])
                leftIndex++;
            }<span class="hljs-keyword">else</span>{
                result.<span class="hljs-title function_">push</span>(right[rightIndex])
                rightIndex++;
            }
        }
        <span class="hljs-keyword">return</span> result.<span class="hljs-title function_">concat</span>(left.<span class="hljs-title function_">slice</span>(leftIndex)).<span class="hljs-title function_">concat</span>(right.<span class="hljs-title function_">slice</span>(rightIndex));
    };
    <span class="hljs-keyword">const</span>  <span class="hljs-title function_">mergeSort</span>=(<span class="hljs-params">arr</span>)=&gt; {
        <span class="hljs-comment">// 数组长度小于等于1，则已经有序</span>
        <span class="hljs-keyword">if</span>(arr.<span class="hljs-property">length</span>&lt;=<span class="hljs-variable constant_">INSERTION_SORT_THRESHOLD</span>){
            <span class="hljs-keyword">return</span> <span class="hljs-title function_">insertionSort</span>([...arr]);
        }
        <span class="hljs-comment">// 分解阶段：将数组分成两半</span>
        <span class="hljs-keyword">const</span> middle=<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(arr.<span class="hljs-property">length</span> / <span class="hljs-number">2</span>);
        <span class="hljs-keyword">const</span> left =arr.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>,middle);
        <span class="hljs-keyword">const</span> right =arr.<span class="hljs-title function_">slice</span>(middle);
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">merge</span>(<span class="hljs-title function_">mergeSort</span>(left), <span class="hljs-title function_">mergeSort</span>(right));
    }

</code></pre>
<h5 data-id="heading-51">优化-预先分配结果数组空间</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 预先分配结果数组空间</span>
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">INSERTION_SORT_THRESHOLD</span> = <span class="hljs-number">10</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">insertionSort</span> = (<span class="hljs-params">arr</span>) =&gt; {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) {
            <span class="hljs-keyword">let</span> key = arr[i];
            <span class="hljs-keyword">let</span> j = i - <span class="hljs-number">1</span>;
            <span class="hljs-keyword">while</span> (j &gt;= <span class="hljs-number">0</span> &amp;&amp; arr[j] &gt; key) {
                arr[j + <span class="hljs-number">1</span>] = arr[j];
                j--;
            }
            arr[j + <span class="hljs-number">1</span>] = key;
        }
        <span class="hljs-keyword">return</span> arr;
    };
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">merge</span>=(<span class="hljs-params">left,right</span>)=&gt;{
        <span class="hljs-comment">// 检查是否可以直接合并</span>
        <span class="hljs-keyword">if</span> (left[left.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>] &lt;= right[<span class="hljs-number">0</span>]) {
            <span class="hljs-keyword">return</span> left.<span class="hljs-title function_">concat</span>(right);
        }
        <span class="hljs-keyword">if</span> (right[right.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>] &lt;= left[<span class="hljs-number">0</span>]) {
            <span class="hljs-keyword">return</span> right.<span class="hljs-title function_">concat</span>(left);
        }
         <span class="hljs-comment">// 预先分配结果数组空间</span>
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(left.<span class="hljs-property">length</span> + right.<span class="hljs-property">length</span>);
        <span class="hljs-keyword">let</span> leftIndex = <span class="hljs-number">0</span>, rightIndex = <span class="hljs-number">0</span>, resultIndex = <span class="hljs-number">0</span>;

        <span class="hljs-keyword">while</span> (leftIndex &lt; left.<span class="hljs-property">length</span> &amp;&amp; rightIndex &lt; right.<span class="hljs-property">length</span>) {
            result[resultIndex++] = left[leftIndex] &lt; right[rightIndex] 
            ? left[leftIndex++] 
            : right[rightIndex++];
        }
         <span class="hljs-comment">// 处理剩余元素</span>
        <span class="hljs-keyword">while</span> (leftIndex &lt; left.<span class="hljs-property">length</span>) {
            result[resultIndex++] = left[leftIndex++];
        }
        <span class="hljs-keyword">while</span> (rightIndex &lt; right.<span class="hljs-property">length</span>) {
            result[resultIndex++] = right[rightIndex++];
        }
        
        <span class="hljs-keyword">return</span> result;
    };
    <span class="hljs-keyword">const</span>  <span class="hljs-title function_">mergeSort</span>=(<span class="hljs-params">arr</span>)=&gt; {
        <span class="hljs-comment">// 数组长度小于等于1，则已经有序</span>
        <span class="hljs-keyword">if</span>(arr.<span class="hljs-property">length</span>&lt;=<span class="hljs-variable constant_">INSERTION_SORT_THRESHOLD</span>){
            <span class="hljs-keyword">return</span> <span class="hljs-title function_">insertionSort</span>([...arr]);
        }
        <span class="hljs-comment">// 分解阶段：将数组分成两半</span>
        <span class="hljs-keyword">const</span> middle=<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(arr.<span class="hljs-property">length</span> / <span class="hljs-number">2</span>);
        <span class="hljs-keyword">const</span> left =arr.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>,middle);
        <span class="hljs-keyword">const</span> right =arr.<span class="hljs-title function_">slice</span>(middle);
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">merge</span>(<span class="hljs-title function_">mergeSort</span>(left), <span class="hljs-title function_">mergeSort</span>(right));
    }
</code></pre>
<h5 data-id="heading-52">优化5-避免不必要的数组复制-使用索引而不是slice来减少内存分配</h5>
<pre><code class="hljs language-javascript" lang="javascript"> <span class="hljs-keyword">const</span> <span class="hljs-title function_">mergeSort</span> = (<span class="hljs-params">arr, start = <span class="hljs-number">0</span>, end = arr.length</span>) =&gt; {
        <span class="hljs-comment">// 数组长度小于阈值，使用插入排序</span>
        <span class="hljs-keyword">if</span> (end - start &lt;= <span class="hljs-variable constant_">INSERTION_SORT_THRESHOLD</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-title function_">insertionSort</span>(arr.<span class="hljs-title function_">slice</span>(start, end));
        }
        
        <span class="hljs-keyword">const</span> middle = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((start + end) / <span class="hljs-number">2</span>);
        <span class="hljs-keyword">const</span> left = <span class="hljs-title function_">mergeSort</span>(arr, start, middle);
        <span class="hljs-keyword">const</span> right = <span class="hljs-title function_">mergeSort</span>(arr, middle, end);
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">merge</span>(left, right);
    };
</code></pre>
<h5 data-id="heading-53">优化-使用迭代而非递归实现</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">INSERTION_SORT_THRESHOLD</span> = <span class="hljs-number">10</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">insertionSort</span> = (<span class="hljs-params">arr</span>) =&gt; {
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; arr.<span class="hljs-property">length</span>; i++) {
            <span class="hljs-keyword">let</span> key = arr[i];
            <span class="hljs-keyword">let</span> j = i - <span class="hljs-number">1</span>;
            <span class="hljs-keyword">while</span> (j &gt;= <span class="hljs-number">0</span> &amp;&amp; arr[j] &gt; key) {
                arr[j + <span class="hljs-number">1</span>] = arr[j];
                j--;
            }
            arr[j + <span class="hljs-number">1</span>] = key;
        }
        <span class="hljs-keyword">return</span> arr;
    };
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">merge</span> = (<span class="hljs-params">arr, temp, left, mid, right</span>) =&gt; {
        <span class="hljs-comment">// 检查是否已经有序</span>
        <span class="hljs-keyword">if</span> (arr[mid - <span class="hljs-number">1</span>] &lt;= arr[mid]) {
            <span class="hljs-keyword">return</span>;
        }
        
        <span class="hljs-comment">// 合并两个有序区间</span>
        <span class="hljs-keyword">let</span> i = left, j = mid, k = left;
        <span class="hljs-keyword">while</span> (i &lt; mid &amp;&amp; j &lt; right) {
            temp[k++] = arr[i] &lt;= arr[j] ? arr[i++] : arr[j++];
        }
        <span class="hljs-keyword">while</span> (i &lt; mid) {
            temp[k++] = arr[i++];
        }
        <span class="hljs-keyword">while</span> (j &lt; right) {
            temp[k++] = arr[j++];
        }
        
        <span class="hljs-comment">// 将合并结果复制回原数组</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> idx = left; idx &lt; right; idx++) {
            arr[idx] = temp[idx];
        }
    };
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">mergeSort</span> = (<span class="hljs-params">arr</span>) =&gt; {
        <span class="hljs-keyword">const</span> n = arr.<span class="hljs-property">length</span>;
        <span class="hljs-keyword">const</span> temp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(n);
        
        <span class="hljs-comment">// 使用插入排序处理小数组</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; n; i += <span class="hljs-variable constant_">INSERTION_SORT_THRESHOLD</span>) {
            <span class="hljs-keyword">const</span> end = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(i + <span class="hljs-variable constant_">INSERTION_SORT_THRESHOLD</span>, n);
            <span class="hljs-title function_">insertionSort</span>(arr, i, end);
        }
        
        <span class="hljs-comment">// 自底向上的归并排序</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> size = <span class="hljs-variable constant_">INSERTION_SORT_THRESHOLD</span>; size &lt; n; size *= <span class="hljs-number">2</span>) {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> left = <span class="hljs-number">0</span>; left &lt; n - size; left += <span class="hljs-number">2</span> * size) {
                <span class="hljs-keyword">const</span> mid = left + size;
                <span class="hljs-keyword">const</span> right = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(left + <span class="hljs-number">2</span> * size, n);
                <span class="hljs-title function_">merge</span>(arr, temp, left, mid, right);
            }
        }
        
        <span class="hljs-keyword">return</span> arr;
    };

</code></pre>
<h5 data-id="heading-54">最终版本</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">INSERTION_SORT_THRESHOLD</span> = <span class="hljs-number">10</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title function_">insertionSort</span> = (<span class="hljs-params">arr, start = <span class="hljs-number">0</span>, end = arr.length</span>) =&gt; {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = start + <span class="hljs-number">1</span>; i &lt; end; i++) {
        <span class="hljs-keyword">let</span> key = arr[i];
        <span class="hljs-keyword">let</span> j = i - <span class="hljs-number">1</span>;
        <span class="hljs-keyword">while</span> (j &gt;= start &amp;&amp; arr[j] &gt; key) {
            arr[j + <span class="hljs-number">1</span>] = arr[j];
            j--;
        }
        arr[j + <span class="hljs-number">1</span>] = key;
    }
    <span class="hljs-keyword">return</span> arr;
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">merge</span> = (<span class="hljs-params">left, right</span>) =&gt; {
    <span class="hljs-comment">// 检查是否可以直接合并</span>
    <span class="hljs-keyword">if</span> (left[left.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>] &lt;= right[<span class="hljs-number">0</span>]) {
        <span class="hljs-keyword">return</span> left.<span class="hljs-title function_">concat</span>(right);
    }
    <span class="hljs-keyword">if</span> (right[right.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>] &lt;= left[<span class="hljs-number">0</span>]) {
        <span class="hljs-keyword">return</span> right.<span class="hljs-title function_">concat</span>(left);
    }
    
    <span class="hljs-comment">// 预先分配结果数组空间</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(left.<span class="hljs-property">length</span> + right.<span class="hljs-property">length</span>);
    <span class="hljs-keyword">let</span> leftIndex = <span class="hljs-number">0</span>, rightIndex = <span class="hljs-number">0</span>, resultIndex = <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">while</span> (leftIndex &lt; left.<span class="hljs-property">length</span> &amp;&amp; rightIndex &lt; right.<span class="hljs-property">length</span>) {
        result[resultIndex++] = left[leftIndex] &lt; right[rightIndex] 
            ? left[leftIndex++] 
            : right[rightIndex++];
    }
    
    <span class="hljs-comment">// 处理剩余元素</span>
    <span class="hljs-keyword">while</span> (leftIndex &lt; left.<span class="hljs-property">length</span>) {
        result[resultIndex++] = left[leftIndex++];
    }
    <span class="hljs-keyword">while</span> (rightIndex &lt; right.<span class="hljs-property">length</span>) {
        result[resultIndex++] = right[rightIndex++];
    }
    
    <span class="hljs-keyword">return</span> result;
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">mergeSort</span> = (<span class="hljs-params">arr</span>) =&gt; {
    <span class="hljs-comment">// 数组长度小于阈值，使用插入排序</span>
    <span class="hljs-keyword">if</span> (arr.<span class="hljs-property">length</span> &lt;= <span class="hljs-variable constant_">INSERTION_SORT_THRESHOLD</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">insertionSort</span>([...arr]);
    }
    
    <span class="hljs-comment">// 分解阶段：将数组分成两半</span>
    <span class="hljs-keyword">const</span> middle = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(arr.<span class="hljs-property">length</span> / <span class="hljs-number">2</span>);
    <span class="hljs-keyword">const</span> left = <span class="hljs-title function_">mergeSort</span>(arr.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, middle));
    <span class="hljs-keyword">const</span> right = <span class="hljs-title function_">mergeSort</span>(arr.<span class="hljs-title function_">slice</span>(middle));
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">merge</span>(left, right);
};

</code></pre>
<h3 data-id="heading-55">5.选择排序(Selection Sort)</h3>
<h4 data-id="heading-56">认识</h4>
<h5 data-id="heading-57">选择排序基本思想是</h5>
<ul>
<li>首先在未排序的数列中找到最小(or最大)元素，然后将其存放到数列的起始位置。</li>
<li>接着，再从剩余未排序的元素中继续寻找最小(or最大)元素，然后放到已排序序列的末尾。</li>
<li>以此类推，直到所有元素均排序完毕。</li>
</ul>
<p>分类：属于选择排序类，是原地排序算法</p>
<p>稳定性：不稳定排序算法（相等元素的相对位置可能改变）</p>
<h5 data-id="heading-58">时间复杂度：</h5>
<ul>
<li>最坏情况：O(n²)</li>
<li>最好情况：O(n²)</li>
<li>平均情况：O(n²)</li>
</ul>
<h5 data-id="heading-59">空间复杂度：</h5>
<p>O(1)，只需要常数级别的额外空间</p>
<p>特点：</p>
<p>交换次数少，每次只交换一次</p>
<p>比较次数多，无论数组初始状态如何</p>
<p>不适合大规模数据排序</p>
<h5 data-id="heading-60">选择排序的原理</h5>
<p>选择排序的工作过程可以分为以下步骤：</p>
<ol>
<li>将数组分为已排序区和未排序区，初始时已排序区为空</li>
<li>在未排序区中找到最小（或最大）的元素</li>
<li>将这个元素与未排序区的第一个元素交换位置</li>
<li>将已排序区的范围扩大一个元素</li>
<li>重复步骤2-4，直到整个数组排序完成</li>
</ol>
<h5 data-id="heading-61">适用场景</h5>
<p>选择排序适用于以下场景：</p>
<ol>
<li>小规模数据排序</li>
<li>内存受限的环境（空间复杂度低）</li>
<li>对交换操作有较高成本的情况（交换次数少）</li>
<li>对算法简单性要求高的情况</li>
</ol>
<h5 data-id="heading-62">选择排序的优缺点</h5>
<p>优点：</p>
<ol>
<li>实现简单，容易理解</li>
<li>空间复杂度低，只需要O(1)的额外空间</li>
<li>交换次数少，每次排序只交换一次</li>
<li>不受数据初始顺序影响，时间复杂度始终是O(n²)</li>
</ol>
<p>缺点：</p>
<ol>
<li>时间复杂度高，不适合大规模数据</li>
<li>不稳定排序，相等元素的相对位置可能改变</li>
<li>即使数组已经有序，仍然需要进行O(n²)的比较</li>
</ol>
<h4 data-id="heading-63">实现</h4>
<pre><code class="hljs language-plain" lang="plain">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;

&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;title&gt;选择排序&lt;/title&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;script&gt;
    // 解法1 选择排序
    const optimizedSelectionSort = (arr) =&gt; {
        const n = arr.length;

         // 外层循环控制排序轮数
        for(let i=0;i&lt;n-1;i++){
            // 假设当前未排序区的第一个元素是最小的
            let minIndex = i;

            // 内层循环在未排序区找最小元素的索引
            for(let j=i+1;j&lt;n;j++){
                if(arr[j]&lt;arr[minIndex]){
                    minIndex=j;
                }
            }
            // 如果找到的最小元素不是当前位置，则交换
            if(minIndex!==i){
                [arr[i], arr[minIndex]] = [arr[minIndex], arr[i]];
            }
        }
        return arr;
    };
    // 示例使用
    const arr = [38, 27, 43, 3, 9, 82, 10];
    console.log("原始数组:", arr);
    console.log("排序后数组:", optimizedSelectionSort(arr));
    &lt;/script&gt;
&lt;/body&gt;

&lt;/html&gt;
</code></pre>
<h5 data-id="heading-64">优化-双向选择排序,减少比较次数</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1 优化 -双向选择排序,减少比较次数</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">optimizedSelectionSort</span> = (<span class="hljs-params">arr</span>) =&gt; {
        <span class="hljs-keyword">const</span> n = arr.<span class="hljs-property">length</span>;
        <span class="hljs-keyword">let</span> left = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">let</span> right = n - <span class="hljs-number">1</span>;
        <span class="hljs-keyword">while</span>(left &lt; right){
            <span class="hljs-keyword">let</span> minIndex = left;
            <span class="hljs-keyword">let</span> maxIndex = left;  
             <span class="hljs-comment">// 优化内层循环，减少比较次数</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = left + <span class="hljs-number">1</span>; i &lt;= right; i++) {
                <span class="hljs-comment">// 一次比较同时更新最小和最大值</span>
                <span class="hljs-keyword">if</span> (arr[i] &lt; arr[minIndex]) {
                    minIndex = i;
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (arr[i] &gt; arr[maxIndex]) {
                    maxIndex = i;
                }
            }
            <span class="hljs-comment">// 交换最小值到左端</span>
            <span class="hljs-keyword">if</span> (minIndex !== left) {
                [arr[left], arr[minIndex]] = [arr[minIndex], arr[left]];
                <span class="hljs-comment">// 如果最大值原本在left位置，已经被交换到minIndex位置</span>
                <span class="hljs-keyword">if</span> (maxIndex === left) {
                    maxIndex = minIndex;
                }
            }
            <span class="hljs-comment">// 交换最大值到右端</span>
            <span class="hljs-keyword">if</span> (maxIndex !== right) {
                [arr[right], arr[maxIndex]] = [arr[maxIndex], arr[right]];
            }
            left++;
            right--;
            <span class="hljs-keyword">return</span> arr;
        }
    };

</code></pre>
<h5 data-id="heading-65">添加提前终止条件</h5>
<p>在排序的过程之中，有时候我们会遇到后面已经排序的情况，就可以避免重复比对，这个时候可以提前添加终止条件</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 2 添加提前终止条件</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">optimizedSelectionSort</span>(<span class="hljs-params">arr</span>) {
        <span class="hljs-keyword">const</span> n = arr.<span class="hljs-property">length</span>;

        <span class="hljs-keyword">let</span> left = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">let</span> right = n - <span class="hljs-number">1</span>;

        <span class="hljs-keyword">while</span> (left &lt; right) {
            <span class="hljs-keyword">let</span> minIndex = left;
            <span class="hljs-keyword">let</span> maxIndex = left;
            <span class="hljs-keyword">let</span> isSorted = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 添加标记，假设已排序</span>

            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = left + <span class="hljs-number">1</span>; i &lt;= right; i++) {
                <span class="hljs-comment">// 如果发现逆序对，标记为未排序</span>
                <span class="hljs-keyword">if</span> (arr[i] &lt; arr[i - <span class="hljs-number">1</span>]) {
                    isSorted = <span class="hljs-literal">false</span>;
                }

                <span class="hljs-keyword">if</span> (arr[i] &lt; arr[minIndex]) {
                    minIndex = i;
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (arr[i] &gt; arr[maxIndex]) {
                    maxIndex = i;
                }
            }

            <span class="hljs-comment">// 如果已经有序，提前终止</span>
            <span class="hljs-keyword">if</span> (isSorted) {
                <span class="hljs-keyword">break</span>;
            }

            <span class="hljs-comment">// 交换最小值到左端</span>
            <span class="hljs-keyword">if</span> (minIndex !== left) {
                [arr[left], arr[minIndex]] = [arr[minIndex], arr[left]];

                <span class="hljs-keyword">if</span> (maxIndex === left) {
                    maxIndex = minIndex;
                }
            }

            <span class="hljs-comment">// 交换最大值到右端</span>
            <span class="hljs-keyword">if</span> (maxIndex !== right) {
                [arr[right], arr[maxIndex]] = [arr[maxIndex], arr[right]];
            }

            left++;
            right--;
        }

        <span class="hljs-keyword">return</span> arr;
    }
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Redis主从同步以及Redis-Shake数据同步实战]]></title>    <link>https://juejin.cn/post/7571399272496742463</link>    <guid>https://juejin.cn/post/7571399272496742463</guid>    <pubDate>2025-11-12T07:54:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571399272496742463" data-draft-id="7571399272496709695" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Redis主从同步以及Redis-Shake数据同步实战"/> <meta itemprop="keywords" content="Redis,云原生"/> <meta itemprop="datePublished" content="2025-11-12T07:54:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小小程序员贝塔"/> <meta itemprop="url" content="https://juejin.cn/user/4125023359219022"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Redis主从同步以及Redis-Shake数据同步实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4125023359219022/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小小程序员贝塔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T07:54:53.000Z" title="Wed Nov 12 2025 07:54:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><ol>
<li>
<h2 data-id="heading-0">背景</h2>
</li>
</ol>
<p>项目在进行上云，原先redis是自建的，现需要对自建的redis中的数据迁移到云上的redis中，遂调研当前有哪些工具支持redis的全量部署数据的迁移和增量数据迁移。经过调研当前使用比较多的有 Redis-Shake 以及云厂商提供的商用的同步工具，我们公司当前采购的是阿里云的redis,所以阿里云也提供了DTS的工具，由于阿里云的DTS在增量同步数据这块是按时间收费的，而且 Redis-Shake 当前是能正常满足我们的迁移需求的，所以下面主要介绍Redis-Shake 这个工具的使用以及 Redis 的主从复制的原理等</p>
<ol start="2">
<li>
<h2 data-id="heading-1">Redis主从复制以及Redis-Shake架构</h2>
</li>
</ol>
<p>和 Mysql 领域的 Canal 的原理类似，Redis-Shake 也是通过伪装成 Redis Master节点的 Slave 节点来获取主节点数据，之后进行主动推送给 需要同步的目标机器Redis, 所以先来了解下 Redis 主从同步的过程，然后再来了解下Redis-Shake 的工作过程。</p>
<ol>
<li>
<h5 data-id="heading-2">Redis 主从（Master-Replica）数据同步过程</h5>
</li>
</ol>
<p>Redis 的主从同步分为两种主要模式：全量同步(Full Synchronization)和部分同步(Partial Synchronization)。</p>
<h6 data-id="heading-3">阶段一：建立连接与协商</h6>
<p>  当一个副本节点（Replica）要从一个主节点（Master）同步数据时，整个过程开始。</p>
<ol>
<li>设置主节点：副本节点通过执行 REPLICAOF &lt;master_ip&gt; &lt;master_port&gt; 命令（老版本是 SLAVEOF）来指定其主节点。</li>
<li>建立网络连接：副本与主节点之间建立一个 TCP socket 连接。</li>
<li>发送 PING：副本向主节点发送 PING 命令，如果收到 PONG 响应，说明网络通信正常。</li>
<li>身份验证：如果主节点设置了 requirepass，副本需要发送 AUTH  进行验证。</li>
<li>端口和能力协商：副本通过 REPLCONF listening-port  告知主节点自己的监听端口，并通过 REPLCONF capa eof capa psync2 等告知主节点自己支持的能力（例如，支持无盘复制、支持 PSYNC2 协议等）。</li>
<li>发起同步请求：副本向主节点发送 PSYNC   命令，请求开始同步数据。这是最关键的一步。</li>
</ol>
<h6 data-id="heading-4">阶段二：同步数据（全量或部分）</h6>
<p>  主节点收到 PSYNC 命令后，会根据副本提供的 runid 和 offset 决定采用哪种同步模式。</p>
<p>场景 A：全量同步 (Full Synchronization)</p>
<p>在以下情况下会触发全量同步：</p>
<ul>
<li>副本是第一次连接主节点。</li>
<li>副本的 runid 与主节点的 runid 不匹配（说明主节点重启过或发生了故障转移）。</li>
<li>副本请求的 offset 在主节点的复制积压缓冲区（Replication Backlog）中已经不存在（即副本断线时间太长）。</li>
</ul>
<p>全量同步的详细步骤：</p>
<ol>
<li>主节点响应：主节点回复 +FULLRESYNC  ，告知副本需要进行全量同步，并提供自己当前的 runid 和 offset。</li>
<li>生成 RDB：主节点执行 BGSAVE 命令，在后台异步生成一个 RDB 快照文件。</li>
<li>缓冲写命令：在 BGSAVE 期间，主节点会将所有新的写命令（如 SET, INCR 等）缓存到一个内存缓冲区中。</li>
<li>发送 RDB：RDB 文件生成后，主节点将其内容发送给副本。</li>
<li>副本接收 RDB：副本接收到 RDB 文件后，会清空自己当前的所有数据，然后加载 RDB文件，将自己的数据库状态恢复到主节点执行 BGSAVE 时的状态。</li>
<li>发送缓冲命令：主节点将之前在内存缓冲区中缓存的写命令，逐一发送给副本。</li>
<li>副本执行命令：副本执行从主节点发来的所有写命令，使其数据库状态与主节点完全一致。至此，全量同步完成，主从状态达到一致。</li>
</ol>
<p>场景 B：部分同步 (Partial Synchronization)</p>
<p>如果副本不是第一次连接，并且它请求的 runid 与主节点匹配，且 offset仍在主节点的复制积压缓冲区内，则会触发部分同步。</p>
<ol>
<li>主节点响应：主节点回复 +CONTINUE，表示可以进行部分同步。</li>
<li>发送缺失命令：主节点从复制积压缓冲区中，将从副本 offset 之后的所有命令发送给副本。</li>
<li>副本执行命令：副本接收并执行这些命令。部分同步非常快，因为它只传输断线期间的少量增量数据，避免了生成和传输庞大 RDB 文件的开销。</li>
</ol>
<h6 data-id="heading-5">阶段三：命令传播 (Command Propagation)</h6>
<p>  一旦主从状态同步完成，它们就进入了命令传播阶段</p>
<ul>
<li>主节点每执行一个写命令，都会异步地将该命令发送给所有连接的副本。</li>
<li>副本接收并执行这些命令，从而实时保持与主节点的数据同步。</li>
<li>为了维持连接，主从之间会周期性地发送心跳命令（主节点发 PING，副本回 REPLCONF ACK ）</li>
</ul>
<ol start="2">
<li>
<h5 data-id="heading-6">涉及的核心命令详解</h5>
</li>
</ol>
<ul>
<li>
<p>REPLICAOF &lt;master_ip&gt; &lt;master_port&gt; (或 SLAVEOF)</p>
<ul>
<li>作用：由客户端或副本自己执行，用于设置要复制的主节点。执行 REPLICAOF NO ONE 可以使副本节点变回主节点。这是触发整个复制流程的“用户命令”。</li>
</ul>
</li>
<li>
<p>PSYNC  </p>
<ul>
<li>
<p>作用：由副本在内部自动发送给主节点，是复制协议的核心命令。</p>
</li>
<li>
<p>参数：</p>
<ul>
<li>runid: 副本所记录的主节点的运行 ID。如果是第一次连接，runid 为 ?。</li>
<li>offset: 副本已接收到的数据偏移量。如果是第一次连接，offset 为 -1。</li>
</ul>
</li>
<li>
<p>主节点响应：</p>
<ul>
<li>+FULLRESYNC  : 强制进行全量同步。</li>
<li>+CONTINUE: 同意进行部分同步。</li>
<li>-ERR ...: 拒绝同步（例如，runid 不匹配且无法进行部分同步）</li>
</ul>
</li>
</ul>
</li>
<li>
<p>REPLCONF</p>
<ul>
<li>
<p>作用：一个用于配置和确认的内部命令。</p>
</li>
<li>
<p>常见子命令：</p>
<ul>
<li>REPLCONF listening-port : 副本告知主节点自己的监听端口。</li>
<li>REPLCONF ip-address : 副本告知主节点自己的 IP 地址。</li>
<li>REPLCONF capa : 副本告知主节点自己支持的能力（如 eof, psync2）。</li>
<li>REPLCONF ACK :非常重要，副本周期性地向主节点报告自己已处理的数据偏移量。这既是心跳，也让主节点知道复制的健康状况，并据此判断复制积压缓冲区中的数据是否可以被覆盖。</li>
</ul>
</li>
</ul>
</li>
</ul>
<ol start="3">
<li>
<h5 data-id="heading-7">Redis-Shake 伪装成副本的原理和过程</h5>
</li>
</ol>
<p>Redis-shake 的核心原理就是完全遵守并实现了上述的 Redis 复制协议，从主节点的视角来看，Redis-shake</p>
<p>就是一个行为标准的 Redis 副本。</p>
<ol>
<li>
<p>配置与启动：您在 redis-shake.toml 中配置源 Redis（即 Master）的地址、端口和密码。</p>
</li>
<li>
<p>模拟连接握手：</p>
<ol>
<li>Redis-shake 启动后，会像一个真正的副本一样，与源 Redis 建立 TCP 连接。</li>
<li>它会发送 PING、AUTH、REPLCONF listening-port 等一系列命令，完成连接的初始化和身份验证。这个过程与真实副本完全一致。</li>
</ol>
</li>
<li>
<p>发起同步请求：</p>
<ol>
<li>握手成功后，Redis-shake 向源 Redis 发送 PSYNC ? -1，请求进行数据同步。</li>
</ol>
</li>
<li>
<p>处理数据流（核心区别）：</p>
<ol>
<li>
<p>源 Redis 收到请求后，开始进行全量同步，并向 Redis-shake 发送 RDB 文件流。</p>
</li>
<li>
<p>关键区别在于：</p>
<ul>
<li>一个真实的 Redis 副本会接收 RDB 数据，并将其加载到自己的内存中。</li>
<li>Redis-shake 则在接收 RDB数据流时，实时地解析（Parse）这个数据流。它并不把数据加载到自己的内存里，而是根据解析出的键值对（Key-Value），将其转换成目标端需要的格式。</li>
<li>例如，如果目标端是另一个 Redis，它就会为每个键值对生成对应的 RESTORE 命令或 SET、HSET等命令，然后发送给目标 Redis。如果目标端是文件，它就会将键值对格式化后写入文件。</li>
</ul>
</li>
</ol>
</li>
<li>
<p>处理增量命令：</p>
<ol>
<li>当 RDB 同步完成后，源 Redis 会进入命令传播阶段，开始向 Redis-shake 发送增量写命令。</li>
<li>Redis-shake 接收到这些增量命令后，同样不会在自己身上执行，而是将这些命令转换并应用到目标端。</li>
</ol>
</li>
<li>
<p>维持心跳：</p>
<ol>
<li>在整个同步过程中，Redis-shake 会像一个好学生一样，周期性地向源 Redis 发送 REPLCONF ACK ，报告自己的同步进度，防止连接因超时而中断。</li>
</ol>
</li>
</ol>

<ol start="3">
<li>
<h2 data-id="heading-8">使用方式</h2>
</li>
</ol>
<p>Redis-Shake 非常容易上手，而且提供了相当强大的功能，包括自动的全量数据同步以及增量数据同步，相关文档见下面的参考</p>
<ol>
<li>
<h5 data-id="heading-9">下载Redis-Shake工具到Linux服务器</h5>
</li>
</ol>
<p>保证 Redis-Shake 所在机器能访问 自建Redis机器 以及 阿里云redis代理地址</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment">## 下载地址</span>
https://github.com/tair-opensource/RedisShake/releases
</code></pre>
<p>2.  ##### 配置redis-shake</p>
<p>shake.toml 配置文件修改，主要修改sync_reader 以及 redis_writer的配置</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[sync_reader]</span>
<span class="hljs-attr">cluster</span> = <span class="hljs-literal">false</span>            <span class="hljs-comment"># Set to true if the source is a Redis cluster</span>
<span class="hljs-attr">address</span> = <span class="hljs-string">"127.0.0.1:6379"</span> <span class="hljs-comment"># For clusters, specify the address of any cluster node; use the master or slave address in master-slave mode</span>
<span class="hljs-attr">username</span> = <span class="hljs-string">""</span>              <span class="hljs-comment"># Keep empty if ACL is not in use</span>
<span class="hljs-attr">password</span> = <span class="hljs-string">"local@test"</span>              <span class="hljs-comment"># Keep empty if no authentication is required</span>
<span class="hljs-attr">tls</span> = <span class="hljs-literal">false</span>                <span class="hljs-comment"># Set to true to enable TLS if needed</span>
<span class="hljs-attr">sync_rdb</span> = <span class="hljs-literal">true</span>            <span class="hljs-comment"># Set to false if RDB synchronization is not required</span>
<span class="hljs-attr">sync_aof</span> = <span class="hljs-literal">true</span>            <span class="hljs-comment"># Set to false if AOF synchronization is not required</span>
<span class="hljs-attr">prefer_replica</span> = <span class="hljs-literal">false</span>     <span class="hljs-comment"># Set to true to sync from a replica node</span>
<span class="hljs-attr">try_diskless</span> = <span class="hljs-literal">false</span>       <span class="hljs-comment"># Set to true for diskless sync if the source has repl-diskless-sync=yes</span>

<span class="hljs-comment">#[scan_reader]</span>
<span class="hljs-comment">#cluster = false            # set to true if source is a redis cluster</span>
<span class="hljs-comment">#address = "127.0.0.1:6379" # when cluster is true, set address to one of the cluster node</span>
<span class="hljs-comment">#username = ""              # keep empty if not using ACL</span>
<span class="hljs-comment">#password = ""              # keep empty if no authentication is required</span>
<span class="hljs-comment">#tls = false</span>
<span class="hljs-comment">#dbs = []                   # set you want to scan dbs such as [1,5,7], if you don't want to scan all</span>
<span class="hljs-comment">#scan = true                # set to false if you don't want to scan keys</span>
<span class="hljs-comment">#ksn = false                # set to true to enabled Redis keyspace notifications (KSN) subscription</span>
<span class="hljs-comment">#count = 1                  # number of keys to scan per iteration</span>

<span class="hljs-comment"># [rdb_reader]</span>
<span class="hljs-comment"># filepath = "/tmp/dump.rdb"</span>

<span class="hljs-comment"># [aof_reader]</span>
<span class="hljs-comment"># filepath = "/tmp/.aof"</span>
<span class="hljs-comment"># timestamp = 0            # subsecond</span>

<span class="hljs-section">[redis_writer]</span>
<span class="hljs-attr">cluster</span> = <span class="hljs-literal">false</span>            <span class="hljs-comment"># set to true if target is a redis cluster</span>
<span class="hljs-attr">address</span> = <span class="hljs-string">"云上地址:6379"</span> <span class="hljs-comment"># when cluster is true, set address to one of the cluster node</span>
<span class="hljs-attr">username</span> = <span class="hljs-string">""</span>              <span class="hljs-comment"># keep empty if not using ACL</span>
<span class="hljs-attr">password</span> = <span class="hljs-string">"test"</span>              <span class="hljs-comment"># keep empty if no authentication is required</span>
<span class="hljs-attr">tls</span> = <span class="hljs-literal">false</span>
<span class="hljs-attr">off_reply</span> = <span class="hljs-literal">false</span>          <span class="hljs-comment"># turn off the server reply</span>

<span class="hljs-comment"># [file_writer]</span>
<span class="hljs-comment"># filepath = "/tmp/cmd.txt"</span>
<span class="hljs-comment"># type = "cmd" #cmd,aof,json (default cmd)</span>

<span class="hljs-section">[filter]</span>
<span class="hljs-comment"># Allow keys with specific prefixes or suffixes</span>
<span class="hljs-comment"># Examples:</span>
<span class="hljs-comment">#   allow_keys = ["user:1001", "product:2001"]</span>
<span class="hljs-comment">#   allow_key_prefix = ["user:", "product:"]</span>
<span class="hljs-comment">#   allow_key_suffix = [":active", ":valid"]</span>
<span class="hljs-comment">#   allow A collection of keys containing 11-digit mobile phone numbers</span>
<span class="hljs-comment">#   allow_key_regex = [":\d{11}:"]</span>
<span class="hljs-comment"># Leave empty to allow all keys</span>
<span class="hljs-attr">allow_keys</span> = []
<span class="hljs-attr">allow_key_prefix</span> = []
<span class="hljs-attr">allow_key_suffix</span> = []
<span class="hljs-attr">allow_key_regex</span> = []

<span class="hljs-comment"># Block keys with specific prefixes or suffixes</span>
<span class="hljs-comment"># Examples:</span>
<span class="hljs-comment">#   block_keys = ["temp:1001", "cache:2001"]</span>
<span class="hljs-comment">#   block_key_prefix = ["temp:", "cache:"]</span>
<span class="hljs-comment">#   block_key_suffix = [":tmp", ":old"]</span>
<span class="hljs-comment">#   block test 11-digit mobile phone numbers keys</span>
<span class="hljs-comment">#   block_key_regex = [":test:\d{11}:"]</span>
<span class="hljs-comment"># Leave empty to block nothing</span>
<span class="hljs-attr">block_keys</span> = []
<span class="hljs-attr">block_key_prefix</span> = []
<span class="hljs-attr">block_key_suffix</span> = []
<span class="hljs-attr">block_key_regex</span> = []

<span class="hljs-comment"># Specify allowed and blocked database numbers (e.g., allow_db = [0, 1, 2], block_db = [3, 4, 5])</span>
<span class="hljs-comment"># Leave empty to allow all databases</span>
<span class="hljs-attr">allow_db</span> = []
<span class="hljs-attr">block_db</span> = []

<span class="hljs-comment"># Allow or block specific commands</span>
<span class="hljs-comment"># Examples:</span>
<span class="hljs-comment">#   allow_command = ["GET", "SET"]  # Only allow GET and SET commands</span>
<span class="hljs-comment">#   block_command = ["DEL", "FLUSHDB"]  # Block DEL and FLUSHDB commands</span>
<span class="hljs-comment"># Leave empty to allow all commands</span>
<span class="hljs-attr">allow_command</span> = []
<span class="hljs-attr">block_command</span> = []

<span class="hljs-comment"># Allow or block specific command groups</span>
<span class="hljs-comment"># Available groups:</span>
<span class="hljs-comment">#   SERVER, STRING, CLUSTER, CONNECTION, BITMAP, LIST, SORTED_SET,</span>
<span class="hljs-comment">#   GENERIC, TRANSACTIONS, SCRIPTING, TAIRHASH, TAIRSTRING, TAIRZSET,</span>
<span class="hljs-comment">#   GEO, HASH, HYPERLOGLOG, PUBSUB, SET, SENTINEL, STREAM</span>
<span class="hljs-comment"># Examples:</span>
<span class="hljs-comment">#   allow_command_group = ["STRING", "HASH"]  # Only allow STRING and HASH commands</span>
<span class="hljs-comment">#   block_command_group = ["SCRIPTING", "PUBSUB"]  # Block SCRIPTING and PUBSUB commands</span>
<span class="hljs-comment"># Leave empty to allow all command groups</span>
<span class="hljs-attr">allow_command_group</span> = []
<span class="hljs-attr">block_command_group</span> = []

<span class="hljs-comment"># Function for custom data processing</span>
<span class="hljs-comment"># For best practices and examples, visit:</span>
<span class="hljs-comment"># https://tair-opensource.github.io/RedisShake/zh/filter/function.html</span>
<span class="hljs-attr">function</span> = <span class="hljs-string">""</span>

<span class="hljs-section">[advanced]</span>
<span class="hljs-attr">dir</span> = <span class="hljs-string">"data"</span>
<span class="hljs-attr">ncpu</span> = <span class="hljs-number">0</span>        <span class="hljs-comment"># runtime.GOMAXPROCS, 0 means use runtime.NumCPU() cpu cores</span>
<span class="hljs-attr">pprof_port</span> = <span class="hljs-number">0</span>  <span class="hljs-comment"># pprof port, 0 means disable</span>
<span class="hljs-attr">status_port</span> = <span class="hljs-number">0</span> <span class="hljs-comment"># status port, 0 means disable</span>

<span class="hljs-comment"># log</span>
<span class="hljs-attr">log_file</span> = <span class="hljs-string">"shake.log"</span>
<span class="hljs-attr">log_level</span> = <span class="hljs-string">"info"</span>     <span class="hljs-comment"># debug, info or warn</span>
<span class="hljs-attr">log_interval</span> = <span class="hljs-number">5</span>       <span class="hljs-comment"># in seconds</span>
<span class="hljs-attr">log_rotation</span> = <span class="hljs-literal">true</span>    <span class="hljs-comment"># enable log rotation</span>
<span class="hljs-attr">log_max_size</span> = <span class="hljs-number">512</span>     <span class="hljs-comment"># MiB, logs max size to rotate, default 512 MiB</span>
<span class="hljs-attr">log_max_age</span> = <span class="hljs-number">7</span>        <span class="hljs-comment"># days, logs are kept, default 7 days</span>
<span class="hljs-attr">log_max_backups</span> = <span class="hljs-number">3</span>    <span class="hljs-comment"># number of log backups, default 3</span>
<span class="hljs-attr">log_compress</span> = <span class="hljs-literal">true</span>    <span class="hljs-comment"># enable log compression after rotate, default true</span>

<span class="hljs-comment"># redis-shake gets key and value from rdb file, and uses RESTORE command to</span>
<span class="hljs-comment"># create the key in target redis. Redis RESTORE will return a "Target key name</span>
<span class="hljs-comment"># is busy" error when key already exists. You can use this configuration item</span>
<span class="hljs-comment"># to change the default behavior of restore:</span>
<span class="hljs-comment"># panic:   redis-shake will stop when meet "Target key name is busy" error.</span>
<span class="hljs-comment"># rewrite: redis-shake will replace the key with new value.</span>
<span class="hljs-comment"># skip:  redis-shake will skip restore the key when meet "Target key name is busy" error.</span>
<span class="hljs-attr">rdb_restore_command_behavior</span> = <span class="hljs-string">"panic"</span> <span class="hljs-comment"># panic, rewrite or skip</span>

<span class="hljs-comment"># redis-shake uses pipeline to improve sending performance.</span>
<span class="hljs-comment"># Adjust this value based on the destination Redis performance:</span>
<span class="hljs-comment"># - Higher values may improve performance for capable destinations.</span>
<span class="hljs-comment"># - Lower values are recommended for destinations with poor performance.</span>
<span class="hljs-comment"># 1024 is a good default value for most cases.</span>
<span class="hljs-attr">pipeline_count_limit</span> = <span class="hljs-number">1024</span>

<span class="hljs-comment"># This setting corresponds to the 'client-query-buffer-limit' in Redis configuration.</span>
<span class="hljs-comment"># The default value is typically 1GB.</span>
<span class="hljs-comment"># It's recommended not to modify this value unless absolutely necessary.</span>
<span class="hljs-attr">target_redis_client_max_querybuf_len</span> = <span class="hljs-number">1073741824</span>  <span class="hljs-comment"># 1GB in bytes</span>

<span class="hljs-comment"># This setting corresponds to the 'proto-max-bulk-len' in Redis configuration.</span>
<span class="hljs-comment"># It defines the maximum size of a single string element in the Redis protocol.</span>
<span class="hljs-comment"># The value must be 1MB or greater. Default is 512MB.</span>
<span class="hljs-comment"># It's recommended not to modify this value unless absolutely necessary.</span>
<span class="hljs-attr">target_redis_proto_max_bulk_len</span> = <span class="hljs-number">512_000_000</span>

<span class="hljs-comment"># If the source is Elasticache, you can set this item. AWS ElastiCache has custom</span>
<span class="hljs-comment"># psync command, which can be obtained through a ticket.</span>
<span class="hljs-attr">aws_psync</span> = <span class="hljs-string">""</span> <span class="hljs-comment"># example: aws_psync = "10.0.0.1:6379@nmfu2sl5osync,10.0.0.1:6379@xhma21xfkssync"</span>

<span class="hljs-comment"># destination will delete itself entire database before fetching files</span>
<span class="hljs-comment"># from source during full synchronization.</span>
<span class="hljs-comment"># This option is similar redis replicas RDB diskless load option:</span>
<span class="hljs-comment">#   repl-diskless-load on-empty-db</span>
<span class="hljs-attr">empty_db_before_sync</span> = <span class="hljs-literal">false</span>

<span class="hljs-section">[module]</span>
<span class="hljs-comment"># The data format for BF.LOADCHUNK is not compatible in different versions. v2.6.3 &lt;=&gt; 20603</span>
<span class="hljs-attr">target_mbbloom_version</span> = <span class="hljs-number">20603</span>
</code></pre>
<p>3.  ##### 启动redis-shake</p>

<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">nohup</span> redis-shake ./shake.toml &amp;
</code></pre>
<p>4.  ## 全量数据同步验证</p>
<p>进程启动之后，会自动进行全量数据同步，如上面的原理分析一样，redis-shake会请求源redis进行数据同步，这次因为相当于是新增的redis副本，所以是一次全量的数据同步，源redis会后台进行bgsave生成rdb文件，之后传输给redis-shake， 同时源redis的增量数据会被源redis保存缓存，等待全量数据同步之后，自动会进行增量数据同步</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da852260b9bf423dae1348eea4b5adb9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5bCP56iL5bqP5ZGY6LSd5aGU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763538893&amp;x-signature=WOsTejJNNLG%2BhslLa2SXeBReAug%3D" alt="" loading="lazy"/></p>
<ol start="5">
<li>
<h2 data-id="heading-10">增量数据同步验证</h2>
</li>
</ol>
<p>使用 redis-benchmark 模拟增量数据过程，往测试的162的redis 发送1000w的redis的写，</p>
<pre><code class="hljs language-bash" lang="bash">taskset -c 0-7 /usr/local/redis/bin/redis-benchmark -r 10000000 -n 10000000 -t <span class="hljs-built_in">set</span> -h 127.0.0.1 -a <span class="hljs-string">'local@test'</span>  -c 8 -d 8 -P 2 
</code></pre>
<p>本地的redis 实际生成 6320024</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a07722cc1ad34c6f8a368d8ac238ef1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5bCP56iL5bqP5ZGY6LSd5aGU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763538893&amp;x-signature=Y9dujUvIkOw3zhsG7vNY%2Bg%2B8NPs%3D" alt="" loading="lazy"/></p>
<p>云上redis通过 redis-shake的增量同步也有了 6320024</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c7a2bdb6efe42feb67a68599d8b845d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5bCP56iL5bqP5ZGY6LSd5aGU:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763538893&amp;x-signature=6RiBzn05QYItg2i1AJyPWHYPqhY%3D" alt="" loading="lazy"/></p>
<ol start="6">
<li>
<h2 data-id="heading-11">总结</h2>
</li>
</ol>
<p>本文通过一个 Redis 的数据迁移的需求，深入了解了redis的主从同步的过程以及原理，之后调研Redis的数据同步工具，包括 Redis-Shake 和 云厂商提供的同步工具，最后经过动手搭建一个本地的redis ，然后通过redis-shake 工具成功进行数据的全量和增量同步。最后感谢下开源贡献者吧，然后作为开发者的一员，咱们也要多多参与开源</p>
<ol start="7">
<li>
<h2 data-id="heading-12">参考</h2>
</li>
</ol>
<p>1、<a href="https://link.juejin.cn?target=https%3A%2F%2Fedu.alibabacloud.com%2Flab%2F21" target="_blank" title="https://edu.alibabacloud.com/lab/21" ref="nofollow noopener noreferrer">Use Redis-shake To Migrate Self-built Redis To Alibaba Cloud</a></p>
<p>2、<a href="https://link.juejin.cn?target=https%3A%2F%2Ftair-opensource.github.io%2FRedisShake%2Fzh%2Fguide%2Fgetting-started.html" target="_blank" title="https://tair-opensource.github.io/RedisShake/zh/guide/getting-started.html" ref="nofollow noopener noreferrer">tair-opensource.github.io/RedisShake/…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在Next.js中实现页面级别KeepAlive]]></title>    <link>https://juejin.cn/post/7571655312798138394</link>    <guid>https://juejin.cn/post/7571655312798138394</guid>    <pubDate>2025-11-12T08:56:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571655312798138394" data-draft-id="7571637614203109403" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在Next.js中实现页面级别KeepAlive"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-12T08:56:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="超大只番薯"/> <meta itemprop="url" content="https://juejin.cn/user/4138987510833768"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在Next.js中实现页面级别KeepAlive
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4138987510833768/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    超大只番薯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T08:56:57.000Z" title="Wed Nov 12 2025 08:56:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">在Next.js中实现页面级别KeepAlive</h2>
<p>前提:</p>
<ol>
<li>
<p>基于App Router的路由模式</p>
</li>
<li>
<p>使用客户端组件(服务端组件没测试过)</p>
</li>
</ol>
<p>很简单, 只需要三个文件</p>





















<table><thead><tr><th>组件名称</th><th>作用</th></tr></thead><tbody><tr><td>KeepAliveProvider.tsx</td><td>用于包裹最外层layout, 处理缓存组件和非缓存组件的渲染</td></tr><tr><td>KeepAliveContext.tsx</td><td>无需解释</td></tr><tr><td>KeepAlive.tsx</td><td>用于包裹App Router的页面组件page.tsx</td></tr></tbody></table>
<h3 data-id="heading-1">KeepAliveProvider.tsx</h3>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-string">'use client'</span>

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">KeepAliveContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/KeepAlive/KeepAliveContext'</span>
<span class="hljs-keyword">import</span> { usePathname } <span class="hljs-keyword">from</span> <span class="hljs-string">'next/navigation'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">KeepAliveProviderProps</span> {
  <span class="hljs-attr">children</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>
}

<span class="hljs-comment">// 最大缓存数量</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAX_CACHE_SIZE</span> = <span class="hljs-number">5</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">KeepAliveProvider</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">KeepAliveProviderProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{ children }</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> pathname = <span class="hljs-title function_">usePathname</span>()
  <span class="hljs-keyword">const</span> [componentList, setComponentList] = useState&lt;<span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>&gt;&gt;(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>())

  <span class="hljs-comment">// 更新缓存组件列表的方法</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">updateComponentList</span> = (<span class="hljs-params">path: <span class="hljs-built_in">string</span>, component: React.ReactNode</span>) =&gt; {
    <span class="hljs-title function_">setComponentList</span>(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> newMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>(prev)
      newMap.<span class="hljs-title function_">set</span>(path, component)

      <span class="hljs-comment">// 如果超过最大缓存数量，再删除最旧的</span>
      <span class="hljs-keyword">if</span> (newMap.<span class="hljs-property">size</span> &gt; <span class="hljs-variable constant_">MAX_CACHE_SIZE</span>) {
        <span class="hljs-keyword">const</span> oldestKey = newMap.<span class="hljs-title function_">keys</span>().<span class="hljs-title function_">next</span>().<span class="hljs-property">value</span>

        <span class="hljs-comment">// 如果存在最旧的key，则删除</span>
        <span class="hljs-keyword">if</span> (oldestKey !== <span class="hljs-literal">undefined</span>) {
          newMap.<span class="hljs-title function_">delete</span>(oldestKey)
        }
      }

      <span class="hljs-keyword">return</span> newMap
    })
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">KeepAliveContext.Provider</span>
      <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">componentList</span>,
        <span class="hljs-attr">updateComponentList</span>,
        <span class="hljs-attr">activePath:</span> <span class="hljs-attr">pathname</span>,
      }}
    &gt;</span>
      {[...componentList.entries()].map(([key, node]) =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
          <span class="hljs-attr">key</span>=<span class="hljs-string">{key}</span>
          <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span>
            <span class="hljs-attr">display:</span> <span class="hljs-attr">key</span> === <span class="hljs-string">pathname</span> ? '<span class="hljs-attr">block</span>' <span class="hljs-attr">:</span> '<span class="hljs-attr">none</span>',
            <span class="hljs-attr">height:</span> '<span class="hljs-attr">100</span>%',
          }}
        &gt;</span>
          {node}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      ))}

      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"h-full"</span>&gt;</span>{!componentList.get(pathname) &amp;&amp; children}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">KeepAliveContext.Provider</span>&gt;</span></span>
  )
}

</code></pre>
<h3 data-id="heading-2">KeepAliveContext.tsx</h3>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// 创建context</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { createContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">IKeepAliveContext</span> {
  <span class="hljs-comment">// 缓存的组件列表</span>
  <span class="hljs-attr">componentList</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>&gt;
  <span class="hljs-comment">// 更新缓存组件列表的方法</span>
  <span class="hljs-attr">updateComponentList</span>: <span class="hljs-function">(<span class="hljs-params">path: <span class="hljs-built_in">string</span>, component: React.ReactNode</span>) =&gt;</span> <span class="hljs-built_in">void</span>
  <span class="hljs-comment">// 当前激活的路径</span>
  activePath?: <span class="hljs-built_in">string</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">KeepAliveContext</span> = createContext&lt;<span class="hljs-title class_">IKeepAliveContext</span>&gt;({
  <span class="hljs-attr">componentList</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span>&gt;(),
  <span class="hljs-attr">updateComponentList</span>: <span class="hljs-function">() =&gt;</span> {},
})

</code></pre>
<h3 data-id="heading-3">KeepAlive.tsx</h3>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-string">'use client'</span>

<span class="hljs-keyword">import</span> { usePathname } <span class="hljs-keyword">from</span> <span class="hljs-string">'next/navigation'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useContext, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">KeepAliveContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./KeepAliveContext'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">KeepAlive</span> = (<span class="hljs-params">{ children }: { children: React.ReactNode }</span>) =&gt; {
  <span class="hljs-keyword">const</span> { updateComponentList } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">KeepAliveContext</span>)
  <span class="hljs-keyword">const</span> pathname = <span class="hljs-title function_">usePathname</span>()

  <span class="hljs-comment">// 每当 children 变化时，更新缓存的组件列表</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">updateComponentList</span>(pathname, children)
  }, [children])

  <span class="hljs-comment">// 该组件本身不渲染任何内容</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
}
</code></pre>
<h3 data-id="heading-4">用法</h3>
<ol>
<li>先包裹最外层layout (项目根目录的layout.tsx, 并非组件的layout.tsx)</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// layout.tsx</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">KeepAliveProvider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/KeepAlive/KeepAliveProvider'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">RootLayout</span>(<span class="hljs-params">{ children }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">KeepAliveProvider</span>&gt;</span>{children}<span class="hljs-tag">&lt;/<span class="hljs-name">KeepAliveProvider</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span>
  )
}
</code></pre>
<ol start="2">
<li>在需要缓存的页面组件中使用KeepAlive包裹</li>
</ol>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// page.tsx</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">KeepAlive</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/KeepAlive/KeepAlive'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">KeepAlive</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>这是一个需要缓存的页面内容<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">KeepAlive</span>&gt;</span></span>
  )
}
</code></pre>
<ol start="3">
<li>测试结果, 切换页面时, 该页面状态会被保留, 如果没保留, 请检查是否正确包裹, KeepAlive是否包裹正确</li>
</ol>
<p>如果还是异常, 请忽略该文章, 就当没看过...</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Token无感刷新全流程（Vue + Axios + Node.js（Express））]]></title>    <link>https://juejin.cn/post/7571636682694787112</link>    <guid>https://juejin.cn/post/7571636682694787112</guid>    <pubDate>2025-11-12T09:00:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571636682694787112" data-draft-id="7571316028322578467" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Token无感刷新全流程（Vue + Axios + Node.js（Express））"/> <meta itemprop="keywords" content="JavaScript,Java,Vue.js"/> <meta itemprop="datePublished" content="2025-11-12T09:00:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="拉不动的猪"/> <meta itemprop="url" content="https://juejin.cn/user/1429793504759630"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Token无感刷新全流程（Vue + Axios + Node.js（Express））
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1429793504759630/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    拉不动的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T09:00:38.000Z" title="Wed Nov 12 2025 09:00:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#5f6368;background-image:linear-gradient(90deg,rgba(240,191,213,.1) 3%,transparent 0),linear-gradient(1turn,rgba(240,191,213,.1) 3%,transparent 0);background-size:20px 20px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;line-height:1.5;margin-top:35px;margin-bottom:10px;padding-left:50px;padding-bottom:5px;color:#5f6368}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{position:absolute;left:0;display:block;content:""}.markdown-body h1{font-size:32px;margin-bottom:5px}.markdown-body h1:before{top:0;content:"🦄";font-size:32px}.markdown-body h2{padding-bottom:24px;border-bottom:1px solid #ececec}.markdown-body h2:before{top:0;left:8px;content:"🐳";font-size:24px}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{top:-2px;left:8px;content:"🐄";font-size:20px}.markdown-body h4{font-size:16px}.markdown-body h4:before{top:-2px;left:8px;content:"🦥";font-size:18px}.markdown-body h5{font-size:14px}.markdown-body h5:before{top:-2px;left:9px;content:"🦩";font-size:16px}.markdown-body h6{font-size:12px;margin-top:5px}.markdown-body h6:before{top:-1px;left:10px;content:"🐧";font-size:14px}.markdown-body p{line-height:1.9;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid rgba(253,121,168,.5);margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#a6accd;background:#292d3e;border-radius:8px}.markdown-body a{text-decoration:none;color:#fd79a8;border-bottom:1px solid #fd79a8;padding:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(253,121,168,.1);color:#ee69a9}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body th{color:#fd79a8}.markdown-body th,.markdown-body tr:hover{background:rgba(253,121,168,.1)}.markdown-body td{min-width:120px}.markdown-body blockquote{position:relative;color:#666;padding:23px;margin:22px 0;border-left:4px solid #ee69a9;background-color:rgba(253,121,168,.1)}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;display:block;font-size:27px;color:#fd79a8;opacity:.8}.markdown-body blockquote:before{left:10px;top:0;content:"❝"}.markdown-body blockquote:after{right:10px;bottom:0;content:"❞"}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body strong{position:relative;color:#fd79a8}.markdown-body strong:before{content:"· "}.markdown-body strong:after{content:" ·"}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit;color:#fd79a8}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#ee69a9}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}</style><style data-highlight="" data-highlight-key="androidstudio">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#a9b7c6;background:#282b2e}.hljs-bullet,.hljs-literal,.hljs-number,.hljs-symbol{color:#6897bb}.hljs-deletion,.hljs-keyword,.hljs-selector-tag{color:#cc7832}.hljs-link,.hljs-template-variable,.hljs-variable{color:#629755}.hljs-comment,.hljs-quote{color:grey}.hljs-meta{color:#bbb529}.hljs-addition,.hljs-attribute,.hljs-string{color:#6a8759}.hljs-section,.hljs-title,.hljs-type{color:#ffc66d}.hljs-name,.hljs-selector-class,.hljs-selector-id{color:#e8bf6a}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">页面基本流程</h3>
<ol>
<li>登录成功后，后端返回 Access Token 和 Refresh Token，前端存储两者及各自有效期。</li>
<li>每次发起业务请求前，前端判断 Access Token 是否即将过期。</li>
<li>若即将过期，先调用 “刷新 Token 接口”，用有效的 Refresh Token 换取新的 Access Token。</li>
<li>用新的 Access Token 发起原业务请求，用户全程无感知。</li>
<li>若 Refresh Token 也过期，才会引导用户重新登录。</li>
</ol>
<h3 data-id="heading-1">一、技术栈与核心约定</h3>
<ul>
<li>
<p>前端：Vue 3（适配 Vue 2，只需微调语法）+ Axios（统一请求拦截）</p>
</li>
<li>
<p>后端：Node.js + Express + JWT（生成 Token）+ Redis（存储 Refresh Token，可选但推荐）</p>
</li>
<li>
<p>Token 规则：</p>
<ul>
<li>Access Token：短期有效（1 小时），用于业务请求身份验证</li>
<li>Refresh Token：长期有效（7 天），仅用于刷新 Access Token</li>
<li>状态码：401 = Access Token 过期 / 无效；403 = Refresh Token 过期 / 无效</li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-2">二、前端实现（核心代码）</h3>
<h4 data-id="heading-3">1. 初始化 Axios 实例（api/index.js）</h4>
<p>封装请求 / 响应拦截器，处理 Token 携带、刷新和重试逻辑</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ElMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'element-plus'</span>; <span class="hljs-comment">// 按需引入UI组件库提示（可选）</span>

<span class="hljs-comment">// 1. 创建Axios实例</span>
<span class="hljs-keyword">const</span> service = axios.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">baseURL</span>: <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_API_BASE_URL</span>, <span class="hljs-comment">// 环境变量配置后端地址</span>
  <span class="hljs-attr">timeout</span>: <span class="hljs-number">5000</span>, <span class="hljs-comment">// 请求超时时间</span>
});

<span class="hljs-comment">// 2. Token存取工具函数（安全存储建议用HttpOnly Cookie，此处用localStorage演示）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">TokenKey</span> = {
  <span class="hljs-attr">ACCESS</span>: <span class="hljs-string">'access_token'</span>,
  <span class="hljs-attr">REFRESH</span>: <span class="hljs-string">'refresh_token'</span>,
};

<span class="hljs-comment">// 获取Token</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getAccessToken</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-title class_">TokenKey</span>.<span class="hljs-property">ACCESS</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getRefreshToken</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-title class_">TokenKey</span>.<span class="hljs-property">REFRESH</span>);
<span class="hljs-comment">// 存储新Token</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">setTokens</span> = (<span class="hljs-params">accessToken, refreshToken</span>) =&gt; {
  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-title class_">TokenKey</span>.<span class="hljs-property">ACCESS</span>, accessToken);
  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-title class_">TokenKey</span>.<span class="hljs-property">REFRESH</span>, refreshToken);
};
<span class="hljs-comment">// 清除Token（退出登录用）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">removeTokens</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-title class_">TokenKey</span>.<span class="hljs-property">ACCESS</span>);
  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-title class_">TokenKey</span>.<span class="hljs-property">REFRESH</span>);
};

<span class="hljs-comment">// 3. 刷新状态管理（防止并发请求重复刷新Token）</span>
<span class="hljs-keyword">let</span> isRefreshing = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 是否正在刷新Token</span>
<span class="hljs-keyword">let</span> requestQueue = []; <span class="hljs-comment">// 等待刷新完成的请求队列</span>

<span class="hljs-comment">// 4. 请求拦截器：自动给所有请求添加Access Token</span>
service.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> token = <span class="hljs-title function_">getAccessToken</span>();
    <span class="hljs-keyword">if</span> (token) {
      <span class="hljs-comment">// 规范格式：Bearer + 空格 + Token（后端需对应解析）</span>
      config.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span>;
    }
    <span class="hljs-keyword">return</span> config;
  },
  <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error)
);

<span class="hljs-comment">// 5. 响应拦截器：处理Token过期逻辑</span>
service.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> response.<span class="hljs-property">data</span>, <span class="hljs-comment">// 直接返回响应体，简化业务层调用</span>
  <span class="hljs-keyword">async</span> (error) =&gt; {
    <span class="hljs-keyword">const</span> { response, config } = error;
    <span class="hljs-keyword">const</span> originalRequest = config; <span class="hljs-comment">// 原始失败请求</span>

    <span class="hljs-comment">// 仅处理401状态码（Access Token过期/无效），且排除刷新Token本身的请求</span>
    <span class="hljs-keyword">if</span> (response?.<span class="hljs-property">status</span> === <span class="hljs-number">401</span> &amp;&amp; originalRequest.<span class="hljs-property">url</span> !== <span class="hljs-string">'/auth/refresh'</span>) {
      <span class="hljs-comment">// 避免重复刷新：正在刷新时，将请求加入队列</span>
      <span class="hljs-keyword">if</span> (isRefreshing) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
          requestQueue.<span class="hljs-title function_">push</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-comment">// 刷新成功后，用新Token重试原始请求</span>
            originalRequest.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${getAccessToken()}</span>`</span>;
            <span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">service</span>(originalRequest));
          });
        });
      }

      originalRequest.<span class="hljs-property">_retry</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 标记该请求已进入重试流程</span>
      isRefreshing = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 开启刷新状态</span>

      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 调用后端刷新接口，用Refresh Token换取新Token</span>
        <span class="hljs-keyword">const</span> refreshToken = <span class="hljs-title function_">getRefreshToken</span>();
        <span class="hljs-keyword">if</span> (!refreshToken) {
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Refresh Token不存在'</span>);
        }

        <span class="hljs-keyword">const</span> refreshRes = <span class="hljs-keyword">await</span> service.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/auth/refresh'</span>, {
          refreshToken, <span class="hljs-comment">// 传给后端的Refresh Token</span>
        });

        <span class="hljs-comment">// 存储新Token</span>
        <span class="hljs-keyword">const</span> { accessToken, <span class="hljs-attr">refreshToken</span>: newRefreshToken } = refreshRes;
        <span class="hljs-title function_">setTokens</span>(accessToken, newRefreshToken);

        <span class="hljs-comment">// 重试队列中所有等待的请求</span>
        requestQueue.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">callback</span>) =&gt;</span> <span class="hljs-title function_">callback</span>());
        requestQueue = []; <span class="hljs-comment">// 清空队列</span>

        <span class="hljs-comment">// 重试当前失败的请求</span>
        originalRequest.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${accessToken}</span>`</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">service</span>(originalRequest);
      } <span class="hljs-keyword">catch</span> (refreshError) {
        <span class="hljs-comment">// 刷新失败（Refresh Token过期/无效），强制跳转登录页</span>
        <span class="hljs-title function_">removeTokens</span>(); <span class="hljs-comment">// 清除本地无效Token</span>
        <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'登录已过期，请重新登录'</span>);
        <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">'/login'</span>; <span class="hljs-comment">// 跳转到登录页</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(refreshError);
      } <span class="hljs-keyword">finally</span> {
        isRefreshing = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 关闭刷新状态</span>
      }
    }

    <span class="hljs-comment">// 非401错误（如网络错误、业务错误），直接抛出</span>
    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(error.<span class="hljs-property">message</span> || <span class="hljs-string">'请求失败'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);
  }
);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> service;
</code></pre>
<h4 data-id="heading-4">2. 登录与业务请求示例（api/user.js）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> service <span class="hljs-keyword">from</span> <span class="hljs-string">'./index'</span>;

<span class="hljs-comment">// 登录：获取初始双Token</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">login</span> = (<span class="hljs-params">username, password</span>) =&gt; {
  <span class="hljs-keyword">return</span> service.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/auth/login'</span>, { username, password });
};

<span class="hljs-comment">// 业务请求示例（无需手动处理Token）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getUserInfo</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> service.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/user/info'</span>);
};

<span class="hljs-comment">// 退出登录：清除Token</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">logout</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">'access_token'</span>);
  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">'refresh_token'</span>);
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">'/login'</span>;
};
</code></pre>
<h4 data-id="heading-5">3. 登录页面使用示例（Login.vue）</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"username"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"用户名"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"密码"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleLogin"</span>&gt;</span>登录<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> { login } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api/user'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ElMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'element-plus'</span>;

<span class="hljs-keyword">const</span> username = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>);
<span class="hljs-keyword">const</span> password = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLogin</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 调用登录接口，后端返回accessToken和refreshToken</span>
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">login</span>(username.<span class="hljs-property">value</span>, password.<span class="hljs-property">value</span>);
    <span class="hljs-comment">// 存储Token（实际已在api拦截器中处理，此处简化）</span>
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'access_token'</span>, res.<span class="hljs-property">accessToken</span>);
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'refresh_token'</span>, res.<span class="hljs-property">refreshToken</span>);
    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">'登录成功'</span>);
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">'/home'</span>; <span class="hljs-comment">// 跳转到首页</span>
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'登录失败，请检查账号密码'</span>);
  }
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-6">三、后端实现（Node.js + Express）</h3>
<h4 data-id="heading-7">1. 依赖安装</h4>
<pre><code class="hljs language-arduino" lang="arduino">npm install express jsonwebtoken redis cors dotenv <span class="hljs-comment">// 核心依赖</span>
</code></pre>
<h4 data-id="heading-8">2. 核心配置（config.js）</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-built_in">require</span>(<span class="hljs-string">'dotenv'</span>).<span class="hljs-built_in">config</span>();

<span class="hljs-keyword">module</span>.exports = {
  <span class="hljs-comment">// JWT密钥（生产环境需用环境变量，避免硬编码）</span>
  JWT_SECRET: process.env.JWT_SECRET || <span class="hljs-string">'your-secret-key-321'</span>,
  <span class="hljs-comment">// Token有效期</span>
  ACCESS_TOKEN_EXPIRES: <span class="hljs-string">'1h'</span>, <span class="hljs-comment">// 1小时</span>
  REFRESH_TOKEN_EXPIRES: <span class="hljs-string">'7d'</span>, <span class="hljs-comment">// 7天</span>
  <span class="hljs-comment">// Redis配置（存储Refresh Token，防止重复使用）</span>
  REDIS: {
    host: <span class="hljs-string">'localhost'</span>,
    port: <span class="hljs-number">6379</span>,
    db: <span class="hljs-number">0</span>,
  },
};
</code></pre>
<h4 data-id="heading-9">3. JWT 工具函数（utils/jwt.js）</h4>
<p>javascript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> jwt = <span class="hljs-built_in">require</span>(<span class="hljs-string">'jsonwebtoken'</span>);
<span class="hljs-keyword">const</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../config'</span>);

<span class="hljs-comment">// 生成Token</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">generateToken</span> = (<span class="hljs-params">payload, expiresIn</span>) =&gt; {
  <span class="hljs-keyword">return</span> jwt.<span class="hljs-title function_">sign</span>(payload, config.<span class="hljs-property">JWT_SECRET</span>, { expiresIn });
};

<span class="hljs-comment">// 验证Token</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">verifyToken</span> = (<span class="hljs-params">token</span>) =&gt; {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">return</span> jwt.<span class="hljs-title function_">verify</span>(token, config.<span class="hljs-property">JWT_SECRET</span>);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Token无效或已过期'</span>);
  }
};

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = { generateToken, verifyToken };
</code></pre>
<h4 data-id="heading-10">4. Redis 工具函数（utils/redis.js）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> redis = <span class="hljs-built_in">require</span>(<span class="hljs-string">'redis'</span>);
<span class="hljs-keyword">const</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../config'</span>);

<span class="hljs-comment">// 创建Redis客户端</span>
<span class="hljs-keyword">const</span> client = redis.<span class="hljs-title function_">createClient</span>({
  <span class="hljs-attr">host</span>: config.<span class="hljs-property">REDIS</span>.<span class="hljs-property">host</span>,
  <span class="hljs-attr">port</span>: config.<span class="hljs-property">REDIS</span>.<span class="hljs-property">port</span>,
  <span class="hljs-attr">db</span>: config.<span class="hljs-property">REDIS</span>.<span class="hljs-property">db</span>,
});

<span class="hljs-comment">// 连接Redis</span>
client.<span class="hljs-title function_">connect</span>().<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Redis连接失败:'</span>, err));

<span class="hljs-comment">// 存储Refresh Token（key: userId, value: refreshToken）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">setRefreshToken</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">userId, refreshToken</span>) =&gt; {
  <span class="hljs-comment">// 有效期与Refresh Token一致（7天）</span>
  <span class="hljs-keyword">await</span> client.<span class="hljs-title function_">setEx</span>(<span class="hljs-string">`refresh_token:<span class="hljs-subst">${userId}</span>`</span>, <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">24</span> * <span class="hljs-number">7</span>, refreshToken);
};

<span class="hljs-comment">// 获取Refresh Token</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getRefreshToken</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">userId</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> client.<span class="hljs-title function_">get</span>(<span class="hljs-string">`refresh_token:<span class="hljs-subst">${userId}</span>`</span>);
};

<span class="hljs-comment">// 删除Refresh Token（退出登录时）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">deleteRefreshToken</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">userId</span>) =&gt; {
  <span class="hljs-keyword">await</span> client.<span class="hljs-title function_">del</span>(<span class="hljs-string">`refresh_token:<span class="hljs-subst">${userId}</span>`</span>);
};

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = { setRefreshToken, getRefreshToken, deleteRefreshToken };
</code></pre>
<h4 data-id="heading-11">5. 核心接口实现（routes/auth.js）</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">express</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">'express'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">router</span> = express.<span class="hljs-title function_ invoke__">Router</span>();
<span class="hljs-keyword">const</span> { generateToken, verifyToken } = <span class="hljs-keyword">require</span>(<span class="hljs-string">'../utils/jwt'</span>);
<span class="hljs-keyword">const</span> { setRefreshToken, getRefreshToken, deleteRefreshToken } = <span class="hljs-keyword">require</span>(<span class="hljs-string">'../utils/redis'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">config</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">'../config'</span>);

<span class="hljs-comment">// 模拟用户数据库（实际替换为MySQL/MongoDB）</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">mockUsers</span> = [
  { id: <span class="hljs-number">1</span>, username: <span class="hljs-string">'admin'</span>, password: <span class="hljs-string">'123456'</span> },
];

<span class="hljs-comment">// 1. 登录接口：生成双Token</span>
router.<span class="hljs-title function_ invoke__">post</span>(<span class="hljs-string">'/login'</span>, (req, res) =&gt; {
  <span class="hljs-keyword">const</span> { username, password } = req.body;
  <span class="hljs-comment">// 验证账号密码</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">user</span> = mockUsers.<span class="hljs-title function_ invoke__">find</span>(
    (u) =&gt; u.username === username &amp;&amp; u.password === password
  );

  <span class="hljs-keyword">if</span> (!user) {
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_ invoke__">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_ invoke__">json</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'账号或密码错误'</span> });
  }

  <span class="hljs-comment">// 生成双Token（payload中存储用户唯一标识，避免敏感信息）</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">accessToken</span> = <span class="hljs-title function_ invoke__">generateToken</span>({ <span class="hljs-attr">userId</span>: user.id }, config.ACCESS_TOKEN_EXPIRES);
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">refreshToken</span> = <span class="hljs-title function_ invoke__">generateToken</span>({ <span class="hljs-attr">userId</span>: user.id }, config.REFRESH_TOKEN_EXPIRES);

  <span class="hljs-comment">// 存储Refresh Token到Redis（用于后续验证）</span>
  <span class="hljs-title function_ invoke__">setRefreshToken</span>(user.id, refreshToken);

  <span class="hljs-comment">// 返回双Token给前端</span>
  res.<span class="hljs-title function_ invoke__">json</span>({
    <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,
    <span class="hljs-attr">message</span>: <span class="hljs-string">'登录成功'</span>,
    <span class="hljs-attr">data</span>: { accessToken, refreshToken },
  });
});

<span class="hljs-comment">// 2. 刷新Token接口：用有效Refresh Token换取新双Token</span>
router.<span class="hljs-title function_ invoke__">post</span>(<span class="hljs-string">'/refresh'</span>, <span class="hljs-title function_ invoke__">async</span> (req, res) =&gt; {
  <span class="hljs-keyword">const</span> { refreshToken } = req.body;
  <span class="hljs-keyword">if</span> (!refreshToken) {
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_ invoke__">status</span>(<span class="hljs-number">403</span>).<span class="hljs-title function_ invoke__">json</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'Refresh Token不能为空'</span> });
  }

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 1. 验证Refresh Token有效性</span>
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">payload</span> = <span class="hljs-title function_ invoke__">verifyToken</span>(refreshToken);
    <span class="hljs-keyword">const</span> { userId } = payload;

    <span class="hljs-comment">// 2. 验证Redis中存储的Refresh Token是否一致（防止伪造）</span>
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">storedRefreshToken</span> = await <span class="hljs-title function_ invoke__">getRefreshToken</span>(userId);
    <span class="hljs-keyword">if</span> (storedRefreshToken !== refreshToken) {
      <span class="hljs-keyword">return</span> res.<span class="hljs-title function_ invoke__">status</span>(<span class="hljs-number">403</span>).<span class="hljs-title function_ invoke__">json</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'Refresh Token无效'</span> });
    }

    <span class="hljs-comment">// 3. 生成新的双Token</span>
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">newAccessToken</span> = <span class="hljs-title function_ invoke__">generateToken</span>({ userId }, config.ACCESS_TOKEN_EXPIRES);
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">newRefreshToken</span> = <span class="hljs-title function_ invoke__">generateToken</span>({ userId }, config.REFRESH_TOKEN_EXPIRES);

    <span class="hljs-comment">// 4. 更新Redis中的Refresh Token（滑动过期，增强安全性）</span>
    await <span class="hljs-title function_ invoke__">setRefreshToken</span>(userId, newRefreshToken);

    <span class="hljs-comment">// 5. 返回新Token</span>
    res.<span class="hljs-title function_ invoke__">json</span>({
      <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,
      <span class="hljs-attr">data</span>: { <span class="hljs-attr">accessToken</span>: newAccessToken, <span class="hljs-attr">refreshToken</span>: newRefreshToken },
    });
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_ invoke__">status</span>(<span class="hljs-number">403</span>).<span class="hljs-title function_ invoke__">json</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'Refresh Token已过期，请重新登录'</span> });
  }
});

<span class="hljs-comment">// 3. 退出登录接口：删除Redis中的Refresh Token</span>
router.<span class="hljs-title function_ invoke__">post</span>(<span class="hljs-string">'/logout'</span>, <span class="hljs-title function_ invoke__">async</span> (req, res) =&gt; {
  <span class="hljs-keyword">const</span> token = req.headers.authorization?.<span class="hljs-title function_ invoke__">split</span>(<span class="hljs-string">' '</span>)[<span class="hljs-number">1</span>];
  <span class="hljs-keyword">if</span> (!token) {
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_ invoke__">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_ invoke__">json</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'Token不能为空'</span> });
  }

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">payload</span> = <span class="hljs-title function_ invoke__">verifyToken</span>(token);
    await <span class="hljs-title function_ invoke__">deleteRefreshToken</span>(payload.userId);
    res.<span class="hljs-title function_ invoke__">json</span>({ <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'退出登录成功'</span> });
  } <span class="hljs-keyword">catch</span> (error) {
    res.<span class="hljs-title function_ invoke__">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_ invoke__">json</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">'退出登录失败'</span> });
  }
});

module.exports = router;
</code></pre>
<h4 data-id="heading-12">6. 后端入口文件（app.js）</h4>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">express</span> = require(<span class="hljs-string">'express'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">cors</span> = require(<span class="hljs-string">'cors'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">authRouter</span> = require(<span class="hljs-string">'./routes/auth'</span>)<span class="hljs-comment">;</span>

const <span class="hljs-attr">app</span> = express()<span class="hljs-comment">;</span>
const <span class="hljs-attr">port</span> = <span class="hljs-number">3001</span><span class="hljs-comment">;</span>

// 跨域配置（生产环境需限制origin）
app.use(cors())<span class="hljs-comment">;</span>
// 解析JSON请求体
app.use(express.json())<span class="hljs-comment">;</span>

// 挂载路由
app.use('/api/auth', authRouter)<span class="hljs-comment">;</span>

// 启动服务
app.listen(port, () =&gt; {
  console.log(`后端服务启动成功：http://localhost:${port}`)<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<hr/>
<h3 data-id="heading-13">四、关键注意事项（生产环境必看）</h3>
<ol>
<li>
<p><strong>安全存储 Token</strong></p>
<ul>
<li>不推荐用 localStorage 存储（易受 XSS 攻击），优先用 <strong>HttpOnly Cookie</strong> 存储 Refresh Token，前端无法读取，避免窃取。</li>
<li>Access Token 可存在内存（如 Vuex/Pinia），页面刷新后通过 Cookie 获取 Refresh Token 重新刷新。</li>
</ul>
</li>
<li>
<p><strong>防止重复刷新</strong></p>
<ul>
<li>用<code>isRefreshing</code>状态和<code>requestQueue</code>队列，避免多个并发请求同时触发刷新接口，导致 Token 冲突。</li>
</ul>
</li>
<li>
<p><strong>Redis 的必要性</strong></p>
<ul>
<li>存储 Refresh Token 到 Redis，支持 “强制登出”“单点登录” 功能（如修改密码后，删除 Redis 中的旧 Refresh Token，强制用户重新登录）。</li>
</ul>
</li>
<li>
<p><strong>HTTPS 协议</strong></p>
<ul>
<li>生产环境必须启用 HTTPS，防止 Token 在传输过程中被中间人窃取。</li>
</ul>
</li>
<li>
<p><strong>Token 有效期合理设置</strong></p>
<ul>
<li>Access Token：15 分钟～2 小时（越短越安全）。</li>
<li>Refresh Token：7~30 天（平衡安全性和用户体验）。</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-14">五、完整流程梳理</h3>
<ol>
<li>用户登录 → 后端验证账号密码 → 返回 Access Token 和 Refresh Token → 前端存储。</li>
<li>前端发起业务请求 → 拦截器自动携带 Access Token → 后端验证有效 → 返回业务数据。</li>
<li>若 Access Token 过期 → 后端返回 401 → 前端拦截器调用刷新接口。</li>
<li>刷新接口验证 Refresh Token 有效 → 返回新双 Token → 前端更新存储，重试原始请求。</li>
<li>若 Refresh Token 过期 → 前端清除 Token，跳转登录页。</li>
</ol>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue.js 源码解读：从 new Vue() 到 DOM 更新的完整追踪]]></title>    <link>https://juejin.cn/post/7571416207972450354</link>    <guid>https://juejin.cn/post/7571416207972450354</guid>    <pubDate>2025-11-12T07:49:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571416207972450354" data-draft-id="7571637614202470427" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue.js 源码解读：从 new Vue() 到 DOM 更新的完整追踪"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-11-12T07:49:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="再吃一颗苹果要不要"/> <meta itemprop="url" content="https://juejin.cn/user/2277843821659485"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue.js 源码解读：从 new Vue() 到 DOM 更新的完整追踪
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2277843821659485/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    再吃一颗苹果要不要
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T07:49:45.000Z" title="Wed Nov 12 2025 07:49:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 示例与调试环境</h2>
<p><strong>示例代码（Vue</strong>@<strong>2.6.14）</strong></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>组件化机制<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{msg}}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">comp</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"../../dist/vue.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">component</span>(<span class="hljs-string">'comp'</span>, {
      <span class="hljs-attr">template</span>: <span class="hljs-string">'&lt;div&gt;I am a component&lt;/div&gt;'</span>
    })

    <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
      <span class="hljs-attr">el</span>: <span class="hljs-string">'#app'</span>,
      <span class="hljs-attr">data</span>:{
        <span class="hljs-attr">msg</span>: <span class="hljs-string">'hello vue'</span>
      }
    })

  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
</code></pre>
<p><strong>源码调试环境搭建</strong></p>
<ol>
<li>
<p>获取Vue.js源码，v2.6.14</p>
</li>
<li>
<p>安装项目依赖</p>
<p><code>npm install</code>（安装phantom.js时可终止）</p>
</li>
<li>
<p>安装构建工具rollup</p>
<p><code>npm i -g rollup</code></p>
</li>
<li>
<p>配置构建脚本</p>
<p>修改<code>package.json</code>中的dev脚本，添加<code>--sourcemap</code>，在开发模式下生成sourcemap</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rollup -w -c scripts/config.js --sourcemap --environment TARGET:web-full-dev"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
<li>
<p>构建Vue.js</p>
<p>运行行开发命令<code>npm run dev</code>，构建完成后，会在dist目录下生成带源码映射的vue.js文件</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfc418150fed4584b38c845923d12e1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YaN5ZCD5LiA6aKX6Iu55p6c6KaB5LiN6KaB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763538924&amp;x-signature=U2MzCqkacPfaFhJ%2FuaHVsnSDSaU%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p>创建测试页面并引入构建好的vue.js</p>
</li>
<li>
<p>调试Vue.js源码</p>
</li>
</ol>
<p>在浏览器中打开测试页面，然后打开开发者工具进行调试</p>
<h2 data-id="heading-1">2. 从构建配置寻找源码入口</h2>
<h3 data-id="heading-2">2.1. <strong>构建命令分析</strong></h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rollup -w -c scripts/config.js --sourcemap --environment TARGET:web-full-dev"</span>
</code></pre>
<ul>
<li><code>-c scripts/config.js</code>=&gt; 指定Rollup配置文件路径</li>
<li><code>--environment TARGET:web-full-dev</code>=&gt; 设置环境变量<code>TARGET</code>为<code>web-full-dev</code></li>
</ul>
<h3 data-id="heading-3">2.2. 查看Rollup配置文件</h3>
<ol>
<li>打开<code>scripts/config.js</code></li>
<li>找到<code>web-full-dev</code>相关配置</li>
</ol>

<pre><code class="hljs language-css" lang="css">const builds = {
  ...
  // Runtime+compiler development build (Browser)
  'web-full-dev': {
    entry: <span class="hljs-built_in">resolve</span>(<span class="hljs-string">'web/entry-runtime-with-compiler.js'</span>),
    dest: <span class="hljs-built_in">resolve</span>(<span class="hljs-string">'dist/vue.js'</span>),
    format: <span class="hljs-string">'umd'</span>,
    env: <span class="hljs-string">'development'</span>,
    alias: { he: <span class="hljs-string">'./entity-decoder'</span> },
    banner
  },
  ...
}
</code></pre>
<h3 data-id="heading-4">2.3. 定位入口文件</h3>
<p>从配置中可以看出入口文件为：</p>
<p><code>entry: resolve('web/entry-runtime-with-compiler.js')</code></p>
<ol>
<li><strong>先看resolve函数的定义：</strong></li>
</ol>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">const</span> aliases = require(<span class="hljs-string">'./alias'</span>)
<span class="hljs-keyword">const</span> resolve = p =&gt; {
  <span class="hljs-comment">// 将传入的web/entry-runtime-with-compiler.js通过/分割成数组</span>
  <span class="hljs-comment">// 然后取第一个元素设置为base，即web</span>
  <span class="hljs-keyword">const</span> <span class="hljs-keyword">base</span> = p.split(<span class="hljs-string">'/'</span>)[<span class="hljs-number">0</span>]
  <span class="hljs-keyword">if</span> (aliases[<span class="hljs-keyword">base</span>]) {
    <span class="hljs-keyword">return</span> path.resolve(aliases[<span class="hljs-keyword">base</span>], p.slice(<span class="hljs-keyword">base</span>.length + <span class="hljs-number">1</span>))
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> path.resolve(__dirname, <span class="hljs-string">'../'</span>, p)
  }
}
</code></pre>
<p>2.  <strong>接着来到</strong><code>scripts/alias.js</code></p>

<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">module</span>.<span class="hljs-keyword">exports</span> = {
  ...
  web: resolve(<span class="hljs-string">'src/platforms/web'</span>),	<span class="hljs-comment">// 找到web对应的真实路径</span>
  ...
}
</code></pre>
<p>3.  <strong>于是便得到入口文件的真实路径</strong></p>
<p><code>src/platforms/web/entry-runtime-with-compiler.js</code></p>
<h3 data-id="heading-5">2.4. 通过追踪入口文件依赖关系找到核心入口</h3>
<p>💡 主线不要乱，粗略地看细节，先理清调用链</p>
<p>打开代码文件后，先把方法都折叠起来，了解大致结构</p>
<p>🚂 <code>src/platforms/web/entry-runtime-with-compiler.js</code></p>
<p>⬇️ <code>import Vue from './runtime/index'</code></p>
<p>🚂 <code>src/platforms/web/runtime/index.js</code></p>
<p>⬇️ <code>import Vue from 'core/index'</code></p>
<p>🚂 <code>/src/core/index.js</code></p>
<p>⬇️ <code>import Vue from './instance/index'</code></p>
<p>🚂 <code>src/core/instance/index.js</code></p>
<p>➡️ <code>function Vue () { ... }</code> <strong>找到Vue构造函数</strong></p>
<h2 data-id="heading-6">3. Vue的渐进式构建</h2>
<p><strong>Vue并非一次性定义完成，而是通过多个模块逐步增强功能</strong></p>
<h3 data-id="heading-7">3.1. 原型方法混入</h3>
<p>🚂 <code>src/core/instance/index.js</code></p>
<p>先定义一个空函数，只是定义，还没执行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function">function <span class="hljs-title">Vue</span> <span class="hljs-params">(options)</span> </span>{
  ...
  <span class="hljs-keyword">this</span>._init(options)	<span class="hljs-comment">// 初始化入口</span>
}
</code></pre>
<p>这里只是一个空函数，还没有原型方法：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc7cc81ca3da4a3f863d44b4d08c2d4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YaN5ZCD5LiA6aKX6Iu55p6c6KaB5LiN6KaB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763538924&amp;x-signature=08WHLgnYU2wW0FgPXzpDUvsgF1M%3D" alt="" loading="lazy"/></p>
<p><strong>按顺序混入原型上的方法和属性</strong></p>
<p><code>initMixin(Vue)</code> ➡️ 添加<code>_init</code>方法</p>
<p><code>stateMixin(Vue)</code> ➡️ 添加 <code>$data``$props</code>属性 &amp; <code>$set``$delete``$watch</code>方法</p>
<p><code>eventsMixin(Vue)</code> ➡️ 添加 <code>$on``$once``$off``$emit</code>方法</p>
<p><code>lifecycleMixin(Vue)</code> ➡️ 添加 <code>_update``$forceUpdate``$destroy</code>方法</p>
<p><code>renderMixin(Vue)</code></p>
<ul>
<li>添加 <code>$nextTick</code>方法</li>
<li><code>installRenderHelpers(Vue.prototype)</code></li>
</ul>

<ul>
<li>
<ul>
<li>为Vue实例添加渲染相关的工具方法（_s _l _v等，注意，此时还没有添加_c）</li>
<li>🚂<code>src/core/instance/render-helpers/index.js</code></li>
</ul>
</li>
</ul>
<p><strong>导出基础Vue</strong></p>
<p>此时只有原型方法</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48b89888d54842e4b0fd1a42b92c1d9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YaN5ZCD5LiA6aKX6Iu55p6c6KaB5LiN6KaB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763538924&amp;x-signature=p%2BTomBq4jWtpN%2FMr2vq02sEMrSU%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">3.2. 静态方法添加</h3>
<p>🚂 <code>src/core/index.js</code></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./instance/index'</span>		<span class="hljs-comment">// 导入上一步导出的基础Vue类</span>
<span class="hljs-title function_">initGlobalAPI</span>(<span class="hljs-title class_">Vue</span>);	<span class="hljs-comment">// 全局静态API初始化入口</span>
</code></pre>
<p>🚂 <code>src/core/global-api/index.js</code></p>
<ul>
<li>
<p><strong>初始化全局配置对象</strong><code>Vue.config</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed7fc23220e54d1f81c3e8356f78a88e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YaN5ZCD5LiA6aKX6Iu55p6c6KaB5LiN6KaB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763538924&amp;x-signature=v4hxb5sBg2tn4oABn6qAKxiCxF0%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p><strong>添加内部使用的工具函数</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">Vue.util</span> = {
  warn,
  extend,
  mergeOptions,
  defineReactive
}
</code></pre>
</li>
<li>
<p><strong>添加</strong><code>Vue.set</code> <code>Vue.delete</code> <code>Vue.nextTick</code></p>
</li>
</ul>

<ul>
<li>
<p><strong>初始化选项对象</strong></p>
<p><code>Vue.options = Object.create(null)</code></p>
</li>
<li>
<p><strong>初始化组件、指令、过滤器的存储结构</strong></p>
<pre><code class="hljs language-css" lang="css">// <span class="hljs-selector-attr">[<span class="hljs-string">'component'</span>, <span class="hljs-string">'directive'</span>, <span class="hljs-string">'filter'</span>]</span>
ASSET_TYPES<span class="hljs-selector-class">.forEach</span>(type =&gt; {
  Vue<span class="hljs-selector-class">.options</span><span class="hljs-selector-attr">[type + <span class="hljs-string">'s'</span>]</span> = <span class="hljs-selector-tag">Object</span><span class="hljs-selector-class">.create</span>(null)
})
</code></pre>
</li>
<li>
<p><strong>内置组件</strong> <code>&lt;keep-alive&gt;</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/934c430d97df4a87bf298fea67dddfb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YaN5ZCD5LiA6aKX6Iu55p6c6KaB5LiN6KaB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763538924&amp;x-signature=tHDaCOXIF%2BMhYo6kGDz6NJB8r9c%3D" alt="" loading="lazy"/></p>
</li>
<li>
<p><strong>初始化全局API</strong></p>
<p><code>initUse(Vue)</code>=&gt;<code>Vue.use</code></p>
<p><code>initMixin(Vue)</code>=&gt;<code>Vue.mixin</code></p>
<p><code>initExtend(Vue)</code>=&gt;<code>Vue.extend</code></p>
</li>
<li>
<p><strong>资源注册</strong></p>
<p><code>initAssetRegisters(Vue)</code></p>
</li>
</ul>
<p>最后，导出完整的Vue类：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57a922b8c37943eeb0619912ac2c5ceb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YaN5ZCD5LiA6aKX6Iu55p6c6KaB5LiN6KaB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763538924&amp;x-signature=NEV8mBniA9%2BuMhkSTZkBAc8O0Z8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">3.3. 平台适配完善</h3>
<p>🚂<code>src/platforms/web/runtime/index.js</code></p>
<p>导入上一步导出的Vue类</p>
<ul>
<li>
<p><strong>添加web平台特定配置</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">Vue.config.mustUseProp</span> = mustUseProp
<span class="hljs-attr">Vue.config.isReservedTag</span> = isReservedTag
<span class="hljs-attr">Vue.config.isReservedAttr</span> = isReservedAttr
<span class="hljs-attr">Vue.config.getTagNamespace</span> = getTagNamespace
<span class="hljs-attr">Vue.config.isUnknownElement</span> = isUnknownElement
</code></pre>
</li>
<li>
<p><strong>安装web平台相关指令和组件</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// model,show</span>
<span class="hljs-built_in">extend</span>(Vue.options.directives, platformDirectives)  
<span class="hljs-comment">// Transition,TransitionGroup</span>
<span class="hljs-built_in">extend</span>(Vue.options.components, platformComponents)  
</code></pre>
</li>
<li>
<p><strong>安装</strong><code> __patch__ </code><strong>函数</strong> ❗</p>
</li>
<li>
<p><strong>安装</strong><code> $mount</code><strong>方法</strong>❗</p>
</li>
<li>
<p>导出Web平台适配后的Vue</p>
</li>
</ul>
<h3 data-id="heading-10">3.4. 编译器集成</h3>
<p>🚂 <code>src/platforms/web/entry-runtime-with-compiler.js</code></p>
<p>导入上一步平台适配后的Vue</p>
<ul>
<li>
<p>缓存原始的<code>$mount</code>方法 <code>const mount = Vue.prototype.$mount</code></p>
</li>
<li>
<p>重写<code>$mount</code>方法，支持模板编译</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> mount = Vue.prototype.$mount  <span class="hljs-comment">// 缓存原始方法</span>

Vue.prototype.$mount = <span class="hljs-built_in">function</span> (el, hydrating) {
  <span class="hljs-comment">// 处理模板编译逻辑</span>
  <span class="hljs-keyword">if</span> (!options.render) {
    let <span class="hljs-keyword">template</span> = options.<span class="hljs-keyword">template</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">template</span> &amp;&amp; el) {
      <span class="hljs-keyword">template</span> = <span class="hljs-built_in">getOuterHTML</span>(el)  <span class="hljs-comment">// 将 DOM 转为模板字符串</span>
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">template</span>) {
      <span class="hljs-comment">// 编译模板得到 render 函数</span>
      <span class="hljs-type">const</span> { render, staticRenderFns } = <span class="hljs-built_in">compileToFunctions</span>(<span class="hljs-keyword">template</span>, {
        delimiters: options.delimiters,
        comments: options.comments
      }, <span class="hljs-keyword">this</span>)
      options.render = render
    }
  }

  <span class="hljs-comment">// 调用原始 mount 方法</span>
  <span class="hljs-keyword">return</span> mount.<span class="hljs-built_in">call</span>(<span class="hljs-keyword">this</span>, el, hydrating)
}
</code></pre>
</li>
</ul>
<p>最终导出给用户使用的Vue</p>
<h2 data-id="heading-11">4. 从<code>new Vue()</code>到挂载</h2>
<h3 data-id="heading-12">4.1. 全局组件注册</h3>
<pre><code class="hljs language-arduino" lang="arduino">Vue.<span class="hljs-built_in">component</span>(<span class="hljs-string">'comp'</span>, {  <span class="hljs-comment">// 🚂 调用initGlobalAPI中定义的Vue.component</span>
  <span class="hljs-keyword">template</span>: <span class="hljs-string">'&lt;div&gt;I am a component&lt;/div&gt;'</span>
})
</code></pre>
<h4 data-id="heading-13">4.1.1. 执行过程</h4>
<ul>
<li>调用<code>initGlobalAPI</code>中定义的<code>Vue.component</code>方法</li>
<li>将组件配置存入<code>Vue.options.components</code></li>
<li>⚠️ 此时只是注册定义，尚未创建组件构造函数</li>
</ul>
<h4 data-id="heading-14">4.1.2. 相关代码</h4>
<p>🚂<code>src/core/global-api/assets.js</code></p>
<pre><code class="hljs language-bash" lang="bash">// src/core/global-api/assets.js
<span class="hljs-keyword">function</span> initAssetRegisters(Vue) {
  ASSET_TYPES.forEach(<span class="hljs-built_in">type</span> =&gt; {
    Vue[<span class="hljs-built_in">type</span>] = <span class="hljs-keyword">function</span>(<span class="hljs-built_in">id</span>, definition) {
      <span class="hljs-keyword">if</span> (!definition) {
        <span class="hljs-built_in">return</span> this.options[<span class="hljs-built_in">type</span> + <span class="hljs-string">'s'</span>][<span class="hljs-built_in">id</span>]
      }
      // 注册组件
      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">type</span> === <span class="hljs-string">'component'</span> &amp;&amp; isPlainObject(definition)) {
        definition.name = definition.name || <span class="hljs-built_in">id</span>
        definition = this.options._base.extend(definition)
      }
      this.options[<span class="hljs-built_in">type</span> + <span class="hljs-string">'s'</span>][<span class="hljs-built_in">id</span>] = definition
      <span class="hljs-built_in">return</span> definition
    }
  })
}
</code></pre>
<p>执行完后</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74675384651746faa45531f0d068a660~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YaN5ZCD5LiA6aKX6Iu55p6c6KaB5LiN6KaB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763538924&amp;x-signature=ur2fWKmic5sO4isdgpnGhXqrseY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-15">4.2. Vue实例化入口</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Vue</span>({
  el: <span class="hljs-string">'#app'</span>,
  data: {
    msg: <span class="hljs-string">'hello vue'</span>
  }
})
</code></pre>
<p>当执行<code>new Vue(options)</code>时，Vue内部会立即调用<code>_init</code></p>
<p>🚂<code>core/instance/index.js</code></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 进入Vue构造函数</span>
<span class="hljs-function">function <span class="hljs-title">Vue</span> <span class="hljs-params">(options)</span> </span>{
  <span class="hljs-comment">// 🚂 马上进入这里！</span>
  <span class="hljs-keyword">this</span>._init(options)
}
</code></pre>
<h3 data-id="heading-16">4.3. <code>_init</code>方法</h3>
<p>❗初始化流程开始</p>
<p>🚂<code>src/core/instance/init.js</code></p>
<h4 data-id="heading-17">4.3.1. 选项合并</h4>
<p><strong>目的：</strong> 将用户传入的实例配置与Vue构造函数自身的全局配置（🌰全局组件/混入/指令/...）进行合并，生成最终的实例属性<code>vm.$options</code></p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">vm</span>.$<span class="hljs-selector-tag">options</span> = <span class="hljs-selector-tag">mergeOptions</span>(
  <span class="hljs-built_in">resolveConstructorOptions</span>(vm.constructor),	<span class="hljs-comment">// 解析Vue全局配置</span>
  options || {},		<span class="hljs-comment">// 用户实例配置</span>
  vm		<span class="hljs-comment">// 当前Vue实例</span>
)
</code></pre>
<p><strong>合并后：</strong> <code>vm.$options</code>包含了所有可用于当前实例的选项</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5132c0f2ea334c96834258bccb79ed8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YaN5ZCD5LiA6aKX6Iu55p6c6KaB5LiN6KaB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763538924&amp;x-signature=0C60fZpcQtGZw%2BUocNL7Qxw7acY%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-18">4.3.2. 核心功能初始化</h4>
<p>此阶段按特定顺序初始化实例的核心功能模块，<strong>确保后续模块能访问先初始化的内容</strong></p>
<ol>
<li><code>initLifecycle(vm)</code></li>
</ol>
<ul>
<li>
<ul>
<li>初始化组件实例的生命周期相关属性</li>
<li>建立父子组件关系链（<code>$parent</code> <code>$children</code> <code>...</code>）等</li>
</ul>
</li>
</ul>
<ol start="2">
<li><code>initEvents(vm)</code></li>
</ol>
<ul>
<li>
<ul>
<li>初始化事件系统</li>
<li>处理父组件传递的自定义事件（<code>vm.$listeners</code>），为后续的<code>$on</code> <code>$emit</code>等方法提供支持</li>
</ul>
</li>
</ul>
<ol start="3">
<li><code>initRender(vm)</code>⚠️ <strong>关键步骤</strong></li>
</ol>
<ul>
<li>
<ul>
<li>初始化与渲染相关的属性和方法</li>
<li>挂载<code>vm._createElement</code> <code>vm._c</code></li>
</ul>
</li>
</ul>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">initRender</span>(<span class="hljs-params">vm</span>) {
  <span class="hljs-comment">// 供内部模板编译生成的render函数使用</span>
  vm.<span class="hljs-property">_c</span> = <span class="hljs-function">(<span class="hljs-params">a, b, c, d</span>) =&gt;</span> <span class="hljs-title function_">createElement</span>(vm, a, b, c, d, <span class="hljs-literal">false</span>)
  
  <span class="hljs-comment">// 供用户手写render函数时使用</span>
  vm.<span class="hljs-property">$createElement</span> = <span class="hljs-function">(<span class="hljs-params">a, b, c, d</span>) =&gt;</span> <span class="hljs-title function_">createElement</span>(vm, a, b, c, d, <span class="hljs-literal">true</span>)
}

<span class="hljs-comment">// 两者的区别</span>
<span class="hljs-comment">// vm._c：会对子节点进行简单的规范化处理，因为模板编译时已经处理过大部分情况</span>
<span class="hljs-comment">// vm.$createElement：会进行更全面的规范化处理，确保用户编写的VNode结构正确</span>
</code></pre>
<p>⚠️ 此时安装了<code>_c</code></p>
<h4 data-id="heading-19">4.3.3. 调用<code>beforeCreate</code>钩子</h4>
<p><code>callHook(vm, 'beforeCreate')</code></p>
<p>此时状态：事件、渲染函数已就绪，但数据响应式尚未建立，即无法访问到data、computed等数据</p>
<h4 data-id="heading-20">4.3.4. 初始化inject</h4>
<p><code>initInjections(vm)</code></p>
<p>解析并建立<code>inject</code>选项，使得当前实例可以注入来自祖先组件提供的数据</p>
<h4 data-id="heading-21">4.3.5. 初始化状态</h4>
<p><code>initState(vm)</code> ❗️<strong>响应式系统核心</strong></p>
<p><strong>目的：</strong> 建立Vue的响应式数据系统</p>
<p>初始化顺序：props =&gt; methods =&gt; data =&gt; computed =&gt; watch</p>
<p>取出options选项，按照以上顺序，如果存在，则初始化之</p>
<p><strong>❓</strong> <strong>为什么是按这个顺序</strong></p>
<p><strong>确保后初始化的数据能访问先初始化的数据</strong></p>
<ol>
<li>props - 接收父组件传递的数据（最先，供其他选项使用）</li>
<li>methods - 定义方法，供data中方法调用</li>
<li>data - 整个响应式系统的起点，将数据对象转为响应式，建立getter/setter =&gt; <code>observe(data)</code></li>
<li>computed - 定义计算属性，创建惰性求值的Watcher</li>
<li>watch - 监听器，依赖前面所有数据，为每个处理函数创建watcher =&gt; <code>createWatcher</code></li>
</ol>
<h4 data-id="heading-22">4.3.6. 初始化provide</h4>
<p><code>initProvide(vm)</code></p>
<p>解析<code>provide</code>选项，为后代组件提供数据</p>
<h4 data-id="heading-23">4.3.7. 调用created钩子</h4>
<p><code>callHook(vm, 'created')</code></p>
<p>此时状态：数据响应式系统已完全建立，实例已准备就绪，但尚未开始DOM的挂载和渲染</p>
<h4 data-id="heading-24">4.3.8. 自动挂载判断</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">if</span> (vm.<span class="hljs-variable">$options</span>.el) {	<span class="hljs-comment">// 如果设置了el选项，直接挂载</span>
  vm.<span class="hljs-variable">$mount</span>(vm.<span class="hljs-variable">$options</span>.el)		<span class="hljs-comment">// 启动挂载流程</span>
}
</code></pre>
<h3 data-id="heading-25">4.4. 渲染&amp;挂载阶段</h3>
<h4 data-id="heading-26">4.4.1. <code>$mount</code>的扩展</h4>
<h5 data-id="heading-27">4.4.1.1. 回到入口文件</h5>
<p>🚂<code>src/platforms/web/entry-runtime-with-compiler.js</code></p>
<p>可以看到</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> mount = <span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$mount</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$mount</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  ...
  <span class="hljs-keyword">return</span> mount.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, el, hydrating)
}
</code></pre>
<p>❓ <strong>这里做了什么？</strong> =&gt; 扩展$mount方法</p>
<ol>
<li>缓存原始<code>$mount</code></li>
<li>重定定义<code>$mount</code> =&gt; 扩展</li>
<li>调用原始<code>$mount</code>，执行默认挂载</li>
</ol>
<p>❓ <strong>为什么这样设计？</strong></p>
<p>✅ <strong>功能分离</strong>：编译逻辑与挂载逻辑解耦</p>
<p>✅ <strong>向后兼容</strong>：确保核心功能不受破坏</p>
<p>✅ <strong>灵活配置</strong>：运行时版本可以直接使用原始方法</p>
<h5 data-id="heading-28">4.4.1.2. <strong>模板处理链与优先级</strong></h5>
<pre><code class="hljs language-arduino" lang="arduino">Vue.prototype.$mount = <span class="hljs-built_in">function</span> () {
  <span class="hljs-comment">// 1.处理el</span>
  el = el &amp;&amp; <span class="hljs-built_in">query</span>(el)

  <span class="hljs-type">const</span> options = <span class="hljs-keyword">this</span>.$options

  <span class="hljs-comment">// 2. 模板处理链： el -&gt; template -&gt; render </span>
  <span class="hljs-keyword">if</span> (!options.render) {
    let <span class="hljs-keyword">template</span> = options.<span class="hljs-keyword">template</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">template</span>) {
      <span class="hljs-comment">// 处理各种template（字符串/DOM元素/...）</span>
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (el) {
      <span class="hljs-comment">// 没有template，从el获取模版 （🌰 id="app"的div内容）</span>
      <span class="hljs-keyword">template</span> = <span class="hljs-built_in">getOuterHTML</span>(el)
    }

    <span class="hljs-comment">// 3.如果存在template，则编译它，获取render函数</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">template</span>) {
      <span class="hljs-type">const</span> { render, staticRenderFns } = <span class="hljs-built_in">compileToFunctions</span>(<span class="hljs-keyword">template</span>, {
        <span class="hljs-comment">// 编译选项...</span>
      }, <span class="hljs-keyword">this</span>)
      <span class="hljs-comment">// 4.将结果保存到选项中，供后续使用</span>
      options.render = render
      options.staticRenderFns = staticRenderFns

    }
  }
  <span class="hljs-comment">// 5.调用原始$mount 执行默认挂载</span>
  <span class="hljs-keyword">return</span> mount.<span class="hljs-built_in">call</span>(<span class="hljs-keyword">this</span>, el, hydrating)
}
</code></pre>
<p><strong>优先级说明：</strong></p>
<ol>
<li>render函数（最高）-&gt; 直接使用</li>
<li>template选项 -&gt; 编译为render函数</li>
<li>el选项（最低）-&gt; 提取对应DOM的HTML并编译</li>
</ol>
<h4 data-id="heading-29">4.4.2. 模板编译过程</h4>
<h5 data-id="heading-30">4.4.2.1. 编译流程概览</h5>
<p>➡️ <code>compileToFunctions</code> 🚂 <code>src/platforms/web/compiler/index.js</code></p>
<pre><code class="hljs language-scss" lang="scss">const { compile, compileToFunctions } = <span class="hljs-built_in">createCompiler</span>(baseOptions)
</code></pre>
<p>➡️ <code>createCompiler</code> 🚂 <code>src/compiler/index.js</code></p>
<h5 data-id="heading-31">4.4.2.2. 核心编译函数</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createCompilerCreator } <span class="hljs-keyword">from</span> <span class="hljs-string">'./create-compiler'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> createCompiler = <span class="hljs-title function_">createCompilerCreator</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">baseCompile</span>(<span class="hljs-params">
  template: string,     <span class="hljs-comment">// 要编译的模版字符串</span>
  options: CompilerOptions  <span class="hljs-comment">// 编译选项，可以配置一些编译时的行为</span>
</span>): <span class="hljs-title class_">CompiledResult</span> {
  <span class="hljs-comment">// 1.解析  template=&gt;AST</span>
  <span class="hljs-keyword">const</span> ast = <span class="hljs-title function_">parse</span>(template.<span class="hljs-title function_">trim</span>(), options)
  
  <span class="hljs-comment">// 2.优化  标记静态节点</span>
  <span class="hljs-keyword">if</span> (options.<span class="hljs-property">optimize</span> !== <span class="hljs-literal">false</span>) {
    <span class="hljs-title function_">optimize</span>(ast, options) 
  }
  
  <span class="hljs-comment">// 3.生成render函数  AST=&gt;render函数</span>
  <span class="hljs-keyword">const</span> code = <span class="hljs-title function_">generate</span>(ast, options)
  
  <span class="hljs-comment">// 返回一个CompiledResult对象，包含：</span>
  <span class="hljs-comment">// ast 生成的抽象语法树，可以用于服务端渲染或其他分析</span>
  <span class="hljs-comment">// render 主渲染函数的代码字符串</span>
  <span class="hljs-comment">// staticRenderFns 一个数组，包含静态子树的渲染函数代码字符串，结果恒定，缓存</span>
  <span class="hljs-keyword">return</span> {
    ast,
    <span class="hljs-attr">render</span>: code.<span class="hljs-property">render</span>,
    <span class="hljs-attr">staticRenderFns</span>: code.<span class="hljs-property">staticRenderFns</span>
  }
})
</code></pre>
<h5 data-id="heading-32">4.4.2.3. <strong>编译结果示例</strong></h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">with</span>(<span class="hljs-params"><span class="hljs-variable language_">this</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">_c</span>(<span class="hljs-string">'div'</span>, 
      { <span class="hljs-attr">attrs</span>: { <span class="hljs-string">"id"</span>: <span class="hljs-string">"app"</span> } },
      [
        <span class="hljs-title function_">_c</span>(<span class="hljs-string">'h1'</span>, [<span class="hljs-title function_">_v</span>(<span class="hljs-string">"组件化机制"</span>)]),
        <span class="hljs-title function_">_c</span>(<span class="hljs-string">'p'</span>, [<span class="hljs-title function_">_v</span>(<span class="hljs-title function_">_s</span>(msg))]),
        <span class="hljs-title function_">_c</span>(<span class="hljs-string">'comp'</span>)
      ], 
      <span class="hljs-number">1</span> <span class="hljs-comment">// 规范化类型标识</span>
    )
  }
}
</code></pre>
<p><strong>工具函数说明：</strong></p>
<ul>
<li><code>_c</code>：createElement，创建VNode</li>
<li><code>_v</code>：createTextVNode，创建文本VNode</li>
<li><code>_s</code>：toString，值转换为字符串</li>
</ul>
<h4 data-id="heading-33">4.4.3. 运行时挂载：<code>mountComponent</code></h4>
<h5 data-id="heading-34">4.4.3.1. 调用原始<code>$mount</code>方法</h5>
<p>🚂 <code>src/platforms/web/runtime/index.js</code></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">$mount</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">el, hydrating</span>) {
  el = el &amp;&amp; inBrowser ? <span class="hljs-title function_">query</span>(el) : <span class="hljs-literal">undefined</span>
  <span class="hljs-comment">// 调用核心挂载方法, Vue实例真正开始挂载的地方</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">mountComponent</span>(<span class="hljs-variable language_">this</span>, el, hydrating)
}
</code></pre>
<p>🚂 <code>src/core/instance/lifecycle.js</code></p>
<h5 data-id="heading-35">4.4.3.2. 核心挂载逻辑</h5>
<pre><code class="hljs language-php" lang="php"> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mountComponent</span> (<span class="hljs-params">vm, el, hydrating</span>) </span>{
  <span class="hljs-comment">// 1.保存DOM引用</span>
  vm.<span class="hljs-variable">$el</span> = el

  <span class="hljs-comment">// 2.正式挂载前，触发beforeMount钩子</span>
  <span class="hljs-title function_ invoke__">callHook</span>(vm, <span class="hljs-string">'beforeMount'</span>)

  <span class="hljs-comment">// 3.定义组件更新函数 updateComponent(❗️核心)</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">updateComponent</span> = () =&gt; {
    <span class="hljs-comment">// 首先执行_render =&gt; vdom</span>
    vm.<span class="hljs-title function_ invoke__">_update</span>(vm.<span class="hljs-title function_ invoke__">_render</span>(), hydrating)
  }

  <span class="hljs-comment">// 4.创建Watcher实例，触发首次渲染（响应式系统的关键连接点）</span>
  <span class="hljs-comment">// 对于子组件，它们的mounted钩子会在其自身的vnode被插入到父DOM树时才触发</span>
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watcher</span>(vm, updateComponent, noop, ...)
  
  <span class="hljs-comment">// 5.触发mounted钩子，仅根实例</span>
  <span class="hljs-keyword">if</span> (vm.<span class="hljs-variable">$vnode</span> == <span class="hljs-literal">null</span>) {
    vm._isMounted = <span class="hljs-literal">true</span>
    <span class="hljs-title function_ invoke__">callHook</span>(vm, <span class="hljs-string">'mounted'</span>)
  }

  <span class="hljs-comment">// 6.返回实例本身，支持链式调用</span>
  <span class="hljs-keyword">return</span> vm 
}
</code></pre>
<p><strong>关于updateComponent的两个关键步骤</strong></p>
<p>两个关键步骤：</p>
<ol>
<li><code>vm._render()</code></li>
</ol>
<p>调用实例的_render方法，执行定义的render函数或模板编译得到的render函数，返回一个vnode</p>
<ol start="2">
<li><code>vm._update(vm._render(), hydrating)</code></li>
</ol>
<p>调用实例的_update方法，接收_render产生的vnode，进行patch算法，将vnode转为真实DOM并挂载或更新到页面</p>
<h5 data-id="heading-36">4.4.3.3. 挂载执行时序</h5>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">mountComponent</span>()
    ↓
new <span class="hljs-built_in">Watcher</span>(vm, updateComponent)  <span class="hljs-comment">// 创建渲染Watcher</span>
    ↓  
Watcher<span class="hljs-selector-class">.get</span>() → <span class="hljs-built_in">pushTarget</span>(this)  <span class="hljs-comment">// 开始依赖收集</span>
    ↓
<span class="hljs-built_in">updateComponent</span>()  <span class="hljs-comment">// 执行更新函数</span>
    ↓
vm<span class="hljs-selector-class">._render</span>()  <span class="hljs-comment">// 生成VNode树</span>
    ↓
vm<span class="hljs-selector-class">._update</span>()  <span class="hljs-comment">// DOM更新</span>
    ↓
vm<span class="hljs-selector-class">.__patch__</span>()  <span class="hljs-comment">// 创建/更新真实DOM</span>
    ↓
<span class="hljs-built_in">popTarget</span>()  <span class="hljs-comment">// 结束依赖收集</span>
    ↓
<span class="hljs-built_in">callHook</span>(vm, 'mounted')  <span class="hljs-comment">// 挂载完成</span>
</code></pre>
<h4 data-id="heading-37">4.4.4. 渲染Watcher</h4>
<h5 data-id="heading-38">4.4.4.1. Watcher的核心职责</h5>
<ol>
<li>解析表达式：处理计算属性和监听器</li>
<li>收集依赖：建立视图与数据的关联</li>
<li>触发回调：数据变化时执行更新</li>
</ol>
<h5 data-id="heading-39">4.4.4.2. 首次渲染的执行流程</h5>
<h6 data-id="heading-40">4.4.4.2.1. 触发时机</h6>
<p>在<code>mountComponent</code>时创建Watcher时，<code>Watcher.get()</code>会同步执行，立即触发首次渲染</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mountComponent</span> (<span class="hljs-params">vm, el, hydrating</span>) 
  ...
  <span class="hljs-title">new</span> <span class="hljs-title">Watcher</span>(<span class="hljs-params">vm, updateComponent, noop, {
    before (<span class="hljs-params"/>) {
      <span class="hljs-keyword">if</span> (<span class="hljs-params">vm._isMounted &amp;&amp; !vm._isDestroyed</span>) {
        callHook(<span class="hljs-params">vm, <span class="hljs-string">'beforeUpdate'</span></span>)
      }
    }
  }, <span class="hljs-literal">true</span> <span class="hljs-comment">/* isRenderWatcher */</span></span>)
  ...
}
</span></code></pre>
<h6 data-id="heading-41">4.4.4.2.2. <strong>执行流程</strong></h6>
<p>🚂 <code>src/core/observer/watcher.js</code></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 💡 Watcher构造函数中的关键逻辑</span>
<span class="hljs-keyword">constructor</span>(vm, expOrFn, ...){
  <span class="hljs-keyword">this</span>.vm = vm    <span class="hljs-comment">// 保存组件引用</span>

  <span class="hljs-comment">// 如果是render watcher，记录到vm上</span>
  <span class="hljs-keyword">if</span> (isRenderWatcher) {
    vm._watcher = <span class="hljs-keyword">this</span>	<span class="hljs-comment">// 便于实例管理和调试</span>
  }
    ...

  <span class="hljs-comment">// 处理getter 保存更新函数</span>
  <span class="hljs-keyword">if</span> (typeof expOrFn === <span class="hljs-string">'function'</span>) {
    <span class="hljs-comment">// 如果传入的参数2=&gt;expOrFn是函数，则表示它是组件的更新函数</span>
    <span class="hljs-comment">// 即updateComponent</span>
    <span class="hljs-keyword">this</span>.getter = expOrFn
  }<span class="hljs-keyword">else</span>{
    ...
  }

  <span class="hljs-keyword">this</span>.value = <span class="hljs-keyword">this</span>.<span class="hljs-keyword">get</span>()	<span class="hljs-comment">// 立即执行首次渲染</span>
}

<span class="hljs-comment">// 💡 依赖收集核心</span>
<span class="hljs-keyword">get</span>() {
  <span class="hljs-comment">// 设置当前Watcher实例为全局的依赖收集目标</span>
  pushTarget(<span class="hljs-keyword">this</span>)  <span class="hljs-comment">// 即Dep.target = this(当前Watcher)，在后续的属性访问中，相关的Dep就知道要收集哪个Watcher</span>
  let value
  <span class="hljs-keyword">const</span> vm = <span class="hljs-keyword">this</span>.vm
  <span class="hljs-keyword">try</span>{
    <span class="hljs-comment">// 触发getter，即updateComponent</span>
    value = <span class="hljs-keyword">this</span>.getter.call(vm, vm)    
  } <span class="hljs-keyword">finally</span> {
    popTarget()    <span class="hljs-comment">// 恢复上一个 Watcher</span>
    <span class="hljs-keyword">this</span>.cleanupDeps() <span class="hljs-comment">// 清理依赖</span>
  }
  <span class="hljs-keyword">return</span> value
}
</code></pre>
<h4 data-id="heading-42">4.4.5. 虚拟DOM的创建与处理</h4>
<h5 data-id="heading-43">4.4.5.1. 虚拟DOM的生成</h5>
<p><strong>核心方法：</strong> <code>_render()</code> 执行render函数并返回对应的vnode</p>
<p>🚂 <code>src/core/instance/render.js</code></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Vue</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">_render</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>): <span class="hljs-title class_">VNode</span> {
  <span class="hljs-comment">// 保存当前Vue实例的引用</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">vm</span>: <span class="hljs-title class_">Component</span> = <span class="hljs-variable language_">this</span>  
  <span class="hljs-comment">// 从实例配置中获取render方法和父组件的vnode（父组件创建的，代表当前组件的占位符vnode）</span>
  <span class="hljs-keyword">const</span> { render, _parentVnode } = vm.<span class="hljs-property">$options</span>  

  <span class="hljs-comment">// 设置父vnode，根实例为null</span>
  vm.<span class="hljs-property">$vnode</span> = _parentVnode
  
  <span class="hljs-comment">// 🔥 核心调用：执行渲染函数，生成当前组件的 VNode 树</span>
  <span class="hljs-keyword">let</span> vnode
  <span class="hljs-keyword">try</span> {
    vnode = render.<span class="hljs-title function_">call</span>(vm.<span class="hljs-property">_renderProxy</span>, vm.<span class="hljs-property">$createElement</span>)   
  } ...
  

  <span class="hljs-comment">// 设置父级关系，将当前VNode的parent指向_parentVnode，完善vnode树结构</span>
  vnode.<span class="hljs-property">parent</span> = _parentVnode 

  <span class="hljs-comment">// 返回最终生成的虚拟DOM节点</span>
  <span class="hljs-keyword">return</span> vnode  
}
</code></pre>
<p><strong>关键参数：</strong></p>
<ul>
<li><code>vm._renderProxy</code>执行上下文，开发环境有代理检查，生产环境即<code>vm</code></li>
<li><code>vm.$createElement</code></li>
</ul>

<ul>
<li>
<ul>
<li>创建vnode的函数</li>
<li><code>initRender()</code>时已经挂载到实例上的</li>
</ul>
</li>
</ul>
<h5 data-id="heading-44">4.4.5.2. createElement的设计</h5>
<p><strong>设计模式：外层包装+内层实现</strong></p>
<p>🚂 <code>src/core/vdom/create-element.js</code></p>
<ol>
<li><strong>外层：参数标准化和重载处理</strong></li>
</ol>

<pre><code class="hljs language-kotlin" lang="kotlin">export function createElement(context, tag, <span class="hljs-keyword">data</span>, children, ...) {
  <span class="hljs-comment">// 参数重载：支持多种调用方式</span>
  <span class="hljs-keyword">if</span> (Array.isArray(<span class="hljs-keyword">data</span>) || isPrimitive(<span class="hljs-keyword">data</span>)) {
    <span class="hljs-comment">// h('div', ['hello']) → h('div', undefined, ['hello'])</span>
    normalizationType = children
    children = <span class="hljs-keyword">data</span>
    <span class="hljs-keyword">data</span> = undefined
  }
  
  <span class="hljs-comment">// 调用核心实现</span>
  <span class="hljs-keyword">return</span> _createElement(context, tag, <span class="hljs-keyword">data</span>, children, normalizationType)
}
</code></pre>
<p>2.  <strong>内层：vnode创建核心逻辑</strong></p>

<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 真正返回vnode的函数</span>
export function _createElement (context, tag, data, children, normalizationType) {

  <span class="hljs-comment">// 1. 子节点标准化</span>
  if (normalizationType === ALWAYS_NORMALIZE) {
    children = <span class="hljs-built_in">normalizeChildren</span>(children)
  }

  <span class="hljs-comment">// 2. 根据tag类型创建对应DOM</span>
  let vnode, ns
  if (typeof tag === 'string') {  
    <span class="hljs-comment">// 处理字符串标签（HTML 元素、组件、...）</span>
    if (config.isReservedTag(tag)) {
      <span class="hljs-comment">// 平台内置元素 div/p/...</span>
      vnode = new <span class="hljs-built_in">VNode</span>(config.parsePlatformTagName(tag), data, children,undefined, undefined, context)
    } else if ((!data || !data.pre) &amp;&amp; <span class="hljs-built_in">isDef</span>(Ctor = resolveAsset(context.$options, 'components', tag))) {
      <span class="hljs-comment">// 已注册的组件，创建组件占位符vnode</span>
      vnode = <span class="hljs-built_in">createComponent</span>(Ctor, data, context, children, tag)
    } else {
      <span class="hljs-comment">// 未知标签或命名空间元素</span>
      vnode = new <span class="hljs-built_in">VNode</span>(tag, data, children,undefined, undefined, context)
    }
  } else {
    <span class="hljs-comment">// 组件选项/构造函数 </span>
    vnode = <span class="hljs-built_in">createComponent</span>(tag, data, context, children)
  }

  return vnode
}
</code></pre>
<h5 data-id="heading-45">4.4.5.3. <code>createComponent</code>：组件占位符的创建</h5>
<p>在执行<code>_createElement</code>的过程中，当识别到一个组件时（已注册的组件名或直接传入的组件选项/构造函数），会调用<code>createComponent</code>创建组件占位符vnode。</p>
<p>❗️注意：<code>createComponent</code>只负责创建一个代表该组件的占位符vnode，而不是立即实例化组件本身。</p>
<h6 data-id="heading-46">4.4.5.3.1. 设计思想</h6>
<p><strong>延迟渲染&amp;性能优化</strong></p>
<ul>
<li><strong>懒加载</strong>：组件占位符vnode只包含元数据（构造函数/Props/...）。真正的组件实例化、渲染还有挂载被延迟到后续的patch阶段才执行</li>
<li><strong>性能优化：</strong> 这种组件级懒渲染方式带了巨大的性能优势，🌰 对于<code>v-if="false"</code>的组件，Vue在首次渲染的时候只需创建一个轻量的占位符vnode，完全跳过内部复杂的实例化、渲染和DOM操作流程</li>
<li><strong>支持异步组件</strong></li>
</ul>
<h6 data-id="heading-47">4.4.5.3.2. 主要逻辑</h6>
<p>🚂 <code>src/core/vdom/create-component.js</code></p>
<pre><code class="hljs language-scss" lang="scss">export function <span class="hljs-built_in">createComponent</span>(Ctor, data, context, children, tag) {

  <span class="hljs-comment">// 确保Ctor是构造函数</span>
  const baseCtor = context.<span class="hljs-variable">$options</span><span class="hljs-selector-class">._base</span> <span class="hljs-comment">// 获取Vue构造函数</span>
  if (isObject(Ctor)) {
    <span class="hljs-comment">// 如果传入的是组件选项对象，则转换为构造函数</span>
    Ctor = baseCtor<span class="hljs-selector-class">.extend</span>(Ctor)
  }

  ...

  <span class="hljs-comment">// 将组件的生命周期逻辑（init, prepatch等）以钩子函数的形式挂载到 vnode.data.hook上</span>
  <span class="hljs-comment">// 在后续的 patch过程中，当处理到这个组件 VNode 时，会调用相应的钩子（如 init）来真正创建组件实例</span>
  <span class="hljs-built_in">installComponentHooks</span>(data)
  
  <span class="hljs-comment">// 创建组件占位符vnode</span>
  const vnode = new <span class="hljs-built_in">VNode</span>(...)
  
  return vnode
}
</code></pre>
<h6 data-id="heading-48">4.4.5.3.3. 组件占位符vnode结构</h6>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-comment">// 基本 VNode 属性</span>
  <span class="hljs-attr">tag</span>: <span class="hljs-string">'vue-component-1-comp'</span>, <span class="hljs-comment">// Vue 内部生成的唯一标识符</span>
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">hook</span>: { <span class="hljs-comment">// 🔥 核心！存放组件生命周期的钩子函数，将在 patch 阶段被触发</span>
      <span class="hljs-attr">init</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">vnode</span>) { ... },    <span class="hljs-comment">// 初始化组件实例</span>
      <span class="hljs-attr">prepatch</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">oldVnode, vnode</span>) { ... }, <span class="hljs-comment">// 更新前</span>
      <span class="hljs-attr">insert</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">vnode</span>) { ... }, <span class="hljs-comment">// 插入 DOM 后</span>
      <span class="hljs-attr">destroy</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">vnode</span>) { ... }  <span class="hljs-comment">// 销毁时</span>
    }
  },
  <span class="hljs-attr">children</span>: <span class="hljs-literal">undefined</span>, <span class="hljs-comment">// ❗ 注意：子节点（元素内容）不在这里</span>
  <span class="hljs-attr">elm</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 对应的真实 DOM 元素（此时尚未创建）</span>

  <span class="hljs-comment">// 组件特有属性</span>
  <span class="hljs-attr">componentOptions</span>: { <span class="hljs-comment">// 🔥 组件的“配置包”，包含了实例化所需的一切信息</span>
    <span class="hljs-title class_">Ctor</span>: <span class="hljs-keyword">function</span> <span class="hljs-title function_">VueComponent</span>(<span class="hljs-params">options</span>) { ... }, <span class="hljs-comment">// 组件构造函数</span>
    <span class="hljs-attr">propsData</span>: { <span class="hljs-attr">msg</span>: <span class="hljs-string">'hello'</span> }, <span class="hljs-comment">// 从 data 中提取出的 props 值</span>
    <span class="hljs-attr">listeners</span>: { <span class="hljs-string">'custom-event'</span>: handler }, <span class="hljs-comment">// 父组件监听的事件</span>
    <span class="hljs-attr">tag</span>: <span class="hljs-string">'comp'</span>, <span class="hljs-comment">// 原始标签名</span>
    <span class="hljs-attr">children</span>: [<span class="hljs-comment">/* 插槽内容的 VNode 数组 */</span>] <span class="hljs-comment">// ❗ 子节点（插槽内容）在这里</span>
  },
  <span class="hljs-attr">componentInstance</span>: <span class="hljs-literal">undefined</span> <span class="hljs-comment">// ❗ 关键：此时组件实例还不存在！</span>
}
</code></pre>
<p><strong>关键点说明：</strong></p>
<ol>
<li><code>componentOptions</code><strong>对象：</strong> 一个信息聚合包，包含了创建和配置组件实例所需要的全部数据，方便在patch阶段一次性使用</li>
<li><strong>children的存放位置：</strong> 对于组件vnode，其模板内的子内容（即默认插槽内容）不是作为vnode的直接子节点（vnode.children），而是放在<code>vnode.componentOptions.children</code>中</li>
</ol>
<h5 data-id="heading-49">4.4.5.4. vnode的创建顺序</h5>
<p><strong>深度优先</strong></p>
<p><strong>执行render函数时的调用栈推进过程：</strong></p>
<pre><code class="hljs language-scss" lang="scss">调用栈深度：
<span class="hljs-built_in">anonymous</span>() 开始
  ↓
准备执行 <span class="hljs-built_in">_c</span>('div', ...)
  ↓ 需要先计算子节点数组
计算第一个数组元素：<span class="hljs-built_in">_c</span>('h1', ...)
  ↓ 需要先计算<span class="hljs-selector-tag">h1</span>的子节点
计算 <span class="hljs-built_in">_v</span>("组件化机制")  ← 最先执行完成！
  ↓
<span class="hljs-built_in">_c</span>('h1', ...) 执行完成
  ↓
计算第二个数组元素：<span class="hljs-built_in">_c</span>('comp')
  ↓
<span class="hljs-built_in">_c</span>('comp') 执行完成  
  ↓
现在所有子节点就绪，执行 <span class="hljs-built_in">_c</span>('div', ...)
  ↓
<span class="hljs-built_in">anonymous</span>() 返回结果
</code></pre>
<h5 data-id="heading-50">4.4.5.5. <strong>生成的vnode的大致结构：</strong></h5>
<pre><code class="hljs language-yaml" lang="yaml">{
  <span class="hljs-attr">tag:</span> <span class="hljs-string">'div'</span>,
  <span class="hljs-attr">data:</span> { <span class="hljs-attr">attrs:</span> { <span class="hljs-attr">id:</span> <span class="hljs-string">'app'</span> } },
  <span class="hljs-attr">children:</span> [
    {
      <span class="hljs-attr">tag:</span> <span class="hljs-string">'h1'</span>,
      <span class="hljs-attr">children:</span> [
        { <span class="hljs-attr">tag:</span> <span class="hljs-string">undefined</span>, <span class="hljs-attr">text:</span> <span class="hljs-string">'组件化机制'</span>, <span class="hljs-attr">isComment:</span> <span class="hljs-literal">false</span> }
      ],
      <span class="hljs-attr">elm:</span> <span class="hljs-string">undefined</span>,
      <span class="hljs-attr">context:</span> <span class="hljs-string">vm</span>
    },
    { <span class="hljs-attr">tag:</span> <span class="hljs-string">undefined</span>, <span class="hljs-attr">text:</span> <span class="hljs-string">' '</span>, <span class="hljs-attr">isComment:</span> <span class="hljs-literal">false</span> },
    {
      <span class="hljs-attr">tag:</span> <span class="hljs-string">'p'</span>,
      <span class="hljs-attr">children:</span> [
        { <span class="hljs-attr">tag:</span> <span class="hljs-string">undefined</span>, <span class="hljs-attr">text:</span> <span class="hljs-string">"hello vue"</span>, <span class="hljs-attr">isComment:</span> <span class="hljs-literal">false</span> }
      ],
      <span class="hljs-attr">elm:</span> <span class="hljs-string">undefined</span>,
      <span class="hljs-attr">context:</span> <span class="hljs-string">vm</span>
    },
    { <span class="hljs-attr">tag:</span> <span class="hljs-string">undefined</span>, <span class="hljs-attr">text:</span> <span class="hljs-string">' '</span>, <span class="hljs-attr">isComment:</span> <span class="hljs-literal">false</span> },
    {
      <span class="hljs-attr">tag:</span> <span class="hljs-string">'vue-component-1-comp'</span>,
      <span class="hljs-attr">componentOptions:</span> {
        <span class="hljs-attr">Ctor:</span> <span class="hljs-string">CompConstructor</span>,
        <span class="hljs-attr">propsData:</span> <span class="hljs-string">undefined</span>,
        <span class="hljs-attr">tag:</span> <span class="hljs-string">'comp'</span>
      },
      <span class="hljs-attr">data:</span> {
        <span class="hljs-attr">hook:</span> { <span class="hljs-string">/*</span> <span class="hljs-string">组件生命周期钩子</span> <span class="hljs-string">*/</span> }
      },
      <span class="hljs-attr">elm:</span> <span class="hljs-string">undefined</span>,
      <span class="hljs-attr">context:</span> <span class="hljs-string">vm</span>
    }
  ],
  <span class="hljs-attr">elm:</span> <span class="hljs-string">undefined</span>,
  <span class="hljs-attr">context:</span> <span class="hljs-string">vm</span>,
  <span class="hljs-attr">parent:</span> <span class="hljs-string">undefined</span>
}
</code></pre>
<h4 data-id="heading-51">4.4.6. Patch过程：从虚拟DOM到真实DOM</h4>
<h5 data-id="heading-52">4.4.6.1. Patch的触发</h5>
<p>在<code>_update</code>中，会根据是否首次渲染，选择不同的patch策略</p>
<p>🚂 <code>src/core/instance/lifecycle.js</code></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">Vue.prototype._update</span> = function (vnode, hydrating) {
  const <span class="hljs-attr">vm</span> = this
  const <span class="hljs-attr">prevVnode</span> = vm._vnode	// 之前渲染的vnode
  
  if (!prevVnode) {
    // 首次渲染
    vm.$<span class="hljs-attr">el</span> = vm.__patch__(vm.<span class="hljs-variable">$el</span>, vnode, hydrating, <span class="hljs-literal">false</span>)
  } else {
    // 更新渲染（diff算法）
    vm.$<span class="hljs-attr">el</span> = vm.__patch__(prevVnode, vnode)
  }
}
</code></pre>
<h5 data-id="heading-53">4.4.6.2. Patch函数的创建</h5>
<p>🚂 <code>src/platforms/web/runtime/patch.js</code></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 工厂模式，创建平台专用的 patch 函数</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">patch</span>: <span class="hljs-title class_">Function</span> = <span class="hljs-title function_">createPatchFunction</span>({ nodeOps, modules })
</code></pre>
<p><code>createPatchFunction</code>一个工厂函数</p>
<ul>
<li>输入：平台特有的节点操作和属性操作</li>
</ul>

<ul>
<li>
<ul>
<li>nodeOps：封装了平台对应的各种原生DOM的基础操作方法</li>
<li>modules：处理属性、样式、事件等平台相关逻辑</li>
</ul>
</li>
</ul>

<ul>
<li>输出：一个平台专有的patch函数并返回</li>
</ul>
<p><strong>💡</strong> <strong>核心算法复用，平台特性隔离</strong></p>
<h5 data-id="heading-54">4.4.6.3. <strong>Patch核心流程</strong></h5>
<p>🚂 <code>src/core/vdom/patch.js</code></p>
<p><strong>主要处理三个场景：</strong></p>
<ol>
<li>
<p><strong>新节点不存在 =&gt; 销毁旧节点</strong>(组件被条件渲染移除 v-if="false")</p>
<pre><code class="hljs language-scss" lang="scss">if (isUndef(vnode)) {
  if (isDef(oldVnode)) <span class="hljs-built_in">invokeDestroyHook</span>(oldVnode)
  return
}
</code></pre>
</li>
<li>
<p><strong>旧节点不存在 =&gt; 全新挂载</strong>（动态组件首次渲染/服务端渲染激活）</p>
<pre><code class="hljs language-scss" lang="scss">if (isUndef(oldVnode)) {
  isInitialPatch = true
  <span class="hljs-built_in">createElm</span>(vnode, insertedVnodeQueue)  <span class="hljs-comment">// 直接创建新DOM树</span>
}
</code></pre>
</li>
<li>
<p><strong>新旧都存在 =&gt; 精细化更新</strong></p>
<p>在首次渲染根节点时，走的就是这里</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 检查是否是真实DOM元素（首次挂载时 oldVnode 是真实的 div#app）</span>
const isRealElement = <span class="hljs-built_in">isDef</span>(oldVnode.nodeType)

if (!isRealElement &amp;&amp; sameVnode(oldVnode, vnode)) {
  <span class="hljs-comment">// 可复用的虚拟节点 → 精细化diff</span>
  <span class="hljs-built_in">patchVnode</span>(oldVnode, vnode, insertedVnodeQueue, null, null, removeOnly)
} else {
  <span class="hljs-comment">// 真实DOM或不可复用 → 替换操作</span>
  if (isRealElement) {	<span class="hljs-comment">// 根组件挂载</span>
    <span class="hljs-comment">// 首次挂载，标准化为vnode</span>
    oldVnode = <span class="hljs-built_in">emptyNodeAt</span>(oldVnode)
  }

  const oldElm = oldVnode<span class="hljs-selector-class">.elm</span>   <span class="hljs-comment">// 获取宿主元素</span>
  const parentElm = nodeOps<span class="hljs-selector-class">.parentNode</span>(oldElm)  <span class="hljs-comment">// 获取宿主元素父元素 🌰body</span>


  <span class="hljs-comment">// 关键：创建新DOM树，将它追加到parentElm里面，oldElm旁边</span>
  <span class="hljs-built_in">createElm</span>(
    vnode,                    // 新虚拟节点
    insertedVnodeQueue,       // 插入回调队列
    parentElm,                // 父容器（body）
    nodeOps.nextSibling(oldElm) <span class="hljs-comment">// 参考位置：旧节点的下一个兄弟节点前</span>
  )

  <span class="hljs-comment">// 销毁旧节点</span>
  if (isDef(parentElm)) {
    <span class="hljs-built_in">removeVnodes</span>(parentElm, [oldVnode], <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)
  }
}
</code></pre>
</li>
</ol>
<h5 data-id="heading-55">4.4.6.4. <code>createElm() </code>：DOM创建的核心</h5>
<p><strong>从虚拟DOM到真实DOM的转换器</strong></p>
<h6 data-id="heading-56">4.4.6.4.1. <strong>核心逻辑</strong></h6>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">createElm</span>(vnode, insertedVnodeQueue, parentElm, refElm, nested) {
  <span class="hljs-comment">// 优先尝试作为组件创建</span>
  if (createComponent(vnode, insertedVnodeQueue, parentElm, refElm)) {
    return	<span class="hljs-comment">// 如果是组件，创建成功直接返回，不是组件则继续普通元素创建流程</span>
  }

  const data = vnode<span class="hljs-selector-class">.data</span>
  const children = vnode<span class="hljs-selector-class">.children</span>
  const tag = vnode<span class="hljs-selector-class">.tag</span>

  <span class="hljs-comment">// 按元素类型分派处理</span>
  if (isDef(tag)) {
    <span class="hljs-comment">// 1. 元素节点：创建对应HTML标签</span>
    vnode<span class="hljs-selector-class">.elm</span> = vnode<span class="hljs-selector-class">.ns</span> 
      ? nodeOps<span class="hljs-selector-class">.createElementNS</span>(vnode.ns, tag)  <span class="hljs-comment">// 命名空间元素</span>
      : nodeOps.<span class="hljs-built_in">createElement</span>(tag, vnode)       // 普通元素
    
    // 递归创建子节点（深度优先）
    <span class="hljs-built_in">createChildren</span>(vnode, children, insertedVnodeQueue)
    
    // 处理属性、样式、事件等
    if (<span class="hljs-built_in">isDef</span>(data)) {
      <span class="hljs-built_in">invokeCreateHooks</span>(vnode, insertedVnodeQueue)
    }
    
    <span class="hljs-comment">// 插入到DOM</span>
    <span class="hljs-built_in">insert</span>(parentElm, vnode.elm, refElm)
    
  } else if (isTrue(vnode.isComment)) {
    <span class="hljs-comment">// 2. 注释节点</span>
    vnode<span class="hljs-selector-class">.elm</span> = nodeOps<span class="hljs-selector-class">.createComment</span>(vnode.text)
    <span class="hljs-built_in">insert</span>(parentElm, vnode.elm, refElm)
    
  } else {
    <span class="hljs-comment">// 3. 文本节点</span>
    vnode<span class="hljs-selector-class">.elm</span> = nodeOps<span class="hljs-selector-class">.createTextNode</span>(vnode.text)
    <span class="hljs-built_in">insert</span>(parentElm, vnode.elm, refElm)
  }
}
</code></pre>
<h6 data-id="heading-57">4.4.6.4.2. <code>createChildren</code></h6>
<p><strong>递归创建子节点，深度优先遍历</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createChildren</span>(<span class="hljs-params">vnode, children, insertedVnodeQueue</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(children)) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; children.<span class="hljs-property">length</span>; ++i) {
      <span class="hljs-comment">// 对每个子节点递归调用 createElm</span>
      <span class="hljs-title function_">createElm</span>(children[i], insertedVnodeQueue, vnode.<span class="hljs-property">elm</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">true</span>)
    }
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isPrimitive</span>(vnode.<span class="hljs-property">text</span>)) {
    <span class="hljs-comment">// 文本内容直接创建文本节点</span>
    nodeOps.<span class="hljs-title function_">appendChild</span>(vnode.<span class="hljs-property">elm</span>, nodeOps.<span class="hljs-title function_">createTextNode</span>(<span class="hljs-title class_">String</span>(vnode.<span class="hljs-property">text</span>)))
  }
}
</code></pre>
<h6 data-id="heading-58">4.4.6.4.3. <strong>当前示例的执行顺序</strong></h6>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">createElm</span>(div#app)
    ↓
createChildren → 遍历<span class="hljs-number">5</span>个子节点
    ↓
<span class="hljs-built_in">createElm</span>(h1) → 创建<span class="hljs-selector-tag">h1</span>元素 → createChildren → 创建文本节点"组件化机制"
    ↓
<span class="hljs-built_in">createElm</span>(文本节点 "\n    ")
    ↓
<span class="hljs-built_in">createElm</span>(p) → 创建<span class="hljs-selector-tag">p</span>元素 → createChildren → 创建动态文本节点
    ↓
<span class="hljs-built_in">createElm</span>(文本节点 "\n    ")  
    ↓
<span class="hljs-built_in">createElm</span>(comp组件) → 触发组件创建逻辑
</code></pre>
<h5 data-id="heading-59">4.4.6.5. <code>createComponent()</code>组件创建的特殊处理</h5>
<p><code>createElm</code>中，会调用<code>createComponent</code>，将vnode优先尝试作为组件创建</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">createComponent</span>(vnode, insertedVnodeQueue, parentElm, refElm) {
  let <span class="hljs-selector-tag">i</span> = vnode<span class="hljs-selector-class">.data</span>
  if (isDef(i)) {
    <span class="hljs-comment">// 检查是否有init钩子（组件标识，只有组件节点的data属性中会有hook属性）</span>
    if (isDef(i = i.hook) &amp;&amp; <span class="hljs-built_in">isDef</span>(i = i.init)) {
      <span class="hljs-comment">// 执行组件初始化钩子</span>
      <span class="hljs-selector-tag">i</span>(vnode, false /* hydrating */)
    }
    
    <span class="hljs-comment">// 如果组件实例创建成功 =&gt; 调用组件的init钩子后，vnode中才会有组件实例，所以可以用vnode.componentInstance来判断组件实例是否创建成功</span>
    if (isDef(vnode.componentInstance)) {
      <span class="hljs-comment">// 初始化组件DOM</span>
      <span class="hljs-built_in">initComponent</span>(vnode, insertedVnodeQueue)
      <span class="hljs-comment">// 插入到父容器</span>
      <span class="hljs-built_in">insert</span>(parentElm, vnode.elm, refElm)
      return true  <span class="hljs-comment">// 返回true，表示已作为组件处理</span>
    }
  }
  return false
}
</code></pre>
<h6 data-id="heading-60">4.4.6.5.1. <strong>组件init钩子的作用</strong></h6>
<p>🚂 <code>src/core/vdom/create-component.js</code></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">init</span>(<span class="hljs-params">vnode, hydrating</span>) {
  <span class="hljs-keyword">if</span> (vnode.<span class="hljs-property">componentInstance</span> &amp;&amp; vnode.<span class="hljs-property">data</span>.<span class="hljs-property">keepAlive</span>) {
    <span class="hljs-comment">// keep-alive组件复用逻辑</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 创建组件实例</span>
    <span class="hljs-keyword">const</span> child = vnode.<span class="hljs-property">componentInstance</span> = <span class="hljs-title function_">createComponentInstanceForVnode</span>(
      vnode,
      activeInstance  <span class="hljs-comment">// 当前激活的组件实例</span>
    )
    
    <span class="hljs-comment">// 子组件递归挂载（重要！）</span>
    child.$mount(hydrating ? vnode.<span class="hljs-property">elm</span> : <span class="hljs-literal">undefined</span>, hydrating)
  }
}
</code></pre>
<h6 data-id="heading-61">4.4.6.5.2. <strong>组件从render到patch的完整过程</strong></h6>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-number">1</span>. 渲染阶段 (_render)
  父组件 <span class="hljs-built_in">_render</span>()
      ↓
  遇到 &lt;comp&gt;&lt;/comp&gt;，调用 <span class="hljs-built_in">_createElement</span>('comp', ...)
      ↓
  识别为组件，调用 <span class="hljs-built_in">createComponent</span>(...)
      ↓
  返回一个轻量的【组件占位符 VNode】（包含 Ctor, props, hooks 等元数据）
      ↓
  父组件 VNode 树生成完毕

<span class="hljs-number">2</span>. 补丁阶段 (patch)
  patch 过程遍历到组件占位符 VNode
      ↓
  调用 vnode<span class="hljs-selector-class">.data</span><span class="hljs-selector-class">.hook</span><span class="hljs-selector-class">.init</span>(vnode) 钩子
      ↓
  在 init 钩子中：const child = vnode<span class="hljs-selector-class">.componentInstance</span> = new <span class="hljs-built_in">Ctor</span>(...)
      ↓
  子组件开始自己的生命周期：child.<span class="hljs-variable">$mount</span>() -&gt; <span class="hljs-built_in">_init</span>() -&gt; <span class="hljs-built_in">_render</span>() -&gt; <span class="hljs-built_in">patch</span>()
      ↓
  此时才真正创建子组件的实例和 DOM 树
</code></pre>
<h5 data-id="heading-62">4.4.6.6. Diff算法核心</h5>
<h6 data-id="heading-63">4.4.6.6.1. <code>patchVnode() </code>中的Diff入口</h6>
<p>在Patch的过程中，当判断到新旧vnode可复用时，会调用<code>patchVnode()</code>方法，进行<strong>精细化更新</strong></p>
<p><strong>核心逻辑：</strong> 首先进行树级别比较</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c61e5e58520a40ffbbd5fcb2c65b940a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YaN5ZCD5LiA6aKX6Iu55p6c6KaB5LiN6KaB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763538924&amp;x-signature=hYhhhQ0Na7iV2QGNdUe8myztCq8%3D" alt="" loading="lazy"/></p>
<p><strong>三种情况：</strong></p>
<ol>
<li>新vnode不存在 =&gt; 删</li>
<li>旧vnode不存在 =&gt; 增</li>
<li>都存在 =&gt; diff</li>
</ol>
<p><strong>具体规则：</strong></p>
<ol>
<li>新老节点均有children，则对子节点diff，调用updateChildern</li>
<li>新节点有children而老节点没有，先清空老节点文本，再新增子节点</li>
<li>新节点没有children而老节点有，移除该节点的所有子节点</li>
<li>新老节点都没有children，文本替换</li>
</ol>

<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 获取双方子元素</span>
const oldCh = oldVnode<span class="hljs-selector-class">.children</span>
const ch = vnode<span class="hljs-selector-class">.children</span>

if (isUndef(vnode.text)) { 
  <span class="hljs-comment">// 非文本节点</span>
  if (isDef(oldCh) &amp;&amp; <span class="hljs-built_in">isDef</span>(ch)) {  
    <span class="hljs-comment">// 新旧节点都有子节点</span>
    <span class="hljs-comment">// 触发updateChildren进行对比</span>
    if (oldCh !== ch) <span class="hljs-built_in">updateChildren</span>(elm, oldCh, ch, insertedVnodeQueue, removeOnly)
  } else if (isDef(ch)) { 
    <span class="hljs-comment">// 只有新节点有子节点</span>
    <span class="hljs-comment">// 如果旧节点有文本则清空</span>
    if (isDef(oldVnode.text)) nodeOps<span class="hljs-selector-class">.setTextContent</span>(elm, '')
    <span class="hljs-comment">// 添加新节点</span>
    <span class="hljs-built_in">addVnodes</span>(elm, null, ch, <span class="hljs-number">0</span>, ch.length - <span class="hljs-number">1</span>, insertedVnodeQueue)
  } else if (isDef(oldCh)) {  
    <span class="hljs-comment">// 只有旧节点有子节点，直接移除</span>
    <span class="hljs-built_in">removeVnodes</span>(oldCh, <span class="hljs-number">0</span>, oldCh.length - <span class="hljs-number">1</span>) 
  } else if (isDef(oldVnode.text)) {  
    <span class="hljs-comment">// 旧节点有文本内容，直接清空</span>
    nodeOps<span class="hljs-selector-class">.setTextContent</span>(elm, '')
  }
} else if (oldVnode.text !== vnode.text) {
  <span class="hljs-comment">// 文本节点，直接更新文本</span>
  nodeOps<span class="hljs-selector-class">.setTextContent</span>(elm, vnode.text)
}

if (isDef(data)) {
  <span class="hljs-comment">// 触发postpatch钩子</span>
  if (isDef(i = data.hook) &amp;&amp; <span class="hljs-built_in">isDef</span>(i = i.postpatch)) <span class="hljs-selector-tag">i</span>(oldVnode, vnode)
}
</code></pre>
<h6 data-id="heading-64">4.4.6.6.2. <code>updateChildren() </code><strong>：Diff算法的核心实现</strong></h6>
<h6 data-id="heading-65">4.4.6.6.2.1. <strong>核心逻辑：</strong></h6>
<p><strong>双指针&amp;同层比较</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff06648bbd6f4f99a199f662fa7bd278~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YaN5ZCD5LiA6aKX6Iu55p6c6KaB5LiN6KaB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763538924&amp;x-signature=5H88%2FwCmEjQW4lFVOps5rM1ZLPw%3D" alt="" loading="lazy"/></p>
<p>新老两组VNode节点的左右头尾两侧都有一个变量标记，在遍历过程中这几个变量都会向中间靠拢，<code>oldStartIdx &gt; oldEndIdx</code>或<code>newStartIdx &gt; newEndIdx</code>时结束循环</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">updateChildren</span>(parentElm, oldCh, newCh, insertedVnodeQueue, removeOnly) {
  <span class="hljs-comment">// 初始化指针</span>
  let oldStartIdx = <span class="hljs-number">0</span>
  let newStartIdx = <span class="hljs-number">0</span>
  let oldEndIdx = oldCh<span class="hljs-selector-class">.length</span> - <span class="hljs-number">1</span>
  let oldStartVnode = oldCh<span class="hljs-selector-attr">[0]</span>
  let oldEndVnode = oldCh<span class="hljs-selector-attr">[oldEndIdx]</span>
  let newEndIdx = newCh<span class="hljs-selector-class">.length</span> - <span class="hljs-number">1</span>
  let newStartVnode = newCh<span class="hljs-selector-attr">[0]</span>
  let newEndVnode = newCh<span class="hljs-selector-attr">[newEndIdx]</span>
  
  let oldKeyToIdx, idxInOld, vnodeToMove, refElm

  <span class="hljs-comment">// 双端比较循环</span>
  while (oldStartIdx &lt;= oldEndIdx &amp;&amp; newStartIdx &lt;= newEndIdx) {
    if (isUndef(oldStartVnode)) {
      <span class="hljs-comment">// 旧开始节点为空，跳过</span>
      oldStartVnode = oldCh<span class="hljs-selector-attr">[++oldStartIdx]</span>
    } else if (isUndef(oldEndVnode)) {
      <span class="hljs-comment">// 旧结束节点为空，跳过</span>
      oldEndVnode = oldCh<span class="hljs-selector-attr">[--oldEndIdx]</span>
    } 
    <span class="hljs-comment">// 1. 头头相同 - 直接 patch</span>
    else if (sameVnode(oldStartVnode, newStartVnode)) {
      <span class="hljs-built_in">patchVnode</span>(oldStartVnode, newStartVnode, insertedVnodeQueue)
      oldStartVnode = oldCh<span class="hljs-selector-attr">[++oldStartIdx]</span>
      newStartVnode = newCh<span class="hljs-selector-attr">[++newStartIdx]</span>
    } 
    <span class="hljs-comment">// 2. 尾尾相同 - 直接 patch</span>
    else if (sameVnode(oldEndVnode, newEndVnode)) {
      <span class="hljs-built_in">patchVnode</span>(oldEndVnode, newEndVnode, insertedVnodeQueue)
      oldEndVnode = oldCh<span class="hljs-selector-attr">[--oldEndIdx]</span>
      newEndVnode = newCh<span class="hljs-selector-attr">[--newEndIdx]</span>
    } 
    <span class="hljs-comment">// 3. 头尾相同 - patch 后移动到末尾</span>
    else if (sameVnode(oldStartVnode, newEndVnode)) {
      <span class="hljs-built_in">patchVnode</span>(oldStartVnode, newEndVnode, insertedVnodeQueue)
      <span class="hljs-comment">// 将节点移动到旧列表末尾之后</span>
      nodeOps<span class="hljs-selector-class">.insertBefore</span>(parentElm, oldStartVnode.elm, nodeOps.nextSibling(oldEndVnode.elm))
      oldStartVnode = oldCh<span class="hljs-selector-attr">[++oldStartIdx]</span>
      newEndVnode = newCh<span class="hljs-selector-attr">[--newEndIdx]</span>
    } 
    <span class="hljs-comment">// 4. 尾头相同 - patch 后移动到开头</span>
    else if (sameVnode(oldEndVnode, newStartVnode)) {
      <span class="hljs-built_in">patchVnode</span>(oldEndVnode, newStartVnode, insertedVnodeQueue)
      <span class="hljs-comment">// 将节点移动到旧列表开头之前</span>
      nodeOps<span class="hljs-selector-class">.insertBefore</span>(parentElm, oldEndVnode.elm, oldStartVnode.elm)
      oldEndVnode = oldCh<span class="hljs-selector-attr">[--oldEndIdx]</span>
      newStartVnode = newCh<span class="hljs-selector-attr">[++newStartIdx]</span>
    } 
    <span class="hljs-comment">// 5. 四种情况都不匹配 - 使用 key 映射查找</span>
    else {
      <span class="hljs-comment">// 创建旧节点的 key 到 index 的映射</span>
      if (isUndef(oldKeyToIdx)) {
        oldKeyToIdx = <span class="hljs-built_in">createKeyToOldIdx</span>(oldCh, oldStartIdx, oldEndIdx)
      }
      
      <span class="hljs-comment">// 根据新节点的 key 查找在旧列表中的位置</span>
      idxInOld = <span class="hljs-built_in">isDef</span>(newStartVnode.key) 
        ? oldKeyToIdx<span class="hljs-selector-attr">[newStartVnode.key]</span>
        : <span class="hljs-built_in">findIdxInOld</span>(newStartVnode, oldCh, oldStartIdx, oldEndIdx)
      
      if (<span class="hljs-built_in">isUndef</span>(idxInOld)) {
        <span class="hljs-comment">// 新节点 - 创建并插入</span>
        <span class="hljs-built_in">createElm</span>(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.elm)
      } else {
        <span class="hljs-comment">// 找到可复用的节点</span>
        vnodeToMove = oldCh<span class="hljs-selector-attr">[idxInOld]</span>
        if (sameVnode(vnodeToMove, newStartVnode)) {
          <span class="hljs-built_in">patchVnode</span>(vnodeToMove, newStartVnode, insertedVnodeQueue)
          oldCh<span class="hljs-selector-attr">[idxInOld]</span> = undefined <span class="hljs-comment">// 标记为已处理</span>
          <span class="hljs-comment">// 移动到当前位置</span>
          nodeOps<span class="hljs-selector-class">.insertBefore</span>(parentElm, vnodeToMove.elm, oldStartVnode.elm)
        } else {
          <span class="hljs-comment">// 相同 key 但不同元素 - 创建新节点</span>
          <span class="hljs-built_in">createElm</span>(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.elm)
        }
      }
      newStartVnode = newCh<span class="hljs-selector-attr">[++newStartIdx]</span>
    }
  }

  <span class="hljs-comment">// 处理剩余节点</span>
  if (oldStartIdx &gt; oldEndIdx) {
    <span class="hljs-comment">// 旧节点遍历完 - 添加剩余的新节点</span>
    <span class="hljs-built_in">addVnodes</span>(parentElm, refElm, newCh, newStartIdx, newEndIdx, insertedVnodeQueue)
  } else if (newStartIdx &gt; newEndIdx) {
    <span class="hljs-comment">// 新节点遍历完 - 移除剩余的旧节点</span>
    <span class="hljs-built_in">removeVnodes</span>(parentElm, oldCh, oldStartIdx, oldEndIdx)
  }
}
</code></pre>
<h6 data-id="heading-66">4.4.6.6.2.2. Diff算法的四种比较策略</h6>
<ol>
<li><strong>头头</strong></li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7795103c496b40bb8b51ef6aeb82cf7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YaN5ZCD5LiA6aKX6Iu55p6c6KaB5LiN6KaB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763538924&amp;x-signature=%2BIrpaXcobejTup5FzHudfhY1HmY%3D" alt="" loading="lazy"/></p>
<ol start="2">
<li><strong>尾尾</strong></li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4af43ed30b9349459f7442a809322dcb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YaN5ZCD5LiA6aKX6Iu55p6c6KaB5LiN6KaB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763538924&amp;x-signature=eqS0UgqthQ0m0XUClprblaqQsaw%3D" alt="" loading="lazy"/></p>
<ol start="3">
<li><strong>头尾（节点移动）</strong></li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87a45695153d46baaffc1b437e81932b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YaN5ZCD5LiA6aKX6Iu55p6c6KaB5LiN6KaB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763538924&amp;x-signature=h%2FxinFjhd2wk4TheTGJEYWCXk%2FY%3D" alt="" loading="lazy"/></p>
<ol start="4">
<li><strong>尾头（节点移动）</strong></li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b8d757018d74932acf1ab5a99245594~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YaN5ZCD5LiA6aKX6Iu55p6c6KaB5LiN6KaB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763538924&amp;x-signature=XIB9aXKjHp0Y1fgW0%2FkdK6pzNJ0%3D" alt="" loading="lazy"/></p>
<h6 data-id="heading-67">4.4.6.6.2.3. key的重要性</h6>
<p><strong>有key的情况：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 旧列表</span>
[{key: <span class="hljs-string">'a'</span>, text: <span class="hljs-string">'A'</span>}, {key: <span class="hljs-string">'b'</span>, text: <span class="hljs-string">'B'</span>}, {key: <span class="hljs-string">'c'</span>, text: <span class="hljs-string">'C'</span>}]

<span class="hljs-comment">// 新列表  </span>
[{key: <span class="hljs-string">'c'</span>, text: <span class="hljs-string">'C'</span>}, {key: <span class="hljs-string">'a'</span>, text: <span class="hljs-string">'A'</span>}, {key: <span class="hljs-string">'b'</span>, text: <span class="hljs-string">'B'</span>}]

<span class="hljs-comment">// Diff 过程：通过 key 快速定位，只需移动节点，无需重新创建</span>
</code></pre>
<p><strong>无key的情况：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 旧列表</span>
[{text: <span class="hljs-string">'A'</span>}, {text: <span class="hljs-string">'B'</span>}, {text: <span class="hljs-string">'C'</span>}]

<span class="hljs-comment">// 新列表</span>
[{text: <span class="hljs-string">'C'</span>}, {text: <span class="hljs-string">'A'</span>}, {text: <span class="hljs-string">'B'</span>}]  

<span class="hljs-comment">// Diff 过程：只能按位置比较，误判为不同节点，导致不必要的重新创建</span>
</code></pre>
<p>key是Vue中用于优化diff算法的特殊属性，核心作用是为vnode提供一个唯一标识，帮助Vue更高效地识别哪些节点可以复用，从而最小化DOM操作，提升性能。</p>
<p>从源码层面来看：</p>
<p>首先key是用来判断是否相同节点的第一条件，只有当两个vnode的key和tag都相同时，vue才会认为它们是可复用节点，继而进行精细化的属性更新，否则，Vue会直接销毁并重新创建节点。</p>
<p>其次，在diff算法的核心，updateChildren函数中，当前面的头头、尾尾、头尾、尾头，四种快捷对比都失败后，Vue会为旧的节点数组创建一个key到index的映射表，通过这个映射表，Vue可以直接用新节点的key快速判断是否有可复用节点，然后通过移动DOM来完成更新。没有key的情况下，Vue只能按索引顺序对比。这在对列表进行排序、过滤等非末尾增删操作时，会误判为是节点内容发生了更改，而非节点位置发生了移动。结果就是导致大量不必要的DOM操作和组件重新渲染，而非高效的移动。</p>
<p>因此，在实际开发中，尤其是包含状态的组件列表或复杂DOM结构的v-for循环中，必须为每一项提供一个唯一且稳定的key（通常为id）。</p>
<h2 data-id="heading-68">5. 关键流程回顾</h2>
<pre><code class="hljs language-scss" lang="scss">new <span class="hljs-built_in">Vue</span>() → <span class="hljs-built_in">_init</span>() → <span class="hljs-variable">$mount</span>() → <span class="hljs-built_in">mountComponent</span>() → new <span class="hljs-built_in">Watcher</span>()
    ↓
Watcher<span class="hljs-selector-class">.get</span>() → <span class="hljs-built_in">updateComponent</span>() → <span class="hljs-built_in">_render</span>() → <span class="hljs-built_in">createElement</span>()
    ↓
生成 VNode 树 → <span class="hljs-built_in">_update</span>() → <span class="hljs-built_in">patch</span>() → <span class="hljs-built_in">createElm</span>()
    ↓
递归处理组件 → 创建真实 DOM → 触发 mounted 钩子
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浏览器之内置四大多线程API]]></title>    <link>https://juejin.cn/post/7571477608393572352</link>    <guid>https://juejin.cn/post/7571477608393572352</guid>    <pubDate>2025-11-12T09:01:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571477608393572352" data-draft-id="7571641339687895040" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浏览器之内置四大多线程API"/> <meta itemprop="keywords" content="前端,JavaScript,浏览器"/> <meta itemprop="datePublished" content="2025-11-12T09:01:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="拉不动的猪"/> <meta itemprop="url" content="https://juejin.cn/user/1429793504759630"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浏览器之内置四大多线程API
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1429793504759630/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    拉不动的猪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T09:01:00.000Z" title="Wed Nov 12 2025 09:01:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h3 data-id="heading-0">一、为什么 Web Worker 能实现 “多线程”？</h3>
<p>浏览器的 JS 引擎（如 V8）本身是单线程的，但浏览器是多进程 / 多线程架构。Web Worker 的本质是 <strong>浏览器为 JS 提供的 “额外线程池”</strong> ，核心原理：</p>
<ol>
<li><strong>线程隔离</strong>：Worker 线程与主线程是完全隔离的内存空间（不共享堆内存），通过 “消息队列” 通信（数据传输基于结构化克隆算法，深拷贝）。</li>
<li><strong>阻塞无关性</strong>：Worker 线程的阻塞（如死循环）不会影响主线程，但会导致自身无法响应消息。</li>
<li><strong>资源限制</strong>：浏览器对 Worker 数量有上限（通常同源下不超过 20 个），且单个 Worker 占用的内存有限制（避免滥用系统资源）。</li>
</ol>
<p><strong>关键区别</strong>：与 Node.js 的 <code>child_process</code> 不同，Web Worker 无法共享内存（需通过 <code>SharedArrayBuffer</code> 实现有限共享，见下文），且受浏览器安全策略（如跨域限制）约束。</p>
<p><strong>总结：</strong>
webwork是通过js的方式唤起浏览器的内置api使用，辅助前端计算的一种方式，就像fetch、ajaix那样唤起浏览器的接口查询一样。</p>
<h3 data-id="heading-1">多线程四大API</h3>
<p>Web Worker 是前端 “多线程” 的基础规范，但浏览器针对不同场景设计了 <strong>4 种独立的 Worker 类型</strong>—— 它们共享 “线程隔离” 的核心思想（避免阻塞主线程），但定位、能力、使用场景完全不同，均为 W3C 标准定义的原生 API（无需第三方库），底层由浏览器独立实现（无依赖关系）。</p>
<h4 data-id="heading-2">浏览器 4 种核心 Worker 类型对比表</h4>



































<table><thead><tr><th>Worker 类型</th><th>核心定位</th><th>底层依赖</th><th>典型场景</th></tr></thead><tbody><tr><td><strong>Web Worker</strong></td><td>主线程的 “计算助手”，处理耗时计算</td><td>浏览器线程池</td><td>大数据排序、加密解密、复杂算法计算</td></tr><tr><td><strong>Shared Worker</strong></td><td>多页面共享的 “后台协调者”，跨页面通信</td><td>浏览器共享线程</td><td>多标签页登录状态同步、跨页数据协同</td></tr><tr><td><strong>Service Worker</strong></td><td>页面离线的 “代理服务器”，拦截请求 + 缓存</td><td>浏览器后台线程</td><td>离线应用、请求拦截优化、浏览器推送通知</td></tr><tr><td><strong>Worklet</strong></td><td>渲染管线的 “实时处理器”，介入渲染流程</td><td>浏览器渲染线程</td><td>CSS 物理动画、音频降噪、Canvas 渲染优化</td></tr></tbody></table>
<h3 data-id="heading-3">二、分类</h3>
<h4 data-id="heading-4">1. Web Worker（计算型：解决主线程阻塞）</h4>
<p><strong>核心能力</strong>：</p>
<ul>
<li>独立于主线程的 “计算线程”，仅与创建它的主线程通信（一对一）；</li>
</ul>

<ul>
<li>生命周期与页面绑定（页面关闭则 Worker 销毁）；</li>
</ul>

<ul>
<li>不阻塞 UI，专门处理耗时计算（避免页面卡顿）。</li>
</ul>
<p><strong>示例：10 万条数据排序</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主线程（main.js）：发起计算请求，接收结果</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">Worker</span>) {
  <span class="hljs-comment">// 1. 创建 Worker 实例</span>
  <span class="hljs-keyword">const</span> sortWorker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">'sort-worker.js'</span>);
  
  <span class="hljs-comment">// 2. 生成 10 万条随机大数据（模拟复杂计算场景）</span>
  <span class="hljs-keyword">const</span> bigData = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">100000</span> }, <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">100000</span>);
  
  <span class="hljs-comment">// 3. 发送数据给 Worker，触发计算</span>
  sortWorker.<span class="hljs-title function_">postMessage</span>(bigData);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'主线程：已发送数据，等待排序结果...'</span>);
  
  <span class="hljs-comment">// 4. 接收 Worker 返回的计算结果</span>
  sortWorker.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'主线程：排序完成，前 10 条数据：'</span>, e.<span class="hljs-property">data</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>));
    sortWorker.<span class="hljs-title function_">terminate</span>(); <span class="hljs-comment">// 计算完成，销毁 Worker（避免内存泄漏）</span>
  };
  
  <span class="hljs-comment">// 5. 监听 Worker 错误（如代码报错）</span>
  sortWorker.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Worker 错误：<span class="hljs-subst">${err.message}</span>（行号：<span class="hljs-subst">${err.lineno}</span>）`</span>);
    sortWorker.<span class="hljs-title function_">terminate</span>();
  };
} <span class="hljs-keyword">else</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'当前浏览器不支持 Web Worker'</span>);
}
<span class="hljs-comment">// Worker 线程（sort-worker.js）：执行耗时计算</span>
self.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> data = e.<span class="hljs-property">data</span>;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Worker 线程：开始排序 10 万条数据...'</span>);
  
  <span class="hljs-comment">// 耗时计算（示例用内置排序，实际可替换为快排、归并等复杂算法）</span>
  <span class="hljs-keyword">const</span> sortedData = data.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a - b);
  
  <span class="hljs-comment">// 向主线程返回结果</span>
  self.<span class="hljs-title function_">postMessage</span>(sortedData);
  self.<span class="hljs-title function_">close</span>(); <span class="hljs-comment">// Worker 主动关闭，释放资源</span>
};
</code></pre>
<p><strong>运行效果</strong>：</p>
<p>主线程可正常处理用户交互（点击、滚动），排序在后台线程执行，页面无卡顿；计算完成后自动销毁 Worker，无内存泄漏。</p>
<h4 data-id="heading-5">2. Shared Worker（协同型：多页面数据同步）</h4>
<p><strong>核心能力</strong>：</p>
<ul>
<li>同源多页面可共享同一个 Worker 实例（突破 “单页面私有” 限制）；</li>
</ul>

<ul>
<li>通过 port（通信端口）实现多页面与 Worker 的双向通信；</li>
</ul>

<ul>
<li>适合跨页面状态同步（无需重复请求接口）。</li>
</ul>
<p><strong>示例：多标签页登录状态同步</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主线程 - 页面 A（login.html）：登录后同步状态</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">SharedWorker</span>) {
  <span class="hljs-comment">// 1. 创建 Shared Worker 实例</span>
  <span class="hljs-keyword">const</span> sharedWorker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedWorker</span>(<span class="hljs-string">'sync-worker.js'</span>);
  <span class="hljs-comment">// 2. 激活通信端口（必须调用 start()）</span>
  sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-title function_">start</span>();
  
  <span class="hljs-comment">// 3. 模拟登录按钮点击，发送登录状态给 Worker</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'login-btn'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> userInfo = { <span class="hljs-attr">username</span>: <span class="hljs-string">'admin'</span>, <span class="hljs-attr">isLogin</span>: <span class="hljs-literal">true</span> };
    sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'LOGIN'</span>, <span class="hljs-attr">data</span>: userInfo });
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'页面 A：已发送登录状态'</span>);
  });
  
  <span class="hljs-comment">// 4. 接收 Worker 广播的消息（如其他页面同步的状态）</span>
  sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'页面 A 收到消息：'</span>, e.<span class="hljs-property">data</span>);
  };
}
<span class="hljs-comment">// 主线程 - 页面 B（index.html）：实时获取登录状态</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">SharedWorker</span>) {
  <span class="hljs-keyword">const</span> sharedWorker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedWorker</span>(<span class="hljs-string">'sync-worker.js'</span>);
  sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-title function_">start</span>();
  
  <span class="hljs-comment">// 1. 向 Worker 请求当前登录状态</span>
  sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'QUERY_STATUS'</span> });
  
  <span class="hljs-comment">// 2. 接收状态（页面 A 登录后，页面 B 实时更新）</span>
  sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (e.<span class="hljs-property">data</span>.<span class="hljs-property">type</span> === <span class="hljs-string">'LOGIN_STATUS'</span>) {
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'status'</span>).<span class="hljs-property">textContent</span> = e.<span class="hljs-property">data</span>.<span class="hljs-property">isLogin</span> 
        ? <span class="hljs-string">`已登录：<span class="hljs-subst">${e.data.username}</span>`</span> 
        : <span class="hljs-string">'未登录'</span>;
    }
  };
}
<span class="hljs-comment">// Shared Worker 线程（sync-worker.js）：维护全局状态，广播消息</span>
<span class="hljs-keyword">const</span> connections = []; <span class="hljs-comment">// 存储所有连接的页面端口</span>
<span class="hljs-keyword">let</span> globalState = { <span class="hljs-attr">isLogin</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">username</span>: <span class="hljs-string">''</span> }; <span class="hljs-comment">// 全局共享状态</span>
<span class="hljs-comment">// 监听页面连接（新页面打开时触发）</span>
self.<span class="hljs-property">onconnect</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> port = e.<span class="hljs-property">ports</span>[<span class="hljs-number">0</span>];
  connections.<span class="hljs-title function_">push</span>(port); <span class="hljs-comment">// 记录新连接的页面</span>
  port.<span class="hljs-title function_">start</span>();
  
  <span class="hljs-comment">// 处理页面发送的消息</span>
  port.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> {
    <span class="hljs-keyword">switch</span> (msg.<span class="hljs-property">data</span>.<span class="hljs-property">type</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'LOGIN'</span>:
        <span class="hljs-comment">// 更新全局状态</span>
        globalState = msg.<span class="hljs-property">data</span>.<span class="hljs-property">data</span>;
        <span class="hljs-comment">// 广播给所有连接的页面（同步状态到页面 A、B...）</span>
        connections.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">p</span> =&gt;</span> p.<span class="hljs-title function_">postMessage</span>({ 
          <span class="hljs-attr">type</span>: <span class="hljs-string">'LOGIN_STATUS'</span>, 
          ...globalState 
        }));
        <span class="hljs-keyword">break</span>;
      <span class="hljs-keyword">case</span> <span class="hljs-string">'QUERY_STATUS'</span>:
        <span class="hljs-comment">// 单独响应某个页面的状态查询</span>
        port.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'LOGIN_STATUS'</span>, ...globalState });
        <span class="hljs-keyword">break</span>;
    }
  };
  
  <span class="hljs-comment">// 页面关闭时，移除端口（避免内存泄漏）</span>
  port.<span class="hljs-property">onclose</span> = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> index = connections.<span class="hljs-title function_">indexOf</span>(port);
    <span class="hljs-keyword">if</span> (index !== -<span class="hljs-number">1</span>) connections.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
  };
};
</code></pre>
<p><strong>运行效果</strong>：</p>
<p>页面 A 点击 “登录” 后，页面 B 无需刷新，实时显示 “已登录：admin”；多标签页共享同一登录状态，无需重复调用登录接口。</p>
<h4 data-id="heading-6">3. Service Worker（网络型：离线缓存 + 请求拦截）</h4>
<p><strong>核心能力</strong>：</p>
<ul>
<li>完全独立于页面，运行在浏览器后台（页面关闭后仍可活动）；</li>
</ul>

<ul>
<li>拦截所有网络请求，可自定义缓存策略（实现离线访问）；</li>
</ul>

<ul>
<li>生命周期包含 “安装→激活→运行”，需手动管理缓存版本。</li>
</ul>
<p><strong>示例：离线缓存静态资源 + API 请求</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主线程（main.js）：注册 Service Worker，触发离线逻辑</span>
<span class="hljs-keyword">if</span> (<span class="hljs-string">'serviceWorker'</span> <span class="hljs-keyword">in</span> navigator) {
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 1. 注册 Service Worker（脚本需在根目录，确保作用域覆盖所有页面）</span>
      <span class="hljs-keyword">const</span> registration = <span class="hljs-keyword">await</span> navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-title function_">register</span>(<span class="hljs-string">'/sw.js'</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Service Worker 注册成功，作用域：'</span>, registration.<span class="hljs-property">scope</span>);
      
      <span class="hljs-comment">// 2. 测试离线请求（首次联网缓存，后续断网可访问）</span>
      <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>()).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'API 请求结果：'</span>, data);
      });
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Service Worker 注册失败：'</span>, err);
    }
  });
}
<span class="hljs-comment">// Service Worker 线程（sw.js）：缓存+请求拦截逻辑</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CACHE_NAME</span> = <span class="hljs-string">'offline-cache-v1'</span>; <span class="hljs-comment">// 缓存版本（更新时修改版本号）</span>
<span class="hljs-comment">// 需要缓存的资源列表（静态资源+API接口）</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">CACHE_ASSETS</span> = [
  <span class="hljs-string">'/'</span>, 
  <span class="hljs-string">'/index.html'</span>,
  <span class="hljs-string">'/styles.css'</span>,
  <span class="hljs-string">'/api/data'</span> <span class="hljs-comment">// 需缓存的 API 接口</span>
];
<span class="hljs-comment">// 1. 安装阶段：缓存静态资源（仅首次注册/版本更新时触发）</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'install'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// 等待缓存完成后，再进入激活阶段</span>
  event.<span class="hljs-title function_">waitUntil</span>(
    caches.<span class="hljs-title function_">open</span>(<span class="hljs-variable constant_">CACHE_NAME</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> cache.<span class="hljs-title function_">addAll</span>(<span class="hljs-variable constant_">CACHE_ASSETS</span>)) <span class="hljs-comment">// 批量缓存资源</span>
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> self.<span class="hljs-title function_">skipWaiting</span>()) <span class="hljs-comment">// 跳过等待，立即激活新 Worker（替换旧版本）</span>
  );
});
<span class="hljs-comment">// 2. 激活阶段：清理旧缓存（避免缓存膨胀）</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'activate'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  event.<span class="hljs-title function_">waitUntil</span>(
    caches.<span class="hljs-title function_">keys</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cacheNames</span> =&gt;</span> {
      <span class="hljs-comment">// 删除非当前版本的缓存</span>
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(
        cacheNames.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> name !== <span class="hljs-variable constant_">CACHE_NAME</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span> caches.<span class="hljs-title function_">delete</span>(name))
      );
    }).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> self.<span class="hljs-property">clients</span>.<span class="hljs-title function_">claim</span>()) <span class="hljs-comment">// 强制所有打开的页面使用新 Worker</span>
  );
});
<span class="hljs-comment">// 3. 拦截请求：优先从缓存返回，无缓存则请求网络</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'fetch'</span>, <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  <span class="hljs-comment">// 仅拦截同源的 GET 请求（避免跨域资源和非幂等请求）</span>
  <span class="hljs-keyword">if</span> (event.<span class="hljs-property">request</span>.<span class="hljs-property">method</span> === <span class="hljs-string">'GET'</span> &amp;&amp; event.<span class="hljs-property">request</span>.<span class="hljs-property">mode</span> === <span class="hljs-string">'same-origin'</span>) {
    event.<span class="hljs-title function_">respondWith</span>(
      caches.<span class="hljs-title function_">match</span>(event.<span class="hljs-property">request</span>)
        .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cachedResponse</span> =&gt;</span> {
          <span class="hljs-comment">// 缓存命中：直接返回缓存资源</span>
          <span class="hljs-keyword">if</span> (cachedResponse) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'从缓存返回：'</span>, event.<span class="hljs-property">request</span>.<span class="hljs-property">url</span>);
            <span class="hljs-keyword">return</span> cachedResponse;
          }
          <span class="hljs-comment">// 缓存未命中：发起网络请求，并缓存新结果</span>
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(event.<span class="hljs-property">request</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">networkResponse</span> =&gt;</span> {
            caches.<span class="hljs-title function_">open</span>(<span class="hljs-variable constant_">CACHE_NAME</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">cache</span> =&gt;</span> {
              cache.<span class="hljs-title function_">put</span>(event.<span class="hljs-property">request</span>, networkResponse.<span class="hljs-title function_">clone</span>()); <span class="hljs-comment">// 缓存新请求</span>
            });
            <span class="hljs-keyword">return</span> networkResponse;
          });
        })
    );
  }
});
</code></pre>
<p><strong>运行效果</strong>：</p>
<ul>
<li>首次联网时，自动缓存 index.html、styles.css 和 /api/data；</li>
</ul>

<ul>
<li>断网后刷新页面，仍能正常加载页面和 API 数据（从缓存读取）；</li>
</ul>

<ul>
<li>缓存版本更新时，自动清理旧缓存，避免资源冗余。</li>
</ul>
<h4 data-id="heading-7">4. Worklet（实时型：介入渲染流程）</h4>
<p><strong>核心能力</strong>：</p>
<ul>
<li>嵌入浏览器渲染管线（如 CSS 引擎线程、音频线程），低延迟（&lt;1ms）；</li>
</ul>

<ul>
<li>直接干预渲染过程（动画、绘制、音频处理），弥补 Web Worker 通信延迟的缺陷；</li>
</ul>

<ul>
<li>细分类型：CSSWorklet（动画）、AudioWorklet（音频）、PaintWorklet（绘制）。</li>
</ul>
<p><strong>示例：CSSWorklet 实现物理弹性动画</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 主线程（main.js）：注册 Worklet，关联动画</span>
<span class="hljs-keyword">if</span> (<span class="hljs-string">'CSSWorklet'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 注册自定义 Worklet（加载动画逻辑脚本）</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">CSSWorklet</span>.<span class="hljs-title function_">addModule</span>(<span class="hljs-string">'bounce-worklet.js'</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'CSSWorklet 注册成功'</span>);
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'CSSWorklet 注册失败：'</span>, err);
  }
}
<span class="hljs-comment">// HTML 结构：动画元素</span>
<span class="hljs-comment">/*
&lt;div class="box"&gt;弹性动画方块&lt;/div&gt;
*/</span>
<span class="hljs-comment">// CSS 样式：绑定 Worklet 动画</span>
<span class="hljs-comment">/*
.box {
  width: 100px;
  height: 100px;
  background: red;
  /* 使用 Worklet 定义的动画（名称与 Worklet 中注册一致） */</span>
  <span class="hljs-attr">animation</span>: bounce 2s infinite;
}
<span class="hljs-comment">/* 定义动画进度（from→to 对应 Worklet 中的 0→1） */</span>
<span class="hljs-meta">@keyframes</span> bounce {
  <span class="hljs-keyword">from</span> { <span class="hljs-attr">transform</span>: <span class="hljs-title function_">translateY</span>(<span class="hljs-number">0</span>); }
  to { <span class="hljs-attr">transform</span>: <span class="hljs-title function_">translateY</span>(300px); }
}
*/
<span class="hljs-comment">// CSSWorklet 线程（bounce-worklet.js）：自定义动画逻辑</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">BounceWorklet</span> {
  <span class="hljs-comment">// 每一帧的计算（嵌入渲染管线，实时执行）</span>
  <span class="hljs-title function_">process</span>(<span class="hljs-params">inputs, outputs, parameters</span>) {
    <span class="hljs-keyword">const</span> [t] = inputs; <span class="hljs-comment">// 动画进度（0~1，from→to）</span>
    <span class="hljs-keyword">const</span> [output] = outputs; <span class="hljs-comment">// 输出结果（最终的 CSS 样式值）</span>
    
    <span class="hljs-comment">// 物理弹性公式（模拟重力+反弹效果，非匀速动画）</span>
    <span class="hljs-keyword">const</span> bounce = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(t * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>) * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">exp</span>(-t * <span class="hljs-number">0.5</span>);
    <span class="hljs-comment">// 输出 transform 样式（控制方块位置）</span>
    output.<span class="hljs-property">value</span> = <span class="hljs-string">`translateY(<span class="hljs-subst">${<span class="hljs-number">300</span> * (<span class="hljs-number">1</span> - bounce)}</span>px)`</span>;
  }
}
<span class="hljs-comment">// 注册 Worklet 动画（名称需与 CSS 中的 @keyframes 名称一致）</span>
<span class="hljs-title function_">registerAnimator</span>(<span class="hljs-string">'bounce'</span>, <span class="hljs-title class_">BounceWorklet</span>);
</code></pre>
<p><strong>运行效果</strong>：</p>
<p>红色方块以 “物理弹性轨迹” 上下运动（类似小球落地反弹），动画流畅无卡顿；Worklet 运行在渲染线程，延迟极低，避免 Web Worker 通信导致的动画掉帧。</p>
<h3 data-id="heading-8">三、混合使用：多 Worker 协同解决复杂场景</h3>
<h4 data-id="heading-9">场景需求：离线数据分析 Dashboard</h4>
<p>需要同时满足 4 个核心需求：</p>
<ol>
<li>离线访问（断网后仍可查看历史数据）；</li>
</ol>

<ol start="2">
<li>多标签页同步分析结果（无需重复解析）；</li>
</ol>

<ol start="3">
<li>后台解析 10 万条 CSV 数据（不阻塞页面）；</li>
</ol>

<ol start="4">
<li>实时渲染流畅图表（动画无掉帧）。</li>
</ol>
<h4 data-id="heading-10">完整实现代码（整合 4 种 Worker）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主线程（dashboard.js）：整合所有 Worker，协调流程</span>
<span class="hljs-keyword">if</span> (<span class="hljs-string">'serviceWorker'</span> <span class="hljs-keyword">in</span> navigator) {
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-keyword">async</span> () =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 1. 第一步：注册 Service Worker（离线缓存）</span>
      <span class="hljs-keyword">const</span> swRegistration = <span class="hljs-keyword">await</span> navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-title function_">register</span>(<span class="hljs-string">'/sw.js'</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Service Worker 注册成功'</span>);
      <span class="hljs-comment">// 2. 第二步：创建 Shared Worker（多页面同步）</span>
      <span class="hljs-keyword">const</span> sharedWorker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedWorker</span>(<span class="hljs-string">'sync-worker.js'</span>);
      sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-title function_">start</span>();
      <span class="hljs-comment">// 3. 第三步：创建 Web Worker（CSV 数据解析）</span>
      <span class="hljs-keyword">const</span> csvWorker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">'csv-worker.js'</span>);
      <span class="hljs-comment">// 4. 第四步：注册 CSSWorklet（图表动画优化）</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-string">'CSSWorklet'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>) {
        <span class="hljs-keyword">await</span> <span class="hljs-title class_">CSSWorklet</span>.<span class="hljs-title function_">addModule</span>(<span class="hljs-string">'chart-worklet.js'</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'CSSWorklet 注册成功'</span>);
      }
      <span class="hljs-comment">// 5. 页面元素：文件上传、图表容器、状态文本</span>
      <span class="hljs-keyword">const</span> fileInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'file-upload'</span>);
      <span class="hljs-keyword">const</span> chartContainer = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'chart-container'</span>);
      <span class="hljs-keyword">const</span> statusText = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'status'</span>);
      <span class="hljs-comment">// 6. 监听文件上传：触发 CSV 解析</span>
      fileInput.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'change'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> file = e.<span class="hljs-property">target</span>.<span class="hljs-property">files</span>[<span class="hljs-number">0</span>];
        <span class="hljs-keyword">if</span> (file &amp;&amp; file.<span class="hljs-property">name</span>.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'.csv'</span>)) {
          statusText.<span class="hljs-property">textContent</span> = <span class="hljs-string">'正在解析 CSV 文件...'</span>;
          csvWorker.<span class="hljs-title function_">postMessage</span>(file); <span class="hljs-comment">// 发送文件给 Web Worker</span>
        } <span class="hljs-keyword">else</span> {
          statusText.<span class="hljs-property">textContent</span> = <span class="hljs-string">'请上传 CSV 格式文件！'</span>;
        }
      });
      <span class="hljs-comment">// 7. 接收 Web Worker 解析结果：渲染+同步+缓存</span>
      csvWorker.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> analysisResult = e.<span class="hljs-property">data</span>; <span class="hljs-comment">// 解析结果（数据数组+统计信息）</span>
        
        <span class="hljs-comment">// 7.1 渲染图表（用 CSSWorklet 优化动画）</span>
        <span class="hljs-title function_">renderChart</span>(analysisResult, chartContainer);
        
        <span class="hljs-comment">// 7.2 同步结果到其他标签页（通过 Shared Worker）</span>
        sharedWorker.<span class="hljs-property">port</span>.<span class="hljs-title function_">postMessage</span>({
          <span class="hljs-attr">type</span>: <span class="hljs-string">'ANALYSIS_RESULT'</span>,
          <span class="hljs-attr">data</span>: analysisResult
        });
        
        <span class="hljs-comment">// 7.3 缓存结果到 Service Worker（支持离线访问）</span>
        <span class="hljs-keyword">if</span> (navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-property">controller</span>) {
          navigator.<span class="hljs-property">serviceWorker</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">postMessage</span>({
            <span class="hljs-attr">type</span>: <span class="hljs-string">'CACHE_RESULT'</span>,
            <span class="hljs-attr">key</span>: <span class="hljs-string">'last-csv-analysis'</span>,
            <span class="hljs-attr">data</span>: analysisResult
          });
        }
        
        <span class="hljs-comment">// 7.4 更新状态文本</span>
        statusText.<span class="hljs-property">textContent</span> = <span class="hljs-string">`解析完成：共 <span class="hljs-subst">${analysisResult.totalCount}</span> 条&lt;/doubaocanvas&gt;
</span></code></pre>
<h3 data-id="heading-11">四、关于self</h3>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 1. 来源：Worker 线程的内置全局对象，浏览器自动注入，无需定义</span>
<span class="hljs-comment">// 2. 作用：等同于主线程的 window，是 Worker 线程访问自身能力的入口</span>
<span class="hljs-comment">// 3. 隔离性：不同 Worker 的 self 是独立实例，互不干扰（如 Web Worker 的 self ≠ Service Worker 的 self）</span>
<span class="hljs-comment">// 4. 核心能力：接收/发送消息（onmessage/postMessage）、管理生命周期（close）、调用 Worker 专属 API</span>
</code></pre>
<h5 data-id="heading-12">Worker 中 self 的简单代码示例</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Worker 线程（calc-worker.js）</span>
<span class="hljs-comment">// self 指向当前 Web Worker 实例，仅用于计算相关逻辑</span>
self.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { num1, num2 } = e.<span class="hljs-property">data</span>;
  <span class="hljs-keyword">const</span> sum = num1 + num2; <span class="hljs-comment">// 简单计算：两数相加</span>
  self.<span class="hljs-title function_">postMessage</span>(sum); <span class="hljs-comment">// 用 self 向主线程返回结果</span>
  self.<span class="hljs-title function_">close</span>(); <span class="hljs-comment">// 用 self 主动关闭 Worker，释放资源</span>
};
<span class="hljs-comment">// 主线程（main.js）- 配合使用</span>
<span class="hljs-keyword">const</span> calcWorker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">'calc-worker.js'</span>);
calcWorker.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">num1</span>: <span class="hljs-number">10</span>, <span class="hljs-attr">num2</span>: <span class="hljs-number">20</span> }); <span class="hljs-comment">// 发数据给 Worker</span>
calcWorker.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'计算结果：'</span>, e.<span class="hljs-property">data</span>); <span class="hljs-comment">// 输出 30</span>
};
</code></pre>
<h5 data-id="heading-13">注意：</h5>
<pre><code class="hljs language-lua" lang="lua">// 注意 <span class="hljs-number">1</span>：Worker 中不能用 window，必须用 <span class="hljs-built_in">self</span>（因 Worker 无窗口概念）
// 注意 <span class="hljs-number">2</span>：<span class="hljs-built_in">self</span> 无法访问 DOM（如 document、body），仅能处理非 UI 逻辑
// 注意 <span class="hljs-number">3</span>：简单场景可省略 <span class="hljs-built_in">self</span>（如 onmessage = () =&gt; {} 等同于 <span class="hljs-built_in">self</span>.onmessage = () =&gt; {}），但复杂场景建议保留，增强可读性
</code></pre>
<h3 data-id="heading-14">五、生产环境使用的平衡点</h3>
<h4 data-id="heading-15">1. 错误处理与健壮性</h4>
<ul>
<li>
<p>Worker 内部错误不会冒泡到主线程，需单独监听：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 主线程</span>
worker.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Worker错误：<span class="hljs-subst">${err.message}</span>`</span>);
  worker.<span class="hljs-title function_">terminate</span>(); <span class="hljs-comment">// 出错后销毁Worker，避免内存泄漏</span>
};

<span class="hljs-comment">// Worker线程</span>
self.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
  self.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'ERROR'</span>, <span class="hljs-attr">message</span>: err.<span class="hljs-property">message</span> });
  self.<span class="hljs-title function_">close</span>(); <span class="hljs-comment">// 主动关闭</span>
};
</code></pre>
</li>
<li>
<p>网络错误：Worker 脚本加载失败（404）时，主线程会触发 <code>error</code> 事件，需捕获并降级处理。</p>
</li>
</ul>
<h4 data-id="heading-16">2. 内存管理与资源回收</h4>
<ul>
<li>避免创建过多 Worker：每个 Worker 都是独立线程，占用内存和 CPU，建议通过 “Worker 池” 复用（如用 <code>p-queue</code> 管理 Worker 实例）。</li>
<li>及时销毁无用 Worker：<code>worker.terminate()</code>（主线程主动销毁，立即终止）或 <code>self.close()</code>（Worker 主动关闭，清理后终止）。</li>
<li>警惕内存泄漏：Worker 中若持有 <code>setInterval</code>、未关闭的 <code>fetch</code> 请求等，即使调用 <code>terminate</code> 也可能导致内存泄漏，需先清理资源。</li>
</ul>
<h4 data-id="heading-17">3. 跨域与安全策略</h4>
<ul>
<li>Worker 脚本必须与主线程同源（协议、域名、端口一致），若需加载跨域脚本，需通过 <code>importScripts</code> 加载且服务器允许跨域（<code>Access-Control-Allow-Origin</code>）。</li>
<li>禁止访问 <code>file://</code> 协议下的脚本（浏览器安全限制），本地开发需用 <code>http-server</code> 启动服务。</li>
<li>敏感操作限制：Worker 中无法使用 <code>localStorage</code>（部分浏览器支持，但规范不推荐），建议用 <code>IndexedDB</code> 存储大量数据（异步 API，不阻塞）。</li>
</ul>
<h4 data-id="heading-18">4. 兼容性处理与降级方案</h4>
<ul>
<li>
<p>浏览器支持：IE 完全不支持，Edge 12+、Chrome 4+、Firefox 3.5+ 支持基本特性，<code>SharedArrayBuffer</code> 和 <code>SharedWorker</code> 兼容性较差。</p>
</li>
<li>
<p>降级逻辑：</p>
<pre><code class="hljs language-scss" lang="scss">if (window.Worker) {
  <span class="hljs-comment">// 使用Worker</span>
} else {
  <span class="hljs-comment">// 降级到主线程执行（给用户提示“当前浏览器可能卡顿”）</span>
  <span class="hljs-built_in">heavyTask</span>();
}
</code></pre>
</li>
</ul>
<h3 data-id="heading-19">六、性能陷阱</h3>
<ol>
<li>
<p><strong>过度使用 Worker 导致性能反降</strong>小数据计算（如几毫秒可完成的操作）用 Worker 反而会增加通信开销（序列化 + 消息传递），建议仅对 <strong>执行时间 &gt; 50ms</strong> 的任务使用 Worker。</p>
</li>
<li>
<p><strong>频繁通信导致主线程阻塞</strong>若 Worker 与主线程高频次 <code>postMessage</code>（如每秒 hundreds 次），序列化数据会占用主线程资源，导致卡顿。解决方案：</p>
<ul>
<li>批量发送数据（累计一定量后再通信）；</li>
<li>用 <code>SharedArrayBuffer</code> 减少序列化开销。</li>
</ul>
</li>
<li>
<p><strong>Worker 中滥用同步 API</strong>Worker 虽然不阻塞 UI，但内部的同步操作（如 <code>XMLHttpRequest</code> 的同步请求、大量同步循环）会阻塞自身线程，导致无法响应消息。建议优先使用异步 API（<code>fetch</code>、<code>setImmediate</code>）。</p>
</li>
<li>
<p><strong>忽略线程优先级</strong>浏览器会给 Worker 分配较低的线程优先级，若需 “近实时” 处理（如游戏帧计算），可能出现延迟。此时可考虑 <code>requestIdleCallback</code> 结合 Worker，利用主线程空闲时间处理。</p>
</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[CSS 定位详解：relative、absolute、fixed、sticky 与 static]]></title>    <link>https://juejin.cn/post/7571258854901415979</link>    <guid>https://juejin.cn/post/7571258854901415979</guid>    <pubDate>2025-11-11T14:26:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571258854901415979" data-draft-id="7571304204754763830" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="CSS 定位详解：relative、absolute、fixed、sticky 与 static"/> <meta itemprop="keywords" content="CSS"/> <meta itemprop="datePublished" content="2025-11-11T14:26:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iNx177"/> <meta itemprop="url" content="https://juejin.cn/user/2904285373272825"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            CSS 定位详解：relative、absolute、fixed、sticky 与 static
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2904285373272825/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iNx177
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T14:26:27.000Z" title="Tue Nov 11 2025 14:26:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">CSS 定位详解：relative、absolute、fixed、sticky 与 static</h2>
<p>CSS 中的 <code>position</code> 属性用于控制元素的定位方式，常见的取值包括 <code>relative</code>、<code>absolute</code>、<code>fixed</code>、<code>sticky</code> 和 <code>static</code>。理解它们的行为差异，尤其是是否脱离文档流、定位参考点等，对布局开发至关重要。</p>
<h3 data-id="heading-1">文档流基础</h3>
<p>文档流是 HTML 元素默认的布局方式：块级元素垂直排列，行内元素水平排列，整体遵循从上到下、从左到右的自然顺序。元素若“脱离文档流”，则不再占据原有空间，可能影响其他元素的布局。</p>
<h3 data-id="heading-2">relative（相对定位）</h3>
<ul>
<li>相对于元素在文档流中的原始位置进行偏移。</li>
<li><strong>不会脱离文档流</strong>，原位置仍被保留，后续元素仍按标准流对待它。</li>
<li>常用于微调位置或作为绝对定位子元素的参考容器。</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.parent</span> {
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">100px</span>;
}
</code></pre>
<h3 data-id="heading-3">absolute（绝对定位）</h3>
<ul>
<li>脱离文档流，不占据原有空间。</li>
<li>定位参考点为<strong>最近的非 <code>static</code> 定位祖先元素</strong>；若无，则以 <code>&lt;body&gt;</code> 为基准。</li>
<li>常用于弹窗、下拉菜单等需要精确控制位置的场景。</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.child</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">right</span>: <span class="hljs-number">100px</span>;
}
</code></pre>
<h3 data-id="heading-4">fixed（固定定位）</h3>
<ul>
<li>脱离文档流。</li>
<li>以<strong>浏览器视口</strong>为参考点，不随页面滚动而移动。</li>
<li>适用于导航栏、悬浮按钮等需固定显示的元素。</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.child</span> {
  <span class="hljs-attribute">position</span>: fixed;
  <span class="hljs-attribute">bottom</span>: <span class="hljs-number">100px</span>;
  <span class="hljs-attribute">right</span>: <span class="hljs-number">100px</span>;
}
</code></pre>
<h3 data-id="heading-5">sticky（黏连定位）</h3>
<ul>
<li>行为介于 <code>relative</code> 与 <code>fixed</code> 之间。</li>
<li>在滚动到达指定阈值（如 <code>top: 100px</code>）前表现为相对定位；超过后变为固定定位。</li>
<li>需指定 <code>top</code>、<code>bottom</code> 等阈值才生效。</li>
<li>不脱离文档流，但滚动时会“粘”在视口某处。</li>
</ul>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">position</span>: sticky;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">100px</span>;
}
</code></pre>
<h3 data-id="heading-6">static（静态定位）</h3>
<ul>
<li>默认定位方式，元素按正常文档流排列。</li>
<li>设置 <code>left</code>、<code>top</code> 等偏移属性无效。</li>
<li>可用于<strong>重置</strong>已定位元素，使其回归标准流。</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">// 示例：3 秒后取消定位
<span class="hljs-attr">oParent.style.position</span> = <span class="hljs-string">'static'</span><span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-7">总结对比</h3>









































<table><thead><tr><th>定位类型</th><th>是否脱离文档流</th><th>定位参考点</th><th>典型用途</th></tr></thead><tbody><tr><td>static</td><td>否</td><td>无（忽略偏移属性）</td><td>默认布局</td></tr><tr><td>relative</td><td>否</td><td>自身原始位置</td><td>微调、作为 absolute 容器</td></tr><tr><td>absolute</td><td>是</td><td>最近非 static 祖先或 body</td><td>弹层、精准定位</td></tr><tr><td>fixed</td><td>是</td><td>浏览器视口</td><td>固定导航、悬浮按钮</td></tr><tr><td>sticky</td><td>否（视觉上固定）</td><td>滚动阈值触发 fixed 行为</td><td>表头、侧边栏吸附</td></tr></tbody></table>
<p>掌握这些定位机制，能更灵活地实现复杂页面布局。</p>
<hr/>
<p>本文基于实际代码示例与规范总结，适用于前端开发者系统理解 CSS 定位模型。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【前端效率工具】再也不用 APIfox 联调！零侵入 Mock，全程不改代码、不开代理]]></title>    <link>https://juejin.cn/post/7570984257666056238</link>    <guid>https://juejin.cn/post/7570984257666056238</guid>    <pubDate>2025-11-11T00:15:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570984257666056238" data-draft-id="7569813790533730323" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【前端效率工具】再也不用 APIfox 联调！零侵入 Mock，全程不改代码、不开代理"/> <meta itemprop="keywords" content="前端,浏览器,JavaScript"/> <meta itemprop="datePublished" content="2025-11-11T00:15:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不一样的少年_"/> <meta itemprop="url" content="https://juejin.cn/user/3035079961218551"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【前端效率工具】再也不用 APIfox 联调！零侵入 Mock，全程不改代码、不开代理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3035079961218551/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不一样的少年_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T00:15:35.000Z" title="Tue Nov 11 2025 00:15:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    561
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>上周四下午，我正在调样式，突然电脑风扇开始咆哮。</p>
<p>打开任务管理器：<strong>内存占用 15.5G / 16G</strong>。</p>
<p>我人傻了，16G 内存开发个前端项目还能卡？</p>
<p>仔细一看：</p>
<ul>
<li><strong>VSCode</strong>：2.1G（跑着项目，正常）</li>
<li><strong>Chrome 30 个标签页</strong>：4.5G（掘金、Stack Overflow、GitHub、文档...能理解）</li>
<li><strong>APIfox</strong>：1.5G（？？？）</li>
<li><strong>微信 + 企业微信</strong>：1.1G（没办法，工作要用）</li>
<li><strong>其他若干进程…</strong>：...</li>
</ul>
<p><strong>APIfox这一个工具，占了 1.5G？</strong></p>
<p>关键是，我只是想 Mock 几个接口而已，为什么要：</p>
<ul>
<li>装一个 500M+ 的客户端</li>
<li>开代理（还得记得关）</li>
<li>来回切窗口（浏览器 → APIfox → VSCode）</li>
<li>占用 1.5G 内存</li>
</ul>
<p>我试过其他方案：</p>
<ul>
<li><strong>在代码里写死 Mock 数据</strong> → 有时候忘记删掉，上线差点带着假数据冲进生产</li>
<li><strong>用 Mock.js</strong> → 配置太麻烦，还要改代码</li>
</ul>
<p>我想要的是：不装客户端、不改代码、不开代理、不耗内存、一键切换 Mock 开关
。
于是，我花了一个周末，做了一个chrome浏览器插件。</p>
<p><strong>现在mock不用 APIfox，内存占用降了不少，电脑顺多了，浏览器里一键 Mock，调试又快又省心。</strong></p>
<p><code>想知道怎么实现的吗？接下来将从零开始，和你一起实现这个mock小工具</code></p>
</blockquote>
<h2 data-id="heading-0">效果演示:  下面是插件在拦截 fetch/ajax 请求并返回 Mock 数据时的演示：</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ff5b4c2ddc4432491f849c8b01888f5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763464720&amp;x-signature=wzZKT%2FF3yr%2BhMdnIWqGdjhWWT7Y%3D" alt="mock插件效果.gif" loading="lazy"/></p>
<h2 data-id="heading-1">插件功能预览</h2>
<ul>
<li>拦截页面的 <code>fetch</code>、<code>ajax</code> 请求</li>
<li>规则支持模糊匹配和完全匹配</li>
<li>支持按 HTTP 方法过滤（GET/POST/PUT/DELETE）</li>
<li>自定义返回 JSON 数据</li>
<li><code>持续优化中：性能、匹配规则和用户体验会不断迭代，欢迎反馈与建议</code></li>
</ul>
<h2 data-id="heading-2">根本原理：劫持浏览器的网络请求方法</h2>
<h3 data-id="heading-3">一句话总结</h3>
<p><strong>在网页加载前，偷偷替换掉浏览器原生的</strong> <strong><code>fetch</code></strong> <strong>和</strong> <strong><code>XMLHttpRequest</code></strong> <strong>，让所有网络请求先经过我们的"检查站"，符合规则的就返回假数据，不符合的就放行。</strong></p>
<h3 data-id="heading-4">原理:</h3>
<pre><code class="hljs language-sql" lang="sql">正常情况：
网页代码 → <span class="hljs-keyword">fetch</span>(<span class="hljs-string">'/api/user'</span>) → 浏览器发送真实请求 → 服务器

插件介入后：
网页代码 → <span class="hljs-keyword">fetch</span>(<span class="hljs-string">'/api/user'</span>) 
           ↓
       我们的假 <span class="hljs-keyword">fetch</span>（检查是否需要 Mock）
           ↓
    需要 Mock？
    ├─ 是 → 直接返回假数据 ✅
    └─ 否 → 调用真正的 <span class="hljs-keyword">fetch</span> 发送请求 → 服务器
</code></pre>
<h3 data-id="heading-5">具体实现（简化版）</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 1. 保存原始方法</span>
<span class="hljs-keyword">const</span> 真正的fetch = <span class="hljs-variable language_">window</span>.<span class="hljs-property">fetch</span>;

<span class="hljs-comment">// 2. 替换成我们的方法</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">fetch</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">url</span>) {
  <span class="hljs-comment">// 3. 检查是否需要 Mock</span>
  <span class="hljs-keyword">if</span> (url.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'/api/user'</span>)) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'拦截成功！返回假数据'</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>({
      <span class="hljs-attr">json</span>: <span class="hljs-function">() =&gt;</span> ({ <span class="hljs-attr">name</span>: <span class="hljs-string">'Mock User'</span> })
    });
  }
  
  <span class="hljs-comment">// 4. 不需要 Mock，调用原始方法</span>
  <span class="hljs-keyword">return</span> 真正的<span class="hljs-title function_">fetch</span>(url);
};
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li>必须先保存原始方法，否则无法发送真实请求</li>
<li>必须在网页加载前执行，否则拦截不到早期请求</li>
<li>XMLHttpRequest 同理，重写 <code>open</code> 和 <code>send</code> 方法</li>
</ul>
<h2 data-id="heading-6">项目结构</h2>
<pre><code class="hljs language-bash" lang="bash">quick-mock/
├── manifest.json      <span class="hljs-comment"># 插件配置文件</span>
├── popup.html         <span class="hljs-comment"># 弹窗页面</span>
├── popup.css          <span class="hljs-comment"># 弹窗样式</span>
├── popup.js           <span class="hljs-comment"># 弹窗逻辑</span>
├── content.js         <span class="hljs-comment"># 内容脚本 </span>
└── injected.js        <span class="hljs-comment"># 注入脚本 </span>
</code></pre>
<h2 data-id="heading-7">🚀 快速开始</h2>
<h3 data-id="heading-8">获取代码</h3>
<ul>
<li><strong>GitHub</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTeernage%2Fquick-mock" target="_blank" title="https://github.com/Teernage/quick-mock" ref="nofollow noopener noreferrer">github.com/Teernage/qu…</a> ⭐ 如果对您有帮助欢迎Star</li>
<li><strong>Gitee</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fxuzhenxin110%2Fquick-mock" target="_blank" title="https://gitee.com/xuzhenxin110/quick-mock" ref="nofollow noopener noreferrer">gitee.com/xuzhenxin11…</a></li>
</ul>
<h3 data-id="heading-9">一键安装</h3>
<ol>
<li>打开Chrome浏览器</li>
<li>地址栏输入：<code>chrome://extensions/</code></li>
<li>打开右上角"开发者模式"</li>
<li>点击"加载已解压的扩展程序"</li>
<li>选择quick-mock文件夹</li>
<li>搞定！扩展安装完成！</li>
</ol>
<h2 data-id="heading-10">深入解析：从零开始理解插件实现</h2>
<h3 data-id="heading-11">界面层（用户交互）</h3>
<h4 data-id="heading-12">1. <strong>popup.html</strong> - 插件的"脸面"-   作用：用户点击插件图标看到的弹窗界面</h4>
<ul>
<li>包含：输入框、按钮、规则列表</li>
</ul>
<blockquote>
<p>🔗 <strong>文件源码链接</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTeernage%2Fquick-mock%2Fblob%2Fmain%2Fpopup.html" target="_blank" title="https://github.com/Teernage/quick-mock/blob/main/popup.html" ref="nofollow noopener noreferrer"><code>GitHub</code></a>： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTeernage%2Fquick-mock%2Fblob%2Fmain%2Fpopup.html" target="_blank" title="https://github.com/Teernage/quick-mock/blob/main/popup.html" ref="nofollow noopener noreferrer">github.com/Teernage/qu…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fxuzhenxin110%2Fquick-mock%2Fblob%2Fmain%2Fpopup.html" target="_blank" title="https://gitee.com/xuzhenxin110/quick-mock/blob/main/popup.html" ref="nofollow noopener noreferrer"><code>Gitee</code></a>： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fxuzhenxin110%2Fquick-mock%2Fblob%2Fmain%2Fpopup.html" target="_blank" title="https://gitee.com/xuzhenxin110/quick-mock/blob/main/popup.html" ref="nofollow noopener noreferrer">gitee.com/xuzhenxin11…</a></li>
</ul>
</blockquote>
<h4 data-id="heading-13">2. <strong>popup.css</strong> - 界面样式</h4>
<blockquote>
<p>🔗 <strong>文件源码链接</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTeernage%2Fquick-mock%2Fblob%2Fmain%2Fpopup.css" target="_blank" title="https://github.com/Teernage/quick-mock/blob/main/popup.css" ref="nofollow noopener noreferrer"><code>GitHub</code></a>： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTeernage%2Fquick-mock%2Fblob%2Fmain%2Fpopup.css" target="_blank" title="https://github.com/Teernage/quick-mock/blob/main/popup.css" ref="nofollow noopener noreferrer">github.com/Teernage/qu…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fxuzhenxin110%2Fquick-mock%2Fblob%2Fmain%2Fpopup.css" target="_blank" title="https://gitee.com/xuzhenxin110/quick-mock/blob/main/popup.css" ref="nofollow noopener noreferrer"><code>Gitee</code></a>： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fxuzhenxin110%2Fquick-mock%2Fblob%2Fmain%2Fpopup.css" target="_blank" title="https://gitee.com/xuzhenxin110/quick-mock/blob/main/popup.css" ref="nofollow noopener noreferrer">gitee.com/xuzhenxin11…</a></li>
</ul>
</blockquote>
<h4 data-id="heading-14">3. <strong>popup.js</strong> - 界面逻辑</h4>
<p>作用：处理用户配置mock操作</p>
<p>功能：</p>
<ul>
<li>点击"添加规则" → 保存到 chrome.storage</li>
<li>点击"删除" → 从 chrome.storage 移除</li>
<li>渲染规则列表</li>
</ul>
<blockquote>
<p>🔗 <strong>文件源码链接</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTeernage%2Fquick-mock%2Fblob%2Fmain%2Fpopup.js" target="_blank" title="https://github.com/Teernage/quick-mock/blob/main/popup.js" ref="nofollow noopener noreferrer"><code>GitHub</code></a>： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTeernage%2Fquick-mock%2Fblob%2Fmain%2Fpopup.js" target="_blank" title="https://github.com/Teernage/quick-mock/blob/main/popup.js" ref="nofollow noopener noreferrer">github.com/Teernage/qu…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fxuzhenxin110%2Fquick-mock%2Fblob%2Fmain%2Fpopup.js" target="_blank" title="https://gitee.com/xuzhenxin110/quick-mock/blob/main/popup.js" ref="nofollow noopener noreferrer"><code>Gitee</code></a>： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fxuzhenxin110%2Fquick-mock%2Fblob%2Fmain%2Fpopup.js" target="_blank" title="https://gitee.com/xuzhenxin110/quick-mock/blob/main/popup.js" ref="nofollow noopener noreferrer">gitee.com/xuzhenxin11…</a></li>
</ul>
</blockquote>
<h3 data-id="heading-15">核心层（拦截逻辑）</h3>
<h4 data-id="heading-16">4. <strong>content.js</strong> - "中间人"</h4>
<p>作用：连接插件和网页的桥梁</p>
<p>能力：</p>
<ul>
<li>可以访问 Chrome API（读取 chrome.storage）</li>
<li>可以访问网页 DOM</li>
<li>不能访问网页的 JavaScript 环境（window.fetch）</li>
</ul>
<p>职责：</p>
<ol>
<li>把 injected.js 注入到网页</li>
<li>读取用户配置的 Mock 规则</li>
<li>通过 postMessage 与 injected.js 通信</li>
</ol>
<blockquote>
<p>🔗 <strong>文件源码链接</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTeernage%2Fquick-mock%2Fblob%2Fmain%2Fcontent.js" target="_blank" title="https://github.com/Teernage/quick-mock/blob/main/content.js" ref="nofollow noopener noreferrer"><code>GitHub</code></a>： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTeernage%2Fquick-mock%2Fblob%2Fmain%2Fcontent.js" target="_blank" title="https://github.com/Teernage/quick-mock/blob/main/content.js" ref="nofollow noopener noreferrer">github.com/Teernage/qu…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fxuzhenxin110%2Fquick-mock%2Fblob%2Fmain%2Fcontent.js" target="_blank" title="https://gitee.com/xuzhenxin110/quick-mock/blob/main/content.js" ref="nofollow noopener noreferrer"><code>Gitee</code></a>： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fxuzhenxin110%2Fquick-mock%2Fblob%2Fmain%2Fcontent.js" target="_blank" title="https://gitee.com/xuzhenxin110/quick-mock/blob/main/content.js" ref="nofollow noopener noreferrer">gitee.com/xuzhenxin11…</a></li>
</ul>
</blockquote>
<h4 data-id="heading-17">5. <strong>injected.js</strong> - "劫匪"</h4>
<p>作用：真正执行拦截的代码</p>
<p>能力：</p>
<ul>
<li>
<p><code>可以</code>访问网页的 JavaScript 环境（window.fetch）</p>
</li>
<li>
<p><code>可以</code>重写 fetch 和 XMLHttpRequest</p>
</li>
<li>
<p><code>不能</code>访问 Chrome API（chrome.storage）</p>
</li>
</ul>
<p>职责：</p>
<ol>
<li>重写 window.fetch</li>
<li>重写 XMLHttpRequest.prototype.open/send</li>
<li>拦截请求，询问 content.js 是否需要 Mock</li>
<li>根据回复决定返回假数据还是真实请求</li>
</ol>
<blockquote>
<p>🔗 <strong>文件源码链接</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTeernage%2Fquick-mock%2Fblob%2Fmain%2Finjected.js" target="_blank" title="https://github.com/Teernage/quick-mock/blob/main/injected.js" ref="nofollow noopener noreferrer"><code>GitHub</code></a>： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTeernage%2Fquick-mock%2Fblob%2Fmain%2Finjected.js" target="_blank" title="https://github.com/Teernage/quick-mock/blob/main/injected.js" ref="nofollow noopener noreferrer">github.com/Teernage/qu…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fxuzhenxin110%2Fquick-mock%2Fblob%2Fmain%2Finjected.js" target="_blank" title="https://gitee.com/xuzhenxin110/quick-mock/blob/main/injected.js" ref="nofollow noopener noreferrer"><code>Gitee</code></a>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fxuzhenxin110%2Fquick-mock%2Fblob%2Fmain%2Finjected.js" target="_blank" title="https://gitee.com/xuzhenxin110/quick-mock/blob/main/injected.js" ref="nofollow noopener noreferrer">gitee.com/xuzhenxin11…</a></li>
</ul>
</blockquote>
<h3 data-id="heading-18">配置层</h3>
<h4 data-id="heading-19">6. <strong>manifest.json</strong> - 插件的"身份证"</h4>
<blockquote>
<p>🔗 <strong>文件源码链接</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTeernage%2Fquick-mock%2Fblob%2Fmain%2Fmanifest.json" target="_blank" title="https://github.com/Teernage/quick-mock/blob/main/manifest.json" ref="nofollow noopener noreferrer"><code>GitHub</code></a>： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTeernage%2Fquick-mock%2Fblob%2Fmain%2Fmanifest.json" target="_blank" title="https://github.com/Teernage/quick-mock/blob/main/manifest.json" ref="nofollow noopener noreferrer">github.com/Teernage/qu…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fxuzhenxin110%2Fquick-mock%2Fblob%2Fmain%2Fmanifest.json" target="_blank" title="https://gitee.com/xuzhenxin110/quick-mock/blob/main/manifest.json" ref="nofollow noopener noreferrer"><code>Gitee</code></a>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fxuzhenxin110%2Fquick-mock%2Fblob%2Fmain%2Fmanifest.json" target="_blank" title="https://gitee.com/xuzhenxin110/quick-mock/blob/main/manifest.json" ref="nofollow noopener noreferrer">gitee.com/xuzhenxin11…</a></li>
</ul>
</blockquote>
<h3 data-id="heading-20">安装扩展</h3>
<ol>
<li>打开Chrome浏览器</li>
<li>地址栏输入：<code>chrome://extensions/</code></li>
<li>打开右上角"开发者模式"</li>
<li>点击"加载已解压的扩展程序"</li>
<li>选择quick-mock文件夹</li>
<li>搞定！扩展安装完成！</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3757cfb50c944109f1055b036e06ff1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5LiA5qC355qE5bCR5bm0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763464720&amp;x-signature=uW3CXo9%2FrVeDtaOahw08A7Ah9jU%3D" alt="安装mock插件.gif" loading="lazy"/></p>
<h2 data-id="heading-21">文件协作流程（完整链路）</h2>
<h3 data-id="heading-22">第一阶段：用户配置规则</h3>
<pre><code class="hljs language-c" lang="c">┌─────────────┐
│  用户操作    │ 在 popup.html 输入 Mock 规则
└──────┬──────┘
       │
       ↓
┌─────────────┐
│  popup.js   │ 点击<span class="hljs-string">"添加"</span>按钮
└──────┬──────┘
       │
       │ chrome.storage.local.<span class="hljs-built_in">set</span>({ mockRules: [...] })
       ↓
┌─────────────┐
│Chrome Storage│ 持久化存储规则（关闭浏览器也不丢失）
└─────────────┘
</code></pre>
<h3 data-id="heading-23">第二阶段：页面加载时注入脚本</h3>
<pre><code class="hljs language-ini" lang="ini">用户打开网页（如 https://example.com）
       ↓
┌─────────────┐
│manifest.json│ 检测到匹配的 URL
└──────┬──────┘
       │
       │ 自动注入
       ↓
┌─────────────┐
│ content.js  │ 在网页上下文运行（但在隔离沙箱）
└──────┬──────┘
       │
       │ 创建 &lt;script&gt; 标签
       │ <span class="hljs-attr">script.src</span> = chrome.runtime.getURL(<span class="hljs-string">'injected.js'</span>)
       │ document.head.appendChild(script)
       ↓
┌─────────────┐
│ injected.js │ 在网页真实环境运行
└──────┬──────┘
       │
       │ <span class="hljs-attr">window.fetch</span> = 我们的假fetch<span class="hljs-comment">;</span>
       ↓
    拦截就绪！
</code></pre>
<h3 data-id="heading-24">第三阶段：拦截请求（实时通信）</h3>
<pre><code class="hljs language-php" lang="php">网页代码执行：<span class="hljs-title function_ invoke__">fetch</span>(<span class="hljs-string">'/api/user'</span>)
       ↓
┌─────────────────────┐
│ injected.js         
│ 我们的假 fetch 被调用 
└──────┬──────────────┘
       │
       │ window.<span class="hljs-title function_ invoke__">postMessage</span>({
       │   <span class="hljs-attr">type</span>: <span class="hljs-string">'MOCK_REQUEST'</span>,
       │   <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/user'</span>,
       │   <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>
       │ })
       ↓
┌─────────────────────┐
│ content.js          │ 监听 message 事件
└──────┬──────────────┘
       │
       │ <span class="hljs-number">1</span>. 读取 chrome.storage.local
       │ <span class="hljs-number">2</span>. 遍历规则，检查是否匹配
       │ <span class="hljs-number">3</span>. 找到匹配规则
       ↓
       │ window.<span class="hljs-title function_ invoke__">postMessage</span>({
       │   <span class="hljs-attr">type</span>: <span class="hljs-string">'MOCK_RESPONSE'</span>,
       │   <span class="hljs-attr">shouldMock</span>: <span class="hljs-literal">true</span>,
       │   <span class="hljs-attr">mockData</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'Mock User'</span> }
       │ })
       ↓
┌─────────────────────┐
│ injected.js         │ 收到回复
└──────┬──────────────┘
       │
       │ <span class="hljs-keyword">if</span> (shouldMock) {
       │   <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(JSON.<span class="hljs-title function_ invoke__">stringify</span>(mockData));
       │ } <span class="hljs-keyword">else</span> {
       │   <span class="hljs-keyword">return</span> 真<span class="hljs-title function_ invoke__">fetch</span>(url); <span class="hljs-comment">// 调用原始方法</span>
       │ }
       ↓
网页代码收到响应：{ name: <span class="hljs-string">'Mock User'</span> }
</code></pre>
<h2 data-id="heading-25">为什么要分 content.js 和 injected.js？</h2>
<h3 data-id="heading-26">只用 Content Script 行不行？</h3>
<p><strong>不行！</strong> 因为 Content Script 运行在隔离的沙箱中，无法访问网页的 <code>window.fetch</code>。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// content.js 中这样做是无效的！</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">fetch</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) { 
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'拦截失败！'</span>); <span class="hljs-comment">// 网页看不到这个修改</span>
}
</code></pre>
<h3 data-id="heading-27">只用 Injected Script 行不行？</h3>
<p><strong>不行！</strong> 因为 Injected Script 无法访问 <code>chrome.storage</code> 等 Chrome API，无法读取用户配置的 Mock 规则。</p>
<pre><code class="hljs language-scss" lang="scss">### 正确方案：两者配合

用户配置 Mock 规则
↓
存储到 chrome<span class="hljs-selector-class">.storage</span> (Popup)
↓
读取规则 (Content Script) ← 可以访问 Chrome API
↓
通过 postMessage 通信
↓
拦截 fetch (Injected Script) ← 可以修改 window<span class="hljs-selector-class">.fetch</span>
</code></pre>
<h3 data-id="heading-28">通俗比喻</h3>
<pre><code class="hljs language-markdown" lang="markdown">content.js = 银行金库管理员
<span class="hljs-bullet">  -</span> 有钥匙（Chrome API 权限）
<span class="hljs-bullet">  -</span> 能读取保险箱（chrome.storage）
<span class="hljs-bullet">  -</span> 但不能直接接触客户（网页 JavaScript）

injected.js = 银行大堂经理
<span class="hljs-bullet">  -</span> 直接面对客户（网页代码）
<span class="hljs-bullet">  -</span> 能拦截客户请求（重写 fetch）
<span class="hljs-bullet">  -</span> 但没有金库钥匙（无法访问 chrome.storage）

解决方案：两人用对讲机（postMessage）通信
  客户发起请求 → 大堂经理拦截 → 对讲机问管理员"要不要放行"
  → 管理员查保险箱 → 回复"不放行，给假钞" → 大堂经理返回假钞
</code></pre>
<h2 data-id="heading-29">关键技术点总结</h2>
<h3 data-id="heading-30">1. <strong>为什么要用</strong> <strong><code>run_at: "document_start"</code></strong> <strong>？</strong></h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// manifest.json</span>
<span class="hljs-attr">"run_at"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"document_start"</span>  <span class="hljs-comment">// 在 HTML 解析前运行</span>
</code></pre>
<p><strong>原因：</strong> 如果网页在插件加载前就执行了 <code>fetch('/api/data')</code>，我们就拦截不到了。</p>
<h3 data-id="heading-31">2. <strong>为什么要用</strong> <strong><code>web_accessible_resources</code></strong> <strong>？</strong></h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// manifest.json</span>
<span class="hljs-attr">"web_accessible_resources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"resources"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"injected.js"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"matches"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"&lt;all_urls&gt;"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
</code></pre>
<p><strong>原因：</strong> 默认情况下，网页无法加载插件内部的文件（跨域限制）。这个配置相当于给 <code>injected.js</code> 开了"绿色通道"。</p>
<h3 data-id="heading-32">3. <strong>为什么用</strong> <strong><code>postMessage</code></strong> <strong>而不是全局变量？</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误做法</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">mockRules</span> = [...];  <span class="hljs-comment">// content.js 设置</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">mockRules</span>);  <span class="hljs-comment">// injected.js 读取（读不到！）</span>

<span class="hljs-comment">// ✅ 正确做法</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'MOCK_REQUEST'</span> }, <span class="hljs-string">'*'</span>);  <span class="hljs-comment">// injected.js 发送</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'message'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> { ... });  <span class="hljs-comment">// content.js 接收</span>
</code></pre>
<p><strong>原因：</strong> content.js 和 injected.js 虽然在同一个网页，但 JavaScript 环境是隔离的，就像两个平行世界，只能通过 <code>postMessage</code> 这个"传送门"通信。</p>
<h3 data-id="heading-33">4. <strong>为什么要保存原始 fetch、xhr？</strong></h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> originalFetch = <span class="hljs-variable language_">window</span>.<span class="hljs-property">fetch</span>;  <span class="hljs-comment">//  必须先保存</span>

<span class="hljs-variable language_">window</span>.<span class="hljs-property">fetch</span> = <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">url</span>) {
  <span class="hljs-keyword">if</span> (needMock) {
    <span class="hljs-keyword">return</span> mockResponse;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">originalFetch</span>(url);  <span class="hljs-comment">//  不 Mock 时调用原始方法</span>
};
</code></pre>
<p><strong>原因：</strong> 如果不保存，所有请求都会被拦截，无法发送真实请求。</p>
<h2 data-id="heading-34">总结</h2>
<h3 data-id="heading-35">核心要点</h3>
<ol>
<li><strong>根本原理</strong>：重写 <code>window.fetch</code> 和 <code>XMLHttpRequest</code>，在网页代码执行前劫持请求</li>
<li><strong>为什么分两个脚本</strong>：content.js 能读插件配置，injected.js 能拦截请求</li>
<li><strong>怎么通信</strong>：<code>postMessage</code>（唯一方式）</li>
<li><strong>什么时候注入</strong>：<code>document_start</code>（越早越好）</li>
<li><strong>为什么能拦截</strong>：在网页代码执行前就替换了原生方法</li>
</ol>
<h3 data-id="heading-36">适用场景</h3>
<ul>
<li>前端开发时，后端接口还没好</li>
<li>调试线上 Bug，想临时改返回数据</li>
<li>演示 Demo，不想依赖真实服务器</li>
<li>自动化测试，需要稳定的 Mock 数据</li>
<li>接口文档不完善，想自己造数据测试</li>
</ul>
<h3 data-id="heading-37">最后</h3>
<p>如果这个插件帮到了你，欢迎：</p>
<ul>
<li>如果觉得对您有帮助，欢迎点赞 👍 收藏 ⭐ 关注 🔔 支持一下！</li>
<li>⭐ <strong>GitHub Star 支持</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTeernage%2Fquick-mock" target="_blank" title="https://github.com/Teernage/quick-mock" ref="nofollow noopener noreferrer">github.com/Teernage/qu…</a></li>
<li>💬 <strong>评论区聊聊你的使用场景</strong></li>
</ul>
<p>这个插件会持续优化，支持更丰富的配置项、更好的交互等</p>
<p><strong>如果你有好的想法，欢迎在评论区或 GitHub Issue 提出！</strong></p>
<blockquote>
<p>如果觉得对您有帮助，欢迎点赞 👍 收藏 ⭐ 关注 🔔 支持一下！</p>
<p><strong>往期实战推荐：</strong></p>
<ul>
<li>
<p><a href="https://juejin.cn/post/7549096640340426802" target="_blank" title="https://juejin.cn/post/7549096640340426802">Vue3 后台分页写腻了？我用 1 个 Hook 删掉 90% 重复代码（附源码）</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7511332054941188147" target="_blank" title="https://juejin.cn/post/7511332054941188147">⚡ 一个Vue自定义指令搞定丝滑拖拽列表，告别复杂组件封装
</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7543806966926802971" target="_blank" title="https://juejin.cn/post/7543806966926802971">🔥 这才是 Vue 驱动的 Chrome 插件工程化正确打开方式</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7566299971643424819" target="_blank" title="https://juejin.cn/post/7566299971643424819">  老板问我：AI真能一键画广州旅游路线图？我用 MCP 现场开图</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7559124639323242506" target="_blank" title="https://juejin.cn/post/7559124639323242506">【前端效率工具】：告别右键另存，不到 50 行代码一键批量下载网页图片</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7561612065707065390" target="_blank" title="https://juejin.cn/post/7561612065707065390"> 女朋友炸了：刚打开的网页怎么又没了？我反手甩出一键恢复按钮！</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7562859113246343178" target="_blank" title="https://juejin.cn/post/7562859113246343178"> 你家孩子又偷玩网页游戏? 试试这个防沉迷工具</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7563830723057647643" target="_blank" title="https://juejin.cn/post/7563830723057647643">  她说想要浪漫，我把浏览器鼠标换成了柴犬，点一下就有烟花（附源码）</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7566677296801071155" target="_blank" title="https://juejin.cn/post/7566677296801071155"> 女朋友被链接折磨疯了，我写了个工具一键解救</a></p>
</li>
<li>
<p><a href="https://juejin.cn/post/7568055953310662707" target="_blank" title="https://juejin.cn/post/7568055953310662707"> 上班摸鱼看掘金，老板突然出现在身后...</a></p>
</li>
</ul>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[肝了半个月，我用 Flutter 写了个功能强大的图片编辑器，告别image_cropper]]></title>    <link>https://juejin.cn/post/7571067260053585946</link>    <guid>https://juejin.cn/post/7571067260053585946</guid>    <pubDate>2025-11-11T07:40:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571067260053585946" data-draft-id="7571086754880307246" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="肝了半个月，我用 Flutter 写了个功能强大的图片编辑器，告别image_cropper"/> <meta itemprop="keywords" content="前端,Android,Flutter"/> <meta itemprop="datePublished" content="2025-11-11T07:40:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小林的跨端开发日记"/> <meta itemprop="url" content="https://juejin.cn/user/3320949647350765"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            肝了半个月，我用 Flutter 写了个功能强大的图片编辑器，告别image_cropper
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3320949647350765/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小林的跨端开发日记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T07:40:58.000Z" title="Tue Nov 11 2025 07:40:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    132
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言：为什么需要图片编辑？</h2>
<p>在如今的应用开发中，图片处理几乎是社交、电商、工具类 App 的标配功能。用户上传头像需要裁剪，分享美图需要编辑，添加水印需要文字功能，为 App 添加一个头像上传功能等等...这些听起来像是一个再普通不过的需求。产品经理的要求也很简单：“用户选完图片，能把它裁成 1:1 的正方形就行。”</p>
<p>于是，我像往常一样打开 <code>pub.dev</code>，很快就找到 <code>image_cropper</code>。看起来完美，对吧？</p>
<p><strong>然而，现实很快就给了我一记重拳。</strong></p>
<p>当我把这个功能集成进我跨平台的 Flutter 应用后，一连串的问题浮出水面：</p>
<ol>
<li><strong>UI/UX 的巨大鸿沟</strong>：<code>image_cropper</code> 的核心是<strong>通过 <code>MethodChannel</code> 调用原生插件</strong>。这直接导致了 Android 和 iOS 两端的裁剪界面（UI）和交互体验（UX）存在巨大差异。对于我这样追求品牌一致性和统一用户体验的团队来说，这几乎是不可接受的。</li>
<li><strong>桌面端的缺失</strong>：我的应用需要支持 Windows 和 Mac，而 <code>image_cropper</code> 在桌面端的支持并不理想，这直接堵死了我的全平台之路。</li>
<li><strong>扩展性的枷锁</strong>：产品经理紧接着说：“我后续的内容模块需要16:9的封面图，商品模块可能需要自由裁剪……” 我意识到，一个基于原生UI封装的库，很难满足我未来灵活多变的裁剪比例需求。</li>
<li><strong>性能的隐忧</strong>：后端同事也发来提醒：“上传的图片不能太大，最好能在客户端压缩一下，不然服务器和带宽顶不住！” 这意味着我不仅要裁剪，还需要在<strong>不严重损失画质的前提下，对图片进行缩放（Scale）处理，以达到压缩体积的效果</strong>。而这一点，<code>image_cropper</code> 提供的控制力非常有限。</li>
</ol>
<p>面对这些“卡脖子”的问题，我意识到，我需要的不只是一个“能用”的裁剪工具。我需要的是一个<strong>纯 Dart 实现、跨平台 UI 完全一致、功能高度可控、并且能精细化处理图片尺寸</strong>的解决方案。</p>
<p>市面上没有现成的轮子，那就自己造一个！</p>
<p>于是，我肝了半个月，从零开始，用 <code>CustomPaint</code> 和矩阵变换硬核打造了这款全新的 Flutter 图片编辑器。它不仅解决了上述所有痛点，还带来了更多惊喜：</p>
<ul>
<li><strong>像素级无损裁剪</strong>：支持任意比例和自由裁剪，保证画质。</li>
<li><strong>内置缩放压缩</strong>：在裁剪的同时，通过精密的 <code>scale</code> 计算，有效控制输出图片的尺寸和体积。</li>
<li><strong>跨平台体验完全一致</strong>：纯 Dart 绘制，告别平台差异。</li>
<li><strong>不止是裁剪</strong>：它还集成了 360° 自由旋转、功能完善的文本添加与编辑，以及健全的撤销/重做历史管理机制。</li>
</ul>
<p><strong>先来看看最终效果</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07f0efb092c1440f909ae9c2aefa49dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6X55qE6Leo56uv5byA5Y-R5pel6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763455838&amp;x-signature=Qsa0mxmuRvd67ONg4cF6P44Eqxs%3D" alt="Simulator Screenshot - iPhone 16 Plus - 2025-11-11 at 15.15.17.png" loading="lazy"/></p>
<ul>
<li>图1:图片编辑主界面：回滚、裁剪、渲染、贴图、撤销</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f2282066c75447399d6a1f853e18e31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6X55qE6Leo56uv5byA5Y-R5pel6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763455838&amp;x-signature=Eo7KzB269GtkQTFAGWcCHg9Q%2B%2FE%3D" alt="Simulator Screenshot - iPhone 16 Plus - 2025-11-11 at 15.15.45.png" loading="lazy"/></p>
<ul>
<li>图2:图片裁剪主界面：自由比例、特定比例</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d9a3ef6df0442fcb11e0c01a94dfd5e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6X55qE6Leo56uv5byA5Y-R5pel6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763455838&amp;x-signature=%2FIpMssrJ%2F%2Fhz6JTM%2FNXJznB93%2FY%3D" alt="Simulator Screenshot - iPhone 16 Plus - 2025-11-11 at 15.16.02.png" loading="lazy"/></p>
<ul>
<li>图3:图片旋转主界面：自由角度、特定角度</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca18dd1b054346a4834ea9e7da72937c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6X55qE6Leo56uv5byA5Y-R5pel6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763455838&amp;x-signature=Cr1GCUfI9YxtQ3NvkyOvI8GCKiM%3D" alt="Simulator Screenshot - iPhone 16 Plus - 2025-11-11 at 15.16.35.png" loading="lazy"/></p>
<ul>
<li>图4:图片贴图主界面</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe8831c4cf714fe48df71482b197a1b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5p6X55qE6Leo56uv5byA5Y-R5pel6K6w:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763455838&amp;x-signature=9eS5K1%2F43E4ixoQd6OphLua4GAo%3D" alt="Simulator Screenshot - iPhone 16 Plus - 2025-11-11 at 15.17.01.png" loading="lazy"/></p>
<ul>
<li>原图和编辑后的对比：压缩系数（可配置）</li>
</ul>
<h2 data-id="heading-1">编辑器的架构设计</h2>
<p>一个复杂的系统，好的架构是成功的一半。我不想把所有逻辑都堆在一个臃肿的 <code>StatefulWidget</code> 里，那样会变成难以维护的“上帝类”。因此，我从一开始就确立了**“关注点分离”**的核心设计原则。</p>
<p>整个编辑器被拆分为以下几个层次：</p>
<ul>
<li>
<p><strong>视图层 (View)</strong> ：由 <code>ImageEditorView</code> 和 <code>CustomPainter</code> 组成，纯粹负责UI的渲染和用户手势的捕获。它本身不包含任何业务逻辑。</p>
</li>
<li>
<p><strong>控制器 (Controller)</strong> ：<code>ImageEditorController</code> 是整个编辑器的“大脑”。它继承自 <code>ChangeNotifier</code>，负责管理所有状态（图片、旋转角度、裁剪框、文本层等），处理业务逻辑，并通知视图层更新。</p>
</li>
<li>
<p><strong>模型层 (Model)</strong> -：<code>TextLayerData</code>, <code>ImageEditorConfig</code> 等，就是最纯粹的数据结构。</p>
</li>
<li>
<p><strong>处理器/管理器 (Handlers/Managers)</strong> ：这是本次设计的精髓。我将不同功能的复杂逻辑抽离成独立的类，让 Controller 保持清爽，只做“指挥官”。</p>
<ul>
<li><code>CropHandler</code>: 负责所有与裁剪相关的计算，如初始化裁剪框、限制边界、执行高保真裁剪。</li>
<li><code>RotationHandler</code>: 负责渲染旋转后的图片。</li>
<li><code>TextLayerManager</code>: 专门管理文本图层的增删改查和状态。</li>
<li><code>HistoryManager</code>: 负责管理操作快照，实现撤销和重做。</li>
</ul>
</li>
</ul>
<p>这种分层架构带来了巨大的好处：</p>
<ol>
<li><strong>高内聚，低耦合</strong>：每个模块只关心自己的职责，修改裁剪逻辑不会影响文本功能。</li>
<li><strong>易于测试</strong>：可以单独对 <code>CropHandler</code> 或 <code>HistoryManager</code> 进行单元测试。</li>
<li><strong>可扩展性强</strong>：未来想增加“滤镜”功能？只需要新增一个 <code>FilterHandler</code>，然后在 Controller 中集成即可，对现有代码的侵入极小。</li>
</ol>
<h2 data-id="heading-2">万物皆可绘：CustomPaint 的魔力</h2>
<p>编辑器的核心显示区域，本质上是一个画布（Canvas），我需要在上面自由地绘制图片、裁剪框、文本等元素。在 Flutter 中，<code>CustomPaint</code> 和 <code>CustomPainter</code> 是实现这一需求的最佳选择。</p>
<p>我的 <code>ImageEditorPainter</code> 的 <code>paint</code> 方法，就像一位画家在按步骤作画：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// ImageEditorPainter.dart</span>
<span class="hljs-meta">@override</span>
<span class="hljs-keyword">void</span> paint(Canvas canvas, Size size) {
    <span class="hljs-comment">// ... 获取 controller 中的各种状态 ...</span>

    <span class="hljs-comment">// --- 1. 绘制变换后的图片 ---</span>
    <span class="hljs-comment">// 这是核心绘制逻辑，保证图片居中显示并应用旋转和缩放</span>
    <span class="hljs-keyword">final</span> canvasCenterX = size.width / <span class="hljs-number">2</span>;
    <span class="hljs-keyword">final</span> canvasCenterY = size.height / <span class="hljs-number">2</span>;
    canvas.save(); <span class="hljs-comment">// 保存当前画布状态</span>
    canvas.translate(canvasCenterX, canvasCenterY); <span class="hljs-comment">// 将画布原点移到中心</span>
    canvas.rotate(rotationAngle); <span class="hljs-comment">// 旋转</span>
    canvas.scale(scale, scale); <span class="hljs-comment">// 缩放</span>
    <span class="hljs-comment">// 以图片中心为原点绘制</span>
    canvas.drawImage(image, Offset(-image.width / <span class="hljs-number">2</span>, -image.height / <span class="hljs-number">2</span>), paint);
    canvas.restore(); <span class="hljs-comment">// 恢复画布状态，后续绘制不受影响</span>

    <span class="hljs-comment">// --- 2. 如果裁剪激活，则绘制裁剪UI ---</span>
    <span class="hljs-keyword">if</span> (isCropping &amp;&amp; cropRect != <span class="hljs-keyword">null</span>) {
      _drawCropUI(canvas, size, cropRect, handleSize);
    }

    <span class="hljs-comment">// --- 3. 绘制所有文本图层 ---</span>
    _drawTextLayers(canvas, size);
}
</code></pre>
<p>这里有几个关键点：</p>
<ol>
<li><strong><code>canvas.save()</code> 和 <code>canvas.restore()</code></strong> ：这对组合是 <code>Canvas</code> 操作的黄金法则。它能确保我的变换（平移、旋转、缩放）只对绘制图片生效，而不会影响后续裁剪框和文本的绘制。</li>
<li><strong>中心点变换</strong>：所有的变换都围绕画布中心进行，这样可以保证用户在缩放和旋转时，视觉焦点始终在图片中心，体验更自然。</li>
<li><strong>绘制裁剪蒙层</strong>：一个有趣的小技巧是，如何绘制裁剪框外部的半透明蒙层？我可以利用 <code>Path</code> 的 <code>fillType = PathFillType.evenOdd</code> 属性。</li>
</ol>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// ImageEditorPainter.dart -&gt; _drawCropUI</span>
<span class="hljs-keyword">void</span> _drawCropUI(...) {
    <span class="hljs-comment">// ...</span>
    <span class="hljs-comment">// 创建一个包含两个矩形的路径：一个是整个画布，一个是裁剪框</span>
    Path overlayPath = Path()
      ..addRect(Rect.fromLTWH(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, size.width, size.height))
      ..addRect(currentCropRect)
      ..fillType = PathFillType.evenOdd; <span class="hljs-comment">// 设置为 evenOdd 填充规则</span>
    
    <span class="hljs-comment">// 绘制这个路径，Canvas 会自动填充两个矩形之间的区域</span>
    canvas.drawPath(overlayPath, overlayPaint);
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>通过 <code>CustomPaint</code>，获得了对UI像素级的完全掌控力，为实现复杂的交互效果打下了基础。</p>
<h2 data-id="heading-3">坐标系与高保真裁剪的实现</h2>
<p>这是整个编辑器技术含量最高，也是最难啃的一块硬骨头。</p>
<p><strong>问题是什么？</strong><br/>
用户在屏幕上看到的是一张经过<strong>缩放</strong>和<strong>旋转</strong>的图片。当他拖动裁剪框时，这个裁剪框的坐标是相对于<strong>屏幕</strong>的（我称之为“屏幕坐标系”）。但我的最终目标，是从那张<strong>未经任何变换的、原始高分辨率的图片</strong>（“图片坐标系”）中，精确地切出对应的部分。</p>
<p>如果只是简单地对屏幕内容进行截图，图片质量会严重下降，这是不可接受的。我必须实现<strong>高保真裁剪</strong>。</p>
<p><strong>解决方案：矩阵变换的魔法！</strong></p>
<p>线性代数中的矩阵，是连接不同坐标系的桥梁。我的思路是：</p>
<ol>
<li>构建一个从“图片坐标系”到“屏幕坐标系”的变换矩阵 <code>M</code>。</li>
<li>求出 <code>M</code> 的逆矩阵 <code>M⁻¹</code>，它就是从“屏幕坐标系”返回“图片坐标系”的钥匙。</li>
<li>将屏幕上裁剪框的四个顶点，通过 <code>M⁻¹</code> 变换，得到它们在原始图片上的精确坐标。</li>
<li>根据这四个点，计算出一个能完全包裹它们的最小矩形（<code>sourceRect</code>）。</li>
<li>使用 <code>canvas.drawImageRect</code>，从原始图片中挖出 <code>sourceRect</code> 区域，绘制到一个新的、尺寸完美匹配的画布上，从而生成一张全新的、高保真裁剪后的图片。</li>
</ol>
<p>核心代码在 <code>CropHandler.captureHiResCroppedImage</code> 中：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// CropHandler.dart</span>
<span class="hljs-keyword">static</span> Future&lt;ui.Image?&gt; captureHiResCroppedImage(...) <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 1. 计算从"图片坐标系"到"屏幕坐标系"的变换矩阵</span>
    <span class="hljs-keyword">final</span> Matrix4 matrixToScreen = CoordinateTransformer.createImageToScreenMatrix(...);

    <span class="hljs-comment">// 2. 求逆矩阵</span>
    <span class="hljs-keyword">final</span> Matrix4 screenToImageMatrix = Matrix4.inverted(matrixToScreen);

    <span class="hljs-comment">// 3. 将屏幕上的裁剪框的四个角，通过逆矩阵变换回图片上的坐标</span>
    <span class="hljs-keyword">final</span> topLeft = MatrixUtils.transformPoint(screenToImageMatrix, cropRect.topLeft);
    <span class="hljs-comment">// ... (transform other 3 corners)</span>

    <span class="hljs-comment">// 4. 计算能完全包围这四个点的、在图片坐标系中的矩形边界 (sourceRect)</span>
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> minX = [topLeft.dx, ...].reduce(math.min);
    <span class="hljs-comment">// ... (calculate maxX, minY, maxY)</span>
    <span class="hljs-keyword">final</span> Rect sourceRect = Rect.fromLTRB(minX, minY, maxX, maxY);

    <span class="hljs-comment">// 5. 计算新图片的尺寸（高保真尺寸）</span>
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> newWidth = sourceRect.width.round();
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> newHeight = sourceRect.height.round();

    <span class="hljs-comment">// 6. 使用 PictureRecorder 和 drawImageRect 进行高保真绘制</span>
    <span class="hljs-keyword">final</span> recorder = ui.PictureRecorder();
    <span class="hljs-keyword">final</span> canvas = Canvas(recorder, Rect.fromLTWH(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, newWidth.toDouble(), newHeight.toDouble()));
    <span class="hljs-keyword">final</span> Rect destinationRect = Rect.fromLTWH(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, newWidth.toDouble(), newHeight.toDouble());

    <span class="hljs-comment">// 核心：从原图的 sourceRect 区域，绘制到新画布的 destinationRect 区域</span>
    canvas.drawImageRect(image, sourceRect, destinationRect, Paint());

    <span class="hljs-comment">// 7. 生成最终的高清图片</span>
    <span class="hljs-keyword">final</span> picture = recorder.endRecording();
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> picture.toImage(newWidth, newHeight);
}
</code></pre>
<p>这个过程完美地解决了因旋转和缩放带来的坐标系差异问题，保证了每一次裁剪都是像素级的无损操作。同样，在最终导出图片时，文本的绘制也遵循了类似的坐标变换逻辑，确保文字能被高清地“印”在最终的图片上。</p>
<h2 data-id="heading-4">文本与历史记录管理</h2>
<p>除了硬核的裁剪，一些“软”功能的设计同样重要，它们直接决定了用户体验。</p>
<h3 data-id="heading-5">1. 文本管理 (<code>TextLayerManager</code>)</h3>
<p>添加文本不仅仅是在画布上画几个字那么简单，我需要管理多个文本层，支持对它们进行独立的移动、样式修改和删除。</p>
<p><code>TextLayerManager</code> 内部使用一个 <code>Map&lt;String, TextLayerData&gt;</code> 来存储所有文本层，以 <code>id</code> 作为键，实现了 O(1) 复杂度的快速查找。</p>
<p>它负责处理：</p>
<ul>
<li><strong>命中测试</strong>：当用户点击屏幕时，<code>selectLayerAt</code> 方法会遍历所有文本层，计算它们的边界框（<code>_getTextLayerBounds</code>），判断点击位置是否落在某个文本层内，从而实现选中。</li>
<li><strong>状态管理</strong>：管理当前选中的文本层 ID (<code>_selectedLayerId</code>)，并提供更新颜色、大小、位置的接口。</li>
<li><strong>数据隔离</strong>：所有文本相关的状态都内聚在 <code>TextLayerManager</code> 中，<code>ImageEditorController</code> 只需调用其API即可，无需关心内部实现。</li>
</ul>
<h3 data-id="heading-6">2. 时间旅行 (<code>HistoryManager</code>)</h3>
<p>一个专业的编辑器，怎能没有撤销/重做功能？我通过<strong>备忘录模式</strong>实现了这个功能。</p>
<ul>
<li><strong><code>EditorStateSnapshot</code></strong>：这是一个数据类，像一个“快照”，保存了某一时刻编辑器的所有关键状态（<code>ui.Image</code> 对象、文本层列表、旋转角度等）。</li>
<li><strong><code>HistoryManager</code></strong>：它内部维护一个 <code>List&lt;EditorStateSnapshot&gt;</code> 列表，作为历史堆栈。</li>
</ul>
<p><strong>工作流程是这样的：</strong></p>
<ol>
<li><strong>保存快照</strong>：在执行一个“破坏性”操作（如应用裁剪、应用旋转）<strong>之前</strong>，调用 <code>_historyManager.saveSnapshot()</code>，将当前状态推入堆栈。</li>
<li><strong>撤销操作</strong>：当用户点击“撤销”时，调用 <code>_historyManager.popSnapshot()</code>，取出最近的一个快照，然后用快照中的数据恢复 <code>ImageEditorController</code> 的状态。</li>
</ol>
<p>这里需要注意一个细节：在保存快照时，对于 <code>List&lt;TextLayerData&gt;</code> 这样的可变对象，必须进行<strong>深拷贝</strong>，否则后续对文本的修改会污染历史记录。而 <code>ui.Image</code> 是不可变对象，可以直接引用，这为我省了不少事。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// HistoryManager.dart</span>
<span class="hljs-keyword">void</span> saveSnapshot(...) {
    <span class="hljs-comment">// 深拷贝文本图层列表</span>
    <span class="hljs-keyword">final</span> copiedTextLayers = textLayers.map((layer) =&gt; layer.clone()).toList();

    <span class="hljs-keyword">final</span> snapshot = EditorStateSnapshot(
      image: image, <span class="hljs-comment">// ui.Image 是不可变的，可以直接引用</span>
      textLayers: copiedTextLayers,
      <span class="hljs-comment">// ...</span>
    );
    _snapshots.add(snapshot);
    <span class="hljs-comment">// ... (限制历史记录数量)</span>
}
</code></pre>
<p>通过 <code>HistoryManager</code>，我赋予了用户“反悔”的权利，大大提升了编辑器的容错性和用户体验。</p>
<h2 data-id="heading-7">可配置的导出压缩，为服务器减负</h2>
<p>在前面我提到了一个非常现实的痛点：用户上传的原始图片动辄几兆甚至十几兆，如果直接上传，会给服务器的<strong>带宽和存储</strong>带来巨大压力，同时也会消耗用户大量的移动数据。因此，在客户端进行<strong>高质量的预压缩</strong>，是企业级应用不可或缺的一环。</p>
<p>我的目标很明确：</p>
<ol>
<li><strong>压缩过程对用户无感</strong>：用户只需要正常编辑，在最后导出时自动完成。</li>
<li><strong>压缩比率可配置</strong>：允许开发者根据不同的业务场景（如头像、封面、普通插图）灵活设置压缩强度。</li>
<li><strong>保证画质</strong>：不能因为压缩就让图片变得模糊不堪，要在体积和质量之间找到最佳平衡。</li>
</ol>
<p>基于这些目标，我设计了一套优雅的、基于 <code>scale</code> 的压缩方案。</p>
<h3 data-id="heading-8">1. 设计思路：分离与配置</h3>
<p>我没有将压缩逻辑耦合在裁剪或旋转等任何一个编辑步骤中。编辑过程始终应该在最高保真度的图像上进行，以保证操作的精确性。压缩，应该是<strong>导出前（Export）的最后一道工序</strong>。</p>
<p>为此，我引入了 <code>ImageCompressionConfig</code> 配置类，并将其作为 <code>ImageEditorConfig</code> 的一部分：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// models/editor_models.dart</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageEditorConfig</span> </span>{
  <span class="hljs-comment">// ... 其他配置</span>
  <span class="hljs-keyword">final</span> ImageCompressionConfig? compression;
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageCompressionConfig</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">bool</span> enabled; <span class="hljs-comment">// 是否启用压缩</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> scale; <span class="hljs-comment">// 压缩比例，例如 0.5 表示尺寸变为原来的一半</span>

  <span class="hljs-keyword">const</span> ImageCompressionConfig({
    <span class="hljs-keyword">this</span>.enabled = <span class="hljs-keyword">true</span>,
    <span class="hljs-keyword">this</span>.scale = <span class="hljs-number">0.5</span>,
  });
}
</code></pre>
<p>这样的设计让压缩功能变成了一个<strong>可插拔、可配置</strong>的模块。开发者在初始化编辑器时，可以轻松地决定是否启用压缩以及压缩到什么程度。</p>
<h3 data-id="heading-9">2. 实现揭秘：<code>exportImage</code> 的处理流水线</h3>
<p>当用户点击“完成”并调用 <code>exportImage()</code> 方法时，一条精密的流水线就开始工作了：</p>
<p><code>exportImage() -&gt; _captureTransformedImage() -&gt; _applyCompressionIfNeeded() -&gt; 返回最终图片</code></p>
<ol>
<li><strong><code>_captureTransformedImage()</code></strong> : 首先，无论是否压缩，我们都需要先将用户的所有编辑操作（旋转、裁剪、添加文本等）应用，生成一张“所见即所得”的高保真中间图。</li>
<li><strong><code>_applyCompressionIfNeeded()</code></strong> : 接着，这张高保真图被传递给压缩处理器。这个方法是实现压缩的核心。</li>
</ol>
<p>让我们深入 <code>_applyCompressionIfNeeded</code> 的源码，看看魔法是如何发生的：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// ImageEditorController.dart</span>

Future&lt;ui.Image&gt; _applyCompressionIfNeeded(ui.Image image) <span class="hljs-keyword">async</span> {
  <span class="hljs-comment">// 1. 从配置中读取压缩设置</span>
  <span class="hljs-keyword">final</span> ImageCompressionConfig? compressionConfig = config.compression;
  <span class="hljs-keyword">if</span> (compressionConfig == <span class="hljs-keyword">null</span> || !compressionConfig.enabled) {
    <span class="hljs-keyword">return</span> image; <span class="hljs-comment">// 如果未配置或未启用，直接返回原图</span>
  }
  
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> scale = compressionConfig.scale;
  <span class="hljs-keyword">if</span> (scale &lt;= <span class="hljs-number">0</span> || scale &gt;= <span class="hljs-number">1.0</span>) {
    <span class="hljs-keyword">return</span> image; <span class="hljs-comment">// 无效的 scale 值，不处理</span>
  }

  <span class="hljs-comment">// 2. 根据 scale 计算目标尺寸</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> targetWidth = math.max(<span class="hljs-number">1</span>, (image.width * scale).round());
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> targetHeight = math.max(<span class="hljs-number">1</span>, (image.height * scale).round());

  <span class="hljs-comment">// 3. 使用 PictureRecorder 和 drawImageRect 进行高质量缩放</span>
  <span class="hljs-keyword">final</span> ui.PictureRecorder recorder = ui.PictureRecorder();
  <span class="hljs-keyword">final</span> Canvas canvas = Canvas(recorder);
  
  <span class="hljs-keyword">final</span> Rect srcRect = Rect.fromLTWH(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, image.width.toDouble(), image.height.toDouble());
  <span class="hljs-keyword">final</span> Rect dstRect = Rect.fromLTWH(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, targetWidth.toDouble(), targetHeight.toDouble());
  
  <span class="hljs-comment">// 4. [关键] 设置高质量的绘制滤镜</span>
  <span class="hljs-keyword">final</span> Paint paint = Paint()..filterQuality = FilterQuality.high;

  canvas.drawImageRect(image, srcRect, dstRect, paint);

  <span class="hljs-comment">// 5. 生成新的、尺寸更小的图片</span>
  <span class="hljs-keyword">final</span> ui.Picture picture = recorder.endRecording();
  <span class="hljs-keyword">final</span> ui.Image resized = <span class="hljs-keyword">await</span> picture.toImage(targetWidth, targetHeight);
  
  <span class="hljs-comment">// 6. [关键] 释放旧的大图内存</span>
  _disposeImage(image); 
  
  <span class="hljs-keyword">return</span> resized;
}
</code></pre>
<p>这段代码虽然不长，但处处体现着精心的设计：</p>
<ul>
<li><strong>计算目标尺寸 (步骤2)</strong> ：通过将原始宽高乘以 <code>scale</code> 因子，我们得到了压缩后的目标尺寸。这是整个方案的数学基础。</li>
<li><strong><code>drawImageRect</code> (步骤3)</strong> ：这个 Flutter <code>Canvas</code> 的 API 是实现缩放的关键。它允许我们将一个源矩形（<code>srcRect</code>，即整个原始大图）绘制到一个目标矩形（<code>dstRect</code>，即我们计算出的小尺寸矩形）中。在绘制过程中，Flutter 引擎会自动为我们完成像素的插值和缩放。</li>
<li><strong>画质的秘密武器 (步骤4)</strong> ：仅仅缩放是不够的，如何保证画质？答案是 <code>Paint</code> 对象的 <code>filterQuality</code> 属性。将其设置为 <code>FilterQuality.high</code>，会告诉 Flutter 引擎使用更高级、更平滑的算法（通常是双线性或双三次插值）来处理像素，从而在缩小图片时最大程度地保留细节，避免出现锯齿和马赛克。</li>
<li><strong>内存管理的典范 (步骤6)</strong> ：在生成了新的、小尺寸的 <code>resized</code> 图片后，那张作为输入的、高保真的 <code>image</code> 就完成了它的历史使命。通过调用 <code>_disposeImage(image)</code> 主动释放其占用的内存，可以有效避免应用因处理大图而导致的内存峰值，这对于移动设备尤其重要。</li>
</ul>
<h5 data-id="heading-10">3. 优势总结</h5>
<p>通过这种基于 <code>scale</code> 和 <code>drawImageRect</code> 的方案，我们实现了一个非常理想的客户端压缩功能：</p>
<ul>
<li><strong>逻辑解耦</strong>：压缩与编辑功能完全分离，代码清晰，易于维护。</li>
<li><strong>高度可控</strong>：通过 <code>ImageEditorConfig</code>，开发者可以像开关一样控制压缩，并精确调整压缩比。</li>
<li><strong>质量优先</strong>：利用 <code>FilterQuality.high</code> 保证了即使在较大比例压缩下，也能获得令人满意的视觉效果。</li>
<li><strong>性能友好</strong>：即时释放无用的大图资源，体现了优秀的内存管理意识。</li>
</ul>
<p>最终，这个“点睛之笔”不仅提升了用户体验（更快的上传速度），也实实在在地为后端的服务器减轻了负担，实现了双赢。</p>
<h2 data-id="heading-11">快速开始</h2>
<p><code>flutter pub add flutter_img_editor</code></p>
<p>或者</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">dependencies:</span>
  <span class="hljs-attr">flutter_img_editor:</span> <span class="hljs-string">^0.0.3</span> <span class="hljs-comment"># 使用最新版本</span>
</code></pre>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'dart:io'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'dart:ui'</span> <span class="hljs-keyword">as</span> ui;

<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter_img_editor/image_editor.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:image_picker/image_picker.dart'</span>;

<span class="hljs-keyword">import</span> <span class="hljs-string">'more_page.dart'</span>;

<span class="hljs-keyword">void</span> main() {
  runApp(<span class="hljs-keyword">const</span> MyApp());
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">const</span> MyApp({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> MaterialApp(
      title: <span class="hljs-string">'Image Editor 示例'</span>,
      theme: ThemeData(
        colorScheme: ColorScheme.fromSeed(seedColor: Colors.deepPurple),
        useMaterial3: <span class="hljs-keyword">true</span>,
      ),
      home: <span class="hljs-keyword">const</span> MyHomePage(),
    );
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyHomePage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> MyHomePage({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  State&lt;MyHomePage&gt; createState() =&gt; _MyHomePageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MyHomePageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">MyHomePage</span>&gt; </span>{
  <span class="hljs-keyword">final</span> ImagePicker _picker = ImagePicker();

  <span class="hljs-comment">// 相册图片</span>
  ui.Image? _pickerOriginal;
  ui.Image? _pickerEdited;
  <span class="hljs-built_in">String?</span> _pickerTempPath;
  <span class="hljs-built_in">Duration?</span> _pickerTempDuration;

  <span class="hljs-comment">// 是否正在选择相册图片</span>
  <span class="hljs-built_in">bool</span> _isPickingImage = <span class="hljs-keyword">false</span>;

  <span class="hljs-keyword">void</span> _showSnack(<span class="hljs-built_in">String</span> message) {
    <span class="hljs-keyword">if</span> (!mounted) <span class="hljs-keyword">return</span>;
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text(message)),
    );
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(
        title: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'Image Editor 示例'</span>),
        actions: [
          TextButton(
            onPressed: _openMorePage,
            style: TextButton.styleFrom(
              foregroundColor: Theme.of(context).colorScheme.onPrimary,
            ),
            child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'更多示例'</span>),
          ),
        ],
      ),
      body: SafeArea(
        child: ListView(
          padding: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">16</span>),
          children: [
            _buildIntroCard(),
            _buildPickerDemo(),
            _buildPerformanceNote(),
          ],
        ),
      ),
    );
  }

  <span class="hljs-keyword">void</span> _openMorePage() {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (_) =&gt; <span class="hljs-keyword">const</span> MorePage(),
      ),
    );
  }

  Card _buildIntroCard() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> Card(
      child: Padding(
        padding: EdgeInsets.all(<span class="hljs-number">16</span>),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              <span class="hljs-string">'本页聚焦 image_picker 相册流程，演示如何快速打开图片编辑器并保存编辑结果。'</span>,
            ),
            SizedBox(height: <span class="hljs-number">8</span>),
            Text(
              <span class="hljs-string">'想了解内置 Asset、相机拍照与网络下载场景，请点击右上角“更多示例”。'</span>,
              style: TextStyle(color: Colors.black54),
            ),
          ],
        ),
      ),
    );
  }

  Card _buildPickerDemo() {
    <span class="hljs-keyword">return</span> Card(
      child: Padding(
        padding: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">16</span>),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            _buildHeader(
              title: <span class="hljs-string">'案例：Image Picker 相册'</span>,
              actions: [
                ElevatedButton.icon(
                  onPressed: _isPickingImage ? <span class="hljs-keyword">null</span> : _handlePickerEdit,
                  icon: <span class="hljs-keyword">const</span> Icon(Icons.photo_library),
                  label: Text(_isPickingImage ? <span class="hljs-string">'处理中...'</span> : <span class="hljs-string">'选择并编辑'</span>),
                ),
              ],
            ),
            <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">8</span>),
            <span class="hljs-keyword">const</span> Text(
              <span class="hljs-string">'直接通过 image_picker 选择本地相册图片后进入编辑器，'</span>
              <span class="hljs-string">'展示如何与外部端到端整合。'</span>,
            ),
            <span class="hljs-keyword">if</span> (_isPickingImage)
              <span class="hljs-keyword">const</span> Padding(
                padding: EdgeInsets.only(top: <span class="hljs-number">12</span>),
                child: LinearProgressIndicator(minHeight: <span class="hljs-number">3</span>),
              ),
            <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">16</span>),
            Row(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                _buildImagePanel(label: <span class="hljs-string">'原始'</span>, image: _pickerOriginal),
                <span class="hljs-keyword">const</span> SizedBox(width: <span class="hljs-number">16</span>),
                _buildImagePanel(label: <span class="hljs-string">'ui.Image'</span>, image: _pickerEdited),
                <span class="hljs-keyword">const</span> SizedBox(width: <span class="hljs-number">16</span>),
                _buildImagePanelFromPath(label: <span class="hljs-string">'path'</span>, path: _pickerTempPath),
              ],
            ),
            <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">12</span>),
            _buildPixelStats(_pickerOriginal, _pickerEdited),
            <span class="hljs-keyword">if</span> (_pickerTempPath != <span class="hljs-keyword">null</span>) ...[
              <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">16</span>),
              Text(
                <span class="hljs-string">'临时文件路径 (saveImageToTempFile):'</span>,
                style: Theme.of(context).textTheme.titleSmall,
              ),
              <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">4</span>),
              SelectableText(_pickerTempPath!),
              Text(
                <span class="hljs-string">'耗时: <span class="hljs-subst">${_pickerTempDuration != <span class="hljs-keyword">null</span> ? <span class="hljs-string">'<span class="hljs-subst">${_pickerTempDuration!.inMilliseconds}</span> ms'</span> : <span class="hljs-string">'--'</span>}</span>'</span>,
              ),
            ],
          ],
        ),
      ),
    );
  }

  Widget _buildHeader({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> title,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">List</span>&lt;Widget&gt; actions,
  }) {
    <span class="hljs-keyword">return</span> Row(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Expanded(
          child: Text(
            title,
            style: Theme.of(context).textTheme.titleMedium?.copyWith(
                  fontWeight: FontWeight.w600,
                ),
          ),
        ),
        Wrap(
          spacing: <span class="hljs-number">8</span>,
          runSpacing: <span class="hljs-number">8</span>,
          children: actions,
        ),
      ],
    );
  }

  Widget _buildImagePanel({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> label,
    <span class="hljs-keyword">required</span> ui.Image? image,
  }) {
    <span class="hljs-keyword">final</span> TextStyle? captionStyle =
        Theme.of(context).textTheme.labelMedium?.copyWith(
              color: Colors.grey.shade600,
            );
    <span class="hljs-keyword">return</span> Expanded(
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(label, style: Theme.of(context).textTheme.bodySmall),
          <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">6</span>),
          Container(
            height: <span class="hljs-number">180</span>,
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(<span class="hljs-number">12</span>),
              color: Colors.grey.shade100,
              border: Border.all(color: Colors.grey.shade300),
            ),
            child: ClipRRect(
              borderRadius: BorderRadius.circular(<span class="hljs-number">12</span>),
              child: image != <span class="hljs-keyword">null</span>
                  ? RawImage(
                      image: image,
                      fit: BoxFit.contain,
                    )
                  : Center(
                      child: Text(
                        <span class="hljs-string">'暂无图片'</span>,
                        style: captionStyle,
                      ),
                    ),
            ),
          ),
          <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">6</span>),
          Text(<span class="hljs-string">'像素: <span class="hljs-subst">${_pixelSize(image)}</span>'</span>, style: captionStyle),
        ],
      ),
    );
  }

  Widget _buildImagePanelFromPath({
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> label,
    <span class="hljs-keyword">required</span> <span class="hljs-built_in">String?</span> path,
  }) {
    <span class="hljs-keyword">final</span> captionStyle = Theme.of(context).textTheme.labelMedium?.copyWith(
          color: Colors.grey.shade600,
        );
    Widget child;
    <span class="hljs-keyword">if</span> (path != <span class="hljs-keyword">null</span>) {
      child = Image.file(
        File(path),
        fit: BoxFit.contain,
      );
    } <span class="hljs-keyword">else</span> {
      child = Center(
        child: Text(
          <span class="hljs-string">'暂无图片'</span>,
          style: captionStyle,
        ),
      );
    }
    <span class="hljs-keyword">return</span> Expanded(
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(label, style: Theme.of(context).textTheme.bodySmall),
          <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">6</span>),
          Container(
            height: <span class="hljs-number">180</span>,
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(<span class="hljs-number">12</span>),
              color: Colors.grey.shade100,
              border: Border.all(color: Colors.grey.shade300),
            ),
            child: ClipRRect(
              borderRadius: BorderRadius.circular(<span class="hljs-number">12</span>),
              child: child,
            ),
          ),
          <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">6</span>),
          <span class="hljs-keyword">if</span> (path != <span class="hljs-keyword">null</span>) Text(<span class="hljs-string">'文件大小: <span class="hljs-subst">${_fileSize(path)}</span>'</span>, style: captionStyle),
        ],
      ),
    );
  }

  Widget _buildPixelStats(ui.Image? original, ui.Image? edited) {
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> delta = _pixelDelta(original, edited);
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> originalMemory = _memoryUsage(original);
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> editedMemory = _memoryUsage(edited);
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> memoryDelta = _memoryDelta(original, edited);
    <span class="hljs-keyword">return</span> Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          <span class="hljs-string">'像素对比'</span>,
          style: Theme.of(context).textTheme.titleSmall,
        ),
        <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">4</span>),
        Text(<span class="hljs-string">'原始: <span class="hljs-subst">${_pixelSize(original)}</span>'</span>),
        Text(<span class="hljs-string">'编辑后: <span class="hljs-subst">${_pixelSize(edited)}</span>'</span>),
        <span class="hljs-keyword">if</span> (delta.isNotEmpty) Text(delta),
        <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">8</span>),
        Text(
          <span class="hljs-string">'内存估算（RGBA 32bit）'</span>,
          style: Theme.of(context).textTheme.titleSmall,
        ),
        <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">4</span>),
        Text(<span class="hljs-string">'原始: <span class="hljs-subst">$originalMemory</span>'</span>),
        Text(<span class="hljs-string">'编辑后: <span class="hljs-subst">$editedMemory</span>'</span>),
        <span class="hljs-keyword">if</span> (memoryDelta.isNotEmpty) Text(memoryDelta),
      ],
    );
  }

  <span class="hljs-built_in">String</span> _pixelSize(ui.Image? image) {
    <span class="hljs-keyword">if</span> (image == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'--'</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-string">'<span class="hljs-subst">${image.width}</span> x <span class="hljs-subst">${image.height}</span>'</span>;
  }

  <span class="hljs-built_in">String</span> _pixelDelta(ui.Image? original, ui.Image? edited) {
    <span class="hljs-keyword">if</span> (original == <span class="hljs-keyword">null</span> || edited == <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
    }
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> dw = edited.width - original.width;
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> dh = edited.height - original.height;
    <span class="hljs-built_in">String</span> fmt(<span class="hljs-built_in">int</span> value) =&gt; value &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">'+<span class="hljs-subst">$value</span>'</span> : value.toString();
    <span class="hljs-keyword">if</span> (dw == <span class="hljs-number">0</span> &amp;&amp; dh == <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'变化: 无 (像素保持不变)'</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">'变化: 宽度 <span class="hljs-subst">${fmt(dw)}</span>，高度 <span class="hljs-subst">${fmt(dh)}</span>'</span>;
  }

  <span class="hljs-built_in">String</span> _memoryUsage(ui.Image? image) {
    <span class="hljs-keyword">if</span> (image == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">'--'</span>;
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> bytes = image.width * image.height * <span class="hljs-number">4</span>;
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> mb = bytes / (<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-string">'<span class="hljs-subst">${mb.toStringAsFixed(<span class="hljs-number">2</span>)}</span> MB'</span>;
  }

  <span class="hljs-built_in">String</span> _memoryDelta(ui.Image? original, ui.Image? edited) {
    <span class="hljs-keyword">if</span> (original == <span class="hljs-keyword">null</span> || edited == <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
    }
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> originalPixels = original.width * original.height.toDouble();
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> editedPixels = edited.width * edited.height.toDouble();
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> diffBytes = (editedPixels - originalPixels) * <span class="hljs-number">4</span>;
    <span class="hljs-keyword">if</span> (diffBytes == <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'内存变化: 无 (像素点数量一致)'</span>;
    }
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> diffMb = diffBytes / (<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>);
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> sign = diffMb &gt; <span class="hljs-number">0</span> ? <span class="hljs-string">'+'</span> : <span class="hljs-string">''</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-string">'内存变化: <span class="hljs-subst">$sign</span><span class="hljs-subst">${diffMb.toStringAsFixed(<span class="hljs-number">2</span>)}</span> MB'</span>;
  }

  <span class="hljs-built_in">String</span> _fileSize(<span class="hljs-built_in">String</span> path) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> bytes = File(path).lengthSync();
      <span class="hljs-keyword">if</span> (bytes &lt; <span class="hljs-number">1024</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">'<span class="hljs-subst">$bytes</span> B'</span>;
      }
      <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> kb = bytes / <span class="hljs-number">1024</span>;
      <span class="hljs-keyword">if</span> (kb &lt; <span class="hljs-number">1024</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">'<span class="hljs-subst">${kb.toStringAsFixed(<span class="hljs-number">1</span>)}</span> KB'</span>;
      }
      <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> mb = kb / <span class="hljs-number">1024</span>;
      <span class="hljs-keyword">return</span> <span class="hljs-string">'<span class="hljs-subst">${mb.toStringAsFixed(<span class="hljs-number">2</span>)}</span> MB'</span>;
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'--'</span>;
    }
  }

  Future&lt;<span class="hljs-keyword">void</span>&gt; _handlePickerEdit() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">if</span> (_isPickingImage) <span class="hljs-keyword">return</span>;
    setState(() {
      _isPickingImage = <span class="hljs-keyword">true</span>;
    });
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> XFile? picked = <span class="hljs-keyword">await</span> _picker.pickImage(source: ImageSource.gallery);
      <span class="hljs-keyword">if</span> (picked == <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-keyword">final</span> ui.Image image = <span class="hljs-keyword">await</span> loadImageFromFile(picked.path);
      <span class="hljs-keyword">if</span> (!mounted) <span class="hljs-keyword">return</span>;
      setState(() {
        _pickerOriginal = image;
        _pickerEdited = <span class="hljs-keyword">null</span>;
      });
      <span class="hljs-keyword">final</span> ui.Image? result = <span class="hljs-keyword">await</span> _openEditor(
        image,
        config: <span class="hljs-keyword">const</span> ImageEditorConfig(
          topToolbar: TopToolbarConfig(
            titleText: <span class="hljs-string">'相册图片编辑'</span>,
            cancelText: <span class="hljs-string">'取消'</span>,
            confirmText: <span class="hljs-string">'完成'</span>,
          ),
          compression: ImageCompressionConfig(
            enabled: <span class="hljs-keyword">true</span>,
            scale: <span class="hljs-number">0.3</span>,
          ),
        ),
      );
      <span class="hljs-keyword">if</span> (!mounted || result == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span>;
      setState(() {
        _pickerEdited = result;
      });
      <span class="hljs-keyword">await</span> _processPickerResult(result);
      <span class="hljs-keyword">await</span> _logImageBytes(result, <span class="hljs-string">'picker'</span>);
    } <span class="hljs-keyword">catch</span> (error) {
      _showSnack(<span class="hljs-string">'选择图片失败: <span class="hljs-subst">$error</span>'</span>);
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-keyword">if</span> (!mounted) <span class="hljs-keyword">return</span>;
      setState(() {
        _isPickingImage = <span class="hljs-keyword">false</span>;
      });
    }
  }

  Future&lt;ui.Image?&gt; _openEditor(
    ui.Image image, {
    ImageEditorConfig? config,
  }) {
    <span class="hljs-keyword">return</span> Navigator.push&lt;ui.Image?&gt;(
      context,
      MaterialPageRoute(
        builder: (context) =&gt; ImageEditor(
          image: image,
          config: config ?? <span class="hljs-keyword">const</span> ImageEditorConfig(),
        ),
      ),
    );
  }

  Future&lt;<span class="hljs-keyword">void</span>&gt; _logImageBytes(ui.Image image, <span class="hljs-built_in">String</span> tag) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> bytes = <span class="hljs-keyword">await</span> convertUiImageToBytes(image);
    <span class="hljs-keyword">if</span> (bytes == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span>;
    <span class="hljs-comment">// 此处仅演示如何获取可直接用于上传的字节数据，可替换为实际网络请求。</span>
    debugPrint(<span class="hljs-string">'[image_editor_demo][<span class="hljs-subst">$tag</span>] export bytes=<span class="hljs-subst">${bytes.lengthInBytes}</span>'</span>);
  }

  <span class="hljs-comment">/// <span class="markdown">处理相册图片编辑结果为临时文件</span></span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; _processPickerResult(ui.Image result) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">Stopwatch</span> stopwatch = <span class="hljs-built_in">Stopwatch</span>()..start();
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">String?</span> tempPath = <span class="hljs-keyword">await</span> saveImageToTempFile(result);
    stopwatch.stop();

    setState(() {
      _pickerTempPath = tempPath;
      _pickerTempDuration = stopwatch.elapsed;
    });

    <span class="hljs-keyword">if</span> (tempPath == <span class="hljs-keyword">null</span>) {
      _showSnack(<span class="hljs-string">'图片保存失败'</span>);
    } <span class="hljs-keyword">else</span> {
      debugPrint(<span class="hljs-string">'[image_editor_demo][picker] tempPath=<span class="hljs-subst">$tempPath</span> in <span class="hljs-subst">${stopwatch.elapsedMilliseconds}</span>ms'</span>);
    }
  }

  Card _buildPerformanceNote() {
    <span class="hljs-keyword">return</span> Card(
      color: Colors.blueGrey.shade50,
      child: <span class="hljs-keyword">const</span> Padding(
        padding: EdgeInsets.all(<span class="hljs-number">16</span>),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              <span class="hljs-string">'性能提示'</span>,
              style: TextStyle(fontSize: <span class="hljs-number">16</span>, fontWeight: FontWeight.w600),
            ),
            SizedBox(height: <span class="hljs-number">12</span>),
            Text(
              <span class="hljs-string">'· `ui.Image` 在 Flutter 中以原始 RGBA 32 位像素存储，内存占用约等于像素总数 × 4 字节，读取速度快但占用高。\n'</span>
              <span class="hljs-string">'· 若目标是压缩图片体积，建议在裁剪后进一步按需缩放，并使用 JPG/PNG/WebP 编码保存或上传。\n'</span>
              <span class="hljs-string">'· 对于批量压缩，可结合 `ui.PictureRecorder` 或第三方图像处理库（例如 `image` 包）在后台处理，降低内存峰值。\n'</span>
              <span class="hljs-string">'· 可通过 Flutter DevTools 的 Memory 面板，或在控制台打印 `(image.width * image.height * 4 / 1024 / 1024)` 观察实时内存占用，帮助评估方案。'</span>,
            ),
          ],
        ),
      ),
    );
  }
}
</code></pre>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxinqingaa%2Fimage_editor" target="_blank" title="https://github.com/xinqingaa/image_editor" ref="nofollow noopener noreferrer">github</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Fflutter_img_editor" target="_blank" title="https://pub.dev/packages/flutter_img_editor" ref="nofollow noopener noreferrer">pubdev</a></li>
</ul>
<blockquote>
<p>欢迎大家 Star 和 Fork。如果你对 Flutter 图形图像处理有兴趣，或者在寻找一个可以轻松集成到自己项目中的图片编辑器，希望我的这个轮子能帮到你。
感谢你的阅读！如果觉得这篇文章对你有帮助，不妨点个赞吧！</p>
</blockquote>
<h2 data-id="heading-12">总结和展望</h2>
<p>从一个想法，到一个功能完备的图片编辑器，这个过程充满了挑战，也充满了乐趣。回顾整个项目，我认为有几点关键的收获：</p>
<ol>
<li><strong>架构先行</strong>：良好的分层和模块化设计是应对复杂度的不二法门。将职责拆分到独立的 <code>Handler</code> 和 <code>Manager</code> 中，让代码逻辑清晰，易于维护和扩展。</li>
<li><strong>拥抱底层API</strong>：<code>CustomPaint</code> 和 <code>Matrix4</code> 虽然概念上有些抽象，但它们是实现高级自定义UI和复杂图形操作的利器。深入理解它们，能让你在 Flutter 的世界里拥有更大的创造自由。</li>
<li><strong>关注核心问题</strong>：高保真处理是图片编辑器的灵魂。始终围绕“如何操作原始数据”来思考，而不是“如何修改屏幕显示”，是保证最终输出质量的关键。</li>
</ol>
<p>当然，这个编辑器还有很多可以完善的地方，比如：</p>
<ul>
<li><strong>性能优化</strong>：对于超大尺寸的图片，可以引入瓦片化渲染技术。</li>
<li><strong>功能扩展</strong>：增加画笔、马赛克、滤镜等更丰富的编辑工具。</li>
<li><strong>手势体验</strong>：支持双指旋转和缩放文本层等更精细的交互。</li>
</ul>
<h2 data-id="heading-13">往期文章介绍</h2>
<h3 data-id="heading-14">Flutter 全链路监控 SDK</h3>
<ul>
<li><a href="https://juejin.cn/post/7564977973260173338" target="_blank" title="https://juejin.cn/post/7564977973260173338">掘金文章</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Fflutter_monitor_sdk" target="_blank" title="https://pub.dev/packages/flutter_monitor_sdk" ref="nofollow noopener noreferrer">pubdev</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxinqingaa%2Fflutter_monitor_sdk" target="_blank" title="https://github.com/xinqingaa/flutter_monitor_sdk" ref="nofollow noopener noreferrer">github</a></li>
</ul>
<h3 data-id="heading-15">Flutter 全场景弹框</h3>
<ul>
<li><a href="https://juejin.cn/post/7538324216594726950" target="_blank" title="https://juejin.cn/post/7538324216594726950">掘金文章</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Funified_popups" target="_blank" title="https://pub.dev/packages/unified_popups" ref="nofollow noopener noreferrer">pubdev</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxinqingaa%2Funified_popups" target="_blank" title="https://github.com/xinqingaa/unified_popups" ref="nofollow noopener noreferrer">github</a></li>
</ul>
<h3 data-id="heading-16">Flutter日历组件</h3>
<ul>
<li><a href="https://juejin.cn/post/7531976064496123931" target="_blank" title="https://juejin.cn/post/7531976064496123931">掘金文章</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Fomni_calendar_view" target="_blank" title="https://pub.dev/packages/omni_calendar_view" ref="nofollow noopener noreferrer">pubdev</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxinqingaa%2Fomni_calendar_view" target="_blank" title="https://github.com/xinqingaa/omni_calendar_view" ref="nofollow noopener noreferrer">github</a></li>
</ul>
<h3 data-id="heading-17">日期选择器</h3>
<ul>
<li><a href="https://juejin.cn/post/7524159959480991753" target="_blank" title="https://juejin.cn/post/7524159959480991753">掘金文章</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Fomni_date_picker" target="_blank" title="https://pub.dev/packages/omni_date_picker" ref="nofollow noopener noreferrer">pubdev</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxinqingaa%2Fomni_date_picker" target="_blank" title="https://github.com/xinqingaa/omni_date_picker" ref="nofollow noopener noreferrer">github</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue组件通信不再难！这8种方式让你彻底搞懂父子兄弟传值]]></title>    <link>https://juejin.cn/post/7570923924365180991</link>    <guid>https://juejin.cn/post/7570923924365180991</guid>    <pubDate>2025-11-10T23:29:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570923924365180991" data-draft-id="7570899512782929983" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue组件通信不再难！这8种方式让你彻底搞懂父子兄弟传值"/> <meta itemprop="keywords" content="Vue.js,前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-10T23:29:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="良山有风来"/> <meta itemprop="url" content="https://juejin.cn/user/3940246036939358"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue组件通信不再难！这8种方式让你彻底搞懂父子兄弟传值
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3940246036939358/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    良山有风来
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T23:29:25.000Z" title="Mon Nov 10 2025 23:29:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    28
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你是不是经常遇到这样的场景？父组件的数据要传给子组件，子组件的事件要通知父组件，兄弟组件之间要共享状态...每次写Vue组件通信都觉得头大，不知道用哪种方式最合适？</p>
<p>别担心！今天我就带你彻底搞懂Vue组件通信的8种核心方式，每种方式都有详细的代码示例和适用场景分析。看完这篇文章，你就能根据具体业务场景选择最合适的通信方案，再也不用为组件间传值发愁了！</p>
<h2 data-id="heading-0">Props：最基础的父子通信</h2>
<p>Props是Vue中最基础也是最常用的父子组件通信方式。父组件通过属性向下传递数据，子组件通过props选项接收。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 子组件 ChildComponent.vue</span>
&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>子组件接收到的消息：{{ message }}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>用户年龄：{{ userInfo.age }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-comment">// 定义props，可以指定类型和默认值</span>
  <span class="hljs-attr">props</span>: {
    <span class="hljs-attr">message</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
      <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>  <span class="hljs-comment">// 必须传递这个prop</span>
    },
    <span class="hljs-attr">userInfo</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">Object</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-function">() =&gt;</span> ({})  <span class="hljs-comment">// 默认空对象</span>
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="hljs-comment">// 父组件 ParentComponent.vue</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">child-component</span> 
      <span class="hljs-attr">:message</span>=<span class="hljs-string">"parentMessage"</span> 
      <span class="hljs-attr">:user-info</span>=<span class="hljs-string">"userData"</span>
    /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ChildComponent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./ChildComponent.vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">components</span>: { <span class="hljs-title class_">ChildComponent</span> },
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">parentMessage</span>: <span class="hljs-string">'来自父组件的问候'</span>,
      <span class="hljs-attr">userData</span>: {
        <span class="hljs-attr">name</span>: <span class="hljs-string">'小明'</span>,
        <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>
      }
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p>适用场景：简单的父子组件数据传递，数据流清晰明确。但要注意，props是单向数据流，子组件不能直接修改props。</p>
<h2 data-id="heading-1">$emit：子组件向父组件通信</h2>
<p>当子组件需要向父组件传递数据或触发父组件的某个方法时，就需要用到$emit。子组件通过触发自定义事件，父组件通过v-on监听这些事件。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 子组件 SubmitButton.vue</span>
&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleClick"</span>&gt;</span>
    提交表单
  <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 触发自定义事件，并传递数据</span>
      <span class="hljs-variable language_">this</span>.$emit(<span class="hljs-string">'form-submit'</span>, {
        <span class="hljs-attr">timestamp</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(),
        <span class="hljs-attr">formData</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">formData</span>
      })
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="hljs-comment">// 父组件 FormContainer.vue</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">submit-button</span> @<span class="hljs-attr">form-submit</span>=<span class="hljs-string">"handleFormSubmit"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">SubmitButton</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./SubmitButton.vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">components</span>: { <span class="hljs-title class_">SubmitButton</span> },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">handleFormSubmit</span>(<span class="hljs-params">payload</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'接收到子组件的数据：'</span>, payload)
      <span class="hljs-comment">// 这里可以处理表单提交逻辑</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">submitToServer</span>(payload.<span class="hljs-property">formData</span>)
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p>适用场景：子组件需要通知父组件某个事件发生，或者需要传递数据给父组件处理。</p>
<h2 data-id="heading-2">ref：直接访问子组件实例</h2>
<p>通过ref属性，父组件可以直接访问子组件的实例，调用其方法或访问其数据。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 子组件 CustomInput.vue</span>
&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
    <span class="hljs-attr">ref</span>=<span class="hljs-string">"inputRef"</span> 
    <span class="hljs-attr">v-model</span>=<span class="hljs-string">"inputValue"</span> 
    <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>
  /&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">inputValue</span>: <span class="hljs-string">''</span>
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-comment">// 子组件的自定义方法</span>
    <span class="hljs-title function_">focus</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>.<span class="hljs-property">inputRef</span>.<span class="hljs-title function_">focus</span>()
    },
    <span class="hljs-title function_">clear</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">inputValue</span> = <span class="hljs-string">''</span>
    },
    <span class="hljs-title function_">getValue</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">inputValue</span>
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="hljs-comment">// 父组件 ParentComponent.vue</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">custom-input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"myInput"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleFocus"</span>&gt;</span>聚焦输入框<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleClear"</span>&gt;</span>清空输入框<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">CustomInput</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./CustomInput.vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">components</span>: { <span class="hljs-title class_">CustomInput</span> },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">handleFocus</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 通过ref直接调用子组件的方法</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>.<span class="hljs-property">myInput</span>.<span class="hljs-title function_">focus</span>()
    },
    <span class="hljs-title function_">handleClear</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 调用子组件的清空方法</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>.<span class="hljs-property">myInput</span>.<span class="hljs-title function_">clear</span>()
      
      <span class="hljs-comment">// 也可以直接访问子组件的数据（不推荐）</span>
      <span class="hljs-comment">// this.$refs.myInput.inputValue = ''</span>
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p>适用场景：需要直接操作子组件的DOM元素或调用子组件方法的场景。但要谨慎使用，避免破坏组件的封装性。</p>
<h2 data-id="heading-3">Event Bus：任意组件间通信</h2>
<p>Event Bus通过创建一个空的Vue实例作为事件中心，实现任意组件间的通信，特别适合非父子组件的情况。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// event-bus.js - 创建事件总线</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">EventBus</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>()

<span class="hljs-comment">// 组件A - 事件发送者</span>
&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"sendMessage"</span>&gt;</span>发送全局消息<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">EventBus</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./event-bus'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">sendMessage</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 触发全局事件</span>
      <span class="hljs-title class_">EventBus</span>.$emit(<span class="hljs-string">'global-message'</span>, {
        <span class="hljs-attr">text</span>: <span class="hljs-string">'Hello from Component A!'</span>,
        <span class="hljs-attr">from</span>: <span class="hljs-string">'ComponentA'</span>
      })
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="hljs-comment">// 组件B - 事件监听者</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>最新消息：{{ latestMessage }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">EventBus</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./event-bus'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">latestMessage</span>: <span class="hljs-string">''</span>
    }
  },
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 监听全局事件</span>
    <span class="hljs-title class_">EventBus</span>.$on(<span class="hljs-string">'global-message'</span>, <span class="hljs-function">(<span class="hljs-params">payload</span>) =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">latestMessage</span> = <span class="hljs-string">`<span class="hljs-subst">${payload.<span class="hljs-keyword">from</span>}</span> 说：<span class="hljs-subst">${payload.text}</span>`</span>
    })
  },
  <span class="hljs-title function_">beforeDestroy</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 组件销毁前移除事件监听，防止内存泄漏</span>
    <span class="hljs-title class_">EventBus</span>.$off(<span class="hljs-string">'global-message'</span>)
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p>适用场景：简单的跨组件通信，小型项目中的状态管理。但在复杂项目中建议使用Vuex或Pinia。</p>
<h2 data-id="heading-4">provide/inject：依赖注入</h2>
<p>provide和inject主要用于高阶组件开发，允许祖先组件向其所有子孙后代注入依赖，而不需要层层传递props。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 祖先组件 Ancestor.vue</span>
&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">middle-component</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-comment">// 提供数据和方法</span>
  <span class="hljs-title function_">provide</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// 提供响应式数据</span>
      <span class="hljs-attr">appTheme</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">theme</span>,
      <span class="hljs-comment">// 提供方法</span>
      <span class="hljs-attr">changeTheme</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">changeTheme</span>,
      <span class="hljs-comment">// 提供常量</span>
      <span class="hljs-attr">appName</span>: <span class="hljs-string">'我的Vue应用'</span>
    }
  },
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">theme</span>: <span class="hljs-string">'dark'</span>
    }
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">changeTheme</span>(<span class="hljs-params">newTheme</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">theme</span> = newTheme
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="hljs-comment">// 深层子组件 DeepChild.vue</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"`theme-${appTheme}`"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>应用名称：{{ appName }}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"changeTheme('light')"</span>&gt;</span>切换亮色主题<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"changeTheme('dark')"</span>&gt;</span>切换暗色主题<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-comment">// 注入祖先组件提供的数据</span>
  <span class="hljs-attr">inject</span>: [<span class="hljs-string">'appTheme'</span>, <span class="hljs-string">'changeTheme'</span>, <span class="hljs-string">'appName'</span>],
  
  <span class="hljs-comment">// 也可以指定默认值和来源</span>
  <span class="hljs-comment">// inject: {</span>
  <span class="hljs-comment">//   theme: {</span>
  <span class="hljs-comment">//     from: 'appTheme',</span>
  <span class="hljs-comment">//     default: 'light'</span>
  <span class="hljs-comment">//   }</span>
  <span class="hljs-comment">// }</span>
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p>适用场景：组件层级很深，需要避免props逐层传递的麻烦。常用于开发组件库或大型应用的基础配置。</p>
<h2 data-id="heading-5"><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>t</mi><mi>t</mi><mi>r</mi><mi>s</mi><mi mathvariant="normal">/</mi></mrow><annotation encoding="application/x-tex">attrs/</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">a</span><span class="mord mathnormal">tt</span><span class="mord mathnormal">rs</span><span class="mord">/</span></span></span></span></span>listeners：跨层级属性传递</h2>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>t</mi><mi>t</mi><mi>r</mi><mi>s</mi><mtext>包含了父组件传入的所有非</mtext><mi>p</mi><mi>r</mi><mi>o</mi><mi>p</mi><mi>s</mi><mtext>属性，</mtext></mrow><annotation encoding="application/x-tex">attrs包含了父组件传入的所有非props属性，</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">a</span><span class="mord mathnormal">tt</span><span class="mord mathnormal">rs</span><span class="mord cjk_fallback">包含了父组件传入的所有非</span><span class="mord mathnormal">p</span><span class="mord mathnormal">ro</span><span class="mord mathnormal">p</span><span class="mord mathnormal">s</span><span class="mord cjk_fallback">属性，</span></span></span></span></span>listeners包含了父组件传入的所有事件监听器，可以用于创建高阶组件。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 中间组件 MiddleComponent.vue</span>
&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 传递所有属性和事件到子组件 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">child-component</span> <span class="hljs-attr">v-bind</span>=<span class="hljs-string">"$attrs"</span> <span class="hljs-attr">v-on</span>=<span class="hljs-string">"$listeners"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ChildComponent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./ChildComponent.vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">components</span>: { <span class="hljs-title class_">ChildComponent</span> },
  <span class="hljs-attr">inheritAttrs</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// 不让属性绑定到根元素</span>
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'$attrs:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">$attrs</span>) <span class="hljs-comment">// 所有非props属性</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'$listeners:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">$listeners</span>) <span class="hljs-comment">// 所有事件监听器</span>
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="hljs-comment">// 最终子组件 ChildComponent.vue</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
    <span class="hljs-attr">v-bind</span>=<span class="hljs-string">"$attrs"</span>
    <span class="hljs-attr">v-on</span>=<span class="hljs-string">"$listeners"</span>
    <span class="hljs-attr">class</span>=<span class="hljs-string">"custom-input"</span>
  /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 可以直接使用父组件传递的所有属性和事件</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'接收到的属性：'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">$attrs</span>)
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="hljs-comment">// 父组件使用</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">middle-component</span>
    <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"请输入内容"</span>
    <span class="hljs-attr">maxlength</span>=<span class="hljs-string">"20"</span>
    @<span class="hljs-attr">focus</span>=<span class="hljs-string">"handleFocus"</span>
    @<span class="hljs-attr">blur</span>=<span class="hljs-string">"handleBlur"</span>
  /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
</code></pre>
<p>适用场景：创建包装组件、高阶组件，需要透传属性和事件的场景。</p>
<h2 data-id="heading-6">Vuex：集中式状态管理</h2>
<p>Vuex是Vue的官方状态管理库，适用于中大型复杂应用的状态管理。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// store/index.js</span>
<span class="hljs-keyword">import</span> { createStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'vuex'</span>

<span class="hljs-keyword">const</span> store = <span class="hljs-title function_">createStore</span>({
  <span class="hljs-title function_">state</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">user</span>: <span class="hljs-literal">null</span>,
      <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>
    }
  },
  <span class="hljs-attr">mutations</span>: {
    <span class="hljs-comment">// 同步修改状态</span>
    <span class="hljs-title function_">increment</span>(<span class="hljs-params">state</span>) {
      state.<span class="hljs-property">count</span>++
    },
    <span class="hljs-title function_">setUser</span>(<span class="hljs-params">state, user</span>) {
      state.<span class="hljs-property">user</span> = user
    },
    <span class="hljs-title function_">setLoading</span>(<span class="hljs-params">state, loading</span>) {
      state.<span class="hljs-property">loading</span> = loading
    }
  },
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-comment">// 异步操作</span>
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">login</span>(<span class="hljs-params">{ commit }, credentials</span>) {
      <span class="hljs-title function_">commit</span>(<span class="hljs-string">'setLoading'</span>, <span class="hljs-literal">true</span>)
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">login</span>(credentials)
        <span class="hljs-title function_">commit</span>(<span class="hljs-string">'setUser'</span>, user)
        <span class="hljs-keyword">return</span> user
      } <span class="hljs-keyword">finally</span> {
        <span class="hljs-title function_">commit</span>(<span class="hljs-string">'setLoading'</span>, <span class="hljs-literal">false</span>)
      }
    }
  },
  <span class="hljs-attr">getters</span>: {
    <span class="hljs-comment">// 计算属性</span>
    <span class="hljs-attr">isLoggedIn</span>: <span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> !!state.<span class="hljs-property">user</span>,
    <span class="hljs-attr">doubleCount</span>: <span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> state.<span class="hljs-property">count</span> * <span class="hljs-number">2</span>
  }
})

<span class="hljs-comment">// 组件中使用</span>
&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>计数器：{{ count }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>双倍计数：{{ doubleCount }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"isLoggedIn"</span>&gt;</span>欢迎，{{ user.name }}！<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"increment"</span>&gt;</span>增加<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"login"</span> <span class="hljs-attr">:disabled</span>=<span class="hljs-string">"loading"</span>&gt;</span>
      {{ loading ? '登录中...' : '登录' }}
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { mapState, mapGetters, mapMutations, mapActions } <span class="hljs-keyword">from</span> <span class="hljs-string">'vuex'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">computed</span>: {
    <span class="hljs-comment">// 映射state和getters到计算属性</span>
    ...<span class="hljs-title function_">mapState</span>([<span class="hljs-string">'count'</span>, <span class="hljs-string">'user'</span>, <span class="hljs-string">'loading'</span>]),
    ...<span class="hljs-title function_">mapGetters</span>([<span class="hljs-string">'doubleCount'</span>, <span class="hljs-string">'isLoggedIn'</span>])
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-comment">// 映射mutations和actions到方法</span>
    ...<span class="hljs-title function_">mapMutations</span>([<span class="hljs-string">'increment'</span>]),
    ...<span class="hljs-title function_">mapActions</span>([<span class="hljs-string">'login'</span>])
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p>适用场景：中大型复杂应用，多个组件需要共享状态，需要严格的状态管理流程。</p>
<h2 data-id="heading-7">Pinia：新一代状态管理</h2>
<p>Pinia是Vue官方推荐的新一代状态管理库，相比Vuex更加轻量、直观，并且完美支持TypeScript。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// stores/counter.js</span>
<span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCounterStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'counter'</span>, {
  <span class="hljs-attr">state</span>: <span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">count</span>: <span class="hljs-number">0</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'我的计数器'</span>
  }),
  
  <span class="hljs-attr">getters</span>: {
    <span class="hljs-attr">doubleCount</span>: <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">count</span> * <span class="hljs-number">2</span>,
    <span class="hljs-comment">// 使用this访问其他getter</span>
    <span class="hljs-title function_">doubleCountPlusOne</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">doubleCount</span> + <span class="hljs-number">1</span>
    }
  },
  
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span>++
    },
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">incrementAsync</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 异步action</span>
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">1000</span>))
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">increment</span>()
    },
    <span class="hljs-title function_">reset</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">count</span> = <span class="hljs-number">0</span>
    }
  }
})

<span class="hljs-comment">// 组件中使用</span>
&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>{{ name }}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前计数：{{ count }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>双倍计数：{{ doubleCount }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"increment"</span>&gt;</span>增加<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"incrementAsync"</span>&gt;</span>异步增加<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"reset"</span>&gt;</span>重置<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useCounterStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/counter'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> counterStore = <span class="hljs-title function_">useCounterStore</span>()
    
    <span class="hljs-comment">// 可以直接解构，但会失去响应式</span>
    <span class="hljs-comment">// 使用storeToRefs保持响应式</span>
    <span class="hljs-keyword">const</span> { name, count, doubleCount } = counterStore
    
    <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// state和getters</span>
      name,
      count,
      doubleCount,
      <span class="hljs-comment">// actions</span>
      <span class="hljs-attr">increment</span>: counterStore.<span class="hljs-property">increment</span>,
      <span class="hljs-attr">incrementAsync</span>: counterStore.<span class="hljs-property">incrementAsync</span>,
      <span class="hljs-attr">reset</span>: counterStore.<span class="hljs-property">reset</span>
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>

<span class="hljs-comment">// 在多个store之间交互</span>
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores/user'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCartStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'cart'</span>, {
  <span class="hljs-attr">actions</span>: {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">checkout</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>()
      
      <span class="hljs-keyword">if</span> (!userStore.<span class="hljs-property">isLoggedIn</span>) {
        <span class="hljs-keyword">await</span> userStore.<span class="hljs-title function_">login</span>()
      }
      
      <span class="hljs-comment">// 结账逻辑...</span>
    }
  }
})
</code></pre>
<p>适用场景：现代Vue应用的状态管理，特别是需要TypeScript支持和更简洁API的项目。</p>
<h2 data-id="heading-8">实战场景选择指南</h2>
<p>现在你已经了解了8种Vue组件通信方式，但在实际开发中该如何选择呢？我来给你一些实用建议：</p>
<p>如果是简单的父子组件通信，优先考虑props和$emit，这是最直接的方式。</p>
<p>当组件层级较深，需要避免props逐层传递时，provide/inject是不错的选择。</p>
<p>对于非父子组件间的简单通信，Event Bus可以快速解决问题，但要注意事件管理。</p>
<p>在需要创建高阶组件或包装组件时，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>t</mi><mi>t</mi><mi>r</mi><mi>s</mi><mtext>和</mtext></mrow><annotation encoding="application/x-tex">attrs和</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">a</span><span class="mord mathnormal">tt</span><span class="mord mathnormal">rs</span><span class="mord cjk_fallback">和</span></span></span></span></span>listeners能大大简化代码。</p>
<p>对于中大型复杂应用，需要集中管理状态时，Vuex或Pinia是必备的。个人更推荐Pinia，因为它更现代、更简洁。</p>
<p>如果需要直接操作子组件，ref提供了最直接的方式，但要谨慎使用以保持组件的封装性。</p>
<p>记住，没有最好的通信方式，只有最适合当前场景的方式。在实际项目中，往往是多种方式结合使用。</p>
<h2 data-id="heading-9">写在最后</h2>
<p>组件通信是Vue开发中的核心技能，掌握这些通信方式就像掌握了组件间的"对话语言"。从简单的props/$emit到复杂的Pinia状态管理，每种方式都有其独特的价值和适用场景。</p>
<p>关键是要理解每种方式的原理和优缺点，在实际开发中根据组件关系、数据流复杂度、项目规模等因素做出合适的选择。</p>
<p>你现在对Vue组件通信是不是有了更清晰的认识？在实际项目中，你最喜欢用哪种通信方式？有没有遇到过特别的通信难题？欢迎在评论区分享你的经验和心得！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[李飞飞万字长文爆了！定义 AI 下一个十年]]></title>    <link>https://juejin.cn/post/7571067260053405722</link>    <guid>https://juejin.cn/post/7571067260053405722</guid>    <pubDate>2025-11-11T06:56:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571067260053405722" data-draft-id="7571051830710386738" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="李飞飞万字长文爆了！定义 AI 下一个十年"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-11-11T06:56:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新智元"/> <meta itemprop="url" content="https://juejin.cn/user/952600743642312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            李飞飞万字长文爆了！定义 AI 下一个十年
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/952600743642312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新智元
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T06:56:42.000Z" title="Tue Nov 11 2025 06:56:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读30分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/787b168bbf994bc9bc8fe95ba127b7ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=LHmxaCcpFDj0fWjStEVuvjybgLI%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-0"><strong>「【新智元导读】AI 的下一个十年，是构建空间智能的机器。李飞飞最新硬核长文，揭秘了空间智能「世界模型」核心框架和三大核心支柱。」</strong></h5>
<p>AI 的下一个前沿，是「空间智能」。</p>
<p>它是一项能让「看见」升华为「推理」，让「感知」蜕变为「行动」，让「想象」落地为「创造」的技术。</p>
<p>但「空间智能」究竟是什么？为何如此重要？该如何构建它？又该如何应用它？</p>
<p>今天，李飞飞撰万字长文分享了自己关于构建和使用「世界模型」以解锁空间智能的思考。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53787ed7f2c94c409b54871abd824965~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=zuN%2FpXnjjiFvF0Pog1tZ%2B884fiQ%3D" alt="" loading="lazy"/></p>
<p>新文章中，她为真正具备空间智能的「世界模型」所需达成的目标勾勒了一个框架。</p>
<p>具体来说，构建这样的 AI 必须具备三大核心能力：</p>
<p>让 AI 拥有故事讲述家的想象力去创造，</p>
<p>拥有急救人员般的敏捷性去导航，</p>
<p>并拥有科学家的严谨去推理空间。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dfdd903077454cbab446d9a771c2d62b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=aHmj3fuin0OSEOyuUgKFfihu%2F2Y%3D" alt="" loading="lazy"/></p>
<p>李飞飞与 LeCun 共识的一点是，「世界模型」是解锁空间智能的核心。</p>
<p>它必须能生成遵循物理定律、在空间上保持一致的世界，能处理从图像到动作的多模态输入，并能预测这些世界将如何演变或与之互动。</p>
<p>空间智能的应用疆域，正沿着一条清晰路径演进。</p>
<p>当下，它正赋能创意，World Labs Marble 项目已经将这些能力交到了创作者和故事讲述者的手中。</p>
<p>下一步，它将驾驭物理世界，机器人实现感知与行动之间的闭环。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b5cd939fb414854adfc32d32706931f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=bpqVqiafRO8r54Ffar7Dwljqx%2BE%3D" alt="" loading="lazy"/></p>
<p>而最具变革性的科学应用，虽然需要更长时间，但有望对人类福祉产生深远影响。</p>
<p>哲学家维特根斯坦曾写道：「我语言的极限，意味着我世界的极限。」</p>
<p>李飞飞表示，「我不是哲学家，但我深知，至少对 AI 而言，世界远不止于文字」。</p>
<p>空间智能代表了超越语言的前沿——它是一种将想象、感知与行动融会贯通的能力，为机器真正提升人类生活开启了无限可能，从医疗健康到创意挥洒，从科学探索到日常辅助。</p>
<p>众多网友点评，这是李飞飞一篇非常重要的文章，空间智能必读之作！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d952b60fda34290b81704174f33e976~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=nS3L0QbBABB8uY1FGq1nY%2Fqzb%2BI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/829f115810a1456c8e752addcd2c96c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=3KM4OTQNtkEN%2FLwH83eRxukPOUY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c1a336c69724f4b8627c100a5716194~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=PlvEaZXiGe3rmmV1H%2B2XifLmiwg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4023768723f745d8b60d23042ff8dc29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=HsjDipxBuWha6WwBORrm9mYbJac%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b74535841647441fba71e4d60e0b065d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=cbQYNrQWCFiern%2BSigVpJpBhdr8%3D" alt="" loading="lazy"/></p>
<p>上下滑动查看</p>
<p>以下是全文翻译，一起来拜读下。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44a149c8e6ed44cbb4952a69c4cb9ab6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=f6Kg8Uu3IJ%2B2PUEyt6IGww%2B4xNc%3D" alt="" loading="lazy"/></p>
<p><strong>「从语言到世界：空间智能是 AI 的下一个前沿」</strong></p>
<p>1950 年，当计算还只是自动化算术和简单逻辑的代名词时，阿兰 · 图灵提出了一个至今仍振聋发聩的问题：机器能否思考？能洞见他所预见的一切，需要非凡的想象力：智能有朝一日或可后天构建，而非与生俱来。</p>
<p>这一洞见，后来开启了一场名为「人工智能」（AI）的不懈科学探索。</p>
<p>在我投身 AI 领域的第二十五个年头，图灵的远见卓识依然激励着我。但我们离这个目标还有多近？答案并非一言以蔽之。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21d7e8566db54f228e9b01be34e5f734~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=TTHYDZ%2BlQ5jA4%2Fa3EWbXnd%2FStac%3D" alt="" loading="lazy"/></p>
<p>如今，以大语言模型（LLM）为代表的顶尖 AI 技术已开始改变我们获取和运用抽象知识的方式。</p>
<p>然而，它们仍是黑暗中的文字大师；能言善辩却缺乏经验，知识渊博却脱离现实的根基。</p>
<p>空间智能将改变我们创造以及与真实和虚拟世界互动的方式——为故事叙述、创意、机器人技术、科学发现等领域带来革命性的变革。这，就是 AI 的下一个前沿。</p>
<p>对视觉与空间智能的追求，是我踏入该领域以来始终指引我前行的「北极星」。</p>
<p>正因如此，我花费数年时间构建了 ImageNet——首个大规模视觉学习与基准测试数据集，它与神经网络算法、图形处理器（GPU）等现代计算设备一道，成为催生现代 AI 的三大关键基石之一。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb008ef13c0f4511936e2c4dd550388b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=I7QFj1ZVqoO6ugm%2BS9qy0u5Y7ks%3D" alt="" loading="lazy"/></p>
<p>正因如此，我在斯坦福大学的学术实验室在过去十年里，始终致力于将计算机视觉与机器人学习相结合。</p>
<p>也正因如此，一年多前，我与联合创始人 Justin Johnson、Christoph Lassner、Ben Mildenhall 共同创立了 World Labs：旨在首次将这一可能性淋漓尽致地变为现实。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d752adca59a4be6b50f3bea797f6767~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=EFu%2BFVezeBeYYSpmR3Vp9kLtPMI%3D" alt="" loading="lazy"/></p>
<p>World Labs 创始人团队，左起依次为 Ben Mildenhall、Justin Johnson、Christoph Lassner 和李飞飞</p>
<p>在本文中，我将阐释何为空间智能、其重要性何在，以及我们如何构建能够解锁它的「世界模型」——其深远影响将重塑创意、具身智能与人类的进步。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e65078eb6a8240e0a6c52b0a2f5c1316~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=rBaPXZYq2vAWjqFDjoveLrvVIMo%3D" alt="" loading="lazy"/></p>
<p><strong>「空间智能：人类认知的基石」</strong></p>
<p>人工智能的发展从未如此激动人心。像大语言模型这样的生成式 AI 已经从实验室走向日常生活，成为数十亿人创意、生产力和沟通的工具。</p>
<p>它们展现了曾被认为遥不可及的能力，能轻松生成连贯的文本、浩如烟海的代码、逼真的图像，乃至短视频片段。AI 是否会改变世界已不再是疑问。</p>
<p>无论以何种合理的标准衡量，它都已然做到了。</p>
<p>然而，仍有太多领域是我们力所不及的。自主机器人的愿景虽引人入胜，却仍停留在理论层面，远未成为未来学家们长期许诺的日常必需品。</p>
<p>在疾病治疗、新材料发现和粒子物理学等领域实现研究进程大飞跃的梦想，在很大程度上仍未实现。</p>
<p>而 AI 真正理解并赋能人类创作者的承诺——无论是帮助学生理解分子化学的复杂概念，协助建筑师构想空间，支持电影制作人构建世界，还是为任何寻求完全沉浸式虚拟体验的人提供支持——也依然遥不可及。</p>
<p>要理解为何这些能力仍难以实现，我们需要审视空间智能的演化历程，以及它如何塑造我们对世界的认知。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73f595c679dd4d87b25ed03940b320d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=X2lqHVlT1AvSAHP4GgOE60PDKrs%3D" alt="" loading="lazy"/></p>
<p>视觉长久以来都是人类智能的基石，但其力量源于某种更为根本的能力。远在动物学会筑巢、哺育后代、用语言交流或建立文明之前，感知这一简单的行为就已悄然点燃了通往智能的进化火花。</p>
<p>这种从外部世界（无论是一缕微光还是一丝触感）收集信息的看似孤立的能力，在感知与生存之间架起了一座桥梁，并随着代代繁衍而愈发坚固和精巧。层层叠叠的神经元从这座桥梁上生长出来，形成了能够解读世界并协调生物体与环境互动的神经系统。</p>
<p>因此，许多科学家推断，感知与行动的循环成为驱动智能进化的核心动力，也是自然界创造出我们人类——这一集感知、学习、思考与行动于一体的终极造物——的根基。</p>
<p>空间智能在定义我们如何与物理世界互动方面扮演着至关重要的角色。</p>
<p>每一天，我们都依赖它来完成最平凡的举动：通过想象保险杠与路缘之间不断缩小的间隙来停放汽车，接住抛过房间的一串钥匙，在拥挤的人行道上穿行而避免碰撞，或是在睡眼惺忪中不看一眼便将咖啡倒入杯中。</p>
<p>在更极端的情况下，消防员在浓烟弥漫、摇摇欲坠的建筑中穿行，对结构的稳定性和自身的生存在瞬间做出判断，并通过手势、肢体语言和一种无可替代的职业直觉进行交流。</p>
<p>而婴幼儿则在学会说话前的整段岁月里，通过与环境的嬉戏互动来认知世界。所有这一切都发生得如此直观、自然——这是机器尚未能企及的自如与娴熟。</p>
<p>空间智能同样是我们想象力与创造力的基石。故事讲述者在脑海中创造出异常丰富的世界，并利用从古老的洞穴壁画到现代电影，再到沉浸式视频游戏等多种视觉媒介，将这些世界呈现给他人。</p>
<p>无论是孩童在沙滩上堆砌沙堡，还是在电脑上玩《我的世界》，基于空间的想象力构成了真实或虚拟世界中互动体验的基础。在众多行业应用中，对物体、场景和动态交互环境的模拟，为从工业设计到数字孪生，再到机器人训练等无数关键商业用例提供了动力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f936b89d96a5484e9e563dff308532fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=CPalbwpPFNCdbuKXPfod1KJHWtY%3D" alt="" loading="lazy"/></p>
<p>历史上充满了由空间智能扮演核心角色的、定义文明进程的时刻。</p>
<p>在古希腊，埃拉托色尼将光影转化为几何学——在太阳直射赛伊尼城的同一时刻，于亚历山大港测得 7 度的夹角——从而计算出地球的周长。</p>
<p>哈格里夫斯的「珍妮纺纱机」凭借一个空间洞见彻底改变了纺织业：将多个纺锤并排置于同一框架内，使得一名工人能同时纺织多根纱线，生产效率提升了八倍。</p>
<p>沃森和克里克通过亲手搭建 3D 分子模型发现了 DNA 的结构，他们不断摆弄金属板和金属丝，直至碱基对的空间排列「咔哒」一声完美契合。</p>
<p>在每一个案例中，当科学家和发明家需要操控物体、构想结构、推理物理空间时，空间智能都推动了文明的进步——而这些，都非文字所能单独承载。</p>
<p>空间智能是我们认知赖以构建的基石。无论我们是被动观察还是主动创造，它都在发挥作用。它驱动着我们的推理与规划，即便是面对最抽象的议题。</p>
<p>它对于我们互动的方式——无论是口头还是肢体，与同伴还是与环境本身——都至关重要。</p>
<p>虽然我们大多数人并非每天都能像埃拉托色尼那样揭示新的宇宙真理，但我们日常的思考方式与他并无二致——通过感官感知复杂的世界，再利用一种对物理、空间运作方式的直观理解来赋予其意义。</p>
<p>不幸的是，今天的 AI 还不能这样思考。</p>
<p>过去几年确实取得了巨大进步。多模态大语言模型（MLLM）除了文本数据外，还用大量的多媒体数据进行训练，引入了一些基本的空间意识，今天的 AI 可以分析图片、回答关于图片的问题，并生成超逼真的图像和短视频。</p>
<p>通过传感器和触觉技术的突破，我们最先进的机器人可以在高度受限的环境中开始操纵物体和工具。</p>
<p>然而，坦率的真相是，AI 的空间能力仍远未达到人类水平，其局限性很快便会暴露无遗。</p>
<p>在估算距离、方向和尺寸，或通过从新角度生成图像来进行物体的「心理旋转」等任务上，最先进的 MLLM 模型的表现鲜有超过随机猜测的。它们无法走出迷宫、识别捷径或预测基本的物理现象。AI 生成的视频——尽管初露锋芒，且的确酷炫——通常在几秒钟后便会失去连贯性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b340585e1e4944e6abfcad97ef8d36ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=recFCQrFTmWApvhn%2FYFdE%2F80rnU%3D" alt="" loading="lazy"/></p>
<p>虽然当前最先进的 AI 在阅读、写作、研究和数据模式识别方面表现出色，但这些模型在表征或与物理世界互动时，却存在根本性的局限。</p>
<p>我们对世界的看法是整体性的——不仅仅是眼前所见，还包括万物在空间上的相互关联、其意义以及其重要性。通过想象、推理、创造和互动——而不仅是描述——来理解这一切，正是空间智能的力量所在。</p>
<p>若无此能力，AI 便与它试图理解的物理现实脱节。它将无法有效地驾驶我们的汽车，引导家中的机器人或医院的护理机器人，也无法为学习和娱乐开启全新的沉浸式互动体验，更无法加速材料科学和医学领域的探索发现。</p>
<p>哲学家维特根斯坦曾写道：「我语言的极限，意味着我世界的极限。」我不是哲学家，但我深知，至少对 AI 而言，世界远不止于文字。</p>
<p>空间智能代表了超越语言的前沿——它是一种将想象、感知与行动融会贯通的能力，为机器真正提升人类生活开启了无限可能，从医疗健康到创意挥洒，从科学探索到日常辅助。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a6fe151b8d544e5a3921fb045de9f34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=9cR53sYM1liCrUbbQHH0B3CvVZY%3D" alt="" loading="lazy"/></p>
<p><strong>「AI 的下一个十年：」</strong></p>
<p><strong>「构建真正具备空间智能的机器」</strong></p>
<p>那么，我们该如何构建具备空间智能的 AI？</p>
<p>如何才能打造出能够像埃拉托色尼一样洞察深远、像工业设计师一样精雕细琢、像故事讲述家一样天马行空，并像急救人员一样敏捷自如地与环境互动的模型？</p>
<p>构建具备空间智能的 AI 需要比大语言模型更为宏大的构想：<strong>「世界模型。」</strong></p>
<p>这是一种新型的生成模型，其理解、推理、生成以及与语义、物理、几何和动态上都极为复杂的虚拟或真实世界进行互动的能力，远非今日的 LLM 所能企及。</p>
<p>不过，这一领域尚处萌芽阶段，当前方法涵盖了从抽象推理模型到视频生成系统的各种探索。</p>
<p>World Labs 正是基于这一信念于 2024 年初创立的：基础方法尚在建立之中，而这将成为未来十年的决定性挑战。</p>
<p>在这个新兴领域，最重要的是确立指导发展的基本原则。对于空间智能，我通过三大核心能力来定义世界模型：</p>
<p><strong>「1. 生成式：世界模型能生成在感知、几何和物理层面保持一致的世界」</strong></p>
<p>能解锁空间理解与推理能力的世界模型，也必须能生成属于自己的模拟世界。</p>
<p>它们必须能够生成无穷无尽、千变万化的模拟世界，这些世界遵循语义或感知指令，同时在几何、物理和动态层面保持一致性——无论其表征的是真实空间还是虚拟空间。</p>
<p>研究界正在积极探索，这些世界固有的几何结构应该被隐式表征还是显式表征。</p>
<p>此外，我相信，除了强大的潜在表征，一个通用的世界模型的输出还必须能为众多不同的用例生成一个显式的、可观察的世界状态。</p>
<p>尤其重要的是，它对当前状态的理解必须与其过去——即导致当前状态的先前世界状态——连贯地联系在一起。</p>
<p><strong>「2. 多模态：世界模型在设计上是多模态的」</strong></p>
<p>正如动物与人类一样，世界模型应该能够处理多种形式的输入——在生成式 AI 领域，这被称为「提示词」。</p>
<p>在给定部分信息——无论是图像、视频、深度图、文本指令、手势还是动作——的情况下，世界模型应能预测或生成尽可能完整的世界状态。</p>
<p>这要求它既能以真实视觉的保真度处理视觉输入，又能同样自如地解读语义指令。</p>
<p>这使得智能体和人类都能通过多样化的输入与模型与世界进行交流，并反过来接收多样化的输出。</p>
<p><strong>「3. 互动性：世界模型能根据输入的动作输出下一个状态」</strong></p>
<p>最后，如果动作和 / 或目标是给予世界模型的提示词的一部分，那么其输出必须包含世界的下一个状态，无论是隐式还是显式表征。</p>
<p>当仅给定一个动作（无论是否包含目标状态）作为输入时，世界模型产生的输出必须与世界先前的状态、任何预设的目标状态、其语义含义、物理定律以及动态行为保持一致。</p>
<p>随着具备空间智能的世界模型在推理和生成能力上变得日益强大和稳健，可以想见，在给定目标的情况下，世界模型本身将不仅能预测世界的下一个状态，甚至还能基于新状态预测出下一步的动作。</p>
<p><strong>「这项挑战的广度与深度，超越了」</strong> <strong>「AI」</strong> <strong>「以往所面对的任何课题。」</strong></p>
<p>语言是人类认知中纯粹的生成现象，而世界则遵循着远为复杂的规则。</p>
<p>例如，在地球上，引力支配运动，原子结构决定光如何产生色彩与亮度，无数物理定律约束着每一次互动。即便是最天马行空的创意世界，也由遵循其自身物理定律和动态行为的空间物体与智能体构成。</p>
<p>要将这一切——语义、几何、动态与物理——持续一致地调和起来，需要全新的方法论。表征一个世界的维度，远比像语言这样的一维、顺序信号复杂得多。</p>
<p>要实现能提供如人类般通用能力的世界模型，需要克服若干严峻的技术壁垒。在 World Labs，我们的研究团队正致力于朝此目标取得根本性的进展。</p>
<p>以下是我们当前研究课题的一些示例。</p>
<p><strong>「· 一种新的、通用的训练任务函数：」</strong></p>
<p>定义一个像 LLM 中「预测下一个 token」一样简洁而优雅的通用任务函数，长久以来都是世界模型研究的核心目标。由于其输入和输出空间的复杂性，这种函数的构建本质上更加困难。</p>
<p>尽管仍有待探索，但这个目标函数及相应的表征必须能反映几何与物理定律，尊重世界模型作为想象与现实之根基表征的本质。</p>
<p><strong>「· 大规模</strong>「<strong>「训练数据」</strong>」<strong>：」</strong></p>
<p>训练世界模型需要比文本整理复杂得多的数据。好消息是：海量的数据源业已存在。</p>
<p>互联网规模的图像和视频集是丰富且易于获取的训练材料——挑战在于开发能够从这些二维图像或视频帧信号（即 RGB）中提取更深层次空间信息的算法。</p>
<p>过去十年的研究已证明了语言模型中数据量与模型大小之间的「规模定律」的力量；世界模型的关键突破在于构建能够以相当规模利用现有视觉数据的架构。</p>
<p>此外，我绝不会低估高质量合成数据以及深度、触觉信息等额外模态的力量。它们在训练过程的关键阶段对互联网规模的数据形成了重要补充。</p>
<p>但前路漫漫，这有赖于更好的传感器系统、更稳健的信号提取算法以及远为强大的神经模拟方法。</p>
<p><strong>「· 新的模型架构与表征学习：」</strong></p>
<p>世界模型的研究将不可避免地推动模型架构与学习算法的进步，尤其是在当前 MLLM 和视频扩散范式之外。</p>
<p>这两种范式通常将数据「token 化」为一维或二维序列，这使得一些简单的空间任务变得异常困难——例如，计算一个短视频中不重复的椅子数量，或者记住一个小时前房间的样貌。</p>
<p>替代性架构或可助一臂之力，例如具备三维或四维感知能力的 token 化、上下文和记忆方法。</p>
<p>例如，在 World Labs，我们近期关于一个名为 RTFM 的实时生成性帧基模型的工作就展示了这种转变，它使用基于空间的帧作为一种空间记忆形式，以实现高效的实时生成，同时在生成的世界中保持持久性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/168a8b744efb425d84d6eb1e561f4c7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=lga6I%2FjLBptCAzfkfiVlGKgvmX0%3D" alt="" loading="lazy"/></p>
<p>显然，在我们能够通过世界建模完全解锁空间智能之前，仍面临着艰巨的挑战。这项研究不仅是一次理论演练，它是一类新型创意与生产力工具的核心引擎。而 World Labs 内部的进展令人鼓舞。</p>
<p>我们最近向少数用户展示了 Marble 的一瞥——这是首个能够通过多模态输入提示，来生成并维持一致三维环境的世界模型，供用户和故事讲述者在其创意工作流中进行探索、互动和进一步构建。我们正努力使其尽快向公众开放！</p>
<p>Marble 只是我们创造真正具备空间智能的世界模型的第一步。随着进展加速，研究人员、工程师、用户和商界领袖都开始认识到其非凡的潜力。</p>
<p>下一代世界模型将使机器能够在全新层面上实现空间智能——这一成就将解锁当今 AI 系统中仍然普遍缺失的核心能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/931922a21a1c4d2e870624bb0e16a427~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=WjjuBnL0upv4Oa4GknFZkuULj5A%3D" alt="" loading="lazy"/></p>
<p><strong>「用世界模型为人类构建一个更美好的世界」</strong></p>
<p>是什么在激励 AI 的发展？这一点至关重要。</p>
<p>作为协助开启现代 AI 时代的科学家之一，我的动机始终明确：AI 必须增强人类的能力，而非取而代之。</p>
<p>多年来，我一直致力于使 AI 的开发、部署和治理与人类的需求相契合。</p>
<p>如今，关于技术乌托邦和末日论的极端叙事甚嚣尘上，但我始终持有一种更务实的观点：AI 由人开发，为人所用，由人治理。</p>
<p>它必须始终尊重人的能动性与尊严。它的魔力在于扩展我们的能力，让我们更有创造力、联系更紧密、效率更高、生活更充实。</p>
<p>空间智能正是这一愿景的体现——AI 赋能人类的创作者、照护者、科学家和梦想家，去实现曾经的不可能。这一信念，是我将空间智能作为 AI 下一个伟大前沿并为之奋斗的动力。</p>
<p>空间智能的应用横跨不同的时间尺度。创意工具正不断涌现——World Labs 的 Marble 项目已经将这些能力交到了创作者和故事讲述者的手中。</p>
<p>随着我们不断完善感知与行动之间的闭环，机器人技术将是雄心勃勃的中期目标。而最具变革性的科学应用虽然需要更长时间，但有望对人类的福祉产生深远影响。</p>
<p>在所有这些时间尺度上，有几个领域因其重塑人类能力的潜力而格外突出。这需要巨大的集体努力，远非一个团队或一家公司所能实现。</p>
<p>具体来说，它需要整个 AI 生态系统的参与——研究人员、创新者、企业家、公司，乃至政策制定者——共同为实现一个共享的愿景而努力。</p>
<p>但这个愿景值得我们去追求。以下是这个未来所蕴含的图景：</p>
<p><strong>「<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18b21018c5eb42a9b0194ab9db2ed0a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=zXDqu3v2mqRhHC9DiNCygHl3kP8%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「创造力：为故事叙述和沉浸式体验注入超凡动力」</strong></p>
<p>「创造力是智力在享受乐趣。」这是我最喜欢的 爱因斯坦名言之一。</p>
<p>早在书面语言出现之前，人类就已开始讲述故事——将其描绘于洞穴岩壁，代代相传，在共同的叙事之上建立起整个文化。</p>
<p>故事是我们理解世界、跨越时空建立联系、探索人性意义的方式，最重要的是，在生活中找到意义，在内心发现爱。</p>
<p>今天，空间智能有潜力改变我们创造和体验叙事的方式，既尊重其根本的重要性，又将其影响力从娱乐延伸至教育，从设计延伸至建筑。</p>
<p>World Labs 的 Marble 平台将把前所未有的空间能力和编辑可控性交到电影制作人、游戏设计师、建筑师和各类故事讲述者的手中，让他们能够快速创造和迭代完全可探索的三维世界，而无需传统三维设计软件的沉重负担。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7cdde3208f44aa2983dbd802d428324~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=IYREf1ObOtVjszcznFZVWEqQBlU%3D" alt="" loading="lazy"/></p>
<p>创造行为本身依然如故，充满人性的活力；AI 工具只是放大和加速了创作者所能达成的成就。这包括：</p>
<p>**新维度的叙事体验：**电影制作人和游戏设计师正使用 Marble 凭空创造出整个世界，不受预算或地理位置的限制，探索在传统制作流程中难以企及的各种场景和视角。</p>
<p>随着不同形式的媒体与娱乐之间的界限日益模糊，我们正在接近一种全新的互动体验，它融合了艺术、模拟与游戏——个性化的世界，其中任何人，而不仅是工作室，都可以创造并沉浸在自己的故事中。</p>
<p>随着将概念和故事板转化为完整体验的更新、更快捷的方式的出现，叙事将不再局限于单一媒介，创作者可以自由地在无数的界面和平台上构建具有共同主线的大千世界。</p>
<p>**通过设计的空间叙事：**几乎每一个制造的物体或建造的空间，在其实体化之前都必须在虚拟三维环境中进行设计。</p>
<p>这个过程在时间和金钱上都高度迭代且成本高昂。有了具备空间智能的模型，建筑师可以快速构想结构，而无需投入数月时间进行设计，他们可以在尚未存在的空间中漫步——这本质上是在讲述我们未来可能如何生活、工作和聚集的故事。</p>
<p>工业设计师和时装设计师可以瞬间将想象转化为形态，探索物体如何与人体和空间互动。</p>
<p>**新的沉浸式和互动体验：**体验本身是我们作为一个物种创造意义的最深层方式之一。</p>
<p>在整个人类历史中，只有一个单一的三维世界：我们共同生活的物理世界。仅在近几十年，通过游戏和早期的虚拟现实（VR），我们才开始一窥我们自己创造的替代世界是何种滋味。</p>
<p>现在，空间智能与新的设备形态（如 VR 和扩展现实（XR）头显及沉浸式显示器）相结合，以前所未有的方式提升了这些体验。</p>
<p>我们正在接近一个未来，届时，步入一个完全实现的多维世界将像翻开一本书一样自然。</p>
<p>空间智能让世界构建不再是拥有专业制作团队的工作室的专利，而是个人创作者、教育工作者以及任何有愿景希望分享的人都能触及的能力。</p>
<p><strong>「<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9103eacc99ec4d97963e02710fbf7493~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=J7AdJp%2BruvaqKVTLXr%2BG%2F%2BwaAr4%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「机器人技术：具身智能在行动」</strong></p>
<p>从昆虫到人类，动物都依赖空间智能来理解、导航并与它们的世界互动。机器人也不例外。</p>
<p>自诞生之日起，具备空间意识的机器就一直是该领域的梦想，这其中也包括我与我在斯坦福研究实验室的学生及合作者们的工作。</p>
<p>这也是为何我如此兴奋，期待能用 World Labs 正在构建的这类模型将这一梦想变为现实。</p>
<p><strong>通过世界模型规模化</strong>「<strong>「机器人」</strong>」**学习：**机器人学习的进展取决于一个可扩展的、可行的训练数据解决方案。</p>
<p>考虑到机器人必须学习去理解、推理、规划和互动的状态空间极其庞大，许多人推测，需要结合互联网数据、合成模拟以及对真实世界人类演示的捕捉，才能真正创造出具备泛化能力的机器人。</p>
<p>但与语言模型不同，当今的机器人研究缺乏训练数据。世界模型将在此扮演决定性角色。</p>
<p>随着它们在感知保真度和计算效率上的提升，世界模型的输出可以迅速弥合模拟与现实之间的鸿沟。这反过来将有助于在无数的状态、互动和环境模拟中训练机器人。</p>
<p>**伴侣与协作者：**机器人作为人类的协作者——无论是在实验室工作台上协助科学家，还是在家中帮助独居老人——都可以在急需更多劳动力和生产力的领域扩展我们的劳动力。</p>
<p>但这需要具备感知、推理、规划和行动的空间智能，同时——这是最重要的——与人类的目标和行为保持共情式的对齐。</p>
<p>例如，一个实验室机器人可以处理仪器，让科学家能专注于需要精细操作或推理的任务；而一个家庭助理则可以帮助一位老年人做饭，而不会削弱他们的乐趣或自主性。</p>
<p>能够预测下一个状态，甚至可能预测出符合这种期望的下一步动作的、真正具备空间智能的世界模型，对于实现这一目标至关重要。</p>
<p>**扩展具身形式：**人形机器人在我们为自己构建的世界中扮演着一定角色。</p>
<p>但创新的全部益处将来自更多样化的设计：输送药物的纳米机器人、在狭小空间中穿行的软体机器人，以及为深海或外太空打造的机器。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c5ac19f5be340549abfed73eb82385d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=HZT0ZQ0Sxn0j75%2FNRo4zIPQT93c%3D" alt="" loading="lazy"/></p>
<p>无论其形态如何，未来的空间智能模型都必须整合这些机器人所处的环境以及它们自身的具身感知与运动。但开发这些机器人的一个关键挑战是，在这些五花八门的具身形态上缺乏训练数据。</p>
<p>世界模型将在模拟数据、训练环境和基准测试任务等方面为这些努力发挥关键作用。</p>
<p><strong>「<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1cce9a4b3b034c53862c1cb522379e40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=b38kspL%2BT6RBwYRBXibgTP6pD3E%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「更长远的图景：科学、医疗与教育」</strong></p>
<p>除了创意和机器人应用，空间智能的深远影响还将延伸至那些能以拯救生命、加速发现的方式增强人类能力的领域。</p>
<p>我下面重点介绍三个可能带来深刻变革的应用领域，当然，空间智能的用例在更多行业中同样是广阔无垠的。</p>
<p>**在科学研究中，**具备空间智能的系统可以模拟实验、并行测试假设，并探索人类无法触及的环境——从深邃的海洋到遥远的行星。</p>
<p>这项技术可以改变气候科学和材料研究等领域的计算建模。通过将多维模拟与真实世界的数据收集相结合，这些工具可以降低计算门槛，扩展每个实验室所能观察和理解的范围。</p>
<p><strong>在医疗</strong>「<strong>「健康」</strong>」**领域，**空间智能将重塑从实验室到病床边的每一个环节。在斯坦福，我的学生和合作者多年来一直与医院、养老院以及居家患者合作。</p>
<p>这段经历让我坚信空间智能在此处的变革潜力。AI 可以通过在多维空间中建模分子相互作用来加速药物发现，通过帮助放射科医生在医学影像中识别模式来提升诊断水平，并能实现环境监测系统，在不取代治愈所必需的人类情感联结的前提下，为患者和照护者提供支持。</p>
<p>更不用说机器人在众多不同场景下帮助我们的医护人员和患者的巨大潜力。</p>
<p>**在教育领域，**空间智能可以实现沉浸式学习，使抽象或复杂的概念变得触手可及，并创造出对我们大脑和身体学习方式至关重要的迭代式体验。</p>
<p>在 AI 时代，更快、更有效的学习和技能再培训对于学龄儿童和成年人都尤为重要。学生可以在多维空间中探索细胞的运作机制或亲历历史事件。教师可以利用互动环境获得个性化教学的工具。</p>
<p>从外科医生到工程师的专业人士，都可以在逼真的模拟中安全地练习复杂技能。</p>
<p>在所有这些领域，可能性是无限的，但目标始终如一：AI 增强人类的专业知识，加速人类的发现，并放大人类的关怀——而不是取代作为人类核心的判断力、创造力和同理心。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6036d9b8ff4b4f3ba7138bbc64a5aff7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=G1F1%2Ba5qjPja89WNXr71zdSv2k0%3D" alt="" loading="lazy"/></p>
<p><strong>「结论」</strong></p>
<p>过去十年见证了 AI 成为一种全球现象，以及技术、经济乃至地缘政治的转折点。</p>
<p>但作为一名研究者、教育者，如今又是一名创业者，最能激励我的，仍然是图灵 75 年前提出的那个问题背后的精神。</p>
<p>我依然怀有他那份好奇与惊叹。正是这种感觉，每天都激励着我迎接空间智能的挑战。</p>
<p>历史上第一次，我们有望构建出与物理世界如此协调的机器，以至于在我们面临的最严峻挑战中，可以将它们视为真正的伙伴。</p>
<p>无论是加速我们对实验室中疾病的理解，彻底改变我们讲述故事的方式，还是在我们因疾病、受伤或年老而最脆弱的时刻给予支持，我们都正处在一项新技术的风口浪尖，这项技术将提升我们最珍视的生活的方方面面。这</p>
<p>是一个更深刻、更丰富、更强大的生活愿景。</p>
<p>在大自然于远古动物身上释放出第一缕空间智能的近五亿年后，我们有幸成为可能很快就能赋予机器同样能力的这一代技术专家中的一员——并有幸利用这些能力为世界各地的人们谋福祉。</p>
<p>我们关于真正智能机器的梦想，没有空间智能是不完整的。</p>
<p>这项探索，就是指引我的北极星。我邀请你与我同行。</p>
<p>参考资料：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fdrfeifei%2Fstatus%2F1987891210699379091" target="_blank" title="https://x.com/drfeifei/status/1987891210699379091" ref="nofollow noopener noreferrer">x.com/drfeifei/st…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdrfeifei.substack.com%2Fp%2Ffrom-words-to-worlds-spatial-intelligence" target="_blank" title="https://drfeifei.substack.com/p/from-words-to-worlds-spatial-intelligence" ref="nofollow noopener noreferrer">drfeifei.substack.com/p/from-word…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Guava 迭代器增强类介绍]]></title>    <link>https://juejin.cn/post/7570903763722453002</link>    <guid>https://juejin.cn/post/7570903763722453002</guid>    <pubDate>2025-11-10T16:17:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570903763722453002" data-draft-id="7570897638441320475" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Guava 迭代器增强类介绍"/> <meta itemprop="keywords" content="后端,Java,设计模式"/> <meta itemprop="datePublished" content="2025-11-10T16:17:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="桦说编程"/> <meta itemprop="url" content="https://juejin.cn/user/2212689394274136"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Guava 迭代器增强类介绍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2212689394274136/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    桦说编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-10T16:17:00.000Z" title="Mon Nov 10 2025 16:17:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-10
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    41
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Guava 库为 Java 开发者提供了一系列强大的迭代器增强工具，它们简化了复杂迭代模式的实现。本文将深入探讨 Guava 的 PeekingIterator、AbstractIterator 和 AbstractSequentialIterator。</p>
<h3 data-id="heading-0">1. AbstractSequentialIterator</h3>
<p>对于那些下一个值很容易根据前一个值计算出来的迭代器，AbstractSequentialIterator 提供了一种表达迭代的替代方式。</p>
<p><strong>核心功能：</strong></p>
<ul>
<li>开发者实现的方法是 <code>computeNext(T previous)</code>，它接受序列中的前一个值作为参数。</li>
<li>必须在构造函数中提供一个初始值（或者如果迭代器应立即终止，则传入 <code>null</code>）。</li>
<li><code>computeNext()</code> 方法约定，返回 <code>null</code> 意味着迭代结束。</li>
</ul>
<p><strong>它带来的便利：</strong></p>
<p>AbstractSequentialIterator 适用于那些下一个值可以根据前一个值计算出来的序列。它通过**按需生成（on-demand generation）**机制，仅在 <code>next()</code> 被调用时才计算下一个元素。这使得它非常适合处理可能非常长甚至无限的序列，因为它避免了预先计算和存储整个序列。</p>
<p><strong>示例：惰性计算 2 的幂次</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractSequentialIteratorExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 从1开始生成2的幂次方，直到达到 1 &lt;&lt; 30</span>
        Iterator&lt;Integer&gt; powersOfTwo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbstractSequentialIterator</span>&lt;Integer&gt;(<span class="hljs-number">1</span>) {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">protected</span> Integer <span class="hljs-title function_">computeNext</span><span class="hljs-params">(Integer previous)</span> {
                <span class="hljs-comment">// 如果 previous 已经达到最大值，则返回 null 结束迭代</span>
                <span class="hljs-keyword">return</span> (previous == <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">30</span>) ? <span class="hljs-literal">null</span> : previous * <span class="hljs-number">2</span>;
            }
        };

        System.out.println(<span class="hljs-string">"Powers of two (only consuming first 7):"</span>);
        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">while</span> (powersOfTwo.hasNext() &amp;&amp; count &lt; <span class="hljs-number">7</span>) { <span class="hljs-comment">// 假设我们只消费前7个元素</span>
            System.out.println(powersOfTwo.next());
            count++;
        }
        <span class="hljs-comment">// Output: 1, 2, 4, 8, 16, 32, 64</span>
    }
}
</code></pre>
<p>在此示例中，我们仅消费了序列的前 7 个元素。AbstractSequentialIterator 确保了只有这 7 次乘法操作被执行，并且在内存中只维护了当前 <code>previous</code> 元素的状态。这种惰性生成方式，避免了对整个序列进行预计算和存储的需要。</p>
<p><strong>关键限制：</strong> 由于返回 <code>null</code> 标志着迭代的结束，因此 AbstractSequentialIterator 不能用于实现一个可以合法返回 <code>null</code> 元素的迭代器。</p>
<p>笔者遇到一个按需深拷贝的需求，简单描述为：已获得对象a，需要深拷贝若干份，同时需要标记序号，a已经实现deepCopy方法。实现如下：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 实现1</span>
<span class="hljs-type">A</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> getA();
<span class="hljs-type">boolean</span> <span class="hljs-variable">first</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x: request.getXList()) {
    <span class="hljs-comment">// ...</span>
    <span class="hljs-keyword">if</span> (a != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">if</span> (first) {
            x.setA(a);
            first = <span class="hljs-literal">false</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-type">A</span> <span class="hljs-variable">newA</span> <span class="hljs-operator">=</span> a.deepCopy();
            newA.seq++;
            x.setA(newA);
        }
    }
    <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// 实现2，修改引用a</span>
<span class="hljs-type">A</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> getA();
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x: request.getXList()) {
    <span class="hljs-comment">// ...</span>
    <span class="hljs-keyword">if</span> (a != <span class="hljs-literal">null</span>) {
        x.setA(a);
        a = a.deepCopy(); <span class="hljs-comment">//会多复制一次</span>
        a.seq++;
    }
    <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// 新实现</span>
<span class="hljs-type">A</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> getA();
<span class="hljs-comment">// copy iter</span>
Iterator&lt;A&gt; aIter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbstractSequentialIterator</span>&lt;&gt;(a) {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> A <span class="hljs-title function_">computeNext</span><span class="hljs-params">(A prev)</span> {
        <span class="hljs-type">A</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> prev.deepCopy();
        result.seq++;
        <span class="hljs-keyword">return</span> result;
    }
};
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x: request.getXList()) {
    <span class="hljs-comment">// ...</span>
    <span class="hljs-keyword">if</span> (a != <span class="hljs-literal">null</span>) {
        x.setA(aIter.next());
    }
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>和原有实现相比，新实现抽取出了A的迭代逻辑，更好理解。</p>
<h3 data-id="heading-1">2. AbstractIterator：一个方法定义迭代器</h3>
<p>当需要实现一个自定义的 Iterator，例如对数据进行过滤、转换或从复杂数据源中提取时，手动管理 <code>hasNext()</code> 和 <code>next()</code> 的内部状态会引入大量样板代码。AbstractIterator 极大地简化了这一过程。</p>
<p><strong>核心功能：</strong></p>
<ul>
<li>开发者只需实现一个方法：<code>computeNext()</code>。此方法负责计算并返回序列中的下一个值。</li>
<li>当迭代序列完成时，<code>computeNext()</code> 应返回 <code>endOfData()</code> 以标记迭代结束。</li>
</ul>
<p><strong>它带来的便利：</strong></p>
<p>AbstractIterator 采用惰性求值（lazy evaluation）机制。它确保 <code>computeNext()</code> 方法仅在真正需要下一个元素（即 <code>next()</code> 被调用时）才会被执行。这使得迭代器能够按需生成元素，避免了在迭代器未被完全消费时进行不必要的计算。同时，Guava 负责处理 <code>hasNext()</code> 和 <code>next()</code> 之间的状态同步，简化了自定义迭代器的实现。</p>
<p><strong>示例：惰性过滤 Null 值</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractIteratorExample</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Iterator&lt;String&gt; <span class="hljs-title function_">skipNulls</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Iterator&lt;String&gt; in)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbstractIterator</span>&lt;String&gt;() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">computeNext</span><span class="hljs-params">()</span> {
                <span class="hljs-keyword">while</span> (in.hasNext()) {
                    <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> in.next();
                    <span class="hljs-keyword">if</span> (s != <span class="hljs-literal">null</span>) {
                        <span class="hljs-keyword">return</span> s; <span class="hljs-comment">// 找到非 null 元素，返回</span>
                    }
                }
                <span class="hljs-keyword">return</span> endOfData(); <span class="hljs-comment">// 内部迭代器耗尽，返回 endOfData()</span>
            }
        };
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        List&lt;String&gt; source = Arrays.asList(<span class="hljs-string">"hello"</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">"world"</span>, <span class="hljs-literal">null</span>, <span class="hljs-string">"guava"</span>, <span class="hljs-string">"java"</span>);
        Iterator&lt;String&gt; filteredIterator = skipNulls(source.iterator());

        System.out.println(<span class="hljs-string">"Filtered elements (only consuming first 3):"</span>);
        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">while</span> (filteredIterator.hasNext() &amp;&amp; count &lt; <span class="hljs-number">3</span>) { <span class="hljs-comment">// 假设我们只消费前3个元素</span>
            System.out.println(filteredIterator.next());
            count++;
        }
        <span class="hljs-comment">// Output:</span>
        <span class="hljs-comment">// hello</span>
        <span class="hljs-comment">// world</span>
        <span class="hljs-comment">// guava</span>
    }
}
</code></pre>
<p>在此示例中，即使 <code>source</code> 列表中有更多元素，我们只消费了前 3 个非空字符串。AbstractIterator 确保了 <code>in.next()</code> 和 <code>if (s != null)</code> 这样的操作仅执行了刚好足以找到这 3 个元素所需的最小次数。这种按需计算的模式，使得迭代器只在需要时才处理数据。</p>
<p><strong>限制：</strong> AbstractIterator 继承自 <code>UnmodifiableIterator</code>，这意味着它禁止实现 <code>remove()</code> 方法。如果您的迭代器必须支持 <code>remove()</code>，则不应继承 AbstractIterator。</p>
<h3 data-id="heading-2">3. PeekingIterator：洞察先机</h3>
<p>标准的 Iterator 接口仅提供 hasNext() 和 next() 方法，这在某些场景下显得力不从心。当需要“预读”下一个元素以做出决策，但又不想立即消耗它时，PeekingIterator 应运而生。</p>
<p><strong>核心功能：</strong></p>
<ul>
<li><code>Iterators.peekingIterator(Iterator)</code> 方法用于将现有的 <code>Iterator</code> 包装成一个 <code>PeekingIterator</code>。</li>
<li>其核心方法是 <code>peek()</code>，允许在不推进迭代器的情况下，查看下一个调用 <code>next()</code> 时将返回的元素。</li>
</ul>
<p><strong>它带来的便利：</strong></p>
<p>PeekingIterator 的 <code>peek()</code> 方法能够支持更灵活的迭代逻辑，尤其是在需要根据当前元素和“下一个”元素关系进行判断的场景中。它允许在一次迭代过程中完成复杂的逻辑判断和数据处理，避免了传统方法中可能出现的冗余 <code>next()</code> 调用或额外的状态变量管理。</p>
<p><strong>示例：消除连续重复元素</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PeekingIteratorExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        List&lt;Integer&gt; source = Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">5</span>);
        List&lt;Integer&gt; result = Lists.newArrayList();

        PeekingIterator&lt;Integer&gt; iter = Iterators.peekingIterator(source.iterator());

        <span class="hljs-keyword">while</span> (iter.hasNext()) {
            <span class="hljs-type">Integer</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> iter.next(); <span class="hljs-comment">// 获取当前元素</span>
            result.add(current); <span class="hljs-comment">// 将当前元素添加到结果</span>

            <span class="hljs-comment">// 利用 peek() 提前判断，如果下一个元素与当前元素重复，则跳过。</span>
            <span class="hljs-keyword">while</span> (iter.hasNext() &amp;&amp; iter.peek().equals(current)) {
                iter.next(); <span class="hljs-comment">// 跳过这个重复元素</span>
            }
        }
        System.out.println(<span class="hljs-string">"Original: "</span> + source);
        System.out.println(<span class="hljs-string">"Deduplicated: "</span> + result); <span class="hljs-comment">// Output: [1, 2, 3, 4, 5]</span>
    }
}
</code></pre>
<p>在此示例中，我们仅对 <code>source</code> 列表进行了一次逻辑遍历。PeekingIterator 使得我们能够在处理 <code>current</code> 元素的同时，预判并跳过所有后续的重复项，而无需将它们存储到任何中间结构或进行后续的去重处理。这简化了去重逻辑的实现。</p>
<p><strong>注意事项：</strong> 由 <code>Iterators.peekingIterator</code> 返回的 <code>PeekingIterator</code> 不支持在调用 <code>peek()</code> 之后执行 <code>remove()</code> 操作。</p>
<h3 data-id="heading-3">总结</h3>
<p>Guava 的 PeekingIterator、AbstractIterator 和 AbstractSequentialIterator 为 Java 开发者提供了强大的工具，用于简化和增强迭代器的使用。它们通过以下方式提升代码的健壮性和可维护性：</p>
<ul>
<li><strong>PeekingIterator：</strong> 允许在单次遍历中进行预判和复杂逻辑处理，减少了状态管理和冗余操作。</li>
<li><strong>AbstractIterator：</strong> 强制惰性求值，简化了自定义迭代器的实现，并按需处理数据。</li>
<li><strong>AbstractSequentialIterator：</strong> 实现按需生成序列，适用于处理长序列，避免了不必要的预计算和存储。</li>
</ul>
<p>在处理数据流、构建数据管道或实现复杂业务逻辑时，合理利用这些迭代器，可以使代码更加清晰、灵活，并更好地管理资源。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[flutter图片选择库multi_image_picker_plus和image_picker的对比和使用解析]]></title>    <link>https://juejin.cn/post/7570923924365230143</link>    <guid>https://juejin.cn/post/7570923924365230143</guid>    <pubDate>2025-11-11T00:24:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570923924365230143" data-draft-id="7560992984017322019" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="flutter图片选择库multi_image_picker_plus和image_picker的对比和使用解析"/> <meta itemprop="keywords" content="Flutter,Android,iOS"/> <meta itemprop="datePublished" content="2025-11-11T00:24:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏多多"/> <meta itemprop="url" content="https://juejin.cn/user/747323639737191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            flutter图片选择库multi_image_picker_plus和image_picker的对比和使用解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323639737191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏多多
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T00:24:37.000Z" title="Tue Nov 11 2025 00:24:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><p>在Flutter应用开发中，图片选择是高频场景，无论是头像上传、相册选图还是拍照功能，都需要可靠的图片选择组件支撑。目前社区中最常用的两款组件分别是<strong>multi_image_picker_plus</strong>和官方维护的<strong>image_picker</strong>。本文将从核心属性、API接口、使用流程、功能差异及优缺点等维度进行全面解析，帮助开发者根据业务需求精准选型。</p>
<h2 data-id="heading-0">1. 组件基础认知</h2>
<p>在深入细节前，先明确两款组件的核心定位，为后续对比建立基础，如下：</p>
<ul>
<li>
<p><strong>image_picker</strong>：Flutter官方团队维护的图片/视频选择组件，主打轻量、稳定，支持拍照和单张/多张图片选择，适配iOS和Android双平台，是官方推荐的基础选择。</p>
</li>
<li>
<p><strong>multi_image_picker_plus</strong>：第三方开源组件，基于早期的multi_image_picker迭代优化，专注于<strong>多图选择场景</strong>，提供更丰富的选图交互和图片处理能力，扩展性更强。</p>
</li>
</ul>
<h2 data-id="heading-1">2. 核心属性与API解析</h2>
<p>两款组件的属性和API设计围绕其定位展开，image_picker侧重简洁易用，multi_image_picker_plus侧重多图场景的精细化控制。</p>
<h3 data-id="heading-2">2.1. image_picker 核心解析</h3>
<p>image_picker的API设计极简，通过静态方法直接调用，核心属性集中在选择参数的配置上。</p>
<h4 data-id="heading-3">2.1.1. 关键属性</h4>









































<table><thead><tr><th>属性名</th><th>类型</th><th>作用</th><th>平台支持</th></tr></thead><tbody><tr><td>source</td><td>ImageSource</td><td>指定图片来源，可选gallery（相册）或camera（相机）</td><td>iOS/Android</td></tr><tr><td>imageQuality</td><td>int (0-100)</td><td>压缩后图片质量，数值越高质量越好，仅Android支持</td><td>Android</td></tr><tr><td>maxWidth/maxHeight</td><td>double</td><td>压缩后图片的最大宽高，超过则等比缩放</td><td>iOS/Android</td></tr><tr><td>requestFullMetadata</td><td>bool</td><td>是否请求图片元数据（如拍摄时间、位置），默认false</td><td>iOS/Android</td></tr><tr><td>preferredCameraDevice</td><td>CameraDevice</td><td>指定相机设备，可选rear（后置）或front（前置）</td><td>iOS/Android</td></tr></tbody></table>
<h4 data-id="heading-4">2.1.2. 核心API</h4>
<p>image_picker的核心API封装在<code>ImagePicker</code>类中，主要提供图片和视频选择方法，支持单张和多张选择：</p>
<ol>
<li><strong>单张图片选择</strong>：</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">Future&lt;XFile?&gt; pickImage({
  <span class="hljs-keyword">required</span> ImageSource source,
  <span class="hljs-built_in">double?</span> maxWidth,
  <span class="hljs-built_in">double?</span> maxHeight,
  <span class="hljs-built_in">int?</span> imageQuality,
  <span class="hljs-built_in">bool</span> requestFullMetadata = <span class="hljs-keyword">false</span>,
})
</code></pre>
<ol start="2">
<li><strong>多张图片选择</strong>：</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">Future&lt;<span class="hljs-built_in">List</span>&lt;XFile&gt;?&gt; pickMultiImage({
  <span class="hljs-built_in">double?</span> maxWidth,
  <span class="hljs-built_in">double?</span> maxHeight,
  <span class="hljs-built_in">int?</span> imageQuality,
  <span class="hljs-built_in">bool</span> requestFullMetadata = <span class="hljs-keyword">false</span>,
})
</code></pre>
<ol start="3">
<li><strong>拍照</strong>：</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">Future&lt;XFile?&gt; pickImage(
  source: ImageSource.camera, <span class="hljs-comment">// 指定相机来源</span>
  preferredCameraDevice: CameraDevice.front, <span class="hljs-comment">// 可选前置相机</span>
)
</code></pre>
<ol start="4">
<li><strong>获取图片临时路径</strong>：通过返回的<code>XFile</code>对象的<code>path</code>属性获取，可用于预览或上传。</li>
</ol>
<h3 data-id="heading-5">2.2. multi_image_picker_plus 核心解析</h3>
<p>multi_image_picker_plus专为多图场景设计，API支持批量选择、预览、编辑等功能，属性配置更细致，支持自定义选图界面风格。</p>
<h4 data-id="heading-6">2.2.1. 关键属性</h4>





















































<table><thead><tr><th>属性名</th><th>类型</th><th>作用</th><th>平台支持</th></tr></thead><tbody><tr><td>maxImages</td><td>int</td><td>最大选择图片数量，必填参数</td><td>iOS/Android</td></tr><tr><td>selectedAssets</td><td>List</td><td>已选择的图片列表，用于回显已选内容</td><td>iOS/Android</td></tr><tr><td>enableCamera</td><td>bool</td><td>是否显示相机入口，支持选图时直接拍照</td><td>iOS/Android</td></tr><tr><td>cupertinoOptions</td><td>CupertinoOptions</td><td>iOS端自定义配置（如标题、取消按钮文字）</td><td>iOS</td></tr><tr><td>materialOptions</td><td>MaterialOptions</td><td>Android端自定义配置（如主题色、网格列数）</td><td>Android</td></tr><tr><td>compressQuality</td><td>int (0-100)</td><td>图片压缩质量，双平台均支持</td><td>iOS/Android</td></tr><tr><td>compressSize</td><td>int</td><td>图片压缩后最大尺寸（KB），超过则进一步压缩</td><td>iOS/Android</td></tr></tbody></table>
<h4 data-id="heading-7">2.2.2. 核心API</h4>
<p>multi_image_picker_plus的核心是<code>MultiImagePicker</code>类，通过<code>pickImages</code>方法触发选图，返回<code>Asset</code>对象列表（包含图片详情），关键API如下：</p>
<ol>
<li><strong>多图选择</strong>：</li>
</ol>
<pre><code class="hljs language-dart" lang="dart">Future&lt;<span class="hljs-built_in">List</span>&lt;Asset&gt;&gt; pickImages({
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">int</span> maxImages,
  <span class="hljs-built_in">List</span>&lt;Asset&gt; selectedAssets = <span class="hljs-keyword">const</span> [],
  <span class="hljs-built_in">bool</span> enableCamera = <span class="hljs-keyword">true</span>,
  CupertinoOptions cupertinoOptions = <span class="hljs-keyword">const</span> CupertinoOptions(),
  MaterialOptions materialOptions = <span class="hljs-keyword">const</span> MaterialOptions(),
  <span class="hljs-built_in">int</span> compressQuality = <span class="hljs-number">80</span>,
  <span class="hljs-built_in">int?</span> compressSize,
})
</code></pre>
<ol start="2">
<li>
<p><strong>Asset对象核心方法</strong>：
<code>getByteData({int? width, int? height})</code>：获取图片字节数据，支持指定宽高缩放</p>
</li>
<li>
<p><code>getImageByteData()</code>：获取原始图片字节数据</p>
</li>
<li>
<p><code>getThumbByteData(int width, int height)</code>：获取缩略图字节数据</p>
</li>
<li>
<p><code>getMetadata()</code>：获取图片元数据（尺寸、类型、拍摄时间等）</p>
</li>
<li>
<p><strong>预览已选图片</strong>：通过<code>AssetPreview</code>组件可直接预览<code>Asset</code>列表，无需额外处理路径。</p>
</li>
</ol>
<h2 data-id="heading-8">3. 实际使用流程对比</h2>
<p>两款组件的集成流程相似，但在多图处理和自定义场景下存在差异，以下是完整集成步骤对比。</p>
<h3 data-id="heading-9">3.1. image_picker 集成步骤</h3>
<p>下面是一个基本例子的集成步骤：</p>
<h4 data-id="heading-10">3.1.1. 添加依赖</h4>
<p>在<code>pubspec.yaml</code>中添加依赖并执行<code>pub get</code>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">image_picker:</span> <span class="hljs-string">^1.1.1</span>
</code></pre>
<h4 data-id="heading-11">3.1.2. 平台配置</h4>
<p>iOS：在<code>Info.plist</code>中添加权限描述：</p>
<pre><code class="hljs language-plist" lang="plist"><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>NSPhotoLibraryUsageDescription<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>需要访问相册以选择图片<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>NSCameraUsageDescription<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>需要访问相机以拍摄图片<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
</code></pre>
<p>Android：在<code>AndroidManifest.xml</code>中添加权限：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.READ_EXTERNAL_STORAGE"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.CAMERA"</span>/&gt;</span>
<span class="hljs-comment">&lt;!-- Android 13+ 需添加读写媒体权限 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.READ_MEDIA_IMAGES"</span>/&gt;</span>
</code></pre>
<h4 data-id="heading-12">3.1.3. 核心代码实现</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:image_picker/image_picker.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImagePickerDemo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _ImagePickerDemoState createState() =&gt; _ImagePickerDemoState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_ImagePickerDemoState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">ImagePickerDemo</span>&gt; </span>{
  <span class="hljs-keyword">final</span> ImagePicker _picker = ImagePicker();
  <span class="hljs-built_in">List</span>&lt;XFile&gt; _selectedImages = [];

  <span class="hljs-comment">// 选择多张图片</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; _pickMultiImages() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;XFile&gt;? images = <span class="hljs-keyword">await</span> _picker.pickMultiImage(
      imageQuality: <span class="hljs-number">80</span>, <span class="hljs-comment">// 压缩质量</span>
      maxWidth: <span class="hljs-number">1080</span>, <span class="hljs-comment">// 最大宽度</span>
    );
    <span class="hljs-keyword">if</span> (images != <span class="hljs-keyword">null</span>) {
      setState(() =&gt; _selectedImages = images);
    }
  }

  <span class="hljs-comment">// 拍照</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; _takePhoto() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> XFile? photo = <span class="hljs-keyword">await</span> _picker.pickImage(
      source: ImageSource.camera,
      preferredCameraDevice: CameraDevice.front,
    );
    <span class="hljs-keyword">if</span> (photo != <span class="hljs-keyword">null</span>) {
      setState(() =&gt; _selectedImages.add(photo));
    }
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(title: Text(<span class="hljs-string">"ImagePicker示例"</span>)),
      body: GridView.count(
        crossAxisCount: <span class="hljs-number">3</span>,
        children: [
          <span class="hljs-comment">// 选择按钮</span>
          IconButton(onPressed: _pickMultiImages, icon: Icon(Icons.photo_library)),
          IconButton(onPressed: _takePhoto, icon: Icon(Icons.camera)),
          <span class="hljs-comment">// 已选图片预览</span>
          ..._selectedImages.map((image) =&gt; Image.file(File(image.path))),
        ],
      ),
    );
  }
}
</code></pre>
<h3 data-id="heading-13">3.2 multi_image_picker_plus 集成步骤</h3>
<p>下面是一个基本例子的集成步骤：</p>
<h4 data-id="heading-14">3.2.1. 添加依赖</h4>
<p>在<code>pubspec.yaml</code>中添加依赖并执行<code>pub get</code>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">multi_image_picker_plus:</span> <span class="hljs-string">^1.0.5</span>
</code></pre>
<h4 data-id="heading-15">3.2.2. 平台配置</h4>
<p>iOS：在<code>Info.plist</code>中添加相册和相机权限描述。</p>
<pre><code class="hljs language-plist" lang="plist"><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>NSPhotoLibraryUsageDescription<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>需要访问相册以选择图片<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>NSCameraUsageDescription<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>需要访问相机以拍摄图片<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
</code></pre>
<p>Android：在<code>AndroidManifest.xml</code>中添加权限，并配置主题（可选）：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.READ_EXTERNAL_STORAGE"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.CAMERA"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">"android.permission.WRITE_EXTERNAL_STORAGE"</span> <span class="hljs-attr">android:maxSdkVersion</span>=<span class="hljs-string">"32"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">application</span> <span class="hljs-attr">...</span> <span class="hljs-attr">android:theme</span>=<span class="hljs-string">"@style/Theme.AppCompat.Light"</span>/&gt;</span>
</code></pre>
<h4 data-id="heading-16">3.2.3. 核心代码实现</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:multi_image_picker_plus/multi_image_picker_plus.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MultiImagePickerDemo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _MultiImagePickerDemoState createState() =&gt; _MultiImagePickerDemoState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MultiImagePickerDemoState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">MultiImagePickerDemo</span>&gt; </span>{
  <span class="hljs-built_in">List</span>&lt;Asset&gt; _selectedAssets = [];

  <span class="hljs-comment">// 选择多图</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; _pickImages() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-built_in">List</span>&lt;Asset&gt; resultList = <span class="hljs-keyword">await</span> MultiImagePicker.pickImages(
        maxImages: <span class="hljs-number">9</span>, <span class="hljs-comment">// 最多选9张</span>
        selectedAssets: _selectedAssets, <span class="hljs-comment">// 回显已选</span>
        enableCamera: <span class="hljs-keyword">true</span>, <span class="hljs-comment">// 显示相机入口</span>
        compressQuality: <span class="hljs-number">80</span>, <span class="hljs-comment">// 压缩质量</span>
        materialOptions: MaterialOptions(
          actionBarColor: <span class="hljs-string">"#2196F3"</span>, <span class="hljs-comment">// 标题栏颜色</span>
          statusBarColor: <span class="hljs-string">"#2196F3"</span>, <span class="hljs-comment">// 状态栏颜色</span>
          gridColumnCount: <span class="hljs-number">4</span>, <span class="hljs-comment">// 网格列数</span>
        ),
      );
      setState(() =&gt; _selectedAssets = resultList);
    } <span class="hljs-keyword">on</span> Exception <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">"选图异常：<span class="hljs-subst">$e</span>"</span>);
    }
  }

  <span class="hljs-comment">// 预览图片</span>
  <span class="hljs-keyword">void</span> _previewImages() {
    <span class="hljs-keyword">if</span> (_selectedAssets.isNotEmpty) {
      Navigator.push(
        context,
        MaterialPageRoute(
          builder: (context) =&gt; AssetPreview(
            assets: _selectedAssets,
            startIndex: <span class="hljs-number">0</span>,
          ),
        ),
      );
    }
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(title: Text(<span class="hljs-string">"MultiImagePickerPlus示例"</span>)),
      body: Column(
        children: [
          ElevatedButton(onPressed: _pickImages, child: Text(<span class="hljs-string">"选择图片"</span>)),
          ElevatedButton(onPressed: _previewImages, child: Text(<span class="hljs-string">"预览图片"</span>)),
          Expanded(
            child: GridView.count(
              crossAxisCount: <span class="hljs-number">4</span>,
              children: _selectedAssets.map((asset) =&gt;
                AssetThumb(
                  asset: asset,
                  width: <span class="hljs-number">100</span>,
                  height: <span class="hljs-number">100</span>,
                )
              ).toList(),
            ),
          ),
        ],
      ),
    );
  }
}
</code></pre>
<h2 data-id="heading-17">4. 核心差异与优缺点对比</h2>
<p>基于上述解析，两款组件在功能、性能、扩展性等方面存在显著差异，以下从多个维度进行对比：</p>
<h3 data-id="heading-18">4.1 核心功能差异</h3>













































<table><thead><tr><th>功能点</th><th>image_picker</th><th>multi_image_picker_plus</th></tr></thead><tbody><tr><td>多图选择</td><td>支持，但无选图数量实时提示</td><td>原生支持，显示已选数量和剩余可选项</td></tr><tr><td>选图时拍照</td><td>需单独调用相机API，无法在选图界面直接拍照</td><td>支持在选图界面内置相机入口，拍照后直接加入已选</td></tr><tr><td>界面自定义</td><td>无，使用系统原生选图界面</td><td>支持双平台主题、颜色、网格列数等自定义</td></tr><tr><td>图片预览</td><td>需通过File路径自行实现预览组件</td><td>提供AssetPreview组件，直接预览Asset列表</td></tr><tr><td>压缩控制</td><td>仅支持质量和宽高压缩，Android/iOS差异大</td><td>支持质量、尺寸、大小三重压缩，双平台统一</td></tr><tr><td>元数据获取</td><td>需开启requestFullMetadata，仅返回基础信息</td><td>原生支持，可获取尺寸、类型、拍摄时间等详细信息</td></tr><tr><td>视频选择</td><td>支持单视频/多视频选择</td><td>仅支持图片选择，不支持视频</td></tr></tbody></table>
<h3 data-id="heading-19">4.2 优缺点对比</h3>
<p>以下分类型维度进行对比:</p>
<h4 data-id="heading-20">4.2.1. image_picker的优缺点</h4>
<ul>
<li>
<p><strong>优点</strong>：
官方维护，稳定性高，与Flutter版本兼容性好</p>
</li>
<li>
<p>轻量简洁，API学习成本低，快速集成</p>
</li>
<li>
<p>支持视频选择，满足图文+视频混合场景</p>
</li>
<li>
<p>系统原生界面，用户熟悉度高，交互一致性好</p>
</li>
</ul>
<p><strong>缺点</strong>：
多图选择体验差，无实时数量提示和已选回显优化</p>
<p>界面无法自定义，无法匹配APP整体设计风格</p>
<p>压缩和预览需自行处理，开发效率低</p>
<p>Android和iOS压缩逻辑不一致，需额外适配</p>
<h4 data-id="heading-21">4.2.2. multi_image_picker_plus的优缺点</h4>
<ul>
<li>
<p><strong>优点</strong>：
多图选择体验极佳，支持已选回显、数量控制、内置相机</p>
</li>
<li>
<p>丰富的自定义能力，可匹配APP主题风格</p>
</li>
<li>
<p>提供AssetPreview、AssetThumb等组件，减少重复开发</p>
</li>
<li>
<p>统一的压缩逻辑，双平台表现一致</p>
</li>
<li>
<p>Asset对象封装完善，便于图片处理和上传</p>
</li>
</ul>
<p><strong>缺点</strong>：
第三方维护，版本更新速度可能滞后于Flutter新版本</p>
<p>不支持视频选择，需额外集成其他组件</p>
<p>自定义配置项多，初次集成需熟悉更多参数</p>
<p>包体积略大于image_picker</p>
<h2 data-id="heading-22">5. 选型建议</h2>
<p>根据业务场景的不同，两款组件的适用场景存在明显区分，建议按以下原则选型：</p>
<ol>
<li>
<p><strong>优先选择 image_picker 的场景</strong>：
简单的单图选择或拍照场景（如头像上传）</p>
</li>
<li>
<p>需要同时支持图片和视频选择的场景</p>
</li>
<li>
<p>对包体积敏感，追求轻量集成的场景</p>
</li>
<li>
<p>重视官方维护保障，需长期稳定性的场景</p>
</li>
<li>
<p><strong>优先选择 multi_image_picker_plus 的场景</strong>：
核心场景为多图选择（如朋友圈、相册上传）</p>
</li>
<li>
<p>对选图界面风格有自定义需求，需匹配APP主题</p>
</li>
<li>
<p>需要优化多图选图体验（如已选回显、内置相机）</p>
</li>
<li>
<p>需要快速实现图片预览、缩略图展示的场景</p>
</li>
</ol>
<h2 data-id="heading-23">6. 总结</h2>
<p>image_picker和multi_image_picker_plus各有侧重：</p>
<ul>
<li>image_picker是官方背书的"基础款"，胜在稳定轻量、支持视频；</li>
<li>multi_image_picker_plus是多图场景的"专业款"，赢在体验优化和自定义能力。</li>
</ul>
<p>开发者在实际开发中需结合业务需求的核心痛点，权衡稳定性、功能完整性和开发效率，选择最适合的组件。若需同时支持多图和视频，可考虑两者结合使用。用multi_image_picker_plus处理多图，而image_picker补充视频选择能力。</p>
<hr/>
<blockquote>
<p>本次分享就到这儿啦，我是鹏多多，深耕前端的技术创作者，如果您看了觉得有帮助，欢迎评论，关注，点赞，转发，我们下次见~</p>
</blockquote>
<p>PS：在本页按F12，在console中输入document.getElementsByClassName('panel-btn')[0].click();有惊喜哦~</p>
<p><code>往期文章</code></p>
<ul>
<li><a href="https://juejin.cn/post/7568136081302978623" target="_blank" title="https://juejin.cn/post/7568136081302978623">解锁flutter弹窗新姿势：dialog-flutter_smart_dialog插件解读+案例</a></li>
<li><a href="https://juejin.cn/post/7559089440901545999" target="_blank" title="https://juejin.cn/post/7559089440901545999">flutter-切换状态显示不同组件10种实现方案全解析</a></li>
<li><a href="https://juejin.cn/post/7555079970491318308" target="_blank" title="https://juejin.cn/post/7555079970491318308">flutter-详解控制组件显示的两种方式Offstage与Visibility</a></li>
<li><a href="https://juejin.cn/post/7535358416182788122" target="_blank" title="https://juejin.cn/post/7535358416182788122">flutter-使用AnimatedDefaultTextStyle实现文本动画</a></li>
<li><a href="https://juejin.cn/post/7537339432291434496" target="_blank" title="https://juejin.cn/post/7537339432291434496">flutter-使用SafeArea组件处理各机型的安全距离</a></li>
<li><a href="https://juejin.cn/spost/7537593417099149321" target="_blank" title="https://juejin.cn/spost/7537593417099149321">flutter-实现渐变色边框背景以及渐变色文字</a></li>
<li><a href="https://juejin.cn/post/7543474419240370185" target="_blank" title="https://juejin.cn/post/7543474419240370185">flutter-使用confetti制作炫酷纸屑爆炸粒子动画</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用Unsloth微调一个老中医垂直领域大模型]]></title>    <link>https://juejin.cn/post/7571304204720406582</link>    <guid>https://juejin.cn/post/7571304204720406582</guid>    <pubDate>2025-11-11T06:12:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571304204720406582" data-draft-id="7571005216910393363" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用Unsloth微调一个老中医垂直领域大模型"/> <meta itemprop="keywords" content="LLM,Agent,程序员"/> <meta itemprop="datePublished" content="2025-11-11T06:12:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型教程"/> <meta itemprop="url" content="https://juejin.cn/user/1145012233707299"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用Unsloth微调一个老中医垂直领域大模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1145012233707299/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型教程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T06:12:58.000Z" title="Tue Nov 11 2025 06:12:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p>本文介绍了如何使用Unsloth框架微调大语言模型，以《伤寒论》数据集为例训练一个中医专家模型。Unsloth显著降低了微调的资源需求。文章涵盖了从环境配置、模型选择、数据准备到训练部署的完整流程，为垂直领域模型微调提供了实用参考。</p>
<p>在实际应用中，我们常常面临特定场景下的问题需求。此时，通过指令微调可以让模型更好地适应这些具体任务，从而提升模型的实用性和表现。</p>
<p>比如：在医疗健康领域，医生希望让大模型更好地理解中医诊断和治疗的知识体系，从而能够辅助分析病情、推荐中药方剂，甚至自动生成病历摘要。又如，在法律行业，律师团队希望通过微调，让大模型能够更准确地解读中国法律条文、判例和合同文本，辅助法律检索和文书生成。此外，在教育领域，教师可以通过指令微调，让模型更贴合本地教材内容，自动批改作业、生成个性化学习建议。这些场景都需要针对特定任务和数据对大模型进行定制化微调，以提升其在实际应用中的表现和价值。</p>
<p>正好最近身体不适，并且得到一本医疗秘籍《伤寒论》，用 <code>Unsloth</code> 来微调一个垂直领域的模型出来。</p>
<h2 data-id="heading-0">1.  关于Unsloth</h2>
<p>大型语言模型（LLM）的微调有很大的资源挑战，如高昂的内存需求和漫长的训练时间。</p>
<p>传统的微调方法，可能需要数十小时才能完成一项任务，并且常常导致内存不足问题 。这种特性限制了个人开发者和小型团队对 LLM 进行定制化和优化的能力。</p>
<p>Unsloth 正是为了解决这些痛点而诞生的。</p>
<p>它是一个专门为加速 LLM 微调并显著降低内存消耗而设计的 Python 框架 。</p>
<p>Unsloth 实现了显著的性能提升，同时保持了与 Hugging Face 生态系统的完全兼容性 。这使得用户即使在免费的 Colab GPU 或配备 GPU 的笔记本电脑等有限硬件上，也能够高效地进行 LLM 微调 。</p>
<h2 data-id="heading-1">2.  Unsloth 的核心优势</h2>
<p><strong>速度提升</strong></p>
<p>在Alpaca 数据集上进行了测试，使用的 batch 大小为 2，gradient accumulation steps 为 4，rank 为 32，并在所有线性层（q、k、v、o、gate、up、down）上应用了 QLoRA</p>





























<table><thead><tr><th>Model</th><th>VRAM</th><th>Unsloth speed</th><th>VRAM reduction</th><th>Longer context</th><th>Hugging Face + FA2</th></tr></thead><tbody><tr><td>Llama 3.3 (70B)</td><td>80GB</td><td>2x</td><td>&gt;75%</td><td>13x longer</td><td>1x</td></tr><tr><td>Llama 3.1 (8B)</td><td>80GB</td><td>2x</td><td>&gt;70%</td><td>12x longer</td><td>1x</td></tr></tbody></table>
<p>测试结果显示，两种模型在显存使用上均为80GB，速度均提升了2倍。Llama 3.3的显存减少了超过75%，能够处理的上下文长度提升了13倍；而Llama 3.1的显存减少了超过70%，上下文长度提升了12倍。</p>
<p><strong>API 简化</strong></p>
<p>Unsloth 提供了一个简洁的 API，显著降低了 LLM 微调的复杂性 。它将模型加载、量化、训练、评估、保存、导出以及与 Ollama、llama.cpp 和 vLLM 等推理引擎的集成等所有工作流程进行了简化 。</p>
<p><strong>Hugging Face 生态系统兼容性</strong></p>
<p>Unsloth 是在 Hugging Face Transformers 库之上构建的，这使其能够充分利用 Hugging Face 强大的生态系统，同时添加自己的增强功能来简化微调过程 。</p>
<p>它与 Hugging Face Hub、Transformers、PEFT 和 TRL 等组件完全兼容 。这意味着用户可以无缝地访问 Hugging Face 提供的丰富模型和数据集资源，并利用 Unsloth 的优化进行训练。</p>
<p><strong>硬件兼容性与可访问性</strong></p>
<p>Unsloth 支持非常多的 NVIDIA GPU，从 2018 年及以后发布的型号，包括 V100、T4、Titan V、RTX 20、30、40 系列、A100 和 H100 等，最低 CUDA 能力要求为 7.0。即使是 GTX 1070 和 1080 也能工作，尽管速度较慢 。</p>
<p>Unsloth 可以在 Linux 和 Windows 操作系统上运行 。</p>
<p><strong>广泛的模型支持</strong></p>
<p>Unsloth 支持所有 Transformer 风格的模型，包括 Llama、DeepSeek、TTS、Qwen、Mistral、Gemma 等主流 LLM。它还支持多模态模型、文本到语音 (TTS)、语音到文本 (STT) 模型、BERT 模型以及扩散模型。</p>
<p><strong>动态量化</strong></p>
<p>Unsloth 引入了动态 4 位量化 (Dynamic 4-bit Quantization) 技术，这是一种智能的量化策略，通过动态选择不对某些参数进行量化，从而在仅增加不到 10% VRAM 的情况下显著提高准确性 。</p>
<p><strong>社区的活跃</strong></p>
<p>从GitHub上可以看出，他的受欢迎程度非常高，目前已经43k颗星</p>
<blockquote>
<p>❝</p>
<p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Funslothai%2Funsloth" target="_blank" title="https://github.com/unslothai/unsloth" ref="nofollow noopener noreferrer">github.com/unslothai/u…</a></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fcdecd2deb545b589b9c4e71cb0ce83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763446378&amp;x-signature=ClBLhODcfYaWWVRXbkvK0TMccGg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">3.  使用要求</h2>
<hr/>
<p>支持 Linux 和 Windows。</p>
<p>支持 2018 年及以后的 NVIDIA 显卡，包括 Blackwell RTX 50 系列。最低要求 CUDA 计算能力为 7.0（如 V100、T4、Titan V、RTX 20、30、40 系列，以及 A100、H100、L40 等）。GTX 1070、1080 虽然可以使用，但运行速度较慢。</p>
<p><strong>GPU内存要求：</strong></p>











































































<table><thead><tr><th>Model parameters</th><th>QLoRA (4-bit) VRAM</th><th>LoRA (16-bit) VRAM</th></tr></thead><tbody><tr><td>3B</td><td>3.5 GB</td><td>8 GB</td></tr><tr><td>7B</td><td>5 GB</td><td>19 GB</td></tr><tr><td>8B</td><td>6 GB</td><td>22 GB</td></tr><tr><td>9B</td><td>6.5 GB</td><td>24 GB</td></tr><tr><td>11B</td><td>7.5 GB</td><td>29 GB</td></tr><tr><td>14B</td><td>8.5 GB</td><td>33 GB</td></tr><tr><td>27B</td><td>22GB</td><td>64GB</td></tr><tr><td>32B</td><td>26 GB</td><td>76 GB</td></tr><tr><td>40B</td><td>30GB</td><td>96GB</td></tr><tr><td>70B</td><td>41 GB</td><td>164 GB</td></tr><tr><td>81B</td><td>48GB</td><td>192GB</td></tr><tr><td>90B</td><td>53GB</td><td>212GB</td></tr><tr><td>405B</td><td>237 GB</td><td>950 GB</td></tr></tbody></table>
<h2 data-id="heading-3">4.  安装 Unsloth</h2>
<hr/>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 初始化一个名为 demo-unsloth 的项目，并指定 Python 版本为 3.11.9  </span>
uv init demo-unsloth -p 3.11.9  
<span class="hljs-comment"># 进入项目目录  </span>
<span class="hljs-built_in">cd</span> demo-unsloth  
<span class="hljs-comment"># 创建虚拟环境  </span>
uv venv  
<span class="hljs-comment"># 激活虚拟环境（Windows 下）  </span>
.venv\Scripts\activate  
<span class="hljs-comment"># 安装 triton-windows，要求版本3.3.1.post19  </span>
uv pip install triton-windows==3.3.1.post19  
<span class="hljs-comment"># 安装支持 CUDA 12.6 的 PyTorch 及其相关库  </span>
uv pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu126
</code></pre>
<p><strong>安装unsloth</strong></p>
<pre><code class="hljs">uv pip install unsloth
</code></pre>
<h2 data-id="heading-4">5.  选择模型</h2>
<hr/>
<p>Unsloth 支持非常多的预训练模型，包括 Llama、DeepSeek、TTS、Qwen、Mistral 和 Gemma 系列 LLM 3。</p>
<p>在选择模型时，需要注意模型名称的后缀。以 <code>unsloth-bnb-4bit</code> 结尾的模型表示它们是 Unsloth 动态 4 位量化模型，与标准 <code>bnb-4bit</code> 模型相比，这些模型在略微增加 VRAM 使用的情况下提供了更高的精度。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.unsloth.ai%2Fget-started%2Fall-our-models" target="_blank" title="https://docs.unsloth.ai/get-started/all-our-models" ref="nofollow noopener noreferrer">docs.unsloth.ai/get-started…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e079ef9a2c44f6cbbb68adbc9a84acf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763446378&amp;x-signature=OIda%2FB%2B45WTQ8nLx7Da6blqwa2o%3D" alt="" loading="lazy"/></p>
<p><strong>我的显卡是RTX 2050显卡，4GB显存，我选一个比较小的版本 unsloth/Qwen2.5-1.5B-Instruct-bnb-4bit</strong></p>
<p><strong>下载模型：</strong></p>
<pre><code class="hljs language-css" lang="css">huggingface-cli download <span class="hljs-attr">--resume-download</span> unsloth/Qwen2.<span class="hljs-number">5</span>-<span class="hljs-number">1.5</span>B-Instruct-bnb-<span class="hljs-number">4</span>bit <span class="hljs-attr">--local-dir</span> ./ckpts/qwen2.<span class="hljs-number">5</span>-<span class="hljs-number">1.5</span>b-instruct-bnb-<span class="hljs-number">4</span>bit
</code></pre>
<h2 data-id="heading-5">6.  数据集准备</h2>
<hr/>
<p>数据集的质量和格式直接决定了模型微调的效果。</p>
<p>一个高质量的数据集不仅需要覆盖目标任务的核心内容，还应保证问答对的准确性、完整性和多样性。</p>
<p>此外，数据集的规模也会影响模型的泛化能力，数据量越大、覆盖面越广，模型在实际应用中的表现通常会更好。</p>
<p>因此，在微调前应充分清洗、标注和检查数据，确保其能够有效支撑下游任务的训练需求。</p>
<p>因为要要训练一个老中医，所以找了一本《伤寒论》,通过工具把他拆成问答对，格式如下</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[    {      <span class="hljs-string">"Question"</span>: <span class="hljs-string">"伤寒一日，巨阳受之会出现什么症状？"</span>,      <span class="hljs-string">"Response"</span>: <span class="hljs-string">"伤寒一日，巨阳受之会出现头项痛、腰脊强的症状。因为巨阳者，诸阳之属也，其脉连于风府，为诸阳主气，所以先受邪。 "</span>    },    {      <span class="hljs-string">"Question"</span>: <span class="hljs-string">"三阴受病，厥阴受之会出现什么症状"</span>,      <span class="hljs-string">"Response"</span>: <span class="hljs-string">"三阴受病，若厥阴受之，厥阴脉循阴器而络于肝，会出现烦满而囊缩的症状。 若伤寒循常无变，十二日厥阴病衰，会出现囊纵、少腹微下的情况。 "</span>    },  ]</span>
</code></pre>
<h2 data-id="heading-6">7.  开始微调</h2>
<hr/>
<h4 data-id="heading-7">7.1 引入依赖</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 导入必要的库  </span>
<span class="hljs-keyword">from</span> unsloth <span class="hljs-keyword">import</span> FastLanguageModel, is_bfloat16_supported  
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> TrainingArguments, EarlyStoppingCallback  
<span class="hljs-keyword">from</span> trl <span class="hljs-keyword">import</span> SFTTrainer  
<span class="hljs-keyword">from</span> datasets <span class="hljs-keyword">import</span> load_dataset  
  
<span class="hljs-comment"># 模型配置参数  </span>
max_seq_length = <span class="hljs-number">2048</span>  <span class="hljs-comment"># 模型处理文本的最大序列长度，支持长文本输入</span>
</code></pre>
<h4 data-id="heading-8">7.2 加载模型</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 加载预训练模型和分词器  </span>
model, <span class="hljs-attr">tokenizer</span> = FastLanguageModel.from_pretrained(  
    <span class="hljs-attr">model_name</span>=<span class="hljs-string">"ckpts/qwen2.5-1.5b-instruct-bnb-4bit"</span>,  
    <span class="hljs-attr">max_seq_length</span>=max_seq_length,  
    <span class="hljs-attr">dtype</span>=None,  <span class="hljs-comment"># 自动检测最佳数据类型（bfloat16或float16）  </span>
    <span class="hljs-attr">load_in_4bit</span>=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 使用4bit量化加载模型，大幅减少显存占用  </span>
)
</code></pre>
<h4 data-id="heading-9">7.3 加载数据集</h4>
<p>大型语言模型需要以特定的“提示风格”或“聊天模板”来接收输入，以便它们能够正确理解任务、指令、输入和预期响应之间的关系。</p>
<p>例如，一个常用的提示风格是：</p>
<pre><code class="hljs language-bash" lang="bash">“请先阅读下方的任务指令，再结合提供的上下文信息，生成恰当的回复。<span class="hljs-comment">### 指令：{} ### 上下文：{} ### 回复：{}”</span>
</code></pre>
<p>有效的微调需要仔细关注输入格式，因为它直接影响模型学习的内容和响应方式</p>
<p>下面代码中加载我们的《伤寒论》数据集（ <code>data/datasets-2025-08.json</code>），并使用 <code>formatting_data</code> 函数将其转换为 Unsloth 所需的格式，此函数会结合输入和输出，按照 <code>prompt_style</code> 进行格式化，并添加 <code>EOS_TOKEN</code>（End-of-Sentence Token），<code>EOS_TOKEN</code> 对于避免模型生成重复内容至关重要。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 定义训练数据格式化模板  </span>
<span class="hljs-comment"># 使用中医专家角色设定，专门针对《伤寒论》问答任务  </span>
train_prompt_style = <span class="hljs-string">"""你是一位精通中医理论的专家，特别擅长《伤寒论》的理论和实践应用。  
请根据《伤寒论》的经典理论，准确回答以下问题。  
  
### 问题:  
{}  
  
### 回答:  
{}  
"""</span>  
  
<span class="hljs-comment"># 加载训练数据集  </span>
<span class="hljs-comment"># 从JSON文件加载伤寒论问答数据集，包含问题和回答对  </span>
dataset = load_dataset(<span class="hljs-string">"json"</span>, data_files=<span class="hljs-string">"data/datasets-2025-08.json"</span>, split=<span class="hljs-string">"train"</span>)    
  
  
<span class="hljs-keyword">def</span> <span class="hljs-title function_">formatting_data</span>(<span class="hljs-params">examples</span>):  
    <span class="hljs-string">"""格式化数据集函数，将问答对转换为训练格式  
      
    将原始的问题和回答对格式化为模型训练所需的文本格式，  
    添加角色设定和结构化模板。  
  
    Args:  
        examples: 包含Question、Response字段的数据样本字典  
  
    Returns:  
        dict: 包含格式化后文本的字典，键为"text"  
    """</span>  
    questions = examples[<span class="hljs-string">"Question"</span>]  
    responses = examples[<span class="hljs-string">"Response"</span>]  
    texts = []  
    <span class="hljs-keyword">for</span> q, r <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(questions, responses):  
        <span class="hljs-comment"># 使用模板格式化每个问答对，并添加结束标记  </span>
        text = train_prompt_style.<span class="hljs-built_in">format</span>(q, r) + tokenizer.eos_token  
        texts.append(text)  
    <span class="hljs-comment"># print(f"数据集: {texts}")  </span>
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"text"</span>: texts}  
  
  
<span class="hljs-comment"># 应用数据格式化函数  </span>
dataset = dataset.<span class="hljs-built_in">map</span>(formatting_data, batched=<span class="hljs-literal">True</span>, num_proc=<span class="hljs-number">1</span>)  
  
<span class="hljs-comment"># 数据集分割：80%用于训练，20%用于验证  </span>
<span class="hljs-comment"># 使用固定随机种子确保结果可复现  </span>
train_test_split = dataset.train_test_split(test_size=<span class="hljs-number">0.2</span>, seed=<span class="hljs-number">3407</span>)  
train_dataset = train_test_split[<span class="hljs-string">'train'</span>]  
eval_dataset = train_test_split[<span class="hljs-string">'test'</span>]  
  
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"数据集加载完成 - 训练集: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(train_dataset)}</span> 条, 验证集: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(eval_dataset)}</span> 条"</span>)
</code></pre>
<h4 data-id="heading-10">7.4 定义 LoRA</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 添加LoRA（Low-Rank Adaptation）权重配置  </span>
<span class="hljs-comment"># LoRA是一种高效的微调方法，只训练少量参数即可适应新任务  </span>
<span class="hljs-attr">model</span> = FastLanguageModel.get_peft_model(  
    model,  
    <span class="hljs-attr">r</span>=<span class="hljs-number">32</span>,  <span class="hljs-comment"># LoRA矩阵的秩，值越大表达能力越强，但参数量也越多  </span>
    <span class="hljs-attr">target_modules</span>=[<span class="hljs-string">"q_proj"</span>, <span class="hljs-string">"k_proj"</span>, <span class="hljs-string">"v_proj"</span>, <span class="hljs-string">"o_proj"</span>, <span class="hljs-string">"gate_proj"</span>, <span class="hljs-string">"up_proj"</span>, <span class="hljs-string">"down_proj"</span>, ],  
    <span class="hljs-attr">lora_alpha</span>=<span class="hljs-number">64</span>,  <span class="hljs-comment"># LoRA缩放参数  </span>
    <span class="hljs-attr">lora_dropout</span>=<span class="hljs-number">0.1</span>,  <span class="hljs-comment"># LoRA dropout率，防止过拟合，值越小正则化越弱  </span>
    <span class="hljs-attr">bias</span>=<span class="hljs-string">"none"</span>,  <span class="hljs-comment"># 偏置项处理方式，"none"表示不训练偏置，节省参数  </span>
    <span class="hljs-attr">use_gradient_checkpointing</span>=<span class="hljs-string">"unsloth"</span>,  <span class="hljs-comment"># 使用Unsloth优化的梯度检查点，支持超长序列  </span>
    <span class="hljs-attr">random_state</span>=<span class="hljs-number">3407</span>,  <span class="hljs-comment"># 随机种子，确保结果可复现  </span>
    <span class="hljs-attr">use_rslora</span>=<span class="hljs-literal">False</span>,  <span class="hljs-comment"># 是否使用Rank Stabilized LoRA，当前使用标准LoRA  </span>
    <span class="hljs-attr">loftq_config</span>=None,  <span class="hljs-comment"># LoftQ配置，用于更精确的量化  </span>
)
</code></pre>
<h4 data-id="heading-11">7.5 使用 <code>SFTTrainer</code> 进行训练</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 创建SFT（Supervised Fine-Tuning）训练器  </span>
<span class="hljs-comment"># 使用监督学习方式微调模型，适用于问答任务  </span>
<span class="hljs-attr">trainer</span> = SFTTrainer(  
    <span class="hljs-attr">model</span>=model,  
    <span class="hljs-attr">tokenizer</span>=tokenizer,  
    <span class="hljs-attr">train_dataset</span>=train_dataset,  <span class="hljs-comment"># 训练数据集  </span>
    <span class="hljs-attr">eval_dataset</span>=eval_dataset,  <span class="hljs-comment"># 验证数据集，用于评估模型性能  </span>
    <span class="hljs-attr">dataset_text_field</span>=<span class="hljs-string">"text"</span>,  <span class="hljs-comment"># 数据集中文本字段的名称  </span>
    <span class="hljs-attr">max_seq_length</span>=max_seq_length,  <span class="hljs-comment"># 最大序列长度  </span>
    <span class="hljs-attr">dataset_num_proc</span>=<span class="hljs-number">1</span>,  <span class="hljs-comment"># 数据处理进程数，设为1避免缓存冲突  </span>
    <span class="hljs-attr">packing</span>=<span class="hljs-literal">False</span>,  <span class="hljs-comment"># 是否使用序列打包，短序列时可设为True提升5倍训练速度  </span>
    <span class="hljs-attr">callbacks</span>=[  
        EarlyStoppingCallback(early_stopping_patience=<span class="hljs-number">3</span>, early_stopping_threshold=<span class="hljs-number">0.0005</span>),  <span class="hljs-comment"># 早停机制，防止过拟合  </span>
    ],  
    <span class="hljs-attr">args</span>=TrainingArguments(  
        <span class="hljs-comment"># 批次大小配置  </span>
        <span class="hljs-attr">per_device_train_batch_size</span>=<span class="hljs-number">2</span>,  <span class="hljs-comment"># 每个GPU的训练批次大小  </span>
        <span class="hljs-attr">per_device_eval_batch_size</span>=<span class="hljs-number">2</span>,  <span class="hljs-comment"># 每个GPU的验证批次大小  </span>
          
        <span class="hljs-comment"># 梯度累积配置  </span>
        <span class="hljs-attr">gradient_accumulation_steps</span>=<span class="hljs-number">8</span>,  <span class="hljs-comment"># 梯度累积步数，有效批次大小 = batch_size * gradient_accumulation_steps  </span>
          
        <span class="hljs-comment"># 学习率配置  </span>
        <span class="hljs-attr">warmup_ratio</span>=<span class="hljs-number">0.15</span>,  <span class="hljs-comment"># 学习率预热比例，前15%的步数用于预热  </span>
        <span class="hljs-attr">learning_rate</span>=<span class="hljs-number">2</span>e-<span class="hljs-number">5</span>,  <span class="hljs-comment"># 学习率，控制参数更新步长  </span>
          
        <span class="hljs-comment"># 训练轮数和步数配置  </span>
        <span class="hljs-comment"># max_steps = 200, # 最大训练步数（可选）  </span>
        <span class="hljs-attr">num_train_epochs</span>=<span class="hljs-number">5</span>,  <span class="hljs-comment"># 训练轮数，给模型充分学习机会  </span>
          
        <span class="hljs-comment"># 精度配置  </span>
        <span class="hljs-attr">fp16</span>=not is_bfloat16_supported(),  <span class="hljs-comment"># 是否使用16位浮点精度训练  </span>
        <span class="hljs-attr">bf16</span>=is_bfloat16_supported(),  <span class="hljs-comment"># 是否使用bfloat16精度训练（更稳定）  </span>
          
        <span class="hljs-comment"># 日志和监控配置  </span>
        <span class="hljs-attr">logging_steps</span>=<span class="hljs-number">2</span>,  <span class="hljs-comment"># 每2步记录一次日志  </span>
        <span class="hljs-attr">eval_steps</span>=<span class="hljs-number">10</span>,  <span class="hljs-comment"># 每10步进行一次验证评估  </span>
        <span class="hljs-attr">eval_strategy</span>=<span class="hljs-string">"steps"</span>,  <span class="hljs-comment"># 按步数进行验证  </span>
          
        <span class="hljs-comment"># 模型保存配置  </span>
        <span class="hljs-attr">save_steps</span>=<span class="hljs-number">20</span>,  <span class="hljs-comment"># 每20步保存一次模型检查点  </span>
        <span class="hljs-attr">save_strategy</span>=<span class="hljs-string">"steps"</span>,  <span class="hljs-comment"># 按步数保存模型  </span>
        <span class="hljs-attr">save_total_limit</span>=<span class="hljs-number">5</span>,  <span class="hljs-comment"># 最多保存5个检查点，节省存储空间  </span>
          
        <span class="hljs-comment"># 最佳模型配置  </span>
        <span class="hljs-attr">load_best_model_at_end</span>=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 训练结束时自动加载最佳模型  </span>
        <span class="hljs-attr">metric_for_best_model</span>=<span class="hljs-string">"eval_loss"</span>,  <span class="hljs-comment"># 使用验证损失作为最佳模型指标  </span>
        <span class="hljs-attr">greater_is_better</span>=<span class="hljs-literal">False</span>,  <span class="hljs-comment"># 损失越小越好  </span>
          
        <span class="hljs-comment"># 正则化配置  </span>
        <span class="hljs-attr">weight_decay</span>=<span class="hljs-number">0.001</span>,  <span class="hljs-comment"># 权重衰减，防止过拟合  </span>
        <span class="hljs-attr">max_grad_norm</span>=<span class="hljs-number">1.0</span>,  <span class="hljs-comment"># 梯度裁剪阈值，防止梯度爆炸  </span>
          
        <span class="hljs-comment"># 学习率调度配置  </span>
        <span class="hljs-attr">lr_scheduler_type</span>=<span class="hljs-string">"cosine"</span>,  <span class="hljs-comment"># 使用余弦退火学习率调度器  </span>
          
        <span class="hljs-comment"># 优化器配置  </span>
        <span class="hljs-attr">optim</span>=<span class="hljs-string">"adamw_8bit"</span>,  <span class="hljs-comment"># 使用8位AdamW优化器，节省显存  </span>
          
        <span class="hljs-comment"># 数据加载配置  </span>
        <span class="hljs-attr">dataloader_num_workers</span>=<span class="hljs-number">0</span>,  <span class="hljs-comment"># 数据加载器工作进程数，设为0避免多进程冲突  </span>
          
        <span class="hljs-comment"># 输出配置  </span>
        <span class="hljs-attr">output_dir</span>=<span class="hljs-string">"outputs"</span>,  <span class="hljs-comment"># 模型输出和检查点保存目录  </span>
          
        <span class="hljs-comment"># 随机种子  </span>
        <span class="hljs-attr">seed</span>=<span class="hljs-number">3407</span>,  <span class="hljs-comment"># 随机种子，确保结果可复现  </span>
  
    ),  
)  
  
<span class="hljs-comment"># 开始训练  </span>
<span class="hljs-attr">train_stats</span> = trainer.train()  
print(f"训练完成，训练损失: \n {train_stats}")
</code></pre>
<h4 data-id="heading-12">7.6 模型保存</h4>
<p>Unsloth 提供了多种保存微调后模型的方法，每种方法都有其特定的用途：</p>
<p><strong><code>save_pretrained</code></strong></p>
<p>此方法仅保存 LoRA 适配器权重。这些文件通常很小，只包含模型修改部分，包括 <code>adapter_config.json</code> 和 <code>adapter_model.safetensors</code> 。这种方法适用于需要灵活切换不同 LoRA 适配器或节省存储空间的情况。</p>
<p><strong><code>save_pretrained_gguf</code></strong></p>
<p>这是一种新的优化格式（GGUF），支持更好的元数据处理。文件同样较小且经过量化，包括 <code>model.gguf</code> 和 <code>tokenizer.json</code> 。Unsloth 的动态量化在 GGUF 导出中通过智能的层特定量化策略，进一步增强了模型性能和效率。</p>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-comment"># 保存微调后的模型权重</span>
<span class="hljs-comment"># 只保存LoRA权重，原始模型权重保持不变</span>
model.save_pretrained(<span class="hljs-string">"ckpts/qwen2.5-1.5b-instruct-bnb-4bit-lora"</span>)
<span class="hljs-comment"># 保存分词器（tokenizer），以便后续加载和推理时使用</span>
tokenizer.save_pretrained(<span class="hljs-string">"ckpts/qwen2.5-1.5b-instruct-bnb-4bit-lora"</span>)
<span class="hljs-comment">#==================================================================================</span>

<span class="hljs-comment"># model.save_pretrained_gguf("ckpts/qwen2.5-1.5b-instruct-bnb-4bit-gguf", tokenizer, quantization_method="q4_k_m")</span>
</code></pre>
<h4 data-id="heading-13">7.7 训练过程</h4>
<p><strong>开始时显示基础信息：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml">
<span class="hljs-string">==((====))==</span>  <span class="hljs-attr">Unsloth 2025.7.8: Fast Qwen3 patching. Transformers:</span> <span class="hljs-number">4.53</span><span class="hljs-number">.3</span><span class="hljs-string">.</span>
   <span class="hljs-string">\</span>   <span class="hljs-string">/|</span>    <span class="hljs-string">NVIDIA</span> <span class="hljs-string">GeForce</span> <span class="hljs-string">RTX</span> <span class="hljs-number">2050. </span><span class="hljs-string">Num</span> <span class="hljs-string">GPUs</span> <span class="hljs-string">=</span> <span class="hljs-attr">1. Max memory: 4.0 GB. Platform:</span> <span class="hljs-string">Windows.</span>
<span class="hljs-string">O^O/</span> <span class="hljs-string">_/</span> <span class="hljs-string">\</span>    <span class="hljs-attr">Torch:</span> <span class="hljs-number">2.7</span><span class="hljs-number">.1</span><span class="hljs-string">+cu126.</span> <span class="hljs-attr">CUDA: 8.6. CUDA Toolkit: 12.6. Triton:</span> <span class="hljs-number">3.3</span><span class="hljs-number">.1</span>
<span class="hljs-string">\</span>        <span class="hljs-string">/</span>    <span class="hljs-string">Bfloat16</span> <span class="hljs-string">=</span> <span class="hljs-string">TRUE.</span> <span class="hljs-string">FA</span> [<span class="hljs-string">Xformers</span> <span class="hljs-string">=</span> <span class="hljs-number">0.0</span><span class="hljs-number">.31</span><span class="hljs-string">.post1.</span> <span class="hljs-string">FA2</span> <span class="hljs-string">=</span> <span class="hljs-literal">False</span>]
 <span class="hljs-string">"-____-"</span>     <span class="hljs-attr">Free license:</span> <span class="hljs-string">http://github.com/unslothai/unsloth</span>
<span class="hljs-comment"># 批注：系统配置信息</span>
<span class="hljs-comment"># - 使用RTX 2050显卡，4GB显存</span>
<span class="hljs-comment"># - 支持bfloat16精度训练</span>
<span class="hljs-comment"># - 使用Xformers优化注意力机制</span>

</code></pre>
<p><strong>再给出微调的配置：</strong></p>
<pre><code class="hljs language-ini" lang="ini">==((====))==  Unsloth - 2x faster free finetuning | Num GPUs <span class="hljs-attr">used</span> = <span class="hljs-number">1</span>  
   \\   /|    Num <span class="hljs-attr">examples</span> = <span class="hljs-number">353</span> | Num Epochs = <span class="hljs-number">5</span> | Total steps = <span class="hljs-number">115</span>  
O^O/ \_/ \    Batch size per <span class="hljs-attr">device</span> = <span class="hljs-number">2</span> | Gradient accumulation steps = <span class="hljs-number">8</span>  
\        /    Data Parallel <span class="hljs-attr">GPUs</span> = <span class="hljs-number">1</span> | Total batch size (<span class="hljs-number">2</span> x <span class="hljs-number">8</span> x <span class="hljs-number">1</span>) = <span class="hljs-number">16</span>  
 "-____-"     Trainable <span class="hljs-attr">parameters</span> = <span class="hljs-number">20</span>,<span class="hljs-number">185</span>,<span class="hljs-number">088</span> of <span class="hljs-number">616</span>,<span class="hljs-number">235</span>,<span class="hljs-number">008</span> (<span class="hljs-number">3.28</span>% trained)  
<span class="hljs-comment"># 批注：训练配置详情  </span>
<span class="hljs-comment"># - 总样本数：353个  </span>
<span class="hljs-comment"># - 训练轮数：5轮  </span>
<span class="hljs-comment"># - 总步数：115步  </span>
<span class="hljs-comment"># - 有效批次大小：16（2×8×1）  </span>
<span class="hljs-comment"># - 可训练参数：3.28%（20M/616M）</span>
</code></pre>
<p><strong>后面是微调细节：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">{<span class="hljs-string">'loss'</span>: <span class="hljs-number">2.1017</span>, <span class="hljs-string">'grad_norm'</span>: <span class="hljs-number">3.180413007736206</span>, <span class="hljs-string">'learning_rate'</span>: <span class="hljs-number">1.995283421166614e-05</span>, <span class="hljs-string">'epoch'</span>: <span class="hljs-number">1.05</span>}  
{<span class="hljs-string">'loss'</span>: <span class="hljs-number">2.2702</span>, <span class="hljs-string">'grad_norm'</span>: <span class="hljs-number">2.8307971954345703</span>, <span class="hljs-string">'learning_rate'</span>: <span class="hljs-number">1.9869167087338908e-05</span>, <span class="hljs-string">'epoch'</span>: <span class="hljs-number">1.14</span>}  
{<span class="hljs-string">'loss'</span>: <span class="hljs-number">2.0511</span>, <span class="hljs-string">'grad_norm'</span>: <span class="hljs-number">3.1757583618164062</span>, <span class="hljs-string">'learning_rate'</span>: <span class="hljs-number">1.9744105246469264e-05</span>, <span class="hljs-string">'epoch'</span>: <span class="hljs-number">1.23</span>}  
{<span class="hljs-string">'loss'</span>: <span class="hljs-number">2.1853</span>, <span class="hljs-string">'grad_norm'</span>: <span class="hljs-number">2.5234906673431396</span>, <span class="hljs-string">'learning_rate'</span>: <span class="hljs-number">1.957817324187987e-05</span>, <span class="hljs-string">'epoch'</span>: <span class="hljs-number">1.32</span>}  
{<span class="hljs-string">'loss'</span>: <span class="hljs-number">1.8145</span>, <span class="hljs-string">'grad_norm'</span>: <span class="hljs-number">2.9424679279327393</span>, <span class="hljs-string">'learning_rate'</span>: <span class="hljs-number">1.937206705006344e-05</span>, <span class="hljs-string">'epoch'</span>: <span class="hljs-number">1.32</span>}
</code></pre>
<h2 data-id="heading-14">8.  测试微调的模型</h2>
<p>模型测试代码如下：</p>
<pre><code class="hljs language-ini" lang="ini">from unsloth import FastLanguageModel  
from unsloth.chat_templates import get_chat_template  
from transformers import TextStreamer  
import torch  
  
<span class="hljs-attr">max_seq_length</span> = <span class="hljs-number">512</span>  
  
  
model, <span class="hljs-attr">tokenizer</span> = FastLanguageModel.from_pretrained(  
    <span class="hljs-attr">model_name</span>=<span class="hljs-string">"ckpts/qwen2.5-1.5b-instruct-bnb-4bit-lora"</span>,  
    <span class="hljs-attr">max_seq_length</span>=max_seq_length,  
    <span class="hljs-attr">dtype</span>=None,  
    <span class="hljs-attr">load_in_4bit</span>=<span class="hljs-literal">True</span>,  
)  
  
<span class="hljs-comment"># 启用unsloth的2x更快推理优化  </span>
print("启用推理优化...")  
FastLanguageModel.for_inference(model)  
print("模型加载完成")  
  
  
<span class="hljs-comment"># 定义训练数据格式化字符串模板  </span>
<span class="hljs-attr">train_prompt_style</span> = <span class="hljs-string">"""你是一位精通中医理论的专家，特别擅长《伤寒论》的理论和实践应用。  
请根据《伤寒论》的经典理论，准确回答以下问题。  
  
### 问题:  
{}  
"""</span>  
<span class="hljs-attr">question</span> = <span class="hljs-string">'什么是太阳病？'</span>  
  
<span class="hljs-attr">formatted_prompt</span> = train_prompt_style.format(question)  
print(f"格式化后的提示文本:\n-------------------\n{formatted_prompt}\n-------------------")  
print(type(tokenizer))   <span class="hljs-comment"># &lt;class 'transformers.models.qwen2.tokenization_qwen2_fast.Qwen2TokenizerFast'&gt;  </span>
<span class="hljs-attr">inputs</span> = tokenizer([formatted_prompt], return_tensors=<span class="hljs-string">'pt'</span>, max_length=max_seq_length).to(<span class="hljs-string">"cuda"</span>)  
  
print(f"inputs: \n-------------------\n{inputs}\n-------------------")  
  
  
  
<span class="hljs-comment"># 生成回答（流式输出）  </span>
with torch.no_grad():  
    <span class="hljs-attr">outputs</span> = model.generate(  
        <span class="hljs-comment"># 输入序列的token ID  </span>
        inputs<span class="hljs-section">['input_ids']</span>,   
        <span class="hljs-comment"># 注意力掩码，指示哪些位置是有效输入  </span>
        <span class="hljs-attr">attention_mask</span>=inputs[<span class="hljs-string">'attention_mask'</span>],   
        <span class="hljs-comment"># 生成文本的最大长度限制  </span>
        <span class="hljs-attr">max_length</span>=max_seq_length,  
        <span class="hljs-comment"># 启用KV缓存，加速生成过程  </span>
        <span class="hljs-attr">use_cache</span>=<span class="hljs-literal">True</span>,  
        <span class="hljs-comment"># 温度参数，控制生成的随机性  </span>
        <span class="hljs-comment"># 值越低生成越确定，值越高生成越随机  </span>
        <span class="hljs-attr">temperature</span>=<span class="hljs-number">0.8</span>,   
        <span class="hljs-comment"># 核采样参数，只从累积概率达到90%的词中选择  </span>
        <span class="hljs-comment"># 避免选择概率极低的词，提高生成质量  </span>
        <span class="hljs-attr">top_p</span>=<span class="hljs-number">0.9</span>,  
        <span class="hljs-comment"># 启用采样模式，而不是贪婪解码  </span>
        <span class="hljs-comment"># 贪婪解码总是选择概率最高的词，容易产生重复  </span>
        <span class="hljs-attr">do_sample</span>=<span class="hljs-literal">True</span>,  
        <span class="hljs-comment"># 设置填充标记ID，用于处理变长序列  </span>
        <span class="hljs-attr">pad_token_id</span>=tokenizer.eos_token_id,  
        <span class="hljs-comment"># 设置结束标记ID，告诉模型何时停止生成  </span>
        <span class="hljs-attr">eos_token_id</span>=tokenizer.eos_token_id,  
        <span class="hljs-comment"># 重复惩罚参数，防止模型重复生成相同内容  </span>
        <span class="hljs-comment"># 1.1表示重复词的生成概率降低10%  </span>
        <span class="hljs-attr">repetition_penalty</span>=<span class="hljs-number">1.1</span>  
    )  
  
print(type(outputs))  
print(outputs)  
<span class="hljs-attr">answer</span> = tokenizer.decode(outputs[<span class="hljs-number">0</span>], skip_special_tokens=<span class="hljs-literal">True</span>)  
print("\n<span class="hljs-attr">" + "</span>=<span class="hljs-string">" * 80)  
print(answer)  
print("</span>\n<span class="hljs-string">" + "</span>=<span class="hljs-string">" * 80)  
print("</span>测试完成！<span class="hljs-string">")
</span></code></pre>
<h3 data-id="heading-15">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js第三章(App Router)]]></title>    <link>https://juejin.cn/post/7571272874846273588</link>    <guid>https://juejin.cn/post/7571272874846273588</guid>    <pubDate>2025-11-11T08:49:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571272874846273588" data-draft-id="7571077686108094527" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js第三章(App Router)"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-11T08:49:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小满zs"/> <meta itemprop="url" content="https://juejin.cn/user/2463384809252397"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js第三章(App Router)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2463384809252397/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小满zs
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T08:49:31.000Z" title="Tue Nov 11 2025 08:49:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Next.js 路由概览</h2>
<p>Next.js 使用基于文件系统的路由，这意味着文件和文件夹的结构直接决定了应用的路由结构。</p>
<h3 data-id="heading-1">基于文件系统的路由</h3>
<p>我们只需要创建对应的文件和文件夹，Next.js 会自动生成对应的路由。</p>
<p>在 Next.js 中，每个文件夹代表一个路由段，映射到 URL 段：</p>
<h4 data-id="heading-2">page</h4>
<pre><code class="hljs language-bash" lang="bash">app/
├── page.tsx               <span class="hljs-comment"># /</span>
├── about/
│   └── page.tsx           <span class="hljs-comment"># /about</span>
├── blog/test
│        └── page.tsx      <span class="hljs-comment"># /blog/test</span>
└── contact/
    └── page.tsx           <span class="hljs-comment"># /contact</span>
</code></pre>
<h4 data-id="heading-3">layout &amp;&amp; template</h4>
<p><code>layout</code>(布局) 布局是多个页面共享UI，例如导航栏、侧边栏、底部等。</p>
<p><code>template</code>(模板) 基本功能跟布局一样，只是不会保存状态</p>
<p>布局和模板的特点就是：</p>
<ul>
<li>多个布局可以嵌套</li>
<li><code>布局会保存状态 / 模板不会保存状态</code></li>
<li>根布局(必须存在)</li>
<li>如果布局和模板同时存在，则布局会优先于模板 layout-&gt;template-page</li>
</ul>
<p>目录结构如下:</p>
<pre><code class="hljs language-txt" lang="txt">app
└─ blog
   ├─ layout.tsx
   ├─ template.tsx
   ├─ a
   │  └─ page.tsx
   └─ b
      └─ page.tsx
</code></pre>
<p>app/blog/layout.tsx</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-string">'use client'</span> <span class="hljs-comment">//需要交互的地方要改为客户端组件 默认是服务端组件</span>
<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">BlogLayout</span>(<span class="hljs-params">{ children }: { children: React.ReactNode }</span>) {
    <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Blog 布局组件<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>数量： {count}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">hr</span> /&gt;</span>
            {children}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>app/blog/template.tsx</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-string">'use client'</span> <span class="hljs-comment">//需要交互的地方要改为客户端组件 默认是服务端组件</span>
<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">BlogTemplate</span>(<span class="hljs-params">{ children }: { children: React.ReactNode }</span>) {
    <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Blog Template<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>数量： {count}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">hr</span> /&gt;</span>
            {children}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>app/blog/a/page.tsx</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/link"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">APage</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>A Page<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/blog/b"</span>&gt;</span>跳转B<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>app/blog/b/page.tsx</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/link"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">BPage</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>B Page<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/blog/a"</span>&gt;</span>跳转A<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ea6f0aeae9a4ce98978f894abb7dfd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763455771&amp;x-signature=L8HsLelL81pqJERp6YChG9UPq4s%3D" alt="1.gif" loading="lazy"/></p>
<h4 data-id="heading-4">loading(加载)</h4>
<p>Next.js的loading是借助了<code>Suspense</code>实现的，Suspense的具体用法请参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fmessage163.github.io%2Freact-docs%2Freact%2Fcomponents%2Fsuspense.html" target="_blank" title="https://message163.github.io/react-docs/react/components/suspense.html" ref="nofollow noopener noreferrer">Suspense 组件</a></p>
<p>app/blog/loading.tsx</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Loading</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Loading...<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>app/blog/a/page.tsx</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/link"</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">//触发异步会自动跳转到loading组件 异步结束正常返回页面</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">resolve</span>(<span class="hljs-string">"数据"</span>)
    }, <span class="hljs-number">5000</span>)
  })
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">APage</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getData</span>()
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data)
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>A Page<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/blog/b"</span>&gt;</span>跳转B<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abd5f2f39f86406b85ba797fc0b36e56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763455771&amp;x-signature=d6HiHh%2FULAHxDghLgDA9X%2BnJCiI%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">error(错误)</h4>
<p>Next.js的error是借助了<code>Error Boundary</code>实现的。</p>
<p>app/blog/error.tsx</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-string">'use client'</span> <span class="hljs-comment">//错误组件必须是客户端组件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Error</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Error<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>app/blog/a/page.tsx</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/link"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">APage</span>(<span class="hljs-params"/>) {
   <span class="hljs-comment">//遇到异常会自动跳转到error组件</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"错误"</span>)
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>A Page<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/blog/b"</span>&gt;</span>跳转B<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f354c01c68454aa18edb1322ed17a68f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763455771&amp;x-signature=8utuEr2Lkw%2F8OlyQHNJH2iIpwMk%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-6">not-found(404)</h4>
<p>其实Next.js 默认会生成一个404页面，但我们可能自定义404页面，只需要在app目录下创建一个not-found.tsx文件即可</p>
<p>app/not-found.tsx</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">NotFound</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>404 Page<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96aad6f0e4cd408b9e07093cf0cdc169~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763455771&amp;x-signature=zXyN2lrQKsKsduG%2BBvkfJ3yjfE4%3D" alt="image.png" loading="lazy"/></p>
<p><strong>预计学习时间</strong>: 20 分钟<br/>
<strong>难度级别</strong>: 初级 🟢</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[在Jetpack Compose中创建CRT屏幕效果]]></title>    <link>https://juejin.cn/post/7571352754896060442</link>    <guid>https://juejin.cn/post/7571352754896060442</guid>    <pubDate>2025-11-11T14:17:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571352754896060442" data-draft-id="7571304204719947830" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="在Jetpack Compose中创建CRT屏幕效果"/> <meta itemprop="keywords" content="Android,Android Jetpack,Kotlin"/> <meta itemprop="datePublished" content="2025-11-11T14:17:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="稀有猿诉"/> <meta itemprop="url" content="https://juejin.cn/user/2788017216685784"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            在Jetpack Compose中创建CRT屏幕效果
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2788017216685784/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    稀有猿诉
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T14:17:35.000Z" title="Tue Nov 11 2025 14:17:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文译自「Creating a CRT Screen Effect in Jetpack Compose」，原文链接<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.sinasamaki.com%2Fcreating-a-crt-screen-effect-in-jetpack-compose%2F" target="_blank" title="https://www.sinasamaki.com/creating-a-crt-screen-effect-in-jetpack-compose/" ref="nofollow noopener noreferrer">www.sinasamaki.com/creating-a-…</a>，由sinasamaki发布于2025年11月7日。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c03b13347444a40a65e398230a3664a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763475454&amp;x-signature=aM1APr%2Fnd8P0rxCx%2FeYyUPjF4dg%3D" alt="CRT 屏幕效果" loading="lazy"/></p>
<p>CRT 显示器具有独特而怀旧的外观：模糊的边缘、扫描线和轻微的色彩溢出。让我们尝试使用 <code>GraphicsLayer</code> 和一些巧妙的图层技巧在 Jetpack Compose 中重现 这种效果。</p>
<h2 data-id="heading-0">GraphicsLayer</h2>
<p>与上一篇文章一样，此效果的基础是 <code>GraphicsLayer</code>。它允许我们将内容绘制一次到屏幕外缓冲区。然后，我们可以以极低的性能开销多次使用不同的效果重新绘制它。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> graphicsLayer = rememberGraphicsLayer()

Box(Modifier.drawWithContent {
    graphicsLayer.record { 
        <span class="hljs-keyword">this</span><span class="hljs-symbol">@drawWithContent</span>.drawContent() 
    }
}) {
    content()
}
</code></pre>
<p>一旦我们将内容记录到 <code>graphicsLayer</code> 中，就可以使用 <code>drawLayer(graphicsLayer)</code> 根据需要多次绘制它。</p>
<p>我喜欢在黑色背景上绘制色彩鲜艳、饱和度高的内容，并运用这种效果。以下是我们将应用此效果的基础可组合对象。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d39284fd2094df8b21f1a6f4edd2e31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763475454&amp;x-signature=2glx3H%2BydfHnGQf0e7Vc8Yi6dfU%3D" alt="" width="70%" loading="lazy"/></p>
<h2 data-id="heading-1">添加扫描线</h2>
<p>为了模拟 CRT 显示器上的水平扫描线，我们将使用重复渐变。让我们将其放入一个扩展函数中，如下所示：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> DrawScope.<span class="hljs-title">drawScanLines</span><span class="hljs-params">(alpha: <span class="hljs-type">Float</span>, blendMode: <span class="hljs-type">BlendMode</span>)</span></span> {
    <span class="hljs-keyword">val</span> color = Colors.Black.copy(alpha = alpha)
    drawRect(
        brush = Brush.verticalGradient(
            <span class="hljs-number">0f</span> to color,
            <span class="hljs-number">0.4f</span> to color,
            <span class="hljs-number">0.4f</span> to Colors.Transparent,
            <span class="hljs-number">1f</span> to Colors.Transparent,
            tileMode = TileMode.Repeated,
            startY = <span class="hljs-number">0f</span>,
            endY = <span class="hljs-number">10f</span>,
        ),
        blendMode = blendMode
    )
    drawRect(
        brush = Brush.horizontalGradient(
            <span class="hljs-number">0f</span> to color,
            <span class="hljs-number">0.1f</span> to color,
            <span class="hljs-number">0.1f</span> to Colors.Transparent,
            <span class="hljs-number">1f</span> to Colors.Transparent,
            tileMode = TileMode.Repeated,
            startX = <span class="hljs-number">0f</span>,
            endX = <span class="hljs-number">10f</span>,
        ),
        blendMode = blendMode
    )
}
</code></pre>
<p>我们手动定义颜色停止点，以便在颜色之间形成清晰的边缘，然后将 <code>tileMode</code> 设置为 <code>Repeated</code>。这样，再加上较短的起点和终点，就能得到许多重复的平行线。</p>
<p>扩展函数还会接收我们所需的透明度和 <code>BlendMode</code> 参数。</p>
<p>然后，我们可以使用此函数在 <code>graphicsLayer</code> 上绘制扫描线。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">.drawBehind {
    layer {
        drawLayer(graphicsLayer)
        drawScanLines(alpha = <span class="hljs-number">1f</span>, blendMode = BlendMode.DstOut)
    }
}
</code></pre>
<p>将混合模式设置为 <code>DstOut</code> 会从绘制的内容中“减去”我们的渐变，从而产生这种效果。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28d91b6dd34844b1bea2ebe831da791e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763475454&amp;x-signature=x7IQ35n0Md8ld%2FbcOmq6yESR%2F2o%3D" alt="" width="70%" loading="lazy"/></p>
<h2 data-id="heading-2">构建模糊图层</h2>
<p>为了实现 CRT 屏幕常见的发光效果，我们将多次绘制 <code>graphicsLayer</code> 图层，每次绘制时分别设置不同的模糊半径、透明度和缩放比例。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> blurLayers = remember {
    listOf(
        Triple(<span class="hljs-number">1.</span>dp, <span class="hljs-number">0.2f</span>, <span class="hljs-number">1.02f</span> to <span class="hljs-number">1.03f</span>),
        Triple(<span class="hljs-number">0.</span>dp, <span class="hljs-number">.2f</span>, <span class="hljs-number">1f</span> to <span class="hljs-number">1f</span>),
        Triple(<span class="hljs-number">1.</span>dp, <span class="hljs-number">0.9f</span>, <span class="hljs-number">1f</span> to <span class="hljs-number">1f</span>),
        Triple(<span class="hljs-number">10.</span>dp, <span class="hljs-number">1f</span>, <span class="hljs-number">1f</span> to <span class="hljs-number">1f</span>),
        Triple(<span class="hljs-number">40.</span>dp, <span class="hljs-number">1f</span>, <span class="hljs-number">1f</span> to <span class="hljs-number">1f</span>),
    )
}
</code></pre>
<p>我们将使用一个 <code>Triple</code> 列表来存储每个图层的数据。该列表的顺序也定义了它们的绘制顺序。我建议你尝试调整这些值和顺序，以获得所需的效果。但这是我目前使用的方法。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">blurLayers.forEach { (blur, alpha, scale) -&gt;  
    Box(  
        Modifier  
            .matchParentSize()  
            .blur(blur, BlurredEdgeTreatment.Unbounded)  
            .graphicsLayer {  
                scaleX = scale.first  
                scaleY = scale.second  
                <span class="hljs-keyword">this</span>.alpha = alpha  
            }  
            .drawBehind {  
                layer {  
                    drawLayer(graphicsLayer)  
                    drawScanLines(alpha = <span class="hljs-number">1f</span>, blendMode = BlendMode.DstOut)  
                }  
            }    
    )  
}
</code></pre>
<p>然后，我们使用列表中的值绘制每个图层。在 <code>drawBehind</code> 修改器上方，我们将图层大小设置为与父图层匹配，并应用模糊、缩放和透明度。请记住将模糊设置为 <code>Unbounded</code>，使其超出包含它的可组合对象的边界。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb287da9548d4c8599ccafef052673af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763475454&amp;x-signature=YY17IWzj47KP6nLWcJnlTRyaR1U%3D" alt="" width="70%" loading="lazy"/></p>
<h2 data-id="heading-3">屏幕抖动</h2>
<p>最后，我们来添加屏幕抖动效果，以模拟 CRT 显示器特有的抖动。我们可以通过创建一个 <code>Offset</code> 对象，并用 -1 到 1 之间的随机浮点值来更新它。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">var</span> shake <span class="hljs-keyword">by</span> remember { mutableStateOf(Offset.Zero) }

LaunchedEffect(<span class="hljs-built_in">Unit</span>) {
    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
        shake = Offset(
            Random.nextInt(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>) * Random.nextFloat(),
            Random.nextInt(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>) * Random.nextFloat(),
        )
        delay(<span class="hljs-number">32</span>)
    }
}
</code></pre>
<p>这里只需在一个 while 循环中即可完成。可以调整延迟时间来控制闪烁的间隔频率。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">modifier = modifier  
    .graphicsLayer {  
        translationX = shake.x  
        translationY = shake.y  
    }
</code></pre>
<p>然后可以使用修饰符来应用此偏移量。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08daadbb6efd45cc981fb077e23d6b47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763475454&amp;x-signature=bSgkKe2ddTbuZyvzMGmA75jfjxM%3D" alt="crt_opt.gif" loading="lazy"/></p>
## 整合所有功能
<p>让我们将所有这些功能组合成一个可轻松使用的组合。它会接收 <code>content</code> 参数以及 <code>flickerDelay</code> 参数，后者用于控制闪烁频率。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>  
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">CRTBox</span><span class="hljs-params">(  
    modifier: <span class="hljs-type">Modifier</span> = Modifier,  
    flickerDelay: <span class="hljs-type">Int</span> = <span class="hljs-number">32</span>,  
    content: @<span class="hljs-type">Composable</span> () -&gt; <span class="hljs-type">Unit</span>,  
)</span></span> {  
    <span class="hljs-keyword">var</span> shake <span class="hljs-keyword">by</span> remember { mutableStateOf(Offset.Zero) }  
  
    LaunchedEffect(<span class="hljs-built_in">Unit</span>) {  
        <span class="hljs-keyword">while</span> (flickerDelay &gt; <span class="hljs-number">0</span>) {  
            shake = Offset(  
                Random.nextInt(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>) * Random.nextFloat(),  
                Random.nextInt(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>) * Random.nextFloat(),  
            )  
            delay(flickerDelay.toLong())  
        }  
    }  
  
    <span class="hljs-keyword">val</span> graphicsLayer = rememberGraphicsLayer()  
  
    Box(  
        modifier = modifier  
            .graphicsLayer {  
                translationX = shake.x  
                translationY = shake.y  
            }  
    ) {  
        Box(Modifier.drawWithContent {  
            graphicsLayer.record { <span class="hljs-keyword">this</span><span class="hljs-symbol">@drawWithContent</span>.drawContent() }  
        }) {  
            content()  
        }  
  
        <span class="hljs-keyword">val</span> blurLayers = remember {  
            listOf(  
                Triple(<span class="hljs-number">5.</span>dp, <span class="hljs-number">.3f</span>, <span class="hljs-number">1.02f</span> to <span class="hljs-number">1.03f</span>),  
                Triple(<span class="hljs-number">0.</span>dp, <span class="hljs-number">.8f</span>, <span class="hljs-number">1f</span> to <span class="hljs-number">1f</span>),  
                Triple(<span class="hljs-number">1.</span>dp, <span class="hljs-number">.9f</span>, <span class="hljs-number">1f</span> to <span class="hljs-number">1f</span>),  
                Triple(<span class="hljs-number">10.</span>dp, <span class="hljs-number">.6f</span>, <span class="hljs-number">1.001f</span> to <span class="hljs-number">1f</span>),  
                Triple(<span class="hljs-number">40.</span>dp, <span class="hljs-number">.7f</span>, <span class="hljs-number">1f</span> to <span class="hljs-number">1f</span>),  
            )  
        }  
  
        blurLayers.forEach { (blur, alpha, scale) -&gt;  
            Box(  
                Modifier  
                    .matchParentSize()  
                    .blur(blur, BlurredEdgeTreatment.Unbounded)  
                    .graphicsLayer {  
                        scaleX = scale.first  
                        scaleY = scale.second  
                        <span class="hljs-keyword">this</span>.alpha = alpha  
                    }  
                    .drawBehind {  
                        layer {  
                            drawLayer(graphicsLayer)  
                            drawScanLines(alpha = <span class="hljs-number">1f</span>, blendMode = BlendMode.DstOut)  
                        }  
                    }            
            )  
        }  
    }}  
  
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> DrawScope.<span class="hljs-title">layer</span><span class="hljs-params">(  
    bounds: <span class="hljs-type">Rect</span> = size.toRect()</span></span>,  
    block: DrawScope.() -&gt; <span class="hljs-built_in">Unit</span>  
) =  
    drawIntoCanvas { canvas -&gt;  
        canvas.withSaveLayer(  
            bounds = bounds,  
            paint = Paint(),  
        ) { block() }  
    }  
  
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> DrawScope.<span class="hljs-title">drawScanLines</span><span class="hljs-params">(alpha: <span class="hljs-type">Float</span>, blendMode: <span class="hljs-type">BlendMode</span>)</span></span> {  
    <span class="hljs-keyword">val</span> color = Colors.Black.copy(alpha = alpha)  
    drawRect(  
        brush = Brush.verticalGradient(  
            <span class="hljs-number">0f</span> to color,  
            <span class="hljs-number">0.4f</span> to color,  
            <span class="hljs-number">0.4f</span> to Colors.Transparent,  
            <span class="hljs-number">1f</span> to Colors.Transparent,  
            tileMode = TileMode.Repeated,  
            startY = <span class="hljs-number">0f</span>,  
            endY = <span class="hljs-number">10f</span>,  
        ),  
        blendMode = blendMode  
    )  
    drawRect(  
        brush = Brush.horizontalGradient(  
            <span class="hljs-number">0f</span> to color,  
            <span class="hljs-number">0.1f</span> to color,  
            <span class="hljs-number">0.1f</span> to Colors.Transparent,  
            <span class="hljs-number">1f</span> to Colors.Transparent,  
            tileMode = TileMode.Repeated,  
            startX = <span class="hljs-number">0f</span>,  
            endX = <span class="hljs-number">10f</span>,  
        ),  
        blendMode = blendMode  
    )  
}
</code></pre>
<p>然后，你可以像使用其他可组合组件一样使用它：</p>
<pre><code class="hljs language-kotlin" lang="kotlin">CRTBox {
    Text(<span class="hljs-string">"GAME OVER"</span>)
}
</code></pre>
<h2 data-id="heading-4">Sweeper 更新</h2>
<p>如果你想查看实际效果，请查看最新的 Sweeper 更新，该更新使用 CRT 效果创建了一个令人毛骨悚然的万圣节主题。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70c135b0abf04a7a88d83881ba6bad6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iA5pyJ54y_6K-J:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763475454&amp;x-signature=fJO3ZjvcXhYG0mt6uzjwA%2Be7QTE%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fplay.google.com%2Fstore%2Fapps%2Fdetails%3Fid%3Dcom.sinasamaki.chroma.sweeper%26ref%3Dsinasamaki.com" target="_blank" title="https://play.google.com/store/apps/details?id=com.sinasamaki.chroma.sweeper&amp;ref=sinasamaki.com" ref="nofollow noopener noreferrer">play.google.com/store/apps/…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fapps.apple.com%2Fus%2Fapp%2Fsweeper-by-sinasamaki%2Fid6752220495%3Fref%3Dsinasamaki.com" target="_blank" title="https://apps.apple.com/us/app/sweeper-by-sinasamaki/id6752220495?ref=sinasamaki.com" ref="nofollow noopener noreferrer">apps.apple.com/us/app/swee…</a></p>
<p>感谢阅读，祝你好运！</p>
<blockquote>
<p>欢迎搜索并关注 <em>公众号<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fmp%2Fqrcode%3Fscene%3D10000004%26size%3D512%26__biz%3DMzU1MDg0NDczNA%3D%3D%26mid%3D2247484417%26idx%3D1%26sn%3D60c15f0d3c4be75e37748c2472a74102" target="_blank" title="https://mp.weixin.qq.com/mp/qrcode?scene=10000004&amp;size=512&amp;__biz=MzU1MDg0NDczNA==&amp;mid=2247484417&amp;idx=1&amp;sn=60c15f0d3c4be75e37748c2472a74102" ref="nofollow noopener noreferrer">「稀有猿诉」</a></em> 获取更多的优质文章！</p>
<p>保护原创，请勿转载！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TRAE SOLO 正式版上线，限时免费活动开启]]></title>    <link>https://juejin.cn/post/7571379089992187958</link>    <guid>https://juejin.cn/post/7571379089992187958</guid>    <pubDate>2025-11-12T05:06:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571379089992187958" data-draft-id="7571379089992171574" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TRAE SOLO 正式版上线，限时免费活动开启"/> <meta itemprop="keywords" content="Trae,Solo,人工智能"/> <meta itemprop="datePublished" content="2025-11-12T05:06:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="飞哥数智谈"/> <meta itemprop="url" content="https://juejin.cn/user/3825956195409223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TRAE SOLO 正式版上线，限时免费活动开启
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956195409223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    飞哥数智谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T05:06:44.000Z" title="Wed Nov 12 2025 05:06:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>今晚 <code>TRAE SOLO</code> 计划发布正式版，但让我没想到的是，中午竟然提前上线，并开始<strong>限时免费活动</strong>。</p>
<p>活动时间：11 月 12 日 12:00 - 11 月 15 日 23:59。</p>
<p>在活动期间，所有用户都可以免费体验 <code>SOLO Coder</code>、<code>SOLO Builder</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/216c9f49410c4202af40579fce25e003~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763528804&amp;x-signature=h5xI3XduKjADH6jAcdnB8%2FqFgAc%3D" alt="" loading="lazy"/></p>
<p>记得更新到 <code>TRAE（国际版）3.0</code>，然后就可以尽情体验了~</p>
<h2 data-id="heading-0">升级内容</h2>
<h3 data-id="heading-1">内置智能体 SOLO Coder</h3>
<p>之前大家都说 <code>SOLO Builder</code> 智能体更擅长前端，这不就来了个擅长复杂编程的智能体。</p>
<ul>
<li>专为复杂编程项目设置，补全之前的偏科表现</li>
<li>支持“<strong>规划</strong>”模式，“规划”模式在其他竞品中尝试过多次，效果确实好</li>
<li>可作为总管，<strong>智能调用“自定义智能体”</strong>，类似 Claude Code 的 <code>subagent</code> 模式，方便配置自己喜欢的开发流程</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/975c117ea641422b9c53ab19d872fb7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763528804&amp;x-signature=aOJzIIPfJUd%2Bgp1GjAdTCEA0nvM%3D" alt="" loading="lazy"/></p>
<p>注意：<code>SOLO Coder</code> 默认开启 <code>Max</code> 模式，后续注意 <code>Token</code> 消耗。</p>
<h3 data-id="heading-2">内置智能体 SOLO Builder</h3>
<p>一站式将想法转换为产品，包括 PRD、任务、代码、预览、部署流程，也是 SOLO 最初的设计理念。</p>
<p>已经分享过多次了，这里就不多说了。</p>
<h3 data-id="heading-3">支持多任务并行</h3>
<p>最左侧增加了任务列表（非<code>todo-list</code>），可
<strong>多功能模块同时开发</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4920a42d519d4b35b57b0e1a64df1baf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763528804&amp;x-signature=Hdg%2FYqvyyzC3kessyhs%2BjK%2BTxHo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">对话任务自动折叠并汇总</h3>
<p>AI 返回的对话内容随着模型能力的提升，现在越来越多，很多时候滚动起来看着都头大。</p>
<p>这次升级，直接提供了<strong>自动折叠</strong>和<strong>摘要显示</strong>，让你更清晰地掌握任务整体情况。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e470fa8e43c4c97b5b5a9b40efe04a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763528804&amp;x-signature=ywpw7bx%2F%2FTcf7I7wewJc%2Bo1uczU%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">代码差异视图工具</h3>
<p>也是参考主流方式，把代码变更<strong>集中显示</strong>，更加方便大家审阅代码。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a8f5881d1324b07ba7fb57e777a3db0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763528804&amp;x-signature=7i48i7qkh5IElfXEXR0SgvGLXhQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">自定义显示集成工具</h3>
<p>主界面的集成工具可根据个人喜好，自行配置。</p>
<p>毕竟，这块会不断增加、完善工具，如果不能自定义，后续选择都会困难。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c47000525e90408682a781bafd9838ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763528804&amp;x-signature=JRprBD96rwX9DtSw%2B9L%2F5k%2Fqgng%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">其他</h3>
<p>TRAE 内的更新文档是有“支持用户管理上下文，包括上下文使用展示及上下文压缩。”，但是只看到上下文显示，还没发现如何管理。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76990f4fd1b249098c7edba403683786~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOe5ZOl5pWw5pm66LCI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763528804&amp;x-signature=fzFyhwHxbL6cfbOyUJRpixvgOaQ%3D" alt="" loading="lazy"/></p>
<p>优化设置功能，支持全局搜索，快速定位所需配置项，这个在配置项越来越多的情况下还是挺好用的。</p>
<h2 data-id="heading-8">结语</h2>
<p>个人感觉更新的特性还是比较实用的，后续再仔细试试 <code>SOLO Coder</code> 提升有多少吧。</p>
<p>最主要的是最近几天免费，大家抓紧去试试吧~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当我们执行 npm run xxx 的时候实际执行逻辑和流程]]></title>    <link>https://juejin.cn/post/7571621555512918070</link>    <guid>https://juejin.cn/post/7571621555512918070</guid>    <pubDate>2025-11-12T07:46:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571621555512918070" data-draft-id="7571429745231233060" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="当我们执行 npm run xxx 的时候实际执行逻辑和流程"/> <meta itemprop="keywords" content="前端,JavaScript,前端框架"/> <meta itemprop="datePublished" content="2025-11-12T07:46:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Man"/> <meta itemprop="url" content="https://juejin.cn/user/2524134428378206"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            当我们执行 npm run xxx 的时候实际执行逻辑和流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134428378206/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Man
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-12T07:46:13.000Z" title="Wed Nov 12 2025 07:46:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">npm run dev 执行流程详解</h2>
<p><code>npm run dev</code> 最终是通过 Node.js 执行的，<code>vite.config.ts</code> 是一个 Node.js 模块，会被 Node.js 读取和执行。</p>
<h3 data-id="heading-1">📋 完整执行流程</h3>
<h4 data-id="heading-2">1. npm run dev 命令</h4>
<pre><code class="hljs language-bash" lang="bash">npm run dev
</code></pre>
<p><strong>实际执行：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># npm 会查找 package.json 中的 scripts.dev</span>
<span class="hljs-comment"># 然后执行对应的命令</span>
unh dev
</code></pre>
<h4 data-id="heading-3">2. unh 命令（Node.js 可执行文件）</h4>
<pre><code class="hljs language-bash" lang="bash">unh dev
</code></pre>
<p><strong>实际执行：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># unh 是一个 Node.js 命令行工具（CLI）</span>
<span class="hljs-comment"># 位于 node_modules/.bin/unh</span>
<span class="hljs-comment"># 实际是一个 Node.js 脚本，通过 shebang 执行：</span>
<span class="hljs-comment">#!/usr/bin/env node</span>

<span class="hljs-comment"># 或者通过 npx 执行：</span>
npx unh dev
</code></pre>
<p><strong>unh 的工作：</strong></p>
<ol>
<li>读取 <code>unh.config.ts</code> 配置文件（Node.js 模块）</li>
<li>解析平台参数（如 <code>wx</code> → <code>mp-weixin</code>）</li>
<li>执行 hooks（如 <code>dev</code> hook）</li>
<li>调用 Vite CLI</li>
</ol>
<h4 data-id="heading-4">3. Vite CLI（Node.js 可执行文件）</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># unh 内部会调用：</span>
vite dev
<span class="hljs-comment"># 或</span>
npx vite dev
</code></pre>
<p><strong>Vite 的工作：</strong></p>
<ol>
<li>读取 <code>vite.config.ts</code> 配置文件（Node.js 模块）</li>
<li>加载环境变量（<code>.env</code> 文件）</li>
<li>启动开发服务器</li>
</ol>
<h4 data-id="heading-5">4. vite.config.ts 的执行</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// vite.config.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(<span class="hljs-function">(<span class="hljs-params">{ mode }</span>) =&gt;</span> {
  <span class="hljs-comment">// 这段代码是在 Node.js 环境中执行的！</span>
  <span class="hljs-keyword">const</span> actualMode = process.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_MODE</span> || mode
  <span class="hljs-keyword">const</span> env = <span class="hljs-title function_">loadEnv</span>(actualMode, process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">''</span>)
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-comment">// 返回配置对象</span>
  }
})
</code></pre>
<p><strong>执行时机：</strong></p>
<ul>
<li>✅ <strong>Node.js 环境</strong>：在 Node.js 进程中执行</li>
<li>✅ <strong>构建时</strong>：在启动开发服务器之前执行</li>
<li>✅ <strong>每次启动</strong>：每次运行 <code>npm run dev</code> 都会执行</li>
</ul>
<h3 data-id="heading-6">🔍 详细执行链</h3>
<pre><code class="hljs language-arduino" lang="arduino">npm run dev
  ↓
npm 读取 package.json
  ↓
执行: unh dev
  ↓
Node.js 执行 node_modules/.bin/unh
  ↓
unh 读取 unh.config.<span class="hljs-built_in">ts</span> (Node.js 模块)
  ↓
unh 执行 dev hook
  ↓
unh 调用 Vite CLI
  ↓
Node.js 执行 node_modules/.bin/vite
  ↓
Vite 读取 vite.config.<span class="hljs-built_in">ts</span> (Node.js 模块)
  ↓
vite.config.ts 中的代码在 Node.js 中执行
  ↓
<span class="hljs-built_in">loadEnv</span>() 读取 .env 文件（Node.js fs 模块）
  ↓
返回配置对象
  ↓
Vite 启动开发服务器
</code></pre>
<h3 data-id="heading-7">💡 关键点</h3>
<h4 data-id="heading-8">1. 都是 Node.js 执行</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 所有这些命令最终都是通过 Node.js 执行的：</span>
npm run dev          <span class="hljs-comment"># Node.js 执行 npm</span>
unh dev              <span class="hljs-comment"># Node.js 执行 unh</span>
vite dev             <span class="hljs-comment"># Node.js 执行 vite</span>
</code></pre>
<h4 data-id="heading-9">2. 配置文件是 Node.js 模块</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// vite.config.ts</span>
<span class="hljs-comment">// 这是一个 Node.js 模块（CommonJS 或 ES Module）</span>
<span class="hljs-comment">// 会被 Node.js 的 require() 或 import() 加载</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(<span class="hljs-function">(<span class="hljs-params">{ mode }</span>) =&gt;</span> {
  <span class="hljs-comment">// 这里的代码在 Node.js 环境中运行</span>
  <span class="hljs-comment">// 可以使用 Node.js 的所有 API：</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(process.<span class="hljs-property">env</span>)        <span class="hljs-comment">// ✅ Node.js 全局对象</span>
  <span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)        <span class="hljs-comment">// ✅ Node.js 模块</span>
  <span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)    <span class="hljs-comment">// ✅ Node.js 模块</span>
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-comment">// 返回配置对象</span>
  }
})
</code></pre>
<h4 data-id="heading-10">3. 自动读取配置文件</h4>
<p><strong>Vite 会自动查找配置文件：</strong></p>
<ul>
<li><code>vite.config.ts</code>（TypeScript）</li>
<li><code>vite.config.js</code>（JavaScript）</li>
<li><code>vite.config.mjs</code>（ES Module）</li>
<li><code>vite.config.cjs</code>（CommonJS）</li>
</ul>
<p><strong>查找顺序：</strong></p>
<ol>
<li>项目根目录</li>
<li>使用 <code>fs</code> 模块读取文件</li>
<li>使用 Node.js 的模块系统加载</li>
</ol>
<h4 data-id="heading-11">4. 环境变量加载</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// vite.config.ts</span>
<span class="hljs-keyword">const</span> env = <span class="hljs-title function_">loadEnv</span>(actualMode, process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">''</span>)
</code></pre>
<p><strong>loadEnv 的工作原理：</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Vite 内部的 loadEnv 函数（简化版）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">loadEnv</span>(<span class="hljs-params">mode, root, prefix</span>) {
  <span class="hljs-comment">// 使用 Node.js 的 fs 模块读取文件</span>
  <span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)
  <span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
  
  <span class="hljs-comment">// 读取 .env.development 文件</span>
  <span class="hljs-keyword">const</span> envFile = path.<span class="hljs-title function_">join</span>(root, <span class="hljs-string">`.env.<span class="hljs-subst">${mode}</span>`</span>)
  <span class="hljs-keyword">const</span> content = fs.<span class="hljs-title function_">readFileSync</span>(envFile, <span class="hljs-string">'utf-8'</span>)
  
  <span class="hljs-comment">// 解析环境变量</span>
  <span class="hljs-keyword">const</span> env = {}
  content.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">line</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> [key, value] = line.<span class="hljs-title function_">split</span>(<span class="hljs-string">'='</span>)
    <span class="hljs-keyword">if</span> (key.<span class="hljs-title function_">startsWith</span>(prefix)) {
      env[key] = value
    }
  })
  
  <span class="hljs-keyword">return</span> env
}
</code></pre>
<h3 data-id="heading-12">🎓 实际例子</h3>
<h4 data-id="heading-13">例子1：npm run dev</h4>
<pre><code class="hljs language-bash" lang="bash">npm run dev
</code></pre>
<p><strong>执行过程：</strong></p>
<ol>
<li>
<p><strong>npm 解析命令</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># npm 内部执行：</span>
node node_modules/.bin/unh dev
</code></pre>
</li>
<li>
<p><strong>unh 启动</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// unh 内部代码（简化）</span>
<span class="hljs-keyword">const</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./unh.config.ts'</span>)
config.<span class="hljs-property">hooks</span>.<span class="hljs-title function_">dev</span>(<span class="hljs-string">'h5'</span>, {})
</code></pre>
</li>
<li>
<p><strong>unh 调用 Vite</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># unh 内部执行：</span>
node node_modules/.bin/vite dev
</code></pre>
</li>
<li>
<p><strong>Vite 读取配置</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vite 内部代码（简化）</span>
<span class="hljs-keyword">const</span> config = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./vite.config.ts'</span>)
<span class="hljs-keyword">const</span> resolvedConfig = config.<span class="hljs-title function_">default</span>({ <span class="hljs-attr">mode</span>: <span class="hljs-string">'development'</span> })
</code></pre>
</li>
<li>
<p><strong>vite.config.ts 执行</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 这段代码在 Node.js 中执行</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(<span class="hljs-function">(<span class="hljs-params">{ mode }</span>) =&gt;</span> {
  <span class="hljs-comment">// mode = 'development'</span>
  <span class="hljs-keyword">const</span> env = <span class="hljs-title function_">loadEnv</span>(<span class="hljs-string">'development'</span>, process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">''</span>)
  <span class="hljs-comment">// env = { VITE_API_BASE_URL: 'https://dev-api.example.com', ... }</span>

  <span class="hljs-keyword">return</span> {
    <span class="hljs-comment">// 返回配置</span>
  }
})
</code></pre>
</li>
</ol>
<h4 data-id="heading-14">例子2：VITE_MODE=test npm run dev</h4>
<pre><code class="hljs language-bash" lang="bash">VITE_MODE=<span class="hljs-built_in">test</span> npm run dev
</code></pre>
<p><strong>执行过程：</strong></p>
<ol>
<li>
<p><strong>设置环境变量</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Shell 设置环境变量</span>
process.env.VITE_MODE = <span class="hljs-string">'test'</span>
</code></pre>
</li>
<li>
<p><strong>npm 执行命令</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># npm 继承环境变量</span>
node node_modules/.bin/unh dev
</code></pre>
</li>
<li>
<p><strong>vite.config.ts 读取环境变量</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(<span class="hljs-function">(<span class="hljs-params">{ mode }</span>) =&gt;</span> {
  <span class="hljs-comment">// process.env.VITE_MODE = 'test'（从环境变量读取）</span>
  <span class="hljs-keyword">const</span> actualMode = process.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_MODE</span> || mode
  <span class="hljs-comment">// actualMode = 'test'</span>

  <span class="hljs-keyword">const</span> env = <span class="hljs-title function_">loadEnv</span>(<span class="hljs-string">'test'</span>, process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">''</span>)
  <span class="hljs-comment">// 读取 .env.test 文件</span>

  <span class="hljs-keyword">return</span> {
    <span class="hljs-comment">// 返回配置</span>
  }
})
</code></pre>
</li>
</ol>
<h3 data-id="heading-15">🔧 技术细节</h3>
<h4 data-id="heading-16">1. Node.js 模块系统</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// vite.config.ts</span>
<span class="hljs-comment">// 这是一个 ES Module（因为 package.json 中有 "type": "module"）</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(...)
</code></pre>
<p><strong>加载过程：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vite 内部（简化）</span>
<span class="hljs-keyword">import</span> config <span class="hljs-keyword">from</span> <span class="hljs-string">'./vite.config.ts'</span>
<span class="hljs-comment">// 或</span>
<span class="hljs-keyword">const</span> config = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./vite.config.ts'</span>)
</code></pre>
<h4 data-id="heading-17">2. 配置文件执行时机</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// vite.config.ts</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这行代码会在 Node.js 中执行'</span>)

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(<span class="hljs-function">(<span class="hljs-params">{ mode }</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'这行代码也会在 Node.js 中执行'</span>)
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'mode:'</span>, mode)
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-comment">// 配置对象</span>
  }
})
</code></pre>
<p><strong>执行时机：</strong></p>
<ul>
<li>✅ <strong>每次启动时</strong>：每次运行 <code>npm run dev</code> 都会执行</li>
<li>✅ <strong>Node.js 环境</strong>：在 Node.js 进程中执行</li>
<li>✅ <strong>构建时</strong>：在启动开发服务器之前执行</li>
</ul>
<h4 data-id="heading-18">3. 环境变量访问</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// vite.config.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(<span class="hljs-function">(<span class="hljs-params">{ mode }</span>) =&gt;</span> {
  <span class="hljs-comment">// ✅ 可以访问 Node.js 环境变量</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_MODE</span>)
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span>)
  
  <span class="hljs-comment">// ✅ 可以使用 Node.js 模块</span>
  <span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)
  <span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
  
  <span class="hljs-comment">// ✅ 可以读取文件</span>
  <span class="hljs-keyword">const</span> packageJson = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(
    fs.<span class="hljs-title function_">readFileSync</span>(path.<span class="hljs-title function_">join</span>(process.<span class="hljs-title function_">cwd</span>(), <span class="hljs-string">'package.json'</span>), <span class="hljs-string">'utf-8'</span>)
  )
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-comment">// 配置</span>
  }
})
</code></pre>
<h3 data-id="heading-19">📊 执行流程图</h3>
<pre><code class="hljs language-arduino" lang="arduino">┌─────────────────────────────────────────┐
│  <span class="hljs-number">1.</span> 用户输入: npm run dev                │
└──────────────────┬──────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────┐
│  <span class="hljs-number">2.</span> npm 读取 package.json               │
│     scripts.dev = <span class="hljs-string">"unh dev"</span>             │
└──────────────────┬──────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────┐
│  <span class="hljs-number">3.</span> npm 执行: node node_modules/.bin/unh│
│     (Node.js 执行 unh 可执行文件)       │
└──────────────────┬──────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────┐
│  <span class="hljs-number">4.</span> unh 读取 unh.config.ts              │
│     (Node.js 模块系统加载)              │
└──────────────────┬──────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────┐
│  <span class="hljs-number">5.</span> unh 执行 dev hook                   │
│     console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'启动开发环境...'</span>)       │
└──────────────────┬──────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────┐
│  <span class="hljs-number">6.</span> unh 调用: node node_modules/.bin/vite│
│     (Node.js 执行 vite 可执行文件)       │
└──────────────────┬──────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────┐
│  <span class="hljs-number">7.</span> Vite 读取 vite.config.ts            │
│     (Node.js 模块系统加载)              │
└──────────────────┬──────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────┐
│  <span class="hljs-number">8.</span> vite.config.ts 中的代码执行         │
│     - <span class="hljs-built_in">loadEnv</span>() 读取 .env 文件          │
│     - 使用 Node.js fs 模块              │
│     - 返回配置对象                      │
└──────────────────┬──────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────┐
│  <span class="hljs-number">9.</span> Vite 启动开发服务器                  │
│     - 使用配置对象                       │
│     - 启动 HTTP 服务器                  │
└─────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-20">✅ 总结</h3>
<ol>
<li>
<p>✅ <strong>npm run dev 最终执行的是 Node.js 命令</strong></p>
<ul>
<li><code>npm</code> → <code>node node_modules/.bin/unh</code></li>
<li><code>unh</code> → <code>node node_modules/.bin/vite</code></li>
</ul>
</li>
<li>
<p>✅ <strong>会自动读取指定文件</strong></p>
<ul>
<li>Vite 自动查找 <code>vite.config.ts</code></li>
<li>使用 Node.js 的 <code>fs</code> 模块读取</li>
<li>使用 Node.js 的模块系统加载</li>
</ul>
</li>
<li>
<p>✅ <strong>vite.config.ts 是 Node.js 模块</strong></p>
<ul>
<li>会被 Node.js 执行</li>
<li>可以使用所有 Node.js API</li>
<li>在 Node.js 环境中运行</li>
</ul>
</li>
<li>
<p>✅ <strong>是一层封装</strong></p>
<ul>
<li><code>npm</code> 封装了命令执行</li>
<li><code>unh</code> 封装了 uni-app 启动流程</li>
<li><code>vite</code> 封装了构建工具</li>
<li><code>vite.config.ts</code> 是配置层</li>
</ul>
</li>
</ol>
<h4 data-id="heading-21">关键点</h4>
<ul>
<li><strong>执行环境</strong>：Node.js</li>
<li><strong>配置文件</strong>：Node.js 模块</li>
<li><strong>文件读取</strong>：Node.js <code>fs</code> 模块</li>
<li><strong>自动查找</strong>：Vite 自动查找配置文件</li>
<li><strong>执行时机</strong>：每次启动时执行</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>