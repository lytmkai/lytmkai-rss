<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[有了AI之后我一天要上三五个服务。自建项目模板 Maven archetype 减轻工作量]]></title>    <link>https://juejin.cn/post/7578836326475087899</link>    <guid>https://juejin.cn/post/7578836326475087899</guid>    <pubDate>2025-12-02T08:54:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578836326475087899" data-draft-id="7578917474659369011" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="有了AI之后我一天要上三五个服务。自建项目模板 Maven archetype 减轻工作量"/> <meta itemprop="keywords" content="maven,Java,Spring"/> <meta itemprop="datePublished" content="2025-12-02T08:54:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="纸仓"/> <meta itemprop="url" content="https://juejin.cn/user/1812410601572599"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            有了AI之后我一天要上三五个服务。自建项目模板 Maven archetype 减轻工作量
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1812410601572599/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    纸仓
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T08:54:05.000Z" title="Tue Dec 02 2025 08:54:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>年关将至，大家都很焦虑。老板焦虑最近用户付费数据怎么越来越不行了。</p>
<p>运营焦虑老板把用户付费数据不行这个帽子扣自己身上。</p>
<p>产品焦虑老板把用户付费数据不行这个帽子扣自己身上。</p>
<p>开发焦虑老板把用户付费数据不行这个帽子扣自己身上。</p>
<p>测试焦虑老板把用户付费数据不行这个帽子扣自己身上。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10a6c0051af44d9ab8c5308cd9368d18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270445&amp;x-signature=ApyS81qGu%2Fub3Iya0cOkqjmXgQM%3D" alt="image.png" loading="lazy"/></p>
<p>总之，大家都焦虑。作为一个在职海沉浮许久的开发，为了不让老板看向我。我给的答案是：多上十几二十个服务。</p>
<p>当老板处于正要开口让我背锅之前，已经在脑子里面酝酿好“你自己提离职，公司不追究你的责任”之前。我们率先出击，和他说我今年多上线了三五十服务。</p>
<p>一方面告诉他，我干的可不少。另一方面也是一种威慑：如果离了我，这三五十个烫手山芋谁来接？</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/378239fd1246480aa52dc7d6417a6349~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270445&amp;x-signature=b4OC45VvuWNqejYfxmbt4bmVO%2Bw%3D" alt="image.png" loading="lazy"/></p>
<p>为了多上服务，我就得整一个模版工程。虽然可以手动改，但我改了几个之后发现太特么麻烦了。</p>
<p>程序员怎么能吃得了这种手动干活的苦？毕竟一个 2 分钟可以干完的活，我都想花 5 分钟写个脚本自动化。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d7b2237b2b54362a8ab50f96e9610ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270445&amp;x-signature=PmrD300ko%2BD1bplQsH9eOhIEvhc%3D" alt="image.png" loading="lazy"/></p>
<p>问就是高级，如果我手动干了，那怎么显示出来我是开发，我是一个坎普特训练师？</p>
<p>本来以前还可以用一个程序装一下，但是被你们这群爱装逼的人用多了。现在广大老板都知道了，也包括我的老板。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b36734d30f804b588e40170914b8ba21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270445&amp;x-signature=7Zsscrpblr2ATM%2BSto6qX4kAnjU%3D" alt="image.png" loading="lazy"/></p>
<p>于是为了继续装逼，不是。是为了自动化这部分工作，我打算又写一个项目仓库用来存放模板代码。（嘿嘿，属于我的仓库+1）</p>
<p>那接下来就盘一下怎么做一个 maven archetype。</p>
<p>首先你要有一个Java开发环境，然后你要有一个模板工程，如果想大家一起用还需要有一个 maven 仓库。</p>
<p>步骤大概是这样的：
第一步：打开电脑
第二步：选择一部
第三步：把手放在➡️键上
第四步：另一只手...咳咳</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28b4023ec52f45a3a58d5a53f5434af6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270445&amp;x-signature=Ir3SOTyNLqQJdPgDf6SUK9DYZ2E%3D" alt="image.png" loading="lazy"/></p>
<p>好像不太对，贤者时间应该是这样：
第一步：准备一个正常的工程模板
第二步：引入 maven 插件生成模板
第三步：把生成的项目复制出来改一下
第四步：打包
第五步：上传到远程库（如果自娱自乐这一步就不用了）</p>
<h3 data-id="heading-0">第一步：准备正常的工程模板</h3>
<p>自己准备去</p>
<h3 data-id="heading-1">第二步：引入 maven 插件生成模板</h3>
<p>先引入扩展，可以通过项目生成样板项目</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">extension</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.maven.archetype<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>archetype-packaging<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">extension</span>&gt;</span>
</code></pre>
<p>执行命令后，就会在 target 目录中生成一个样板项目</p>
<pre><code class="hljs language-shell" lang="shell">mvn archetype:create-from-project
</code></pre>
<p>把 target/generated-sources/ 目录下的样板项目复制出来，单独作为一个项目来修改维护。</p>
<h3 data-id="heading-2">第三部：<del>三上</del> 样板项目信息自定义</h3>
<p>现在虽然已经生成了一个项目，如果想用是可以直接用的。如果有一些特殊的需求，则需要自己修改 <code>archetype-metadata.xml</code> 文件。</p>
<p><code>archetype-metadata.xml</code> 文件中最重要的是 <code>&lt;fileSets&gt;</code> 这个标签的内容。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dde6ea8a628f41558455506b77bdad11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270445&amp;x-signature=eJFBmfx6NA3fB%2F6Z4r2snN4yx6w%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">archetype-descriptor</span> <span class="hljs-attr">...</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">fileSets</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">fileSet</span> <span class="hljs-attr">filtered</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">encoding</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>.circleci<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>config.yml<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">fileSet</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">fileSet</span> <span class="hljs-attr">encoding</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>.gitignore<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>README.md<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">fileSet</span>&gt;</span>
    ...
  <span class="hljs-tag">&lt;/<span class="hljs-name">fileSets</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">modules</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">module</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span> <span class="hljs-attr">dir</span>=<span class="hljs-string">"app"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"app"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">fileSets</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">fileSet</span> <span class="hljs-attr">filtered</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">packaged</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">encoding</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/java<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/*.java<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/pom.xml<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">fileSet</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">fileSet</span> <span class="hljs-attr">encoding</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/resources<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/*.yml<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">fileSet</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">fileSet</span> <span class="hljs-attr">filtered</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">packaged</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">encoding</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/test/java<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/*.java<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">fileSet</span>&gt;</span>
        ...
      <span class="hljs-tag">&lt;/<span class="hljs-name">fileSets</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">module</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"controller"</span> <span class="hljs-attr">dir</span>=<span class="hljs-string">"controller"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"controller"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">fileSets</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">fileSet</span> <span class="hljs-attr">filtered</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">packaged</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">encoding</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/java<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/*.java<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/pom.xml<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">fileSet</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">fileSets</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span>
    ...
  <span class="hljs-tag">&lt;/<span class="hljs-name">modules</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">archetype-descriptor</span>&gt;</span>
</code></pre>
<p>这个文件中定义了要管理哪些文件夹和文件，就是要从 <code>archetype-resources</code> 中复制哪些文件夹和文件。</p>
<p>如果需要使用参数替换，就要添加 <code>filtered="true"</code> 就可以直接在文件中写变量，使用模板生成的时候就会自动替换。</p>
<p>变量通常有 <code>${groupId}</code>、<code>${artifactId}</code>和 <code>${version}</code></p>
<p><code>.idea</code>、<code>.claude</code> 这种目录不想在生成项目的时候也生成，直接删掉样板代码中的目录，或者是修改 <code>archetype-metadata.xml</code></p>
<h3 data-id="heading-3">第四步：打包</h3>
<pre><code class="hljs language-shell" lang="shell">mvn clean install
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e73f358dac745efb06c589e6f7d5abf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270445&amp;x-signature=YhB9prdEcdGEmOSgOJWb2Vx8Bu4%3D" alt="image.png" loading="lazy"/></p>
<p>打包完之后，本地 Maven 仓库就会多出一个项目包。这个项目包里面就有些乱七八糟的文件，jar文件、pom文件等等等等。</p>
<pre><code class="hljs language-powershell" lang="powershell">PS ...\repository\com\xxx\archetype\xxx-archetype&gt; tree /F /A
.
|-- maven-metadata-local.xml
|-- maven-metadata-yuan-nexus-releases.xml
|-- resolver-status.properties
\---1.2
    |-- felo-archetype-1.2.jar
    |-- felo-archetype-1.2.pom
    |-- _remote.repositories
</code></pre>
<p>既然本地有了包，那就可以直接使用了。</p>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">这里只是进入工作目录，不需要进入项目目录</span>
cd workspace
<span class="hljs-meta prompt_">
# </span><span class="bash">通过模板项目生成项目，会自动生成项目根目录</span>
mvn archetype:generate
</code></pre>
<p>生成项目的过程会自动进入交互模式：</p>
<ul>
<li>先根据提示输入项目模板对应的编号</li>
<li>在按照提示输入项目信息：
<ul>
<li>groupId：组ID</li>
<li>artifactId：项目名</li>
<li>version：版本号</li>
<li>package：项目包名</li>
</ul>
</li>
</ul>
<h3 data-id="heading-4">第五步：上传到远程库</h3>
<p>如果自娱自乐这一步就不用了，到上一步已经可以正常使用。</p>
<p>如果你像我一样精益求精、坚持不懈、勇往无前还貌若潘安。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10489c030560412fb5996abfd28ce55d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270445&amp;x-signature=APu7iLIvQNYh5pXlRBzKCf2aPL0%3D" alt="image.png" loading="lazy"/></p>
<p>那么可以把这个项目打包完上传到远程仓库，以供需要的人使用。</p>
<p>第一步：先在项目的 <code>pom.xml</code> 中配置上仓库的地址</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">distributionManagement</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">repository</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>nexus-releases<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Team Nexus Repository<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://nexus.xxx.com/repository/maven-releases/<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">layout</span>&gt;</span>default<span class="hljs-tag">&lt;/<span class="hljs-name">layout</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">releases</span>&gt;</span>
			<span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
		<span class="hljs-tag">&lt;/<span class="hljs-name">releases</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">snapshots</span>&gt;</span>
			<span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
		<span class="hljs-tag">&lt;/<span class="hljs-name">snapshots</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">repository</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">snapshotRepository</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>nexus-snapshots<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>Team Nexus Repository Snapshots<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">url</span>&gt;</span>https://nexus.xxx.com/repository/maven-snapshots/<span class="hljs-tag">&lt;/<span class="hljs-name">url</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">layout</span>&gt;</span>default<span class="hljs-tag">&lt;/<span class="hljs-name">layout</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">releases</span>&gt;</span>
			<span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
		<span class="hljs-tag">&lt;/<span class="hljs-name">releases</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">snapshots</span>&gt;</span>
			<span class="hljs-tag">&lt;<span class="hljs-name">enabled</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">enabled</span>&gt;</span>
			<span class="hljs-tag">&lt;<span class="hljs-name">updatePolicy</span>&gt;</span>always<span class="hljs-tag">&lt;/<span class="hljs-name">updatePolicy</span>&gt;</span>
		<span class="hljs-tag">&lt;/<span class="hljs-name">snapshots</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">snapshotRepository</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">distributionManagement</span>&gt;</span>
</code></pre>
<p>第二步：在 <code>maven settings.xml</code> 中配置上认证用的用户名密码</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">servers</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">server</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>nexus-releases<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">username</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>xxxxxxxx<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">server</span>&gt;</span>
	<span class="hljs-tag">&lt;<span class="hljs-name">server</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>nexus-snapshots<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">username</span>&gt;</span>xxx<span class="hljs-tag">&lt;/<span class="hljs-name">username</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">password</span>&gt;</span>xxxxxxxxx<span class="hljs-tag">&lt;/<span class="hljs-name">password</span>&gt;</span>
	<span class="hljs-tag">&lt;/<span class="hljs-name">server</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">servers</span>&gt;</span>
</code></pre>
<p>第三步：执行 deploy 命令上传jar到远程仓库</p>
<pre><code class="hljs language-shell" lang="shell">mvn clean deploy
</code></pre>
<p>然后获取到 catalog 配置文件地址，一般是这样的URL：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fnexus.xxx.com%2Frepository%2Fmaven-releases%2Farchetype-catalog.xml" target="_blank" title="https://nexus.xxx.com/repository/maven-releases/archetype-catalog.xml" ref="nofollow noopener noreferrer">nexus.xxx.com/repository/…</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/239a293459864c39afad9357b4cc9b7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270445&amp;x-signature=%2BVoe3xIYcf0pPu0W2jgbSrehYZo%3D" alt="image.png" loading="lazy"/></p>
<p>第四步：在 IDEA 中使用</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48f54efca56e46908d328e34cde6688b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270445&amp;x-signature=yhXat1aiUO%2Bo%2F8a8arZbrwAMyas%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/298fd71f2e154a76bbd94ec5afecbc95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270445&amp;x-signature=na0ZE6ke4MNMx64Rno0nRwfOzmM%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34a07b719a0d4b1fb0c2083546d98503~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270445&amp;x-signature=XhfLZD9fSlZZQAixqZJcoEVCRAQ%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d50cc7fc3b084591943f0cdb56cab2b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57q45LuT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765270445&amp;x-signature=fv3K2KbY3Othy3rJQ5Esa6RE%2BJI%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【文件管理系列】003：重复文件查找工具]]></title>    <link>https://juejin.cn/post/7579298511072296960</link>    <guid>https://juejin.cn/post/7579298511072296960</guid>    <pubDate>2025-12-03T09:45:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579298511072296960" data-draft-id="7579264485259214863" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【文件管理系列】003：重复文件查找工具"/> <meta itemprop="keywords" content="后端,Python"/> <meta itemprop="datePublished" content="2025-12-03T09:45:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="零日失眠者"/> <meta itemprop="url" content="https://juejin.cn/user/3411111810444068"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【文件管理系列】003：重复文件查找工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3411111810444068/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    零日失眠者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T09:45:57.000Z" title="Wed Dec 03 2025 09:45:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">简介</h2>
<p>在长期使用计算机的过程中，我们经常会无意中积累大量重复的文件，这些重复文件不仅占用宝贵的存储空间，还会造成文件管理的混乱。手动查找和删除重复文件是一项繁琐且容易出错的任务。本文将介绍一个实用的Python脚本——重复文件查找工具，它可以通过计算文件的哈希值来准确识别重复文件，并提供多种处理选项。</p>
<h2 data-id="heading-1">功能介绍</h2>
<p>这个重复文件查找工具具有以下核心功能：</p>
<ol>
<li><strong>精准识别</strong>：通过计算文件的MD5哈希值来准确识别重复文件</li>
<li><strong>多目录扫描</strong>：支持同时扫描多个目录中的文件</li>
<li><strong>多种匹配模式</strong>：支持按文件名、文件大小或内容哈希值查找重复文件</li>
<li><strong>详细报告</strong>：生成详细的重复文件报告，包括文件路径、大小等信息</li>
<li><strong>多种处理选项</strong>：提供删除、移动或符号链接等多种处理重复文件的方式</li>
<li><strong>进度显示</strong>：实时显示扫描进度和统计信息</li>
<li><strong>安全保护</strong>：提供预览模式，避免误删重要文件</li>
<li><strong>日志记录</strong>：记录所有操作历史，便于追踪和审计</li>
</ol>
<h2 data-id="heading-2">应用场景</h2>
<p>这个工具适用于以下场景：</p>
<ol>
<li><strong>存储空间清理</strong>：查找并删除重复文件以释放存储空间</li>
<li><strong>文件整理</strong>：在合并多个文件夹时识别重复内容</li>
<li><strong>备份管理</strong>：在备份文件中查找重复项以优化备份策略</li>
<li><strong>照片管理</strong>：查找重复的照片文件，特别是从不同设备导入的照片</li>
<li><strong>文档去重</strong>：在企业环境中查找重复的文档文件</li>
<li><strong>下载文件夹清理</strong>：清理下载文件夹中的重复内容</li>
</ol>
<h2 data-id="heading-3">报错处理</h2>
<p>脚本包含了完善的错误处理机制：</p>
<ol>
<li><strong>路径验证</strong>：检查指定目录是否存在且可访问</li>
<li><strong>权限检测</strong>：检测文件读取权限，防止因权限不足导致的错误</li>
<li><strong>文件锁定处理</strong>：处理被其他程序占用的文件</li>
<li><strong>大文件处理</strong>：优化大文件的哈希计算过程，防止内存溢出</li>
<li><strong>符号链接处理</strong>：正确处理符号链接，避免无限循环</li>
<li><strong>异常捕获</strong>：捕获并处理运行过程中可能出现的各种异常</li>
</ol>
<h2 data-id="heading-4">代码实现</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> hashlib
<span class="hljs-keyword">import</span> argparse
<span class="hljs-keyword">import</span> json
<span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> defaultdict
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">import</span> shutil

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DuplicateFileFinder</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, directories, mode=<span class="hljs-string">'content'</span></span>):
        self.directories = directories <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(directories, <span class="hljs-built_in">list</span>) <span class="hljs-keyword">else</span> [directories]
        self.mode = mode  <span class="hljs-comment"># 'name', 'size', or 'content'</span>
        self.duplicates = defaultdict(<span class="hljs-built_in">list</span>)
        self.scan_stats = {
            <span class="hljs-string">'total_files'</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">'total_size'</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">'scanned_dirs'</span>: <span class="hljs-number">0</span>,
            <span class="hljs-string">'errors'</span>: <span class="hljs-number">0</span>
        }
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">calculate_md5</span>(<span class="hljs-params">self, filepath, chunk_size=<span class="hljs-number">8192</span></span>):
        <span class="hljs-string">"""计算文件的MD5哈希值"""</span>
        md5_hash = hashlib.md5()
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(filepath, <span class="hljs-string">"rb"</span>) <span class="hljs-keyword">as</span> f:
                <span class="hljs-comment"># 分块读取文件以节省内存</span>
                <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> <span class="hljs-built_in">iter</span>(<span class="hljs-keyword">lambda</span>: f.read(chunk_size), <span class="hljs-string">b""</span>):
                    md5_hash.update(chunk)
            <span class="hljs-keyword">return</span> md5_hash.hexdigest()
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"计算文件哈希值时出错 <span class="hljs-subst">{filepath}</span>: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
            
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_file_info</span>(<span class="hljs-params">self, filepath</span>):
        <span class="hljs-string">"""获取文件信息"""</span>
        <span class="hljs-keyword">try</span>:
            stat = os.stat(filepath)
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">'path'</span>: filepath,
                <span class="hljs-string">'size'</span>: stat.st_size,
                <span class="hljs-string">'mtime'</span>: stat.st_mtime,
                <span class="hljs-string">'hash'</span>: <span class="hljs-literal">None</span>
            }
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"获取文件信息时出错 <span class="hljs-subst">{filepath}</span>: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
            
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">scan_directory</span>(<span class="hljs-params">self, directory</span>):
        <span class="hljs-string">"""扫描目录中的文件"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(directory):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"警告: 目录不存在 <span class="hljs-subst">{directory}</span>"</span>)
            self.scan_stats[<span class="hljs-string">'errors'</span>] += <span class="hljs-number">1</span>
            <span class="hljs-keyword">return</span>
            
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.isdir(directory):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"警告: 路径不是目录 <span class="hljs-subst">{directory}</span>"</span>)
            self.scan_stats[<span class="hljs-string">'errors'</span>] += <span class="hljs-number">1</span>
            <span class="hljs-keyword">return</span>
            
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"正在扫描目录: <span class="hljs-subst">{directory}</span>"</span>)
        
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">for</span> root, dirs, files <span class="hljs-keyword">in</span> os.walk(directory):
                self.scan_stats[<span class="hljs-string">'scanned_dirs'</span>] += <span class="hljs-number">1</span>
                
                <span class="hljs-comment"># 过滤掉隐藏目录</span>
                dirs[:] = [d <span class="hljs-keyword">for</span> d <span class="hljs-keyword">in</span> dirs <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> d.startswith(<span class="hljs-string">'.'</span>)]
                
                <span class="hljs-keyword">for</span> filename <span class="hljs-keyword">in</span> files:
                    <span class="hljs-comment"># 跳过隐藏文件</span>
                    <span class="hljs-keyword">if</span> filename.startswith(<span class="hljs-string">'.'</span>):
                        <span class="hljs-keyword">continue</span>
                        
                    filepath = os.path.join(root, filename)
                    
                    <span class="hljs-comment"># 获取文件信息</span>
                    file_info = self.get_file_info(filepath)
                    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> file_info:
                        self.scan_stats[<span class="hljs-string">'errors'</span>] += <span class="hljs-number">1</span>
                        <span class="hljs-keyword">continue</span>
                        
                    self.scan_stats[<span class="hljs-string">'total_files'</span>] += <span class="hljs-number">1</span>
                    self.scan_stats[<span class="hljs-string">'total_size'</span>] += file_info[<span class="hljs-string">'size'</span>]
                    
                    <span class="hljs-comment"># 根据模式确定键值</span>
                    <span class="hljs-keyword">if</span> self.mode == <span class="hljs-string">'name'</span>:
                        key = filename.lower()
                    <span class="hljs-keyword">elif</span> self.mode == <span class="hljs-string">'size'</span>:
                        key = file_info[<span class="hljs-string">'size'</span>]
                    <span class="hljs-keyword">else</span>:  <span class="hljs-comment"># content</span>
                        file_hash = self.calculate_md5(filepath)
                        <span class="hljs-keyword">if</span> file_hash <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
                            self.scan_stats[<span class="hljs-string">'errors'</span>] += <span class="hljs-number">1</span>
                            <span class="hljs-keyword">continue</span>
                        file_info[<span class="hljs-string">'hash'</span>] = file_hash
                        key = file_hash
                        
                    self.duplicates[key].append(file_info)
                    
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"扫描目录时出错 <span class="hljs-subst">{directory}</span>: <span class="hljs-subst">{e}</span>"</span>)
            self.scan_stats[<span class="hljs-string">'errors'</span>] += <span class="hljs-number">1</span>
            
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">find_duplicates</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""查找重复文件"""</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"开始查找重复文件..."</span>)
        
        <span class="hljs-keyword">for</span> directory <span class="hljs-keyword">in</span> self.directories:
            self.scan_directory(directory)
            
        <span class="hljs-comment"># 过滤出真正的重复文件（至少2个相同的）</span>
        duplicates = {k: v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> self.duplicates.items() <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(v) &gt; <span class="hljs-number">1</span>}
        self.duplicates = duplicates
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n扫描完成:"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  扫描目录数: <span class="hljs-subst">{self.scan_stats[<span class="hljs-string">'scanned_dirs'</span>]}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  总文件数: <span class="hljs-subst">{self.scan_stats[<span class="hljs-string">'total_files'</span>]}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  总大小: <span class="hljs-subst">{self.scan_stats[<span class="hljs-string">'total_size'</span>] / (<span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>):<span class="hljs-number">.2</span>f}</span> MB"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  发现重复组: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(self.duplicates)}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  错误数: <span class="hljs-subst">{self.scan_stats[<span class="hljs-string">'errors'</span>]}</span>"</span>)
        
        <span class="hljs-keyword">return</span> self.duplicates
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">print_duplicates</span>(<span class="hljs-params">self, max_files_per_group=<span class="hljs-number">10</span></span>):
        <span class="hljs-string">"""打印重复文件信息"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.duplicates:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"未发现重复文件"</span>)
            <span class="hljs-keyword">return</span>
            
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n发现 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(self.duplicates)}</span> 组重复文件:"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">80</span>)
        
        <span class="hljs-keyword">for</span> i, (key, files) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(self.duplicates.items(), <span class="hljs-number">1</span>):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n[<span class="hljs-subst">{i}</span>] <span class="hljs-subst">{<span class="hljs-built_in">len</span>(files)}</span> 个重复文件:"</span>)
            
            <span class="hljs-comment"># 显示文件信息</span>
            total_size = files[<span class="hljs-number">0</span>][<span class="hljs-string">'size'</span>]
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  文件大小: <span class="hljs-subst">{total_size / <span class="hljs-number">1024</span>:<span class="hljs-number">.2</span>f}</span> KB"</span>)
            
            <span class="hljs-keyword">if</span> self.mode == <span class="hljs-string">'content'</span> <span class="hljs-keyword">and</span> files[<span class="hljs-number">0</span>][<span class="hljs-string">'hash'</span>]:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  文件哈希: <span class="hljs-subst">{files[<span class="hljs-number">0</span>][<span class="hljs-string">'hash'</span>][:<span class="hljs-number">16</span>]}</span>..."</span>)
                
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"  文件列表:"</span>)
            <span class="hljs-keyword">for</span> j, file_info <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(files[:max_files_per_group]):
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"    <span class="hljs-subst">{j+<span class="hljs-number">1</span>}</span>. <span class="hljs-subst">{file_info[<span class="hljs-string">'path'</span>]}</span>"</span>)
                
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(files) &gt; max_files_per_group:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"    ... 还有 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(files) - max_files_per_group}</span> 个文件"</span>)
                
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">save_report</span>(<span class="hljs-params">self, report_file=<span class="hljs-string">"duplicate_report.json"</span></span>):
        <span class="hljs-string">"""保存重复文件报告"""</span>
        <span class="hljs-keyword">try</span>:
            report_data = {
                <span class="hljs-string">'scan_time'</span>: datetime.now().isoformat(),
                <span class="hljs-string">'directories'</span>: self.directories,
                <span class="hljs-string">'mode'</span>: self.mode,
                <span class="hljs-string">'stats'</span>: self.scan_stats,
                <span class="hljs-string">'duplicates'</span>: {}
            }
            
            <span class="hljs-comment"># 转换文件信息为可序列化的格式</span>
            <span class="hljs-keyword">for</span> key, files <span class="hljs-keyword">in</span> self.duplicates.items():
                report_data[<span class="hljs-string">'duplicates'</span>][<span class="hljs-built_in">str</span>(key)] = [
                    {
                        <span class="hljs-string">'path'</span>: f[<span class="hljs-string">'path'</span>],
                        <span class="hljs-string">'size'</span>: f[<span class="hljs-string">'size'</span>],
                        <span class="hljs-string">'modified'</span>: datetime.fromtimestamp(f[<span class="hljs-string">'mtime'</span>]).isoformat() <span class="hljs-keyword">if</span> <span class="hljs-string">'mtime'</span> <span class="hljs-keyword">in</span> f <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>,
                        <span class="hljs-string">'hash'</span>: f.get(<span class="hljs-string">'hash'</span>)
                    }
                    <span class="hljs-keyword">for</span> f <span class="hljs-keyword">in</span> files
                ]
                
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(report_file, <span class="hljs-string">'w'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
                json.dump(report_data, f, indent=<span class="hljs-number">2</span>, ensure_ascii=<span class="hljs-literal">False</span>)
                
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"重复文件报告已保存到: <span class="hljs-subst">{report_file}</span>"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"保存报告时出错: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
            
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">remove_duplicates</span>(<span class="hljs-params">self, keep_strategy=<span class="hljs-string">'first'</span>, dry_run=<span class="hljs-literal">True</span></span>):
        <span class="hljs-string">"""删除重复文件"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.duplicates:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"没有重复文件需要处理"</span>)
            <span class="hljs-keyword">return</span>
            
        action = <span class="hljs-string">"预览"</span> <span class="hljs-keyword">if</span> dry_run <span class="hljs-keyword">else</span> <span class="hljs-string">"删除"</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n<span class="hljs-subst">{action}</span>重复文件 (保留策略: <span class="hljs-subst">{keep_strategy}</span>):"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
        
        removed_count = <span class="hljs-number">0</span>
        removed_size = <span class="hljs-number">0</span>
        
        <span class="hljs-keyword">for</span> key, files <span class="hljs-keyword">in</span> self.duplicates.items():
            <span class="hljs-comment"># 确定要保留的文件</span>
            <span class="hljs-keyword">if</span> keep_strategy == <span class="hljs-string">'first'</span>:
                keep_index = <span class="hljs-number">0</span>
            <span class="hljs-keyword">elif</span> keep_strategy == <span class="hljs-string">'last'</span>:
                keep_index = -<span class="hljs-number">1</span>
            <span class="hljs-keyword">elif</span> keep_strategy == <span class="hljs-string">'largest'</span>:
                keep_index = <span class="hljs-built_in">max</span>(<span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(files)), key=<span class="hljs-keyword">lambda</span> i: files[i][<span class="hljs-string">'size'</span>])
            <span class="hljs-keyword">elif</span> keep_strategy == <span class="hljs-string">'smallest'</span>:
                keep_index = <span class="hljs-built_in">min</span>(<span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(files)), key=<span class="hljs-keyword">lambda</span> i: files[i][<span class="hljs-string">'size'</span>])
            <span class="hljs-keyword">else</span>:
                keep_index = <span class="hljs-number">0</span>  <span class="hljs-comment"># 默认保留第一个</span>
                
            keep_file = files[keep_index]
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n保留: <span class="hljs-subst">{keep_file[<span class="hljs-string">'path'</span>]}</span>"</span>)
            
            <span class="hljs-comment"># 处理其他重复文件</span>
            <span class="hljs-keyword">for</span> i, file_info <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(files):
                <span class="hljs-keyword">if</span> i == keep_index:
                    <span class="hljs-keyword">continue</span>
                    
                filepath = file_info[<span class="hljs-string">'path'</span>]
                filesize = file_info[<span class="hljs-string">'size'</span>]
                
                <span class="hljs-keyword">if</span> dry_run:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  将删除: <span class="hljs-subst">{filepath}</span> (<span class="hljs-subst">{filesize / <span class="hljs-number">1024</span>:<span class="hljs-number">.2</span>f}</span> KB)"</span>)
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-keyword">try</span>:
                        os.remove(filepath)
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  已删除: <span class="hljs-subst">{filepath}</span>"</span>)
                        removed_count += <span class="hljs-number">1</span>
                        removed_size += filesize
                    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  删除失败 <span class="hljs-subst">{filepath}</span>: <span class="hljs-subst">{e}</span>"</span>)
                        
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> dry_run:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n删除完成: <span class="hljs-subst">{removed_count}</span> 个文件, 释放空间 <span class="hljs-subst">{removed_size / (<span class="hljs-number">1024</span>*<span class="hljs-number">1024</span>):<span class="hljs-number">.2</span>f}</span> MB"</span>)
            
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">move_duplicates</span>(<span class="hljs-params">self, target_dir, keep_strategy=<span class="hljs-string">'first'</span>, dry_run=<span class="hljs-literal">True</span></span>):
        <span class="hljs-string">"""移动重复文件到指定目录"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.duplicates:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"没有重复文件需要处理"</span>)
            <span class="hljs-keyword">return</span>
            
        <span class="hljs-comment"># 创建目标目录</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(target_dir):
            <span class="hljs-keyword">try</span>:
                os.makedirs(target_dir)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"创建目录: <span class="hljs-subst">{target_dir}</span>"</span>)
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"创建目录失败 <span class="hljs-subst">{target_dir}</span>: <span class="hljs-subst">{e}</span>"</span>)
                <span class="hljs-keyword">return</span>
                
        action = <span class="hljs-string">"预览"</span> <span class="hljs-keyword">if</span> dry_run <span class="hljs-keyword">else</span> <span class="hljs-string">"移动"</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n<span class="hljs-subst">{action}</span>重复文件到 <span class="hljs-subst">{target_dir}</span> (保留策略: <span class="hljs-subst">{keep_strategy}</span>):"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">60</span>)
        
        moved_count = <span class="hljs-number">0</span>
        
        <span class="hljs-keyword">for</span> key, files <span class="hljs-keyword">in</span> self.duplicates.items():
            <span class="hljs-comment"># 确定要保留的文件</span>
            <span class="hljs-keyword">if</span> keep_strategy == <span class="hljs-string">'first'</span>:
                keep_index = <span class="hljs-number">0</span>
            <span class="hljs-keyword">elif</span> keep_strategy == <span class="hljs-string">'last'</span>:
                keep_index = -<span class="hljs-number">1</span>
            <span class="hljs-keyword">else</span>:
                keep_index = <span class="hljs-number">0</span>  <span class="hljs-comment"># 默认保留第一个</span>
                
            keep_file = files[keep_index]
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n保留: <span class="hljs-subst">{keep_file[<span class="hljs-string">'path'</span>]}</span>"</span>)
            
            <span class="hljs-comment"># 处理其他重复文件</span>
            <span class="hljs-keyword">for</span> i, file_info <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(files):
                <span class="hljs-keyword">if</span> i == keep_index:
                    <span class="hljs-keyword">continue</span>
                    
                filepath = file_info[<span class="hljs-string">'path'</span>]
                filename = os.path.basename(filepath)
                
                <span class="hljs-comment"># 构造目标路径</span>
                target_path = os.path.join(target_dir, filename)
                <span class="hljs-comment"># 如果目标文件已存在，添加序号</span>
                counter = <span class="hljs-number">1</span>
                base_name, ext = os.path.splitext(filename)
                <span class="hljs-keyword">while</span> os.path.exists(target_path):
                    new_name = <span class="hljs-string">f"<span class="hljs-subst">{base_name}</span>_<span class="hljs-subst">{counter}</span><span class="hljs-subst">{ext}</span>"</span>
                    target_path = os.path.join(target_dir, new_name)
                    counter += <span class="hljs-number">1</span>
                    
                <span class="hljs-keyword">if</span> dry_run:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  将移动: <span class="hljs-subst">{filepath}</span> -&gt; <span class="hljs-subst">{target_path}</span>"</span>)
                <span class="hljs-keyword">else</span>:
                    <span class="hljs-keyword">try</span>:
                        shutil.move(filepath, target_path)
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  已移动: <span class="hljs-subst">{filepath}</span> -&gt; <span class="hljs-subst">{target_path}</span>"</span>)
                        moved_count += <span class="hljs-number">1</span>
                    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  移动失败 <span class="hljs-subst">{filepath}</span>: <span class="hljs-subst">{e}</span>"</span>)
                        
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> dry_run:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n移动完成: <span class="hljs-subst">{moved_count}</span> 个文件"</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    parser = argparse.ArgumentParser(description=<span class="hljs-string">"重复文件查找工具"</span>)
    parser.add_argument(<span class="hljs-string">"directories"</span>, nargs=<span class="hljs-string">'+'</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">"要扫描的目录路径"</span>)
    parser.add_argument(<span class="hljs-string">"-m"</span>, <span class="hljs-string">"--mode"</span>, choices=[<span class="hljs-string">'name'</span>, <span class="hljs-string">'size'</span>, <span class="hljs-string">'content'</span>], 
                       default=<span class="hljs-string">'content'</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">"匹配模式 (默认: content)"</span>)
    parser.add_argument(<span class="hljs-string">"-r"</span>, <span class="hljs-string">"--report"</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">"保存报告到指定文件"</span>)
    parser.add_argument(<span class="hljs-string">"--remove"</span>, action=<span class="hljs-string">"store_true"</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">"删除重复文件"</span>)
    parser.add_argument(<span class="hljs-string">"--move"</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">"移动重复文件到指定目录"</span>)
    parser.add_argument(<span class="hljs-string">"--keep"</span>, choices=[<span class="hljs-string">'first'</span>, <span class="hljs-string">'last'</span>, <span class="hljs-string">'largest'</span>, <span class="hljs-string">'smallest'</span>], 
                       default=<span class="hljs-string">'first'</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">"保留策略 (默认: first)"</span>)
    parser.add_argument(<span class="hljs-string">"--dry-run"</span>, action=<span class="hljs-string">"store_true"</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">"预览模式，不执行实际操作"</span>)
    
    args = parser.parse_args()
    
    <span class="hljs-keyword">try</span>:
        finder = DuplicateFileFinder(args.directories, args.mode)
        duplicates = finder.find_duplicates()
        
        <span class="hljs-keyword">if</span> duplicates:
            finder.print_duplicates()
            
            <span class="hljs-keyword">if</span> args.report:
                finder.save_report(args.report)
                
            <span class="hljs-keyword">if</span> args.remove:
                finder.remove_duplicates(args.keep, dry_run=args.dry_run)
                
            <span class="hljs-keyword">if</span> args.move:
                finder.move_duplicates(args.move, args.keep, dry_run=args.dry_run)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"未发现重复文件"</span>)
            
    <span class="hljs-keyword">except</span> KeyboardInterrupt:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n\n用户中断操作"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"程序执行出错: <span class="hljs-subst">{e}</span>"</span>)
        sys.exit(<span class="hljs-number">1</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<h2 data-id="heading-5">使用方法</h2>
<h3 data-id="heading-6">基本使用</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 基本用法，扫描单个目录</span>
python duplicate_finder.py /path/to/directory

<span class="hljs-comment"># 扫描多个目录</span>
python duplicate_finder.py /path/to/dir1 /path/to/dir2 /path/to/dir3

<span class="hljs-comment"># 按文件名查找重复文件</span>
python duplicate_finder.py /path/to/directory -m name

<span class="hljs-comment"># 按文件大小查找重复文件</span>
python duplicate_finder.py /path/to/directory -m size

<span class="hljs-comment"># 保存报告到文件</span>
python duplicate_finder.py /path/to/directory -r report.json

<span class="hljs-comment"># 预览删除操作（不实际删除）</span>
python duplicate_finder.py /path/to/directory --remove --dry-run

<span class="hljs-comment"># 删除重复文件（保留第一个）</span>
python duplicate_finder.py /path/to/directory --remove

<span class="hljs-comment"># 删除重复文件（保留最大的）</span>
python duplicate_finder.py /path/to/directory --remove --keep largest

<span class="hljs-comment"># 移动重复文件到指定目录</span>
python duplicate_finder.py /path/to/directory --move /path/to/duplicates
</code></pre>
<h3 data-id="heading-7">命令行参数说明</h3>
<ul>
<li><code>directories</code>: 必需参数，指定要扫描的一个或多个目录路径</li>
<li><code>-m, --mode</code>: 匹配模式，可选 <code>name</code>(按文件名)、<code>size</code>(按文件大小)、<code>content</code>(按文件内容，默认)</li>
<li><code>-r, --report</code>: 保存详细报告到指定的JSON文件</li>
<li><code>--remove</code>: 删除重复文件</li>
<li><code>--move</code>: 移动重复文件到指定目录</li>
<li><code>--keep</code>: 保留策略，可选 <code>first</code>(第一个，默认)、<code>last</code>(最后一个)、<code>largest</code>(最大的)、<code>smallest</code>(最小的)</li>
<li><code>--dry-run</code>: 预览模式，只显示将要执行的操作，不实际执行</li>
</ul>
<h3 data-id="heading-8">使用示例</h3>
<p>假设有以下文件结构：</p>
<pre><code class="hljs language-scss" lang="scss">/photos/
  vacation1<span class="hljs-selector-class">.jpg</span> (重复)
  vacation2<span class="hljs-selector-class">.jpg</span>
  family<span class="hljs-selector-class">.jpg</span> (重复)
  work/
    vacation1<span class="hljs-selector-class">.jpg</span> (重复)
    presentation<span class="hljs-selector-class">.ppt</span>
/downloads/
  family<span class="hljs-selector-class">.jpg</span> (重复)
  document<span class="hljs-selector-class">.pdf</span>
</code></pre>
<p>执行命令：</p>
<pre><code class="hljs language-bash" lang="bash">python duplicate_finder.py /photos /downloads -r duplicates.json
</code></pre>
<p>输出结果：</p>
<pre><code class="hljs language-bash" lang="bash">发现 2 组重复文件:

[1] 2 个重复文件:
  文件大小: 2048.00 KB
  文件哈希: abc123def456...
  文件列表:
    1. /photos/vacation1.jpg
    2. /photos/work/vacation1.jpg

[2] 2 个重复文件:
  文件大小: 1024.00 KB
  文件哈希: def456ghi789...
  文件列表:
    1. /photos/family.jpg
    2. /downloads/family.jpg
</code></pre>
<h2 data-id="heading-9">总结</h2>
<p>这个重复文件查找工具通过计算文件的MD5哈希值来准确识别重复文件，提供了多种匹配模式和处理选项。它不仅能帮助用户找出占用存储空间的重复文件，还提供了安全的处理方式，包括预览模式、保留策略选择等。工具生成的详细报告可以帮助用户更好地了解重复文件的情况。无论是个人用户清理存储空间，还是企业用户管理大量文件，这个工具都能提供有效的帮助。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[拒绝 rem 计算！Vue3 大屏适配，我是这样做的 (vfit 使用体验)]]></title>    <link>https://juejin.cn/post/7579427549472014382</link>    <guid>https://juejin.cn/post/7579427549472014382</guid>    <pubDate>2025-12-03T10:09:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579427549472014382" data-draft-id="7579440586693951534" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="拒绝 rem 计算！Vue3 大屏适配，我是这样做的 (vfit 使用体验)"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-03T10:09:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王霸天"/> <meta itemprop="url" content="https://juejin.cn/user/1875092531319104"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            拒绝 rem 计算！Vue3 大屏适配，我是这样做的 (vfit 使用体验)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1875092531319104/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王霸天
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T10:09:29.000Z" title="Wed Dec 03 2025 10:09:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近公司又接了个数据可视化大屏的需求，设计稿是标准的 <code>1920 x 1080</code>。
拿到设计稿的那一刻，我的内心是拒绝的... 🤯</p>
<p>大家都知道，做大屏适配最烦的就是<strong>还原设计稿坐标</strong>。
以前我尝试过各种方案：</p>
<ul>
<li><strong>rem / vw</strong>: 每一个 px 都要转换，写 css 的时候旁边还得开个计算器，太累。</li>
<li><strong>百分比</strong>: 更是噩梦，稍微动一下布局就乱了。</li>
<li><strong>手动 scale</strong>: 虽然好用，但要自己写 <code>resize</code> 监听，处理防抖，还要算居中偏移，很容易出 bug（比如留白不对、点击错位）。</li>
</ul>
<p>这次我想偷个懒，在 GitHub 上翻了一圈，发现了一个基于 Vue 3 的超轻量适配库 —— <strong>vfit</strong>。
用完之后我只想说：<strong>真香！原来适配大屏可以像写普通页面一样简单。</strong></p>
<p>这里分享一下我的使用过程，希望能帮到同样在“搬砖”的兄弟们。</p>
<hr/>
<h2 data-id="heading-0">🛠 3分钟上手实录</h2>
<h3 data-id="heading-1">1. 安装</h3>
<p>首先安装库，包很小，没什么乱七八糟的依赖。</p>
<pre><code class="hljs language-bash" lang="bash">npm install vfit
</code></pre>
<h3 data-id="heading-2">2. “傻瓜式”配置</h3>
<p>在 <code>main.ts</code> 里注册一下。
这里最爽的是，<strong>可以直接填设计稿的宽高</strong>。我的设计稿是 1920x1080，我就直接填进去，根本不用换算。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// main.ts</span>
<span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>
<span class="hljs-keyword">import</span> { createFitScale } <span class="hljs-keyword">from</span> <span class="hljs-string">'vfit'</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'vfit/style.css'</span> <span class="hljs-comment">// ⚠️ 划重点：一定要引入这个样式，不然布局组件会失效</span>

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)

app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">createFitScale</span>({
  <span class="hljs-attr">target</span>: <span class="hljs-string">'#app'</span>,        <span class="hljs-comment">// 告诉它要在哪个容器搞事情</span>
  <span class="hljs-attr">designWidth</span>: <span class="hljs-number">1920</span>,     <span class="hljs-comment">// 设计稿宽</span>
  <span class="hljs-attr">designHeight</span>: <span class="hljs-number">1080</span>,    <span class="hljs-comment">// 设计稿高</span>
  <span class="hljs-attr">scaleMode</span>: <span class="hljs-string">'auto'</span>      <span class="hljs-comment">// 默认 auto 就能应付绝大多数情况</span>
}))

app.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<p>这就完事了？对，这就完事了。
这时候你的页面已经具备了<strong>自动缩放</strong>的能力，无论怎么拖拽浏览器窗口，内容都会保持比例并自动居中。</p>
<hr/>
<h2 data-id="heading-3">✨ 我最爱的功能：FitContainer</h2>
<p>配置好 scale 只是第一步，真正的痛点是<strong>组件定位</strong>。
以前用 scale 方案，子元素定位还是得小心翼翼。</p>
<p>vfit 提供了一个叫 <code>&lt;FitContainer&gt;</code> 的组件，这个简直是“偷懒神器”。
<strong>它可以直接接收设计稿上的 px 坐标！</strong></p>
<h3 data-id="heading-4">举个栗子 🌰</h3>
<p>假设设计稿上：</p>
<ul>
<li><strong>标题</strong>：距离顶部 50px，水平居中。</li>
<li><strong>左侧图表</strong>：距离左边 30px，顶部 100px。</li>
<li><strong>右侧列表</strong>：死死贴住右边框，距离右边 30px。</li>
</ul>
<p>用 <code>vfit</code> 写代码是这样的：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"screen-wrapper"</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 标题：居中咱们还是用 flex 方便，或者也可以算 left --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">FitContainer</span> <span class="hljs-attr">:top</span>=<span class="hljs-string">"50"</span> <span class="hljs-attr">:left</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">:right</span>=<span class="hljs-string">"0"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"text-align: center"</span>&gt;</span>我的酷炫大屏<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">FitContainer</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 左侧图表：直接写设计稿坐标 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">FitContainer</span> <span class="hljs-attr">:top</span>=<span class="hljs-string">"100"</span> <span class="hljs-attr">:left</span>=<span class="hljs-string">"30"</span> <span class="hljs-attr">:z</span>=<span class="hljs-string">"10"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ChartComponent</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">FitContainer</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 右侧列表：注意这里！支持 right 定位 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">FitContainer</span> <span class="hljs-attr">:top</span>=<span class="hljs-string">"100"</span> <span class="hljs-attr">:right</span>=<span class="hljs-string">"30"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ListComponent</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">FitContainer</span>&gt;</span>

  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>
</code></pre>
<p><strong>发现没？我完全不需要思考缩放比例！</strong></p>
<ul>
<li>设计稿标 <code>30px</code>，我就写 <code>30</code>。</li>
<li>插件内部会自动根据当前的缩放倍率，帮我计算好实际的位置。</li>
<li>不管是 4K 屏还是笔记本小屏幕，位置看起来都和设计稿一模一样。</li>
</ul>
<hr/>
<h2 data-id="heading-5">🤔 踩坑小贴士</h2>
<p>在使用过程中也发现了一些需要注意的小细节，分享给大家避坑：</p>
<ol>
<li>
<p><strong>样式引入不能忘</strong>：
第一次用的时候忘了 <code>import 'vfit/style.css'</code>，结果 <code>&lt;FitContainer&gt;</code> 变成普通 div 了，排版全乱。大家千万别忘了。</p>
</li>
<li>
<p><strong>z-index 层级</strong>：
<code>&lt;FitContainer&gt;</code> 默认有个 <code>z-index: 300</code>（大概是为了防止被背景盖住）。如果你的弹窗被遮住了，记得给组件传个更大的 <code>:z="999"</code>。</p>
</li>
<li>
<p><strong>Right/Bottom 的特殊逻辑</strong>：
我看了一下源码发现，如果你用 <code>:left</code>，它会根据缩放比例位移（保持相对设计稿位置）。
但如果你用 <code>:right</code>，它是<strong>不乘缩放比例</strong>的。
<strong>这其实很科学</strong>：因为大屏通常是居中显示的，如果右侧元素也按比例缩放距离，在宽屏下可能会离屏幕边缘太远。现在的逻辑能保证它<strong>始终吸附在屏幕边缘</strong>，视觉效果更好。</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-6">总结</h2>
<p>如果你也在做 Vue 3 的大屏项目，真心推荐试一下 <code>vfit</code>。
它不是功能最强大的，但绝对是<strong>最省心</strong>的。
把精力花在画 ECharts 上，而不是在那算 <code>rem</code> 或者调 css 布局，这才是程序员该干的事嘛！😂</p>
<p><strong>项目地址</strong>：
🔗 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fv-plugin%2Fvfit" target="_blank" title="https://github.com/v-plugin/vfit" ref="nofollow noopener noreferrer">Github: https://github.com/v-plugin/vfit</a>
🔗 <a href="https://link.juejin.cn?target=https%3A%2F%2Fweb-vfit.netlify.app" target="_blank" title="https://web-vfit.netlify.app" ref="nofollow noopener noreferrer">文档: https://web-vfit.netlify.app</a></p>
<p>祝大家的大屏项目都能一次过稿！🍻</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift中对象实例方法名混淆问题详细解决方法]]></title>    <link>https://juejin.cn/post/7579264485259264015</link>    <guid>https://juejin.cn/post/7579264485259264015</guid>    <pubDate>2025-12-03T09:54:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579264485259264015" data-draft-id="7579313396207796239" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift中对象实例方法名混淆问题详细解决方法"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-03T09:54:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iOS开发上架哦"/> <meta itemprop="url" content="https://juejin.cn/user/3336394949004844"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift中对象实例方法名混淆问题详细解决方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3336394949004844/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iOS开发上架哦
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T09:54:43.000Z" title="Wed Dec 03 2025 09:54:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Swift对象实例方法名混淆的解决</p>
<p>在Xcode7.x中,比如有以下一个类:</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Foo</span>{
    func test(v:<span class="hljs-built_in">Int</span>,before:<span class="hljs-built_in">Int</span>)-&gt;<span class="hljs-built_in">Int</span>{
        <span class="hljs-keyword">return</span> v + <span class="hljs-number">1</span>
    }
}<span class="hljs-number">12345</span>
</code></pre>
<p>我可以直接这么做:</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">foo</span> = Foo()
let <span class="hljs-attr">f</span> = foo.test
f(11, before: 121)123
</code></pre>
<p>但是如果Foo中有一个类似的方法呢?</p>
<pre><code class="hljs language-kotlin" lang="kotlin">func test(v:<span class="hljs-built_in">Int</span>,after:<span class="hljs-built_in">Int</span>)-&gt;<span class="hljs-built_in">Int</span>{
        <span class="hljs-keyword">return</span> v + <span class="hljs-number">100</span>
    }<span class="hljs-number">123</span>
</code></pre>
<p>此时仅仅是Foo.test的赋值操作就会发生问题:</p>
<pre><code class="hljs language-rust" lang="rust">Playground execution failed: <span class="hljs-number">71</span>.playground:<span class="hljs-number">8</span>:<span class="hljs-number">9</span>: error: ambiguous <span class="hljs-keyword">use</span> of <span class="hljs-symbol">'test</span>(_:before:)'
<span class="hljs-keyword">let</span> <span class="hljs-keyword"/><span class="hljs-variable">f</span> = foo.test12
</code></pre>
<p>编译器告诉你上下文是模糊不清的,因为你不知道要用哪个test! 这种问题在代码混淆时尤其常见，当方法名被重命名后，类似的命名冲突可能增多。使用专业的代码混淆工具如IpaGuard可以帮助系统性地管理重命名，减少此类错误，并增强应用安全性。</p>
<p>此时我们可以明确写出我们想要的方法:</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">let</span> <span class="hljs-selector-tag">f</span> = <span class="hljs-selector-tag">foo</span><span class="hljs-selector-class">.test</span>(<span class="hljs-attribute">_</span>:<span class="hljs-attribute">after</span>:)
<span class="hljs-selector-tag">let</span> <span class="hljs-selector-tag">f2</span> = <span class="hljs-selector-tag">foo</span><span class="hljs-selector-class">.test</span>(<span class="hljs-attribute">_</span>:<span class="hljs-attribute">before</span>:)

<span class="hljs-selector-tag">f</span>(<span class="hljs-number">11</span>, <span class="hljs-attribute">after</span>: <span class="hljs-number">0</span>)
<span class="hljs-selector-tag">f2</span>(<span class="hljs-number">11</span>,<span class="hljs-attribute">before</span>: <span class="hljs-number">0</span>)<span class="hljs-number">12345</span>
</code></pre>
<p>但是在Xcode8beta中,_已不被允许,你必须这样写完整:</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">f</span> = foo.test(v:before:)
let <span class="hljs-attr">f2</span> = foo.test(v:after:)<span class="hljs-number">12</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GooglePay: 订阅商品购买流程]]></title>    <link>https://juejin.cn/post/7579450578293555242</link>    <guid>https://juejin.cn/post/7579450578293555242</guid>    <pubDate>2025-12-03T10:12:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579450578293555242" data-draft-id="7579439226518863878" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GooglePay: 订阅商品购买流程"/> <meta itemprop="keywords" content="Android,Google"/> <meta itemprop="datePublished" content="2025-12-03T10:12:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Nerve"/> <meta itemprop="url" content="https://juejin.cn/user/3438928101639512"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GooglePay: 订阅商品购买流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3438928101639512/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Nerve
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T10:12:43.000Z" title="Wed Dec 03 2025 10:12:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    10
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">GooglePay 订阅商品购买流程</h2>
<p>本文档详细介绍如何使用 GooglePay 库实现订阅商品的完整购买流程。</p>
<h3 data-id="heading-1">1. 概述</h3>
<h4 data-id="heading-2">1.1 什么是订阅商品</h4>
<p>订阅商品是指用户按周期（如每月、每年）付费的商品，会自动续订直到用户取消。常见的订阅商品包括：</p>
<ul>
<li>VIP 会员</li>
<li>高级功能订阅</li>
<li>内容订阅（音乐、视频、新闻等）</li>
<li>云存储空间</li>
<li>去广告服务</li>
</ul>
<h4 data-id="heading-3">1.2 订阅商品的特点</h4>
<ul>
<li><strong>自动续订</strong>: 到期后自动续费，除非用户主动取消</li>
<li><strong>周期性</strong>: 按固定周期收费（周、月、季、年等）</li>
<li><strong>需要确认</strong>: 购买成功后必须调用 <code>acknowledgePurchase</code> 确认</li>
<li><strong>支持优惠</strong>: 可以设置试用期、介绍价格等优惠</li>
<li><strong>状态管理</strong>: 需要管理订阅的有效期、暂停、恢复等状态</li>
</ul>
<h4 data-id="heading-4">1.3 订阅模式</h4>
<p>GooglePay 库支持两种订阅模式：</p>




















<table><thead><tr><th>模式</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>SingleMode</strong></td><td>单订阅模式，用户同时只能拥有一个订阅</td><td>会员等级系统（普通会员、VIP、SVIP）</td></tr><tr><td><strong>MultiModal</strong></td><td>多订阅模式，用户可以同时拥有多个订阅</td><td>多个独立功能订阅</td></tr></tbody></table>
<h3 data-id="heading-5">2. 前置准备</h3>
<h4 data-id="heading-6">2.1 Google Play Console 配置</h4>
<h5 data-id="heading-7">创建订阅商品</h5>
<ol>
<li>登录 <a href="https://link.juejin.cn?target=https%3A%2F%2Fplay.google.com%2Fconsole" target="_blank" title="https://play.google.com/console" ref="nofollow noopener noreferrer">Google Play Console</a></li>
<li>选择您的应用</li>
<li>导航到 <strong>订阅</strong> → <strong>创建订阅</strong></li>
<li>填写订阅基本信息：
<ul>
<li><strong>订阅 ID</strong>: 唯一标识符（例如：<code>monthly_vip</code>）</li>
<li><strong>名称</strong>: 订阅显示名称</li>
<li><strong>说明</strong>: 订阅描述</li>
</ul>
</li>
</ol>
<h5 data-id="heading-8">配置 Base Plan（基础方案）</h5>
<p>每个订阅至少需要一个 Base Plan：</p>
<ol>
<li>点击 <strong>添加基础方案</strong></li>
<li>设置 <strong>Base Plan ID</strong>（例如：<code>monthly-plan</code>）</li>
<li>选择 <strong>续订类型</strong>: 自动续订</li>
<li>设置 <strong>计费周期</strong>: 每月、每年等</li>
<li>设置 <strong>价格</strong>: 各个国家/地区的价格</li>
</ol>
<h5 data-id="heading-9">配置 Offer（优惠）（可选）</h5>
<p>可以为 Base Plan 添加优惠：</p>
<ol>
<li>在 Base Plan 中点击 <strong>添加优惠</strong></li>
<li>设置 <strong>Offer ID</strong>（例如：<code>trial-7days</code>）</li>
<li>选择优惠类型：
<ul>
<li><strong>免费试用</strong>: 免费使用一段时间</li>
<li><strong>介绍价格</strong>: 首次订阅享受优惠价格</li>
<li><strong>促销价格</strong>: 限时优惠</li>
</ul>
</li>
<li>设置优惠详情和价格</li>
</ol>
<h4 data-id="heading-10">2.2 应用初始化配置</h4>
<p>在 <code>Application</code> 类中初始化 GooglePayClient：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">App</span> : <span class="hljs-type">Application</span>(), GooglePayService {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onCreate()
        
        GooglePayClient.getInstance()
            .initBillingClient(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>)
            .setDebug(<span class="hljs-literal">true</span>)  <span class="hljs-comment">// 开发环境开启调试日志</span>
            .setSubscription(<span class="hljs-literal">true</span>)  <span class="hljs-comment">// 支持订阅</span>
            .setSubscriptionMode(SubscriptionMode.SingleMode)  <span class="hljs-comment">// 单订阅模式</span>
            .setInterval(<span class="hljs-number">15</span>)  <span class="hljs-comment">// 自动刷新间隔 15 秒</span>
            .registerActivitys(listOf(MainActivity::<span class="hljs-keyword">class</span>.java))
    }
    
    <span class="hljs-comment">// 实现 GooglePayService 接口</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getOneTimeConsumableProducts</span><span class="hljs-params">()</span></span>: List&lt;String&gt; {
        <span class="hljs-keyword">return</span> emptyList()  <span class="hljs-comment">// 不支持消耗型商品</span>
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getOneTimeNonConsumableProducts</span><span class="hljs-params">()</span></span>: List&lt;String&gt; {
        <span class="hljs-keyword">return</span> emptyList()
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getSubscribeProducts</span><span class="hljs-params">()</span></span>: List&lt;String&gt; {
        <span class="hljs-keyword">return</span> listOf(
            <span class="hljs-string">"monthly_vip"</span>,
            <span class="hljs-string">"yearly_vip"</span>
        )
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handlePurchasesProcess</span><span class="hljs-params">(
        isPay: <span class="hljs-type">Boolean</span>,
        productType: <span class="hljs-type">BillingProductType</span>,
        purchases: <span class="hljs-type">Purchase</span>
    )</span></span> {
        <span class="hljs-comment">// 处理订阅验证逻辑（见后续章节）</span>
    }
}
</code></pre>
<h3 data-id="heading-11">3. 完整购买流程</h3>
<h4 data-id="heading-12">流程图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User as 用户
    participant App as 应用客户端
    participant GPLib as GooglePay库
    participant GP as Google Play
    participant Server as 业务服务器
    
    User-&gt;&gt;App: 1. 点击订阅按钮
    App-&gt;&gt;GPLib: 2. querySubsOfferDetails(SubsOfferParams)
    GPLib-&gt;&gt;GP: 查询订阅详情
    GP--&gt;&gt;GPLib: 返回订阅信息
    GPLib--&gt;&gt;App: AppSubscribeDetails
    App-&gt;&gt;User: 3. 展示订阅信息和价格
    
    User-&gt;&gt;App: 4. 确认订阅
    App-&gt;&gt;Server: 5. 创建业务订单（可选）
    Server--&gt;&gt;App: 返回订单号
    
    App-&gt;&gt;GPLib: 6. launchBillingFlow(BillingSubsParams)
    GPLib-&gt;&gt;GP: 发起订阅
    GP-&gt;&gt;User: 7. 显示订阅确认界面
    User-&gt;&gt;GP: 8. 确认订阅
    
    GP--&gt;&gt;GPLib: 9. 订阅结果
    GPLib--&gt;&gt;App: PaySuccessful事件
    
    GPLib-&gt;&gt;Server: 10. handlePurchasesProcess回调
    Server-&gt;&gt;Server: 11. 验证订阅
    Server-&gt;&gt;GP: 12. 验证购买凭证
    GP--&gt;&gt;Server: 验证结果
    
    Server-&gt;&gt;Server: 13. 发放订阅权益
    Server-&gt;&gt;GPLib: 14. 调用acknowledgePurchase
    GPLib-&gt;&gt;GP: 15. 确认订阅
    
    GP--&gt;&gt;GPLib: 确认成功
    GPLib--&gt;&gt;App: 订阅激活
    
    App-&gt;&gt;User: 16. 显示订阅成功
</code></pre>
<h4 data-id="heading-13">步骤 1: 查询订阅详情</h4>
<p>在展示订阅列表前，需要先查询订阅的详细信息（价格、优惠等）。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SubscriptionViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> subscriptionService = GooglePayClient.getInstance()
        .getPayService&lt;SubscriptionService&gt;()
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _subscriptions = MutableLiveData&lt;List&lt;SubscriptionData&gt;&gt;()
    <span class="hljs-keyword">val</span> subscriptions: LiveData&lt;List&lt;SubscriptionData&gt;&gt; = _subscriptions
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadSubscriptions</span><span class="hljs-params">()</span></span> {
        viewModelScope.launch {
            <span class="hljs-comment">// 1. 构建查询参数</span>
            <span class="hljs-keyword">val</span> params = SubsOfferParams.Builder()
                .setProductIds(listOf(<span class="hljs-string">"monthly_vip"</span>, <span class="hljs-string">"yearly_vip"</span>))
                .build()
            
            <span class="hljs-comment">// 2. 查询订阅详情</span>
            subscriptionService.querySubsOfferDetails(params).collect { result -&gt;
                result.onSuccess { subscriptionList -&gt;
                    <span class="hljs-comment">// 3. 处理订阅数据</span>
                    <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = subscriptionList.map { subscription -&gt;
                        SubscriptionData(
                            productId = subscription.productId,
                            productName = subscription.productName,
                            basePlanId = extractBasePlanId(subscription),
                            offerId = extractOfferId(subscription),
                            pricingPhases = subscription.pricingPhases
                        )
                    }
                    _subscriptions.value = <span class="hljs-keyword">data</span>
                    Log.d(<span class="hljs-string">"Subs"</span>, <span class="hljs-string">"加载成功: <span class="hljs-subst">${data.size}</span> 个订阅"</span>)
                }
                result.onFailure { error -&gt;
                    Log.e(<span class="hljs-string">"Subs"</span>, <span class="hljs-string">"加载失败: <span class="hljs-subst">${error.message}</span>"</span>)
                }
            }
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">extractBasePlanId</span><span class="hljs-params">(subscription: <span class="hljs-type">AppSubscribeDetails</span>)</span></span>: String {
        <span class="hljs-comment">// 从订阅详情中提取 basePlanId</span>
        <span class="hljs-comment">// 实际实现需要根据库的具体 API</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"monthly-plan"</span>
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">extractOfferId</span><span class="hljs-params">(subscription: <span class="hljs-type">AppSubscribeDetails</span>)</span></span>: String? {
        <span class="hljs-comment">// 从订阅详情中提取 offerId（如果有优惠）</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>
    }
}

<span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SubscriptionData</span>(
    <span class="hljs-keyword">val</span> productId: String,
    <span class="hljs-keyword">val</span> productName: String,
    <span class="hljs-keyword">val</span> basePlanId: String,
    <span class="hljs-keyword">val</span> offerId: String?,
    <span class="hljs-keyword">val</span> pricingPhases: List&lt;PricingPhase&gt;
)
</code></pre>
<p><strong>AppSubscribeDetails 字段说明:</strong></p>

























<table><thead><tr><th>字段</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><code>productId</code></td><td>String</td><td>订阅商品 ID</td></tr><tr><td><code>productName</code></td><td>String</td><td>订阅商品名称</td></tr><tr><td><code>pricingPhases</code></td><td>List&lt;PricingPhase&gt;</td><td>定价阶梯列表</td></tr></tbody></table>
<p><strong>PricingPhase 字段说明:</strong></p>

























<table><thead><tr><th>字段</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><code>formattedPrice</code></td><td>String</td><td>格式化的价格（如 "€7.99"）</td></tr><tr><td><code>priceAmountMicros</code></td><td>Long</td><td>价格的微单位值</td></tr><tr><td><code>priceCurrencyCode</code></td><td>String</td><td>货币代码（如 "EUR"）</td></tr></tbody></table>
<h4 data-id="heading-14">步骤 2: 发起订阅购买</h4>
<p>用户点击订阅按钮后，构建订阅参数并发起订阅流程。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SubsFragment</span> : <span class="hljs-type">Fragment</span>() {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> subscriptionService = GooglePayClient.getInstance()
        .getPayService&lt;SubscriptionService&gt;()
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onSubscriptionClick</span><span class="hljs-params">(subscription: <span class="hljs-type">SubscriptionData</span>)</span></span> {
        lifecycleScope.launch {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 1. 可选：向业务服务器创建订单</span>
                <span class="hljs-keyword">val</span> chargeNo = createBusinessOrder(subscription.productId)
                
                <span class="hljs-comment">// 2. 构建订阅参数</span>
                <span class="hljs-keyword">val</span> params = BillingSubsParams.Builder()
                    .setAccountId(<span class="hljs-string">"user_12345"</span>)  <span class="hljs-comment">// 用户唯一标识</span>
                    .setProductId(subscription.productId)  <span class="hljs-comment">// 订阅商品 ID</span>
                    .setChargeNo(chargeNo)  <span class="hljs-comment">// 业务订单号（可选）</span>
                    .setBasePlanId(subscription.basePlanId)  <span class="hljs-comment">// Base Plan ID</span>
                    .setOfferId(subscription.offerId)  <span class="hljs-comment">// Offer ID（如果有优惠）</span>
                    .build()
                
                <span class="hljs-comment">// 3. 发起订阅</span>
                <span class="hljs-keyword">val</span> result = subscriptionService.launchBillingFlow(
                    requireActivity(),
                    params
                )
                
                <span class="hljs-comment">// 4. 处理返回结果</span>
                <span class="hljs-keyword">when</span> (result.code) {
                    AppBillingResponseCode.OK -&gt; {
                        Log.d(<span class="hljs-string">"Subs"</span>, <span class="hljs-string">"订阅流程已启动"</span>)
                    }
                    AppBillingResponseCode.USER_CANCELED -&gt; {
                        showToast(<span class="hljs-string">"您取消了订阅"</span>)
                    }
                    AppBillingResponseCode.ITEM_ALREADY_OWNED -&gt; {
                        showToast(<span class="hljs-string">"您已订阅该商品"</span>)
                        <span class="hljs-comment">// 可以查询当前订阅状态</span>
                        queryCurrentSubscription()
                    }
                    <span class="hljs-keyword">else</span> -&gt; {
                        showToast(<span class="hljs-string">"订阅失败: <span class="hljs-subst">${result.message}</span>"</span>)
                    }
                }
                
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                showToast(<span class="hljs-string">"订阅失败: <span class="hljs-subst">${e.message}</span>"</span>)
            }
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createBusinessOrder</span><span class="hljs-params">(productId: <span class="hljs-type">String</span>)</span></span>: String {
        <span class="hljs-keyword">return</span> withContext(Dispatchers.IO) {
            <span class="hljs-comment">// 调用业务服务器 API 创建订单</span>
            <span class="hljs-string">"SUB_ORDER_<span class="hljs-subst">${System.currentTimeMillis()}</span>"</span>
        }
    }
}
</code></pre>
<p><strong>BillingSubsParams 参数说明:</strong></p>









































<table><thead><tr><th>参数</th><th>类型</th><th>必填</th><th>说明</th></tr></thead><tbody><tr><td><code>accountId</code></td><td>String</td><td>是</td><td>用户唯一标识</td></tr><tr><td><code>productId</code></td><td>String</td><td>是</td><td>订阅商品 ID</td></tr><tr><td><code>chargeNo</code></td><td>String</td><td>否</td><td>业务订单号</td></tr><tr><td><code>basePlanId</code></td><td>String</td><td>是</td><td>Base Plan ID</td></tr><tr><td><code>offerId</code></td><td>String</td><td>否</td><td>Offer ID（有优惠时必填）</td></tr></tbody></table>
<h4 data-id="heading-15">步骤 3: 监听支付事件</h4>
<p>使用 <code>observePayEvent</code> 监听订阅结果。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SubsFragment</span> : <span class="hljs-type">Fragment</span>() {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewCreated</span><span class="hljs-params">(view: <span class="hljs-type">View</span>, savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onViewCreated(view, savedInstanceState)
        
        <span class="hljs-comment">// 监听支付事件</span>
        observePayEvent { event -&gt;
            <span class="hljs-keyword">when</span> (event) {
                <span class="hljs-keyword">is</span> BillingPayEvent.PaySuccessful -&gt; {
                    <span class="hljs-comment">// 订阅成功</span>
                    Log.d(<span class="hljs-string">"Subs"</span>, <span class="hljs-string">"订阅成功: <span class="hljs-subst">${event.purchase.orderId}</span>"</span>)
                    showLoading(<span class="hljs-string">"正在激活订阅..."</span>)
                    
                    <span class="hljs-comment">// 注意：订阅商品不会触发 PayConsumeSuccessful</span>
                    <span class="hljs-comment">// 需要在服务端验证后手动确认</span>
                }
                
                <span class="hljs-keyword">is</span> BillingPayEvent.PayFailed -&gt; {
                    <span class="hljs-comment">// 订阅失败</span>
                    hideLoading()
                    showToast(<span class="hljs-string">"订阅失败: <span class="hljs-subst">${event.message}</span>"</span>)
                    Log.e(<span class="hljs-string">"Subs"</span>, <span class="hljs-string">"订阅失败: code=<span class="hljs-subst">${event.code}</span>, msg=<span class="hljs-subst">${event.message}</span>"</span>)
                }
                
                <span class="hljs-keyword">is</span> BillingPayEvent.PayConsumeSuccessful -&gt; {
                    <span class="hljs-comment">// 订阅商品不会触发此事件</span>
                }
                
                <span class="hljs-keyword">is</span> BillingPayEvent.PayConsumeFailed -&gt; {
                    <span class="hljs-comment">// 订阅商品不会触发此事件</span>
                }
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-16">步骤 4: 服务端验证和确认</h4>
<p>在 <code>GooglePayService.handlePurchasesProcess()</code> 中实现订阅验证和确认逻辑。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">App</span> : <span class="hljs-type">Application</span>(), GooglePayService {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handlePurchasesProcess</span><span class="hljs-params">(
        isPay: <span class="hljs-type">Boolean</span>,
        productType: <span class="hljs-type">BillingProductType</span>,
        purchases: <span class="hljs-type">Purchase</span>
    )</span></span> {
        <span class="hljs-comment">// 检查是否是订阅商品</span>
        <span class="hljs-keyword">if</span> (productType != BillingProductType.SUBS) <span class="hljs-keyword">return</span>
        
        <span class="hljs-comment">// 在后台线程处理</span>
        CoroutineScope(Dispatchers.IO).launch {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 1. 提取订单信息</span>
                <span class="hljs-keyword">val</span> productId = purchases.products.firstOrNull() ?: <span class="hljs-keyword">return</span><span class="hljs-symbol">@launch</span>
                <span class="hljs-keyword">val</span> purchaseToken = purchases.purchaseToken
                <span class="hljs-keyword">val</span> orderId = purchases.orderId
                <span class="hljs-keyword">val</span> accountId = purchases.accountIdentifiers?.obfuscatedAccountId
                
                Log.d(<span class="hljs-string">"Subscription"</span>, <span class="hljs-string">"处理订阅: orderId=<span class="hljs-variable">$orderId</span>, productId=<span class="hljs-variable">$productId</span>"</span>)
                
                <span class="hljs-comment">// 2. 检查是否已确认</span>
                <span class="hljs-keyword">if</span> (purchases.isAcknowledged) {
                    Log.d(<span class="hljs-string">"Subscription"</span>, <span class="hljs-string">"订阅已确认，跳过处理"</span>)
                    <span class="hljs-keyword">return</span><span class="hljs-symbol">@launch</span>
                }
                
                <span class="hljs-comment">// 3. 调用业务服务器验证订阅</span>
                <span class="hljs-keyword">val</span> verifyResult = verifySubscriptionOnServer(
                    productId = productId,
                    purchaseToken = purchaseToken,
                    orderId = orderId,
                    accountId = accountId
                )
                
                <span class="hljs-keyword">if</span> (verifyResult.success) {
                    <span class="hljs-comment">// 4. 验证成功，发放订阅权益</span>
                    Log.d(<span class="hljs-string">"Subscription"</span>, <span class="hljs-string">"订阅验证成功，正在确认..."</span>)
                    
                    <span class="hljs-comment">// 5. 确认订阅（重要！）</span>
                    acknowledgePurchase(purchases)
                    
                } <span class="hljs-keyword">else</span> {
                    Log.e(<span class="hljs-string">"Subscription"</span>, <span class="hljs-string">"订阅验证失败: <span class="hljs-subst">${verifyResult.message}</span>"</span>)
                }
                
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                Log.e(<span class="hljs-string">"Subscription"</span>, <span class="hljs-string">"处理订阅异常"</span>, e)
            }
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">acknowledgePurchase</span><span class="hljs-params">(purchase: <span class="hljs-type">Purchase</span>)</span></span> {
        withContext(Dispatchers.IO) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 调用 Google Play Billing API 确认订阅</span>
                <span class="hljs-keyword">val</span> billingClient = GooglePayClient.getInstance().getBillingClient()
                <span class="hljs-keyword">val</span> params = AcknowledgePurchaseParams.newBuilder()
                    .setPurchaseToken(purchase.purchaseToken)
                    .build()
                
                <span class="hljs-keyword">val</span> result = billingClient.acknowledgePurchase(params)
                
                <span class="hljs-keyword">if</span> (result.responseCode == BillingClient.BillingResponseCode.OK) {
                    Log.d(<span class="hljs-string">"Subscription"</span>, <span class="hljs-string">"订阅确认成功"</span>)
                    <span class="hljs-comment">// 通知用户订阅已激活</span>
                    notifySubscriptionActivated()
                } <span class="hljs-keyword">else</span> {
                    Log.e(<span class="hljs-string">"Subscription"</span>, <span class="hljs-string">"订阅确认失败: <span class="hljs-subst">${result.debugMessage}</span>"</span>)
                }
                
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                Log.e(<span class="hljs-string">"Subscription"</span>, <span class="hljs-string">"确认订阅异常"</span>, e)
            }
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">verifySubscriptionOnServer</span><span class="hljs-params">(
        productId: <span class="hljs-type">String</span>,
        purchaseToken: <span class="hljs-type">String</span>,
        orderId: <span class="hljs-type">String</span>?,
        accountId: <span class="hljs-type">String</span>?
    )</span></span>: VerifyResult {
        <span class="hljs-keyword">return</span> withContext(Dispatchers.IO) {
            <span class="hljs-comment">// 调用业务服务器 API 验证订阅</span>
            <span class="hljs-comment">// 服务器应该：</span>
            <span class="hljs-comment">// 1. 验证 purchaseToken 的有效性（调用 Google Play Developer API）</span>
            <span class="hljs-comment">// 2. 检查订阅是否已经处理过</span>
            <span class="hljs-comment">// 3. 发放订阅权益给用户</span>
            <span class="hljs-comment">// 4. 返回验证结果</span>
            
            <span class="hljs-keyword">val</span> response = apiService.verifySubscription(
                productId, purchaseToken, orderId, accountId
            )
            VerifyResult(response.success, response.message)
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">notifySubscriptionActivated</span><span class="hljs-params">()</span></span> {
        <span class="hljs-comment">// 发送通知或事件，告知用户订阅已激活</span>
    }
    
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VerifyResult</span>(<span class="hljs-keyword">val</span> success: <span class="hljs-built_in">Boolean</span>, <span class="hljs-keyword">val</span> message: String)
}
</code></pre>
<h4 data-id="heading-17">步骤 5: 查询当前订阅状态</h4>
<p>查询用户当前有效的订阅。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SubscriptionViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> subscriptionService = GooglePayClient.getInstance()
        .getPayService&lt;SubscriptionService&gt;()
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _activeSubscriptions = MutableLiveData&lt;List&lt;Purchase&gt;&gt;()
    <span class="hljs-keyword">val</span> activeSubscriptions: LiveData&lt;List&lt;Purchase&gt;&gt; = _activeSubscriptions
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">queryActiveSubscriptions</span><span class="hljs-params">()</span></span> {
        viewModelScope.launch {
            <span class="hljs-comment">// 查询当前有效的订阅</span>
            subscriptionService.queryAckSubscribePurchases(<span class="hljs-literal">null</span>).collect { result -&gt;
                result.onSuccess { purchases -&gt;
                    _activeSubscriptions.value = purchases
                    Log.d(<span class="hljs-string">"Subs"</span>, <span class="hljs-string">"当前有效订阅: <span class="hljs-subst">${purchases.size}</span> 个"</span>)
                    
                    purchases.forEach { purchase -&gt;
                        Log.d(<span class="hljs-string">"Subs"</span>, <span class="hljs-string">"订阅: <span class="hljs-subst">${purchase.products.firstOrNull()}</span>"</span>)
                        Log.d(<span class="hljs-string">"Subs"</span>, <span class="hljs-string">"订单ID: <span class="hljs-subst">${purchase.orderId}</span>"</span>)
                        Log.d(<span class="hljs-string">"Subs"</span>, <span class="hljs-string">"是否已确认: <span class="hljs-subst">${purchase.isAcknowledged}</span>"</span>)
                    }
                }
                result.onFailure { error -&gt;
                    Log.e(<span class="hljs-string">"Subs"</span>, <span class="hljs-string">"查询失败: <span class="hljs-subst">${error.message}</span>"</span>)
                }
            }
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkSubscriptionStatus</span><span class="hljs-params">(productId: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-comment">// 检查用户是否订阅了指定商品</span>
        <span class="hljs-keyword">return</span> activeSubscriptions.value?.any { purchase -&gt;
            purchase.products.contains(productId) &amp;&amp; purchase.isAcknowledged
        } ?: <span class="hljs-literal">false</span>
    }
}
</code></pre>
<h3 data-id="heading-18">4. 订阅管理</h3>
<h4 data-id="heading-19">4.1 升级/降级订阅</h4>
<p>在单订阅模式下，用户可以升级或降级订阅。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">upgradeSubscription</span><span class="hljs-params">(
    oldProductId: <span class="hljs-type">String</span>,
    newProductId: <span class="hljs-type">String</span>,
    newBasePlanId: <span class="hljs-type">String</span>
)</span></span> {
    lifecycleScope.launch {
        <span class="hljs-comment">// 1. 查询当前订阅</span>
        <span class="hljs-keyword">val</span> currentPurchase = findCurrentPurchase(oldProductId)
        
        <span class="hljs-keyword">if</span> (currentPurchase == <span class="hljs-literal">null</span>) {
            showToast(<span class="hljs-string">"未找到当前订阅"</span>)
            <span class="hljs-keyword">return</span><span class="hljs-symbol">@launch</span>
        }
        
        <span class="hljs-comment">// 2. 构建升级参数</span>
        <span class="hljs-keyword">val</span> params = BillingSubsParams.Builder()
            .setAccountId(<span class="hljs-string">"user_12345"</span>)
            .setProductId(newProductId)
            .setBasePlanId(newBasePlanId)
            .setOldPurchaseToken(currentPurchase.purchaseToken)  <span class="hljs-comment">// 关键：传入旧订阅的 token</span>
            .build()
        
        <span class="hljs-comment">// 3. 发起升级</span>
        <span class="hljs-keyword">val</span> result = subscriptionService.launchBillingFlow(
            requireActivity(),
            params
        )
        
        <span class="hljs-keyword">if</span> (result.code == AppBillingResponseCode.OK) {
            showToast(<span class="hljs-string">"正在升级订阅..."</span>)
        }
    }
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">findCurrentPurchase</span><span class="hljs-params">(productId: <span class="hljs-type">String</span>)</span></span>: Purchase? {
    <span class="hljs-comment">// 查询当前订阅</span>
    <span class="hljs-keyword">var</span> purchase: Purchase? = <span class="hljs-literal">null</span>
    subscriptionService.queryAckSubscribePurchases(<span class="hljs-literal">null</span>).collect { result -&gt;
        result.onSuccess { purchases -&gt;
            purchase = purchases.find { it.products.contains(productId) }
        }
    }
    <span class="hljs-keyword">return</span> purchase
}
</code></pre>
<h4 data-id="heading-20">4.2 取消订阅</h4>
<p>用户需要在 Google Play 中取消订阅，应用可以引导用户：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">navigateToSubscriptionManagement</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">val</span> intent = Intent(Intent.ACTION_VIEW).apply {
            <span class="hljs-keyword">data</span> = Uri.parse(<span class="hljs-string">"https://play.google.com/store/account/subscriptions"</span>)
        }
        startActivity(intent)
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        showToast(<span class="hljs-string">"无法打开订阅管理页面"</span>)
    }
}
</code></pre>
<h4 data-id="heading-21">4.3 订阅状态检查</h4>
<p>定期检查订阅状态，处理过期、暂停等情况。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkAndUpdateSubscriptionStatus</span><span class="hljs-params">()</span></span> {
    lifecycleScope.launch {
        subscriptionService.queryAckSubscribePurchases(<span class="hljs-literal">null</span>).collect { result -&gt;
            result.onSuccess { purchases -&gt;
                <span class="hljs-keyword">if</span> (purchases.isEmpty()) {
                    <span class="hljs-comment">// 用户没有有效订阅</span>
                    updateUserSubscriptionStatus(<span class="hljs-literal">false</span>)
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">// 用户有有效订阅</span>
                    updateUserSubscriptionStatus(<span class="hljs-literal">true</span>)
                    
                    <span class="hljs-comment">// 检查订阅详情</span>
                    purchases.forEach { purchase -&gt;
                        checkPurchaseDetails(purchase)
                    }
                }
            }
        }
    }
}

<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkPurchaseDetails</span><span class="hljs-params">(purchase: <span class="hljs-type">Purchase</span>)</span></span> {
    <span class="hljs-comment">// 检查订阅是否在宽限期</span>
    <span class="hljs-comment">// 检查订阅是否在账号保留期</span>
    <span class="hljs-comment">// 这些信息需要通过 Google Play Developer API 在服务端查询</span>
}
</code></pre>
<h3 data-id="heading-22">5. 完整代码示例</h3>
<h4 data-id="heading-23">Fragment 完整实现</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SubsFragment</span> : <span class="hljs-type">Fragment</span>() {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> _binding: FragmentSubsBinding? = <span class="hljs-literal">null</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> binding <span class="hljs-keyword">get</span>() = _binding!!
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> viewModel <span class="hljs-keyword">by</span> viewModels&lt;SubsViewModel&gt;()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> adapter = SubscriptionAdapter()
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> subscriptionService = GooglePayClient.getInstance()
        .getPayService&lt;SubscriptionService&gt;()
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreateView</span><span class="hljs-params">(
        inflater: <span class="hljs-type">LayoutInflater</span>,
        container: <span class="hljs-type">ViewGroup</span>?,
        savedInstanceState: <span class="hljs-type">Bundle</span>?
    )</span></span>: View {
        _binding = FragmentSubsBinding.inflate(inflater, container, <span class="hljs-literal">false</span>)
        <span class="hljs-keyword">return</span> binding.root
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onViewCreated</span><span class="hljs-params">(view: <span class="hljs-type">View</span>, savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onViewCreated(view, savedInstanceState)
        
        setupRecyclerView()
        observeSubscriptions()
        observePayEvents()
        
        <span class="hljs-comment">// 加载订阅列表</span>
        viewModel.loadSubscriptions()
        
        <span class="hljs-comment">// 查询当前订阅状态</span>
        viewModel.queryActiveSubscriptions()
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">setupRecyclerView</span><span class="hljs-params">()</span></span> {
        binding.recyclerView.apply {
            layoutManager = GridLayoutManager(requireContext(), <span class="hljs-number">2</span>)
            adapter = <span class="hljs-keyword">this</span><span class="hljs-symbol">@SubsFragment</span>.adapter
        }
        
        adapter.setOnItemClickListener { subscription -&gt;
            purchaseSubscription(subscription)
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">observeSubscriptions</span><span class="hljs-params">()</span></span> {
        viewModel.subscriptions.observe(viewLifecycleOwner) { subscriptions -&gt;
            adapter.submitList(subscriptions)
        }
        
        viewModel.activeSubscriptions.observe(viewLifecycleOwner) { purchases -&gt;
            updateSubscriptionStatus(purchases)
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">observePayEvents</span><span class="hljs-params">()</span></span> {
        observePayEvent { event -&gt;
            <span class="hljs-keyword">when</span> (event) {
                <span class="hljs-keyword">is</span> BillingPayEvent.PaySuccessful -&gt; {
                    showLoading(<span class="hljs-string">"正在激活订阅..."</span>)
                }
                
                <span class="hljs-keyword">is</span> BillingPayEvent.PayFailed -&gt; {
                    hideLoading()
                    showToast(<span class="hljs-string">"订阅失败: <span class="hljs-subst">${event.message}</span>"</span>)
                }
                
                <span class="hljs-keyword">else</span> -&gt; {
                    <span class="hljs-comment">// 订阅商品不会触发消耗相关事件</span>
                }
            }
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">purchaseSubscription</span><span class="hljs-params">(subscription: <span class="hljs-type">SubscriptionData</span>)</span></span> {
        lifecycleScope.launch {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">val</span> params = BillingSubsParams.Builder()
                    .setAccountId(viewModel.getUserId())
                    .setProductId(subscription.productId)
                    .setBasePlanId(subscription.basePlanId)
                    .setOfferId(subscription.offerId)
                    .build()
                
                <span class="hljs-keyword">val</span> result = subscriptionService.launchBillingFlow(
                    requireActivity(),
                    params
                )
                
                <span class="hljs-keyword">if</span> (result.code != AppBillingResponseCode.OK) {
                    showToast(result.message)
                }
                
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                showToast(<span class="hljs-string">"订阅失败: <span class="hljs-subst">${e.message}</span>"</span>)
            }
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateSubscriptionStatus</span><span class="hljs-params">(purchases: <span class="hljs-type">List</span>&lt;<span class="hljs-type">Purchase</span>&gt;)</span></span> {
        <span class="hljs-comment">// 更新 UI 显示订阅状态</span>
        binding.subscriptionStatus.text = <span class="hljs-keyword">if</span> (purchases.isNotEmpty()) {
            <span class="hljs-string">"已订阅"</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-string">"未订阅"</span>
        }
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onDestroyView</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onDestroyView()
        _binding = <span class="hljs-literal">null</span>
    }
}
</code></pre>
<h4 data-id="heading-24">ViewModel 实现</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SubsViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> subscriptionService = GooglePayClient.getInstance()
        .getPayService&lt;SubscriptionService&gt;()
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _subscriptions = MutableLiveData&lt;List&lt;SubscriptionData&gt;&gt;()
    <span class="hljs-keyword">val</span> subscriptions: LiveData&lt;List&lt;SubscriptionData&gt;&gt; = _subscriptions
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _activeSubscriptions = MutableLiveData&lt;List&lt;Purchase&gt;&gt;()
    <span class="hljs-keyword">val</span> activeSubscriptions: LiveData&lt;List&lt;Purchase&gt;&gt; = _activeSubscriptions
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadSubscriptions</span><span class="hljs-params">()</span></span> {
        viewModelScope.launch {
            <span class="hljs-keyword">val</span> params = SubsOfferParams.Builder()
                .setProductIds(listOf(<span class="hljs-string">"monthly_vip"</span>, <span class="hljs-string">"yearly_vip"</span>))
                .build()
            
            subscriptionService.querySubsOfferDetails(params).collect { result -&gt;
                result.onSuccess { list -&gt;
                    <span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span> = list.map { sub -&gt;
                        SubscriptionData(
                            productId = sub.productId,
                            productName = sub.productName,
                            basePlanId = <span class="hljs-string">"monthly-plan"</span>,  <span class="hljs-comment">// 实际需要从订阅详情中提取</span>
                            offerId = <span class="hljs-literal">null</span>,
                            pricingPhases = sub.pricingPhases
                        )
                    }
                    _subscriptions.value = <span class="hljs-keyword">data</span>
                }
                result.onFailure { Log.e(<span class="hljs-string">"VM"</span>, <span class="hljs-string">"加载失败"</span>, it) }
            }
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">queryActiveSubscriptions</span><span class="hljs-params">()</span></span> {
        viewModelScope.launch {
            subscriptionService.queryAckSubscribePurchases(<span class="hljs-literal">null</span>).collect { result -&gt;
                result.onSuccess { _activeSubscriptions.value = it }
                result.onFailure { Log.e(<span class="hljs-string">"VM"</span>, <span class="hljs-string">"查询失败"</span>, it) }
            }
        }
    }
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getUserId</span><span class="hljs-params">()</span></span>: String {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"user_12345"</span>
    }
}
</code></pre>
<h3 data-id="heading-25">6. 订阅生命周期</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">stateDiagram-v2
    [*] --&gt; 未订阅
    未订阅 --&gt; 试用期: 开始试用
    未订阅 --&gt; 正常订阅: 直接订阅
    试用期 --&gt; 正常订阅: 试用结束
    试用期 --&gt; 已取消: 取消订阅
    正常订阅 --&gt; 正常订阅: 自动续订
    正常订阅 --&gt; 已取消: 取消订阅
    正常订阅 --&gt; 宽限期: 支付失败
    宽限期 --&gt; 正常订阅: 支付成功
    宽限期 --&gt; 账号保留期: 宽限期结束
    账号保留期 --&gt; 正常订阅: 恢复订阅
    账号保留期 --&gt; 已过期: 保留期结束
    已取消 --&gt; 已过期: 到期
    已过期 --&gt; [*]
</code></pre>
<h3 data-id="heading-26">7. 常见问题</h3>
<h4 data-id="heading-27">Q1: 订阅模式如何选择？</h4>
<p><strong>A</strong>:</p>
<ul>
<li><strong>SingleMode</strong>: 适用于会员等级系统，用户只能同时拥有一个订阅（如普通会员、VIP、SVIP）</li>
<li><strong>MultiModal</strong>: 适用于多个独立功能订阅，用户可以同时订阅多个（如去广告 + 云存储）</li>
</ul>
<h4 data-id="heading-28">Q2: 如何获取 Offer Token？</h4>
<p><strong>A</strong>:</p>
<ul>
<li>Offer Token 在查询订阅详情时返回</li>
<li>需要从 <code>AppSubscribeDetails</code> 中提取</li>
<li>如果没有优惠，可以不设置 <code>offerId</code></li>
</ul>
<h4 data-id="heading-29">Q3: 订阅确认失败怎么办？</h4>
<p><strong>A</strong>:</p>
<ul>
<li>用户下次启动应用时，库会自动重新查询未确认的订阅</li>
<li>在 <code>handlePurchasesProcess</code> 中会再次触发确认流程</li>
<li>建议在服务端记录确认状态</li>
</ul>
<h4 data-id="heading-30">Q4: 如何处理订阅冲突？</h4>
<p><strong>A</strong>:</p>
<ul>
<li>在 SingleMode 下，购买新订阅会自动替换旧订阅</li>
<li>需要传入旧订阅的 <code>purchaseToken</code> 进行升级/降级</li>
<li>Google Play 会自动处理退款和计费</li>
</ul>
<h4 data-id="heading-31">Q5: 宽限期和账号保留期是什么？</h4>
<p><strong>A</strong>:</p>
<ul>
<li><strong>宽限期</strong>: 支付失败后，给用户一段时间更新支付方式，期间仍可使用订阅</li>
<li><strong>账号保留期</strong>: 宽限期结束后，暂停订阅但保留用户数据，等待用户恢复订阅</li>
<li>这些状态需要通过 Google Play Developer API 在服务端查询</li>
</ul>
<h4 data-id="heading-32">Q6: 如何测试订阅？</h4>
<p><strong>A</strong>:</p>
<ol>
<li>在 Google Play Console 中添加测试账号</li>
<li>使用测试账号登录设备</li>
<li>测试订阅会加速到期（如月订阅变为 5 分钟）</li>
<li>可以测试续订、取消、恢复等流程</li>
</ol>
<h3 data-id="heading-33">8. 最佳实践</h3>
<ol>
<li><strong>服务端验证</strong>: 始终在服务端验证订阅凭证，不要仅依赖客户端</li>
<li><strong>及时确认</strong>: 订阅成功后必须在 3 天内确认，否则会自动退款</li>
<li><strong>状态同步</strong>: 定期查询订阅状态，保持客户端和服务端状态一致</li>
<li><strong>优雅降级</strong>: 订阅过期后，优雅地降级用户权益，引导续订</li>
<li><strong>用户引导</strong>: 提供清晰的订阅管理入口，方便用户查看和管理订阅</li>
<li><strong>错误处理</strong>: 完善的错误处理和用户提示</li>
<li><strong>测试</strong>: 充分测试各种场景（新订阅、续订、升级、降级、取消等）</li>
</ol>
<h3 data-id="heading-34">9. 相关文档</h3>
<ul>
<li><a href="https://juejin.cn/post/7579427549471735854" target="_blank" title="https://juejin.cn/post/7579427549471735854">Google Play 结算系统入门指南</a></li>
<li><a href="https://juejin.cn/post/7579436743260274707" target="_blank" title="https://juejin.cn/post/7579436743260274707">GooglePay: API 文档</a></li>
<li><a href="https://juejin.cn/post/7579438351297740836" target="_blank" title="https://juejin.cn/post/7579438351297740836">GooglePay 消耗商品购买流程</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fgoogle%2Fplay%2Fbilling%2Fsubscriptions" target="_blank" title="https://developer.android.com/google/play/billing/subscriptions" ref="nofollow noopener noreferrer">Google Play Billing 官方文档</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端跨页面通讯终极指南③：LocalStorage 用法全解析]]></title>    <link>https://juejin.cn/post/7578877638988759040</link>    <guid>https://juejin.cn/post/7578877638988759040</guid>    <pubDate>2025-12-02T09:06:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578877638988759040" data-draft-id="7576482238461198378" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端跨页面通讯终极指南③：LocalStorage 用法全解析"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-02T09:06:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一诺滚雪球"/> <meta itemprop="url" content="https://juejin.cn/user/2824015112318094"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端跨页面通讯终极指南③：LocalStorage 用法全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2824015112318094/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一诺滚雪球
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T09:06:16.000Z" title="Tue Dec 02 2025 09:06:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>上一篇介绍了<strong>BroadcastChannel</strong>跨页面通讯的方式。今天介绍一种我们非常熟悉的方式<strong>LocalStorage</strong> 。凭浏览器原生接口就能实现数据共享，用法简洁高效。需要注意，仅支持<strong>同源页面</strong>。</p>
<p>下面我们介绍下LocalStorage 的跨页通讯的用法。</p>
<h2 data-id="heading-1">1. LocalStorage为什么能跨页通讯？</h2>
<p>我们都知道LocalStorage——它是浏览器提供的<strong>同源本地存储方案</strong>，数据存储在客户端，生命周期为永久（除非手动删除或清除浏览器缓存）。</p>
<p>它能实现跨页通讯的关键，在于两个核心机制：</p>
<h3 data-id="heading-2">1.1 同源数据共享机制</h3>
<p>LocalStorage 的数据严格遵循“同源策略”，即同一协议（http/https）、同一域名、同一端口下的所有页面，都能读取和修改同一个 LocalStorage 实例中的数据。</p>
<h3 data-id="heading-3">1.2 storage 事件触发机制</h3>
<p>LocalStorage 实现“通讯”而非单纯“数据存储”的核心。当一个页面修改了 LocalStorage 中的数据时，浏览器会自动向同源下的所有其他页面触发一个 <code>storage</code> 事件，该事件会携带修改前、修改后的数据及键名等信息。其他页面通过监听这个事件，就能实时感知数据变化，从而完成跨页通讯。</p>
<p>注意：当前页面修改 LocalStorage 时，自身不会触发 storage 事件，只有同源的其他页面才会收到通知！</p>
<h3 data-id="heading-4">1.3 LocalStorage通讯流程</h3>
<p>LocalStorage 跨页通讯的核心流程是：</p>
<ol>
<li>页面A修改 LocalStorage 数据 → 浏览器向同源其他页面发送 storage 事件</li>
<li>页面B/C/D 监听事件并获取数据变化。</li>
</ol>
<h2 data-id="heading-5">2. 实践案例</h2>
<p>通过上面的说明，作为数据发送方，通过修改 LocalStorage 存储数据；作为接收方，监听 storage 事件获取父页面传递的信息。我们实践一下：</p>
<h3 data-id="heading-6">2.1 步骤1：数据发送</h3>
<p>通过 <code>localStorage.setItem()</code> 存储数据，触发 storage 事件。为避免数据覆盖，建议给键名添加场景标识（如 <code>parent-to-iframe-msg</code>）。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 发送数据</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sendToIframe</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-comment">// 1. 存储数据到 LocalStorage，键名需唯一标识通讯场景</span>
  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'parent-to-iframe-msg'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
    <span class="hljs-attr">timestamp</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(), <span class="hljs-comment">// 防止数据缓存导致事件不触发</span>
    <span class="hljs-attr">content</span>: data
  }));
  
  <span class="hljs-comment">// 2. 可选：若需重复发送相同数据，可先删除再添加（storage 事件仅在值变化时触发）</span>
  <span class="hljs-comment">// localStorage.removeItem('parent-to-iframe-msg');</span>
}

<span class="hljs-comment">// 调用方法发送数据（示例：传递用户信息）</span>
<span class="hljs-title function_">sendToIframe</span>({
  <span class="hljs-attr">username</span>: <span class="hljs-string">'前端小助手'</span>,
  <span class="hljs-attr">role</span>: <span class="hljs-string">'admin'</span>
});
</code></pre>
<h3 data-id="heading-7">2.2 步骤2：数据接收</h3>
<p>接收方页面通过监听 <code>window.addEventListener('storage', callback)</code> 捕获数据变化，解析后获取页面传递的内容。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 监听父页面发送的数据</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'storage'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-comment">// 1. 仅处理目标键名的数据变化，避免无关事件干扰</span>
  <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> !== <span class="hljs-string">'parent-to-iframe-msg'</span>) <span class="hljs-keyword">return</span>;
  
  <span class="hljs-comment">// 2. 解析数据（注意：初始状态下 e.newValue 可能为 null）</span>
  <span class="hljs-keyword">if</span> (!e.<span class="hljs-property">newValue</span>) <span class="hljs-keyword">return</span>;
  
  <span class="hljs-keyword">const</span> { timestamp, content } = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(e.<span class="hljs-property">newValue</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'iframe 收到父页面数据：'</span>, content);
  
  <span class="hljs-comment">// 3. 业务处理：如渲染用户信息</span>
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'user-info'</span>).<span class="hljs-property">innerText</span> = <span class="hljs-string">`用户名：<span class="hljs-subst">${content.username}</span>，角色：<span class="hljs-subst">${content.role}</span>`</span>;
});

<span class="hljs-comment">// 可选：页面销毁时移除监听，避免内存泄漏</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'storage'</span>, handleStorage);
});
</code></pre>
<p>接收数据如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0160e05f2e2e45498b719ee165aaf211~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765271175&amp;x-signature=fTBp2QqtDH91VOC72BJXO0MycmU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-8">3. LocalStorage通讯注意事项</h2>
<p>LocalStorage 用法简单，但在跨页通讯中若忽略细节，很容易出现“数据发了但收不到”的问题。以下这些坑必须提前规避：</p>
<h3 data-id="heading-9">3.1 同源策略限制：跨域页面无法通讯</h3>
<p>LocalStorage 严格遵循同源策略，不同域名、协议或端口的页面无法共享数据，也无法触发 storage 事件。若需跨域通讯，需结合 postMessage 或服务器中转，LocalStorage 无法单独实现。</p>
<h3 data-id="heading-10">3.2 数据格式限制：仅支持字符串类型</h3>
<p>LocalStorage 只能存储字符串，若要传递对象、数组等复杂数据，必须用 <code>JSON.stringify()</code> 序列化，接收时用 <code>JSON.parse()</code> 反序列化。注意：undefined、function 等类型无法被正常序列化，需提前处理。</p>
<h3 data-id="heading-11">3.3 storage 事件触发条件：仅值变化时触发</h3>
<p>只有当 LocalStorage 中数据的“值”发生变化时，才会触发 storage 事件。若两次存储相同的值，事件不会触发。解决办法：在数据中添加 timestamp 时间戳或随机数，确保每次存储的值不同。</p>
<h3 data-id="heading-12">3.4 存储容量限制：避免数据过大</h3>
<p>LocalStorage 单个域名的存储容量约为 5MB，若存储数据过大，会导致存储失败。跨页通讯应仅传递必要的核心数据（如 ID、状态），避免传递大量文本或二进制数据。</p>
<h2 data-id="heading-13">4. 总结</h2>
<p>最后总结一下：LocalStorage只需要操作 <code>setItem</code>、<code>getItem</code> 和 监听 <strong>storage</strong> 事件就能实现同源通讯。如果是非同源，那就只能用其他方式。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[多级缓存框架（Redis + Caffeine）完整指南]]></title>    <link>https://juejin.cn/post/7579460553614557235</link>    <guid>https://juejin.cn/post/7579460553614557235</guid>    <pubDate>2025-12-03T10:12:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579460553614557235" data-draft-id="7579427549472030766" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="多级缓存框架（Redis + Caffeine）完整指南"/> <meta itemprop="keywords" content="后端,Redis"/> <meta itemprop="datePublished" content="2025-12-03T10:12:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈哈哈笑什么"/> <meta itemprop="url" content="https://juejin.cn/user/808832912075352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            多级缓存框架（Redis + Caffeine）完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/808832912075352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈哈哈笑什么
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T10:12:16.000Z" title="Wed Dec 03 2025 10:12:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">多级缓存框架（Redis + Caffeine）完整指南</h2>
<h3 data-id="heading-1">一、框架核心概述（是什么）</h3>
<p>这是一套 <strong>本地缓存（Caffeine）+ 分布式缓存（Redis）的多级缓存框架</strong>，基于 Spring 生态实现，核心目标是兼顾缓存访问性能与分布式环境下的数据一致性。</p>
<h4 data-id="heading-2">核心特性</h4>
<ul>
<li>多级缓存架构：一级缓存（本地 Caffeine）提升响应速度，二级缓存（Redis）保证分布式一致性</li>
<li>灵活配置：支持过期时间、过期模式、NULL 值缓存、本地缓存容量限制等</li>
<li>动态 Key 生成：基于 SpEL 表达式实现缓存 Key 动态拼接</li>
<li>并发安全：内置分布式锁（Redisson），解决缓存穿透/击穿/雪崩问题</li>
<li>完整 API：支持缓存增删改查、原子操作、批量处理等</li>
</ul>
<h4 data-id="heading-3">技术栈依赖</h4>
<ul>
<li>核心框架：Spring Boot、Spring Context</li>
<li>缓存组件：Caffeine（本地缓存）、Redis（分布式缓存）</li>
<li>分布式锁：Redisson</li>
<li>序列化：Jackson</li>
<li>表达式解析：Spring EL</li>
</ul>
<h3 data-id="heading-4">二、框架核心价值（为什么用）</h3>
<h4 data-id="heading-5">1. 解决的核心问题</h4>





























<table><thead><tr><th>问题场景</th><th>框架解决方案</th></tr></thead><tbody><tr><td>缓存穿透（查询不存在的数据）</td><td>支持 NULL 值缓存 + 分布式锁防重复查询</td></tr><tr><td>缓存击穿（热点 Key 过期）</td><td>分布式锁 + 缓存自动续期</td></tr><tr><td>缓存雪崩（大量 Key 同时过期）</td><td>过期时间随机偏移 + 多级缓存降级</td></tr><tr><td>分布式缓存一致性</td><td>Redis 集中存储 + 缓存更新同步</td></tr><tr><td>本地缓存性能瓶颈</td><td>Caffeine 本地缓存（O(1) 访问速度）</td></tr></tbody></table>
<h4 data-id="heading-6">2. 相比单一缓存的优势</h4>
<ul>
<li>比纯 Redis 缓存：减少网络 IO 开销，本地缓存响应时间提升 10-100 倍</li>
<li>比纯本地缓存：支持分布式部署，避免节点间数据不一致</li>
<li>比 Spring Cache 原生：支持更灵活的配置（过期模式、容量限制）和更完善的并发控制</li>
</ul>
<h3 data-id="heading-7">三、快速上手（怎么做）</h3>
<h4 data-id="heading-8">1. 依赖配置（Maven）</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Spring Boot 基础依赖 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- Caffeine 本地缓存 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.ben-manes.caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>caffeine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.1.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- Redisson 分布式锁 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.redisson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.25.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

<span class="hljs-comment">&lt;!-- Jackson 序列化 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-databind<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h4 data-id="heading-9">2. 配置文件（application.yml）</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">demo-app</span> <span class="hljs-comment"># 用于 Redis Key 前缀</span>
  <span class="hljs-attr">redis:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span>
    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span>
    <span class="hljs-attr">timeout:</span> <span class="hljs-string">3000ms</span>
    <span class="hljs-attr">lettuce:</span>
      <span class="hljs-attr">pool:</span>
        <span class="hljs-attr">max-active:</span> <span class="hljs-number">8</span>
        <span class="hljs-attr">max-idle:</span> <span class="hljs-number">8</span>
        <span class="hljs-attr">min-idle:</span> <span class="hljs-number">2</span>
</code></pre>
<h4 data-id="heading-10">3. 基础使用示例</h4>
<h5 data-id="heading-11">3.1 编程式使用（直接操作缓存 API）</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> javax.annotation.Resource;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {

    <span class="hljs-comment">// 注入缓存管理器</span>
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> CacheManager cacheManager;

    <span class="hljs-comment">// 缓存配置（可通过 @ConfigurationProperties 注入）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">MultiCacheConfig</span> <span class="hljs-variable">userCacheConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MultiCacheConfig</span>(
        <span class="hljs-number">30</span>, TimeUnit.MINUTES, <span class="hljs-number">20</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span> <span class="hljs-comment">// ttl=30分钟，允许缓存NULL，启用本地缓存</span>
    );

    <span class="hljs-comment">/**
     * 查询用户：缓存命中返回，未命中查库并缓存
     */</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-comment">// 1. 获取缓存实例（缓存名称：userCache）</span>
        <span class="hljs-type">Cache</span> <span class="hljs-variable">cache</span> <span class="hljs-operator">=</span> cacheManager.getCache(<span class="hljs-string">"userCache"</span>, userCacheConfig);
        <span class="hljs-comment">// 2. 生成缓存Key（支持SpEL表达式，这里直接拼接）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"user:"</span> + userId;
        
        <span class="hljs-comment">// 3. 缓存查询（未命中时执行Supplier查库）</span>
        <span class="hljs-keyword">return</span> (User) cache.get(cacheKey, User.class, () -&gt; {
            <span class="hljs-comment">// 数据库查询逻辑（仅缓存未命中时执行）</span>
            <span class="hljs-keyword">return</span> userDao.selectById(userId);
        });
    }

    <span class="hljs-comment">/**
     * 更新用户：同步更新数据库和缓存
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-type">Cache</span> <span class="hljs-variable">cache</span> <span class="hljs-operator">=</span> cacheManager.getCache(<span class="hljs-string">"userCache"</span>, userCacheConfig);
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"user:"</span> + user.getId();
        
        <span class="hljs-comment">// 1. 更新数据库</span>
        userDao.updateById(user);
        <span class="hljs-comment">// 2. 更新缓存（覆盖旧值）</span>
        cache.put(cacheKey, user);
    }

    <span class="hljs-comment">/**
     * 删除用户：同步删除数据库和缓存
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(Long userId)</span> {
        <span class="hljs-type">Cache</span> <span class="hljs-variable">cache</span> <span class="hljs-operator">=</span> cacheManager.getCache(<span class="hljs-string">"userCache"</span>, userCacheConfig);
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"user:"</span> + userId;
        
        <span class="hljs-comment">// 1. 删除数据库记录</span>
        userDao.deleteById(userId);
        <span class="hljs-comment">// 2. 删除缓存（避免脏数据）</span>
        cache.evict(cacheKey);
    }
}
</code></pre>
<h5 data-id="heading-12">3.2 注解式使用（基于 AOP 切面）</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.lang.annotation.*;

<span class="hljs-comment">// 1. 自定义缓存注解（可扩展）</span>
<span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Documented</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> MyCacheable {
    String <span class="hljs-title function_">cacheName</span><span class="hljs-params">()</span>; <span class="hljs-comment">// 缓存名称</span>
    String <span class="hljs-title function_">key</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">""</span>; <span class="hljs-comment">// SpEL表达式Key</span>
    MultiCacheConfig <span class="hljs-title function_">config</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-meta">@MultiCacheConfig()</span>; <span class="hljs-comment">// 缓存配置</span>
}

<span class="hljs-comment">// 2. 注解切面实现（基于 AbstractCacheAspectSupport）</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheAspect</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractCacheAspectSupport</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> CacheManager cacheManager;

    <span class="hljs-meta">@Around("@annotation(myCacheable)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">cacheAroundAdvice</span><span class="hljs-params">(ProceedingJoinPoint joinPoint, MyCacheable myCacheable)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-comment">// 获取方法信息</span>
        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> getSpecificMethod(joinPoint);
        Object[] args = joinPoint.getArgs();
        <span class="hljs-type">Object</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> joinPoint.getTarget();
        
        <span class="hljs-comment">// 解析缓存Key（支持SpEL表达式）</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">cacheKey</span> <span class="hljs-operator">=</span> (String) generateKey(myCacheable.key(), method, args, target);
        <span class="hljs-comment">// 获取缓存实例</span>
        <span class="hljs-type">Cache</span> <span class="hljs-variable">cache</span> <span class="hljs-operator">=</span> cacheManager.getCache(myCacheable.cacheName(), myCacheable.config());
        
        <span class="hljs-comment">// 缓存查询：命中返回，未命中执行目标方法并缓存</span>
        <span class="hljs-keyword">return</span> cache.get(cacheKey, method.getReturnType(), () -&gt; {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">return</span> joinPoint.proceed();
            } <span class="hljs-keyword">catch</span> (Throwable e) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"缓存加载失败"</span>, e);
            }
        });
    }
}

<span class="hljs-comment">// 3. 业务层使用注解</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductService</span> {

    <span class="hljs-meta">@MyCacheable(
        cacheName = "productCache",
        key = "#root.methodName + ':' + #p0", // SpEL：方法名+第一个参数
        config = @MultiCacheConfig(ttl = 60, timeUnit = TimeUnit.MINUTES, cacheNullValues = true)
    )</span>
    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">getProductById</span><span class="hljs-params">(Long productId)</span> {
        <span class="hljs-comment">// 数据库查询逻辑（缓存未命中时执行）</span>
        <span class="hljs-keyword">return</span> productDao.selectById(productId);
    }
}
</code></pre>
<h3 data-id="heading-13">四、核心组件详解</h3>
<h4 data-id="heading-14">1. 缓存核心接口（Cache）</h4>
<p>定义缓存操作标准 API，所有缓存实现的顶层接口：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> interface Cache {
    <span class="hljs-comment">// 获取缓存（未命中返回null）</span>
    &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">get</span><span class="hljs-params">(<span class="hljs-type">String</span> key, Class&lt;T&gt; resultType)</span></span>;
    <span class="hljs-comment">// 获取缓存（未命中执行valueLoader加载并缓存）</span>
    &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">get</span><span class="hljs-params">(<span class="hljs-type">String</span> key, Class&lt;T&gt; resultType, Supplier&lt;Object&gt; valueLoader)</span></span>;
    <span class="hljs-comment">// 添加/覆盖缓存</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">put</span><span class="hljs-params">(<span class="hljs-type">String</span> key, Object value)</span></span>;
    <span class="hljs-comment">// 原子操作：不存在时才添加</span>
    <span class="hljs-function"><span class="hljs-type">boolean</span> <span class="hljs-title">putIfAbsent</span><span class="hljs-params">(<span class="hljs-type">String</span> key, Object value)</span></span>;
    <span class="hljs-comment">// 单个删除</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">evict</span><span class="hljs-params">(<span class="hljs-type">String</span> key)</span></span>;
    <span class="hljs-comment">// 批量删除</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">multiEvict</span><span class="hljs-params">(Collection&lt;<span class="hljs-type">String</span>&gt; keys)</span></span>;
    <span class="hljs-comment">// 清空缓存</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">clear</span><span class="hljs-params">()</span></span>;
}
</code></pre>
<h4 data-id="heading-15">2. 多级缓存实现（MultiLevelCache）</h4>
<p>整合 Caffeine 本地缓存和 Redis 分布式缓存：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiLevelCache</span> <span class="hljs-title">implements</span> <span class="hljs-title">Cache</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String cacheName;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CaffeineCache localCache; <span class="hljs-comment">// 一级缓存（本地）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> RedisCache remoteCache; <span class="hljs-comment">// 二级缓存（Redis）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> boolean cacheNullValues; <span class="hljs-comment">// 是否缓存NULL值</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> boolean enableLocalCache; <span class="hljs-comment">// 是否启用本地缓存</span>

    <span class="hljs-comment">// 核心逻辑：查询缓存时先查本地，再查Redis，最后查库</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-keyword">get</span>(String key, Class&lt;T&gt; resultType, Supplier&lt;Object&gt; valueLoader) {
        <span class="hljs-comment">// 1. 查本地缓存</span>
        <span class="hljs-keyword">if</span> (enableLocalCache) {
            T localValue = localCache.<span class="hljs-keyword">get</span>(key, resultType);
            <span class="hljs-keyword">if</span> (resultType.isInstance(localValue) &amp;&amp; !NullValue.isNullValue(localValue)) {
                <span class="hljs-keyword">return</span> localValue;
            }
        }

        <span class="hljs-comment">// 2. 查Redis缓存</span>
        T remoteValue = remoteCache.<span class="hljs-keyword">get</span>(key, resultType);
        <span class="hljs-keyword">if</span> (resultType.isInstance(remoteValue) &amp;&amp; !NullValue.isNullValue(remoteValue)) {
            <span class="hljs-comment">// 同步到本地缓存</span>
            <span class="hljs-keyword">if</span> (enableLocalCache) {
                localCache.put(key, remoteValue);
            }
            <span class="hljs-keyword">return</span> remoteValue;
        }

        <span class="hljs-comment">// 3. 缓存未命中，执行加载逻辑（查库）</span>
        Object value = valueLoader.<span class="hljs-keyword">get</span>();
        <span class="hljs-comment">// 4. 缓存结果（支持NULL值）</span>
        put(key, value);
        <span class="hljs-keyword">return</span> resultType.cast(fromStoreValue(value));
    }

    <span class="hljs-comment">// 其他方法：put/evict/clear 均同步操作本地和Redis缓存</span>
}
</code></pre>
<h4 data-id="heading-16">3. 缓存管理器（CacheManager）</h4>
<p>负责缓存实例的创建和管理，采用懒加载模式：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> interface CacheManager {
    <span class="hljs-comment">// 获取缓存（不存在返回null）</span>
    <span class="hljs-function">Cache <span class="hljs-title">getCache</span><span class="hljs-params">(<span class="hljs-type">String</span> name)</span></span>;
    <span class="hljs-comment">// 获取缓存（不存在则创建）</span>
    <span class="hljs-function">Cache <span class="hljs-title">getCache</span><span class="hljs-params">(<span class="hljs-type">String</span> name, MultiCacheConfig config)</span></span>;
}

<span class="hljs-comment">// 抽象实现类</span>
<span class="hljs-keyword">public</span> abstract <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractCacheManager</span> implements CacheManager {
    <span class="hljs-comment">// 缓存容器（ConcurrentHashMap保证线程安全）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentMap&lt;<span class="hljs-type">String</span>, Cache&gt; cacheMap = <span class="hljs-keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="hljs-number">16</span>);

    @<span class="hljs-function">Override
    <span class="hljs-keyword">public</span> Cache <span class="hljs-title">getCache</span><span class="hljs-params">(<span class="hljs-type">String</span> name, MultiCacheConfig config)</span> </span>{
        <span class="hljs-comment">// 双重检查锁：避免重复创建缓存</span>
        Cache cache = cacheMap.<span class="hljs-built_in">get</span>(name);
        <span class="hljs-keyword">if</span> (cache != null) {
            <span class="hljs-keyword">return</span> cache;
        }
        <span class="hljs-built_in">synchronized</span> (cacheMap) {
            cache = cacheMap.<span class="hljs-built_in">get</span>(name);
            <span class="hljs-keyword">if</span> (cache == null) {
                <span class="hljs-comment">// 创建缓存实例（子类实现具体缓存类型）</span>
                cache = <span class="hljs-built_in">createCache</span>(name, config);
                cacheMap.<span class="hljs-built_in">put</span>(name, cache);
            }
            <span class="hljs-keyword">return</span> cache;
        }
    }

    <span class="hljs-comment">// 抽象方法：由子类实现缓存创建逻辑</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> abstract Cache <span class="hljs-title">createCache</span><span class="hljs-params">(<span class="hljs-type">String</span> name, MultiCacheConfig config)</span></span>;
}
</code></pre>
<h4 data-id="heading-17">4. 分布式锁组件（Redisson）</h4>
<p>解决并发场景下的缓存问题，核心 API：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> interface DistributedLocker {
    <span class="hljs-comment">// 获取单个锁</span>
    <span class="hljs-function"><span class="hljs-type">boolean</span> <span class="hljs-title">lock</span><span class="hljs-params">(<span class="hljs-type">String</span> lockKey, <span class="hljs-type">long</span> leaseTime, <span class="hljs-type">long</span> waitTime, TimeUnit unit)</span></span>;
    <span class="hljs-comment">// 获取联锁（多个Key）</span>
    <span class="hljs-function"><span class="hljs-type">boolean</span> <span class="hljs-title">multiLock</span><span class="hljs-params">(Collection&lt;<span class="hljs-type">String</span>&gt; lockKeys, <span class="hljs-type">long</span> leaseTime, <span class="hljs-type">long</span> waitTime, TimeUnit unit)</span></span>;
    <span class="hljs-comment">// 释放锁</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">unlock</span><span class="hljs-params">(<span class="hljs-type">String</span> lockKey)</span></span>;
    <span class="hljs-comment">// 释放联锁</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">multiUnlock</span><span class="hljs-params">(Collection&lt;<span class="hljs-type">String</span>&gt; lockKeys)</span></span>;
}

<span class="hljs-comment">// 工具类封装（静态调用）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedLockUtils</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-type">static</span> DistributedLocker locker;

    <span class="hljs-comment">// 获取锁并执行逻辑</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">static</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">executeWithLock</span><span class="hljs-params">(<span class="hljs-type">String</span> lockKey, <span class="hljs-type">long</span> leaseTime, <span class="hljs-type">long</span> waitTime, TimeUnit unit, Supplier&lt;T&gt; supplier)</span> </span>{
        <span class="hljs-keyword">if</span> (locker.<span class="hljs-built_in">lock</span>(lockKey, leaseTime, waitTime, unit)) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-keyword">return</span> supplier.<span class="hljs-built_in">get</span>();
            } finally {
                locker.<span class="hljs-built_in">unlock</span>(lockKey);
            }
        }
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">"获取锁失败"</span>);
    }
}
</code></pre>
<h4 data-id="heading-18">5. 工具类</h4>
<h5 data-id="heading-19">5.1 JSON 序列化工具（JsonUtils）</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JsonUtils</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title class_">ObjectMapper</span> <span class="hljs-variable constant_">OBJECT_MAPPER</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>()
        .<span class="hljs-title function_">configure</span>(<span class="hljs-title class_">DeserializationFeature</span>.<span class="hljs-property">FAIL_ON_UNKNOWN_PROPERTIES</span>, <span class="hljs-literal">false</span>);

    <span class="hljs-comment">// 对象转JSON字符串</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">toJson</span>(<span class="hljs-params"><span class="hljs-built_in">Object</span> obj</span>) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">OBJECT_MAPPER</span>.<span class="hljs-title function_">writeValueAsString</span>(obj);
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">JsonProcessingException</span> e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"JSON序列化失败"</span>, e);
        }
    }

    <span class="hljs-comment">// JSON字符串转对象</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T&gt; T <span class="hljs-title function_">fromJson</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> json, Class&lt;T&gt; clazz</span>) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">OBJECT_MAPPER</span>.<span class="hljs-title function_">readValue</span>(json, clazz);
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">JsonProcessingException</span> e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"JSON反序列化失败"</span>, e);
        }
    }
}
</code></pre>
<h5 data-id="heading-20">5.2 SpEL 表达式解析工具（CacheExpressionEvaluator）</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheExpressionEvaluator</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">CachedExpressionEvaluator</span> {
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">ExpressionKey</span>, <span class="hljs-title class_">Expression</span>&gt; keyCache = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>&lt;&gt;(<span class="hljs-number">64</span>);

    <span class="hljs-comment">// 创建表达式上下文（包含方法、参数、目标对象等）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">EvaluationContext</span> <span class="hljs-title function_">createContext</span>(<span class="hljs-params">Method method, <span class="hljs-built_in">Object</span>[] args, <span class="hljs-built_in">Object</span> target</span>) {
        <span class="hljs-title class_">CacheExpressionRootObject</span> root = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CacheExpressionRootObject</span>(method, args, target);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodBasedEvaluationContext</span>(root, method, args, <span class="hljs-title function_">getParameterNameDiscoverer</span>());
    }

    <span class="hljs-comment">// 解析SpEL表达式</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">Object</span> <span class="hljs-title function_">evaluateKey</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> keyExpr, Method method, <span class="hljs-built_in">Object</span>[] args, <span class="hljs-built_in">Object</span> target</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">StringUtils</span>.<span class="hljs-title function_">isEmpty</span>(keyExpr)) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
        }
        <span class="hljs-title class_">EvaluationContext</span> context = <span class="hljs-title function_">createContext</span>(method, args, target);
        <span class="hljs-title class_">ExpressionKey</span> key = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExpressionKey</span>(keyExpr, method);
        <span class="hljs-keyword">return</span> keyCache.<span class="hljs-title function_">computeIfAbsent</span>(key, k -&gt; <span class="hljs-title function_">getExpressionParser</span>().<span class="hljs-title function_">parseExpression</span>(keyExpr))
            .<span class="hljs-title function_">getValue</span>(context);
    }
}
</code></pre>
<h3 data-id="heading-21">五、进阶配置与最佳实践</h3>
<h4 data-id="heading-22">1. 缓存策略配置</h4>
<h5 data-id="heading-23">1.1 过期模式选择</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 过期模式枚举</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ExpireMode</span> {
    WRITE, <span class="hljs-comment">// 写入后开始计时（适合写少读多场景）</span>
    ACCESS <span class="hljs-comment">// 访问后刷新过期时间（适合热点数据）</span>
}

<span class="hljs-comment">// 配置示例：热点数据使用ACCESS模式</span>
<span class="hljs-type">MultiCacheConfig</span> <span class="hljs-variable">hotDataConfig</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MultiCacheConfig</span>();
hotDataConfig.setExpireMode(ExpireMode.ACCESS.name());
hotDataConfig.setTtl(<span class="hljs-number">10</span>); <span class="hljs-comment">// 10分钟</span>
hotDataConfig.setEnableFirstCache(<span class="hljs-literal">true</span>);
</code></pre>
<h5 data-id="heading-24">1.2 防止缓存雪崩</h5>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 配置过期时间随机偏移（避免大量Key同时过期）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiCacheConfig</span> {
    <span class="hljs-comment">// 最大偏移比例（10%）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">double</span> MAX_OFFSET_RATIO = <span class="hljs-number">0.1</span>;

    <span class="hljs-comment">// 获取带随机偏移的过期时间（秒）</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title">getRandomTtl</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-type">long</span> baseTtl = <span class="hljs-built_in">getTtlToSeconds</span>();
        <span class="hljs-type">double</span> offset = baseTtl * MAX_OFFSET_RATIO;
        <span class="hljs-comment">// 随机增减偏移量</span>
        <span class="hljs-keyword">return</span> (<span class="hljs-type">long</span>) (baseTtl + (Math.<span class="hljs-built_in">random</span>() * <span class="hljs-number">2</span> * offset - offset));
    }
}
</code></pre>
<h4 data-id="heading-25">2. 性能调优</h4>
<h5 data-id="heading-26">2.1 本地缓存（Caffeine）调优</h5>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 高性能配置：基于访问频率和过期时间</span>
CaffeineCacheConfig config = <span class="hljs-keyword">new</span> <span class="hljs-built_in">CaffeineCacheConfig</span>();
config.<span class="hljs-built_in">setInitialCapacity</span>(<span class="hljs-number">100</span>); <span class="hljs-comment">// 初始容量</span>
config.<span class="hljs-built_in">setMaximumSize</span>(<span class="hljs-number">5000</span>); <span class="hljs-comment">// 最大容量（避免内存溢出）</span>
config.<span class="hljs-built_in">setExpireMode</span>(ExpireMode.ACCESS); <span class="hljs-comment">// 访问过期</span>
config.<span class="hljs-built_in">setTtl</span>(<span class="hljs-number">5</span>); <span class="hljs-comment">// 5分钟过期</span>
</code></pre>
<h5 data-id="heading-27">2.2 Redis 缓存调优</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">redis:</span>
    <span class="hljs-attr">lettuce:</span>
      <span class="hljs-attr">pool:</span>
        <span class="hljs-attr">max-active:</span> <span class="hljs-number">16</span> <span class="hljs-comment"># 最大连接数</span>
        <span class="hljs-attr">max-idle:</span> <span class="hljs-number">8</span> <span class="hljs-comment"># 最大空闲连接</span>
        <span class="hljs-attr">min-idle:</span> <span class="hljs-number">4</span> <span class="hljs-comment"># 最小空闲连接</span>
    <span class="hljs-attr">timeout:</span> <span class="hljs-string">2000ms</span> <span class="hljs-comment"># 超时时间（避免长时间阻塞）</span>
</code></pre>
<h4 data-id="heading-28">3. 常见问题解决方案</h4>
<h5 data-id="heading-29">3.1 缓存穿透（查询不存在的数据）</h5>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 方案：缓存NULL值 + 分布式锁</span>
<span class="hljs-keyword">public</span> User getUserById(<span class="hljs-built_in">Long</span> userId) {
    String cacheKey = <span class="hljs-string">"user:"</span> + userId;
    Cache cache = cacheManager.getCache(<span class="hljs-string">"userCache"</span>, config);
    
    <span class="hljs-comment">// 1. 查缓存（包括NULL值）</span>
    User user = cache.<span class="hljs-keyword">get</span>(cacheKey, User.<span class="hljs-keyword">class</span>);
    <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> user;
    }
    
    <span class="hljs-comment">// 2. 分布式锁：防止并发查询不存在的数据</span>
    <span class="hljs-keyword">return</span> DistributedLockUtils.executeWithLock(
        <span class="hljs-string">"lock:user:"</span> + userId, <span class="hljs-number">5</span>, <span class="hljs-number">3</span>, TimeUnit.SECONDS,
        () -&gt; {
            <span class="hljs-comment">// 3. 再次查缓存（避免锁等待期间已缓存）</span>
            User cachedUser = cache.<span class="hljs-keyword">get</span>(cacheKey, User.<span class="hljs-keyword">class</span>);
            <span class="hljs-keyword">if</span> (cachedUser != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> cachedUser;
            }
            <span class="hljs-comment">// 4. 查库（不存在则返回null）</span>
            User dbUser = userDao.selectById(userId);
            <span class="hljs-comment">// 5. 缓存结果（包括NULL值）</span>
            cache.put(cacheKey, dbUser);
            <span class="hljs-keyword">return</span> dbUser;
        }
    );
}
</code></pre>
<h5 data-id="heading-30">3.2 缓存击穿（热点Key过期）</h5>
<pre><code class="hljs language-ini" lang="ini">// 方案：缓存自动续期 + 分布式锁
public Product getHotProduct(Long productId) {
    String <span class="hljs-attr">cacheKey</span> = <span class="hljs-string">"hot:product:"</span> + productId<span class="hljs-comment">;</span>
    Cache <span class="hljs-attr">cache</span> = cacheManager.getCache(<span class="hljs-string">"hotProductCache"</span>, config)<span class="hljs-comment">;</span>
    
    return DistributedLockUtils.executeWithLock(
        cacheKey + ":lock", -1, 3, TimeUnit.SECONDS, // <span class="hljs-attr">leaseTime</span>=-<span class="hljs-number">1</span>：自动续期
        () -&gt; {
            Product <span class="hljs-attr">product</span> = cache.get(cacheKey, Product.class)<span class="hljs-comment">;</span>
            if (product != null) {
                // 访问后刷新过期时间（ACCESS模式自动实现）
                return product<span class="hljs-comment">;</span>
            }
            // 查库并缓存
            Product <span class="hljs-attr">dbProduct</span> = productDao.selectById(productId)<span class="hljs-comment">;</span>
            cache.put(cacheKey, dbProduct)<span class="hljs-comment">;</span>
            return dbProduct<span class="hljs-comment">;</span>
        }
    )<span class="hljs-comment">;</span>
}
</code></pre>
<h5 data-id="heading-31">3.3 缓存一致性（更新/删除后同步缓存）</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 方案：更新数据库后同步更新缓存，删除数据库后删除缓存</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">updateProduct</span>(<span class="hljs-params">Product product</span>) {
    <span class="hljs-comment">// 1. 更新数据库（事务内）</span>
    productDao.<span class="hljs-title function_">updateById</span>(product);
    <span class="hljs-comment">// 2. 更新缓存（事务提交后执行，避免事务回滚导致缓存脏数据）</span>
    <span class="hljs-title class_">TransactionSynchronizationManager</span>.<span class="hljs-title function_">registerSynchronization</span>(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransactionSynchronizationAdapter</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">afterCommit</span>(<span class="hljs-params"/>) {
                <span class="hljs-title class_">Cache</span> cache = cacheManager.<span class="hljs-title function_">getCache</span>(<span class="hljs-string">"productCache"</span>, config);
                cache.<span class="hljs-title function_">put</span>(<span class="hljs-string">"product:"</span> + product.<span class="hljs-title function_">getId</span>(), product);
            }
        }
    );
}
</code></pre>
<h3 data-id="heading-32">六、完整可复用核心代码</h3>
<h4 data-id="heading-33">1. 缓存配置类</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">boot</span>.<span class="hljs-property">autoconfigure</span>.<span class="hljs-property">condition</span>.<span class="hljs-property">ConditionalOnBean</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">context</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">Bean</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">context</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">Configuration</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">beans</span>.<span class="hljs-property">factory</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">Value</span>;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@ConditionalOnBean</span>(<span class="hljs-title class_">RedisTemplate</span>.<span class="hljs-property">class</span>)
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheAutoConfiguration</span> {

    <span class="hljs-meta">@Value</span>(<span class="hljs-string">"${spring.application.name}"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">String</span> appName;

    <span class="hljs-comment">// 注册缓存管理器</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">CacheManager</span> <span class="hljs-title function_">cacheManager</span>(<span class="hljs-params">RedisTemplate&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>&gt; redisTemplate</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultCacheManager</span>(appName, <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisCacheTemplate</span>(redisTemplate));
    }

    <span class="hljs-comment">// 注册分布式锁</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">DistributedLocker</span> <span class="hljs-title function_">distributedLocker</span>(<span class="hljs-params">RedissonClient redissonClient</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedissonDistributedLocker</span>(redissonClient);
    }
}
</code></pre>
<h4 data-id="heading-34">2. 多级缓存配置模型</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MultiCacheConfig</span> {
    <span class="hljs-comment">// 缓存过期时间（默认10分钟）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-variable">ttl</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;
    <span class="hljs-comment">// 时间单位（默认分钟）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">TimeUnit</span> <span class="hljs-variable">timeUnit</span> <span class="hljs-operator">=</span> TimeUnit.MINUTES;
    <span class="hljs-comment">// 过期时间比例（用于动态调整，1-100）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">ttlProportion</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;
    <span class="hljs-comment">// 是否缓存NULL值（默认false）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">cacheNullValues</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    <span class="hljs-comment">// 是否启用本地缓存（默认false）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">enableLocalCache</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    <span class="hljs-comment">// 本地缓存初始容量（默认10）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">initialCapacity</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;
    <span class="hljs-comment">// 本地缓存最大容量（默认3000）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> <span class="hljs-variable">maximumSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">3000</span>;
    <span class="hljs-comment">// 过期模式（默认WRITE）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">expireMode</span> <span class="hljs-operator">=</span> ExpireMode.WRITE.name();

    <span class="hljs-comment">// Getter/Setter 省略</span>

    <span class="hljs-comment">// 转换为秒级过期时间</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getTtlToSeconds</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> timeUnit.toSeconds(ttl);
    }

    <span class="hljs-comment">// 带比例的过期时间（最小3秒）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getTtlWithProportion</span><span class="hljs-params">()</span> {
        <span class="hljs-type">long</span> <span class="hljs-variable">base</span> <span class="hljs-operator">=</span> getTtlToSeconds();
        <span class="hljs-type">long</span> <span class="hljs-variable">proportioned</span> <span class="hljs-operator">=</span> (base * ttlProportion) / <span class="hljs-number">100</span>;
        <span class="hljs-keyword">return</span> Math.max(proportioned, <span class="hljs-number">3</span>);
    }
}

<span class="hljs-comment">// 过期模式枚举</span>
<span class="hljs-keyword">enum</span> <span class="hljs-title class_">ExpireMode</span> {
    WRITE, ACCESS
}
</code></pre>
<h4 data-id="heading-35">3. 空值标识类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.io.Serializable;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NullValue</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">NullValue</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullValue</span>();

    <span class="hljs-keyword">private</span> <span class="hljs-title function_">NullValue</span><span class="hljs-params">()</span> {}

    <span class="hljs-comment">// 反序列化时返回单例</span>
    <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">readResolve</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> INSTANCE;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object obj)</span> {
        <span class="hljs-keyword">return</span> obj == <span class="hljs-built_in">this</span> || obj == <span class="hljs-literal">null</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> NullValue.class.hashCode();
    }

    <span class="hljs-comment">// 判断是否为空值</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isNull</span><span class="hljs-params">(Object value)</span> {
        <span class="hljs-keyword">return</span> value == <span class="hljs-literal">null</span> || value == INSTANCE;
    }
}
</code></pre>
<h4 data-id="heading-36">4. Redis 缓存模板</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">data</span>.<span class="hljs-property">redis</span>.<span class="hljs-property">core</span>.<span class="hljs-property">StringRedisTemplate</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">concurrent</span>.<span class="hljs-property">TimeUnit</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisCacheTemplate</span> {
    <span class="hljs-keyword">private</span> final <span class="hljs-title class_">StringRedisTemplate</span> redisTemplate;

    <span class="hljs-keyword">public</span> <span class="hljs-title class_">RedisCacheTemplate</span>(<span class="hljs-title class_">StringRedisTemplate</span> redisTemplate) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">redisTemplate</span> = redisTemplate;
    }

    <span class="hljs-comment">// 设置缓存（带过期时间）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">set</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> key, <span class="hljs-built_in">String</span> value, long ttl, TimeUnit unit</span>) {
        redisTemplate.<span class="hljs-title function_">opsForValue</span>().<span class="hljs-title function_">set</span>(key, value, ttl, unit);
    }

    <span class="hljs-comment">// 获取缓存</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">get</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> key</span>) {
        <span class="hljs-keyword">return</span> redisTemplate.<span class="hljs-title function_">opsForValue</span>().<span class="hljs-title function_">get</span>(key);
    }

    <span class="hljs-comment">// 删除缓存</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> key</span>) {
        <span class="hljs-keyword">return</span> redisTemplate.<span class="hljs-title function_">delete</span>(key);
    }

    <span class="hljs-comment">// 批量删除</span>
    <span class="hljs-keyword">public</span> long <span class="hljs-title function_">delete</span>(<span class="hljs-params">Collection&lt;<span class="hljs-built_in">String</span>&gt; keys</span>) {
        <span class="hljs-keyword">return</span> redisTemplate.<span class="hljs-title function_">delete</span>(keys);
    }

    <span class="hljs-comment">// 判断Key是否存在</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">hasKey</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> key</span>) {
        <span class="hljs-keyword">return</span> redisTemplate.<span class="hljs-title function_">hasKey</span>(key);
    }

    <span class="hljs-comment">// 设置过期时间</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">boolean</span> <span class="hljs-title function_">expire</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> key, long ttl, TimeUnit unit</span>) {
        <span class="hljs-keyword">return</span> redisTemplate.<span class="hljs-title function_">expire</span>(key, ttl, unit);
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[3.组合式函数]]></title>    <link>https://juejin.cn/post/7579440586694230062</link>    <guid>https://juejin.cn/post/7579440586694230062</guid>    <pubDate>2025-12-03T10:14:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579440586694230062" data-draft-id="7579451710302617626" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="3.组合式函数"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-12-03T10:14:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Zohnny"/> <meta itemprop="url" content="https://juejin.cn/user/879230751088759"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            3.组合式函数
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/879230751088759/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Zohnny
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T10:14:25.000Z" title="Wed Dec 03 2025 10:14:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">组合式函数</h2>
<p>组合式函数，本质上也就是<strong>代码复用</strong>的一种方式。</p>
<ul>
<li>组件：对结构、样式、逻辑进行复用</li>
<li>组合式函数：侧重于对 <strong>有状态</strong> 的逻辑进行复用</li>
</ul>
<p><strong>快速上手</strong></p>
<p>实现一个鼠标坐标值的追踪器。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div&gt;当前鼠标位置: {{ x }}, {{ y }}&lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref, onMounted, onUnmounted } from 'vue'

const x = ref(0)
const y = ref(0)

function update(event) {
  x.value = event.pageX
  y.value = event.pageY
}

onMounted(() =&gt; window.addEventListener('mousemove', update))
onUnmounted(() =&gt; window.removeEventListener('mousemove', update))
&lt;/script&gt;

&lt;style scoped&gt;&lt;/style&gt;
</code></pre>
<p>多个组件中<strong>复用这个相同的逻辑</strong>，该怎么办？</p>
<p>答：使用组合式函数。将包含了状态的相关逻辑，一起提取到一个单独的函数中，该函数就是组合式函数。</p>
<p><strong>相关细节</strong></p>
<p><strong>1. 组合式函数本身还可以相互嵌套</strong></p>
<p><strong>2. 和Vue2时期mixin区别</strong></p>
<p>解决了 Vue2 时期 mixin 的一些问题。</p>
<ol>
<li>
<p>不清晰的数据来源：当使用多个 minxin 的时候，实例上的数据属性来自于哪一个 mixin 不太好分辨。</p>
</li>
<li>
<p>命名空间冲突：如果多个 mixin 来自于不同的作者，可能会注册相同的属性名，造成命名冲突</p>
<p>mixin</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> mixinA = {
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// fetch data logic for mixin A</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Fetching data from mixin A'</span>);
    }
  }
};

<span class="hljs-keyword">const</span> mixinB = {
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// fetch data logic for mixin B</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Fetching data from mixin B'</span>);
    }
  }
};

<span class="hljs-keyword">new</span> <span class="hljs-title class_">Vue</span>({
  <span class="hljs-attr">mixins</span>: [mixinA, mixinB],
  <span class="hljs-attr">template</span>: <span class="hljs-string">`
    &lt;div&gt;
      &lt;button @click="fetchData"&gt;Fetch Data&lt;/button&gt;
    &lt;/div&gt;
  `</span>
});
</code></pre>
<p>组合式函数：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// useMixinA.js</span>
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useMixinA</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// fetch data logic for mixin A</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Fetching data from mixin A'</span>);
  }

  <span class="hljs-keyword">return</span> { fetchData };
}

<span class="hljs-comment">// useMixinB.js</span>
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useMixinB</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// fetch data logic for mixin B</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Fetching data from mixin B'</span>);
  }

  <span class="hljs-keyword">return</span> { fetchData };
}
</code></pre>
<p>组件使用上面的组合式函数：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { defineComponent } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> { useMixinA } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useMixinA'</span>;
<span class="hljs-keyword">import</span> { useMixinB } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useMixinB'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineComponent</span>({
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 这里必须要给别名</span>
    <span class="hljs-keyword">const</span> { <span class="hljs-attr">fetchData</span>: fetchDataA } = <span class="hljs-title function_">useMixinA</span>();
    <span class="hljs-keyword">const</span> { <span class="hljs-attr">fetchData</span>: fetchDataB } = <span class="hljs-title function_">useMixinB</span>();

    <span class="hljs-title function_">fetchDataA</span>();
    <span class="hljs-title function_">fetchDataB</span>();

    <span class="hljs-keyword">return</span> { fetchDataA, fetchDataB };
  },
  <span class="hljs-attr">template</span>: <span class="hljs-string">`
    &lt;div&gt;
      &lt;button @click="fetchDataA"&gt;Fetch Data A&lt;/button&gt;
      &lt;button @click="fetchDataB"&gt;Fetch Data B&lt;/button&gt;
    &lt;/div&gt;
  `</span>
});
</code></pre>
</li>
<li>
<p>隐式的跨mixin交流</p>
<p>mixin</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> mixinA = {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">sharedValue</span>: <span class="hljs-string">'some value'</span>
    };
  }
};
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> minxinB = {
  <span class="hljs-attr">computed</span>: {
    <span class="hljs-title function_">dValue</span>(<span class="hljs-params"/>){
      <span class="hljs-comment">// 和 mixinA 具有隐式的交流</span>
      <span class="hljs-comment">// 因为最终 mixin 的内容会被合并到组件实例上面，因此在 mixinB 里面可以直接访问 mixinA 的数据</span>
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">sharedValue</span> + <span class="hljs-string">'xxxx'</span>;
    }
  }
}
</code></pre>
<p>组合式函数：交流就是显式的</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useMixinA</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> sharedValue = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'some value'</span>);
  <span class="hljs-keyword">return</span> { sharedValue };
}
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useMixinB</span>(<span class="hljs-params">sharedValue</span>) {
  <span class="hljs-keyword">const</span> derivedValue = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> sharedValue.<span class="hljs-property">value</span> + <span class="hljs-string">' extended'</span>);
  <span class="hljs-keyword">return</span> { derivedValue };
}
</code></pre>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div&gt;
    {{ derivedValue }}
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
import { defineComponent } from 'vue';
import { useMixinA } from './useMixinA';
import { useMixinB } from './useMixinB';

export default defineComponent({
  setup() {
    const { sharedValue } = useMixinA();
    
    // 两个组合式函数的交流是显式的
    const { derivedValue } = useMixinB(sharedValue);

    return { derivedValue };
  }
});
&lt;/script&gt;
</code></pre>
</li>
</ol>
<p><strong>异步状态</strong></p>
<p>根据异步请求的情况显示不同的信息：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div v-if="error"&gt;Oops! Error encountered: {{ error.message }}&lt;/div&gt;
  &lt;div v-else-if="data"&gt;
    Data loaded:
    &lt;pre&gt;{{ data }}&lt;/pre&gt;
  &lt;/div&gt;
  &lt;div v-else&gt;Loading...&lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref } from 'vue'

// 发送请求获取数据
const data = ref(null)
// 错误
const error = ref(null)

fetch('...')
  .then((res) =&gt; res.json())
  .then((json) =&gt; (data.value = json))
  .catch((err) =&gt; (error.value = err))
&lt;/script&gt;
</code></pre>
<p>如何复用这段逻辑？仍然是提取成一个组合式函数。</p>
<p>如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useFetch</span>(<span class="hljs-params">url</span>) {
  <span class="hljs-keyword">const</span> data = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)
  <span class="hljs-keyword">const</span> error = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)

  <span class="hljs-title function_">fetch</span>(url)
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> res.<span class="hljs-title function_">json</span>())
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">json</span>) =&gt;</span> (data.<span class="hljs-property">value</span> = json))
    .<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> (error.<span class="hljs-property">value</span> = err))

  <span class="hljs-keyword">return</span> { data, error }
}
</code></pre>
<p>现在重构上面的组件：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div v-if="error"&gt;Oops! Error encountered: {{ error.message }}&lt;/div&gt;
  &lt;div v-else-if="data"&gt;
    Data loaded:
    &lt;pre&gt;{{ data }}&lt;/pre&gt;
  &lt;/div&gt;
  &lt;div v-else&gt;Loading...&lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import {useFetch} from './hooks/useFetch';
const {data, error} = useFetch('xxxx')
&lt;/script&gt;
</code></pre>
<p>这里为了更加灵活，我们想要传递一个响应式数据：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> url = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'first-url'</span>);
<span class="hljs-comment">// 请求数据</span>
<span class="hljs-keyword">const</span> {data, error} = <span class="hljs-title function_">useFetch</span>(url);
<span class="hljs-comment">// 修改 url 的值后重新请求数据</span>
url.<span class="hljs-property">value</span> = <span class="hljs-string">'new-url'</span>;
</code></pre>
<p>此时我们就需要重构上面的组合式函数：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { ref, watchEffect, toValue } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useFetch</span>(<span class="hljs-params">url</span>) {
  <span class="hljs-keyword">const</span> data = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)
  <span class="hljs-keyword">const</span> error = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>)

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchData</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-comment">// 每次执行 fetchData 的时候，重制 data 和 error 的值</span>
    data.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>
    error.<span class="hljs-property">value</span> = <span class="hljs-literal">null</span>

    <span class="hljs-title function_">fetch</span>(<span class="hljs-title function_">toValue</span>(url))
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> res.<span class="hljs-title function_">json</span>())
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">json</span>) =&gt;</span> (data.<span class="hljs-property">value</span> = json))
      .<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> (error.<span class="hljs-property">value</span> = err))
  }

  <span class="hljs-title function_">watchEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">fetchData</span>()
  })

  <span class="hljs-keyword">return</span> { data, error }
}
</code></pre>
<p><strong>约定和最佳实践</strong></p>
<p><strong>1. 命名</strong>：组合式函数约定用<strong>驼峰命名法</strong>命名，并<strong>以“use”作为开头</strong>。例如前面的 useMouse、useEvent.</p>
<p><strong>2. 输入参数</strong>：注意参数是<strong>响应式数据</strong>的情况。如果你的组合式函数在输入参数是 ref 或 getter 的情况下创建了响应式 effect，为了让它能够被正确追踪，请确保要么使用 watch( ) 显式地监视 ref 或 getter，要么在 watchEffect( ) 中调用 toValue( )。</p>
<p><strong>3. 返回值</strong></p>
<p>组合式函数中推荐返回一个普通对象，该对象的每一项是 ref 数据，这样可以保证在解构的时候仍然能够保持其响应式的特性：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 组合式函数</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useMouse</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
  <span class="hljs-keyword">const</span> y = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)

  <span class="hljs-comment">// ...</span>
  
  <span class="hljs-keyword">return</span> { x, y }
}
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { useMouse } <span class="hljs-keyword">from</span> <span class="hljs-string">'./hooks/useMouse'</span>
<span class="hljs-comment">// 可以解构</span>
<span class="hljs-keyword">const</span> { x, y } = <span class="hljs-title function_">useMouse</span>()
</code></pre>
<p>如果希望以对象属性的形式来使用组合式函数中返回的状态，可以将返回的对象用 reactive 再包装一次即可：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { useMouse } <span class="hljs-keyword">from</span> <span class="hljs-string">'./hooks/useMouse'</span>
<span class="hljs-keyword">const</span> mouse = <span class="hljs-title function_">reactive</span>(<span class="hljs-title function_">useMouse</span>())
</code></pre>
<p><strong>4. 副作用</strong></p>
<p>在组合式函数中可以执行副作用，例如添加 DOM 事件监听器或者请求数据。但是请确保在 onUnmounted 里面清理副作用。</p>
<p>例如在一个组合式函数设置了一个事件监听器，那么就需要在 onUnmounted 的时候移除这个事件监听器。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useMouse</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// ...</span>

  <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, update))
  <span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'mousemove'</span>, update))

	<span class="hljs-comment">// ...</span>
}
</code></pre>
<p>也可以像前面 useEvent 一样，专门定义一个组合式函数来处理副作用：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { onMounted, onUnmounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useEventListener</span>(<span class="hljs-params">target, event, callback</span>) {
  <span class="hljs-comment">// 专门处理副作用的组合式函数</span>
  <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> target.<span class="hljs-title function_">addEventListener</span>(event, callback))
  <span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> target.<span class="hljs-title function_">removeEventListener</span>(event, callback))
}
</code></pre>
<p><strong>5. 使用限制</strong></p>
<ol>
<li>
<p>只能在 &lt;script setup&gt;或 setup( ) 钩子中调用：确保在组件实例被创建时，所有的组合式函数都被正确初始化。特别如果你使用的是选项式 API，那么需要在 setup 方法中调用组合式函数，并且返回，这样才能暴露给 this 及其模板使用</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { useMouse } <span class="hljs-keyword">from</span> <span class="hljs-string">'./mouse.js'</span>
<span class="hljs-keyword">import</span> { useFetch } <span class="hljs-keyword">from</span> <span class="hljs-string">'./fetch.js'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">setup</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 因为组合式函数会返回一些状态</span>
    <span class="hljs-comment">// 为了后面通过 this 能够正确访问到这些数据状态</span>
    <span class="hljs-comment">// 必须在 setup 的时候调用组合式函数</span>
    <span class="hljs-keyword">const</span> { x, y } = <span class="hljs-title function_">useMouse</span>()
    <span class="hljs-keyword">const</span> { data, error } = <span class="hljs-title function_">useFetch</span>(<span class="hljs-string">'...'</span>)
    <span class="hljs-keyword">return</span> { x, y, data, error }
  },
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// setup() 暴露的属性可以在通过 `this` 访问到</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">x</span>)
  }
  <span class="hljs-comment">// ...其他选项</span>
}
</code></pre>
</li>
<li>
<p>只能被同步调用：组合式函数需要同步调用，以确保在组件实例的初始化过程中，所有相关的状态和副作用都能被正确地设置和处理。如果组合式函数被异步调用，可能会导致在组件实例还未完全初始化时，尝试访问未定义的实例数据，从而引发错误。</p>
</li>
<li>
<p>可以在像 onMounted 生命周期钩子中调用：在某些情况下，可以在如 onMounted 生命周期钩子中调用组合式函数。这些生命周期钩子也是<strong>同步执行</strong>的，并且在组件实例已经被初始化后调用，因此可以安全地使用组合式函数。</p>
</li>
</ol>
<hr/>
<p>-EOF-</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[关于Gulp，你学这些就够了]]></title>    <link>https://juejin.cn/post/7579453456018128937</link>    <guid>https://juejin.cn/post/7579453456018128937</guid>    <pubDate>2025-12-03T10:14:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579453456018128937" data-draft-id="7579453456018112553" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="关于Gulp，你学这些就够了"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2025-12-03T10:14:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="秀秀不只会前端"/> <meta itemprop="url" content="https://juejin.cn/user/1410009035452887"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            关于Gulp，你学这些就够了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1410009035452887/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    秀秀不只会前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T10:14:53.000Z" title="Wed Dec 03 2025 10:14:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Gulp 是一个基于流（Stream）的构建工具，用于自动化前端开发中的常见任务（如文件压缩、编译、自动化测试等）。它的设计理念是将任务流程处理成数据流，通过管道（Pipeline）处理数据，以达到自动化构建的目的。</p>
<blockquote>
<p>现在对 gulp 的使用已经很少了，但是有些面试官在面试的时候还是会问，因此单独写一篇文章来讲一下。</p>
</blockquote>
<h2 data-id="heading-0">1. <strong>Gulp 的基本概念</strong></h2>
<ul>
<li>​**流（Stream）**​：Gulp 通过流的方式来处理文件，可以让文件在内存中进行操作，而不需要频繁的读写磁盘。</li>
<li>​**任务（Task）**​：每个 Gulp 操作叫做一个任务，任务可以包含一个或多个操作（如文件压缩、文件合并等）。</li>
<li>​**管道（Pipe）**​：Gulp 使用管道来连接多个任务，以此形成工作流。管道是任务之间的流动路径，每个任务输出的结果作为下一个任务的输入。</li>
</ul>
<h2 data-id="heading-1">2. <strong>安装 Gulp</strong></h2>
<p>首先，确保你已经安装了 Node.js，然后通过 npm 安装 Gulp。</p>
<pre><code class="hljs language-Bash" lang="Bash"><span class="hljs-comment"># 安装 Gulp CLI（命令行工具）</span>
npm install --global gulp-cli

<span class="hljs-comment"># 在项目中安装 Gulp 本地依赖</span>
npm install --save-dev gulp
</code></pre>
<h2 data-id="heading-2">3. <strong>创建 Gulp 任务</strong></h2>
<p>gulp 任务函数可以接受一个 callback 作为参数，调用 callback 函数那么任务会结束；或者是一个返回 stream、promise、event emitter、child process 或 observable 类型的函数。</p>
<p><strong>一套流程 = src → pipe(plugin) → pipe(plugin) → dest</strong></p>
<blockquote>
<p>以下写法均为：gulp4+ 版本的最新写法。</p>
</blockquote>
<h3 data-id="heading-3">1）定义一个任务（Task）</h3>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">hello</span>(<span class="hljs-params">cb</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Gulp run ok"</span>);
  <span class="hljs-title function_">cb</span>(); <span class="hljs-comment">// 表示任务完成</span>
}
<span class="hljs-built_in">exports</span>.<span class="hljs-property">hello</span> = hello;
</code></pre>
<p>运行：</p>
<pre><code class="hljs language-Bash" lang="Bash">gulp hello
</code></pre>
<h3 data-id="heading-4">2）处理 CSS / Sass</h3>
<pre><code class="hljs language-Bash" lang="Bash">npm i gulp-sass sass gulp-clean-css gulp-autoprefixer -D
</code></pre>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> { src, dest } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"gulp"</span>);
<span class="hljs-keyword">const</span> sass = <span class="hljs-built_in">require</span>(<span class="hljs-string">"gulp-sass"</span>)(<span class="hljs-built_in">require</span>(<span class="hljs-string">"sass"</span>));
<span class="hljs-keyword">const</span> cleanCSS = <span class="hljs-built_in">require</span>(<span class="hljs-string">"gulp-clean-css"</span>);
<span class="hljs-keyword">const</span> autoprefixer = <span class="hljs-built_in">require</span>(<span class="hljs-string">"gulp-autoprefixer"</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">styles</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">src</span>(<span class="hljs-string">"src/scss/*.scss"</span>)
    .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">sass</span>())                <span class="hljs-comment">// scss -&gt; css</span>
    .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">autoprefixer</span>())        <span class="hljs-comment">// 自动加前缀</span>
    .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">cleanCSS</span>())            <span class="hljs-comment">// 压缩 css</span>
    .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">dest</span>(<span class="hljs-string">"dist/css"</span>));
}

<span class="hljs-built_in">exports</span>.<span class="hljs-property">styles</span> = styles;
</code></pre>
<p>运行：</p>
<pre><code class="hljs language-Bash" lang="Bash">gulp styles
</code></pre>
<h3 data-id="heading-5">3）压缩 / 合并 JS</h3>
<pre><code class="hljs language-Bash" lang="Bash">npm i gulp-uglify gulp-concat -D
</code></pre>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> uglify = <span class="hljs-built_in">require</span>(<span class="hljs-string">"gulp-uglify"</span>);
<span class="hljs-keyword">const</span> concat = <span class="hljs-built_in">require</span>(<span class="hljs-string">"gulp-concat"</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">scripts</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">src</span>(<span class="hljs-string">"src/js/*.js"</span>)
    .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">concat</span>(<span class="hljs-string">"app.min.js"</span>)) <span class="hljs-comment">// 合并</span>
    .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">uglify</span>())             <span class="hljs-comment">// 压缩</span>
    .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">dest</span>(<span class="hljs-string">"dist/js"</span>));
}

<span class="hljs-built_in">exports</span>.<span class="hljs-property">scripts</span> = scripts;
</code></pre>
<h3 data-id="heading-6">4）压缩图片</h3>
<pre><code class="hljs language-Bash" lang="Bash">npm i gulp-imagemin -D
</code></pre>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> imagemin = <span class="hljs-built_in">require</span>(<span class="hljs-string">"gulp-imagemin"</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">images</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">src</span>(<span class="hljs-string">"src/images/*"</span>)
    .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">imagemin</span>())   <span class="hljs-comment">// 压缩图片</span>
    .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">dest</span>(<span class="hljs-string">"dist/images"</span>));
}

<span class="hljs-built_in">exports</span>.<span class="hljs-property">images</span> = images;
</code></pre>
<h3 data-id="heading-7">5）监听文件修改</h3>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> { watch } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"gulp"</span>);

<span class="hljs-keyword">function</span> <span class="hljs-title function_">dev</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">watch</span>(<span class="hljs-string">"src/scss/*.scss"</span>, styles);
  <span class="hljs-title function_">watch</span>(<span class="hljs-string">"src/js/*.js"</span>, scripts);
  <span class="hljs-title function_">watch</span>(<span class="hljs-string">"src/images/*"</span>, images);
}

<span class="hljs-built_in">exports</span>.<span class="hljs-property">dev</span> = dev;
</code></pre>
<p>运行：</p>
<pre><code class="hljs language-Bash" lang="Bash">gulp dev
</code></pre>
<p>文件一改 → 自动构建</p>
<h3 data-id="heading-8">6）组合任务 series / parallel</h3>
<p>示例：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> { series, parallel } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"gulp"</span>);

<span class="hljs-built_in">exports</span>.<span class="hljs-property">build</span> = <span class="hljs-title function_">series</span>(styles, scripts, images);   <span class="hljs-comment">// 先后执行</span>
<span class="hljs-built_in">exports</span>.<span class="hljs-property">all</span>    = <span class="hljs-title function_">parallel</span>(styles, scripts, images); <span class="hljs-comment">// 同时执行</span>
</code></pre>
<p>运行：</p>
<pre><code class="hljs language-Bash" lang="Bash">gulp build
</code></pre>
<h3 data-id="heading-9">7）默认任务（直接 <code>gulp</code>）</h3>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-built_in">exports</span>.<span class="hljs-property">default</span> = <span class="hljs-title function_">series</span>(styles, scripts, images, dev);
</code></pre>
<p>执行：</p>
<pre><code class="hljs language-Bash" lang="Bash">gulp
</code></pre>
<ol start="4">
<li>
<h2 data-id="heading-10">常用 gulpfile.js</h2>
</li>
</ol>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> { src, dest, series, parallel, watch } = <span class="hljs-built_in">require</span>(<span class="hljs-string">"gulp"</span>);
<span class="hljs-keyword">const</span> sass = <span class="hljs-built_in">require</span>(<span class="hljs-string">"gulp-sass"</span>)(<span class="hljs-built_in">require</span>(<span class="hljs-string">"sass"</span>));
<span class="hljs-keyword">const</span> cleanCSS = <span class="hljs-built_in">require</span>(<span class="hljs-string">"gulp-clean-css"</span>);
<span class="hljs-keyword">const</span> uglify = <span class="hljs-built_in">require</span>(<span class="hljs-string">"gulp-uglify"</span>);
<span class="hljs-keyword">const</span> concat = <span class="hljs-built_in">require</span>(<span class="hljs-string">"gulp-concat"</span>);
<span class="hljs-keyword">const</span> imagemin = <span class="hljs-built_in">require</span>(<span class="hljs-string">"gulp-imagemin"</span>);
<span class="hljs-keyword">const</span> autoprefixer = <span class="hljs-built_in">require</span>(<span class="hljs-string">"gulp-autoprefixer"</span>);

<span class="hljs-comment">// CSS处理</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">styles</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">src</span>(<span class="hljs-string">"src/scss/*.scss"</span>)
    .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">sass</span>())
    .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">autoprefixer</span>())
    .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">cleanCSS</span>())
    .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">dest</span>(<span class="hljs-string">"dist/css"</span>));
}

<span class="hljs-comment">// JS处理</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">scripts</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">src</span>(<span class="hljs-string">"src/js/*.js"</span>)
    .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">concat</span>(<span class="hljs-string">"app.min.js"</span>))
    .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">uglify</span>())
    .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">dest</span>(<span class="hljs-string">"dist/js"</span>));
}

<span class="hljs-comment">// 图片压缩</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">images</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">src</span>(<span class="hljs-string">"src/images/*"</span>)
    .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">imagemin</span>())
    .<span class="hljs-title function_">pipe</span>(<span class="hljs-title function_">dest</span>(<span class="hljs-string">"dist/images"</span>));
}

<span class="hljs-comment">// 监听</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">dev</span>(<span class="hljs-params"/>) {
  <span class="hljs-title function_">watch</span>(<span class="hljs-string">"src/scss/*.scss"</span>, styles);
  <span class="hljs-title function_">watch</span>(<span class="hljs-string">"src/js/*.js"</span>, scripts);
  <span class="hljs-title function_">watch</span>(<span class="hljs-string">"src/images/*"</span>, images);
}

<span class="hljs-built_in">exports</span>.<span class="hljs-property">default</span> = <span class="hljs-title function_">series</span>(
  <span class="hljs-title function_">parallel</span>(styles, scripts, images),
  dev
);
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[最全音频处理WaveSurfer.js配置文档]]></title>    <link>https://juejin.cn/post/7579410911058083866</link>    <guid>https://juejin.cn/post/7579410911058083866</guid>    <pubDate>2025-12-03T10:17:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579410911058083866" data-draft-id="7579440586694246446" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="最全音频处理WaveSurfer.js配置文档"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-03T10:17:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QINS"/> <meta itemprop="url" content="https://juejin.cn/user/3825956196198669"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            最全音频处理WaveSurfer.js配置文档
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3825956196198669/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QINS
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T10:17:41.000Z" title="Wed Dec 03 2025 10:17:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、基础使用示例</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 基础用法</span>
<span class="hljs-keyword">const</span> wavesurfer = <span class="hljs-title class_">WaveSurfer</span>.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">container</span>: <span class="hljs-string">'#waveform'</span>,
  <span class="hljs-attr">waveColor</span>: <span class="hljs-string">'violet'</span>,
  <span class="hljs-attr">progressColor</span>: <span class="hljs-string">'purple'</span>
});

<span class="hljs-comment">// 加载音频</span>
wavesurfer.<span class="hljs-title function_">load</span>(<span class="hljs-string">'audio.mp3'</span>);

<span class="hljs-comment">// 事件监听</span>
wavesurfer.<span class="hljs-title function_">on</span>(<span class="hljs-string">'ready'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  wavesurfer.<span class="hljs-title function_">play</span>();
});

<span class="hljs-comment">// 控制方法</span>
wavesurfer.<span class="hljs-title function_">play</span>();
wavesurfer.<span class="hljs-title function_">pause</span>();
wavesurfer.<span class="hljs-title function_">stop</span>();
wavesurfer.<span class="hljs-title function_">setVolume</span>(<span class="hljs-number">0.5</span>);
wavesurfer.<span class="hljs-title function_">setPlaybackRate</span>(<span class="hljs-number">1.5</span>);
</code></pre>
<h2 data-id="heading-1">二、完整配置参数表格</h2>
<h3 data-id="heading-2">基础配置参数</h3>

































































<table><thead><tr><th>参数名</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>container</code></td><td>String/HTMLElement</td><td><strong>必填</strong></td><td>波形图容器（CSS选择器或DOM元素）</td></tr><tr><td><code>height</code></td><td>Number</td><td>128</td><td>波形图高度（像素）</td></tr><tr><td><code>width</code></td><td>Number</td><td>0</td><td>波形图宽度，0表示自动填充</td></tr><tr><td><code>responsive</code></td><td>Boolean</td><td>true</td><td>是否响应式布局</td></tr><tr><td><code>pixelRatio</code></td><td>Number</td><td>window.devicePixelRatio</td><td>像素比，用于高清屏</td></tr><tr><td><code>fillParent</code></td><td>Boolean</td><td>true</td><td>是否填充父容器</td></tr><tr><td><code>scrollParent</code></td><td>Boolean</td><td>false</td><td>是否启用横向滚动</td></tr><tr><td><code>minPxPerSec</code></td><td>Number</td><td>0</td><td>最小每秒像素数</td></tr><tr><td><code>hideScrollbar</code></td><td>Boolean</td><td>false</td><td>是否隐藏滚动条</td></tr></tbody></table>
<h3 data-id="heading-3">波形样式参数</h3>

















































































































<table><thead><tr><th>参数名</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>waveColor</code></td><td>String</td><td>'#999'</td><td>波形颜色</td></tr><tr><td><code>progressColor</code></td><td>String</td><td>'#555'</td><td>播放进度颜色</td></tr><tr><td><code>cursorColor</code></td><td>String</td><td>'#333'</td><td>光标颜色</td></tr><tr><td><code>cursorWidth</code></td><td>Number</td><td>1</td><td>光标宽度（像素）</td></tr><tr><td><code>barWidth</code></td><td>Number</td><td>0</td><td>条形宽度，0表示自动计算</td></tr><tr><td><code>barHeight</code></td><td>Number</td><td>1</td><td>条形高度比例（0-1）</td></tr><tr><td><code>barRadius</code></td><td>Number</td><td>0</td><td>条形圆角半径</td></tr><tr><td><code>barGap</code></td><td>Number</td><td>1</td><td>条形间距</td></tr><tr><td><code>backgroundColor</code></td><td>String</td><td>null</td><td>背景颜色</td></tr><tr><td><code>backgroundImage</code></td><td>String</td><td>null</td><td>背景图片URL</td></tr><tr><td><code>waveBackgroundColor</code></td><td>String</td><td>null</td><td>波形背景颜色</td></tr><tr><td><code>normalize</code></td><td>Boolean</td><td>false</td><td>是否归一化波形</td></tr><tr><td><code>splitChannels</code></td><td>Boolean</td><td>false</td><td>是否分离声道显示</td></tr><tr><td><code>waveShadowColor</code></td><td>String</td><td>null</td><td>波形阴影颜色</td></tr><tr><td><code>waveShadowBlur</code></td><td>Number</td><td>0</td><td>阴影模糊度</td></tr><tr><td><code>waveShadowOffsetX</code></td><td>Number</td><td>0</td><td>阴影X偏移</td></tr><tr><td><code>waveShadowOffsetY</code></td><td>Number</td><td>0</td><td>阴影Y偏移</td></tr></tbody></table>
<h3 data-id="heading-4">交互配置参数</h3>



















































































<table><thead><tr><th>参数名</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>interact</code></td><td>Boolean</td><td>true</td><td>是否启用交互</td></tr><tr><td><code>dragToSeek</code></td><td>Boolean</td><td>true</td><td>是否允许拖动跳转</td></tr><tr><td><code>autoScroll</code></td><td>Boolean</td><td>true</td><td>播放时是否自动滚动</td></tr><tr><td><code>autoCenter</code></td><td>Boolean</td><td>true</td><td>是否自动居中播放位置</td></tr><tr><td><code>hideCursor</code></td><td>Boolean</td><td>false</td><td>是否隐藏光标</td></tr><tr><td><code>skipLength</code></td><td>Number</td><td>2</td><td>跳过秒数（键盘快捷键）</td></tr><tr><td><code>showTimePosition</code></td><td>Boolean</td><td>true</td><td>是否显示时间位置</td></tr><tr><td><code>regionsMinLength</code></td><td>Number</td><td>0.01</td><td>最小区域长度（秒）</td></tr><tr><td><code>regionsSnapToGrid</code></td><td>Boolean</td><td>false</td><td>是否对齐网格</td></tr><tr><td><code>removeMediaElementOnDestroy</code></td><td>Boolean</td><td>true</td><td>销毁时是否移除媒体元素</td></tr><tr><td><code>partialRender</code></td><td>Boolean</td><td>false</td><td>是否部分渲染</td></tr><tr><td><code>rtl</code></td><td>Boolean</td><td>false</td><td>是否从右到左布局</td></tr></tbody></table>
<h3 data-id="heading-5">音频处理参数</h3>













































































<table><thead><tr><th>参数名</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>backend</code></td><td>String</td><td>'WebAudio'</td><td>音频后端：'WebAudio' 或 'MediaElement'</td></tr><tr><td><code>mediaType</code></td><td>String</td><td>'audio'</td><td>媒体类型：'audio' 或 'video'</td></tr><tr><td><code>audioRate</code></td><td>Number</td><td>1</td><td>播放速度（0.5-4）</td></tr><tr><td><code>volume</code></td><td>Number</td><td>1</td><td>音量（0-1）</td></tr><tr><td><code>loopSelection</code></td><td>Boolean</td><td>true</td><td>是否循环选区</td></tr><tr><td><code>sampleRate</code></td><td>Number</td><td>0</td><td>采样率，0表示自动</td></tr><tr><td><code>audioContext</code></td><td>AudioContext</td><td>null</td><td>自定义AudioContext</td></tr><tr><td><code>fftSmoothingTimeConstant</code></td><td>Number</td><td>0.8</td><td>FFT平滑常数</td></tr><tr><td><code>filter</code></td><td>String</td><td>'none'</td><td>滤波器类型：'lowpass'、'highpass'、'bandpass'</td></tr><tr><td><code>filterFrequency</code></td><td>Number</td><td>null</td><td>滤波频率</td></tr><tr><td><code>filterQ</code></td><td>Number</td><td>null</td><td>滤波器Q值</td></tr></tbody></table>
<h3 data-id="heading-6">音频加载参数</h3>





















































<table><thead><tr><th>参数名</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>url</code></td><td>String</td><td>null</td><td>音频URL（可直接在此指定）</td></tr><tr><td><code>xhr</code></td><td>Object</td><td>{}</td><td>XMLHttpRequest配置</td></tr><tr><td><code>mediaControls</code></td><td>Boolean</td><td>false</td><td>是否显示浏览器原生控制条</td></tr><tr><td><code>audioBuffer</code></td><td>AudioBuffer</td><td>null</td><td>预加载的AudioBuffer</td></tr><tr><td><code>peaks</code></td><td>Array</td><td>null</td><td>预计算的峰值数据</td></tr><tr><td><code>duration</code></td><td>Number</td><td>null</td><td>音频时长（秒）</td></tr><tr><td><code>forceDecode</code></td><td>Boolean</td><td>false</td><td>是否强制解码</td></tr></tbody></table>
<h3 data-id="heading-7">性能优化参数</h3>















































<table><thead><tr><th>参数名</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>renderFunction</code></td><td>Function</td><td>null</td><td>自定义渲染函数</td></tr><tr><td><code>drawingContextAttributes</code></td><td>Object</td><td><code>{alpha: true}</code></td><td>Canvas上下文属性</td></tr><tr><td><code>splitChannels</code></td><td>Boolean</td><td>false</td><td>是否分离声道处理</td></tr><tr><td><code>mediaContainer</code></td><td>HTMLElement</td><td>null</td><td>自定义媒体容器</td></tr><tr><td><code>mediaElement</code></td><td>HTMLMediaElement</td><td>null</td><td>自定义媒体元素</td></tr><tr><td><code>closeAudioContext</code></td><td>Boolean</td><td>false</td><td>销毁时是否关闭AudioContext</td></tr></tbody></table>
<h3 data-id="heading-8">XHR配置参数</h3>















































<table><thead><tr><th>参数名</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>xhr.cache</code></td><td>String</td><td>'default'</td><td>缓存策略</td></tr><tr><td><code>xhr.mode</code></td><td>String</td><td>'cors'</td><td>跨域模式</td></tr><tr><td><code>xhr.credentials</code></td><td>String</td><td>'same-origin'</td><td>凭证设置</td></tr><tr><td><code>xhr.referrer</code></td><td>String</td><td>'client'</td><td>引用来源</td></tr><tr><td><code>xhr.timeout</code></td><td>Number</td><td>0</td><td>超时时间（毫秒）</td></tr><tr><td><code>xhr.headers</code></td><td>Object</td><td>{}</td><td>请求头</td></tr></tbody></table>
<h3 data-id="heading-9">分离声道配置参数</h3>



































<table><thead><tr><th>参数名</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>splitChannelsOptions.overlay</code></td><td>Boolean</td><td>false</td><td>是否叠加显示</td></tr><tr><td><code>splitChannelsOptions.channelColors</code></td><td>Object</td><td>{}</td><td>各声道颜色配置</td></tr><tr><td><code>splitChannelsOptions.filterChannels</code></td><td>Array</td><td>[]</td><td>过滤显示的声道</td></tr><tr><td><code>splitChannelsOptions.relativeNormalization</code></td><td>Boolean</td><td>false</td><td>相对归一化</td></tr></tbody></table>
<h2 data-id="heading-10">三、分离声道颜色配置示例</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">splitChannelsOptions</span>: {
  <span class="hljs-attr">overlay</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">channelColors</span>: {
    <span class="hljs-number">0</span>: { <span class="hljs-comment">// 左声道</span>
      <span class="hljs-attr">waveColor</span>: <span class="hljs-string">'rgba(255, 0, 0, 0.5)'</span>,
      <span class="hljs-attr">progressColor</span>: <span class="hljs-string">'rgba(255, 100, 100, 0.8)'</span>
    },
    <span class="hljs-number">1</span>: { <span class="hljs-comment">// 右声道</span>
      <span class="hljs-attr">waveColor</span>: <span class="hljs-string">'rgba(0, 0, 255, 0.5)'</span>,
      <span class="hljs-attr">progressColor</span>: <span class="hljs-string">'rgba(100, 100, 255, 0.8)'</span>
    }
  },
  <span class="hljs-attr">filterChannels</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>],
  <span class="hljs-attr">relativeNormalization</span>: <span class="hljs-literal">true</span>
}
</code></pre>
<h2 data-id="heading-11">四、XHR配置示例</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">xhr</span>: {
  <span class="hljs-attr">cache</span>: <span class="hljs-string">'default'</span>,
  <span class="hljs-attr">mode</span>: <span class="hljs-string">'cors'</span>,
  <span class="hljs-attr">credentials</span>: <span class="hljs-string">'same-origin'</span>,
  <span class="hljs-attr">referrer</span>: <span class="hljs-string">'client'</span>,
  <span class="hljs-attr">timeout</span>: <span class="hljs-number">30000</span>,
  <span class="hljs-attr">headers</span>: {
    <span class="hljs-string">'Authorization'</span>: <span class="hljs-string">'Bearer token'</span>,
    <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'audio/mpeg'</span>
  }
}
</code></pre>
<h2 data-id="heading-12">五、分析器配置参数</h2>



































<table><thead><tr><th>参数名</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>analyserOptions.fftSize</code></td><td>Number</td><td>2048</td><td>FFT大小</td></tr><tr><td><code>analyserOptions.smoothingTimeConstant</code></td><td>Number</td><td>0.8</td><td>平滑时间常数</td></tr><tr><td><code>analyserOptions.minDecibels</code></td><td>Number</td><td>-100</td><td>最小分贝值</td></tr><tr><td><code>analyserOptions.maxDecibels</code></td><td>Number</td><td>-30</td><td>最大分贝值</td></tr></tbody></table>
<h2 data-id="heading-13">六、Canvas上下文属性</h2>























<table><thead><tr><th>参数名</th><th>类型</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>drawingContextAttributes.alpha</code></td><td>Boolean</td><td>true</td><td>是否启用透明度</td></tr><tr><td><code>drawingContextAttributes.desynchronized</code></td><td>Boolean</td><td>false</td><td>是否启用异步渲染</td></tr></tbody></table>
<h2 data-id="heading-14">七、完整配置示例</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 完整的WaveSurfer配置示例</span>
<span class="hljs-keyword">const</span> wavesurfer = <span class="hljs-title class_">WaveSurfer</span>.<span class="hljs-title function_">create</span>({
  <span class="hljs-comment">// 基础配置</span>
  <span class="hljs-attr">container</span>: <span class="hljs-string">'#waveform'</span>,
  <span class="hljs-attr">height</span>: <span class="hljs-number">200</span>,
  <span class="hljs-attr">width</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">responsive</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">pixelRatio</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">devicePixelRatio</span>,
  <span class="hljs-attr">fillParent</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">scrollParent</span>: <span class="hljs-literal">false</span>,
  
  <span class="hljs-comment">// 波形样式</span>
  <span class="hljs-attr">waveColor</span>: <span class="hljs-string">'#4A90E2'</span>,
  <span class="hljs-attr">progressColor</span>: <span class="hljs-string">'#2D5BA3'</span>,
  <span class="hljs-attr">cursorColor</span>: <span class="hljs-string">'#1A3D7C'</span>,
  <span class="hljs-attr">cursorWidth</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">barWidth</span>: <span class="hljs-number">3</span>,
  <span class="hljs-attr">barHeight</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">barRadius</span>: <span class="hljs-number">3</span>,
  <span class="hljs-attr">barGap</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'#F5F7FA'</span>,
  <span class="hljs-attr">normalize</span>: <span class="hljs-literal">true</span>,
  
  <span class="hljs-comment">// 交互配置</span>
  <span class="hljs-attr">interact</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">dragToSeek</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">autoScroll</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">autoCenter</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">hideCursor</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">skipLength</span>: <span class="hljs-number">5</span>,
  
  <span class="hljs-comment">// 音频处理</span>
  <span class="hljs-attr">backend</span>: <span class="hljs-string">'WebAudio'</span>,
  <span class="hljs-attr">audioRate</span>: <span class="hljs-number">1.0</span>,
  <span class="hljs-attr">volume</span>: <span class="hljs-number">0.8</span>,
  <span class="hljs-attr">loopSelection</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">sampleRate</span>: <span class="hljs-number">44100</span>,
  
  <span class="hljs-comment">// 音频加载</span>
  <span class="hljs-attr">xhr</span>: {
    <span class="hljs-attr">cache</span>: <span class="hljs-string">'default'</span>,
    <span class="hljs-attr">mode</span>: <span class="hljs-string">'cors'</span>,
    <span class="hljs-attr">credentials</span>: <span class="hljs-string">'same-origin'</span>,
    <span class="hljs-attr">timeout</span>: <span class="hljs-number">30000</span>
  },
  
  <span class="hljs-comment">// 性能优化</span>
  <span class="hljs-attr">partialRender</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">closeAudioContext</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">removeMediaElementOnDestroy</span>: <span class="hljs-literal">true</span>,
  
  <span class="hljs-comment">// 分析器配置</span>
  <span class="hljs-attr">analyserOptions</span>: {
    <span class="hljs-attr">fftSize</span>: <span class="hljs-number">2048</span>,
    <span class="hljs-attr">smoothingTimeConstant</span>: <span class="hljs-number">0.8</span>,
    <span class="hljs-attr">minDecibels</span>: -<span class="hljs-number">100</span>,
    <span class="hljs-attr">maxDecibels</span>: -<span class="hljs-number">30</span>
  },
  
  <span class="hljs-comment">// Canvas配置</span>
  <span class="hljs-attr">drawingContextAttributes</span>: {
    <span class="hljs-attr">alpha</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">desynchronized</span>: <span class="hljs-literal">false</span>
  }
});
</code></pre>
<h2 data-id="heading-15">八、不同场景推荐配置</h2>
<h3 data-id="heading-16">音乐播放器配置</h3>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-attr">height</span>: <span class="hljs-number">150</span>,
  <span class="hljs-attr">waveColor</span>: <span class="hljs-string">'#c1d8ff'</span>,
  <span class="hljs-attr">progressColor</span>: <span class="hljs-string">'#4a7dff'</span>,
  <span class="hljs-attr">cursorColor</span>: <span class="hljs-string">'#1e3a8a'</span>,
  <span class="hljs-attr">barWidth</span>: <span class="hljs-number">3</span>,
  <span class="hljs-attr">barGap</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">barRadius</span>: <span class="hljs-number">4</span>,
  <span class="hljs-attr">normalize</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">audioRate</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">volume</span>: <span class="hljs-number">0.8</span>,
  <span class="hljs-attr">responsive</span>: <span class="hljs-literal">true</span>
}
</code></pre>
<h3 data-id="heading-17">语音分析配置</h3>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-attr">height</span>: <span class="hljs-number">100</span>,
  <span class="hljs-attr">waveColor</span>: <span class="hljs-string">'#f0f0f0'</span>,
  <span class="hljs-attr">progressColor</span>: <span class="hljs-string">'#4CAF50'</span>,
  <span class="hljs-attr">cursorColor</span>: <span class="hljs-string">'#333'</span>,
  <span class="hljs-attr">barWidth</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">barGap</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">normalize</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">minPxPerSec</span>: <span class="hljs-number">100</span>,
  <span class="hljs-attr">splitChannels</span>: <span class="hljs-literal">true</span>
}
</code></pre>
<h3 data-id="heading-18">大文件优化配置</h3>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-attr">partialRender</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">pixelRatio</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">barWidth</span>: <span class="hljs-number">0</span>,
  <span class="hljs-attr">minPxPerSec</span>: <span class="hljs-number">20</span>,
  <span class="hljs-attr">forceDecode</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">xhr</span>: {
    <span class="hljs-attr">cache</span>: <span class="hljs-string">'force-cache'</span>
  }
}
</code></pre>
<h2 data-id="heading-19">九、注意事项</h2>
<ol>
<li><strong>必填参数</strong>：<code>container</code> 是唯一必须提供的参数</li>
<li><strong>后端选择</strong>：<code>backend</code> 默认为 'WebAudio'，支持更多功能</li>
<li><strong>响应式</strong>：<code>responsive</code> 和 <code>fillParent</code> 通常一起使用</li>
<li><strong>性能</strong>：大文件建议启用 <code>partialRender</code></li>
<li><strong>兼容性</strong>：确保浏览器支持 Web Audio API</li>
<li><strong>移动端</strong>：在移动设备上适当降低 <code>pixelRatio</code> 以提升性能</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Apache Doris 在小米统一 OLAP 和湖仓一体的实践]]></title>    <link>https://juejin.cn/post/7578902814022746127</link>    <guid>https://juejin.cn/post/7578902814022746127</guid>    <pubDate>2025-12-02T07:47:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578902814022746127" data-draft-id="7578892205290192936" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Apache Doris 在小米统一 OLAP 和湖仓一体的实践"/> <meta itemprop="keywords" content="数据库,程序员,运维"/> <meta itemprop="datePublished" content="2025-12-02T07:47:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SelectDB"/> <meta itemprop="url" content="https://juejin.cn/user/3189021726222904"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Apache Doris 在小米统一 OLAP 和湖仓一体的实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3189021726222904/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SelectDB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T07:47:43.000Z" title="Tue Dec 02 2025 07:47:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>小米早在 2019 年便引入 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdoris.apache.org" target="_blank" title="https://doris.apache.org" ref="nofollow noopener noreferrer">Apache Doris</a> 作为 OLAP 分析型数据库之一，经过五年的技术沉淀，已形成<strong>以 Doris 为核心的分析体系</strong>，并基于 2.1 版本异步物化视图、3.0 版本湖仓一体与存算分离等核心能力优化数据架构。本文将详细介绍小米数据中台基于 Apache Doris 3.0 的查询链路优化、性能提升、资源管理、自动化运维、可观测等一系列应用实践。</p>
</blockquote>
<p>小米集团成立于 2010 年，是一家以智能手机、智能硬件和 IoT 平台为核心的全球领先科技企业，业务遍及全球 100 多个国家和地区。小米构建了全球最大的消费类 IoT 物联网平台，同时持续推进“手机×AIoT”战略。旗下产品涵盖智能手机、电视、笔记本、可穿戴设备及生态链智能产品，并投资孵化众多智能科技企业。</p>
<p>Apache Doris 在小米内部应用广泛，业务涵盖汽车、手机领域（包括手机系统应用与硬件制造）、互联网、线上线下销售与服务、底层平台以及新业务等多个领域，支撑着多样化的数据分析需求。<strong>目前，Doris 集群数量超过 40 个，管理数据规模数 PB，日均查询量达到 5000 万次，资源规模在近一年内增长约 80%，展现出快速发展的态势。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a990b92db31493d8a9a4760b81a8f9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266463&amp;x-signature=fGGavKpw4yYj9XSeL7xMM6wTM0E%3D" alt="Doris 对小米业务线的支持.PNG" loading="lazy"/></p>
<h2 data-id="heading-0">小米数据中台 OLAP 发展与挑战</h2>
<h3 data-id="heading-1">01 架构演变历程</h3>
<p>早期小米技术栈复杂多样，数据湖体系与 OLAP 引擎众多。自 2019 年在小米内部投入应用以来，Apache Doris 逐渐从中脱颖而出，发展成为小米数据架构的核心引擎。</p>
<p><strong>一方面，Apache Doris 整合了内部复杂的 OLAP 分析体系，统一承载起原本由多系统分散提供的查询能力；另一方面，Doris 凭借出色的查询性能与良好的生态兼容，配合 Trino、Spark、Iceberg、Paimon 等完成了从外仓到湖仓一体架构的关键升级。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fc47f90cc4c40daacd0149ce3bb85df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266463&amp;x-signature=cjNJkOXO6pzqsyilkaULeoF1nzk%3D" alt="架构演变历程.png" loading="lazy"/></p>
<p>2022 年起，Doris 在小米内部已形成了较为成熟的应用体系：依托内部发布平台，在物理机上实现集群的自动化部署与运维；同时接入内部监控体系，全面保障 Doris 集群的可观测性与稳定性。</p>
<p>2025 年，我们正式引入了湖仓一体与存算分离能力成熟的 Doris 3.0 稳定版本，与 2.1 版本并行运行，并针对 Doris 3.0 在管理层面进行了重大调整：引入集群编排系统，并基于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.selectdb.com%2Fenterprise%2Fmanagement-guide%2Fwhat-is-doris-manager" target="_blank" title="https://docs.selectdb.com/enterprise/management-guide/what-is-doris-manager" ref="nofollow noopener noreferrer">Doris Manager </a>自主开发了集群管理系统，提供更全面、标准化的运维与可观测性方案。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4bc7f166a58415b897ec47a7af2c988~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266463&amp;x-signature=ObcXkGLTgt6l8RsTu1Iiy6BRauE%3D" alt="架构演变历程-1.PNG" loading="lazy"/></p>
<h3 data-id="heading-2">02 外仓面临的挑战</h3>
<p>小米早期 OLAP 体系中，离线数仓视为“内仓”，而  OLAP 服务则归为“外仓”，内外仓的数据流动依赖 Flink 或 Spark 等数据集成工具。团队主要负责 Doris 集群的部署与日常运维，在此过程中，我们遇到了诸多来自用户和自身的痛点问题，下面将结合业务场景介绍。</p>
<h4 data-id="heading-3">跨系统数据集成</h4>
<p>数据通过 Flink 或 Spark 从离线的内仓抽取至 Doris，形成跨系统数据流动。这种模式带来一系列挑战：</p>
<ul>
<li>数据冗余：同一份数据在多个系统中存储，增加成本；</li>
<li>口径不一致：不同系统处理逻辑差异导致结果偏差；</li>
<li>排查困难：当 BI 看板数据出现差异时，需跨多个系统定位问题；</li>
<li>开发负担重：业务方需自行维护 ETL 链路和多套查询接口。</li>
</ul>
<p>以广告业务为例，其数据链路涉及多个存储系统（如 Iceberg、Druid）和同步任务，分析师需根据查询粒度选择不同系统，心智负担显著。对开发侧而言，需针对不同数据链路进行定制化开发，同时在多个系统上重复建设数据看板，导致开发工作重复、周期长，整体投入成本较高。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e3f63d2568f64516b9afd0b6e6308f27~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266463&amp;x-signature=eUed9SaD5RWLUT59V35VFs94g1A%3D" alt="跨系统数据集成.PNG" loading="lazy"/></p>
<h4 data-id="heading-4">存算一体架构局限</h4>
<p><strong>1、高可用容灾</strong></p>
<p>2023 年海外机房火灾事件暴露了存算一体架构的脆弱性，虽然数据最终恢复，但也促使团队重新审视数据高可用策略。针对 Doris 2.x 的高可用方案，团队曾评估两种路径：</p>
<ul>
<li>主从复制（CCR）：依赖较新版本支持，缺乏生产验证，主备切换复杂，客户端需双连，恢复时间长；</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4049824ee04f4d6c9e240a16d0e8c746~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266463&amp;x-signature=BnnUGOBfQ1xox%2BGVL9cgKnz4ffk%3D" alt="高可用容灾.PNG" loading="lazy"/></p>
<ul>
<li>跨可用区副本分布：通过 Resource Group 将副本分散至不同机房，虽可避免单点故障，但跨机房读写带来性能损耗。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52e3387f7b5947f49e4a3c72d8b132f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266463&amp;x-signature=H5sgo%2BdEFoXYsqd5nl4Wp0Qfpq8%3D" alt="高可用容灾-1.png" loading="lazy"/></p>
<p>最终采用后者作为临时方案，但仍未根本解决成本与可用性之间的矛盾。</p>
<p><strong>2、资源利用率低</strong></p>
<p>物理机部署模式下，构建一个高可用 Doris 集群需要 3 FE + 3 BE，对于中小规模业务而言，此配置远超实际需求，导致资源浪费严重。若为每个小业务独立建集群，将导致集群数量激增，运维压力剧增；若采用共享集群，则面临资源争抢、隔离困难、计费模糊等问题。</p>
<p>直到 Apache Doris 3.0 发布后引入存算分离版本，高可用容灾与资源弹性问题得到解决，下个章节将详细展开介绍。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/358325b51c4f45cf86073cbdab56206b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266463&amp;x-signature=kw2b5GVG7%2FzPnOF%2FTn%2FMusK9PkU%3D" alt="资源利用率低.png" loading="lazy"/></p>
<h4 data-id="heading-5">集群运维效率低</h4>
<p>原有基于物理机的手动部署流程，从申请资源到集群上线通常耗时一周以上。面对快速增长的业务需求，该模式已无法满足敏捷交付要求。</p>
<h2 data-id="heading-6">Apache Doris 3.0 应用实践与突破</h2>
<p>基于上述挑战，Doris 2.0 及早期版本在湖仓一体、存算分离、集群自动化运维等方面仍有不足，而 3.0 存算分离版本带来了诸多升级，经过一段时间的验证，团队规划出 3.0 版本与早期版本并行的升级架构，并在 3.0 版本的基础上对架构设计与使用模式进行了显著优化。</p>
<h3 data-id="heading-7">01 Doris 3.0 核心优势</h3>
<p>首先是 3.0 存算分离的部署模式，其主要依赖计算组进行资源隔离通过将计算层与存储层解耦，BE 节点实现无状态化，依托底层 Kubernetes 支持，可以实现快速弹性伸缩以满足不同体量用户的需求。</p>
<p>同时，Doris 原生支持湖仓查询能力，在存算分离模式下，能够直接访问外部数据湖，有效打通数据孤岛。这一特性不仅显著简化了传统数据链路，也减少了因多层复制带来的数据冗余，真正推动湖仓一体架构的落地实践。</p>
<p>基于此，数据开发平台的整体架构发生变化：Doris 不再局限于传统“外仓”的角色，而是向上演进为统一的查询引擎层，与底层 Iceberg、Paimon 等湖仓格式解耦，直接进行联邦查询，同时利用自身的数据缓存、物化视图等能力对热点数据进行加速，兼顾灵活性与高性能。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1809d114405b4a559bdd5cf85c68c722~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266463&amp;x-signature=XNYNxEwumQGq5%2BajpPBA8SDdueY%3D" alt="Doris 3.0 核心优势.png" loading="lazy"/></p>
<h4 data-id="heading-8">Doris vs Trino 湖仓分析能力对比：全面领先</h4>
<p>在 TPC-DS 1TB 标准测试中，Doris 对比 Trino 在整体查询性能上展现出全面领先的优势。无论是复杂多表关联、聚合分析，还是高并发场景下的响应效率，Doris 均表现出更优的执行速度和资源利用率，平均查询耗时明显更低，尤其适用于对查询性能要求较高的实时分析场景。</p>
<ul>
<li>TPC-DS 1T 测试：Doris 对比 Trino 全面领先</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3751c34bb6574eff8a8d179cc0d02936~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266463&amp;x-signature=A4pGRRzLPLx7igsslQ%2BVpxGLlJo%3D" alt="Doris vs Trino 湖仓分析能力对比.png" loading="lazy"/></p>
<p>在小米内部的数据查询场景，涵盖多表关联、聚合计算、过滤下推等常见操作的实际业务查询中，<strong>Doris 对比 Trino 的数据湖查询效率高 3～5 倍</strong>。</p>
<ul>
<li>内部数据查询场景：Doris 对比 Trino 数据湖查询效率高 3～5 倍</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63eba0d9dce8405aa8c805490cc80f1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266463&amp;x-signature=%2BalB6InW%2F63FF%2B03Meplnt0WPL4%3D" alt="Doris vs Trino 湖仓分析能力对比-1.png" loading="lazy"/></p>
<h3 data-id="heading-9">02 统一查询网关</h3>
<ul>
<li><strong>统一认证鉴权</strong>：在连接层，将不同引擎的权限和认证体系统一提升到网关层，用户通过网关统一查询，无需担心引擎权限问题。</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.selectdb.com%2Fblog%2F209" target="_blank" title="https://www.selectdb.com/blog/209" ref="nofollow noopener noreferrer">SQL 改写</a></strong>：利用 Doris 的 SQL 改写能力，将其提升到网关层，帮助用户在不同引擎间平滑切换，避免因 SQL 语句不兼容导致出错。</li>
<li><strong>连接协议优化</strong>：采用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.selectdb.com%2Fblog%2F220" target="_blank" title="https://www.selectdb.com/blog/220" ref="nofollow noopener noreferrer">Arrow Flight SQL </a>传输协议和 ADBC 连接方式，传输效率较 JDBC 高 10 倍以上，真实业务场景查询耗时减少 36%，Kyuubi 实例内存用量减少 50%，代理层服务的管理效率显著提升。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea706dad05684a998408ca2d129318bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266463&amp;x-signature=j7Tc3BORx%2BAE2RydZQ5R5MPQy0M%3D" alt="统一查询网关.png" loading="lazy"/></p>
<h3 data-id="heading-10">03 数据链路：物化视图上卷代替导入任务</h3>
<p>以广告业务场景为例，面对分钟级明细数据聚合查询较慢的问题，常见方案是将原始明细数据聚合成小时级数据，定期导入 Doris 以提升查询性能。这一过程需开发和维护复杂的调度任务，运维成本较高。</p>
<p>自 Doris 2.1 版本引入<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.selectdb.com%2Fblog%2F1204" target="_blank" title="https://www.selectdb.com/blog/1204" ref="nofollow noopener noreferrer">异步物化视图</a>能力后，只需在 Doris 中声明物化视图定义，系统即可自动完成从外部数据湖（如 Iceberg）增量同步、数据聚合、更新调度等全过程，无需额外开发 ETL 链路，也无需关注底层执行细节，显著降低了开发与运维负担。同时，Doris 支持物化视图改写能力，用户仍可使用原有 SQL 查询原始表，系统会自动识别并将其透明改写为对应的物化视图，实现查询加速。目前该功能基于增量方式实现，主要支持仅追加场景，更新场景仍处于研发状态。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2cddfb14903844329c27bb5136e77ed6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266463&amp;x-signature=cQbNMHJWgNCbDyeZTZ6gwYB80CU%3D" alt="数据链路：物化视图上卷代替导入任务.png" loading="lazy"/></p>
<p>异步物化视图能力的建表语句示例如下：</p>
<pre><code class="hljs language-SQL" lang="SQL"><span class="hljs-keyword">CREATE</span> MATERIALIZED <span class="hljs-keyword">VIEW</span> mv
BUILD DEFERRED
REFRESH INCREMENTAL
<span class="hljs-keyword">ON</span> <span class="hljs-keyword">COMMIT</span>
<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> (<span class="hljs-type">date</span>)
DISTRIBUTED <span class="hljs-keyword">BY</span> RANDOM BUCKETS <span class="hljs-number">4</span>
PROPERTIES (<span class="hljs-string">'replication_num'</span> <span class="hljs-operator">=</span> <span class="hljs-string">'3'</span>) 
<span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> 
  <span class="hljs-type">date</span>, 
  k1<span class="hljs-operator">+</span><span class="hljs-number">1</span> <span class="hljs-keyword">AS</span> k2, 
  <span class="hljs-built_in">SUM</span>(a1) <span class="hljs-keyword">AS</span> a2
<span class="hljs-keyword">FROM</span>
  paimon.data.table
<span class="hljs-keyword">WHERE</span> <span class="hljs-type">date</span> <span class="hljs-operator">&gt;=</span> <span class="hljs-number">20250222</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">1</span>, <span class="hljs-number">2</span>;
</code></pre>
<h3 data-id="heading-11">04 自助化、精细化的资源管理</h3>
<p>为了优化资源管理与运维流程，我们自研了精细的 Doris Manager 集群管理服务，将用户的运维需求转化为自助操作，依托社区开源的 Doris Operator 在 Kubernetes 平台自动完成资源申请与释放，实现快速的集群变更。用户直接通过平台提交资源申请，无需等待平台申请机器、初始化、发布和上线等步骤，以集群扩容为例，交付周期从原先的约一周大幅缩短至分钟级，显著提升了运维响应速度与效率。</p>
<p>同时，通过 Doris Manager 集群自动化注册与发现能力，新集群创建的同时向元数据中心注册 Catalog，可自动被查询网关识别并接入统一访问入口，用户无需额外配置即可通过网关发起 Doris 查询，进一步优化了使用体验。</p>
<p>接入 Kubernetes 后，资源调度更加精细化，最小调度粒度从物理机级别转变为机器核心、内存大小、磁盘容量等维度，能够根据不同业务需求灵活调配资源，提高资源利用率，满足多样化的业务场景。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/774ad21b7dc34483b096d9c2e3df79ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266463&amp;x-signature=Bu0j2u3vRBbHA6I1qEa9ZSXLQ6M%3D" alt="自助化、精细化的资源管理.png" loading="lazy"/></p>
<h3 data-id="heading-12">05 更完善的数据采集与可观测性</h3>
<p>在集群可观测性方面，基于 Kubernetes 的标准化组件，参照 OpenTelemetry 的规范对 Doris 的监控体系进行全面升级。通过 Prometheus 的 ServiceMonitor 机制采集 Doris 各组件的性能指标，为用户提供全面、细粒度性能监控数据。</p>
<p>在日志采集方面，采用自研的 Hera（log tail 组件）实现高效采集，同时，借鉴社区的日志检索场景实践，将 Doris 作为 OpenTelemetry 的存储后端：Doris 自身运行产生的日志经采集后，最终回流并存储至 Doris 内部表中，形成“日志产生-采集-存储-查询”的闭环。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f06a773c3bf46c19110e76f33873c60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266463&amp;x-signature=y%2Fp5pgHWZjPZAxRxHL8ToqdNPv8%3D" alt="更完善的数据采集与可观测性.png" loading="lazy"/></p>
<p>与之前仅支持基础指标采集的 Falcon 体系相比，Hera 架构覆盖了审计日志、监控指标、运行日志、Profiling 结果以及正在完善的分布式 tracing 信息，提供更加全面的综合诊断能力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc94080fcbd54ce290d24a69e06467cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765266463&amp;x-signature=muSrWk1jB64W79j7Tg1ttm%2BC3SM%3D" alt="更完善的数据采集与可观测性-1.png" loading="lazy"/></p>
<h2 data-id="heading-13">后续规划</h2>
<p>感谢 Doris 社区始终保持高效的版本迭代节奏与稳定性打磨，后续我们将基于以下几方面展开工作：</p>
<ul>
<li><strong>完成 Doris 版本收敛工作</strong>：将核心功能并线至 2.1 和 3.0 版本，并统一工具链版本依赖以减少环境差异，最终实现开发迭代效率的显著提升，为后续功能迭代奠定高效基础。</li>
<li><strong>围绕湖仓一体能力进行深度优化</strong>：重点提升湖仓支持的完整性与稳定性，推动 Doris 存算分离架构的大规模落地，同时完善增量计算能力的覆盖范围，以满足复杂场景下的实时数据处理需求。</li>
<li><strong>拓展新场景与 AI 融合方向</strong>：孵化日志、Tracing 等数据存储能力，通过 AI for Doris 提升运维管理效率，并探索 Doris for AI 的反向赋能能力，构建数据平台与智能技术的双向协同生态。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GooglePay: API 文档]]></title>    <link>https://juejin.cn/post/7579436743260274707</link>    <guid>https://juejin.cn/post/7579436743260274707</guid>    <pubDate>2025-12-03T10:19:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579436743260274707" data-draft-id="7579453456018096169" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GooglePay:  API 文档"/> <meta itemprop="keywords" content="Android,Google"/> <meta itemprop="datePublished" content="2025-12-03T10:19:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Nerve"/> <meta itemprop="url" content="https://juejin.cn/user/3438928101639512"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GooglePay:  API 文档
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3438928101639512/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Nerve
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T10:19:58.000Z" title="Wed Dec 03 2025 10:19:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">GooglePay API 文档</h2>
<p>本文档详细介绍了 GooglePay 库的 API 接口、参数说明以及在不同场景下的使用方法。</p>
<h3 data-id="heading-1">1. 初始化 (Initialization)</h3>
<p>在 <code>Application</code> 的 <code>onCreate</code> 方法中初始化 <code>GooglePayClient</code>。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">App</span> : <span class="hljs-type">Application</span>(), GooglePayService {

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onCreate()
        <span class="hljs-comment">// 初始化 GooglePayClient</span>
        GooglePayClient.getInstance()
            .initBillingClient(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>) <span class="hljs-comment">// 传入 Application Context 和 GooglePayService 实现</span>
            .setDebug(<span class="hljs-literal">true</span>) <span class="hljs-comment">// 开启调试模式，输出日志</span>
            .setSubscription(<span class="hljs-literal">false</span>) <span class="hljs-comment">// 是否支持订阅，默认为 false</span>
            .setSubscriptionMode(SubscriptionMode.MultiModal) <span class="hljs-comment">// 设置订阅模式</span>
            .setInterval(<span class="hljs-number">15</span>) <span class="hljs-comment">// 设置自动刷新间隔（秒），默认 15秒</span>
            .registerActivitys(listOf(MainActivity::<span class="hljs-keyword">class</span>.java)) <span class="hljs-comment">// 注册需要触发自动刷新的 Activity</span>
    }

    <span class="hljs-comment">// 实现 GooglePayService 接口的方法...</span>
}
</code></pre>
<h3 data-id="heading-2">2. 核心类与接口</h3>
<h4 data-id="heading-3">2.1 GooglePayClient</h4>
<p><code>GooglePayClient</code> 是库的核心入口，单例模式。</p>
<ul>
<li><strong>getInstance()</strong>: 获取单例实例。</li>
<li><strong>initBillingClient(context: Application, service: GooglePayService)</strong>: 初始化客户端。</li>
<li><strong>setDebug(isDebug: Boolean)</strong>: 设置是否开启调试日志。</li>
<li><strong>setSubscription(isSubscription: Boolean)</strong>: 设置是否支持订阅功能。</li>
<li><strong>setSubscriptionMode(mode: SubscriptionMode)</strong>: 设置订阅模式。</li>
<li><strong>setInterval(interval: Int)</strong>: 设置在指定 Activity <code>onResume</code> 时触发刷新购买状态的最小时间间隔（单位：秒），默认 15 秒。</li>
<li><strong>registerActivitys(activitys: List&lt;Class&gt;)</strong>: 注册需要触发自动刷新的 Activity 类。当这些 Activity <code>onResume</code> 且距离上次刷新超过 <code>interval</code> 时，会自动调用 <code>queryPurchases()</code>。</li>
<li><strong>getPayService()</strong>: 获取具体的支付服务 (<code>OneTimeService</code> 或 <code>SubscriptionService</code>)。</li>
<li><strong>queryPurchases()</strong>: 查询并刷新当前的购买状态（包括一次性商品和订阅）。</li>
<li><strong>isGoogleAvailable(context: Context?)</strong>: 检查 Google Play 服务是否可用。</li>
<li><strong>endConnection()</strong>: 断开 BillingClient 连接。</li>
</ul>
<h4 data-id="heading-4">2.2 GooglePayService</h4>
<p>业务端需要实现的接口，用于提供商品 ID 和处理购买结果。</p>
<ul>
<li><strong>getOneTimeConsumableProducts()</strong>: 返回一次性消耗型商品 ID 列表。</li>
<li><strong>getOneTimeNonConsumableProducts()</strong>: 返回一次性非消耗型商品 ID 列表。</li>
<li><strong>getSubscribeProducts()</strong>: 返回订阅商品 ID 列表。</li>
<li><strong>handlePurchasesProcess(isPay: Boolean, productType: BillingProductType, purchases: Purchase)</strong>: 处理购买交易，验证订单并确认。</li>
</ul>
<h3 data-id="heading-5">3. 支付服务 (Payment Services)</h3>
<p>通过 <code>GooglePayClient.getInstance().getPayService&lt;T&gt;()</code> 获取。</p>
<h4 data-id="heading-6">3.1 OneTimeService (一次性商品服务)</h4>
<p>用于处理消耗型和非消耗型商品。</p>
<ul>
<li><strong>launchBillingFlow(activity: Activity, billingParams: BillingParams)</strong>: 启动支付流程。</li>
<li><strong>queryProductDetails(productIds: List)</strong>: 查询商品详情。</li>
</ul>
<h4 data-id="heading-7">3.2 SubscriptionService (订阅服务)</h4>
<p>用于处理订阅商品。</p>
<ul>
<li><strong>launchBillingFlow(activity: Activity, billingSubsParams: BillingSubsParams)</strong>: 启动订阅支付流程。</li>
<li><strong>querySubsOfferDetails(subsOfferParams: SubsOfferParams)</strong>: 查询订阅商品详情（包括 Offer）。</li>
<li><strong>queryAckSubscribePurchases(productIds: List?)</strong>: 查询当前有效的订阅。</li>
</ul>
<h3 data-id="heading-8">4. 参数说明 (Parameters)</h3>
<h4 data-id="heading-9">4.1 BillingParams (一次性购买参数)</h4>
<p>用于 <code>OneTimeService.launchBillingFlow</code>。</p>

























<table><thead><tr><th align="left">字段</th><th align="left">类型</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><code>accountId</code></td><td align="left">String</td><td align="left">业务方标识用户的唯一 ID (obfuscatedAccountId)</td></tr><tr><td align="left"><code>productId</code></td><td align="left">String</td><td align="left">Google Play 后台配置的商品 ID</td></tr><tr><td align="left"><code>chargeNo</code></td><td align="left">String</td><td align="left">业务方生成的订单号 (obfuscatedProfileId)</td></tr></tbody></table>
<p><strong>构建示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> params = BillingParams.Builder()
    .setAccountId(<span class="hljs-string">"user_123"</span>)
    .setProductId(<span class="hljs-string">"coin_100"</span>)
    .setChargeNo(<span class="hljs-string">"order_abc_456"</span>)
    .build()
</code></pre>
<h4 data-id="heading-10">4.2 BillingSubsParams (订阅购买参数)</h4>
<p>用于 <code>SubscriptionService.launchBillingFlow</code>。</p>






























<table><thead><tr><th align="left">字段</th><th align="left">类型</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><code>accountId</code></td><td align="left">String</td><td align="left">业务方标识用户的唯一 ID</td></tr><tr><td align="left"><code>productId</code></td><td align="left">String</td><td align="left">Google Play 后台配置的订阅商品 ID</td></tr><tr><td align="left"><code>chargeNo</code></td><td align="left">String</td><td align="left">业务方生成的订单号</td></tr><tr><td align="left"><code>offerToken</code></td><td align="left">String</td><td align="left">订阅商品的 Offer Token (从 <code>AppSubscribeDetails</code> 获取)</td></tr></tbody></table>
<h4 data-id="heading-11">4.3 AppBillingResponseCode (响应码)</h4>
<p><code>AppBillingResponseCode</code> 定义了 Google Play Billing API 返回的所有可能的响应码。</p>
















































































<table><thead><tr><th align="left">代码</th><th align="left">常量</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><code>0</code></td><td align="left"><code>OK</code></td><td align="left">请求成功</td></tr><tr><td align="left"><code>-200</code></td><td align="left"><code>FAIL</code></td><td align="left">业务错误</td></tr><tr><td align="left"><code>-3</code></td><td align="left"><code>SERVICE_TIMEOUT</code></td><td align="left">请求超时（已废弃，建议使用 <code>SERVICE_UNAVAILABLE</code>）</td></tr><tr><td align="left"><code>-2</code></td><td align="left"><code>FEATURE_NOT_SUPPORTED</code></td><td align="left">当前设备或 Google Play 不支持该功能（如订阅、商品详情等）</td></tr><tr><td align="left"><code>-1</code></td><td align="left"><code>SERVICE_DISCONNECTED</code></td><td align="left">与 Google Play Billing 服务断开连接，可尝试重新连接</td></tr><tr><td align="left"><code>1</code></td><td align="left"><code>USER_CANCELED</code></td><td align="left">用户在结算流程中主动取消</td></tr><tr><td align="left"><code>2</code></td><td align="left"><code>SERVICE_UNAVAILABLE</code></td><td align="left">网络问题或 Google Play 服务不可用（如正在更新、离线等）</td></tr><tr><td align="left"><code>3</code></td><td align="left"><code>BILLING_UNAVAILABLE</code></td><td align="left">当前设备上不支持 Google Play 结算</td></tr><tr><td align="left"><code>4</code></td><td align="left"><code>ITEM_UNAVAILABLE</code></td><td align="left">商品在当前区域或账户不可用（例如未发布或已下架）</td></tr><tr><td align="left"><code>5</code></td><td align="left"><code>DEVELOPER_ERROR</code></td><td align="left">开发者调用错误（如参数错误、API 调用顺序错误）</td></tr><tr><td align="left"><code>6</code></td><td align="left"><code>ERROR</code></td><td align="left">一般错误（系统内部异常、未知问题等）</td></tr><tr><td align="left"><code>7</code></td><td align="left"><code>ITEM_ALREADY_OWNED</code></td><td align="left">商品已拥有（如未消耗的消耗型商品或已购买的非消耗型商品）</td></tr><tr><td align="left"><code>8</code></td><td align="left"><code>ITEM_NOT_OWNED</code></td><td align="left">操作失败，因为商品未拥有（尝试消耗或确认未拥有的商品）</td></tr><tr><td align="left"><code>12</code></td><td align="left"><code>NETWORK_ERROR</code></td><td align="left">网络错误（新引入，用于明确网络失败场景）</td></tr></tbody></table>
<p><strong>使用示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">when</span> (responseCode) {
    AppBillingResponseCode.OK -&gt; {
        <span class="hljs-comment">// 处理成功</span>
    }
    AppBillingResponseCode.USER_CANCELED -&gt; {
        <span class="hljs-comment">// 用户取消支付</span>
    }
    AppBillingResponseCode.ITEM_ALREADY_OWNED -&gt; {
        <span class="hljs-comment">// 商品已拥有</span>
    }
    AppBillingResponseCode.NETWORK_ERROR -&gt; {
        <span class="hljs-comment">// 网络错误，可以重试</span>
    }
    <span class="hljs-keyword">else</span> -&gt; {
        <span class="hljs-comment">// 处理其他错误</span>
    }
}
</code></pre>
<h4 data-id="heading-12">4.4 AppProductDetails (商品详情模型)</h4>
<p><code>AppProductDetails</code> 表示一次性购买商品（消耗型或非消耗型）的详细信息。</p>



































<table><thead><tr><th align="left">字段</th><th align="left">类型</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><code>productId</code></td><td align="left">String</td><td align="left">商品 ID（例如 <code>com.xx.product.1</code>）</td></tr><tr><td align="left"><code>productName</code></td><td align="left">String</td><td align="left">商品名称</td></tr><tr><td align="left"><code>formattedPrice</code></td><td align="left">String</td><td align="left">格式化后的价格字符串（例如 <code>"€7.99"</code>）</td></tr><tr><td align="left"><code>priceAmountMicros</code></td><td align="left">Long</td><td align="left">以微单位表示的价格（例如价格为 <code>"€7.99"</code> 时，该值为 <code>7990000</code>）</td></tr><tr><td align="left"><code>priceCurrencyCode</code></td><td align="left">String</td><td align="left">货币代码（例如 <code>"EUR"</code>）</td></tr></tbody></table>
<p><strong>查询商品详情示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> oneTimeService = GooglePayClient.getInstance().getPayService&lt;OneTimeService&gt;()

lifecycleScope.launch {
    oneTimeService.queryProductDetails(listOf(<span class="hljs-string">"coin_100"</span>, <span class="hljs-string">"coin_500"</span>)).collect { result -&gt;
        result.onSuccess { productList -&gt;
            productList.forEach { product -&gt;
                Log.d(<span class="hljs-string">"Product"</span>, <span class="hljs-string">"ID: <span class="hljs-subst">${product.productId}</span>"</span>)
                Log.d(<span class="hljs-string">"Product"</span>, <span class="hljs-string">"名称: <span class="hljs-subst">${product.productName}</span>"</span>)
                Log.d(<span class="hljs-string">"Product"</span>, <span class="hljs-string">"价格: <span class="hljs-subst">${product.formattedPrice}</span>"</span>)
                Log.d(<span class="hljs-string">"Product"</span>, <span class="hljs-string">"货币: <span class="hljs-subst">${product.priceCurrencyCode}</span>"</span>)
            }
        }
        result.onFailure { error -&gt;
            Log.e(<span class="hljs-string">"Product"</span>, <span class="hljs-string">"查询失败: <span class="hljs-subst">${error.message}</span>"</span>)
        }
    }
}
</code></pre>
<h4 data-id="heading-13">4.5 AppSubscribeDetails (订阅详情模型)</h4>
<p><code>AppSubscribeDetails</code> 表示订阅商品的详细信息，包括定价阶梯。</p>

























<table><thead><tr><th align="left">字段</th><th align="left">类型</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><code>productId</code></td><td align="left">String</td><td align="left">订阅商品 ID（例如 <code>com.xx.subscription.monthly</code>）</td></tr><tr><td align="left"><code>productName</code></td><td align="left">String</td><td align="left">订阅商品名称</td></tr><tr><td align="left"><code>pricingPhases</code></td><td align="left">List&lt;PricingPhase&gt;</td><td align="left">定价阶梯列表（支持试用期、介绍价格等）</td></tr></tbody></table>
<p><strong>PricingPhase 字段：</strong></p>

























<table><thead><tr><th align="left">字段</th><th align="left">类型</th><th align="left">说明</th></tr></thead><tbody><tr><td align="left"><code>formattedPrice</code></td><td align="left">String</td><td align="left">格式化后的价格字符串（例如 <code>"€7.99"</code>）</td></tr><tr><td align="left"><code>priceAmountMicros</code></td><td align="left">Long</td><td align="left">以微单位表示的价格（例如价格为 <code>"€7.99"</code> 时，该值为 <code>7990000</code>）</td></tr><tr><td align="left"><code>priceCurrencyCode</code></td><td align="left">String</td><td align="left">货币代码（例如 <code>"EUR"</code>）</td></tr></tbody></table>
<p><strong>查询订阅详情示例：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> subscriptionService = GooglePayClient.getInstance().getPayService&lt;SubscriptionService&gt;()

lifecycleScope.launch {
    <span class="hljs-keyword">val</span> params = SubsOfferParams.Builder()
        .setProductIds(listOf(<span class="hljs-string">"monthly_vip"</span>, <span class="hljs-string">"yearly_vip"</span>))
        .build()
    
    subscriptionService.querySubsOfferDetails(params).collect { result -&gt;
        result.onSuccess { subscriptionList -&gt;
            subscriptionList.forEach { subscription -&gt;
                Log.d(<span class="hljs-string">"Subscription"</span>, <span class="hljs-string">"ID: <span class="hljs-subst">${subscription.productId}</span>"</span>)
                Log.d(<span class="hljs-string">"Subscription"</span>, <span class="hljs-string">"名称: <span class="hljs-subst">${subscription.productName}</span>"</span>)
                subscription.pricingPhases.forEach { phase -&gt;
                    Log.d(<span class="hljs-string">"Subscription"</span>, <span class="hljs-string">"阶梯价格: <span class="hljs-subst">${phase.formattedPrice}</span>"</span>)
                }
            }
        }
    }
}
</code></pre>
<h3 data-id="heading-14">5. 支付事件监听 (Payment Event Listening)</h3>
<p><code>GooglePayClient</code> 使用 Kotlin Coroutines 的 <code>SharedFlow</code> 发送支付事件。</p>
<h4 data-id="heading-15">5.1 BillingPayEvent</h4>
<p>支付事件密封类：</p>
<ul>
<li><code>PaySuccessful(purchase: Purchase)</code>: 支付成功。</li>
<li><code>PayFailed(code: Int, message: String)</code>: 支付失败。</li>
<li><code>PayConsumeSuccessful(purchase: Purchase)</code>:  支付并消耗成功。</li>
<li><code>PayConsumeFailed(purchase: Purchase, code: Int, message: String)</code>:  支付成功但消耗失败。</li>
</ul>
<h4 data-id="heading-16">5.2 在 Activity 中使用</h4>
<p>建议在 <code>onCreate</code> 或 <code>onStart</code> 中开始收集事件，使用 <code>lifecycleScope</code> 确保在生命周期结束时自动取消。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
    <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
    
    lifecycleScope.launch {
        <span class="hljs-comment">// 使用 repeatOnLifecycle 确保只在活跃状态下收集</span>
        repeatOnLifecycle(Lifecycle.State.STARTED) {
            GooglePayClient.getInstance().appBillingPayEventFlow.collect { event -&gt;
                <span class="hljs-keyword">when</span> (event) {
                    <span class="hljs-keyword">is</span> BillingPayEvent.PaySuccessful -&gt; {
                        <span class="hljs-comment">// 处理支付成功</span>
                        Log.d(<span class="hljs-string">"Pay"</span>, <span class="hljs-string">"Success: <span class="hljs-subst">${event.purchase}</span>"</span>)
                    }
                    <span class="hljs-keyword">is</span> BillingPayEvent.PayFailed -&gt; {
                        <span class="hljs-comment">// 处理支付失败</span>
                        Log.e(<span class="hljs-string">"Pay"</span>, <span class="hljs-string">"Failed: <span class="hljs-subst">${event.code}</span> - <span class="hljs-subst">${event.message}</span>"</span>)
                    }
                    <span class="hljs-keyword">else</span> -&gt; {
                        <span class="hljs-comment">// 其他状态</span>
                    }
                }
            }
        }
    }
}
</code></pre>
<h4 data-id="heading-17">5.3 在 Dialog 中使用 (手动释放)</h4>
<p>如果在 <code>Dialog</code> 中监听支付结果，需要注意协程作用域的管理。</p>
<ol>
<li><strong>使用 Dialog 所在的 Activity/Fragment 的 lifecycleScope</strong>: 这是最推荐的方式，与 Activity 生命周期绑定，无需手动释放。</li>
<li><strong>使用自定义 Scope</strong>: 如果必须在 Dialog 内部管理，需要在 <code>dismiss</code> 时取消 Job。</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PayDialog</span>(context: Context) : Dialog(context) {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> dialogScope = CoroutineScope(Dispatchers.Main + SupervisorJob())

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">show</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.show()
        dialogScope.launch {
            GooglePayClient.getInstance().appBillingPayEventFlow.collect { event -&gt;
                <span class="hljs-comment">// 处理事件</span>
                <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">is</span> BillingPayEvent.PaySuccessful) {
                    dismiss()
                }
            }
        }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dismiss</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.dismiss()
        <span class="hljs-comment">// 必须手动取消，防止内存泄漏</span>
        dialogScope.cancel()
    }
}
</code></pre>
<h3 data-id="heading-18">6. 其他注意事项</h3>
<ol>
<li><strong>生命周期</strong>: <code>GooglePayClient</code> 内部处理了 Activity 的生命周期感知，但事件监听需要调用者自行管理 Scope。</li>
<li><strong>消耗</strong>: 对于一次性消耗型商品，库会自动进行消耗操作 (<code>consumeAsync</code>)。</li>
<li><strong>确认</strong>: 所有购买（包括订阅）都需要确认 (<code>acknowledgePurchase</code>)，这部分逻辑在 <code>GooglePayService.handlePurchasesProcess</code> 中由业务层触发或库内部处理（具体取决于 <code>handlePurchases</code> 的实现，库默认会自动处理消耗，但确认逻辑通常需要业务端配合验证后调用）。</li>
</ol>
<h3 data-id="heading-19">相关文档</h3>
<ul>
<li><a href="https://juejin.cn/post/7579450578293293098" target="_blank" title="https://juejin.cn/post/7579450578293293098">GooglePay</a></li>
<li><a href="https://juejin.cn/post/7579438351297740836" target="_blank" title="https://juejin.cn/post/7579438351297740836">GooglePay 消耗商品购买流程</a></li>
<li><a href="https://juejin.cn/post/7579450578293555242" target="_blank" title="https://juejin.cn/post/7579450578293555242">GooglePay 订阅商品购买流程</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.android.com%2Fgoogle%2Fplay%2Fbilling%2Fsubscriptions" target="_blank" title="https://developer.android.com/google/play/billing/subscriptions" ref="nofollow noopener noreferrer">Google Play Billing 官方文档</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kotlin 协程中Job和SupervisorJob —— 新手指南]]></title>    <link>https://juejin.cn/post/7578780780026855433</link>    <guid>https://juejin.cn/post/7578780780026855433</guid>    <pubDate>2025-12-02T03:03:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578780780026855433" data-draft-id="7578709098256400422" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kotlin 协程中Job和SupervisorJob —— 新手指南"/> <meta itemprop="keywords" content="Kotlin,Android,Android Jetpack"/> <meta itemprop="datePublished" content="2025-12-02T03:03:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QING618"/> <meta itemprop="url" content="https://juejin.cn/user/339115460529117"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kotlin 协程中Job和SupervisorJob —— 新手指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/339115460529117/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QING618
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T03:03:49.000Z" title="Tue Dec 02 2025 03:03:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Kotlin：协程为管理异步操作提供了强大的工具，而<code>Job</code>和<code>SupervisorJob</code>正是这个系统的核心。理解这些概念对于构建健壮、容错的应用程序至关重要。本文将从它们的区别、使用场景和最佳实践进行讲解。</h2>
<h2 data-id="heading-1">一、概念</h2>
<h4 data-id="heading-2">什么是Job？</h4>
<p><code>Job</code>是一个具有生命周期的可取消任务。每个协程都有一个关联的Job，用于控制其执行。</p>
<p>你可以把Job看作是协程的句柄，它允许你：</p>
<ul>
<li>取消协程</li>
<li>等待其完成</li>
<li>检查其状态（活跃、完成、取消）</li>
<li>建立父子关系</li>
</ul>
<h4 data-id="heading-3">什么是SupervisorJob？</h4>
<p><code>SupervisorJob</code>是一种特殊类型的Job，它改变了取消行为。</p>
<p>使用SupervisorJob时：</p>
<ul>
<li><strong>子Job失败不会向上传播:</strong>  失败的子Job不会取消父Job</li>
<li><strong>向下传播仍然有效:</strong>   取消父Job仍然会取消子Job</li>
<li><strong>兄弟Job相互独立：</strong>  一个子Job的失败不会影响兄弟Job</li>
</ul>
<h2 data-id="heading-4">二、 Job生命周期状态</h2>
<ul>
<li><strong>新建</strong> — Job已创建但尚未启动（仅适用于惰性协程）</li>
<li><strong>活跃</strong> — Job正在运行</li>
<li><strong>完成中</strong> — Job正在完成但等待子Job</li>
<li><strong>已完成</strong> — Job成功完成</li>
<li><strong>取消中</strong> — Job正在被取消</li>
<li><strong>已取消</strong> — Job已被取消</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/302e662c76544fec8c6f97ffd75987ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUUlORzYxOA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765249839&amp;x-signature=2oRwgObiMjZF1yIWiRUbL8xk8vE%3D" alt="deepseek_mermaid_20251202_892c7b.png" loading="lazy"/></p>
<h2 data-id="heading-5">三、Job状态详细说明及示例</h2>
<h4 data-id="heading-6">1. New (新建)</h4>
<ul>
<li>刚刚创建但还未启动的 Job</li>
<li>需要通过 <code>start()</code> 或 <code>launch</code> 启动</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> job = Job()  <span class="hljs-comment">// 创建后处于 New 状态</span>
job.start()      <span class="hljs-comment">// 启动后变为 Active</span>
</code></pre>
<h4 data-id="heading-7">2. Active (活跃)</h4>
<ul>
<li>Job 正在运行</li>
<li>可以创建子协程</li>
<li>属性状态：
<ul>
<li><code>isActive = true</code></li>
<li><code>isCompleted = false</code></li>
<li><code>isCancelled = false</code></li>
</ul>
</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> job = launch {
    <span class="hljs-comment">// 协程体执行中 - Active 状态</span>
    delay(<span class="hljs-number">1000</span>)
    println(<span class="hljs-string">"Done"</span>)
}
</code></pre>
<h4 data-id="heading-8">3. Completing (完成中)</h4>
<ul>
<li>协程体已执行完毕</li>
<li>正在等待所有子协程完成</li>
<li>属性状态：
<ul>
<li><code>isActive = false</code></li>
<li><code>isCompleted = false</code> (还有子协程未完成)</li>
</ul>
</li>
</ul>
<h4 data-id="heading-9">4. Completed (已完成)</h4>
<ul>
<li>协程及其所有子协程都已正常完成</li>
<li>属性状态：
<ul>
<li><code>isActive = false</code></li>
<li><code>isCompleted = true</code></li>
<li><code>isCancelled = false</code></li>
</ul>
</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> job = launch {
    <span class="hljs-comment">// 正常执行完成</span>
}
job.join()  <span class="hljs-comment">// 等待进入 Completed 状态</span>
</code></pre>
<h4 data-id="heading-10">5. Cancelling (取消中)</h4>
<ul>
<li>收到取消请求，正在执行取消操作</li>
<li>可能还在执行 <code>finally</code> 块或挂起函数</li>
<li>属性状态：
<ul>
<li><code>isActive = false</code></li>
<li><code>isCancelled = true</code></li>
</ul>
</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> job = launch {
    <span class="hljs-keyword">try</span> {
        delay(<span class="hljs-number">10000</span>)
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-comment">// 进入 Cancelling 状态</span>
        delay(<span class="hljs-number">1000</span>)  <span class="hljs-comment">// 仍可执行挂起函数</span>
    }
}
delay(<span class="hljs-number">100</span>)
job.cancel()  <span class="hljs-comment">// 触发 Cancelling 状态</span>
</code></pre>
<h4 data-id="heading-11">6. Cancelled (已取消)</h4>
<ul>
<li>取消操作已完成</li>
<li>属性状态：
<ul>
<li><code>isActive = false</code></li>
<li><code>isCompleted = true</code> (注意：已取消也被视为完成)</li>
<li><code>isCancelled = true</code></li>
</ul>
</li>
</ul>
<h4 data-id="heading-12">7. 状态检查方法</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> job = launch {
    <span class="hljs-comment">// 协程体</span>
}

<span class="hljs-comment">// 检查状态</span>
println(<span class="hljs-string">"isActive: <span class="hljs-subst">${job.isActive}</span>"</span>)      <span class="hljs-comment">// 是否活跃</span>
println(<span class="hljs-string">"isCompleted: <span class="hljs-subst">${job.isCompleted}</span>"</span>) <span class="hljs-comment">// 是否完成</span>
println(<span class="hljs-string">"isCancelled: <span class="hljs-subst">${job.isCancelled}</span>"</span>) <span class="hljs-comment">// 是否取消</span>

<span class="hljs-comment">// 等待完成</span>
job.join()

<span class="hljs-comment">// 取消 Job</span>
job.cancel()

<span class="hljs-comment">// 取消并等待完成</span>
job.cancelAndJoin()
</code></pre>
<h4 data-id="heading-13">8. 状态转换示例</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> job = launch {
        println(<span class="hljs-string">"1. Job started - Active"</span>)
        <span class="hljs-keyword">try</span> {
            delay(<span class="hljs-number">2000</span>)
            println(<span class="hljs-string">"2. Normal completion - Completing → Completed"</span>)
        } <span class="hljs-keyword">finally</span> {
            println(<span class="hljs-string">"3. Finally block - Cancelling"</span>)
            delay(<span class="hljs-number">500</span>)  <span class="hljs-comment">// 在取消中仍可挂起</span>
        }
    }
    
    delay(<span class="hljs-number">500</span>)
    job.cancel()  <span class="hljs-comment">// Active → Cancelling</span>
    job.join()    <span class="hljs-comment">// 等待进入 Cancelled</span>
    println(<span class="hljs-string">"4. Final state: isCancelled=<span class="hljs-subst">${job.isCancelled}</span>"</span>)
}
</code></pre>
<h2 data-id="heading-14">四、Job重要注意事项</h2>
<h4 data-id="heading-15">1. Completed 和 Cancelled 都是完成状态</h4>
<ul>
<li><code>isCompleted = true</code> 表示两者</li>
<li>需要用 <code>isCancelled</code> 区分</li>
</ul>
<h4 data-id="heading-16">2. 状态检查是瞬时的</h4>
<ul>
<li>状态可能在你检查后立即改变</li>
</ul>
<h4 data-id="heading-17">3.  父子关系影响状态</h4>
<ul>
<li>父 Job 取消会导致所有子 Job 取消</li>
<li>父 Job 等待所有子 Job 完成才能进入 Completed</li>
</ul>
<h4 data-id="heading-18">4.  结构化并发</h4>
<ul>
<li>父协程的作用域取消会传播到所有子协程</li>
<li>父协程会等待所有子协程完成</li>
</ul>
<h2 data-id="heading-19">五、SupervisorJob基础示例</h2>
<h4 data-id="heading-20">1. 失败不会传播</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> supervisorJob = SupervisorJob()  <span class="hljs-comment">// SupervisorJob</span>
    
    launch(supervisorJob) {
        println(<span class="hljs-string">"Child 1 starts"</span>)
        delay(<span class="hljs-number">100</span>)
        <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"Child 1 failed!"</span>)
    }
    
    launch(supervisorJob) {
        println(<span class="hljs-string">"Child 2 starts"</span>)
        delay(<span class="hljs-number">200</span>)
        println(<span class="hljs-string">"Child 2 completed"</span>)  <span class="hljs-comment">// 这个会正常执行</span>
    }
    
    delay(<span class="hljs-number">300</span>)
    println(<span class="hljs-string">"Supervisor is alive: <span class="hljs-subst">${supervisorJob.isActive}</span>"</span>)  <span class="hljs-comment">// true</span>
    println(<span class="hljs-string">"Supervisor children active: <span class="hljs-subst">${supervisorJob.children.count { it.isActive }</span>}"</span>)
}
</code></pre>
<h4 data-id="heading-21">2. 推荐使用 <code>supervisorScope</code> 构建器</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    supervisorScope {
        <span class="hljs-keyword">val</span> child1 = launch {
            println(<span class="hljs-string">"Task 1 started"</span>)
            delay(<span class="hljs-number">500</span>)
            <span class="hljs-keyword">throw</span> ArithmeticException(<span class="hljs-string">"Task 1 calculation error!"</span>)
        }
        
        <span class="hljs-keyword">val</span> child2 = launch {
            println(<span class="hljs-string">"Task 2 started"</span>)
            delay(<span class="hljs-number">1000</span>)
            println(<span class="hljs-string">"Task 2 completed successfully"</span>)
        }
        
        <span class="hljs-keyword">val</span> child3 = launch {
            println(<span class="hljs-string">"Task 3 started"</span>)
            delay(<span class="hljs-number">1500</span>)
            println(<span class="hljs-string">"Task 3 completed successfully"</span>)
        }
        
        <span class="hljs-comment">// 处理各个子协程的结果</span>
        child1.join()  <span class="hljs-comment">// 会抛出异常</span>
        println(<span class="hljs-string">"Child1 joined, isCancelled: <span class="hljs-subst">${child1.isCancelled}</span>"</span>)
        
        child2.join()  <span class="hljs-comment">// 正常完成</span>
        println(<span class="hljs-string">"Child2 joined, isCompleted: <span class="hljs-subst">${child2.isCompleted}</span>"</span>)
        
        child3.join()  <span class="hljs-comment">// 正常完成</span>
        println(<span class="hljs-string">"All tasks processed"</span>)
    }
    
    println(<span class="hljs-string">"SupervisorScope completed"</span>)
}
</code></pre>
<h2 data-id="heading-22">六、SupervisorJob实际应用场景</h2>
<h4 data-id="heading-23">1. 并行下载多个文件</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-keyword">class</span> <span class="hljs-title class_">FileDownloader</span> {
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">downloadFiles</span><span class="hljs-params">(urls: <span class="hljs-type">List</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> = supervisorScope {
        <span class="hljs-keyword">val</span> downloadJobs = urls.map { url -&gt;
            async {
                <span class="hljs-keyword">try</span> {
                    println(<span class="hljs-string">"Downloading <span class="hljs-variable">$url</span>"</span>)
                    delay((<span class="hljs-number">100.</span><span class="hljs-number">.500</span>).random().toLong())  <span class="hljs-comment">// 模拟下载</span>
                    <span class="hljs-keyword">if</span> (url.contains(<span class="hljs-string">"error"</span>)) {
                        <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">"Failed to download <span class="hljs-variable">$url</span>"</span>)
                    }
                    <span class="hljs-string">"Content of <span class="hljs-variable">$url</span>"</span>
                } <span class="hljs-keyword">catch</span> (e: Exception) {
                    println(<span class="hljs-string">"Error downloading <span class="hljs-variable">$url</span>: <span class="hljs-subst">${e.message}</span>"</span>)
                    <span class="hljs-literal">null</span>  <span class="hljs-comment">// 返回 null 表示失败</span>
                }
            }
        }
        
        <span class="hljs-comment">// 收集所有结果（包括失败的）</span>
        <span class="hljs-keyword">val</span> results = downloadJobs.map { it.await() }
        results.filterNotNull()  <span class="hljs-comment">// 返回成功下载的内容</span>
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> downloader = FileDownloader()
    <span class="hljs-keyword">val</span> urls = listOf(
        <span class="hljs-string">"http://example.com/file1.txt"</span>,
        <span class="hljs-string">"http://example.com/file2-error.txt"</span>,  <span class="hljs-comment">// 这个会失败</span>
        <span class="hljs-string">"http://example.com/file3.txt"</span>,
        <span class="hljs-string">"http://example.com/file4-error.txt"</span>   <span class="hljs-comment">// 这个也会失败</span>
    )
    
    <span class="hljs-keyword">val</span> successfulDownloads = downloader.downloadFiles(urls)
    println(<span class="hljs-string">"Successfully downloaded <span class="hljs-subst">${successfulDownloads.size}</span> files"</span>)
}
</code></pre>
<h4 data-id="heading-24">2. 微服务健康检查</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*
<span class="hljs-keyword">import</span> java.time.LocalDateTime

<span class="hljs-keyword">class</span> <span class="hljs-title class_">HealthChecker</span> {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceStatus</span>(
        <span class="hljs-keyword">val</span> name: String,
        <span class="hljs-keyword">val</span> isHealthy: <span class="hljs-built_in">Boolean</span>,
        <span class="hljs-keyword">val</span> responseTime: <span class="hljs-built_in">Long</span>,
        <span class="hljs-keyword">val</span> error: String? = <span class="hljs-literal">null</span>
    )
    
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkAllServices</span><span class="hljs-params">()</span></span> = supervisorScope {
        <span class="hljs-keyword">val</span> services = listOf(
            <span class="hljs-string">"auth-service"</span> to <span class="hljs-string">"http://auth:8080/health"</span>,
            <span class="hljs-string">"payment-service"</span> to <span class="hljs-string">"http://payment:8080/health"</span>,
            <span class="hljs-string">"notification-service"</span> to <span class="hljs-string">"http://notification:8080/health"</span>,
            <span class="hljs-string">"database"</span> to <span class="hljs-string">"http://db:5432/health"</span>
        )
        
        services.map { (name, url) -&gt;
            async {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">val</span> startTime = System.currentTimeMillis()
                    <span class="hljs-comment">// 模拟健康检查请求</span>
                    delay((<span class="hljs-number">50.</span><span class="hljs-number">.500</span>).random().toLong())
                    
                    <span class="hljs-comment">// 模拟随机失败</span>
                    <span class="hljs-keyword">if</span> (Math.random() &lt; <span class="hljs-number">0.3</span>) {
                        <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">"<span class="hljs-variable">$name</span> timeout"</span>)
                    }
                    
                    <span class="hljs-keyword">val</span> responseTime = System.currentTimeMillis() - startTime
                    ServiceStatus(name, isHealthy = <span class="hljs-literal">true</span>, responseTime)
                } <span class="hljs-keyword">catch</span> (e: Exception) {
                    ServiceStatus(name, isHealthy = <span class="hljs-literal">false</span>, <span class="hljs-number">0</span>, e.message)
                }
            }
        }.map { it.await() }
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> checker = HealthChecker()
    
    repeat(<span class="hljs-number">3</span>) { checkNumber -&gt;
        println(<span class="hljs-string">"\n=== Health Check #<span class="hljs-subst">${checkNumber + <span class="hljs-number">1</span>}</span> ==="</span>)
        <span class="hljs-keyword">val</span> results = checker.checkAllServices()
        
        results.forEach { status -&gt;
            <span class="hljs-keyword">val</span> statusIcon = <span class="hljs-keyword">if</span> (status.isHealthy) <span class="hljs-string">"✅"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"❌"</span>
            println(<span class="hljs-string">"<span class="hljs-variable">$statusIcon</span> <span class="hljs-subst">${status.name}</span>: "</span> +
                   <span class="hljs-keyword">if</span> (status.isHealthy) <span class="hljs-string">"<span class="hljs-subst">${status.responseTime}</span>ms"</span> 
                   <span class="hljs-keyword">else</span> <span class="hljs-string">"ERROR: <span class="hljs-subst">${status.error}</span>"</span>)
        }
        
        <span class="hljs-keyword">val</span> healthyCount = results.count { it.isHealthy }
        println(<span class="hljs-string">"\nSummary: <span class="hljs-variable">$healthyCount</span>/<span class="hljs-subst">${results.size}</span> services healthy"</span>)
        
        delay(<span class="hljs-number">2000</span>)
    }
}
</code></pre>
<h4 data-id="heading-25">3. UI 应用中的并行任务</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDashboardViewModel</span> {
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadDashboardData</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span>: DashboardData = supervisorScope {
        <span class="hljs-comment">// 并行加载各种数据</span>
        <span class="hljs-keyword">val</span> userProfile = async { 
            loadUserProfile(userId) 
        }
        
        <span class="hljs-keyword">val</span> recentOrders = async { 
            loadRecentOrders(userId) 
        }
        
        <span class="hljs-keyword">val</span> notifications = async { 
            loadNotifications(userId) 
        }
        
        <span class="hljs-keyword">val</span> recommendations = async { 
            <span class="hljs-keyword">try</span> {
                loadRecommendations(userId)
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                <span class="hljs-comment">// 推荐失败不影响其他数据</span>
                emptyList&lt;Recommendation&gt;()
            }
        }
        
        <span class="hljs-comment">// 等待所有请求完成</span>
        DashboardData(
            profile = userProfile.await(),
            orders = recentOrders.await(),
            notifications = notifications.await(),
            recommendations = recommendations.await()
        )
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadUserProfile</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span>: UserProfile {
        delay(<span class="hljs-number">300</span>)
        <span class="hljs-keyword">return</span> UserProfile(<span class="hljs-string">"User <span class="hljs-variable">$userId</span>"</span>)
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadRecentOrders</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span>: List&lt;Order&gt; {
        delay(<span class="hljs-number">400</span>)
        <span class="hljs-keyword">return</span> listOf(Order(<span class="hljs-string">"Order1"</span>), Order(<span class="hljs-string">"Order2"</span>))
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadNotifications</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span>: List&lt;Notification&gt; {
        delay(<span class="hljs-number">200</span>)
        <span class="hljs-keyword">if</span> (Math.random() &lt; <span class="hljs-number">0.2</span>) <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">"Notification service down"</span>)
        <span class="hljs-keyword">return</span> listOf(Notification(<span class="hljs-string">"New message"</span>))
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadRecommendations</span><span class="hljs-params">(userId: <span class="hljs-type">String</span>)</span></span>: List&lt;Recommendation&gt; {
        delay(<span class="hljs-number">500</span>)
        <span class="hljs-keyword">if</span> (Math.random() &lt; <span class="hljs-number">0.3</span>) <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">"Recommendation engine error"</span>)
        <span class="hljs-keyword">return</span> listOf(Recommendation(<span class="hljs-string">"Item 1"</span>), Recommendation(<span class="hljs-string">"Item 2"</span>))
    }
    
    <span class="hljs-comment">// 数据类</span>
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DashboardData</span>(
        <span class="hljs-keyword">val</span> profile: UserProfile,
        <span class="hljs-keyword">val</span> orders: List&lt;Order&gt;,
        <span class="hljs-keyword">val</span> notifications: List&lt;Notification&gt;,
        <span class="hljs-keyword">val</span> recommendations: List&lt;Recommendation&gt;
    )
    
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserProfile</span>(<span class="hljs-keyword">val</span> name: String)
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span>(<span class="hljs-keyword">val</span> id: String)
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Notification</span>(<span class="hljs-keyword">val</span> message: String)
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Recommendation</span>(<span class="hljs-keyword">val</span> item: String)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> viewModel = UserDashboardViewModel()
    
    repeat(<span class="hljs-number">5</span>) {
        <span class="hljs-keyword">try</span> {
            println(<span class="hljs-string">"\nLoading dashboard..."</span>)
            <span class="hljs-keyword">val</span> dashboard = viewModel.loadDashboardData(<span class="hljs-string">"user123"</span>)
            println(<span class="hljs-string">"Dashboard loaded successfully:"</span>)
            println(<span class="hljs-string">"- Profile: <span class="hljs-subst">${dashboard.profile.name}</span>"</span>)
            println(<span class="hljs-string">"- Orders: <span class="hljs-subst">${dashboard.orders.size}</span>"</span>)
            println(<span class="hljs-string">"- Notifications: <span class="hljs-subst">${dashboard.notifications.size}</span>"</span>)
            println(<span class="hljs-string">"- Recommendations: <span class="hljs-subst">${dashboard.recommendations.size}</span>"</span>)
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            println(<span class="hljs-string">"Critical error loading dashboard: <span class="hljs-subst">${e.message}</span>"</span>)
        }
        delay(<span class="hljs-number">1000</span>)
    }
}
</code></pre>
<h2 data-id="heading-26">七、SupervisorJob高级用法：自定义错误处理</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.*

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ResilientTaskManager</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> supervisorJob = SupervisorJob()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> scope = CoroutineScope(Dispatchers.IO + supervisorJob)
    
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TaskResult</span>(<span class="hljs-keyword">val</span> id: String, <span class="hljs-keyword">val</span> success: <span class="hljs-built_in">Boolean</span>, <span class="hljs-keyword">val</span> value: Any? = <span class="hljs-literal">null</span>, <span class="hljs-keyword">val</span> error: String? = <span class="hljs-literal">null</span>)
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">submitTask</span><span class="hljs-params">(taskId: <span class="hljs-type">String</span>, task: <span class="hljs-type">suspend</span> () -&gt; <span class="hljs-type">Any</span>)</span></span> {
        scope.launch {
            <span class="hljs-keyword">try</span> {
                println(<span class="hljs-string">"[<span class="hljs-variable">$taskId</span>] Starting task"</span>)
                <span class="hljs-keyword">val</span> result = task()
                println(<span class="hljs-string">"[<span class="hljs-variable">$taskId</span>] Task completed successfully"</span>)
                onTaskCompleted(TaskResult(taskId, <span class="hljs-literal">true</span>, result))
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                println(<span class="hljs-string">"[<span class="hljs-variable">$taskId</span>] Task failed: <span class="hljs-subst">${e.message}</span>"</span>)
                onTaskCompleted(TaskResult(taskId, <span class="hljs-literal">false</span>, error = e.message))
                <span class="hljs-comment">// 失败的任务可以在这里重试</span>
                <span class="hljs-keyword">if</span> (shouldRetry(taskId)) {
                    delay(<span class="hljs-number">1000</span>)
                    println(<span class="hljs-string">"[<span class="hljs-variable">$taskId</span>] Retrying..."</span>)
                    submitTask(<span class="hljs-string">"<span class="hljs-variable">$taskId</span>-retry"</span>, task)
                }
            }
        }
    }
    
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">shutdown</span><span class="hljs-params">(timeoutMillis: <span class="hljs-type">Long</span> = <span class="hljs-number">5000</span>)</span></span> {
        scope.cancel()
        <span class="hljs-keyword">try</span> {
            withTimeout(timeoutMillis) {
                supervisorJob.join()
            }
            println(<span class="hljs-string">"All tasks completed gracefully"</span>)
        } <span class="hljs-keyword">catch</span> (e: TimeoutCancellationException) {
            println(<span class="hljs-string">"Some tasks did not complete in time"</span>)
        }
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onTaskCompleted</span><span class="hljs-params">(result: <span class="hljs-type">TaskResult</span>)</span></span> {
        <span class="hljs-comment">// 处理任务完成事件</span>
        println(<span class="hljs-string">"Task <span class="hljs-subst">${result.id}</span>: <span class="hljs-subst">${if (result.success) <span class="hljs-string">"SUCCESS"</span> else <span class="hljs-string">"FAILED"</span>}</span>"</span>)
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">shouldRetry</span><span class="hljs-params">(taskId: <span class="hljs-type">String</span>)</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> !taskId.contains(<span class="hljs-string">"no-retry"</span>)
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> manager = ResilientTaskManager()
    
    <span class="hljs-comment">// 提交多个任务</span>
    manager.submitTask(<span class="hljs-string">"task-1"</span>) {
        delay(<span class="hljs-number">1000</span>)
        <span class="hljs-string">"Result 1"</span>
    }
    
    manager.submitTask(<span class="hljs-string">"task-2-error"</span>) {
        delay(<span class="hljs-number">500</span>)
        <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"Simulated error in task 2"</span>)
    }
    
    manager.submitTask(<span class="hljs-string">"task-3-no-retry"</span>) {
        delay(<span class="hljs-number">800</span>)
        <span class="hljs-keyword">throw</span> RuntimeException(<span class="hljs-string">"Fatal error - no retry"</span>)
    }
    
    manager.submitTask(<span class="hljs-string">"task-4"</span>) {
        delay(<span class="hljs-number">1200</span>)
        <span class="hljs-string">"Result 4"</span>
    }
    
    <span class="hljs-comment">// 等待所有任务完成</span>
    delay(<span class="hljs-number">3000</span>)
    manager.shutdown()
}
</code></pre>
<h2 data-id="heading-27">八、SupervisorJob 重要注意事项</h2>
<h4 data-id="heading-28">1. 错误处理</h4>
<pre><code class="hljs language-kotlin" lang="kotlin">supervisorScope {
    <span class="hljs-keyword">val</span> child = launch {
        <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">"Child failed"</span>)
    }
    
    <span class="hljs-comment">// 必须显式处理子协程异常</span>
    <span class="hljs-keyword">try</span> {
        child.join()
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        println(<span class="hljs-string">"Caught child exception: <span class="hljs-subst">${e.message}</span>"</span>)
    }
}
</code></pre>
<h4 data-id="heading-29">2. 与 CoroutineExceptionHandler 配合</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> handler = CoroutineExceptionHandler { _, exception -&gt;
    println(<span class="hljs-string">"Uncaught exception: <span class="hljs-subst">${exception.message}</span>"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> = runBlocking {
    <span class="hljs-keyword">val</span> supervisor = SupervisorJob()
    <span class="hljs-keyword">val</span> scope = CoroutineScope(Dispatchers.Default + supervisor + handler)
    
    scope.launch {
        <span class="hljs-keyword">throw</span> Exception(<span class="hljs-string">"This will be caught by handler"</span>)
    }
    
    scope.launch {
        delay(<span class="hljs-number">1000</span>)
        println(<span class="hljs-string">"I'm still running!"</span>)
    }
    
    delay(<span class="hljs-number">2000</span>)
    supervisor.cancel()
}
</code></pre>
<h4 data-id="heading-30">3. 限制并发数</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> kotlinx.coroutines.sync.Semaphore

<span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">limitedParallelTasks</span><span class="hljs-params">(tasks: <span class="hljs-type">List</span>&lt;<span class="hljs-type">suspend</span> () -&gt; <span class="hljs-type">Unit</span>&gt;, maxConcurrent: <span class="hljs-type">Int</span> = <span class="hljs-number">3</span>)</span></span> {
    <span class="hljs-keyword">val</span> semaphore = Semaphore(maxConcurrent)
    
    supervisorScope {
        tasks.map { task -&gt;
            launch {
                semaphore.withPermit {
                    task()
                }
            }
        }.forEach { it.join() }
    }
}
</code></pre>
<h2 data-id="heading-31">九、SupervisorJob总结</h2>
<p><strong>SupervisorJob 的主要使用场景：</strong></p>
<ol>
<li>需要独立执行多个任务的场景</li>
<li>一个任务的失败不应影响其他任务</li>
<li>UI 应用中并行加载多个数据源</li>
<li>批量处理任务，允许部分失败</li>
<li>微服务架构中的健康检查、监控等</li>
</ol>
<p><strong>关键点：</strong></p>
<ul>
<li>使用 <code>supervisorScope</code> 或 <code>SupervisorJob()</code> 创建</li>
<li>子协程异常需要显式处理</li>
<li>配合 <code>CoroutineExceptionHandler</code> 进行全局错误处理</li>
<li>注意资源清理和超时控制</li>
</ul>
<p>通过 SupervisorJob，你可以构建更健壮、容错性更好的并发应用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[线程池拒绝策略为何不一致？项目实战中的决策逻辑与踩坑指南]]></title>    <link>https://juejin.cn/post/7578724773993824282</link>    <guid>https://juejin.cn/post/7578724773993824282</guid>    <pubDate>2025-12-02T01:21:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578724773993824282" data-draft-id="7578714735308423194" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="线程池拒绝策略为何不一致？项目实战中的决策逻辑与踩坑指南"/> <meta itemprop="keywords" content="后端,分布式"/> <meta itemprop="datePublished" content="2025-12-02T01:21:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="回家路上绕了弯"/> <meta itemprop="url" content="https://juejin.cn/user/536217404587134"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            线程池拒绝策略为何不一致？项目实战中的决策逻辑与踩坑指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/536217404587134/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    回家路上绕了弯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T01:21:10.000Z" title="Tue Dec 02 2025 01:21:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    13
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">线程池拒绝策略为何不一致？项目实战中的决策逻辑与踩坑指南</h2>
<p>在后端项目中，线程池是处理异步任务的核心组件 —— 从订单支付、库存扣减到日志记录、数据统计，几乎都依赖线程池提升并发能力。但很多开发者会忽略一个关键细节：<strong>不同业务场景的线程池，拒绝策略必须差异化选择</strong>。</p>
<p>我曾在电商项目中踩过典型的坑：用默认的AbortPolicy（直接抛异常）处理订单支付线程池，导致大促高峰期大量 “支付成功但订单未处理” 的异常；又曾为日志线程池选了CallerRunsPolicy（调用方执行），结果日志队列满时阻塞用户浏览商品的主线程，页面卡顿投诉激增。</p>
<p>本文结合电商项目中两个核心线程池的实战经验，拆解 “拒绝策略不一致” 的底层逻辑，帮你掌握 “按业务选策略” 的方法论，而非盲目套用默认配置。</p>
<h3 data-id="heading-1">一、先明确：线程池拒绝策略的基础认知</h3>
<p>在讲项目实战前，先快速回顾线程池拒绝策略的核心类型 ——JDK 默认提供 4 种策略，外加自定义策略，不同策略的 “任务处理逻辑” 和 “业务影响” 差异极大：</p>















































<table><thead><tr><th>拒绝策略类型</th><th>核心逻辑</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td>AbortPolicy（默认）</td><td>直接抛出RejectedExecutionException</td><td>快速失败，提醒开发者有问题</td><td>任务直接丢失，可能导致业务中断</td><td>非核心任务，且需感知队列满的场景</td></tr><tr><td>CallerRunsPolicy</td><td>由提交任务的调用方（如主线程）执行任务</td><td>任务不丢失，避免业务中断</td><td>可能阻塞调用方，影响主线程性能</td><td>核心任务，且任务执行耗时短的场景</td></tr><tr><td>DiscardPolicy</td><td>默默丢弃无法处理的任务，不抛异常</td><td>不影响调用方，性能无损耗</td><td>任务丢失，无感知难排查</td><td>非核心任务，任务丢失可容忍的场景</td></tr><tr><td>DiscardOldestPolicy</td><td>丢弃队列中最旧的任务（队列头部），再尝试提交当前任务</td><td>尽量处理新任务，减少最新任务丢失</td><td>可能丢失重要旧任务</td><td>任务有 “时效性”，新任务比旧任务重要的场景</td></tr><tr><td>自定义策略</td><td>按业务逻辑自定义（如持久化任务到 DB/MQ）</td><td>完全适配业务需求</td><td>开发成本高，需考虑异常处理</td><td>核心任务，绝对不能丢失的场景（如支付订单）</td></tr></tbody></table>
<p><strong>关键前提</strong>：线程池触发拒绝策略的条件是 “核心线程满 + 队列满 + 最大线程满”，所以策略选择必须结合 “线程池参数配置” 与 “业务需求”，不能孤立决策。</p>
<h3 data-id="heading-2">二、项目实战：两个线程池的拒绝策略差异与决策逻辑</h3>
<p>我负责的电商项目中，有两个高频使用的线程池：<strong>订单支付处理线程池</strong>（核心业务）和<strong>用户行为日志线程池</strong>（非核心业务）。两者的拒绝策略完全不同，背后是 “业务优先级、任务容忍度、调用方影响” 的三重考量。</p>
<h4 data-id="heading-3">场景 1：订单支付处理线程池 —— 选 CallerRunsPolicy（调用方执行）</h4>
<h5 data-id="heading-4">1. 业务背景与核心诉求</h5>
<ul>
<li><strong>任务内容</strong>：用户支付成功后，异步处理订单状态更新、库存扣减、积分增加（3 个步骤，单次任务耗时约 50ms）；</li>
</ul>

<ul>
<li><strong>核心诉求</strong>：任务<strong>绝对不能丢失</strong>（丢失会导致 “用户已付款但订单未生效”，引发资损和用户投诉）；</li>
</ul>

<ul>
<li><strong>调用方</strong>：支付回调接口（同步接收第三方支付平台的通知，如微信支付回调）；</li>
</ul>

<ul>
<li><strong>性能要求</strong>：正常情况下响应时间 &lt; 100ms，高峰期（如双 11）可接受短暂延迟，但不能抛异常。</li>
</ul>
<h5 data-id="heading-5">2. 线程池参数配置</h5>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Configuration</span>
<span class="hljs-variable">@EnableAsync</span>
public class ThreadPoolConfig {
    <span class="hljs-comment">// 订单支付处理线程池</span>
    <span class="hljs-variable">@Bean</span>(<span class="hljs-string">"orderPayExecutor"</span>)
    public Executor <span class="hljs-built_in">orderPayExecutor</span>() {
        <span class="hljs-selector-tag">ThreadPoolTaskExecutor</span> <span class="hljs-selector-tag">executor</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">ThreadPoolTaskExecutor</span>();
        <span class="hljs-selector-tag">executor</span><span class="hljs-selector-class">.setCorePoolSize</span>(<span class="hljs-number">20</span>);          <span class="hljs-comment">// 核心线程数：日常峰值足够处理</span>
        <span class="hljs-selector-tag">executor</span><span class="hljs-selector-class">.setMaxPoolSize</span>(<span class="hljs-number">50</span>);          <span class="hljs-comment">// 最大线程数：高峰期扩容上限</span>
        <span class="hljs-selector-tag">executor</span><span class="hljs-selector-class">.setQueueCapacity</span>(<span class="hljs-number">100</span>);        <span class="hljs-comment">// 队列容量：故意设小，避免任务堆积过多导致延迟</span>
        <span class="hljs-selector-tag">executor</span><span class="hljs-selector-class">.setKeepAliveSeconds</span>(<span class="hljs-number">60</span>);      <span class="hljs-comment">// 空闲线程存活时间：60秒</span>
        <span class="hljs-selector-tag">executor</span><span class="hljs-selector-class">.setThreadNamePrefix</span>(<span class="hljs-string">"OrderPay-"</span>); <span class="hljs-comment">// 线程名前缀：便于日志排查</span>
        <span class="hljs-comment">// 拒绝策略：CallerRunsPolicy（调用方执行）</span>
        <span class="hljs-selector-tag">executor</span><span class="hljs-selector-class">.setRejectedExecutionHandler</span>(new ThreadPoolExecutor.<span class="hljs-built_in">CallerRunsPolicy</span>());
        <span class="hljs-selector-tag">executor</span><span class="hljs-selector-class">.initialize</span>();
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">executor</span>;
    }
}
</code></pre>
<h5 data-id="heading-6">3. 为什么选 CallerRunsPolicy？</h5>
<p>决策过程中排除了其他策略，核心原因如下：</p>
<ul>
<li><strong>排除 AbortPolicy</strong>：若选默认的 AbortPolicy，高峰期队列满时会直接抛RejectedExecutionException，导致支付回调接口返回失败，第三方支付平台会重复回调，可能引发 “重复处理订单”（如重复扣减库存）；</li>
</ul>

<ul>
<li><strong>排除 DiscardPolicy/DiscardOldestPolicy</strong>：这两种策略都会丢失任务，而订单支付任务绝对不能丢，丢单意味着资损，风险不可接受；</li>
</ul>

<ul>
<li><strong>选择 CallerRunsPolicy 的核心逻辑</strong>：当线程池满时，让 “支付回调接口的线程”（调用方）亲自执行任务 —— 虽然会导致回调接口响应时间从 50ms 增至 100ms，但能 100% 保证任务不丢失，且无需额外开发成本；</li>
</ul>

<ul>
<li><strong>配合小队列容量</strong>：队列容量设为 100（而非 1000），目的是 “尽早触发拒绝策略”—— 避免队列堆积过多任务导致延迟（比如堆积 1000 个任务，每个耗时 50ms，最后一个任务要等 50 秒），用 CallerRunsPolicy 承担部分压力，平衡延迟与可靠性。</li>
</ul>
<h5 data-id="heading-7">4. 实战效果</h5>
<p>双 11 高峰期，该线程池 QPS 从日常 500 飙升至 2000，触发拒绝策略后：</p>
<ul>
<li>任务丢失率：0%（无一笔订单因拒绝策略丢失）；</li>
</ul>

<ul>
<li>回调接口响应时间：从 50ms 升至 120ms（用户无感知，第三方支付平台也接受该延迟）；</li>
</ul>

<ul>
<li>系统稳定性：无异常日志，库存与订单状态完全一致。</li>
</ul>
<h4 data-id="heading-8">场景 2：用户行为日志线程池 —— 选 DiscardOldestPolicy（丢弃最旧任务）</h4>
<h5 data-id="heading-9">1. 业务背景与核心诉求</h5>
<ul>
<li><strong>任务内容</strong>：用户浏览商品、点击按钮、加入购物车等行为的日志异步写入 Elasticsearch（单次任务耗时约 10ms）；</li>
</ul>

<ul>
<li><strong>核心诉求</strong>：任务<strong>可容忍部分丢失</strong>（少几条浏览日志不影响核心业务，也不会导致用户投诉）；</li>
</ul>

<ul>
<li><strong>调用方</strong>：用户前端操作对应的接口（如商品详情接口、购物车接口）；</li>
</ul>

<ul>
<li><strong>性能要求</strong>：绝对不能阻塞调用方（比如用户点击 “加入购物车”，必须立即返回成功，不能因日志写入延迟导致页面卡顿）。</li>
</ul>
<h5 data-id="heading-10">2. 线程池参数配置</h5>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Configuration</span>
public class ThreadPoolConfig {
    <span class="hljs-comment">// 用户行为日志线程池</span>
    <span class="hljs-keyword">@Bean</span>(<span class="hljs-string">"userBehaviorLogExecutor"</span>)
    public Executor userBehaviorLogExecutor() {
        ThreadPoolTaskExecutor executor = new <span class="hljs-built_in">ThreadPoolTaskExecutor</span>();
        executor<span class="hljs-selector-class">.setCorePoolSize</span>(<span class="hljs-number">10</span>);          <span class="hljs-comment">// 核心线程数：日常足够</span>
        executor<span class="hljs-selector-class">.setMaxPoolSize</span>(<span class="hljs-number">20</span>);          <span class="hljs-comment">// 最大线程数：高峰期扩容</span>
        executor<span class="hljs-selector-class">.setQueueCapacity</span>(<span class="hljs-number">1000</span>);       <span class="hljs-comment">// 队列容量：设大，尽量缓存任务</span>
        executor<span class="hljs-selector-class">.setKeepAliveSeconds</span>(<span class="hljs-number">30</span>);      <span class="hljs-comment">// 空闲线程存活时间：30秒</span>
        executor<span class="hljs-selector-class">.setThreadNamePrefix</span>("UserLog-"); <span class="hljs-comment">// 线程名前缀</span>
        <span class="hljs-comment">// 拒绝策略：DiscardOldestPolicy（丢弃队列最旧任务，尝试提交当前任务）</span>
        executor<span class="hljs-selector-class">.setRejectedExecutionHandler</span>(new ThreadPoolExecutor.DiscardOldestPolicy());
        executor<span class="hljs-selector-class">.initialize</span>();
        return executor;
    }
}
</code></pre>
<h5 data-id="heading-11">3. 为什么选 DiscardOldestPolicy？</h5>
<p>这是踩坑后优化的结果，最初选了CallerRunsPolicy，导致严重问题：</p>
<ul>
<li><strong>最初的坑</strong>：上线初期用 CallerRunsPolicy，大促期间用户浏览量激增，日志队列满后，调用方（商品详情接口线程）被迫执行日志写入任务 —— 商品详情接口响应时间从 30ms 飙升至 200ms，用户反馈 “点击商品后页面半天加载不出来”；</li>
</ul>

<ul>
<li><strong>排除 CallerRunsPolicy</strong>：核心原因是 “日志是非核心任务，不能让它阻塞核心业务的调用方”—— 用户浏览商品是核心体验，比日志重要得多；</li>
</ul>

<ul>
<li><strong>排除 AbortPolicy</strong>：抛异常会导致接口返回错误，虽然可以捕获异常，但日志任务没必要让接口感知失败；</li>
</ul>

<ul>
<li><strong>排除 DiscardPolicy</strong>：DiscardPolicy 会丢弃当前任务，而日志有 “时效性”—— 用户最新的点击行为比 10 秒前的浏览行为更有分析价值，丢弃旧任务比丢弃新任务更合理；</li>
</ul>

<ul>
<li><strong>选择 DiscardOldestPolicy 的核心逻辑</strong>：队列满时，丢弃最早进入队列的旧日志（比如 10 秒前的浏览记录），尝试提交当前的新日志 —— 既保证了 “最新日志尽量被处理”，又不会阻塞调用方，性能无损耗；</li>
</ul>

<ul>
<li><strong>配合大队列容量</strong>：队列容量设为 1000，目的是 “尽量缓存日志任务”—— 只有在极端高峰期（如秒杀开始时用户集中涌入）才会触发拒绝策略，减少任务丢失量。</li>
</ul>
<h5 data-id="heading-12">4. 实战效果</h5>
<p>优化后双 11 高峰期：</p>
<ul>
<li>日志丢失率：约 2%（仅极端峰值时丢失少量旧日志，不影响数据分析）；</li>
</ul>

<ul>
<li>调用方响应时间：稳定在 30ms 以内（用户无感知卡顿）；</li>
</ul>

<ul>
<li>系统稳定性：日志线程池满时，无任何核心业务异常。</li>
</ul>
<h3 data-id="heading-13">三、拒绝策略选择的底层方法论：3 个核心维度</h3>
<p>项目中两个线程池的策略差异，本质是 “业务属性决定技术选型”。总结出 3 个维度的决策框架，帮你快速匹配适合的拒绝策略：</p>
<h4 data-id="heading-14">维度 1：业务优先级 —— 核心任务 vs 非核心任务</h4>
<p>这是首要维度，直接决定 “是否能容忍任务丢失”：</p>
<ul>
<li><strong>核心任务</strong>（如订单、支付、库存）：绝对不能丢失，优先选CallerRunsPolicy或自定义策略（如持久化到 DB/MQ）；</li>
</ul>

<ul>
<li><strong>非核心任务</strong>（如日志、统计、通知）：可容忍丢失，优先选DiscardPolicy或DiscardOldestPolicy。</li>
</ul>
<h4 data-id="heading-15">维度 2：任务容忍度 —— 不可丢 vs 可丢、时效性</h4>
<ul>
<li><strong>不可丢 + 无时效性</strong>：选CallerRunsPolicy（如订单处理）；</li>
</ul>

<ul>
<li><strong>不可丢 + 强时效性</strong>：选自定义策略（如将任务写入 Redis/MQ，后续重试，避免 CallerRunsPolicy 阻塞）；</li>
</ul>

<ul>
<li><strong>可丢 + 新任务优先</strong>：选DiscardOldestPolicy（如用户行为日志）；</li>
</ul>

<ul>
<li><strong>可丢 + 无优先级</strong>：选DiscardPolicy（如非核心数据统计）。</li>
</ul>
<h4 data-id="heading-16">维度 3：调用方影响 —— 是否可阻塞</h4>
<ul>
<li><strong>调用方是核心接口</strong>（如商品详情、支付回调）：绝对不能阻塞，非核心任务选Discard*策略，核心任务选CallerRunsPolicy（但需控制任务耗时）；</li>
</ul>

<ul>
<li><strong>调用方是后台任务</strong>（如定时任务）：可阻塞，选CallerRunsPolicy（后台任务无用户感知）。</li>
</ul>
<h3 data-id="heading-17">四、进阶：自定义拒绝策略 —— 应对复杂业务场景</h3>
<p>当 JDK 默认策略无法满足需求时，需自定义拒绝策略。比如项目中的 “退款任务线程池”，要求 “任务不丢失、不阻塞调用方、失败后重试”，此时自定义策略是最佳选择。</p>
<h4 data-id="heading-18">自定义拒绝策略实战（退款任务）</h4>
<h5 data-id="heading-19">1. 业务诉求</h5>
<ul>
<li>退款任务绝对不能丢（涉及用户资金，丢单会引发严重投诉）；</li>
</ul>

<ul>
<li>调用方是退款接口，不能阻塞（用户申请退款后需立即返回 “处理中”）；</li>
</ul>

<ul>
<li>失败后需重试（线程池满时，将任务存入 Redis，后续定时重试）。</li>
</ul>
<h5 data-id="heading-20">2. 自定义拒绝策略代码</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 自定义拒绝策略类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RefundRejectedPolicy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RejectedExecutionHandler</span> {
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">RedisTemplate</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; redisTemplate;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title class_">String</span> <span class="hljs-variable constant_">REFUND_TASK_KEY</span> = <span class="hljs-string">"refund:task:queue"</span>;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">rejectedExecution</span>(<span class="hljs-params">Runnable r, ThreadPoolExecutor executor</span>) {
        <span class="hljs-comment">// 判断任务是否为退款任务（强转验证）</span>
        <span class="hljs-keyword">if</span> (r <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">RefundTask</span>) {
            <span class="hljs-title class_">RefundTask</span> refundTask = (<span class="hljs-title class_">RefundTask</span>) r;
            <span class="hljs-comment">// 将任务ID存入Redis列表（后续定时任务重试）</span>
            <span class="hljs-title class_">String</span> taskJson = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">toJSONString</span>(refundTask.<span class="hljs-title function_">getRefundId</span>());
            redisTemplate.<span class="hljs-title function_">opsForList</span>().<span class="hljs-title function_">rightPush</span>(<span class="hljs-variable constant_">REFUND_TASK_KEY</span>, taskJson);
            log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"退款任务线程池满，任务存入Redis重试，退款ID：{}"</span>, refundTask.<span class="hljs-title function_">getRefundId</span>());
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 非退款任务，按默认策略处理（抛异常）</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RejectedExecutionException</span>(<span class="hljs-string">"不支持的任务类型："</span> + r.<span class="hljs-title function_">getClass</span>().<span class="hljs-title function_">getName</span>());
        }
    }
}
<span class="hljs-comment">// 2. 退款任务线程池配置</span>
<span class="hljs-meta">@Bean</span>(<span class="hljs-string">"refundExecutor"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-title class_">Executor</span> <span class="hljs-title function_">refundExecutor</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">ThreadPoolTaskExecutor</span> executor = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadPoolTaskExecutor</span>();
    executor.<span class="hljs-title function_">setCorePoolSize</span>(<span class="hljs-number">15</span>);
    executor.<span class="hljs-title function_">setMaxPoolSize</span>(<span class="hljs-number">30</span>);
    executor.<span class="hljs-title function_">setQueueCapacity</span>(<span class="hljs-number">200</span>);
    executor.<span class="hljs-title function_">setThreadNamePrefix</span>(<span class="hljs-string">"Refund-"</span>);
    <span class="hljs-comment">// 配置自定义拒绝策略</span>
    executor.<span class="hljs-title function_">setRejectedExecutionHandler</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RefundRejectedPolicy</span>());
    executor.<span class="hljs-title function_">initialize</span>();
    <span class="hljs-keyword">return</span> executor;
}
<span class="hljs-comment">// 3. 定时任务重试Redis中的退款任务</span>
<span class="hljs-meta">@Scheduled</span>(fixedRate = <span class="hljs-number">60000</span>) <span class="hljs-comment">// 每分钟执行一次</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">retryRefundTask</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 从Redis中取出未处理的退款任务ID</span>
    <span class="hljs-title class_">String</span> taskJson;
    <span class="hljs-keyword">while</span> ((taskJson = redisTemplate.<span class="hljs-title function_">opsForList</span>().<span class="hljs-title function_">leftPop</span>(<span class="hljs-variable constant_">REFUND_TASK_KEY</span>, <span class="hljs-number">0</span>, <span class="hljs-title class_">TimeUnit</span>.<span class="hljs-property">SECONDS</span>)) != <span class="hljs-literal">null</span>) {
        <span class="hljs-title class_">Long</span> refundId = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parseObject</span>(taskJson, <span class="hljs-title class_">Long</span>.<span class="hljs-property">class</span>);
        <span class="hljs-comment">// 提交任务到线程池（此时线程池可能已空闲）</span>
        refundExecutor.<span class="hljs-title function_">execute</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RefundTask</span>(refundId));
    }
}
</code></pre>
<h5 data-id="heading-21">3. 效果</h5>
<ul>
<li>任务丢失率：0%（所有退款任务要么立即执行，要么存入 Redis 重试）；</li>
</ul>

<ul>
<li>调用方影响：退款接口响应时间稳定在 80ms 以内，无阻塞；</li>
</ul>

<ul>
<li>异常处理：即使线程池长期满，任务也会在 Redis 中排队，不会丢失。</li>
</ul>
<h3 data-id="heading-22">五、常见踩坑总结与避坑指南</h3>
<ol>
<li><strong>坑 1：所有线程池用默认的 AbortPolicy</strong></li>
</ol>
<ul>
<li>
<ul>
<li>后果：核心任务（如支付）会因抛异常丢失，非核心任务（如日志）抛异常影响调用方；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>避坑：按业务优先级分类，核心任务禁用 AbortPolicy。</li>
</ul>
</li>
</ul>
<ol start="2">
<li><strong>坑 2：非核心任务用 CallerRunsPolicy</strong></li>
</ol>
<ul>
<li>
<ul>
<li>后果：高峰期阻塞核心接口（如日志阻塞商品详情接口），用户体验差；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>避坑：非核心任务优先选Discard*策略，除非任务绝对不能丢。</li>
</ul>
</li>
</ul>
<ol start="3">
<li><strong>坑 3：线程池参数与拒绝策略不匹配</strong></li>
</ol>
<ul>
<li>
<ul>
<li>后果：比如核心任务线程池队列设太大，导致任务堆积延迟，拒绝策略无法及时触发；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>避坑：核心任务队列设小（尽早触发拒绝策略），非核心任务队列设大（尽量缓存）。</li>
</ul>
</li>
</ul>
<ol start="4">
<li><strong>坑 4：自定义策略未处理异常</strong></li>
</ol>
<ul>
<li>
<ul>
<li>后果：比如自定义策略中写入 DB 失败，导致任务丢失且无日志；</li>
</ul>
</li>
</ul>

<ul>
<li>
<ul>
<li>避坑：自定义策略必须加异常捕获和日志记录，关键任务需加重试机制。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-23">总结：拒绝策略选择的核心逻辑</h3>
<p>线程池拒绝策略的本质是 “<strong>业务风险与技术成本的平衡</strong>”—— 没有 “最好的策略”，只有 “最适合业务的策略”：</p>
<ul>
<li>核心任务：优先保证 “不丢失”，哪怕牺牲一点调用方性能（如 CallerRunsPolicy）；</li>
</ul>

<ul>
<li>非核心任务：优先保证 “不影响调用方”，哪怕丢失少量任务（如 DiscardOldestPolicy）；</li>
</ul>

<ul>
<li>复杂场景：用自定义策略兜底，平衡 “不丢失” 与 “不阻塞”（如结合 Redis 重试）。</li>
</ul>
<p>记住：线程池的每一个参数（核心线程数、队列容量、拒绝策略）都应服务于业务需求，而非盲目照搬网上的 “最优配置”。只有深入理解业务优先级和任务属性，才能做出正确的决策，让线程池成为提升系统性能的利器，而非引发故障的隐患。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入浅出：理解js的‘万物皆对象’与原型链]]></title>    <link>https://juejin.cn/post/7579450578293604394</link>    <guid>https://juejin.cn/post/7579450578293604394</guid>    <pubDate>2025-12-03T10:25:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579450578293604394" data-draft-id="7577705544875474982" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入浅出：理解js的‘万物皆对象’与原型链"/> <meta itemprop="keywords" content="JavaScript,前端"/> <meta itemprop="datePublished" content="2025-12-03T10:25:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Neptune1"/> <meta itemprop="url" content="https://juejin.cn/user/1030661718147776"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入浅出：理解js的‘万物皆对象’与原型链
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1030661718147776/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Neptune1
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T10:25:22.000Z" title="Wed Dec 03 2025 10:25:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#444;background-image:linear-gradient(90deg,rgba(59,59,59,.1) 3%,transparent 0),linear-gradient(1turn,rgba(122,120,121,.1) 3%,transparent 0);background-size:30px 30px;background-position:50%;letter-spacing:1px;word-spacing:1px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{position:relative;margin-top:34px;margin-bottom:16px;font-weight:700;line-height:1.3;cursor:text;color:#444;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body h1{font-size:41px;margin-bottom:34px;line-height:1.5}.markdown-body h1:before{content:""}.markdown-body h2{font-size:30px;padding-left:.4em;border-left:.4em solid #5e5e5e;border-bottom:1px solid #444}.markdown-body h2:after{content:"🕛";position:absolute;top:0;right:0;transition:all;animation:rotate 10s linear infinite}@keyframes rotate{0%{transform:rotate(0deg)}to{transform:rotate(1turn)}}.markdown-body h3{border-left:.4em solid #8d8d8d;font-size:24px;padding-left:.4em}.markdown-body h4{font-size:20px}.markdown-body h5{font-size:16px}.markdown-body h6{font-size:14px}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body table,.markdown-body ul{margin:.8em 0}.markdown-body strong{font-weight:1000;position:relative;color:#444;padding:0 3px}.markdown-body em{font-weight:inherit}.markdown-body a{box-sizing:border-box;color:grey;position:relative}.markdown-body a:before{position:absolute;box-sizing:border-box;content:"Go -&gt;";left:0;width:100%;max-width:0;color:#fff;background-color:hsla(0,0%,50.2%,.8);white-space:nowrap;transition:.2s ease;pointer-events:none;overflow:hidden}.markdown-body a:after{content:"";position:absolute;bottom:0;left:0;width:100%;height:1px;background-color:grey}.markdown-body a:active:before,.markdown-body a:hover:before{max-width:100%;padding-left:8px;border-radius:5px}.markdown-body hr{position:relative;width:100%;height:1px;border:none;margin-top:36px;margin-bottom:36px;background:linear-gradient(90deg,grey,#f1f1f1,#444,#444,#f1f1f1,grey);overflow:visible}.markdown-body ol,.markdown-body ul{padding-left:32px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px;list-style:inherit}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol{counter-reset:my-counter}.markdown-body ol&gt;li{padding-left:6px;list-style:none;counter-increment:my-counter;position:relative}.markdown-body ol&gt;li:before{position:absolute;left:-1.5em;content:counter(my-counter);font-weight:700}.markdown-body ol&gt;li:first-child:before{content:"1️⃣"}.markdown-body ol&gt;li:nth-child(2):before{content:"2️⃣"}.markdown-body ol&gt;li:nth-child(3):before{content:"3️⃣"}.markdown-body ol&gt;li:nth-child(4):before{content:"4️⃣"}.markdown-body ol&gt;li:nth-child(5):before{content:"5️⃣"}.markdown-body ol&gt;li:nth-child(6):before{content:"6️⃣"}.markdown-body ol&gt;li:nth-child(7):before{content:"7️⃣"}.markdown-body ol&gt;li:nth-child(8):before{content:"8️⃣"}.markdown-body ol&gt;li:nth-child(9):before{content:"9️⃣"}.markdown-body ol&gt;li:nth-child(10):before{content:"🔟"}.markdown-body ul&gt;li{list-style:none;position:relative}.markdown-body ul&gt;li:before{z-index:10;position:absolute;left:-1.57em;content:"🔹";margin-right:12px}.markdown-body ul&gt;li input{margin-left:8px!important}.markdown-body blockquote{position:relative;background-color:#d3d3d3;padding:5px 10px;border-left:.2em solid #000;border-radius:3px;transition:all .8s ease}.markdown-body blockquote:hover{opacity:.7}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(69,69,77,.8);color:#fff;font-size:.87em;padding:.07em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:7px;overflow:hidden}.markdown-body pre:before{z-index:10;position:absolute;top:14px;left:14px;width:12px;height:12px;border-radius:50%;background:#fc625d;-webkit-box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;box-shadow:20px 0 #fdbc40,40px 0 #35cd4b;content:" "}.markdown-body pre:after{z-index:9;content:"";position:absolute;width:100%;height:40px;top:0;background-color:#1a1a1a}.markdown-body pre&gt;code{display:block;font-family:Menlo,Monaco,Consolas,Courier New,monospace;word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#171717;color:#bababa;font-size:14px;padding:40px 20px 20px}.markdown-body del{color:grey}.markdown-body table{margin-bottom:1.25rem;border-collapse:collapse}.markdown-body table td,.markdown-body table th{margin:0;padding:8px;line-height:20px;vertical-align:middle;border:1px solid #ddd}.markdown-body table thead,.markdown-body table tr:nth-child(2n){background-color:#fcfcfc}.markdown-body table thead th,.markdown-body table tr:nth-child(2n) th{font-weight:700;vertical-align:middle;color:#444}.markdown-body table tbody tr td{font-weight:400;color:#444}.markdown-body table tbody tr:hover{background-color:#d3d3d3}.markdown-body table tbody tr:hover td{color:#fff}.markdown-body img{max-width:100%;margin:0 12px}@media (max-width:720px){.markdown-body h1{font-size:32.8px}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:19.2px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:12.8px}}</style><style data-highlight="" data-highlight-key="hybrid">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1d1f21}.hljs::selection,.hljs span::selection{background:#373b41}.hljs::-moz-selection,.hljs span::-moz-selection{background:#373b41}.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#c5c8c6}.hljs-name,.hljs-title{color:#f0c674}.hljs-comment,.hljs-meta,.hljs-meta .hljs-keyword{color:#707880}.hljs-deletion,.hljs-link,.hljs-literal,.hljs-number,.hljs-symbol{color:#c66}.hljs-addition,.hljs-doctag,.hljs-regexp,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string{color:#b5bd68}.hljs-attribute,.hljs-code,.hljs-selector-id{color:#b294bb}.hljs-bullet,.hljs-keyword,.hljs-selector-tag,.hljs-tag{color:#81a2be}.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-variable{color:#8abeb7}.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-selector-class,.hljs-type{color:#de935f}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在平时使用数组时，看到以下代码，你是否有产生过疑问，数组里的<code>push，pop,shift,unshift</code>，，字符串里
的<code>slice,length</code>方法是哪里来的，我没定义它啊，而且，不应该是对象才能使用‘‘对象名  + . + 属性名’’这
种方式来调用对象里的内容吗，为什么字符串，数组，以及函数等等都可以使用这种调用方式呢？？？</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>]
arr.push(4)   //为什么我新建的这个数组就可以使用push方法？？？

const <span class="hljs-attr">str</span>=<span class="hljs-string">'hello world'</span>
let <span class="hljs-attr">num</span> = str.length  //这些属性是哪里来的呢？？？

let <span class="hljs-attr">obj</span> = {name:<span class="hljs-string">''</span>zzh<span class="hljs-string">''</span>}   //一个真正的对象
console.log(obj.name)
<span class="hljs-attr">obj.printname</span> =() =&gt; {console.log(<span class="hljs-string">'your name'</span>)}

</code></pre>
<p>你会发现，很多明明不是对象的数据类型，却透露着种种对象的气息，你是否发现一个字符串<code>str</code>,居然可以像对象<code>obj</code>一样访问他的属性<code>.length</code>，数组<code>str</code>调用方法<code>push（）</code>。这究竟是为什么呢，<strong>难道说，这些数据类型天生就是对象？</strong></p>
<p>没错，在js中你可以理解为万物皆对象，我接下来将为你解释为何万物皆对象，为了帮助理解，我们需要来聊聊原型与原型链，因为让你感到疑惑的这一切其背后都是‘原型’在默默工作着，理解了原型，我们才能真正理解js的面向对象编程</p>
<h3 data-id="heading-0">一、创造实例对象 ————  实例对象的继承</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name</span>){
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name
}

<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">yourname</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
    
}

<span class="hljs-keyword">const</span> person1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'z'</span>)
<span class="hljs-keyword">const</span> person2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'a'</span>)

person1.<span class="hljs-title function_">yourname</span>()  <span class="hljs-comment">// z</span>
person2.<span class="hljs-title function_">yourname</span>()  <span class="hljs-comment">// a</span>
</code></pre>
<p>有没有发现一件事，yourname（）方法只在Person.prototype中定义了一次，但使用new Person（）构造出来的实例对象perosn1，与person2却均可调用，观察下来，明明‘‘person1与person2都只继承了name属性’’，可他们为什么都能调用相同的保存在Person.prototype中的yourname方法呢，实例对象是怎么调用这个方法的，这个方法又是存在哪的</p>
<h3 data-id="heading-1">二、何为原型，详解<code>prototype，__prototype__ , constructor</code></h3>
<h6 data-id="heading-2">1. prototype (函数的显示原型)</h6>
<p>函数天生拥有一个属性（prototype），箭头函数除外，可以被函数本身访问到但是,由于不是显示属性，所以你并不能在函数体中观察到，通过在游览器中打印该属性，我们可以看到以下内容：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa66a07256184acc8a858f5fc8eff769~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmVwdHVuZTE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362325&amp;x-signature=NiHTYjaMfZZAiaaemfeUZHfIg9U%3D" alt="image.png" loading="lazy"/></p>
<p>可以看见，函数的prototype是以一个对象的形式存在的，该对象中包括了：</p>
<ol>
<li>共享的方法与属性，这也是prototype存在的主要的目的，用以<strong>存储所有实例共享的方法和属性</strong>，这样通过把方法和属性定义在prototype上，可以避免每个实例都创建一份方法的副本，节省内存</li>
</ol>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params">name,age</span>){
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age
  }
  
fn.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">foo</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>){
     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'hello'</span>)   <span class="hljs-comment">//将实例对象需要共享的方法放在prototype上，使得所有实例对象共享一份，避免了每创建一个实例对象便创建一个foo函数，减少了内存的占用</span>
}


<span class="hljs-keyword">const</span> person1 = <span class="hljs-keyword">new</span> <span class="hljs-title function_">fn</span>()
<span class="hljs-keyword">const</span> person2 = <span class="hljs-keyword">new</span> <span class="hljs-title function_">fn</span>()

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person1.<span class="hljs-property">foo</span> === person2.<span class="hljs-property">foo</span>)   <span class="hljs-comment">//得到true，可证明person1 与person2 是同一个方法</span>
</code></pre>
<p>2.<code> constructor</code> 属性（默认存在），每个构造函数的<code>prototype</code>对象都默认有一个<code>constructor</code>属性，指向构造函数本身</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params">name,age</span>){
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age
  }
  
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(fn.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> === fn)   <span class="hljs-comment">//true  验证成功</span>
  <span class="hljs-keyword">const</span> person1 = <span class="hljs-keyword">new</span> <span class="hljs-title function_">fn</span>(<span class="hljs-string">'z'</span>,<span class="hljs-number">18</span>)
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person1.<span class="hljs-property">constructor</span>.<span class="hljs-property">name</span>)  <span class="hljs-comment">//name   由于constructor指向构造函数本身，所有实例对象可以通过constructor来访问它的构造函数</span>
</code></pre>
<p>3.  prototype对象本身也有一个__prototype__,这构成了原型链的基础，这就是原型链中继承链的基础，对象类型的数据结构都拥有一个__prototype__，称之为隐式原型，由于<code>prototype</code>本身也是一个对象类型的数据类型，所以它也拥有一个__prototype__</p>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">fn</span>(<span class="hljs-params">name,age</span>){
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age
  }
  
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(fn.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">__prototype__</span> === <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>)  <span class="hljs-comment">//true</span>
  
  这使得通过fn 创建的实例对象可以找到并访问<span class="hljs-title class_">Object</span>方法,即实例对象通过它的隐式原型找到它构造函数的显示原型，再通过它的显示原型的隐式原型找到<span class="hljs-title class_">Object</span>（），也可以通过构造函数它的隐式原型找到<span class="hljs-title class_">Function</span>（）函数
</code></pre>
<h6 data-id="heading-3">2. <code>__prototype__</code> (对象的隐式原型) 注:在谷歌浏览器中表示为[[prototype]]</h6>
<p>每一个<strong>对象</strong>（包括函数,数组等所有对象类型）在创建时都会内置一个<code>__prototype__</code></p>
<p>通过<code>__prototype__ </code>,我们就可以理解<strong>new操作符的秘密</strong>了:</p>
<p>const zzh = new Person() 这一行代码创建实例对象zzh时，实际上就做了三件事</p>
<ol>
<li>创建一个空对象{}</li>
<li>将空对象内的<code>__prototype__</code>指向<code>Person_prototype</code>.(使得实例对象可以沿着<code>__prototype__</code>向上寻找它的构造函数)</li>
<li>将构造函数内的<code>this</code>绑定到这个新对象上，执行构造函数，并在最后返回该新对象</li>
</ol>
<p><strong>用一串代码表示new在干的事情</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">a,b,c</span>){
<span class="hljs-keyword">const</span> xxx = {}  <span class="hljs-comment">//创建一个空对象</span>

xxx.<span class="hljs-property">__prototype__</span> = <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> <span class="hljs-comment">//使Person的显示原型指向新对象的隐式原型</span>

<span class="hljs-title class_">Person</span>.<span class="hljs-title function_">call</span>(zzh,a,b,c)   <span class="hljs-comment">//使Person()的this指向新对象</span>

<span class="hljs-variable language_">this</span>.<span class="hljs-property">a</span>=a
<span class="hljs-variable language_">this</span>.<span class="hljs-property">b</span>=b
<span class="hljs-variable language_">this</span>.<span class="hljs-property">c</span>=c

<span class="hljs-keyword">return</span> xxx    <span class="hljs-comment">//返回新对象</span>

}
<span class="hljs-keyword">const</span> zzh = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(a,b,c)
</code></pre>
<h6 data-id="heading-4">3. <code>constructor</code>(构造函数)</h6>
<p>在函数的<code>prototype</code>对象上,默认会有一个<code>construct</code>属性，用于指回函数本身，可使得该构造函数创建的实例对象通过它的<code>__prototype__</code>找回构造它的构造函数，所以<code>construct</code>起到一个标识作用，但是，由于该属性是可以被覆盖掉的，它并不完全可靠</p>
<p>观察下图，总结了<code>prototype,__prototype__,constructor</code>三者的关系，可以更好的理解什么是原型</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fcef5ee255c4ba3a71c7f79b811cb96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTmVwdHVuZTE=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362325&amp;x-signature=ONuOKlhifu75Ot5n97ntkQ0DWjI%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">三、原型链的形成</h3>
<p>现在，让我们来聊聊Object上的toString方法是如何继承到构造函数所创建的实例对象上的，为何被
构造函数所创建出的实例对象都可以使用toString方法</p>
<p>让我来详细写出实例对象对toSrting方法的查找过程</p>
<ol>
<li>js读取到<code>toString</code>被调用</li>
<li>向实例对象<code>person1</code>中查找   //发现没找到</li>
<li>顺着原型链，从该实例对象<code>person.__prototype__</code>查找到Person.prototype           //toString没有定义在这，所以没找到</li>
<li>继续沿着<code>person.__prototype__.__prototype__</code>寻找         // 此时等价于在<code>Person.prototype.__prototype</code>中寻找，由于Person.prototype也是一个对象，所以它也有隐式原型，且由于Person.prototype是一个用new Object（）类似的方法创建的对象，所以通过它的原型所找到的隐式原型指向着Object.prototype（详情见本文二、2.3图所示），此时成功在Object.prototype中找到toString方法，成功调用</li>
</ol>
<p>ps:原型链的终点为null:<code>Object.prototype.__prototype__</code>,查找到此结束，如果还没查找到方法，则返回<strong>undefined</strong></p>
<p>完整的原型链可表示为： person1 --&gt; Person.prototype --&gt; Objectotype --&gt; null</p>
<h5 data-id="heading-6">四、总结</h5>
<p>此时你也许明白了实例对象里明明没有一些属性和方法却可以调用的原因了，让我们来总结一下所有的知识点</p>
<p>1.js通过原型链实现了继承，每个对象都有一个隐秘的__prototype__链接指向它的原型，形成了一个链式结构，继而使的实现了原型链</p>
<p>2.使用原型链可以解决内存浪费的问题</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[扒一扒 Vue3 大屏适配插件 vfit 的源码：原来这么简单？]]></title>    <link>https://juejin.cn/post/7579440586694361134</link>    <guid>https://juejin.cn/post/7579440586694361134</guid>    <pubDate>2025-12-03T10:26:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579440586694361134" data-draft-id="7579427549472063534" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="扒一扒 Vue3 大屏适配插件 vfit 的源码：原来这么简单？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-03T10:26:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="王霸天"/> <meta itemprop="url" content="https://juejin.cn/user/1875092531319104"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            扒一扒 Vue3 大屏适配插件 vfit 的源码：原来这么简单？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1875092531319104/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    王霸天
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T10:26:18.000Z" title="Wed Dec 03 2025 10:26:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前几天用了 vfit 做大屏适配，感觉挺好用的。
作为一个有追求的前端（其实是闲得蛋疼），我忍不住扒了一下它的源码。
结果发现... <strong>核心代码居然不到 50 行？</strong> 🤯</p>
<p>今天就带大家深入浅出地拆解一下这个库，看看它是如何优雅地解决大屏适配问题的。</p>
<h2 data-id="heading-0">🎯 核心原理：Scale 方案</h2>
<p>大屏适配的核心流派无非就那几种：</p>
<ol>
<li><strong>REM / VW</strong>：修改基准值，所有单位都要改，侵入性强。</li>
<li><strong>Scale</strong>：CSS <code>transform: scale()</code>，简单粗暴，不改变布局。</li>
</ol>
<p>vfit 采用的是 <strong>Scale 方案</strong>。
它的思路非常清晰：</p>
<blockquote>
<p>计算 <code>当前屏幕宽高</code> / <code>设计稿宽高</code> = <code>缩放比例</code>，然后应用到根容器上。</p>
</blockquote>
<h2 data-id="heading-1">🔍 源码拆解</h2>
<h3 data-id="heading-2">1. 监听屏幕变化 (ResizeObserver)</h3>
<p>在 <code>src/scale.ts</code> 里，它没有使用传统的 <code>window.onresize</code>，而是用了更现代、性能更好的 <code>ResizeObserver</code>。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/scale.ts (简化版)</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">observeScale</span>(<span class="hljs-params">target, designHeight, onScale</span>) {
  <span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ResizeObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> entry <span class="hljs-keyword">of</span> entries) {
      <span class="hljs-keyword">const</span> { width, height } = entry.<span class="hljs-property">contentRect</span>
      <span class="hljs-comment">// ... 计算 scale 逻辑</span>
      <span class="hljs-title function_">onScale</span>(scaleVal)
    }
  })
  observer.<span class="hljs-title function_">observe</span>(target)
}
</code></pre>
<p><strong>为什么用 ResizeObserver？</strong>
因为它能监听<strong>任意元素</strong>的大小变化，而不仅仅是 window。这意味着你可以把大屏嵌入到一个 div 里（比如后台管理系统的某个 dashboard 页签），它依然能正常缩放！</p>
<h3 data-id="heading-3">2. 三种缩放模式的算法</h3>
<p>vfit 支持 <code>width</code> | <code>height</code> | <code>auto</code> 三种模式。
看看它是怎么算的：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/scale.ts</span>
<span class="hljs-keyword">if</span> (scaleMode === <span class="hljs-string">'height'</span>) {
  <span class="hljs-comment">// 1. 只要高度撑满，宽度按比例缩放（适合定高宽屏）</span>
  scaleVal = rectHeight / designHeight
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (scaleMode === <span class="hljs-string">'width'</span>) {
  <span class="hljs-comment">// 2. 只要宽度撑满，高度按比例缩放（适合定宽长页面）</span>
  scaleVal = rectWidth / designWidth
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// 3. auto 模式 (默认)：保持宽高比，全部显示 (Contain)</span>
  <span class="hljs-keyword">const</span> designRatio = designWidth / designHeight
  <span class="hljs-comment">// 如果当前屏幕更宽（带鱼屏），就以高度为基准</span>
  <span class="hljs-comment">// 如果当前屏幕更窄（手机），就以宽度为基准</span>
  <span class="hljs-keyword">if</span> (rectWidth / rectHeight &lt; designRatio) {
    scaleVal = rectWidth / designWidth
  } <span class="hljs-keyword">else</span> {
    scaleVal = rectHeight / designHeight
  }
}
</code></pre>
<p>这段逻辑非常经典，保证了内容<strong>永远不会被裁剪</strong>，同时也保持了设计稿的比例。</p>
<h3 data-id="heading-4">3. 神奇的 FitContainer</h3>
<p>大家用 scale 方案最头疼的是什么？
<strong>是定位！</strong> 😫
一旦缩放了，原来的 <code>top: 100px</code> 可能就不是视觉上的 100px 了，而且居中后的偏移量也很难算。</p>
<p>vfit 的 <code>FitContainer.vue</code> 组件用了一个很巧妙的思路解决这个问题：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// src/components/FitContainer.vue</span>

<span class="hljs-comment">// 监听 scale 和 props 变化</span>
<span class="hljs-title function_">watch</span>([<span class="hljs-function">() =&gt;</span> props.<span class="hljs-property">scale</span>, fitScale], <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> s = fitScale.<span class="hljs-property">value</span>
  
  <span class="hljs-comment">// 对于 left 和 top，乘以缩放比例 s</span>
  <span class="hljs-comment">// 这样就能让元素相对于原点进行位移</span>
  <span class="hljs-keyword">if</span> (key === <span class="hljs-string">'left'</span> || key === <span class="hljs-string">'top'</span>) {
    position[key] = val * s + <span class="hljs-string">'px'</span>
  }
  
  <span class="hljs-comment">// 对于 right 和 bottom，不乘！</span>
  <span class="hljs-comment">// 这样元素就会死死贴住容器边缘</span>
  <span class="hljs-keyword">else</span> {
    position[key] = val + <span class="hljs-string">'px'</span>
  }
})
</code></pre>
<p><strong>这里有个细节设计得很赞：</strong></p>
<ul>
<li><code>top</code> / <code>left</code>：<strong>参与缩放</strong>。这意味着你给的坐标是相对于“设计稿左上角”的。</li>
<li><code>right</code> / <code>bottom</code>：<strong>不参与缩放</strong>。这意味着你给的坐标是相对于“屏幕边缘”的。</li>
</ul>
<p>这解决了大屏开发的一个痛点：<strong>中间内容要还原设计稿，但边缘菜单要贴边。</strong></p>
<h2 data-id="heading-5">💡 我们可以学到什么？</h2>
<ol>
<li><strong>API 设计要简单</strong>：用户只关心 <code>designWidth</code> 和 <code>designHeight</code>，不要把复杂的计算抛给用户。</li>
<li><strong>善用现代 API</strong>：<code>ResizeObserver</code> 比 <code>resize</code> 事件更好用。</li>
<li><strong>组件化思维</strong>：通过 <code>FitContainer</code> 把“定位计算”封装起来，业务代码里就全是干净的 px 值了。</li>
</ol>
<h2 data-id="heading-6">总结</h2>
<p>vfit 的源码虽然简单，但确实切中了痛点。
有时候造轮子不一定要多高深的技术，能<strong>优雅地解决一个小问题</strong>，就是一个好轮子。</p>
<p>推荐大家去读读它的源码，就几个文件，半小时就能看完。
👉 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fv-plugin%2Fvfit" target="_blank" title="https://github.com/v-plugin/vfit" ref="nofollow noopener noreferrer">GitHub: v-plugin/vfit</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 勇闯2D像素游戏之路（一）：一个 Hero 的诞生]]></title>    <link>https://juejin.cn/post/7579264485259411471</link>    <guid>https://juejin.cn/post/7579264485259411471</guid>    <pubDate>2025-12-03T10:26:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579264485259411471" data-draft-id="7578781397117337646" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 勇闯2D像素游戏之路（一）：一个 Hero 的诞生"/> <meta itemprop="keywords" content="游戏,游戏开发,Flutter"/> <meta itemprop="datePublished" content="2025-12-03T10:26:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="_大学牲"/> <meta itemprop="url" content="https://juejin.cn/user/3125273628517148"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 勇闯2D像素游戏之路（一）：一个 Hero 的诞生
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3125273628517148/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    _大学牲
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T10:26:29.000Z" title="Wed Dec 03 2025 10:26:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aec1a3e414794e86ba2a9d75c18f470d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362821&amp;x-signature=nBJqpKHLrUDvkvAZfB%2FcSTufOp0%3D" width="100%" loading="lazy"/></p><p/>
<h2 data-id="heading-0">前言</h2>
<p>小时候的我们，都有一个小小的游戏梦<br/>
什么 <strong>植物大战僵尸、红警、CF、LOL、王者荣耀</strong> ...<br/>
这些游戏无不手拿把掐<br/>
半夜躲在被窝里偷偷玩电脑、玩手机，那更是 <strong>基操勿六</strong></p>
<p>即使现在长大了，没时间玩了<br/>
💭 那份 <strong>热爱</strong>，从来没消失过 ...</p>
<p>本系列文章，我们就来看看如何使用 <strong>Flutter</strong> 开发一款 <code>2D像素风</code> 游戏。</p>
<blockquote>
<p>本着开源精神，所有 <strong>资源素材</strong> 及 <strong>源代码</strong> , 将在 <code>github</code> 上公开。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">Flame 开发引擎</h3>
<p><strong>Flame</strong> 是一个构建于 <strong>Flutter</strong> 之上的 <strong>轻量级 2D 游戏引擎</strong>。<br/>
让我们能够使用熟悉的 <code>Flutter + Dart</code> 技术栈快速制作跨平台游戏。<br/>
不需要我们深入研究底层渲染、动画系统、触摸事件管理或碰撞检测，就能轻松上手开发一款游戏。</p>
<p><strong>特点</strong>：</p>

































<table><thead><tr><th>功能模块</th><th>说明</th></tr></thead><tbody><tr><td>组件化系统（FCS）</td><td>游戏角色、背景、UI 全部组件化，结构清晰、扩展灵活。</td></tr><tr><td>游戏循环（Game Loop）</td><td>内置稳定帧循环，自动处理 <code>update()</code> 与 <code>render()</code>。</td></tr><tr><td>动画管理简单</td><td>Sprite / SpriteSheet / SpriteAnimation 使用便捷。</td></tr><tr><td>碰撞检测 &amp; 物理支持</td><td>自带碰撞系统，支持 Shape、Hitbox、物理模拟等。</td></tr><tr><td>输入处理统一</td><td>轻松处理点击、拖拽、多点触控、键盘、手柄等输入。</td></tr><tr><td>生态完善</td><td>拥有大量扩展插件，如 flame_audio、flame_behaviors、flame_rive、flame_forge2d 等。</td></tr></tbody></table>
<p><strong>拓展</strong>：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c105e2495a72466dbf75f8519bc84f63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362821&amp;x-signature=2y8nSIrlR5Hp7aYyQ9jfe%2B0tyK8%3D" width="100%" loading="lazy"/></p><p/>
<p>在今年 9 月 3 日 举办的 <strong>FlutterNFriends</strong> 大会上，Flame 还展示了关于 3D 游戏的支持 <code>flame_3d</code>。</p>
<blockquote>
<p><strong>Flame 3D</strong> 是 Flame 团队推出的基于 <strong>Flutter + Impeller</strong> 的轻量级 3D 游戏引擎扩展。它延续了 Flame 的组件化架构与简单 API，让开发者能用熟悉的 Dart 写出包含 3D 模型、光照、摄像机、交互等效果的场景。适用于移动端轻量 3D 游戏、展示类应用及 UI+3D 混合项目，学习门槛极低。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">素材推荐</h3>
<p>相信总会有一部分兄弟有一颗做游戏的心，但是苦于没有素材。<br/>
自己这三脚猫功夫，也不可能自己绘制。<br/>
在这里给大家推荐 <strong>两种方式</strong> ：</p>
<p><strong>1. itch.io</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f04b3521f57c412c9a3209d60303d079~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362821&amp;x-signature=v9WlWETU5kN96oNExZOuUR0PKlo%3D" width="100%" loading="lazy"/></p><p/>
<blockquote>
<p><strong>itch.io</strong> 是一个开放的独立游戏发布平台，同时也是开发者获取游戏素材的重要来源。平台上有大量由创作者上传的 <strong>像素素材、UI、地图瓦片、音效、背景音乐、角色动画、特效包</strong> 等资源，支持免费、付费或“随心付”
下载。开发者可以快速获取美术与音频资产，用于原型制作或正式项目。</p>
<p>🗺️  <strong>网站地址</strong> ：<a href="https://link.juejin.cn?target=https%3A%2F%2Fitch.io" target="_blank" title="https://itch.io" ref="nofollow noopener noreferrer">itch.io</a></p>
</blockquote>
<p><strong>2. Holopix AI</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc10f1882f964a0f8e4605ea4aab8e9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362821&amp;x-signature=iLOO1hAnBsy3HylVSDaFB41UE7c%3D" width="100%" loading="lazy"/></p><p/>
<blockquote>
<p><strong>Holopix AI</strong> 是一款专为游戏设计而生的 AI 美术平台，帮助开发者显著提升生产力。它通过文生图、草稿细化、多风格生成等能力，快速产出 2D 原画、角色、场景和 UI 素材；并支持 <strong>2D→3D 转换、局部精修、高清放大</strong> 等专业能力，让美术风格保持一致。平台还涵盖图生视频与营销素材生成，让 AI 无缝融入游戏创作与发行流程，非常适合独立开发者和小团队快速构建游戏原型与正式资源。</p>
<p>🗺️  <strong>网站地址</strong> ：<a href="https://link.juejin.cn?target=https%3A%2F%2Fholopix.cn" target="_blank" title="https://holopix.cn" ref="nofollow noopener noreferrer">holopix.cn</a></p>
</blockquote>
<hr/>
<h3 data-id="heading-3">精灵图</h3>
<blockquote>
<p><code>2D游戏</code> 的本质，其实可以归结为两点：</p>
<ul>
<li><strong>在一个平面世界里渲染图像</strong></li>
<li><strong>让图像根据规则动起来</strong>。</li>
</ul>
<p>玩家眼中看到的角色、怪物、背景、UI，其实都是一张张图像按顺序绘制出来的<br/>
无论是走路、跳跃、攻击，还是爆炸特效，本质都是：<strong>不断更新图片 → 渲染到屏幕 → 形成视觉动画</strong></p>
</blockquote>
<p>在早期图形系统中，这些可移动的小图像被称为 <strong>精灵（Sprite）</strong> ，是 2D 游戏世界中角色与物体的基础单位<br/>
随着游戏规模增大、资源增多，为了让这些 Sprite <strong>加载更快、渲染更高效、管理更统一</strong>，开发者进一步提出了：</p>
<p>👉 <strong>精灵图（Sprite Sheet）</strong></p>
<p>它将角色的所有动作帧、特效图块等合并到一张大图中，通过 <code>切图 + 帧序播放</code> 实现动画。<br/>
在 <strong>Flame</strong> 里，大多数角色动画、特效乃至 UI 图形，都是基于精灵图构建的。</p>
<blockquote>
<p><code>Sprite</code> 是 <strong>2D 游戏</strong> 显示的 <strong>基础单位</strong>，而 <code>精灵图</code> 则是让这些 <code>Sprite</code> 在现代游戏中更高效运作的资源组织方式。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f3079732e074bc29dd80f9ae2f8f483~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362821&amp;x-signature=Mlg2%2B8dnJtx15OZecIXX6VNIZFE%3D" alt="heart_animated_1.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce9155cd1621469484912088cb1cc66c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362821&amp;x-signature=ZPYFWkherDBA2d7jpeFFhSWbLDY%3D" alt="SPRITE_SHEET.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3259a59effab4baa96ceab77716d354a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362821&amp;x-signature=sYIw4hCUX%2BHK3sh%2B1nRA8BpXvKw%3D" alt="Tilemap Dungeon original size.png" loading="lazy"/></p>








































<table><thead><tr><th>优点✨</th><th>说明</th><th>效果</th></tr></thead><tbody><tr><td><strong>减少加载次数</strong></td><td>多帧动画只加载 1 张图，而不是多张图片</td><td>加载速度更快、进入场景不再卡顿</td></tr><tr><td><strong>降低内存与 GPU 纹理切换</strong></td><td>所有帧共享同一个纹理对象（GPU 优化）</td><td>更省内存、减少 GPU draw calls、游戏更稳定</td></tr><tr><td><strong>动画播放更流畅</strong></td><td>多帧在同一张图内，无需频繁切换纹理</td><td>动画更丝滑、掉帧概率更低</td></tr><tr><td><strong>减少 I/O（磁盘读取）</strong></td><td>一次加载大图比多次加载小图快得多</td><td>场景切换、人物加载速度显著提升</td></tr><tr><td><strong>资源管理更简单</strong></td><td>所有帧统一管理，不易出错</td><td>文件结构清晰、开发效率高</td></tr><tr><td><strong>Flame 原生优化支持</strong></td><td>Flame ImageCache、SpriteSheet、SpriteAnimation 等都为精灵图优化</td><td>代码更短、更快、更稳定</td></tr></tbody></table>
<h2 data-id="heading-4">MyHero</h2>
<h3 data-id="heading-5">一. 本章目标</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ccdbe7e34d4472a82792b9b6527a4d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362821&amp;x-signature=hxeUuCGCAtDG39r1P2DZlhOYlNY%3D" width="70%" loading="lazy"/></p><p/>
<h3 data-id="heading-6">二. 项目构建</h3>
<h4 data-id="heading-7">1. 引入依赖</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 最新版本以官网为准</span>
<span class="hljs-attr">flame:</span> <span class="hljs-string">^1.34.0</span>         <span class="hljs-comment"># Flame 主引擎：提供组件系统、渲染、动画、输入事件、碰撞检测等 2D 游戏核心功能</span>
<span class="hljs-attr">flame_audio:</span> <span class="hljs-string">^2.11.12</span>  <span class="hljs-comment"># 音频扩展库：简化 BGM、音效的加载和播放（底层基于 audioplayers）</span>
<span class="hljs-attr">flame_tiled:</span> <span class="hljs-string">^1.17.0</span>   <span class="hljs-comment"># 支持 Tiled 地图（*.tmx）解析，用于关卡设计、地形图层、碰撞层等</span>
</code></pre>
<blockquote>
<p>本章仅会用到 <code>flame</code> ,其他依赖会在后续文章中一一使用。</p>
</blockquote>
<h4 data-id="heading-8">2. 引入资源</h4>
<p>在项目，根目录下创建 <strong>assets/images/</strong> 文件夹，专门存储图片资源文件。<br/>
然后在 <code>pubspec.yaml</code> 中配置对应的文件夹。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/105c60e5c41045c6b5f468f4280bc25e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362821&amp;x-signature=AVti6OdfCY3tk28%2B%2FZzadknxotU%3D" alt="截屏2025-12-03 11.53.02.png" loading="lazy"/></p>
<hr/>
<p>这里的图片，是我在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fitch.io%2F" target="_blank" title="https://itch.io/" ref="nofollow noopener noreferrer">itch.io</a> ，找到的一个免费的资源。<br/>
像素小人 <a href="https://link.juejin.cn?target=https%3A%2F%2Flucky-loops.itch.io%2Fcharacter-satyr" target="_blank" title="https://lucky-loops.itch.io/character-satyr" ref="nofollow noopener noreferrer">塞提尔</a>。<br/>
包含了 <strong>待机、奔跑、攻击、死亡、游泳</strong> ... 多个动画。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/623a7426150c48bdbc072bb58e0de4ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362821&amp;x-signature=RdOvZaA%2FG83BZNEFtpNzLQYN9O4%3D" width="100%" loading="lazy"/></p> <img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be90d61a5f4f4aac94ac2214561cb9ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362821&amp;x-signature=%2FbvdSyDEZVUAZITcioSO7vh8OWk%3D" width="100%" loading="lazy"/><p/><p/>
<h4 data-id="heading-9">3. 初始化模板</h4>
<h5 data-id="heading-10">（1）项目目录说明</h5>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">lib</span>/
├── <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.dart</span>          <span class="hljs-comment">// 游戏入口</span>
├── <span class="hljs-selector-tag">game</span>/
│   ├── <span class="hljs-selector-tag">my_game</span><span class="hljs-selector-class">.dart</span>   <span class="hljs-comment">// 游戏核心逻辑</span>
│   ├── <span class="hljs-selector-tag">component</span>/     <span class="hljs-comment">// 游戏中各类组件（角色、敌人、道具等）</span>
│   └── <span class="hljs-selector-tag">state</span>/         <span class="hljs-comment">// 游戏对象的状态逻辑（角色状态、敌人 AI 等）</span>
</code></pre>
<ul>
<li>
<p><strong><code>main.dart</code></strong>:<br/>
启动 Flutter 应用，创建并挂载 <code>GameWidget</code>，作为游戏渲染入口。</p>
</li>
<li>
<p><strong><code>my_game.dart</code></strong>:<br/>
游戏主类，管理游戏世界（World）、相机、输入处理、更新循环、组件添加与调度。</p>
</li>
<li>
<p><strong><code>component/</code></strong>:<br/>
存放游戏中的各类可复用组件，比如：</p>
<ul>
<li>玩家角色 <code>PlayerComponent</code></li>
<li>敌人 <code>EnemyComponent</code></li>
<li>子弹、道具、障碍物等</li>
</ul>
<p>负责<strong>显示、动画、碰撞体积</strong>等具体表现。</p>
</li>
<li>
<p><strong><code>state/</code></strong>:<br/>
放置组件的 <strong>行为状态</strong> 逻辑，比如：</p>
<ul>
<li>角色状态（Idle、Run、Attack、Dead）</li>
<li>敌人状态机（Patrol、Chase、Attack、Die）</li>
<li>道具的生命周期状态</li>
</ul>
<p>把行为从组件中分离出来，使逻辑更清晰。</p>
</li>
</ul>
<hr/>
<h5 data-id="heading-11">（2）<code>main.dart</code> - 游戏入口</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'game/my_game.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flame/game.dart'</span>;

<span class="hljs-keyword">void</span> main() {
  runApp(
    GameWidget(
      game: MyGame(),
    ),
  );
}
</code></pre>
<ol>
<li><strong>GameWidget</strong>：
<ul>
<li>将 <code>MyGame</code> 游戏实例嵌入 Flutter Widget 树</li>
<li>自动处理：
<ul>
<li>每帧刷新 (<code>update</code> + <code>render</code>)</li>
<li>输入事件（触摸、手势、键盘）</li>
<li>屏幕尺寸变化 (<code>onGameResize</code>)</li>
</ul>
</li>
</ul>
</li>
<li><strong>runApp</strong>：
<ul>
<li>启动 Flutter 应用</li>
<li>显示游戏画面到屏幕</li>
</ul>
</li>
</ol>
<hr/>
<h5 data-id="heading-12">（3）<code>my_game.dart</code> - 游戏核心类</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:flame/game.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flutter/material.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyGame</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">FlameGame</span> </span>{

  <span class="hljs-meta">@override</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; onLoad() <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 加载游戏资源</span>
    <span class="hljs-keyword">super</span>.onLoad();
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> update(<span class="hljs-built_in">double</span> dt) {
    <span class="hljs-comment">// 游戏逻辑，每帧更新</span>
    <span class="hljs-keyword">super</span>.update(dt);
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> render(Canvas canvas) {
    <span class="hljs-comment">// 渲染逻辑</span>
    <span class="hljs-keyword">super</span>.render(canvas);
  }
}
</code></pre>
<ol>
<li>
<p><strong>FlameGame</strong>：</p>
<ul>
<li>Flame 的基础游戏类</li>
<li>自动管理组件 (<code>children</code>)</li>
<li>自动处理渲染循环</li>
</ul>
</li>
<li>
<p><strong>生命周期方法</strong>：</p>
<ul>
<li>
<p><code>onLoad()</code></p>
<ul>
<li>游戏启动时异步加载资源（图片、音效、精灵表等）</li>
<li>在这里可以 <code>add()</code> 组件到游戏中</li>
</ul>
</li>
<li>
<p><code>update(double dt)</code></p>
<ul>
<li>每帧调用一次，处理游戏逻辑</li>
<li><code>dt</code>：上一帧耗时（秒），用于实现帧率无关移动</li>
</ul>
</li>
<li>
<p><code>render(Canvas canvas)</code></p>
<ul>
<li>每帧绘制游戏画面</li>
<li><code>FlameGame</code> 会自动渲染已添加的组件</li>
</ul>
</li>
</ul>
</li>
</ol>
<hr/>
<h5 data-id="heading-13">（4）补充说明</h5>
<h6 data-id="heading-14">① 组件管理（Components）</h6>
<p>在 Flame 中，游戏中的任何元素（人物、背景、道具、碰撞体等）都应该封装成 <strong>Component</strong>。</p>
<p>常用组件类型：</p>
<ul>
<li><strong>PositionComponent</strong>：具有位置、大小、角度</li>
<li><strong>SpriteComponent</strong>：显示一张静态图片</li>
<li><strong>SpriteAnimationComponent</strong>：播放动画序列</li>
<li><strong>TextComponent</strong>：渲染文本</li>
<li><strong>自定义组件</strong>：继承 Component</li>
</ul>
<p><strong>👉 添加组件</strong><br/>
在 <code>onLoad()</code> 里添加：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-meta">@override</span>
Future&lt;<span class="hljs-keyword">void</span>&gt; onLoad() <span class="hljs-keyword">async</span> {
  add(HeroComponent());
  add(EnemyComponent());
  add(BackgroundComponent());
}
</code></pre>
<p>Flame 会负责：</p>
<ul>
<li>管理生命周期</li>
<li>自动调用组件的 <code>update()</code> 和 <code>render()</code></li>
<li>统一渲染顺序（可用 priority 调整层级）</li>
</ul>
<h6 data-id="heading-15">② 输入事件（Interaction）</h6>
<p>游戏需要交互时，只需要让 Game 类混入<code>能力模块</code>。</p>
<p>常见模块：</p>






























<table><thead><tr><th>输入类型</th><th>混入 (with xxx)</th><th>组件需继承</th></tr></thead><tbody><tr><td>点击</td><td><code>HasTappables</code></td><td><code>Tappable</code></td></tr><tr><td>拖拽</td><td><code>HasDraggables</code></td><td><code>Draggable</code></td></tr><tr><td>键盘</td><td><code>KeyboardEvents</code></td><td>—</td></tr><tr><td>手势（长按/双击）</td><td><code>HasGestureDetectors</code></td><td>—</td></tr></tbody></table>
<p><strong>👉 例如：点击让角色跳跃</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyGame</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">FlameGame</span> <span class="hljs-title">with</span> <span class="hljs-title">HasTappables</span> </span>{}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HeroComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SpriteAnimationComponent</span> <span class="hljs-title">with</span> <span class="hljs-title">Tappable</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-built_in">bool</span> onTapDown(TapDownInfo info) {
    <span class="hljs-comment">// 点击触发跳跃</span>
    y -= <span class="hljs-number">50</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
  }
}
</code></pre>
<h6 data-id="heading-16">③ 屏幕适配（onGameResize）</h6>
<p>当设备旋转、窗口变化时 Flame 会自动触发：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-meta">@override</span>
<span class="hljs-keyword">void</span> onGameResize(Vector2 size) {
  <span class="hljs-keyword">super</span>.onGameResize(size);
  <span class="hljs-built_in">print</span>(<span class="hljs-string">'新的屏幕大小 <span class="hljs-subst">$size</span>'</span>);
}
</code></pre>
<p>你可以用它来：</p>
<ul>
<li>居中角色</li>
<li>调整 UI 布局</li>
<li>计算碰撞区域</li>
</ul>
<p><strong>👉 例如：让主角始终在屏幕中心</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-meta">@override</span>
<span class="hljs-keyword">void</span> onGameResize(Vector2 gameSize) {
  <span class="hljs-keyword">super</span>.onGameResize(gameSize);
  position = gameSize / <span class="hljs-number">2</span>;
}
</code></pre>
<h3 data-id="heading-17">三. 英雄登场</h3>
<p>在完成前置条件之后，我们可以正式创建游戏中的第一个角色组件 <strong>HeroComponent</strong> ：<br/>
<code>HeroComponent</code> 代表玩家角色，它继承自 Flame 提供的 <code>SpriteAnimationComponent</code>，用于播放角色动画。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/050c6224e8de4af2b0e51c6f2f318ff9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362821&amp;x-signature=sgjHhx%2BdQNhlUrWsgz23TOR048I%3D" width="70%" loading="lazy"/></p><p/>
<h4 data-id="heading-18">1. HeroComponent 代码</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">import</span> <span class="hljs-string">'package:myhero/game/my_game.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flame/sprite.dart'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">'package:flame/components.dart'</span>;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HeroComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SpriteAnimationComponent</span> <span class="hljs-title">with</span> <span class="hljs-title">HasGameReference</span>&lt;<span class="hljs-title">MyGame</span>&gt; </span>{

  HeroComponent()
      : <span class="hljs-keyword">super</span>(
          size: Vector2(<span class="hljs-number">32</span>, <span class="hljs-number">32</span>),
          anchor: Anchor.center,
        );

  <span class="hljs-meta">@override</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; onLoad() <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 加载整张精灵图</span>
    <span class="hljs-keyword">final</span> image = <span class="hljs-keyword">await</span> game.images.load(<span class="hljs-string">'SPRITE_SHEET.png'</span>);

    <span class="hljs-comment">// 按 32×32 分割精灵表</span>
    <span class="hljs-keyword">final</span> sheet = SpriteSheet(
      image: image,
      srcSize: Vector2(<span class="hljs-number">32</span>, <span class="hljs-number">32</span>),
    );

    <span class="hljs-comment">// 创建动画（第 0 行，帧 0~5）</span>
    animation = sheet.createAnimation(
      row: <span class="hljs-number">0</span>,
      stepTime: <span class="hljs-number">0.15</span>,
      from: <span class="hljs-number">0</span>,
      to: <span class="hljs-number">5</span>,
      loop: <span class="hljs-keyword">true</span>,
    );

    <span class="hljs-comment">// 实际渲染大小放大为 100×100</span>
    size = Vector2(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>);

    <span class="hljs-comment">// 初始位置：屏幕中心</span>
    position = game.size / <span class="hljs-number">2</span>;
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> onGameResize(Vector2 size) {
    <span class="hljs-keyword">super</span>.onGameResize(size);

    <span class="hljs-comment">// 屏幕变化时保持英雄居中</span>
    position = size / <span class="hljs-number">2</span>;
  }
}
</code></pre>
<hr/>
<h4 data-id="heading-19">2. 代码详解</h4>
<h5 data-id="heading-20">① 继承 SpriteAnimationComponent</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HeroComponent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SpriteAnimationComponent</span>
</span></code></pre>
<p>选择这个组件是因为：</p>
<ul>
<li>可自动播放逐帧动画</li>
<li>支持 <code>animation = ...</code> 动态切换动画（后续可做 idle/run/attack）</li>
<li>已包含位置、大小、角度等属性</li>
</ul>
<hr/>
<h5 data-id="heading-21">② super 构造参数：size 与 anchor</h5>
<pre><code class="hljs language-dart" lang="dart">HeroComponent() : <span class="hljs-keyword">super</span>(size: Vector2(<span class="hljs-number">32</span>, <span class="hljs-number">32</span>), anchor: Anchor.center);
</code></pre>
<ul>
<li><code>size: Vector2(32, 32)</code>：逻辑上的精灵尺寸</li>
<li><code>anchor: Anchor.center</code>：组件位置以中心点为基准，便于旋转和居中显示</li>
</ul>
<hr/>
<h5 data-id="heading-22">③ onLoad：加载资源与初始化动画</h5>
<p><strong>1. 加载整张精灵图</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">final</span> image = <span class="hljs-keyword">await</span> game.images.load(<span class="hljs-string">'SPRITE_SHEET.png'</span>);
</code></pre>
<p>Flame 会自动缓存图片，同一个资源不会重复加载。</p>
<p><strong>2. 创建 SpriteSheet</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">final</span> sheet = SpriteSheet(image: image, srcSize: Vector2(<span class="hljs-number">32</span>, <span class="hljs-number">32</span>));
</code></pre>
<p>表示图片被切割成 32×32 的小格，是精灵图中角色动画每帧大小。</p>
<p><strong>3. 创建动画</strong></p>
<pre><code class="hljs language-dart" lang="dart"> animation = sheet.createAnimation(
      row: <span class="hljs-number">0</span>,
      stepTime: <span class="hljs-number">0.15</span>,
      from: <span class="hljs-number">0</span>,
      to: <span class="hljs-number">5</span>,
      loop: <span class="hljs-keyword">true</span>,
    );
</code></pre>
<ul>
<li>row：使用第 <strong>0 行</strong> 的动画帧</li>
<li>stepTime：每帧播放时间 <strong>0.15 秒</strong></li>
<li>from：从 <strong>帧 0 播到帧 5</strong></li>
<li>to：播放至该行 <strong>第5帧</strong></li>
<li>loop: 是否循环播放</li>
</ul>
<hr/>
<p><strong>4. 设置渲染尺寸</strong></p>
<pre><code class="hljs language-dart" lang="dart">    size = Vector2(<span class="hljs-number">100</span>, <span class="hljs-number">100</span>);
</code></pre>
<p>虽然原图是 32×32，但渲染时可以放大到 100×100 更清晰。</p>
<hr/>
<p><strong>5. 初次定位与屏幕适配</strong></p>
<ul>
<li>初次进入游戏时居中：
<pre><code class="hljs language-dart" lang="dart">position = game.size / <span class="hljs-number">2</span>;
</code></pre>
</li>
<li>屏幕尺寸变化时重新居中：
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> onGameResize(Vector2 size) {
      position = size / <span class="hljs-number">2</span>;
    }
</code></pre>
</li>
</ul>
<p>场景变化（横屏、竖屏、窗口大小变化）后，主角仍保持在屏幕中心。</p>
<h3 data-id="heading-23">四. 随心所动</h3>
<p>人物渲染出来后，最核心的交互能力就是 <strong>移动</strong>。<br/>
一个完善、自然、流畅的移动系统通常包含下面 <strong>三个关键步骤</strong>：</p>
<ol>
<li><strong>输入控制</strong>：捕获玩家操作（摇杆/键盘/手势）</li>
<li><strong>状态机驱动动画</strong>：根据移动状态切换对应动画</li>
<li><strong>方向控制</strong>：角色自动朝向移动方向（翻转）</li>
</ol>
<p>下面将一步步完善这三个部分。</p>
<hr/>
<h4 data-id="heading-24">1. 创建摇杆，实现基础移动</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eeeb775ce6d341808fecd57fa30a8f36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362821&amp;x-signature=87s12LKwww8shn6RuzSOoNOHX7w%3D" width="70%" loading="lazy"/></p><p/>
<p>移动的第一步是捕获玩家输入。<br/>
Flame 提供了现成的 <code>JoystickComponent</code>，通过它可以轻松实现虚拟摇杆控制。</p>
<p><strong>① 创建摇杆组件</strong>：</p>
<pre><code class="hljs language-dart" lang="dart">    <span class="hljs-comment">// 创建摇杆</span>
    joystick = JoystickComponent(
      knob: CircleComponent(radius: <span class="hljs-number">30</span>, paint: Paint()..color = Colors.white70),
      background: CircleComponent(
        radius: <span class="hljs-number">80</span>,
        paint: Paint()..color = Colors.black87,
      ),
      margin: <span class="hljs-keyword">const</span> EdgeInsets.only(left: <span class="hljs-number">50</span>, bottom: <span class="hljs-number">50</span>),
    );
</code></pre>
<p><strong>② 根据摇杆移动人物</strong></p>
<pre><code class="hljs language-dart" lang="dart"> <span class="hljs-comment">// 每秒移动速度</span>
  <span class="hljs-built_in">double</span> speed = <span class="hljs-number">160</span>;
  
  <span class="hljs-meta">@override</span>
    <span class="hljs-keyword">void</span> update(<span class="hljs-built_in">double</span> dt) {
      <span class="hljs-keyword">super</span>.update(dt);

      <span class="hljs-keyword">final</span> joy = game.joystick;

      <span class="hljs-keyword">if</span> (joy.direction != JoystickDirection.idle) {
        <span class="hljs-comment">// 获取单位方向向量，例如 (0.7, -0.3)</span>
        Vector2 dir = joy.relativeDelta;
        position += dir * speed * dt;
      }
    }
</code></pre>
<p>在移动更新逻辑中，我们主要关心两个变量：</p>
<ul>
<li>
<p><strong>direction（摇杆方向）</strong>：</p>























































<table><thead><tr><th>方向</th><th>角度范围（度）</th><th>简要说明</th></tr></thead><tbody><tr><td><strong>idle</strong></td><td>—</td><td>没有输入（<code>delta.isZero()</code>）</td></tr><tr><td><strong>up</strong></td><td>0° ~ 22.5°、337.5° ~ 360°</td><td>上方（包含左右两端的小范围）</td></tr><tr><td><strong>upRight</strong></td><td>22.5° ~ 67.5°</td><td>右上</td></tr><tr><td><strong>right</strong></td><td>67.5° ~ 112.5°</td><td>右</td></tr><tr><td><strong>downRight</strong></td><td>112.5° ~ 157.5°</td><td>右下</td></tr><tr><td><strong>down</strong></td><td>157.5° ~ 202.5°</td><td>下</td></tr><tr><td><strong>downLeft</strong></td><td>202.5° ~ 247.5°</td><td>左下</td></tr><tr><td><strong>left</strong></td><td>247.5° ~ 292.5°</td><td>左</td></tr><tr><td><strong>upLeft</strong></td><td>292.5° ~ 337.5°</td><td>左上</td></tr></tbody></table>
</li>
<li>
<p><strong>relativeDelta（标准化后的方向向量）</strong>：<br/>
它由摇杆当前的偏移量自动 <code>归一化</code> 得到，表示<strong>纯粹的方向</strong>（长度始终为 1）。</p>
</li>
</ul>
<blockquote>
<p>💡 <strong>position += dir * speed * dt 是如何计算的？</strong></p>
<p>按当前方向 <code>dir</code>，乘以移动速度 <code>speed</code>，乘以本帧的时间 <code>dt</code>，更新角色位置。<br/>
公式可以拆成：</p>
<pre><code class="hljs language-bash" lang="bash">位移 = 方向向量 <span class="hljs-built_in">dir</span> × 速度 speed × 时间 dt
新位置 = 旧位置 + 位移
</code></pre>
<p>举例：</p>
<ul>
<li><code>dir = (1, 0)</code>（向右）</li>
<li><code>speed = 200</code> 像素/秒</li>
<li><code>dt = 0.016</code>（60FPS）</li>
</ul>
<p>计算：</p>
<pre><code class="hljs language-scss" lang="scss">位移 = (<span class="hljs-number">1</span>, <span class="hljs-number">0</span>) * <span class="hljs-number">200</span> * <span class="hljs-number">0.016</span>
    = (<span class="hljs-number">3.2</span>, <span class="hljs-number">0</span>)
<span class="hljs-attribute">position</span> = <span class="hljs-attribute">position</span> + (<span class="hljs-number">3.2</span>, <span class="hljs-number">0</span>)
</code></pre>
<p>👉 角色这一帧 <strong>向右移动了 3.2 像素。</strong></p>
</blockquote>
<p>虽然这里已经完成了角色的<strong>位置移动</strong>，但此时角色的动画仍然停留在 <strong>待机（Idle）状态</strong>。<br/>
原因是：</p>
<ul>
<li><strong>目前只渲染了单个待机动画</strong> —— 未建立可切换的动画状态集合。</li>
<li><strong>移动逻辑和动画逻辑是独立的</strong> —— 位置改变不会自动切换到 <code>跑步/行走</code> 动画。</li>
</ul>
<h4 data-id="heading-25">2. 根据状态切换动画</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55d8bb0067b94b92b704218cd155c1df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362821&amp;x-signature=AqSEgik%2BwXo9Ben%2FoSol%2BE4fwf4%3D" width="70%" loading="lazy"/></p><p/>
<p>移动不仅要位移，还要 <strong>行为表现</strong>。<br/>
要使角色自然地 <code>走起来 / 停下来</code>，我们必须根据当前状态决定渲染哪个动画。</p>
<p><strong>① 定义角色状态</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">enum</span> HeroState {
 idle,
 run,
 swim,
 attack,
 hurt,
 die,
}
</code></pre>
<p><strong>② 状态改变时更新对应的动画</strong></p>
<pre><code class="hljs language-dart" lang="dart">HeroState state = HeroState.idle;

<span class="hljs-keyword">void</span> _setState(HeroState newState) {
  <span class="hljs-keyword">if</span> (state == newState) <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 避免重复切换</span>

  state = newState;
  animation = animations[state]!;
}
</code></pre>
<p><strong>③ 加载动画帧，生成动画集合</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">late</span> <span class="hljs-built_in">Map</span>&lt;HeroState, SpriteAnimation&gt; animations;

Future&lt;<span class="hljs-keyword">void</span>&gt; _loadAnimations() <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">final</span> image = <span class="hljs-keyword">await</span> game.images.load(<span class="hljs-string">'SPRITE_SHEET.png'</span>);
  <span class="hljs-keyword">final</span> sheet = SpriteSheet(image: image, srcSize: Vector2(<span class="hljs-number">32</span>, <span class="hljs-number">32</span>));

  animations = {
    HeroState.idle: sheet.createAnimation(
      row: <span class="hljs-number">0</span>,
      stepTime: <span class="hljs-number">0.15</span>,
      from: <span class="hljs-number">0</span>,
      to: <span class="hljs-number">6</span>,
      loop: <span class="hljs-keyword">true</span>,
    ),
    HeroState.run: sheet.createAnimation(
      row: <span class="hljs-number">1</span>,
      stepTime: <span class="hljs-number">0.10</span>,
      from: <span class="hljs-number">0</span>,
      to: <span class="hljs-number">8</span>,
      loop: <span class="hljs-keyword">true</span>,
    ),
  };
}
</code></pre>
<p><strong>④ 在 update() 中根据输入切换状态</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-meta">@override</span>
<span class="hljs-keyword">void</span> update(<span class="hljs-built_in">double</span> dt) {
  <span class="hljs-keyword">super</span>.update(dt);

  <span class="hljs-keyword">final</span> joy = game.joystick;

  <span class="hljs-keyword">if</span> (joy.direction == JoystickDirection.idle) {
    _setState(HeroState.idle);
  } <span class="hljs-keyword">else</span> {
    _setState(HeroState.run);
    position += joy.relativeDelta * speed * dt;
  }
}
</code></pre>
<p>至此，角色的动作已经可以<strong>随着摇杆移动自动切换动画</strong>，看起来行走更加自然。</p>
<p>但是当 <strong>摇杆方向</strong> 与 <strong>角色当前朝向</strong> 相 <strong>反</strong> 时，角色看起来就像 <strong>倒退行走</strong>，这显然不符合认知习惯。</p>
<h4 data-id="heading-26">3. 分析摇杆方向，实现左右翻转</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ccdbe7e34d4472a82792b9b6527a4d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362821&amp;x-signature=hxeUuCGCAtDG39r1P2DZlhOYlNY%3D" width="70%" loading="lazy"/></p><p/>
<p>一个横版 <code>RPG/ARPG</code> 中，角色通常使用 <strong>同一套竖直方向帧</strong>，需要通过 <strong>水平翻转</strong> 来表现 <code>朝左/朝右</code>。</p>
<blockquote>
<p>Flame 提供了翻转方法：<code>flipHorizontally()</code></p>
</blockquote>
<p><strong>① 具体翻转方法</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-built_in">bool</span> facingRight = <span class="hljs-keyword">true</span>;

<span class="hljs-keyword">void</span> _faceRight() {
  <span class="hljs-keyword">if</span> (!facingRight) {
    flipHorizontally();
    facingRight = <span class="hljs-keyword">true</span>;
  }
}

<span class="hljs-keyword">void</span> _faceLeft() {
  <span class="hljs-keyword">if</span> (facingRight) {
    flipHorizontally();
    facingRight = <span class="hljs-keyword">false</span>;
  }
}
</code></pre>
<p><strong>② 根据摇杆方向翻转角色</strong></p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">if</span> (joy.relativeDelta.x &gt; <span class="hljs-number">0</span>) {
  _faceRight();
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (joy.relativeDelta.x &lt; <span class="hljs-number">0</span>) {
  _faceLeft();
}
</code></pre>
<blockquote>
<p>通过判断摇杆 <code>relativeDelta.x</code> 的正负值，就可以确定角色应该面向的方向：</p>
<ul>
<li>当 <code>relativeDelta.x &gt; 0</code> 时，摇杆向右，角色应面向右方</li>
<li>当 <code>relativeDelta.x &lt; 0</code> 时，摇杆向左，角色应面向左方</li>
<li>当 <code>relativeDelta.x == 0</code> 时，角色水平朝向保持不变</li>
</ul>
</blockquote>
<p>这种方法非常简单高效，无需计算角度，在角色移动时自动翻转，避免了 <strong>倒退行走</strong>。</p>
<h3 data-id="heading-27">五. 总结与展望</h3>
<h4 data-id="heading-28">总结</h4>
<p>本章主要介绍了 <strong>Flutter&amp;Flame</strong> 开发 <strong>2D像素游戏</strong> 关于 <code>主角人物</code> 的基础实践。<br/>
通过上述步骤，我们完成了一个像素风游戏角色的搭建与移动控制，主要包括了以下内容：</p>
<ul>
<li><strong>角色与动画</strong>：使用精灵图 (<code>SpriteSheet</code>) 创建角色，支持 idle/run 等动画状态切换。</li>
<li><strong>玩家交互</strong>：通过摇杆控制角色移动，并根据方向翻转动画。</li>
</ul>
<h4 data-id="heading-29">展望</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48d840c0943b48dc974afc9d4952fefd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362821&amp;x-signature=n2oCiFWHuGWy4HCRsCh9s69HPUs%3D" width="100%" loading="lazy"/></p><p/>
<p align="center"><i>之前尝试的Demo预览</i></p>
<ul>
<li>
<p>在 <strong>Tiled</strong> 中制作专属地图，包含不同层级和碰撞区域。</p>
</li>
<li>
<p>在 Flutter 中加载地图，并完善碰撞逻辑。</p>
</li>
<li>
<p>实现相机跟随玩家移动。</p>
</li>
<li>
<p>完成攻击与技能系统，包括动画切换、攻击范围和远程弹道。</p>
</li>
<li>
<p>实现怪物生成、自动攻击与玩家碰撞逻辑。</p>
</li>
<li>
<p>支持局域网多玩家联机功能。</p>
</li>
</ul>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTheSyart%2Fmyhero" target="_blank" title="https://github.com/TheSyart/myhero" ref="nofollow noopener noreferrer">🚪 github 源码</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.shanchen.space" target="_blank" title="https://www.shanchen.space" ref="nofollow noopener noreferrer">💻 个人门户网站</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[windows自动任务定期执行]]></title>    <link>https://juejin.cn/post/7579453456018210857</link>    <guid>https://juejin.cn/post/7579453456018210857</guid>    <pubDate>2025-12-03T10:22:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579453456018210857" data-draft-id="7579213860572086326" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="windows自动任务定期执行"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-12-03T10:22:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿迷不想上班"/> <meta itemprop="url" content="https://juejin.cn/user/2799801568605741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            windows自动任务定期执行
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2799801568605741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿迷不想上班
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T10:22:26.000Z" title="Wed Dec 03 2025 10:22:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>需求：服务器附件转换会有一份缓存在本地，磁盘满了以后导致自动任务失败，搞一个bat或者ps1脚本通过windows的自动定时任务执行，避免转换中心服务停摆</p>
<h2 data-id="heading-0">直接上脚本</h2>
<pre><code class="hljs language-js" lang="js">@echo off
setlocal enabledelayedexpansion
:: 需要删除的缓存目标地址
set <span class="hljs-string">"TARGET_DIR=C:\filestorage"</span>
:: 月份参数（你想删几个月的）
set <span class="hljs-string">"MONTHS=3"</span>
:: log打印地址
set <span class="hljs-string">"LOG_FILE=C:\logs\cleanup_log.txt"</span>

echo %date% %time% 开始清理 &gt;&gt; <span class="hljs-string">"%LOG_FILE%"</span>

:: 计算<span class="hljs-number">3</span>个月前的日期
<span class="hljs-keyword">for</span> /f <span class="hljs-string">"tokens=1-3 delims=/"</span> %%a <span class="hljs-keyword">in</span> (<span class="hljs-string">"%date%"</span>) <span class="hljs-keyword">do</span> (
    set current_day=%%a
    set current_month=%%b
    set current_year=%%c
)

:: 这里使用<span class="hljs-title class_">PowerShell</span>来计算准确日期
<span class="hljs-keyword">for</span> /f <span class="hljs-string">"delims="</span> %%i <span class="hljs-keyword">in</span> (<span class="hljs-string">'powershell -Command "Get-Date (Get-Date).AddMonths(-%MONTHS%) -Format '</span>yyyyMMdd<span class="hljs-string">'"'</span>) <span class="hljs-keyword">do</span> (
    set cutoff_date=%%i
)

echo 正在清理 %<span class="hljs-variable constant_">TARGET_DIR</span>% 中超过 %<span class="hljs-variable constant_">MONTHS</span>% 个月的文件...
echo 截止日期: %cutoff_date%

:: 使用forfiles命令（需要<span class="hljs-title class_">Windows</span> <span class="hljs-title class_">Vista</span>及以上）
forfiles /p <span class="hljs-string">"%TARGET_DIR%"</span> /s /m *.* <span class="hljs-regexp">/d -%MONTHS% /</span>c <span class="hljs-string">"cmd /c echo 删除 @path &amp;&amp; del @path"</span>

echo %date% %time% 清理完成 &gt;&gt; <span class="hljs-string">"%LOG_FILE%"</span>
echo 清理完成！
pause
</code></pre>
<p>保存为<code>.bat</code>文件</p>
<p>可以先点击文件执行尝试（调试，填加更丰富的log，换清理逻辑就把<code>.bat后缀</code>改成<code>.txt后缀</code>再编辑）</p>
<p>如果文件比较重要建议<code>备份后再搞</code></p>
<p>如果你<code>看不到文件后缀</code></p>
<p>文件管理--查看--选项--更改文件夹和搜索选项</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c0056c62b3e49879ffe06d15526befa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6L-35LiN5oOz5LiK54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362146&amp;x-signature=XwaFgdLSGGMeWmTTcPrC2ehimBw%3D" alt="image.png" loading="lazy"/></p>
<p>取消掉这项--<code>隐藏已知文件类型的扩展名</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db9b0654355141138abfaa70a3c00593~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6L-35LiN5oOz5LiK54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362146&amp;x-signature=lyc706z7O3szpVkc2qXvRIFlJyM%3D" alt="image.png" loading="lazy"/></p>
<p>执行后就能看到一个这样的界面</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec09057ddcb048df92046df1aeb1132c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6L-35LiN5oOz5LiK54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362146&amp;x-signature=1uxO9tdDmLAcYk%2FUmAC7dTX4IqY%3D" alt="image.png" loading="lazy"/></p>
<p>如果<code>提示拒绝访问</code>也没什么事，权限问题，不耽误使用，右键管理员身份执行就没了</p>
<p>在日志中能看到<code>具体执行记录</code>（日志在我们的脚本里写了具体路径 LOG_FILE）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b897d2f4404c437eb314733a422adc26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6L-35LiN5oOz5LiK54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362146&amp;x-signature=q6Y0cTvUh82CdkjahOfYul0xC5w%3D" alt="image.png" loading="lazy"/></p>
<p>行得通后通过windows添加自动任务，记得把代码最后一行的<code>pause去掉</code>，不然会导致自动任务处于<code>一直执行</code>的状态</p>
<h2 data-id="heading-1">windows添加自动任务流程</h2>
<p><code>win+r</code>打开运行--输入<code>cmd</code>打开命令行窗口后--输入<code>taskschd.msc</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a21b5d788905464ca916edffe1f50b33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6L-35LiN5oOz5LiK54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362146&amp;x-signature=Hj3I3R3QrlkQmYC2BkJCiQxufm8%3D" alt="image.png" loading="lazy"/></p>
<p>右键任务计划程序库--创建基本任务--输入任务名称</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4489d5eb2164410b945ba585b1068cbc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6L-35LiN5oOz5LiK54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362146&amp;x-signature=XOykjzT7MJLckeyk1seeSngIkrQ%3D" alt="image.png" loading="lazy"/></p>
<p>触发器设置（按自己的需求来）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32714197e89a489a95b7d2f370f6e9e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6L-35LiN5oOz5LiK54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362146&amp;x-signature=sadDh8h9L82Np8FAsaq3jq6O4o0%3D" alt="image.png" loading="lazy"/></p>
<p>每日（设置执行时间，间隔）</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/553c2ecfb3014b0aba9e9d706fcf264c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6L-35LiN5oOz5LiK54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362146&amp;x-signature=eibKiUnwyC6CoN0kK7hNlNPceAM%3D" alt="image.png" loading="lazy"/></p>
<p>操作（默认即可）</p>
<p>启动程序--通过浏览选择我们之前创建的.bat的脚本的文件位置</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1776ffcb2931408eb7237b3d3765071f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6L-35LiN5oOz5LiK54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362146&amp;x-signature=NkL1pfVDRnAxIfQj5sY1lxfzQmc%3D" alt="image.png" loading="lazy"/></p>
<p>下一步，点击完成即可</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf87ec25fc3a4abbb4d2550a4953f611~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6L-35LiN5oOz5LiK54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362146&amp;x-signature=JAOTfwsKnWR0DMdAsHxre7dGUM8%3D" alt="image.png" loading="lazy"/></p>
<p>创建完成后还需要右键点击我们创建的任务--<code>属性</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72606845e42645b5a8555c1a53eace5a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6L-35LiN5oOz5LiK54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362146&amp;x-signature=KZCqy2qIFC1uNakxOeuPywbjGYw%3D" alt="image.png" loading="lazy"/></p>
<p>勾选常规选项卡中的它们</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d4866c7c28a420fa9d2a0e202f330bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6L-35LiN5oOz5LiK54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362146&amp;x-signature=PQav94bgpZ2LJjxi%2FNeQw0OPJmM%3D" alt="image.png" loading="lazy"/></p>
<p>条件中也有一些选项，按自己的需要来</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62df035fb9274441b7df7b7a96240791~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6L-35LiN5oOz5LiK54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362146&amp;x-signature=xmVZ9f4jUqZJcxJNMzgWU9ajoDg%3D" alt="image.png" loading="lazy"/></p>
<p>都处理好后就可以<code>点击运行</code>或者<code>修改执行时间</code>为下一分钟触发一下，看有没有成功了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbaad4c0fb6d4348a79dda30ddfa7309~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6L-35LiN5oOz5LiK54-t:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765362146&amp;x-signature=7Ui6F4iOrvzN7Rm1hOu5tjqzMcQ%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JPA 的脏检查：一次“没 save() 却更新了”的排查记录]]></title>    <link>https://juejin.cn/post/7579298511072493568</link>    <guid>https://juejin.cn/post/7579298511072493568</guid>    <pubDate>2025-12-03T10:28:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579298511072493568" data-draft-id="7577663384423825459" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JPA 的脏检查：一次“没 save() 却更新了”的排查记录"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-03T10:28:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="云烟飘渺o"/> <meta itemprop="url" content="https://juejin.cn/user/1978776662850525"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JPA 的脏检查：一次“没 save() 却更新了”的排查记录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1978776662850525/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    云烟飘渺o
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T10:28:59.000Z" title="Wed Dec 03 2025 10:28:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>第 11 篇 · 共100篇｜用代码丈量成长 —— 坚持写下去，就是最好的成长。</p>
<p>Hibernate：你不 save，我也要帮你 UPDATE</p>
<p>那天在排查一个挺诡异的事：<br/>
某个分表系统（用的是 ShardingSphere），日志里出现了奇怪的更新。明明业务逻辑只改了一条数据，最后路由日志却显示更新了好几张分表。</p>
<p>最开始我们都以为是 SQL 写错了，或者 ShardingSphere 的分片配置有问题。结果一通跟踪下来，发现问题根本不在 SQL，而在 <strong>JPA 自己干的“好事”</strong> 。</p>
<hr/>
<h3 data-id="heading-0">“我没 save()，它自己就 UPDATE 了？”</h3>
<p>当时业务代码大概长这样：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Transactional</span>
public void updateOrder() {
    <span class="hljs-attribute">Order</span> <span class="hljs-attribute">order</span> = orderRepo<span class="hljs-selector-class">.findById</span>(<span class="hljs-number">9527</span>L)<span class="hljs-selector-class">.orElseThrow</span>();
    <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setStatus</span>("PAID");
    <span class="hljs-attribute">order</span><span class="hljs-selector-class">.setUpdateTime</span>(new Date());
}
</code></pre>
<p>没调用 <code>save()</code>，也没写 <code>update</code> 语句，但提交事务时，数据库那边真的多了一条 UPDATE。<br/>
一开始我还以为是同事哪里调用错了，后来把日志和 SQL 都跟了一遍，才想起来——这是 JPA 的“脏检查”（Dirty Checking）。</p>
<p>JPA 查出来的实体在事务里是托管状态，Hibernate 会在事务提交前比对对象的快照，如果字段被改了，就自动发 UPDATE。<br/>
这机制平时挺贴心的，但在分表系统里就变成了个坑。</p>
<hr/>
<h3 data-id="heading-1">分表的锅：一个小 UPDATE，变成多表广播</h3>
<p>JPA 发的 UPDATE 语句是：</p>
<pre><code class="hljs language-bash" lang="bash">update orders <span class="hljs-built_in">set</span> status=?, update_time=? <span class="hljs-built_in">where</span> <span class="hljs-built_in">id</span>=?
</code></pre>
<p>如果分片键不是 <code>id</code>，或者 <code>WHERE</code> 条件没带上分片字段，ShardingSphere 就懵了——它不知道该发到哪张分表去，只能“全表广播更新”。</p>
<p>日志里就能看到：</p>
<pre><code class="hljs language-sql" lang="sql">Logic <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">update</span> orders <span class="hljs-keyword">set</span> status<span class="hljs-operator">=</span>?, update_time<span class="hljs-operator">=</span>? <span class="hljs-keyword">where</span> id<span class="hljs-operator">=</span>?
Actual <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">update</span> orders_1001_2025 ...
Actual <span class="hljs-keyword">SQL</span>: <span class="hljs-keyword">update</span> orders_1002_2025 ...
</code></pre>
<p>一条逻辑 SQL，打到了两张甚至多张分表上。<br/>
看着这些 UPDATE 日志，心里直犯嘀咕：这谁背得起啊。</p>
<hr/>
<h3 data-id="heading-2">对照实验：同样的逻辑，不同的状态</h3>
<p>为了确认是不是 JPA 自动干的，我们做了几个小实验。</p>
<h4 data-id="heading-3">情况一：有事务，自动 UPDATE</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">caseA</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Order</span> o = repo.<span class="hljs-title function_">findById</span>(9527L).<span class="hljs-title function_">orElseThrow</span>();
    o.<span class="hljs-title function_">setStatus</span>(<span class="hljs-string">"PAID"</span>);
    o.<span class="hljs-title function_">setUpdateTime</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());
}
</code></pre>
<p>提交事务时 Hibernate 会自动发 UPDATE。</p>
<h4 data-id="heading-4">情况二：detach 后再改，不会 UPDATE</h4>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Transactional</span>
public void caseB() {
    <span class="hljs-attribute">Order</span> o = repo<span class="hljs-selector-class">.findById</span>(<span class="hljs-number">9527</span>L)<span class="hljs-selector-class">.orElseThrow</span>();
    entityManager<span class="hljs-selector-class">.detach</span>(o);
    o<span class="hljs-selector-class">.setStatus</span>("CANCELLED");
}
</code></pre>
<p>因为被 <code>detach</code> 掉了，不再是托管对象，Hibernate 就不会再跟踪。<br/>
只是这种写法容易破坏工作单元的一致性，后续再 <code>merge</code> 回去挺麻烦，不太推荐。</p>
<h4 data-id="heading-5">情况三：只读事务，最干净的做法</h4>
<pre><code class="hljs language-ini" lang="ini">@Transactional(<span class="hljs-attr">readOnly</span> = <span class="hljs-literal">true</span>)
public UserDTO view(Long id) {
    User <span class="hljs-attr">u</span> = userRepo.findById(id).orElseThrow()<span class="hljs-comment">;</span>
    return toDto(u)<span class="hljs-comment">;</span>
}
</code></pre>
<p>只读事务 Hibernate 默认不 flush，用在纯查询场景下特别合适。<br/>
这种写法读起来就安全，不用担心哪天有人无意中改了个字段把数据库带跑偏。</p>
<hr/>
<h3 data-id="heading-6">最后的方案其实挺简单：</h3>
<p>查询完直接转 DTO，再改 DTO。<br/>
这样实体就不会处在托管状态，也不会触发自动更新。</p>
<p>从那之后，凡是看到有事务的地方改实体对象，大家都会多问一句：“这个改动是要落库的，还是只是展示？”<br/>
有时候小小一个约定，能省下很多奇怪的线上故障。</p>
<hr/>
<h3 data-id="heading-7">一点后话</h3>
<p>其实 JPA 的脏检查机制挺聪明的，它帮我们省掉了很多 save() 的麻烦。只是当系统复杂起来，比如有分表、有中间件、有异步逻辑时， <strong>“自动”反而成了风险</strong>。</p>
<p>那次排查让我意识到，ORM 的便利是有边界的。它能帮你管理状态，但你得清楚自己在哪个状态里动了手。</p>
<p>有时候写代码不是在防 bug，而是在防“好心办坏事”。</p>
<p>你的阅读与同行，让路途更有意义</p>
<p>愿我们一路向前，成为更好的自己</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【新模型速递】PAI-Model Gallery云上一键部署DeepSeek-V3.2模型]]></title>    <link>https://juejin.cn/post/7579264485259444239</link>    <guid>https://juejin.cn/post/7579264485259444239</guid>    <pubDate>2025-12-03T10:31:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579264485259444239" data-draft-id="7579264485259362319" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【新模型速递】PAI-Model Gallery云上一键部署DeepSeek-V3.2模型"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-03T10:31:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【新模型速递】PAI-Model Gallery云上一键部署DeepSeek-V3.2模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T10:31:29.000Z" title="Wed Dec 03 2025 10:31:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">模型介绍</h2>
<p>12月1日晚，DeepSeek又开源了两款新模型，<strong>DeepSeek-V3.2 和 DeepSeek-V3.2-Speciale</strong>，在推理能力上全球领先。</p>
<p>两款模型有着不同的定位。DeepSeek-V3.2的目标是平衡推理能力与输出长度，适合日常使用，例如问答场景和通用智能体任务场景。9月底DeepSeek发布了实验版V3.2-Exp，此次是正式版更新。在公开推理测试中，V3.2达到了GPT-5的水平，仅略低于谷歌的Gemini3 Pro。</p>
<p>DeepSeek-V3.2-Speciale的目标则是“将开源模型的推理能力推向极致，探索模型能力的边界”。据介绍，Speciale是V3.2的长思考增强版，同时结合了DeepSeek-Math-V2的定理证明能力，该模型具备出色的指令跟随、严谨的数学证明与逻辑验证能力。据DeepSeek公布的数据，Speciale在多个推理基准测试中超越谷歌最先进的Gemini3 Pro。</p>
<p>由于 DeepSeek-V3.2 模型的参数量高达 671B，本地难以直接部署模型，云端部署成为企业用户和开发者们部署的优先选择。</p>
<p>阿里云 PAI-Model Gallery 已第一时间接入 <strong>DeepSeek-V3.2、DeepSeek-V3.2-Speciale</strong> 模型，提供企业级部署方案。</p>
<h2 data-id="heading-1">PAI-Model Gallery 简介</h2>
<p>PAI-Model Gallery 是阿里云人工智能平台 PAI 的产品组件，它集成了国内外 AI 开源社区中优质的预训练模型，涵盖了 LLM、AIGC、CV、NLP 等各个领域。通过 PAI 对这些模型的适配，用户可以以零代码方式实现从训练到部署再到推理的全过程，简化了模型的开发流程，为开发者和企业用户带来了更快、更高效、更便捷的 AI 开发和应用体验。</p>
<p>PAI-Model Gallery 访问地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpai.console.aliyun.com%2F%23%2Fquick-start%2Fmodels" target="_blank" title="https://pai.console.aliyun.com/#/quick-start/models" ref="nofollow noopener noreferrer">pai.console.aliyun.com/#/quick-sta…</a></p>
<ul>
<li>
<p>零代码一键部署</p>
</li>
<li>
<p>自动适配云资源</p>
</li>
<li>
<p>部署后开箱即用API</p>
</li>
<li>
<p>全流程运维托管</p>
</li>
<li>
<p>企业级安全 数据不出域</p>
</li>
</ul>
<p><img src="https://static001.geekbang.org/infoq/9e/9e54f24bd7d97a35729759eee14f1293.png" alt="" loading="lazy"/></p>
<p><img src="https://static001.geekbang.org/infoq/2c/2c895fb66da536d68d9f6c4a464f1aff.png" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">一键部署 DeepSeek-V3.2 模型</h2>
<p>1. 在 PAI-Model Gallery 模型广场找到 <strong>DeepSeek-V3.2</strong> 模型，或通过链接直达该模型：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpai.console.aliyun.com%2F%23%2Fquick-start%2Fmodels%2FDeepSeek-V3.2%2Fintro" target="_blank" title="https://pai.console.aliyun.com/#/quick-start/models/DeepSeek-V3.2/intro" ref="nofollow noopener noreferrer">pai.console.aliyun.com/#/quick-sta…</a></p>
<p><img src="https://static001.geekbang.org/infoq/a9/a9c34f7530c76842a08b2edacb7647d4.png" alt="" loading="lazy"/></p>
<p>2. 在模型详情页右上角点击「部署」，平台支持SGLang、vLLM部署框架。<strong>平台提供多种部署模板，包括单机、分布式、EP+PD分离部署方案，内置默认配置，只需选择模板和计算资源，即可一键完成模型的云上部署，操作十分简便。</strong></p>
<p><img src="https://static001.geekbang.org/infoq/cd/cdf71a986121409b00bcc445756fc1c2.png" alt="" loading="lazy"/></p>
<p><img src="https://static001.geekbang.org/infoq/79/79be46480581ca070982e5eade2c03fc.png" alt="" loading="lazy"/></p>
<p><img src="https://static001.geekbang.org/infoq/9f/9f566f36b6d308ebfdd1e8977367e406.png" alt="" loading="lazy"/></p>
<p>3. 部署成功后，在服务页面可以点击“查看调用信息”获取调用的 Endpoint 和 Token，想了解服务调用方式可以点击预训练模型链接，返回模型介绍页查看调用方式说明。</p>
<p><img src="https://static001.geekbang.org/infoq/7d/7daeb2576f70cd6f1f8b8e882f9e9f13.png" alt="" loading="lazy"/></p>
<p>4. 使用推理服务：您可以在本地或使用各类客户端直接调用模型服务，也可以使用 PAI 平台提供的在线调试功能，此外您还可以使用 PAI 平台提供的 WebUI 界面与模型进行交互。可以参考使用文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fpai%2Fgetting-started%2Fmodel-gallery-quick-start%23091a6b66e9v4x" target="_blank" title="https://help.aliyun.com/zh/pai/getting-started/model-gallery-quick-start#091a6b66e9v4x" ref="nofollow noopener noreferrer">help.aliyun.com/zh/pai/gett…</a></p>
<h2 data-id="heading-3">更多模型支持</h2>
<p>PAI-Model Gallery 持续提供开源社区热门模型的快速部署、微调、蒸馏、评测实践，模型覆盖<strong>通义千问、通义万相、DeepSeek、Kimi、MiniMax、GLM</strong>等优秀开源模型，同时还提供 <strong>Qwen3-235B-A22B-PAI-optimized、Qwen3-Next-80B-A3B-Instruct-FP8-PAI-optimized、DeepSeek-R1-0528-PAI-optimized</strong> 等PAI优化版本模型，内置了PAI优化版的EP+PD分离部署等模板，性能更优。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于PixiJS的小游戏广告开发]]></title>    <link>https://juejin.cn/post/7579255046980190234</link>    <guid>https://juejin.cn/post/7579255046980190234</guid>    <pubDate>2025-12-03T09:38:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579255046980190234" data-draft-id="7579255046980108314" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于PixiJS的小游戏广告开发"/> <meta itemprop="keywords" content="前端,游戏开发,WebGL"/> <meta itemprop="datePublished" content="2025-12-03T09:38:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="福大命大"/> <meta itemprop="url" content="https://juejin.cn/user/2154698523020205"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于PixiJS的小游戏广告开发
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2154698523020205/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    福大命大
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T09:38:25.000Z" title="Wed Dec 03 2025 09:38:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">前言</h2>
<p>这是一个完整的试玩游戏广告，最终会投放到 <code>Moloco</code> 广告平台进行推广，游戏不算复杂，但是也是第一次接触这个类目，记录一下 😀😀😀</p>
<p>如果文章对你有帮助的话，<strong>记得一键三连哟</strong>。有问题和疑惑的话也可以在评论区留言。我会第一时间回复大家，如果觉得我的文章哪里有知识点错误的话，也恳请能够告知，把错的东西理解成对的，无论在什么行业，都是致命的。</p>
<h2 data-id="heading-1">项目概览</h2>
<h3 data-id="heading-2">技术栈</h3>
<ul>
<li><strong>PixiJS 8.x</strong>: 2D WebGL 渲染引擎，用来画游戏画面</li>
<li><strong>GSAP 3.x</strong>: 动画库，让元素动起来更流畅，强烈推荐</li>
<li><strong>TypeScript</strong>: 带类型检查的 JavaScript</li>
<li><strong>Vite</strong>: 现代化的打包工具</li>
<li><strong>@pixi/sound</strong>: 管理音效和背景音乐</li>
</ul>
<h3 data-id="heading-3">项目文件结构</h3>
<pre><code class="hljs language-plain" lang="plain">src/
├── main.ts                 # 程序入口
├── types.ts               # 类型定义
├── components/            # 游戏组件
│   ├── Background.ts      # 背景层
│   ├── Character.ts       # 左侧角色
│   ├── TopBar.ts         # 顶部栏(Logo/大奖/分数)
│   ├── SlotArea.ts       # 转轮区域容器
│   ├── SlotMachine.ts    # 转轮核心逻辑
│   ├── MaskOverlay.ts    # 引导遮罩
│   ├── BottomArea.ts     # 底部按钮
│   ├── GuideHand.ts      # 引导手势
│   ├── CoinRain.ts       # 金币雨特效
│   └── DownloadOverlay.ts # 下载弹窗
├── utils/
│   ├── responsive.ts     # 响应式适配
│   ├── textures.ts       # 纹理管理
│   ├── resources.ts      # 资源加载
│   ├── audio.ts         # 音频管理
│   ├── ad.ts            # 广告跳转
│   └── time.ts          # 时间工具
└── assets/              # 资源文件
</code></pre>
<h2 data-id="heading-4">核心系统实现</h2>
<h3 data-id="heading-5">程序启动流程</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 创建 PixiJS 应用</span>
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Application</span>();

<span class="hljs-comment">// 初始化配置</span>
<span class="hljs-keyword">await</span> app.<span class="hljs-title function_">init</span>({
  <span class="hljs-attr">backgroundColor</span>: <span class="hljs-number">0xffffff</span>,
  <span class="hljs-attr">resizeTo</span>: <span class="hljs-variable language_">window</span>, <span class="hljs-comment">// 自动适配窗口大小</span>
  <span class="hljs-attr">resolution</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">devicePixelRatio</span>, <span class="hljs-number">2</span>), <span class="hljs-comment">// 支持高清屏</span>
  <span class="hljs-attr">autoDensity</span>: <span class="hljs-literal">true</span>,
});

<span class="hljs-comment">// 初始化响应式系统(基于 375x667 设计稿)</span>
<span class="hljs-title function_">initResponsive</span>(app, <span class="hljs-number">375</span>, <span class="hljs-number">667</span>);

<span class="hljs-comment">// 加载所有资源</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">loadResources</span>();

<span class="hljs-comment">// 创建游戏场景</span>
<span class="hljs-title function_">createGameScene</span>();
</code></pre>
<h3 data-id="heading-6">响应式适配系统</h3>
<p>类似 CSS 的 Rem 单位：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 设计稿上的像素值转换成实际屏幕像素</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">rem</span>(<span class="hljs-params">px: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {
  <span class="hljs-keyword">const</span> scale = <span class="hljs-title function_">getScale</span>();
  <span class="hljs-keyword">return</span> px * scale;
}

<span class="hljs-comment">// 计算缩放比例</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getScale</span>(<span class="hljs-params"/>): <span class="hljs-built_in">number</span> {
  <span class="hljs-keyword">const</span> { width, height } = appInstance.<span class="hljs-property">screen</span>;

  <span class="hljs-comment">// 竖屏: 按宽度缩放</span>
  <span class="hljs-keyword">if</span> (height &gt; width) {
    <span class="hljs-keyword">return</span> width / <span class="hljs-variable constant_">DESIGN_WIDTH</span>; <span class="hljs-comment">// DESIGN_WIDTH = 375</span>
  }
  <span class="hljs-comment">// 横屏: 按高度缩放</span>
  <span class="hljs-keyword">return</span> height / <span class="hljs-variable constant_">DESIGN_HEIGHT</span>; <span class="hljs-comment">// DESIGN_HEIGHT = 667</span>
}
</code></pre>
<p><strong>使用方法</strong>:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 设计稿上某个元素位置是 (100, 200)</span>
sprite.<span class="hljs-property">x</span> = <span class="hljs-title function_">rem</span>(<span class="hljs-number">100</span>);
sprite.<span class="hljs-property">y</span> = <span class="hljs-title function_">rem</span>(<span class="hljs-number">200</span>);

<span class="hljs-comment">// 设计稿上字体大小是 24</span>
text.<span class="hljs-property">style</span>.<span class="hljs-property">fontSize</span> = <span class="hljs-title function_">rem</span>(<span class="hljs-number">24</span>);
</code></pre>
<h3 data-id="heading-7">资源管理</h3>
<h4 data-id="heading-8">纹理图集</h4>
<p>纹理就是把很多小图片加到一个大图片里面，包含了一个 json 文件记录小图片位置，我把所有小图片打包成三张大图，这样加载更快：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 主资源图集 (assets.png)</span>
<span class="hljs-comment">// 包含 UI、背景、按钮等</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">loadAssetsSheet</span>();

<span class="hljs-comment">// 图标图集 (assets_icons.png)</span>
<span class="hljs-comment">// 包含转轮上的各种图标</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">loadAssetsIconsSheet</span>();

<span class="hljs-comment">// 宣传图集 (promo_custom.png)</span>
<span class="hljs-comment">// 包含最终落地页素材</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">loadPromoCustomSheet</span>();

<span class="hljs-comment">// 使用时只需要传图片名称</span>
<span class="hljs-keyword">const</span> texture = <span class="hljs-title function_">getAssetsTexture</span>(<span class="hljs-string">"Character"</span>);
<span class="hljs-keyword">const</span> sprite = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sprite</span>(texture);
</code></pre>
<p><strong>图集的好处</strong>:</p>
<ul>
<li>一次请求下载多张图</li>
<li>减少服务器压力</li>
<li>GPU 渲染更高效</li>
</ul>
<h4 data-id="heading-9">音频管理</h4>
<p>音频也是一样，用@pixi/sound 进行播放，使用单例模式管理所有音效：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AudioManager</span> {
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">init</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 加载所有音效</span>
    <span class="hljs-keyword">await</span> sound.<span class="hljs-title function_">add</span>(<span class="hljs-string">"spinButton"</span>, spinButtonUrl);
    <span class="hljs-keyword">await</span> sound.<span class="hljs-title function_">add</span>(<span class="hljs-string">"reelClick"</span>, reelClickUrl);
    <span class="hljs-keyword">await</span> sound.<span class="hljs-title function_">add</span>(<span class="hljs-string">"backgroundMusic"</span>, backgroundMusicUrl);
  }

  <span class="hljs-keyword">public</span> <span class="hljs-title function_">playSpinButton</span>(<span class="hljs-params"/>) {
    sound.<span class="hljs-title function_">play</span>(<span class="hljs-string">"spinButton"</span>);
  }

  <span class="hljs-keyword">public</span> <span class="hljs-title function_">playBackgroundMusic</span>(<span class="hljs-params"/>) {
    sound.<span class="hljs-title function_">play</span>(<span class="hljs-string">"backgroundMusic"</span>, {
      <span class="hljs-attr">loop</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 循环播放</span>
      <span class="hljs-attr">volume</span>: <span class="hljs-number">0.5</span>, <span class="hljs-comment">// 音量 50%</span>
    });
  }
}
</code></pre>
<h3 data-id="heading-10">组件设计模式</h3>
<p>所有需要适配屏幕的组件都得实现 <code>Resizable</code> 这个接口：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Resizable</span> {
  <span class="hljs-title function_">resize</span>(...<span class="hljs-attr">args</span>: <span class="hljs-built_in">unknown</span>[]): <span class="hljs-built_in">void</span>;
}
</code></pre>
<p><strong>组件的生命周期</strong>:</p>
<ol>
<li><strong>构造</strong>: 创建精灵、设置初始位置</li>
<li><strong>Resize</strong>: 窗口变化时重新计算布局</li>
<li><strong>交互</strong>: 处理用户点击、拖动等</li>
<li><strong>销毁</strong>: 清理资源防止内存泄漏</li>
</ol>
<h2 data-id="heading-11">游戏流程设计</h2>
<h3 data-id="heading-12">场景层级</h3>
<p>页面中各个区块层级不一样，使用 <code>zIndex</code> 管理不同层级，数字越大越靠前：</p>
<pre><code class="hljs language-plain" lang="plain">Stage
├── Background (zIndex: 0) - 背景最底层
├── MaskOverlay (zIndex: 1) - 引导遮罩
├── Character (zIndex: 2) - 角色
├── BottomArea (zIndex: 3) - 按钮
├── SlotArea (zIndex: 4) - 转轮
├── TopBar (zIndex: 5) - 顶部UI
└── DownloadOverlay (zIndex: 100) - 弹窗最上层
</code></pre>
<h3 data-id="heading-13">游戏流程图</h3>
<pre><code class="hljs language-plain" lang="plain">用户进入
    ↓
[初始场景]
- 显示角色和引导
- Play 按钮 + 手势动画
- 播放背景音乐
    ↓
用户点击 Play
    ↓
[淡出动画]
- 角色淡出 (0.8秒)
- 遮罩淡出
- 按钮淡出
    ↓
[转轮旋转]
- 播放旋转音效
- 3个转轮依次启动
- 每个转 2 秒
- 依次停止
    ↓
[判断结果]
- 检查是否三个图标一样
- 分数增长动画
    ↓
[金币雨]
- 开始掉金币
- 金币下落+旋转+翻转
- 播放中奖音效
    ↓
[3秒后]
    ↓
[显示下载弹窗]
- 弹窗淡入
- 金币雨逐渐停止
</code></pre>
<h2 data-id="heading-14">核心功能实现</h2>
<h3 data-id="heading-15">游戏转轮</h3>
<h4 data-id="heading-16">状态机管理</h4>
<p>我用<code>状态机</code>来管理转轮状态，避免出现点两次按钮之类的 bug：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">SlotMachineState</span> {
  <span class="hljs-variable constant_">IDLE</span> = <span class="hljs-string">"IDLE"</span>, <span class="hljs-comment">// 空闲，可以点击</span>
  <span class="hljs-variable constant_">SPINNING</span> = <span class="hljs-string">"SPINNING"</span>, <span class="hljs-comment">// 正在转</span>
  <span class="hljs-variable constant_">STOPPING</span> = <span class="hljs-string">"STOPPING"</span>, <span class="hljs-comment">// 正在停止</span>
  <span class="hljs-variable constant_">STOPPED</span> = <span class="hljs-string">"STOPPED"</span>, <span class="hljs-comment">// 已停止</span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SlotMachineStateMachine</span> {
  <span class="hljs-title function_">canSpin</span>(): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-comment">// 只有空闲和已停止状态才能再次旋转</span>
    <span class="hljs-keyword">return</span> [<span class="hljs-title class_">SlotMachineState</span>.<span class="hljs-property">IDLE</span>, <span class="hljs-title class_">SlotMachineState</span>.<span class="hljs-property">STOPPED</span>].<span class="hljs-title function_">includes</span>(
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentState</span>
    );
  }
}
</code></pre>
<h4 data-id="heading-17">转轮动画</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Reel</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">spin</span>(
    <span class="hljs-attr">delay</span>: <span class="hljs-built_in">number</span>, <span class="hljs-comment">// 延迟启动</span>
    <span class="hljs-attr">targetIcon</span>: <span class="hljs-built_in">number</span>, <span class="hljs-comment">// 目标图标</span>
    <span class="hljs-attr">speed</span>: <span class="hljs-built_in">number</span>, <span class="hljs-comment">// 速度</span>
    <span class="hljs-attr">duration</span>: <span class="hljs-built_in">number</span> <span class="hljs-comment">// 持续时间</span>
  ): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-comment">// 1. 延迟启动(让3个转轮错开)</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(delay * <span class="hljs-number">1000</span>);

    <span class="hljs-comment">// 2. 加速阶段</span>
    gsap.<span class="hljs-title function_">to</span>(<span class="hljs-variable language_">this</span>, {
      <span class="hljs-attr">y</span>: <span class="hljs-string">`+=<span class="hljs-subst">${speed * <span class="hljs-number">3</span>}</span>`</span>,
      <span class="hljs-attr">duration</span>: <span class="hljs-number">0.3</span>,
      <span class="hljs-attr">ease</span>: <span class="hljs-string">"power2.in"</span>,
    });

    <span class="hljs-comment">// 3. 匀速旋转</span>
    gsap.<span class="hljs-title function_">to</span>(<span class="hljs-variable language_">this</span>, {
      <span class="hljs-attr">y</span>: <span class="hljs-string">`+=<span class="hljs-subst">${speed * duration}</span>`</span>,
      <span class="hljs-attr">duration</span>: duration,
      <span class="hljs-attr">ease</span>: <span class="hljs-string">"none"</span>,
    });

    <span class="hljs-comment">// 4. 减速停在目标图标</span>
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">stopAtIcon</span>(targetIcon);
  }
}
</code></pre>
<h4 data-id="heading-18">预设结果</h4>
<p>因为是试玩游戏，为了控制体验，直接预设几个游戏结果，随机抽取：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PRESET_RESULTS</span> = [
  [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>], <span class="hljs-comment">// 三个相同 - 中奖</span>
  [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>],
  [<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>],
  <span class="hljs-comment">// ...</span>
  [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>], <span class="hljs-comment">// 不同 - 不中奖</span>
];

<span class="hljs-comment">// 随机选一个</span>
<span class="hljs-keyword">const</span> resultIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-variable constant_">PRESET_RESULTS</span>.<span class="hljs-property">length</span>);
<span class="hljs-keyword">const</span> resultData = <span class="hljs-variable constant_">PRESET_RESULTS</span>[resultIndex];
</code></pre>
<h3 data-id="heading-19">金币雨特效</h3>
<p>游戏结束时金币下落效果</p>
<h4 data-id="heading-20">金币的属性</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">CoinSprite</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Sprite</span> {
  <span class="hljs-attr">speedY</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 下落速度</span>
  <span class="hljs-attr">speedX</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 水平漂移</span>
  <span class="hljs-attr">speedR</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 旋转速度</span>
  <span class="hljs-attr">flipSpeed</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 翻转速度(实现3D效果)</span>
  <span class="hljs-attr">flipPhase</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 翻转相位</span>
  <span class="hljs-attr">initialScale</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 初始大小</span>
}
</code></pre>
<h4 data-id="heading-21">创建金币</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-title function_">createCoin</span>(<span class="hljs-params">randomY: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span></span>) {
  <span class="hljs-keyword">const</span> coin = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Sprite</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">texture</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">CoinSprite</span>;

  <span class="hljs-comment">// 随机位置</span>
  coin.<span class="hljs-property">x</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-property">screen</span>.<span class="hljs-property">width</span>;
  coin.<span class="hljs-property">y</span> = randomY
    ? (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-property">screen</span>.<span class="hljs-property">height</span>) / <span class="hljs-number">2</span> - <span class="hljs-title function_">rem</span>(<span class="hljs-number">200</span>)
    : <span class="hljs-title function_">rem</span>(-<span class="hljs-number">50</span>); <span class="hljs-comment">// 从顶部开始</span>

  <span class="hljs-comment">// 随机大小 (0.3 - 0.6)</span>
  <span class="hljs-keyword">const</span> scale = (<span class="hljs-number">0.3</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.3</span>) * <span class="hljs-title function_">getScale</span>();
  coin.<span class="hljs-property">scale</span>.<span class="hljs-title function_">set</span>(scale);
  coin.<span class="hljs-property">initialScale</span> = scale;

  <span class="hljs-comment">// 随机物理属性</span>
  coin.<span class="hljs-property">speedY</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">speedMin</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * (<span class="hljs-variable language_">this</span>.<span class="hljs-property">speedMax</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">speedMin</span>);
  coin.<span class="hljs-property">speedX</span> = (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">1</span>;      <span class="hljs-comment">// 左右漂移</span>
  coin.<span class="hljs-property">speedR</span> = (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() - <span class="hljs-number">0.5</span>) * <span class="hljs-number">0.1</span>;    <span class="hljs-comment">// 旋转</span>
  coin.<span class="hljs-property">flipSpeed</span> = <span class="hljs-number">0.02</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">0.05</span>; <span class="hljs-comment">// 翻转快慢</span>
  coin.<span class="hljs-property">flipPhase</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span> * <span class="hljs-number">2</span>; <span class="hljs-comment">// 初始相位</span>

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">coins</span>.<span class="hljs-title function_">push</span>(coin);
}
</code></pre>
<h4 data-id="heading-22">动画更新</h4>
<p>这是整个特效的核心，每帧都会执行：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> update = <span class="hljs-function">(<span class="hljs-params">ticker: Ticker</span>) =&gt;</span> {
  <span class="hljs-comment">// 1. 生成新金币(如果没有停止)</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">isStopping</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">coins</span>.<span class="hljs-property">length</span> &lt; <span class="hljs-number">300</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">density</span>) { <span class="hljs-comment">// density = 0.2</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createCoin</span>();
    }
  }

  <span class="hljs-comment">// 2. 更新每个金币</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-variable language_">this</span>.<span class="hljs-property">coins</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; i--) {
    <span class="hljs-keyword">const</span> coin = <span class="hljs-variable language_">this</span>.<span class="hljs-property">coins</span>[i];

    <span class="hljs-comment">// 位置更新</span>
    coin.<span class="hljs-property">y</span> += coin.<span class="hljs-property">speedY</span> * ticker.<span class="hljs-property">deltaTime</span>;
    coin.<span class="hljs-property">x</span> += coin.<span class="hljs-property">speedX</span> * ticker.<span class="hljs-property">deltaTime</span>;
    coin.<span class="hljs-property">rotation</span> += coin.<span class="hljs-property">speedR</span> * ticker.<span class="hljs-property">deltaTime</span>;

    <span class="hljs-comment">// 3D翻转效果(通过缩放 x 轴模拟)</span>
    coin.<span class="hljs-property">flipPhase</span> += coin.<span class="hljs-property">flipSpeed</span> * ticker.<span class="hljs-property">deltaTime</span>;
    coin.<span class="hljs-property">scale</span>.<span class="hljs-property">x</span> = coin.<span class="hljs-property">initialScale</span> * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(coin.<span class="hljs-property">flipPhase</span>);

    <span class="hljs-comment">// 边界检查</span>
    <span class="hljs-keyword">if</span> (coin.<span class="hljs-property">y</span> &gt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-property">screen</span>.<span class="hljs-property">height</span> + <span class="hljs-title function_">rem</span>(<span class="hljs-number">50</span>)) {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isStopping</span>) {
        <span class="hljs-comment">// 停止阶段: 销毁掉出去的金币</span>
        coin.<span class="hljs-title function_">destroy</span>();
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">coins</span>.<span class="hljs-title function_">splice</span>(i, <span class="hljs-number">1</span>);
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 正常阶段: 循环利用，从顶部重新掉下来</span>
        coin.<span class="hljs-property">y</span> = <span class="hljs-title function_">rem</span>(-<span class="hljs-number">50</span>);
        coin.<span class="hljs-property">x</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-variable language_">this</span>.<span class="hljs-property">app</span>.<span class="hljs-property">screen</span>.<span class="hljs-property">width</span>;
      }
    }
  }

  <span class="hljs-comment">// 3. 如果停止且没有金币了，清理资源</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isStopping</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">coins</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cleanup</span>();
  }
};
</code></pre>
<h4 data-id="heading-23">性能优化技巧</h4>
<ol>
<li><strong>对象池思想</strong>: 金币掉出屏幕后不销毁，而是重置位置继续用</li>
<li><strong>数量限制</strong>: 最多 300 个金币，避免内存爆炸</li>
<li><strong>软停止</strong>: 调用 <code>stop()</code> 后不立即清理，让现有金币自然落完</li>
<li><strong>禁用交互</strong>: <code>coin.eventMode = "none"</code> 避免不必要的事件检测</li>
</ol>
<h3 data-id="heading-24">引导手势动画</h3>
<p>使用 GSAP Timeline 做循环动画：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">private</span> <span class="hljs-title function_">startAnimation</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeline</span> = gsap.<span class="hljs-title function_">timeline</span>({ <span class="hljs-attr">repeat</span>: -<span class="hljs-number">1</span> }); <span class="hljs-comment">// 无限循环</span>

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeline</span>
    <span class="hljs-comment">// 手指下压 + 旋转</span>
    .<span class="hljs-title function_">to</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mcPointer</span>, {
      <span class="hljs-attr">y</span>: <span class="hljs-title function_">rem</span>(<span class="hljs-number">10</span>),
      <span class="hljs-attr">rotation</span>: -<span class="hljs-number">0.1</span>,
      <span class="hljs-attr">duration</span>: <span class="hljs-number">0.3</span>,
      <span class="hljs-attr">ease</span>: <span class="hljs-string">"power2.out"</span>
    })
    <span class="hljs-comment">// 同时播放水波纹扩散</span>
    .<span class="hljs-title function_">to</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mcRing</span>, {
      <span class="hljs-attr">scale</span>: <span class="hljs-number">1.5</span>,
      <span class="hljs-attr">alpha</span>: <span class="hljs-number">0</span>,      <span class="hljs-comment">// 淡出</span>
      <span class="hljs-attr">duration</span>: <span class="hljs-number">0.6</span>,
      <span class="hljs-attr">ease</span>: <span class="hljs-string">"power2.out"</span>
    }, <span class="hljs-string">"&lt;"</span>)          <span class="hljs-comment">// "&lt;" 表示和上一个动画同时开始</span>
    <span class="hljs-comment">// 手指复位</span>
    .<span class="hljs-title function_">to</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mcPointer</span>, {
      <span class="hljs-attr">y</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">rotation</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">duration</span>: <span class="hljs-number">0.3</span>,
      <span class="hljs-attr">ease</span>: <span class="hljs-string">"power2.in"</span>
    })
    <span class="hljs-comment">// 暂停 0.5 秒</span>
    .<span class="hljs-title function_">to</span>({}, { <span class="hljs-attr">duration</span>: <span class="hljs-number">0.5</span> });
}
</code></pre>
<h2 data-id="heading-25"><code>Moloco</code>集成</h2>
<p>这个项目最终要在 <code>Moloco</code> 广告平台上运行，按他的需求给下载按钮添加以下代码：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleCTA</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 检查广告平台注入的全局对象</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">FbPlayableAd</span> !== <span class="hljs-string">"undefined"</span> &amp;&amp; <span class="hljs-title class_">FbPlayableAd</span>.<span class="hljs-property">onCTAClick</span>) {
    <span class="hljs-title class_">FbPlayableAd</span>.<span class="hljs-title function_">onCTAClick</span>(); <span class="hljs-comment">// 调用平台的跳转方法</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"【本地测试】模拟跳转"</span>);
  }
}
</code></pre>
<h2 data-id="heading-26">打包配置</h2>
<p><code>Moloco</code>要求产物是一个单独的<code>HTML</code>文件，要改一下 <code>Vite</code> 的打包配置：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// vite.config.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">viteSingleFile</span>()],
  <span class="hljs-attr">build</span>: {
    <span class="hljs-attr">assetsInlineLimit</span>: <span class="hljs-number">100000000</span>, <span class="hljs-comment">// 所有资源内联</span>
    <span class="hljs-attr">cssCodeSplit</span>: <span class="hljs-literal">false</span>, <span class="hljs-comment">// CSS 不分割</span>
    <span class="hljs-attr">minify</span>: <span class="hljs-string">"terser"</span>, <span class="hljs-comment">// 压缩代码</span>
  },
});
</code></pre>
<p>运行 <code>npm run build</code> 后得到一个 <code>HTML</code> 文件，  <code>HTML</code> 文件包含所有代码、图片、音频</p>
<h2 data-id="heading-27">总结</h2>
<p>尽管游戏比较简单，但整个开发过程让我对游戏开发有了初步的了解。这个项目没有涉及到碰撞检测、路由、骨骼动画以及资产包管理（AssetPack）等技术，未来有机会再去学习强化。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于物联网设计的蜂箱智能监测系统设计]]></title>    <link>https://juejin.cn/post/7579440586693836846</link>    <guid>https://juejin.cn/post/7579440586693836846</guid>    <pubDate>2025-12-03T09:03:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579440586693836846" data-draft-id="7579440586693820462" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于物联网设计的蜂箱智能监测系统设计"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-03T09:03:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="DS小龙哥"/> <meta itemprop="url" content="https://juejin.cn/user/968038836867111"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于物联网设计的蜂箱智能监测系统设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/968038836867111/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    DS小龙哥
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T09:03:31.000Z" title="Wed Dec 03 2025 09:03:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1小时+
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前言</h2>
<h3 data-id="heading-1">1.1 项目介绍</h3>
<h4 data-id="heading-2">【1】项目开发背景</h4>
<p>随着现代农业向智能化、精细化方向的不断演进，传统养蜂业面临的挑战日益凸显。传统的养蜂方式高度依赖养蜂人的经验和定期的人工开箱检查，这种模式不仅耗费大量人力物力，而且频繁的开箱操作会严重干扰蜂群的正常生活，甚至可能引起蜂群应激反应，影响蜂蜜产量与蜂群健康。此外，对于病虫害、天敌入侵、分蜂预兆等突发状况，传统管理方式往往响应迟缓，容易错失最佳干预时机，给养蜂业带来显著的经济损失。</p>
<p>在此背景下，将物联网（IoT）技术与现代传感技术相结合，应用于传统养蜂业的数字化转型，成为提升养蜂效率与科学管理水平的关键路径。物联网技术能够实现对环境和设备状态的远程、实时、无干扰监测，通过数据分析为生产决策提供科学依据。将这一技术应用于蜂箱，可以打破传统养蜂业在空间和时间上的限制，实现对蜂群状态的全天候、数据化、可视化管理，从而推动养蜂业从“经验养蜂”向“科学养蜂”的现代化升级。</p>
<p>本项目设计并实现一套基于物联网的蜂箱智能监测系统，以应对传统养蜂模式的痛点。该系统通过集成多种传感器，实时采集蜂箱内外的关键环境参数，如温度、湿度、重量、声音、震动及光照强度等。这些数据通过4G或Wi-Fi等无线通信方式，实时上传至云端服务器。养蜂管理者可以通过上位机软件远程访问这些数据，直观地了解蜂群的健康状况、活动规律以及蜂蜜的产出情况，并通过系统设定的报警阈值，及时获取如失重（可能的分蜂或饥饿）、超重（蜂蜜已满）、异常震动（天敌入侵）等预警信息，从而实现精准、高效、低干扰的现代化蜂群管理，最终达到降本增效、提升蜂蜜产量与品质的目的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f85f727f62884178a36a1b5c317b96e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=nKSfwATnYbsm04AOMU5WxMvjmHc%3D" alt="4" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b5b10b5ea4f48dbb5f440c71d17ca10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=XGr2n7NkjI4%2FvbZEy5YxL1MgMZ0%3D" alt="mermaid_20251203_313da6" loading="lazy"/></p>
<h4 data-id="heading-3">【2】设计实现的功能</h4>
<p>当前项目使用的相关软件工具、模块源码已经上传：<a href="https://link.juejin.cn?target=https%3A%2F%2Fccnr8sukk85n.feishu.cn%2Fwiki%2FQjY8weDYHibqRYkFP2qcA9aGnvb%3Ffrom%3Dfrom_copylink" target="_blank" title="https://ccnr8sukk85n.feishu.cn/wiki/QjY8weDYHibqRYkFP2qcA9aGnvb?from=from_copylink" ref="nofollow noopener noreferrer">ccnr8sukk85n.feishu.cn/wiki/QjY8we…</a></p>
<p>（1）使用 STM32F103C8T6 完成温湿度、重量、声音、震动等传感器的采集与数字处理。</p>
<p>（2）通过 HX711 完成蜂箱重量传感器（称重传感器）的高精度采集与校准。</p>
<p>（3）使用一个 DHT11 完成蜂箱内部温湿度精准测量，实现数据补偿与滤波。</p>
<p>（4）使用一个 DHT11 完成外部环境温湿度测量，上传对比分析数据。</p>
<p>（5）使用 MAX9814 麦克风模块采集蜂箱声学信息，用于蜂群活力判断。</p>
<p>（6）使用 SW420 震动模块采集蜂箱震动情况，实现异常震动报警。</p>
<p>（7）使用 BH1750 光照传感器测量外界光照强度，辅助判断蜂群活动周期。</p>
<p>（8）使用 OLED 0.96 显示屏显示实时的蜂箱内部温湿度、重量、光照等信息。</p>
<p>（9）使用 Air780E 模块实现 4G LTE 物联网数据通信或选择 ESP8266-WIFI，上传数据至华为云。</p>
<p>（10）通过 MQTT 协议实现蜂箱数据上报、阈值下发和报警推送。</p>
<p>（11）上位机采用 Qt（C++）实现数据接收可视化显示。</p>
<h4 data-id="heading-4">【3】项目硬件模块组成</h4>
<p>（1）主控模块：STM32F103C8T6 核心板</p>
<p>（2）内部温湿度传感器：DHT11</p>
<p>（3）外部环境温湿度传感器：DHT11</p>
<p>（4）重量传感器：10kg 称重传感器 + HX711 放大器</p>
<p>（5）声音采集模块：MAX9814 自动增益麦克风模块</p>
<p>（6）震动传感器：SW420 震动检测模块</p>
<p>（7）光照采集模块：BH1750</p>
<p>（8）通信模块：Air780E（4G LTE Cat1） 或ESP8266-01S</p>
<p>（9）显示模块：OLED 0.96 I2C 显示屏</p>
<p>（10）电源模块：DC-DC 5V/3.3V 稳压模块（AMS1117）</p>
<p>（11）电池：18650 锂电池 + 保护板 + 太阳能板（户外部署）</p>
<h4 data-id="heading-5">【4】设计意义</h4>
<p>本项目设计的智能蜂箱监测系统，其核心意义在于利用物联网和传感技术，将传统养蜂模式从依赖人力和经验的粗放式管理，转变为一种非侵入式、数据化的精细化管理模式。它解决了频繁开箱检查对蜂群造成的干扰问题，实现了对蜂箱内部状态的持续、无声监测，为养蜂业的现代化转型提供了切实可行的技术路径。</p>
<p>该设计的深远意义体现在它为养蜂决策提供了科学的数据支持。通过集成温度、湿度、重量、声音、光照和震动等多种传感器，系统能够构建一个关于蜂群健康、活力、繁殖和生产状态的多维度数据模型。养蜂人不再仅仅依赖主观经验来判断蜂群状况，而是可以根据实时、客观的数据进行分析。例如，通过对比箱内外温湿度和光照强度，可以更准确地评估蜂群的活动节律；通过分析声音频率，可以预判分蜂或病态等异常情况，从而将“经验养蜂”提升到“科学养蜂”的全新水平。</p>
<p>此系统显著提升了养蜂管理的效率与响应速度。借助4G或Wi-Fi无线通信模块，所有采集的数据都能实时传输至云服务器，并通过上位机软件进行可视化呈现。这意味着管理者可以随时随地远程监控蜂箱，极大地降低了巡查成本和劳动强度。更重要的是，基于重量和震动等关键指标的阈值报警功能，使得系统能够主动预警潜在风险，如蜂蜜满溢、蜂群失重（可能由分蜂或饥荒导致）或外部侵扰，使管理者能够第一时间采取干预措施，变被动管理为主动预防，有效规避经济损失。</p>
<p>本设计的现实意义还在于其高度的实用性和可部署性。系统提供了4G和Wi-Fi两种通信方案，使其能够灵活适应不同场地的网络条件，无论是偏远山区还是家庭农场。结合太阳能板和锂电池的供电方案，确保了设备在户外环境下的长期稳定运行。同时，本地OLED显示屏的设计也为现场维护和快速诊断提供了便利。这套完整的软硬件解决方案不仅是一个技术验证原型，更是一个具备实际应用价值、能够直接服务于养蜂生产、降低管理门槛、提升产业效益的智能化工具。</p>
<h4 data-id="heading-6">【5】市面上同类产品研究现状</h4>
<h5 data-id="heading-7">案例一：国内的先行者——天府蜂谷“大蜂慧”智能蜂箱</h5>
<p>四川天府蜂谷科技有限公司是国内智慧养蜂领域的代表企业之一。   他们的核心产品是“大蜂慧”AI养蜂系统，该系统深度融合了物联网与大数据技术。</p>
<ul>
<li><strong>核心功能</strong>：这套系统与您的设计非常相似，同样通过在蜂箱底部安装智能传感器，实时采集蜂箱的重量、蜜蜂出入蜂箱的次数（即“出勤率”）等数据。   这些数据通过无线网络传输到云端，用户可以通过手机App随时查看，实现了远程、无干扰的蜂箱状态监控。</li>
<li><strong>技术亮点</strong>：天府蜂谷强调其“蜜蜂多维大数据平台”，该平台不仅收集数据，还利用AI进行计算和分析，为养蜂户提供精准的数据服务和异常预警。   例如，通过分析蜂箱重量变化曲线，可以判断蜂蜜是否成熟，何时可以取蜜；通过监测蜜蜂出勤数据，可以评估蜂群的健康与活力。</li>
<li><strong>解决的痛点</strong>：该系统显著减少了传统养蜂中频繁的人工开箱检查，降低了70%的劳动量，同时减少了对蜂群50%的干扰。   对于养蜂大户来说，原本需要多人多天完成的巡查工作，现在只需少数人通过手机即可完成，大幅提升了管理效率。 此外，该公司还关注到了野外蜂场供电和网络覆盖的难题，并通过太阳能光伏板和优化的低功耗设计来应对。</li>
</ul>
<h5 data-id="heading-8">案例二：国际视野下的创新者——以色列Beewise公司的“BeeHome”</h5>
<p>Beewise是一家备受关注的以色列农业科技初创公司，他们推出的“BeeHome”产品，在智能化和自动化方面迈出了更大的一步。</p>
<ul>
<li><strong>核心功能</strong>：“BeeHome”不仅仅是一个监测设备，它更像一个机器人管家。它在一个大型箱体中容纳多个蜂群，并通过内置的机器人、计算机视觉和AI技术，实现24/7的全天候监测和自动干预。</li>
<li><strong>技术亮点</strong>：其最大的特色是“机器人养蜂”。系统通过摄像头和传感器监测蜂群，当AI算法发现问题时（如病虫害、蜂王问题、分蜂预兆等），机器人会自动采取行动，例如施药、调整环境或合并蜂群，全程无需人工介入。 Beewise声称这种方式能显著降低高达35%的蜂群崩溃率。</li>
<li>
<ul>
<li><strong>商业模式</strong>：Beewise的模式不仅是销售硬件，更侧重于提供授粉服务。他们与农场主合作，通过其高效的蜂群管理技术，确保作物授粉的质量和效率，解决了因蜂群数量下降导致的授粉服务价格上涨和供应不稳定的问题。</li>
</ul>
</li>
</ul>
<h5 data-id="heading-9">案例三：功能全面的解决方案提供商——慧养蜂</h5>
<p>“慧养蜂”是中国农业科学院蜜蜂研究所背景下的一个品牌，提供从硬件到软件的一整套智慧蜂业解决方案。</p>
<ul>
<li><strong>产品系列化</strong>：他们根据不同用户需求，推出了基础版、标准版、高级版等不同配置的智能蜂箱。 基础版侧重于内部环境监测和无线传输，由太阳能供电，易于部署。 而标准版则增加了视频监控和更精确的蜜蜂计数功能。</li>
<li><strong>平台化服务</strong>：除了智能硬件，他们还提供蜂产品质量安全追溯平台、蜂产业大数据管理决策平台和蜂业公共服务平台等。 这表明市场趋势正从单一的硬件销售，转向提供全产业链的数字化服务，包括生产管理、产品溯源和信息共享。</li>
</ul>
<h5 data-id="heading-10">总结与共性</h5>
<p>综合来看，市面上的同类产品在核心思路上通过传感器采集数据，实现远程监控和智能预警。   <strong>重量、温度、湿度</strong>是所有产品的标配监测指标。   <strong>声音监测</strong>也逐渐成为主流，用于分析蜂群的“脉动”和状态。   在通信方面，同样采用4G/LTE或Wi-Fi等方案将数据上传至云平台。</p>
<h4 data-id="heading-11">【6】摘要</h4>
<p>为解决传统养蜂业依赖人工、管理效率低下、干扰蜂群等问题，本项目设计并实现了一套基于物联网（IoT）的蜂箱智能监测系统。该系统以STM32F103C8T6单片机作为主控核心，集成DHT11温湿度传感器、HX711称重模块、MAX9814声音传感器、SW420震动传感器及BH1750光照传感器，实现对蜂箱内外环境、蜂群活力、蜂蜜产量及外部干扰等多维度信息的实时采集。系统支持通过Air780E（4G）或ESP8266（Wi-Fi）模块，利用MQTT协议将数据稳定上传至华为云IoTDA平台。同时，数据可在本地OLED屏幕上实时显示，并通过Qt开发的上位机软件进行远程可视化监控与报警阈值配置。本设计旨在实现对蜂箱的远程化、数据化、无干扰式管理，以提升养蜂的科学性与经济效益。</p>
<hr/>
<p><strong>关键字</strong></p>
<ul>
<li>物联网</li>
<li>智能蜂箱</li>
<li>STM32</li>
<li>传感器网络</li>
<li>MQTT</li>
<li>华为云</li>
<li>Qt</li>
</ul>
<h3 data-id="heading-12">1.2 设计思路</h3>
<p>本项目的设计思路围绕模块化、实用性和可扩展性展开，构建一个完整的“感知-传输-应用”物联网解决方案。整体架构分为三个核心层次：底层的数据采集端、中层的网络传输层以及顶层的云平台与用户应用层。通过这种分层设计，将复杂的系统功能解耦，使每个部分都能独立开发、测试和优化，最终集成为一个高效、可靠的智能监测系统。</p>
<p>在数据采集端，设计的核心是选用STM32F103C8T6作为主控芯片。选择此芯片是基于其强大的性能、丰富的片上外设资源（如ADC、I2C、SPI等）以及广泛的社区支持，足以胜任同时处理多个传感器数据的任务。传感器的选择则严格对应功能需求：通过两个DHT11传感器分别采集蜂箱内部和外部的温湿度，形成内外环境对比；采用高精度的HX711模块配合称重传感器，实现对蜂箱重量的精确测量，从而间接反映蜂蜜产量和蜂群规模；利用MAX9814麦克风和SW420震动模块，分别从声学和物理震动两个维度监测蜂群状态及外部威胁；并辅以BH1750光照传感器判断蜂群的昼夜活动周期。所有传感器数据由STM32进行统一的采集、滤波和初步处理，并通过本地的OLED显示屏为现场人员提供即时的数据反馈。</p>
<p>在网络传输层，设计充分考虑了不同部署场景的网络可用性，提供了4G和Wi-Fi两种灵活的通信方案。对于偏远、无Wi-Fi覆盖的野外蜂场，选用Air780E模组接入4G LTE网络；对于家庭或有Wi-Fi网络的场景，则可选用成本更低的ESP8266模块。通信协议选择了轻量级的MQTT协议，它基于发布/订阅模式，非常适合资源受限的物联网设备。设备作为客户端，将采集到的各项数据发布到云服务器的指定主题（Topic），同时订阅配置主题，以接收云端下发的报警阈值等指令，实现了设备与云平台之间高效、低功耗的双向通信。</p>
<p>在云平台与应用层，系统以华为云IoTDA作为数据中枢。该平台负责设备的接入认证、数据流的接收、存储以及规则引擎的配置，为后续的数据分析和应用开发提供了坚实的基础。报警功能（如超重、失重、异常震动）的核心逻辑在云端实现，当上报的数据触发预设阈值时，平台能够主动推送报警信息。最终，面向用户的交互界面通过Qt（C++）开发的上位机软件实现。该软件通过订阅云平台相应的数据主题，将接收到的实时数据直观形式进行可视化展示，并能接收和显示报警通知，从而让管理者可以远程、清晰地掌握蜂箱的全部动态，实现科学决策。</p>
<h3 data-id="heading-13">1.3 系统功能总结</h3>











































































<table><thead><tr><th>功能类别</th><th>具体功能描述</th><th>实现方式/涉及模块</th></tr></thead><tbody><tr><td><strong>数据采集</strong></td><td>采集蜂箱内部的实时温度和湿度。</td><td>STM32F103C8T6 + 内部DHT11传感器</td></tr><tr><td/><td>采集蜂箱外部环境的实时温度和湿度。</td><td>STM32F103C8T6 + 外部DHT11传感器</td></tr><tr><td/><td>高精度采集蜂箱重量，反映蜂蜜量与蜂群规模。</td><td>10kg称重传感器 + HX711放大器 + STM32</td></tr><tr><td/><td>采集蜂箱内部声音，用于分析蜂群状态。</td><td>MAX9814麦克风模块 + STM32</td></tr><tr><td/><td>采集蜂箱入口震动，判断外部干扰或攻击。</td><td>SW420震动模块 + STM32</td></tr><tr><td/><td>采集外部环境光照强度，辅助判断蜂群活动周期。</td><td>BH1750光照传感器 + STM32</td></tr><tr><td><strong>数据传输</strong></td><td>支持4G或Wi-Fi网络将数据上传至云服务器。</td><td>Air780E (4G LTE) 或 ESP8266 (Wi-Fi)</td></tr><tr><td/><td>通过MQTT协议实现数据上报和指令下发。</td><td>MQTT协议栈 (在通信模块和STM32上实现)</td></tr><tr><td><strong>本地交互</strong></td><td>在蜂箱本地实时显示各项关键数据。</td><td>OLED 0.96寸I2C显示屏</td></tr><tr><td><strong>远程监控</strong></td><td>在上位机软件上实时可视化显示蜂箱数据。</td><td>Qt (C++) 开发的上位机软件</td></tr><tr><td><strong>智能报警</strong></td><td>支持服务器端配置报警阈值（温度、湿度、重量、声音）。</td><td>华为云IoTDA平台规则引擎</td></tr><tr><td/><td>实现蜂蜜过载或异常减重时的报警。</td><td>基于重量数据和云端阈值配置</td></tr><tr><td/><td>实现蜂箱异常震动时的报警。</td><td>基于震动数据和云端阈值配置</td></tr></tbody></table>
<h3 data-id="heading-14">1.4 开发工具的选择</h3>
<h4 data-id="heading-15">【1】设备端开发</h4>
<p>硬件设备端的开发主要依赖于C语言，利用该语言直接操作硬件寄存器，确保系统运行的高效性和低延迟。C语言在嵌入式开发中具有广泛的应用，它能够直接访问硬件，满足对资源消耗和响应速度的严格要求。为了编写高效、稳定的代码，开发工具选择了<strong>Keil uVision 5</strong>作为主要的开发环境。Keil是一个专业的嵌入式开发工具，广泛应用于基于ARM架构的微控制器（如STM32）开发。Keil提供了完善的调试、编译和仿真支持，能够帮助在软件开发过程中高效地进行调试、单步执行以及断点设置，确保开发的稳定性和高效性。
STM32F103RCT6是项目中使用的主控芯片，它基于ARM Cortex-M3架构，拥有强大的计算能力和丰富的外设接口。在硬件编程中，寄存器级编程是常用的方式，这要求开发者对芯片的硬件寄存器有深入的理解。在Keil环境中，通过STM32的寄存器直接控制GPIO、ADC、I2C、SPI等硬件接口，以满足各个硬件模块（如传感器、执行器、显示屏等）与主控芯片的交互。使用寄存器编程能够提供更高效、精确的控制，避免了外部库的开销，同时也能深入调控硬件特性，提升系统性能。</p>
<h4 data-id="heading-16">【2】上位机开发</h4>
<p>本项目的上位机开发基于<strong>Qt 5</strong>框架，使用**C++**作为主要编程语言。Qt是一个跨平台的应用开发框架，广泛用于开发GUI应用程序。Qt提供了丰富的GUI组件和工具，能够高效地实现图形界面的设计与开发。C++则作为Qt的底层语言，具有高效的性能和良好的控制力，非常适合用于处理设备与系统之间的数据交互、通信协议的实现和复杂的计算任务。在项目中，Qt被用于开发Windows平台的桌面应用程序以及Android平台的手机APP。Qt框架的跨平台特性使得开发者能够使用同一套代码在不同操作系统上进行构建和部署，大大提高了开发效率。</p>
<p>为了方便开发和调试，上位机的开发采用了<strong>Qt Creator</strong>作为主要的集成开发环境（IDE）。Qt Creator是一款由Qt官方提供的开发工具，专为Qt应用程序开发设计，支持C++、QML和JavaScript等语言。Qt Creator提供了丰富的功能，如代码编辑、调试、构建、版本控制集成等，能够显著提升开发者的生产力。在本项目中，Qt Creator为开发者提供了自动化构建、界面设计工具（如Qt Designer）和调试工具（如QDebug和QML调试工具），使得开发过程更加高效和流畅。
上位机与硬件设备端的通信采用了基于TCP/IP协议的数据传输方式。为了实现这一功能，Qt提供了丰富的网络编程支持，尤其是<strong>QTcpSocket</strong>和<strong>QTcpServer</strong>类，使得上位机能够轻松地与硬件设备建立TCP连接，进行数据收发。上位机通过WIFI连接ESP8266-WIFI模块，ESP8266模块创建TCP服务器，上位机应用则作为客户端连接到服务器，进行实时的数据传输与控制命令的下发。
为了满足不同用户的需求，本项目需要支持Windows平台的桌面应用和Android平台的移动APP。Qt的跨平台特性使得开发人员能够在一个代码库下完成多平台应用的开发和移植。开发者仅需要编写一次应用逻辑和用户界面，就可以通过Qt的跨平台构建工具生成Windows和Android两个平台的可执行文件。此外，Qt提供了丰富的文档和社区支持，帮助开发者解决平台差异和兼容性问题，确保应用在不同平台上都能稳定运行。</p>
<p>总体而言，上位机开发环境采用了Qt 5框架和C++语言，结合Qt Creator集成开发环境，提供了一个高效、稳定、跨平台的开发工具链。通过Qt强大的GUI设计、网络通信、多线程支持以及数据库管理功能，开发者能够轻松实现与硬件设备的交互、控制设备、处理传感器数据，并为用户提供直观、流畅的操作体验。</p>
<h3 data-id="heading-17">1.5 模块的技术详情介绍</h3>
<p>(1) <strong>主控模块：STM32F103C8T6 核心板</strong></p>
<ul>
<li><strong>功能</strong>：作为整个系统的“大脑”，负责协调各传感器的数据采集、信号处理、逻辑判断以及控制通信模块与云端交互。</li>
<li><strong>特点</strong>：基于 ARM Cortex-M3 内核，拥有丰富的外设资源（如 ADC、I2C、USART 等），处理速度快，功耗较低，且开发生态成熟，性价比高，完全满足多传感器并行工作的需求。</li>
</ul>
<p>(2) <strong>温湿度传感器：DHT11</strong></p>
<ul>
<li><strong>功能</strong>：分别用于采集蜂箱内部和外部环境的温度与湿度数据。</li>
<li><strong>特点</strong>：采用单总线数字通信，集成度高，自带校准功能。虽然精度相对中等，但稳定性好、响应速度快且成本低廉，非常适合一般的环境温湿度监测场景。</li>
</ul>
<p>(3) <strong>重量检测模块：10kg 称重传感器 + HX711 放大器</strong></p>
<ul>
<li><strong>功能</strong>：实时测量蜂箱的总重量，通过重量变化监测蜂蜜产量、蜂群数量变化及异常失重情况。</li>
<li><strong>特点</strong>：HX711 是一款专为高精度电子秤设计的 24 位 A/D 转换芯片，具有极高的集成度和抗干扰能力。配合全桥式称重传感器，能实现微小重量变化的精准捕捉。</li>
</ul>
<p>(4) <strong>声音采集模块：MAX9814 自动增益麦克风</strong></p>
<ul>
<li><strong>功能</strong>：采集蜂箱内部的音频信号，用于后续分析蜂群的鸣叫频率和强度，以判断蜂群是否处于躁动或分蜂状态。</li>
<li><strong>特点</strong>：内置自动增益控制（AGC）功能，能够在周围环境声音过大时自动降低增益，声音过小时自动提高增益，从而保证采集到的蜂群声音信号幅度稳定，噪声更低。</li>
</ul>
<p>(5) <strong>震动传感器：SW420 震动检测模块</strong></p>
<ul>
<li><strong>功能</strong>：监测蜂箱受到的物理震动，用于检测是否有天敌入侵（如熊、獾）或人为破坏等外部攻击行为。</li>
<li><strong>特点</strong>：基于常闭型震动传感器设计，灵敏度可通过电位器调节。输出为数字开关量（0或1），能够直接触发单片机中断，响应迅速，误报率通过调节可控。</li>
</ul>
<p>(6) <strong>光照采集模块：BH1750</strong></p>
<ul>
<li><strong>功能</strong>：测量外界环境的光照强度（Lux），辅助系统判断当前的昼夜状态及天气情况，分析蜂群出勤与光照的关系。</li>
<li><strong>特点</strong>：采用 I2C 总线接口，能够直接输出数字光照值，无需复杂的计算和校准。其光谱响应特性接近人眼视觉，测量范围宽，受红外线影响小。</li>
</ul>
<p>(7) <strong>通信模块：Air780E (4G) 或 ESP8266 (Wi-Fi)</strong></p>
<ul>
<li><strong>功能</strong>：负责将单片机处理后的数据打包，通过 MQTT 协议发送至华为云 IoTDA 平台。</li>
<li><strong>特点</strong>：
<ul>
<li><strong>Air780E</strong>：支持 LTE Cat.1 网络，广域网覆盖，传输速率适中，适合没有 Wi-Fi 的野外偏远蜂场部署。</li>
<li><strong>ESP8266</strong>：集成度高的 Wi-Fi 模块，成本极低，适合家庭农场或有无线网络覆盖的区域，开发便捷。</li>
</ul>
</li>
</ul>
<p>(8) <strong>显示模块：OLED 0.96 I2C 显示屏</strong></p>
<ul>
<li><strong>功能</strong>：作为本地人机交互界面，实时轮播显示温湿度、重量、系统状态等关键信息，方便现场巡查。</li>
<li><strong>特点</strong>：自发光技术（无需背光），对比度高，可视角广，功耗极低。使用 I2C 接口，仅需占用单片机两个 I/O 口，节省资源。</li>
</ul>
<p>(9) <strong>电源系统：AMS1117 稳压与锂电池供电</strong></p>
<ul>
<li><strong>功能</strong>：为系统各模块提供稳定、纯净的电压（3.3V 和 5V），并保障户外持续运行。</li>
<li><strong>特点</strong>：AMS1117 系列具有低压差特性，输出电压稳定。配合 18650 锂电池和太阳能充电板，构成了可循环的绿色供电系统，解决了户外设备取电难的问题。</li>
</ul>
<h2 data-id="heading-18">二、部署华为云物联网平台</h2>
<p>华为云官网: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.huaweicloud.com%2F" target="_blank" title="https://www.huaweicloud.com/" ref="nofollow noopener noreferrer">www.huaweicloud.com/</a></p>
<p>打开官网，搜索物联网，就能快速找到 <code>设备接入IoTDA</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1382e8b60ae44a93b28a934e32066648~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=0JNKEhw%2FWioH%2FNGz5sCtbosLkj4%3D" alt="image-20221204193824815" loading="lazy"/></p>
<h3 data-id="heading-19">2.1 物联网平台介绍</h3>
<p>华为云物联网平台（IoT 设备接入云服务）提供海量设备的接入和管理能力，将物理设备联接到云，支撑设备数据采集上云和云端下发命令给设备进行远程控制，配合华为云其他产品，帮助我们快速构筑物联网解决方案。</p>
<p>使用物联网平台构建一个完整的物联网解决方案主要包括3部分：物联网平台、业务应用和设备。</p>
<p>物联网平台作为连接业务应用和设备的中间层，屏蔽了各种复杂的设备接口，实现设备的快速接入；同时提供强大的开放能力，支撑行业用户构建各种物联网解决方案。</p>
<p>设备可以通过固网、2G/3G/4G/5G、NB-IoT、Wifi等多种网络接入物联网平台，并使用LWM2M/CoAP、MQTT、HTTPS协议将业务数据上报到平台，平台也可以将控制命令下发给设备。</p>
<p>业务应用通过调用物联网平台提供的API，实现设备数据采集、命令下发、设备管理等业务场景。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f9b29ee3c1aa4f389bda6f0d5e11eee7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=HN%2FGYH3MukYbuBMwGQ30b631QGg%3D" alt="img" loading="lazy"/></p>
<h3 data-id="heading-20">2.2 开通物联网服务</h3>
<p>地址： <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.huaweicloud.com%2Fproduct%2Fiothub.html" target="_blank" title="https://www.huaweicloud.com/product/iothub.html" ref="nofollow noopener noreferrer">www.huaweicloud.com/product/iot…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a0353113269441c8a9eac4f1c881cfe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=1PWC%2BskCqXtD8PE85mzqiVDttuw%3D" alt="image-20241028135834377" loading="lazy"/></p>
<p><strong>开通免费单元。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d9940ca991e4fc7b3f7066b8075e033~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=6Fg06SAnz5RGMgy63reXkfl5v0M%3D" alt="image-20241028135935457" loading="lazy"/></p>
<p>点击<code>立即创建</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da9652c3bd454462ba9cd2d62c09e970~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=JGOEnx%2FTfFHm8q5fKBHbLJ9%2By4k%3D" alt="image-20240117134653452" loading="lazy"/></p>
<p>正在创建标准版实例，需要等待片刻。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8de114dfd8242d4a17631097388e3db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=sJ0ihw24c%2FttOPqYhxu08upqqCk%3D" alt="image-20241028140048811" loading="lazy"/></p>
<p><strong>创建完成之后，点击详情。 可以看到标准版实例的设备接入端口和地址。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fea83cd4cb0c412f905c6929c759a091~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=04jDLdQNeXWAyJlVB1oVfWyqa7g%3D" alt="image-20241028140129102" loading="lazy"/></p>
<p>下面框起来的就是<code>端口号</code>和<code>域名</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a06706afa0b34adbbcf6a28fbbf053cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=j1n4iV1o3POrbKKtKaPq0kFTGcw%3D" alt="image-20241028140229696" loading="lazy"/></p>
<p>点击实例名称，可以查看当前<code>免费单元</code>的配置情况。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02a4e1631cee476fa971b280a5f8b279~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=%2BDD5ugKJ26JBpH1HjUD1V%2FMHqX4%3D" alt="image-20241028140331523" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f0d332c26b34e2cbc865896709b6a89~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=0pfNg6VzQbmd4zIKYZJIjegjQMw%3D" alt="image-20241028140428663" loading="lazy"/></p>
<p>开通之后，点击<code>接入信息</code>，也能查看接入信息。 我们当前设备准备采用MQTT协议接入华为云平台，这里可以看到MQTT协议的地址和端口号等信息。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2bb6d845ddba44b39a6c23b03447be37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=P4mIhdjF6ikr4OEDhbT%2F8RhlX4U%3D" alt="image-20241028140511105" loading="lazy"/></p>
<p><strong>总结:</strong></p>
<pre><code class="hljs language-scss" lang="scss">端口号：   MQTT (<span class="hljs-number">1883</span>)| MQTTS (<span class="hljs-number">8883</span>)    
接入地址： dab1a1f2c6<span class="hljs-selector-class">.st1</span><span class="hljs-selector-class">.iotda-device</span><span class="hljs-selector-class">.cn-north-4</span><span class="hljs-selector-class">.myhuaweicloud</span><span class="hljs-selector-class">.com</span>
</code></pre>
<p><strong>根据域名地址得到IP地址信息:</strong></p>
<p>打开Windows电脑的命令行控制台终端，使用<code>ping</code> 命令。<code>ping</code>一下即可。</p>
<pre><code class="hljs language-ini" lang="ini">Microsoft Windows <span class="hljs-section">[版本 10.0.19045.5011]</span>
(c) Microsoft Corporation。保留所有权利。

C:\Users\Lenovo&gt;ping dab1a1f2c6.st1.iotda-device.cn-north-4.myhuaweicloud.com

正在 Ping dab1a1f2c6.st1.iotda-device.cn-north-4.myhuaweicloud.com <span class="hljs-section">[117.78.5.125]</span> 具有 32 字节的数据:
来自 117.78.5.125 的回复: 字节=32 时间=37ms <span class="hljs-attr">TTL</span>=<span class="hljs-number">44</span>
来自 117.78.5.125 的回复: 字节=32 时间=37ms <span class="hljs-attr">TTL</span>=<span class="hljs-number">44</span>
来自 117.78.5.125 的回复: 字节=32 时间=37ms <span class="hljs-attr">TTL</span>=<span class="hljs-number">44</span>
来自 117.78.5.125 的回复: 字节=32 时间=37ms <span class="hljs-attr">TTL</span>=<span class="hljs-number">44</span>

117.78.5.125 的 Ping 统计信息:
    数据包: 已发送 = 4，已接收 = 4，丢失 = 0 (0% 丢失)，
往返行程的估计时间(以毫秒为单位):
    最短 = 37ms，最长 = 37ms，平均 = 37ms

C:\Users\Lenovo&gt;

</code></pre>
<p>MQTT协议接入端口号有两个，1883是非加密端口，8883是证书加密端口，<code>单片机无法加载证书，所以使用1883端口合适</code>。</p>
<h3 data-id="heading-21">2.3 创建产品</h3>
<p>链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fconsole.huaweicloud.com%2Fiotdm%2F%3Fregion%3Dcn-north-4%23%2Fdm-dev%2Fall-product%3FinstanceId%3D03c5c68c-e588-458c-90c3-9e4c640be7af" target="_blank" title="https://console.huaweicloud.com/iotdm/?region=cn-north-4#/dm-dev/all-product?instanceId=03c5c68c-e588-458c-90c3-9e4c640be7af" ref="nofollow noopener noreferrer">console.huaweicloud.com/iotdm/?regi…</a></p>
<h4 data-id="heading-22">（1）创建产品</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25822cf39c7e45f7a9038655e7263750~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=S3olirMz%2BV5LlczhUIVoyhd2swg%3D" alt="image-20241028141601305" loading="lazy"/></p>
<h4 data-id="heading-23">（2）填写产品信息</h4>
<p>根据自己产品名字填写，下面的设备类型选择自定义类型。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c04ebb116d34d7493adae7081c8090b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=hGn0Ueg9KjoSW3pIVc%2Ffu9Z3zzw%3D" alt="image-20240612094809689" loading="lazy"/></p>
<h4 data-id="heading-24">（3）产品创建成功</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4681fd1b277748e186625711ee370f50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=eiY7ccPALAsBz3GxhQsRDTyUoPA%3D" alt="image-20240612095148945" loading="lazy"/></p>
<p>创建完成之后点击查看详情。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/191b19e4acfa4a5e8d67ada4995227ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=Yd5UiknaHE6KLvzhTQ4cx%2BJpOkA%3D" alt="image-20240612095134263" loading="lazy"/></p>
<h4 data-id="heading-25">（4）添加自定义模型</h4>
<p>产品创建完成之后，点击进入产品详情页面，翻到最下面可以看到模型定义。</p>
<p>模型简单来说： 就是存放设备上传到云平台的数据。</p>
<p>可以根据自己的产品进行创建。</p>
<p>比如：</p>
<pre><code class="hljs language-cpp" lang="cpp">烟雾可以叫  MQ2
温度可以叫  Temperature
湿度可以叫  humidity
火焰可以叫  flame
其他的传感器自己用单词简写命名即可。 这就是的单片机设备端上传到服务器的数据名字。
</code></pre>
<p>先点击自定义模型。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8c87b5aac21489c9b0712207666970c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=2lfL%2BTfcWfSP7p4YLHClbJTemvo%3D" alt="image-20240612095517900" loading="lazy"/></p>
<p>再创建一个服务ID。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aba2193baa014a0a8d93198b1281cc20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=nk4yBMqw189jjB5FToLl27ZkEJI%3D" alt="image-20240612095542749" loading="lazy"/></p>
<p>接着点击新增属性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42fa34b0a9684339967607d4247c7f11~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=muAaL12FeRBEdzVqEiDCou7zfDA%3D" alt="image-20240612095648815" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/367e042ab370453d9c6b1d6eca71a531~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=CmWaxXKtUjgoIkgOHb082O5Ut%2Bg%3D" alt="image-20240612095711898" loading="lazy"/></p>
<h3 data-id="heading-26">2.4 添加设备</h3>
<p>产品是属于上层的抽象模型，接下来在产品模型下添加实际的设备。添加的设备最终需要与真实的设备关联在一起，完成数据交互。</p>
<h4 data-id="heading-27">（1）注册设备</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71940c7ea72c422aad6cc9575f4260f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=lLRJdlXS3EOA7wJ%2FI2RbVC5Lg%2B4%3D" alt="image-20240425181935561" loading="lazy"/></p>
<h4 data-id="heading-28">（2）根据自己的设备填写</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcef1477597e4e13bcef776b7a69142e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=W5OW6C4cLypoNpsIV34r1mITCoI%3D" alt="image-20240612100115167" loading="lazy"/></p>
<h4 data-id="heading-29">（3）保存设备信息</h4>
<p>创建完毕之后，点击保存并关闭，得到创建的设备密匙信息。该信息在后续生成MQTT三元组的时候需要使用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae5e71606a1f412eb68eedb3d3ad28dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=GKp%2BoE8O5r5IOwV%2FwTfPBcghDao%3D" alt="image-20240612100128061" loading="lazy"/></p>
<h4 data-id="heading-30">（4）设备创建完成</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48cea29e8169435f966e8717ae886980~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=dsaSOyqDPndQZHUydsDioK5KQTc%3D" alt="image-20240612100147232" loading="lazy"/></p>
<h4 data-id="heading-31">（5）设备详情</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a5a24fd3d7d4199b0a835aad4016f7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=c2WLvbkJ7wySRz64mQcj13tlVu4%3D" alt="image-20240612100202960" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e61b358a66b54253bb2dc8844c8a9e25~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=f9QfzY7jYbArtM8GqJGoiaLBOHE%3D" alt="image-20240612100217236" loading="lazy"/></p>
<h3 data-id="heading-32">2.5 MQTT协议主题订阅与发布</h3>
<h4 data-id="heading-33">（1）MQTT协议介绍</h4>
<p>当前的设备是采用MQTT协议与华为云平台进行通信。</p>
<p>MQTT是一个物联网传输协议，它被设计用于轻量级的发布/订阅式消息传输，旨在为低带宽和不稳定的网络环境中的物联网设备提供可靠的网络服务。MQTT是专门针对物联网开发的轻量级传输协议。MQTT协议针对低带宽网络，低计算能力的设备，做了特殊的优化，使得其能适应各种物联网应用场景。目前MQTT拥有各种平台和设备上的客户端，已经形成了初步的生态系统。</p>
<p>MQTT是一种消息队列协议，使用发布/订阅消息模式，提供一对多的消息发布，解除应用程序耦合，相对于其他协议，开发更简单；MQTT协议是工作在TCP/IP协议上；由TCP/IP协议提供稳定的网络连接；所以，只要具备TCP协议栈的网络设备都可以使用MQTT协议。  本次设备采用的ESP8266就具备TCP协议栈，能够建立TCP连接，所以，配合STM32代码里封装的MQTT协议，就可以与华为云平台完成通信。</p>
<p>华为云的MQTT协议接入帮助文档在这里:  <a href="https://link.juejin.cn?target=https%3A%2F%2Fsupport.huaweicloud.com%2Fdevg-iothub%2Fiot_02_2200.html" target="_blank" title="https://support.huaweicloud.com/devg-iothub/iot_02_2200.html" ref="nofollow noopener noreferrer">support.huaweicloud.com/devg-iothub…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85420a00ae274df98e59953f6c36f34e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=ah7KfQUU3wUflKWc6sSsPe89RkI%3D" alt="img" loading="lazy"/></p>
<p><strong>业务流程：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85560f1e730040f98559d94e814fc472~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=WOllCxdpsRWnvPsFEjdAlqHLUUU%3D" alt="img" loading="lazy"/></p>
<h4 data-id="heading-34">（2）华为云平台MQTT协议使用限制</h4>





















































<table><thead><tr><th>描述</th><th>限制</th></tr></thead><tbody><tr><td>支持的MQTT协议版本</td><td>3.1.1</td></tr><tr><td>与标准MQTT协议的区别</td><td>支持Qos 0和Qos 1支持Topic自定义不支持QoS2不支持will、retain msg</td></tr><tr><td>MQTTS支持的安全等级</td><td>采用TCP通道基础 + TLS协议（最高TLSv1.3版本）</td></tr><tr><td>单帐号每秒最大MQTT连接请求数</td><td>无限制</td></tr><tr><td>单个设备每分钟支持的最大MQTT连接数</td><td>1</td></tr><tr><td>单个MQTT连接每秒的吞吐量，即带宽，包含直连设备和网关</td><td>3KB/s</td></tr><tr><td>MQTT单个发布消息最大长度，超过此大小的发布请求将被直接拒绝</td><td>1MB</td></tr><tr><td>MQTT连接心跳时间建议值</td><td>心跳时间限定为30至1200秒，推荐设置为120秒</td></tr><tr><td>产品是否支持自定义Topic</td><td>支持</td></tr><tr><td>消息发布与订阅</td><td>设备只能对自己的Topic进行消息发布与订阅</td></tr><tr><td>每个订阅请求的最大订阅数</td><td>无限制</td></tr></tbody></table>
<h4 data-id="heading-35">（3）主题订阅格式</h4>
<p>帮助文档地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fsupport.huaweicloud.com%2Fdevg-iothub%2Fiot_02_2200.html" target="_blank" title="https://support.huaweicloud.com/devg-iothub/iot_02_2200.html" ref="nofollow noopener noreferrer">support.huaweicloud.com/devg-iothub…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c122c8357f540d3b72888d825e2c51e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=8r8HSLz6dHB9r2SjPr8Cs8jTDaY%3D" alt="image-20221207153310037" loading="lazy"/></p>
<p>对于设备而言，一般会订阅平台下发消息给设备 这个主题。</p>
<p>设备想接收平台下发的消息，就需要订阅平台下发消息给设备 的主题，订阅后，平台下发消息给设备，设备就会收到消息。</p>
<p>如果设备想要知道平台下发的消息，需要订阅上面图片里标注的主题。</p>
<pre><code class="hljs language-cpp" lang="cpp">以当前设备为例，最终订阅主题的格式如下:
$oc/devices/{device_id}/sys/messages/down
    
最终的格式:
$oc/devices/<span class="hljs-number">663</span>cb18871d845632a0912e7_dev1/sys/messages/down
</code></pre>
<h4 data-id="heading-36">（4）主题发布格式</h4>
<p>对于设备来说，主题发布表示向云平台上传数据，将最新的传感器数据，设备状态上传到云平台。</p>
<p>这个操作称为：属性上报。</p>
<p>帮助文档地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fsupport.huaweicloud.com%2Fusermanual-iothub%2Fiot_06_v5_3010.html" target="_blank" title="https://support.huaweicloud.com/usermanual-iothub/iot_06_v5_3010.html" ref="nofollow noopener noreferrer">support.huaweicloud.com/usermanual-…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88790ea5762c46139b43c08bc5337acd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=wHcf%2F9%2FInrC8OchyHo4vx0uoOZo%3D" alt="image-20221207153637391" loading="lazy"/></p>
<p><strong>根据帮助文档的介绍， 当前设备发布主题，上报属性的格式总结如下：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp">发布的主题格式:
$oc/devices/{device_id}/sys/properties/report
 
最终的格式:
$oc/devices/<span class="hljs-number">663</span>cb18871d845632a0912e7_dev1/sys/properties/report
发布主题时，需要上传数据，这个数据格式是JSON格式。

上传的JSON数据格式如下:

{
  <span class="hljs-string">"services"</span>: [
    {
      <span class="hljs-string">"service_id"</span>: &lt;填服务ID&gt;,
      <span class="hljs-string">"properties"</span>: {
        <span class="hljs-string">"&lt;填属性名称1&gt;"</span>: &lt;填属性值&gt;,
        <span class="hljs-string">"&lt;填属性名称2&gt;"</span>: &lt;填属性值&gt;,
        ..........
      }
    }
  ]
}
根据JSON格式，一次可以上传多个属性字段。 这个JSON格式里的，服务ID，属性字段名称，属性值类型，在前面创建产品的时候就已经介绍了，不记得可以翻到前面去查看。

根据这个格式，组合一次上传的属性数据:
{<span class="hljs-string">"services"</span>: [{<span class="hljs-string">"service_id"</span>: <span class="hljs-string">"stm32"</span>,<span class="hljs-string">"properties"</span>:{<span class="hljs-string">"的字段名字1"</span>:<span class="hljs-number">30</span>,<span class="hljs-string">"的字段名字2"</span>:<span class="hljs-number">10</span>,<span class="hljs-string">"的字段名字3"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"的字段名字4"</span>:<span class="hljs-number">0</span>}}]}
</code></pre>
<h3 data-id="heading-37">2.6 MQTT三元组</h3>
<p>MQTT协议登录需要填用户ID，设备ID，设备密码等信息，就像我们平时登录QQ，微信一样要输入账号密码才能登录。MQTT协议登录的这3个参数，一般称为MQTT三元组。</p>
<p>接下来介绍，华为云平台的MQTT三元组参数如何得到。</p>
<h4 data-id="heading-38">（1）MQTT服务器地址</h4>
<p>要登录MQTT服务器，首先记得先知道服务器的地址是多少，端口是多少。</p>
<p>帮助文档地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fconsole.huaweicloud.com%2Fiotdm%2F%3Fregion%3Dcn-north-4%23%2Fdm-portal%2Fhome" target="_blank" title="https://console.huaweicloud.com/iotdm/?region=cn-north-4#/dm-portal/home" ref="nofollow noopener noreferrer">console.huaweicloud.com/iotdm/?regi…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28721cafc3e4419ab7d458158aa5c22d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=vouEWdFtwJGyeeINjWPcJcbRcb0%3D" alt="image-20240509193207359" loading="lazy"/></p>
<p>MQTT协议的端口支持1883和8883，它们的区别是：8883 是加密端口更加安全。但是单片机上使用比较困难，所以当前的设备是采用1883端口进连接的。</p>
<p><strong>根据上面的域名和端口号，得到下面的IP地址和端口号信息：</strong>   如果设备支持填写域名可以直接填域名，不支持就直接填写IP地址。  （IP地址就是域名解析得到的）</p>
<pre><code class="hljs language-cpp" lang="cpp">华为云的MQTT服务器地址：<span class="hljs-number">117.78</span><span class="hljs-number">.5</span><span class="hljs-number">.125</span>
华为云的MQTT端口号：<span class="hljs-number">1883</span>
</code></pre>
<p>如何得到IP地址？如何域名转IP？  打开Windows的命令行输入以下命令。</p>
<pre><code class="hljs language-cpp" lang="cpp">ping  ad635970a1.st1.iotda-device.cn-north<span class="hljs-number">-4.</span>myhuaweicloud.com
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78672b5427c6440989468a2bfe855d51~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=pAOujZ97EIi%2BtOgVkykgaoNnMlc%3D" alt="image-20240425182610048" loading="lazy"/></p>
<h4 data-id="heading-39">（2）生成MQTT三元组</h4>
<p>华为云提供了一个在线工具，用来生成MQTT鉴权三元组： <a href="https://link.juejin.cn?target=https%3A%2F%2Fiot-tool.obs-website.cn-north-4.myhuaweicloud.com%2F" target="_blank" title="https://iot-tool.obs-website.cn-north-4.myhuaweicloud.com/" ref="nofollow noopener noreferrer">iot-tool.obs-website.cn-north-4.myhuaweicloud.com/</a></p>
<p>打开这个工具，填入设备的信息（也就是刚才创建完设备之后保存的信息），点击生成，就可以得到MQTT的登录信息了。</p>
<p><strong>下面是打开的页面：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/514802762d904bdcbf50cf7eda3d1b9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=V03NiFDBbpiQ2O6nz1r4T%2Biyw84%3D" alt="image-20240425183025893" loading="lazy"/></p>
<p><strong>填入设备的信息：</strong>   （上面两行就是设备创建完成之后保存得到的）</p>
<p>直接得到三元组信息。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c8cd7be6a534b7cad309dcfb4968f37~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=0mChOVaLRJU51PohVrUL8eIDP2E%3D" alt="image-20240509193310020" loading="lazy"/></p>
<p>得到三元组之后，设备端通过MQTT协议登录鉴权的时候，填入参数即可。</p>
<pre><code class="hljs language-cpp" lang="cpp">ClientId  <span class="hljs-number">663</span>cb18871d845632a0912e7_dev1_0_0_2024050911
Username  <span class="hljs-number">663</span>cb18871d845632a0912e7_dev1
Password  <span class="hljs-number">71b</span>82deae83e80f04c4269b5bbce3b2fc7c13f610948fe210ce18650909ac237
</code></pre>
<h3 data-id="heading-40">2.7 模拟设备登录测试</h3>
<p>经过上面的步骤介绍，已经创建了产品，设备，数据模型，得到MQTT登录信息。 接下来就用MQTT客户端软件模拟真实的设备来登录平台。测试与服务器通信是否正常。</p>
<p><strong>MQTT软件下载地址【免费】：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fdownload.csdn.net%2Fdownload%2Fxiaolong1126626497%2F89928772" target="_blank" title="https://download.csdn.net/download/xiaolong1126626497/89928772" ref="nofollow noopener noreferrer">download.csdn.net/download/xi…</a></p>
<h4 data-id="heading-41">（1）填入登录信息</h4>
<p>打开MQTT客户端软件，对号填入相关信息（就是上面的文本介绍）。然后，点击登录，订阅主题，发布主题。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1645ee1035024af89e127ca0936bd056~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=m2iFJrbX2KCmazwXLItJSheRrdc%3D" alt="image-20240509193457358" loading="lazy"/></p>
<h4 data-id="heading-42">（2）打开网页查看</h4>
<p>完成上面的操作之后，打开华为云网页后台，可以看到设备已经在线了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/785fe0014613421c862df2833b7242b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=UCAhuXTgXANj3DZEWpHRvpcKD90%3D" alt="image-20240612100508790" loading="lazy"/></p>
<p>点击详情页面，可以看到上传的数据：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6baa2073dc8b4283824c173e3ba02aff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=sXlb8TUTXC5GF08QBPdkoRWf7VU%3D" alt="image-20240612100529581" loading="lazy"/></p>
<p>到此，云平台的部署已经完成，设备已经可以正常上传数据了。</p>
<h4 data-id="heading-43">（3）MQTT登录测试参数总结</h4>
<pre><code class="hljs language-cpp" lang="cpp">MQTT服务器:  <span class="hljs-number">117.78</span><span class="hljs-number">.5</span><span class="hljs-number">.125</span>
MQTT端口号:  <span class="hljs-number">183</span>

<span class="hljs-comment">//物联网服务器的设备信息</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> MQTT_ClientID <span class="hljs-string">"663cb18871d845632a0912e7_dev1_0_0_2024050911"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> MQTT_UserName <span class="hljs-string">"663cb18871d845632a0912e7_dev1"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> MQTT_PassWord <span class="hljs-string">"71b82deae83e80f04c4269b5bbce3b2fc7c13f610948fe210ce18650909ac237"</span></span>

<span class="hljs-comment">//订阅与发布的主题</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SET_TOPIC  <span class="hljs-string">"$oc/devices/663cb18871d845632a0912e7_dev1/sys/messages/down"</span>  <span class="hljs-comment">//订阅</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> POST_TOPIC <span class="hljs-string">"$oc/devices/663cb18871d845632a0912e7_dev1/sys/properties/report"</span>  <span class="hljs-comment">//发布</span></span>


发布的数据:
{<span class="hljs-string">"services"</span>: [{<span class="hljs-string">"service_id"</span>: <span class="hljs-string">"stm32"</span>,<span class="hljs-string">"properties"</span>:{<span class="hljs-string">"的字段名字1"</span>:<span class="hljs-number">30</span>,<span class="hljs-string">"的字段名字2"</span>:<span class="hljs-number">10</span>,<span class="hljs-string">"的字段名字3"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"的字段名字4"</span>:<span class="hljs-number">0</span>}}]}

</code></pre>
<h3 data-id="heading-44">2.8 创建IAM账户</h3>
<p>创建一个IAM账户，因为接下来开发上位机，需要使用云平台的API接口，这些接口都需要token进行鉴权。简单来说，就是身份的认证。  调用接口获取Token时，就需要填写IAM账号信息。所以，接下来演示一下过程。</p>
<p>地址:  <a href="https://link.juejin.cn?target=https%3A%2F%2Fconsole.huaweicloud.com%2Fiam%2F%3Fregion%3Dcn-north-4%23%2Fiam%2Fusers" target="_blank" title="https://console.huaweicloud.com/iam/?region=cn-north-4#/iam/users" ref="nofollow noopener noreferrer">console.huaweicloud.com/iam/?region…</a></p>
<p>**【1】获取项目凭证 **  点击左上角用户名，选择下拉菜单里的<code>我的凭证</code></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2062a032bf2547e3bf52615f0b6ae3c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=LHJ0jg0v1OfX4yDTb7QgneFDgwc%3D" alt="image-20240509193646253" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82319076baee40058ab4eed4ac38af17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=UAXxl5GU6vOqTEcvTWUU7iynBDg%3D" alt="image-20240509193701262" loading="lazy"/></p>
<p><strong>项目凭证:</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-number">28</span>add376c01e4a61ac8b621c714bf459
</code></pre>
<p><strong>【2】创建IAM用户</strong></p>
<p>鼠标放在左上角头像上，在下拉菜单里选择<code>统一身份认证</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6aa6543f1734f26aad695500910aa4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=FLdflBY8cV3jgkHT5ncLD9GXilo%3D" alt="image-20240509193729078" loading="lazy"/></p>
<p>点击左上角<code>创建用户</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83554585c7e44b5a95cd80fdf2395f08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=OOZBI363CdPMKnyJIAzZz8tqO18%3D" alt="image-20240509193744287" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3597d011458042d9ac113b86ae122565~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=fU3w4vdurlImOw6FDEsEoPrWixM%3D" alt="image-20240314153208692" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f381cbaf63046b68e2d99040f545624~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=ewMwPkjtJW1rKQH6qc9XbejfOLs%3D" alt="image-20240314153228359" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abeb9f97d260461cafb8a608fb8fd4fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=Ml3oiY%2FEWwdiGcQ7FevOrqi6jRk%3D" alt="image-20240314153258229" loading="lazy"/></p>
<p><strong>创建成功：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6890cd751d3742268fa46346af3c8619~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=59loPvTOiLQFHBPlTr6rKZOMPFs%3D" alt="image-20240314153315444" loading="lazy"/></p>
<p>【3】创建完成</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a202140521c7424f8c02815d1f1c2519~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=wlHWQ%2BZt2VTWKvFxMfq8pXYFHz8%3D" alt="image-20240509193828289" loading="lazy"/></p>
<p><strong>用户信息如下：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp">主用户名  l19504562721
IAM用户  ds_abc
密码     DS12345678
</code></pre>
<h3 data-id="heading-45">2.9 获取影子数据</h3>
<p>帮助文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fsupport.huaweicloud.com%2Fapi-iothub%2Fiot_06_v5_0079.html" target="_blank" title="https://support.huaweicloud.com/api-iothub/iot_06_v5_0079.html" ref="nofollow noopener noreferrer">support.huaweicloud.com/api-iothub/…</a></p>
<p><strong>设备影子介绍：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp">设备影子是一个用于存储和检索设备当前状态信息的JSON文档。
每个设备有且只有一个设备影子，由设备ID唯一标识
设备影子仅保存最近一次设备的上报数据和预期数据
无论该设备是否在线，都可以通过该影子获取和设置设备的属性
</code></pre>
<p>简单来说：设备影子就是保存，设备最新上传的一次数据。</p>
<p>我们设计的软件里，如果想要获取设备的最新状态信息，就采用设备影子接口。</p>
<p>如果对接口不熟悉，可以先进行在线调试：<a href="https://link.juejin.cn?target=https%3A%2F%2Fapiexplorer.developer.huaweicloud.com%2Fapiexplorer%2Fdoc%3Fproduct%3DIoTDA%26api%3DShowDeviceShadow" target="_blank" title="https://apiexplorer.developer.huaweicloud.com/apiexplorer/doc?product=IoTDA&amp;api=ShowDeviceShadow" ref="nofollow noopener noreferrer">apiexplorer.developer.huaweicloud.com/apiexplorer…</a></p>
<p>在线调试接口，可以请求影子接口，了解请求，与返回的数据格式。</p>
<p><strong>调试完成看右下角的响应体，就是返回的影子数据。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4dc5dbdda256495aad3b6d0e3f8545a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=auviXLjBrxmq4qwDZ1NKBB11fXo%3D" alt="image-20240509194152229" loading="lazy"/></p>
<p><strong>设备影子接口返回的数据如下：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp">{
 <span class="hljs-string">"device_id"</span>: <span class="hljs-string">"663cb18871d845632a0912e7_dev1"</span>,
 <span class="hljs-string">"shadow"</span>: [
  {
   <span class="hljs-string">"service_id"</span>: <span class="hljs-string">"stm32"</span>,
   <span class="hljs-string">"desired"</span>: {
    <span class="hljs-string">"properties"</span>: null,
    <span class="hljs-string">"event_time"</span>: null
   },
   <span class="hljs-string">"reported"</span>: {
    <span class="hljs-string">"properties"</span>: {
     <span class="hljs-string">"DHT11_T"</span>: <span class="hljs-number">18</span>,
     <span class="hljs-string">"DHT11_H"</span>: <span class="hljs-number">90</span>,
     <span class="hljs-string">"BH1750"</span>: <span class="hljs-number">38</span>,
     <span class="hljs-string">"MQ135"</span>: <span class="hljs-number">70</span>
    },
    <span class="hljs-string">"event_time"</span>: <span class="hljs-string">"20240509T113448Z"</span>
   },
   <span class="hljs-string">"version"</span>: <span class="hljs-number">3</span>
  }
 ]
}
</code></pre>
<p><strong>调试成功之后，可以得到访问影子数据的真实链接，接下来的代码开发中，就采用Qt写代码访问此链接，获取影子数据，完成上位机开发。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c50df9d3fc9a4e5b84b259a3fabd0058~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=C6mzKBLWwPwMes2jFLJp1%2Fu18jo%3D" alt="image-20240509194214716" loading="lazy"/></p>
<p><strong>链接如下：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp">https:<span class="hljs-comment">//ad635970a1.st1.iotda-app.cn-north-4.myhuaweicloud.com:443/v5/iot/28add376c01e4a61ac8b621c714bf459/devices/663cb18871d845632a0912e7_dev1/shadow</span>
</code></pre>
<h2 data-id="heading-46">三、Qt开发入门与环境搭建</h2>
<p><strong>当前项目的上位机是采用Qt开发的，这一章节主要是介绍Qt开发环境的安装，以及Qt开发环境入门的使用。如果Qt没有任何基础，建议仔细看一遍。</strong></p>
<h3 data-id="heading-47">3.1 Qt是什么？</h3>
<p>Qt 是一个功能强大、跨平台的应用程序开发框架，主要用于创建图形用户界面（GUI）应用程序，但它不仅仅局限于GUI编程。它由挪威的奇趣科技（TrollTech）最初于1991年开发，并在后续的发展历程中经历了多次所有权变更，包括诺基亚和Digia等公司接手，现在Qt属于The Qt Company所有。</p>
<p><strong>Qt 主要特点和优势包括：</strong></p>
<p>（1）<strong>跨平台</strong>：Qt 支持多种操作系统，开发者可以使用同一份源代码在不同平台上编译运行，如Windows、Linux、macOS、Android以及各种嵌入式系统（如RTOS），实现“一次编写，到处编译”。</p>
<p>（2）<strong>C++ 开发</strong>：Qt 的核心是基于C++编程语言构建，提供了一套丰富的类库，通过面向对象的设计方式简化了开发过程。</p>
<p>（3）<strong>图形用户界面</strong>：Qt 提供了完整的GUI组件集，包含窗口、按钮、标签、文本框等各种标准控件，以及布局管理器、样式表等功能，使得开发者能够高效地创建美观且功能完善的桌面应用或移动应用界面。</p>
<p>（4）<strong>工具链完整</strong>：Qt 包含一系列集成开发环境（IDE）和辅助工具，例如Qt Creator是一个全能的跨平台IDE，Qt Designer用于可视化拖拽设计UI界面，Qt Linguist支持国际化资源文件的翻译，还有Qt Assistant和大量文档资源方便开发者的使用。</p>
<p>（5）<strong>非GUI功能丰富</strong>：除了GUI功能外，Qt 还提供了众多非图形化功能模块，如网络通信、数据库访问、XML处理、多媒体处理（音频视频）、文件I/O、线程与并发处理、OpenGL和3D图形渲染等。</p>
<p>（6）<strong>元对象系统</strong>：Qt 使用元对象系统（Meta-Object System, MOC）实现了信号与槽机制（Signals and Slots），这是一种高级事件处理机制，允许在不同对象之间安全地进行异步通信。</p>
<p>（7）<strong>可扩展性与灵活性</strong>：Qt 架构高度灵活，支持插件体系结构，开发者可以根据需要自定义组件并轻松地集成到Qt应用中。</p>
<p>Qt 以其强大的跨平台能力和全面的功能集合成为许多企业和个人开发者选择用来开发高性能、高稳定性的应用程序的重要工具之一，被广泛应用于各类桌面软件、嵌入式设备、移动应用以及服务器端组件等领域。</p>
<h3 data-id="heading-48">3.2 Qt版本介绍</h3>
<p>在Qt发行版本中将要涉及两个版本：Qt商业授权和Qt开源授权。</p>
<p>（1）Qt商业授权是设计商业软件的开发环境，这些商业软件使用了传统的商业来发布，它包含了一些更新的功能、技术上的支持和大量的解决方案，开发了使用于行业的一些特定的组件，有一些特殊的功能只在商业用户中使用。</p>
<p>（2）Qt开源授权是用来开发开源的软件，它提供了一些免费的支持，并遵循QPL协议。</p>
<p>开放源代码是免费的软件，不牵涉用户的某些权益。任何人都有使用开源软件和参与它的修改的机会，这就意味着其他的人同样可获得开发的代码。目前 Qt 的开源授权有两种，一种是 GPL 授权，另一种是 LGPL 授权。</p>
<h3 data-id="heading-49">3.3 Qt开发环境安装</h3>
<p>Qt的中文官网： <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.qt.io%2Fzh-cn%2F!%255Bimage-20221207160550486%255D(https%3A%2F%2Fled-obs.obs.cn-north-1.myhuaweicloud.com%2FBlog%2Fimg%2Fimage-20221207160550486.png)" target="_blank" title="https://www.qt.io/zh-cn/!%5Bimage-20221207160550486%5D(https://led-obs.obs.cn-north-1.myhuaweicloud.com/Blog/img/image-20221207160550486.png)" ref="nofollow noopener noreferrer">www.qt.io/zh-cn/![ima…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b65fec9401b4fe2a6bba80e43a459f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=6igUydPoyOoFHVOZo1iZJEOFo4Y%3D" alt="image-20221207160606892" loading="lazy"/></p>
<p>QT5.12.6的下载地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdownload.qt.io%2Farchive%2Fqt%2F5.12%2F5.12.6" target="_blank" title="https://download.qt.io/archive/qt/5.12/5.12.6" ref="nofollow noopener noreferrer">download.qt.io/archive/qt/…</a></p>
<p>打开下载链接后选择下面的版本进行下载：</p>
<p><code>qt-opensource-windows-x86-5.12.6.exe 13-Nov-2019 07:28 3.7G Details</code></p>
<p>软件安装时断网安装，否则会提示输入账户。</p>
<p><strong>如果下载不了，可以在网盘里找到安装包下载：</strong>    飞书文档记录的网盘地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fccnr8sukk85n.feishu.cn%2Fwiki%2FQjY8weDYHibqRYkFP2qcA9aGnvb%3Ffrom%3Dfrom_copylink" target="_blank" title="https://ccnr8sukk85n.feishu.cn/wiki/QjY8weDYHibqRYkFP2qcA9aGnvb?from=from_copylink" ref="nofollow noopener noreferrer">ccnr8sukk85n.feishu.cn/wiki/QjY8we…</a></p>
<p>安装的时候，第一个复选框里勾选一个<code>mingw 32</code>编译器即可，其他的不管默认就行，直接点击下一步继续安装。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d9784a612b34b1894d3678a13a22341~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=e72Jj5uxVcliaKd7fWkLfA4tFLE%3D" alt="image-20221203151742653" loading="lazy"/></p>
<p>选择MinGW 32-bit 编译器：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d3a87702e02468181ac0020e4be9f67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=4Ng%2BbmOODXYVaa4eUuVm1Qekcqs%3D" alt="image-20221203151750344" loading="lazy"/></p>
<h3 data-id="heading-50">3.4 开发第一个QT程序</h3>
<p>在QT开发过程中，可以手动编写代码也可以使用UI设计师直接拖拽控件的方式编写界面和布局，在实际的开发过程中一般是两种方式结合使用，提高开发效率。</p>
<p><strong>本小节用一个简单的 "Hello QT" 程序介绍一下使用QtCreator新建工程的步骤</strong>。</p>
<p>（1）打开QtCreator软件，选择New Project，新建一个工程。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3f5779cfa67451aabaa85d3d8e28efc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=pbD7dDa%2B7jXAdT9bNQTZH5J0YG4%3D" alt="image-20240304134953164" loading="lazy"/></p>
<p><strong>（2）项目模板选择QT Widgets Application</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e560b32a44047b7aa47a91eaf91e952~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=wVi6WoHLwjdAvBZICVYAkH4ClFQ%3D" alt="image-20240304135416497" loading="lazy"/></p>
<p><strong>（3）设置项目名称和存放路径</strong></p>
<p>注意：QT项目路径和名称不能出现中文字符。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6ebe97b4ad840feb2c84a0918e20c2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=2EFfcS9gg4zS03OE2wyB%2BhfyH1U%3D" alt="image-20240304135504345" loading="lazy"/></p>
<p><strong>（4）编译工具套件选择</strong></p>
<p>编译工具套件可以后面自己增加，比如增加Android的。套件是指 Qt 程序从编译链接到运行环境的全部工具和 Qt 类库的集合。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7872f1c2fa1140309ce9b66ef29c1012~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=%2F54DzLUNDFi5vPuS0fA0qzjIS%2BM%3D" alt="image-20240304135535341" loading="lazy"/></p>
<p><strong>（5）设置生成的类信息</strong></p>
<p>在类信息设置界面选择基类，目前有三种基类：QMainWindow，QWidget，QDialog。在基类里选择QMainWindow，类名和文件名会根据基类自动修改，一般不需要修改，默认即可。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76a4d2ffbe63472491b4a2fffd648c0e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=Flaw4mItaGVMV%2BptURdBCM0n%2FPY%3D" alt="image-20240304135630942" loading="lazy"/></p>
<p><strong>（6）项目管理</strong></p>
<p>在项目管理界面可以设置作为子项目，以及加入版本控制系统。这两个功能暂时用不到，都用默认的  ，然后点击 “完成”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fcabfd49c1541a885d105f6cb23c447~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=PN7CgTGjDZwb1S9QJEa6f%2FdbbEQ%3D" alt="image-20240304135652922" loading="lazy"/></p>
<p><strong>（7）创建完成</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5de4a6ce3cd84dc8ac1f686dccf13474~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=3rQgsaSMgJg%2F3LwurzIy4PUi7ug%3D" alt="image-20240304135728165" loading="lazy"/></p>
<p><strong>（8） 编辑代码</strong></p>
<p>展开main.cpp文件，添加内容如下：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"mainwindow.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QApplication&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QDebug&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QLabel&gt;</span></span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span>
</span>{
    <span class="hljs-function">QApplication <span class="hljs-title">a</span><span class="hljs-params">(argc, argv)</span></span>;
    <span class="hljs-comment">//MainWindow w;</span>
    <span class="hljs-comment">//w.show();</span>
    QLabel *label =<span class="hljs-keyword">new</span> <span class="hljs-built_in">QLabel</span>(<span class="hljs-string">"Hello Qt!"</span>);
    label-&gt;<span class="hljs-built_in">setGeometry</span>(<span class="hljs-number">400</span>,<span class="hljs-number">100</span>,<span class="hljs-number">100</span>,<span class="hljs-number">20</span>);
    label-&gt;<span class="hljs-built_in">show</span>();
    <span class="hljs-keyword">return</span> a.<span class="hljs-built_in">exec</span>();
}
</code></pre>
<p><strong>代码解析：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-number">1</span>)	<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QApplication&gt;</span>和 #<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QLabel&gt;</span>是QT的类声明头文件，对于每个QT类都有一个与该类同名的头文件，在这个头文件包含了对该类的定义。</span>
<span class="hljs-number">2</span>)	<span class="hljs-built_in">main</span>(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[]) ：main函数的标准写法。
<span class="hljs-number">3</span>)	<span class="hljs-function">QApplication <span class="hljs-title">a</span><span class="hljs-params">(argc, argv)</span>：创建一个QApplication对象，用于管理应用程序的资源，QApplication类的构造函数需要两个参数。
4)	QLabel *label </span>=<span class="hljs-keyword">new</span> <span class="hljs-built_in">QLabel</span>(<span class="hljs-string">"Hello Qt!"</span>) ：创建QLabel窗口部件，QLabel是一个Qt提供的窗口部件，可以用来显示一行文本。
<span class="hljs-number">5</span>)	label-&gt;<span class="hljs-built_in">setGeometry</span>(<span class="hljs-number">400</span>,<span class="hljs-number">100</span>,<span class="hljs-number">100</span>,<span class="hljs-number">20</span>) ： 设置控件显示的位置。
<span class="hljs-number">6</span>)	label-&gt;<span class="hljs-built_in">show</span>()：使Qlabel创建的窗口可见，就是显示设置的文本。
<span class="hljs-number">7</span>)	<span class="hljs-keyword">return</span> a.<span class="hljs-built_in">exec</span>()：应用程序将控制权传递给QT，让程序进入消息循环。等待可能的菜单，工具条，鼠标等的输入，进行响应。
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ad718b513084f38883dfae9cca9bc1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=87KdZC%2BT7T5A5F5J9%2BxW4BdjyMU%3D" alt="image-20240304135908750" loading="lazy"/></p>
<p><strong>（9）行程序</strong></p>
<p>运行程序可以点击左下角的三角形符号或者按下快捷键Ctrl+R。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a218608a8d224e829050d0265a7ddccd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=KUQzh9HKKqht6bkk%2F%2BrNUQWElW4%3D" alt="image-20240304135938848" loading="lazy"/></p>
<h3 data-id="heading-51">3.5 调试输出</h3>
<p>QT中使用QDebug类输出调试信息。主要用于调试代码，类似于std::cout的替代品，支持QT的数据类型。使用前需要包含头文件。</p>
<p><strong>调试输出的分类</strong></p>





















<table><thead><tr><th>qDebug</th><th>调试信息提示</th></tr></thead><tbody><tr><td>qWarning</td><td>一般的警告提示</td></tr><tr><td>qCritical</td><td>严重错误提示</td></tr><tr><td>qFatal</td><td>致命错误提示</td></tr></tbody></table>
<p><strong>示例代码：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-built_in">qDebug</span>(<span class="hljs-string">"调试信息输出"</span>);
<span class="hljs-built_in">qWarning</span>(<span class="hljs-string">"一般警告信息输出"</span>);
<span class="hljs-built_in">qCritical</span>(<span class="hljs-string">"严重错误输出"</span>);
<span class="hljs-built_in">qFatal</span>(<span class="hljs-string">"致命错误输出"</span>);
</code></pre>
<p>qDebug输出的信息会打印到QT软件下边的输出面板。</p>
<p>在上节的HelloQt工程上加上调试输出代码，增加的main.cpp代码如下：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"mainwindow.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QApplication&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QDebug&gt;</span></span>
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span>
</span>{
    <span class="hljs-function">QApplication <span class="hljs-title">a</span><span class="hljs-params">(argc, argv)</span></span>;
    <span class="hljs-comment">//MainWindow w;</span>
    <span class="hljs-comment">//w.show();</span>
    <span class="hljs-built_in">qDebug</span>()&lt;&lt;<span class="hljs-string">"QT调试信息输出"</span>;
    <span class="hljs-type">int</span> data_int=<span class="hljs-number">8888</span>;
    <span class="hljs-built_in">qDebug</span>()&lt;&lt;data_int;
    <span class="hljs-type">float</span> data_float=<span class="hljs-number">123.888</span>;
    <span class="hljs-built_in">qDebug</span>()&lt;&lt;data_float;
    <span class="hljs-keyword">return</span> a.<span class="hljs-built_in">exec</span>();
}
</code></pre>
<p>运行程序，观察输出的调试信息：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/231fccaa47e2428bbbf5d78446befc39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=EglhN0PVbbCIIZkaIe0vn0wietA%3D" alt="image-20240304140142790" loading="lazy"/></p>
<h3 data-id="heading-52">3.6 QT Creator常用的快捷键</h3>
<p>掌握一些适用的快捷键，可以提高程序开发的效率。</p>
<p>（1）F1 键，快速切换光标选中的函数或者类的帮助信息，按一次半屏显示，按下两次全屏显示。</p>
<p>（2）F2 键，快速切换到光标选中的函数或者类的源码定义处。</p>
<p>（3）F4键，快速在源文件和头文件之间切换。</p>
<p>（4）Ctrl(按住)+ Tab，快速切换已打开的文件</p>
<p>（5）Ctrl+ I ，缩进光标选中行代码（自动与上层代码对齐）。</p>
<p>（6）Ctrl + / ，快速注释或者取消注释光标选中行。</p>
<p>（7）快速修改全局变量名</p>
<p>鼠标光标选中变量名，按下Ctrl+Shift+R，当变量名称出现红色框表示已经激活全局修改功能。修改一处，整个工程对应变量名称全部会修改。修改完毕之后，光标移开，再按下Ctrl+Shift+R保存修改。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a30a4452f949447b806c787af10a5937~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=fBkKbYSmmdln5tC5ANBqpJFsINY%3D" alt="image-20240304140242113" loading="lazy"/></p>
<p>（8）快速修改全局函数名</p>
<p>快捷方式与变量修改一样按下Ctrl+Shift+R，一处修改整个工程对应的函数名称也会跟着改。选中函数后，按下Ctrl+Shift+R后整个工程的对应的函数名会高亮，并且在软件下方弹出修改框。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/257b6eb6d3a24fe3958a93295b0a2d3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=ZB89axi8zTbcGZdO4BELLznua3E%3D" alt="image-20240304140311742" loading="lazy"/></p>
<h3 data-id="heading-53">3.7 QT帮助文档</h3>
<p>Qt 帮助文档太多，难以全部翻译成中文，即使翻译了一部分，翻译花的时间太多，翻译更新的时效性也难以保证，最终还是得看英文帮助，QtCreator 集成了帮助系统，查找非常方便。</p>
<p>打开QtCreator，选择菜单栏的最左边的帮助选项，界面如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e206ccc87b504c52a976ef69d7061ea6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=iX29EMyPeyyiGrZqNPSJqsireoA%3D" alt="image-20240304140337833" loading="lazy"/></p>
<p>（1）查看Qlabel控件的帮助信息：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b5057dbb1694be19e6ab07d25f6be5a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=dTxGj39tuIvXSEOXVDF7pv3tbk4%3D" alt="image-20240304140357011" loading="lazy"/></p>
<h3 data-id="heading-54">3.8 UI设计师使用</h3>
<p>上节的Hello QT程序使用纯C++代码编写，这一节使用QT界面设计模式实现与上一节<code>Hello QT程序</code>一样的功能。仿照着上节新创建一个工程。双击打开<code>mainwindow.ui</code>文件，进入到UI设计界面。</p>
<p>（1）拖一个Label控件到编辑区，双击Label控件可以修改文本内容。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db383ffaab0b4b93a65bda8e283489c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=qqZo29q0%2BfZIDvWRaF71%2BqP6caQ%3D" alt="image-20240304140517858" loading="lazy"/></p>
<p>（2）运行程序可以点击左下角的三角形符号或者按下快捷键Ctrl+R。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6b0ed4a33df49ce87bb957f47897d4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=ZheLEFl3z5MhlVcvQeOuXNXrKDI%3D" alt="image-20240304140600717" loading="lazy"/></p>
<p>（3）UI设计师界面功能介绍</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7fa2ef9b3904859a350dd403519781d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=%2FjLD9OKJTwmtNjkNtGWcMBtL%2F18%3D" alt="image-20240304140615717" loading="lazy"/></p>
<h3 data-id="heading-55">3.9 按钮控件组</h3>
<p>QT Creator UI设计师界面的按钮组截图如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a9f14b2bbdd4d3993859d1e355f27a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=iG%2FyrkN8XYsiBseJsrxHONSx5SQ%3D" alt="image-20240304140809093" loading="lazy"/></p>
<p>以下是对按钮组控件的一些功能介绍：</p>
<p>（1）Push Button按压按钮：最普通的按钮，按(点击)按钮命令计算机执行一些动作，或者回答问题，比如windows开始菜单里的重启，注销，关机等按钮。</p>
<p>（2）Tool Button工具按钮：工具按钮是一个集合，一般集成在工具栏里。比如打开，保存，复制，粘贴，剪切等常用的操作。</p>
<p>（3）Radio Button单选按钮：单选按钮是两个以上的形式出现在一块，按钮之间有互斥关系，每次只能选中一个。比如：一个人的性别只能选择一个，不能同时是男性又是女性。</p>
<p>（4）Check Box复选框：复选框与单选按钮概念相反，复选框表示多个可以同时存在的选项，比如一个人可以同时拥有多个爱好，比如读书、看电影、爬山、游泳等。</p>
<p>（5）Command Link Button命令链接按钮：一般用来打开的窗口或者网页链接。</p>
<p>（6）Dialog Button Box标准按钮盒：标准按钮盒用于对话框程序；比如：常见的确认对话框有 “确定”“取消”等标准按钮，Qt 将这些典型的按钮做成标准按钮盒，并将相应的信号加以封装，方便程序员使用。</p>
<h3 data-id="heading-56">3.10 布局控件组</h3>
<p>开发一个图形界面应用程序，界面的布局影响到界面的美观。前面的程序中都是使用UI界面拖控件，如果有多个按钮，会出现大小难调整、位置难对齐等问题。Qt 提供的“布局管理“就很好的解决了控件摆放的问题。</p>
<p>以下是UI设计师界面的布局相关控件组：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89631e2c4bff4db4b4286922a496def8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=xyeGpOovOvgG8nBXDeBXp14l1OA%3D" alt="image-20240304140914361" loading="lazy"/></p>
<p><strong>功能介绍：</strong></p>
<p>（1）Vertical Layout：垂直布局</p>
<p>（2）Horizontal Layout：水平布局</p>
<p>（3）Grid Layout：网格布局</p>
<p>（4）Form Layout：窗体中布局</p>
<p>（5）Horizontal Spacers：水平空格，在布局中用来占位。</p>
<p>（6）Vertical Spacer：垂直空格，在布局中用来占位。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/475f9b71f3ef49d1b25de6a2e0b12346~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=PLF%2FnQYYCQIba%2F4qfjabA%2FH0OTk%3D" alt="image-20240304140956243" loading="lazy"/></p>
<h3 data-id="heading-57">3.11 基本布局控件</h3>
<p>在UI设计界面添加一个布局控件，然后将需要布局的其他控件放入布局控件中即可完成布局，布局控件可以互相嵌套使用。（本节只介绍基本布局控件的使用）</p>
<p><strong>以下是4种布局控件的效果：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aba84d7044e54b1baa2deb483323bbbc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=GBIXrDCNJAABt0TQ9ZrIjLI1kcY%3D" alt="image-20240304141035428" loading="lazy"/></p>
<h3 data-id="heading-58">3.12 UI设计师的布局功能</h3>
<p>在UI设计界面的左上角有一排快捷的布局选项，使用时选中两个以上的控件，点击其中一种布局方式就可以切换布局。</p>
<p>以下为布局的简单示例图：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4026b618e45f4672bdc0580e4ad3459f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=a6IvwcA4KonCvaskw1bGJ5aBtjM%3D" alt="image-20240304141115657" loading="lazy"/></p>
<p>（1）为布局的选项。</p>
<p>（2）控件层次图，可以看到控件的布局摆放层次。</p>
<p>如果想要控制某个控件的固定大小，不随着布局改变大小，可以限定最大最小尺寸。选中控件鼠标右键--&gt;大小限定-&gt;设置大小。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7c0f3f0b868d4cb7b62fdf11c764ac26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=pgvp9tIWwImDplJyMfJ%2By7a1eGQ%3D" alt="image-20240304141311256" loading="lazy"/></p>
<p><strong>水平布局与垂直布局：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fac6c6f1d9734a75a789b7d795142e4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=Ol%2BvOLpM2wdoUmQvK%2FPpTMggITQ%3D" alt="image-20240304141335977" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02127c0ed419463e828ccd7d5b73f1cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=5blCaPdcj%2FieClN4FQonLuxSQVI%3D" alt="image-20240304141347209" loading="lazy"/></p>
<p>水平布局将控件按照水平方式摆放，垂直布局将控件按照垂直方式摆放。鼠标拖动红色布局框上的黑色方点，可以调整布局框的大小。随着布局框的尺寸变化，包含的控件高度不会变化，宽度会随着布局框变化。选中其中一个控件然后鼠标右键&gt;点击大小限定，可以限定控件的最大和最小尺寸。</p>
<p><strong>分裂器水平布局与垂直布局：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32e29b498be2486aa831e840f358d874~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=MH63OXdJ57fox%2BdZreiLlIFEuRY%3D" alt="image-20240304141412287" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/92e0d7042ce84cb486168298b6354efd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=37VMLECp0RFsxBib%2BaTiZtfrVTI%3D" alt="image-20240304141426088" loading="lazy"/></p>
<p>分裂器方式布局，包含控件的高度和宽度都会随着布局框的拉伸而改变。选中其中一个控件然后鼠标右键&gt;点击大小限定，可以限定控件的最大和最小尺寸。</p>
<p><strong>窗体中布局与栅格布局：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c8dc789e7d2459b8eca3a0a413452f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=tG4SXFS5id6Mr6cve36qlplZP9g%3D" alt="image-20240304141449390" loading="lazy"/></p>
<p>栅格（网格）布局器的基本单元是单元格，而窗体中布局（表单）的基本单元是行。随着布局框的尺寸变化，包含的控件高度不会变化，宽度会随着布局框变化。</p>
<p><strong>设置主窗体布局方式：</strong></p>
<p>设置主窗体的布局方式后，包含在主窗体内的控件会随着窗体的拉伸自动调整大小。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b46dce499a7e4476bfe71edb3f57675a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=j6H4seKpLE3JeWHWxLMb%2Beq7FdY%3D" alt="image-20240304141518067" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9ad30da169cb472283fbc8c940e95c77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=7RThh6BMwx504GGmha%2FLqwcjYMA%3D" alt="image-20240304141529003" loading="lazy"/></p>
<h2 data-id="heading-59">四、上位机开发</h2>
<p>当前项目使用的相关软件工具、模块源码已经上传到网盘：<a href="https://link.juejin.cn?target=https%3A%2F%2Fccnr8sukk85n.feishu.cn%2Fwiki%2FQjY8weDYHibqRYkFP2qcA9aGnvb%3Ffrom%3Dfrom_copylink" target="_blank" title="https://ccnr8sukk85n.feishu.cn/wiki/QjY8weDYHibqRYkFP2qcA9aGnvb?from=from_copylink" ref="nofollow noopener noreferrer">ccnr8sukk85n.feishu.cn/wiki/QjY8we…</a></p>
<h3 data-id="heading-60">4.1 Qt开发环境安装</h3>
<p>Qt的中文官网： <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.qt.io%2Fzh-cn%2F!%255Bimage-20221207160550486%255D(https%3A%2F%2Fled-obs.obs.cn-north-1.myhuaweicloud.com%2FBlog%2Fimg%2Fimage-20221207160550486.png)" target="_blank" title="https://www.qt.io/zh-cn/!%5Bimage-20221207160550486%5D(https://led-obs.obs.cn-north-1.myhuaweicloud.com/Blog/img/image-20221207160550486.png)" ref="nofollow noopener noreferrer">www.qt.io/zh-cn/![ima…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efe081cf84ef4352b544edc732a114b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=E9H4FZjiuLgrwIv4rqu3rl5lDZE%3D" alt="image-20221207160606892" loading="lazy"/></p>
<p>QT5.12.6的下载地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdownload.qt.io%2Farchive%2Fqt%2F5.12%2F5.12.6" target="_blank" title="https://download.qt.io/archive/qt/5.12/5.12.6" ref="nofollow noopener noreferrer">download.qt.io/archive/qt/…</a></p>
<p><strong>打开下载链接后选择下面的版本进行下载：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e09c8bfafbf04bf8a1701fb6911108ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=Z3sEaVnnWldBYgJ3SG%2BoZuHc99k%3D" alt="" loading="lazy"/></p>
<p><strong>如果下载不了，可以在网盘里找到安装包下载：</strong>    飞书文档记录的网盘地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fccnr8sukk85n.feishu.cn%2Fwiki%2FQjY8weDYHibqRYkFP2qcA9aGnvb%3Ffrom%3Dfrom_copylink" target="_blank" title="https://ccnr8sukk85n.feishu.cn/wiki/QjY8weDYHibqRYkFP2qcA9aGnvb?from=from_copylink" ref="nofollow noopener noreferrer">ccnr8sukk85n.feishu.cn/wiki/QjY8we…</a></p>
<p>软件安装时断网安装，否则会提示输入账户。</p>
<p>安装的时候，第一个复选框里的编译器可以全选，直接点击下一步继续安装。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4a6adb7af5742d6936a6f3ff605e390~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=Lk8aAAze%2Fgp9%2Bt8y8VotdU2bsss%3D" alt="image-20221203151742653" loading="lazy"/></p>
<p><strong>选择编译器： （一定要看清楚了）</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e09e9021ec534fd792e01d8e443f856f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=aIdMc1WGjlV%2BU%2FzIeGfQ%2B3%2B%2FaIA%3D" alt="image-20241028152725134" loading="lazy"/></p>
<h3 data-id="heading-61">4.2 新建上位机工程</h3>
<p>前面2讲解了需要用的API接口，接下来就使用Qt设计上位机，设计界面，完成整体上位机的逻辑设计。</p>
<p>【1】新建工程</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87ec690405eb4da9a8d9c042a011de15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=UYAvdNFLCxzjiu7DgFJ1%2FMsf9eI%3D" alt="image-20240117144052547" loading="lazy"/></p>
<p>【2】设置项目的名称。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac5345c4eb514b93927a55da0b7d5cb3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=pfgmK1vzkILs8rULSujrSFDTsLs%3D" alt="image-20250420200347498" loading="lazy"/></p>
<p>【3】选择编译系统</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64428c6047f44c348349eae7d139a7df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=pzg766wHBJbAbvei6NgfMSoCsZQ%3D" alt="image-20240117144239681" loading="lazy"/></p>
<p>【4】选择默认继承的类</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/214a2aa185524b4ea9b3bc58a1e2be46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=3tiGjWOKfHCcIMaPOXFQdNJU8A8%3D" alt="image-20240117144302275" loading="lazy"/></p>
<p>【5】选择编译器</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5cf96330cfd64a45a71f68121376e0cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=cE%2F%2FpizIozA0my202dm60P%2Fv9Ow%3D" alt="image-20241028153603487" loading="lazy"/></p>
<p>【6】点击完成</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1237dfea39d4a0eaeaa4cbeacf367a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=enV8ue7G3ChfTNmOsGfYfS3UllQ%3D" alt="image-20240117144354252" loading="lazy"/></p>
<p>【7】工程创建完成</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1a22eec2947487ab503c8f2f235c4a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=MwhHDqDEbkV%2FgDKiDlxYxNZUNIg%3D" alt="image-20250420200411303" loading="lazy"/></p>
<h3 data-id="heading-62">4.3 切换编译器</h3>
<p>在左下角是可以切换编译器的。 可以选择用什么样的编译器编译程序。</p>
<p>目前新建工程的时候选择了2种编译器。 一种是<code>mingw32</code>这个编译Windows下运行的程序。 一种是<code>Android</code>编译器，可以生成<code>Android</code>手机APP。</p>
<p><code>不过要注意：Android的编译器需要配置一些环境才可以正常使用，这个大家可以网上找找教程配置一下就行了。</code></p>
<p>windows的编译器就没有这么麻烦，安装好Qt就可以编译使用。</p>
<p>下面我这里就选择的 <code>mingw32</code>这个编译器，编译Windows下运行的程序。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/014b8da88b874ac7931467cfcecfb868~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=LAfnvqNnGVJUl5No2YwaI8Umlpo%3D" alt="image-20250420200424965" loading="lazy"/></p>
<h3 data-id="heading-63">4.4 编译测试功能</h3>
<p>创建完毕之后，编译测试一下功能是否OK。</p>
<p>点击左下角的<code>绿色三角形按钮</code>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f15a3c3c47704896baa148320a9ac299~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=WOer2S2RXtdhfz%2B%2B3RaOMipzUCo%3D" alt="image-20250420200442769" loading="lazy"/></p>
<p>正常运行就可以看到弹出一个白色的框框。这就表示工程环境没有问题了。 接下来就可以放心的设计界面了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a22a20938bae449f96c04077ff18b298~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=M48pdmITha0rWlPOuPPkHMrlaD0%3D" alt="image-20250420200457319" loading="lazy"/></p>
<h3 data-id="heading-64">4.5 设计UI界面与工程配置</h3>
<h4 data-id="heading-65">【1】打开UI文件</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18e4e44f35614e5197e6784cf4797b87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=HTI99axoLMS6wJJfhB6C7ivMppQ%3D" alt="image-20250420200514220" loading="lazy"/></p>
<p><strong>打开默认的界面如下：</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/627274d7d20c476d80999704f374dc0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=LesQdPSjly3p0uT%2BUMLX%2BpuqPac%3D" alt="image-20250420200526194" loading="lazy"/></p>
<h4 data-id="heading-66">【2】开始设计界面</h4>
<p>根据自己需求设计界面。</p>
<h3 data-id="heading-67">4.6 设计代码</h3>
<h4 data-id="heading-68">设计说明</h4>
<ol>
<li><strong>纯代码构建 UI</strong>：不依赖 <code>.ui</code> 文件，只需要把 <code>.h</code> 和 <code>.cpp</code> 文件复制到项目中即可，无需配置 UI 设计器。</li>
<li><strong>MQTT 通信</strong>：由于 Qt 官方的 <code>QtMqtt</code> 模块在标准安装包中不包含（需要自行编译），为了保证兼容性和降低门槛，<strong>本代码示例假设已经配置好了 QtMqtt 环境</strong>。
<ul>
<li><em>如果的 Qt 环境没有 Mqtt 模块，需要先编译安装 <code>QtMqtt</code>，或者使用第三方库（如 QMQTT）。</em></li>
</ul>
</li>
<li><strong>数据协议</strong>：采用标准的 JSON 格式与 STM32 通信。</li>
<li><strong>功能覆盖</strong>：包含了连接云平台、实时数据显示（温湿度、重量、光照等）、阈值下发设置、日志显示。</li>
</ol>
<hr/>
<h4 data-id="heading-69">1. 项目配置文件 (BeehiveMonitor.pro)</h4>
<p>在 <code>.pro</code> 文件中，必须添加 <code>mqtt</code> 模块（如果使用的是官方模块）。</p>
<pre><code class="hljs language-pro" lang="pro">QT       += core gui network mqtt

greaterThan(QT_MAJOR_VERSION, 4): QT += widgets

CONFIG += c++11

# You can rename the target as you like
TARGET = BeehiveMonitor
TEMPLATE = app

SOURCES += \
    main.cpp \
    mainwindow.cpp

HEADERS += \
    mainwindow.h
</code></pre>
<hr/>
<h4 data-id="heading-70">2. 头文件 (mainwindow.h)</h4>
<p>定义了界面元素和业务逻辑。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> MAINWINDOW_H</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> MAINWINDOW_H</span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QMainWindow&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QMqttClient&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QLabel&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QLineEdit&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QPushButton&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QTextEdit&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QGroupBox&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QGridLayout&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QSpinBox&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QJsonDocument&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QJsonObject&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QDateTime&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainWindow</span> : <span class="hljs-keyword">public</span> QMainWindow
{
    Q_OBJECT

<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">MainWindow</span>(QWidget *parent = <span class="hljs-literal">nullptr</span>);
    ~<span class="hljs-built_in">MainWindow</span>();

<span class="hljs-keyword">private</span> slots:
    <span class="hljs-comment">// MQTT Slots</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">onConnectClicked</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">onSubscribeClicked</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">onPublishThresholdClicked</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">updateLogStateChange</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">brokerDisconnected</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">onMessageReceived</span><span class="hljs-params">(<span class="hljs-type">const</span> QByteArray &amp;message, <span class="hljs-type">const</span> QMqttTopicName &amp;topic)</span></span>;

<span class="hljs-keyword">private</span>:
    <span class="hljs-comment">// --- UI 初始化函数 ---</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">initUI</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setupMqtt</span><span class="hljs-params">()</span></span>;

    <span class="hljs-comment">// --- MQTT 客户端 ---</span>
    QMqttClient *m_client;

    <span class="hljs-comment">// --- UI 控件 ---</span>
    <span class="hljs-comment">// 1. 连接设置区域</span>
    QLineEdit *le_host;
    QLineEdit *le_port;
    QLineEdit *le_clientId;
    QLineEdit *le_username;
    QLineEdit *le_password;
    QLineEdit *le_sub_topic; <span class="hljs-comment">// 订阅主题（接收数据）</span>
    QLineEdit *le_pub_topic; <span class="hljs-comment">// 发布主题（下发命令）</span>
    QPushButton *btn_connect;
    QPushButton *btn_subscribe;

    <span class="hljs-comment">// 2. 实时数据通过 Label 显示</span>
    QLabel *lbl_temp_in;
    QLabel *lbl_humi_in;
    QLabel *lbl_temp_out;
    QLabel *lbl_humi_out;
    QLabel *lbl_weight;
    QLabel *lbl_sound;
    QLabel *lbl_light;
    QLabel *lbl_vibration; <span class="hljs-comment">// 状态：正常/异常</span>

    <span class="hljs-comment">// 3. 阈值设置</span>
    QSpinBox *sb_temp_max;
    QSpinBox *sb_humi_max;
    QDoubleSpinBox *sb_weight_min; <span class="hljs-comment">// 比如失重报警</span>
    QSpinBox *sb_sound_max;
    QPushButton *btn_set_threshold;

    <span class="hljs-comment">// 4. 日志区域</span>
    QTextEdit *txt_log;

    <span class="hljs-comment">// --- 辅助函数 ---</span>
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">log</span><span class="hljs-params">(<span class="hljs-type">const</span> QString &amp;msg)</span></span>;
};

<span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// MAINWINDOW_H</span></span>
</code></pre>
<hr/>
<h4 data-id="heading-71">3. 源文件 (mainwindow.cpp)</h4>
<p>实现了核心逻辑：解析 JSON、更新 UI、发送 MQTT 指令。</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"mainwindow.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QVBoxLayout&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QMessageBox&gt;</span></span>

MainWindow::<span class="hljs-built_in">MainWindow</span>(QWidget *parent)
    : <span class="hljs-built_in">QMainWindow</span>(parent)
{
    <span class="hljs-built_in">initUI</span>();
    <span class="hljs-built_in">setupMqtt</span>();
}

MainWindow::~<span class="hljs-built_in">MainWindow</span>()
{
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">MainWindow::initUI</span><span class="hljs-params">()</span>
</span>{
    QWidget *centralWidget = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QWidget</span>(<span class="hljs-keyword">this</span>);
    <span class="hljs-built_in">setCentralWidget</span>(centralWidget);
    QVBoxLayout *mainLayout = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QVBoxLayout</span>(centralWidget);

    <span class="hljs-comment">// === 1. 连接配置区域 ===</span>
    QGroupBox *grpSettings = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QGroupBox</span>(<span class="hljs-string">"华为云 MQTT 连接配置"</span>, <span class="hljs-keyword">this</span>);
    QGridLayout *layoutSettings = <span class="hljs-keyword">new</span> QGridLayout;

    layoutSettings-&gt;<span class="hljs-built_in">addWidget</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">QLabel</span>(<span class="hljs-string">"服务器地址:"</span>), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
    le_host = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QLineEdit</span>(<span class="hljs-string">"iot-mqtts.cn-north-4.myhuaweicloud.com"</span>); <span class="hljs-comment">// 示例地址</span>
    layoutSettings-&gt;<span class="hljs-built_in">addWidget</span>(le_host, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);

    layoutSettings-&gt;<span class="hljs-built_in">addWidget</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">QLabel</span>(<span class="hljs-string">"端口:"</span>), <span class="hljs-number">0</span>, <span class="hljs-number">2</span>);
    le_port = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QLineEdit</span>(<span class="hljs-string">"1883"</span>);
    layoutSettings-&gt;<span class="hljs-built_in">addWidget</span>(le_port, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>);

    layoutSettings-&gt;<span class="hljs-built_in">addWidget</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">QLabel</span>(<span class="hljs-string">"Client ID:"</span>), <span class="hljs-number">1</span>, <span class="hljs-number">0</span>);
    le_clientId = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QLineEdit</span>(<span class="hljs-string">"Beehive_PC_Client"</span>);
    layoutSettings-&gt;<span class="hljs-built_in">addWidget</span>(le_clientId, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);

    layoutSettings-&gt;<span class="hljs-built_in">addWidget</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">QLabel</span>(<span class="hljs-string">"用户名:"</span>), <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);
    le_username = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QLineEdit</span>();
    layoutSettings-&gt;<span class="hljs-built_in">addWidget</span>(le_username, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>);

    layoutSettings-&gt;<span class="hljs-built_in">addWidget</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">QLabel</span>(<span class="hljs-string">"密码:"</span>), <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);
    le_password = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QLineEdit</span>();
    le_password-&gt;<span class="hljs-built_in">setEchoMode</span>(QLineEdit::Password);
    layoutSettings-&gt;<span class="hljs-built_in">addWidget</span>(le_password, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>);

    btn_connect = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QPushButton</span>(<span class="hljs-string">"连接服务器"</span>);
    layoutSettings-&gt;<span class="hljs-built_in">addWidget</span>(btn_connect, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);

    layoutSettings-&gt;<span class="hljs-built_in">addWidget</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">QLabel</span>(<span class="hljs-string">"订阅Topic (接收):"</span>), <span class="hljs-number">3</span>, <span class="hljs-number">0</span>);
    le_sub_topic = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QLineEdit</span>(<span class="hljs-string">"/beehive/data"</span>); <span class="hljs-comment">// 需根据华为云规则修改</span>
    layoutSettings-&gt;<span class="hljs-built_in">addWidget</span>(le_sub_topic, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);
    
    btn_subscribe = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QPushButton</span>(<span class="hljs-string">"订阅"</span>);
    btn_subscribe-&gt;<span class="hljs-built_in">setEnabled</span>(<span class="hljs-literal">false</span>);
    layoutSettings-&gt;<span class="hljs-built_in">addWidget</span>(btn_subscribe, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>);

    layoutSettings-&gt;<span class="hljs-built_in">addWidget</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">QLabel</span>(<span class="hljs-string">"发布Topic (命令):"</span>), <span class="hljs-number">4</span>, <span class="hljs-number">0</span>);
    le_pub_topic = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QLineEdit</span>(<span class="hljs-string">"/beehive/cmd"</span>); <span class="hljs-comment">// 需根据华为云规则修改</span>
    layoutSettings-&gt;<span class="hljs-built_in">addWidget</span>(le_pub_topic, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>);

    grpSettings-&gt;<span class="hljs-built_in">setLayout</span>(layoutSettings);
    mainLayout-&gt;<span class="hljs-built_in">addWidget</span>(grpSettings);

    <span class="hljs-comment">// === 2. 实时监控面板 ===</span>
    QGroupBox *grpData = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QGroupBox</span>(<span class="hljs-string">"蜂箱实时监测数据"</span>, <span class="hljs-keyword">this</span>);
    QGridLayout *layoutData = <span class="hljs-keyword">new</span> QGridLayout;

    <span class="hljs-comment">// 样式设置</span>
    QString labelStyle = <span class="hljs-string">"QLabel { font-size: 18px; font-weight: bold; color: #2E8B57; }"</span>;
    
    <span class="hljs-comment">// 初始化 Label</span>
    lbl_temp_in = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QLabel</span>(<span class="hljs-string">"0.0 ℃"</span>); lbl_temp_in-&gt;<span class="hljs-built_in">setStyleSheet</span>(labelStyle);
    lbl_humi_in = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QLabel</span>(<span class="hljs-string">"0.0 %"</span>); lbl_humi_in-&gt;<span class="hljs-built_in">setStyleSheet</span>(labelStyle);
    lbl_temp_out = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QLabel</span>(<span class="hljs-string">"0.0 ℃"</span>); lbl_temp_out-&gt;<span class="hljs-built_in">setStyleSheet</span>(labelStyle);
    lbl_humi_out = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QLabel</span>(<span class="hljs-string">"0.0 %"</span>); lbl_humi_out-&gt;<span class="hljs-built_in">setStyleSheet</span>(labelStyle);
    lbl_weight = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QLabel</span>(<span class="hljs-string">"0.00 kg"</span>); lbl_weight-&gt;<span class="hljs-built_in">setStyleSheet</span>(<span class="hljs-string">"QLabel { font-size: 18px; font-weight: bold; color: blue; }"</span>);
    lbl_sound = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QLabel</span>(<span class="hljs-string">"0 dB"</span>); lbl_sound-&gt;<span class="hljs-built_in">setStyleSheet</span>(labelStyle);
    lbl_light = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QLabel</span>(<span class="hljs-string">"0 Lx"</span>); lbl_light-&gt;<span class="hljs-built_in">setStyleSheet</span>(labelStyle);
    lbl_vibration = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QLabel</span>(<span class="hljs-string">"正常"</span>); lbl_vibration-&gt;<span class="hljs-built_in">setStyleSheet</span>(<span class="hljs-string">"QLabel { font-size: 18px; font-weight: bold; color: green; }"</span>);

    layoutData-&gt;<span class="hljs-built_in">addWidget</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">QLabel</span>(<span class="hljs-string">"内部温度:"</span>), <span class="hljs-number">0</span>, <span class="hljs-number">0</span>); layoutData-&gt;<span class="hljs-built_in">addWidget</span>(lbl_temp_in, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
    layoutData-&gt;<span class="hljs-built_in">addWidget</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">QLabel</span>(<span class="hljs-string">"内部湿度:"</span>), <span class="hljs-number">0</span>, <span class="hljs-number">2</span>); layoutData-&gt;<span class="hljs-built_in">addWidget</span>(lbl_humi_in, <span class="hljs-number">0</span>, <span class="hljs-number">3</span>);
    
    layoutData-&gt;<span class="hljs-built_in">addWidget</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">QLabel</span>(<span class="hljs-string">"外部温度:"</span>), <span class="hljs-number">1</span>, <span class="hljs-number">0</span>); layoutData-&gt;<span class="hljs-built_in">addWidget</span>(lbl_temp_out, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
    layoutData-&gt;<span class="hljs-built_in">addWidget</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">QLabel</span>(<span class="hljs-string">"外部湿度:"</span>), <span class="hljs-number">1</span>, <span class="hljs-number">2</span>); layoutData-&gt;<span class="hljs-built_in">addWidget</span>(lbl_humi_out, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>);

    layoutData-&gt;<span class="hljs-built_in">addWidget</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">QLabel</span>(<span class="hljs-string">"蜂箱重量:"</span>), <span class="hljs-number">2</span>, <span class="hljs-number">0</span>); layoutData-&gt;<span class="hljs-built_in">addWidget</span>(lbl_weight, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>);
    layoutData-&gt;<span class="hljs-built_in">addWidget</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">QLabel</span>(<span class="hljs-string">"光照强度:"</span>), <span class="hljs-number">2</span>, <span class="hljs-number">2</span>); layoutData-&gt;<span class="hljs-built_in">addWidget</span>(lbl_light, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>);

    layoutData-&gt;<span class="hljs-built_in">addWidget</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">QLabel</span>(<span class="hljs-string">"声音强度:"</span>), <span class="hljs-number">3</span>, <span class="hljs-number">0</span>); layoutData-&gt;<span class="hljs-built_in">addWidget</span>(lbl_sound, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>);
    layoutData-&gt;<span class="hljs-built_in">addWidget</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">QLabel</span>(<span class="hljs-string">"震动状态:"</span>), <span class="hljs-number">3</span>, <span class="hljs-number">2</span>); layoutData-&gt;<span class="hljs-built_in">addWidget</span>(lbl_vibration, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>);

    grpData-&gt;<span class="hljs-built_in">setLayout</span>(layoutData);
    mainLayout-&gt;<span class="hljs-built_in">addWidget</span>(grpData);

    <span class="hljs-comment">// === 3. 阈值设置面板 ===</span>
    QGroupBox *grpControl = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QGroupBox</span>(<span class="hljs-string">"报警阈值配置"</span>, <span class="hljs-keyword">this</span>);
    QHBoxLayout *layoutControl = <span class="hljs-keyword">new</span> QHBoxLayout;

    layoutControl-&gt;<span class="hljs-built_in">addWidget</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">QLabel</span>(<span class="hljs-string">"最高温度:"</span>));
    sb_temp_max = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QSpinBox</span>(); sb_temp_max-&gt;<span class="hljs-built_in">setRange</span>(<span class="hljs-number">0</span>, <span class="hljs-number">60</span>); sb_temp_max-&gt;<span class="hljs-built_in">setValue</span>(<span class="hljs-number">38</span>);
    layoutControl-&gt;<span class="hljs-built_in">addWidget</span>(sb_temp_max);

    layoutControl-&gt;<span class="hljs-built_in">addWidget</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">QLabel</span>(<span class="hljs-string">"最小重量(kg):"</span>));
    sb_weight_min = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QDoubleSpinBox</span>(); sb_weight_min-&gt;<span class="hljs-built_in">setRange</span>(<span class="hljs-number">0</span>, <span class="hljs-number">50</span>); sb_weight_min-&gt;<span class="hljs-built_in">setValue</span>(<span class="hljs-number">5.0</span>);
    layoutControl-&gt;<span class="hljs-built_in">addWidget</span>(sb_weight_min);

    layoutControl-&gt;<span class="hljs-built_in">addWidget</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">QLabel</span>(<span class="hljs-string">"声音阈值(dB):"</span>));
    sb_sound_max = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QSpinBox</span>(); sb_sound_max-&gt;<span class="hljs-built_in">setRange</span>(<span class="hljs-number">0</span>, <span class="hljs-number">120</span>); sb_sound_max-&gt;<span class="hljs-built_in">setValue</span>(<span class="hljs-number">80</span>);
    layoutControl-&gt;<span class="hljs-built_in">addWidget</span>(sb_sound_max);

    btn_set_threshold = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QPushButton</span>(<span class="hljs-string">"下发配置"</span>);
    btn_set_threshold-&gt;<span class="hljs-built_in">setEnabled</span>(<span class="hljs-literal">false</span>);
    layoutControl-&gt;<span class="hljs-built_in">addWidget</span>(btn_set_threshold);

    grpControl-&gt;<span class="hljs-built_in">setLayout</span>(layoutControl);
    mainLayout-&gt;<span class="hljs-built_in">addWidget</span>(grpControl);

    <span class="hljs-comment">// === 4. 日志显示 ===</span>
    txt_log = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QTextEdit</span>();
    txt_log-&gt;<span class="hljs-built_in">setReadOnly</span>(<span class="hljs-literal">true</span>);
    txt_log-&gt;<span class="hljs-built_in">setMaximumHeight</span>(<span class="hljs-number">150</span>);
    mainLayout-&gt;<span class="hljs-built_in">addWidget</span>(txt_log);

    <span class="hljs-comment">// 信号连接</span>
    <span class="hljs-built_in">connect</span>(btn_connect, &amp;QPushButton::clicked, <span class="hljs-keyword">this</span>, &amp;MainWindow::onConnectClicked);
    <span class="hljs-built_in">connect</span>(btn_subscribe, &amp;QPushButton::clicked, <span class="hljs-keyword">this</span>, &amp;MainWindow::onSubscribeClicked);
    <span class="hljs-built_in">connect</span>(btn_set_threshold, &amp;QPushButton::clicked, <span class="hljs-keyword">this</span>, &amp;MainWindow::onPublishThresholdClicked);

    <span class="hljs-built_in">setWindowTitle</span>(<span class="hljs-string">"智能蜂箱监测系统 - 上位机"</span>);
    <span class="hljs-built_in">resize</span>(<span class="hljs-number">800</span>, <span class="hljs-number">600</span>);
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">MainWindow::setupMqtt</span><span class="hljs-params">()</span>
</span>{
    m_client = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QMqttClient</span>(<span class="hljs-keyword">this</span>);
    
    <span class="hljs-comment">// 状态改变信号</span>
    <span class="hljs-built_in">connect</span>(m_client, &amp;QMqttClient::stateChanged, <span class="hljs-keyword">this</span>, &amp;MainWindow::updateLogStateChange);
    <span class="hljs-built_in">connect</span>(m_client, &amp;QMqttClient::disconnected, <span class="hljs-keyword">this</span>, &amp;MainWindow::brokerDisconnected);

    <span class="hljs-comment">// 收到消息信号</span>
    <span class="hljs-built_in">connect</span>(m_client, &amp;QMqttClient::messageReceived, <span class="hljs-keyword">this</span>, &amp;MainWindow::onMessageReceived);
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">MainWindow::onConnectClicked</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-keyword">if</span> (m_client-&gt;<span class="hljs-built_in">state</span>() == QMqttClient::Disconnected) {
        m_client-&gt;<span class="hljs-built_in">setHostname</span>(le_host-&gt;<span class="hljs-built_in">text</span>());
        m_client-&gt;<span class="hljs-built_in">setPort</span>(le_port-&gt;<span class="hljs-built_in">text</span>().<span class="hljs-built_in">toInt</span>());
        m_client-&gt;<span class="hljs-built_in">setClientId</span>(le_clientId-&gt;<span class="hljs-built_in">text</span>());
        m_client-&gt;<span class="hljs-built_in">setUsername</span>(le_username-&gt;<span class="hljs-built_in">text</span>());
        m_client-&gt;<span class="hljs-built_in">setPassword</span>(le_password-&gt;<span class="hljs-built_in">text</span>());

        m_client-&gt;<span class="hljs-built_in">connectToHost</span>();
    } <span class="hljs-keyword">else</span> {
        m_client-&gt;<span class="hljs-built_in">disconnectFromHost</span>();
    }
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">MainWindow::updateLogStateChange</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-type">const</span> QString content = QDateTime::<span class="hljs-built_in">currentDateTime</span>().<span class="hljs-built_in">toString</span>() + <span class="hljs-string">": State Change -&gt; "</span> + QString::<span class="hljs-built_in">number</span>(m_client-&gt;<span class="hljs-built_in">state</span>());
    <span class="hljs-built_in">log</span>(content);

    <span class="hljs-keyword">if</span> (m_client-&gt;<span class="hljs-built_in">state</span>() == QMqttClient::Connected) {
        btn_connect-&gt;<span class="hljs-built_in">setText</span>(<span class="hljs-string">"断开连接"</span>);
        btn_subscribe-&gt;<span class="hljs-built_in">setEnabled</span>(<span class="hljs-literal">true</span>);
        btn_set_threshold-&gt;<span class="hljs-built_in">setEnabled</span>(<span class="hljs-literal">true</span>);
        <span class="hljs-built_in">log</span>(<span class="hljs-string">"成功连接至华为云服务器！"</span>);
    } <span class="hljs-keyword">else</span> {
        btn_connect-&gt;<span class="hljs-built_in">setText</span>(<span class="hljs-string">"连接服务器"</span>);
        btn_subscribe-&gt;<span class="hljs-built_in">setEnabled</span>(<span class="hljs-literal">false</span>);
        btn_set_threshold-&gt;<span class="hljs-built_in">setEnabled</span>(<span class="hljs-literal">false</span>);
    }
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">MainWindow::brokerDisconnected</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-built_in">log</span>(<span class="hljs-string">"已断开连接"</span>);
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">MainWindow::onSubscribeClicked</span><span class="hljs-params">()</span>
</span>{
    QString topic = le_sub_topic-&gt;<span class="hljs-built_in">text</span>();
    <span class="hljs-keyword">auto</span> subscription = m_client-&gt;<span class="hljs-built_in">subscribe</span>(topic);
    <span class="hljs-keyword">if</span> (!subscription) {
        <span class="hljs-built_in">log</span>(<span class="hljs-string">"订阅失败: "</span> + topic);
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-built_in">log</span>(<span class="hljs-string">"成功订阅主题: "</span> + topic);
}

<span class="hljs-comment">// *** 核心：处理接收到的 JSON 数据 ***</span>
<span class="hljs-comment">// 假设 STM32 发送的 JSON 格式如下：</span>
<span class="hljs-comment">// {</span>
<span class="hljs-comment">//    "temp_in": 28.5, "humi_in": 60,</span>
<span class="hljs-comment">//    "temp_out": 22.0, "humi_out": 45,</span>
<span class="hljs-comment">//    "weight": 10.5, "light": 1500,</span>
<span class="hljs-comment">//    "sound": 40, "vib": 0</span>
<span class="hljs-comment">// }</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">MainWindow::onMessageReceived</span><span class="hljs-params">(<span class="hljs-type">const</span> QByteArray &amp;message, <span class="hljs-type">const</span> QMqttTopicName &amp;topic)</span>
</span>{
    <span class="hljs-built_in">log</span>(<span class="hljs-string">"收到数据 ["</span> + topic.<span class="hljs-built_in">name</span>() + <span class="hljs-string">"]: "</span> + message);

    QJsonDocument doc = QJsonDocument::<span class="hljs-built_in">fromJson</span>(message);
    <span class="hljs-keyword">if</span> (doc.<span class="hljs-built_in">isNull</span>() || !doc.<span class="hljs-built_in">isObject</span>()) {
        <span class="hljs-built_in">log</span>(<span class="hljs-string">"JSON 解析失败"</span>);
        <span class="hljs-keyword">return</span>;
    }

    QJsonObject obj = doc.<span class="hljs-built_in">object</span>();

    <span class="hljs-comment">// 更新内部温湿度</span>
    <span class="hljs-keyword">if</span> (obj.<span class="hljs-built_in">contains</span>(<span class="hljs-string">"temp_in"</span>)) lbl_temp_in-&gt;<span class="hljs-built_in">setText</span>(QString::<span class="hljs-built_in">number</span>(obj[<span class="hljs-string">"temp_in"</span>].<span class="hljs-built_in">toDouble</span>(), <span class="hljs-string">'f'</span>, <span class="hljs-number">1</span>) + <span class="hljs-string">" ℃"</span>);
    <span class="hljs-keyword">if</span> (obj.<span class="hljs-built_in">contains</span>(<span class="hljs-string">"humi_in"</span>)) lbl_humi_in-&gt;<span class="hljs-built_in">setText</span>(QString::<span class="hljs-built_in">number</span>(obj[<span class="hljs-string">"humi_in"</span>].<span class="hljs-built_in">toDouble</span>(), <span class="hljs-string">'f'</span>, <span class="hljs-number">1</span>) + <span class="hljs-string">" %"</span>);

    <span class="hljs-comment">// 更新外部温湿度</span>
    <span class="hljs-keyword">if</span> (obj.<span class="hljs-built_in">contains</span>(<span class="hljs-string">"temp_out"</span>)) lbl_temp_out-&gt;<span class="hljs-built_in">setText</span>(QString::<span class="hljs-built_in">number</span>(obj[<span class="hljs-string">"temp_out"</span>].<span class="hljs-built_in">toDouble</span>(), <span class="hljs-string">'f'</span>, <span class="hljs-number">1</span>) + <span class="hljs-string">" ℃"</span>);
    <span class="hljs-keyword">if</span> (obj.<span class="hljs-built_in">contains</span>(<span class="hljs-string">"humi_out"</span>)) lbl_humi_out-&gt;<span class="hljs-built_in">setText</span>(QString::<span class="hljs-built_in">number</span>(obj[<span class="hljs-string">"humi_out"</span>].<span class="hljs-built_in">toDouble</span>(), <span class="hljs-string">'f'</span>, <span class="hljs-number">1</span>) + <span class="hljs-string">" %"</span>);

    <span class="hljs-comment">// 更新重量</span>
    <span class="hljs-keyword">if</span> (obj.<span class="hljs-built_in">contains</span>(<span class="hljs-string">"weight"</span>)) lbl_weight-&gt;<span class="hljs-built_in">setText</span>(QString::<span class="hljs-built_in">number</span>(obj[<span class="hljs-string">"weight"</span>].<span class="hljs-built_in">toDouble</span>(), <span class="hljs-string">'f'</span>, <span class="hljs-number">2</span>) + <span class="hljs-string">" kg"</span>);

    <span class="hljs-comment">// 更新光照</span>
    <span class="hljs-keyword">if</span> (obj.<span class="hljs-built_in">contains</span>(<span class="hljs-string">"light"</span>)) lbl_light-&gt;<span class="hljs-built_in">setText</span>(QString::<span class="hljs-built_in">number</span>(obj[<span class="hljs-string">"light"</span>].<span class="hljs-built_in">toInt</span>()) + <span class="hljs-string">" Lx"</span>);

    <span class="hljs-comment">// 更新声音</span>
    <span class="hljs-keyword">if</span> (obj.<span class="hljs-built_in">contains</span>(<span class="hljs-string">"sound"</span>)) lbl_sound-&gt;<span class="hljs-built_in">setText</span>(QString::<span class="hljs-built_in">number</span>(obj[<span class="hljs-string">"sound"</span>].<span class="hljs-built_in">toInt</span>()) + <span class="hljs-string">" dB"</span>);

    <span class="hljs-comment">// 更新震动状态</span>
    <span class="hljs-keyword">if</span> (obj.<span class="hljs-built_in">contains</span>(<span class="hljs-string">"vib"</span>)) {
        <span class="hljs-type">int</span> vib = obj[<span class="hljs-string">"vib"</span>].<span class="hljs-built_in">toInt</span>();
        <span class="hljs-keyword">if</span> (vib == <span class="hljs-number">1</span>) {
            lbl_vibration-&gt;<span class="hljs-built_in">setText</span>(<span class="hljs-string">"⚠ 异常震动!"</span>);
            lbl_vibration-&gt;<span class="hljs-built_in">setStyleSheet</span>(<span class="hljs-string">"QLabel { font-size: 18px; font-weight: bold; color: red; }"</span>);
        } <span class="hljs-keyword">else</span> {
            lbl_vibration-&gt;<span class="hljs-built_in">setText</span>(<span class="hljs-string">"正常"</span>);
            lbl_vibration-&gt;<span class="hljs-built_in">setStyleSheet</span>(<span class="hljs-string">"QLabel { font-size: 18px; font-weight: bold; color: green; }"</span>);
        }
    }
}

<span class="hljs-comment">// *** 核心：下发阈值配置 ***</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">MainWindow::onPublishThresholdClicked</span><span class="hljs-params">()</span>
</span>{
    QString topic = le_pub_topic-&gt;<span class="hljs-built_in">text</span>();
    
    <span class="hljs-comment">// 构建 JSON</span>
    QJsonObject jobj;
    jobj[<span class="hljs-string">"cmd"</span>] = <span class="hljs-string">"set_threshold"</span>;
    jobj[<span class="hljs-string">"temp_max"</span>] = sb_temp_max-&gt;<span class="hljs-built_in">value</span>();
    jobj[<span class="hljs-string">"weight_min"</span>] = sb_weight_min-&gt;<span class="hljs-built_in">value</span>();
    jobj[<span class="hljs-string">"sound_max"</span>] = sb_sound_max-&gt;<span class="hljs-built_in">value</span>();

    <span class="hljs-function">QJsonDocument <span class="hljs-title">doc</span><span class="hljs-params">(jobj)</span></span>;
    QByteArray payload = doc.<span class="hljs-built_in">toJson</span>(QJsonDocument::Compact);

    <span class="hljs-keyword">if</span> (m_client-&gt;<span class="hljs-built_in">publish</span>(topic, payload) == <span class="hljs-number">-1</span>) {
        <span class="hljs-built_in">log</span>(<span class="hljs-string">"指令下发失败"</span>);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">log</span>(<span class="hljs-string">"指令下发成功: "</span> + payload);
    }
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">MainWindow::log</span><span class="hljs-params">(<span class="hljs-type">const</span> QString &amp;msg)</span>
</span>{
    txt_log-&gt;<span class="hljs-built_in">append</span>(QDateTime::<span class="hljs-built_in">currentDateTime</span>().<span class="hljs-built_in">toString</span>(<span class="hljs-string">"HH:mm:ss"</span>) + <span class="hljs-string">" "</span> + msg);
}
</code></pre>
<hr/>
<h4 data-id="heading-72">4. 主程序入口 (main.cpp)</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"mainwindow.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;QApplication&gt;</span></span>

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span>
</span>{
    <span class="hljs-function">QApplication <span class="hljs-title">a</span><span class="hljs-params">(argc, argv)</span></span>;
    MainWindow w;
    w.<span class="hljs-built_in">show</span>();
    <span class="hljs-keyword">return</span> a.<span class="hljs-built_in">exec</span>();
}
</code></pre>
<hr/>
<h4 data-id="heading-73">5. 使用说明与注意事项</h4>
<h5 data-id="heading-74">1. 关于 QtMqtt 模块</h5>
<p>本代码使用了 <code>QMqttClient</code> 类，这是 Qt 官方提供的 MQTT 封装。</p>
<ul>
<li><strong>Qt 5.10+ / Qt 6+</strong>：需要手动编译 <code>qtmqtt</code> 库。</li>
<li><strong>Linux (Ubuntu)</strong>：可以通过 <code>sudo apt install qt6-mqtt-dev</code> (针对 Qt6) 安装。</li>
<li><strong>如果无法编译 QtMqtt</strong>：需要将代码中的 <code>QMqttClient</code> 替换为第三方的 <code>QMQTT</code> 库（GitHub 上有很多单头文件的库）。</li>
</ul>
<h5 data-id="heading-75">2. 华为云配置</h5>
<p>为了成功连接华为云，需要在上位机软件界面填入正确的鉴权信息。</p>
<ul>
<li><strong>Server</strong>: <code>iot-mqtts.cn-north-4.myhuaweicloud.com</code> (请根据的华为云实际区域填写)。</li>
<li><strong>Client ID</strong>: 格式为 <code>device_id_0_0_timestamp</code>。</li>
<li><strong>Username</strong>: <code>device_id</code>。</li>
<li><strong>Password</strong>: 需要使用 HMAC-SHA256 算法，通过 <code>Device Secret</code> 生成。华为云控制台提供了在线生成工具，或者可以写一个小工具生成后填入。</li>
</ul>
<h5 data-id="heading-76">3. 通信协议对应</h5>
<p>确保 STM32 端上传的 JSON 键名（Key）与 <code>mainwindow.cpp</code> 中解析的键名一致：</p>
<ul>
<li><code>temp_in</code>, <code>humi_in</code></li>
<li><code>temp_out</code>, <code>humi_out</code></li>
<li><code>weight</code></li>
<li><code>light</code></li>
<li><code>sound</code></li>
<li><code>vib</code> (0为正常，1为报警)</li>
</ul>
<h3 data-id="heading-77">4.5 编译Windows上位机</h3>
<p>点击软件左下角的绿色三角形按钮进行编译运行。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3b0e78f536b42dfab959583b969b12e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=KRWeGR%2BxJWiVgLysDctv3aKKY7s%3D" alt="image-20250402144112519" loading="lazy"/></p>
<h3 data-id="heading-78">4.6 配置Android环境</h3>
<p>如果想编译Android手机APP，必须要先自己配置好自己的Android环境。（搭建环境的过程可以自行百度搜索学习）</p>
<p>然后才可以进行下面的步骤。</p>
<h4 data-id="heading-79">【1】选择Android编译器</h4>
<p>选择编译器。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3226f81351c4d09b6f7f3558346c594~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=sFz9RftInzS3JATR5kpWUhSxTf4%3D" alt="image-20240425232651515" loading="lazy"/></p>
<p>切换编译器。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3594ac95bbbd48d3bdb0619bd97b1e67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=096stxttBekMccdPnW3jHUPW8uc%3D" alt="image-20250402144840442" loading="lazy"/></p>
<h4 data-id="heading-80">【2】创建Android配置文件</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46dceb1183a24fdd8b6bbbdaa91f407b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=AxR6jf5oGlW2m8tK%2BHpzE5fT4zA%3D" alt="image-20240117144604025" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1874689b5b74eda941b6fda0aa7a214~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=Ys%2BfaeiCheKg9U%2B2XAKYT7g91%2BA%3D" alt="image-20240117144635052" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d7d845b12a345bdbbc2c632b9b2f4ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=by0hIkeMxvAjZ%2BFs16%2BAXJ5HNuA%3D" alt="image-20240117144652014" loading="lazy"/></p>
<p>创建完成。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/952cb35891814820b8b883a5ff0d97b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=h7ofGMLlQFBFZc1JFarMjEXq5jI%3D" alt="image-20250402144902155" loading="lazy"/></p>
<h4 data-id="heading-81">【3】配置Android图标与名称</h4>
<p>根据自己的需求配置 Android图标与名称。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af7776f4ec1246ae9b697b4724d3dda6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=nmcY3moTNIaf11Q9E9wZlTMtnMQ%3D" alt="image-20250613111054529" loading="lazy"/></p>
<h4 data-id="heading-82">【3】编译Android上位机</h4>
<p>Qt本身是跨平台的，直接选择Android的编译器，就可以将程序编译到Android平台。</p>
<p>然后点击构建。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26035b7e8d5745e88452d4ad319ac1d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=DVTkT5ERe7EPTMrztrZDOuSjGbw%3D" alt="image-20250613111041456" loading="lazy"/></p>
<p>成功之后，在目录下可以看到生成的<code>apk</code>文件，也就是Android手机的安装包，电脑端使用<code>QQ</code>发送给手机QQ,手机登录QQ接收，就能直接安装。</p>
<p>生成的<code>apk</code>的目录在哪里呢？ 编译完成之后，在控制台会输出APK文件的路径。</p>
<p>知道目录在哪里之后，在Windows的文件资源管理器里，找到路径，具体看下图，找到生成的apk文件。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74d4bd3c05cd49ef9502ad88736e5136~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=LxF0ZInZXAyxBQMydxPjNxXGr%2BY%3D" alt="image-20250402145406894" loading="lazy"/></p>
<pre><code class="hljs language-cpp" lang="cpp">File: D:/QtProject/build<span class="hljs-number">-333</span>_QtProject-Android_for_arm64_v8a_Clang_Qt_5_12_6_for_Android_ARM64_v8a-Release/android-build<span class="hljs-comment">//build/outputs/apk/debug/android-build-debug.apk</span>
</code></pre>
<h3 data-id="heading-83">4.7 设备仿真调试</h3>
<p>通过MQTT客户端模拟设备登录华为云服务器。进行设备联调，实现数据上传和下发测试。</p>
<h2 data-id="heading-84">五、STM32代码设计</h2>
<p>当前项目使用的相关软件工具、模块源码已经上传到网盘：<a href="https://link.juejin.cn?target=https%3A%2F%2Fccnr8sukk85n.feishu.cn%2Fwiki%2FQjY8weDYHibqRYkFP2qcA9aGnvb%3Ffrom%3Dfrom_copylink" target="_blank" title="https://ccnr8sukk85n.feishu.cn/wiki/QjY8weDYHibqRYkFP2qcA9aGnvb?from=from_copylink" ref="nofollow noopener noreferrer">ccnr8sukk85n.feishu.cn/wiki/QjY8we…</a></p>
<h3 data-id="heading-85">5.1 硬件连线说明</h3>
<hr/>
<h4 data-id="heading-86">1. I2C 总线设备（OLED 显示屏 + BH1750 光照传感器）</h4>
<p>这两个模块都使用 I2C 通信协议，可以并联挂载在同一个 I2C 总线上（STM32 的 I2C1 接口）。</p>























































<table><thead><tr><th>模块引脚</th><th>STM32 引脚</th><th>说明</th></tr></thead><tbody><tr><td><strong>OLED SCL</strong></td><td><strong>PB6</strong></td><td>I2C1_SCL</td></tr><tr><td><strong>OLED SDA</strong></td><td><strong>PB7</strong></td><td>I2C1_SDA</td></tr><tr><td>OLED VCC</td><td>3.3V</td><td>OLED 供电</td></tr><tr><td>OLED GND</td><td>GND</td><td>共地</td></tr><tr><td><strong>BH1750 SCL</strong></td><td><strong>PB6</strong></td><td>与 OLED 并联</td></tr><tr><td><strong>BH1750 SDA</strong></td><td><strong>PB7</strong></td><td>与 OLED 并联</td></tr><tr><td>BH1750 VCC</td><td>3.3V or 5V</td><td>模块通常兼容</td></tr><tr><td>BH1750 GND</td><td>GND</td><td>共地</td></tr><tr><td>BH1750 ADDR</td><td>GND (或悬空)</td><td>地址选择脚，接地默认地址</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-87">2. 温湿度传感器（内部 &amp; 外部）</h4>
<p>采用单总线协议，分别占用两个普通 GPIO 口。</p>








































<table><thead><tr><th>模块引脚</th><th>STM32 引脚</th><th>说明</th></tr></thead><tbody><tr><td><strong>DHT11(内) DATA</strong></td><td><strong>PA4</strong></td><td>内部温湿度数据脚</td></tr><tr><td>DHT11(内) VCC</td><td>3.3V or 5V</td><td>建议 3.3V 以匹配逻辑电平</td></tr><tr><td>DHT11(内) GND</td><td>GND</td><td>共地</td></tr><tr><td><strong>DHT11(外) DATA</strong></td><td><strong>PA5</strong></td><td>外部温湿度数据脚</td></tr><tr><td>DHT11(外) VCC</td><td>3.3V or 5V</td><td/></tr><tr><td>DHT11(外) GND</td><td>GND</td><td/></tr></tbody></table>
<p><em>注意：DHT11 的 DATA 引脚通常需要接一个 4.7kΩ - 10kΩ 的上拉电阻到 VCC（很多成品模块已内置）。</em></p>
<hr/>
<h4 data-id="heading-88">3. 重量监测模块（HX711 + 称重传感器）</h4>
<p>HX711 是高精度 ADC，使用自定义的串行协议。</p>






























<table><thead><tr><th>模块引脚</th><th>STM32 引脚</th><th>说明</th></tr></thead><tbody><tr><td><strong>HX711 DT (Data)</strong></td><td><strong>PA6</strong></td><td>数据引脚</td></tr><tr><td><strong>HX711 SCK (Clock)</strong></td><td><strong>PA7</strong></td><td>时钟引脚</td></tr><tr><td>HX711 VCC</td><td>5V</td><td>建议接 5V 以提供更稳定的传感器激励电压</td></tr><tr><td>HX711 GND</td><td>GND</td><td>共地</td></tr></tbody></table>
<p><em>接线说明：称重传感器的 E+/E-/A+/A- 请严格按照传感器线色连接到 HX711 模块对应端口。</em></p>
<hr/>
<h4 data-id="heading-89">4. 声音采集模块（MAX9814）</h4>
<p>输出模拟电压信号，需要连接 STM32 的 ADC 引脚。</p>






























<table><thead><tr><th>模块引脚</th><th>STM32 引脚</th><th>说明</th></tr></thead><tbody><tr><td><strong>MAX9814 OUT</strong></td><td><strong>PA1</strong></td><td>连接 ADC1_IN1</td></tr><tr><td>MAX9814 VCC</td><td>3.3V or 5V</td><td/></tr><tr><td>MAX9814 GND</td><td>GND</td><td/></tr><tr><td>MAX9814 GAIN</td><td>(可选)</td><td>增益设置，悬空默认 60dB，或接 VCC/GND 调整</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-90">5. 震动监测模块（SW420）</h4>
<p>通常输出数字开关量（0 或 1），连接普通 GPIO 即可。</p>

























<table><thead><tr><th>模块引脚</th><th>STM32 引脚</th><th>说明</th></tr></thead><tbody><tr><td><strong>SW420 DO</strong></td><td><strong>PB0</strong></td><td>数字输出引脚 (Digital Out)</td></tr><tr><td>SW420 VCC</td><td>3.3V or 5V</td><td/></tr><tr><td>SW420 GND</td><td>GND</td><td/></tr></tbody></table>
<hr/>
<h4 data-id="heading-91">6. 通信模块（二选一：Air780E 或 ESP8266）</h4>
<p>使用串口 (USART2) 进行通信。<strong>注意 TX 和 RX 要交叉连接。</strong></p>
<h5 data-id="heading-92">方案 A: Air780E (4G Cat.1)</h5>






























<table><thead><tr><th>模块引脚</th><th>STM32 引脚</th><th>说明</th></tr></thead><tbody><tr><td><strong>Air780 TX</strong></td><td><strong>PA3</strong></td><td>STM32 的 RX2</td></tr><tr><td><strong>Air780 RX</strong></td><td><strong>PA2</strong></td><td>STM32 的 TX2</td></tr><tr><td>Air780 VCC</td><td>5V / VBAT</td><td>4G 模块电流大，建议直接由电源模块供电，不要从 STM32 取电</td></tr><tr><td>Air780 GND</td><td>GND</td><td><strong>务必共地</strong></td></tr></tbody></table>
<h5 data-id="heading-93">方案 B: ESP8266-01S (Wi-Fi)</h5>



































<table><thead><tr><th>模块引脚</th><th>STM32 引脚</th><th>说明</th></tr></thead><tbody><tr><td><strong>ESP8266 TX</strong></td><td><strong>PA3</strong></td><td>STM32 的 RX2</td></tr><tr><td><strong>ESP8266 RX</strong></td><td><strong>PA2</strong></td><td>STM32 的 TX2</td></tr><tr><td>ESP8266 3V3</td><td>3.3V</td><td><strong>严禁接 5V，会烧毁</strong></td></tr><tr><td>ESP8266 EN</td><td>3.3V</td><td>使能脚，必须接高电平</td></tr><tr><td>ESP8266 GND</td><td>GND</td><td>共地</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-94">7. 电源管理模块</h4>
<p>系统供电是稳定的关键。</p>
<ul>
<li><strong>18650 锂电池</strong> 输出 (3.7V - 4.2V) 连接到 <strong>AMS1117-3.3</strong> 和 <strong>AMS1117-5.0</strong> 输入端（或者使用升压/降压模块）。</li>
<li><strong>STM32 供电</strong>：将稳压后的 3.3V 接到 STM32 的 3.3V 引脚，GND 接 GND。</li>
<li><strong>5V 总线</strong>：用于给 HX711、Air780E 供电。</li>
<li><strong>3.3V 总线</strong>：用于给 STM32、OLED、DHT11、ESP8266 供电。</li>
</ul>
<h4 data-id="heading-95">总结引脚分配表</h4>

































































<table><thead><tr><th>STM32 引脚</th><th>功能分配</th><th>备注</th></tr></thead><tbody><tr><td><strong>PA1</strong></td><td>MAX9814 (ADC)</td><td>声音采集</td></tr><tr><td><strong>PA2</strong></td><td>USART2_TX</td><td>连接通信模块 RX</td></tr><tr><td><strong>PA3</strong></td><td>USART2_RX</td><td>连接通信模块 TX</td></tr><tr><td><strong>PA4</strong></td><td>GPIO</td><td>DHT11 (内部)</td></tr><tr><td><strong>PA5</strong></td><td>GPIO</td><td>DHT11 (外部)</td></tr><tr><td><strong>PA6</strong></td><td>GPIO</td><td>HX711_DT (数据)</td></tr><tr><td><strong>PA7</strong></td><td>GPIO</td><td>HX711_SCK (时钟)</td></tr><tr><td><strong>PB0</strong></td><td>GPIO</td><td>SW420 (震动)</td></tr><tr><td><strong>PB6</strong></td><td>I2C1_SCL</td><td>OLED &amp; BH1750</td></tr><tr><td><strong>PB7</strong></td><td>I2C1_SDA</td><td>OLED &amp; BH1750</td></tr><tr><td><strong>PA9/PA10</strong></td><td>USART1</td><td>用于程序下载调试 (ST-Link 或 串口下载)</td></tr></tbody></table>
<h3 data-id="heading-96">5.2 传感器代码</h3>
<p>这是一个基于 <strong>STM32F103C8T6</strong> 的完整底层驱动代码集合。为了满足“寄存器方式，不采用库”的要求，代码直接操作寄存器（如 <code>GPIOA-&gt;CRL</code>、<code>RCC-&gt;APB2ENR</code> 等）。</p>
<p>为了方便你直接使用，我将代码组织为几个核心部分。你可以将这些代码分别保存为 <code>.c</code> 和 <code>.h</code> 文件，或者整合到一个 <code>main.c</code> 中（虽然不建议这样做，但为了展示方便，下面按功能模块列出）。</p>
<p><strong>前提条件</strong>：</p>
<ol>
<li>开发环境需包含 CMSIS 核心头文件 <code>stm32f10x.h</code>（这是所有 STM32 开发的基础，定义了寄存器结构体）。</li>
<li>系统时钟默认配置为 72MHz。</li>
</ol>
<hr/>
<h4 data-id="heading-97">1. 基础延时与系统配置 (System)</h4>
<p><strong>核心功能</strong>：提供微秒级延时（DHT11必须）和毫秒级延时。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// system.c</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"stm32f10x.h"</span></span>

<span class="hljs-comment">// 系统时钟初始化 (72MHz) - 通常启动文件已处理，这里确保外设时钟开启</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">System_Init_Config</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
    <span class="hljs-comment">// 开启 GPIOA, GPIOB, AFIO, USART1, USART2, ADC1 时钟</span>
    RCC-&gt;APB2ENR |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">2</span>) | (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">3</span>) | (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">0</span>) | (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">14</span>) | (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">9</span>); 
    RCC-&gt;APB1ENR |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">17</span>); <span class="hljs-comment">// 开启 USART2 时钟</span>
}

<span class="hljs-comment">// 简单的 SysTick 延时函数 (72MHz)</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">Delay_us</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> us)</span> {
    SysTick-&gt;LOAD = <span class="hljs-number">72</span> * us;         <span class="hljs-comment">// 装载计数值</span>
    SysTick-&gt;VAL = <span class="hljs-number">0x00</span>;             <span class="hljs-comment">// 清空计数器</span>
    SysTick-&gt;CTRL = <span class="hljs-number">0x00000005</span>;      <span class="hljs-comment">// 使能，源时钟AHB</span>
    <span class="hljs-keyword">while</span>(!(SysTick-&gt;CTRL &amp; <span class="hljs-number">0x00010000</span>)); <span class="hljs-comment">// 等待计数归零</span>
    SysTick-&gt;CTRL = <span class="hljs-number">0x00000004</span>;      <span class="hljs-comment">// 关闭定时器</span>
}

<span class="hljs-type">void</span> <span class="hljs-title function_">Delay_ms</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> ms)</span> {
    <span class="hljs-keyword">while</span>(ms--) {
        Delay_us(<span class="hljs-number">1000</span>);
    }
}
</code></pre>
<hr/>
<h4 data-id="heading-98">2. GPIO 工具函数 (GPIO Utils)</h4>
<p>由于寄存器操作配置 GPIO 模式比较繁琐，定义两个辅助函数用于 DHT11 等需要频繁切换输入/输出的引脚。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 模式定义: 0=Input, 1=Output_PP_50MHz</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">GPIO_SetMode</span><span class="hljs-params">(GPIO_TypeDef* GPIOx, <span class="hljs-type">uint8_t</span> Pin, <span class="hljs-type">uint8_t</span> Mode)</span> {
    <span class="hljs-type">uint32_t</span> *cr_reg;
    <span class="hljs-type">uint8_t</span> shift;
    
    <span class="hljs-keyword">if</span> (Pin &lt; <span class="hljs-number">8</span>) {
        cr_reg = &amp;GPIOx-&gt;CRL;
        shift = Pin * <span class="hljs-number">4</span>;
    } <span class="hljs-keyword">else</span> {
        cr_reg = &amp;GPIOx-&gt;CRH;
        shift = (Pin - <span class="hljs-number">8</span>) * <span class="hljs-number">4</span>;
    }

    *cr_reg &amp;= ~(<span class="hljs-number">0xF</span> &lt;&lt; shift); <span class="hljs-comment">// 清除原有配置</span>
    
    <span class="hljs-keyword">if</span> (Mode == <span class="hljs-number">1</span>) { <span class="hljs-comment">// Output Push-Pull 50MHz</span>
        *cr_reg |= (<span class="hljs-number">0x3</span> &lt;&lt; shift); 
    } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// Input Pull-Up/Down (需配合ODR设置电平)</span>
        *cr_reg |= (<span class="hljs-number">0x8</span> &lt;&lt; shift); 
    }
}
</code></pre>
<hr/>
<h4 data-id="heading-99">3. DHT11 温湿度传感器驱动</h4>
<p><strong>硬件连接</strong>：PA4 (内部), PA5 (外部)</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 读取 DHT11 数据</span>
<span class="hljs-comment">// GPIOx: GPIOA, Pin: 4 or 5</span>
<span class="hljs-comment">// 返回值: 0-成功, 1-失败</span>
<span class="hljs-type">uint8_t</span> <span class="hljs-title function_">DHT11_Read_Data</span><span class="hljs-params">(GPIO_TypeDef* GPIOx, <span class="hljs-type">uint8_t</span> Pin, <span class="hljs-type">uint8_t</span> *temp, <span class="hljs-type">uint8_t</span> *humi)</span> {
    <span class="hljs-type">uint8_t</span> buf[<span class="hljs-number">5</span>];
    <span class="hljs-type">uint8_t</span> i, j;
    
    <span class="hljs-comment">// 1. 主机发送开始信号</span>
    GPIO_SetMode(GPIOx, Pin, <span class="hljs-number">1</span>); <span class="hljs-comment">// 输出模式</span>
    GPIOx-&gt;BRR = (<span class="hljs-number">1</span> &lt;&lt; Pin);     <span class="hljs-comment">// 拉低</span>
    Delay_ms(<span class="hljs-number">20</span>);                <span class="hljs-comment">// 保持至少18ms</span>
    GPIOx-&gt;BSRR = (<span class="hljs-number">1</span> &lt;&lt; Pin);    <span class="hljs-comment">// 拉高</span>
    Delay_us(<span class="hljs-number">30</span>);
    
    <span class="hljs-comment">// 2. 切换为输入，等待响应</span>
    GPIO_SetMode(GPIOx, Pin, <span class="hljs-number">0</span>); <span class="hljs-comment">// 输入模式</span>
    
    <span class="hljs-comment">// 检测响应信号（低电平80us -&gt; 高电平80us）</span>
    <span class="hljs-keyword">if</span> (!(GPIOx-&gt;IDR &amp; (<span class="hljs-number">1</span> &lt;&lt; Pin))) {
        <span class="hljs-keyword">while</span>(!(GPIOx-&gt;IDR &amp; (<span class="hljs-number">1</span> &lt;&lt; Pin))); <span class="hljs-comment">// 等待变高</span>
        <span class="hljs-keyword">while</span>(GPIOx-&gt;IDR &amp; (<span class="hljs-number">1</span> &lt;&lt; Pin));    <span class="hljs-comment">// 等待变低</span>
        
        <span class="hljs-comment">// 3. 开始接收 40bit 数据</span>
        <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
            buf[i] = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">for</span>(j = <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">8</span>; j++) {
                <span class="hljs-keyword">while</span>(!(GPIOx-&gt;IDR &amp; (<span class="hljs-number">1</span> &lt;&lt; Pin))); <span class="hljs-comment">// 等待变为高电平（开始传输位）</span>
                Delay_us(<span class="hljs-number">40</span>); <span class="hljs-comment">// 延时40us判断是0还是1</span>
                
                <span class="hljs-keyword">if</span>(GPIOx-&gt;IDR &amp; (<span class="hljs-number">1</span> &lt;&lt; Pin)) { <span class="hljs-comment">// 如果还在高电平，则是1</span>
                    buf[i] |= (<span class="hljs-number">1</span> &lt;&lt; (<span class="hljs-number">7</span> - j));
                    <span class="hljs-keyword">while</span>(GPIOx-&gt;IDR &amp; (<span class="hljs-number">1</span> &lt;&lt; Pin)); <span class="hljs-comment">// 等待变为低电平</span>
                }
            }
        }
        
        <span class="hljs-comment">// 4. 校验</span>
        <span class="hljs-keyword">if</span>((buf[<span class="hljs-number">0</span>] + buf[<span class="hljs-number">1</span>] + buf[<span class="hljs-number">2</span>] + buf[<span class="hljs-number">3</span>]) == buf[<span class="hljs-number">4</span>]) {
            *humi = buf[<span class="hljs-number">0</span>];
            *temp = buf[<span class="hljs-number">2</span>];
            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;
}
</code></pre>
<hr/>
<h4 data-id="heading-100">4. HX711 重量传感器驱动</h4>
<p><strong>硬件连接</strong>：DT=PA6, SCK=PA7</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-title function_">HX711_Read</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> count = <span class="hljs-number">0</span>;
    <span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> i;
    
    <span class="hljs-comment">// PA6 Input, PA7 Output (在初始化中配置好)</span>
    <span class="hljs-comment">// DT=PA6, SCK=PA7</span>
    
    GPIOA-&gt;BRR = (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">7</span>); <span class="hljs-comment">// SCK = 0</span>
    
    <span class="hljs-comment">// 等待 DT 变低，表示转换完成</span>
    <span class="hljs-keyword">while</span>(GPIOA-&gt;IDR &amp; (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">6</span>)); 
    
    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">24</span>; i++) {
        GPIOA-&gt;BSRR = (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">7</span>); <span class="hljs-comment">// SCK = 1</span>
        Delay_us(<span class="hljs-number">1</span>);
        count = count &lt;&lt; <span class="hljs-number">1</span>;
        GPIOA-&gt;BRR = (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">7</span>);  <span class="hljs-comment">// SCK = 0</span>
        Delay_us(<span class="hljs-number">1</span>);
        <span class="hljs-keyword">if</span>(GPIOA-&gt;IDR &amp; (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">6</span>)) count++;
    }
    
    <span class="hljs-comment">// 第25个脉冲，设置增益 128</span>
    GPIOA-&gt;BSRR = (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">7</span>); 
    Delay_us(<span class="hljs-number">1</span>);
    GPIOA-&gt;BRR = (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">7</span>); 
    Delay_us(<span class="hljs-number">1</span>);
    
    <span class="hljs-keyword">return</span> count ^ <span class="hljs-number">0x800000</span>; <span class="hljs-comment">// 转换符号位</span>
}

<span class="hljs-comment">// 初始化 GPIO</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">HX711_Init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
    <span class="hljs-comment">// PA6 Input (Floating/PU), PA7 Output</span>
    GPIO_SetMode(GPIOA, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>);
    GPIOA-&gt;ODR |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">6</span>); <span class="hljs-comment">// Pull Up</span>
    GPIO_SetMode(GPIOA, <span class="hljs-number">7</span>, <span class="hljs-number">1</span>);
}
</code></pre>
<hr/>
<h4 data-id="heading-101">5. 软件 I2C 驱动 (OLED &amp; BH1750)</h4>
<p><strong>硬件连接</strong>：SCL=PB6, SDA=PB7</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> SCL_H GPIOB-&gt;BSRR = (1 &lt;&lt; 6)</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SCL_L GPIOB-&gt;BRR  = (1 &lt;&lt; 6)</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SDA_H GPIOB-&gt;BSRR = (1 &lt;&lt; 7)</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> SDA_L GPIOB-&gt;BRR  = (1 &lt;&lt; 7)</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> READ_SDA (GPIOB-&gt;IDR &amp; (1 &lt;&lt; 7))</span>

<span class="hljs-type">void</span> <span class="hljs-title function_">I2C_GPIO_Config</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
    <span class="hljs-comment">// 配置 PB6, PB7 为开漏输出 (Open-Drain, 50MHz)</span>
    <span class="hljs-comment">// CNF=01, MODE=11 -&gt; 0x7</span>
    GPIOB-&gt;CRL &amp;= <span class="hljs-number">0x00FFFFFF</span>; 
    GPIOB-&gt;CRL |= <span class="hljs-number">0x77000000</span>; 
    SCL_H; SDA_H;
}

<span class="hljs-type">void</span> <span class="hljs-title function_">I2C_Start</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
    SDA_H; SCL_H; Delay_us(<span class="hljs-number">4</span>);
    SDA_L; Delay_us(<span class="hljs-number">4</span>);
    SCL_L;
}

<span class="hljs-type">void</span> <span class="hljs-title function_">I2C_Stop</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
    SCL_L; SDA_L; Delay_us(<span class="hljs-number">4</span>);
    SCL_H; SDA_H; Delay_us(<span class="hljs-number">4</span>);
}

<span class="hljs-type">void</span> <span class="hljs-title function_">I2C_SendByte</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> Byte)</span> {
    <span class="hljs-type">uint8_t</span> i;
    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++) {
        <span class="hljs-keyword">if</span>(Byte &amp; <span class="hljs-number">0x80</span>) SDA_H; <span class="hljs-keyword">else</span> SDA_L;
        Byte &lt;&lt;= <span class="hljs-number">1</span>;
        Delay_us(<span class="hljs-number">2</span>);
        SCL_H; Delay_us(<span class="hljs-number">2</span>);
        SCL_L; Delay_us(<span class="hljs-number">2</span>);
    }
    <span class="hljs-comment">// 等待 ACK (简单处理，忽略返回值)</span>
    SDA_H; SCL_H; Delay_us(<span class="hljs-number">2</span>); SCL_L;
}

<span class="hljs-type">uint8_t</span> <span class="hljs-title function_">I2C_ReadByte</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
    <span class="hljs-type">uint8_t</span> i, val = <span class="hljs-number">0</span>;
    SDA_H; <span class="hljs-comment">// 释放总线</span>
    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">8</span>; i++) {
        val &lt;&lt;= <span class="hljs-number">1</span>;
        SCL_H; Delay_us(<span class="hljs-number">2</span>);
        <span class="hljs-keyword">if</span>(READ_SDA) val++;
        SCL_L; Delay_us(<span class="hljs-number">2</span>);
    }
    <span class="hljs-comment">// 发送 NoACK (最后一位)</span>
    SDA_H; SCL_H; Delay_us(<span class="hljs-number">2</span>); SCL_L;
    <span class="hljs-keyword">return</span> val;
}
</code></pre>
<hr/>
<h4 data-id="heading-102">6. BH1750 光照传感器驱动</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> BH1750_ADDR 0x46 <span class="hljs-comment">// ADDR接地时地址</span></span>

<span class="hljs-type">void</span> <span class="hljs-title function_">BH1750_Init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
    I2C_Start();
    I2C_SendByte(BH1750_ADDR);
    I2C_SendByte(<span class="hljs-number">0x01</span>); <span class="hljs-comment">// Power On</span>
    I2C_Stop();
}

<span class="hljs-type">void</span> <span class="hljs-title function_">BH1750_Start</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
    I2C_Start();
    I2C_SendByte(BH1750_ADDR);
    I2C_SendByte(<span class="hljs-number">0x10</span>); <span class="hljs-comment">// H-Resolution Mode</span>
    I2C_Stop();
}

<span class="hljs-type">uint16_t</span> <span class="hljs-title function_">BH1750_Read</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
    <span class="hljs-type">uint16_t</span> data;
    I2C_Start();
    I2C_SendByte(BH1750_ADDR | <span class="hljs-number">1</span>); <span class="hljs-comment">// Read mode</span>
    data = I2C_ReadByte();
    data = (data &lt;&lt; <span class="hljs-number">8</span>) + I2C_ReadByte();
    I2C_Stop();
    <span class="hljs-keyword">return</span> data; <span class="hljs-comment">// 单位 Lux</span>
}
</code></pre>
<hr/>
<h4 data-id="heading-103">7. MAX9814 (ADC) 驱动</h4>
<p><strong>硬件连接</strong>：PA1 (ADC1_IN1)</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">ADC_Config</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
    <span class="hljs-comment">// PA1 模拟输入模式 (CNF=00, MODE=00)</span>
    GPIOA-&gt;CRL &amp;= <span class="hljs-number">0xFFFFFF0F</span>;
    
    <span class="hljs-comment">// ADC1 时钟预分频 (Max 14MHz, PCLK2=72M, DIV6=12M)</span>
    RCC-&gt;CFGR |= (<span class="hljs-number">2</span> &lt;&lt; <span class="hljs-number">14</span>); 
    
    <span class="hljs-comment">// 复位 ADC</span>
    ADC1-&gt;CR2 |= (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">3</span>);
    <span class="hljs-keyword">while</span>(ADC1-&gt;CR2 &amp; (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">3</span>));
    
    <span class="hljs-comment">// 校准 ADC</span>
    ADC1-&gt;CR2 |= (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">2</span>);
    <span class="hljs-keyword">while</span>(ADC1-&gt;CR2 &amp; (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">2</span>));
    
    <span class="hljs-comment">// 配置规则组: 序列1 为 通道1</span>
    ADC1-&gt;SQR3 = <span class="hljs-number">1</span>; 
    
    <span class="hljs-comment">// 开启 ADC</span>
    ADC1-&gt;CR2 |= <span class="hljs-number">1</span>; 
}

<span class="hljs-type">uint16_t</span> <span class="hljs-title function_">Get_Sound_Level</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
    ADC1-&gt;CR2 |= <span class="hljs-number">1</span>; <span class="hljs-comment">// 再次置位启动转换</span>
    <span class="hljs-keyword">while</span>(!(ADC1-&gt;SR &amp; (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">1</span>))); <span class="hljs-comment">// 等待 EOC</span>
    <span class="hljs-keyword">return</span> ADC1-&gt;DR;
}
</code></pre>
<hr/>
<h4 data-id="heading-104">8. USART2 通信驱动 (连接 Air780E/ESP8266)</h4>
<p><strong>硬件连接</strong>：PA2 (TX), PA3 (RX)</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> <span class="hljs-title function_">USART2_Config</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> baud)</span> {
    <span class="hljs-comment">// PA2 (TX): AF_PP (1011 -&gt; 0xB)</span>
    GPIOA-&gt;CRL &amp;= <span class="hljs-number">0xFFFF00FF</span>;
    GPIOA-&gt;CRL |= <span class="hljs-number">0x00004B00</span>; <span class="hljs-comment">// PA2=AF_PP, PA3=Input Floating(0x4)</span>
    
    <span class="hljs-comment">// 波特率计算 (PCLK1 = 36MHz)</span>
    <span class="hljs-comment">// USARTDIV = 36000000 / 115200 = 312.5</span>
    <span class="hljs-comment">// Mantissa = 312 (0x138), Fraction = 0.5*16 = 8</span>
    <span class="hljs-comment">// BRR = 0x1388</span>
    <span class="hljs-type">float</span> div = <span class="hljs-number">36000000.0</span> / baud;
    <span class="hljs-type">uint16_t</span> mantissa = (<span class="hljs-type">uint16_t</span>)div;
    <span class="hljs-type">uint16_t</span> fraction = (<span class="hljs-type">uint16_t</span>)((div - mantissa) * <span class="hljs-number">16</span>);
    USART2-&gt;BRR = (mantissa &lt;&lt; <span class="hljs-number">4</span>) + fraction;
    
    <span class="hljs-comment">// 使能 UE, TE, RE, RXNE中断</span>
    USART2-&gt;CR1 = (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">13</span>) | (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">3</span>) | (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">2</span>) | (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">5</span>); 
    
    <span class="hljs-comment">// 配置 NVIC</span>
    NVIC_EnableIRQ(USART2_IRQn);
}

<span class="hljs-type">void</span> <span class="hljs-title function_">USART2_SendChar</span><span class="hljs-params">(<span class="hljs-type">char</span> ch)</span> {
    <span class="hljs-keyword">while</span>(!(USART2-&gt;SR &amp; (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">7</span>))); <span class="hljs-comment">// 等待 TXE</span>
    USART2-&gt;DR = ch;
}

<span class="hljs-type">void</span> <span class="hljs-title function_">USART2_SendString</span><span class="hljs-params">(<span class="hljs-type">char</span> *str)</span> {
    <span class="hljs-keyword">while</span>(*str) {
        USART2_SendChar(*str++);
    }
}

<span class="hljs-comment">// 中断接收处理</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">USART2_IRQHandler</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
    <span class="hljs-keyword">if</span>(USART2-&gt;SR &amp; (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">5</span>)) { <span class="hljs-comment">// RXNE</span>
        <span class="hljs-type">uint8_t</span> data = USART2-&gt;DR;
        <span class="hljs-comment">// 在这里处理接收到的 MQTT 数据</span>
    }
}
</code></pre>
<hr/>
<h4 data-id="heading-105">9. OLED 驱动 (简化版)</h4>
<p><strong>硬件连接</strong>：同 I2C</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> OLED_ADDR 0x78 </span>

<span class="hljs-type">void</span> <span class="hljs-title function_">OLED_WriteCmd</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> cmd)</span> {
    I2C_Start();
    I2C_SendByte(OLED_ADDR);
    I2C_SendByte(<span class="hljs-number">0x00</span>); <span class="hljs-comment">// Co=0, D/C#=0</span>
    I2C_SendByte(cmd);
    I2C_Stop();
}

<span class="hljs-type">void</span> <span class="hljs-title function_">OLED_WriteData</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> data)</span> {
    I2C_Start();
    I2C_SendByte(OLED_ADDR);
    I2C_SendByte(<span class="hljs-number">0x40</span>); <span class="hljs-comment">// Co=0, D/C#=1</span>
    I2C_SendByte(data);
    I2C_Stop();
}

<span class="hljs-type">void</span> <span class="hljs-title function_">OLED_Init</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
    Delay_ms(<span class="hljs-number">100</span>);
    <span class="hljs-comment">// 常用初始化序列</span>
    OLED_WriteCmd(<span class="hljs-number">0xAE</span>); <span class="hljs-comment">// Display Off</span>
    OLED_WriteCmd(<span class="hljs-number">0x20</span>); OLED_WriteCmd(<span class="hljs-number">0x02</span>); <span class="hljs-comment">// Set Memory Addressing Mode</span>
    OLED_WriteCmd(<span class="hljs-number">0xB0</span>); <span class="hljs-comment">// Set Page Start Address</span>
    OLED_WriteCmd(<span class="hljs-number">0xC8</span>); <span class="hljs-comment">// Set COM Output Scan Direction</span>
    OLED_WriteCmd(<span class="hljs-number">0x00</span>); <span class="hljs-comment">// Set Low Column Address</span>
    OLED_WriteCmd(<span class="hljs-number">0x10</span>); <span class="hljs-comment">// Set High Column Address</span>
    OLED_WriteCmd(<span class="hljs-number">0x40</span>); <span class="hljs-comment">// Set Start Line Address</span>
    OLED_WriteCmd(<span class="hljs-number">0x81</span>); OLED_WriteCmd(<span class="hljs-number">0xCF</span>); <span class="hljs-comment">// Contrast</span>
    OLED_WriteCmd(<span class="hljs-number">0xA1</span>); <span class="hljs-comment">// Set Segment Re-map</span>
    OLED_WriteCmd(<span class="hljs-number">0xA6</span>); <span class="hljs-comment">// Normal Display</span>
    OLED_WriteCmd(<span class="hljs-number">0xA8</span>); OLED_WriteCmd(<span class="hljs-number">0x3F</span>); <span class="hljs-comment">// Multiplex Ratio</span>
    OLED_WriteCmd(<span class="hljs-number">0xAF</span>); <span class="hljs-comment">// Display On</span>
}

<span class="hljs-comment">// 清屏</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">OLED_Clear</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
    <span class="hljs-type">uint8_t</span> i, n;
    <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">8</span>;i++) {
        OLED_WriteCmd(<span class="hljs-number">0xB0</span> + i);
        OLED_WriteCmd(<span class="hljs-number">0x00</span>);
        OLED_WriteCmd(<span class="hljs-number">0x10</span>);
        <span class="hljs-keyword">for</span>(n=<span class="hljs-number">0</span>;n&lt;<span class="hljs-number">128</span>;n++) OLED_WriteData(<span class="hljs-number">0x00</span>);
    }
}
</code></pre>
<h3 data-id="heading-106">5.3 项目核心代码</h3>
<h4 data-id="heading-107">10. 主函数 (Main Loop)</h4>
<p>这是如何调度上述驱动的示例。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// main.c 示例</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> {
    <span class="hljs-type">uint8_t</span> t_in, h_in, t_out, h_out;
    <span class="hljs-type">uint16_t</span> light, sound;
    <span class="hljs-type">long</span> weight;
    <span class="hljs-type">char</span> buffer[<span class="hljs-number">128</span>];

    System_Init_Config();
    I2C_GPIO_Config();
    ADC_Config();
    HX711_Init();
    USART2_Config(<span class="hljs-number">115200</span>); <span class="hljs-comment">// 连接 4G/Wifi</span>
    
    OLED_Init();
    OLED_Clear();
    BH1750_Init();
    
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>) {
        <span class="hljs-comment">// 1. 采集数据</span>
        DHT11_Read_Data(GPIOA, <span class="hljs-number">4</span>, &amp;t_in, &amp;h_in);
        DHT11_Read_Data(GPIOA, <span class="hljs-number">5</span>, &amp;t_out, &amp;h_out);
        light = BH1750_Read();
        weight = HX711_Read() / <span class="hljs-number">100</span>; <span class="hljs-comment">// 简单比例换算，实际需校准公式</span>
        sound = Get_Sound_Level();
        
        <span class="hljs-comment">// 2. 处理震动 (PB0)</span>
        <span class="hljs-type">uint8_t</span> vib = (GPIOB-&gt;IDR &amp; <span class="hljs-number">1</span>);
        
        <span class="hljs-comment">// 3. 格式化为 JSON 字符串 (需自行实现 sprintf 或引用 stdio.h)</span>
        <span class="hljs-comment">// {"temp_in":25,"weight":1000...}</span>
        <span class="hljs-comment">// sprintf(buffer, "{\"temp_in\":%d, \"humi_in\":%d, \"weight\":%ld}\r\n", t_in, h_in, weight);</span>
        
        <span class="hljs-comment">// 4. 通过串口发送给通信模块</span>
        <span class="hljs-comment">// USART2_SendString(buffer);</span>
        
        <span class="hljs-comment">// 5. OLED 显示 (需配合字库)</span>
        
        Delay_ms(<span class="hljs-number">1000</span>); <span class="hljs-comment">// 1秒采集一次</span>
    }
}
</code></pre>
<ol>
<li><strong>头文件包含</strong>：所有 <code>.c</code> 文件都需要 <code>#include "stm32f10x.h"</code>。</li>
<li><strong>中断处理</strong>：如果使用 USART 中断，请确保在启动代码（<code>.s</code> 文件）中没有注释掉 <code>USART2_IRQHandler</code>，或者你自己定义了它。</li>
<li><strong>HX711 校准</strong>：代码中返回的是原始 ADC 值，实际使用时需要减去皮重（空载值）并除以系数（Gap Value）才能得到克数。</li>
<li><strong>OLED 字库</strong>：由于篇幅限制，这里没有提供 8x16 的点阵数组（<code>F8X16[]</code>）</li>
</ol>
<h3 data-id="heading-108">5.4 程序下载</h3>
<p><strong>也有视频教程：</strong></p>
<p>讲解如何编译代码，下载STM32程序: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1Cw4m1e7Yc" target="_blank" title="https://www.bilibili.com/video/BV1Cw4m1e7Yc" ref="nofollow noopener noreferrer">www.bilibili.com/video/BV1Cw…</a></p>
<p>打STM32的keil工程，编译代码、然后，使用USB线将开发板的左边的USB口(串口1)与电脑的USB连接，打开程序下载软件下载程序。</p>
<p>具体下载过程看下面图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ddf50cd0f9aa4dd48af9dc490902ef94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=kDI3oWqNCDfGW699cZMcde%2FsLYk%3D" alt="image-20240319223247836" loading="lazy"/></p>
<p>打开程序下载软件：[软件就在资料包里的软件工具目录下]</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3570c4edcc9a499c8b2b19e7dc1406d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=XWULc9Z2pINX3oRx0eBS9NrKj4U%3D" alt="image-20240120160735942" loading="lazy"/></p>
<h3 data-id="heading-109">5.5 程序正常运行效果</h3>
<p>设备运行过程中会通过串口打印调试信息，我们可以通过串口打印了解程序是否正常。</p>
<p>程序下载之后，可以打开串口调试助手查看程序运行的状态信息。[软件就在资料包里的软件工具目录下]</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fb0871e416d43b582bae9e23c0043b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=uLw11ofZ1jUkCsTdiUR5R9XRgmY%3D" alt="image-20240327212042050" loading="lazy"/></p>
<h3 data-id="heading-110">5.6 取模软件的使用</h3>
<p>显示屏上会显示中文，字母，数字等数据，可以使用下面的取模软件进行取模设置。</p>
<p>[软件就在资料包里的软件工具目录下]</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/264aabedda2147ef8fba0c30f4176a2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=HQlUWF1XZinMvATYKRTTkm3SOtk%3D" alt="image-20241024142522970" loading="lazy"/></p>
<p><strong>打开软件之后：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5e5e576eb4540fe83923f667a1ad34b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRFPlsI_pvpnlk6U=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765357411&amp;x-signature=Yv8DAfaDTMF970qyE6yENpZyFfY%3D" alt="image-20241127212320020" loading="lazy"/></p>
<h2 data-id="heading-111">六、总结</h2>
<p>本项目成功设计并构建了一套基于 STM32 与华为云平台的物联网蜂箱智能监测系统。系统以 STM32F103C8T6 为核心控制单元，有机融合了多维传感器网络（温湿度、重量、声音、震动、光照）、无线通信技术（4G/Wi-Fi）以及 Qt 上位机可视化技术，实现了从数据感知、边缘处理、远程传输到云端交互的完整闭环。</p>
<p>通过本设计，有效解决了传统养蜂业中依赖人工巡查、管理效率低且易干扰蜂群正常生活等核心痛点。系统不仅能够全天候实时监测蜂箱的内外环境与蜂群活力，还能通过重量分析与震动检测功能，对分蜂、蜂蜜满载、天敌入侵等异常情况进行及时预警。这种“非侵入式”的智能管理模式，大幅降低了养蜂人的劳动强度，为蜂群健康繁育和蜂蜜增产提供了科学、客观的数据支撑。总体而言，本系统硬件成本可控、功能实用且运行稳定，充分验证了物联网技术在智慧农业细分领域的应用潜力和实用价值，具有良好的推广前景。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[鸿蒙 ArkUI 从零到精通：基础语法全解析]]></title>    <link>https://juejin.cn/post/7578902814022565903</link>    <guid>https://juejin.cn/post/7578902814022565903</guid>    <pubDate>2025-12-02T07:21:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578902814022565903" data-draft-id="7576573061580537897" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="鸿蒙 ArkUI 从零到精通：基础语法全解析"/> <meta itemprop="keywords" content="前端,HarmonyOS,Android"/> <meta itemprop="datePublished" content="2025-12-02T07:21:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="hqk"/> <meta itemprop="url" content="https://juejin.cn/user/2357827986264942"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            鸿蒙 ArkUI 从零到精通：基础语法全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2357827986264942/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    hqk
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T07:21:01.000Z" title="Tue Dec 02 2025 07:21:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    81
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文参与了<a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F7e230b074eaa41c587c71c1d1a9a6514%3Ftype%3D1%3Fha_source%3Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/7e230b074eaa41c587c71c1d1a9a6514?type=1?ha_source=hmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">华为官方活动：HarmonyOS赋能资源丰富度建设</a></p>
<h2 data-id="heading-0">前言</h2>
<p>在上一篇中，讲解了<a href="https://juejin.cn/post/7576057623742464042" target="_blank" title="https://juejin.cn/post/7576057623742464042">鸿蒙ArkTS基础语法</a> ，本篇将会讲解ArkUI相关的知识点。</p>
<h2 data-id="heading-1">1、ArkUI介绍</h2>
<p>ArkUI：Ability kit在UIAbility组件可以使用ArkUI提供的组件，事件，动效，状态管理等能力。</p>
<p>我们先来看看ArkUI的<strong>基本结构</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e560ee37da674992bb5494d5a118bb90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765353992&amp;x-signature=nU4FDMOuUgaWoUoK8kUB9dGC9Js%3D" alt="QQ_1764139591463.png" loading="lazy"/>
如图所示：</p>
<ul>
<li>
<p>ArkUI基本结构包含：<strong>装饰器</strong>、<strong>自定义组件</strong>、<strong>系统组件</strong>、以及组件内一系列<strong>属性方法与事件方法</strong>等</p>
</li>
<li>
<p>装饰器：用于装饰类、结构、方法以及变量，并赋予对应的含义。如上图所示<code>@Entry</code>、<code>@Component</code>和<code>@State</code>都是装饰器</p>
<ul>
<li><code>@Entry</code>：表示该自定义组件为入口组价</li>
<li><code>@Component</code>：表示自定义组件</li>
<li><code>@State</code>：表示组件中的状态变量，状态变量变化会触发UI刷新</li>
</ul>
</li>
<li>
<p>UI描述：以声明式的方法来描述UI的结构，如上图所示 build()方法中的代码块</p>
</li>
<li>
<p>自定义组件：可复用的UI模块，可组合其他组件，如上图所示被<code>@Component</code>修饰的<code>struct Page4</code></p>
</li>
<li>
<p>属性方法：组件可以通过链式调用对应组件的多项属性方法，如<code>id()</code>、<code>width()</code>、<code>fontSize()</code>等</p>
</li>
<li>
<p>事件方法：组件可以通过链式调用设置多个事件的响应逻辑，如<code>onClick()</code></p>
</li>
</ul>
<p>当我们掌握了 ArkUI 的基本结构后，会发现 <strong>UI的最终呈现其实是由一个个组件拼起来的</strong>。</p>
<p>所以在理解“框架怎么组织 UI”之后，我们下一步就需要弄清楚：“真正构成 UI 的那些组件有哪些？它们各自怎么用？”</p>
<p>因此，下面我们就正式进入ArkUI的组件学习部分，我们将通过一系列小案例由浅入深逐步对ArkUI进行讲解。</p>
<h2 data-id="heading-2">2、ArkUI组件讲解</h2>
<p>ArkUI系统组件又分为：容器组件、基础组件。</p>
<h3 data-id="heading-3">2.1 容器组件</h3>
<p>容器组件顾名思义类似于一个容器一样，可以装下不同的组件。那该如何使用呢？那么就迎来了第一个容器组件<code>Row</code></p>
<h4 data-id="heading-4">2.1.1 Row容器组件</h4>
<p>我们先来看第一个小案例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">@Entry
@Component
struct Index {
  build() {
    Row({space: 20}){
      Text("字符串1").width(100).height(100).backgroundColor(Color.Pink)
      Text("字符串2").width(100).height(100).backgroundColor(Color.Red)
      Text("字符串3").width(100).height(100).backgroundColor(Color.Blue).fontColor(Color.White)
    }
    .width('100%')
    .height('100%')
    .border({color:Color.Red, style: BorderStyle.Dashed, width:1})
    .backgroundColor(Color.Yellow)
    .justifyContent(FlexAlign.SpaceEvenly)
    .alignItems(VerticalAlign.Center)
  }
}
</code></pre>
<p>运行效果图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13275a67886448468d15e47ccd980afc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765353992&amp;x-signature=bVZbHj9JVBoUoZYYPRZprAJKuD8%3D" alt="QQ_1764225287496.png" loading="lazy"/></p>
<p>在这个案例中：</p>
<ul>
<li><code>Row{}</code>里面包含了三个组件，并且这三个组件是水平排列</li>
<li><code>Row{}</code>设置了不同的属性
<ul>
<li><code>{space: 20}</code>表示容器内组件之间的间距为<code>20vp</code>，这个<code>vp</code>就好比<code>Android</code>里面的<code>dp</code>单位</li>
<li><code>.width('100%').height('100%')</code>，表示宽高都是100%，充满整个屏幕</li>
<li><code>border({color:Color.Red, style: BorderStyle.Dashed, width:1})</code>给这个<code>Row</code>组件设置了边框以及边框属性</li>
<li><code>.justifyContent(FlexAlign.SpaceEvenly)</code>给这个<code>Row</code>组件设置了<strong>水平对齐方式，这个属性方法它和这个<code>Row{}</code>组件是同一种对齐方向</strong></li>
<li><code>.alignItems(VerticalAlign.Center)</code>给这个<code>Row</code>组件设置了<strong>垂直对齐方式，这个属性方法它和这个<code>Row{}</code>组件是相反的对齐方向</strong></li>
</ul>
</li>
</ul>
<p>看到这是不是会想：那我咋知道这些组件有哪些方法？然后这些方法又该如何赋值呢？不可能每个组件我都要去死记硬背涩！</p>
<h5 data-id="heading-5">2.1.1.1 源码剖析</h5>
<p>所谓的授人以鱼不如授人以渔！我这将一步一步的带你去剖析源码，就算以后遇到陌生组件也能让你更快的熟悉并使用它！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0c1bd004395473ca6adaa0d889ac683~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765353992&amp;x-signature=4H%2FytptMfQrn%2B1cjoC0vuBe6f6w%3D" alt="QQ_1764227796785.png" loading="lazy"/></p>
<p><strong>如图所示</strong></p>
<p>按住<code>Ctrl</code>+鼠标左键点击<code>Row</code>，你将会看到这样的代码</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">declare</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">Row</span>: RowInterface;
</code></pre>
<p>继续按住<code>Ctrl</code>+鼠标左键点击<code>RowInterface</code>，将会是如下代码：</p>
<pre><code class="hljs language-css" lang="css">interface RowInterface {
    (value?: {
        space?: string | number;
    }): RowAttribute;
}
</code></pre>
<p>这里只看到刚刚 <code>Row({space: 20})</code>这句代码的使用方式</p>
<ul>
<li><code>value? </code> 有<code>?</code>修饰说明了这个value可为空，而这个值的类型是 <code>{space?: string | number;}</code>这样的结构体</li>
<li><code>{space?: string | number;}</code>这样的结构体里面只有<code>space?</code>变量，而且这个变量也有<code>?</code>修饰，说明了这个<code>space</code>也可为空，而这个值类型是<code>string | number</code>，说明了，如果值不为空的话，那么<code>space</code>要么是<code>string</code>要么是 <code>number</code></li>
</ul>
<p>所以在使用<code>Row</code>组件时，构造方法里面可以传<code>{space?: string | number;}</code> 这样的结构体</p>
<p>然而这里没看到想要的属性方法，继续往下看，按住<code>Ctrl</code>+鼠标左键点击<code>RowAttribute</code>，将会是如下代码：</p>
<pre><code class="hljs language-scala" lang="scala">declare <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RowAttribute</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">CommonMethod&lt;RowAttribute&gt;</span> </span>{

 <span class="hljs-comment">//Called when the vertical alignment is set.</span>
 alignItems(value: <span class="hljs-type">VerticalAlign</span>): <span class="hljs-type">RowAttribute</span>;
 
 <span class="hljs-comment">//Called when the horizontal alignment is set.</span>
 justifyContent(value: <span class="hljs-type">FlexAlign</span>): <span class="hljs-type">RowAttribute</span>;

 reverse(isReversed: <span class="hljs-type">Optional</span>&lt;boolean&gt;): <span class="hljs-type">RowAttribute</span>;
 
}
</code></pre>
<p>到这里我们看到<code>Row</code>组件特有的属性<code>alignItems</code>、<code>justifyContent</code>、<code>reverse</code>，对应属性方法的值范围，可以继续按照刚刚的方式往下看</p>
<p>不过在这里面我们就只看到这三个属性方法，上面案例里的<code>width</code>以及其他的属性方法呢？</p>
<p>我们看到<code>class RowAttribute extends CommonMethod&lt;RowAttribute&gt;</code>这句代码，<a href="https://juejin.cn/post/7576057623742464042" target="_blank" title="https://juejin.cn/post/7576057623742464042">在上一篇基础语法中</a>，讲解了这是继承关系，也就是<code>RowAttribute</code>拥有了<code>CommonMethod</code>所有非私有的属性以及方法</p>
<p>那继续按住<code>Ctrl</code>+鼠标左键点击<code>CommonMethod</code>，将会是如下代码：</p>
<pre><code class="hljs language-scss" lang="scss">declare class CommonMethod&lt;T&gt; {
  <span class="hljs-comment">//....省略部分代码</span>
  <span class="hljs-attribute">width</span>(value: Length): T;
  
  <span class="hljs-attribute">height</span>(value: Length): T;
  
  <span class="hljs-attribute">padding</span>(value: Padding | Length | LocalizedPadding): T
  
  <span class="hljs-built_in">background</span>(builder: CustomBuilder, options?: {
    align?: Alignment;
  }): T;
  
  <span class="hljs-attribute">border</span>(value: BorderOptions): T;
  
  <span class="hljs-built_in">backgroundColor</span>(value: ResourceColor): T;
 <span class="hljs-comment">//....省略部分代码</span>

</code></pre>
<p>在这里我们就看到了我们案例上使用的所有属性方法了。这里可以总结出：<strong>组件都有它自己独有的属性，并且非独有（公共）属性通过<code>extends CommonMethod&lt;T&gt;</code> 方式获得</strong></p>
<p>这里我们熟悉了<code>Row</code>组件，继续下一个组件</p>
<h4 data-id="heading-6">2.1.2 Column容器组件</h4>
<p>我们接着来看案例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">@Entry
@Component
struct ColumnPage {
  build() {
    Column({space: 20}){
      Row().width(100).height(100).backgroundColor(Color.Pink)
      Row().width(100).height(100).backgroundColor(Color.Yellow)
      Row().width(100).height(100).backgroundColor(Color.Blue)
      Row().width(100).height(100).backgroundColor(Color.Green)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Gray)
    .justifyContent(FlexAlign.SpaceEvenly)
    .alignItems(HorizontalAlign.End)
  }
}
</code></pre>
<p>运行效果图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1c37862201240e39994c5a5fe5689d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765353992&amp;x-signature=Dyxm3zjv5xldepi0%2BqqutBsPskc%3D" alt="QQ_1764230669769.png" loading="lazy"/></p>
<p>在这个案例中：</p>
<ul>
<li><code>Column{}</code>里面包含了四个组件，并且这四个组件是垂直排列</li>
<li><code>.justifyContent(FlexAlign.SpaceEvenly)</code>给这个<code>Column</code>组件设置了<strong>垂直对齐方式，这个属性方法它和这个<code>Column{}</code>组件是同一种对齐方向</strong></li>
<li><code>.alignItems(HorizontalAlign.End)</code>给这个<code>Column</code>组件设置了<strong>水平对齐方式，这个属性方法它和这个<code>Column{}</code>组件是相反的对齐方向</strong></li>
</ul>
<p>这个<code>Column</code>列组件与<code>Row</code>行组件是相反的，特别注意<code>Column</code>的<code>.alignItems(HorizontalAlign.End)</code>属性方法里面是<code>HorizontalAlign</code>，而<code>Row</code>的<code>.alignItems(VerticalAlign.Center)</code>是<code>VerticalAlign</code>。</p>
<p>OK，我们继续下一个组件！</p>
<h4 data-id="heading-7">2.1.3 Flex容器组件</h4>
<p>Flex（弹性组件）提供更加有效的方式对容器中的子元素进行排列、对齐和分配剩余空间。</p>
<p>容器默认存在主轴与交叉轴，子元素默认沿主轴排列，子元素在主轴方向的尺寸称为主轴尺寸，在交叉轴方向的尺寸称为交叉轴尺寸。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aad9cc84edce4ba69e71cf54f60f51fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765353992&amp;x-signature=vIrfiyASuH2vtI4rc27vCY4upfc%3D" alt="0000000000011111111.20250314163923.55033350674177624945588898470143.png" loading="lazy"/></p>
<p>既然<code>Flex</code>容器可以改变子元素在主轴与交叉轴排列，那么我们就能复刻<code>Row</code>组件以及<code>Column</code>组件</p>
<p>注意：</p>
<ul>
<li>当Flex容器为<code>Row</code>、<code>RowReverse</code>排列时，主轴与交叉轴就为图中所示；</li>
<li>当Flex容器为<code>Column</code>、<code>ColumnReverse</code>排列时，图中的主轴变交叉轴，交叉轴变主轴</li>
</ul>
<h5 data-id="heading-8">2.1.3.1 复刻Row组件</h5>
<pre><code class="hljs language-ArkTS" lang="ArkTS">import { LengthMetrics } from '@kit.ArkUI';

@Entry
@Component
struct FlexiblePage {
  build() {
    Flex({
      direction: FlexDirection.Row,
      justifyContent: FlexAlign.Start,
      alignItems: ItemAlign.Start,
      wrap: FlexWrap.NoWrap,
      space: { main: LengthMetrics.vp(20), cross: LengthMetrics.vp(30) }
    }) {
      Column().width(100).height(200).backgroundColor(Color.Pink)
      Column().width(100).height(200).backgroundColor(Color.Red)
      Column().width(100).height(200).backgroundColor(Color.Blue)

      Column().width(100).height(200).backgroundColor(Color.White)
      Column().width(100).height(200).backgroundColor(Color.Green)
      Column().width(100).height(200).backgroundColor(Color.Orange)
    }
    .margin({ top: 10 })
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Gray)
  }
}
</code></pre>
<p>运行效果图：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2851334b2c614cf08377cd6b9189054b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765353992&amp;x-signature=jISBMKCUzHU9cZP%2FEVhCPsJzO6g%3D" alt="QQ_1764233341962.png" loading="lazy"/></p>
<p>在这个案例中</p>
<ul>
<li>使用<code>direction: FlexDirection.Row</code>让<code>Flex</code>组件成功复刻了<code>Row</code>组件特性</li>
<li>当然<code>justifyContent</code>与<code>alignItems</code>也具备了<code>Row</code>组件特性</li>
</ul>
<p>刚刚复刻了<code>Row</code>组件，来试试复刻<code>Column</code>组件</p>
<h5 data-id="heading-9">2.1.3.2 复刻Column组件</h5>
<pre><code class="hljs language-ArkTS" lang="ArkTS">import { LengthMetrics } from '@kit.ArkUI';

@Entry
@Component
struct FlexiblePage {
  build() {
   复刻了`Column`组件
   - ({
      direction: FlexDirection.Column,
      justifyContent: FlexAlign.Start,
      alignItems: ItemAlign.Start,
      wrap: FlexWrap.NoWrap,
      space: { main: LengthMetrics.vp(20), cross: LengthMetrics.vp(30) }
    }) {
      Column().width(100).height(200).backgroundColor(Color.Pink)
      Column().width(100).height(200).backgroundColor(Color.Red)
      Column().width(100).height(200).backgroundColor(Color.Blue)

      Column().width(100).height(200).backgroundColor(Color.White)
      Column().width(100).height(200).backgroundColor(Color.Green)
      Column().width(100).height(200).backgroundColor(Color.Orange)
    }
    .margin({ top: 10 })
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Gray)
  }
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7cb176a192d4eaebae0ee1155eef561~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765353992&amp;x-signature=x7GZLv2GNknfEgPYO2ZHT%2B2Mm44%3D" alt="QQ_1764235343899.png" loading="lazy"/></p>
<p>在这个案例中</p>
<ul>
<li>仅仅改变了<code>direction</code>的值，成功的复刻了<code>Column</code>组件</li>
<li>对应<code>justifyContent</code>与<code>alignItems</code>也具备了<code>Column</code>组件特性</li>
<li>案例里面<code>wrap</code>表示是否多行，<code>NoWrap</code>也就是不允许，读者可以自行测试多行效果，这里不在赘述</li>
<li><code>space</code> 设置元素之间的间距。<code>main</code>主轴元素之间间距；<code>cross</code>交叉轴之间的间距（注意不同的<code>direction</code>的值，主轴、交叉轴不同哟）</li>
</ul>
<p>OK，我们继续下一个！</p>
<h4 data-id="heading-10">2.2.4 Stack容器组件</h4>
<p>Stack案例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">@Entry
@Component
struct StackPage {
  @State message: string = 'Hello World';

  build() {
    Stack({alignContent: Alignment.Center}) {
      Column().width('90%').height('90%').backgroundColor(Color.Pink).zIndex(1)
      Column().width('50').height('50').backgroundColor(Color.Blue).zIndex(3)
      Column().width('150').height('150').backgroundColor(Color.Green).zIndex(2)
    }
    .height('100%')
    .width('100%')
  }
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f335b15f71149a89ffdbbfdebf4c707~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765353992&amp;x-signature=M80Dbzt06dpS1IeEO4vvmgmt%2FJQ%3D" alt="QQ_1764237543527.png" loading="lazy"/></p>
<p>在这个案例中：</p>
<ul>
<li>有三个大小不一的元素在里面通过<code>{alignContent: Alignment.Center}</code>实现了所有元素居中对齐。（一共有9中对齐方式，读者可以亲自尝试）</li>
<li><code>.zIndex(1)</code>通过这个属性方法设置 层级的优先级，数字越大，层级越靠前。<strong>可以将这个理解为厨房叠盘子，数字越大盘子就越上面，如果上面的盘子比下面的大，那就看不到下面的盘子</strong></li>
</ul>
<p>这个没什么难度，继续下一个！</p>
<h4 data-id="heading-11">2.2.5 Grid容器组件</h4>
<h5 data-id="heading-12">2.2.5.1 Grid案例一</h5>
<pre><code class="hljs language-ArkTS" lang="ArkTS">@Entry
@Component
struct GridPage {
  build() {
    Grid() {
      GridItem() {
        Row() {
          Column() {
            Text('商品名称')
          }
          .width('100%')
        }
      }.width("100%").height(100).backgroundColor(Color.Gray)
      GridItem().width("100%").height(100).backgroundColor(Color.Gray)
      GridItem().width("100%").height(100).backgroundColor(Color.Gray)
      GridItem().width("100%").height(100).backgroundColor(Color.Gray)
      GridItem().width("100%").height(100).backgroundColor(Color.Gray)
      GridItem().width("100%").height(100).backgroundColor(Color.Gray)
      GridItem().width("100%").height(100).backgroundColor(Color.Gray)
      GridItem().width("100%").height(100).backgroundColor(Color.Gray)
    }
    .height('100%')
    .width('100%')
    .columnsTemplate('1fr 1fr 1fr 1fr')
    .rowsGap(10)
    .columnsGap(10)
  }
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4067eb34d8e04e6e848e8186d5577dfd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765353992&amp;x-signature=F5CtdVf49KWIXgfwW1P5N1q7Twg%3D" alt="QQ_1764299740119.png" loading="lazy"/></p>
<p>在这个案例中：</p>
<ul>
<li><code>Grid</code>组件需要结合<code>GridItem</code>组件一起使用，并且这两个组件都是容器组件。</li>
<li><code>.columnsTemplate('1fr 1fr 1fr 1fr')</code>属性方法表示该<code>Grid</code>组件分为几列数据，其中的<code>1fr</code>表示该列权重占比</li>
<li><code>rowsGap</code>与<code>columnsGap</code>分别表示设置 行间距以及列间距</li>
</ul>
<p>那现在问题来了，案例一的<code>GridItem</code>组件就仅仅第一个添加了基本组件，而且还仅仅只是一个<code>Text</code>组件，结构层次就已经比较多了，试想一下，如果<code>Item</code>内容再复杂一点，那代码岂不是很冗余？</p>
<p>带着这样的问题，我们来看下一个案例：</p>
<h5 data-id="heading-13">2.2.5.2 Grid案例二</h5>
<pre><code class="hljs language-ArkTS" lang="ArkTS">@Entry
@Component
struct GridPage {
  build() {
    Grid() {
      GirdItemComponent()
      GirdItemComponent()
      GirdItemComponent()
      GirdItemComponent()
      GirdItemComponent()
      GirdItemComponent()
      GirdItemComponent()
      GirdItemComponent()
      GirdItemComponent()
      GirdItemComponent()
      GirdItemComponent()
      GirdItemComponent()
    }
    .height('100%')
    .width('100%')
    .columnsTemplate('1fr 1fr 1fr 1fr')
    .rowsGap(10)
    .columnsGap(10)
  }
}

@Component
struct GirdItemComponent {
  build() {
    GridItem() {
      Row() {
        Column() {
          Text('商品名称')
        }.width('100%')
      }.height(100)
    }.borderRadius(4)
    .backgroundColor(Color.Pink)
  }
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e1ea64e4f5742c89114d70e0349aa96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765353992&amp;x-signature=C5wNu3IAxLlCQ83TredRUvOZss4%3D" alt="QQ_1764300613985.png" loading="lazy"/></p>
<p>在这个案例中：</p>
<ul>
<li>我们将<code>GridItem</code>放在了新的<code>struct GirdItemComponent</code>里面，并且用<code>@Component</code>修饰，此时<code>GirdItemComponent</code>已经被我们封装成了<strong>自定义组件</strong></li>
</ul>
<p>不过现在还有个问题：<code>GirdItemComponent()</code>数量目前是代码写死的，如何通过数据源动态渲染呢？</p>
<h5 data-id="heading-14">2.2.5.3 Grid案例三</h5>
<pre><code class="hljs language-ArkTS" lang="ArkTS">@Entry
@Component
struct GridPage {
  listData:Array&lt;number&gt;=[1,2,3,4,5,6,7,8,9,10,11,12]
  build() {
    Grid() {
      ForEach(this.listData,(item:number,index:number)=&gt;{
        GirdItemComponent()
      })
    }
    .height('100%')
    .width('100%')
    .columnsTemplate('1fr 1fr 1fr 1fr')
    .rowsGap(10)
    .columnsGap(10)
  }
}
//部分代码省略......

</code></pre>
<p>在这个案例中</p>
<ul>
<li>使用<code>ForEach</code>循环，成功的通过数据源的数量动态渲染<code>GridItem</code></li>
</ul>
<p>接着讲下一个组件！</p>
<h4 data-id="heading-15">2.2.6 RelativeContainer 容器组件</h4>
<p>相对布局组件，用于复杂场景中元素对齐的布局。它可以根据组件与组件的关系，设置并定位对应自己的不同的位置。</p>
<p>RelativeContainer 案例</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">@Entry
@Component
struct Page2 {
  build() {
    Row() {
      RelativeContainer() {
        Row(){Text('row1')}.justifyContent(FlexAlign.Center)
        .width(100).height(100)
        .backgroundColor("#FF3333")
        .alignRules({
          top: {anchor: "__container__", align: VerticalAlign.Top},
          left: {anchor: "__container__", align: HorizontalAlign.Start}
        })
        .id("row1")

        Row(){Text('row2')}.justifyContent(FlexAlign.Center)
        .width(100).height(100)
        .backgroundColor("#FFCC00")
        .alignRules({
          top: {anchor: "__container__", align: VerticalAlign.Top},
          right: {anchor: "__container__", align: HorizontalAlign.End}
        })
        .id("row2")

        Row(){Text('row3')}.justifyContent(FlexAlign.Center)
        .height(100)
        .backgroundColor("#FF6633")
        .alignRules({
          top: {anchor: "row1", align: VerticalAlign.Bottom},
          left: {anchor: "row1", align: HorizontalAlign.End},
          right: {anchor: "row2", align: HorizontalAlign.Start}
        })
        .id("row3")

        Row(){Text('row4')}.justifyContent(FlexAlign.Center)
        .backgroundColor("#FF9966")
        .alignRules({
          top: {anchor: "row3", align: VerticalAlign.Bottom},
          bottom: {anchor: "__container__", align: VerticalAlign.Bottom},
          left: {anchor: "__container__", align: HorizontalAlign.Start},
          right: {anchor: "row1", align: HorizontalAlign.End}
        })
        .id("row4")

        Row(){Text('row5')}.justifyContent(FlexAlign.Center)
        .backgroundColor("#FF66FF")
        .alignRules({
          top: {anchor: "row3", align: VerticalAlign.Bottom},
          bottom: {anchor: "__container__", align: VerticalAlign.Bottom},
          left: {anchor: "row2", align: HorizontalAlign.Start},
          right: {anchor: "__container__", align: HorizontalAlign.End}
        })
        .id("row5")
      }
      .width(300).height(300)
      .margin({left: 50})
      .border({width:2, color: "#6699FF"})
    }
    .height('100%')
  }
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fc4db1db5e44bafb46f369ef21f8c20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765353992&amp;x-signature=B%2FU11yGgC7py5cN%2BCKXqDMtQs5w%3D" alt="QQ_1764315080855.png" loading="lazy"/></p>
<p>在这个案例中：</p>
<ul>
<li>
<p>在<code>RelativeContainer</code>组件里，子组件位置通过<code>.alignRules(xx)</code>属性方法，设置当前子组件的位置</p>
</li>
<li>
<p>在<code>.alignRules(xx)</code>属性方法里，可以分别设置<code>top</code>、<code>bottom</code>、<code>left</code>、<code>right</code>、<code>center</code>、<code>middle</code>,不同方位以及居中对齐参数，但他们无非都是分为<strong>垂直方向以及水平方向</strong></p>
<ul>
<li><code>top</code>、<code>bottom</code>、<code>center</code> 这三个是垂直方向</li>
<li><code>left</code>、<code>right</code>、<code>middle</code> 这三个是水平方向</li>
</ul>
</li>
<li>
<p>在<code>{anchor: "xxx", align: xxx}</code>结构体中，<strong>不同的方向将会有不同的设置约束的方式</strong>，</p>
<ul>
<li>水平方向通过<code>align: HorizontalAlign.xxx</code>赋值</li>
<li>垂直方向通过<code>align: VerticalAlign.xxx</code>赋值</li>
</ul>
</li>
<li>
<p>在<code>{anchor: "xxx", align: xxx}</code>结构体中，当前子组件可以通过<code>anchor: "xxx"</code>与其他子组件或父组件建立约束</p>
<ul>
<li><code>anchor: "__container__"</code> 这个表示与父容器建立约束</li>
<li><code>anchor: "row3"</code> 这个表示与<code>row3</code>组件建立约束。而<code>row3</code>组件通过<code>.id("row3")</code>设置并命名了自己就是<code>row3</code>组件</li>
</ul>
</li>
<li>
<p>在<code>Row4</code>与<code>Row5</code>组件里，它俩分别建立了四个方位的约束，因此在没有设置<code>width</code>与<code>height</code>时，它也会自动根据约束生成对应的宽高长度</p>
</li>
</ul>
<p>OK，常用的容器组件，已经讲完了。现在我们开始讲解基础组件。</p>
<h3 data-id="heading-16">2.2 基础组件</h3>
<p>基础组件比较简单，我这准备用一些小案例来讲解基础组件如何使用</p>
<h4 data-id="heading-17">2.2.1 案例一：</h4>
<pre><code class="hljs language-ArkTS" lang="ArkTS">@Entry
@Component
struct TextPage {
  @State message: string = 'Hello World';
  build() {
    RelativeContainer() {
      Text(this.message)
        .id('TextPageHelloWorld')
        .fontSize(50)
        .fontWeight(FontWeight.Bold)
        .alignRules({
          center: { anchor: '__container__', align: VerticalAlign.Center },
          middle: { anchor: '__container__', align: HorizontalAlign.Center }
        })

      Button('点我改变文本')
        .alignRules({
          top: { anchor: 'TextPageHelloWorld', align: VerticalAlign.Bottom },
          middle: { anchor: '__container__', align: HorizontalAlign.Center }
        })
        .onClick(() =&gt; {
          this.clickBtn()
        })
        .margin({ top: 20 })
    }
    .height('100%')
    .width('100%')
  }

  private clickBtn() {
    this.message = "我改变了Text"
  }
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/001f5c7289ac467580f7b2cffdb2ccb0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765353992&amp;x-signature=Ybyywix%2FNKJGP6vpeIx5BJdVpn0%3D" alt="ezgif-50a344ea2841ebb4.gif" loading="lazy"/></p>
<p>在这个示例中：</p>
<ul>
<li>使用了<code>Text</code>、<code>Button</code>组件，而<code>Text</code>文本是通过变量<code>message</code>赋值，这个变量使用了<code>@State</code>修饰符</li>
<li><code>@State</code>又名：<strong>状态变量装饰器</strong>，被它修饰的变量<code>message</code>称为<strong>状态变量</strong>（让普通变量具备状态属性），也就是说当状态变量改变时，将会触发绑定的UI组件渲染更新</li>
<li>因此在<code>Button</code>点击事件里，改变了<code>message</code>状态变量，让<code>Text</code>组件渲染更新了最新的文本</li>
</ul>
<p>这个很简单，现在逐渐上难度</p>
<h4 data-id="heading-18">2.2.2 案例二：</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> { promptAction } from <span class="hljs-string">'@kit.ArkUI'</span>;

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct LoginPage {

  <span class="hljs-meta">@State</span> phone: string = <span class="hljs-string">''</span>
  <span class="hljs-meta">@State</span> password: string = <span class="hljs-string">''</span>
  <span class="hljs-meta">@State</span> smsCode: string = <span class="hljs-string">''</span>

  <span class="hljs-meta">@State</span> loginByPassword: boolean = <span class="hljs-literal">true</span> <span class="hljs-comment">// true=密码登录，false=验证码登录</span>

  <span class="hljs-comment">// 验证码倒计时</span>
  <span class="hljs-meta">@State</span> counter: number = <span class="hljs-number">0</span>
  <span class="hljs-keyword">private</span> timerId: number = <span class="hljs-number">0</span>

  build() {
    Column({ space: <span class="hljs-number">20</span> }) {

      Text(<span class="hljs-string">"手机登录"</span>)
        .fontSize(<span class="hljs-number">30</span>)
        .fontWeight(FontWeight.Bold)
        .margin({ top: <span class="hljs-number">40</span> })

      <span class="hljs-comment">/** 手机号输入框 */</span>
      Row() {
        TextInput({ placeholder: <span class="hljs-string">'请输入手机号'</span> })
          .type(InputType.Number)
          .maxLength(<span class="hljs-number">11</span>)
          .onChange(v =&gt; <span class="hljs-keyword">this</span>.phone = v)
      }
      .padding(<span class="hljs-number">12</span>)
      .backgroundColor(<span class="hljs-string">'#F7F7F7'</span>)
      .borderRadius(<span class="hljs-number">8</span>)
      .width(<span class="hljs-string">'85%'</span>)

      <span class="hljs-comment">/** 密码登录区域 */</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.loginByPassword) {
        Row() {
          TextInput({ placeholder: <span class="hljs-string">'请输入密码'</span> })
            .type(InputType.Password)
            .onChange(v =&gt; <span class="hljs-keyword">this</span>.password = v)
        }
        .padding(<span class="hljs-number">12</span>)
        .backgroundColor(<span class="hljs-string">'#F7F7F7'</span>)
        .borderRadius(<span class="hljs-number">8</span>)
        .width(<span class="hljs-string">'85%'</span>)
      }

      <span class="hljs-comment">/** 验证码登录区域 */</span>
      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.loginByPassword) {
        Row({ space: <span class="hljs-number">10</span> }) {
          TextInput({
            placeholder: <span class="hljs-string">'请输入验证码'</span>
          })
            .onChange(v =&gt; <span class="hljs-keyword">this</span>.smsCode = v)
            .width(<span class="hljs-string">'60%'</span>)
          <span class="hljs-comment">// 发送验证码按钮</span>
          Button(
            <span class="hljs-keyword">this</span>.counter &gt; <span class="hljs-number">0</span>
              ? `${<span class="hljs-keyword">this</span>.counter} 秒后重试`
              : <span class="hljs-string">'发送验证码'</span>
          )
            .height(<span class="hljs-number">40</span>)
            .borderRadius(<span class="hljs-number">6</span>)
            .backgroundColor(<span class="hljs-string">'#007DFF'</span>)
            .fontColor(Color.White)
            .onClick(() =&gt; <span class="hljs-keyword">this</span>.onSendCode())
        }
        .padding(<span class="hljs-number">12</span>)
        .backgroundColor(<span class="hljs-string">'#F7F7F7'</span>)
        .borderRadius(<span class="hljs-number">8</span>)
        .width(<span class="hljs-string">'85%'</span>)
      }

      <span class="hljs-comment">/** 登录按钮 */</span>
      Button(<span class="hljs-string">"登录"</span>)
        .width(<span class="hljs-string">'85%'</span>)
        .height(<span class="hljs-number">45</span>)
        .backgroundColor(<span class="hljs-string">'#007DFF'</span>)
        .fontColor(Color.White)
        .borderRadius(<span class="hljs-number">8</span>)
        .onClick(() =&gt; <span class="hljs-keyword">this</span>.onLogin())

      <span class="hljs-comment">/** 登录方式切换 */</span>
      Row() {
        Text(<span class="hljs-keyword">this</span>.loginByPassword ? <span class="hljs-string">"使用验证码登录"</span> : <span class="hljs-string">"使用密码登录"</span>)
          .fontColor(<span class="hljs-string">'#007DFF'</span>)
          .onClick(() =&gt; {
            <span class="hljs-keyword">this</span>.loginByPassword = !<span class="hljs-keyword">this</span>.loginByPassword
            <span class="hljs-keyword">this</span>.password = <span class="hljs-string">''</span>
            <span class="hljs-keyword">this</span>.smsCode = <span class="hljs-string">''</span>
          })
      }
    }
    .width(<span class="hljs-string">'100%'</span>)
    .justifyContent(FlexAlign.Center)
  }

  <span class="hljs-comment">/** ---------------- 功能逻辑 ---------------- */</span>
  <span class="hljs-keyword">private</span> show(msg: string) {
    <span class="hljs-keyword">this</span>.toast(msg)
  }

  <span class="hljs-comment">/** 登录按钮逻辑 */</span>
  <span class="hljs-keyword">private</span> onLogin() {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.phone.trim() === <span class="hljs-string">''</span>) {
      <span class="hljs-keyword">this</span>.show(<span class="hljs-string">"请输入手机号"</span>)
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.loginByPassword) {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.password.trim() === <span class="hljs-string">''</span>) {
        <span class="hljs-keyword">this</span>.show(<span class="hljs-string">"请输入密码"</span>)
        <span class="hljs-keyword">return</span>
      }
      <span class="hljs-keyword">this</span>.show(<span class="hljs-string">"密码登录成功（示例）"</span>)
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.smsCode.trim() === <span class="hljs-string">''</span>) {
        <span class="hljs-keyword">this</span>.show(<span class="hljs-string">"请输入验证码"</span>)
        <span class="hljs-keyword">return</span>
      }
      <span class="hljs-keyword">this</span>.show(<span class="hljs-string">"验证码登录成功（示例）"</span>)
    }
  }

  <span class="hljs-comment">/** 发送验证码逻辑 */</span>
  <span class="hljs-keyword">private</span> onSendCode() {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.phone.trim() === <span class="hljs-string">''</span>) {
      <span class="hljs-keyword">this</span>.show(<span class="hljs-string">"请先输入手机号"</span>)
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.counter &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">this</span>.show(`请等待 ${<span class="hljs-keyword">this</span>.counter} 秒后再试`)
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-comment">// 模拟发送成功</span>
    <span class="hljs-keyword">this</span>.show(<span class="hljs-string">"验证码已发送"</span>)

    <span class="hljs-keyword">this</span>.counter = <span class="hljs-number">60</span>
    <span class="hljs-keyword">this</span>.startTimer()
  }

  <span class="hljs-keyword">private</span> toast(msg: string) {
    promptAction.showToast({ message: msg })
  }

  <span class="hljs-comment">/** 60 秒倒计时定时器 */</span>
  <span class="hljs-keyword">private</span> startTimer() {
    clearInterval(<span class="hljs-keyword">this</span>.timerId)
    <span class="hljs-keyword">this</span>.timerId = setInterval(() =&gt; {
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.counter &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">this</span>.counter--
      } <span class="hljs-keyword">else</span> {
        clearInterval(<span class="hljs-keyword">this</span>.timerId)
      }
    }, <span class="hljs-number">1000</span>)
  }
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efd276d1e9a2406fa012e6be5ddeb7bb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765353992&amp;x-signature=ztJT1rZ4a5pMcr26S1Cxm%2FRISbY%3D" alt="ezgif-4d505e9cca216e11.gif" loading="lazy"/></p>
<p>这是一个非常典型的验证码、密码登录例子，在这个例子中：</p>
<ul>
<li>
<p>使用的新组件<code>TextInput</code>输入框组件，</p>
<ul>
<li><code>{ placeholder: 'xxxx' }</code>表示该输入框组件，在没有输入内容之前提示文本</li>
<li><code>.type(InputType.xxx)</code>设置改输入框组件是什么类型的输入框</li>
</ul>
</li>
<li>
<p>在UI描述区域可以使用<code>if</code>语句来控制UI区域是否显示。（必须是<code>@State</code>修饰的<strong>状态变量</strong>）</p>
<ul>
<li><code>if (this.loginByPassword)</code>显示密码登录区域；</li>
<li><code>if (!this.loginByPassword)</code>显示验证码登录区域</li>
</ul>
</li>
<li>
<p>也可以在某个组件内使用三目运算符进行组件渲染。如案例中：<code>Text(this.loginByPassword ? "使用验证码登录" : "使用密码登录")</code>等。（必须是<code>@State</code>修饰的<strong>状态变量</strong>）</p>
</li>
<li>
<p><code>import { promptAction } from '@kit.ArkUI';</code>这里导入了SDK开放能力，SDK对同一个Kit下的接口模块进行了封装。这句代码意思就是，导入<code>@kit.ArkUI</code>里面的<code>promptAction</code>接口能力</p>
</li>
</ul>
<p>上面的俩个例子都是通过<strong>状态变量</strong>改变时影响布局的渲染，那能不能通过组件内容的更改从而改变变量的值呢？</p>
<h4 data-id="heading-19">2.2.3 案例三：</h4>
<pre><code class="hljs language-ArkTS" lang="ArkTS">@Entry
@Component
struct PageMvvm {

  @State
  isChecked: boolean = false
  @State
  myDate: Date = new Date()
  @State
  sexMale: boolean = true
  @State
  sexFeMale: boolean = false
  @State
  mySearch: string = ''
  @State
  myToggle: boolean = false
  @State
  mySelect: string = 'aaa'

  build() {
    Column({space: 12}) {

      Column(){
        Text('CheckBox双向绑定')
        Checkbox().select($$this.isChecked)
        Text('' + this.isChecked)
      }

      MyDivider()

      Column(){
        Text('DatePicker双向绑定')
        DatePicker({selected: $$this.myDate})
        Text('' + this.myDate.toLocaleString())
      }
      MyDivider()
      Column(){
        Text('Radio双向绑定')
        Radio({value:'male',   group: 'sex'}).checked($$this.sexMale)
        Radio({value:'female', group: 'sex'}).checked($$this.sexFeMale)
        Text('' + this.sexMale)
      }
      MyDivider()
      Column(){
        Text('Search双向绑定')
        Search({value: $$this.mySearch})
        Text('' + this.mySearch)
      }

      MyDivider()
      Column() {
        Text('Toggle双向绑定')
        Toggle({ type: ToggleType.Switch,isOn:$$this.myToggle})
        Text('' + this.myToggle)
      }

      MyDivider()
      Column() {
        Text('Select双向绑定')
        Row(){
          Select([{ value: 'aaa' },
            { value: 'bbb'},
            { value: 'ccc'},
            { value: 'ddd'}])
            .value($$this.mySelect)
          Text('' + this.mySelect)
        }
      }
      MyDivider()
    }
    .height('100%')
    .width('100%')
  }
}

@Component
struct MyDivider {
  build() {
    Divider().height(3).backgroundColor(Color.Pink)
  }
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/564f3edfe5d142b18d739cebf3933ccd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765353992&amp;x-signature=teWO5rPiCHlvKDOm25MDapC%2BxC8%3D" alt="ezgif-36c0e0b8023d3deb.gif" loading="lazy"/></p>
<p>在该例子中：</p>
<ul>
<li>使用了一系列不同的新组件（<code>Checkbox</code>、<code>DatePicker</code>、<code>Radio</code>.....），在传值的时候，对应的变量前加了<code>$$</code>符号，当组件值改变时，也会同步改变对应变量。</li>
</ul>
<p>在日常开发中，我们难免会根据不同的需求，封装自己的UI。</p>
<p>那该如何封装自定义UI呢？</p>
<h3 data-id="heading-20">2.3 自定义UI</h3>
<p>在上面讲解<code>Grid</code>案例二的时候，就用过一次自定义UI，当时是用<code>@Component</code>封装了自定义组件。</p>
<p>而在鸿蒙<code>ArkTS</code>开发中,<code>@Component</code>和<code>@Builder</code>是构建UI最常用的两个装饰器。</p>
<p>虽然它们都用于生成 UI 界面，但它们在定位、能力、生命周期和性能上有本质的区别。</p>
<p>说了这么多，上案例讲解！</p>
<h4 data-id="heading-21">2.3.1 案例一</h4>
<pre><code class="hljs language-ArkTS" lang="ArkTS">@Builder
function ValueBuilder(text: string) {
  Text(`值传递Builder，不会刷新UI: ${text}`)
    .fontSize(16)
    .fontColor(Color.Gray)
    .margin(5)
}

class Tmp {
  title: string = ''
}

@Builder
function QuoteBuilder(tmp: Tmp) {
  Column() {
    Row() {
      Image($r('app.media.startIcon')).width(20)
      Text(`引用传递Builder,会刷新UI: ${tmp.title}`).fontSize(18)
    }
    .margin(10)
  }
}

@Component
@Entry
struct ParentPage {
  @State parentMessage: string = "父组件状态";

  @Builder
  LocalBuilder() {
    Text(`这是LocalBuilder 能通过this刷新 ${this.parentMessage}`)
  }

  build() {
    Column() {

      //全局值传递Builder
      ValueBuilder(this.parentMessage)

      //全局引用传递Builder
      QuoteBuilder({ title: this.parentMessage })

      //局部 this 指向Builder
      this.LocalBuilder()
      Divider().strokeWidth(2).color(Color.Blue).margin({top:20})

      Button("修改父组件状态")
        .onClick(() =&gt; {
          this.parentMessage = "状态已更新";
          console.log(`parentMessage=${this.parentMessage}`)
        }).margin({top:20})

      Text(this.parentMessage).margin({top:20})

      Divider().strokeWidth(2).color(Color.Blue).margin({top:20})

      // 使用子组件
      ChildComponent().margin({top:20})
    }
    .width('100%')
    .height('100%')
  }
}


// 2. 定义一个子组件 Component (独立模块，有生命周期)
@Component
struct ChildComponent {
  @State message: string = "我是独立的子组件";

  // 生命周期演示
  aboutToAppear() {
    console.log("ChildComponent 初始化了");
  }

  build() {
    Column() {
      Text(this.message)
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .backgroundColor(Color.Pink)
        .padding(10)
        .onClick(() =&gt; {
          this.message = "子组件被点击，只刷新我！";
        })
    }
  }
}
</code></pre>
<p>运行初始化日志：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-code">     ChildComponent 初始化了
</span></code></pre>
<p>运行效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89f3553c240e4d1faf0e19d146e1666a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765353992&amp;x-signature=LjTOVSQhALb3uoEjTBrafu54vrs%3D" alt="ezgif-3df822dc21ccbf98.gif" loading="lazy"/></p>
<p>在该例子中：</p>








































<table><thead><tr><th><strong>特性</strong></th><th><strong>@Component (自定义组件)</strong></th><th><strong>@Builder (UI 构建函数)</strong></th></tr></thead><tbody><tr><td><strong>本质</strong></td><td><strong>类/结构体</strong> (<code>struct</code>)</td><td><strong>函数/方法</strong> (<code>function</code>)</td></tr><tr><td><strong>生命周期</strong></td><td><strong>有</strong> (<code>aboutToAppear</code>, <code>aboutToDisappear</code> 等)</td><td><strong>无</strong></td></tr><tr><td><strong>状态管理</strong></td><td>拥有独立的状态 (<code>@State</code>, <code>@Link</code> 等)</td><td>依赖传入参数或宿主组件的状态</td></tr><tr><td><strong>渲染机制</strong></td><td>独立的渲染节点，更新时只刷新自己</td><td>视为宿主组件的一部分，通常随宿主刷新</td></tr><tr><td><strong>性能开销</strong></td><td>较重 (需要创建实例、维护状态和生命周期)</td><td>极轻 (仅仅是代码复用逻辑)</td></tr><tr><td><strong>复用范围</strong></td><td>全局可复用，不仅限 UI，还封装逻辑</td><td>主要是 UI 结构的复用 (分为全局和局部)</td></tr></tbody></table>
<p>我们在开发过程中往往会出现大量的代码在进行重复样式的设置，因此这就涉及到样式的复用。</p>
<h3 data-id="heading-22">2.4 样式复用</h3>
<h4 data-id="heading-23">2.4.1 @Styles 样式复用</h4>
<p>案例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">import { promptAction } from '@kit.ArkUI';

enum PayType {
  WXPay, Alipay, BankPay, CreditCard
}

@Entry
@Component
struct PageStyle1 {
  @State
  heightValue: number = 50

  @Styles
  // payStyle(payType:PayType){  //编译报错，@Styles 方法不能含有参数
  payStyle(){
    .width('100%')
    .height(this.heightValue)
    .borderRadius(10)
    .backgroundColor('#FF1266e0')
    .onClick(() =&gt; {
      promptAction.showToast({ message: '支付成功！' })
    })
  }

  build() {
    Column() {
      Row() {
        Button('微信支付', { type: ButtonType.Normal })
          .payStyle()
      }
      .padding(10)

      Row() {
        Button('支付宝支付', { type: ButtonType.Normal })
          .payStyle()

      }
      .padding(10)

      Row() {
        Button('银行卡支付', { type: ButtonType.Normal })
          .payStyle()

      }
      .padding(10)

      Row() {
        Button('信用卡支付', { type: ButtonType.Normal })
          .payStyle()

      }
      .padding(10)

    }
    .width('100%')
    .height('100%')

  }
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a164547ff5c4713ac8cc5cd22b4816b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765353992&amp;x-signature=k4ZDEwt4gRk31MDOfSWYDFkO5w0%3D" alt="ezgif-60d51c07d55661eb.gif" loading="lazy"/></p>
<p>在该例子中：</p>
<ul>
<li>通过<code>@Styles</code>修饰的方法可以定义<strong>通用属性与通用事件，不支持参数传递（通用、通用、通用）</strong></li>
</ul>
<p>那如果说有多种情况，不同情况按钮颜色不一样，然而<code>@Styles</code>修饰的方法不可传参，区分不了按钮，那该怎么办呢？</p>
<h4 data-id="heading-24">2.4.2 @Extend 样式复用</h4>
<p>案例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">import { promptAction } from '@kit.ArkUI';

@Entry
@Component
struct PageStyle2 {
  build() {
    Column({ space: 20 }) {
      Button("支付宝支付")
        .payButton("alipay")
      Button("微信支付")
        .payButton("wechat")
      Button("支付宝支付")
        .payButton("alipay")
      Button("微信支付")
        .payButton("wechat")
      Button("支付宝支付")
        .payButton("alipay")
      Button("微信支付")
        .payButton("wechat")
      Button("支付宝支付")
        .payButton("alipay")
    }
    .padding(20)
    .width('100%')
  }
}

@Extend(Button)
function payButton(type: 'alipay' | 'wechat'){
  .type(ButtonType.Normal)
  .fontColor(Color.White)
  .width('100%')
  .height(50)
  .borderRadius(4)
  .backgroundColor(type === 'wechat' ? '#00c168':'#ff1256e0')
  .onClick(()=&gt;{
    if( type === 'alipay'){
      promptAction.showToast({message: '支付宝支付成功！'})
    }else{
      promptAction.showToast({message: '微信支付成功！'})
    }
  })
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4b8ede32c5d4adeabd0d747122b4064~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765353992&amp;x-signature=qRFpiz%2B89MbRZMAK9YaeMFNLhZg%3D" alt="ezgif-2587c76ade83aa5c.gif" loading="lazy"/></p>
<p>在该例子中：</p>
<ul>
<li>使用<code>@Extend(Button)</code>扩展了原生组件的样式，支持封装私有属性、通用属性、事件。</li>
<li>与<code>@Styles</code>不同，<code>@Extend(Button)</code>支持参数传递，提供了更大的灵活性</li>
</ul>
<p>虽然<code>@Styles</code>和<code>@Extend(Button)</code>提供了样式复用的能力，但是它们还是存在一些限制，因此就有了<code>AttributeModifier</code>。</p>
<p>我们来看看如何使用它。</p>
<h4 data-id="heading-25">2.4.3 AttributeModifier</h4>
<p>案例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">@Entry
@Component
struct PageStyle3 {

  @State modifier: MyButtonModifier = new MyButtonModifier()
  @State modifier2: MyButtonModifier2 = new MyButtonModifier2()

  build() {

    Column({space: 20}){
      Button('点我试试').attributeModifier(this.modifier).onClick(()=&gt;{
        this.modifier.isDark = !this.modifier.isDark
      })

      Divider().height(2).backgroundColor(Color.Pink)

      Button('点我试试').attributeModifier(this.modifier2)

    }
    .width('100%')
    .height('100%')
  }
}

class MyButtonModifier implements AttributeModifier&lt;ButtonAttribute&gt;{
  isDark: boolean  = false
  applyNormalAttribute(instance: ButtonAttribute): void {
    instance.backgroundColor(this.isDark ? Color.Black: Color.Red)
  }
}

class MyButtonModifier2 implements AttributeModifier&lt;ButtonAttribute&gt; {
  applyNormalAttribute(instance: ButtonAttribute): void {
    instance.backgroundColor(Color.Black)
  }
  applyPressedAttribute(instance: ButtonAttribute): void {
    instance.backgroundColor(Color.Red)

  }
}
</code></pre>
<p>运行效果</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14f251648531456c91057c98ac40677f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765353992&amp;x-signature=APmj5m2w7H7toUBkas%2FE85%2BUTH4%3D" alt="ezgif-7320282bf35d4baa.gif" loading="lazy"/></p>
<p>在这个例子中：</p>
<ul>
<li><code>AttributeModifier&lt;ButtonAttribute&gt;</code> 其中<code>ButtonAttribute</code>是 <code>Button</code>专有属性类，也就是按钮扩展属性</li>
<li><code>applyNormalAttribute</code> 表示 按钮在正常情况下属性的表现</li>
<li><code>applyPressedAttribute</code> 表示 按钮在按下的情况下属性的表现</li>
</ul>
<h4 data-id="heading-26">2.4.4 多态样式stateStyles</h4>
<p>案例：</p>
<pre><code class="hljs language-ArkTS" lang="ArkTS">@Entry
@Component
struct PageStyle4 {
  build() {
    Column(){
      Row(){
        Text('今天你心情怎么样！')
      }
      .padding(20)
      .height(80)
      .border({
        color: Color.Pink,
        width: 3
      })
      .borderRadius(4)
      .stateStyles({
        normal:{
          .backgroundColor(Color.Green)
        },
        pressed:{
          .backgroundColor('#eee')
          .border({
            width: 1,
            style: BorderStyle.Solid,
            color: Color.Red
          })
        }
      })

    }
    .width('100%')
    .height('100%')
  }
}
</code></pre>
<p>运行效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b48add4fe046497ba0045f05cb591604~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaHFr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765353992&amp;x-signature=%2Fx%2BR1Mn3vCF2rP%2B5UlLUMjxYDmQ%3D" alt="ezgif-7e5bff81b40c9dd2.gif" loading="lazy"/></p>
<p>在这个例子中：</p>
<ul>
<li>
<p>stateStyles可以依据组件的内部状态不同，快速设置不同样式</p>
</li>
<li>
<p>ArkUI提供以下五种状态</p>
<ul>
<li>focused：获取焦点时</li>
<li>normal：正常情况</li>
<li>pressed：按压时</li>
<li>disabled：不可选中时</li>
<li>selected：选中时</li>
</ul>
</li>
</ul>
<h3 data-id="heading-27">3、结束语</h3>
<p>OK，看到这里的小伙伴相信你对ArkUI有了一定的了解！
下一篇讲解状态管理、应用程序结构以及路由相关讲解！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[.NET 8 实时推送魔法：SSE 让数据 “主动跑” 到客户端]]></title>    <link>https://juejin.cn/post/7579441333166080009</link>    <guid>https://juejin.cn/post/7579441333166080009</guid>    <pubDate>2025-12-03T09:25:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579441333166080009" data-draft-id="7579440586693705774" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=".NET 8 实时推送魔法：SSE 让数据 “主动跑” 到客户端"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-03T09:25:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="幌才_loong"/> <meta itemprop="url" content="https://juejin.cn/user/4256947657515320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            .NET 8 实时推送魔法：SSE 让数据 “主动跑” 到客户端
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4256947657515320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    幌才_loong
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T09:25:00.000Z" title="Wed Dec 03 2025 09:25:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    17
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">引言</h3>
<p>在实时Web应用开发中，Server-Sent Events(SSE)作为一种轻量级的服务器推送技术，正成为提升用户体验的重要方案。SSE基于HTTP协议，允许服务器通过持久连接主动向客户端推送数据流，特别适合新闻更新、实时监控等场景。.NET 8通过性能优化和服务器端增强，为SSE提供了更强大的支持，使其成为构建高效实时应用的理想选择。</p>
<h3 data-id="heading-1">基本原理</h3>
<p>SSE是一种基于HTTP/1.1的单向通信技术，核心是通过text/event-stream MIME类型建立持久连接。客户端使用EventSource接口监听服务器推送的事件流，服务器则以分块编码形式持续发送数据。与轮询相比，SSE显著降低网络开销；与WebSocket相比，SSE实现更简单，特别适合服务器到客户端的单向数据推送。</p>
<h3 data-id="heading-2">后端代码实现</h3>
<h4 data-id="heading-3">1、Controller层代码实现</h4>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 建立 SSE 流连接的端点</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 客户端通过此端点建立持久连接以接收服务器推送的事件</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="clientId"&gt;</span>客户端唯一标识符（可选）<span class="hljs-doctag">&lt;/param&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>异步任务<span class="hljs-doctag">&lt;/returns&gt;</span></span>
[<span class="hljs-meta">HttpGet(<span class="hljs-string">"stream"</span>)</span>]
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">StreamEvents</span>(<span class="hljs-params">[FromQuery] <span class="hljs-built_in">string</span> clientId</span>)</span>
{
    <span class="hljs-comment">// 如果客户端未提供ID，则生成一个唯一的ID</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">string</span>.IsNullOrEmpty(clientId))
    {
        clientId = Guid.NewGuid().ToString();
    }

    <span class="hljs-comment">// 设置响应头以支持 SSE 协议</span>
    Response.Headers.Append(<span class="hljs-string">"Content-Type"</span>, <span class="hljs-string">"text/event-stream"</span>);         <span class="hljs-comment">// 指定内容类型为 SSE</span>
    Response.Headers.Append(<span class="hljs-string">"Cache-Control"</span>, <span class="hljs-string">"no-cache"</span>);                 <span class="hljs-comment">// 禁用缓存</span>
    Response.Headers.Append(<span class="hljs-string">"Connection"</span>, <span class="hljs-string">"keep-alive"</span>);                  <span class="hljs-comment">// 保持连接</span>
    Response.Headers.Append(<span class="hljs-string">"Access-Control-Allow-Origin"</span>, <span class="hljs-string">"*"</span>);          <span class="hljs-comment">// 允许跨域访问</span>

    <span class="hljs-comment">// 将当前客户端添加到 SSE 服务管理器中</span>
    <span class="hljs-keyword">await</span> _sseService.AddClientAsync(clientId, Response);

    <span class="hljs-comment">// 保持连接打开，直到客户端断开或请求被取消</span>
    <span class="hljs-keyword">try</span>
    {
        <span class="hljs-comment">// 循环检查请求是否已被取消</span>
        <span class="hljs-keyword">while</span> (!HttpContext.RequestAborted.IsCancellationRequested)
        {
            <span class="hljs-comment">// 每隔1秒检查一次连接状态</span>
            <span class="hljs-keyword">await</span> Task.Delay(<span class="hljs-number">1000</span>, HttpContext.RequestAborted);
        }
    }
    <span class="hljs-keyword">catch</span> (OperationCanceledException)
    {
        _logger.LogInformation(<span class="hljs-string">$"Client <span class="hljs-subst">{clientId}</span> disconnected (canceled)"</span>);
    }
    <span class="hljs-keyword">catch</span> (Exception ex)
    {
        _logger.LogError(ex, <span class="hljs-string">$"Error in SSE stream for client: <span class="hljs-subst">{clientId}</span>"</span>);
    }
    <span class="hljs-keyword">finally</span>
    {
        <span class="hljs-keyword">await</span> _sseService.RemoveClientAsync(clientId);
        _logger.LogInformation(<span class="hljs-string">$"SSE connection cleaned up for client: <span class="hljs-subst">{clientId}</span>"</span>);
    }
}
</code></pre>
<h4 data-id="heading-4">2、Service代码实现</h4>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> Server-Sent Events (SSE) 服务接口</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 提供向客户端推送实时事件的功能</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">ISseService</span>
{
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> 向指定客户端发送事件数据</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="clientId"&gt;</span>客户端唯一标识符<span class="hljs-doctag">&lt;/param&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="data"&gt;</span>要发送的数据<span class="hljs-doctag">&lt;/param&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>异步任务<span class="hljs-doctag">&lt;/returns&gt;</span></span>
    <span class="hljs-function">Task <span class="hljs-title">SendEventAsync</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> clientId, <span class="hljs-built_in">string</span> data</span>)</span>;

    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> 向指定客户端发送指定类型的事件数据</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="clientId"&gt;</span>客户端唯一标识符<span class="hljs-doctag">&lt;/param&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="eventType"&gt;</span>事件类型<span class="hljs-doctag">&lt;/param&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="data"&gt;</span>要发送的数据<span class="hljs-doctag">&lt;/param&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>异步任务<span class="hljs-doctag">&lt;/returns&gt;</span></span>
    <span class="hljs-function">Task <span class="hljs-title">SendEventAsync</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> clientId, <span class="hljs-built_in">string</span> eventType, <span class="hljs-built_in">string</span> data</span>)</span>;

    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> 添加新的 SSE 客户端连接</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="clientId"&gt;</span>客户端唯一标识符<span class="hljs-doctag">&lt;/param&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="response"&gt;</span>HTTP 响应对象<span class="hljs-doctag">&lt;/param&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>异步任务<span class="hljs-doctag">&lt;/returns&gt;</span></span>
    <span class="hljs-function">Task <span class="hljs-title">AddClientAsync</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> clientId, HttpResponse response</span>)</span>;

    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> 移除指定的客户端连接</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="clientId"&gt;</span>客户端唯一标识符<span class="hljs-doctag">&lt;/param&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>异步任务<span class="hljs-doctag">&lt;/returns&gt;</span></span>
    <span class="hljs-function">Task <span class="hljs-title">RemoveClientAsync</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> clientId</span>)</span>;

    <span class="hljs-function">Task <span class="hljs-title">BroadcastAsync</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> data</span>)</span>;
    <span class="hljs-function">Task <span class="hljs-title">BroadcastAsync</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> eventType, <span class="hljs-built_in">string</span> data</span>)</span>;
}


<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> SSE 服务实现类</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> 管理所有客户端连接并向其推送实时数据</span>
<span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SseService</span> : <span class="hljs-title">ISseService</span>
{
    <span class="hljs-keyword">private</span> ILogger&lt;SseService&gt; _logger;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SseService</span>(<span class="hljs-params">ILogger&lt;SseService&gt; logger</span>)</span>
    {
        _logger = logger;
    }

    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> 存储所有活动的客户端连接</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> 使用线程安全的字典存储客户端ID和对应的HttpResponse</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ConcurrentDictionary&lt;<span class="hljs-built_in">string</span>, HttpResponse&gt; _clients = <span class="hljs-keyword">new</span>();

    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> 添加新的 SSE 客户端连接到管理器</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="clientId"&gt;</span>客户端唯一标识符<span class="hljs-doctag">&lt;/param&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="response"&gt;</span>HTTP 响应对象<span class="hljs-doctag">&lt;/param&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>异步任务<span class="hljs-doctag">&lt;/returns&gt;</span></span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">AddClientAsync</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> clientId, HttpResponse response</span>)</span>
    {
        <span class="hljs-comment">// 将客户端添加到连接字典中</span>
        _clients.TryAdd(clientId, response);
        <span class="hljs-comment">// 发送连接确认事件给客户端</span>
        <span class="hljs-keyword">await</span> SendEventAsync(clientId, <span class="hljs-string">"connection"</span>, <span class="hljs-string">$"Connected with ID: <span class="hljs-subst">{clientId}</span>"</span>);
    }

    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> 从管理器中移除指定的客户端连接</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="clientId"&gt;</span>要移除的客户端ID<span class="hljs-doctag">&lt;/param&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>异步任务<span class="hljs-doctag">&lt;/returns&gt;</span></span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">RemoveClientAsync</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> clientId</span>)</span>
    {
        <span class="hljs-comment">// 尝试从字典中移除客户端并获取其响应对象</span>
        <span class="hljs-keyword">if</span> (_clients.TryRemove(clientId, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> response))
        {
            <span class="hljs-comment">// 完成 HTTP 响应</span>
            <span class="hljs-comment">//await response.CompleteAsync(); </span>
            <span class="hljs-comment">// 清空缓冲区并关闭流。这实际上等同于完成了响应。但更常用的是不需要手动调用此方法。 </span>
            <span class="hljs-keyword">await</span> response.Body.FlushAsync();
        }
    }

    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> 向指定客户端发送默认类型的事件消息</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="clientId"&gt;</span>目标客户端ID<span class="hljs-doctag">&lt;/param&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="data"&gt;</span>要发送的数据<span class="hljs-doctag">&lt;/param&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>异步任务<span class="hljs-doctag">&lt;/returns&gt;</span></span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">SendEventAsync</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> clientId, <span class="hljs-built_in">string</span> data</span>)</span>
    {
        <span class="hljs-comment">// 调用重载方法，使用默认的消息类型</span>
        <span class="hljs-keyword">await</span> SendEventAsync(clientId, <span class="hljs-string">"message"</span>, data);
    }

    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> 向指定客户端发送指定类型的事件消息</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="clientId"&gt;</span>目标客户端ID<span class="hljs-doctag">&lt;/param&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="eventType"&gt;</span>事件类型（如：message, notification, update等）<span class="hljs-doctag">&lt;/param&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="data"&gt;</span>要发送的数据内容<span class="hljs-doctag">&lt;/param&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>异步任务<span class="hljs-doctag">&lt;/returns&gt;</span></span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">SendEventAsync</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> clientId, <span class="hljs-built_in">string</span> eventType, <span class="hljs-built_in">string</span> data</span>)</span>
    {
        <span class="hljs-comment">// 检查客户端是否仍然连接</span>
        <span class="hljs-keyword">if</span> (_clients.TryGetValue(clientId, <span class="hljs-keyword">out</span> <span class="hljs-keyword">var</span> response))
        {
            <span class="hljs-keyword">try</span>
            {
                <span class="hljs-comment">// 按照 SSE 格式写入事件类型</span>
                <span class="hljs-keyword">await</span> response.WriteAsync(<span class="hljs-string">$"event: <span class="hljs-subst">{eventType}</span>\n"</span>);
                <span class="hljs-comment">// 按照 SSE 格式写入数据内容</span>
                <span class="hljs-keyword">await</span> response.WriteAsync(<span class="hljs-string">$"data: <span class="hljs-subst">{data}</span>\n\n"</span>);
                <span class="hljs-comment">// 刷新响应流，确保数据立即发送到客户端</span>
                <span class="hljs-keyword">await</span> response.Body.FlushAsync();
            }
            <span class="hljs-keyword">catch</span>
            {
                <span class="hljs-comment">// 如果发生异常（如客户端断开连接），则移除该客户端</span>
                <span class="hljs-keyword">await</span> RemoveClientAsync(clientId);
            }
        }
    }

    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> 向所有连接的客户端广播消息</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="data"&gt;</span>要广播的数据<span class="hljs-doctag">&lt;/param&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>异步任务<span class="hljs-doctag">&lt;/returns&gt;</span></span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">BroadcastAsync</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> data</span>)</span>
    {
        <span class="hljs-comment">// 为每个客户端创建发送任务并等待全部完成</span>
        <span class="hljs-keyword">var</span> tasks = _clients.Keys.Select(clientId =&gt; SendEventAsync(clientId, data));
        <span class="hljs-keyword">await</span> Task.WhenAll(tasks);
    }

    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> 向所有连接的客户端广播指定类型的事件</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="eventType"&gt;</span>事件类型<span class="hljs-doctag">&lt;/param&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="data"&gt;</span>要广播的数据<span class="hljs-doctag">&lt;/param&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>异步任务<span class="hljs-doctag">&lt;/returns&gt;</span></span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">BroadcastAsync</span>(<span class="hljs-params"><span class="hljs-built_in">string</span> eventType, <span class="hljs-built_in">string</span> data</span>)</span>
    {
        <span class="hljs-comment">// 为每个客户端创建发送任务并等待全部完成</span>
        <span class="hljs-keyword">var</span> tasks = _clients.Keys.Select(clientId =&gt; SendEventAsync(clientId, eventType, data));
        <span class="hljs-keyword">await</span> Task.WhenAll(tasks);
    }
}
</code></pre>
<h3 data-id="heading-5">模拟发送数据</h3>
<pre><code class="hljs language-C#" lang="C#">这里只是为了模拟数据,具体可根据自己的业务做出调整

    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> SSE 后台服务</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> 定期向所有连接的客户端推送数据更新</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">SseBackgroundService</span> : <span class="hljs-title">BackgroundService</span>
    {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ISseService _sseService;
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 日志记录器，用于记录服务运行状态和错误信息</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ILogger&lt;SseBackgroundService&gt; _logger;

        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 构造函数，通过依赖注入获取所需的服务</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="scopeFactory"&gt;</span>服务作用域工厂<span class="hljs-doctag">&lt;/param&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="logger"&gt;</span>日志记录器<span class="hljs-doctag">&lt;/param&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SseBackgroundService</span>(<span class="hljs-params">ISseService sseService, ILogger&lt;SseBackgroundService&gt; logger</span>)</span>
        {
            _sseService = sseService;
            _logger = logger;
        }

        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 后台服务执行方法</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> 定期执行任务直到服务停止</span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="stoppingToken"&gt;</span>服务停止通知令牌<span class="hljs-doctag">&lt;/param&gt;</span></span>
        <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;returns&gt;</span>异步任务<span class="hljs-doctag">&lt;/returns&gt;</span></span>
        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">ExecuteAsync</span>(<span class="hljs-params">CancellationToken stoppingToken</span>)</span>
        {
            <span class="hljs-comment">// 循环执行直到收到停止信号</span>
            <span class="hljs-keyword">while</span> (!stoppingToken.IsCancellationRequested)
            {
                <span class="hljs-keyword">try</span>
                {
                    <span class="hljs-comment">// 准备要广播的事件数据</span>
                    <span class="hljs-keyword">var</span> eventData = <span class="hljs-keyword">new</span>
                    {
                        timestamp = DateTime.UtcNow,                    <span class="hljs-comment">// 当前 UTC 时间戳</span>
                        message = <span class="hljs-string">"Server time update"</span>,                 <span class="hljs-comment">// 消息内容</span>
                        temperature = Random.Shared.Next(<span class="hljs-number">20</span>, <span class="hljs-number">30</span>)        <span class="hljs-comment">// 模拟温度数据</span>
                    };

                    <span class="hljs-comment">// 将事件数据广播给所有连接的客户端</span>
                    <span class="hljs-keyword">await</span> _sseService.BroadcastAsync(<span class="hljs-string">"time-update"</span>, JsonSerializer.Serialize(eventData));

                    <span class="hljs-comment">// 等待 5 秒后继续下一次循环，支持取消操作</span>
                    <span class="hljs-keyword">await</span> Task.Delay(TimeSpan.FromSeconds(<span class="hljs-number">5</span>), stoppingToken);
                }
                <span class="hljs-keyword">catch</span> (Exception ex)
                {
                    <span class="hljs-comment">// 记录执行过程中发生的异常</span>
                    _logger.LogError(ex, <span class="hljs-string">"Error in SSE background service"</span>);
                }
            }
        }
    }
</code></pre>
<h3 data-id="heading-6">其他配置</h3>
<pre><code class="hljs language-C#" lang="C#"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
{
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>(<span class="hljs-params"><span class="hljs-built_in">string</span>[] args</span>)</span>
    {
        <span class="hljs-keyword">var</span> builder = WebApplication.CreateBuilder(args);

        ConfigureAutofac(builder);

        <span class="hljs-comment">// Add services to the container.</span>
        builder.Services.AddControllers();

        builder.Services.AddEndpointsApiExplorer();
        builder.Services.AddSwaggerGen();

        <span class="hljs-keyword">var</span> app = builder.Build();
        <span class="hljs-comment">// Configure the HTTP request pipeline.</span>
        <span class="hljs-keyword">if</span> (app.Environment.IsDevelopment())
        {
            app.UseSwagger();
            app.UseSwaggerUI();
        }

        app.UseHttpsRedirection();
        app.UseAuthorization();
        app.MapControllers();
        app.Run();
    }

    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> 配置 Autofac</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;param name="builder"&gt;</span><span class="hljs-doctag">&lt;/param&gt;</span></span>
    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureAutofac</span>(<span class="hljs-params">WebApplicationBuilder builder</span>)</span>
    {
        <span class="hljs-comment">// 配置 Autofac 作为 DI 容器</span>
        builder.Host.UseServiceProviderFactory(<span class="hljs-keyword">new</span> AutofacServiceProviderFactory());

        <span class="hljs-comment">// 配置容器注册</span>
        builder.Host.ConfigureContainer&lt;ContainerBuilder&gt;(containerBuilder =&gt;
        {
            <span class="hljs-comment">// 重点内容，这里必须要注册成单例模式</span>
            containerBuilder.RegisterType&lt;SseService&gt;().As&lt;ISseService&gt;().SingleInstance();
            <span class="hljs-comment">// Autofac注册</span>
            containerBuilder.RegisterModule(<span class="hljs-keyword">new</span> AutofacModuleRegister());
            <span class="hljs-comment">// 注册后台服务，项目启动时就会执行</span>
            containerBuilder.RegisterType&lt;SseBackgroundService&gt;().As&lt;IHostedService&gt;();
        });
    }
}
</code></pre>
<h3 data-id="heading-7">前端代码</h3>
<pre><code class="hljs language-JS" lang="JS">&lt;script&gt;
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">sendMessage</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 连接到 SSE 流</span>
        <span class="hljs-keyword">const</span> clientId = <span class="hljs-string">'client-'</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>().<span class="hljs-title function_">toString</span>(<span class="hljs-number">36</span>).<span class="hljs-title function_">substr</span>(<span class="hljs-number">2</span>, <span class="hljs-number">9</span>);
        <span class="hljs-keyword">const</span> eventSource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EventSource</span>(<span class="hljs-string">`替换成你的域名/api/sse/stream?clientId=<span class="hljs-subst">${clientId}</span>`</span>);

        eventSource.<span class="hljs-property">onopen</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'SSE connection opened'</span>);
        };

        eventSource.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Message received:'</span>, event.<span class="hljs-property">data</span>);
        };

        eventSource.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'connection'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Connection event:'</span>, event.<span class="hljs-property">data</span>);
        });

        eventSource.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'time-update'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
            <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(event.<span class="hljs-property">data</span>);
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Time update:'</span>, data);
            <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'server-time'</span>).<span class="hljs-property">innerText</span> = data.<span class="hljs-property">timestamp</span>;
        });

        eventSource.<span class="hljs-property">onerror</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'SSE error occurred'</span>);
        };
    }
        
&lt;/script&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-center"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"Send message"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"sendMessage()"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>

</code></pre>
<h3 data-id="heading-8">最后效果</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7232f428961947089094012115f48196~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bmM5omNX2xvb25n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765360290&amp;x-signature=rpQs4gsA5ciwLpzqn62ISlD%2FEcI%3D" alt="81607923-dbcd-4be4-854c-89d2042e6dad.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Paimon Branch --- 流批一体化之二]]></title>    <link>https://juejin.cn/post/7579427549471752238</link>    <guid>https://juejin.cn/post/7579427549471752238</guid>    <pubDate>2025-12-03T09:25:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579427549471752238" data-draft-id="7579451710302044186" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Paimon Branch --- 流批一体化之二"/> <meta itemprop="keywords" content="后端,大数据,Flink"/> <meta itemprop="datePublished" content="2025-12-03T09:25:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="expect7g"/> <meta itemprop="url" content="https://juejin.cn/user/3514471387235735"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Paimon Branch --- 流批一体化之二
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3514471387235735/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    expect7g
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T09:25:12.000Z" title="Wed Dec 03 2025 09:25:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Branch是什么？</h2>
<p>可以理解为是git的分支，分为主分支、dev分支等等，而最后读取的时候就相当于是分支的一个merge合并</p>
<p>在流式数据处理中，数据可能因为乱序等问题，存在不准确的情况，这是实时的通病，而实时修正数据存在困难，那么为了解决这个补数的情况，因此Paimon推出了Branch分支机制。</p>
<p>假设现有工作流处理的分支为“主分支”，通过创建自定义数据分支，可在不停止现有读写工作流且无需复制主分支数据的前提下，对现有表进行新任务的实验测试与数据验证。</p>
<p>借助合并或替换分支操作，即可完成数据修正工作。</p>
<h3 data-id="heading-1">(1) Branch的创建和删除</h3>
<p>首先需要创建branch，Paimon支持从特定标签创建分支，或直接创建空分支——这意味着创建的分支初始状态如同空白表格。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 从tag1中对table1创建test-branch分支</span>
<span class="hljs-keyword">CALL</span> sys.create_branch(<span class="hljs-string">'default.table1'</span>, <span class="hljs-string">'test-branch'</span>, <span class="hljs-string">'tag1'</span>);

<span class="hljs-comment">-- 直接对table2创建一个空的tese-branch2分支</span>
<span class="hljs-keyword">CALL</span> sys.create_branch(<span class="hljs-string">'default.table2'</span>, <span class="hljs-string">'test-branch2'</span>);

<span class="hljs-comment">-- 删除指定branch</span>
<span class="hljs-keyword">CALL</span> sys.delete_branch(<span class="hljs-string">'default.table3'</span>, <span class="hljs-string">'branch1'</span>);
</code></pre>
<h3 data-id="heading-2">(2) Branch的使用 -- 读写</h3>
<p>默认Branch分支是main，并且Branch有默认的前缀是branch_</p>
<p>因此，如果我们想读写特定的Branch，有2种方式</p>
<h4 data-id="heading-3">&lt;1&gt; 方式一：sql就指定好，读写那个Branch</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 对表t从Branch为test-branch去读数据</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> `t$branch_test<span class="hljs-operator">-</span>branch`; <span class="hljs-comment">-- 批</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> `t$branch_test<span class="hljs-operator">-</span>branch` <span class="hljs-comment">/*+ OPTIONS('consumer-id' = 'myid') */</span>; <span class="hljs-comment">-- 流</span>

<span class="hljs-comment">-- 往表t的test2分支去写</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `t$branch_test2` 
<span class="hljs-keyword">SELECT</span> ...
</code></pre>
<h4 data-id="heading-4">&lt;2&gt; 方式二：采用Fallback Branch -- 流批一体之二</h4>
<p>这个原理就是：设置为fallback分支后, 当查询/写入的分区在主分支不存在时，paimon reader会从<code>scan.fallback-branch</code>指定的分支去进行操作</p>
<p>因此，就可以针对流批一体做一些操作，比如离线的批数据正常写入到昨日的分区中，而实时数据写到今日的Fallback Branch分支的分区中</p>
<p>案例如下：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1.创建一个T表，按照dt分区</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> T (
    dt STRING <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    name STRING <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    amount <span class="hljs-type">BIGINT</span>
) PARTITIONED <span class="hljs-keyword">BY</span> (dt);

<span class="hljs-comment">-- 2.为流处理创建一个Branch，叫test</span>
<span class="hljs-keyword">CALL</span> sys.create_branch(<span class="hljs-string">'default.T'</span>, <span class="hljs-string">'test'</span>);

<span class="hljs-comment">-- 3.对test分支进行修改属性</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> `T$branch_test` <span class="hljs-keyword">SET</span> (
    <span class="hljs-string">'primary-key'</span> <span class="hljs-operator">=</span> <span class="hljs-string">'dt,name'</span>,
    <span class="hljs-string">'bucket'</span> <span class="hljs-operator">=</span> <span class="hljs-string">'2'</span>,
    <span class="hljs-string">'changelog-producer'</span> <span class="hljs-operator">=</span> <span class="hljs-string">'lookup'</span>
);

<span class="hljs-comment">-- 4.设置Fallback Branch 为 test分支</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> T <span class="hljs-keyword">SET</span> (
    <span class="hljs-string">'scan.fallback-branch'</span> <span class="hljs-operator">=</span> <span class="hljs-string">'test'</span>
);

<span class="hljs-comment">-- 5.流式写入，写入到T表的test分支的20240726分区中</span>
(这里如果全部都是<span class="hljs-number">20250726</span>分区的数据，那么也可以不写$branch_test，因为T表是没有<span class="hljs-number">20240726</span>分区的，会去Fallback Branch分支中操作，但是建议是带上$branch_test)
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> `T$branch_test` <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'20240725'</span>, <span class="hljs-string">'apple'</span>, <span class="hljs-number">4</span>), (<span class="hljs-string">'20240725'</span>, <span class="hljs-string">'peach'</span>, <span class="hljs-number">10</span>), (<span class="hljs-string">'20240726'</span>, <span class="hljs-string">'cherry'</span>, <span class="hljs-number">3</span>), (<span class="hljs-string">'20240726'</span>, <span class="hljs-string">'pear'</span>, <span class="hljs-number">6</span>);

<span class="hljs-comment">-- 6.批式写入T的主分支</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> T <span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'20240725'</span>, <span class="hljs-string">'apple'</span>, <span class="hljs-number">5</span>), (<span class="hljs-string">'20240725'</span>, <span class="hljs-string">'banana'</span>, <span class="hljs-number">7</span>);

<span class="hljs-comment">-- 7.查表的时候，引擎会合并Branch分支的数据，因此查询，是能查到20240726分区的数据的</span>
<span class="hljs-comment">-- 合并的逻辑是main没有的分区，从Fallback Branch中拿数据，main有的分区，从main拿</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> T;
<span class="hljs-comment">/*
+------------------+------------------+--------+
|               dt |             name | amount |
+------------------+------------------+--------+
|         20240725 |            apple |      5 |
|         20240725 |           banana |      7 |
|         20240726 |           cherry |      3 |
|         20240726 |             pear |      6 |
+------------------+------------------+--------+
*/</span>

<span class="hljs-comment">-- 重置fallback branch</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> T RESET ( <span class="hljs-string">'scan.fallback-branch'</span> );

<span class="hljs-comment">-- 这样读的话，就只能读main主分支的数据了</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> T;
<span class="hljs-comment">/*
+------------------+------------------+--------+
|               dt |             name | amount |
+------------------+------------------+--------+
|         20240725 |            apple |      5 |
|         20240725 |           banana |      7 |
+------------------+------------------+--------+
*/</span>
</code></pre>
<h3 data-id="heading-5">(3) 总结</h3>
<p>针对实时数据不准确，需要补数，修改的操作，传统做法是离线覆盖实时昨日，分别落两个表，维护两套系统，这对开发而已是很浪费资源的问题，因此，Paimon推出了Branch操作，去实现一套sql一张表，不同的Branch去存实时和离线的数据，互相不影响，查询的时候又能既查出实时的，也查出离线的</p>
<p>方案就是：</p>
<ol>
<li>离线跑main主分支，直接insert overwrite/into</li>
<li>实时的跑Fallback Branch指定分支，只能insert into</li>
<li>查询时，Paimon reader会去合并：<strong>优先读取主分支（main）的分区数据；如果 main 分支没有该分区，才从 Fallback Branch 读取该分区的补充数据</strong></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 抽象类 vs 接口：相同点与不同点]]></title>    <link>https://juejin.cn/post/7579313396207665167</link>    <guid>https://juejin.cn/post/7579313396207665167</guid>    <pubDate>2025-12-03T09:27:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579313396207665167" data-draft-id="7579385656779964450" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 抽象类 vs 接口：相同点与不同点"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-03T09:27:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小周在成长"/> <meta itemprop="url" content="https://juejin.cn/user/3632442150752573"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 抽象类 vs 接口：相同点与不同点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3632442150752573/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小周在成长
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T09:27:36.000Z" title="Wed Dec 03 2025 09:27:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🎯 快速对比表</h2>


















































<table><thead><tr><th>特性</th><th>抽象类</th><th>接口</th></tr></thead><tbody><tr><td><strong>关键字</strong></td><td><code>abstract class</code></td><td><code>interface</code></td></tr><tr><td><strong>实例化</strong></td><td>❌ 不能</td><td>❌ 不能</td></tr><tr><td><strong>继承/实现</strong></td><td>单继承</td><td>多实现</td></tr><tr><td><strong>方法类型</strong></td><td>抽象 + 具体</td><td>默认只有抽象（Java 8前）</td></tr><tr><td><strong>构造器</strong></td><td>✅ 有</td><td>❌ 无</td></tr><tr><td><strong>变量</strong></td><td>任意类型</td><td>只能是常量</td></tr><tr><td><strong>访问修饰符</strong></td><td>任意</td><td>默认 <code>public</code></td></tr><tr><td><strong>设计目的</strong></td><td>代码复用 + 规范</td><td>定义契约/能力</td></tr></tbody></table>
<h2 data-id="heading-1">🔍 相同点</h2>
<h3 data-id="heading-2"><strong>1. 都不能被实例化</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 抽象类不能实例化</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractClass</span> {
    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span>;
}

<span class="hljs-comment">// 接口不能实例化</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Interface</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CannotInstantiate</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// ❌ 两者都不能直接new</span>
        <span class="hljs-comment">// AbstractClass obj1 = new AbstractClass();  // 编译错误</span>
        <span class="hljs-comment">// Interface obj2 = new Interface();         // 编译错误</span>
    }
}
</code></pre>
<h3 data-id="heading-3"><strong>2. 都可以有抽象方法</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AnimalClass</span> {
    <span class="hljs-comment">// 抽象类可以有抽象方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">makeSound</span><span class="hljs-params">()</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">AnimalInterface</span> {
    <span class="hljs-comment">// 接口方法默认是抽象的</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">makeSound</span><span class="hljs-params">()</span>;  <span class="hljs-comment">// 等价于 public abstract void makeSound()</span>
}

<span class="hljs-comment">// 子类/实现类必须实现抽象方法</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AnimalClass</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">makeSound</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"汪汪"</span>);
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AnimalInterface</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">makeSound</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"喵喵"</span>);
    }
}
</code></pre>
<h3 data-id="heading-4"><strong>3. 都支持多态</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shape</span> {
    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">draw</span><span class="hljs-params">()</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Drawable</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">draw</span><span class="hljs-params">()</span>;
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Circle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Shape</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">draw</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"画圆形"</span>);
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Square</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Drawable</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">draw</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"画正方形"</span>);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PolymorphismDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 抽象类的多态</span>
        <span class="hljs-type">Shape</span> <span class="hljs-variable">shape</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Circle</span>();
        shape.draw();  <span class="hljs-comment">// 画圆形</span>
        
        <span class="hljs-comment">// 接口的多态</span>
        <span class="hljs-type">Drawable</span> <span class="hljs-variable">drawable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Square</span>();
        drawable.draw();  <span class="hljs-comment">// 画正方形</span>
        
        <span class="hljs-comment">// 都可以用数组统一管理</span>
        Shape[] shapes = {<span class="hljs-keyword">new</span> <span class="hljs-title class_">Circle</span>()};
        Drawable[] drawables = {<span class="hljs-keyword">new</span> <span class="hljs-title class_">Square</span>()};
    }
}
</code></pre>
<h2 data-id="heading-5">⚡ 不同点</h2>
<h3 data-id="heading-6"><strong>1. 继承 vs 实现（核心区别）</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 单继承：一个类只能继承一个抽象类</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Vehicle</span> {
    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">move</span><span class="hljs-params">()</span>;
}

<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Engine</span> {
    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span>;
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Car</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Vehicle</span> {
    <span class="hljs-comment">// ✅ 正确：只能继承一个抽象类</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">move</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"汽车行驶"</span>);
    }
}

<span class="hljs-comment">/*
class HybridCar extends Vehicle, Engine {  
    // ❌ 错误：不能继承多个抽象类
}
*/</span>

<span class="hljs-comment">// 多实现：一个类可以实现多个接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Flyable</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">fly</span><span class="hljs-params">()</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Swimmable</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">swim</span><span class="hljs-params">()</span>;
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Duck</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Flyable</span>, Swimmable {
    <span class="hljs-comment">// ✅ 正确：可以实现多个接口</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fly</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"鸭子飞"</span>);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">swim</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"鸭子游"</span>);
    }
}

<span class="hljs-comment">// 组合：可以继承一个类 + 实现多个接口</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AmphibiousVehicle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Vehicle</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Flyable</span>, Swimmable {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">move</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"两栖车移动"</span>);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fly</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"两栖车飞行模式"</span>);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">swim</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"两栖车游泳模式"</span>);
    }
}
</code></pre>
<h3 data-id="heading-7"><strong>2. 方法实现能力（Java 8+）</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractExample</span> {
    <span class="hljs-comment">// 1. 可以有抽象方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">abstractMethod</span><span class="hljs-params">()</span>;
    
    <span class="hljs-comment">// 2. 可以有具体方法（一直都可以）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">concreteMethod</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"抽象类的具体方法"</span>);
    }
    
    <span class="hljs-comment">// 3. 可以有构造器</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AbstractExample</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"抽象类构造器"</span>);
    }
    
    <span class="hljs-comment">// 4. 可以有静态方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">staticMethod</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"抽象类静态方法"</span>);
    }
    
    <span class="hljs-comment">// 5. 可以有final方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">finalMethod</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"抽象类final方法"</span>);
    }
    
    <span class="hljs-comment">// 6. 可以有private方法</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">privateMethod</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"抽象类私有方法"</span>);
    }
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">InterfaceExample</span> {
    <span class="hljs-comment">// 1. 抽象方法（Java 8前唯一允许的方法）</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">abstractMethod</span><span class="hljs-params">()</span>;
    
    <span class="hljs-comment">// 2. 默认方法（Java 8+）</span>
    <span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">defaultMethod</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"接口的默认方法"</span>);
        privateMethod();  <span class="hljs-comment">// 调用私有方法</span>
    }
    
    <span class="hljs-comment">// 3. 静态方法（Java 8+）</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">staticMethod</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"接口的静态方法"</span>);
    }
    
    <span class="hljs-comment">// 4. 私有方法（Java 9+）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">privateMethod</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"接口的私有方法"</span>);
    }
    
    <span class="hljs-comment">// 5. 私有静态方法（Java 9+）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">privateStaticMethod</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"接口的私有静态方法"</span>);
    }
    
    <span class="hljs-comment">// ❌ 不能有构造器</span>
    <span class="hljs-comment">// InterfaceExample() { }  // 编译错误</span>
    
    <span class="hljs-comment">// ❌ 不能有final方法</span>
    <span class="hljs-comment">// final void finalMethod();  // 编译错误</span>
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Implementation</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InterfaceExample</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">abstractMethod</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"实现抽象方法"</span>);
    }
}
</code></pre>
<h3 data-id="heading-8"><strong>3. 变量/字段的区别</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractVars</span> {
    <span class="hljs-comment">// 1. 可以有实例变量</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-type">String</span> <span class="hljs-variable">instanceVar</span> <span class="hljs-operator">=</span> <span class="hljs-string">"实例变量"</span>;
    
    <span class="hljs-comment">// 2. 可以有非常量</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">counter</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    
    <span class="hljs-comment">// 3. 可以有静态变量</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">String</span> <span class="hljs-variable">staticVar</span> <span class="hljs-operator">=</span> <span class="hljs-string">"静态变量"</span>;
    
    <span class="hljs-comment">// 4. 可以有final变量</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">finalVar</span> <span class="hljs-operator">=</span> <span class="hljs-string">"final变量"</span>;
    
    <span class="hljs-comment">// 5. 访问修饰符可以是任意的</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">privateVar</span> <span class="hljs-operator">=</span> <span class="hljs-string">"私有变量"</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-type">String</span> <span class="hljs-variable">protectedVar</span> <span class="hljs-operator">=</span> <span class="hljs-string">"受保护变量"</span>;
    <span class="hljs-type">String</span> <span class="hljs-variable">defaultVar</span> <span class="hljs-operator">=</span> <span class="hljs-string">"默认变量"</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-variable">publicVar</span> <span class="hljs-operator">=</span> <span class="hljs-string">"公共变量"</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">InterfaceVars</span> {
    <span class="hljs-comment">// 1. 所有变量默认是 public static final</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">CONSTANT</span> <span class="hljs-operator">=</span> <span class="hljs-string">"常量"</span>;
    
    <span class="hljs-comment">// 等价于：</span>
    <span class="hljs-comment">// public static final String CONSTANT = "常量";</span>
    
    <span class="hljs-comment">// ❌ 不能有实例变量</span>
    <span class="hljs-comment">// String instanceVar;  // 编译错误</span>
    
    <span class="hljs-comment">// ❌ 不能有非final变量</span>
    <span class="hljs-comment">// int counter = 0;     // 实际上是常量</span>
    
    <span class="hljs-comment">// 2. 只能是public</span>
    <span class="hljs-comment">// private String privateVar = "错误";  // 编译错误</span>
    <span class="hljs-comment">// protected String protectedVar = "错误";  // 编译错误</span>
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VariablesDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        System.out.println(<span class="hljs-string">"抽象类变量: "</span> + AbstractVars.staticVar);
        System.out.println(<span class="hljs-string">"接口常量: "</span> + InterfaceVars.CONSTANT);
        
        <span class="hljs-comment">// 接口常量不能修改</span>
        <span class="hljs-comment">// InterfaceVars.CONSTANT = "新值";  // 编译错误</span>
    }
}
</code></pre>
<h3 data-id="heading-9"><strong>4. 构造器的区别</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractWithConstructor</span> {
    <span class="hljs-keyword">private</span> String name;
    
    <span class="hljs-comment">// 抽象类可以有构造器</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AbstractWithConstructor</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-built_in">this</span>.name = name;
        System.out.println(<span class="hljs-string">"抽象类构造器调用: "</span> + name);
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSomething</span><span class="hljs-params">()</span>;
    
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> name;
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ConcreteClass</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractWithConstructor</span> {
    <span class="hljs-comment">// 子类必须调用父类构造器</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ConcreteClass</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-built_in">super</span>(name);  <span class="hljs-comment">// 必须调用</span>
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doSomething</span><span class="hljs-params">()</span> {
        System.out.println(getName() + <span class="hljs-string">"在做事情"</span>);
    }
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">NoConstructor</span> {
    <span class="hljs-comment">// ❌ 接口不能有构造器</span>
    <span class="hljs-comment">// NoConstructor() { }  // 编译错误</span>
    
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConstructorDemo</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ConcreteClass</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcreteClass</span>(<span class="hljs-string">"测试"</span>);
        obj.doSomething();
    }
}
</code></pre>
<h3 data-id="heading-10"><strong>5. 访问修饰符的区别</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccessModifiers</span> {
    <span class="hljs-comment">// 所有访问修饰符都可以用</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">privateMethod</span><span class="hljs-params">()</span> {}
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">defaultMethod</span><span class="hljs-params">()</span> {}
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">protectedMethod</span><span class="hljs-params">()</span> {}
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">publicMethod</span><span class="hljs-params">()</span> {}
    
    <span class="hljs-comment">// 抽象方法不能是private</span>
    <span class="hljs-comment">// private abstract void privateAbstract();  // 编译错误</span>
    
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">protectedAbstract</span><span class="hljs-params">()</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">publicAbstract</span><span class="hljs-params">()</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">InterfaceAccess</span> {
    <span class="hljs-comment">// 接口方法默认是public</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span>;  <span class="hljs-comment">// 等价于 public abstract void method()</span>
    
    <span class="hljs-comment">// Java 9+ 可以有private方法</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">privateMethod</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"接口私有方法"</span>);
    }
    
    <span class="hljs-comment">// 不能是protected或默认</span>
    <span class="hljs-comment">// protected void protectedMethod();  // 编译错误</span>
    <span class="hljs-comment">// void defaultMethod();              // 编译错误（Java 8前）</span>
    
    <span class="hljs-comment">// Java 8+ 默认方法可以是public</span>
    <span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">defaultPublicMethod</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"默认公共方法"</span>);
    }
}
</code></pre>
<h2 data-id="heading-11">💡 何时使用抽象类 vs 接口</h2>
<h3 data-id="heading-12"><strong>1. 使用抽象类的情况</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 场景1：多个相关类共享代码</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Database</span> {
    <span class="hljs-comment">// 共享的连接逻辑</span>
    <span class="hljs-keyword">protected</span> Connection <span class="hljs-title function_">connect</span><span class="hljs-params">(String url)</span> {
        System.out.println(<span class="hljs-string">"连接到: "</span> + url);
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Connection</span>();
    }
    
    <span class="hljs-comment">// 共享的关闭逻辑</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">(Connection conn)</span> {
        System.out.println(<span class="hljs-string">"关闭连接"</span>);
    }
    
    <span class="hljs-comment">// 模板方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeQuery</span><span class="hljs-params">(String sql)</span> {
        <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> connect(getUrl());
        <span class="hljs-keyword">try</span> {
            execute(sql, conn);
        } <span class="hljs-keyword">finally</span> {
            close(conn);
        }
    }
    
    <span class="hljs-comment">// 子类必须实现</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> String <span class="hljs-title function_">getUrl</span><span class="hljs-params">()</span>;
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(String sql, Connection conn)</span>;
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MySQLDatabase</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Database</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">getUrl</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"jdbc:mysql://localhost:3306/db"</span>;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(String sql, Connection conn)</span> {
        System.out.println(<span class="hljs-string">"执行MySQL查询: "</span> + sql);
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">OracleDatabase</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Database</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> String <span class="hljs-title function_">getUrl</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"jdbc:oracle:thin:@localhost:1521:orcl"</span>;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">execute</span><span class="hljs-params">(String sql, Connection conn)</span> {
        System.out.println(<span class="hljs-string">"执行Oracle查询: "</span> + sql);
    }
}
</code></pre>
<h3 data-id="heading-13"><strong>2. 使用接口的情况</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 场景1：定义能力/契约</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Comparable</span>&lt;T&gt; {
    <span class="hljs-type">int</span> <span class="hljs-title function_">compareTo</span><span class="hljs-params">(T other)</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-comment">// 标记接口</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Cloneable</span> {
    <span class="hljs-comment">// 标记接口</span>
}

<span class="hljs-comment">// 场景2：多重继承</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Worker</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">work</span><span class="hljs-params">()</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Student</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">study</span><span class="hljs-params">()</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">Athlete</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">train</span><span class="hljs-params">()</span>;
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CollegeStudent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Student</span>, Worker, Athlete {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">work</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"兼职工作"</span>);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">study</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"学习课程"</span>);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">train</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"体育训练"</span>);
    }
}

<span class="hljs-comment">// 场景3：回调机制</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ClickListener</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">()</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">TextChangedListener</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onTextChanged</span><span class="hljs-params">(String newText)</span>;
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Button</span> {
    <span class="hljs-keyword">private</span> ClickListener listener;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setClickListener</span><span class="hljs-params">(ClickListener listener)</span> {
        <span class="hljs-built_in">this</span>.listener = listener;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">click</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">if</span> (listener != <span class="hljs-literal">null</span>) {
            listener.onClick();
        }
    }
}
</code></pre>
<h3 data-id="heading-14"><strong>3. 结合使用（常见模式）</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 抽象类提供骨架实现</span>
<span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractList</span>&lt;E&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">List</span>&lt;E&gt; {
    <span class="hljs-comment">// 提供通用实现</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">add</span><span class="hljs-params">(E e)</span> {
        add(size(), e);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-comment">// 抽象方法由子类实现</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> index, E element)</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> E <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span>;
}

<span class="hljs-comment">// 接口定义契约</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">List</span>&lt;E&gt; {
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">add</span><span class="hljs-params">(E e)</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> index, E element)</span>;
    E <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span>;
    <span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span>;
}

<span class="hljs-comment">// 具体实现</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ArrayList</span>&lt;E&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractList</span>&lt;E&gt; {
    <span class="hljs-keyword">private</span> Object[] elements = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">10</span>];
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> index, E element)</span> {
        <span class="hljs-comment">// 实现细节</span>
        System.out.println(<span class="hljs-string">"ArrayList添加元素"</span>);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> E <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-type">int</span> index)</span> {
        <span class="hljs-comment">// 实现细节</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> size;
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CombinedUsage</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        List&lt;String&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        list.add(<span class="hljs-string">"Hello"</span>);
        System.out.println(<span class="hljs-string">"大小: "</span> + list.size());
    }
}
</code></pre>
<h2 data-id="heading-15">📝 现代Java中的变化（Java 8+）</h2>
<h3 data-id="heading-16"><strong>接口的增强</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java 8 前：接口只能有抽象方法</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">OldInterface</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span>;  <span class="hljs-comment">// 只能是抽象方法</span>
}

<span class="hljs-comment">// Java 8+：接口可以有多样方法</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">ModernInterface</span> {
    <span class="hljs-comment">// 1. 抽象方法</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">abstractMethod</span><span class="hljs-params">()</span>;
    
    <span class="hljs-comment">// 2. 默认方法</span>
    <span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">defaultMethod</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"默认实现"</span>);
        privateMethod();
    }
    
    <span class="hljs-comment">// 3. 静态方法</span>
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">staticMethod</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"静态方法"</span>);
        privateStaticMethod();
    }
    
    <span class="hljs-comment">// 4. 私有方法（Java 9+）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">privateMethod</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"私有实例方法"</span>);
    }
    
    <span class="hljs-comment">// 5. 私有静态方法（Java 9+）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">privateStaticMethod</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"私有静态方法"</span>);
    }
}

<span class="hljs-comment">// 现在接口 ≈ 抽象类，但仍有区别：</span>
<span class="hljs-comment">// 1. 接口仍然不能有构造器</span>
<span class="hljs-comment">// 2. 接口仍然不能有实例变量</span>
<span class="hljs-comment">// 3. 接口仍然支持多重继承</span>
</code></pre>
<h2 data-id="heading-17">🎓 记忆口诀</h2>
<pre><code class="hljs language-markdown" lang="markdown">相同点：
<span class="hljs-bullet">1.</span> 都不能new（不能实例化）
<span class="hljs-bullet">2.</span> 都能有抽象方法
<span class="hljs-bullet">3.</span> 都支持多态

不同点：
抽象类：
<span class="hljs-bullet">-</span> 单继承
<span class="hljs-bullet">-</span> 有构造器
<span class="hljs-bullet">-</span> 有具体方法（一直都有）
<span class="hljs-bullet">-</span> 有各种变量
<span class="hljs-bullet">-</span> 设计：是什么（is-a）

接口：
<span class="hljs-bullet">-</span> 多实现
<span class="hljs-bullet">-</span> 无构造器
<span class="hljs-bullet">-</span> 默认方法（Java 8+）
<span class="hljs-bullet">-</span> 只有常量
<span class="hljs-bullet">-</span> 设计：能什么（has-a/can-do）
</code></pre>
<h2 data-id="heading-18">💡 实用建议</h2>
<h3 data-id="heading-19"><strong>选择指南</strong></h3>
<pre><code class="hljs language-markdown" lang="markdown">问自己这些问题：

<span class="hljs-bullet">1.</span> 需要多重继承吗？
<span class="hljs-bullet">   -</span> 是 → 用接口
<span class="hljs-bullet">   -</span> 否 → 继续

<span class="hljs-bullet">2.</span> 需要共享代码吗？
<span class="hljs-bullet">   -</span> 是 → 用抽象类
<span class="hljs-bullet">   -</span> 否 → 用接口

<span class="hljs-bullet">3.</span> 相关类有紧密关系吗？
<span class="hljs-bullet">   -</span> 是 → 用抽象类
<span class="hljs-bullet">   -</span> 否 → 用接口

<span class="hljs-bullet">4.</span> 只是定义契约吗？
<span class="hljs-bullet">   -</span> 是 → 用接口
<span class="hljs-bullet">   -</span> 否 → 继续

<span class="hljs-bullet">5.</span> 需要控制子类构造吗？
<span class="hljs-bullet">   -</span> 是 → 用抽象类
<span class="hljs-bullet">   -</span> 否 → 用接口
</code></pre>
<h3 data-id="heading-20"><strong>最佳实践</strong></h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 优先使用接口（更加灵活）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Repository</span>&lt;T&gt; {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(T entity)</span>;
    T <span class="hljs-title function_">findById</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span>;
    List&lt;T&gt; <span class="hljs-title function_">findAll</span><span class="hljs-params">()</span>;
}

<span class="hljs-comment">// 需要共享代码时使用抽象类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractRepository</span>&lt;T&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Repository</span>&lt;T&gt; {
    <span class="hljs-keyword">protected</span> DatabaseConnection connection;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AbstractRepository</span><span class="hljs-params">(DatabaseConnection connection)</span> {
        <span class="hljs-built_in">this</span>.connection = connection;
    }
    
    <span class="hljs-comment">// 共享的保存逻辑</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">(T entity)</span> {
        validate(entity);
        persist(entity);
        logSave(entity);
    }
    
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">persist</span><span class="hljs-params">(T entity)</span>;
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validate</span><span class="hljs-params">(T entity)</span> {
        <span class="hljs-comment">// 验证逻辑</span>
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logSave</span><span class="hljs-params">(T entity)</span> {
        <span class="hljs-comment">// 日志逻辑</span>
    }
}

<span class="hljs-comment">// 具体实现</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractRepository</span>&lt;User&gt; {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserRepository</span><span class="hljs-params">(DatabaseConnection connection)</span> {
        <span class="hljs-built_in">super</span>(connection);
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">persist</span><span class="hljs-params">(User entity)</span> {
        <span class="hljs-comment">// 具体持久化逻辑</span>
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">findById</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> {
        <span class="hljs-comment">// 具体查找逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">findAll</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 具体查找逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    }
}
</code></pre>
<p><strong>记住</strong>：现代Java开发中，优先考虑使用接口，只有在确实需要共享代码时才使用抽象类。接口提供了更大的灵活性和可扩展性！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Manim v0.19.1 发布啦！三大新特性让动画制作更丝滑]]></title>    <link>https://juejin.cn/post/7578787344612769828</link>    <guid>https://juejin.cn/post/7578787344612769828</guid>    <pubDate>2025-12-02T04:28:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7578787344612769828" data-draft-id="7578811288819449899" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Manim v0.19.1 发布啦！三大新特性让动画制作更丝滑"/> <meta itemprop="keywords" content="Python,动效,后端"/> <meta itemprop="datePublished" content="2025-12-02T04:28:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="databook"/> <meta itemprop="url" content="https://juejin.cn/user/3526889035006702"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Manim v0.19.1 发布啦！三大新特性让动画制作更丝滑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3526889035006702/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    databook
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T04:28:41.000Z" title="Tue Dec 02 2025 04:28:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好！Manim 社区新发布了 <strong>v0.19.1</strong> 版本（发布于 12 月 1 日）。虽然这是一个小版本号更新，但里面可是藏着几个非常实用的新功能！</p>
<p>无论你是刚入坑的新手，或者已经被某些痛点折磨过的老手，这篇更新速览都值得一看。</p>
<h2 data-id="heading-0">1. 🌟 亮点一：终于可以“固定”随机颜色了！</h2>
<p>以前我们在使用 <code>random_color()</code> 时，最大的痛点就是：<strong>每次运行脚本，生成的颜色都不一样！</strong><br/>
有时候你觉得这次随机出来的配色方案简直完美，结果改了一行无关代码再渲染，配色变了……心态直接崩了有没有？</p>
<p>在 <code>v0.19.1</code> 中，<code>random_color()</code> 终于支持 <code>seed</code>（随机种子）参数了！这意味着你可以通过指定种子，让随机颜色变得“确定”。</p>
<h4 data-id="heading-1">1.0.1. 🌰 代码示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> manim <span class="hljs-keyword">import</span> *


<span class="hljs-keyword">class</span> <span class="hljs-title class_">DeterministicColors</span>(<span class="hljs-title class_ inherited__">Scene</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">construct</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 以前：每次运行颜色都可能不同</span>
        <span class="hljs-comment"># circle = Circle(color=random_color())</span>

        <span class="hljs-comment"># 现在：指定 seed=1，无论运行多少次，它永远是同一个颜色！</span>
        rnd = RandomColorGenerator(seed=<span class="hljs-number">1</span>)
        dot_a = Dot(radius=<span class="hljs-number">1</span>, color=rnd.<span class="hljs-built_in">next</span>())
        dot_a.shift(LEFT * <span class="hljs-number">2</span>)

        <span class="hljs-comment"># 即使在不同的地方调用，只要种子一样，颜色就一样</span>
        dot_b = Dot(radius=<span class="hljs-number">1</span>, color=rnd.<span class="hljs-built_in">next</span>())
        dot_b.shift(RIGHT * <span class="hljs-number">2</span>)

        self.play(Create(dot_a), Create(dot_b))
        self.wait()
</code></pre>
<p>只要<code>seed</code>的值一样，每次的随机的颜色都一样。</p>
<p>这对于制作系列视频或者调试配色时简直是救命稻草。</p>
<h2 data-id="heading-2">2. 🌟 亮点二：ValueTracker 终于学会算术了</h2>
<p><code>ValueTracker</code> 是 Manim 中做动态数值动画的核心。但以前它有点“笨”，不能直接参与加减乘除。</p>
<p>比如你想让一个 <code>tracker</code> 的值翻倍，以前你得写 <code>t.set_value(t.get_value() * 2)</code>。</p>
<p>现在则直接乘这就行了！</p>
<p>新版本支持 <code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>, <code>//</code>, <code>%</code>, <code>**</code> 等常见运算符。</p>
<h4 data-id="heading-3">2.0.1. 🌰 代码示例</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> manim <span class="hljs-keyword">import</span> *

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SmartTracker</span>(<span class="hljs-title class_ inherited__">Scene</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">construct</span>(<span class="hljs-params">self</span>):
        tracker = ValueTracker(<span class="hljs-number">2</span>)

        number = DecimalNumber()
        number.add_updater(<span class="hljs-keyword">lambda</span> m: m.set_value(tracker.get_value()))

        self.add(number)

        <span class="hljs-comment"># 以前的写法（现在依然可用，但比较繁琐）</span>
        <span class="hljs-comment"># self.play(tracker.animate.set_value(tracker.get_value() + 5))</span>

        <span class="hljs-comment"># v0.19.1 的新玩法：直接对对象进行操作</span>
        <span class="hljs-comment"># 注意：这里展示的是逻辑上的简化，在非 animate 场景下处理数据更方便</span>

        <span class="hljs-comment"># 比如我们在循环中处理数据逻辑时：</span>
        tracker += <span class="hljs-number">5</span>  <span class="hljs-comment"># tracker 的内部值现在变成了 7</span>
        self.wait()

        <span class="hljs-comment"># 甚至可以进行更复杂的运算</span>
        tracker *= <span class="hljs-number">2</span>  <span class="hljs-comment"># 变成 14</span>
        self.wait()

        <span class="hljs-comment"># 注意：如果你要用 animate 动画过渡，还是推荐用 .animate.set_value()</span>
        <span class="hljs-comment"># 但这个特性让编写复杂的 updater 逻辑或者预计算变得非常爽。</span>
</code></pre>
<p>代码又可以少写几行 <code>get_value()</code> 了，清爽度 +1。</p>
<h2 data-id="heading-4">3. 🌟 亮点三：新增 <code>TangentialArc</code> (切线弧)</h2>
<p>这是几何绘图的新玩具！以前如果想画一段圆弧，既要连接两个点，又要保证切线方向平滑，可能需要费点脑筋去算角度。</p>
<p>新的 <code>TangentialArc</code> 旨在简化这类几何构造。</p>
<p>目前官方文档还在完善中，但它的出现意味着我们可以更容易地画出流畅连接直线或曲线的圆弧了。</p>
<h4 data-id="heading-5">3.0.1. 🌰 代码场景</h4>
<p>如果你有一条直线，想在末端接一个圆弧，且连接处要是“丝滑”的（切线连续）。</p>
<p>以前你得算切角，现在可以试试使用 <code>TangentialArc</code> 。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TangentialArcSample</span>(<span class="hljs-title class_ inherited__">Scene</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">construct</span>(<span class="hljs-params">self</span>):
        l1 = Line([<span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>], [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>], color=RED)
        l2 = Line([-<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>], [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>], color=BLUE)
        
        <span class="hljs-comment"># 创建切圆弧对象</span>
        <span class="hljs-comment"># 参数说明：</span>
        <span class="hljs-comment"># - l1: 第一条切线</span>
        <span class="hljs-comment"># - l2: 第二条切线</span>
        <span class="hljs-comment"># - radius: 圆弧的半径（0.2）</span>
        <span class="hljs-comment"># - corner: 圆弧所在的角落方向</span>
        <span class="hljs-comment"># - color: 圆弧的颜色（绿色）</span>
        circulararc = TangentialArc(l1, l2, radius=<span class="hljs-number">0.2</span>, corner=(-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>), color=GREEN)
        self.play(Create(l1), Create(l2))
        self.play(Create(circulararc))

        self.wait()
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca2d253b6b73413a9ebda6378bf634ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765254521&amp;x-signature=thDHMrFMRbGCYLS2IqqrB%2B83wXA%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">4. 🛠️ 其他值得关注的变化</h2>
<p>除了上面三个新特性，还有一些改动也非常贴心：</p>
<ol>
<li><strong>SurroundingRectangle 更灵活了</strong>：<br/>
以前 <code>buff</code> 参数只能是一个数字，导致矩形框的四周留白必须一样。现在你可以传入一个元组 <code>buff=(0.5, 0.1)</code>，分别控制 <strong>水平</strong> 和 <strong>垂直</strong> 方向的间距。给长公式加框时再也不用担心左右太宽或者上下太挤了！</li>
<li><strong>Code Mobject 支持 OpenGL</strong>：<br/>
如果你是用 OpenGL 渲染模式（渲染速度超快的那种）的用户，现在 <code>Code</code> 对象也能完美显示了。</li>
<li><strong>修复了 Tex 环境格式化问题</strong>：<br/>
写 <code>LaTeX</code> 公式时如果不小心换行或者格式乱了，现在 <code>Manim</code> 能更好地处理它，报错更少。</li>
<li><strong>CLI 默认分辨率调整</strong>：<br/>
命令行工具的默认分辨率逻辑进行了一些微调，更加符合 1080p 的标准预期。</li>
</ol>
<h2 data-id="heading-7">5. 📝 总结与升级</h2>
<p>这次<code> v0.19.1</code> 虽然版本号跨度不大，但每一个改动都切中了实际开发中的痛点。</p>
<p>特别是 <strong>随机种子</strong> 和 <strong>ValueTracker 算术支持</strong>，属于那种“用了就回不去”的优化。</p>
<p>升级<code>Manim</code>也很简单，打开终端/命令行，输入：</p>
<pre><code class="hljs language-bash" lang="bash">pip install --upgrade manim
</code></pre>
<p>快去试试新功能吧！如果你用新特性做出了好玩的动画，欢迎在社区分享哦。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[runtime-dom记录备忘]]></title>    <link>https://juejin.cn/post/7579255046980010010</link>    <guid>https://juejin.cn/post/7579255046980010010</guid>    <pubDate>2025-12-03T09:23:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579255046980010010" data-draft-id="7579441333165932553" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="runtime-dom记录备忘"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-03T09:23:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="细心细心再细心"/> <meta itemprop="url" content="https://juejin.cn/user/721738373803879"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            runtime-dom记录备忘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/721738373803879/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    细心细心再细心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T09:23:04.000Z" title="Wed Dec 03 2025 09:23:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">packages/runtime-dom/src/index.ts 的主要作用</h2>
<ul>
<li>首先明确的是，在runtime-dom中调用的createApp，实际上是来自runtime-core。runtime-dom只是对它进行了类型扩展和包装导出；</li>
<li>第一步：创建渲染器
<ul>
<li>当createApp被调用时，他背后依赖的核心是createRenderer</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 位于 runtime-dom/src/index.ts</span>
<span class="hljs-comment">// 1. 创建专用于DOM的渲染器，传入所有DOM操作方法（rendererOptions）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> createApp = (<span class="hljs-function">(<span class="hljs-params">...args</span>) =&gt;</span> {
  <span class="hljs-comment">// 2. ensureRenderer() 会调用 createRenderer(rendererOptions)，</span>
  <span class="hljs-comment">//    生成一个具备 render 和 hydrate 方法的渲染器对象</span>
  <span class="hljs-keyword">const</span> app = <span class="hljs-title function_">ensureRenderer</span>().<span class="hljs-title function_">createApp</span>(...args)
  <span class="hljs-comment">// ... 后续对 app.mount 的增强（见下文）</span>
  <span class="hljs-keyword">return</span> app
}) <span class="hljs-keyword">as</span> <span class="hljs-title class_">CreateAppFunction</span>&lt;<span class="hljs-title class_">Element</span>&gt;

</code></pre>
<ol>
<li>ensureRenderer():获取或创建唯一的DOM渲染器，他是整个应用与DOM交互的发动机。</li>
<li>createRenderer(rendererOptions):这是关键。rendererOptions就是之前定义的包含patchProp、insert,createElement等几十个具体DOM操作方法的对象。createRenderer函数（来自runtime-core）接收这些具体方法，返回一个平台通用的渲染器。这是依赖注入的经典实现：核心逻辑是通用的，具体实现由外部注入。</li>
</ol>
<ul>
<li>第二步创建App实例（核心逻辑）
接着，调用渲染器的.createApp方法，这是在runtime-core中定义的createAppApi函数</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 位于 runtime-core/src/apiCreateApp.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> createAppAPI&lt;<span class="hljs-title class_">HostElement</span>&gt;(
  <span class="hljs-attr">render</span>: <span class="hljs-title class_">RootRenderFunction</span>,
  hydrate?: <span class="hljs-title class_">RootHydrateFunction</span>
): <span class="hljs-title class_">CreateAppFunction</span>&lt;<span class="hljs-title class_">HostElement</span>&gt; {
  <span class="hljs-comment">// 这个函数返回的就是我们最终使用的 createApp 函数</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createApp</span>(<span class="hljs-params">rootComponent, rootProps = <span class="hljs-literal">null</span></span>) {
    <span class="hljs-comment">// 1. 创建应用上下文对象 (context)，这是全局配置和状态的集合</span>
    <span class="hljs-keyword">const</span> context = <span class="hljs-title function_">createAppContext</span>()
    <span class="hljs-keyword">const</span> installedPlugins = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>() <span class="hljs-comment">// 用于记录已安装插件，防止重复</span>

    <span class="hljs-keyword">let</span> isMounted = <span class="hljs-literal">false</span> <span class="hljs-comment">// 标记应用是否已挂载</span>

    <span class="hljs-comment">// 2. 创建 app 对象（这就是我们得到的 app 实例）</span>
    <span class="hljs-keyword">const</span> <span class="hljs-attr">app</span>: <span class="hljs-title class_">App</span> = (context.<span class="hljs-property">app</span> = {
      <span class="hljs-attr">_uid</span>: uid++,
      <span class="hljs-attr">_component</span>: rootComponent, <span class="hljs-comment">// 保存根组件对象</span>
      <span class="hljs-attr">_props</span>: rootProps,
      <span class="hljs-attr">_container</span>: <span class="hljs-literal">null</span>, <span class="hljs-comment">// 初始为null，mount后指向根DOM容器</span>
      <span class="hljs-attr">_context</span>: context, <span class="hljs-comment">// 关联上文创建的上下文</span>

      <span class="hljs-comment">// 3. 核心：mount 方法（初始版本，runtime-dom 会增强它）</span>
      <span class="hljs-title function_">mount</span>(<span class="hljs-attr">rootContainer</span>: <span class="hljs-title class_">HostElement</span>, isHydrate?: <span class="hljs-built_in">boolean</span>): <span class="hljs-built_in">any</span> {
        <span class="hljs-keyword">if</span> (isMounted) {
          <span class="hljs-title function_">warn</span>(<span class="hljs-string">`App has already been mounted.`</span>) <span class="hljs-comment">// 开发环境警告</span>
          <span class="hljs-keyword">return</span>
        }
        <span class="hljs-comment">// 3.1 标准化容器：支持字符串选择器（如‘#app’）或DOM元素</span>
        <span class="hljs-keyword">const</span> container = <span class="hljs-title function_">normalizeContainer</span>(rootContainer)
        <span class="hljs-keyword">if</span> (!container) <span class="hljs-keyword">return</span>

        <span class="hljs-comment">// 3.2 创建根组件的虚拟节点 (vnode)</span>
        <span class="hljs-keyword">const</span> vnode = <span class="hljs-title function_">createVNode</span>(
          rootComponent <span class="hljs-keyword">as</span> <span class="hljs-title class_">ConcreteComponent</span>,
          rootProps
        )
        vnode.<span class="hljs-property">appContext</span> = context <span class="hljs-comment">// 将应用上下文关联到vnode</span>

        <span class="hljs-comment">// 3.3 核心渲染调用：将虚拟树转换为真实DOM</span>
        <span class="hljs-keyword">if</span> (isHydrate) {
          <span class="hljs-title function_">hydrate</span>(vnode <span class="hljs-keyword">as</span> <span class="hljs-title class_">VNode</span>&lt;<span class="hljs-title class_">Node</span>, <span class="hljs-title class_">Element</span>&gt;, container)
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-title function_">render</span>(vnode, container) <span class="hljs-comment">// 这里调用的是 runtime-dom 提供的 render 函数</span>
        }

        isMounted = <span class="hljs-literal">true</span>
        app.<span class="hljs-property">_container</span> = container <span class="hljs-comment">// 记录挂载容器</span>
        container.<span class="hljs-property">__vue_app__</span> = app <span class="hljs-comment">// 在DOM元素上记录app实例，便于调试或HMR</span>

        <span class="hljs-comment">// 3.4 返回根组件实例的代理（方便少数需要直接操作实例的场景）</span>
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">getExposeProxy</span>(vnode.<span class="hljs-property">component</span>!) || vnode.<span class="hljs-property">component</span>!.<span class="hljs-property">proxy</span>
      },

      <span class="hljs-comment">// 4. 其他应用API</span>
      <span class="hljs-title function_">use</span>(<span class="hljs-params">plugin: Plugin, ...options: <span class="hljs-built_in">any</span>[]</span>) {
        <span class="hljs-comment">// 插件安装逻辑，调用 plugin.install(app, ...options)</span>
      },
      <span class="hljs-title function_">component</span>(<span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>, component?: <span class="hljs-title class_">Component</span>): <span class="hljs-built_in">any</span> {
        <span class="hljs-comment">// 全局组件注册，存入 context.components</span>
      },
      <span class="hljs-title function_">directive</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span>, directive?: Directive</span>) {
        <span class="hljs-comment">// 全局指令注册，存入 context.directives</span>
      },
      <span class="hljs-comment">// unmount, provide 等其他方法...</span>
    })

    <span class="hljs-keyword">return</span> app
  }
}
</code></pre>
<p>关键行解读：</p>
<ol>
<li>const context = createAppContext():创建应用级别的共享上下文。所有组件树中的组件都能访问到它内部的全局组件、指令、配置等。这是app.component、app.directive全局注册的基石。</li>
<li>const vnode=createVNode(...)将你传入的跟组件（可以是一个对象或者一个组件定义）转换为初始的虚拟DOM节点。Vue3的所有渲染都围绕虚拟DOM进行</li>
<li>render(vnode,container):是连接所有模块的枢纽。这个render函数第一步中createRender返回的核心渲染函数。它会启动整个patch（协调）算法，递归地将vnode树比对并渲染到真实的containerDOM节点中。</li>
</ol>
<ul>
<li>第三步：runtime-dom对mount的增强
在 <code>runtime-dom</code> 中，它拿到了 <code>runtime-core</code> 返回的基础 <code>app</code> 实例，但对 <code>mount</code> 方法做了<strong>关键增强</strong>，以支持更符合Web开发习惯的用法。</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 位于 runtime-dom/src/index.ts (接第一步的代码)</span>
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">ensureRenderer</span>().<span class="hljs-title function_">createApp</span>(...args)

<span class="hljs-comment">// 从 app 实例上获取原始的 mount 方法</span>
<span class="hljs-keyword">const</span> { mount } = app

<span class="hljs-comment">// 重写（增强）mount 方法</span>
app.<span class="hljs-property">mount</span> = (<span class="hljs-attr">containerOrSelector</span>: <span class="hljs-title class_">Element</span> | <span class="hljs-built_in">string</span>): <span class="hljs-function"><span class="hljs-params">any</span> =&gt;</span> {
  <span class="hljs-comment">// 1. 标准化容器（核心增强点）：支持字符串选择器</span>
  <span class="hljs-keyword">const</span> container = <span class="hljs-title function_">normalizeContainer</span>(containerOrSelector)
  <span class="hljs-keyword">if</span> (!container) <span class="hljs-keyword">return</span>

  <span class="hljs-comment">// 2. 获取用户传入的根组件（可能是一个简单的模板对象）</span>
  <span class="hljs-keyword">const</span> component = app.<span class="hljs-property">_component</span>
  <span class="hljs-comment">// 3. 如果根组件不是函数 &amp; 没有render函数 &amp; 有template，则将template编译为render函数</span>
  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isFunction</span>(component) &amp;&amp; !component.<span class="hljs-property">render</span> &amp;&amp; !component.<span class="hljs-property">template</span>) {
    component.<span class="hljs-property">template</span> = container.<span class="hljs-property">innerHTML</span> <span class="hljs-comment">// 注意：这仅用于无构建步骤的CDN用法</span>
  }

  <span class="hljs-comment">// 4. 清除容器内的现有内容（在挂载前）</span>
  container.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">''</span>

  <span class="hljs-comment">// 5. 调用从 runtime-core 拿来的原始 mount 方法，执行真正的挂载</span>
  <span class="hljs-keyword">const</span> proxy = <span class="hljs-title function_">mount</span>(container, <span class="hljs-literal">false</span>, container <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">SVGElement</span>)
  <span class="hljs-comment">// ... 后续处理</span>
  <span class="hljs-keyword">return</span> proxy
}
</code></pre>
<p>为什么需要这个增强？
用户体验：让app.mount('#app')这种写法成为可能，而不必每次都写documnet.querySelector。
支持纯HTML开发：当你在没有构建步骤（如Webpack/Vite）的环境中，直接通过 <code>&lt;script&gt;</code> 标签引入Vue时，你可能需要在HTML中写模板。这段代码会检查根组件，如果它没有 <code>render</code> 函数，就会尝试将 <code>template</code> 选项（或容器内的HTML）<strong>在运行时编译</strong>成 <code>render</code> 函数。这就是“完整版”Vue（包含编译器）与“仅运行时版”的区别所在。</p>
<h4 data-id="heading-1">💎 总结</h4>
<p><code>createApp</code> 函数的主要工作可以概括为以下几步：</p>



































<table><thead><tr><th>步骤</th><th>所在模块</th><th>核心工作</th><th>产出</th></tr></thead><tbody><tr><td><strong>1. 创建渲染器</strong></td><td><code>runtime-dom</code></td><td>注入DOM API，创建平台专属渲染器。</td><td>具备 <code>render</code> 和 <code>createApp</code> 方法的渲染器对象。</td></tr><tr><td><strong>2. 创建App实例</strong></td><td><code>runtime-core</code></td><td>创建应用上下文和基础App对象，定义核心API。</td><td>一个包含 <code>_context</code>、基础 <code>mount</code> 方法的 <code>app</code> 实例。</td></tr><tr><td><strong>3. 增强Mount</strong></td><td><code>runtime-dom</code></td><td>为 <code>mount</code> 增加容器标准化和模板编译支持。</td><td>最终用户使用的、功能完整的 <code>app.mount</code> 方法。</td></tr><tr><td><strong>4. 启动应用</strong></td><td>用户调用</td><td>用户调用 <code>app.mount</code>，触发虚拟DOM渲染流程。</td><td>根组件被渲染成真实DOM，应用启动。</td></tr></tbody></table>
<p><strong>本质上，<code>createApp</code> 是一个高级工厂函数，它：</strong></p>
<ol>
<li><strong>装配环境</strong>：将平台（浏览器）的具体操作与Vue的通用核心连接。</li>
<li><strong>创建上下文</strong>：为整个组件树建立一个共享的配置和状态空间。</li>
<li><strong>封装启动</strong>：提供一个简单易用的 <code>mount</code> 方法，隐藏了虚拟DOM创建、渲染、挂载等复杂细节</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue3 上传文件，图片，视频组件]]></title>    <link>https://juejin.cn/post/7579410911057788954</link>    <guid>https://juejin.cn/post/7579410911057788954</guid>    <pubDate>2025-12-03T09:27:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579410911057788954" data-draft-id="7579255046979977242" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue3 上传文件，图片，视频组件"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-03T09:27:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小周同学"/> <meta itemprop="url" content="https://juejin.cn/user/3808364009365080"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue3 上传文件，图片，视频组件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808364009365080/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小周同学
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T09:27:50.000Z" title="Wed Dec 03 2025 09:27:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">上传文件</h2>
<pre><code class="hljs language-ini" lang="ini">&lt;!-- eslint-disable vue/multi-word-component-names --&gt;
&lt;template&gt;
  &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"upload-file"</span>&gt;
    &lt;el-upload
      <span class="hljs-attr">ref</span>=<span class="hljs-string">"uploadRef"</span>
      :<span class="hljs-attr">multiple</span>=<span class="hljs-string">"true"</span>
      :<span class="hljs-attr">action</span>=<span class="hljs-string">"uploadFileUrl"</span>
      :<span class="hljs-attr">before-upload</span>=<span class="hljs-string">"handleBeforeUpload"</span>
      <span class="hljs-attr">v-model</span>=<span class="hljs-string">"fileList"</span>
      :<span class="hljs-attr">file-list</span>=<span class="hljs-string">"fileList"</span>
      :<span class="hljs-attr">limit</span>=<span class="hljs-string">"limit"</span>
      :<span class="hljs-attr">on-error</span>=<span class="hljs-string">"handleUploadError"</span>
      :<span class="hljs-attr">on-exceed</span>=<span class="hljs-string">"handleExceed"</span>
      :<span class="hljs-attr">on-success</span>=<span class="hljs-string">"handleUploadSuccess"</span>
      :<span class="hljs-attr">show-file-list</span>=<span class="hljs-string">"false"</span>
      :<span class="hljs-attr">headers</span>=<span class="hljs-string">"headers"</span>
      :<span class="hljs-attr">auto-upload</span>=<span class="hljs-string">"true"</span>
      <span class="hljs-attr">class</span>=<span class="hljs-string">"upload-file-uploader"</span>
    &gt;
      &lt;!-- 上传按钮 --&gt;
      &lt;el-button <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span> v-show=<span class="hljs-string">"isShow"</span>&gt;选取文件&lt;/el-button&gt;
    &lt;/el-upload&gt;
    &lt;!-- 上传提示 --&gt;
    &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"el-upload__tip"</span> v-if=<span class="hljs-string">"showTip"</span> v-show=<span class="hljs-string">"isShow"</span>&gt;
      请上传
      &lt;template <span class="hljs-attr">v-if</span>=<span class="hljs-string">"fileSize"</span>&gt;
        大小不超过 &lt;b <span class="hljs-attr">style</span>=<span class="hljs-string">"color: #f56c6c"</span>&gt;{{ fileSize }}MB&lt;/b&gt;
      &lt;/template&gt;
      &lt;template <span class="hljs-attr">v-if</span>=<span class="hljs-string">"fileType"</span>&gt;
        格式为 &lt;b <span class="hljs-attr">style</span>=<span class="hljs-string">"color: #f56c6c"</span>&gt;{{ fileType.join(<span class="hljs-string">'/'</span>) }}&lt;/b&gt;
      &lt;/template&gt;
  的文件
&lt;/div&gt;
&lt;!-- 文件列表 --&gt;
&lt;transition-group
  <span class="hljs-attr">class</span>=<span class="hljs-string">"upload-file-list el-upload-list el-upload-list--text"</span>
  <span class="hljs-attr">name</span>=<span class="hljs-string">"el-fade-in-linear"</span>
  <span class="hljs-attr">tag</span>=<span class="hljs-string">"ul"</span>
&gt;
  &lt;li
    :<span class="hljs-attr">key</span>=<span class="hljs-string">"file.uid"</span>
    <span class="hljs-attr">class</span>=<span class="hljs-string">"el-upload-list__item ele-upload-list__item-content"</span>
    <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(file, index) in fileList"</span>
  &gt;
    &lt;el-link :<span class="hljs-attr">underline</span>=<span class="hljs-string">"false"</span> target=<span class="hljs-string">"_blank"</span>&gt;
      &lt;span <span class="hljs-attr">class</span>=<span class="hljs-string">"el-icon-document"</span>&gt;
        {{ file.attachmentName }}
      &lt;/span&gt;
    &lt;/el-link&gt;
    &lt;div <span class="hljs-attr">class</span>=<span class="hljs-string">"ele-upload-list__item-content-action"</span>&gt;
      &lt;el-link <span class="hljs-attr">v-show</span>=<span class="hljs-string">"isShow"</span> :underline=<span class="hljs-string">"false"</span> @click=<span class="hljs-string">"handleDelete(index)"</span> type=<span class="hljs-string">"danger"</span>
        &gt;删除&lt;/el-link
      &gt;
      &lt;el-link
        :<span class="hljs-attr">underline</span>=<span class="hljs-string">"false"</span>
        <span class="hljs-attr">type</span>=<span class="hljs-string">"primary"</span>
        @<span class="hljs-attr">click</span>=<span class="hljs-string">"downloadFile(file)"</span>
        <span class="hljs-attr">v-if</span>=<span class="hljs-string">"dowloadStatus"</span>
        &gt;下载&lt;/el-link
      &gt;
    &lt;/div&gt;
  &lt;/li&gt;
&lt;/transition-group&gt;
</code></pre>
  

<pre><code class="hljs language-typescript" lang="typescript">&lt;script lang=<span class="hljs-string">"ts"</span> setup&gt;
<span class="hljs-keyword">import</span> cache <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils/cache'</span>;
<span class="hljs-keyword">import</span> { log } <span class="hljs-keyword">from</span> <span class="hljs-string">'console'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ElMessage</span>, <span class="hljs-title class_">UploadUserFile</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'element-plus'</span>;
<span class="hljs-keyword">import</span> { ref, computed, watch } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Download</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@element-plus/icons-vue'</span>;
<span class="hljs-keyword">import</span> { useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/stores'</span>;
<span class="hljs-keyword">const</span> uploadRef = <span class="hljs-title function_">ref</span>();

<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>({
  <span class="hljs-attr">modelValue</span>: [<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>, <span class="hljs-title class_">Array</span>],
  <span class="hljs-comment">// 数量限制</span>
  <span class="hljs-attr">limit</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-number">5</span>
  },
  <span class="hljs-comment">// 大小限制(MB)</span>
  <span class="hljs-attr">fileSize</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-number">1100</span>
  },
  <span class="hljs-comment">// 文件类型, 例如['png', 'jpg', 'jpeg']</span>
  <span class="hljs-attr">fileType</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Array</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-function">() =&gt;</span> [<span class="hljs-string">'doc'</span>, <span class="hljs-string">'xls'</span>, <span class="hljs-string">'xlsx'</span>, <span class="hljs-string">'pdf'</span>, <span class="hljs-string">'docx'</span>]
  },
  <span class="hljs-comment">// 是否显示提示</span>
  <span class="hljs-attr">isShowTip</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-comment">//是否显示删除按钮</span>
  <span class="hljs-attr">isShow</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-comment">//是否显示下载</span>
  <span class="hljs-attr">dowloadStatus</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span>
  }
});

<span class="hljs-comment">// @ts-ignore</span>
<span class="hljs-keyword">const</span> { proxy } = <span class="hljs-title function_">getCurrentInstance</span>();
<span class="hljs-comment">// eslint-disable-next-line vue/valid-define-emits</span>
<span class="hljs-keyword">const</span> emit = <span class="hljs-title function_">defineEmits</span>();
<span class="hljs-keyword">const</span> <span class="hljs-built_in">number</span> = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);
<span class="hljs-keyword">const</span> uploadFileUrl = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">VITE_BASE_API</span> + <span class="hljs-string">'/minio/upload'</span>; <span class="hljs-comment">// 上传文件服务器地址</span>
<span class="hljs-keyword">const</span> headers = <span class="hljs-title function_">ref</span>({
  <span class="hljs-title class_">Authorization</span>: <span class="hljs-string">'Bearer '</span> + <span class="hljs-title function_">useUserStore</span>().<span class="hljs-property">token</span>,
  <span class="hljs-string">'bg-debug'</span>: <span class="hljs-number">1</span>
});
<span class="hljs-keyword">const</span> fileList = ref&lt;<span class="hljs-title class_">UploadUserFile</span>[]&gt;([]);
<span class="hljs-keyword">const</span> showTip = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> props.<span class="hljs-property">isShowTip</span> &amp;&amp; (props.<span class="hljs-property">fileType</span> || props.<span class="hljs-property">fileSize</span>));

<span class="hljs-title function_">watch</span>(
  [<span class="hljs-function">() =&gt;</span> props.<span class="hljs-property">modelValue</span>, <span class="hljs-function">() =&gt;</span> props.<span class="hljs-property">dowloadStatus</span>],
  <span class="hljs-function">(<span class="hljs-params">val: <span class="hljs-built_in">any</span></span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (val) {
      fileList.<span class="hljs-property">value</span> = props.<span class="hljs-property">modelValue</span>;
    }
  },
  { <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span> }
);
<span class="hljs-comment">// 上传前校检格式和大小</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleBeforeUpload</span>(<span class="hljs-params">file: { name: <span class="hljs-built_in">string</span>; size: <span class="hljs-built_in">number</span> }</span>) {
  <span class="hljs-comment">// 校检文件类型</span>
  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">fileType</span>.<span class="hljs-property">length</span>) {
    <span class="hljs-keyword">const</span> fileName = file.<span class="hljs-property">name</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>);
    <span class="hljs-keyword">const</span> fileExt = fileName[fileName.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];
    <span class="hljs-keyword">const</span> isTypeOk = props.<span class="hljs-property">fileType</span>.<span class="hljs-title function_">indexOf</span>(fileExt) &gt;= <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (!isTypeOk) {
      <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`文件格式不正确, 请上传<span class="hljs-subst">${props.fileType.join(<span class="hljs-string">'/'</span>)}</span>格式文件!`</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }
  <span class="hljs-comment">// 校检文件大小</span>
  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">fileSize</span>) {
    <span class="hljs-keyword">const</span> isLt = file.<span class="hljs-property">size</span> / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span> &lt; props.<span class="hljs-property">fileSize</span>;
    <span class="hljs-keyword">if</span> (!isLt) {
      <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`上传文件大小不能超过 <span class="hljs-subst">${props.fileSize}</span> MB!`</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
  }
  <span class="hljs-built_in">number</span>.<span class="hljs-property">value</span>++;
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}

<span class="hljs-comment">//下载文件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">downloadPdf</span> = (<span class="hljs-params">data: <span class="hljs-built_in">any</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> fileName = data.<span class="hljs-property">attachmentName</span>;
  <span class="hljs-keyword">const</span> fileUrl = data.<span class="hljs-property">attachmentPath</span>;
  <span class="hljs-keyword">const</span> request = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();
  request.<span class="hljs-property">responseType</span> = <span class="hljs-string">'blob'</span>;
  request.<span class="hljs-title function_">open</span>(<span class="hljs-string">'Get'</span>, fileUrl);
  request.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> url = <span class="hljs-variable language_">window</span>.<span class="hljs-property">URL</span>.<span class="hljs-title function_">createObjectURL</span>(request.<span class="hljs-property">response</span>);
    <span class="hljs-keyword">const</span> a = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'a'</span>);
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(a);
    a.<span class="hljs-property">href</span> = url;
    a.<span class="hljs-property">download</span> = fileName;
    a.<span class="hljs-title function_">click</span>();
  };
  request.<span class="hljs-title function_">send</span>();
};

<span class="hljs-comment">//下载文件</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">downloadFile</span> = (<span class="hljs-params">file: { attachmentPath: <span class="hljs-built_in">any</span>; attachmentName: <span class="hljs-built_in">any</span> }</span>) =&gt; {
  <span class="hljs-keyword">const</span> lastDotIdx = file.<span class="hljs-property">attachmentPath</span>.<span class="hljs-title function_">lastIndexOf</span>(<span class="hljs-string">'.'</span>);
  <span class="hljs-keyword">const</span> <span class="hljs-keyword">type</span> = file.<span class="hljs-property">attachmentPath</span>.<span class="hljs-title function_">slice</span>(lastDotIdx + <span class="hljs-number">1</span>).<span class="hljs-title function_">toUpperCase</span>();
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> === <span class="hljs-string">'PDF'</span>) {
    <span class="hljs-title function_">downloadPdf</span>(file);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">const</span> link = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'a'</span>);
    link.<span class="hljs-property">href</span> = file.<span class="hljs-property">attachmentPath</span>;
    link.<span class="hljs-property">download</span> = file.<span class="hljs-property">attachmentName</span>;
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(link);
    link.<span class="hljs-title function_">click</span>();
  }
};
<span class="hljs-comment">// 文件个数超出</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleExceed</span>(<span class="hljs-params"/>) {
  <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`上传文件数量不能超过 <span class="hljs-subst">${props.limit}</span> 个!`</span>);
}

<span class="hljs-comment">// 上传失败</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleUploadError</span>(<span class="hljs-params">err: <span class="hljs-built_in">any</span></span>) {
  <span class="hljs-title class_">ElMessage</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'上传文件失败'</span>);
}
<span class="hljs-comment">/** 文件上传成功处理 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">handleUploadSuccess</span>: <span class="hljs-title class_">UploadProps</span>[<span class="hljs-string">'onSuccess'</span>] = <span class="hljs-function">(<span class="hljs-params">
  response: { data: { url: <span class="hljs-built_in">any</span> } },
  file: { name: <span class="hljs-built_in">any</span> }
</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> newFile = { <span class="hljs-attr">attachmentName</span>: file.<span class="hljs-property">name</span>, <span class="hljs-attr">attachmentPath</span>: response.<span class="hljs-property">data</span>.<span class="hljs-property">url</span> };
  fileList.<span class="hljs-property">value</span>.<span class="hljs-title function_">push</span>(newFile);
  uploadRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">submit</span>();
  <span class="hljs-title function_">emit</span>(<span class="hljs-string">'update:modelValue'</span>, fileList.<span class="hljs-property">value</span>);
};
<span class="hljs-comment">// 删除文件</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleDelete</span>(<span class="hljs-params">index: <span class="hljs-built_in">number</span></span>) {
  fileList.<span class="hljs-property">value</span>.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
  <span class="hljs-comment">// @ts-ignore</span>
  <span class="hljs-title function_">emit</span>(<span class="hljs-string">'update:modelValue'</span>, fileList.<span class="hljs-property">value</span>);
}
&lt;/script&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.upload-file-uploader</span> {
  <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">5px</span>;
}
<span class="hljs-selector-class">.upload-file-list</span> <span class="hljs-selector-class">.el-upload-list__item</span> {
  <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#e4e7ed</span>;
  <span class="hljs-attribute">line-height</span>: <span class="hljs-number">2</span>;
  <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">position</span>: relative;
}
<span class="hljs-selector-class">.upload-file-list</span> <span class="hljs-selector-class">.ele-upload-list__item-content</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">justify-content</span>: space-between;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">color</span>: inherit;
}
<span class="hljs-selector-class">.ele-upload-list__item-content-action</span> <span class="hljs-selector-class">.el-link</span> {
  <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">20px</span>;
}
<span class="hljs-selector-class">.ele-upload-list__item-content-action</span> <span class="hljs-selector-class">.el-icon</span> {
  <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">10px</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>
</code></pre>
<h2 data-id="heading-1">上传图片</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"pro-upload-img-box"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"pro-upload-img-content"</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 已上传图片列表 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
        <span class="hljs-attr">class</span>=<span class="hljs-string">"upload-img-card"</span>
        <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(item, index) in fileList"</span>
        <span class="hljs-attr">:key</span>=<span class="hljs-string">"index"</span>
      &gt;</span>
        <span class="hljs-comment">&lt;!-- 图片预览 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-image</span>
          <span class="hljs-attr">class</span>=<span class="hljs-string">"img-sty"</span>
          <span class="hljs-attr">:preview-src-list</span>=<span class="hljs-string">"[item.url]"</span>
          <span class="hljs-attr">fit</span>=<span class="hljs-string">"cover"</span>
          <span class="hljs-attr">:src</span>=<span class="hljs-string">"item.url"</span>
          <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>
        /&gt;</span>
        <span class="hljs-comment">&lt;!-- 删除按钮 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-image</span>
          <span class="hljs-attr">v-if</span>=<span class="hljs-string">"!disabled"</span>
          <span class="hljs-attr">src</span>=<span class="hljs-string">"https://static.wxb.com.cn/frontEnd/images/ideacome-vue3-component/img-close.png"</span>
          <span class="hljs-attr">class</span>=<span class="hljs-string">"img-close"</span>
          @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleRemove(item, index)"</span>
        /&gt;</span>
        <span class="hljs-comment">&lt;!-- 图片遮罩层 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"img-mask"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-image</span>
            <span class="hljs-attr">src</span>=<span class="hljs-string">"https://static.wxb.com.cn/frontEnd/images/ideacome-vue3-component/img-preview.png"</span>
            <span class="hljs-attr">class</span>=<span class="hljs-string">"img-preview"</span>
          /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 上传组件 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-upload</span>
        <span class="hljs-attr">v-loading</span>=<span class="hljs-string">"loading"</span>
        <span class="hljs-attr">ref</span>=<span class="hljs-string">"proUploadImgRef"</span>
        <span class="hljs-attr">:class</span>=<span class="hljs-string">"['pro-upload-img', { 'is-disabled': disabled }]"</span>
        <span class="hljs-attr">v-bind</span>=<span class="hljs-string">"uploadProps"</span>
        <span class="hljs-attr">:before-upload</span>=<span class="hljs-string">"beforeUpload"</span>
        <span class="hljs-attr">:on-success</span>=<span class="hljs-string">"handleSuccess"</span>
        <span class="hljs-attr">:on-error</span>=<span class="hljs-string">"handleError"</span>
        <span class="hljs-attr">:on-exceed</span>=<span class="hljs-string">"handleExceed"</span>
      &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">slot</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"upload-card"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"upload-icon"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"font-size: 30px;"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">CirclePlus</span>  /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"uploadText"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"upload-text"</span>&gt;</span>
              {{ uploadText }}
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-upload</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 提示信息 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"tip"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"upload-tip"</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"tip"</span>&gt;</span>
        {{ tip }}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"ProUploadImg"</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
  <span class="hljs-keyword">import</span> { <span class="hljs-title class_">Plus</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@element-plus/icons-vue'</span>;
  <span class="hljs-keyword">import</span> { <span class="hljs-title class_">ElMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'element-plus'</span>;

  <span class="hljs-comment">// Props 定义</span>
  <span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>({
    <span class="hljs-comment">/** 上传地址 */</span>
    <span class="hljs-attr">action</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
      <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
    },
    <span class="hljs-comment">/** 请求头 */</span>
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">Object</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-function">() =&gt;</span> ({}),
    },
    <span class="hljs-comment">/** 是否支持多选 */</span>
    <span class="hljs-attr">multiple</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span>,
    },
    <span class="hljs-comment">/** 最大上传数量，0表示不限制 */</span>
    <span class="hljs-attr">limit</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-number">0</span>,
    },
    <span class="hljs-comment">/** 接受的文件类型，如：.jpg,.png,.jpeg */</span>
    <span class="hljs-attr">accept</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-string">'.jpg,.png,.jpeg'</span>,
    },
    <span class="hljs-comment">/** 文件大小限制 */</span>
    <span class="hljs-attr">maxSize</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-number">0</span>,
    },
    <span class="hljs-comment">/** 文件大小单位（KB/MB） */</span>
    <span class="hljs-attr">sizeUnit</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-string">'MB'</span>,
      <span class="hljs-attr">validator</span>: <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> [<span class="hljs-string">'KB'</span>, <span class="hljs-string">'MB'</span>].<span class="hljs-title function_">includes</span>(value),
    },
    <span class="hljs-comment">/** 图片宽度限制 */</span>
    <span class="hljs-attr">width</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-number">0</span>,
    },
    <span class="hljs-comment">/** 图片高度限制 */</span>
    <span class="hljs-attr">height</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-number">0</span>,
    },
    <span class="hljs-comment">/** 上传提示文字 */</span>
    <span class="hljs-attr">uploadText</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-string">'点击上传'</span>,
    },
    <span class="hljs-comment">/** 上传提示说明 */</span>
    <span class="hljs-attr">tip</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-string">''</span>,
    },
    <span class="hljs-comment">/** 是否禁用 */</span>
    <span class="hljs-attr">disabled</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span>,
    },
  });
  <span class="hljs-comment">/** 初始文件列表 */</span>
  <span class="hljs-keyword">const</span> fileList = <span class="hljs-title function_">defineModel</span>(<span class="hljs-string">'fileList'</span>, {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Array</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-function">() =&gt;</span> [],
  });

  <span class="hljs-comment">// 事件定义</span>
  <span class="hljs-keyword">const</span> emit = <span class="hljs-title function_">defineEmits</span>([<span class="hljs-string">'success'</span>, <span class="hljs-string">'error'</span>, <span class="hljs-string">'exceed'</span>, <span class="hljs-string">'remove'</span>]);

  <span class="hljs-keyword">const</span> proUploadImgRef = <span class="hljs-title function_">ref</span>();
  <span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">const</span> uploadProps = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">action</span>: props.<span class="hljs-property">action</span>,
    <span class="hljs-attr">accept</span>: props.<span class="hljs-property">accept</span>,
    <span class="hljs-attr">limit</span>: props.<span class="hljs-property">limit</span>,
    <span class="hljs-attr">multiple</span>: props.<span class="hljs-property">multiple</span>,
    <span class="hljs-attr">listType</span>: <span class="hljs-string">'picture-card'</span>,
    <span class="hljs-attr">showFileList</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">headers</span>: props.<span class="hljs-property">headers</span>,
    <span class="hljs-attr">fileList</span>: fileList.<span class="hljs-property">value</span>,
    <span class="hljs-attr">disabled</span>: props.<span class="hljs-property">disabled</span>,
  }));

  <span class="hljs-comment">/**
   * 验证图片尺寸是否符合要求
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">width</span> - 图片宽度
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">height</span> - 图片高度
   * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">boolean</span>} 是否符合要求
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">validateImageSize</span> = (<span class="hljs-params">width, height</span>) =&gt; {
    <span class="hljs-keyword">if</span> (props.<span class="hljs-property">width</span> &amp;&amp; props.<span class="hljs-property">height</span>) {
      <span class="hljs-keyword">return</span> width === props.<span class="hljs-property">width</span> &amp;&amp; height === props.<span class="hljs-property">height</span>;
    }
    <span class="hljs-keyword">if</span> (props.<span class="hljs-property">width</span>) {
      <span class="hljs-keyword">return</span> width === props.<span class="hljs-property">width</span>;
    }
    <span class="hljs-keyword">if</span> (props.<span class="hljs-property">height</span>) {
      <span class="hljs-keyword">return</span> height === props.<span class="hljs-property">height</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  };

  <span class="hljs-comment">/**
   * 上传前校验
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">File</span>} <span class="hljs-variable">file</span> - 待上传的文件
   * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Promise&lt;boolean&gt;</span>} 是否通过校验
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">beforeUpload</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">file</span>) =&gt; {
    <span class="hljs-comment">// 校验文件类型</span>
    <span class="hljs-keyword">const</span> fileTypeList = props.<span class="hljs-property">accept</span>
      .<span class="hljs-title function_">split</span>(<span class="hljs-string">','</span>)
      .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'.'</span>, <span class="hljs-string">''</span>));
    <span class="hljs-keyword">const</span> fileType = file.<span class="hljs-property">name</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>).<span class="hljs-title function_">pop</span>();

    <span class="hljs-keyword">if</span> (!fileTypeList.<span class="hljs-title function_">includes</span>(fileType)) {
      <span class="hljs-title class_">ElMessage</span>({
        <span class="hljs-attr">message</span>: <span class="hljs-string">`仅支持 <span class="hljs-subst">${fileTypeList.join(<span class="hljs-string">'、'</span>)}</span> 格式`</span>,
        <span class="hljs-attr">type</span>: <span class="hljs-string">'warning'</span>,
      });
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// 校验文件大小</span>
    <span class="hljs-keyword">if</span> (props.<span class="hljs-property">maxSize</span>) {
      <span class="hljs-keyword">const</span> fileSize = file.<span class="hljs-property">size</span> / <span class="hljs-number">1024</span>;
      <span class="hljs-keyword">const</span> maxSizeInKB =
        props.<span class="hljs-property">sizeUnit</span> === <span class="hljs-string">'MB'</span> ? props.<span class="hljs-property">maxSize</span> * <span class="hljs-number">1024</span> : props.<span class="hljs-property">maxSize</span>;
      <span class="hljs-keyword">if</span> (fileSize &gt; maxSizeInKB) {
        <span class="hljs-title class_">ElMessage</span>({
          <span class="hljs-attr">message</span>: <span class="hljs-string">`大小不能超过 <span class="hljs-subst">${props.maxSize}</span><span class="hljs-subst">${props.sizeUnit}</span>！`</span>,
          <span class="hljs-attr">type</span>: <span class="hljs-string">'warning'</span>,
        });
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
    }

    <span class="hljs-comment">// 校验图片尺寸</span>
    <span class="hljs-comment">// return new Promise((resolve, reject) =&gt; {</span>
    <span class="hljs-comment">//   const img = new Image();</span>
    <span class="hljs-comment">//   img.src = URL.createObjectURL(file);</span>
    <span class="hljs-comment">//   img.onload = () =&gt; {</span>
    <span class="hljs-comment">//     URL.revokeObjectURL(img.src);</span>
    <span class="hljs-comment">//     const { width, height } = img;</span>

    <span class="hljs-comment">//     if (!validateImageSize(width, height)) {</span>
    <span class="hljs-comment">//       const message =</span>
    <span class="hljs-comment">//         props.width &amp;&amp; props.height</span>
    <span class="hljs-comment">//           ? `图片尺寸必须为 ${props.width}x${props.height}`</span>
    <span class="hljs-comment">//           : props.width</span>
    <span class="hljs-comment">//             ? `图片宽度必须为 ${props.width}px`</span>
    <span class="hljs-comment">//             : `图片高度必须为 ${props.height}px`;</span>

    <span class="hljs-comment">//       ElMessage({</span>
    <span class="hljs-comment">//         message,</span>
    <span class="hljs-comment">//         type: 'warning',</span>
    <span class="hljs-comment">//       });</span>
    <span class="hljs-comment">//       reject(false);</span>
    <span class="hljs-comment">//       return;</span>
    <span class="hljs-comment">//     }</span>
    <span class="hljs-comment">//     loading.value = true;</span>
    <span class="hljs-comment">//     resolve(true);</span>
    <span class="hljs-comment">//   };</span>
    <span class="hljs-comment">//   img.onerror = () =&gt; {</span>
    <span class="hljs-comment">//     URL.revokeObjectURL(img.src);</span>
    <span class="hljs-comment">//     ElMessage({</span>
    <span class="hljs-comment">//       message: '图片加载失败',</span>
    <span class="hljs-comment">//       type: 'error',</span>
    <span class="hljs-comment">//     });</span>
    <span class="hljs-comment">//     reject(false);</span>
    <span class="hljs-comment">//   };</span>
    <span class="hljs-comment">// });</span>
  };

  <span class="hljs-comment">/**
   * 上传成功回调
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">response</span> - 服务器响应数据
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">uploadFile</span> - 上传文件对象
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Array</span>} <span class="hljs-variable">uploadFiles</span> - 上传文件列表
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSuccess</span> = (<span class="hljs-params">response, uploadFile, uploadFiles</span>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(response, uploadFile, uploadFiles,<span class="hljs-number">12345666</span>)
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span> (response.<span class="hljs-property">code</span> === <span class="hljs-number">200</span>) {
      fileList.<span class="hljs-property">value</span>.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">url</span>: response.<span class="hljs-property">data</span>.<span class="hljs-property">url</span> });
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(fileList.<span class="hljs-property">value</span>,<span class="hljs-number">12345</span>)
    } <span class="hljs-keyword">else</span> {
      proUploadImgRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">handleRemove</span>(uploadFile);
      <span class="hljs-title class_">ElMessage</span>({
        <span class="hljs-attr">message</span>: response.<span class="hljs-property">msg</span> || response.<span class="hljs-property">message</span> || <span class="hljs-string">'上传失败'</span>,
        <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span>,
      });
    }
    <span class="hljs-title function_">emit</span>(<span class="hljs-string">'success'</span>, response, uploadFile, uploadFiles);
  };

  <span class="hljs-comment">/**
   * 上传失败回调
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Error</span>} <span class="hljs-variable">error</span> - 错误信息
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">uploadFile</span> - 上传文件对象
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Array</span>} <span class="hljs-variable">uploadFiles</span> - 上传文件列表
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleError</span> = (<span class="hljs-params">error, uploadFile, uploadFiles</span>) =&gt; {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-title class_">ElMessage</span>({
      <span class="hljs-attr">message</span>: <span class="hljs-string">'上传失败'</span>,
      <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span>,
    });
    <span class="hljs-title function_">emit</span>(<span class="hljs-string">'error'</span>, error, uploadFile, uploadFiles);
  };

  <span class="hljs-comment">/**
   * 超出限制回调
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Array</span>} <span class="hljs-variable">files</span> - 超出限制的文件列表
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Array</span>} <span class="hljs-variable">uploadFiles</span> - 已上传的文件列表
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleExceed</span> = (<span class="hljs-params">files, uploadFiles</span>) =&gt; {
    <span class="hljs-title class_">ElMessage</span>({
      <span class="hljs-attr">message</span>: <span class="hljs-string">`最多只能上传 <span class="hljs-subst">${props.limit}</span> 张图片`</span>,
      <span class="hljs-attr">type</span>: <span class="hljs-string">'warning'</span>,
    });
    <span class="hljs-title function_">emit</span>(<span class="hljs-string">'exceed'</span>, files, uploadFiles);
  };

  <span class="hljs-comment">/**
   * 移除图片
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">file</span> - 要移除的文件对象
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">index</span> - 文件索引
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleRemove</span> = (<span class="hljs-params">file, index</span>) =&gt; {
    fileList.<span class="hljs-property">value</span>.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
    proUploadImgRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">handleRemove</span>(file);
    <span class="hljs-title function_">emit</span>(<span class="hljs-string">'remove'</span>, file);
  };
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.pro-upload-img-box</span> {
  <span class="hljs-selector-class">.pro-upload-img-content</span> {
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">flex-wrap</span>: wrap;
    // 已上传图片卡片样式
    <span class="hljs-selector-class">.upload-img-card</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
      <span class="hljs-attribute">position</span>: relative;
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> <span class="hljs-number">12px</span> <span class="hljs-number">12px</span> <span class="hljs-number">0</span>;
      // 图片样式
      <span class="hljs-selector-class">.img-sty</span> {
        <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
        <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
        <span class="hljs-attribute">overflow</span>: hidden;
        <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">6px</span>;
      }
      // 删除按钮样式
      <span class="hljs-selector-class">.img-close</span> {
        <span class="hljs-attribute">position</span>: absolute;
        <span class="hljs-attribute">right</span>: -<span class="hljs-number">6px</span>;
        <span class="hljs-attribute">top</span>: -<span class="hljs-number">6px</span>;
        <span class="hljs-attribute">width</span>: <span class="hljs-number">20px</span>;
        <span class="hljs-attribute">height</span>: <span class="hljs-number">20px</span>;
        <span class="hljs-attribute">cursor</span>: pointer;
        <span class="hljs-attribute">z-index</span>: <span class="hljs-number">2</span>;
      }
      // 遮罩层样式
      <span class="hljs-selector-class">.img-mask</span> {
        <span class="hljs-attribute">background</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.3</span>);
        <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">6px</span>;
        <span class="hljs-attribute">position</span>: absolute;
        <span class="hljs-attribute">top</span>: <span class="hljs-number">0</span>;
        <span class="hljs-attribute">left</span>: <span class="hljs-number">0</span>;
        <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
        <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
        <span class="hljs-attribute">pointer-events</span>: none;

        <span class="hljs-selector-class">.img-preview</span> {
          <span class="hljs-attribute">position</span>: absolute;
          <span class="hljs-attribute">right</span>: <span class="hljs-number">8px</span>;
          <span class="hljs-attribute">bottom</span>: <span class="hljs-number">8px</span>;
          <span class="hljs-attribute">width</span>: <span class="hljs-number">20px</span>;
          <span class="hljs-attribute">height</span>: <span class="hljs-number">20px</span>;
          <span class="hljs-attribute">pointer-events</span>: none;
        }
      }
    }

    // 禁用状态样式
    <span class="hljs-selector-class">.is-disabled</span> {
      :<span class="hljs-built_in">deep</span>(.el-upload--picture-card) {
        <span class="hljs-attribute">cursor</span>: not-allowed;
      }
    }
    // 上传按钮样式
    <span class="hljs-selector-class">.pro-upload-img</span> {
      <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">12px</span>;
      <span class="hljs-selector-class">.upload-card</span> {
        <span class="hljs-attribute">display</span>: flex;
        <span class="hljs-attribute">flex-direction</span>: column;
        <span class="hljs-attribute">align-items</span>: center;
        <span class="hljs-attribute">justify-content</span>: center;
        <span class="hljs-selector-class">.upload-icon</span> {
          <span class="hljs-attribute">font-size</span>: <span class="hljs-number">20px</span>;
          <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;
          <span class="hljs-attribute">text-align</span>: center;
          <span class="hljs-attribute">line-height</span>: <span class="hljs-number">100px</span>;
        }

        <span class="hljs-selector-class">.upload-text</span> {
          <span class="hljs-attribute">line-height</span>: <span class="hljs-number">24px</span>;
          <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;
          <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
          <span class="hljs-attribute">text-align</span>: center;
          <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">10px</span>;
        }
      }
    }

    // 上传组件样式覆盖
    :<span class="hljs-built_in">deep</span>(.el-upload--picture-card) {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
      <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#F8F8F9</span>;
    }
    :<span class="hljs-built_in">deep</span>(.el-upload-list__item) {
      <span class="hljs-attribute">width</span>: auto;
      <span class="hljs-attribute">height</span>: auto;
      <span class="hljs-attribute">overflow</span>: visible;
    }
  }
  // 提示文字样式
  <span class="hljs-selector-class">.upload-tip</span> {
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#909399</span>;
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h2 data-id="heading-2">上传视频</h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"pro-upload-video-box"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"pro-upload-video-content"</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 已上传视频列表 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
        <span class="hljs-attr">class</span>=<span class="hljs-string">"upload-video-card"</span>
        <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(item, index) in fileList"</span>
        <span class="hljs-attr">:key</span>=<span class="hljs-string">"index"</span>
      &gt;</span>
        <span class="hljs-comment">&lt;!-- 视频缩略图/播放按钮 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"video-thumbnail"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"playVideo(item.url)"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"video-icon"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">VideoPlay</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 视频信息 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"video-info"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"playVideo(item.url)"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"video-name"</span>&gt;</span>{{ getFileName(item.url) }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"video-size"</span>&gt;</span>{{ getFileSize(item.size) }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 删除按钮 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">el-image</span>
          <span class="hljs-attr">v-if</span>=<span class="hljs-string">"!disabled"</span>
          <span class="hljs-attr">src</span>=<span class="hljs-string">"https://static.wxb.com.cn/frontEnd/images/ideacome-vue3-component/img-close.png"</span>
          <span class="hljs-attr">class</span>=<span class="hljs-string">"video-close"</span>
          @<span class="hljs-attr">click</span>=<span class="hljs-string">"handleRemove(item, index)"</span>
        /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-comment">&lt;!-- 上传组件 --&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">el-upload</span>
        <span class="hljs-attr">v-if</span>=<span class="hljs-string">"!disabled"</span>
        <span class="hljs-attr">v-loading</span>=<span class="hljs-string">"loading"</span>
        <span class="hljs-attr">ref</span>=<span class="hljs-string">"proUploadVideoRef"</span>
        <span class="hljs-attr">:class</span>=<span class="hljs-string">"['pro-upload-video', { 'is-disabled': disabled }]"</span>
        <span class="hljs-attr">v-bind</span>=<span class="hljs-string">"uploadProps"</span>
        <span class="hljs-attr">:before-upload</span>=<span class="hljs-string">"beforeUpload"</span>
        <span class="hljs-attr">:on-success</span>=<span class="hljs-string">"handleSuccess"</span>
        <span class="hljs-attr">:on-error</span>=<span class="hljs-string">"handleError"</span>
        <span class="hljs-attr">:on-exceed</span>=<span class="hljs-string">"handleExceed"</span>
        <span class="hljs-attr">:on-progress</span>=<span class="hljs-string">"handleProgress"</span>
      &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">slot</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"upload-card"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">el-icon</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"upload-icon"</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">Plus</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">el-icon</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"uploadText"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"upload-text"</span>&gt;</span>
              {{ uploadText }}
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">el-upload</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 提示信息 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">slot</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"tip"</span>  <span class="hljs-attr">v-if</span>=<span class="hljs-string">"!disabled"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"upload-tip"</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"tip"</span>&gt;</span>
        {{ tip }}
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">slot</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"ProUploadVideo"</span>&gt;</span><span class="javascript">
  <span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
  <span class="hljs-keyword">import</span> { <span class="hljs-title class_">Plus</span>, <span class="hljs-title class_">VideoPlay</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@element-plus/icons-vue'</span>;
  <span class="hljs-keyword">import</span> { <span class="hljs-title class_">ElMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'element-plus'</span>;

  <span class="hljs-comment">// Props 定义</span>
  <span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>({
    <span class="hljs-comment">/** 上传地址 */</span>
    <span class="hljs-attr">action</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
      <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span>,
    },
    <span class="hljs-comment">/** 请求头 */</span>
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">Object</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-function">() =&gt;</span> ({}),
    },
    <span class="hljs-comment">/** 是否支持多选 */</span>
    <span class="hljs-attr">multiple</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span>,
    },
    <span class="hljs-comment">/** 最大上传数量，0表示不限制 */</span>
    <span class="hljs-attr">limit</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-number">0</span>,
    },
    <span class="hljs-comment">/** 接受的文件类型，如：.mp4,.avi,.mov */</span>
    <span class="hljs-attr">accept</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-string">'.mp4,.avi,.mov,.wmv,.flv,.webm'</span>,
    },
    <span class="hljs-comment">/** 文件大小限制 */</span>
    <span class="hljs-attr">maxSize</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-number">0</span>,
    },
    <span class="hljs-comment">/** 文件大小单位（KB/MB） */</span>
    <span class="hljs-attr">sizeUnit</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-string">'MB'</span>,
      <span class="hljs-attr">validator</span>: <span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> [<span class="hljs-string">'KB'</span>, <span class="hljs-string">'MB'</span>].<span class="hljs-title function_">includes</span>(value),
    },
    <span class="hljs-comment">/** 上传提示文字 */</span>
    <span class="hljs-attr">uploadText</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-string">'上传视频'</span>,
    },
    <span class="hljs-comment">/** 上传提示说明 */</span>
    <span class="hljs-attr">tip</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">String</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-string">''</span>,
    },
    <span class="hljs-comment">/** 是否禁用 */</span>
    <span class="hljs-attr">disabled</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">Boolean</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-literal">false</span>,
    },
  });
  <span class="hljs-comment">/** 初始文件列表 */</span>
  <span class="hljs-keyword">const</span> fileList = <span class="hljs-title function_">defineModel</span>(<span class="hljs-string">'fileList'</span>, {
    <span class="hljs-attr">type</span>: <span class="hljs-title class_">Array</span>,
    <span class="hljs-attr">default</span>: <span class="hljs-function">() =&gt;</span> [],
  });

  <span class="hljs-comment">// 事件定义</span>
  <span class="hljs-keyword">const</span> emit = <span class="hljs-title function_">defineEmits</span>([<span class="hljs-string">'success'</span>, <span class="hljs-string">'error'</span>, <span class="hljs-string">'exceed'</span>, <span class="hljs-string">'remove'</span>, <span class="hljs-string">'deleteAnnex'</span>, <span class="hljs-string">'progress'</span>]);

  <span class="hljs-keyword">const</span> proUploadVideoRef = <span class="hljs-title function_">ref</span>();
  <span class="hljs-keyword">const</span> loading = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-keyword">const</span> uploadProps = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> ({
    <span class="hljs-attr">action</span>: props.<span class="hljs-property">action</span>,
    <span class="hljs-attr">accept</span>: props.<span class="hljs-property">accept</span>,
    <span class="hljs-attr">limit</span>: props.<span class="hljs-property">limit</span>,
    <span class="hljs-attr">multiple</span>: props.<span class="hljs-property">multiple</span>,
    <span class="hljs-attr">listType</span>: <span class="hljs-string">'text'</span>,
    <span class="hljs-attr">showFileList</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">headers</span>: props.<span class="hljs-property">headers</span>,
    <span class="hljs-attr">fileList</span>: fileList.<span class="hljs-property">value</span>,
    <span class="hljs-attr">disabled</span>: props.<span class="hljs-property">disabled</span>,
  }));

  <span class="hljs-comment">/**
   * 获取文件名
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">url</span> - 文件路径
   * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">string</span>} 文件名
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">getFileName</span> = (<span class="hljs-params">url</span>) =&gt; {
    <span class="hljs-keyword">if</span> (!url) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
    <span class="hljs-keyword">const</span> fileName = url.<span class="hljs-title function_">substring</span>(url.<span class="hljs-title function_">lastIndexOf</span>(<span class="hljs-string">'/'</span>) + <span class="hljs-number">1</span>);
    <span class="hljs-keyword">return</span> fileName.<span class="hljs-property">length</span> &gt; <span class="hljs-number">15</span> ? fileName.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, <span class="hljs-number">15</span>) + <span class="hljs-string">'...'</span> : fileName;
  };

  <span class="hljs-comment">/**
   * 获取文件大小显示
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">size</span> - 文件大小（字节）
   * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">string</span>} 格式化后的文件大小
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">getFileSize</span> = (<span class="hljs-params">size</span>) =&gt; {
    <span class="hljs-keyword">if</span> (!size) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;
    <span class="hljs-keyword">const</span> units = [<span class="hljs-string">'B'</span>, <span class="hljs-string">'KB'</span>, <span class="hljs-string">'MB'</span>, <span class="hljs-string">'GB'</span>];
    <span class="hljs-keyword">let</span> unitIndex = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> fileSize = size;

    <span class="hljs-keyword">while</span> (fileSize &gt;= <span class="hljs-number">1024</span> &amp;&amp; unitIndex &lt; units.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>) {
      fileSize /= <span class="hljs-number">1024</span>;
      unitIndex++;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${fileSize.toFixed(<span class="hljs-number">2</span>)}</span> <span class="hljs-subst">${units[unitIndex]}</span>`</span>;
  };

  <span class="hljs-comment">/**
   * 上传前校验
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">File</span>} <span class="hljs-variable">file</span> - 待上传的文件
   * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Promise&lt;boolean&gt;</span>} 是否通过校验
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">beforeUpload</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">file</span>) =&gt; {
    <span class="hljs-comment">// 校验文件类型</span>
    <span class="hljs-keyword">const</span> fileTypeList = props.<span class="hljs-property">accept</span>
      .<span class="hljs-title function_">split</span>(<span class="hljs-string">','</span>)
      .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'.'</span>, <span class="hljs-string">''</span>).<span class="hljs-title function_">toLowerCase</span>());
    <span class="hljs-keyword">const</span> fileType = file.<span class="hljs-property">name</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>).<span class="hljs-title function_">pop</span>().<span class="hljs-title function_">toLowerCase</span>();

    <span class="hljs-keyword">if</span> (!fileTypeList.<span class="hljs-title function_">includes</span>(fileType)) {
      <span class="hljs-title class_">ElMessage</span>({
        <span class="hljs-attr">message</span>: <span class="hljs-string">`仅支持 <span class="hljs-subst">${props.accept}</span> 格式`</span>,
        <span class="hljs-attr">type</span>: <span class="hljs-string">'warning'</span>,
      });
      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// 校验文件大小</span>
    <span class="hljs-keyword">if</span> (props.<span class="hljs-property">maxSize</span>) {
      <span class="hljs-keyword">const</span> fileSize = file.<span class="hljs-property">size</span>;
      <span class="hljs-keyword">const</span> maxSizeInBytes =
        props.<span class="hljs-property">sizeUnit</span> === <span class="hljs-string">'MB'</span> ? props.<span class="hljs-property">maxSize</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> : props.<span class="hljs-property">maxSize</span> * <span class="hljs-number">1024</span>;
      <span class="hljs-keyword">if</span> (fileSize &gt; maxSizeInBytes) {
        <span class="hljs-title class_">ElMessage</span>({
          <span class="hljs-attr">message</span>: <span class="hljs-string">`大小不能超过 <span class="hljs-subst">${props.maxSize}</span><span class="hljs-subst">${props.sizeUnit}</span>！`</span>,
          <span class="hljs-attr">type</span>: <span class="hljs-string">'warning'</span>,
        });
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
      }
    }

    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
  };

  <span class="hljs-comment">/**
   * 上传进度回调
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">event</span> - 进度事件对象
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">uploadFile</span> - 上传文件对象
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Array</span>} <span class="hljs-variable">uploadFiles</span> - 上传文件列表
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleProgress</span> = (<span class="hljs-params">event, uploadFile, uploadFiles</span>) =&gt; {
    <span class="hljs-title function_">emit</span>(<span class="hljs-string">'progress'</span>, event, uploadFile, uploadFiles);
  };

  <span class="hljs-comment">/**
   * 上传成功回调
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">response</span> - 服务器响应数据
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">uploadFile</span> - 上传文件对象
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Array</span>} <span class="hljs-variable">uploadFiles</span> - 上传文件列表
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSuccess</span> = (<span class="hljs-params">response, uploadFile, uploadFiles</span>) =&gt; {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">if</span> (response.<span class="hljs-property">code</span> === <span class="hljs-number">200</span>) {
      fileList.<span class="hljs-property">value</span>.<span class="hljs-title function_">push</span>({
        <span class="hljs-attr">url</span>: response.<span class="hljs-property">data</span>.<span class="hljs-property">url</span>,
        <span class="hljs-attr">name</span>: uploadFile.<span class="hljs-property">name</span>,
        <span class="hljs-attr">size</span>: uploadFile.<span class="hljs-property">size</span>
      });
    } <span class="hljs-keyword">else</span> {
      proUploadVideoRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">handleRemove</span>(uploadFile);
      <span class="hljs-title class_">ElMessage</span>({
        <span class="hljs-attr">message</span>: response.<span class="hljs-property">msg</span> || response.<span class="hljs-property">message</span> || <span class="hljs-string">'上传失败'</span>,
        <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span>,
      });
    }
    <span class="hljs-title function_">emit</span>(<span class="hljs-string">'success'</span>, response, uploadFile, uploadFiles);
  };

  <span class="hljs-comment">/**
   * 上传失败回调
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Error</span>} <span class="hljs-variable">error</span> - 错误信息
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">uploadFile</span> - 上传文件对象
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Array</span>} <span class="hljs-variable">uploadFiles</span> - 上传文件列表
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleError</span> = (<span class="hljs-params">error, uploadFile, uploadFiles</span>) =&gt; {
    loading.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
    <span class="hljs-title class_">ElMessage</span>({
      <span class="hljs-attr">message</span>: <span class="hljs-string">'上传失败'</span>,
      <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span>,
    });
    <span class="hljs-title function_">emit</span>(<span class="hljs-string">'error'</span>, error, uploadFile, uploadFiles);
  };

  <span class="hljs-comment">/**
   * 超出限制回调
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Array</span>} <span class="hljs-variable">files</span> - 超出限制的文件列表
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Array</span>} <span class="hljs-variable">uploadFiles</span> - 已上传的文件列表
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleExceed</span> = (<span class="hljs-params">files, uploadFiles</span>) =&gt; {
    <span class="hljs-title class_">ElMessage</span>({
      <span class="hljs-attr">message</span>: <span class="hljs-string">`最多只能上传 <span class="hljs-subst">${props.limit}</span> 个视频`</span>,
      <span class="hljs-attr">type</span>: <span class="hljs-string">'warning'</span>,
    });
    <span class="hljs-title function_">emit</span>(<span class="hljs-string">'exceed'</span>, files, uploadFiles);
  };

  <span class="hljs-comment">/**
   * 移除视频
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">file</span> - 要移除的文件对象
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} <span class="hljs-variable">index</span> - 文件索引
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleRemove</span> = (<span class="hljs-params">file, index</span>) =&gt; {
    fileList.<span class="hljs-property">value</span>.<span class="hljs-title function_">splice</span>(index, <span class="hljs-number">1</span>);
    proUploadVideoRef.<span class="hljs-property">value</span>.<span class="hljs-title function_">handleRemove</span>(file);
    <span class="hljs-title function_">emit</span>(<span class="hljs-string">'deleteAnnex'</span>, index);
  };

  <span class="hljs-comment">/**
   * 播放视频
   * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">url</span> - 视频地址
   */</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">playVideo</span> = (<span class="hljs-params">url</span>) =&gt; {
    <span class="hljs-keyword">if</span> (!url) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 创建视频播放弹窗</span>
    <span class="hljs-keyword">const</span> videoDialog = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
    videoDialog.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    `</span>;

    <span class="hljs-comment">// 创建视频元素</span>
    <span class="hljs-keyword">const</span> videoWrapper = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
    videoWrapper.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">`
      position: relative;
      max-width: 90%;
      max-height: 90%;
    `</span>;

    <span class="hljs-comment">// 创建加载提示</span>
    <span class="hljs-keyword">const</span> loadingIndicator = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
    loadingIndicator.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">'视频加载中...'</span>;
    loadingIndicator.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">`
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 16px;
      z-index: 1;
    `</span>;
    videoWrapper.<span class="hljs-title function_">appendChild</span>(loadingIndicator);

    <span class="hljs-keyword">const</span> videoElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'video'</span>);
    videoElement.<span class="hljs-property">controls</span> = <span class="hljs-literal">true</span>;
    videoElement.<span class="hljs-property">autoplay</span> = <span class="hljs-literal">true</span>;
    videoElement.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">`
      max-width: 100%;
      max-height: 80vh;
      outline: none;
      background: black;
      display: none; /* 初始隐藏，等待加载完成后再显示 */
    `</span>;

    <span class="hljs-comment">// 尝试多种视频格式</span>
    <span class="hljs-keyword">const</span> fileExtension = url.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>).<span class="hljs-title function_">pop</span>().<span class="hljs-title function_">toLowerCase</span>();
    <span class="hljs-keyword">const</span> sourceElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'source'</span>);
    sourceElement.<span class="hljs-property">src</span> = url;

    <span class="hljs-comment">// 根据文件扩展名设置正确的 MIME 类型</span>
    <span class="hljs-keyword">const</span> mimeTypes = {
      <span class="hljs-string">'mp4'</span>: <span class="hljs-string">'video/mp4'</span>,
      <span class="hljs-string">'webm'</span>: <span class="hljs-string">'video/webm'</span>,
      <span class="hljs-string">'ogg'</span>: <span class="hljs-string">'video/ogg'</span>,
      <span class="hljs-string">'avi'</span>: <span class="hljs-string">'video/avi'</span>,
      <span class="hljs-string">'mov'</span>: <span class="hljs-string">'video/quicktime'</span>,
      <span class="hljs-string">'wmv'</span>: <span class="hljs-string">'video/x-ms-wmv'</span>,
      <span class="hljs-string">'flv'</span>: <span class="hljs-string">'video/x-flv'</span>
    };

    sourceElement.<span class="hljs-property">type</span> = mimeTypes[fileExtension] || <span class="hljs-string">'video/mp4'</span>;
    videoElement.<span class="hljs-title function_">appendChild</span>(sourceElement);

    <span class="hljs-comment">// 视频加载成功的处理</span>
    videoElement.<span class="hljs-property">onloadeddata</span> = <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 隐藏加载指示器并显示视频</span>
      <span class="hljs-keyword">if</span> (videoWrapper.<span class="hljs-title function_">contains</span>(loadingIndicator)) {
        videoWrapper.<span class="hljs-title function_">removeChild</span>(loadingIndicator);
      }
      videoElement.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'block'</span>;
    };

    <span class="hljs-comment">// 视频加载失败的处理</span>
    videoElement.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 隐藏加载指示器</span>
      <span class="hljs-keyword">if</span> (videoWrapper.<span class="hljs-title function_">contains</span>(loadingIndicator)) {
        videoWrapper.<span class="hljs-title function_">removeChild</span>(loadingIndicator);
      }

      <span class="hljs-comment">// 显示错误信息</span>
      <span class="hljs-keyword">const</span> errorIndicator = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
      errorIndicator.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">'视频加载失败，请稍后重试'</span>;
      errorIndicator.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">`
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #ff6b6b;
        font-size: 16px;
        background: rgba(0, 0, 0, 0.7);
        padding: 10px 20px;
        border-radius: 4px;
        z-index: 1;
      `</span>;
      videoWrapper.<span class="hljs-title function_">appendChild</span>(errorIndicator);

      <span class="hljs-comment">// 3秒后自动关闭</span>
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">contains</span>(videoDialog)) {
          <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(videoDialog);
        }
      }, <span class="hljs-number">3000</span>);
    };

    <span class="hljs-comment">// 创建关闭按钮</span>
    <span class="hljs-keyword">const</span> closeButton = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'button'</span>);
    closeButton.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">'&amp;times;'</span>;
    closeButton.<span class="hljs-property">style</span>.<span class="hljs-property">cssText</span> = <span class="hljs-string">`
      position: absolute;
      top: -40px;
      right: 0;
      background: transparent;
      border: none;
      color: white;
      font-size: 36px;
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
    `</span>;

    closeButton.<span class="hljs-property">onmouseover</span> = <span class="hljs-function">() =&gt;</span> {
      closeButton.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">'scale(1.1)'</span>;
    };

    closeButton.<span class="hljs-property">onmouseout</span> = <span class="hljs-function">() =&gt;</span> {
      closeButton.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">'scale(1)'</span>;
    };

    closeButton.<span class="hljs-property">onclick</span> = <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 暂停视频并移除弹窗</span>
      videoElement.<span class="hljs-title function_">pause</span>();
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">contains</span>(videoDialog)) {
        <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(videoDialog);
      }
    };

    videoWrapper.<span class="hljs-title function_">appendChild</span>(videoElement);
    videoWrapper.<span class="hljs-title function_">appendChild</span>(closeButton);
    videoDialog.<span class="hljs-title function_">appendChild</span>(videoWrapper);
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(videoDialog);

    <span class="hljs-comment">// 点击背景关闭</span>
    videoDialog.<span class="hljs-property">onclick</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (e.<span class="hljs-property">target</span> === videoDialog) {
        videoElement.<span class="hljs-title function_">pause</span>();
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">contains</span>(videoDialog)) {
          <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(videoDialog);
        }
      }
    };

    <span class="hljs-comment">// ESC键关闭</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleEscKey</span> = (<span class="hljs-params">e</span>) =&gt; {
      <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> === <span class="hljs-string">'Escape'</span>) {
        videoElement.<span class="hljs-title function_">pause</span>();
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">contains</span>(videoDialog)) {
          <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(videoDialog);
        }
        <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'keydown'</span>, handleEscKey);
      }
    };

    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keydown'</span>, handleEscKey);
  };
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"scss"</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.pro-upload-video-box</span> {
  <span class="hljs-selector-class">.pro-upload-video-content</span> {
    <span class="hljs-attribute">display</span>: flex;
    // <span class="hljs-attribute">flex-wrap</span>: wrap;
    // 已上传视频卡片样式
    <span class="hljs-selector-class">.upload-video-card</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">max-width</span>: <span class="hljs-number">300px</span>;
      <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
      <span class="hljs-attribute">position</span>: relative;
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> <span class="hljs-number">12px</span> <span class="hljs-number">12px</span> <span class="hljs-number">0</span>;
      <span class="hljs-attribute">display</span>: flex;
      <span class="hljs-attribute">align-items</span>: center;
      <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ebeef5</span>;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">6px</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
      <span class="hljs-attribute">box-sizing</span>: border-box;

      // 视频缩略图样式
      <span class="hljs-selector-class">.video-thumbnail</span> {
        <span class="hljs-attribute">width</span>: <span class="hljs-number">50px</span>;
        <span class="hljs-attribute">height</span>: <span class="hljs-number">50px</span>;
        <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#ecf5ff</span>;
        <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">6px</span>;
        <span class="hljs-attribute">display</span>: flex;
        <span class="hljs-attribute">align-items</span>: center;
        <span class="hljs-attribute">justify-content</span>: center;
        <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">10px</span>;
        <span class="hljs-attribute">cursor</span>: pointer;
        <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.3s</span>;

        &amp;<span class="hljs-selector-pseudo">:hover</span> {
          <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#409eff</span>;
          <span class="hljs-selector-class">.video-icon</span> {
            <span class="hljs-attribute">color</span>: white;
          }
        }

        <span class="hljs-selector-class">.video-icon</span> {
          <span class="hljs-attribute">font-size</span>: <span class="hljs-number">24px</span>;
          <span class="hljs-attribute">color</span>: <span class="hljs-number">#409eff</span>;
        }
      }

      // 视频信息样式
      <span class="hljs-selector-class">.video-info</span> {
        <span class="hljs-attribute">flex</span>: <span class="hljs-number">1</span>;
        <span class="hljs-attribute">min-width</span>: <span class="hljs-number">0</span>;
        <span class="hljs-attribute">cursor</span>: pointer;

        <span class="hljs-selector-class">.video-name</span> {
          <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
          <span class="hljs-attribute">color</span>: <span class="hljs-number">#606266</span>;
          <span class="hljs-attribute">white-space</span>: nowrap;
          <span class="hljs-attribute">overflow</span>: hidden;
          <span class="hljs-attribute">text-overflow</span>: ellipsis;
          <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">5px</span>;
        }

        <span class="hljs-selector-class">.video-size</span> {
          <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>;
          <span class="hljs-attribute">color</span>: <span class="hljs-number">#909399</span>;
        }
      }

      // 删除按钮样式
      <span class="hljs-selector-class">.video-close</span> {
        <span class="hljs-attribute">position</span>: absolute;
        <span class="hljs-attribute">right</span>: -<span class="hljs-number">8px</span>;
        <span class="hljs-attribute">top</span>: -<span class="hljs-number">8px</span>;
        <span class="hljs-attribute">width</span>: <span class="hljs-number">20px</span>;
        <span class="hljs-attribute">height</span>: <span class="hljs-number">20px</span>;
        <span class="hljs-attribute">cursor</span>: pointer;
        <span class="hljs-attribute">z-index</span>: <span class="hljs-number">2</span>;
      }
    }

    // 禁用状态样式
    <span class="hljs-selector-class">.is-disabled</span> {
      :<span class="hljs-built_in">deep</span>(.el-upload--text) {
        <span class="hljs-attribute">cursor</span>: not-allowed;
      }
    }
    // 上传按钮样式
    <span class="hljs-selector-class">.pro-upload-video</span> {
      <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">12px</span>;
      <span class="hljs-selector-class">.upload-card</span> {
        <span class="hljs-attribute">display</span>: flex;
        <span class="hljs-attribute">flex-direction</span>: column;
        <span class="hljs-attribute">align-items</span>: center;
        <span class="hljs-attribute">justify-content</span>: center;
        <span class="hljs-attribute">width</span>: <span class="hljs-number">100px</span>;
        <span class="hljs-attribute">height</span>: <span class="hljs-number">100px</span>;
        <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> dashed <span class="hljs-number">#d9d9d9</span>;
        <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">6px</span>;
        <span class="hljs-attribute">cursor</span>: pointer;
        <span class="hljs-attribute">transition</span>: border-color <span class="hljs-number">0.3s</span>;

        &amp;<span class="hljs-selector-pseudo">:hover</span> {
          <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#409eff</span>;
        }

        <span class="hljs-selector-class">.upload-icon</span> {
          <span class="hljs-attribute">font-size</span>: <span class="hljs-number">28px</span>;
          <span class="hljs-attribute">color</span>: <span class="hljs-number">#8c939d</span>;
          <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">5px</span>;
        }

        <span class="hljs-selector-class">.upload-text</span> {
          <span class="hljs-attribute">line-height</span>: <span class="hljs-number">24px</span>;
          <span class="hljs-attribute">color</span>: <span class="hljs-number">#8c939d</span>;
          <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
          <span class="hljs-attribute">text-align</span>: center;
        }
      }
    }

    // 上传组件样式覆盖
    :<span class="hljs-built_in">deep</span>(.el-upload) {
      <span class="hljs-attribute">width</span>: auto;
      <span class="hljs-attribute">height</span>: auto;
    }
  }
  // 提示文字样式
  <span class="hljs-selector-class">.upload-tip</span> {
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#909399</span>;
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从日常使用到代码实现：B 站签名编辑的 OOP 封装思路与实践]]></title>    <link>https://juejin.cn/post/7579410911057723418</link>    <guid>https://juejin.cn/post/7579410911057723418</guid>    <pubDate>2025-12-03T09:20:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579410911057723418" data-draft-id="7579256547789209641" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从日常使用到代码实现：B 站签名编辑的 OOP 封装思路与实践"/> <meta itemprop="keywords" content="ECMAScript 6,代码规范,JavaScript"/> <meta itemprop="datePublished" content="2025-12-03T09:20:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="有意义"/> <meta itemprop="url" content="https://juejin.cn/user/1739866211617625"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从日常使用到代码实现：B 站签名编辑的 OOP 封装思路与实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1739866211617625/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    有意义
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T09:20:48.000Z" title="Wed Dec 03 2025 09:20:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atelier-savanna-light">.hljs-comment,.hljs-quote{color:#5f6d64}.hljs-attribute,.hljs-link,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#b16139}.hljs-built_in,.hljs-builtin-name,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#9f713c}.hljs-bullet,.hljs-string,.hljs-symbol{color:#489963}.hljs-section,.hljs-title{color:#478c90}.hljs-keyword,.hljs-selector-tag{color:#55859b}.hljs-addition,.hljs-deletion{color:#171c19;display:inline-block;width:100%}.hljs-deletion{background-color:#b16139}.hljs-addition{background-color:#489963}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#ecf4ee;color:#526057}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在浏览 B 站（哔哩哔哩）时，你或许留意到：点击个人主页的“个性签名”，无需跳转页面或弹出复杂表单，就能直接在原位置编辑。这种“就地编辑”（Edit-in-Place）的交互方式，简洁、直观又高效，极大优化了用户体验 ✨。</p>
<p>今天，我将基于 OOP 风格的 JavaScript 代码，从零实现一个类似的就地编辑组件。过程中会分享封装思路与实践细节，剖析核心逻辑，并探索如何将其模块化、通用化，最终构建一个轻量、清晰且可复用的前端小工具 🛠️。
🎯 <strong>功能目标</strong><br/>
我们要实现的效果如下：</p>
<ul>
<li>页面展示一段文本（例如：“这个家伙很懒，什么都没有留下”）；</li>
<li>点击文本后，原地切换为带「保存」和「取消」按钮的可编辑输入框 ✏️；</li>
<li>点击「保存」应用新内容 ✔️，点击「取消」还原原始值 ↩️；</li>
<li>全程无页面刷新，交互流畅自然。</li>
</ul>
<p>这正是 B 站个性签名就地编辑功能的核心逻辑简化版 💡。</p>
<hr/>
<h2 data-id="heading-0">1. 封装起点：用构造函数定义组件</h2>
<p>💡 面向对象封装：EditInPlace 类</p>
<p>为了让逻辑更清晰、组件更易复用，我选择用面向对象的方式，将就地编辑功能抽象为一个独立的 <code>EditInPlace</code> 类。设计时遵循以下几点：</p>
<ul>
<li><strong>职责集中</strong>：文本显示、输入切换、事件处理等全部由类自身管理；</li>
<li><strong>接口简洁</strong>：外部仅需提供容器元素、初始内容和唯一标识，即可完成初始化；</li>
<li><strong>便于集成</strong>：采用单类单文件结构，开箱即用，轻松融入现代前端项目。</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">EditInPlace</span>(<span class="hljs-params">id, value, parentElement</span>) {
  <span class="hljs-comment">// {} 空对象 this指向它</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value || <span class="hljs-string">'这个家伙很懒，什么都没有留下'</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentElement</span> = parentElement;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span> = <span class="hljs-literal">null</span>;   <span class="hljs-comment">// 预声明组件自身的根容器元素（通常是 &lt;div&gt;）</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span> = <span class="hljs-literal">null</span>;         <span class="hljs-comment">// 保存外部传入的挂载容器（即该组件将被插入到哪个 DOM 元素内）。</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span> = <span class="hljs-literal">null</span>;       <span class="hljs-comment">// 取消</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span> = <span class="hljs-literal">null</span>;       <span class="hljs-comment">// 用于编辑文本内容（即编辑状态下的输入框）</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span> = <span class="hljs-literal">null</span>;      <span class="hljs-comment">// 用于展示静态文本（即非编辑状态下的内容）</span>
  <span class="hljs-comment">//  如果不保存这些引用，每次操作都要通过 querySelector 查找，效率低且代码冗余。</span>
  <span class="hljs-comment">// 代码比较多，按功能分模块 拆函数</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createElement</span>();           <span class="hljs-comment">// DOM 对象创建</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">attachEvent</span>();             <span class="hljs-comment">// 事件添加</span>
}
</code></pre>
<p>在本实现中，我采用了 JavaScript 经典的 <strong>“构造函数 + 原型方法”</strong> 模式。虽然如今 ES6 的 <code>class</code> 语法已成为主流，但在需要兼容老旧浏览器（如 IE）或用于教学演示时，这种传统写法反而更能揭示 JavaScript 面向对象的本质，且足够清晰可靠。</p>
<p>设计上有两个关键细节值得说明：</p>
<ol>
<li><strong>DOM 引用提前声明为 <code>null</code></strong><br/>
在构造函数中，所有将要使用的 DOM 元素（如输入框、按钮、容器等）都预先初始化为 <code>null</code>。这不仅让组件的内部结构一目了然，也方便在调试时快速判断元素是否已创建，同时为后续可能的销毁与内存清理提供便利。</li>
<li><strong>构造函数只做初始化，不碰 DOM</strong><br/>
真正的 DOM 创建和事件绑定被拆分到独立的方法（如 <code>createElement</code> 和 <code>attachEvent</code>）中。构造函数仅负责接收参数、设置初始状态并调度这些方法。这种做法遵循了<strong>单一职责原则</strong>——初始化归初始化，渲染归渲染，逻辑解耦，代码更易读、可测、可维护。</li>
</ol>
<p>正是这些看似微小的设计选择，让一个简单的“就地编辑”组件既轻量，又具备良好的工程结构。</p>
<h2 data-id="heading-1">2. 构建骨架：一次挂载，高效渲染</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 封装了DOM操作</span>
  <span class="hljs-attr">createElement</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// DOM 内存 </span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>.<span class="hljs-property">id</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>;

    <span class="hljs-comment">// 值</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'span'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-property">innerHTML</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>);

    <span class="hljs-comment">// 输入框</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'input'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">type</span> = <span class="hljs-string">'text'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">value</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentElement</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'input'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>.<span class="hljs-property">type</span> = <span class="hljs-string">'button'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>.<span class="hljs-property">value</span> = <span class="hljs-string">'保存'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'input'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>.<span class="hljs-property">type</span> = <span class="hljs-string">'button'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>.<span class="hljs-property">value</span> = <span class="hljs-string">'取消'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">convertToText</span>(); <span class="hljs-comment">// 切换到文本显示状态</span>
  }
</code></pre>
<h3 data-id="heading-2">设计亮点：优化用户体验与兼容性的细致考量</h3>
<p>在设计这个“就地编辑”组件时，我们特别注重了性能优化以及初始状态的正确展示，并且确保了良好的浏览器兼容性。以下是一些关键的设计亮点：</p>
<h4 data-id="heading-3">1. <strong>内存中预创建元素</strong></h4>
<p>所有涉及的界面元素（如容器 <code>&lt;div&gt;</code>、静态文本 <code>&lt;span&gt;</code>、输入框 <code>&lt;input&gt;</code> 以及按钮）都在JavaScript运行环境中预先构建完成，仅在所有元素准备就绪后，一次性挂载到DOM树上。这种方法有效减少了由于频繁修改DOM结构而导致的重排和重绘现象，从而提升了页面加载速度和响应性能。</p>
<h4 data-id="heading-4">2. <strong>立即调用 <code>convertToText()</code> 确保初始状态</strong></h4>
<p>在组件初始化完成后，我们会立刻调用 <code>convertToText()</code> 方法来设置其为只读文本模式。这一操作保证了用户首次看到的组件处于正确的初始状态，即以静态文本的形式展现，而不是意外地显示为可编辑状态或者出现任何视觉上的不一致。</p>
<h4 data-id="heading-5">3. <strong>选择 <code>&lt;input type="button"&gt;</code> 超越 <code>&lt;button&gt;</code></strong></h4>
<p>尽管使用 <code>&lt;input type="button"&gt;</code> 这种方式看起来可能不如现代的 <code>&lt;button&gt;</code> 元素那么直观或流行，但它的存在提供了一种极佳的浏览器兼容性解决方案。考虑到网络环境的多样性，不同的用户可能会使用各种版本的浏览器，包括一些较老的版本。通过采用这种更为传统的表单元素，可以确保我们的“就地编辑”功能在尽可能多的环境下都能正常工作，为用户提供无缝的体验。</p>
<p>这些设计决策反映了我们在追求高效能、良好用户体验的同时，也不忽视对广泛设备和浏览器的支持。每一个细节都经过深思熟虑，旨在为用户提供既快速又可靠的交互体验。</p>
<h2 data-id="heading-6">3. 视图切换：复用 DOM 而非反复创建</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">convertToText</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>; <span class="hljs-comment">// 隐藏</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>; <span class="hljs-comment">// 隐藏</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>; <span class="hljs-comment">// 隐藏</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'inline'</span>; <span class="hljs-comment">// 可见</span>
  },
  <span class="hljs-attr">convertToField</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>; <span class="hljs-comment">// 隐藏</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'inline'</span>; <span class="hljs-comment">// 可见</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">value</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>; 
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'inline'</span>; <span class="hljs-comment">// 可见</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'inline'</span>; <span class="hljs-comment">// 可见</span>
  }
</code></pre>
<h3 data-id="heading-7">为什么这样设计？——状态切换优于反复创建</h3>
<p>在实现“就地编辑”功能时，我们<strong>没有采用“销毁再重建 DOM”的方式</strong>，而是选择<strong>复用已有的元素，仅通过切换显示/隐藏状态来切换视图</strong>。这种设计带来了显著的性能优势：</p>
<ul>
<li><strong>避免不必要的 DOM 操作</strong>：频繁创建和移除元素会触发浏览器的重排（reflow）与重绘（repaint），影响渲染性能；</li>
<li><strong>提升交互响应速度</strong>：用户点击即切换，无需等待新元素生成，体验更流畅；</li>
<li><strong>降低内存开销</strong>：所有节点只创建一次，后续仅修改样式属性，资源消耗更小。</li>
</ul>
<hr/>
<h3 data-id="heading-8">确保数据一致性：每次进入编辑都同步最新值</h3>
<p>细心的同学可能注意到，在 <code>convertToField</code> 方法中，有这样一行关键代码：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">value</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;
</code></pre>
<p>这并非多余操作，而是一道<strong>防止脏数据的重要防线</strong>。</p>
<p>设想这样一个场景：用户点击进入编辑 → 修改了内容但未保存 → 又点击其他地方退出 → 再次点击进入编辑。<br/>
如果没有这行赋值，输入框会保留上次未保存的“残留内容”，造成<strong>UI 与实际数据不一致</strong>的错觉。</p>
<p>通过每次进入编辑模式时<strong>强制将输入框的值重置为当前 <code>this.value</code>（即最新确认值）</strong> ，我们确保了：</p>
<ul>
<li>用户看到的始终是“已保存”的最新内容；</li>
<li>未提交的草稿不会被错误保留；</li>
<li>组件行为符合直觉，减少认知负担。</li>
</ul>
<h2 data-id="heading-9">4. 响应用户操作之事件绑定</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, 
      <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">convertToField</span>(); <span class="hljs-comment">// 切换到输入框显示状态</span>
      }
    );
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, 
      <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">save</span>();
      }
    );
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, 
      <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cancel</span>();
      }
    );
</code></pre>
<h3 data-id="heading-10">箭头函数的巧妙之处</h3>
<p>这里使用箭头函数，不仅让代码更简洁，还巧妙地解决了 <code>this</code> 上下文的问题：<br/>
由于箭头函数<strong>不会创建自己的 <code>this</code></strong>，而是<strong>继承外层作用域的 <code>this</code></strong>，因此在事件回调中，<code>this</code> 依然指向 <code>EditInPlace</code> 实例，可以直接调用 <code>this.save()</code>、<code>this.cancel()</code> 等方法。</p>
<p>如果换成普通函数，<code>this</code> 会默认指向触发事件的 DOM 元素（比如按钮或 span），导致方法调用失败。此时就必须手动绑定上下文，例如：</p>
<pre><code class="hljs language-Js" lang="Js"><span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">save</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>));
</code></pre>
<p>而借助箭头函数，我们省去了这些冗余的 <code>.bind(this)</code>，既减少了样板代码，也提升了可读性。</p>
<h2 data-id="heading-11">5.保存提交 vs 无痕取消</h2>
<pre><code class="hljs language-js" lang="js"> <span class="hljs-attr">save</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
     <span class="hljs-keyword">var</span> value = <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">value</span>;
     <span class="hljs-comment">// fetch 后端存储</span>
     <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value;
     <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-property">innerHTML</span> = value;
     <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">convertToText</span>();   
    },
    <span class="hljs-attr">cancel</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">convertToText</span>();
    }
</code></pre>
<h3 data-id="heading-12">核心行为解析</h3>
<ul>
<li><strong><code>save()</code></strong> ：<br/>
负责将用户输入的新内容提交。它会更新组件的内部状态 <code>this.value</code>，并同步刷新静态文本的显示，完成“保存”操作。<br/>
注释中提到的 <code>fetch</code> 是为后续对接后端预留的扩展点——在真实的 B 站场景中，这里会发起 AJAX 请求，将新签名持久化到服务器。</li>
<li><strong><code>cancel()</code></strong> ：<br/>
不修改任何数据，仅切换回只读视图状态，实现真正的“无痕取消”。用户放弃编辑后，界面干净地还原为原始内容，没有任何副作用。</li>
</ul>
<p>这种设计确保了数据流的清晰与可控：<strong>只有 <code>save</code> 会改变状态，<code>cancel</code> 永远是安全的回退操作</strong>。</p>
<h3 data-id="heading-13">📖 注释不是附属品，而是接口的一部分</h3>
<p>一个真正可复用的前端组件，光有代码是不够的——它还需要一份“使用指南”。<br/>
在 <code>edit_in_place.js</code> 的开头，我们通常会看到类似这样的注释：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@func</span> EditInPlace 就地编辑组件
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} value         初始文本内容
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} parentElement  要插入到哪个 DOM 容器
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} id            组件的唯一标识符
 */</span>
</code></pre>
<p>这看似简单的 JSDoc 并非装饰，而是一份<strong>明确的调用契约</strong>。它告诉使用者：</p>
<ul>
<li>这个模块能做什么；</li>
<li>需要提供什么、以什么格式提供；</li>
<li>不需要关心内部如何实现。</li>
</ul>
<blockquote>
<p>毕竟，<strong>写组件的人和用组件的人，往往不是同一个人</strong>。<br/>
只要接口稳定、文档清晰，哪怕底层逻辑彻底重写，上层调用依然安然无恙。</p>
</blockquote>
<p>从这个角度看，注释不是“写给未来的自己看的笔记”，而是<strong>封装完整性的必要组成部分</strong>。</p>
<hr/>
<h3 data-id="heading-14">🧱 从脚本到组件：前端工程化的自然演进</h3>
<p>早期的交互功能常以“过程式脚本”形式存在：变量满天飞，函数互相依赖，改一处可能崩全局。<br/>
而现代前端开发更倾向于这样的路径：</p>
<blockquote>
<p><strong>散落逻辑 → 封装成类 → 独立模块</strong></p>
</blockquote>
<ul>
<li><strong>封装成类（OOP）</strong>  把状态（如当前值）和行为（如切换编辑模式）聚合在一起，避免污染全局作用域；</li>
<li><strong>拆分为独立文件</strong> 后，组件具备了“即插即用”的能力，天然支持复用与协作；</li>
<li><strong>清晰的构造参数 + 完善的注释</strong>，则让他人无需阅读源码也能正确集成。</li>
</ul>
<p>这不仅是代码组织方式的升级，更是<strong>协作效率和项目可维护性</strong>的跃迁。</p>
<hr/>
<h3 data-id="heading-15">⚡ 快速上手：三行搞定可编辑签名</h3>
<p>假设页面中有如下容器：</p>
<pre><code class="hljs language-Html" lang="Html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"profile-signature"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>只需引入脚本并执行：</p>
<pre><code class="hljs language-Js" lang="Js"><span class="hljs-keyword">new</span> <span class="hljs-title class_">EditInPlace</span>(
  <span class="hljs-string">'user-slogan'</span>,
  <span class="hljs-string">'有了肯德基，生活好滋味！'</span>,
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'profile-signature'</span>)
);
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38997d61b1f347ab8165a4245bb8e535~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oSP5LmJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765358447&amp;x-signature=oNp0sSQIkK%2FtPJZUUpurCtv5R8c%3D" alt="image.png" loading="lazy"/></p>
<p>一个支持点击编辑、带保存/取消按钮的交互区域就立刻生效。<br/>
未来在其他模块复用？直接复制初始化语句即可——<strong>零学习成本，开箱即用</strong>。</p>
<p>而这背后的一切，都始于一个设计清晰、文档完整的封装。</p>
<h2 data-id="heading-16">源码在这：</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef82c4439f504fb2a037f432fc1a9403~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oSP5LmJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765358447&amp;x-signature=4XQT4EACQQiOh%2BPC8D0cGjyx0Iw%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * <span class="hljs-doctag">@func</span> EditInPlace 就地编辑
 * <span class="hljs-doctag">@params</span> {<span class="hljs-type">string</span>} value 初始值
 * <span class="hljs-doctag">@params</span> {<span class="hljs-type">element</span>} parentElement 挂载点
 * <span class="hljs-doctag">@params</span> {<span class="hljs-type">string</span>} id  自身ID
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">EditInPlace</span>(<span class="hljs-params">id, value, parentElement</span>) {
  <span class="hljs-comment">// {} 空对象 this指向它</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value || <span class="hljs-string">'这个家伙很懒，什么都没有留下'</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentElement</span> = parentElement;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span> = <span class="hljs-literal">null</span>;   <span class="hljs-comment">// 预声明组件自身的根容器元素（通常是 &lt;div&gt;）</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span> = <span class="hljs-literal">null</span>;         <span class="hljs-comment">// 保存外部传入的挂载容器（即该组件将被插入到哪个 DOM 元素内）。</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span> = <span class="hljs-literal">null</span>;       <span class="hljs-comment">// 取消</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span> = <span class="hljs-literal">null</span>;       <span class="hljs-comment">// 用于编辑文本内容（即编辑状态下的输入框）</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span> = <span class="hljs-literal">null</span>;      <span class="hljs-comment">// 用于展示静态文本（即非编辑状态下的内容）</span>
  <span class="hljs-comment">//  如果不保存这些引用，每次操作都要通过 querySelector 查找，效率低且代码冗余。</span>
  <span class="hljs-comment">// 代码比较多，按功能分模块 拆函数</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createElement</span>();           <span class="hljs-comment">// DOM 对象创建</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">attachEvent</span>();             <span class="hljs-comment">// 事件添加</span>
}
<span class="hljs-title class_">EditInPlace</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = {
  <span class="hljs-comment">// 封装了DOM操作</span>
  <span class="hljs-attr">createElement</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// DOM 内存 </span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>.<span class="hljs-property">id</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span>;

    <span class="hljs-comment">// 值</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'span'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-property">innerHTML</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>);

    <span class="hljs-comment">// 输入框</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'input'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">type</span> = <span class="hljs-string">'text'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">value</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentElement</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'input'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>.<span class="hljs-property">type</span> = <span class="hljs-string">'button'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>.<span class="hljs-property">value</span> = <span class="hljs-string">'保存'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'input'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>.<span class="hljs-property">type</span> = <span class="hljs-string">'button'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>.<span class="hljs-property">value</span> = <span class="hljs-string">'取消'</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>);

    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">convertToText</span>(); <span class="hljs-comment">// 切换到文本显示状态</span>
  },
  <span class="hljs-attr">convertToText</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>; <span class="hljs-comment">// 隐藏</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>; <span class="hljs-comment">// 隐藏</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>; <span class="hljs-comment">// 隐藏</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'inline'</span>; <span class="hljs-comment">// 可见</span>
  },
  <span class="hljs-attr">convertToField</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>; <span class="hljs-comment">// 隐藏</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'inline'</span>; <span class="hljs-comment">// 可见</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">value</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>; 
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'inline'</span>; <span class="hljs-comment">// 可见</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'inline'</span>; <span class="hljs-comment">// 可见</span>
  },
  <span class="hljs-attr">attachEvent</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, 
      <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">convertToField</span>(); <span class="hljs-comment">// 切换到输入框显示状态</span>
      }
    );
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, 
      <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">save</span>();
      }
    );
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, 
      <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">cancel</span>();
      }
    );
  },
   <span class="hljs-attr">save</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
     <span class="hljs-keyword">var</span> value = <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">value</span>;
     <span class="hljs-comment">// fetch 后端存储</span>
     <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value;
     <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-property">innerHTML</span> = value;
     <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">convertToText</span>();   
    },
    <span class="hljs-attr">cancel</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">convertToText</span>();
    }
}
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"app"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./edit_in_place.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
  <span class="hljs-comment">// EditInPlace 类</span>
  <span class="hljs-comment">// OOP </span>
  <span class="hljs-keyword">const</span> ep = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EditInPlace</span>(
    <span class="hljs-string">'slogan'</span>, 
    <span class="hljs-string">'有了肯德基，生活好滋味'</span>, 
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'app'</span>)
  );
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ep);
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h2 data-id="heading-17">总结</h2>
<p>这个“就地编辑”组件虽然只有几十行代码，却是一个典型的 OOP 实践：把状态和行为封装在 <code>EditInPlace</code> 构造函数中，对外只暴露清晰的初始化接口，内部实现完全隐藏。正因如此，它才能真正做到<strong>一次编写、多处复用</strong>——无论用在个人主页签名、评论编辑还是后台配置项，只需一行 <code>new EditInPlace(...)</code> 就能接入，无需关心内部如何切换视图、绑定事件或管理数据。这种基于面向对象的封装思路，正是构建可维护、可复用前端模块的基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[淘宝 API 关键词搜索接口深度解析：请求参数、签名机制与性能优化]]></title>    <link>https://juejin.cn/post/7579453456017768489</link>    <guid>https://juejin.cn/post/7579453456017768489</guid>    <pubDate>2025-12-03T09:30:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579453456017768489" data-draft-id="7579438351297511460" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="淘宝 API 关键词搜索接口深度解析：请求参数、签名机制与性能优化"/> <meta itemprop="keywords" content="前端,API,数据挖掘"/> <meta itemprop="datePublished" content="2025-12-03T09:30:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="电商API大数据接口开发Cris"/> <meta itemprop="url" content="https://juejin.cn/user/3836609967955659"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            淘宝 API 关键词搜索接口深度解析：请求参数、签名机制与性能优化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3836609967955659/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    电商API大数据接口开发Cris
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T09:30:42.000Z" title="Wed Dec 03 2025 09:30:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p>在电商数据采集、第三方工具开发等场景中，淘宝的关键词搜索接口是核心数据入口之一。该接口支持通过关键词查询商品列表、价格、销量等关键信息，但其严格的请求规范、复杂的签名机制和性能限制，往往成为开发者的技术痛点。本文将从请求参数解析、签名机制原理、实战代码实现到性能优化策略，进行全方位深度解析，帮助开发者高效、合规地使用该接口。</p>
<h2 data-id="heading-0">一、接口核心基础认知</h2>
<h3 data-id="heading-1">1.1 接口功能与应用场景</h3>
<p>淘宝关键词搜索接口的核心功能是通过关键词、分类、价格区间等条件，从淘宝商品库中筛选符合条件的商品数据，返回商品 ID、标题、价格、销量、卖家信息等字段。</p>
<p>典型应用场景包括：</p>
<ul>
<li>电商数据分析工具：监控竞品价格、销量变化；</li>
<li>第三方导购平台：基于关键词推荐商品；</li>
<li>商家运营工具：批量查询商品曝光情况；</li>
<li>市场调研系统：采集特定品类商品数据进行趋势分析。</li>
</ul>
<h3 data-id="heading-2">1.2 接口访问前提</h3>
<p>使用该接口需满足以下条件：</p>
<ol>
<li>注册淘宝开发者账号；</li>
<li>申请接口权限；</li>
<li>获取<code>ApiKey</code> 和 <code>ApiSecret</code>（接口调用的核心凭证）；</li>
<li>遵守淘宝平台《API 使用规范》，避免高频次恶意调用。</li>
</ol>
<h2 data-id="heading-3">二、请求参数深度解析</h2>
<p>淘宝 API 采用 HTTP GET/POST 请求方式，参数分为<strong>公共参数</strong>和<strong>业务参数</strong>两类，所有参数需按指定格式拼接，编码采用 UTF-8。</p>
<h3 data-id="heading-4">2.1 公共参数（必填）</h3>
<p>公共参数是所有 TOP 接口的通用参数，用于身份验证、请求标识等，核心参数如下：</p>





















































<table><thead><tr><th>参数名</th><th>类型</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td>app_key</td><td>String</td><td>应用唯一标识</td><td>2356789012</td></tr><tr><td>method</td><td>String</td><td>接口名称</td><td>taobao.items.search</td></tr><tr><td>format</td><td>String</td><td>返回格式（支持 json/xml）</td><td>json</td></tr><tr><td>timestamp</td><td>String</td><td>请求时间戳（格式：yyyy-MM-dd HH:mm:ss）</td><td>2025-12-03 14:30:00</td></tr><tr><td>v</td><td>String</td><td>接口版本</td><td>2.0</td></tr><tr><td>sign</td><td>String</td><td>签名（核心验证参数）</td><td>88E88D8F7A6B5C4D3E2F1A0987654321</td></tr><tr><td>session</td><td>String</td><td>买家 / 卖家授权会话（部分接口必填）</td><td>61022000000000000000000000000000</td></tr></tbody></table>
<h3 data-id="heading-5">2.2 业务参数（关键词搜索核心）</h3>
<p>业务参数用于指定搜索条件，核心参数如下（以<code>taobao.items.search</code>为例）：</p>



























































<table><thead><tr><th>参数名</th><th>类型</th><th>说明</th><th>约束</th></tr></thead><tbody><tr><td>q</td><td>String</td><td>搜索关键词</td><td>不能为空，长度≤30 字符</td></tr><tr><td>cat</td><td>Number</td><td>商品分类 ID</td><td>可选，需通过分类接口获取合法 ID</td></tr><tr><td>price_min</td><td>Number</td><td>最低价格（元）</td><td>与 price_max 搭配使用，非负</td></tr><tr><td>price_max</td><td>Number</td><td>最高价格（元）</td><td>需大于 price_min</td></tr><tr><td>sales</td><td>Number</td><td>销量筛选</td><td>可选，如 100 表示筛选销量≥100 的商品</td></tr><tr><td>page_no</td><td>Number</td><td>页码</td><td>默认为 1，最大支持 100 页</td></tr><tr><td>page_size</td><td>Number</td><td>每页条数</td><td>1-40，默认 20</td></tr><tr><td>sort</td><td>String</td><td>排序方式</td><td>可选值：price_asc（低价优先）、price_desc（高价优先）、sales_desc（销量优先）</td></tr></tbody></table>
<h3 data-id="heading-6">2.3 参数拼接规则</h3>
<ol>
<li>所有参数（公共 + 业务）按<strong>参数名 ASCII 码升序</strong>排序；</li>
<li>键值对格式为<code>key=value</code>，value 需进行 URL 编码（如空格替换为<code>%20</code>，中文转换为 UTF-8 编码的十六进制）；</li>
<li>排序后的键值对用<code>&amp;</code>连接，形成待签名字符串。</li>
</ol>
<p>示例待签名字符串（简化版）：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">app_key</span>=<span class="hljs-number">2356789012</span>&amp;format=json&amp;method=taobao.items.search&amp;page_<span class="hljs-literal">no</span>=<span class="hljs-number">1</span>&amp;page_size=<span class="hljs-number">20</span>&amp;q=手机&amp;timestamp=<span class="hljs-number">2025</span>-<span class="hljs-number">12</span>-<span class="hljs-number">03</span>+<span class="hljs-number">14</span>%<span class="hljs-number">3</span>A30%<span class="hljs-number">3</span>A00&amp;v=<span class="hljs-number">2.0</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-7">三、签名机制原理与实现</h2>
<p>淘宝 API 签名机制是为了验证请求的合法性，防止参数被篡改，核心基于<code>AppSecret</code>进行 MD5 加密，步骤如下：</p>
<h3 data-id="heading-8">3.1 签名生成步骤</h3>
<ol>
<li>按参数拼接规则生成<strong>排序后的待签名字符串</strong>（不含 sign 参数）；</li>
<li>在待签名字符串首尾拼接<code>AppSecret</code>，形成<code>AppSecret + 待签名字符串 + AppSecret</code>；</li>
<li>对拼接后的字符串进行<strong>MD5 加密</strong>，得到 32 位小写字符串，即为 sign 值；</li>
<li>将 sign 参数加入请求参数，完成最终请求 URL 构建。</li>
</ol>
<h3 data-id="heading-9">3.2 签名防篡改原理</h3>
<ul>
<li><code>AppSecret</code>仅开发者和淘宝服务器知晓，第三方无法伪造签名；</li>
<li>任何参数（包括值、顺序）的修改都会导致待签名字符串变化，最终签名失效；</li>
<li>timestamp 参数用于防止请求重放（淘宝默认有效期为 10 分钟）。</li>
</ul>
<h3 data-id="heading-10">3.3 签名实现示例（Python）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> hashlib
<span class="hljs-keyword">import</span> urllib.parse

<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_sign</span>(<span class="hljs-params">params, app_secret</span>):
    <span class="hljs-comment"># 1. 按参数名ASCII升序排序</span>
    sorted_params = <span class="hljs-built_in">sorted</span>(params.items(), key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">0</span>])
    <span class="hljs-comment"># 2. 拼接为key=value格式，URL编码value</span>
    encoded_params = []
    <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> sorted_params:
        encoded_value = urllib.parse.quote(<span class="hljs-built_in">str</span>(value), safe=<span class="hljs-string">''</span>)
        encoded_params.append(<span class="hljs-string">f"<span class="hljs-subst">{key}</span>=<span class="hljs-subst">{encoded_value}</span>"</span>)
    sign_str = <span class="hljs-string">'&amp;'</span>.join(encoded_params)
    <span class="hljs-comment"># 3. 首尾拼接AppSecret</span>
    sign_str = <span class="hljs-string">f"<span class="hljs-subst">{app_secret}</span><span class="hljs-subst">{sign_str}</span><span class="hljs-subst">{app_secret}</span>"</span>
    <span class="hljs-comment"># 4. MD5加密</span>
    md5 = hashlib.md5()
    md5.update(sign_str.encode(<span class="hljs-string">'utf-8'</span>))
    <span class="hljs-keyword">return</span> md5.hexdigest().lower()

<span class="hljs-comment"># 测试</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    app_secret = <span class="hljs-string">"your_app_secret"</span>
    params = {
        <span class="hljs-string">"app_key"</span>: <span class="hljs-string">"2356789012"</span>,
        <span class="hljs-string">"method"</span>: <span class="hljs-string">"taobao.items.search"</span>,
        <span class="hljs-string">"format"</span>: <span class="hljs-string">"json"</span>,
        <span class="hljs-string">"timestamp"</span>: <span class="hljs-string">"2025-12-03 14:30:00"</span>,
        <span class="hljs-string">"v"</span>: <span class="hljs-string">"2.0"</span>,
        <span class="hljs-string">"q"</span>: <span class="hljs-string">"手机"</span>,
        <span class="hljs-string">"page_no"</span>: <span class="hljs-number">1</span>,
        <span class="hljs-string">"page_size"</span>: <span class="hljs-number">20</span>
    }
    sign = generate_sign(params, app_secret)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"生成的签名："</span>, sign)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-11">四、完整接口调用代码实现（Python）</h2>
<p>以下是基于 Python 的完整接口调用示例，包含参数构建、签名生成、HTTP 请求、响应解析等流程，使用<code>requests</code>库发送请求。</p>
<h3 data-id="heading-12">4.1 环境准备</h3>
<p>安装依赖库：</p>
<pre><code class="hljs">pip install requests
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-13">4.2 完整代码</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> hashlib
<span class="hljs-keyword">import</span> urllib.parse
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TaobaoSearchAPI</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, app_key, app_secret</span>):
        self.app_key = app_key
        self.app_secret = app_secret
        self.base_url = <span class="hljs-string">"http://gw.api.taobao.com/router/rest"</span>  <span class="hljs-comment"># 正式环境URL</span>
        <span class="hljs-comment"># 测试环境URL：http://gw.api.tbsandbox.com/router/rest</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_sign</span>(<span class="hljs-params">self, params</span>):
        <span class="hljs-string">"""生成签名（复用3.3节实现）"""</span>
        sorted_params = <span class="hljs-built_in">sorted</span>(params.items(), key=<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">0</span>])
        encoded_params = []
        <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> sorted_params:
            encoded_value = urllib.parse.quote(<span class="hljs-built_in">str</span>(value), safe=<span class="hljs-string">''</span>)
            encoded_params.append(<span class="hljs-string">f"<span class="hljs-subst">{key}</span>=<span class="hljs-subst">{encoded_value}</span>"</span>)
        sign_str = <span class="hljs-string">'&amp;'</span>.join(encoded_params)
        sign_str = <span class="hljs-string">f"<span class="hljs-subst">{self.app_secret}</span><span class="hljs-subst">{sign_str}</span><span class="hljs-subst">{self.app_secret}</span>"</span>
        md5 = hashlib.md5()
        md5.update(sign_str.encode(<span class="hljs-string">'utf-8'</span>))
        <span class="hljs-keyword">return</span> md5.hexdigest().lower()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">search_items</span>(<span class="hljs-params">self, keyword, page_no=<span class="hljs-number">1</span>, page_size=<span class="hljs-number">20</span>, **kwargs</span>):
        <span class="hljs-string">"""
        关键词搜索商品
        :param keyword: 搜索关键词
        :param page_no: 页码
        :param page_size: 每页条数（1-40）
        :param kwargs: 其他业务参数（如cat、price_min、price_max、sort等）
        :return: 解析后的商品数据
        """</span>
        <span class="hljs-comment"># 1. 构建公共参数</span>
        params = {
            <span class="hljs-string">"app_key"</span>: self.app_key,
            <span class="hljs-string">"method"</span>: <span class="hljs-string">"taobao.items.search"</span>,
            <span class="hljs-string">"format"</span>: <span class="hljs-string">"json"</span>,
            <span class="hljs-string">"timestamp"</span>: datetime.now().strftime(<span class="hljs-string">"%Y-%m-%d %H:%M:%S"</span>),
            <span class="hljs-string">"v"</span>: <span class="hljs-string">"2.0"</span>,
            <span class="hljs-string">"page_no"</span>: page_no,
            <span class="hljs-string">"page_size"</span>: <span class="hljs-built_in">min</span>(page_size, <span class="hljs-number">40</span>),  <span class="hljs-comment"># 限制最大条数</span>
            <span class="hljs-string">"q"</span>: keyword
        }

        <span class="hljs-comment"># 2. 添加额外业务参数</span>
        params.update(kwargs)

        <span class="hljs-comment"># 3. 生成签名</span>
        sign = self.generate_sign(params)
        params[<span class="hljs-string">"sign"</span>] = sign

        <span class="hljs-comment"># 4. 发送HTTP请求</span>
        <span class="hljs-keyword">try</span>:
            response = requests.get(self.base_url, params=params, timeout=<span class="hljs-number">10</span>)
            response.raise_for_status()  <span class="hljs-comment"># 抛出HTTP错误</span>
            result = response.json()

            <span class="hljs-comment"># 5. 解析响应</span>
            <span class="hljs-keyword">if</span> <span class="hljs-string">"error_response"</span> <span class="hljs-keyword">in</span> result:
                error = result[<span class="hljs-string">"error_response"</span>]
                <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">f"接口调用失败：<span class="hljs-subst">{error[<span class="hljs-string">'msg'</span>]}</span>（错误码：<span class="hljs-subst">{error[<span class="hljs-string">'code'</span>]}</span>）"</span>)
            
            <span class="hljs-comment"># 提取商品列表</span>
            items = result[<span class="hljs-string">"items_search_response"</span>][<span class="hljs-string">"items"</span>][<span class="hljs-string">"item"</span>]
            total = result[<span class="hljs-string">"items_search_response"</span>][<span class="hljs-string">"total_results"</span>]
            <span class="hljs-keyword">return</span> {
                <span class="hljs-string">"total"</span>: total,
                <span class="hljs-string">"page_no"</span>: page_no,
                <span class="hljs-string">"page_size"</span>: page_size,
                <span class="hljs-string">"items"</span>: items
            }
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"搜索失败：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

<span class="hljs-comment"># 示例调用</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 替换为你的AppKey和AppSecret</span>
    APP_KEY = <span class="hljs-string">"your_app_key"</span>
    APP_SECRET = <span class="hljs-string">"your_app_secret"</span>

    <span class="hljs-comment"># 初始化API客户端</span>
    taobao_api = TaobaoSearchAPI(APP_KEY, APP_SECRET)

    <span class="hljs-comment"># 搜索关键词"手机"，筛选价格1000-5000元，销量优先排序</span>
    result = taobao_api.search_items(
        keyword=<span class="hljs-string">"手机"</span>,
        page_no=<span class="hljs-number">1</span>,
        page_size=<span class="hljs-number">30</span>,
        price_min=<span class="hljs-number">1000</span>,
        price_max=<span class="hljs-number">5000</span>,
        sort=<span class="hljs-string">"sales_desc"</span>
    )

    <span class="hljs-comment"># 打印结果</span>
    <span class="hljs-keyword">if</span> result:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"总商品数：<span class="hljs-subst">{result[<span class="hljs-string">'total'</span>]}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"当前页商品数：<span class="hljs-subst">{<span class="hljs-built_in">len</span>(result[<span class="hljs-string">'items'</span>])}</span>"</span>)
        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> result[<span class="hljs-string">"items"</span>][:<span class="hljs-number">3</span>]:  <span class="hljs-comment"># 打印前3个商品</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"商品标题：<span class="hljs-subst">{item[<span class="hljs-string">'title'</span>]}</span>"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"价格：<span class="hljs-subst">{item[<span class="hljs-string">'price'</span>]}</span>元"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"销量：<span class="hljs-subst">{item[<span class="hljs-string">'sale_count'</span>]}</span>"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"商品链接：<span class="hljs-subst">{item[<span class="hljs-string">'detail_url'</span>]}</span>\n"</span>)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-14">4.3 响应字段说明</h3>
<p>返回的商品数据包含多个核心字段，常用字段如下：</p>
<ul>
<li><code>title</code>：商品标题（含关键词高亮标记）；</li>
<li><code>price</code>：商品价格（单位：元）；</li>
<li><code>sale_count</code>：累计销量；</li>
<li><code>detail_url</code>：商品详情页链接；</li>
<li><code>pic_url</code>：商品主图 URL；</li>
<li><code>nick</code>：卖家昵称；</li>
<li><code>shop_type</code>：店铺类型（taobao：淘宝店，tmall：天猫店）。</li>
</ul>
<h2 data-id="heading-15">五、性能优化策略</h2>
<p>淘宝 API 对调用频率有严格限制（普通应用通常为 10-20 次 / 秒），且单页最大返回 40 条数据，在海量数据采集场景中需针对性优化。</p>
<h3 data-id="heading-16">5.1 限流与重试机制</h3>
<ol>
<li><strong>控制并发量</strong>：使用线程池 / 协程池限制并发请求数，避免触发限流（示例：使用<code>concurrent.futures.ThreadPoolExecutor</code>，最大线程数设为 10）；</li>
<li><strong>指数退避重试</strong>：调用失败时（如错误码<code>429</code>限流、<code>503</code>服务不可用），采用指数退避策略重试（1s→2s→4s→...），避免频繁重试加剧服务器压力；</li>
<li><strong>记录请求日志</strong>：记录每次请求的时间、参数、响应状态，便于排查限流原因。</li>
</ol>
<p>示例重试机制实现（基于<code>tenacity</code>库）：</p>
<pre><code class="hljs">pip install tenacity
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> tenacity <span class="hljs-keyword">import</span> retry, stop_after_attempt, wait_exponential, retry_if_exception_type

<span class="hljs-meta">@retry(<span class="hljs-params">
    stop=stop_after_attempt(<span class="hljs-params"><span class="hljs-number">3</span></span>),  <span class="hljs-comment"># 最多重试3次</span>
    wait=wait_exponential(<span class="hljs-params">multiplier=<span class="hljs-number">1</span>, <span class="hljs-built_in">min</span>=<span class="hljs-number">1</span>, <span class="hljs-built_in">max</span>=<span class="hljs-number">5</span></span>),  <span class="hljs-comment"># 指数退避</span>
    retry=retry_if_exception_type(<span class="hljs-params">(<span class="hljs-params">requests.exceptions.RequestException, Exception</span>)</span>)
</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">search_items_with_retry</span>(<span class="hljs-params">self, keyword, **kwargs</span>):
    <span class="hljs-keyword">return</span> self.search_items(keyword, **kwargs)
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-17">5.2 数据分页优化</h3>
<ol>
<li><strong>批量分页查询</strong>：通过<code>page_no</code>循环获取所有页码数据，直至返回结果为空（注意：淘宝 API 最大支持 100 页，超过需调整筛选条件）；</li>
<li><strong>合理设置 page_size</strong>：每页条数设为 40（最大值），减少总请求次数；</li>
<li><strong>异步分页</strong>：使用异步请求库（如<code>aiohttp</code>）并行获取多页数据，提升效率。</li>
</ol>
<h3 data-id="heading-18">5.3 缓存策略</h3>
<ol>
<li><strong>本地缓存</strong>：缓存热门关键词的搜索结果（如 Redis、内存字典），有效期设为 5-15 分钟，减少重复请求；</li>
<li><strong>增量更新</strong>：仅查询新增数据（通过<code>modify_time</code>等字段筛选），避免全量重复采集；</li>
<li><strong>缓存击穿防护</strong>：对热点关键词设置互斥锁，避免缓存失效时大量请求穿透到 API。</li>
</ol>
<h3 data-id="heading-19">5.4 其他优化技巧</h3>
<ol>
<li><strong>精简返回字段</strong>：使用<code>fields</code>参数指定所需字段（如<code>fields=title,price,sale_count</code>），减少响应数据传输量；</li>
<li><strong>就近接入</strong>：选择与淘宝服务器地理位置较近的服务器部署应用，降低网络延迟；</li>
<li><strong>避免无效参数</strong>：严格校验参数合法性（如价格区间、分类 ID），避免因参数错误导致无效请求。</li>
</ol>
<h2 data-id="heading-20">六、常见问题与排查</h2>
<ol>
<li>
<p><strong>签名错误（错误码<code>15</code>）</strong> ：</p>
<ul>
<li>检查参数排序是否按 ASCII 升序；</li>
<li>确认<code>AppSecret</code>是否正确（区分大小写）；</li>
<li>检查 value 是否正确 URL 编码（中文、特殊字符）。</li>
</ul>
</li>
<li>
<p><strong>权限不足（错误码<code>11</code>）</strong> ：</p>
<ul>
<li>确认应用已申请目标接口权限；</li>
<li>部分接口需用户授权（<code>session</code>参数必填），需引导用户完成授权流程。</li>
</ul>
</li>
<li>
<p><strong>限流（错误码<code>429</code>）</strong> ：</p>
<ul>
<li>降低请求频率，增加并发控制；</li>
<li>检查是否有其他应用使用同一<code>AppKey</code>高频调用。</li>
</ul>
</li>
<li>
<p><strong>数据返回不全</strong>：</p>
<ul>
<li>确认<code>page_no</code>未超过 100 页；</li>
<li>检查筛选条件是否过于严格（如价格区间过窄、关键词过长）。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-21">七、总结</h2>
<p>淘宝 API 关键词搜索接口是电商数据采集的核心工具，其使用要点可总结为：<strong>合规为先、签名为核、优化为翼</strong>。开发者需严格遵守平台规范，正确实现签名机制避免请求失效，同时通过限流、缓存、分页优化等策略提升接口调用效率。</p>
<p>在实际开发中，还需关注接口版本更新（如旧版<code>taobao.items.search</code>逐步迁移至新版<code>alibaba.item.search</code>）、字段变更等平台通知，确保应用长期稳定运行。通过本文的解析与实战代码，开发者可快速掌握接口使用技巧，高效落地相关业务场景。</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python + Langchain + Streamlit + DashScope 实现一个网页版聊天机器人]]></title>    <link>https://juejin.cn/post/7579427549471719470</link>    <guid>https://juejin.cn/post/7579427549471719470</guid>    <pubDate>2025-12-03T09:21:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579427549471719470" data-draft-id="7579410911057674266" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python + Langchain + Streamlit + DashScope 实现一个网页版聊天机器人"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-03T09:21:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="从从容容游刃有余"/> <meta itemprop="url" content="https://juejin.cn/user/4107431173952525"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python + Langchain + Streamlit + DashScope 实现一个网页版聊天机器人
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4107431173952525/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    从从容容游刃有余
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T09:21:40.000Z" title="Wed Dec 03 2025 09:21:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Python + Langchain + Streamlit + DashScope 实现一个网页版聊天机器人</h2>
<h3 data-id="heading-1">零、前置条件</h3>
<p>需要在阿里巴巴百炼平台创建一个api key，并写到.env文件</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 你的百炼平台key</span>
<span class="hljs-attr">DASHSCOPE_API_KEY</span>=你的百炼平台key
<span class="hljs-comment"># 百炼平台url</span>
<span class="hljs-attr">BASE_URL</span>=https://dashscope.aliyuncs.com/compatible-mode/v1
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f410fe0355d4138810f35d91f2af338~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LuO5LuO5a655a655ri45YiD5pyJ5L2Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765358500&amp;x-signature=oV7UcHN1lmzWjb3y08vCR8eXdI0%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">一、安装依赖</h3>
<pre><code class="hljs language-shell" lang="shell">pip install streamlit
pip install langchain_openai
pip install python-dotenv

</code></pre>
<h3 data-id="heading-3">二、完整Python代码</h3>
<pre><code class="hljs language-python" lang="python">
<span class="hljs-comment"># 导入streamlit     安装 pip install streamlit</span>
<span class="hljs-keyword">import</span> streamlit <span class="hljs-keyword">as</span> st
<span class="hljs-comment"># 导入langchain_openai  pip install langchain_openai</span>
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-comment"># 导入 dotenv 读取 .env  pip install python-dotenv</span>
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv

<span class="hljs-keyword">import</span> os

<span class="hljs-comment"># 加载 .env 文件</span>
load_dotenv()

chatLLM = ChatOpenAI(
    openai_api_key=os.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>),
    openai_api_base=os.getenv(<span class="hljs-string">"BASE_URL"</span>),
    model=<span class="hljs-string">"qwen-plus"</span>
)


<span class="hljs-keyword">def</span> <span class="hljs-title function_">chat</span>(<span class="hljs-params">prompt: <span class="hljs-built_in">str</span></span>):
    response = chatLLM.invoke([{<span class="hljs-string">'role'</span>: <span class="hljs-string">'user'</span>, <span class="hljs-string">'content'</span>: prompt}])
    <span class="hljs-keyword">return</span> response.content


<span class="hljs-comment"># 保存聊天信息</span>
<span class="hljs-keyword">if</span> <span class="hljs-string">"messages"</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> st.session_state:
    st.session_state[<span class="hljs-string">'messages'</span>] = []

<span class="hljs-comment"># 标题</span>
st.title(<span class="hljs-string">"Python + Langchain + Streamlit + DashScope 实现一个网页版聊天机器人"</span>)

<span class="hljs-comment"># 分隔符</span>
st.divider()

<span class="hljs-comment"># 请输入你的问题</span>
prompt = st.chat_input(<span class="hljs-string">"请输入你的问题"</span>)

<span class="hljs-keyword">if</span> prompt:
    <span class="hljs-comment"># role : user 、 assistant  ai human</span>
    st.session_state[<span class="hljs-string">'messages'</span>].append({<span class="hljs-string">'role'</span>: <span class="hljs-string">'user'</span>, <span class="hljs-string">'content'</span>: prompt})
    <span class="hljs-keyword">for</span> message <span class="hljs-keyword">in</span> st.session_state[<span class="hljs-string">'messages'</span>]:
        st.chat_message(message[<span class="hljs-string">'role'</span>]).markdown(message[<span class="hljs-string">'content'</span>])

    <span class="hljs-keyword">with</span> st.spinner(<span class="hljs-string">"🤔思考中。。。。"</span>):
        response = chat(prompt)
        st.session_state[<span class="hljs-string">'messages'</span>].append({<span class="hljs-string">'role'</span>: <span class="hljs-string">'assistant'</span>, <span class="hljs-string">'content'</span>: response})
        st.chat_message(<span class="hljs-string">'assistant'</span>).markdown(response)
</code></pre>
<h3 data-id="heading-4">三、启动</h3>
<pre><code class="hljs language-shell" lang="shell">streamlit run streamlit_langchain_dashscope.py 
</code></pre>
<h3 data-id="heading-5">四、效果</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40145648fd7044698ff3a2a678105a16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LuO5LuO5a655a655ri45YiD5pyJ5L2Z:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765358500&amp;x-signature=VBhznhqqEW3IPsqSncOheFdMWXw%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 原生加密指南：详解 Crypto 模块对接天远银行卡黑名单接口]]></title>    <link>https://juejin.cn/post/7579438351297560612</link>    <guid>https://juejin.cn/post/7579438351297560612</guid>    <pubDate>2025-12-03T09:41:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579438351297560612" data-draft-id="7579439226518650886" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 原生加密指南：详解 Crypto 模块对接天远银行卡黑名单接口"/> <meta itemprop="keywords" content="API,大数据"/> <meta itemprop="datePublished" content="2025-12-03T09:41:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天远数科"/> <meta itemprop="url" content="https://juejin.cn/user/3511153810487162"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 原生加密指南：详解 Crypto 模块对接天远银行卡黑名单接口
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3511153810487162/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天远数科
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T09:41:01.000Z" title="Wed Dec 03 2025 09:41:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在构建现代支付架构时，Node.js 常被用作 BFF (Backend for Frontend) 层，负责聚合数据与快速响应。对于风控子系统而言，BFF 层是拦截高危交易的第一道防线——既要快，又要准。</p>
<p>本文将以对接金融级风控接口（以天远数据 API 为例）为例，深入探讨如何在 Node.js 中优雅地实现 <strong>AES-128-CBC</strong> 加密通信，并规避 JavaScript 常见的类型陷阱。此外，我们还将讨论如何利用 Serverless 架构降低风控服务的运维成本。</p>
<h2 data-id="heading-0">一、 为什么原生 Crypto 模块比第三方库更好？</h2>
<p>很多开发者习惯引入 <code>crypto-js</code> 等第三方庞大的库来处理加密。其实，Node.js 内置的 <code>crypto</code> 模块基于 OpenSSL，性能极佳且无额外依赖。</p>
<p>但在对接银行或风控数据时，通常会遇到两个痛点：</p>
<ol>
<li><strong>填充模式（Padding）</strong> ：Java/Go 等后端常需手动实现 PKCS7，而 Node.js 的 <code>createCipheriv</code> 默认开启 PKCS7 填充，这一点虽然方便，但如果服务端使用 ZeroPadding 等非标模式，就需要特别处理。</li>
<li><strong>编码转换</strong>：在 16 进制字符串（Hex）、二进制缓冲区（Buffer）和 Base64 之间反复横跳，容易搞晕。</li>
</ol>
<h2 data-id="heading-1">二、 核心代码：封装一个健壮的 RiskClient</h2>
<p>下面是一个生产可用的类，封装了 IV 拼接、Base64 编码以及 HTTP 请求。</p>
<h3 data-id="heading-2">2.1 依赖准备</h3>
<p>我们仅使用 <code>axios</code> 处理网络请求，加密部分完全使用原生模块。</p>
<pre><code class="hljs">npm install axios
</code></pre>
<h3 data-id="heading-3">2.2 完整实现 (Async/Await)</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">axios</span> = require(<span class="hljs-string">'axios'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">crypto</span> = require(<span class="hljs-string">'crypto'</span>)<span class="hljs-comment">;</span>

class BankCardRiskClient {
    /**
     * @param {string} accessId - 鉴权 ID
     * @param {string} accessKeyHex - 16进制格式的密钥
     */
    constructor(accessId, accessKeyHex) {
        // 这里以标准 AES-128-CBC 接口为例
        <span class="hljs-attr">this.apiUrl</span> = <span class="hljs-string">'[https://api.tianyuanapi.com/api/v1/JRZQ0B6Y](https://api.tianyuanapi.com/api/v1/JRZQ0B6Y)'</span><span class="hljs-comment">;</span>
        <span class="hljs-attr">this.accessId</span> = accessId<span class="hljs-comment">;</span>
        // 关键点：必须将 Hex 字符串转为 Buffer 对象，否则加密结果会完全错误
        <span class="hljs-attr">this.accessKey</span> = Buffer.from(accessKeyHex, <span class="hljs-string">'hex'</span>)<span class="hljs-comment">;</span>
    }

    /**
     * 加密流程: 生成随机IV -&gt; AES加密 -&gt; 拼接IV -&gt; Base64
     */
    encrypt(data) {
        // 安全规范：每次请求必须生成全新的随机 16 字节 IV
        const <span class="hljs-attr">iv</span> = crypto.randomBytes(<span class="hljs-number">16</span>)<span class="hljs-comment">;</span>
        
        // 创建加密实例，Node.js 默认使用 PKCS7 Padding
        const <span class="hljs-attr">cipher</span> = crypto.createCipheriv(<span class="hljs-string">'aes-128-cbc'</span>, this.accessKey, iv)<span class="hljs-comment">;</span>
        
        // 序列化 JSON
        const <span class="hljs-attr">plainText</span> = JSON.stringify(data)<span class="hljs-comment">;</span>
        
        // 核心加密操作：update 处理数据块，final 处理剩余填充
        let <span class="hljs-attr">encrypted</span> = cipher.update(plainText, <span class="hljs-string">'utf8'</span>)<span class="hljs-comment">;</span>
        <span class="hljs-attr">encrypted</span> = Buffer.concat([encrypted, cipher.final()])<span class="hljs-comment">;</span>

        // 协议约定：将 IV 拼接到密文头部，以便服务端提取解密
        const <span class="hljs-attr">combined</span> = Buffer.concat([iv, encrypted])<span class="hljs-comment">;</span>
        
        return combined.toString('base64')<span class="hljs-comment">;</span>
    }

    /**
     * 解密流程: Base64解码 -&gt; 提取IV -&gt; 解密
     */
    decrypt(base64Data) {
        const <span class="hljs-attr">buffer</span> = Buffer.from(base64Data, <span class="hljs-string">'base64'</span>)<span class="hljs-comment">;</span>

        // 提取前 16 字节作为 IV
        const <span class="hljs-attr">iv</span> = buffer.slice(<span class="hljs-number">0</span>, <span class="hljs-number">16</span>)<span class="hljs-comment">;</span>
        // 剩余部分为密文
        const <span class="hljs-attr">text</span> = buffer.slice(<span class="hljs-number">16</span>)<span class="hljs-comment">;</span>

        const <span class="hljs-attr">decipher</span> = crypto.createDecipheriv(<span class="hljs-string">'aes-128-cbc'</span>, this.accessKey, iv)<span class="hljs-comment">;</span>
        let <span class="hljs-attr">decrypted</span> = decipher.update(text)<span class="hljs-comment">;</span>
        <span class="hljs-attr">decrypted</span> = Buffer.concat([decrypted, decipher.final()])<span class="hljs-comment">;</span>

        return JSON.parse(decrypted.toString())<span class="hljs-comment">;</span>
    }

    /**
     * 业务调用封装
     */
    async checkCard(name, idCard, mobile, bankCard) {
        try {
            const <span class="hljs-attr">payload</span> = { 
                name, 
                id_card: idCard, 
                mobile_no: mobile, 
                bank_card: bankCard 
            }<span class="hljs-comment">;</span>

            const <span class="hljs-attr">encryptedData</span> = this.encrypt(payload)<span class="hljs-comment">;</span>

            // 发起请求，注意 t 参数防止重放攻击
            const <span class="hljs-attr">response</span> = await axios.post(
                this.apiUrl, 
                { data: encryptedData }, 
                {
                    headers: { 'Access-Id': this.accessId },
                    params: { t: Date.now() },
                    timeout: 3000 // 建议设置超时时间
                }
            )<span class="hljs-comment">;</span>

            const <span class="hljs-attr">resData</span> = response.data<span class="hljs-comment">;</span>

            if (<span class="hljs-attr">resData.code</span> === <span class="hljs-number">0</span>) {
                return this.decrypt(resData.data)<span class="hljs-comment">;</span>
            } else {
                console.warn(`API 返回异常: ${resData.message}`)<span class="hljs-comment">;</span>
                return null<span class="hljs-comment">;</span>
            }
        } catch (error) {
            console.error('网络或解密错误:', error.message)<span class="hljs-comment">;</span>
            return null<span class="hljs-comment">;</span>
        }
    }
}

// --- 调用示例 ---
(async () =&gt; {
    // 最佳实践：密钥必须从环境变量读取
    const <span class="hljs-attr">client</span> = new BankCardRiskClient(
        process.env.RISK_ACCESS_ID, 
        process.env.RISK_ACCESS_KEY
    )<span class="hljs-comment">;</span>

    const <span class="hljs-attr">report</span> = await client.checkCard(
        '张三', '330106199001011234', '13912345678', '6228480038294321'
    )<span class="hljs-comment">;</span>
    
    if (report) {
         // 下文将详细讲解这里的类型陷阱
         const <span class="hljs-attr">isRisk</span> = report.caseRelated === <span class="hljs-string">'1'</span><span class="hljs-comment">;</span>
         console.log('是否涉案:', isRisk)<span class="hljs-comment">;</span>
    }
})()<span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-4">三、 JavaScript 弱类型系统中的“大坑”</h2>
<p>在对接老牌金融接口时，你会发现大量字段返回的是字符串形式的 <code>"1"</code> 或 <code>"0"</code>，而不是 Boolean 类型的 <code>true</code>/<code>false</code>。</p>
<p>在 JavaScript 中，这极易引发严重的业务逻辑错误：</p>
<pre><code class="hljs language-ini" lang="ini">// 假设 API 返回未涉案：<span class="hljs-attr">res.caseRelated</span> = <span class="hljs-string">"0"</span>

// ❌ 错误写法
if (res.caseRelated) {
    // 在 JS 中，非空字符串（包括 "0"）都被视为 true！
    // 结果：本该放行的交易被误拦截
    blockTransaction()<span class="hljs-comment">; </span>
}

// ✅ 正确写法：显式比较
const <span class="hljs-attr">isCriminal</span> = res.caseRelated === <span class="hljs-string">'1'</span><span class="hljs-comment">;</span>
const <span class="hljs-attr">isFraud</span> = res.fraudTrans === <span class="hljs-string">'1'</span><span class="hljs-comment">;</span>

if (isCriminal || isFraud) {
    blockTransaction()<span class="hljs-comment">;</span>
}
</code></pre>
<p><strong>建议</strong>：在 Service 层设计一个 <code>adapter</code>（适配器），将 API 返回的原始数据清洗为标准的 Boolean 值，不要让脏数据污染业务逻辑层。</p>
<h2 data-id="heading-5">四、 架构进阶：Node.js + Serverless</h2>
<p>Node.js 的冷启动速度快、内存占用低，使其成为 <strong>Serverless（无服务器架构）</strong> 的绝佳拍档。</p>
<h3 data-id="heading-6">4.1 场景：API 网关前置守卫</h3>
<p>传统的风控往往嵌入在单体应用中，导致业务代码臃肿。我们可以将风控逻辑抽离为一个独立的 <strong>AWS Lambda</strong> 或 <strong>阿里云函数计算（FC）</strong> 。</p>
<ul>
<li>
<p><strong>流程</strong>：<code>客户端 -&gt; API 网关 -&gt; 风控云函数 -&gt; 业务服务器</code></p>
</li>
<li>
<p><strong>优势</strong>：</p>
<ol>
<li><strong>隔离性</strong>：如果风控 API 响应延迟，只会阻塞网关层，不会拖垮核心业务服务的线程池。</li>
<li><strong>成本优化</strong>：风控调用通常是低频高并发（如突发大额交易），Serverless 按调用次数计费，比长期维护一台 EC2/ECS 服务器更划算。</li>
<li><strong>安全阻断</strong>：若云函数检测到 <code>caseRelated === '1'</code>，直接返回 HTTP 403，恶意流量根本接触不到你的核心数据库。</li>
</ol>
</li>
</ul>
<h3 data-id="heading-7">4.2 场景：Stream 流式清洗</h3>
<p>财务部门有时需要清洗数万条存量数据（Excel/CSV）。Node.js 的 Stream API 配合 <code>Promise.all</code> 是处理此类任务的神器。</p>
<p>不要一次性把 10 万条数据读入内存！使用 <code>fs.createReadStream</code> 配合 <code>csv-parser</code>，每次并发处理 5-10 个请求，既能利用 API 的并发能力，又不会导致 Node 进程 OOM（内存溢出）。</p>
<h2 data-id="heading-8">五、 总结</h2>
<p>通过 Node.js 原生模块实现 AES 加密，我们无需依赖臃肿的第三方库即可安全对接金融数据。而结合 JavaScript 的异步特性与 Serverless 架构，我们可以构建一个轻量、低成本且高可用的支付风控网关。</p>
<p>记住，在处理金钱相关的逻辑时，<strong>类型检查</strong>（注意 "0" 是 true）和<strong>密钥管理</strong>永远是重中之重。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用“分区”来面对超大数据集和超大吞吐量]]></title>    <link>https://juejin.cn/post/7579451710302470170</link>    <guid>https://juejin.cn/post/7579451710302470170</guid>    <pubDate>2025-12-03T09:42:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579451710302470170" data-draft-id="7579255046980206618" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用“分区”来面对超大数据集和超大吞吐量"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-12-03T09:42:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用“分区”来面对超大数据集和超大吞吐量
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T09:42:59.000Z" title="Wed Dec 03 2025 09:42:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">1. 为什么要分区？</h3>
<p><strong>分区（partitions）</strong> 也被称为 <strong>分片（sharding）</strong> ，通常采用对数据进行分区的方式来增加系统的 <strong>可伸缩性</strong>，以此来面对<strong>非常大的数据集或非常高的吞吐量</strong>，避免出现热点。</p>
<p>分区通常和复制结合使用，使得每个分区的副本存储在多个节点上，保证数据副本的 <strong>高可用</strong>。如下图所示，如果数据库被分区，每个分区都有一个主库。不同分区的主库可能在不同的节点上，每个节点可能是某些分区的主库，同时是其他分区的从库。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42d9d47b5d5e49fe881575dbb10fdca2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765359778&amp;x-signature=hjzRRLYRnn2WoGPxdb%2FeEQe9sic%3D" alt="分区与复制.png" loading="lazy"/></p>
<h4 data-id="heading-1">1.1 一致前缀读</h4>
<p>分区也会由于复制延迟而产生问题，我们先来看下图中的例子，是Poons先生和Cake小姐的对话：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1c05ea40e1e434f8a3d6bd6e51eb2dc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765359778&amp;x-signature=PpseAbZB5ZS3B5Z8Suvp9BXe42c%3D" alt="一致前缀读.png" loading="lazy"/></p>
<p>Poons先生先问： "How far into the future can you see, Mrs.Cake?"</p>
<p>Cake小姐回答说： "About ten seconds usually, Mr.Poons."</p>
<p>正常情况下，这段对话是有因果关系的（先问后答）。但是对于观察者，他看到的顺序却是先得到了答案，再看到了问题，这就是在分区数据库中，因复制延迟而产生的特殊情况。</p>
<p>为了避免这种混乱，我们就需要保证 <strong>一致前缀读</strong>：如果一系列写入按某个顺序发生，那么任何人读取这些写入时，也会看见它们以同样的顺序出现。一种解决方案是，确保任何因果相关的写入都在相同的分区。</p>
<h3 data-id="heading-2">2. 该怎么分区？</h3>
<p>分区的目的是将数据和负载均匀的分布到各个节点上，理论上10个节点能够处理10倍的数据量和10倍单节点的读写吞吐量。</p>
<p>但是如果分区不均，那么就会出现一些分区有更多的数据或读写，我们称之为 <strong>偏斜</strong>，这会使得分区后并没有得到很大的效率提升。在极端情况下，所有的负载如果都落在一个分区，使得该分区负载过高，我们称之为 <strong>热点</strong>。</p>
<p>所以，为了避免偏斜和热点的产生，以键值数据的分区为例，讨论如何将数据分区做得妥当。</p>
<h4 data-id="heading-3">2.1 根据键的范围进行分区</h4>
<p>我们可以根据键值的范围进行分区，比如说我们以26个英文字符划分26个分区，之后根据键值首字母对它们进行分区。通常情况下，键值并不是均匀分布的，这会造成按照首字母分区之后，发生数据偏斜。为了均匀分配数据，分区的边界需要根据数据分区的实际情况再进行调整。</p>
<h4 data-id="heading-4">2.2 散列分区</h4>
<p>一个好的散列函数可以将数据均匀分布，避免发生偏斜。但是这也带来了问题：我们没有办法再进行高效的范围查询。</p>
<h3 data-id="heading-5">3. 热点消除</h3>
<p>避免热点最简单的方法是将数据记录进行散列分区，记录因此会在所有节点上平均分配。</p>
<p>但是它并不能完全避免热点的产生，因为如果所有的读写操作都是针对同一个键的话，那么所有的请求还是会被路由到同一个分区。比如说有一个百万粉丝的博主发布动态，该动态根据博主ID的键值进行分区，如果此时有大量的粉丝对该动态进行互动，那么哈希策略会把这些请求都路由到同一个分区进行操作，发生热点事件。</p>
<p>其实，我们还可以在该热点键上再进行分区，以避免热点：在主键的最后拼接随机数，两位十进制的随机数就能把一个主键分成100个不同的主键，从而存储在不同的分区中，这就完成了热点消除。但是主键被分割后，任何读取工作都必须在每次读取时将所有的数据拉出去合并到一起再返回结果。</p>
<h3 data-id="heading-6">4. 分区再平衡</h3>
<p>如果保存某分区数据的服务器故障，需要使用其他服务器接管或想将目前的服务器换成性能更好的服务器，那么就需要进行 <strong>分区再平衡</strong>。</p>
<p><strong>分区再平衡</strong> 是将负载从集群中的一个节点向另一个节点移动的过程。执行再平衡需要满足以下要求：</p>
<ul>
<li>再平衡期间，数据库应该继续接受读取和写入</li>
<li>节点之间只移动必须的数据，以便快速再平衡，并减少网络和磁盘的IO负载</li>
<li>再平衡之后，负载应该在集群中的节点之间公平地共享</li>
</ul>
<p>比较简单的再平衡分区策略是选择 <strong>固定数量的分区</strong>，当节点数量增加时，可以从原节点中 <strong>窃取</strong> 一些分区（当节点数量减少时，则发生相反的情况），如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a27e8329b4c14681a033fa17b01d48e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765359778&amp;x-signature=CEz4V3PO6zsRwUVIvX5j79H%2Fdjk%3D" alt="固定数量分区再平衡.png" loading="lazy"/></p>
<p>在这种配置中，分区的数量通常在数据库第一次建立时确定，操作比较简单，之后不会改变，因此你需要选择足够多的分区以适应未来的增长。但是，每个分区也有管理开销，所以选择太大的数字会适得其反。</p>
<p>除此之外也可选择 <strong>动态分区</strong>，根据配置的分区大小，当超过该阈值时，可以将该大分区分割成两个小分区，能够使 <strong>分区数量适应总数据量</strong>。在大型分区拆分后，可以将其中的一半转移到另一个节点上，以平衡负载。</p>
<p>还有一种 <strong>根据节点数增加来进行分区</strong> 的方法：每个节点上有固定的分区数，当节点增加时，分区将变小，新增的节点会从原有节点的分区中随机进行拆分，最终这个新节点获得公平的负载份额。</p>
<p>分区再平衡可以 <strong>手动执行</strong> 也可以 <strong>自动执行</strong>。自动再平衡比较方便，因为不需要人工维护，但是它的执行过程是不可预测的：再平衡时将大量数据集从一个节点转移到另一个节点的过程中可能会产生很大的网络开销，这会使得该服务器对请求响应的性能降低，对用户的体验和生产造成负面影响。所以再平衡的过程有人参与是一件好事，这样能防止发生运维问题。</p>
<h3 data-id="heading-7">5. 请求路由（服务发现）</h3>
<p>当我们已经将数据进行分区后，如何才能知道用户想要的数据在哪个节点上？这可以概括为是一个 <strong>服务发现</strong> 的问题。为了解决这个问题，可以通过如下图所示的三个方案</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9b87192d8ea8407d9856ccf677af8cd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765359778&amp;x-signature=TGxWKVi3aJfYUQlzntbqL1pVTZ0%3D" alt="服务发现.png" loading="lazy"/></p>
<ol>
<li>允许访问所有的节点，如果第一个访问的节点有该键值，则处理该请求，否则将该请求转发到适当的节点上，这个方法避免了使用注册中心中间件，但是实现比较复杂</li>
<li>使用分布式的协调服务，用户将所有的请求发送到路由层，由路由层将该请求转发到合适的节点</li>
<li>要求用户（客户端）自己知道分区和节点的分配</li>
</ol>
<p>但是这其中还隐藏着一个问题：<strong>作出决策的组件（节点之一、路由层或客户端）是如何了解数据在节点间的分配变化的</strong>？这就需要一个独立的协调服务，比如使用 zookeeper 来跟踪元数据，如下图所示</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07a0a953e36c490091340d0925843afb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765359778&amp;x-signature=0d%2Fya2dm4G8LIQJscxC8jZjh8hA%3D" alt="zookeeper管理路由元数据.jpeg" loading="lazy"/></p>
<p>每个节点都会在 zookeeper 中进行注册，zookeeper 中维护有节点到各个分区的可靠映射，负责决策的组件在 zookeeper 中订阅这个消息。当分区分配发生改变时，zookeeper 就会通知负责决策的组件更新路由信息，使其保持在最新的状态。</p>
<p>除此之外也可以在各个节点间采用 <strong>流言协议</strong> 来传播集群状态的变化，这样每个节点都维护有最新的数据路由方案，当其中一个节点收到请求时，会将其转发到合适的分区节点上（对应服务发现的方案一）。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[宝剑锋从磨砺出——零售数据库内核，为大促铸剑！]]></title>    <link>https://juejin.cn/post/7579427549471834158</link>    <guid>https://juejin.cn/post/7579427549471834158</guid>    <pubDate>2025-12-03T09:43:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579427549471834158" data-draft-id="7579451710302486554" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="宝剑锋从磨砺出——零售数据库内核，为大促铸剑！"/> <meta itemprop="keywords" content="数据库,程序员"/> <meta itemprop="datePublished" content="2025-12-03T09:43:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            宝剑锋从磨砺出——零售数据库内核，为大促铸剑！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T09:43:35.000Z" title="Wed Dec 03 2025 09:43:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读25分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><em>癸卯七月风雨大作</em></p>
<p><em>京东零售·袁博文</em></p>
<p><em>僵卧双九不自哀，尚思为东戍轮台。</em></p>
<p><em>夜阑卧听珊瑚雨，铁马内核入梦来。</em></p>
<p>﻿<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13c59c3cb53d4c5f8fa219972699b8d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765359814&amp;x-signature=GlUOtsjvugAgnsd65OQfluDn8V0%3D" alt="图片.png" loading="lazy"/></p>
<p>﻿﻿</p>
<p><em><strong>前言略长，只关心技术的同学可直接跳过看第二章</strong></em></p>
<h2 data-id="heading-0"><strong>一、前言：技术的底色是什么？</strong></h2>
<p>这个问题在技术人心中其实没有标准答案，每个人都有每个人的见解。架构师眼里大抵是高屋建瓴，统领全局；技术大牛的视角可能是剖根溯源，精刀细琢；新人小白或许更单纯，无非就是学习进步，快速成长为大牛之类了。</p>
<p>但在我——一个京东数据库人的眼里，技术的底色或许应该是五彩斑斓的吧。</p>
<h4 data-id="heading-1"><strong>白是纯粹的起点</strong></h4>
<p>经常听人说，每个人呱呱坠地那一刻，都是一张白纸，父母在其上着墨。对于技术人来说又何尝不是呢？初学一门技术，初入一个领域，每个人都是一张白纸，在这张白纸上是随意草稿涂鸦，还是认真吸收不断进步，都取决于自己。</p>
<p>数据库内核技术，在 2020 年初，于我个人于内核团队于京东而言都是一个纯白的起点。自此开始探索数据库内核的每一行源码、每一个模块，然后攻关研究每一个技术难点，再设计实现云原生的珊瑚数据库直到其落地承接业务。我和我们团队的小伙伴都可以拍着胸脯说，我们无愧于京东，无愧于这份纯白。</p>
<h4 data-id="heading-2"><strong>青是朝气是成长</strong></h4>
<p>内核团队每一个小伙伴，不论是社招还是校招，都是那么朝气蓬勃，都对数据库内核技术求知若渴。腾龙认真钻研探索，成功打通了数据库测试用例线上部署和初始的内核监控框架；福哥将华为的优良编码风格带入团队并影响了许多小伙伴，还在DDL模块钻研并颇有造诣；海鹏探索并打通了内核与JED接口，为高可用付出良多；金蓬初入团队，甚至连技术栈都是初学，抱着一本经典的《<em>C++ Primer</em>》边啃边研究珊瑚数据库内核源码，但不妨碍进步速度惊人，最终能够独当一面；海波攻关的修改缓冲影子页技术以及共享集群测试框架至今还在持续带来价值；珊哥和齐哥更不用说，一个将多年积累的开发经验与珊瑚数据库内核模块深入结合，做出了诸多贡献；另一个不但对元数据锁研究透彻，更是独自一人承担了整个珊瑚数据库的工程化落地与高可用及运维工具建设。作为校招生的彭凯和宇歆，更是在短短的时间内，迅速成长，深入研究SQL词法和语法解析，以及主从复制模块，并为新产品的铸剑做出了突出的贡献。现在，越来越多的朝气蓬勃的新伙伴陆续加入了我们团队，大家的快速成长都有目共睹。</p>
<p>大家都从当初的青涩小白，成长成了各个内核领域的专家，或者独当一面的人才。所以青这个底色，一定是技术人努力成长，拼搏向上的颜色吧。</p>
<h4 data-id="heading-3"><strong>黄是最后的执着</strong></h4>
<p>在眼看京东数据库内核团队蒸蒸日上，大家在内核领域日渐深耕的时候，不出意外的还是出意外了……</p>
<p>集团层面的架构调整，让零售和科技的技术团队不得不融合成一个团队了，我想初衷肯定是好的，大家也都为之努力过。但出于种种不便明说的原因，数据库内核团队成了大的架构齿轮磨合下的那个代价，团队动荡，未来不明，无奈之下许多初露锋芒的优秀小伙伴不得不做出各自的选择。就在我以为京东数据库内核就要黄了的时候，不幸中的万幸，在零售众多大佬同事的全力保护下，内核的种子留了下来，静待花开。而属于技术人的这份坚守，或许就像鹅卵黄一样，等待破壳重生的那一刻吧。</p>
<h4 data-id="heading-4"><strong>赤是对技术的热忱</strong></h4>
<p>如果希望有颜色，那么一定是红色！</p>
<p>就像赤色当年卧薪尝胆，艰苦奋斗，爬雪山过草地，把希望带给神州大地一样。属于京东技术的赤色，也在京东技术中心迎来新的大家长后随之到来。我不知道其他团队是不是有类似的感受，但数据库团队在回归零售以后，大家的心气神都不一样了，对技术那颗火热的心又重新燃了起来。数据库团队也迎来了新leader：一位在数据库领域有着二十年经验的超级大佬和一位在数据库内核领域有十多年经验的资深大佬。在两位大佬的带领下，我们开始朝着新的方向前进。</p>
<p>同时，数据库内核团队也很快迎来了越来越多的新鲜血液：来自其他大厂的林康、正茂、张扬，将他们所掌握的数据库内核以及工程化经验引入，为我们内核的研发装上了加速器；来自各大名牌高校的校招生以及实习生晓冰、江昊、一贤、祖才等等，也都快速学习迅速成长，以最饱满的热情融入我们团队并做出了相应的贡献。</p>
<p>大家都饱含赤诚，携手开始向未来进发！</p>
<h4 data-id="heading-5"><strong>黑是五彩斑斓的未来</strong></h4>
<p>始于白，终于黑。就像太极阴阳鱼一样，生生不息，周而复始。技术也一样！</p>
<p>自然界当所有的颜色混在一起后，只有一个颜色——黑。数据库内核的团队也在沉淀和挫折中更加强大，随着不断补充新鲜的血液，从市场上吸引更多优秀的数据库内核人才，当所有技术的底色混在一起后，所有的五彩斑斓，所有的初心、成长、坚守、希望融为一体后，所有的不同领域的人才齐心协力共渡难关后，那结合在一起的力量，其实就只剩下未来那无限的可能——五彩斑斓的黑。内核技术的深渊也如黑洞般，深不见底，等待我们去探索。但我相信，只要我们秉持技术人的底色，就一定可以达到那个彼岸！</p>
<h2 data-id="heading-6"><strong>二、正篇：五彩熔炉，铸剑！</strong></h2>
<p>正篇开始！</p>
<p>抱歉大家，前面扯了这么多其实只是前言。但我又不想像以前写前言那样，只是简单的交代一下背景。花了五节的笔墨介绍我心中的技术底色，只希望大家能懂一点——我们会以最大的热情和最强的技术为京东打造基础数据库产品，为大家带来更优质的数据库服务。</p>
<h4 data-id="heading-7"><strong>到底铸了什么剑？</strong></h4>
<p>属于我们京东电商版本的自研数据库内核——DongSQL！</p>
<p>五年前，数据库内核团队立项直接瞄准了新的数据库形态——云原生关系型数据库，也就是存算分离共享存储架构的珊瑚数据库(shared storage)，这一版技术难点主要是在共享存储的架构以及云原生的数据一致性，其产品价值主要是在节约数据库成本以及极致的云上资源伸缩性等。但由于与存量JED库(shared nothing)采用了不一样的技术架构，所以面临一个现实问题——存量用户版本无法平滑升级。</p>
<p>用过或者了解数据库的人都知道，有的时候不是大家不想使用更新的版本，更强的性能，更优秀的功能，而是数据库本身太基础太重要了，如果业务系统已经建设很多年，与数据库绑定太深的话，更多还是求稳为主，能不动则不动。这不是京东独有的情况，可以说整个行业皆是如此，这叫技术惯性。正是因为采用了新的技术架构，带来了一个问题：存量业务如果要使用必须进行数据库的迁移。就这一个原因，很多业务就望而却步。</p>
<p>正是由于这个原因，在新leader带领我们团队以后，基于丰富的数据库经验，敏锐地察觉到京东整个数据库的基本盘其实是存量的数据库，解决存量数据库用户的问题才能带来更大的价值。再优秀的产品，如果没人用一样白费力气。</p>
<p>因此，我们需要做的是，一个完全适配存量架构的数据库内核，不引入更复杂的架构变更和过多的设计，只在其基础上对数据库内核性能进行优化、对配套能力进行提升、对零售电商场景进行针对性扩展，完美支持JED以及DongDAL，秉持稳定性和兼容性为前提的基础上，让京东的数据库内核更好用，更强大！</p>
<h4 data-id="heading-8"><strong>电商场景下数据库痛点的解决之道</strong></h4>
<p>电商场景的数据库需求其实是用户最迫切的，因此我们在首选开刀方向时，没有选择引入花里胡哨高大上的功能等角度。而是从用户中来，回到用户中去，深入分析目前线上用户最常见的问题，以及大促最常见的故障场景，针对性的引入了内核层新的解决方案。</p>
<h5 data-id="heading-9"><strong>问题一：“过载” 大促激增的流量，或者超时SQL不断重试直接把数据库CPU打满甚至打挂</strong></h5>
<p>﻿</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4e6426f6b5543c099a863554b85fdc4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765359814&amp;x-signature=rkofY9xbAv6DnOdnCwI0I7%2BWyVw%3D" alt="图片.png" loading="lazy"/></p>
<p>﻿<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21e949eb52e443dfba30411f1adcb7c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765359814&amp;x-signature=%2B6yRk1hZiqzc%2FeyE97Q6aU5L%2Bg0%3D" alt="图片.png" loading="lazy"/></p>
<p>这种场景真的非常常见，甚至前段时间还有一个白虎故障就是类似的原因。业务研发在设计功能的时候，其实是无法预知线上生产环境真实的流量的，或许可以设计应用侧限流，也或许可以加缓存抗量，但限流不是每个系统都有，即使有也可能存在疏漏，缓存如果被击穿那带给数据库的流量更是暴击。有的时候甚至不是真实暴增的流量，而只是超时机制的负反馈，失败的不断重试就带来了超出预期的数据库请求。</p>
<p>当请求流量突然暴涨时或者突发的慢sql占用大量资源时，它会像一个被瞬间涌入人群挤垮的服务台：每个新连接都需要数据库创建一个线程来处理，大量线程的创建、上下文切换和维持本身就会吃掉可观的内存和CPU；更重要的是，每个查询进来，内核都要疯狂工作——解析复杂的SQL语句、在成千上万条索引条目中查找路径、拼凑关联多张表的数据、进行排序分组计算、管理事务保证一致性（这涉及到频繁的加锁解锁，高并发时极易堵塞排队）、还要不断从磁盘读取数据或把改动写回去。所有这些操作都是极度消耗CPU算力的密集计算。当每秒涌入的请求远超CPU能处理的速度时，CPU就会被完全占满，所有查询都挤在一起排队等待计算资源。与此同时，高并发下锁冲突剧增，大量线程因等待锁而阻塞却不释放资源；内存可能被临时表、排序缓存塞爆；严重时磁盘IO也跟不上。最终，CPU被彻底耗尽，新连接无法建立，已有查询完全卡死，整个数据库进程失去响应，就像被“打挂”了一样，本质上就是所有关键资源（CPU、内存、IO、连接）在瞬间洪峰下被彻底榨干导致的系统性崩溃。</p>
<p>原因很清楚，解决方式也很简单，前面也提到了，限流即可，可实际生产环境操作起来还是会出现诸多困难。</p>
<p>业务层自行限流面临的主要挑战在于其“粗放”和“滞后”。它通常只能基于简单的请求频率或用户维度（如QPS）进行拦截，无法洞察数据库内部真实的瓶颈所在（比如是在CPU、内存、磁盘IO还是锁冲突）。这极易导致“误杀”——核心的重资源消耗型SQL可能未被拦住，反而大量高频但轻量的请求被限流，牺牲了业务可用性却未能真正缓解数据库压力。同时，在分布式微服务架构下，协调各个服务模块统一、实时地实施并调整限流策略异常困难，很容易出现限流不一致或响应迟缓，当业务层感知到数据库响应变慢或报错再触发限流时，往往已经错过了最佳干预时机，雪崩可能已经发生。</p>
<p>目前的实际操作往往是高可用程序或者DBA依靠HA机制进行主备切换来应对过载。切换过程本身必然导致数秒到数十秒的服务中断（连接闪断、短暂只读），对连续性要求高的业务会造成直接影响。更重要的是数据一致性问题：主库在故障或过载瞬间可能存在未同步到备库的事务数据，切换后这些数据可能永久丢失（异步复制下），即使使用半同步复制也可能因网络问题阻塞写入或退化为异步。历年大促线上生产环境不少故障甚至是发生在切换操作之后(普通RDS集群以及低版本vitess集群风险尤其显著)。</p>
<h5 data-id="heading-10"><strong>解：SQL自提示实现精准限流</strong></h5>
<p>基于以上痛点，不少用户提出，如果可以实现精准限流就好了，既能在业务根据流量预测的基础上预防性限流，又能在过载发生后根据简单排查的结果定向限流。有求必应——Hint限流方案横空出世！</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">/</span><span class="hljs-operator">/</span> 根据特定 <span class="hljs-keyword">SQL</span> 指纹进行限流 
<span class="hljs-keyword">update</span><span class="hljs-comment">/*+ ccl_queue_digest(INT&lt;当前语句的并行数&gt;) */</span> t <span class="hljs-keyword">set</span> col1 <span class="hljs-operator">=</span> col1<span class="hljs-operator">+</span><span class="hljs-number">1</span> <span class="hljs-keyword">where</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span>id; 
<span class="hljs-keyword">update</span><span class="hljs-comment">/*+ ccl_queue_digest() */</span> t <span class="hljs-keyword">set</span> col1 <span class="hljs-operator">=</span> col1<span class="hljs-operator">+</span><span class="hljs-number">1</span> <span class="hljs-keyword">where</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span>id;
</code></pre>
<p>数据库内核自身支持限流的核心优势是，我们能深入到SQL执行层，根据用户指定规则（如匹配特定SQL指纹、或者SQL语句全文等不同模式规则）实时识别并优先抑制那些真正“吃掉”大量资源的“罪魁祸首”查询。这如同在数据库引擎内部安装了一个智能节流阀，直接从源头（消耗资源的查询）进行精准控制，避免了业务层限流的盲目性和HA切换的破坏性。它能在资源紧张初现端倪时就主动干预，最大限度保障核心业务请求的通过和系统整体的稳定性，且由内核统一管理，规则生效及时、策略执行高效。</p>
<h5 data-id="heading-11"><strong>问题二：“秒杀” 单点高频写入带来的数据库性能下降，以及库存一致性问题</strong></h5>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/658809ca5a5f48c5bd809b988f0244b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765359814&amp;x-signature=m%2FYmDmq0FVgA5Jr3fvd4ZcUen2M%3D" alt="图片.png" loading="lazy"/></p>
<p>秒杀是电商业务非常常见的场景，无论秒杀业务是否设计缓存前置抗量，库存数据的最终变更都是需要落到数据库的。如果缓存发生击穿，更是需要数据库来进行兜底策略。但秒杀这个场景的数据库操作又极其特殊，甚至可以说会导致传统数据库痛点集中爆发。</p>
<p>首先，高频单行更新使行级锁竞争成为致命瓶颈：当海量请求同时扣减同一商品库存时，存储引擎的行锁强制串行更新，导致线程在锁等待中堆积；死锁检测机制在队列过长时（如超1000线程）触发深度遍历，CPU资源被疯狂消耗，事务响应时间骤增甚至超时。</p>
<p>其次，高频事务的ACID保障带来巨大开销：事务在数据库内核中是核心能力之一，在秒杀场景下往往都是简单事务，但为了保证查询更新的一致性，又不得不开显式事务(非auto commit)，而显式事务的BEGIN、Statement、COMMIT/ROLLBACK，每一个子句都会完整的经历应用侧到数据库底层的多级转发和网络开销，伴随多次网络交互（跨节点延迟加剧堵塞）及日志写入，单事务耗时飙升，系统吞吐量断崖式下跌。</p>
<p>最后，秒杀场景的库存扣减不允许出现意料外的更新：传统数据库的高并发扣减需通过SELECT检查库存后再执行UPDATE，但两步操作存在时序漏洞——高并发下多个请求可能同时读到相同库存值，导致超卖；同时所有请求（包括库存不足的无效请求）均需竞争同一行锁，引发线程堆积和死锁检测的CPU暴增。</p>
<h5 data-id="heading-12"><strong>解：电商秒杀场景定制优化</strong></h5>
<p><strong>秒杀排队</strong>：高频更新问题很好解决，借用限流的思路，只不过秒杀场景要限的是具体的字段甚至是具体的值，因为高频SQL是集中在具体数量的库存或者单一品类上的，要改的可能就几行甚至是一行数据。因此，我们借用了限流的Hint语法，业务只需要在预期秒杀需要更改的具体SQL上，加上对应的Hint规则，约定具体字段或者具体值需要进行限制排队执行，数据库内部就会对秒杀类的SQL进行管理排队，极大程度的规避了行锁的竞争以及其连锁反应，经测试单行更新高并发场景下，比传统数据库的流量能提升一倍以上。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 根据热点值限流</span>
 update<span class="hljs-comment">/*+ ccl_queue_value('茅台') */</span> t <span class="hljs-keyword">set</span> c=c+<span class="hljs-number">1</span> <span class="hljs-keyword">where</span> name =<span class="hljs-string">'茅台'</span>; 
 <span class="hljs-comment">// 根据热点字段限流</span>
  update<span class="hljs-comment">/*+ ccl_queue_field(order_id) */</span> t <span class="hljs-keyword">set</span> c=c+<span class="hljs-number">1</span> <span class="hljs-keyword">where</span> order_id =<span class="hljs-number">1</span><span class="hljs-keyword">and</span> name =<span class="hljs-string">'茅台'</span>;
</code></pre>
<p><strong>事务快速提交/回滚</strong>：针对秒杀事务的特性，设计了事务快速提交回滚的Hint，即用户在事务COMMIT/ROLLBACK前的最后一个SQL语句上，如果加上该Hint，则内核即明白该操作提交或者回滚了。此方案在秒杀场景下，尤其是特定单行更新的场景下，最高可以提升 3 倍以上的性能！优势非常明显。</p>
<p><strong>影响行数约束</strong>：秒杀场景库存扣减，或者其他非秒杀场景也可能存在，业务侧的逻辑明确知道某条SQL更新后应该影响几行数据，如果数据库执行完发现影响的行数不符合预期则大概率出现问题了，需要将事务进行回滚。我们设计了预期影响行数的Hint，通过该Hint（示例 UPDATE /*+ TARGET_AFFECT_ROW(1) */ stock SET count=count-1 WHERE id=100 AND count&gt;=1），可同步实现两大核心优化：</p>
<p>其一，引擎在加锁前优先校验 WHERE 条件（库存≥1），仅当库存充足时才尝试加锁更新，库存不足的请求直接返回影响行数=0，避免无效锁竞争；</p>
<p>其二，库存检查与扣减压缩为单原子操作，确保影响行数严格为1才成功，否则自动失败，彻底杜绝跨事务的脏读与超卖风险。当然也可以配置其他数值，只要与您预期的影响行数一致即可。</p>
<h5 data-id="heading-13"><strong>问题三：“缓存更新一致性问题” 业务前置缓存失效时，会直接更新数据库，然后查询已更新数据并返回</strong></h5>
<p>许多业务系统会在数据库访问层之上引入缓存，例如京东的分布式缓存JIMDB，以利用其极致的读写响应速度优化用户体验。然而，缓存的易失性本质决定了其无法独立承担关键数据的持久化职责——数据库始终是不可或缺的兜底保障（除非数据可容忍丢失）。维护缓存与数据库之间的强一致性是系统设计的核心挑战，当缓存失效导致请求穿透至数据库时，业务常需同步获取刚更新的数据并实时刷新缓存或响应前端。传统数据库在此场景下存在显著局限：若要在事务中确保更新后立即可见且数据一致，必须在DML操作后紧跟一条SELECT语句进行查询。但即便采用此方案，在读已提交（RC）隔离级别下，其他事务的并发修改仍可能导致该查询读到不一致数据，无法满足严格的实时一致性要求。</p>
<h5 data-id="heading-14"><strong>解：实现RETURNING语法</strong></h5>
<p>我们通过实现RETURNING语法解决这一问题：在UPDATE/INSERT等DML语句末尾追加RETURNING子句，就能直接获取修改后的完整行数据。比如库存扣减场景下，一条UPDATE inventory SET stock=stock-1 WHERE id=100 RETURNING *;语句既完成了原子扣减，又能立即返回最新库存值，无需额外SELECT查询。</p>
<p>这一内核级优化不仅消除了RC隔离下的并发脏读风险（DML与返回数据基于同一事务快照，其他事务的并发修改不会干扰结果），还将“更新 + 查询”的两次网络交互压缩为单次请求，把事务耗时再降一个级别。对缓存架构而言，业务侧拿到RETURNING返回的实时数据后，能立刻刷新缓存层，在事务提交时就完成数据对齐，让秒杀、大促等高并发场景下的“缓存击穿兜底逻辑”，既快又稳。</p>
<h5 data-id="heading-15"><strong>问题四："执行计划漂移" 好好的SQL突然就慢了</strong></h5>
<p>这个问题真的让人头疼，一条SQL在开发环境跑得飞快，到了线上就变成了蜗牛。更要命的是，有时候同一条SQL，今天还好好的，明天就突然慢得要死。</p>
<p>举个例子，我们有条订单查询的SQL：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> o.<span class="hljs-operator">*</span>, u.name  
<span class="hljs-keyword">FROM</span> orders o  
<span class="hljs-keyword">JOIN</span> users u <span class="hljs-keyword">ON</span> o.user_id <span class="hljs-operator">=</span> u.id  
<span class="hljs-keyword">WHERE</span> o.create_time  
<span class="hljs-keyword">BETWEEN</span> <span class="hljs-string">'2025-10-01'</span> <span class="hljs-keyword">AND</span> <span class="hljs-string">'2025-10-30'</span> <span class="hljs-keyword">AND</span> o.status <span class="hljs-keyword">IN</span>(<span class="hljs-string">'PAID'</span>,<span class="hljs-string">'SHIPPED'</span>) 
 <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> o.create_time <span class="hljs-keyword">DESC</span> LIMIT <span class="hljs-number">100</span>;
</code></pre>
<p>平时这条SQL毫秒级就能出结果，用的是<code>orders.idx_create_time</code>索引。但有一天大促期间，这条SQL突然开始走全表扫描，30秒才能跑完，直接把系统拖垮了。</p>
<p>为什么会这样？数据库优化器是个"聪明"的家伙，它会根据表的统计信息来选择执行计划。但问题就出在这些统计信息上——<code>ANALYZE TABLE</code>更新了统计信息，数据分布发生了变化，或者系统负载影响了成本计算，优化器就可能突然"变心"，选择一个完全不同的执行路径。</p>
<p>这种情况在大促期间特别危险，数据量激增、系统负载变化，一条核心查询的执行计划突然劣化，整个系统可能就垮了。</p>
<p>传统的解决办法要么重启数据库（代价太大），要么业务研发加Hint强制索引（破坏代码可维护性，还得紧急上线，时间周期长），要么调优化器参数（可能影响其他SQL），都不是很好的选择。</p>
<h5 data-id="heading-16"><strong>解：Statement Outline执行计划固化功能</strong></h5>
<p>为了解决这个问题，我们实现了Statement Outline功能，可以把稳定高效的执行计划"固化"下来，让优化器按照我们指定的方式执行。这个功能通过存储过程包来管理，使用起来很简单。比如我们发现某个查询有个很好的执行计划，就可以把它记下来，一旦发生上述意外场景，可以立即将其注入数据库从而稳定该类型SQL的执行：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 添加优化器hint的outline</span>
 <span class="hljs-keyword">CALL</span> dbms_outln.add_optimizer_outline(   
 <span class="hljs-string">'your_db'</span>,                                     <span class="hljs-comment">-- 数据库名称    </span>
 <span class="hljs-string">''</span>,                                            <span class="hljs-comment">-- SQL语句的摘要，为空时自动计算      </span>
 <span class="hljs-number">1</span>,                                             <span class="hljs-comment">-- 位置，通常为1     </span>
 <span class="hljs-string">'/*+ USE_INDEX(orders idx_create_time) */'</span>,    <span class="hljs-comment">-- 优化器提示文本      </span>
 <span class="hljs-string">'SELECT o.*, u.name        FROM orders o       
 JOIN users u ON o.user_id = u.id        
WHERE o.create_time BETWEEN '</span><span class="hljs-number">2025</span><span class="hljs-number">-10</span><span class="hljs-number">-01</span><span class="hljs-string">' AND '</span><span class="hljs-number">2025</span><span class="hljs-number">-10</span><span class="hljs-number">-30</span><span class="hljs-string">' AND o.status IN ('</span>PAID<span class="hljs-string">', '</span>SHIPPED<span class="hljs-string">')       
ORDER BY o.create_time DESC LIMIT 100;'</span>       <span class="hljs-comment">-- SQL语句文本); </span>

<span class="hljs-comment">-- 添加强制索引的outline   </span>
<span class="hljs-keyword">CALL</span> dbms_outln.add_index_outline(      <span class="hljs-string">'your_db'</span>,                                     <span class="hljs-comment">-- 数据库名称     </span>
 <span class="hljs-string">''</span>,                                            <span class="hljs-comment">-- SQL语句的摘要，为空时自动计算      </span>
<span class="hljs-number">1</span>,                                             <span class="hljs-comment">-- 位置，通常为1     </span>
 <span class="hljs-string">'USE INDEX'</span>,                                   <span class="hljs-comment">-- 索引提示类型，如'USE INDEX'、'IGNORE INDEX'等     </span>
 <span class="hljs-string">'idx_status'</span>,                                  <span class="hljs-comment">-- 索引列表，多个索引用逗号分隔      </span>
 <span class="hljs-string">''</span>,                                            <span class="hljs-comment">-- 索引提示选项，如'FOR JOIN'、'FOR ORDER BY'等     </span>
<span class="hljs-string">'SELECT o.*, u.name       
 FROM orders o        
JOIN users u ON o.user_id = u.id        
 WHERE o.create_time BETWEEN '</span><span class="hljs-number">2025</span><span class="hljs-number">-10</span><span class="hljs-number">-01</span><span class="hljs-string">' AND '</span><span class="hljs-number">2025</span><span class="hljs-number">-10</span><span class="hljs-number">-30</span><span class="hljs-string">' AND o.status IN ('</span>PAID<span class="hljs-string">', '</span>SHIPPED<span class="hljs-string">')        
 ORDER BY o.create_time DESC LIMIT 100;'</span>       <span class="hljs-comment">-- SQL语句文本);</span>
</code></pre>
<p>这样一来，即使统计信息变化了，优化器也会按照我们固化的执行计划来执行，保证查询性能的稳定性，让我们能够精确控制查询的执行方式。对于那些业务关键的SQL，这个功能简直是"定海神针"，彻底解决了执行计划漂移的问题。</p>
<p>Outline还可以注入自定义的hint，比如“问题一”中的解决过载问题hint或者“问题二”中的秒杀场景hint。</p>
<h5 data-id="heading-17"><strong>问题五："线程拥堵" 每连接每线程的弊病</strong></h5>
<p>传统数据库是没有线程池的，每个连接都要创建一个独立的线程来处理，常规场景每连接每线程还很稳定，但高并发场景下就是灾难。</p>
<p>想象一下大促期间的场景：成千上万个连接同时涌入数据库，每个连接都要创建线程，线程创建和销毁的开销巨大，CPU忙着做上下文切换，真正用来处理SQL的时间反而不多。更要命的是，所有请求都是一视同仁，核心的支付查询可能被大量的日志写入、报表查询这些不紧急的请求给"淹没"了。在JED架构下，由vitess控制了连接的数量，这个问题还不大，但目前DongDAL直连DongSQL的架构，这个就成了不得不面对的重点问题！</p>
<p>线程拥堵的问题看起来和过载很像，但还略有一点区别。过载场景可以精确识别到个别问题SQL，并进行精准限流，从而保证不影响其他SQL。而线程拥堵的大部分甚至所有连接都是正常SQL，没有谁是受害者，只不过突发流量真的太大了！所以这种场景，我们就不得不祭出大杀器——线程池！</p>
<h5 data-id="heading-18"><strong>解：DongSQL线程池</strong></h5>
<p>我们实现了完整的线程池功能，能够有效复用线程资源，避免频繁创建和销毁线程的开销。线程池会维护一组工作线程，新来的连接请求会被分配到空闲的线程上处理，这样就能大大减少上下文切换，提升高并发场景下的性能。</p>
<p>这样一来，来自核心服务器/核心用户的请求就能优先得到处理，不会被其他不那么紧急的请求给挤占了。系统会智能识别高优先级连接，确保关键功能的响应时间。</p>
<p>这些优化功能的加入，让DongSQL在高并发、大数据量的零售电商核心场景下展现出了更强的稳定性和性能。每一个功能都是我们在实际业务中遇到问题、分析问题、解决问题的结果，希望能够帮助更多的团队应对类似的挑战。</p>
<h2 data-id="heading-19"><strong>三、结语：技术的成色又是什么呢？</strong></h2>
<p>如果说技术的底色，是求知、是成长、是执着、是热忱、是我们所有技术人团结在一起爆发出的力量。</p>
<p>那么技术的成色，一定有脚踏实地，追根溯源，不浮于表象，而深入骨髓地解决根本问题。正所谓：求木之长者，必固其根本；欲流之远者，必浚其泉源。对于数据库，则必须具备掌控数据库内核的能力，方能使自身以及其上承接的业务行稳致远。</p>
<p>除此之外，更宏观的维度，技术的成色我想应该就是为团队、为公司、为用户、乃至为社会产生实实在在的价值吧！正如公司使命说的那样：<strong>技术为本，让生活更美好！</strong> 让我们携手所有业务研发团队做实事、有价值的事、长期的事，为京东的 35711 梦想付出我们自己的一份力！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[京东自研电商数据库内核DongSQL简介]]></title>    <link>https://juejin.cn/post/7579440586693984302</link>    <guid>https://juejin.cn/post/7579440586693984302</guid>    <pubDate>2025-12-03T09:44:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579440586693984302" data-draft-id="7579427549471850542" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="京东自研电商数据库内核DongSQL简介"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2025-12-03T09:44:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/2634854380340008"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            京东自研电商数据库内核DongSQL简介
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2634854380340008/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T09:44:07.000Z" title="Wed Dec 03 2025 09:44:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>团队于今年(2025.9)打磨出了深度优化的自研数据库内核——DongSQL V1.1.0。</p>
<p><em>[如果对前因后果比较感兴趣，可以移步上一篇文章</em><a href="https://link.juejin.cn?target=http%3A%2F%2Fsd.jd.com%2Farticle%2F47706%3FshareId%3D52009%26isHideShareButton%3D1" target="_blank" title="http://sd.jd.com/article/47706?shareId=52009&amp;isHideShareButton=1" ref="nofollow noopener noreferrer"> <em>《宝剑锋从磨砺出——零售数据库内核，为大促铸剑！》</em> </a><em>]</em></p>
<p>本文将深度解析DongSQL在语法扩展、并发控制、查询优化等方面的内核改造，以及在电商场景下的优化实践。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e6b2f39df7a49be869523ea82f78946~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765359847&amp;x-signature=FZ0gLuiQ9p%2F%2FCL9ClrDi9GdpRFM%3D" alt="图片.png" loading="lazy"/></p>
<h2 data-id="heading-0">1、DongSQL在语法扩展上的优化</h2>
<h3 data-id="heading-1">1.1. RETURNING子句功能</h3>
<p><strong>▶︎ 语法扩展创新</strong>：DongSQL在标准SQL语法基础上扩展了RETURNING子句，这是重要语法创新。RETURNING子句允许DML语句(INSERT、UPDATE、DELETE、REPLACE)在执行数据修改操作的同时返回受影响的行数据，无需额外查询。</p>
<p>传统数据库在执行DML操作后，如果需要获取操作结果，必须执行额外的SELECT查询，这在高并发场景下会产生额外的网络往返开销。DongSQL通过RETURNING子句彻底解决了这一问题。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- INSERT操作返回自增ID </span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> orders (customer_id, order_date) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1001</span>, NOW()) RETURNING order_id; 

<span class="hljs-comment">-- UPDATE操作返回更新后的数据 </span>
<span class="hljs-keyword">UPDATE</span> products <span class="hljs-keyword">SET</span> price <span class="hljs-operator">=</span> price <span class="hljs-operator">*</span> <span class="hljs-number">1.1</span> <span class="hljs-keyword">WHERE</span> category <span class="hljs-operator">=</span> <span class="hljs-string">'electronics'</span>  
RETURNING product_id, name, old_price, price; 

<span class="hljs-comment">-- DELETE操作返回被删除的记录 </span>
<span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> expired_sessions <span class="hljs-keyword">WHERE</span> expire_time <span class="hljs-operator">&lt;</span> NOW()  
RETURNING session_id, user_id, expire_time;
</code></pre>
<p><strong>▶︎ 性能提升效果</strong>：经测试验证，RETURNING子句在不同场景下都能带来显著的性能提升：</p>
<p>•<strong>固定行更新场景</strong>：16并发时TPS提升61%，响应时间降低44%</p>
<p>•<strong>随机行更新场景</strong>：128并发时TPS提升18%</p>
<p>•<strong>大规模更新测试</strong>：2000万次操作中平均TPS提升5-10%</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62994ddf0b9a439eb780bd0e98832c43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765359847&amp;x-signature=HfUlNXPwXmyFdspZTwvavR0w3jc%3D" alt="图片.png" loading="lazy"/></p>
<p><strong>▶︎ 生产落地预期</strong>：该功能与DongDAL发号器逻辑高度匹配，有望将发号器性能瓶颈大幅提升(DongDAL团队配套开发推进中)</p>
<h3 data-id="heading-2">1.2. Hint语法扩展</h3>
<p><strong>▶︎ 多样化Hint支持</strong>：DongSQL扩展了Hint语法体系，提供了针对电商场景的专用提示功能，包括并发控制、库存管理等领域特定的优化。</p>
<p><strong>▶︎ Inventory Hint</strong>：专门针对电商库存管理场景设计的提示语法，提供目标影响行数控制、自动提交/回滚等特性。</p>
<pre><code class="hljs language-ini" lang="ini">-- 库存扣减：确保只影响一行，成功自动提交，失败自动回滚
 UPDATE /*+ TARGET_AFFECT_ROW(1) COMMIT_ON_SUCCESS ROLLBACK_ON_FAIL */
  inventory SET <span class="hljs-attr">stock</span> = stock - <span class="hljs-number">5</span> 
   WHERE <span class="hljs-attr">product_id</span> = <span class="hljs-number">1001</span> AND stock &gt;= <span class="hljs-number">5</span><span class="hljs-comment">;</span>
</code></pre>
<p><strong>▶︎ 性能提升数据</strong>：在16并发的库存扣减场景下，使用Inventory Hint比不使用hint性能提升215%。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0a5827558dac469aa23633899c68b0a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765359847&amp;x-signature=YMq3blQi4Z9AEp%2BoK1jT9G8HqTQ%3D" alt="图片.png" loading="lazy"/></p>
<h2 data-id="heading-3">2、DongSQL在并发控制上的优化</h2>
<h3 data-id="heading-4">2.1. CCL并发控制</h3>
<p><strong>▶︎ 多维度限流机制</strong>：DongSQL实现了CCL(Concurrency Control)并发控制功能，通过多维度的限流策略，有效解决电商秒杀场景下的热点数据访问问题。</p>
<p>传统数据库在面对高并发热点数据访问时，往往会因为激烈的锁竞争导致性能急剧下降，甚至系统雪崩。DongSQL的CCL通过智能排队机制，将无序的并发请求转换为有序处理，从根本上解决了这一问题。</p>
<p><strong>▶︎ 多维度控制策略</strong>：</p>
<p>•<strong>基于字段的限流</strong>：<code>ccl_queue_field(column_name, concurrency)</code>，对特定字段值进行并发控制</p>
<p>•<strong>基于值的限流</strong>：<code>ccl_queue_value(value, concurrency)</code>，对特定数据值进行精准限流</p>
<p>•<strong>基于SQL指纹的限流</strong>：<code>ccl_queue_digest(concurrency)</code>，对相同SQL模式进行统一管控</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 对商品ID为999的热门商品进行限流，并发度限制为5</span>
 <span class="hljs-keyword">SELECT</span> <span class="hljs-comment">/*+ ccl_queue_value(999, 5) */</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">WHERE</span> product_id <span class="hljs-operator">=</span> <span class="hljs-number">999</span>; 
 
 <span class="hljs-comment">-- 对库存扣减操作按商品ID进行限流 </span>
 <span class="hljs-keyword">UPDATE</span> <span class="hljs-comment">/*+ ccl_queue_field(product_id, 8) */</span> inventory <span class="hljs-keyword">SET</span> stock <span class="hljs-operator">=</span> stock <span class="hljs-operator">-</span> <span class="hljs-number">1</span> <span class="hljs-keyword">WHERE</span> product_id <span class="hljs-operator">=</span> ?; 
 
 <span class="hljs-comment">-- 对相同SQL模式进行统一限流 </span>
 <span class="hljs-keyword">SELECT</span> <span class="hljs-comment">/*+ ccl_queue_digest(10) */</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> hot_products <span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
</code></pre>
<p><strong>▶︎ 性能突破数据</strong>：</p>
<p>•<strong>秒杀场景优化</strong>：在4096并发下，使用CCL限流后TPS从573提升至1337，性能提升133%</p>
<p>•<strong>系统稳定性</strong>：有效防止系统雪崩，将无序并发转换为有序处理</p>
<p>•<strong>热点缓解</strong>：通过队列机制显著降低热点数据的锁竞争</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/853112ad066541f39608b88cdda91325~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765359847&amp;x-signature=7P3xIjvJjwLakQOpp47PQ%2Bs5Qec%3D" alt="图片.png" loading="lazy"/></p>
<h3 data-id="heading-5">2.2. Statement Outline执行计划及自定义提示管理</h3>
<p><strong>▶︎ 企业级计划稳定性</strong>：DongSQL提供了Statement Outline功能，用于固化重要SQL的执行计划，防止因数据变化导致的计划不稳定问题。</p>
<p><strong>▶︎ 自定义Hint注入工具</strong>：包括但不限于上述秒杀、CCL限流场景的Hint，即使业务研发预期外的过载或者突发流量发生，应急情况下DBA也可以通过Statement Outline功能对问题SQL进行干预</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 为重要SQL固化执行计划 </span>
<span class="hljs-keyword">CALL</span> dbms_outln.add_index_outline(  
<span class="hljs-string">'test_db'</span>, <span class="hljs-string">''</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'USE INDEX'</span>, <span class="hljs-string">'idx_status'</span>, <span class="hljs-string">''</span>,  
 <span class="hljs-string">'SELECT * FROM orders WHERE status = "PAID"'</span> 
 ); 
 <span class="hljs-comment">-- 为特定查询添加ccl_queue_digest限流hint，限制并发度为2 </span>
<span class="hljs-keyword">CALL</span> dbms_outln.add_optimizer_outline(  
<span class="hljs-string">'test_db'</span>, <span class="hljs-string">''</span>, <span class="hljs-number">1</span>, <span class="hljs-string">'/*+ ccl_queue_digest(2) */'</span>,  
<span class="hljs-string">'SELECT * FROM orders WHERE customer_id = 1001'</span> );
</code></pre>
<p><strong>▶︎ 核心价值</strong>：</p>
<p>•<strong>性能稳定性</strong>：保障核心SQL性能不因数据变化而波动</p>
<p>•<strong>智能限流</strong>：支持基于SQL指纹的手动限流和自动限流(自动限流默认不开启，需要开启的业务需单独申请)</p>
<p>•<strong>企业级管理</strong>：提供生产级的执行计划管理能力</p>
<h2 data-id="heading-6">3、DongSQL在查询优化上的改进</h2>
<h3 data-id="heading-7">3.1. 单点查询优化</h3>
<p><strong>▶︎ 查询路径优化</strong>：DongSQL实现了单点查询bypass功能，针对主键等值查询这类高频简单查询，绕过部分SQL层处理逻辑，直接访问存储引擎，大幅提升查询性能。</p>
<p>电商场景中，商品详情查询、用户信息查询等基于主键的简单查询占据了很大比例。虽然这些查询逻辑简单，但在高并发下仍然消耗大量CPU资源。DongSQL的单点查询优化针对这一痛点进行了专项优化。</p>
<p><strong>▶︎ 性能提升数据</strong>：</p>
<p>•<strong>不同环境性能提升</strong>：容器环境提升20%，物理机环境提升30%</p>
<p>•<strong>高并发场景</strong>：当CPU达到瓶颈时，QPS提升20-28%</p>
<p>•<strong>资源效率</strong>：相同硬件配置下处理能力显著提升</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/246092d7b5474dedb667a73110149ae4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765359847&amp;x-signature=o2blg0q5THYoHHPbqKiFb4aHNo4%3D" alt="图片.png" loading="lazy"/></p>
<h3 data-id="heading-8">3.2. 线程池优化</h3>
<p><strong>▶︎ 高并发处理能力</strong>：DongSQL实现了企业级线程池功能，通过智能线程调度和资源管理，显著提升了系统在高并发场景下的处理能力和稳定性。</p>
<p>传统数据库在面对大量并发连接时，会为每个连接创建独立线程，这在高并发下会导致线程切换开销过大、内存消耗激增等问题。DongSQL的线程池优化通过复用线程资源，有效解决了这些问题。</p>
<p><strong>▶︎ 调度机制</strong>：</p>
<p>•<strong>线程复用：</strong> 通过线程池复用减少线程创建销毁开销</p>
<p>•<strong>负载均衡：</strong> 分配任务到不同线程，避免热点线程</p>
<p>•<strong>优先级调度：</strong> 支持任务优先级，保障重要业务优先处理</p>
<p><strong>▶︎ 性能突破数据</strong>（基于8C32G测试环境，sysbench 16张表每张1000万行数据）：</p>
<p><strong>只读场景性能对比</strong>：</p>
<p>•<strong>低并发优势</strong>：32线程时，线程池模式QPS达到141,261，相比传统模式的110,658提升27.6%</p>
<p>•<strong>高并发稳定性</strong>：在512线程高并发下，线程池模式QPS保持131,939，而传统模式仅61,580，性能提升114%</p>
<p>•<strong>延迟控制</strong>：512线程时TP99延迟从传统模式的297.92ms优化到118.92ms，降低60%</p>
<p><strong>纯写场景性能突破</strong>：</p>
<p>•<strong>中等并发</strong>：64线程时QPS从46,577提升到57,655，性能提升23.8%</p>
<p>•<strong>高并发场景</strong>：512线程时QPS从29,541提升到58,166，性能提升97%</p>
<p>•<strong>超高并发</strong>：4096线程时QPS从28,571提升到54,687，性能提升91%</p>
<p><strong>读写混合场景优化</strong>：</p>
<p>•<strong>128线程</strong>：QPS从54,870提升到80,244，性能提升46%</p>
<p>•<strong>256线程</strong>：QPS从48,787提升到77,961，性能提升60%</p>
<p>•<strong>延迟优化</strong>：256线程时TP99延迟从196.89ms优化到158.63ms，降低19%</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/853868c0a1cb4256942759766e9739e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765359847&amp;x-signature=uhYejtH%2BSG6rLu8JlS8VDzxgI7Y%3D" alt="图片.png" loading="lazy"/></p>
<h3 data-id="heading-9">3.3.  其他查询执行优化</h3>
<p><strong>▶︎ 执行路径优化</strong>：DongSQL在查询执行引擎层面进行了多项优化，包括算子优化、内存管理优化、并行执行优化等。</p>
<p><strong>▶︎ 缓存机制增强</strong>：优化了Buffer Pool管理策略，页面mutex优化，提升了数据访问效率，降低了I/O锁冲突。</p>
<h2 data-id="heading-10">4、性能基准测试汇总</h2>
<h3 data-id="heading-11">OLTP标准基准测试</h3>
<p>基于标准测试环境的性能数据（16C32G, 16张表，每张表100万行）：</p>





















































<table><thead><tr><th>测试场景</th><th>最佳线程数</th><th>TPS</th><th>QPS</th><th>TP99延迟</th><th>平均延迟</th></tr></thead><tbody><tr><td>只读查询</td><td>64</td><td>19,484</td><td>311,745</td><td>21.50ms</td><td>3.28ms</td></tr><tr><td>只写操作</td><td>256</td><td>17,004</td><td>102,025</td><td>29.72ms</td><td>15.05ms</td></tr><tr><td>插入操作</td><td>256</td><td>25,614</td><td>25,614</td><td>15.83ms</td><td>9.99ms</td></tr><tr><td>读写混合</td><td>128</td><td>9,795</td><td>195,908</td><td>33.12ms</td><td>13.06ms</td></tr><tr><td>点查询</td><td>64</td><td>560,933</td><td>560,933</td><td>0.18ms</td><td>0.11ms</td></tr></tbody></table>
<h3 data-id="heading-12">电商场景专项性能汇总</h3>



































<table><thead><tr><th>优化模块</th><th>测试场景</th><th>性能提升幅度</th><th>关键指标</th></tr></thead><tbody><tr><td><strong>RETURNING子句</strong></td><td>固定行更新</td><td><strong>61%</strong></td><td>TPS: 925→1,490</td></tr><tr><td><strong>CCL并发控制</strong></td><td>秒杀场景</td><td><strong>133%</strong></td><td>TPS: 573→1,337</td></tr><tr><td><strong>Inventory Hint</strong></td><td>库存扣减</td><td><strong>215%</strong></td><td>TPS: 1,537→4,843</td></tr><tr><td><strong>单点查询优化</strong></td><td>主键查询</td><td><strong>28%</strong></td><td>QPS: 76,432→98,470</td></tr></tbody></table>
<h2 data-id="heading-13">5、未来规划</h2>
<p>1.<strong>持续语法扩展</strong>：基于业务需求继续扩展SQL语法功能</p>
<p>2.<strong>智能优化增强</strong>：引入机器学习优化执行计划选择</p>
<p>3.<strong>内核级技术支持</strong>：具备内核研发能力的团队，持续从最底层为业务研发提供深度优化的数据库解决方案</p>
<p>4.<strong>云原生存算分离</strong>：继续打造属于京东自己的高性能低成本数据库产品</p>
<h2 data-id="heading-14">6、结语</h2>
<p>从开源内核到自研DongSQL，京东零售数据库团队始终以"业务价值驱动技术创新"为核心理念。DongSQL作为专为京东电商场景设计的数据库，通过语法扩展、并发控制、查询优化等多个模块的深度创新，为电商业务的快速发展提供了强有力的数据库技术支撑。</p>
<p>这些优化不仅提升了系统性能，更重要的是为集团基础技术底座提供了坚实的基础。未来，京东零售数据库团队将持续深耕数据库内核技术，让数据库更好地服务业务发展。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Trae SOLO项目真实需求]]></title>    <link>https://juejin.cn/post/7572997791451611174</link>    <guid>https://juejin.cn/post/7572997791451611174</guid>    <pubDate>2025-11-17T02:42:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7572997791451611174" data-draft-id="7572115057221369891" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Trae SOLO项目真实需求"/> <meta itemprop="keywords" content="Trae,前端,前端工程化"/> <meta itemprop="datePublished" content="2025-11-17T02:42:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="草帽lufei"/> <meta itemprop="url" content="https://juejin.cn/user/501033035632093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Trae SOLO项目真实需求
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/501033035632093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    草帽lufei
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-17T02:42:42.000Z" title="Mon Nov 17 2025 02:42:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-17
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    155
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;color:#3c9dff}.markdown-body h1{font-size:30px;margin-bottom:5px;padding-bottom:8px;text-align:center}.markdown-body h2{font-size:24px;padding-bottom:6px}.markdown-body h2:before{content:"🍋"}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h3:before{content:"🍓"}.markdown-body h4{font-size:16px}.markdown-body h4:before{content:"🍑"}.markdown-body h5{font-size:15px}.markdown-body h5:before{content:"🍉"}.markdown-body h6{margin-top:5px}.markdown-body h6:before{content:"🍒"}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;margin:0 auto;max-width:100%;border-radius:4px;padding:1px;border:1px solid #d2e8ff}.markdown-body img:hover{box-shadow:0 1px 3px #5eaeff}.markdown-body hr{height:4px;margin:34px 0;background-size:4px 1px;background-image:linear-gradient(270deg,#5eaeff,#f3f9ff 25%,transparent 50%);border-style:none}.markdown-body code{word-break:break-word;border-radius:3px;overflow-x:auto;background-color:#d2e8ff;color:#3c9dff;font-size:.9em;padding:.1em .5em;margin:0 3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;transition:all .3s}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:1px solid #90c7ff;border-radius:4px}.markdown-body pre:hover{box-shadow:0 1px 10px #beddff}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#3c9dff;border-bottom:1px solid #90c7ff;transition:all .3s}.markdown-body a:hover{color:#007fff;border-bottom:2px solid #5eaeff}.markdown-body a[href]:not(:empty){padding-right:18px}.markdown-body a[href]:not(:empty):after{display:inline-block;width:16px;height:16px;margin-left:2px;content:"";background:url(data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxwYXRoIGQ9Ik0zODQgMTI4YTQ4IDQ4IDAgMDEyLjgxNiA5NS45MkwzODQgMjI0SDI1NmEzMiAzMiAwIDAwLTMxLjkyIDI5LjZMMjI0IDI1NnY1MTJhMzIgMzIgMCAwMDI5LjYgMzEuOTJsMi40LjA4aDUxMmEzMiAzMiAwIDAwMzEuOTItMjkuNmwuMDgtMi40VjY1NmE0OCA0OCAwIDAxOTUuOTItMi44MTZMODk2IDY1NnYxMTJhMTI4IDEyOCAwIDAxLTEyNCAxMjcuOTM2bC00IC4wNjRIMjU2YTEyOCAxMjggMCAwMS0xMjcuOTM2LTEyNGwtLjA2NC00VjI1NmExMjggMTI4IDAgMDExMjQtMTI3LjkzNmw0LS4wNjRoMTI4em0zODQgMGExMjggMTI4IDAgMDExMjcuOTM2IDEyNGwuMDY0IDR2MTYwYTQ4IDQ4IDAgMDEtOTUuOTIgMi44MTZMODAwIDQxNlYyOTEuODcybC0zODIuMDY0IDM4Mi4wOGE0OCA0OCAwIDAxLTcwLjAzMi02NS42bDIuMTYtMi4yODhMNzMyLjA5NiAyMjRINjA4YTQ4IDQ4IDAgMDEtMi44MTYtOTUuOTJMNjA4IDEyOGgxNjB6IiBmaWxsPSIjM2M5ZGZmIiBmaWxsLW9wYWNpdHk9Ii41NiIgZGF0YS1zcG0tYW5jaG9yLWlkPSJhMzEzeC5zZWFyY2hfaW5kZXguMC5pMC41Yzc1M2E4MTgwa2RKWCIgY2xhc3M9InNlbGVjdGVkIi8+PC9zdmc+);background-size:100%}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border-collapse:collapse;border:1px solid #3c9dff}.markdown-body thead{text-align:center}.markdown-body thead th{color:#fff;background-color:#5eaeff}.markdown-body tr{text-align:center}.markdown-body tbody tr:hover{background-color:#d2e8ff}.markdown-body tbody tr:hover code{background-color:#90c7ff}.markdown-body tr:nth-child(2n){background-color:#ecf5ff}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5eaeff}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{font-weight:900;padding:0 1px;font-size:17px}.markdown-body small{color:#cbcbcb;padding:0 1px;font-size:22px;zoom:.5}.markdown-body em{padding:0 1px}.markdown-body del{padding:0 1px;text-decoration-thickness:2px}.markdown-body blockquote{color:#1a1b1c;padding:1px 20px;margin:22px 0;border-radius:4px;border-left:4px solid rgba(60,157,255,.5);background-color:rgba(190,221,255,.3)}.markdown-body blockquote blockquote{margin:8px 0}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{margin:12px 0;padding:4px 10px;border:2px solid #3c9dff;border-radius:8px;background-color:#ecf5ff;transition:all .3s}.markdown-body details summary{cursor:pointer}.markdown-body input[type=checkbox]{position:relative;appearance:none;width:16px;height:16px;border-radius:2px;vertical-align:middle;transform:translateY(-2px);box-sizing:border-box;border:1px solid #beddff}.markdown-body input[type=checkbox]:checked{border:1px solid #5eaeff;background-color:#5eaeff}.markdown-body input[type=checkbox]:checked:before{position:absolute;top:3px;left:1px;width:11px;height:6px;background-color:transparent;border-left:2px solid #fff;border-bottom:2px solid #fff;transform:rotate(-45deg);content:"";box-sizing:border-box}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">前言</h2>
<p>看到 Trae SOLO 模式限时免费了，趁着免费，赶紧体验一波，Demo 什么的就不试了，直接用 SOLO 模式 SOLO 业务项目，开干，最终目标都是要服务于业务项目的</p>
<p>我是一吊毛前端开发，就从当前做的前端项目开用吧，接下来干的活是改大屏页，就从大屏页面开始，普通业务逻辑的话各路 AI 可能表现都还行，之前测试的是大屏这种明显靠感觉的还是差点意思，大屏页面基本主要还是手动改</p>
<h2 data-id="heading-1">使用 SOLO</h2>
<h3 data-id="heading-2">界面分析</h3>
<p>更新 Trae 后打开项目，分为4大块，从左到右分别是 SOLO模式任务，对话区，代码区，资源管理器，这点和常见的编辑器默认排版刚好相反，不过无所谓，既然这么设计，肯定是有他的道理的，因为现在模式变了，主要以对话，任务描述为主，然后再看代码</p>
<h3 data-id="heading-3">开始对话</h3>
<p>下面是我运行项目后，先在对话区先让它把一个页面的 tab 选项卡默认值改一下，它会自动检索项目代码，然后根据描述默认直接变更代码，然后最左侧任务会自动根据任务内容生成一个任务名称</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f732a2c7e03e413b9c6094df91daf255~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765161809&amp;x-signature=9jsPx1B1dQawuR3fELLnCT1rm7g%3D" alt="image.png" loading="lazy"/></p>
<p>我发现 SOLO Coder 是自动就把项目代码变更了的，这里有个选项，就是用户确认后改代码和自动直接改代码，把这个确认加上了，防止把项目给改崩了，不好还原了，之前遇到过的痛苦经历，用 Agent 改代码，结果崩了，还自动改了，但是只改了半截，还原也只能还原半截，因为涉及了好几个文件，我手动吭哧吭哧忙活半天才恢复，整的都有阴影了</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5004c1e574dd4118a65b83a9eb7097b6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765161809&amp;x-signature=ywI4rtd8wdOrl1WoUqX5z0l8u78%3D" alt="image.png" loading="lazy"/></p>
<p>第二次继续，改点数据看看，顺便调整一下布局</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df149e0d4b4e4aa39338da8b5b3e8063~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765161809&amp;x-signature=LX56MZXyMtDtuBP2uVX7fHHTfxw%3D" alt="image.png" loading="lazy"/></p>
<p>任务执行完后查看变更，点击查看变更，右侧会显示两个折叠面板，一个描述需求，一个是代码变更</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5dfea62001dd4036b56797256e6bb63c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765161809&amp;x-signature=sd1gNACz%2FDwm119mforu9oI0cQw%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d52a08d3d1941eeacf47e78be67f28a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765161809&amp;x-signature=gUoMeG5iMAJl7D1NJZqra4V0q6o%3D" alt="image.png" loading="lazy"/></p>
<p>这两个明确的小改动目前 SOLO 项目中内容改的正确，整体表现还不错，<code>手动点赞</code></p>
<h3 data-id="heading-4">上点强度</h3>
<p>接下来继续上强度试试，添加一个图表，提供了标题，X轴和Y轴数据和描述</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d1925e7b921404386ab811d7e07c298~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765161809&amp;x-signature=PcWtwvC7srKSO13lzc2LMMdlxGw%3D" alt="image.png" loading="lazy"/></p>
<p>等了一会儿，执行完了，这个应该比较简单，只是加一个图表而已，应该问题不大，看着代码页没啥大问题</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d7f594af0224aca8b0e7e26b81d7680~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765161809&amp;x-signature=ZvxkC%2FqYx7LUZC6MyRifRcompC0%3D" alt="image.png" loading="lazy"/></p>
<p>页面上效果只是一个空白，框是加了一个，但是图表没渲染出来，而且位置不对，没有在对应的内容下面生成图表，可能描述的还不够准确，位置倒还好，主要内容没出来</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2886b62385be43a292064da1762b7dae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765161809&amp;x-signature=njfvxXNr%2B6Hsawp4OJFGS4pL11c%3D" alt="image.png" loading="lazy"/></p>
<p>这里的内容是在项目弹框中，用的tab切换显示的页面，可能加载时机有问题，目前浏览器控制台无报错，先问反馈一下 SOLO，再让它分析一下</p>
<p>它根据理解又哐哐改了几行代码，说这个 <code>现在，图表会在页面渲染完成后可靠初始化，并在切换到该页签时再次初始化，确保正常显示</code>，它只负责生成代码，说的好似它亲眼见过一样</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62ab09b5ee644981a1c862b1a5cbc797~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765161809&amp;x-signature=8jPLUsdGCzd4jGlcUtBijlZjAcM%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07d8b7a804e3453490db720a73963fd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765161809&amp;x-signature=QryXwKHumfpw12k%2BsFI5clPwfjw%3D" alt="image.png" loading="lazy"/></p>
<p>浏览器控制台有警告，图表还是空框，完犊子了，这里的代码由于涉及到业务一些东西，估计它没整明白（也有可能是这个shi山项目里面的一坨一坨的代码误导的），得手动完整排查一下这部分相关代码了</p>
<h3 data-id="heading-5">恢复手动</h3>
<p>然后我把这个 Trae 关了，重新打开了一下项目</p>
<p>沃日啊，怎么切换了一下模式重启后，什么改动都没有了，就剩一个默认tab选项效果还在了</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c83c619b73fe4efc87570e1c1776559d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765161809&amp;x-signature=jFih%2B9Qpot1jG92EX4g%2FBHbWIDk%3D" alt="image.png" loading="lazy"/></p>
<p>又使用AI自动改代码翻车的节奏吗，不会又被坑一下午吧</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08627f1624e44235be9e988c97ecd064~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765161809&amp;x-signature=jf3XAl9Y68nA8MuT0ttMmZH9uPA%3D" alt="B98613A4BEA6AC9A4DA6C0A602D6C164.gif" loading="lazy"/></p>
<h3 data-id="heading-6">虚惊一场</h3>
<p>这什么鬼，我查了代码，代码更新的部分也都有啊，缓存？</p>
<p>重新 pnpm run dev ， 把原来的浏览器关掉，重新用无痕打开，又好了，果然浏览器缓存搞的鬼（松了一口气）</p>
<p>切换成编辑器模式后，手动改代码测试，Trae 中有这么个操作，自动写入，自动格式化，大概需要几十秒，这个过程有点慢，体验不是很好</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d46cb9c4f324e0081ed82bb7ab0d29f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765161809&amp;x-signature=J9uuW80dzt30%2FjqE7%2FmA9k0WgCA%3D" alt="image.png" loading="lazy"/></p>
<p>我动了点东西，又提示 正在应用代码操作 “整理导入” 自动写入，自动格式化保存，是什么鬼，我改了个索引数字，两个地方，也需要几十秒，电脑系统 Win11家庭版，内存32G，CPU i5,就启动了 Trae，其他编辑器没开，我查了任务栏 CPU，内存使用率不高，但是这个体验好差呀</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8fa2e553d5644ac85ab321e36600722~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765161809&amp;x-signature=ZeZLiS%2F4mmyoNBdssCbdWrBt8Ws%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">奇怪的自动化</h3>
<p>习惯了改点东西自动后保存后，一两秒就能在页面上效果，现在在 Trae 中自动保存，格式化完以后大约十几秒后，才能在页面上看到更新后的效果，我多次测试改几个数字或改一行代码页这样，啊...... (心态此时有点崩了)</p>
<p>难道是 Trae 中自动保存设置和一些插件一起工作不兼容的问题吗？我这边前端vue3项目，相关插件如下</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71cf68dcc5ab4b9792f375b869785bfc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765161809&amp;x-signature=M2aJSqleSD0X6LKH9SU42M5e0BE%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9aa90be335fb491993e295a2c2f420ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6I2J5bi9bHVmZWk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765161809&amp;x-signature=lcTTWk9CZwgHDgYrg18CmRZAu9Y%3D" alt="image.png" loading="lazy"/></p>
<p>由于进入手改模式后，这个自动保存格式化操作时间有点久，可能是我哪里设置问题？还是操作方式问题？插件是从 VSCode 中同步过来的，这些配置也是日常操作，出现这种明显这么久的时间延迟，还是有点奇怪的</p>
<p>@Trae 官网技术人员，有空看看，难道你们标配都是 Mac book Pro 顶配，然后流畅的不行吗</p>
<h2 data-id="heading-8">小结</h2>
<p>目前来看除了特别代码实现出来的奇葩的功能，常见的功能需求提示描述相对准确后，SOLO模式整体还是非常亮眼的，虽然中间有点小插曲，整体 Trae SOLO 模式还是非常亮眼的</p>
<p>由于自动保存格式化时间有点长，又由于后面的需求也不太好直观描述，并且代码也是特别乱，我就先不用 SOLO 模式了，先换 VSCode 把那种产品自己都讲不明白的需求改了，不然加班不知道几个小时起步了</p>
<blockquote>
<p>欢迎大家讨论交流，如果喜欢本文章或感觉文章有用，动动你那发财的小手点赞、收藏、关注再走呗 <code>^_^</code> </p>
<p>微信公众号：草帽lufei</p>
</blockquote>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e1fd6d3bc93444bbb257fc45e1826b11~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=240&amp;h=240&amp;s=10632&amp;e=jpg&amp;b=fdfafa" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[浅谈 AI 搜索前端打字机效果的实现方案演进]]></title>    <link>https://juejin.cn/post/7576955345378099263</link>    <guid>https://juejin.cn/post/7576955345378099263</guid>    <pubDate>2025-11-27T03:10:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576955345378099263" data-draft-id="7576953459543638070" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="浅谈 AI 搜索前端打字机效果的实现方案演进"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-11-27T03:10:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="vivo互联网技术"/> <meta itemprop="url" content="https://juejin.cn/user/993614243303053"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            浅谈 AI 搜索前端打字机效果的实现方案演进
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614243303053/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    vivo互联网技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-27T03:10:41.000Z" title="Thu Nov 27 2025 03:10:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>作者：vivo 互联网前端团队 - He Yanjun</p>
<p>在当代前端开发领域，打字机效果作为一种极具创造力与吸引力的交互元素，被广泛运用于各类网站和应用程序中，为用户带来独特的视觉体验和信息呈现方式，深受广大用户的喜爱。</p>
<p>本文将深入介绍在AI搜索输出响应的过程中，打字机效果是怎样逐步演进的。力求以通俗的语言和严谨的思路深入剖析打字机效果在不同阶段的关键技术难点和优劣势。</p>
</blockquote>
<p>1分钟看图掌握核心观点👇</p>
<p><img src="https://static001.geekbang.org/infoq/71/71e2717ca5faa5e464284f60854c8cf1.gif" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-0">一、前言</h2>
<p>在如今基于AI搜索的对话舞台上，如果一段文字像老式打字机一样逐字逐句展现在屏幕上，那将是一种具有独特魅力的吸引力。</p>
<p>话不多说，先来看下最终的实现效果。</p>
<p><img src="https://static001.geekbang.org/infoq/e5/e5b2872868de30c88a997b04eff96bc8.gif" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-1">二、引言</h2>
<p>在AI搜索场景中，由于大模型基于流式输出文本，需要多次响应结果到前端，因此这种场景十分适合使用打字机效果。</p>
<p>打字机效果是指在生成内容的场景中，文字逐字符动态显示，模拟人工打字的过程，主要是出于提升用户体验、优化交互逻辑和增强心理感知等方面的考量：</p>
<p><strong>缓解等待焦虑，降低“无反馈”的负面体验。</strong></p>
<p>内容是逐步响应的，打字机效果可以很好地提供“实时反馈”，用户可以感知到系统正在工作，从而减少了等待过程中的不确定性和焦虑感。</p>
<p><strong>模拟自然交互，增强“类人对话”的沉浸感。</strong></p>
<p>对话交流具有停顿、强调等节奏感，通过实时打字的模拟，跟容易拉近与用户的心理距离，增强对话感和沉浸感。</p>
<p><strong>优化信息接收效率，避免“信息过载”。</strong></p>
<p>如果一次性展示大量密密麻麻的文字，用户需要花时间筛选重点，容易产生抵触，通过打字机效果可以缓和阅读节奏，减少视觉和认知负担。</p>
<p><strong>强化“AI生成”的感知，降低对“标准答案”的预期。</strong></p>
<p>使用户感知到是AI实时计算结果，而非预存的标准答案，有助于用户理性客观地使用工具。</p>
<h2 data-id="heading-2">三、早期实现方案——纯文本逐字符打字效果</h2>
<p>最开始的产品功能，需要根据用户输入的搜索词，流式输出并逐字符展示到页面上，这可以说是打字机效果的入门级实现了，不依赖任何复杂的技术，其流程图大致如下所示。</p>
<p><img src="https://static001.geekbang.org/infoq/a6/a6ad8f272b01718ac3b077711a8ec924.png" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-3">3.1 详细说明</h3>
<p>前端会定义一个字段用来缓存全量的markdown文本，每次服务端流式响应markdown文本到前端时，前端都会将其追加到这个缓存字段后，然后基于marked依赖库将全量的markdown文本转换为html片段。</p>
<p>要实现逐字符渲染的动画效果，就需要定时更新文本。定时功能一般采用setTimeout或setInterval来实现，而更新文本可以考虑innerHTML和appendChild的方式，这里采用的innerHTML方式插入文本，核心代码如下所示。</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">fullText</span> = <span class="hljs-string">'test text'</span><span class="hljs-comment">;// 全量的html文本</span>
let <span class="hljs-attr">index</span> = <span class="hljs-number">0</span><span class="hljs-comment">;// 当前打印到的下标</span>
let <span class="hljs-attr">timer</span> = window.setInterval(() =&gt; {
  ++index<span class="hljs-comment">;</span>
  $<span class="hljs-attr">dom.innerHTML</span> = fullText.substring(<span class="hljs-number">0</span>, index)<span class="hljs-comment">;</span>
}, 40)<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-4">3.2 innerHTML与appendChild的核心区别对比</h3>
<p><img src="https://static001.geekbang.org/infoq/41/41849adf6860ac94811e495997bb6709.jpeg" alt="图片" loading="lazy"/></p>
<p><strong>为什么选择innerHTML而非appendChild？</strong></p>
<p>由于服务端是流式返回markdown文本，因此每次返回的markdown文本可能不是完整的。</p>
<p>举个例子如下。</p>
<pre><code class="hljs language-css" lang="css">先返回下面一段markdown文本

** 这是一个
再返回下面一段markdown文本

标题 **
先返回的文本会当作纯文本展示，再返回的文本会与先返回的文本结合生成<span class="hljs-selector-tag">html</span>片段如下

&lt;<span class="hljs-selector-tag">strong</span>&gt;这是一个标题&lt;/<span class="hljs-selector-tag">strong</span>&gt;
</code></pre>
<p>如果使用appendChild的话，就不好处理上述场景。</p>
<h3 data-id="heading-5">3.3 小结</h3>
<p>这种方式的优点就是简单易懂，很容易上手实现，也没有任何依赖。</p>
<p>但是，它的缺点也是显而易见的。比如，我们无法方便的添加一些额外的动画效果来增强视觉体验，如光标闪烁效果；对于一些复杂文本内容，或者需要更加灵活地控制展示细节时也会显得捉襟见肘；并且每次通过innerHTML渲染文本时，都触发了dom的销毁与创建，性能消耗大。</p>
<h2 data-id="heading-6">四、需求难度进一步提升</h2>
<p>随着产品的迭代，业务要求打字内容不仅是纯文本，还需要穿插展示卡片等复杂样式效果，如下图所示。</p>
<p>卡片的类型包括应用、股票、影视等，需要可扩展、可配置，并且还会包括复杂的交互效果，如点击、跳转等。</p>
<p><img src="https://static001.geekbang.org/infoq/fc/fc131edaf07977496b1970b79a44561c.png" alt="图片" loading="lazy"/></p>
<p>很明显，基于早期的实现方案已经远远不能满足日益增强的业务诉求了，必须考虑更加灵活高效的技术方案。</p>
<h2 data-id="heading-7">五、现代框架下的实现——基于Vue虚拟dom动态更新</h2>
<p>通过上述的分析，打字内容中要穿插展示卡片，显然需要使用单例模式，否则如果每次打字都重新创建元素的话，不仅性能低下，而且数据和状态还无法保持一致。</p>
<p>而要使用单例模式，就必须根据现有数据对已插入节点进行插入、更新、移除等操作以保持数据的一致性，这就很自然地会想到使用现代前端框架来对打字机效果进行改进。</p>
<p>Vue是基于虚拟dom的渐进式javascript框架，仅在数据变化时计算差异并更新必要的部分，因此可以借助其数据驱动开发、组件化开发等特性，轻松地构建一个可复用的打字机效果组件。</p>
<h3 data-id="heading-8">5.1 设计思路</h3>
<p>要实现打字正文中穿插卡片的效果，首先需要定义好返回的数据结构，它需要具备可扩展，方便解析，兼容markdown等特性，所以使用html标签是一种比较合适的方式，例如要展示一个应用卡片，可以下发如下所示数据。</p>
<pre><code class="hljs language-ini" lang="ini">&lt;app <span class="hljs-attr">id</span>=<span class="hljs-string">""</span> /&gt;
</code></pre>
<p>从下发的数据中可以获取到标签名和属性键值对，这样就可以通过标签名来渲染关联到的组件模板，通过属性键值对去服务端加载对应的数据，于是就可以水到渠成的把应用卡片展示出来，其流程图如下图所示。</p>
<p><img src="https://static001.geekbang.org/infoq/f7/f7f107266684e611857e0d0a51ffc1c3.png" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-9">5.2 详细说明</h3>
<p>组件模板文件按照一定规则组织在特定的目录下，在构建时打包到资源里，关键代码如下所示。</p>
<pre><code class="hljs language-ini" lang="ini">privateinit(){  
    let <span class="hljs-attr">fileList</span> = require.context(<span class="hljs-string">'@/components/common/box'</span>, <span class="hljs-literal">true</span>, /\.vue$/)<span class="hljs-comment">;  </span>
    fileList.keys().forEach((filePath) =&gt; {  
        let <span class="hljs-attr">startIndex</span> = filePath.lastIndexOf(<span class="hljs-string">'/'</span>)<span class="hljs-comment">;  </span>
        let <span class="hljs-attr">endIndex</span> = filePath.lastIndexOf(<span class="hljs-string">'.'</span>)<span class="hljs-comment">;  </span>
        let <span class="hljs-attr">tagName</span> = filePath.substring(startIndex + <span class="hljs-number">1</span>, endIndex)<span class="hljs-comment">;  </span>
        this.widgetMap<span class="hljs-section">[tagName]</span> = fileList(filePath).default<span class="hljs-comment">;  </span>
    })<span class="hljs-comment">;  </span>
}
</code></pre>
<p>之前版本在每次接收到服务端下发的markdown文本时，都会做一次转换成html的操作，如果多次响应之间的间隔时间很短，则会出现略微卡顿的现象，因此这里转换为html时再增加一个防抖功能，可以很有效的避免卡顿。</p>
<p>每次定时截取到待渲染的html文本以后，会基于ultrahtml库将其转换为dom树，并过滤掉注释、脚本等标签，核心代码如下。</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">toRenderHtml</span> = this.rawHtml.substring(<span class="hljs-number">0</span>, this.curIndex)<span class="hljs-comment">;  </span>
let <span class="hljs-attr">dom</span> = {  
    type: ELEMENT_NODE,  
    name: 'p',  
    children: parse(toRenderHtml).children  
}<span class="hljs-comment">;</span>
</code></pre>
<p>最后就是全局注册一个递归组件用来渲染转换后的dom树，核心代码如下。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">render(h: any) {  
    <span class="hljs-comment">// 此处省略若干代码</span>

    <span class="hljs-comment">// 处理子节点</span>
    let children = <span class="hljs-keyword">this</span>.dom[<span class="hljs-string">'children'</span>] || [];  
    let renderChildren = children.map((child: any, index: number) =&gt; { 
        <span class="hljs-keyword">return</span> h(CommonDisplay, {  
            props: {  
                dom: child,  
                displayCursor: <span class="hljs-keyword">this</span>.displayCursor,  
                lastLine: <span class="hljs-keyword">this</span>.lastLine &amp;&amp; index === children.length - <span class="hljs-number">1</span>,  
                ignoreBoxTag: <span class="hljs-keyword">this</span>.ignoreBoxTag  
            }  
        });  
    });
  
    <span class="hljs-comment">// 此处省略若干代码</span>

    <span class="hljs-comment">// 处理文本节点</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.dom[<span class="hljs-string">'type'</span>] === TEXT_NODE) {  
        returnthis.renderTextNode({h, element: <span class="hljs-keyword">this</span>.dom});  
    }

    <span class="hljs-comment">// 处理自定义组件标签</span>
    let tagName = <span class="hljs-keyword">this</span>.dom[<span class="hljs-string">'type'</span>] === ELEMENT_NODE ? <span class="hljs-keyword">this</span>.dom[<span class="hljs-string">'name'</span>] : <span class="hljs-string">'div'</span>;  
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.$factory.hasTag(tagName)) {  
        <span class="hljs-comment">// 此处省略若干代码</span>
        let widget = <span class="hljs-keyword">this</span>.$factory.getWidget(tagName);
        <span class="hljs-keyword">return</span> h(widget, {  
            key: tagId,  
            props: {  
                displayCursor: <span class="hljs-keyword">this</span>.displayCursor,  
                lastLine: <span class="hljs-keyword">this</span>.lastLine,  
                text,  
                ...attributes  
            }  
        }, isLastLeaf &amp;&amp; <span class="hljs-keyword">this</span>.displayCursor ? [h(commonCursor)] : []);
    }

    <span class="hljs-comment">// 处理html原始标签</span>
    <span class="hljs-keyword">return</span> h(tagName, {  
        attrs: {  
            displayCursor: <span class="hljs-keyword">this</span>.displayCursor,  
            lastLine: <span class="hljs-keyword">this</span>.lastLine,  
            ...<span class="hljs-keyword">this</span>.dom[<span class="hljs-string">'attributes'</span>]  
        }  
    }, renderChildren);  
}
</code></pre>
<h3 data-id="heading-10">5.3 问题整理和解决</h3>
<p>打字机功能终于正常运行了，流畅度还是不错的，但是在体验的过程中，也发现了一些<strong>细节问题</strong>。</p>
<p><strong>①打字文本中如果存在标签，如 </strong></p><p><strong>xxx</strong></p><strong> ，会出现先展示 &lt; ,再展示 &lt;p ，最后展示空的效果，也就是字符回退，极大影响阅读体验。</strong><p/>
<p><strong>原因分析</strong></p>
<p>定时截取待渲染文本时是通过定义一个下标递增逐字符截取的，这就导致标签并没有作为一个原子结构被整体截取，于是就出现了字符回退的现象。</p>
<p><strong>解决方案</strong></p>
<p>当下标指向的字符为 &lt; 时，则往后截取到 &gt; 的位置，核心代码如下。</p>
<pre><code class="hljs language-ini" lang="ini">if (<span class="hljs-attr">curChar</span> === <span class="hljs-string">'&lt;'</span>) {  
    let <span class="hljs-attr">lastGtIndex</span> = this.rawHtml.indexOf(<span class="hljs-string">'&gt;'</span>, this.curIndex)<span class="hljs-comment">;</span>
    if (lastGtIndex &gt; -1) {
        <span class="hljs-attr">this.curIndex</span> = lastGtIndex + <span class="hljs-number">1</span><span class="hljs-comment">;</span>
        returnfalse<span class="hljs-comment">;</span>
    }
}
</code></pre>
<p><strong>② 打字文本中如果存在转义字符，如 " ，则会依次出现这些字符，最后再展示 " ，也就是字符闪烁，也十分影响阅读体验。</strong></p>
<p><strong>原因分析</strong></p>
<p>原因同上述字符回退一样，也是没有把转义字符当作一个整体截取。</p>
<p><strong>解决方案</strong></p>
<p>当下标指向的字符为 &amp; 时，则往后截取到转义字符结束的位置，核心代码如下。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 大模型大概率只下发有限类别的转义字符，做成配置动态下发，不仅解析方便，定制下发也很及时  </span>
<span class="hljs-keyword">if</span> (curChar === <span class="hljs-string">'&amp;'</span>) {  
    let matchEscape = <span class="hljs-keyword">this</span>.config[<span class="hljs-string">'writer'</span>][<span class="hljs-string">'escapeArr'</span>].find((item: any) =&gt; {  
        returnthis.rawHtml.indexOf(item, <span class="hljs-keyword">this</span>.curIndex) === <span class="hljs-keyword">this</span>.curIndex;  
    });  
    <span class="hljs-keyword">if</span> (matchEscape) {  
        <span class="hljs-keyword">this</span>.curIndex += matchEscape.length;  
        returnfalse;  
    }  
}
</code></pre>
<p><strong>③ 打字过程中的速度是固定的，缺少一点抑扬顿挫的节奏感，不够自然。</strong></p>
<p><strong>原因分析</strong></p>
<p>定时器的间隔时间是固定的一个数值，所以表现为一个固定不变的打字节奏。</p>
<p><strong>解决方案</strong></p>
<p>可以根据未打印字符数来动态调整每次打字的速度，一种可选的实现方案如下。</p>
<p>假设未打印字符数为 N ，速度平滑指数为 a ，实际打字速度为 Vcurrent ，逻辑应达到的打字速度为 Vnew 。</p>
<p>if N &lt;= 10 , Vnew = 100 ms / 1字符</p>
<p>if 10 &lt; N &lt;= 20 , Vnew = 100 - 8 * ( N - 10 ) ms / 1字符</p>
<p>if 20 &lt; N , Vnew = 20 ms / 4字符</p>
<p>Vcurrent = a * Vcurrent + ( 1 - a ) * Vnew</p>
<p>上述策略可能会比较多，而且上线以后还有可能更换数值对照效果，因此为了支持配置化，我们可以对Vnew进行表达式归纳，如下所示。</p>
<p>Vnew = Vinit - w * ( N - min ) + b</p>
<p>Vinit 为默认初始打字速度，w 为每条策略的权重值，N 为未打印字符数，min 为每条策略的最小字符数量比较值，b 为每条策略的偏置。关键代码如下所示。</p>
<pre><code class="hljs language-css" lang="css">privatespeedFn({curSpeed, curIndex, totalLength}: any){  
    let leftCharLength = Math<span class="hljs-selector-class">.max</span>(<span class="hljs-number">0</span>, totalLength - curIndex);  
    let matchStrategy = this<span class="hljs-selector-class">.config</span><span class="hljs-selector-attr">[<span class="hljs-string">'writer'</span>]</span><span class="hljs-selector-attr">[<span class="hljs-string">'strategy'</span>]</span><span class="hljs-selector-class">.find</span>((item: any) =&gt; {  
        return (!item<span class="hljs-selector-attr">[<span class="hljs-string">'min'</span>]</span> || item<span class="hljs-selector-attr">[<span class="hljs-string">'min'</span>]</span> &lt; leftCharLength)  
            &amp;&amp; (!item<span class="hljs-selector-attr">[<span class="hljs-string">'max'</span>]</span> || item<span class="hljs-selector-attr">[<span class="hljs-string">'max'</span>]</span> &gt;= leftCharLength);  
    });  
    let speed = this<span class="hljs-selector-class">.config</span><span class="hljs-selector-attr">[<span class="hljs-string">'writer'</span>]</span><span class="hljs-selector-attr">[<span class="hljs-string">'initSpeed'</span>]</span> - matchStrategy<span class="hljs-selector-attr">[<span class="hljs-string">'w'</span>]</span> * (leftCharLength - (matchStrategy<span class="hljs-selector-attr">[<span class="hljs-string">'min'</span>]</span> || <span class="hljs-number">0</span>)) + matchStrategy<span class="hljs-selector-attr">[<span class="hljs-string">'b'</span>]</span>;  
    returnthis<span class="hljs-selector-class">.config</span><span class="hljs-selector-attr">[<span class="hljs-string">'writer'</span>]</span><span class="hljs-selector-attr">[<span class="hljs-string">'smoothParam'</span>]</span> * curSpeed + (<span class="hljs-number">1</span> - this<span class="hljs-selector-class">.config</span><span class="hljs-selector-attr">[<span class="hljs-string">'writer'</span>]</span><span class="hljs-selector-attr">[<span class="hljs-string">'smoothParam'</span>]</span>) * speed;  
}
</code></pre>
<p><strong>④ 打字过程中，会时不时的回退到之前字符的位置重新开始打字，例如当前展示 a = b + c ，等到下一次渲染时会从 a 开始重新打完这一段。</strong></p>
<p><strong>原因分析</strong></p>
<p>由于markdown文本结合会生成html标签，从而导致字符数量增多，那么当前下标指向的字符就相对之前落后了。</p>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">curIndex</span> = <span class="hljs-number">5</span><span class="hljs-comment">;// 当前下标</span>
let <span class="hljs-attr">prevMarkdown</span> = <span class="hljs-string">'**hello'</span><span class="hljs-comment">;// 上一次打印时的全量markdown文本</span>
let <span class="hljs-attr">prevHtml</span> = <span class="hljs-string">'&lt;p&gt;**hello&lt;/p&gt;'</span><span class="hljs-comment">;// 上一次打印时的全量html片段</span>
let <span class="hljs-attr">prevRenderHtml</span> = <span class="hljs-string">'&lt;p&gt;**&lt;p&gt;'</span><span class="hljs-comment">;// 上一次打印到页面上的html片段</span>
// 页面上会渲染 **

// 当服务端继续下发了 ** 的markdown文本时，curIndex会递增1变为6
let <span class="hljs-attr">curMarkdown</span> = <span class="hljs-string">'**hello**'</span><span class="hljs-comment">;// 当前打印时的全量markdown文本</span>
let <span class="hljs-attr">curHtml</span> = <span class="hljs-string">'&lt;p&gt;&lt;strong&gt;hello&lt;/strong&gt;&lt;/p&gt;'</span><span class="hljs-comment">;// 当前打印时的全量html片段</span>
let <span class="hljs-attr">curRenderHtml</span> = <span class="hljs-string">'&lt;p&gt;&lt;strong&gt;&lt;/strong&gt;&lt;p&gt;'</span><span class="hljs-comment">;// 当前打印到页面上的html片段</span>
// 页面上会渲染空标签，然后重新开始打字，尤其是在数学公式场景中非常容易复现
</code></pre>
<p><strong>解决方案</strong></p>
<p>解决这个问题，需要分两步走。</p>
<p>首先需要判断打印到页面上的html片段是否有变化，因为只有变化时才会出现这种情况，而判断是否有变化只需要记录一下上一次的html片段和这一次的html片段是否不同即可，比较好处理。</p>
<p>其次就是需要重新定位下标到上一次打印到的位置，这里相对比较难处理，因为html的结构和内容都在变化，很难准确的定位到下标应该移动到什么位置。虽然我们不能准确定位，但是只要能够使当前打印到页面上的字符比上一次的字符多，就可以满足诉求了。于是我想到了textContent这个属性，它可以获取当前节点及其后代的所有文本内容。那么问题就转化为：找到一个下标，使得当前截取的html片段的textContent长度要比上一次的textContent长度大。</p>
<p>综上所述，可以得到核心代码如下所示。</p>
<pre><code class="hljs language-ini" lang="ini">if (this.isHtmlChanged()) {  
    let domRange: <span class="hljs-attr">any</span> = document.createRange()<span class="hljs-comment">;  </span>
    let <span class="hljs-attr">prevFrag</span> = domRange.createContextualFragment(this.prevRenderHtml)<span class="hljs-comment">;  </span>
    let <span class="hljs-attr">prevTextContent</span> = prevFrag.textContent<span class="hljs-comment">;  </span>
    let <span class="hljs-attr">diffNum</span> = <span class="hljs-number">1</span><span class="hljs-comment">;  </span>
    do {  
        this.curIndex += diffNum<span class="hljs-comment">;  </span>
        let <span class="hljs-attr">curHtml</span> = this.rawHtml.substring(<span class="hljs-number">0</span>, this.curIndex)<span class="hljs-comment">;  </span>
        let <span class="hljs-attr">curFrag</span> = domRange.createContextualFragment(curHtml)<span class="hljs-comment">;  </span>
        let <span class="hljs-attr">curTextContent</span> = curFrag.textContent<span class="hljs-comment">;  </span>
        <span class="hljs-attr">diffNum</span> = prevTextContent.length - curTextContent.length<span class="hljs-comment">;  </span>
        if (diffNum &lt;= 0) {  
            break<span class="hljs-comment">;  </span>
        }  
    } while (this.curIndex &lt; this.rawHtml.length)<span class="hljs-comment">;  </span>
}
</code></pre>
<h3 data-id="heading-11">5.4 小结</h3>
<p>通过现代前端框架构建打字机组件，不仅减少了不必要的渲染和性能消耗，而且还能高效灵活的穿插各种酷炫的样式效果，实现更多复杂的产品功能。</p>
<h2 data-id="heading-12">六、未来展望</h2>
<p>本文详细介绍了AI搜索中前端打字机效果的实现方案演进过程，从最初的纯文本逐字符打字效果，到借助现代前端框架实现灵活可复用的打字机组件，每一个技术难点的技术突破无不体现了前端技术的持续进步和产品不断追求卓越的态度。同时我也希望本文可以抛砖引玉，为读者打开思路，提供借鉴。</p>
<p>随着人工智能和前端技术的不断发展和创新生态的日益完善，未来一定会不断涌现大量的新技术和新理念。我相信只要时刻保持积极学习和不断尝试的探索精神，就能开拓出更多精彩创新的实现方案和应用场景。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[奥特曼怕了！GPT-5.5「大蒜」决战谷歌，红色警报紧急拉响]]></title>    <link>https://juejin.cn/post/7579440586694017070</link>    <guid>https://juejin.cn/post/7579440586694017070</guid>    <pubDate>2025-12-03T09:50:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579440586694017070" data-draft-id="7579410911057854490" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="奥特曼怕了！GPT-5.5「大蒜」决战谷歌，红色警报紧急拉响"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-12-03T09:50:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新智元"/> <meta itemprop="url" content="https://juejin.cn/user/952600743642312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            奥特曼怕了！GPT-5.5「大蒜」决战谷歌，红色警报紧急拉响
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/952600743642312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新智元
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T09:50:07.000Z" title="Wed Dec 03 2025 09:50:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9d38f7065b748a891c36a0bc56eeae0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765360206&amp;x-signature=b7JlnF79na6NdkdQn3GBdsEZp0M%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-0"><strong>「【新智元导读】三年河东三年河西，曾经逼疯谷歌的奥特曼，如今也被谷歌逼得拉响了「红色警报」，AI 王座之下已是刀光剑影。更劲爆的是，最强「Garlic」在预训练取得重大突破，正面硬刚 Gemini 3.」</strong></h5>
<p>三年前，ChatGPT 横空出世。</p>
<p>第一次感受到透骨恐惧的谷歌，仓促拉响了「红色警报」。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/29da3598447b43fbbbd262f8c65665a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765360206&amp;x-signature=q9LGc7%2BMj8OflIN7v1Nnl1w6gcg%3D" alt="" loading="lazy"/></p>
<p>但谁能想到，仅仅三年，这个「红色警报」竟在 OpenAI 自己家里炸响！</p>
<p>CEO 奥特曼紧急发布全员信，字里行间只有一句：</p>
<p>ChatGPT，危在旦夕。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af3a98cdacdc4b6ca834064513d2fd9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765360206&amp;x-signature=XqBNEVNF7VSAmsKTYVArve6zNXE%3D" alt="" loading="lazy"/></p>
<p>奥特曼：We are at a critical time for ChatGPT</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39e5bbd52ffc4bb4b2dd06b5486ba907~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765360206&amp;x-signature=kQnc093pzZHdnRukkHR8O2kYBs4%3D" alt="" loading="lazy"/></p>
<p><strong>「代号 Garlic」</strong></p>
<p><strong>「OpenAI 神秘模型曝光」</strong></p>
<p>这一次，轮到 OpenAI 了。</p>
<p>据奥特曼透露，下周，OpenAI 计划发布一款全新的推理模型。</p>
<p>内部评估显示，这个模型在性能上要比 Gemini 3 更强，但在改善 ChatGPT 的「体验」方面还有更多工作要做。</p>
<p>不仅如此，Inforamtion 最新爆料称，OpenAI 还在研发新一代模型，内部代号「Garlic」（大蒜）。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/920a70185fc041c1b62015d873782370~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765360206&amp;x-signature=t%2FriiehDSCBP4dCKAGXrZFFmAg0%3D" alt="" loading="lazy"/></p>
<p>「Garlic」在预训练方面，实现了重大突破。</p>
<p>它修复了 GPT-4.5 早期结构中的问题，预计明年初作为 GPT-5.2/GPT-5.5 发布。</p>
<p>至少在内部公测中，「Garlic」在编码和推理任务上，比谷歌 Gemini 3、Claude 4.5 Opus 更胜一筹。</p>
<p>上一周，首席研究官 Mark Chen 向内部团队做了闭门分享，核心就一句话：「Garlic」准备好了！</p>
<p>昨天一次访谈上，Mark Chen 公开回应，Gemini 3 是一款强大模型，但 OpenAI 已有与之实力相抗的模型。</p>
<p>由此来看，OpenAI 早已悄悄把下一张王牌攥在了手里。</p>
<p>Mark Chen 在内部的原话是：</p>
<p>我们打算尽快发布 Garlic 的某个版本。以目前的进度，明年初就能看到 GPT-5.2 或 GPT-5.5 发布，大家也不必感到惊讶。</p>
<p>此前，不仅 Information，还有 SemiAnalysis 多家外媒爆出，自 GPT-4o 之后，OpenAI 尚未完成下一代前沿大模型的预训练上。</p>
<p>因为这些挑战，OpenAI 才不得已将重心转向了——推理模型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b192aee20f9e44bcb00cf8d63ee7afbf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765360206&amp;x-signature=y5MuIyQugYkf4a2cdW2vdNkqGIA%3D" alt="" loading="lazy"/></p>
<p>10 月，奥特曼曾向全员保证，OpenAI 将发布代号为「Shallotpeat」的新大语言模型，来应战谷歌 Gemini 3。</p>
<p>显然，「Garlic」和「Shallotpeat」是两款不同的模型。</p>
<p>前者整合了在开发「Shallotpeat」期间修复的 Bug，最关键的突破发生在「预训练阶段」。</p>
<p>众所周知，谷歌在 Gemini 3 上最大的底气，就是在预训练阶段实现了「质的飞跃」。</p>
<p>就连 OpenAI 高层，也在私下承认了这一点。</p>
<p>不过，在「Garlic」开发过程中，OpenAI 解决了此前预训练环节遇到的一些关键问题——</p>
<p>改进之前「最好的」且「体量大得多」的预训练模型。</p>
<p>也就是，今年 2 月发布后，便如昙花一现、如今已没什么存在感的 GPT-4.5。</p>
<p>本质上，这些优化可以让 OpenAI 将同样海量的知识注入到一个更小的模型中。而以前，只能通过开发巨量模型，来实现。</p>
<p>不用说，开发大模型肯定比开发小模型更烧钱、更耗时！</p>
<p>Mark Chen 还透露一个更炸裂的消息：</p>
<p>凭借着「Garlic」的经验积累，OpenAI 已悄然启动下一代更大、更强的模型了。</p>
<p>这两周，AI 圈的风向都吹向了谷歌，OpenAI 罕见地陷入了被动「追赶着」的角色。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f0b5501d8574d64a514d3f28ddd65cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765360206&amp;x-signature=RJUMvUtBUEe4fkRWPeCiXKpJiZ0%3D" alt="" loading="lazy"/></p>
<p>Gemini 3 发布两周后，ChatGPT 日活跃用户下降了 6%</p>
<p>在扳回一局之前，OpenAI 必须拉响「红色警报」！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6285a9ccf1554bcbb0f7e86d5c79835a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765360206&amp;x-signature=RTPoiSjtG2vueQkU4rhqALAVCLc%3D" alt="" loading="lazy"/></p>
<p><strong>「「Code Red」」</strong></p>
<p><strong>「生死存亡保卫战打响」</strong></p>
<p>几周前，为了改进 ChatGPT，OpenAI 曾宣布进入了「橙色警报」状态。</p>
<p>如今的如今，一切更加紧迫了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71e402c6ca834626855245b77ab62ae7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765360206&amp;x-signature=QLVmh6IH0phTdEW67kRKzngShs8%3D" alt="" loading="lazy"/></p>
<p>随着 Code Red 的发布，<strong>「那些曾经排期在前的项目都被推迟了。」</strong></p>
<ul>
<li><strong>「广告业务」</strong>：本来想开始通过搜索赚钱的，先放放。</li>
<li><strong>「AI」</strong> <strong>「智能体」</strong>：那种能帮你自动买票、挂号的全能助手，先等等。</li>
<li><strong>「Pulse」</strong>：本来打算每天早上给你发个性化新闻早报的产品，也砍掉了。</li>
</ul>
<p><strong>「目的很简单。」</strong></p>
<p><strong>「就是用手头上所有的算力、人力和财力，去****服务一件事：」</strong></p>
<p>让现在的 ChatGPT 变得更好。</p>
<p><strong>「<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f19b44da3c2424e89343dc5297ccad5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765360206&amp;x-signature=6ysCdVCC2GhB%2F6LcSyMTkomKIIY%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「「护城河」正在变浅」</strong></p>
<p>为什么要如此大动干戈？</p>
<p>因为 OpenAI 发现，原本看起来不可逾越的领先优势，正在被对手一点点蚕食。</p>
<p><strong>「1. 增长似乎没以前那么猛了：」</strong></p>
<p>CFO 在与投资人的电话会议中暗示：ChatGPT 的某些增长指标在放缓——可能是用户数、使用时长、订阅数，等等。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0e23cfc86744b9882a7b5102ad42f9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765360206&amp;x-signature=sy8Hgsn1j1sQVVwp%2B5UH4qmO%2Fo8%3D" alt="" loading="lazy"/></p>
<p><strong>「2. 谷歌的反击，越来越有威胁」****：</strong></p>
<p>强大的新一代模型吸引力十足，不管是用户还是开发者，都不再只盯着 OpenAI 一家。</p>
<p>在搜索中加入的「AI 模式」，让搜索这件事变成了像是和「AI 聊天」一样。</p>
<p>种种因素叠加之后，Gemini 的月活用户也从 7 月的 4.5 亿，飙升到了 10 月的 6.5 亿。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6799f0b58ffb48d484f2d5cb731729f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765360206&amp;x-signature=whF8SpCiXmOEDPoO6tXd%2Bei6tL8%3D" alt="" loading="lazy"/></p>
<p>奥特曼发内部信，警告道：谷歌在 AI 领域的卷土重来，可能会给 OpenAI 带来「暂时性的经济逆风」</p>
<p><strong>「3. 要烧的钱，实在太多了：」</strong></p>
<p>未来几年，为了训练更强模型 + 支撑 ChatGPT 跑起来，OpenAI 要烧掉数百亿美元。</p>
<p>反过来，ChatGPT 订阅带来的收入预期是：今年约 100 亿美元，明年 200 亿，2027 年 350 亿。</p>
<p>因此，为了给这场「烧钱长跑」续命，OpenAI 希望能够再融差不多 1000 亿美元。</p>
<p>但成功与否，就得看 ChatGPT 的表现如何了。</p>
<p>总结来说，在这样的背景下，<strong>「任何增长放缓、用户流失，都会被放大成「生死问题」」</strong>。</p>
<ol>
<li>用户量追逐战</li>
</ol>
<ul>
<li>OpenAI 表示，ChatGPT 目前承担了全球 70% 的「AI 助手活动」和 10% 的「搜索活动」。</li>
<li>谷歌则展示 Gemini 的快速增长，把它深度整合到自家搜索和产品矩阵里。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9d798e180bd44a5af4c25d4fbc59e40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765360206&amp;x-signature=z9CQnnJQKLVqWt4O%2FG4PT4BkNt4%3D" alt="" loading="lazy"/></p>
<ol start="2">
<li>生态 vs. 爆款</li>
</ol>
<ul>
<li>OpenAI 目前的王牌是：一个极强、极出圈的 ChatGPT + 一套开发者 API。</li>
<li>谷歌拿出的则是：搜索 + 邮箱 + 文档 + 安卓 + 浏览器 + YouTube+…+Gemini，整个生态通通 AI 化。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7ede0fbea7a4a3eb4be3406e7ec5281~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765360206&amp;x-signature=4hAwR3E2zUuQ9yjtbyv39GkX%2Bt8%3D" alt="" loading="lazy"/></p>
<p><strong>「OpenAI 打算把资源砸在哪里？」</strong></p>
<p>在备忘录里，奥特曼重点点了几条「优先级拉满」的方向：</p>
<p><strong>「<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f3d08e5fcde425cbc45645bb2cad11a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765360206&amp;x-signature=nQW5uK2d%2BQo2OpaQgmgJAOKI6r8%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「让每个人都能定制自己的 AI」</strong></p>
<p>他说要**「让每周 8 亿次使用背后的人，感觉这就是****「<strong>「</strong>「我的 ChatGPT」<strong>」</strong>」」**，而不是千篇一律的大众工具：</p>
<ul>
<li>允许用户定制：它的说话风格、偏好、工作流方式，甚至记住你是谁、你怎么做事。</li>
<li>这和此前提到的「Memory」（记忆功能）一脉相承——AI 不只是回答问题，而是长期「认识你」。</li>
</ul>
<p>现在的 ChatGPT，像一个每次见面都要重新自我介绍的前台。</p>
<p>而未来它更像一个长期跟你搭档的助理：记得你做什么工种、你家有几个孩子、你写代码用什么风格、你讨厌什么语气。</p>
<p>这件事，对**「提高用户黏性」**非常关键——</p>
<p>当一个工具开始「懂你」，你就不太想频繁换平台了。</p>
<p><strong>「<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7be84617ae14ca89360d57a315be09e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765360206&amp;x-signature=gxL3dUZ0U6K14Xqhec3nIw%2F8c9Y%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「图像生成是第二战场」</strong></p>
<p>图像生成之所以重要，是因为：</p>
<ul>
<li>很多人可能不会长期用 ChatGPT 写长文，但会**「经常来生图」**；</li>
<li>这是和**「创作者、设计师、普通用户」<strong>联结的</strong>「关键」**入口；</li>
<li>图像生成模型，也可以反哺很多**「产品场景」**（广告设计、电商展示、游戏概念图等）。</li>
</ul>
<p>最近这段时间，谷歌便是凭借着 Nano Banana 和 Nano Banana Pro 断崖式的领先优势，连续数月称霸全球 AI 圈的热门话题。</p>
<p>所以也不难理解，为何奥特曼会把图像生成能力列为 Code Red 的重点之一了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89eb88ca2ceb4e6dab2bee244cea0341~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765360206&amp;x-signature=sBjmTRpjalKSJmUn%2FppMjcvrnFo%3D" alt="" loading="lazy"/></p>
<p><strong>「<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2cc07fa3b3e845e59c0f90136caa5319~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765360206&amp;x-signature=rgahpPUABX9F2GFZcODDYWO8rmk%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「赢下各种公开排行榜的心智战」</strong></p>
<p>「模型行为」包括几件事：</p>
<ul>
<li>回答是否**「准确、有用、少胡说八道」**；</li>
<li>是否<strong>语气舒服，不阴阳怪气、****「有人味」</strong>；</li>
<li>是否**「刚刚好拿捏」**安全与开放之间的尺度。</li>
</ul>
<p>而奥特曼想要的，是大幅改善这些「行为」，从而让用户在 LMArena 这类公开排名里，更愿意选 ChatGPT 背后的模型，而不是竞品。</p>
<p>因为，这类榜单对**「开发者和重度用户」**影响很大，会影响他们选哪个模型来构建自己的应用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42de62cb8e7b4a23bbebf081d8d04b85~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765360206&amp;x-signature=vYhQ3ckNYMPsnQS6UaC2YOr13Xs%3D" alt="" loading="lazy"/></p>
<p><strong>「<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fddb852bd223473890aade45da8ad3ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765360206&amp;x-signature=G236tf3SjYmJvt8AC7uwZRyeB6s%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「速度、可靠性和拒绝机制」</strong></p>
<p>此外，奥特曼还点名了三个优化方向：</p>
<ul>
<li>回答**「速度」**更快</li>
<li><strong>「可靠性更高」</strong></li>
<li><strong>「</strong>「<strong>「过度拒绝」</strong>」<strong>」****「更少」</strong></li>
</ul>
<p>速度方面，不仅用户十分敏感，对于开发者来说更是如此——延迟太高，整个产品的体验就会直接崩盘。</p>
<p>与此同时，「过度拒绝」也是一个非常典型的使用痛点：你明明问的是正常问题，结果 AI 被风控吓到，动不动就说「对不起，我无法回答这个问题」。</p>
<p>接下来他们要做的是：<strong>「在安全红线内，尽量减少误伤正常需求。」</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9532252387824d8c8d8eba8ed0e1f891~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765360206&amp;x-signature=MMYbCORDRO965niMuJUMEhaHyjo%3D" alt="" loading="lazy"/></p>
<p><strong>「这意味着什么？」</strong></p>
<p>对于普通用户来说，他们在一个平台上投入的「时间 + 习惯」，会形成更强的锁定。</p>
<p><strong>「未来的 ChatGPT，会越来越像」****「</strong>「<strong>「私人」</strong> <strong>「AI」</strong> <strong>「助理」</strong>」<strong>」</strong>「<strong>「，而不是公共问答机」</strong>」**。**它会更了解你的偏好、更会「记事」、更像一个长久陪伴的工具。</p>
<p><strong>「体验方面，也会更快、更稳定，以及</strong>「<strong>「更」</strong>」<strong>少无故被拒」****。</strong></p>
<p>如果能让用户使用起来更顺手，那么就有机会增加他们对 AI 的依赖度。也就是，从「偶尔玩玩」变成「每天离不开」。</p>
<p>**「图像、创意、多模态，会越来越重要」****。**不只是「问答和写作」，而是贯穿「写文 + 画图 + 做设计 + 查资料」的全套流程。</p>
<p>对于行业来说，<strong>「短期内」****「</strong>「<strong>「卷体验」</strong>」<strong>」</strong>「<strong>「会比」</strong>」<strong>「</strong>「<strong>「卷参数量」</strong>」<strong>」</strong>「<strong>「更重要」</strong>」<strong>。</strong></p>
<p><strong>「模型参数一再升级，普通用户已经分不清「1 万亿参数」和「2 万亿参数」的区别了。但是谁打开更快、谁更稳定、谁更懂自己，用户一用就知道。」</strong></p>
<p><strong>「对于」</strong> <strong>「OpenAI」</strong> <strong>「来说，这是一次」****「</strong>「<strong>「不一定」</strong>」<strong>决定生死</strong>**、但估值意义极大****」<strong>「</strong>「的争夺战」<strong>」</strong>。**</p>
<p>1000 亿美元的融资目标、数百亿美元的算力投入，都需要一个强而稳定的现金牛做支撑。</p>
<p>而 ChatGPT 就是这头牛：不仅要有流量，还要有粘性和付费意愿。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/491a697e71514f92b17bf03f4d56a220~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765360206&amp;x-signature=KD%2F%2Fa8IEkgsj76abVrFJFm7Hi%2BM%3D" alt="" loading="lazy"/></p>
<p><strong>开发者和创业者，****「则要开始考虑站队哪个「</strong>「<strong>「生态大本营」</strong>」<strong>」：」</strong></p>
<ul>
<li>如果 ChatGPT 的体验和口碑继续领先，它会成为大家默认接入的「AI 水电站」；</li>
<li>谷歌等如果在某些场景做得更顺滑，势必分走一部分新应用。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89a2e07dfb1248f9a04550a9b8df6070~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765360206&amp;x-signature=ChKKg3dEwvVIU90kL9dce2YgvXM%3D" alt="" loading="lazy"/></p>
<p><strong>「一场没有终点的军备竞赛」</strong></p>
<p><strong>「总结起来就一句：AI 赛道，</strong>「没有永恒的王座。」<strong>」</strong></p>
<p>仅仅三年前，ChatGPT 还是那个把谷歌吓出一身冷汗的「屠龙少年」，如今却在疲于应对来自搜索帝国的凛冽反杀。</p>
<p>不过，这恰恰是普通用户的「时代红利」——他们卷得越凶，我们用得越爽。</p>
<p>千帆过尽，极致的产品体验，才是亘古不变的硬道理。</p>
<p>参考资料：HJY</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.theinformation.com%2Farticles%2Fopenai-ceo-declares-code-red-combat-threats-chatgpt-delays-ads-effort%3Frc%3Depv9gi" target="_blank" title="https://www.theinformation.com/articles/openai-ceo-declares-code-red-combat-threats-chatgpt-delays-ads-effort?rc=epv9gi" ref="nofollow noopener noreferrer">www.theinformation.com/articles/op…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android Gradle 学习 - Kts Gradle学习]]></title>    <link>https://juejin.cn/post/7579298511072346112</link>    <guid>https://juejin.cn/post/7579298511072346112</guid>    <pubDate>2025-12-03T09:57:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579298511072346112" data-draft-id="7578820431039561768" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android Gradle 学习 - Kts Gradle学习"/> <meta itemprop="keywords" content="前端,gradle"/> <meta itemprop="datePublished" content="2025-12-03T09:57:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="明川"/> <meta itemprop="url" content="https://juejin.cn/user/114004941350269"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android Gradle 学习 - Kts Gradle学习
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/114004941350269/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    明川
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T09:57:32.000Z" title="Wed Dec 03 2025 09:57:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>  25年主要工作是新App的开发和抽离，期间对Asm和Plugin方面工作较多，理所当然的需要和Gradle打交道，由于项目中使用的Gradle版本较低，且为Groovy版本，所以对Groovy7.0和Kts版本是如何使用的，之前看过但是没有实践过，所以就有了本篇记录文章，算是对25年上半年部分学习知识的总结。 ps：AI当道，虽然很多问题和疑惑直接让Cursor来实现就好了，但是该有的知识库积累还是要做的，好记性不如烂笔头。</p>
<h2 data-id="heading-1">Gradle简要介绍</h2>
<p>注释：下边以Gradle kts 为例
简单展示下一般工程的项目结构图</p>
<pre><code class="hljs language-bash" lang="bash">MyAndroidApp/
├── gradle/
│   ├── wrapper/
│   │   ├── gradle-wrapper.jar          <span class="hljs-comment"># 主要是Gradle的运行逻辑，包含下载Gradle</span>
│   │   └── gradle-wrapper.properties   <span class="hljs-comment"># Wrapper 配置，定义了Gradle版本</span>
│   └── libs.versions.toml              <span class="hljs-comment"># 版本目录（Gradle 7.0+）</span>
│
├── app/                                <span class="hljs-comment"># 应用模块</span>
│   ├── build.gradle.kts                <span class="hljs-comment"># 模块构建脚本</span>
│   ├── proguard-rules.pro              <span class="hljs-comment"># ProGuard 规则</span>
│   └── src/                            <span class="hljs-comment"># 源代码</span>
│
├── ktslibrary/                         <span class="hljs-comment"># 库模块（可选）</span>
│   ├── build.gradle.kts
│   └── src/
│
├── buildSrc/                           <span class="hljs-comment"># 自定义构建逻辑（可选）</span>
│   ├── build.gradle.kts
│   └── src/
│
├── build.gradle.kts                    <span class="hljs-comment"># 根项目构建脚本</span>
├── settings.gradle.kts                 <span class="hljs-comment"># 项目设置</span>
├── gradle.properties                   <span class="hljs-comment"># Gradle 属性配置</span>
├── local.properties                    <span class="hljs-comment"># 本地配置（不提交到 Git）</span>
├── gradlew                             <span class="hljs-comment"># Gradle Wrapper 脚本（Unix）</span>
└── gradlew.bat                         <span class="hljs-comment"># Gradle Wrapper 脚本（Windows）</span>
</code></pre>
<h3 data-id="heading-2">gradle-wrapper.properties</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">#Tue Nov <span class="hljs-number">11</span> <span class="hljs-number">20</span>:<span class="hljs-number">22</span>:<span class="hljs-number">16</span> CST <span class="hljs-number">2025</span>
<span class="hljs-comment">//下载的Gradle的压缩包解压后的主目录</span>
distributionBase=GRADLE_USER_HOME   
<span class="hljs-comment">// 相对于distributionBase的解压后的Gradle的路径，为wrapper/dists</span>
distributionPath=wrapper/dists
<span class="hljs-comment">// Gradle版本的下载地址</span>
distributionUrl=https:<span class="hljs-comment">//services.gradle.org/distributions/gradle-8.11.1-bin.zip</span>
<span class="hljs-comment">// 同distributionBase，不过是存放zip压缩包的主目录</span>
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
</code></pre>
<p>和groovy版本变化不大,主要解释都在备注里了</p>
<h3 data-id="heading-3">settings.gradle.kts</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 1. 插件管理配置</span>
pluginManagement {
    <span class="hljs-comment">// 配置插件仓库</span>
    repositories {
        <span class="hljs-comment">// Google 的 Maven 仓库（Android 插件）</span>
        google {
            <span class="hljs-comment">// 内容过滤：只从 Google 下载特定包</span>
            content {
                includeGroupByRegex(<span class="hljs-string">"com\\.android.*"</span>)
                includeGroupByRegex(<span class="hljs-string">"com\\.google.*"</span>)
                includeGroupByRegex(<span class="hljs-string">"androidx.*"</span>)
            }
        }
        
        mavenCentral()  <span class="hljs-comment">// Maven 中央仓库</span>
        gradlePluginPortal()  <span class="hljs-comment">// Gradle 插件门户</span>
    }
    
    <span class="hljs-comment">// 插件版本解析策略</span>
    resolutionStrategy {
        eachPlugin {
            <span class="hljs-comment">// 自定义插件版本解析</span>
            <span class="hljs-keyword">if</span> (requested.id.id == <span class="hljs-string">"com.example.plugin"</span>) {
                useModule(<span class="hljs-string">"com.example:plugin:<span class="hljs-subst">${requested.version}</span>"</span>)
            }
        }
    }
}

<span class="hljs-comment">// 2. 依赖管理配置 三方库引入的源头配置</span>
dependencyResolutionManagement {
    <span class="hljs-comment">// 仓库模式</span>
    <span class="hljs-comment">// FAIL_ON_PROJECT_REPOS: 禁止在项目中声明仓库（推荐）</span>
    <span class="hljs-comment">// PREFER_PROJECT: 优先使用项目中的仓库</span>
    <span class="hljs-comment">// PREFER_SETTINGS: 优先使用 settings 中的仓库</span>
    repositoriesMode.<span class="hljs-keyword">set</span>(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
    
    <span class="hljs-comment">// 配置依赖仓库</span>
    repositories {
        google()
        mavenCentral()
        mavenLocal()  <span class="hljs-comment">// 本地 Maven 仓库</span>
        maven { url = uri(<span class="hljs-string">"https://jitpack.io"</span>) }   <span class="hljs-comment">// JitPack（GitHub 项目）</span>
        <span class="hljs-comment">// 阿里云镜像（国内加速）</span>
        maven { url = uri(<span class="hljs-string">"https://maven.aliyun.com/repository/public"</span>) }
        maven { url = uri(<span class="hljs-string">"https://maven.aliyun.com/repository/google"</span>) }
    }
    
    <span class="hljs-comment">// 版本目录</span>
    versionCatalogs {
        <span class="hljs-comment">// 自定义版本目录</span>
        create(<span class="hljs-string">"testLibs"</span>) {
            from(files(<span class="hljs-string">"gradle/test-libs.versions.toml"</span>))
        }
    }
}

<span class="hljs-comment">// 3. 构建缓存配置</span>
buildCache {
    local {
        isEnabled = <span class="hljs-literal">true</span>
        directory = File(rootDir, <span class="hljs-string">"build-cache"</span>)
        removeUnusedEntriesAfterDays = <span class="hljs-number">30</span>
    }
    
    remote&lt;HttpBuildCache&gt; {
        url = uri(<span class="hljs-string">"https://build-cache.example.com/cache/"</span>)
        isEnabled = <span class="hljs-literal">false</span>
        isPush = <span class="hljs-literal">false</span>
    }
}

<span class="hljs-comment">// 4. 插件管理（高级）</span>
plugins {
    <span class="hljs-comment">// 在 settings 中应用插件（Gradle 8.0+）</span>
    id(<span class="hljs-string">"com.gradle.enterprise"</span>) version <span class="hljs-string">"3.15"</span>
}

<span class="hljs-comment">// 5. 项目配置</span>

<span class="hljs-comment">// 设置根项目名称</span>
rootProject.name = <span class="hljs-string">"GradleY"</span>

<span class="hljs-comment">// 包含模块</span>
include <span class="hljs-string">':GroovyLibrary'</span>
include <span class="hljs-string">':KtsLibrary'</span>

<span class="hljs-comment">// 6. Gradle Enterprise / Build Scan</span>
gradleEnterprise {
    buildScan {
        termsOfServiceUrl = <span class="hljs-string">"https://gradle.com/terms-of-service"</span>
        termsOfServiceAgree = <span class="hljs-string">"yes"</span>
        publishAlways()
        <span class="hljs-comment">// 自定义标签</span>
        tag(<span class="hljs-string">"CI"</span>)
        value(<span class="hljs-string">"Git Commit"</span>, getGitCommit())
    }
}

<span class="hljs-comment">// 辅助函数</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getGitCommit</span><span class="hljs-params">()</span></span>: String {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">val</span> process = Runtime.getRuntime().exec(<span class="hljs-string">"git rev-parse --short HEAD"</span>)
        process.inputStream.bufferedReader().readText().trim()
    } <span class="hljs-keyword">catch</span> (e: Exception) {
        <span class="hljs-string">"unknown"</span>
    }
}
</code></pre>
<p>  该文件用来配置插件管理，依赖库管理和项目相关配置，具体作用见代码注释中标注</p>
<h3 data-id="heading-4">根项目build.gradle.kts</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// build.gradle.kts (root)</span>

<span class="hljs-comment">// 1. 插件声明</span>
plugins {
    <span class="hljs-comment">// 使用版本目录（推荐）</span>
    alias(libs.plugins.android.application) apply <span class="hljs-literal">false</span>
    alias(libs.plugins.android.library) apply <span class="hljs-literal">false</span>
    alias(libs.plugins.kotlin.android) apply <span class="hljs-literal">false</span>
    alias(libs.plugins.kotlin.jvm) apply <span class="hljs-literal">false</span>
    
    <span class="hljs-comment">// 或直接声明版本</span>
    id(<span class="hljs-string">"com.android.application"</span>) version <span class="hljs-string">"8.1.0"</span> apply <span class="hljs-literal">false</span>
    id(<span class="hljs-string">"org.jetbrains.kotlin.android"</span>) version <span class="hljs-string">"1.9.0"</span> apply <span class="hljs-literal">false</span>
    
    <span class="hljs-comment">// apply false 的含义：</span>
    <span class="hljs-comment">// 声明版本但不应用到根项目，由子项目自己决定是否应用</span>
}

<span class="hljs-comment">// 为所有项目配置</span>
allprojects {
    <span class="hljs-comment">// 设置项目属性</span>
    group = <span class="hljs-string">"com.example"</span>
    version = <span class="hljs-string">"1.0.0"</span>
    
    <span class="hljs-comment">// 配置任务</span>
    tasks.withType&lt;JavaCompile&gt;().configureEach {
        options.encoding = <span class="hljs-string">"UTF-8"</span>
    }
}

<span class="hljs-comment">// 为所有子项目配置</span>
subprojects {
    <span class="hljs-comment">// 应用通用插件</span>
    apply(plugin = <span class="hljs-string">"checkstyle"</span>)
    
    <span class="hljs-comment">// 配置通用依赖</span>
    dependencies {
        <span class="hljs-comment">// 所有子项目都添加这个依赖</span>
        <span class="hljs-string">"implementation"</span>(<span class="hljs-string">"org.jetbrains.kotlin:kotlin-stdlib"</span>)
    }
   
}
</code></pre>
<p>   <strong>alias(libs.plugins.android.application) apply false</strong> ，kotlin 挺好的一点就是可进行定义跳转，alias后边这里的 定义在 <strong>libs.versions.toml</strong>文件中，apply false表示不应用到跟项目，子项目可以使用。</p>
<p>  这里还需要注意的是<strong>allprojects</strong> 是包含整个项目的配置， <strong>subprojects</strong> 不包含跟项目，只包含子项目。</p>
<h3 data-id="heading-5">app build.gradle.kts</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-comment">// 1. 插件配置</span>
plugins {
    <span class="hljs-comment">// 应用插件</span>
    alias(libs.plugins.android.application)
    alias(libs.plugins.kotlin.android)
    alias(libs.plugins.kotlin.kapt)  <span class="hljs-comment">// Kotlin 注解处理</span>
    
    <span class="hljs-comment">// 或直接声明</span>
    id(<span class="hljs-string">"com.android.application"</span>)
    id(<span class="hljs-string">"org.jetbrains.kotlin.android"</span>)
    kotlin(<span class="hljs-string">"kapt"</span>)  <span class="hljs-comment">// 等同于 id("org.jetbrains.kotlin.kapt")</span>
}

<span class="hljs-comment">// 2. Android 基本配置</span>
android {
    <span class="hljs-comment">// 命名空间（AGP 7.0+，替代 manifest 中的 package）</span>
    namespace = <span class="hljs-string">"com.example.app"</span>
    <span class="hljs-comment">// 编译 SDK 版本</span>
    compileSdk = <span class="hljs-number">33</span>
    <span class="hljs-comment">// 构建工具版本（可选，默认使用 AGP 推荐版本）</span>
    buildToolsVersion = <span class="hljs-string">"33.0.1"</span>
    
    <span class="hljs-comment">// 默认配置</span>
    defaultConfig {
        applicationId = <span class="hljs-string">"com.example.app"</span>  <span class="hljs-comment">// 应用 ID</span>
        minSdk = <span class="hljs-number">24</span>
        targetSdk = <span class="hljs-number">33</span>
        versionCode = <span class="hljs-number">1</span>    <span class="hljs-comment">// 版本号</span>
        versionName = <span class="hljs-string">"1.0.0"</span>
        
        <span class="hljs-comment">// 测试运行器</span>
        testInstrumentationRunner = <span class="hljs-string">"androidx.test.runner.AndroidJUnitRunner"</span>
        
        <span class="hljs-comment">// BuildConfig 字段</span>
        buildConfigField(<span class="hljs-string">"String"</span>, <span class="hljs-string">"API_BASE_URL"</span>, <span class="hljs-string">"\"https://api.example.com\""</span>)
        buildConfigField(<span class="hljs-string">"boolean"</span>, <span class="hljs-string">"ENABLE_LOGGING"</span>, <span class="hljs-string">"true"</span>)
        buildConfigField(<span class="hljs-string">"int"</span>, <span class="hljs-string">"MAX_RETRY_COUNT"</span>, <span class="hljs-string">"3"</span>)
        
        <span class="hljs-comment">// Vector Drawable 支持</span>
        vectorDrawables {
            useSupportLibrary = <span class="hljs-literal">true</span>
        }
        
        ndk {
            <span class="hljs-comment">// NDK 配置 支持的 ABI</span>
            abiFilters += setOf(<span class="hljs-string">"armeabi-v7a"</span>, <span class="hljs-string">"arm64-v8a"</span>)
        }
        
        multiDexEnabled = <span class="hljs-literal">true</span>  <span class="hljs-comment">// 多 Dex 支持</span>
        consumerProguardFiles(<span class="hljs-string">"consumer-rules.pro"</span>)   <span class="hljs-comment">// ProGuard 消费者规则</span>
    }
    
    <span class="hljs-comment">// 签名配置</span>
    signingConfigs {
        getByName(<span class="hljs-string">"debug"</span>) {        <span class="hljs-comment">// Debug 签名</span>
            storeFile = file(<span class="hljs-string">"debug.keystore"</span>)
            storePassword = <span class="hljs-string">"android"</span>
            keyAlias = <span class="hljs-string">"androiddebugkey"</span>
            keyPassword = <span class="hljs-string">"android"</span>
        }

        create(<span class="hljs-string">"release"</span>) {        <span class="hljs-comment">// Release 签名</span>
            <span class="hljs-comment">// 从 local.properties 读取</span>
            <span class="hljs-keyword">val</span> keystoreProperties = File(rootDir, <span class="hljs-string">"keystore.properties"</span>)
            <span class="hljs-keyword">if</span> (keystoreProperties.exists()) {
                <span class="hljs-keyword">val</span> properties = java.util.Properties()
                properties.load(keystoreProperties.inputStream())
                
                storeFile = file(properties[<span class="hljs-string">"storeFile"</span>] <span class="hljs-keyword">as</span> String)
                storePassword = properties[<span class="hljs-string">"storePassword"</span>] <span class="hljs-keyword">as</span> String
                keyAlias = properties[<span class="hljs-string">"keyAlias"</span>] <span class="hljs-keyword">as</span> String
                keyPassword = properties[<span class="hljs-string">"keyPassword"</span>] <span class="hljs-keyword">as</span> String
            }
        }
    }
    
    <span class="hljs-comment">// 构建类型</span>
    buildTypes {
        <span class="hljs-comment">// Debug 类型</span>
        debug {
            applicationIdSuffix = <span class="hljs-string">".debug"</span>
            versionNameSuffix = <span class="hljs-string">"-debug"</span>
            
            isDebuggable = <span class="hljs-literal">true</span>
            isMinifyEnabled = <span class="hljs-literal">false</span>
            isShrinkResources = <span class="hljs-literal">false</span>
            
            buildConfigField(<span class="hljs-string">"String"</span>, <span class="hljs-string">"API_BASE_URL"</span>, <span class="hljs-string">"\"https://dev-api.example.com\""</span>)
            resValue(<span class="hljs-string">"string"</span>, <span class="hljs-string">"app_name"</span>, <span class="hljs-string">"MyApp Debug"</span>)
            
            signingConfig = signingConfigs.getByName(<span class="hljs-string">"debug"</span>)
        }
        
        <span class="hljs-comment">// Release 类型</span>
        release {
            isDebuggable = <span class="hljs-literal">false</span>
            isMinifyEnabled = <span class="hljs-literal">true</span>
            isShrinkResources = <span class="hljs-literal">true</span>
            
            proguardFiles(
                getDefaultProguardFile(<span class="hljs-string">"proguard-android-optimize.txt"</span>),
                <span class="hljs-string">"proguard-rules.pro"</span>
            )
            
            signingConfig = signingConfigs.getByName(<span class="hljs-string">"release"</span>)
            
            buildConfigField(<span class="hljs-string">"String"</span>, <span class="hljs-string">"API_BASE_URL"</span>, <span class="hljs-string">"\"https://api.example.com\""</span>)
            resValue(<span class="hljs-string">"string"</span>, <span class="hljs-string">"app_name"</span>, <span class="hljs-string">"MyApp"</span>)
        }
    }
    
    <span class="hljs-comment">// 编译选项</span>
    compileOptions {
        sourceCompatibility = JavaVersion.VERSION_11
        targetCompatibility = JavaVersion.VERSION_11
        
        <span class="hljs-comment">// 启用 desugaring</span>
        isCoreLibraryDesugaringEnabled = <span class="hljs-literal">true</span>
    }
    
    kotlinOptions {
        jvmTarget = <span class="hljs-string">"11"</span>
        
        <span class="hljs-comment">// Kotlin 编译器参数</span>
        freeCompilerArgs = listOf(
            <span class="hljs-string">"-opt-in=kotlin.RequiresOptIn"</span>,
            <span class="hljs-string">"-Xjvm-default=all"</span>,
            <span class="hljs-string">"-Xcontext-receivers"</span>
        )
    }
    
    <span class="hljs-comment">// 构建特性</span>
    buildFeatures {
        viewBinding = <span class="hljs-literal">true</span>         <span class="hljs-comment">// ViewBinding</span>
        dataBinding = <span class="hljs-literal">false</span>        <span class="hljs-comment">// DataBinding</span>
        compose = <span class="hljs-literal">false</span>           <span class="hljs-comment">// Compose</span>
        buildConfig = <span class="hljs-literal">true</span>        <span class="hljs-comment">// BuildConfig</span>
        aidl = <span class="hljs-literal">false</span>             <span class="hljs-comment">// AIDL</span>
        renderScript = <span class="hljs-literal">false</span>      <span class="hljs-comment">// RenderScript</span>
        shaders = <span class="hljs-literal">false</span>          <span class="hljs-comment">// Shaders</span>
    }
    
    <span class="hljs-comment">// Compose 配置（如果启用）</span>
    composeOptions {
        kotlinCompilerExtensionVersion = <span class="hljs-string">"1.5.3"</span>
    }
}

<span class="hljs-comment">// 3. 依赖配置</span>
dependencies {
    <span class="hljs-comment">// Core</span>
    implementation(libs.androidx.core.ktx)
    implementation(libs.androidx.appcompat)
    implementation(libs.material)
    
    <span class="hljs-comment">// Kotlin</span>
    implementation(libs.kotlin.stdlib)
    implementation(libs.kotlinx.coroutines.core)
    implementation(libs.kotlinx.coroutines.android)
    
    <span class="hljs-comment">// Android Components</span>
    implementation(libs.androidx.activity.ktx)
    implementation(libs.androidx.fragment.ktx)
    implementation(libs.androidx.lifecycle.runtime.ktx)
    implementation(libs.androidx.lifecycle.viewmodel.ktx)
    
    ...
}
</code></pre>
<p>  主要声明App bundle中使用到的依赖，构建信息设置和应用插件等信息</p>
<h3 data-id="heading-6">library build.gradle.kts</h3>
<pre><code class="hljs language-kotlin" lang="kotlin">plugins {
    alias(libs.plugins.android.library)  <span class="hljs-comment">// 注意是 library 不是 application</span>
    alias(libs.plugins.kotlin.android)
}

android {
    namespace = <span class="hljs-string">"com.example.library"</span>
    compileSdk = <span class="hljs-number">33</span>
    
    defaultConfig {
        minSdk = <span class="hljs-number">24</span>
        <span class="hljs-comment">// library 没有 applicationId 和 versionCode/versionName</span>
        testInstrumentationRunner = <span class="hljs-string">"androidx.test.runner.AndroidJUnitRunner"</span>
        
        <span class="hljs-comment">// 消费者 ProGuard 规则</span>
        consumerProguardFiles(<span class="hljs-string">"consumer-rules.pro"</span>)
    }
    
    buildTypes {
        release {
            isMinifyEnabled = <span class="hljs-literal">false</span>
            proguardFiles(
                getDefaultProguardFile(<span class="hljs-string">"proguard-android-optimize.txt"</span>),
                <span class="hljs-string">"proguard-rules.pro"</span>
            )
        }
    }
    
    <span class="hljs-comment">// library 可以发布不同的变体</span>
    publishNonDefault = <span class="hljs-literal">true</span>
}

dependencies {
    <span class="hljs-comment">// api: 透传依赖 给使用此库的模块</span>
    api(libs.kotlin.stdlib)
    
    <span class="hljs-comment">// implementation: 不透传 仅当前模块依赖</span>
    implementation(libs.androidx.core.ktx)
    testImplementation(libs.junit)
}
</code></pre>
<h3 data-id="heading-7">gradle libs.versions.toml</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[versions]</span>
<span class="hljs-attr">agp</span> = <span class="hljs-string">"8.10.0"</span>
<span class="hljs-attr">kotlin</span> = <span class="hljs-string">"2.0.21"</span>
<span class="hljs-attr">coreKtx</span> = <span class="hljs-string">"1.17.0"</span>
<span class="hljs-attr">junit</span> = <span class="hljs-string">"4.14-SNAPSHOT"</span>
<span class="hljs-attr">junitVersion</span> = <span class="hljs-string">"1.3.0"</span>
<span class="hljs-attr">espressoCore</span> = <span class="hljs-string">"3.7.0"</span>
<span class="hljs-attr">lifecycleRuntimeKtx</span> = <span class="hljs-string">"2.9.4"</span>
<span class="hljs-attr">activityCompose</span> = <span class="hljs-string">"1.11.0"</span>
<span class="hljs-attr">composeBom</span> = <span class="hljs-string">"2024.09.00"</span>
<span class="hljs-attr">appcompat</span> = <span class="hljs-string">"1.7.1"</span>
<span class="hljs-attr">material</span> = <span class="hljs-string">"1.13.0"</span>

<span class="hljs-section">[libraries]</span>
<span class="hljs-attr">androidx-core-ktx</span> = { group = <span class="hljs-string">"androidx.core"</span>, name = <span class="hljs-string">"core-ktx"</span>, version.ref = <span class="hljs-string">"coreKtx"</span> }
<span class="hljs-attr">junit</span> = { group = <span class="hljs-string">"junit"</span>, name = <span class="hljs-string">"junit"</span>, version.ref = <span class="hljs-string">"junit"</span> }
<span class="hljs-attr">androidx-junit</span> = { group = <span class="hljs-string">"androidx.test.ext"</span>, name = <span class="hljs-string">"junit"</span>, version.ref = <span class="hljs-string">"junitVersion"</span> }
<span class="hljs-attr">androidx-espresso-core</span> = { group = <span class="hljs-string">"androidx.test.espresso"</span>, name = <span class="hljs-string">"espresso-core"</span>, version.ref = <span class="hljs-string">"espressoCore"</span> }
<span class="hljs-attr">androidx-lifecycle-runtime-ktx</span> = { group = <span class="hljs-string">"androidx.lifecycle"</span>, name = <span class="hljs-string">"lifecycle-runtime-ktx"</span>, version.ref = <span class="hljs-string">"lifecycleRuntimeKtx"</span> }
<span class="hljs-attr">androidx-activity-compose</span> = { group = <span class="hljs-string">"androidx.activity"</span>, name = <span class="hljs-string">"activity-compose"</span>, version.ref = <span class="hljs-string">"activityCompose"</span> }
<span class="hljs-attr">androidx-compose-bom</span> = { group = <span class="hljs-string">"androidx.compose"</span>, name = <span class="hljs-string">"compose-bom"</span>, version.ref = <span class="hljs-string">"composeBom"</span> }
<span class="hljs-attr">androidx-ui</span> = { group = <span class="hljs-string">"androidx.compose.ui"</span>, name = <span class="hljs-string">"ui"</span> }
<span class="hljs-attr">androidx-ui-graphics</span> = { group = <span class="hljs-string">"androidx.compose.ui"</span>, name = <span class="hljs-string">"ui-graphics"</span> }
<span class="hljs-attr">androidx-ui-tooling</span> = { group = <span class="hljs-string">"androidx.compose.ui"</span>, name = <span class="hljs-string">"ui-tooling"</span> }
<span class="hljs-attr">androidx-ui-tooling-preview</span> = { group = <span class="hljs-string">"androidx.compose.ui"</span>, name = <span class="hljs-string">"ui-tooling-preview"</span> }
<span class="hljs-attr">androidx-ui-test-manifest</span> = { group = <span class="hljs-string">"androidx.compose.ui"</span>, name = <span class="hljs-string">"ui-test-manifest"</span> }
<span class="hljs-attr">androidx-ui-test-junit4</span> = { group = <span class="hljs-string">"androidx.compose.ui"</span>, name = <span class="hljs-string">"ui-test-junit4"</span> }
<span class="hljs-attr">androidx-material3</span> = { group = <span class="hljs-string">"androidx.compose.material3"</span>, name = <span class="hljs-string">"material3"</span> }
<span class="hljs-attr">androidx-appcompat</span> = { group = <span class="hljs-string">"androidx.appcompat"</span>, name = <span class="hljs-string">"appcompat"</span>, version.ref = <span class="hljs-string">"appcompat"</span> }
<span class="hljs-attr">material</span> = { group = <span class="hljs-string">"com.google.android.material"</span>, name = <span class="hljs-string">"material"</span>, version.ref = <span class="hljs-string">"material"</span> }

<span class="hljs-section">[plugins]</span>
<span class="hljs-attr">android-application</span> = { id = <span class="hljs-string">"com.android.application"</span>, version.ref = <span class="hljs-string">"agp"</span> }
<span class="hljs-attr">kotlin-android</span> = { id = <span class="hljs-string">"org.jetbrains.kotlin.android"</span>, version.ref = <span class="hljs-string">"kotlin"</span> }
<span class="hljs-attr">kotlin-compose</span> = { id = <span class="hljs-string">"org.jetbrains.kotlin.plugin.compose"</span>, version.ref = <span class="hljs-string">"kotlin"</span> }
<span class="hljs-attr">android-library</span> = { id = <span class="hljs-string">"com.android.library"</span>, version.ref = <span class="hljs-string">"agp"</span> }
</code></pre>
<p>  传统的依赖方式使用 字符串，容易拼写错误。kts的新版本依赖方式IDE 自动补全，Cmd+点击可跳转，并且版本管理更加集中</p>
<h3 data-id="heading-8">gradle.properties</h3>
<pre><code class="hljs language-properties" lang="properties"># -Xmx: jvm最大堆内存（根据机器配置调整，8GB 机器建议 4096m，16GB 建议 8192m）
# -XX:MaxMetaspaceSize: 元空间最大大小
# -XX:+HeapDumpOnOutOfMemoryError: OOM 时生成堆转储
# -Dfile.encoding: 文件编码
org.gradle.jvmargs=-Xmx4096m -XX:MaxMetaspaceSize=1024m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8

# 并行编译（利用多核 CPU）
org.gradle.parallel=true
# 配置缓存（实验性功能，显著提升速度） Gradle 8.0+ 稳定，强烈推荐开启
org.gradle.configuration-cache=true
# 构建缓存（复用之前的构建结果）
org.gradle.caching=true
# 按需配置  大型多模块项目建议开启
org.gradle.configureondemand=true
# 后台守护进程，避免每次构建都启动 JVM
org.gradle.daemon=true
# 文件监听（增量构建的基础）
org.gradle.vfs.watch=true
# Kotlin Daemon JVM 参数
kotlin.daemon.jvmargs=-Xmx2048m
# 增量编译
kotlin.incremental=true
# Kotlin 编译缓存
kotlin.caching.enabled=true
# Kotlin 编译器执行策略
# in-process: 在 Gradle Daemon 进程中编译（推荐）
# daemon: 使用单独的 Kotlin Daemon（默认）
# out-of-process: 每次新建进程
kotlin.compiler.execution.strategy=in-process

# 并行编译 Kotlin 模块
kotlin.parallel.tasks.in.project=true
# 使用 AndroidX
android.useAndroidX=true
# kotlin代码样式
kotlin.code.style=official
# 自动迁移第三方库到 AndroidX（通常关闭）
android.enableJetifier=false
# 使每个库的 R 类能够命名空间，让R 类只包含库本身声明的资源，不包含库依赖资源，缩小该库 R 类的大小
android.nonTransitiveRClass=true
# 使用新的资源处理器（AAPT2）
android.enableResourceOptimizations=true
# 禁用 PNG 优化（Debug 时可禁用）
# android.enablePngCrunchInDebugVariant=false
# 启用 D8 desugaring
android.enableD8.desugaring=true
# 启用 R8
android.enableR8=true
# 构建缓存
android.enableBuildCache=true

# 版本号（可被脚本读取）
VERSION_NAME=1.0.0
VERSION_CODE=1

# 签名配置（从环境变量读取，不提交到代码仓库）
# KEYSTORE_FILE=/path/to/keystore
# KEYSTORE_PASSWORD=password
# KEY_ALIAS=alias
# KEY_PASSWORD=password

# API 配置
# API_BASE_URL=https://api.example.com

# Maven 仓库用户名密码（不要提交到仓库）
# MAVEN_USERNAME=username
# MAVEN_PASSWORD=password
</code></pre>
<h3 data-id="heading-9">local.properties</h3>
<pre><code class="hljs language-properties" lang="properties"># Android SDK 路径（Android Studio 自动生成）
sdk.dir=/Users/username/Library/Android/sdk
# NDK 路径
ndk.dir=/Users/username/Library/Android/sdk/ndk/25.1.8937393

# 签名配置（敏感信息）
KEYSTORE_FILE=../release.keystore
KEYSTORE_PASSWORD=mypassword
KEY_ALIAS=mykey
KEY_PASSWORD=mypassword

# API Keys（敏感信息）
GOOGLE_MAPS_API_KEY=xxx
</code></pre>
<p>   设置sdk和ndk本地地址，配置打包签名配置等信息</p>
<h2 data-id="heading-10">Gradle的Groovy &amp; Kotlin区别</h2>
<h3 data-id="heading-11">Gradle DSL 的特点</h3>
<p>可读性更高，更加简洁 （模版代码少一些）</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// Groovy 和 kotlin都要使用到的 DSL格式，不同于java等代码方式</span>
android {
    compileSdk = <span class="hljs-number">33</span>
    
    <span class="hljs-comment">// 可以使用 Kotlin 的条件判断</span>
    if (project.hasProperty("useNewApi")) {
        defaultConfig {
            minSdk = <span class="hljs-number">24</span>
        }
    }
    
    <span class="hljs-comment">// 可以使用 Kotlin 的循环</span>
    <span class="hljs-built_in">listOf</span>("debug", "release")<span class="hljs-selector-class">.forEach</span> { buildType -&gt;
        <span class="hljs-built_in">println</span>("Processing $buildType")
    }
}

<span class="hljs-comment">// 如果不使用DSL的方式 可能会写成这样 ，稍微复杂了点</span>
val android = project<span class="hljs-selector-class">.extensions</span><span class="hljs-selector-class">.getByType</span>(AndroidExtension::class.java)
android<span class="hljs-selector-class">.setCompileSdk</span>(<span class="hljs-number">33</span>)

val config = <span class="hljs-built_in">DefaultConfig</span>()
config<span class="hljs-selector-class">.setMinSdk</span>(<span class="hljs-number">24</span>)
android<span class="hljs-selector-class">.setDefaultConfig</span>(config)
</code></pre>
<p>   Gradle 主要使用的<strong>内部DSL</strong> （简单说下外部DSL：需要专门的代码注解器比如 Html 和 SQL） ，可以使用 Kotlin的一些语言特性，这里还是要提到一下 Groovy的闭包，</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// Gradle 的 android {} 块实际上是：调用 android() 方法, 传入一个闭包作为参数</span>
android {  <span class="hljs-comment">// 闭包</span>
    compileSdk <span class="hljs-number">33</span>
}
<span class="hljs-built_in">android</span>({ 
    compileSdk <span class="hljs-number">33</span> 
})
<span class="hljs-comment">// 完整形态</span>
<span class="hljs-built_in">android</span>(new Closure() {
    void <span class="hljs-built_in">call</span>() {
        compileSdk <span class="hljs-number">33</span>
    }
})
大概得实现逻辑
class AndroidExtension {  <span class="hljs-comment">// 定义 Android 扩展类</span>
    int compileSdk
    
    void <span class="hljs-built_in">defaultConfig</span>(Closure closure) {
        def config = new <span class="hljs-built_in">DefaultConfig</span>()
        closure<span class="hljs-selector-class">.delegate</span> = config  <span class="hljs-comment">// 设置闭包的委托</span>
        <span class="hljs-built_in">closure</span>()                  <span class="hljs-comment">// 闭包</span>
    }
}

<span class="hljs-comment">// 定义配置方法，接收闭包作为参数</span>
def <span class="hljs-built_in">android</span>(Closure closure) {
    def ext = new <span class="hljs-built_in">AndroidExtension</span>()
    closure<span class="hljs-selector-class">.delegate</span> = ext     <span class="hljs-comment">// 设置委托</span>
    <span class="hljs-built_in">closure</span>()                  <span class="hljs-comment">// 闭包</span>
    return ext
}

<span class="hljs-comment">// 使用（看起来像 DSL）</span>
android {
    compileSdk = <span class="hljs-number">33</span>      <span class="hljs-comment">// 实际是在 AndroidExtension 上下文中</span>
    defaultConfig {
        minSdk = <span class="hljs-number">24</span>      <span class="hljs-comment">// 实际是在 DefaultConfig 上下文中</span>
    }
}
</code></pre>
<p>  Kotlin中使用的则是 Lambda方式（如果参数为最后一个，则可以去掉括号），并且Kotlin是使用 = 号来赋值的，相较于 Groovy ，Kotlin是静态类型语言，部分类型不对在编译期就会提示。</p>
<pre><code class="hljs language-kotlin" lang="kotlin">android {  <span class="hljs-comment">// Lambda 表达式</span>
    compileSdk = <span class="hljs-number">33</span>
    defaultConfig {  <span class="hljs-comment">// 嵌套 Lambda</span>
        minSdk = <span class="hljs-number">24</span>
    }
}

<span class="hljs-comment">// android { } 大概实现逻辑，可以理解为 ApplicationExtension.compileSdk = 33</span>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> org.gradle.api.Project.<span class="hljs-title">android</span><span class="hljs-params">(configure: <span class="hljs-type">org</span>.<span class="hljs-type">gradle</span>.<span class="hljs-type">api</span>.<span class="hljs-type">Action</span>&lt;<span class="hljs-type">com</span>.<span class="hljs-type">android</span>.<span class="hljs-type">build</span>.<span class="hljs-type">gradle</span>.<span class="hljs-type">LibraryExtension</span>&gt;)</span></span>: kotlin.<span class="hljs-built_in">Unit</span> { <span class="hljs-comment">/* compiled code */</span> }

</code></pre>
<p>  看Gradle源码，这里是委托给了 LibraryExtension ，所以compileSdk 字段就是 LibraryExtension 中的一个属性</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/563c63c3c2e44097a5937a73f1aa0b0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5piO5bed:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765360651&amp;x-signature=XgyPZTUwXbwqaZE%2BQjY4KSWCLpA%3D" alt="image.png" loading="lazy"/></p>
<p>  所以 我们可以在Android 大括号里边使用compileSdk等字段的赋值</p>
<h3 data-id="heading-12">Groovy vs Kotlin 语法对比</h3>
<ul>
<li>字符串</li>
</ul>
<pre><code class="hljs language-groovy" lang="groovy">// ========== Groovy ==========
def str1 = 'Hello world'      // 普通字符串 
def str3 = "Hello $name"       // 字符串插值  可以单引号，也可以双引号
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ========== Kotlin DSL ==========</span>
<span class="hljs-keyword">val</span> str1 = <span class="hljs-string">"only double quote"</span>  <span class="hljs-comment">// 只能用双引号</span>
<span class="hljs-keyword">val</span> str2 = <span class="hljs-string">"Hello <span class="hljs-variable">$name</span>"</span>        <span class="hljs-comment">// 字符串插值</span>
</code></pre>
<ul>
<li>变量</li>
</ul>
<pre><code class="hljs language-groovy" lang="groovy">// ========== Groovy ==========
def name = "ymc"               // 动态类型
String name = "ymc"            // 显式类型
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ========== Kotlin DSL ==========</span>
<span class="hljs-keyword">var</span> name = <span class="hljs-string">"ymc"</span>               <span class="hljs-comment">// 可变</span>
<span class="hljs-keyword">val</span> name = <span class="hljs-string">"ymc"</span>               <span class="hljs-comment">// 不可变（推荐）</span>
</code></pre>
<ul>
<li>方法调用</li>
</ul>
<pre><code class="hljs language-groovy" lang="groovy">// ========== Groovy ==========
println("Hello")
println "Hello"                 // 可以省略括号

add(1, 2)
add 1, 2                        // 可以省略括号和逗号

implementation 'androidx.core:core-ktx:1.9.0'
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ========== Kotlin DSL ==========</span>
println(<span class="hljs-string">"Hello"</span>)                <span class="hljs-comment">// 必须有括号</span>

add(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>)                       <span class="hljs-comment">// 必须有括号</span>

implementation(<span class="hljs-string">"androidx.core:core-ktx:1.9.0"</span>)  <span class="hljs-comment">// 必须有括号</span>
</code></pre>
<ul>
<li>plugins</li>
</ul>
<pre><code class="hljs language-groovy" lang="groovy">// ========== Groovy ==========
plugins {
    id 'com.android.application'
    id 'org.jetbrains.kotlin.android'
    id 'kotlin-kapt'
}

// 或
apply plugin: 'com.android.application'
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ========== Kotlin DSL ==========</span>
plugins {
    id(<span class="hljs-string">"com.android.application"</span>)
    id(<span class="hljs-string">"org.jetbrains.kotlin.android"</span>)
    kotlin(<span class="hljs-string">"kapt"</span>)  <span class="hljs-comment">// 等价于 id("org.jetbrains.kotlin.kapt")</span>
}

<span class="hljs-comment">// 或</span>
apply(plugin = <span class="hljs-string">"com.android.application"</span>)
</code></pre>
<ul>
<li>dependencies 块</li>
</ul>
<pre><code class="hljs language-groovy" lang="groovy">// ========== Groovy ==========
dependencies {
    implementation 'androidx.core:core-ktx:1.9.0'
    implementation group: 'com.google.code.gson', name: 'gson', version: '2.10.1'
    
    debugImplementation 'com.squareup.leakcanary:leakcanary-android:2.12'
    
    testImplementation 'junit:junit:4.13.2'
}
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ========== Kotlin DSL ==========</span>
dependencies {
    implementation(<span class="hljs-string">"androidx.core:core-ktx:1.9.0"</span>)
    implementation(group = <span class="hljs-string">"com.google.code.gson"</span>, name = <span class="hljs-string">"gson"</span>, version = <span class="hljs-string">"2.10.1"</span>)
    
    debugImplementation(<span class="hljs-string">"com.squareup.leakcanary:leakcanary-android:2.12"</span>)
    
    testImplementation(<span class="hljs-string">"junit:junit:4.13.2"</span>)
}
</code></pre>
<ul>
<li>android 块</li>
</ul>
<pre><code class="hljs language-groovy" lang="groovy">// ========== Groovy ==========
android {
    namespace 'com.example.app'
    compileSdk 33
    
    defaultConfig {
        applicationId "com.example.app"
        minSdk 24
        targetSdk 33
        versionCode 1
        versionName "1.0"
    }
    
    buildTypes {
        debug {
            applicationIdSuffix '.debug'
            debuggable true
        }
        release {
            minifyEnabled true
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
        }
    }
}
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ========== Kotlin DSL ==========</span>
android {
    namespace = <span class="hljs-string">"com.example.app"</span>
    compileSdk = <span class="hljs-number">33</span>
    
    defaultConfig {
        applicationId = <span class="hljs-string">"com.example.app"</span>
        minSdk = <span class="hljs-number">24</span>
        targetSdk = <span class="hljs-number">33</span>
        versionCode = <span class="hljs-number">1</span>
        versionName = <span class="hljs-string">"1.0"</span>
    }
    
    buildTypes {
        debug {
            applicationIdSuffix = <span class="hljs-string">".debug"</span>
            isDebuggable = <span class="hljs-literal">true</span>
        }
        release {
            isMinifyEnabled = <span class="hljs-literal">true</span>
            proguardFiles(
                getDefaultProguardFile(<span class="hljs-string">"proguard-android-optimize.txt"</span>),
                <span class="hljs-string">"proguard-rules.pro"</span>
            )
        }
    }
}
</code></pre>
<p>  前边两段代码，比较明显的不同就是 boolean赋值，kotlin 是is开头，等号赋值</p>
<ul>
<li>集合操作</li>
</ul>
<pre><code class="hljs language-groovy" lang="groovy">// ========== Groovy ==========
ndk {
    abiFilters 'armeabi-v7a', 'arm64-v8a'
}

exclude '**/test/**', '**/*.tmp'
</code></pre>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// ========== Kotlin DSL ==========</span>
ndk {
    abiFilters += setOf(<span class="hljs-string">"armeabi-v7a"</span>, <span class="hljs-string">"arm64-v8a"</span>)
}

exclude(<span class="hljs-string">"**/test/**"</span>, <span class="hljs-string">"**/*.tmp"</span>)
</code></pre>
<h2 data-id="heading-13">最后</h2>
<p>  记得22年新版本As就已经推荐使用kotlin来管理 Gradle ，学完后感觉相比于Groovy，kotlin编译期间更加安全，跳转和代码提示 ，更科学的管理类和版本控制。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 LangGraph 保姆级教程：从零构建你的第一个 AI Agent 工作流]]></title>    <link>https://juejin.cn/post/7579264485258854415</link>    <guid>https://juejin.cn/post/7579264485258854415</guid>    <pubDate>2025-12-03T08:31:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579264485258854415" data-draft-id="7579264485258838031" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 LangGraph 保姆级教程：从零构建你的第一个 AI Agent 工作流"/> <meta itemprop="keywords" content="LangChain,Node.js,Agent"/> <meta itemprop="datePublished" content="2025-12-03T08:31:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Dr_哈哈"/> <meta itemprop="url" content="https://juejin.cn/user/2208293602984286"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 LangGraph 保姆级教程：从零构建你的第一个 AI Agent 工作流
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2208293602984286/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Dr_哈哈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T08:31:40.000Z" title="Wed Dec 03 2025 08:31:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>🔥 本文 1.2w 字，从入门到实战，带你彻底搞懂 LangGraph！适合有一定 LangChain 基础的开发者。</p>
</blockquote>
<h2 data-id="heading-0">📌 前言</h2>
<p>你是否遇到过这些问题？</p>
<ul>
<li>用 LangChain 的 <code>pipe()</code> 写复杂流程时，代码变得一团乱麻？</li>
<li>想让 AI Agent 自动循环调用工具，却不知道怎么实现？</li>
<li>需要根据条件走不同分支，却发现 Chain 不支持？</li>
</ul>
<p>如果你有以上困扰，<strong>LangGraph</strong> 就是你的答案！</p>
<p>LangGraph 是 LangChain 团队推出的<strong>工作流编排框架</strong>，专门用于构建复杂的 AI Agent。它用<strong>图（Graph）</strong> 的方式来定义工作流，原生支持<strong>分支、循环、状态管理</strong>，是构建生产级 AI 应用的利器。</p>
<p><strong>阅读本文你将收获：</strong></p>
<ul>
<li>✅ 理解 LangGraph 的核心概念（StateGraph、Annotation、Node、Edge）</li>
<li>✅ 掌握状态管理和流程控制</li>
<li>✅ 学会实现条件分支和循环流程</li>
<li>✅ 能够独立构建 ReAct Agent</li>
</ul>
<hr/>
<h2 data-id="heading-1">📚 目录</h2>
<ol>
<li><a href="#1-%E4%BB%80%E4%B9%88%E6%98%AF-langgraph" title="#1-%E4%BB%80%E4%B9%88%E6%98%AF-langgraph">什么是 LangGraph</a></li>
<li><a href="#2-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E9%80%9F%E8%A7%88" title="#2-%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5%E9%80%9F%E8%A7%88">核心概念速览</a></li>
<li><a href="#3-stategraph-%E7%8A%B6%E6%80%81%E5%9B%BE" title="#3-stategraph-%E7%8A%B6%E6%80%81%E5%9B%BE">StateGraph 状态图</a></li>
<li><a href="#4-annotation-%E7%8A%B6%E6%80%81%E5%AE%9A%E4%B9%89" title="#4-annotation-%E7%8A%B6%E6%80%81%E5%AE%9A%E4%B9%89">Annotation 状态定义</a></li>
<li><a href="#5-node-%E8%8A%82%E7%82%B9%E8%AF%A6%E8%A7%A3" title="#5-node-%E8%8A%82%E7%82%B9%E8%AF%A6%E8%A7%A3">Node 节点详解</a></li>
<li><a href="#6-edge-%E8%BE%B9%E4%B8%8E%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6" title="#6-edge-%E8%BE%B9%E4%B8%8E%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6">Edge 边与流程控制</a></li>
<li><a href="#7-%E6%9D%A1%E4%BB%B6%E5%88%86%E6%94%AF%E5%AE%9E%E6%88%98" title="#7-%E6%9D%A1%E4%BB%B6%E5%88%86%E6%94%AF%E5%AE%9E%E6%88%98">条件分支实战</a></li>
<li><a href="#8-%E5%BE%AA%E7%8E%AF%E6%B5%81%E7%A8%8B%E5%AE%9E%E7%8E%B0" title="#8-%E5%BE%AA%E7%8E%AF%E6%B5%81%E7%A8%8B%E5%AE%9E%E7%8E%B0">循环流程实现</a></li>
<li><a href="#9-react-agent-%E5%AE%8C%E6%95%B4%E5%AE%9E%E6%88%98" title="#9-react-agent-%E5%AE%8C%E6%95%B4%E5%AE%9E%E6%88%98">ReAct Agent 完整实战</a></li>
<li><a href="#10-%E6%B5%81%E5%BC%8F%E8%BE%93%E5%87%BA" title="#10-%E6%B5%81%E5%BC%8F%E8%BE%93%E5%87%BA">流式输出</a></li>
<li><a href="#11-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B8%8E%E8%B8%A9%E5%9D%91%E6%8C%87%E5%8D%97" title="#11-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E4%B8%8E%E8%B8%A9%E5%9D%91%E6%8C%87%E5%8D%97">最佳实践与踩坑指南</a></li>
<li><a href="#12-%E9%99%84%E5%BD%95llm-%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE" title="#12-%E9%99%84%E5%BD%95llm-%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE">附录：LLM 参数配置</a></li>
</ol>
<hr/>
<h2 data-id="heading-2">1. 什么是 LangGraph</h2>
<h3 data-id="heading-3">1.1 一句话定义</h3>
<p><strong>LangGraph = 用「画流程图」的方式构建 AI 应用</strong></p>
<p>它将工作流建模为图（Graph）：</p>
<ul>
<li><strong>节点（Nodes）</strong> = 执行步骤（函数）</li>
<li><strong>边（Edges）</strong> = 步骤之间的连线</li>
<li><strong>状态（State）</strong> = 在节点间传递的数据</li>
</ul>
<h3 data-id="heading-4">1.2 为什么需要 LangGraph？</h3>








































<table><thead><tr><th>场景</th><th>LangChain (pipe)</th><th>LangGraph</th></tr></thead><tbody><tr><td>简单线性流程</td><td>✅ 足够</td><td>可以但没必要</td></tr><tr><td>条件分支</td><td>❌ 不支持</td><td>✅ 原生支持</td></tr><tr><td>循环/迭代</td><td>❌ 难实现</td><td>✅ 原生支持</td></tr><tr><td>复杂 Agent</td><td>❌ 需手写循环</td><td>✅ 声明式定义</td></tr><tr><td>状态管理</td><td>❌ 手动传递</td><td>✅ 自动管理</td></tr><tr><td>可视化调试</td><td>❌ 困难</td><td>✅ LangGraph Studio</td></tr></tbody></table>
<h3 data-id="heading-5">1.3 安装</h3>
<pre><code class="hljs language-bash" lang="bash">npm install @langchain/langgraph
</code></pre>
<hr/>
<h2 data-id="heading-6">2. 核心概念速览</h2>
<p>在深入细节之前，先建立全局认知：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────┐
│                  LangGraph 核心概念                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│    StateGraph (状态图容器)                                │
│    ┌───────────────────────────────────────────────┐    │
│    │                                               │    │
│    │   <span class="hljs-selector-attr">[START]</span> ──→ <span class="hljs-selector-attr">[Node1]</span> ──→ <span class="hljs-selector-attr">[Node2]</span> ──→ <span class="hljs-selector-attr">[END]</span>  │    │
│    │                 │           │                │    │
│    │                 ▼           ▼                │    │
│    │            ┌─────────────────────┐          │    │
│    │            │  State (共享状态)    │          │    │
│    │            │  { <span class="hljs-selector-tag">input</span>, output }  │          │    │
│    │            └─────────────────────┘          │    │
│    └───────────────────────────────────────────────┘    │
│                                                         │
└─────────────────────────────────────────────────────────┘
</code></pre>













































<table><thead><tr><th>组件</th><th>作用</th><th>类比</th></tr></thead><tbody><tr><td><strong>StateGraph</strong></td><td>状态图容器</td><td>流程图画布</td></tr><tr><td><strong>State</strong></td><td>工作流数据</td><td>全局变量</td></tr><tr><td><strong>Annotation</strong></td><td>状态结构定义</td><td>TypeScript 接口</td></tr><tr><td><strong>Node</strong></td><td>执行单元</td><td>函数</td></tr><tr><td><strong>Edge</strong></td><td>连接关系</td><td>箭头</td></tr><tr><td><strong>START</strong></td><td>起始点</td><td>main()</td></tr><tr><td><strong>END</strong></td><td>结束点</td><td>return</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-7">3. StateGraph 状态图</h2>
<h3 data-id="heading-8">3.1 基本用法</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">StateGraph</span>, <span class="hljs-title class_">Annotation</span>, <span class="hljs-variable constant_">START</span>, <span class="hljs-variable constant_">END</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph"</span>;

<span class="hljs-comment">// 1️⃣ 定义状态结构</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">MyState</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
  <span class="hljs-attr">input</span>: <span class="hljs-title class_">Annotation</span>({ <span class="hljs-attr">reducer</span>: <span class="hljs-function">(<span class="hljs-params">_, x</span>) =&gt;</span> x, <span class="hljs-attr">default</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-string">""</span> }),
  <span class="hljs-attr">output</span>: <span class="hljs-title class_">Annotation</span>({ <span class="hljs-attr">reducer</span>: <span class="hljs-function">(<span class="hljs-params">_, x</span>) =&gt;</span> x, <span class="hljs-attr">default</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-string">""</span> }),
});

<span class="hljs-comment">// 2️⃣ 创建状态图</span>
<span class="hljs-keyword">const</span> graph = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StateGraph</span>(<span class="hljs-title class_">MyState</span>)
  .<span class="hljs-title function_">addNode</span>(<span class="hljs-string">"step1"</span>, step1Function) <span class="hljs-comment">// 添加节点</span>
  .<span class="hljs-title function_">addNode</span>(<span class="hljs-string">"step2"</span>, step2Function)
  .<span class="hljs-title function_">addEdge</span>(<span class="hljs-variable constant_">START</span>, <span class="hljs-string">"step1"</span>) <span class="hljs-comment">// 添加边</span>
  .<span class="hljs-title function_">addEdge</span>(<span class="hljs-string">"step1"</span>, <span class="hljs-string">"step2"</span>)
  .<span class="hljs-title function_">addEdge</span>(<span class="hljs-string">"step2"</span>, <span class="hljs-variable constant_">END</span>);

<span class="hljs-comment">// 3️⃣ 编译</span>
<span class="hljs-keyword">const</span> app = graph.<span class="hljs-title function_">compile</span>();

<span class="hljs-comment">// 4️⃣ 执行</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">invoke</span>({ <span class="hljs-attr">input</span>: <span class="hljs-string">"hello"</span> });
</code></pre>
<h3 data-id="heading-9">3.2 核心 API</h3>








































<table><thead><tr><th>方法</th><th>作用</th><th>示例</th></tr></thead><tbody><tr><td><code>addNode(name, fn)</code></td><td>添加节点</td><td><code>graph.addNode("process", processFn)</code></td></tr><tr><td><code>addEdge(from, to)</code></td><td>添加无条件边</td><td><code>graph.addEdge("A", "B")</code></td></tr><tr><td><code>addConditionalEdges()</code></td><td>添加条件边</td><td>见下文详解</td></tr><tr><td><code>compile()</code></td><td>编译图</td><td><code>const app = graph.compile()</code></td></tr><tr><td><code>invoke(state)</code></td><td>同步执行</td><td><code>await app.invoke({...})</code></td></tr><tr><td><code>stream(state)</code></td><td>流式执行</td><td><code>for await (const e of app.stream({...}))</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-10">4. Annotation 状态定义</h2>
<h3 data-id="heading-11">4.1 什么是 Annotation？</h3>
<p><strong>Annotation = 告诉 LangGraph「状态长什么样」+「状态怎么更新」</strong></p>
<p>把它想象成「快递单」的格式定义：</p>
<pre><code class="hljs language-markdown" lang="markdown">📦 Annotation 定义「快递单」格式

   快递单上有哪些字段？
   ┌─────────────────────────────────┐
   │ 收件人: <span class="hljs-strong">____</span><span class="hljs-strong">____</span>                │
   │ 地址:   <span class="hljs-strong">____</span><span class="hljs-strong">____</span>                │
   │ 物品:   <span class="hljs-strong">____</span><span class="hljs-strong">____</span>                │
   │ 备注:   <span class="hljs-strong">____</span><span class="hljs-strong">____</span> (可追加)       │
   └─────────────────────────────────┘

   每个站点（节点）都能看到这张单，也能修改它
</code></pre>
<h3 data-id="heading-12">4.2 基本语法</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Annotation</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">MyState</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
  <span class="hljs-attr">fieldName</span>: <span class="hljs-title class_">Annotation</span>({
    <span class="hljs-attr">reducer</span>: reducerFunction, <span class="hljs-comment">// 状态如何更新</span>
    <span class="hljs-attr">default</span>: defaultFunction, <span class="hljs-comment">// 默认值</span>
  }),
});
</code></pre>
<h3 data-id="heading-13">4.3 Reducer 详解</h3>
<p>Reducer 决定「当节点返回新值时，怎么更新状态」：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 替换模式 - 新值覆盖旧值</span>
<span class="hljs-attr">reducer</span>: <span class="hljs-function">(<span class="hljs-params">prev, next</span>) =&gt;</span> next;
<span class="hljs-comment">// 节点返回 { name: "李四" } → state.name 变成 "李四"</span>

<span class="hljs-comment">// 2. 累加模式 - 适用于消息列表（最常用！）</span>
<span class="hljs-attr">reducer</span>: <span class="hljs-function">(<span class="hljs-params">prev, next</span>) =&gt;</span> [...prev, ...next];
<span class="hljs-comment">// 节点返回 { messages: [新消息] } → 追加到 messages 数组</span>

<span class="hljs-comment">// 3. 数字累加</span>
<span class="hljs-attr">reducer</span>: <span class="hljs-function">(<span class="hljs-params">prev, next</span>) =&gt;</span> prev + next;
<span class="hljs-comment">// 节点返回 { count: 1 } → count 加 1</span>
</code></pre>
<h3 data-id="heading-14">4.4 实际案例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 对话 Agent 的状态定义</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">AgentState</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
  <span class="hljs-comment">// 消息列表 - 累加模式（重要！）</span>
  <span class="hljs-attr">messages</span>: <span class="hljs-title class_">Annotation</span>({
    <span class="hljs-attr">reducer</span>: <span class="hljs-function">(<span class="hljs-params">prev, next</span>) =&gt;</span> [...prev, ...next],
    <span class="hljs-attr">default</span>: <span class="hljs-function">() =&gt;</span> [],
  }),

  <span class="hljs-comment">// 当前任务 - 替换模式</span>
  <span class="hljs-attr">currentTask</span>: <span class="hljs-title class_">Annotation</span>({
    <span class="hljs-attr">reducer</span>: <span class="hljs-function">(<span class="hljs-params">_, next</span>) =&gt;</span> next,
    <span class="hljs-attr">default</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-string">""</span>,
  }),

  <span class="hljs-comment">// 迭代次数 - 数字累加</span>
  <span class="hljs-attr">iterations</span>: <span class="hljs-title class_">Annotation</span>({
    <span class="hljs-attr">reducer</span>: <span class="hljs-function">(<span class="hljs-params">prev, next</span>) =&gt;</span> prev + next,
    <span class="hljs-attr">default</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-number">0</span>,
  }),
});
</code></pre>
<h3 data-id="heading-15">4.5 为什么需要 Reducer？</h3>
<p><strong>痛点</strong>：多个节点都想更新同一个字段</p>
<pre><code class="hljs language-css" lang="css">例如：消息列表
  - 节点 <span class="hljs-selector-tag">A</span> 返回: { messages: [new <span class="hljs-built_in">HumanMessage</span>(<span class="hljs-string">"hi"</span>)] }
  - 节点 <span class="hljs-selector-tag">B</span> 返回: { messages: [new <span class="hljs-built_in">AIMessage</span>(<span class="hljs-string">"hello"</span>)] }

❌ 没有 Reducer：节点 <span class="hljs-selector-tag">B</span> 的值覆盖节点 <span class="hljs-selector-tag">A</span>，用户消息丢失！
✅ 有 Reducer：  <span class="hljs-selector-attr">[...prev, ...next]</span>，两条消息都保留！
</code></pre>
<hr/>
<h2 data-id="heading-16">5. Node 节点详解</h2>
<h3 data-id="heading-17">5.1 节点函数签名</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 节点 = 接收 state，返回部分更新的函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">myNode</span>(<span class="hljs-params">state</span>) {
  <span class="hljs-comment">// 从 state 读取数据</span>
  <span class="hljs-keyword">const</span> input = state.<span class="hljs-property">input</span>;

  <span class="hljs-comment">// 处理逻辑</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">someOperation</span>(input);

  <span class="hljs-comment">// 只返回需要更新的字段</span>
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">output</span>: result };
}
</code></pre>
<h3 data-id="heading-18">5.2 常见节点类型</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 纯处理节点 - 数据处理，可以是同步的</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">processNode</span>(<span class="hljs-params">state</span>) {
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">result</span>: state.<span class="hljs-property">input</span>.<span class="hljs-title function_">toUpperCase</span>() };
}

<span class="hljs-comment">// 2. LLM 节点 - 调用 AI 模型（必须异步）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">llmNode</span>(<span class="hljs-params">state</span>) {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llm.<span class="hljs-title function_">invoke</span>([<span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(state.<span class="hljs-property">question</span>)]);
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">answer</span>: response.<span class="hljs-property">content</span> };
}

<span class="hljs-comment">// 3. API 节点 - 调用外部接口（必须异步）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">apiNode</span>(<span class="hljs-params">state</span>) {
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">"https://api.example.com/data"</span>);
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">apiResult</span>: <span class="hljs-keyword">await</span> data.<span class="hljs-title function_">json</span>() };
}

<span class="hljs-comment">// 4. 工具节点 - 使用内置 ToolNode</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ToolNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph/prebuilt"</span>;
<span class="hljs-keyword">const</span> toolNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolNode</span>(tools);
</code></pre>
<h3 data-id="heading-19">5.3 返回值规则</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 正确：只返回需要更新的字段</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">goodNode</span>(<span class="hljs-params">state</span>) {
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">output</span>: <span class="hljs-string">"result"</span> };
}

<span class="hljs-comment">// ❌ 错误：不需要展开整个 state</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">badNode</span>(<span class="hljs-params">state</span>) {
  <span class="hljs-keyword">return</span> { ...state, <span class="hljs-attr">output</span>: <span class="hljs-string">"result"</span> };
}

<span class="hljs-comment">// ✅ 正确：返回空对象 = 不更新任何字段</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">noUpdateNode</span>(<span class="hljs-params">state</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(state);
  <span class="hljs-keyword">return</span> {};
}
</code></pre>
<hr/>
<h2 data-id="heading-20">6. Edge 边与流程控制</h2>
<h3 data-id="heading-21">6.1 什么是 Edge？</h3>
<p><strong>Edge = 流程图里的「箭头」= 定义执行顺序</strong></p>
<pre><code class="hljs language-css" lang="css">        Edge（边）
           ↓
<span class="hljs-selector-attr">[START]</span> ────────→ <span class="hljs-selector-attr">[NodeA]</span> ────────→ <span class="hljs-selector-attr">[END]</span>
          ↑                  ↑
       这是边             这也是边

意思：START 完了执行 NodeA，NodeA 完了结束
</code></pre>
<h3 data-id="heading-22">6.2 两种边的对比</h3>























<table><thead><tr><th>类型</th><th>说明</th><th>比喻</th><th>代码</th></tr></thead><tbody><tr><td><strong>普通边</strong></td><td>A 完了一定到 B</td><td>直线</td><td><code>addEdge("A", "B")</code></td></tr><tr><td><strong>条件边</strong></td><td>根据状态决定去哪</td><td>岔路口</td><td><code>addConditionalEdges(...)</code></td></tr></tbody></table>
<h3 data-id="heading-23">6.3 普通边语法</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">START</span>, <span class="hljs-variable constant_">END</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph"</span>;

<span class="hljs-comment">// 从 A 到 B</span>
graph.<span class="hljs-title function_">addEdge</span>(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>);

<span class="hljs-comment">// 入口</span>
graph.<span class="hljs-title function_">addEdge</span>(<span class="hljs-variable constant_">START</span>, <span class="hljs-string">"firstNode"</span>);

<span class="hljs-comment">// 出口</span>
graph.<span class="hljs-title function_">addEdge</span>(<span class="hljs-string">"lastNode"</span>, <span class="hljs-variable constant_">END</span>);

<span class="hljs-comment">// 链式调用</span>
graph.<span class="hljs-title function_">addEdge</span>(<span class="hljs-variable constant_">START</span>, <span class="hljs-string">"A"</span>).<span class="hljs-title function_">addEdge</span>(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>).<span class="hljs-title function_">addEdge</span>(<span class="hljs-string">"B"</span>, <span class="hljs-string">"C"</span>).<span class="hljs-title function_">addEdge</span>(<span class="hljs-string">"C"</span>, <span class="hljs-variable constant_">END</span>);
</code></pre>
<h3 data-id="heading-24">6.4 addEdge vs pipe() 对比</h3>
<p>如果你用过 LangChain 的 <code>pipe()</code>：</p>

























<table><thead><tr><th>特性</th><th>pipe()</th><th>addEdge()</th></tr></thead><tbody><tr><td>流程类型</td><td>只能线性 A→B→C</td><td>可分支、循环</td></tr><tr><td>条件分支</td><td>❌ 不支持</td><td>✅ 支持</td></tr><tr><td>循环</td><td>❌ 不支持</td><td>✅ 支持</td></tr></tbody></table>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">pipe</span>():      <span class="hljs-selector-tag">A</span> ──→ <span class="hljs-selector-tag">B</span> ──→ <span class="hljs-selector-tag">C</span> ──→ 结束（只能往前）

<span class="hljs-selector-tag">addEdge</span>():   <span class="hljs-selector-tag">A</span> ──→ <span class="hljs-selector-tag">B</span> ──→ <span class="hljs-selector-tag">C</span> ──→ 结束
                  ↑     │
                  └─────┘  （可以循环回去！）
</code></pre>
<blockquote>
<p>💡 <strong>总结</strong>：简单线性流程用 pipe，需要分支/循环用 LangGraph！</p>
</blockquote>
<hr/>
<h2 data-id="heading-25">7. 条件分支实战</h2>
<h3 data-id="heading-26">7.1 语法</h3>
<pre><code class="hljs language-javascript" lang="javascript">graph.<span class="hljs-title function_">addConditionalEdges</span>(
  fromNode, <span class="hljs-comment">// 源节点</span>
  routerFunction, <span class="hljs-comment">// 路由函数</span>
  routeMapping <span class="hljs-comment">// 路由映射</span>
);
</code></pre>
<h3 data-id="heading-27">7.2 路由函数</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 路由函数：接收 state，返回路由 key</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">router</span>(<span class="hljs-params">state</span>) {
  <span class="hljs-keyword">if</span> (state.<span class="hljs-property">score</span> &gt; <span class="hljs-number">80</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"high"</span>;
  <span class="hljs-keyword">if</span> (state.<span class="hljs-property">score</span> &gt; <span class="hljs-number">60</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"medium"</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-string">"low"</span>;
}

<span class="hljs-comment">// 路由映射：key → 节点名</span>
<span class="hljs-keyword">const</span> routeMapping = {
  <span class="hljs-attr">high</span>: <span class="hljs-string">"celebrateNode"</span>,
  <span class="hljs-attr">medium</span>: <span class="hljs-string">"normalNode"</span>,
  <span class="hljs-attr">low</span>: <span class="hljs-string">"improveNode"</span>,
};

graph.<span class="hljs-title function_">addConditionalEdges</span>(<span class="hljs-string">"scoreNode"</span>, router, routeMapping);
</code></pre>
<h3 data-id="heading-28">7.3 完整示例：情感分析路由</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 路由函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sentimentRouter</span>(<span class="hljs-params">state</span>) {
  <span class="hljs-keyword">const</span> sentiment = state.<span class="hljs-property">sentiment</span>;
  <span class="hljs-keyword">if</span> (sentiment.<span class="hljs-title function_">includes</span>(<span class="hljs-string">"积极"</span>)) <span class="hljs-keyword">return</span> <span class="hljs-string">"positive"</span>;
  <span class="hljs-keyword">if</span> (sentiment.<span class="hljs-title function_">includes</span>(<span class="hljs-string">"消极"</span>)) <span class="hljs-keyword">return</span> <span class="hljs-string">"negative"</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-string">"neutral"</span>;
}

<span class="hljs-comment">// 构建图</span>
<span class="hljs-keyword">const</span> graph = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StateGraph</span>(<span class="hljs-title class_">MyState</span>)
  .<span class="hljs-title function_">addNode</span>(<span class="hljs-string">"analyze"</span>, analyzeNode)
  .<span class="hljs-title function_">addNode</span>(<span class="hljs-string">"positive"</span>, positiveHandler)
  .<span class="hljs-title function_">addNode</span>(<span class="hljs-string">"negative"</span>, negativeHandler)
  .<span class="hljs-title function_">addNode</span>(<span class="hljs-string">"neutral"</span>, neutralHandler)
  .<span class="hljs-title function_">addEdge</span>(<span class="hljs-variable constant_">START</span>, <span class="hljs-string">"analyze"</span>)
  .<span class="hljs-title function_">addConditionalEdges</span>(<span class="hljs-string">"analyze"</span>, sentimentRouter, {
    <span class="hljs-attr">positive</span>: <span class="hljs-string">"positive"</span>,
    <span class="hljs-attr">negative</span>: <span class="hljs-string">"negative"</span>,
    <span class="hljs-attr">neutral</span>: <span class="hljs-string">"neutral"</span>,
  })
  .<span class="hljs-title function_">addEdge</span>(<span class="hljs-string">"positive"</span>, <span class="hljs-variable constant_">END</span>)
  .<span class="hljs-title function_">addEdge</span>(<span class="hljs-string">"negative"</span>, <span class="hljs-variable constant_">END</span>)
  .<span class="hljs-title function_">addEdge</span>(<span class="hljs-string">"neutral"</span>, <span class="hljs-variable constant_">END</span>);
</code></pre>
<p>流程图：</p>
<pre><code class="hljs language-css" lang="css">                    ┌─────────────┐
               ┌───→│  positive   │───┐
               │    └─────────────┘   │
<span class="hljs-selector-attr">[START]</span>→<span class="hljs-selector-attr">[analyze]</span>                     │→<span class="hljs-selector-attr">[END]</span>
               │    ┌─────────────┐   │
               ├───→│  negative   │───┤
               │    └─────────────┘   │
               │    ┌─────────────┐   │
               └───→│  neutral    │───┘
                    └─────────────┘
</code></pre>
<hr/>
<h2 data-id="heading-29">8. 循环流程实现</h2>
<h3 data-id="heading-30">8.1 核心思路</h3>
<p>通过条件边实现循环：当条件满足时，流程回到之前的节点。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">shouldContinue</span>(<span class="hljs-params">state</span>) {
  <span class="hljs-comment">// 安全保护：最多迭代 N 次</span>
  <span class="hljs-keyword">if</span> (state.<span class="hljs-property">iterations</span> &gt;= <span class="hljs-number">3</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"end"</span>;
  <span class="hljs-comment">// 业务条件</span>
  <span class="hljs-keyword">if</span> (state.<span class="hljs-property">isComplete</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"end"</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-string">"continue"</span>;
}

<span class="hljs-keyword">const</span> graph = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StateGraph</span>(<span class="hljs-title class_">MyState</span>)
  .<span class="hljs-title function_">addNode</span>(<span class="hljs-string">"process"</span>, processNode)
  .<span class="hljs-title function_">addNode</span>(<span class="hljs-string">"check"</span>, checkNode)
  .<span class="hljs-title function_">addEdge</span>(<span class="hljs-variable constant_">START</span>, <span class="hljs-string">"process"</span>)
  .<span class="hljs-title function_">addEdge</span>(<span class="hljs-string">"process"</span>, <span class="hljs-string">"check"</span>)
  .<span class="hljs-title function_">addConditionalEdges</span>(<span class="hljs-string">"check"</span>, shouldContinue, {
    <span class="hljs-attr">continue</span>: <span class="hljs-string">"process"</span>, <span class="hljs-comment">// 🔄 循环回 process</span>
    <span class="hljs-attr">end</span>: <span class="hljs-variable constant_">END</span>,
  });
</code></pre>
<p>流程图：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[START]</span> ──→ <span class="hljs-selector-attr">[process]</span> ──→ <span class="hljs-selector-attr">[check]</span>
                ↑            │
                │  continue  │
                └────────────┤
                             │ end
                             ↓
                          <span class="hljs-selector-attr">[END]</span>
</code></pre>
<h3 data-id="heading-31">8.2 ⚠️ 防止无限循环</h3>
<p><strong>这是最重要的！一定要设置最大迭代次数：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAX_ITERATIONS</span> = <span class="hljs-number">10</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">shouldContinue</span>(<span class="hljs-params">state</span>) {
  <span class="hljs-comment">// 1️⃣ 先检查迭代次数（安全保护）</span>
  <span class="hljs-keyword">if</span> (state.<span class="hljs-property">iterations</span> &gt;= <span class="hljs-variable constant_">MAX_ITERATIONS</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"⚠️ 达到最大迭代次数，强制结束"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-string">"end"</span>;
  }

  <span class="hljs-comment">// 2️⃣ 再检查业务条件</span>
  <span class="hljs-keyword">if</span> (state.<span class="hljs-property">isComplete</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"end"</span>;

  <span class="hljs-keyword">return</span> <span class="hljs-string">"continue"</span>;
}
</code></pre>
<hr/>
<h2 data-id="heading-32">9. ReAct Agent 完整实战</h2>
<h3 data-id="heading-33">9.1 什么是 ReAct？</h3>
<p><strong>ReAct = Reasoning + Acting</strong>，让 LLM 自主使用工具的模式：</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 🤔 Reasoning (推理): LLM 分析问题，决定需要什么
<span class="hljs-bullet">2.</span> 🔧 Acting (行动): 调用工具获取信息
<span class="hljs-bullet">3.</span> 👀 Observation (观察): 查看工具返回结果
<span class="hljs-bullet">4.</span> 🔄 循环: 直到可以给出最终答案
</code></pre>
<h3 data-id="heading-34">9.2 流程图</h3>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[START]</span> ──→ <span class="hljs-selector-attr">[agent]</span> ──→ <span class="hljs-selector-attr">[router]</span>
               ↑            │
               │   tools    │ has_tools
               │  ┌─────────┴─────────┐
               │  ↓                   ↓
           <span class="hljs-selector-attr">[tools]</span>              no_tools
               │                      │
               └──────────────────────↓
                                   <span class="hljs-selector-attr">[END]</span>
</code></pre>
<h3 data-id="heading-35">9.3 完整代码</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">StateGraph</span>, <span class="hljs-title class_">Annotation</span>, <span class="hljs-variable constant_">START</span>, <span class="hljs-variable constant_">END</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ToolNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph/prebuilt"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HumanMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/core/messages"</span>;

<span class="hljs-comment">// 1️⃣ 定义状态</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">AgentState</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
  <span class="hljs-attr">messages</span>: <span class="hljs-title class_">Annotation</span>({
    <span class="hljs-attr">reducer</span>: <span class="hljs-function">(<span class="hljs-params">prev, next</span>) =&gt;</span> [...prev, ...next],
    <span class="hljs-attr">default</span>: <span class="hljs-function">() =&gt;</span> [],
  }),
});

<span class="hljs-comment">// 2️⃣ 定义工具 &amp; 绑定到 LLM</span>
<span class="hljs-keyword">const</span> tools = [calculatorTool, searchTool, weatherTool];
<span class="hljs-keyword">const</span> llmWithTools = llm.<span class="hljs-title function_">bindTools</span>(tools);

<span class="hljs-comment">// 3️⃣ Agent 节点：调用 LLM 做决策</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">agentNode</span>(<span class="hljs-params">state</span>) {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> llmWithTools.<span class="hljs-title function_">invoke</span>(state.<span class="hljs-property">messages</span>);
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">messages</span>: [response] };
}

<span class="hljs-comment">// 4️⃣ 工具节点：真正执行工具</span>
<span class="hljs-keyword">const</span> toolNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolNode</span>(tools);

<span class="hljs-comment">// 5️⃣ 路由函数：判断是否需要调用工具</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">shouldCallTools</span>(<span class="hljs-params">state</span>) {
  <span class="hljs-keyword">const</span> lastMessage = state.<span class="hljs-property">messages</span>[state.<span class="hljs-property">messages</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>];
  <span class="hljs-keyword">if</span> (lastMessage.<span class="hljs-property">tool_calls</span>?.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"tools"</span>;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-string">"end"</span>;
}

<span class="hljs-comment">// 6️⃣ 构建图</span>
<span class="hljs-keyword">const</span> agentGraph = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StateGraph</span>(<span class="hljs-title class_">AgentState</span>)
  .<span class="hljs-title function_">addNode</span>(<span class="hljs-string">"agent"</span>, agentNode)
  .<span class="hljs-title function_">addNode</span>(<span class="hljs-string">"tools"</span>, toolNode)
  .<span class="hljs-title function_">addEdge</span>(<span class="hljs-variable constant_">START</span>, <span class="hljs-string">"agent"</span>)
  .<span class="hljs-title function_">addConditionalEdges</span>(<span class="hljs-string">"agent"</span>, shouldCallTools, {
    <span class="hljs-attr">tools</span>: <span class="hljs-string">"tools"</span>,
    <span class="hljs-attr">end</span>: <span class="hljs-variable constant_">END</span>,
  })
  .<span class="hljs-title function_">addEdge</span>(<span class="hljs-string">"tools"</span>, <span class="hljs-string">"agent"</span>); <span class="hljs-comment">// 🔄 工具执行完回到 agent</span>

<span class="hljs-comment">// 7️⃣ 编译 &amp; 执行</span>
<span class="hljs-keyword">const</span> agent = agentGraph.<span class="hljs-title function_">compile</span>();
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> agent.<span class="hljs-title function_">invoke</span>({
  <span class="hljs-attr">messages</span>: [<span class="hljs-keyword">new</span> <span class="hljs-title class_">HumanMessage</span>(<span class="hljs-string">"北京天气怎么样？"</span>)],
});
</code></pre>
<h3 data-id="heading-36">9.4 执行流程演示</h3>
<pre><code class="hljs language-vbnet" lang="vbnet">用户: <span class="hljs-string">"北京天气怎么样？"</span>

<span class="hljs-keyword">Step</span> <span class="hljs-number">1</span>: [agent]
  └─ LLM 思考: <span class="hljs-string">"需要调用 get_weather 工具"</span>
  └─ 输出: tool_calls: [{name: <span class="hljs-string">"get_weather"</span>, args: {city: <span class="hljs-string">"北京"</span>}}]

<span class="hljs-keyword">Step</span> <span class="hljs-number">2</span>: [router] → 检测到 tool_calls → 去 [tools]

<span class="hljs-keyword">Step</span> <span class="hljs-number">3</span>: [tools]
  └─ 执行: get_weather(<span class="hljs-string">"北京"</span>)
  └─ 返回: <span class="hljs-string">"北京：晴天，15°C"</span>

<span class="hljs-keyword">Step</span> <span class="hljs-number">4</span>: [agent]
  └─ LLM 看到工具结果
  └─ 生成最终回答，无 tool_calls

<span class="hljs-keyword">Step</span> <span class="hljs-number">5</span>: [router] → 无 tool_calls → 去 [<span class="hljs-keyword">END</span>]

最终输出: <span class="hljs-string">"北京今天晴天，气温15°C，是个好天气！"</span>
</code></pre>
<h3 data-id="heading-37">9.5 重要概念辨析</h3>
<p>很多人混淆 <code>llmWithTools</code> 和 <code>toolNode</code>：</p>

























<table><thead><tr><th>概念</th><th>作用</th><th>类比</th></tr></thead><tbody><tr><td><code>llmWithTools</code></td><td>让 LLM <strong>知道</strong>有哪些工具</td><td>工具说明书</td></tr><tr><td><code>agentNode</code></td><td>调用 LLM <strong>决策</strong>是否用工具</td><td>决策者</td></tr><tr><td><code>toolNode</code></td><td><strong>真正执行</strong>工具调用</td><td>执行者</td></tr></tbody></table>
<pre><code class="hljs language-css" lang="css">┌──────────────────────────────────────────────────────────┐
│                                                          │
│  agentNode (内部用 llmWithTools)                         │
│  ┌────────────────────────────────────────────────────┐  │
│  │ LLM: <span class="hljs-string">"用户问天气，我需要调用 get_weather"</span>           │  │
│  │      ↓                                             │  │
│  │ 输出: tool_calls: [{name: <span class="hljs-string">"get_weather"</span>, ...}]     │  │
│  │      （只是"说"要调用，没有真的调）                  │  │
│  └────────────────────────────────────────────────────┘  │
│                          │                               │
│                          ▼                               │
│  toolNode                                                │
│  ┌────────────────────────────────────────────────────┐  │
│  │ 执行: <span class="hljs-built_in">get_weather</span>(<span class="hljs-string">"北京"</span>)                          │  │
│  │ 返回: <span class="hljs-string">"北京：晴天，15°C"</span>                           │  │
│  │      （真正调用工具，拿到结果）                      │  │
│  └────────────────────────────────────────────────────┘  │
│                                                          │
└──────────────────────────────────────────────────────────┘
</code></pre>
<blockquote>
<p>💡 <strong>记忆口诀</strong>：llmWithTools 让 LLM「知道」工具，toolNode 让工具「执行」！</p>
</blockquote>
<hr/>
<h2 data-id="heading-38">10. 流式输出</h2>
<h3 data-id="heading-39">10.1 invoke vs stream</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// invoke: 等待全部完成</span>
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">invoke</span>(initialState);

<span class="hljs-comment">// stream: 实时返回每个节点输出</span>
<span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> event <span class="hljs-keyword">of</span> app.<span class="hljs-title function_">stream</span>(initialState)) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(event);
  <span class="hljs-comment">// { "agent": { messages: [...] } }</span>
  <span class="hljs-comment">// { "tools": { messages: [...] } }</span>
}
</code></pre>
<h3 data-id="heading-40">10.2 优势</h3>
<ul>
<li><strong>用户体验</strong>：实时看到进度，减少等待焦虑</li>
<li><strong>调试方便</strong>：看到每步中间结果</li>
<li><strong>早期发现</strong>：某节点出错可尽早发现</li>
<li><strong>内存友好</strong>：边处理边输出</li>
</ul>
<hr/>
<h2 data-id="heading-41">11. 最佳实践与踩坑指南</h2>
<h3 data-id="heading-42">11.1 状态设计</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 好的设计</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">GoodState</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
  <span class="hljs-attr">userQuestion</span>: <span class="hljs-title class_">Annotation</span>({ ... }),      <span class="hljs-comment">// 清晰命名</span>
  <span class="hljs-attr">chatHistory</span>: <span class="hljs-title class_">Annotation</span>({
    <span class="hljs-attr">reducer</span>: <span class="hljs-function">(<span class="hljs-params">p, n</span>) =&gt;</span> [...p, ...n],      <span class="hljs-comment">// 合适的 reducer</span>
  }),
  <span class="hljs-attr">retryCount</span>: <span class="hljs-title class_">Annotation</span>({
    <span class="hljs-attr">default</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-number">0</span>,                     <span class="hljs-comment">// 明确默认值</span>
  }),
});

<span class="hljs-comment">// ❌ 不好的设计</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">BadState</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
  <span class="hljs-attr">data</span>: <span class="hljs-title class_">Annotation</span>({ ... }),   <span class="hljs-comment">// 命名模糊</span>
  <span class="hljs-attr">x</span>: <span class="hljs-title class_">Annotation</span>({ ... }),      <span class="hljs-comment">// 含义不明</span>
});
</code></pre>
<h3 data-id="heading-43">11.2 节点设计：单一职责</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 好：每个节点只做一件事</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">translateNode</span>(<span class="hljs-params">state</span>) {
  <span class="hljs-keyword">const</span> translated = <span class="hljs-keyword">await</span> llm.<span class="hljs-title function_">invoke</span>([...]);
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">translatedText</span>: translated.<span class="hljs-property">content</span> };
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">analyzeNode</span>(<span class="hljs-params">state</span>) {
  <span class="hljs-keyword">const</span> analysis = <span class="hljs-keyword">await</span> llm.<span class="hljs-title function_">invoke</span>([...]);
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">analysisResult</span>: analysis.<span class="hljs-property">content</span> };
}

<span class="hljs-comment">// ❌ 不好：一个节点做太多事</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">doEverythingNode</span>(<span class="hljs-params">state</span>) {
  <span class="hljs-comment">// 翻译 + 分析 + 总结 + 生成报告...</span>
}
</code></pre>
<h3 data-id="heading-44">11.3 错误处理</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">safeNode</span>(<span class="hljs-params">state</span>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">riskyOperation</span>(state);
    <span class="hljs-keyword">return</span> { result, <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span> };
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"节点执行失败:"</span>, error);
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">result</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">error</span>: error.<span class="hljs-property">message</span> };
  }
}

<span class="hljs-comment">// 在路由中处理错误</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">router</span>(<span class="hljs-params">state</span>) {
  <span class="hljs-keyword">if</span> (state.<span class="hljs-property">error</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"errorHandler"</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-string">"nextStep"</span>;
}
</code></pre>
<h3 data-id="heading-45">11.4 循环必须设置上限</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAX_ITERATIONS</span> = <span class="hljs-number">10</span>; <span class="hljs-comment">// 必须！</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">loopRouter</span>(<span class="hljs-params">state</span>) {
  <span class="hljs-keyword">if</span> (state.<span class="hljs-property">iterations</span> &gt;= <span class="hljs-variable constant_">MAX_ITERATIONS</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"⚠️ 达到最大迭代次数"</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-string">"end"</span>;
  }
  <span class="hljs-keyword">if</span> (state.<span class="hljs-property">isComplete</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">"end"</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-string">"continue"</span>;
}
</code></pre>
<hr/>
<h2 data-id="heading-46">12. 附录：LLM 参数配置</h2>
<h3 data-id="heading-47">12.1 temperature 参数</h3>






























<table><thead><tr><th>值</th><th>效果</th><th>输出特点</th></tr></thead><tbody><tr><td><strong>0</strong></td><td>确定性最高</td><td>每次几乎相同</td></tr><tr><td><strong>0.1-0.3</strong></td><td>低随机性</td><td>稳定、可预测</td></tr><tr><td><strong>0.5-0.7</strong></td><td>中等</td><td>平衡创意和一致性</td></tr><tr><td><strong>0.8-1.0</strong></td><td>高随机性</td><td>更有创意</td></tr></tbody></table>
<h3 data-id="heading-48">12.2 推荐值</h3>





























<table><thead><tr><th>场景</th><th>推荐值</th></tr></thead><tbody><tr><td>代码生成 / 数学</td><td>0 ~ 0.2</td></tr><tr><td>数据提取 / 分类</td><td>0</td></tr><tr><td>问答 / 知识检索</td><td>0 ~ 0.3</td></tr><tr><td>通用对话</td><td>0.5 ~ 0.7</td></tr><tr><td>创意写作</td><td>0.7 ~ 1.0</td></tr></tbody></table>
<h3 data-id="heading-49">12.3 在 LangGraph 中使用</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 不同节点用不同 temperature</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">codeNode</span>(<span class="hljs-params">state</span>) {
  <span class="hljs-keyword">const</span> precisionLLM = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({ <span class="hljs-attr">temperature</span>: <span class="hljs-number">0.1</span> });
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">creativeNode</span>(<span class="hljs-params">state</span>) {
  <span class="hljs-keyword">const</span> creativeLLM = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatDeepSeek</span>({ <span class="hljs-attr">temperature</span>: <span class="hljs-number">0.9</span> });
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-50">🎯 快速参考模板</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">StateGraph</span>, <span class="hljs-title class_">Annotation</span>, <span class="hljs-variable constant_">START</span>, <span class="hljs-variable constant_">END</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ToolNode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/langgraph/prebuilt"</span>;

<span class="hljs-comment">// 1. 定义状态</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">MyState</span> = <span class="hljs-title class_">Annotation</span>.<span class="hljs-title class_">Root</span>({
  <span class="hljs-attr">input</span>: <span class="hljs-title class_">Annotation</span>({ <span class="hljs-attr">reducer</span>: <span class="hljs-function">(<span class="hljs-params">_, x</span>) =&gt;</span> x, <span class="hljs-attr">default</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-string">""</span> }),
  <span class="hljs-attr">output</span>: <span class="hljs-title class_">Annotation</span>({ <span class="hljs-attr">reducer</span>: <span class="hljs-function">(<span class="hljs-params">_, x</span>) =&gt;</span> x, <span class="hljs-attr">default</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-string">""</span> }),
});

<span class="hljs-comment">// 2. 定义节点</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">myNode</span>(<span class="hljs-params">state</span>) {
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">output</span>: <span class="hljs-string">"processed"</span> };
}

<span class="hljs-comment">// 3. 定义路由</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">myRouter</span>(<span class="hljs-params">state</span>) {
  <span class="hljs-keyword">return</span> state.<span class="hljs-property">output</span> ? <span class="hljs-string">"end"</span> : <span class="hljs-string">"continue"</span>;
}

<span class="hljs-comment">// 4. 构建图</span>
<span class="hljs-keyword">const</span> graph = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StateGraph</span>(<span class="hljs-title class_">MyState</span>)
  .<span class="hljs-title function_">addNode</span>(<span class="hljs-string">"myNode"</span>, myNode)
  .<span class="hljs-title function_">addEdge</span>(<span class="hljs-variable constant_">START</span>, <span class="hljs-string">"myNode"</span>)
  .<span class="hljs-title function_">addConditionalEdges</span>(<span class="hljs-string">"myNode"</span>, myRouter, {
    <span class="hljs-attr">continue</span>: <span class="hljs-string">"myNode"</span>,
    <span class="hljs-attr">end</span>: <span class="hljs-variable constant_">END</span>,
  });

<span class="hljs-comment">// 5. 编译执行</span>
<span class="hljs-keyword">const</span> app = graph.<span class="hljs-title function_">compile</span>();
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">invoke</span>({ <span class="hljs-attr">input</span>: <span class="hljs-string">"hello"</span> });
</code></pre>
<hr/>
<h2 data-id="heading-51">📖 学习资源</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Flangchain-ai.github.io%2Flanggraphjs%2F" target="_blank" title="https://langchain-ai.github.io/langgraphjs/" ref="nofollow noopener noreferrer">官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flangchain-ai%2Flanggraphjs" target="_blank" title="https://github.com/langchain-ai/langgraphjs" ref="nofollow noopener noreferrer">GitHub 仓库</a></li>
<li>LangGraph Studio：可视化调试工具</li>
</ul>
<hr/>
<h2 data-id="heading-52">写在最后</h2>
<p>LangGraph 的核心就是<strong>用「画流程图」的思维来构建 AI 应用</strong>。掌握了 State、Node、Edge 这三个核心概念，你就能构建各种复杂的 AI 工作流。</p>
<p><strong>学习建议</strong>：</p>
<ol>
<li>先从简单的串行流程开始</li>
<li>逐步添加条件分支</li>
<li>最后实现完整的 ReAct Agent</li>
</ol>
<p>每一步都运行代码，观察状态的变化，你会很快上手！</p>
<hr/>
<p>如果这篇文章对你有帮助，欢迎<strong>点赞 👍 收藏 ⭐ 关注</strong>，后续还会分享更多 AI 开发干货！</p>
<p>有问题欢迎评论区交流~ 🎉</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RAG + Agent + Prompt工程中]]></title>    <link>https://juejin.cn/post/7579438351296839716</link>    <guid>https://juejin.cn/post/7579438351296839716</guid>    <pubDate>2025-12-03T08:33:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579438351296839716" data-draft-id="7578948893762273307" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RAG + Agent + Prompt工程中"/> <meta itemprop="keywords" content="Docker,AIGC,LLM"/> <meta itemprop="datePublished" content="2025-12-03T08:33:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="国家不保护废物"/> <meta itemprop="url" content="https://juejin.cn/user/1220936035210004"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RAG + Agent + Prompt工程中
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1220936035210004/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    国家不保护废物
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T08:33:26.000Z" title="Wed Dec 03 2025 08:33:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RAG + Agent + Prompt 工程中：搭建本地向量数据库Qdrant、文档处理与多语言支持国际化</h2>
<blockquote>
<p>本文是 <strong>RAG 系统实战系列</strong> 的中间篇。在前一篇文章中，我们介绍了 RAG 的基本原理和 LangChain 的核心概念。今天，我们将深入实战环节——手把手教你如何搭建本地向量数据库（Qdrant），并重点讲解 <strong>文档预处理流程</strong> 和 <strong>多语言国际化支持</strong> 的完整实现方案。</p>
<p>附上项目源代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Flhlhlhlhl%2Fassessment-rag" target="_blank" title="https://github.com/lhlhlhlhl/assessment-rag" ref="nofollow noopener noreferrer">lhlhlhlhl/assessment-rag</a></p>
</blockquote>
<hr/>
<h3 data-id="heading-1">前言：为什么向量数据库如此重要？</h3>
<p>在 RAG（检索增强生成）系统中，<strong>向量数据库</strong> 是连接“用户问题”与“知识库内容”的桥梁。它的作用是：</p>
<ul>
<li>将你的文档内容转换为高维向量（即“嵌入”）</li>
<li>快速找出与用户提问语义最相近的几段文本</li>
<li>为大模型提供精准的上下文，从而生成高质量回答</li>
</ul>
<p>没有高效的向量存储和检索机制，RAG 就失去了“增强”的意义。</p>
<p>在本项目中，我们选择 <strong>Qdrant</strong> 作为本地向量数据库，并围绕它构建了一套完整的文档处理 + 多语言支持体系。</p>
<hr/>
<h3 data-id="heading-2">一、向量数据库选型：为什么是 Qdrant？</h3>
<p>市面上有 Pinecone、Weaviate、Milvus、FAISS 等多种向量数据库，我们最终选择了 <strong>Qdrant</strong>，原因如下：</p>





























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td>🚀 <strong>高性能</strong></td><td>用 Rust 编写，内存效率高，单机每秒可处理数千次查询</td></tr><tr><td>📦 <strong>轻量易部署</strong></td><td>支持 Docker 一键启动，也支持二进制直接运行</td></tr><tr><td>🔍 <strong>支持元数据过滤</strong></td><td>不仅能按向量相似度搜索，还能结合标签、来源等条件筛选</td></tr><tr><td>🌐 <strong>双协议支持</strong></td><td>同时提供 RESTful API 和 gRPC 接口，适配不同场景</td></tr><tr><td>🆓 <strong>开源免费</strong></td><td>社区活跃，文档完善，适合本地开发和中小规模生产</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-3">二、两种部署方式：Docker vs 直接安装</h3>
<h4 data-id="heading-4">方案一：推荐！使用 Docker Compose 一键部署（开发首选）</h4>
<h5 data-id="heading-5">1. 创建 <code>docker-compose.yml</code></h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3.8'</span>

<span class="hljs-attr">services:</span>
  <span class="hljs-attr">qdrant:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">qdrant/qdrant:latest</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">smart_assessment_qdrant</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"6333:6333"</span>  <span class="hljs-comment"># REST API 端口</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"6334:6334"</span>  <span class="hljs-comment"># gRPC 端口（可选）</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./qdrant_storage:/qdrant/storage</span>  <span class="hljs-comment"># 持久化数据</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">QDRANT__SERVICE__GRPC_PORT=6334</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">unless-stopped</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">rag_network</span>

<span class="hljs-attr">networks:</span>
  <span class="hljs-attr">rag_network:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">bridge</span>
</code></pre>
<blockquote>
<p>💡 <strong>关键解释</strong>：</p>
<ul>
<li><code>volumes</code> 将本地 <code>qdrant_storage/</code> 目录挂载到容器内，<strong>即使删除容器，数据也不会丢失</strong></li>
<li><code>restart: unless-stopped</code> 保证服务崩溃后自动重启</li>
<li>自定义网络 <code>rag_network</code> 便于未来扩展（如加入 LLM 服务）</li>
</ul>
</blockquote>
<h5 data-id="heading-6">2. 启动服务</h5>
<pre><code class="hljs">docker-compose up -d
</code></pre>
<h5 data-id="heading-7">3. 验证是否成功</h5>
<pre><code class="hljs language-bash" lang="bash">curl http://localhost:6333/collections
</code></pre>
<p>如果返回 <code>{"result":{"collections":[]},"status":"ok"}</code>，说明 Qdrant 已正常运行！</p>
<hr/>
<h4 data-id="heading-8">方案二：非 Docker 安装（适合无 Docker 环境）</h4>
<h5 data-id="heading-9">Windows 用户：</h5>
<ol>
<li>
<p>从 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fqdrant%2Fqdrant%2Freleases" target="_blank" title="https://github.com/qdrant/qdrant/releases" ref="nofollow noopener noreferrer">GitHub Releases</a> 下载 <code>qdrant-windows-x86_64.zip</code></p>
</li>
<li>
<p>解压后运行：</p>
<pre><code class="hljs">.\qdrant.exe
</code></pre>
</li>
</ol>
<h5 data-id="heading-10">Linux/macOS 用户：</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方法1：APT 安装（Ubuntu/Debian）</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"deb [trusted=yes] https://apt.qdrant.io stable main"</span> | sudo <span class="hljs-built_in">tee</span> /etc/apt/sources.list.d/qdrant.list
sudo apt update &amp;&amp; sudo apt install qdrant

<span class="hljs-comment"># 方法2：直接下载二进制</span>
wget https://github.com/qdrant/qdrant/releases/latest/download/qdrant-linux-x86_64.tar.gz
tar xzf qdrant-linux-x86_64.tar.gz
./qdrant
</code></pre>
<blockquote>
<p>⚠️ 注意：非 Docker 方式需要手动管理配置、日志和数据目录，<strong>强烈建议开发阶段使用 Docker</strong>。</p>
</blockquote>
<hr/>
<h4 data-id="heading-11">✅ 为什么我们推荐 Docker？</h4>



































<table><thead><tr><th>对比项</th><th>直接安装</th><th>Docker</th></tr></thead><tbody><tr><td>安装复杂度</td><td>高（需处理依赖、路径、权限）</td><td>极低（一条命令）</td></tr><tr><td>跨平台一致性</td><td>差（Windows/Linux 行为可能不同）</td><td>完美一致</td></tr><tr><td>数据隔离</td><td>无（文件散落在系统各处）</td><td>完全隔离</td></tr><tr><td>版本切换</td><td>困难</td><td>修改镜像标签即可</td></tr><tr><td>卸载清理</td><td>容易残留</td><td><code>docker-compose down -v</code> 一键清空</td></tr></tbody></table>
<blockquote>
<p>🧩 <strong>打个比方</strong>：<br/>
直接安装就像在客厅里搭帐篷——占地方、难收拾；<br/>
Docker 就像买了一个带轮子的集装箱——随时移动、干净整洁。</p>
</blockquote>
<hr/>
<h3 data-id="heading-12">三、连接 Qdrant：代码实现详解</h3>
<p>无论采用哪种部署方式，我们的 JavaScript 代码连接逻辑完全一致。以下是核心类 <code>QdrantVectorStoreManager</code> 的精要解读：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 初始化客户端</span>
<span class="hljs-keyword">this</span>.client = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QdrantClient</span>({
  url: `http:<span class="hljs-comment">//${config.QDRANT_HOST}:${config.QDRANT_PORT}`,</span>
  timeout: <span class="hljs-number">30000</span>,
});

<span class="hljs-comment">// 使用 Qwen 兼容 OpenAI 的 Embedding 模型</span>
<span class="hljs-keyword">this</span>.embeddings = <span class="hljs-keyword">new</span> <span class="hljs-built_in">OpenAIEmbeddings</span>({
  openAIApiKey: config.QWEN_API_KEY,
  modelName: config.EMBEDDING_MODEL,
  configuration: { baseURL: config.QWEN_API_BASE }
});
</code></pre>
<blockquote>
<p>🔑 <strong>关键点</strong>：虽然用了 <code>OpenAIEmbeddings</code>，但通过 <code>baseURL</code> 指向 Qwen 的 API，实现了“用 OpenAI 接口调 Qwen 模型”。</p>
</blockquote>
<p>后续的 <code>initCollection()</code>、<code>addDocuments()</code>、<code>search()</code> 等方法封装了集合创建、文档插入和相似检索，<strong>完全兼容 LangChain 生态</strong>，可直接用于 RAG 链。</p>
<p>效果展示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/449cb55a1935432bbed7a882c9e24a31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu95a625LiN5L-d5oqk5bqf54mp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765355605&amp;x-signature=sIi5dTAnFRTd5%2F9wwQDOapC%2FXH8%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-13">四、文档处理：从原始文件到向量存储</h3>
<p>这是 RAG 效果好坏的关键！很多初学者直接把整篇文档丢进去，结果检索效果很差。正确的做法是 <strong>“分块 + 嵌入 + 存储”</strong> 。</p>
<h4 data-id="heading-14">步骤 1️⃣：加载文档（支持 Markdown）</h4>
<p>我们设计了一个 <code>DocumentLoader</code> 类，专门用于递归扫描 <code>docs/</code> 目录下的所有 <code>.md</code> 文件：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 递归查找所有 .md 文件</span>
<span class="hljs-built_in">findMarkdownFiles</span>(dirPath) {
  const files = <span class="hljs-selector-attr">[]</span>;
  const items = fs<span class="hljs-selector-class">.readdirSync</span>(dirPath);
  for (const item of items) {
    const itemPath = path<span class="hljs-selector-class">.join</span>(dirPath, item);
    if (fs.statSync(itemPath)<span class="hljs-selector-class">.isDirectory</span>()) {
      files<span class="hljs-selector-class">.push</span>(...this.findMarkdownFiles(itemPath)); <span class="hljs-comment">// 递归</span>
    } else if (path.extname(item) === '<span class="hljs-selector-class">.md</span>') {
      files<span class="hljs-selector-class">.push</span>(itemPath);
    }
  }
  return files;
}
</code></pre>
<p>每个文档被封装为一个 <code>Document</code> 对象，包含：</p>
<ul>
<li><code>content</code>：文件全文</li>
<li><code>metadata</code>：来源路径、文件名、加载时间等</li>
</ul>
<hr/>
<h4 data-id="heading-15">步骤 2️⃣：智能文本分割（重中之重！）</h4>
<p><strong>为什么不能整篇存？</strong><br/>
因为大模型有上下文长度限制（如 8192 tokens），而且长文本嵌入会丢失局部语义。</p>
<p>我们使用 LangChain 的 <code>RecursiveCharacterTextSplitter</code>，并<strong>针对中文做了优化</strong>：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">new</span> RecursiveCharacterTextSplitter({
  chunkSize: <span class="hljs-number">500</span>,        <span class="hljs-comment">// 每块约 500 字符</span>
  chunkOverlap: <span class="hljs-number">50</span>,      <span class="hljs-comment">// 相邻块重叠 50 字，避免断句</span>
  separators: [
    <span class="hljs-string">'\n\n'</span>,   <span class="hljs-comment">// 优先按段落切</span>
    <span class="hljs-string">'\n'</span>,
    <span class="hljs-string">'。'</span>, <span class="hljs-string">'！'</span>, <span class="hljs-string">'？'</span>,  <span class="hljs-comment">// 中文句号、感叹号、问号</span>
    <span class="hljs-string">'；'</span>, <span class="hljs-string">'，'</span>,         <span class="hljs-comment">// 分号、逗号</span>
    <span class="hljs-string">' '</span>,                <span class="hljs-comment">// 英文空格</span>
    <span class="hljs-string">''</span>                  <span class="hljs-comment">// 最后按字符切</span>
  ]
})
</code></pre>
<blockquote>
<p>🌟 <strong>效果示例</strong>：<br/>
原文：“Qwen 是阿里巴巴推出的 AI 模型。它支持多语言。”<br/>
→ 切分为两块：<br/>
块1：“Qwen 是阿里巴巴推出的 AI 模型。”<br/>
块2：“它支持多语言。”</p>
</blockquote>
<p>这样既能保持语义完整，又避免跨句切割。</p>
<hr/>
<h4 data-id="heading-16">步骤 3️⃣：向量化 &amp; 存入 Qdrant</h4>
<p>这一步由 <code>QdrantVectorStore.addDocuments()</code> 自动完成：</p>
<ol>
<li>调用 <code>embeddings.embedDocuments()</code> 生成向量</li>
<li>将 <code>[向量, 文本, 元数据]</code> 作为“点（Point）”存入 Qdrant</li>
</ol>
<p>整个过程对开发者透明，你只需传入 <code>Document[]</code> 即可。</p>
<hr/>
<h3 data-id="heading-17">五、国际化（i18n）：让系统支持中英文切换</h3>
<p>为了让项目更专业、更易用，我们加入了完整的多语言支持。</p>
<h4 data-id="heading-18">1. 技术选型：i18next + JSON 资源文件</h4>
<ul>
<li><strong>i18next</strong>：业界标准的 JS 国际化库</li>
<li><strong>JSON 文件</strong>：按语言分类存储翻译文本，结构清晰</li>
</ul>
<p>目录结构：</p>
<pre><code class="hljs language-bash" lang="bash">src/i18n/
├── index.js              <span class="hljs-comment"># 国际化管理器</span>
└── locales/
    ├── en/translation.json
    └── zh-CN/translation.json
</code></pre>
<hr/>
<h4 data-id="heading-19">2. 核心：I18nManager 单例类</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">I18nManager</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">init</span>(<span class="hljs-params">language = <span class="hljs-string">'en'</span></span>) {
    <span class="hljs-keyword">await</span> i18next.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">Backend</span>).<span class="hljs-title function_">init</span>({
      <span class="hljs-attr">lng</span>: language,
      <span class="hljs-attr">fallbackLng</span>: <span class="hljs-string">'en'</span>,
      <span class="hljs-attr">backend</span>: {
        <span class="hljs-attr">loadPath</span>: <span class="hljs-string">'./locales/{{lng}}/translation.json'</span>
      }
    });
  }

  <span class="hljs-title function_">t</span>(<span class="hljs-params">key, options = {}</span>) {
    <span class="hljs-keyword">return</span> i18next.<span class="hljs-title function_">t</span>(key, options); <span class="hljs-comment">// 如 t('messages.loading_docs', { count: 5 })</span>
  }

  <span class="hljs-title function_">getPreferredLanguage</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 1. 读取系统环境变量 LANG</span>
    <span class="hljs-comment">// 2. 自动匹配支持的语言（如 zh_CN → zh-CN）</span>
    <span class="hljs-comment">// 3. 默认回退到英文</span>
  }
}
</code></pre>
<blockquote>
<p>✅ <strong>优势</strong>：</p>
<ul>
<li>支持插值（如 <code>{{count}}</code>）</li>
<li>自动语言检测</li>
<li>未翻译时回退到英文</li>
</ul>
</blockquote>
<hr/>
<h4 data-id="heading-20">3. 翻译文件示例（zh-CN/translation.json）</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"document_loader"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"loading_all_docs"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"正在加载所有文档..."</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"loaded_doc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"已加载文档: {{path}}"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"error_loading_doc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"加载文档失败 {{path}}: {{error}}"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"text_splitter"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"splitting_docs"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"正在分割文档..."</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"split_doc"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"文档 {{path}} 已分割为 {{count}} 个块"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"vector_store"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"creating_collection"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"正在创建集合: {{name}}"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"collection_exists"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"集合 {{name}} 已存在"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"adding_batch"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"正在添加 {{count}} 个文档块..."</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h4 data-id="heading-21">4. 在代码中使用</h4>
<pre><code class="hljs language-less" lang="less"><span class="hljs-comment">// 初始化（自动检测系统语言）</span>
<span class="hljs-selector-tag">await</span> <span class="hljs-selector-tag">i18nManager</span><span class="hljs-selector-class">.init</span>(i18nManager.<span class="hljs-built_in">getPreferredLanguage</span>());

<span class="hljs-comment">// 打印日志</span>
<span class="hljs-selector-tag">console</span><span class="hljs-selector-class">.log</span>(i18nManager.<span class="hljs-built_in">t</span>(<span class="hljs-string">'vector_store.adding_batch'</span>, { <span class="hljs-attribute">count</span>: docs.length }));
</code></pre>
<h4 data-id="heading-22">5. 命令行支持语言切换</h4>
<pre><code class="hljs language-sql" lang="sql"># 默认根据系统语言自动选择
npm run <span class="hljs-keyword">start</span>

# 强制使用中文
npm run <span class="hljs-keyword">start</span> <span class="hljs-comment">-- -l zh-CN</span>

# 强制使用英文
npm run <span class="hljs-keyword">start</span> <span class="hljs-comment">-- -l en</span>
</code></pre>
<p>效果展示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f39b7f81047f4e05ab9b5d5cf0ed2c46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu95a625LiN5L-d5oqk5bqf54mp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765355605&amp;x-signature=GUyrDfQaK%2F8IVToTT1Hxn%2FXJn04%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>🌍 <strong>用户体验提升</strong>：非英语用户不再面对满屏英文报错，大大降低使用门槛。</p>
</blockquote>
<hr/>
<h3 data-id="heading-23">六、完整流程：从零初始化到交互问答</h3>
<p>整个系统启动流程如下：</p>
<ol>
<li><strong>验证配置</strong> → 2. <strong>加载文档</strong> → 3. <strong>智能分块</strong> → 4. <strong>连接 Qdrant</strong> → 5. <strong>批量向量化存储</strong></li>
</ol>

<pre><code class="hljs language-css" lang="css">graph LR
<span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[验证配置]</span> --&gt; <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[加载 docs/ 下所有 .md 文件]</span>
<span class="hljs-selector-tag">B</span> --&gt; C<span class="hljs-selector-attr">[按语义分割为小块]</span>
C --&gt; D<span class="hljs-selector-attr">[连接 Qdrant]</span>
D --&gt; E<span class="hljs-selector-attr">[生成向量并存入]</span>
E --&gt; F<span class="hljs-selector-attr">[启动交互式问答]</span>
</code></pre>
<p>在问答阶段，用户输入问题后：</p>
<ul>
<li>系统将问题向量化</li>
<li>在 Qdrant 中检索 Top-K 相似块</li>
<li>将结果 + 原始问题交给 LLM 生成答案</li>
<li>返回答案 + 来源引用（含相似度分数）</li>
</ul>
<hr/>
<h3 data-id="heading-24">总结</h3>
<p>本文我们完成了 RAG 系统的三大核心模块：</p>
<p>✅ <strong>向量数据库搭建</strong>：通过 Docker 快速部署 Qdrant，兼顾性能与便捷性<br/>
✅ <strong>文档智能处理</strong>：从加载、中文友好分块到向量化，确保检索质量<br/>
✅ <strong>多语言支持</strong>：基于 i18next 实现中英文无缝切换，提升可用性</p>
<p>这些工作为后续的 <strong>Agent 决策、Prompt 优化、评估指标</strong> 等高级功能打下了坚实基础。（如果想看完整代码可到开头展示的代码仓库中查看，里面包含rag调用的完整代码）</p>
<blockquote>
<p>📌 <strong>下期预告</strong>：我们将使用rag去做一个法律检索的专业ai问答助手，使用爬虫技术去完善我们的数据库，采用流式输出去展示我们的代码，将后端rag技术与前端页面结合起来。</p>
</blockquote>
<hr/>
<p><strong>附：常见问题</strong></p>
<p>❓<strong>Q：为什么不用 FAISS？</strong><br/>
→ FAISS 是纯向量库，无持久化、无过滤、无 API，适合实验；Qdrant 是完整数据库，适合产品。</p>
<p>❓<strong>Q：分块大小怎么选？</strong><br/>
→ 中文建议 300–800 字符，英文 200–500 tokens。可通过 <code>CHUNK_SIZE</code> 配置调整。</p>
<p>❓<strong>Q：Qwen 的 embedding 维度是多少？</strong><br/>
→ <code>text-embedding-v2</code> 输出 <strong>1536 维</strong>，务必在 <code>config.EMBEDDING_DIMENSION</code> 中正确设置！</p>
<hr/>
<p>希望这篇文章能帮你少走弯路，快速搭建出自己的 RAG 系统！欢迎点赞、收藏、评论交流 👇 ```</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【文件管理系列】001：文件批量重命名工具]]></title>    <link>https://juejin.cn/post/7579321624013996072</link>    <guid>https://juejin.cn/post/7579321624013996072</guid>    <pubDate>2025-12-03T08:20:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579321624013996072" data-draft-id="7579313396206993423" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【文件管理系列】001：文件批量重命名工具"/> <meta itemprop="keywords" content="后端,Shell"/> <meta itemprop="datePublished" content="2025-12-03T08:20:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="零日失眠者"/> <meta itemprop="url" content="https://juejin.cn/user/3411111810444068"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【文件管理系列】001：文件批量重命名工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3411111810444068/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    零日失眠者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T08:20:45.000Z" title="Wed Dec 03 2025 08:20:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">简介</h2>
<p>在日常工作中，我们经常需要对大量文件进行重命名操作，特别是在整理照片、文档或其他媒体文件时。手动一个个重命名不仅耗时，还容易出错。本文将介绍一个实用的Python脚本——文件批量重命名工具，它可以大大提高我们的工作效率。</p>
<h2 data-id="heading-1">功能介绍</h2>
<p>这个文件批量重命名工具具有以下核心功能：</p>
<ol>
<li><strong>批量重命名</strong>：可以同时对多个文件按照指定规则进行重命名</li>
<li><strong>多种命名模式</strong>：支持序号命名、前缀命名、后缀命名等多种模式</li>
<li><strong>文件过滤</strong>：可以根据文件扩展名、文件名特征等条件筛选文件</li>
<li><strong>预览功能</strong>：在实际执行前可以预览重命名结果</li>
<li><strong>撤销功能</strong>：支持操作撤销，防止误操作</li>
<li><strong>日志记录</strong>：记录所有操作历史，便于追踪和审计</li>
</ol>
<h2 data-id="heading-2">应用场景</h2>
<p>这个工具适用于以下场景：</p>
<ol>
<li><strong>照片整理</strong>：将相机拍摄的照片按日期或序号统一命名</li>
<li><strong>文档管理</strong>：对公司或个人文档进行规范化命名</li>
<li><strong>下载文件整理</strong>：对下载的文件进行批量重命名以提高可读性</li>
<li><strong>开发项目</strong>：对代码文件或资源文件进行统一命名规范</li>
<li><strong>学术研究</strong>：对实验数据文件进行有序命名</li>
</ol>
<h2 data-id="heading-3">报错处理</h2>
<p>脚本包含了完善的错误处理机制：</p>
<ol>
<li><strong>路径不存在</strong>：检查指定目录是否存在，若不存在则提示用户</li>
<li><strong>权限不足</strong>：检测文件操作权限，权限不足时给出明确提示</li>
<li><strong>文件冲突</strong>：检测目标文件名是否已存在，避免覆盖重要文件</li>
<li><strong>参数验证</strong>：验证用户输入的参数是否合法</li>
<li><strong>异常捕获</strong>：捕获并处理运行过程中可能出现的各种异常</li>
</ol>
<h2 data-id="heading-4">代码实现</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> argparse
<span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime

<span class="hljs-keyword">class</span> <span class="hljs-title class_">FileBatchRenamer</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, directory</span>):
        self.directory = directory
        self.rename_log = []
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">check_directory</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""检查目录是否存在"""</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.exists(self.directory):
            <span class="hljs-keyword">raise</span> FileNotFoundError(<span class="hljs-string">f"目录 '<span class="hljs-subst">{self.directory}</span>' 不存在"</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> os.path.isdir(self.directory):
            <span class="hljs-keyword">raise</span> NotADirectoryError(<span class="hljs-string">f"'<span class="hljs-subst">{self.directory}</span>' 不是一个有效的目录"</span>)
            
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_files</span>(<span class="hljs-params">self, extension=<span class="hljs-literal">None</span>, pattern=<span class="hljs-literal">None</span></span>):
        <span class="hljs-string">"""获取符合条件的文件列表"""</span>
        <span class="hljs-keyword">try</span>:
            self.check_directory()
            files = os.listdir(self.directory)
            filtered_files = []
            
            <span class="hljs-keyword">for</span> file <span class="hljs-keyword">in</span> files:
                file_path = os.path.join(self.directory, file)
                <span class="hljs-comment"># 只处理文件，不处理子目录</span>
                <span class="hljs-keyword">if</span> os.path.isfile(file_path):
                    <span class="hljs-comment"># 根据扩展名过滤</span>
                    <span class="hljs-keyword">if</span> extension <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> file.endswith(extension):
                        <span class="hljs-keyword">continue</span>
                    <span class="hljs-comment"># 根据模式过滤</span>
                    <span class="hljs-keyword">if</span> pattern <span class="hljs-keyword">and</span> pattern <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> file:
                        <span class="hljs-keyword">continue</span>
                    filtered_files.append(file)
                    
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">sorted</span>(filtered_files)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"获取文件列表时出错: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-keyword">return</span> []
            
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">preview_rename</span>(<span class="hljs-params">self, files, naming_pattern, start_number=<span class="hljs-number">1</span></span>):
        <span class="hljs-string">"""预览重命名结果"""</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n重命名预览:"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span> * <span class="hljs-number">50</span>)
        rename_map = {}
        
        <span class="hljs-keyword">for</span> i, filename <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(files, start_number):
            name, ext = os.path.splitext(filename)
            new_name = naming_pattern.<span class="hljs-built_in">format</span>(i) + ext
            rename_map[filename] = new_name
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{filename}</span> -&gt; <span class="hljs-subst">{new_name}</span>"</span>)
            
        <span class="hljs-keyword">return</span> rename_map
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">execute_rename</span>(<span class="hljs-params">self, rename_map</span>):
        <span class="hljs-string">"""执行重命名操作"""</span>
        success_count = <span class="hljs-number">0</span>
        error_count = <span class="hljs-number">0</span>
        
        <span class="hljs-keyword">for</span> old_name, new_name <span class="hljs-keyword">in</span> rename_map.items():
            old_path = os.path.join(self.directory, old_name)
            new_path = os.path.join(self.directory, new_name)
            
            <span class="hljs-comment"># 检查目标文件是否已存在</span>
            <span class="hljs-keyword">if</span> os.path.exists(new_path):
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"警告: 文件 '<span class="hljs-subst">{new_name}</span>' 已存在，跳过 '<span class="hljs-subst">{old_name}</span>'"</span>)
                error_count += <span class="hljs-number">1</span>
                <span class="hljs-keyword">continue</span>
                
            <span class="hljs-keyword">try</span>:
                os.rename(old_path, new_path)
                self.rename_log.append((datetime.now(), old_name, new_name))
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"成功重命名: <span class="hljs-subst">{old_name}</span> -&gt; <span class="hljs-subst">{new_name}</span>"</span>)
                success_count += <span class="hljs-number">1</span>
            <span class="hljs-keyword">except</span> PermissionError:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"权限错误: 无法重命名 '<span class="hljs-subst">{old_name}</span>'，请检查文件权限"</span>)
                error_count += <span class="hljs-number">1</span>
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"重命名 '<span class="hljs-subst">{old_name}</span>' 时出错: <span class="hljs-subst">{e}</span>"</span>)
                error_count += <span class="hljs-number">1</span>
                
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n重命名完成! 成功: <span class="hljs-subst">{success_count}</span>, 失败: <span class="hljs-subst">{error_count}</span>"</span>)
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">save_log</span>(<span class="hljs-params">self, log_file=<span class="hljs-string">"rename_log.txt"</span></span>):
        <span class="hljs-string">"""保存操作日志"""</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(os.path.join(self.directory, log_file), <span class="hljs-string">"w"</span>, encoding=<span class="hljs-string">"utf-8"</span>) <span class="hljs-keyword">as</span> f:
                f.write(<span class="hljs-string">"文件批量重命名操作日志\n"</span>)
                f.write(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span> + <span class="hljs-string">"\n"</span>)
                f.write(<span class="hljs-string">f"操作时间: <span class="hljs-subst">{datetime.now().strftime(<span class="hljs-string">'%Y-%m-%d %H:%M:%S'</span>)}</span>\n"</span>)
                f.write(<span class="hljs-string">f"操作目录: <span class="hljs-subst">{self.directory}</span>\n\n"</span>)
                
                <span class="hljs-keyword">for</span> timestamp, old_name, new_name <span class="hljs-keyword">in</span> self.rename_log:
                    f.write(<span class="hljs-string">f"[<span class="hljs-subst">{timestamp.strftime(<span class="hljs-string">'%H:%M:%S'</span>)}</span>] <span class="hljs-subst">{old_name}</span> -&gt; <span class="hljs-subst">{new_name}</span>\n"</span>)
                    
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"操作日志已保存到: <span class="hljs-subst">{log_file}</span>"</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"保存日志时出错: <span class="hljs-subst">{e}</span>"</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    parser = argparse.ArgumentParser(description=<span class="hljs-string">"文件批量重命名工具"</span>)
    parser.add_argument(<span class="hljs-string">"directory"</span>, <span class="hljs-built_in">help</span>=<span class="hljs-string">"要处理的目录路径"</span>)
    parser.add_argument(<span class="hljs-string">"-p"</span>, <span class="hljs-string">"--pattern"</span>, default=<span class="hljs-string">"file_{:03d}"</span>, 
                       <span class="hljs-built_in">help</span>=<span class="hljs-string">"命名模式，使用 {:03d} 表示序号 (默认: file_{:03d})"</span>)
    parser.add_argument(<span class="hljs-string">"-s"</span>, <span class="hljs-string">"--start"</span>, <span class="hljs-built_in">type</span>=<span class="hljs-built_in">int</span>, default=<span class="hljs-number">1</span>, 
                       <span class="hljs-built_in">help</span>=<span class="hljs-string">"起始序号 (默认: 1)"</span>)
    parser.add_argument(<span class="hljs-string">"-e"</span>, <span class="hljs-string">"--extension"</span>, 
                       <span class="hljs-built_in">help</span>=<span class="hljs-string">"文件扩展名过滤 (例如: .jpg)"</span>)
    parser.add_argument(<span class="hljs-string">"--preview"</span>, action=<span class="hljs-string">"store_true"</span>, 
                       <span class="hljs-built_in">help</span>=<span class="hljs-string">"仅预览，不执行实际重命名"</span>)
    
    args = parser.parse_args()
    
    <span class="hljs-keyword">try</span>:
        renamer = FileBatchRenamer(args.directory)
        files = renamer.get_files(extension=args.extension)
        
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> files:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"未找到符合条件的文件"</span>)
            <span class="hljs-keyword">return</span>
            
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"找到 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(files)}</span> 个文件"</span>)
        
        rename_map = renamer.preview_rename(files, args.pattern, args.start)
        
        <span class="hljs-keyword">if</span> args.preview:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n预览模式，未执行实际重命名操作"</span>)
            <span class="hljs-keyword">return</span>
            
        confirm = <span class="hljs-built_in">input</span>(<span class="hljs-string">"\n确认执行重命名操作? (y/N): "</span>)
        <span class="hljs-keyword">if</span> confirm.lower() == <span class="hljs-string">'y'</span>:
            renamer.execute_rename(rename_map)
            renamer.save_log()
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"操作已取消"</span>)
            
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"程序执行出错: <span class="hljs-subst">{e}</span>"</span>)
        sys.exit(<span class="hljs-number">1</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    main()
</code></pre>
<h2 data-id="heading-5">使用方法</h2>
<h3 data-id="heading-6">基本使用</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 基本用法，对目录中的所有文件按默认模式重命名</span>
python batch_renamer.py /path/to/directory

<span class="hljs-comment"># 指定命名模式</span>
python batch_renamer.py /path/to/directory -p <span class="hljs-string">"photo_{:04d}"</span>

<span class="hljs-comment"># 指定起始序号</span>
python batch_renamer.py /path/to/directory -s 100

<span class="hljs-comment"># 只处理特定扩展名的文件</span>
python batch_renamer.py /path/to/directory -e .jpg

<span class="hljs-comment"># 预览模式（不实际执行重命名）</span>
python batch_renamer.py /path/to/directory --preview
</code></pre>
<h3 data-id="heading-7">命令行参数说明</h3>
<ul>
<li><code>directory</code>: 必需参数，指定要处理的目录路径</li>
<li><code>-p, --pattern</code>: 命名模式，默认为 <code>file_{:03d}</code>，其中 <code>{:03d}</code> 会被替换为序号</li>
<li><code>-s, --start</code>: 起始序号，默认为 1</li>
<li><code>-e, --extension</code>: 文件扩展名过滤器，只处理指定扩展名的文件</li>
<li><code>--preview</code>: 预览模式，只显示重命名结果，不执行实际操作</li>
</ul>
<h3 data-id="heading-8">使用示例</h3>
<p>假设有以下文件：</p>
<pre><code class="hljs language-javascript" lang="javascript">image1.<span class="hljs-property">jpg</span>
image2.<span class="hljs-property">jpg</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-property">pdf</span>
photo.<span class="hljs-property">png</span>
</code></pre>
<p>执行命令：</p>
<pre><code class="hljs language-bash" lang="bash">python batch_renamer.py ./test_dir -p <span class="hljs-string">"pic_{:02d}"</span> -e .jpg
</code></pre>
<p>结果：</p>
<pre><code class="hljs language-javascript" lang="javascript">pic_01.<span class="hljs-property">jpg</span>
pic_02.<span class="hljs-property">jpg</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-property">pdf</span>
photo.<span class="hljs-property">png</span>
</code></pre>
<h2 data-id="heading-9">总结</h2>
<p>这个文件批量重命名工具通过简单的命令行界面提供了强大的批量文件重命名功能。它具有良好的错误处理机制，可以有效防止误操作，并通过日志记录功能保证操作的可追溯性。无论是日常文件整理还是专业项目管理，这个工具都能显著提高工作效率。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vxe-table 使用 spanMethod 合并卡顿的解决方案]]></title>    <link>https://juejin.cn/post/7579255046979747866</link>    <guid>https://juejin.cn/post/7579255046979747866</guid>    <pubDate>2025-12-03T08:41:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579255046979747866" data-draft-id="7579440586693656622" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vxe-table 使用 spanMethod 合并卡顿的解决方案"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-12-03T08:41:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户84179481456"/> <meta itemprop="url" content="https://juejin.cn/user/3921272428567529"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vxe-table 使用 spanMethod 合并卡顿的解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3921272428567529/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户84179481456
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T08:41:06.000Z" title="Wed Dec 03 2025 08:41:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>vxe-table 使用 spanMethod 合并卡顿的解决方案，当业务需求需要合并时，由于表格数据有几千条，使用该合并后不支持虚拟滚动会卡顿。通过查看官网，发现应该使用 merge-cells 来合并单元格，不仅使用非常简单，还支持虚拟滚动，只需要指定行号和列号，合并数量就可以临时合并单元格，需要注意，官网说明是临时合并。也就是合并后如果不重新更新列或者重新加载数据，是没问题的，但是需要需要重新加载数据，那么临时合并就会丢失，需要重新赋值一下 merge-cells 就可以重新临时合并了。</p>
<p>查看官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fvxetable.cn" target="_blank" title="https://vxetable.cn" ref="nofollow noopener noreferrer">vxetable.cn</a>
gitbub：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fx-extends%2Fvxe-table" target="_blank" title="https://github.com/x-extends/vxe-table" ref="nofollow noopener noreferrer">github.com/x-extends/v…</a>
gitee：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fx-extends%2Fvxe-table" target="_blank" title="https://gitee.com/x-extends/vxe-table" ref="nofollow noopener noreferrer">gitee.com/x-extends/v…</a></p>
<h2 data-id="heading-0">效果</h2>
<p>以下通过使用一个比较复杂的场景，包括100列*500行，带左右冻结列和表尾合计，渲染就比较复杂了。测试了一下 5万行和5千列 都比较流畅，比之前流畅太多倍了.</p>
<p>避免合并一整行或一整列，当所有行都被合并为一个单元格时就等同于关闭纵向虚拟滚动，当所有列都被合并为一个单元格时就等同于关闭横向虚拟滚动。应该避免合并范围过大的使用场景.</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/258dbaa4ba88406695df56577f5e7f43~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODQxNzk0ODE0NTY=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765356066&amp;x-signature=DVhSVmikMve61x%2B04fil7nXD4D8%3D" alt="Video_2025-12-02_105507-ezgif.com-optimize.gif" loading="lazy"/></p>
<h2 data-id="heading-1">代码</h2>
<p>有几点需要注意：
如果使用 merge-cells 方式则是全功能的，支持虚拟滚动；
如果使用 span-method 方式的虚拟滚动支持部分功能，存在功能限制：如果进行跨行合并，则不支持纵向虚拟滚动；如果进行跨列合并，则不支持横向虚拟滚动</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">vxe-grid</span> <span class="hljs-attr">v-bind</span>=<span class="hljs-string">"gridOptions"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">vxe-grid</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> gridOptions = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">border</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">showOverflow</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">showHeaderOverflow</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">showFooterOverflow</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">showFooter</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">height</span>: <span class="hljs-number">600</span>,
  <span class="hljs-attr">virtualYConfig</span>: {
    <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">gt</span>: <span class="hljs-number">0</span>
  },
  <span class="hljs-attr">virtualXConfig</span>: {
    <span class="hljs-attr">enabled</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">gt</span>: <span class="hljs-number">0</span>
  },
  <span class="hljs-attr">mergeCells</span>: [
    { <span class="hljs-attr">row</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">col</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">rowspan</span>: <span class="hljs-number">4</span>, <span class="hljs-attr">colspan</span>: <span class="hljs-number">2</span> },
    { <span class="hljs-attr">row</span>: <span class="hljs-number">16</span>, <span class="hljs-attr">col</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">rowspan</span>: <span class="hljs-number">12</span>, <span class="hljs-attr">colspan</span>: <span class="hljs-number">3</span> },
    { <span class="hljs-attr">row</span>: <span class="hljs-number">30</span>, <span class="hljs-attr">col</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">rowspan</span>: <span class="hljs-number">5</span>, <span class="hljs-attr">colspan</span>: <span class="hljs-number">2</span> },
    { <span class="hljs-attr">row</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">col</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">rowspan</span>: <span class="hljs-number">18</span>, <span class="hljs-attr">colspan</span>: <span class="hljs-number">3</span> },
    { <span class="hljs-attr">row</span>: <span class="hljs-number">150</span>, <span class="hljs-attr">col</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">rowspan</span>: <span class="hljs-number">8</span>, <span class="hljs-attr">colspan</span>: <span class="hljs-number">2</span> }
  ],
  <span class="hljs-attr">mergeFooterItems</span>: [
    { <span class="hljs-attr">row</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">col</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">rowspan</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">colspan</span>: <span class="hljs-number">1</span> }
  ],
  <span class="hljs-attr">columns</span>: [
    { <span class="hljs-attr">field</span>: <span class="hljs-string">'seq'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'seq'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">70</span>, <span class="hljs-attr">fixed</span>: <span class="hljs-string">'left'</span> },
    { <span class="hljs-attr">field</span>: <span class="hljs-string">'name'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'Name'</span>, <span class="hljs-attr">minWidth</span>: <span class="hljs-number">300</span> },
    {
      <span class="hljs-attr">title</span>: <span class="hljs-string">'分组1'</span>,
      <span class="hljs-attr">children</span>: [
        { <span class="hljs-attr">field</span>: <span class="hljs-string">'role'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'Role'</span>, <span class="hljs-attr">minWidth</span>: <span class="hljs-number">300</span> },
        { <span class="hljs-attr">field</span>: <span class="hljs-string">'sex'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'Sex'</span>, <span class="hljs-attr">minWidth</span>: <span class="hljs-number">300</span> },
        { <span class="hljs-attr">field</span>: <span class="hljs-string">'age'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'Age'</span>, <span class="hljs-attr">minWidth</span>: <span class="hljs-number">300</span> }
      ]
    },
    {
      <span class="hljs-attr">title</span>: <span class="hljs-string">'分组2'</span>,
      <span class="hljs-attr">children</span>: [
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列3'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col3'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">200</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列4'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col4'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">140</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列5'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col5'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">300</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列6'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col6'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">160</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列7'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col7'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">120</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列8'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col8'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">400</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列9'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col9'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">160</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列10'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col10'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">160</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列11'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col11'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">180</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列12'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col12'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">160</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列13'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col13'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">80</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列14'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col14'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">120</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列15'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col15'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">360</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列16'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col16'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">150</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列17'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col17'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">380</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列18'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col18'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">100</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列19'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col19'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">290</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列20'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col20'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">80</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列21'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col21'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">100</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列22'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col22'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">120</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列23'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col23'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">270</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列24'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col24'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">330</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列25'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col25'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">460</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列26'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col26'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">280</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列27'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col27'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">220</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列28'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col28'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">120</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列29'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col29'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">180</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列30'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col30'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">500</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列31'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col31'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">600</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列32'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col32'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">100</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列33'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col33'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">490</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列34'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col34'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">100</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列35'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col35'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">150</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列36'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col36'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">800</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列37'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col37'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">400</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列38'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col38'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">800</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列39'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col39'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">360</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列40'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col40'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">420</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列41'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col41'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">100</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列42'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col42'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">120</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列43'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col43'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">280</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列44'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col44'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">170</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列45'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col45'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">370</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列46'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col46'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">420</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列47'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col47'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">170</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列48'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col48'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">400</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列49'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col49'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">220</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列50'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col50'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">170</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列51'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col51'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">160</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列52'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col52'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">500</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列53'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col53'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">280</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列54'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col54'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">170</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列55'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col55'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">370</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列56'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col56'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">120</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列57'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col57'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">170</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列58'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col58'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">400</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列59'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col59'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">220</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列60'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col60'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">650</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列61'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col61'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">600</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列62'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col62'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">100</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列63'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col63'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">490</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列64'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col64'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">100</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列65'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col65'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">150</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列66'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col66'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">800</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列67'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col67'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">400</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列68'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col68'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">800</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列69'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col69'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">360</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列70'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col70'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">650</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列71'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col71'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">600</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列72'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col72'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">100</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列73'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col73'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">490</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列74'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col74'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">100</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列75'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col75'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">150</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列76'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col76'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">800</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列77'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col77'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">400</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列78'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col78'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">800</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列79'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col79'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">360</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列80'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col80'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">650</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列81'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col81'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">600</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列82'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col82'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">100</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列83'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col83'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">490</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列84'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col84'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">100</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列85'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col85'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">150</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列86'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col86'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">800</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列87'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col87'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">400</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列88'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col88'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">800</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列89'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col89'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">360</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列90'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col90'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">650</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列91'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col91'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">600</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列92'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col92'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">100</span> },
        { <span class="hljs-attr">title</span>: <span class="hljs-string">'列93'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col93'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">490</span> }
      ]
    },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'列94'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col94'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">100</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'列95'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col95'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">150</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'列96'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col96'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">800</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'列97'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col97'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">100</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'列98'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col98'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">150</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'列99'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col99'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">200</span> },
    { <span class="hljs-attr">title</span>: <span class="hljs-string">'列100'</span>, <span class="hljs-attr">field</span>: <span class="hljs-string">'col100'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">fixed</span>: <span class="hljs-string">'right'</span> }
  ],
  <span class="hljs-attr">data</span>: [],
  <span class="hljs-attr">footerData</span>: [
    { <span class="hljs-attr">seq</span>: <span class="hljs-string">'合计'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'666'</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">'888'</span>, <span class="hljs-attr">sex</span>: <span class="hljs-string">'999'</span>, <span class="hljs-attr">age</span>: <span class="hljs-string">'234'</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'453'</span> },
    { <span class="hljs-attr">seq</span>: <span class="hljs-string">'均值'</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'222'</span>, <span class="hljs-attr">role</span>: <span class="hljs-string">'333'</span>, <span class="hljs-attr">sex</span>: <span class="hljs-string">'777'</span>, <span class="hljs-attr">age</span>: <span class="hljs-string">'876'</span>, <span class="hljs-attr">address</span>: <span class="hljs-string">'134'</span> }
  ]
})
<span class="hljs-comment">// 模拟行数据</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">loadList</span> = (<span class="hljs-params">size = <span class="hljs-number">200</span></span>) =&gt; {
  <span class="hljs-keyword">const</span> dataList = []
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; size; i++) {
    dataList.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">id</span>: <span class="hljs-number">10000</span> + i,
      <span class="hljs-attr">name</span>: <span class="hljs-string">'Test'</span> + i,
      <span class="hljs-attr">role</span>: i % <span class="hljs-number">3</span> ? <span class="hljs-string">'Developer'</span> : <span class="hljs-string">' DeveloperDeveloper DeveloperDeveloper DeveloperDeveloper DeveloperDeveloper DeveloperDeveloper'</span>,
      <span class="hljs-attr">sex</span>: <span class="hljs-string">'男'</span>,
      <span class="hljs-attr">age</span>: <span class="hljs-number">20</span>,
      <span class="hljs-attr">address</span>: <span class="hljs-string">'Address abc'</span>,
      <span class="hljs-attr">col90</span>: <span class="hljs-string">'90-'</span> + i,
      <span class="hljs-attr">col91</span>: <span class="hljs-string">'91-'</span> + i,
      <span class="hljs-attr">col92</span>: <span class="hljs-string">'92-'</span> + i,
      <span class="hljs-attr">col93</span>: <span class="hljs-string">'93-'</span> + i,
      <span class="hljs-attr">col94</span>: <span class="hljs-string">'94-'</span> + i,
      <span class="hljs-attr">col95</span>: <span class="hljs-string">'95-'</span> + i,
      <span class="hljs-attr">col96</span>: <span class="hljs-string">'96-'</span> + i,
      <span class="hljs-attr">col97</span>: <span class="hljs-string">'97-'</span> + i,
      <span class="hljs-attr">col98</span>: <span class="hljs-string">'98-'</span> + i,
      <span class="hljs-attr">col99</span>: <span class="hljs-string">'99-'</span> + i,
      <span class="hljs-attr">col100</span>: <span class="hljs-string">'100-'</span> + i
    })
  }
  gridOptions.<span class="hljs-property">data</span> = dataList
}

<span class="hljs-title function_">loadList</span>(<span class="hljs-number">500</span>)
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fx-extends%2Fvxe-table" target="_blank" title="https://gitee.com/x-extends/vxe-table" ref="nofollow noopener noreferrer">gitee.com/x-extends/v…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025 SECon × AgentX 大会：AI 原生应用架构专场精彩回顾 & PPT 下载]]></title>    <link>https://juejin.cn/post/7579453456017260585</link>    <guid>https://juejin.cn/post/7579453456017260585</guid>    <pubDate>2025-12-03T08:42:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579453456017260585" data-draft-id="7579213860572381238" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025 SECon × AgentX 大会：AI 原生应用架构专场精彩回顾 &amp; PPT 下载"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2025-12-03T08:42:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025 SECon × AgentX 大会：AI 原生应用架构专场精彩回顾 &amp; PPT 下载
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T08:42:22.000Z" title="Wed Dec 03 2025 08:42:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：盈楹</p>
<p>近日，2025 SECon × AgentX大会——AI 原生应用架构专场圆满落幕，本次专场阿里云联合信通院共同出品，现场吸引了 80+ 名技术从业者深度参与。</p>
<p>活动聚焦 AI 时代软件架构的核心命题，深度分享了 AI 原生应用架构趋势与实践、AgentScope 开发框架、AI 开放平台、大模型可观测 &amp; AIOps 等热门技术议题，探讨从基础设施到应用层的协同演进策略与工程实践。</p>
<p>关注「阿里云云原生」公众号，后台回复：1125</p>
<p>免费获得活动讲师 PPT 合辑</p>
<h2 data-id="heading-0">精彩回顾</h2>
<h3 data-id="heading-1">议题一：AI 原生应用架构探索与实践丨肖京(亦盏)   阿里云智能云原生高级技术专家</h3>
<p>当前大模型已迈过技术拐点，Agentic AI 进入规模化落地阶段。AI 原生应用以模型为基础、Agent 为驱动、数据为中心，推动系统从“机器执行”向“机器思考+执行”演进。框架选型需平衡 Agentic 自主性与业务确定性，Agent 面临开发效率、业务效果，以及稳定、性能、成本、安全的挑战。实践上建议构建以数据为核心的 Agent 平台，结合 MCP/A2A 标准与 Serverless 架构，通过 AI 网关、消息队列、可观测等提升安全性、稳定性与可维护性，实现智能化人机协作新范式。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea152df061df4e339245bc2856ea732d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765356142&amp;x-signature=jY5DmIePKyEhkFFgtGJntTGhRBY%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-2">议题二：开发更可控，部署更便捷：AgentScope 迈入 1.0 时代丨邝炜瑞  阿里巴巴集团通义实验室 高级算法工程师</h3>
<p>深度分享了阿里通义实验室开源的 AgentScope 智能体开发框架 1.0 版本。核心内容包括：基于 ReAct 范式的多智能体系统支持，提供结构化输出、工具调用与长期记忆等能力；采用三层架构——开发框架层、可视化调试平台与安全运行时环境，结合工具沙箱与元工具机制，全面提升系统的可控性、可观测性与部署安全性。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4fa960187303425ab4b75c45eba2a315~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765356142&amp;x-signature=sC5gQdpPus3neRelbmjRnkNxZAo%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-3">议题三：AI 网关：AI 原生架构下的智能流量中枢丨 赵炳堃(秉钧)   阿里云智能云原生高级开发工程师</h3>
<p>聚焦 AI 网关在 AI 原生架构中的核心作用，重点介绍 Higress AI 网关的关键能力：支持多模型适配、协议转换与语义缓存，提供 Token 限流、Fallback 机制保障高可用；通过 API-Key 管理、PII 脱敏、WASM 沙箱等实现安全可控；并借助 MCPServer 统一代理提升集成效率。HiMarket 平台则助力企业构建私有 Agent 市场，推动 AI 能力的安全规模化落地。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f6a2162c2a04687b59e1f9422c32e10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765356142&amp;x-signature=hqekz6Jlpn8TxEWekzbyHf3kefg%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-4">议题四：从可观测到 RL：打造生产级可靠的长周期 Agent丨马云雷  阿里云智能云原生技术专家</h3>
<p>聚焦 AI-Native 应用中长周期 Agent 的可靠性建设，提出以可观测性为基础，通过 OpenTelemetry、Prometheus 等工具实现全栈监控，做到“可见、可调、可审”。引入 LLM Judger 作为自动化评估裁判，结合数据工程与模型蒸馏，构建快慢反馈闭环。最终形成从问题发现、根因分析到自我强化的进化系统，推动 Agent 向高可靠、自演进的生产级应用发展。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ad061b319a149d48f32fca63cf20d79~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765356142&amp;x-signature=x9x%2BPT7fAq1zLE6Tyd9cpCHXDiY%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-5">现场精彩瞬间</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e70dd5c0e9a8469ca6c5d29ad53c3e55~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765356142&amp;x-signature=NKOGl9Ul7FXv9U3uoo6YG17d9X8%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/064da6f1678c432c9a82dfe639aa6083~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765356142&amp;x-signature=ceeq4eP7VxrfkEQlFkcYR4mMzLQ%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/38056102f55f4342869e064202875dce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765356142&amp;x-signature=cFiiUZ3dOEoI%2BuGLJkk1%2Fhk%2F1RE%3D" alt="图片" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Let’s Encrypt 证书有效期将缩至 45 天，运维天都塌了]]></title>    <link>https://juejin.cn/post/7579410911057412122</link>    <guid>https://juejin.cn/post/7579410911057412122</guid>    <pubDate>2025-12-03T08:45:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579410911057412122" data-draft-id="7579440586693673006" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Let’s Encrypt 证书有效期将缩至 45 天，运维天都塌了"/> <meta itemprop="keywords" content="HTTPS,运维,自动化运维"/> <meta itemprop="datePublished" content="2025-12-03T08:45:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="该用户已不存在"/> <meta itemprop="url" content="https://juejin.cn/user/64217584778579"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Let’s Encrypt 证书有效期将缩至 45 天，运维天都塌了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/64217584778579/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    该用户已不存在
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-03T08:45:31.000Z" title="Wed Dec 03 2025 08:45:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-03
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>近日，<a href="https://link.juejin.cn?target=https%3A%2F%2Fletsencrypt.org%2F2025%2F12%2F02%2Ffrom-90-to-45" target="_blank" title="https://letsencrypt.org/2025/12/02/from-90-to-45" ref="nofollow noopener noreferrer">Let’s Encrypt 官方正式发布公告</a>，为了符合 CA/浏览器论坛（CA/Browser Forum）的最新基准要求，并将互联网安全性推向新高度，将逐步缩短其签发的 TLS/SSL 证书有效期。</p>
<p>目前的 90 天有效期，将在未来几年内逐步减半。<strong>到 2028 年，免费证书有效期将仅剩 45 天。</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/522cd71c9067446eac6543bc3a95ef73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765356495&amp;x-signature=%2B5RhWXT2xAVccTN3iCOVIU8NTvU%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-0">为什么要缩短有效期？</h3>
<p>这并非 Let’s Encrypt 一家的决定，而是整个行业的趋势。官方给出了3个<del>借口</del>理由</p>
<ol>
<li>
<p><strong>安全性提升：</strong> 缩短证书有效期可以限制密钥泄露后的影响范围。如果私钥被盗，较短的有效期让攻击者利用该密钥的时间窗口更短。</p>
</li>
<li>
<p><strong>提高吊销效率：</strong> 更短的生命周期让证书吊销技术（Certificate Revocation）更有效率，同时也迫使自动化流程更加健壮。</p>
</li>
<li>
<p><strong>行业合规：</strong> 这是所有公共信任的证书颁发机构（CA）都必须遵循的技术要求变化。</p>
</li>
</ol>
<h3 data-id="heading-1">关键时间轴</h3>
<p>为了让运维人员适应这些变化，Let’s Encrypt 给制定了详细的计划（Staging 环境会提前一个月生效）。</p>
<ul>
<li>
<p><strong>2026 年 5 月 13 日：</strong> <code>tlsserver</code> 配置文件率先切换至 45 天有效期（用于测试）。</p>
</li>
<li>
<p><strong>2027 年 2 月 10 日：</strong> 默认证书有效期缩短至 64 天。域名验证的「授权复用期」缩短至 10 天。</p>
</li>
<li>
<p><strong>2028 年 2 月 16 日：</strong> 默认证书有效期全面缩短至 45 天。「授权复用期」大幅缩短至 7 小时。</p>
</li>
</ul>
<h3 data-id="heading-2">苦逼的运维何处何从？</h3>
<p>如果你的证书是全自动续期的，大部分用户可能不需要做太多改动，但为了避免未来可能会遭遇服务中断，还是需要仔细地检查。</p>
<h4 data-id="heading-3"><strong>检查续期频率</strong></h4>
<p>很多旧的自动化脚本或 Cron Job 是硬编码的。例如，如果设置每 60 天运行一次 <code>certbot renew</code>，那么在 2028 年（甚至 2027 年），你的证书在续期前就已经过期了。</p>
<p><strong>建议：</strong> 确保你的 ACME 客户端支持在证书生命周期的 <strong>2/3</strong> 处进行续期（即 45 天证书应在第 30 天左右续期）。</p>
<h4 data-id="heading-4"><strong>启用 ARI（ACME Renewal Information）</strong></h4>
<p>Let’s Encrypt 推荐使用支持 ARI 的客户端。ARI 是一项新功能，能让服务器告知客户端「最佳的续期时间」，而不是依赖客户端自己猜测，这能有效避免续期拥堵和失败。</p>
<h4 data-id="heading-5"><strong>别再手动续期了</strong></h4>
<p>如果你的网站还在靠人工手动上传证书，这次变革将是噩梦。随着有效期缩短，手动操作的频率将翻倍，出错概率也会增加。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f028a4c5cc84f9db360102498d1cd8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765356495&amp;x-signature=1zLDyO2iGc89Wlwr08thTI8nqxE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">新的 DNS 验证方式来了</h3>
<p>好消息是，Let’s Encrypt 正与 IETF 和 CA/浏览器论坛合作，推动一种新的验证标准：<strong>DNS-PERSIST-01</strong>。</p>
<ul>
<li>
<p>目前的 DNS-01 验证需要 ACME 客户端有权限动态修改 DNS 记录（添加 TXT 记录），这通常需要给脚本开放敏感的 API 权限，存在安全隐患，且依赖 DNS 服务商的 API 稳定性。</p>
</li>
<li>
<p><code>DNS-PERSIST-01</code> 允许设置一个<strong>静态的 DNS TXT 记录</strong>。</p>
</li>
</ul>
<p>这一新功能预计将在 <strong>2026 年</strong> 上线，届时将极大地简化自动化续期的配置难度。</p>
<h3 data-id="heading-7">自动化也不是一劳永逸</h3>
<p>虽然但是，ACME 策略在实际落地中可能会出现各种各样的问题。</p>
<ul>
<li>
<p><strong>环境脆弱性：</strong> 操作系统升级或 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.servbay.com%2Ffeatures%2Fpython" target="_blank" title="https://www.servbay.com/features/python" ref="nofollow noopener noreferrer">Python 环境</a>变动，常导致 Certbot 等工具突然失效。</p>
</li>
<li>
<p><strong>安全隐患：</strong> 为了自动通过 DNS 验证，通常需要在服务器上保存 DNS 服务商的高权限 API Key，这增加了服务器被攻陷后的连带风险。</p>
</li>
<li>
<p><strong>复杂架构难题：</strong> 在 CDN、负载均衡或内网环境中，自动化分发证书的脚本编写难度极大，维护成本高昂。</p>
</li>
<li>
<p><strong>新规冲击：</strong> 最要命的是，随着授权复用期缩短至 <strong>7 小时</strong>，续期对外部 API（如 DNS 提供商）稳定性的依赖度极高，任何一次网络抖动都可能导致续期失败。</p>
</li>
</ul>
<p>如果不想花费精力去维护这些复杂的脚本，也不想每隔 45 天就担心一次证书是否更新成功，那花点钱买个 1 年期的商业证书或许是目前最省心的了。</p>
<h3 data-id="heading-8">商业证书是更好的选择</h3>
<p>近期，开发工具提供商 ServBay 上线了其资源商店，并提供了一项针对开发者的支持计划。</p>
<h4 data-id="heading-9"><strong>ServBay SSL 资源概览</strong></h4>
<ul>
<li>
<p><strong>免费领取：</strong> 平台提供了 1000 张 1 年期 DV SSL 证书。基于 Certum 根证书，兼容性好，领取后配置一次即可管一年，无需任何自动化脚本。</p>
</li>
<li>
<p><strong>低成本订阅：</strong> 如果需要多张证书，也可以单独购买，他们的定价可以说是非常顶了（单域名版 ¥29 /年，通配符版 ¥ 256 /年）。</p>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8aeb58833a644521b3bc75351b7f8da1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765356495&amp;x-signature=Vob4frFZEnhLB7CTuvkoCJ3TE3s%3D" alt="image.png" loading="lazy"/></p>
<p><strong>如何获取：</strong></p>
<ul>
<li>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.servbay.com%2Fstore" target="_blank" title="https://www.servbay.com/store" ref="nofollow noopener noreferrer">ServBay 官网进入「商店」</a>板块即可查看。最下方的就有免费的一年期证书可以领取。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6988248c9ea4990befc23609942850d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6K-l55So5oi35bey5LiN5a2Y5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765356495&amp;x-signature=Lf6gPTlFP1pPHIMkZSet2OZIfUQ%3D" alt="" loading="lazy"/></p>
<p>对于追求稳定、希望减少运维干扰的个人开发者或中小团队，这不失为一个高性价比的 Plan B。</p>
<hr/>
<h3 data-id="heading-10">总结</h3>
<p>HTTPS 证书有效期的缩短是不可逆转的安全趋势。虽然 2028 年听起来还很遥远，但对于负责基础设施的运维人员来说，现在就开始检查自动化脚本的兼容性是必要的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[就地编辑功能开发指南：从代码到体验的优雅蜕变]]></title>    <link>https://juejin.cn/post/7579190764766363688</link>    <guid>https://juejin.cn/post/7579190764766363688</guid>    <pubDate>2025-12-02T14:39:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579190764766363688" data-draft-id="7579088065697103912" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="就地编辑功能开发指南：从代码到体验的优雅蜕变"/> <meta itemprop="keywords" content="前端,JavaScript,代码规范"/> <meta itemprop="datePublished" content="2025-12-02T14:39:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="栀秋666"/> <meta itemprop="url" content="https://juejin.cn/user/2566698322650307"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            就地编辑功能开发指南：从代码到体验的优雅蜕变
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2566698322650307/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    栀秋666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T14:39:05.000Z" title="Tue Dec 02 2025 14:39:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><hr/>
<p>在现代 Web 应用中，“点击跳转 → 修改表单 → 提交返回”这种传统模式早已被用户诟病。它割裂了用户的注意力流，增加了操作成本，我们称之为“<strong>跳转暴政</strong>”。而<strong>就地编辑（Edit in Place）</strong> 正是打破这一桎梏的关键交互范式。</p>
<p>本文将带你深入剖析一个经典且实用的 <code>EditInPlace</code> 类实现，不仅讲解其核心逻辑，更从<strong>工程化视角</strong>出发，补充大量实战技巧和进阶优化策略，助你打造既美观又健壮的就地编辑组件。</p>
<hr/>
<h2 data-id="heading-0">一、为什么需要就地编辑？—— 用户体验的降本增效</h2>
<h3 data-id="heading-1">1.1 传统编辑流程的痛点</h3>
<p>设想以下场景：</p>
<ul>
<li>用户发现个人简介有错别字</li>
<li>点击「编辑资料」按钮</li>
<li>跳转到独立页面或弹窗</li>
<li>找到对应字段输入框</li>
<li>修改内容</li>
<li>滚动到底部点击「保存」</li>
<li>等待接口响应 &amp; 页面刷新</li>
<li>返回原页确认修改结果</li>
</ul>
<p>整个过程涉及 <strong>7+ 步骤</strong>，其中包含多次视觉焦点切换与等待时间。研究表明：每增加一步操作，用户完成率下降约 20%（Baymard Institute）。而就地编辑可以将其压缩为：</p>
<blockquote>
<p><strong>点击 → 输入 → 回车/点击保存</strong></p>
</blockquote>
<p>三步闭环，真正实现“所见即所改”。</p>
<h3 data-id="heading-2">1.2 就地编辑的核心价值</h3>






























<table><thead><tr><th>维度</th><th>传统方式</th><th>就地编辑</th></tr></thead><tbody><tr><td>操作路径长度</td><td>长（多跳转）</td><td>极短（零跳转）</td></tr><tr><td>注意力中断</td><td>强（上下文丢失）</td><td>弱（保持聚焦）</td></tr><tr><td>开发复杂度</td><td>中等（需维护完整表单）</td><td>较高（状态管理 + 实时反馈）</td></tr><tr><td>用户满意度</td><td>一般</td><td>高（流畅自然）</td></tr></tbody></table>
<blockquote>
<p>✅ 结论：<strong>减少认知负荷，提升操作效率，增强产品质感</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-3">二、面向对象设计：构建可复用的 <code>EditInPlace</code> 类</h2>
<p>我们将采用经典的 JavaScript 构造函数 + 原型模式来封装这个组件，兼顾兼容性与结构清晰度。</p>
<h3 data-id="heading-4">2.1 类的基本骨架</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 就地编辑组件构造器
 * <span class="hljs-doctag">@class</span> <span class="hljs-variable">EditInPlace</span>
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">id</span> - 元素唯一标识
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} <span class="hljs-variable">value</span> - 初始显示值
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">HTMLElement</span>} <span class="hljs-variable">parentElement</span> - 容器挂载点
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">options</span> - 配置项（扩展用）
 */</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">EditInPlace</span>(<span class="hljs-params">id, value, parentElement, options = {}</span>) {
  <span class="hljs-comment">// 核心属性</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span> = value || <span class="hljs-string">'这个家伙很懒，什么都没有留下'</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentElement</span> = parentElement;

  <span class="hljs-comment">// DOM 引用缓存（避免重复查询）</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span> = <span class="hljs-literal">null</span>;     <span class="hljs-comment">// 展示态文本</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span> = <span class="hljs-literal">null</span>;      <span class="hljs-comment">// 编辑态输入框</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span> = <span class="hljs-literal">null</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-comment">// 配置项合并</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({
    <span class="hljs-attr">tagName</span>: <span class="hljs-string">'span'</span>,           <span class="hljs-comment">// 包裹标签类型</span>
    <span class="hljs-attr">inputType</span>: <span class="hljs-string">'text'</span>,         <span class="hljs-comment">// 输入框类型</span>
    <span class="hljs-attr">maxLength</span>: <span class="hljs-number">100</span>,            <span class="hljs-comment">// 最大字符限制</span>
    <span class="hljs-attr">placeholder</span>: <span class="hljs-string">''</span>,           <span class="hljs-comment">// 输入提示</span>
    <span class="hljs-attr">autoSave</span>: <span class="hljs-literal">false</span>,           <span class="hljs-comment">// 是否启用自动保存（失焦即保存）</span>
    <span class="hljs-attr">debounceTime</span>: <span class="hljs-number">300</span>,         <span class="hljs-comment">// 防抖延迟（毫秒）</span>
    <span class="hljs-attr">onSave</span>: <span class="hljs-literal">null</span>,              <span class="hljs-comment">// 保存回调 (value) =&gt; Promise</span>
    <span class="hljs-attr">onCancel</span>: <span class="hljs-literal">null</span>             <span class="hljs-comment">// 取消回调</span>
  }, options);

  <span class="hljs-comment">// 初始化</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createElement</span>();
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">attachEvents</span>();
}
</code></pre>
<p>📌 <strong>设计亮点解析</strong>：</p>
<ul>
<li>使用 <code>Object.assign</code> 支持灵活配置，便于后期扩展</li>
<li>DOM 引用预存，提高性能</li>
<li>回调函数预留钩子，支持业务层介入（如调用 API）</li>
</ul>
<hr/>
<h2 data-id="heading-5">三、DOM 创建：高效构建 UI 结构</h2>
<h3 data-id="heading-6">3.1 创建方法详解</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">EditInPlace</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">createElement</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> self = <span class="hljs-variable language_">this</span>;

  <span class="hljs-comment">// 【1】创建最外层容器</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'div'</span>);
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>.<span class="hljs-property">className</span> = <span class="hljs-string">'eip-container'</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>.<span class="hljs-property">id</span> = <span class="hljs-string">`eip-<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.id}</span>`</span>;

  <span class="hljs-comment">// 【2】创建静态展示元素</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">tagName</span>);
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-property">className</span> = <span class="hljs-string">'eip-static'</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-property">textContent</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">cursor</span> = <span class="hljs-string">'pointer'</span>; <span class="hljs-comment">// 提示可点击</span>

  <span class="hljs-comment">// 【3】创建输入框</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'input'</span>);
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">type</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">inputType</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">className</span> = <span class="hljs-string">'eip-field'</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">value</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">maxLength</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">maxLength</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">placeholder</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">placeholder</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>; <span class="hljs-comment">// 默认隐藏</span>

  <span class="hljs-comment">// 【4】创建操作按钮组</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'button'</span>);
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>.<span class="hljs-property">type</span> = <span class="hljs-string">'button'</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>.<span class="hljs-property">className</span> = <span class="hljs-string">'eip-btn eip-save'</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>.<span class="hljs-property">textContent</span> = <span class="hljs-string">'✔'</span>;

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span> = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'button'</span>);
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>.<span class="hljs-property">type</span> = <span class="hljs-string">'button'</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>.<span class="hljs-property">className</span> = <span class="hljs-string">'eip-btn eip-cancel'</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>.<span class="hljs-property">textContent</span> = <span class="hljs-string">'✘'</span>;

  <span class="hljs-comment">// 按钮默认隐藏</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>;

  <span class="hljs-comment">// 【5】组装所有元素</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>);
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>);
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>);
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>);

  <span class="hljs-comment">// 【6】挂载到父容器</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">parentElement</span>.<span class="hljs-title function_">appendChild</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">containerElement</span>);

  <span class="hljs-comment">// 【7】初始状态设置</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">convertToText</span>();
};
</code></pre>
<p>🔧 <strong>最佳实践建议</strong>：</p>
<ul>
<li>所有 DOM 操作在内存中完成后再一次性插入文档（减少重排重绘）</li>
<li>使用语义化 class 名称，方便后续 CSS 控制</li>
<li>设置 <code>cursor: pointer</code> 明确交互意图</li>
</ul>
<hr/>
<h2 data-id="heading-7">四、状态切换机制：展示态 ↔ 编辑态</h2>
<p>这是整个组件的灵魂所在。</p>
<h3 data-id="heading-8">4.1 展示态 → 编辑态</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">EditInPlace</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">convertToField</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> self = <span class="hljs-variable language_">this</span>;

  <span class="hljs-comment">// 同步最新值到输入框</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">value</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;

  <span class="hljs-comment">// 切换显示状态</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'inline-block'</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'inline-block'</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'inline-block'</span>;

  <span class="hljs-comment">// 聚焦并选中文本（提升编辑体验）</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-title function_">focus</span>();
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-title function_">select</span>();

  <span class="hljs-comment">// 触发进入编辑事件（可用于埋点）</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_triggerEvent</span>(<span class="hljs-string">'onEditStart'</span>);
};
</code></pre>
<p>🎯 <strong>用户体验优化点</strong>：</p>
<ul>
<li><code>focus()</code> 自动获取焦点</li>
<li><code>select()</code> 全选文本，用户可直接覆盖输入</li>
</ul>
<h3 data-id="heading-9">4.2 编辑态 → 展示态</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">EditInPlace</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">convertToText</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-comment">// 更新静态文本内容</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-property">textContent</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;

  <span class="hljs-comment">// 隐藏编辑相关元素</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'inline'</span>;

  <span class="hljs-comment">// 触发退出编辑事件</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">_triggerEvent</span>(<span class="hljs-string">'onEditEnd'</span>);
};
</code></pre>
<p>💡 <strong>注意</strong>：这里更新的是 <code>textContent</code>，防止 XSS 注入；若需富文本支持，请使用 <code>innerHTML</code> 并做好过滤。</p>
<hr/>
<h2 data-id="heading-10">五、事件绑定系统：让组件“活”起来</h2>
<h3 data-id="heading-11">5.1 使用箭头函数确保上下文正确</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">EditInPlace</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">attachEvents</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> self = <span class="hljs-variable language_">this</span>;

  <span class="hljs-comment">// 【1】点击静态文本进入编辑</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">staticElement</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
    self.<span class="hljs-title function_">convertToField</span>();
  });

  <span class="hljs-comment">// 【2】保存按钮</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">saveButton</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
    self.<span class="hljs-title function_">save</span>();
  });

  <span class="hljs-comment">// 【3】取消按钮</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">cancelButton</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
    self.<span class="hljs-title function_">cancel</span>();
  });

  <span class="hljs-comment">// 【4】输入框回车保存，ESC 取消</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keydown'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> === <span class="hljs-string">'Enter'</span>) {
      e.<span class="hljs-title function_">preventDefault</span>();
      self.<span class="hljs-title function_">save</span>();
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (e.<span class="hljs-property">key</span> === <span class="hljs-string">'Escape'</span>) {
      self.<span class="hljs-title function_">cancel</span>();
    }
  });

  <span class="hljs-comment">// 【5】失焦自动保存（可选）</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">options</span>.<span class="hljs-property">autoSave</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">fieldElement</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'blur'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> self.<span class="hljs-title function_">save</span>(), <span class="hljs-number">100</span>); <span class="hljs-comment">// 延迟避免 cancel 冲突</span>
    });
  }
};
</code></pre>
<p>✅ <strong>关键点说明</strong>：</p>
<ul>
<li>所有事件处理器均使用 <strong>箭头函数</strong> 或闭包捕获 <code>self</code>，保证 <code>this</code> 指向实例</li>
<li>支持键盘快捷键，提升可访问性（a11y）</li>
<li><code>blur</code> 事件加 <code>setTimeout</code> 是为了防止与 cancel 按钮冲突（点击 cancel 也会触发 blur）</li>
</ul>
<hr/>
<h2 data-id="heading-12">六、总结：好交互藏在细节里</h2>
<p>就地编辑虽是一个小功能，却体现了现代前端开发的核心理念：</p>
<blockquote>
<p><strong>以用户为中心的设计 × 工程化的代码组织 × 对细节的极致追求</strong></p>
</blockquote>
<p>通过本文的 <code>EditInPlace</code> 实现，你应该已经掌握：</p>
<ul>
<li>如何用面向对象思想封装可复用组件</li>
<li>DOM 操作的最佳实践（批量创建、引用缓存）</li>
<li>事件绑定中的 <code>this</code> 陷阱规避</li>
<li>状态管理与交互闭环设计</li>
<li>用户体验层面的多项优化手段</li>
</ul>
<hr/>
<p>💬 <strong>互动话题</strong>：你在项目中是如何实现就地编辑的？有没有遇到过并发修改、权限控制等问题？欢迎在评论区分享你的经验！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RAG + Agent + Prompt工程上]]></title>    <link>https://juejin.cn/post/7579096485355798578</link>    <guid>https://juejin.cn/post/7579096485355798578</guid>    <pubDate>2025-12-02T13:35:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579096485355798578" data-draft-id="7579068270294188058" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RAG + Agent + Prompt工程上"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-12-02T13:35:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="国家不保护废物"/> <meta itemprop="url" content="https://juejin.cn/user/1220936035210004"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RAG + Agent + Prompt工程上
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1220936035210004/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    国家不保护废物
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T13:35:38.000Z" title="Tue Dec 02 2025 13:35:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    22
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RAG + Agent + Prompt工程上</h2>
<h3 data-id="heading-1">首先介绍一下rag是什么吧</h3>
<p>相信你们在日常使用ai中，都会遇到ai胡说八道的情况，特别是当提问一些比较专业的问题时，而rag的作用就是解决这个问题，本质上就是创建一个自己的向量数据库，每次询问ai时就会先将我们的问题与数据库中的数据进行一个相似性搜索，将相似度达到一定水平时便将改数据库中的该段内容加入我的提问中一起给大模型，以做到一个丰富内容的效果</p>
<h3 data-id="heading-2">话不多说，直接上项目</h3>
<p>先来一个比较简单的例子试试水</p>
<p>我们要实现的功能是：将我的简历传入，我可以询问ai有关我自己的问题，并得到满意的答案</p>
<p>这里我们使用到技术栈是：Ollama + LangChain.js + Supabase（pgvector）+ Node.js</p>
<ul>
<li><strong>Ollama</strong>：一个本地运行大语言模型（LLM）的工具，支持一键下载、运行和管理开源模型（如 Llama 3、DeepSeek、Nomic 等）。在本项目中，我们用它来提供两个能力：一是通过 <code>nomic-embed-text</code> 模型生成文本的向量嵌入（embedding），二是通过 <code>deepseek-v3.1:671b-cloud</code> 模型回答用户问题。所有推理都在本地完成，无需联网或付费。</li>
<li><strong>LangChain.js</strong>：LangChain 的 JavaScript/TypeScript 实现，是一个专为构建 LLM 应用设计的开发框架。它提供了标准化的组件（如文档加载器、文本分割器、向量存储接口、提示模板、链式调用等），让我们能快速搭建 RAG（检索增强生成）系统。在本项目中，LangChain 负责：读取 PDF 简历 → 切分文本 → 调用 Ollama 生成 embedding → 将向量存入 Supabase → 在问答时检索相关片段 → 构造带上下文的 prompt 并交由 LLM 回答。可以说，<strong>LangChain 是串联整个 RAG 流程的“胶水”和“脚手架”</strong> 。</li>
<li><strong>Supabase（集成 pgvector）</strong> ：一个开源的 Firebase 替代品，底层基于 PostgreSQL。我们特别启用了它的 <code>pgvector</code> 扩展，使其具备<strong>向量存储与相似度搜索</strong>能力。在本项目中，Supabase 充当<strong>向量数据库</strong>的角色：存储每段简历文本及其对应的 768 维 embedding 向量，并通过自定义的 <code>match_documents</code> 函数，根据用户问题的向量快速检索出最相关的简历片段。相比本地内存或文件存储，Supabase 提供了持久化、可扩展、支持复杂查询的云端向量检索服务。</li>
<li><strong>Node.js</strong>：作为运行时环境，支撑整个 JavaScript 应用的执行，包括文件读取、HTTP 请求（与 Ollama 和 Supabase 通信）、异步流程控制等。</li>
</ul>
<h4 data-id="heading-3">LangChain生态系统</h4>
<p>LangChain 是一个开源框架，用于<strong>构建基于大语言模型（LLM）的应用程序</strong>。它的核心目标是：<strong>让 LLM 能够与外部数据、工具和逻辑结合，从而打造更强大、可控、实用的 AI 应用</strong>。</p>
<p><strong>LangChain = 让大模型“能干活”的脚手架 —— 接数据、连工具、记历史、做决策。</strong>
LangChain使这些复杂流程变得简单，让开发者可以专注于业务逻辑而不是底层实现细节。</p>
<p><strong>1. 链(Chains)</strong></p>
<p>链是LangChain的核心概念，允许将多个组件按特定顺序组合起来，完成复杂任务。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 简单链示例</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">LLMChain</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain/chains"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ChatOpenAI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain/
chat_models/openai"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PromptTemplate</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain/
prompts"</span>;

<span class="hljs-keyword">const</span> llm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatOpenAI</span>({ <span class="hljs-attr">temperature</span>: <span class="hljs-number">0.9</span> });
<span class="hljs-keyword">const</span> prompt = <span class="hljs-title class_">PromptTemplate</span>.<span class="hljs-title function_">fromTemplate</span>(<span class="hljs-string">"什么
是{topic}?"</span>);
<span class="hljs-keyword">const</span> chain = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LLMChain</span>({ llm, prompt });
<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> chain.<span class="hljs-title function_">call</span>({ <span class="hljs-attr">topic</span>: <span class="hljs-string">"人工智能
"</span> });
</code></pre>
<p><strong>2. 模型(Models)</strong></p>
<p>LangChain支持多种类型的模型：</p>
<ul>
<li>LLMs : 文本生成模型</li>
<li>Chat Models : 对话模型，支持结构化消息</li>
<li>Text Embedding Models : 文本嵌入模型，用于向量表示</li>
</ul>
<p><strong>3. 提示词(Prompts)</strong></p>
<p>提供模板化管理和优化提示词的工具：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PromptTemplate</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain/
prompts"</span>;

<span class="hljs-keyword">const</span> prompt = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PromptTemplate</span>({
  <span class="hljs-attr">template</span>: <span class="hljs-string">"请用{style}风格解释{topic}"</span>,
  <span class="hljs-attr">inputVariables</span>: [<span class="hljs-string">"style"</span>, <span class="hljs-string">"topic"</span>]
});
</code></pre>
<p><strong>4. 索引(Indexes)</strong></p>
<p>用于结构化和检索外部数据，包括：</p>
<ul>
<li>Document Loaders : 从各种数据源加载文档</li>
<li>Text Splitters : 将长文本分割成可管理的块</li>
<li>Vector Stores : 存储和检索向量嵌入</li>
<li>Retrievers : 从存储中检索相关文档</li>
</ul>
<p><strong>5. 记忆(Memory)</strong></p>
<p>为链和代理提供持久化状态，使对话具有上下文感知能力：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConversationBufferMemory</span> } <span class="hljs-keyword">from</span> 
<span class="hljs-string">"langchain/memory"</span>;

<span class="hljs-keyword">const</span> memory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConversationBufferMemory</span>({
  <span class="hljs-attr">memoryKey</span>: <span class="hljs-string">"chat_history"</span>,
  <span class="hljs-attr">returnMessages</span>: <span class="hljs-literal">true</span>
});
</code></pre>
<p><strong>6. 代理(Agents)</strong></p>
<p>代理使用LLM决定执行哪些动作，可以动态选择工具：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { initializeAgentExecutor } <span class="hljs-keyword">from</span> 
<span class="hljs-string">"langchain/agents"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">SerpAPI</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain/tools"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Calculator</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain/tools"</span>;

<span class="hljs-keyword">const</span> tools = [<span class="hljs-keyword">new</span> <span class="hljs-title class_">SerpAPI</span>(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Calculator</span>()];
<span class="hljs-keyword">const</span> agent = <span class="hljs-keyword">await</span> initializeAgentExecutor
(tools, llm, <span class="hljs-string">"zero-shot-react-description"</span>);
</code></pre>
<p><strong>JavaScript/TypeScript版本</strong></p>
<ul>
<li>langchain : 核心库</li>
<li>@langchain/openai : OpenAI集成</li>
<li>@langchain/community : 社区贡献的集成</li>
<li>langchain/chains : 预构建链</li>
<li>langchain/embeddings : 嵌入模型</li>
</ul>
<h4 data-id="heading-4">如何去存储我传入的数据</h4>
<p>我们已经知道了ai会将我们的问题与数据库中的每一条数据进行相似性搜索，这就需要我们去使用<strong>向量数据库</strong>去存储我们的信息，将信息以向量的形式存储便于我们进行相似性搜索，在这个项目中我们使用到的是线上数据库supabase(当然由于这是一个线上数据库，后续就难免涉及到收费等问题，主包就是在创了两个数据库后要收我的钱了，不然你之前的数据就没了)，那具体如何去用呢？</p>
<h5 data-id="heading-5">环境配置</h5>
<pre><code class="hljs language-.env" lang=".env"># Supabase 配置
SUPABASE_URL=每个库对应一个url
SUPABASE_ANON_KEY=
SUPABASE_TABLE_NAME=documents
</code></pre>
<p>在下图的位置可以找到url
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea8ef042d71047faa62a54a5dc6763ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu95a625LiN5L-d5oqk5bqf54mp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765332827&amp;x-signature=oFY%2FPjXtFM3C0U%2Bd8WmHj4XKqKM%3D" alt="image.png" loading="lazy"/></p>
<p>api的话要注意有两个，而我们需要用到的就是上面<code>anon``public</code>的那个api</p>
<blockquote>
<ul>
<li>anon 密钥 应该只用于客户端应用，权限受限，默认只能读取公开数据</li>
<li>service_role 密钥 应该用于服务端操作，拥有完全权限，可以绕过所有行级安全策略(RLS)</li>
</ul>
<p>而我们使用 anon 密钥能够写入数据的原因是：表权限设置 ：documents表没有启用RLS，所以默认情况下，任何有效的API密钥（包括anon密钥）都有权限插入数据。虽然这样不太安全</p>
<p>更安全的做法应该是：</p>
<ol>
<li>启用RLS： ALTER TABLE public.documents ENABLE ROW LEVEL SECURITY;</li>
<li>创建适当的策略，例如：
<ul>
<li>允许所有人读取： CREATE POLICY "Enable read access for all users" ON public.documents FOR SELECT USING (true);</li>
<li>只允许服务角色写入： CREATE POLICY "Enable insert for service role only" ON public.documents FOR INSERT WITH CHECK (current_setting('request.jwt.claims', true)::json-&gt;&gt;'role' = 'service_role');
这样就可以确保只有服务端（使用service_role密钥）才能写入数据，而客户端（使用anon密钥）只能读取数据。</li>
</ul>
</li>
</ol>
<p>但是我们先不考虑那么远，先偷个懒，就这样</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0214d5ed10b14806b91291fc6e27aecf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu95a625LiN5L-d5oqk5bqf54mp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765332827&amp;x-signature=r3%2BtyGZwq4N1TFh0B4NjOg4OuMI%3D" alt="image.png" loading="lazy"/></p>
<h5 data-id="heading-6">创建一个数据库中的数据表</h5>
<p>在supabase官网中找到编辑表的地方，选择这个，便可以直接使用sql语句去创建表了
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44ad5491e5eb430ea9a1457bd0b7a6e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu95a625LiN5L-d5oqk5bqf54mp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765332827&amp;x-signature=9KIXlEUCS4z6I%2FChONPnFyG1IrM%3D" alt="image.png" loading="lazy"/></p>
<p>这里我们要注意要启动 pgvector 扩展，否则将会创建失败，我们在这里不仅声明了表的结构还创建了向量相似度搜索函数，后续进行相似度判断时会使用到这个函数</p>
<pre><code class="hljs language-js" lang="js">-- 启用 pgvector 扩展
<span class="hljs-variable constant_">CREATE</span> <span class="hljs-variable constant_">EXTENSION</span> <span class="hljs-variable constant_">IF</span> <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">EXISTS</span> vector;


-- 创建 documents 表（根据项目配置使用documents作为表名）
<span class="hljs-variable constant_">CREATE</span> <span class="hljs-variable constant_">TABLE</span> <span class="hljs-variable constant_">IF</span> <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">EXISTS</span> public.<span class="hljs-property">documents</span> (
    id uuid <span class="hljs-variable constant_">NOT</span> <span class="hljs-variable constant_">NULL</span> <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-title function_">gen_random_uuid</span>(),
    content text <span class="hljs-literal">null</span>,
    embedding <span class="hljs-title function_">vector</span>(<span class="hljs-number">768</span>) <span class="hljs-literal">null</span>,  -- nomic-embed-text生成<span class="hljs-number">768</span>维向量
    metadata jsonb <span class="hljs-literal">null</span>,
    <span class="hljs-variable constant_">CONSTRAINT</span> documents_pkey <span class="hljs-variable constant_">PRIMARY</span> <span class="hljs-variable constant_">KEY</span> (id)
);

-- 创建向量相似度搜索函数
<span class="hljs-variable constant_">CREATE</span> <span class="hljs-variable constant_">OR</span> <span class="hljs-variable constant_">REPLACE</span> <span class="hljs-variable constant_">FUNCTION</span> <span class="hljs-title function_">match_documents</span>(
    query_embedding <span class="hljs-title function_">vector</span>(<span class="hljs-number">768</span>),
    match_threshold float <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-number">0.7</span>,
    match_count int <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-number">5</span>,
    filter jsonb <span class="hljs-variable constant_">DEFAULT</span> <span class="hljs-string">'{}'</span>
)
<span class="hljs-variable constant_">RETURNS</span> <span class="hljs-variable constant_">TABLE</span> (
    id uuid,
    content text,
    metadata jsonb,
    similarity float
)
<span class="hljs-variable constant_">LANGUAGE</span> sql <span class="hljs-variable constant_">STABLE</span>
<span class="hljs-variable constant_">AS</span> $$
    <span class="hljs-variable constant_">SELECT</span>
        id,
        content,
        metadata,
        <span class="hljs-number">1</span> - (documents.<span class="hljs-property">embedding</span> &lt;=&gt; query_embedding) <span class="hljs-keyword">as</span> similarity
    <span class="hljs-variable constant_">FROM</span> documents
    <span class="hljs-variable constant_">WHERE</span> <span class="hljs-number">1</span> - (documents.<span class="hljs-property">embedding</span> &lt;=&gt; query_embedding) &gt; match_threshold
    <span class="hljs-variable constant_">ORDER</span> <span class="hljs-variable constant_">BY</span> similarity <span class="hljs-variable constant_">DESC</span>
    <span class="hljs-variable constant_">LIMIT</span> match_count;
$$;
</code></pre>
<h5 data-id="heading-7">往数据库中写入数据</h5>
<p>将supabase的配置文件写好了之后咱们就要去用了</p>
<p>话不多说，直接上代码</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// utils/supabase.js</span>
<span class="hljs-keyword">import</span> { createClient } <span class="hljs-keyword">from</span> <span class="hljs-string">"@supabase/supabase-js"</span>;
<span class="hljs-keyword">import</span> dotenv <span class="hljs-keyword">from</span> <span class="hljs-string">"dotenv"</span>;

dotenv.<span class="hljs-title function_">config</span>();

<span class="hljs-keyword">const</span> supabase = <span class="hljs-title function_">createClient</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">SUPABASE_URL</span>, process.<span class="hljs-property">env</span>.<span class="hljs-property">SUPABASE_ANON_KEY</span>);

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> supabase;
</code></pre>
<p>先实例化supabase,后续可以直接通过supabase进行写入数据</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// ingest.js</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PDFLoader</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain/document_loaders/fs/pdf"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RecursiveCharacterTextSplitter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"langchain/text_splitter"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">SupabaseVectorStore</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/community/vectorstores/supabase"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OllamaEmbeddings</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/community/embeddings/ollama"</span>;
<span class="hljs-keyword">import</span> supabase <span class="hljs-keyword">from</span> <span class="hljs-string">"./utils/supabase.js"</span>;
<span class="hljs-keyword">import</span> dotenv <span class="hljs-keyword">from</span> <span class="hljs-string">"dotenv"</span>;

dotenv.<span class="hljs-title function_">config</span>();

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ingestDocument</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"开始文档植入流程..."</span>);

  <span class="hljs-comment">// 1. 加载 PDF</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"正在加载 PDF 文件..."</span>);
  <span class="hljs-keyword">const</span> loader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PDFLoader</span>(<span class="hljs-string">"documents/assessment_report.pdf"</span>);
  <span class="hljs-keyword">const</span> docs = <span class="hljs-keyword">await</span> loader.<span class="hljs-title function_">load</span>();
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`加载完成，共 <span class="hljs-subst">${docs.length}</span> 页`</span>);

  <span class="hljs-comment">// 2. 分块</span>
  <span class="hljs-keyword">const</span> textSplitter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RecursiveCharacterTextSplitter</span>({
    <span class="hljs-attr">chunkSize</span>: <span class="hljs-number">500</span>,
    <span class="hljs-attr">chunkOverlap</span>: <span class="hljs-number">50</span>,
  });
  <span class="hljs-keyword">const</span> splitDocs = <span class="hljs-keyword">await</span> textSplitter.<span class="hljs-title function_">splitDocuments</span>(docs);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`分块完成，共 <span class="hljs-subst">${splitDocs.length}</span> 个文本块`</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`文本块:<span class="hljs-subst">${splitDocs[<span class="hljs-number">0</span>].pageContent}</span>`</span>);

  <span class="hljs-comment">// 3. 初始化 embedding 模型</span>
  <span class="hljs-keyword">const</span> embeddings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OllamaEmbeddings</span>({
    <span class="hljs-attr">model</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">EMBEDDING_MODEL</span>, <span class="hljs-comment">// "nomic-embed-text"</span>
    <span class="hljs-attr">baseUrl</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">OLLAMA_BASE_URL</span>,
  });

  <span class="hljs-comment">// 4. 存入 Supabase 向量数据库</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"正在将向量写入 Supabase..."</span>);
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">SupabaseVectorStore</span>.<span class="hljs-title function_">fromDocuments</span>(splitDocs, embeddings, {
      <span class="hljs-attr">client</span>: supabase,
      <span class="hljs-attr">tableName</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">SUPABASE_TABLE_NAME</span>,
      <span class="hljs-attr">queryName</span>: <span class="hljs-string">"match_documents"</span>, <span class="hljs-comment">// LangChain 会自动创建这个函数</span>
    });
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"文档已成功存入 Supabase 向量数据库！"</span>);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"存入 Supabase 失败："</span>, error.<span class="hljs-property">message</span>);
  }
}

<span class="hljs-title function_">ingestDocument</span>();
</code></pre>
<p>(((φ(◎ロ◎;)φ)))，这些都是啥啊，我怎么都看不懂，别着急，我们一起来看看</p>
<p>我看整个代码，感觉都围绕着一个东西<code>langchain</code>,在上面我们已经知道了langchain大概是什么了，那我们就先看看具体是怎么用的吧（详细讲述为什么要使用langchain，为什么在这里使用这个东西）</p>
<p>很明显，我们这跟结构化和检索外部数据有关，所以跟索引这个核心概念有关，</p>
<ul>
<li>Document Loaders : 从各种数据源加载文档</li>
<li>Text Splitters : 将长文本分割成可管理的块</li>
<li>Vector Stores : 存储和检索向量嵌入</li>
</ul>
<p>这三个组件，我们肯定是要用到的，并且我们需要将文字转换成向量，所以还需要使用到一个向量大模型
所以总体的流程就是：</p>
<ol>
<li>文档加载 : PDFLoader 加载PDF文档</li>
<li>文本分割 : RecursiveCharacterTextSplitter 分割文本</li>
<li>向量化 : OllamaEmbeddings 生成文本向量</li>
<li>向量存储 : SupabaseVectorStore 存储和检索向量</li>
</ol>
<p><strong>那为什么要用 LangChain 呢？</strong></p>
<p>因为如果没有 LangChain，你需要自己手动完成以下事情：</p>
<ul>
<li>自己写代码解析 PDF（比如用 pdf-parse 或 pdf.js），处理编码、分页、格式丢失等问题；</li>
<li>自己实现文本分块逻辑（比如按字符、句子或语义边界切割），还要考虑重叠以保留上下文；</li>
<li>自己调用 Ollama 的 API 发送文本获取 embedding 向量，处理 HTTP 请求、错误重试、批量处理；</li>
<li>自己构造 SQL 查询或 RPC 调用 Supabase 的 <code>match_documents</code> 函数，拼接向量、设置阈值、解析返回结果；</li>
<li>最后还要手动拼接 prompt，把检索到的内容塞进问题里，再调用 LLM 接口。</li>
</ul>
<p>这些步骤虽然技术上可行，但<strong>重复性高、容易出错、难以维护</strong>，而且不同模型、数据库、文件格式之间的适配成本极高。</p>
<p>而 <strong>LangChain 的价值就在于：它把上述所有环节都封装成了标准化的模块</strong>（Document Loaders / Text Splitters / Embeddings / VectorStores），你只需要像搭积木一样组合它们，就能快速构建一个完整的 RAG 流程。更重要的是，这些模块是<strong>可插拔、可替换</strong>的——今天你用 Supabase + Ollama，明天换成 Pinecone + OpenAI，只需改几行配置，核心逻辑几乎不用动。</p>
<p>在这个项目中，我们之所以选择 LangChain，正是因为：</p>
<ul>
<li>它提供了 <code>PDFLoader</code> 直接读取简历 PDF；</li>
<li>它内置了智能的 <code>RecursiveCharacterTextSplitter</code>，能按段落、句子合理切分，避免切断关键信息；</li>
<li>它通过 <code>OllamaEmbeddings</code> 无缝对接本地 Ollama 的 embedding 模型；</li>
<li>它的 <code>SupabaseVectorStore</code> 已经实现了与 pgvector 的深度集成，自动调用你创建的 <code>match_documents</code> 函数；</li>
<li>整个流程被抽象为清晰的“加载 → 切分 → 向量化 → 存储”管道，极大降低了开发复杂度。</li>
</ul>
<p>换句话说，<strong>LangChain 让你专注于“我要做什么”，而不是“怎么一行行代码去实现底层细节”</strong> 。这正是现代 AI 应用开发所需要的生产力工具。
运行<code>node ingest.js</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/146734e050234c3facb510609bf193bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu95a625LiN5L-d5oqk5bqf54mp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765332827&amp;x-signature=DqVKyN1TCIIy2L%2FMvKvAlHGOwCM%3D" alt="image.png" loading="lazy"/>
经过上面几个步骤，我们已经 成功将数据存入数据库中了，现在就是如何将数据与我们的大模型相结合了</p>
<h4 data-id="heading-8">如何将在LLM中去使用我的数据</h4>
<p>这里由于是简单的一个例子，目的是为了让我们知道大致rag的流程，我们便使用简单的ollama进行举例，但是前提是你本地已经下载了ollama,并且在终端运行<code>ollama run deepseek-v3.1:671b-cloud</code>和
<code>ollama run nomic-embed-text</code>，如此方可使用</p>
<p>首先进行基础配置
在原先的.env文件中添加ollama配置</p>
<pre><code class="hljs language-.env" lang=".env"># Ollama 配置
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_MODEL=deepseek-v3.1:671b-cloud
EMBEDDING_MODEL=nomic-embed-text
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// qa_resume.js - 针对简历内容的问题</span>
<span class="hljs-keyword">import</span> { createClient } <span class="hljs-keyword">from</span> <span class="hljs-string">'@supabase/supabase-js'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OllamaEmbeddings</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@langchain/community/embeddings/ollama'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Ollama</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@langchain/community/llms/ollama"</span>;
<span class="hljs-keyword">import</span> dotenv <span class="hljs-keyword">from</span> <span class="hljs-string">'dotenv'</span>;

dotenv.<span class="hljs-title function_">config</span>();

<span class="hljs-keyword">const</span> supabaseUrl = process.<span class="hljs-property">env</span>.<span class="hljs-property">SUPABASE_URL</span>;
<span class="hljs-keyword">const</span> supabaseKey = process.<span class="hljs-property">env</span>.<span class="hljs-property">SUPABASE_ANON_KEY</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">askResumeQuestion</span>(<span class="hljs-params">question</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`\n问题: <span class="hljs-subst">${question}</span>`</span>);

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 1. 初始化 embedding 模型</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"1. 初始化embedding模型..."</span>);
    <span class="hljs-keyword">const</span> embeddings = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OllamaEmbeddings</span>({
      <span class="hljs-attr">model</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">EMBEDDING_MODEL</span>,
      <span class="hljs-attr">baseUrl</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">OLLAMA_BASE_URL</span>,
    });

    <span class="hljs-comment">// 2. 生成查询向量</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"2. 生成查询向量..."</span>);
    <span class="hljs-keyword">const</span> queryEmbedding = <span class="hljs-keyword">await</span> embeddings.<span class="hljs-title function_">embedQuery</span>(question);

    <span class="hljs-comment">// 3. 执行向量相似度搜索</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"3. 执行向量相似度搜索..."</span>);
    <span class="hljs-keyword">const</span> supabase = <span class="hljs-title function_">createClient</span>(supabaseUrl, supabaseKey);
    
    <span class="hljs-keyword">const</span> { <span class="hljs-attr">data</span>: documents, error } = <span class="hljs-keyword">await</span> supabase
      .<span class="hljs-title function_">rpc</span>(<span class="hljs-string">'match_documents'</span>, {
        <span class="hljs-attr">query_embedding</span>: queryEmbedding,
        <span class="hljs-attr">match_threshold</span>: <span class="hljs-number">0.5</span>,
        <span class="hljs-attr">match_count</span>: <span class="hljs-number">8</span>,
        <span class="hljs-attr">filter</span>: {}
      });

    <span class="hljs-keyword">if</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'向量搜索失败:'</span>, error.<span class="hljs-property">message</span>);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`找到 <span class="hljs-subst">${documents.length}</span> 个相关文档`</span>);
    <span class="hljs-keyword">if</span> (documents.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'没有找到相关文档'</span>);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 4. 构建上下文</span>
    <span class="hljs-comment">// console.log("4. 构建上下文...");</span>
    <span class="hljs-keyword">const</span> context = documents.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">doc, index</span>) =&gt;</span> 
      <span class="hljs-string">`[文档<span class="hljs-subst">${index + <span class="hljs-number">1</span>}</span>]\n<span class="hljs-subst">${doc.content}</span>`</span>
    ).<span class="hljs-title function_">join</span>(<span class="hljs-string">'\n\n'</span>);

    <span class="hljs-comment">// 5. 初始化 LLM</span>
    <span class="hljs-comment">// console.log("5. 初始化LLM...");</span>
    <span class="hljs-keyword">const</span> llm = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Ollama</span>({
      <span class="hljs-attr">baseUrl</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">OLLAMA_BASE_URL</span>,
      <span class="hljs-attr">model</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">OLLAMA_MODEL</span>,
      <span class="hljs-attr">temperature</span>: <span class="hljs-number">0.3</span>,
    });
    <span class="hljs-comment">// 6. 构建提示词</span>
    <span class="hljs-keyword">const</span> prompt = <span class="hljs-string">`基于以下简历内容，请回答问题：

上下文：
<span class="hljs-subst">${context}</span>

问题：<span class="hljs-subst">${question}</span>

请用中文回答，并确保答案准确、简洁。如果上下文中没有相关信息，请明确说明。`</span>;

    <span class="hljs-comment">// 7. 生成回答</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"请稍等，正在生成回答..."</span>);
    <span class="hljs-keyword">const</span> answer = <span class="hljs-keyword">await</span> llm.<span class="hljs-title function_">invoke</span>(prompt);
    
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`回答: <span class="hljs-subst">${answer}</span>`</span>);
    <span class="hljs-keyword">return</span> answer;

  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"问答失败："</span>, error.<span class="hljs-property">message</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"错误详情："</span>, error);
  }
}

<span class="hljs-comment">// 测试针对简历的问题</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">askResumeQuestion</span>(<span class="hljs-string">"这位候选人的主要技能是什么？"</span>);
<span class="hljs-keyword">await</span> <span class="hljs-title function_">askResumeQuestion</span>(<span class="hljs-string">"候选人有哪些项目经验？"</span>);
<span class="hljs-keyword">await</span> <span class="hljs-title function_">askResumeQuestion</span>(<span class="hljs-string">"他的教育背景如何？"</span>);
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e8eaa09704145178e586f461bd691f8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Zu95a625LiN5L-d5oqk5bqf54mp:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765332827&amp;x-signature=nTbT9T3dACLOPbblZGrqUKjDcOc%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-9">总结</h3>
<p>通过这个简单的项目，我们完整走通了 <strong>RAG（检索增强生成）</strong> 的核心流程：<br/>
将个人简历（PDF）作为私有知识源，利用 <strong>LangChain.js</strong> 自动完成文档加载、文本切分、向量化和存储；借助 <strong>Supabase + pgvector</strong> 构建轻量级向量数据库，实现高效的语义相似性检索；最后结合本地运行的 <strong>Ollama 大模型</strong>，在注入上下文的前提下精准回答关于简历的问题。</p>
<p>整个方案完全运行在本地或低成本云服务上，<strong>无需依赖 OpenAI 等商业 API</strong>，既保护了数据隐私，又有效避免了大模型“胡说八道”的问题——因为它的回答始终基于你提供的真实内容。</p>
<p>更重要的是，这个架构具备极强的可扩展性：</p>
<ul>
<li>换个 PDF，就能变成“公司知识库问答”；</li>
<li>加入多个文档，就支持跨文件检索；</li>
<li>接入 Agent 和工具（如日历、邮件），还能实现“根据我的经历自动写求职信”等智能任务。</li>
</ul>
<p>这只是一个起点。<br/>
接下来，我们将尝试引入更复杂的rag项目，还有很多需要优化的部分需要去完善，像文本切割是否可以更加人性化，是否可以通过langchain内的组件进行进一步的开发，比如实现流式输出，对话历史存储之类的，还有之前埋下的伏笔，有没有可以在本地直接运行的免费向量数据库，这些都会在之后的文章中写到</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js第十二章(RSC/服务端组件/客户端组件)]]></title>    <link>https://juejin.cn/post/7579062563326427177</link>    <guid>https://juejin.cn/post/7579062563326427177</guid>    <pubDate>2025-12-02T13:04:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7579062563326427177" data-draft-id="7579066828179357732" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js第十二章(RSC/服务端组件/客户端组件)"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-02T13:04:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小满zs"/> <meta itemprop="url" content="https://juejin.cn/user/2463384809252397"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js第十二章(RSC/服务端组件/客户端组件)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2463384809252397/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小满zs
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-02T13:04:35.000Z" title="Tue Dec 02 2025 13:04:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-02
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RSC(React Server Components)</h2>
<p>RSC(服务器组件)是React19<code>正式引入</code>的一种新的组件类型，它可以在服务器端渲染，也可以在客户端渲染。</p>
<p>像传统的<code>SSR</code>他是在服务器提前把页面渲染好，然后返回给浏览器，然后进行水合，<code>CSR</code>则是在客户端渲染，而<code>RSC</code>则是吸取两方优势，分为<code>服务器组件</code>和<code>客户端组件</code>。</p>
<p>举个例子:</p>
<p>例如我们有一个官网的页面，上面都是静态内容，但下面留言框是需要交互的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a80aa3627d954e6baad4c922fcf9e8ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765285475&amp;x-signature=%2BfIjzD%2BLviW1n8xLZNbwfS7y6Ho%3D" alt="7.gif" loading="lazy"/></p>
<p>此时我们就可以拆分成两个组件:</p>
<ul>
<li>服务器组件: 上面都是静态内容，例如正文，标题，图片等，这类组件之所以适合在服务端执行，核心原因在于服务端渲染HTML+CSS的速度更快，生成的内容对搜索引擎完全可见，且无需客户端额外处理交互逻辑，完美匹配静态内容的需求。</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//Next.js 默认服务器组件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">HomePage</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home Page<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<ul>
<li>客户端组件: 下面留言框是需要交互的，例如交互功能，如点赞按钮、计数器、表单等。这类组件需要依赖浏览器DOM事件、状态管理（useState）、副作用（useEffect）等客户端能力，必须在客户端完成渲染和水合（即添加事件处理程序的过程）才能实现交互效果</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-string">'use client'</span> <span class="hljs-comment">//声明这是一个客户端组件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">HomePage</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Home Page<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<h4 data-id="heading-1">渲染(RSC Payload)</h4>
<p>SSR模式是在服务器直接渲染成<code>HTML</code>页面，返回给浏览器的，而<code>RSC</code>他是一种特殊的<code>紧凑的</code>格式</p>
<pre><code class="hljs language-json" lang="json">b2<span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-string">"$"</span><span class="hljs-punctuation">,</span><span class="hljs-string">"span"</span><span class="hljs-punctuation">,</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"className"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"line"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-string">"$"</span><span class="hljs-punctuation">,</span><span class="hljs-string">"span"</span><span class="hljs-punctuation">,</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"color"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"var(--shiki-color-text)"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"    })"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
b3<span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-string">"$"</span><span class="hljs-punctuation">,</span><span class="hljs-string">"span"</span><span class="hljs-punctuation">,</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"className"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"line"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-string">"$"</span><span class="hljs-punctuation">,</span><span class="hljs-string">"span"</span><span class="hljs-punctuation">,</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"color"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"var(--shiki-color-text)"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"  }"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">[</span><span class="hljs-string">"$"</span><span class="hljs-punctuation">,</span><span class="hljs-string">"span"</span><span class="hljs-punctuation">,</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"color"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"var(--shiki-token-punctuation)"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span><span class="hljs-string">","</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">[</span><span class="hljs-string">"$"</span><span class="hljs-punctuation">,</span><span class="hljs-string">"span"</span><span class="hljs-punctuation">,</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"color"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"var(--shiki-color-text)"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span><span class="hljs-string">" [])"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
b4<span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-string">"$"</span><span class="hljs-punctuation">,</span><span class="hljs-string">"span"</span><span class="hljs-punctuation">,</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"className"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"line"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span><span class="hljs-string">" "</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
b5<span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-string">"$"</span><span class="hljs-punctuation">,</span><span class="hljs-string">"span"</span><span class="hljs-punctuation">,</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"className"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"line"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-string">"$"</span><span class="hljs-punctuation">,</span><span class="hljs-string">"span"</span><span class="hljs-punctuation">,</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"color"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"var(--shiki-color-text)"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"  "</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">[</span><span class="hljs-string">"$"</span><span class="hljs-punctuation">,</span><span class="hljs-string">"span"</span><span class="hljs-punctuation">,</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"color"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"var(--shiki-token-comment)"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"// You can use `isPending` to give users feedback"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
b6<span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-string">"$"</span><span class="hljs-punctuation">,</span><span class="hljs-string">"span"</span><span class="hljs-punctuation">,</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"className"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"line"</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">[</span><span class="hljs-punctuation">[</span><span class="hljs-string">"$"</span><span class="hljs-punctuation">,</span><span class="hljs-string">"span"</span><span class="hljs-punctuation">,</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"color"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"var(--shiki-color-text)"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"  "</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">[</span><span class="hljs-string">"$"</span><span class="hljs-punctuation">,</span><span class="hljs-string">"span"</span><span class="hljs-punctuation">,</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"color"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"var(--shiki-token-keyword)"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"return"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">[</span><span class="hljs-string">"$"</span><span class="hljs-punctuation">,</span><span class="hljs-string">"span"</span><span class="hljs-punctuation">,</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"color"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"var(--shiki-color-text)"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span><span class="hljs-string">" &lt;"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">[</span><span class="hljs-string">"$"</span><span class="hljs-punctuation">,</span><span class="hljs-string">"span"</span><span class="hljs-punctuation">,</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"color"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"var(--shiki-token-string-expression)"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"p"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">[</span><span class="hljs-string">"$"</span><span class="hljs-punctuation">,</span><span class="hljs-string">"span"</span><span class="hljs-punctuation">,</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"color"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"var(--shiki-color-text)"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"&gt;Total Views: {views}&lt;/"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">[</span><span class="hljs-string">"$"</span><span class="hljs-punctuation">,</span><span class="hljs-string">"span"</span><span class="hljs-punctuation">,</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"color"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"var(--shiki-token-string-expression)"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"p"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">[</span><span class="hljs-string">"$"</span><span class="hljs-punctuation">,</span><span class="hljs-string">"span"</span><span class="hljs-punctuation">,</span><span class="hljs-literal"><span class="hljs-keyword">null</span></span><span class="hljs-punctuation">,</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"style"</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">{</span><span class="hljs-attr">"color"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"var(--shiki-color-text)"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span><span class="hljs-attr">"children"</span><span class="hljs-punctuation">:</span><span class="hljs-string">"&gt;"</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">}</span><span class="hljs-punctuation">]</span>
</code></pre>
<p>那为什么这么做呢？因为我们的组件可以进行嵌套<code>服务器组件</code>&gt;嵌套<code>客户端组件</code>&gt;</p>
<p>黄色节点表示<code>服务器组件</code>，虚线节点表示<code>客户端组件</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fb652ca8382248fc83e6d398a2452c74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765285475&amp;x-signature=eylXhlN6aUyMlVxwTmgd%2BwxSHCY%3D" alt="2.png" loading="lazy"/></p>
<p>在这个结构中，Next.js就会标记哪些是客户端组件并且预留好位置，但是不会进行水合。</p>
<p>那么Next.js发现客户端组件也会在服务器生成这个结构，那干脆直接服务器里面把客户端组件进行预渲染(不包含交互)，这样我们就能快速看到数据，等他加载完成后再进行水合，所以客户端组件也会在服务器进行一次<code>预渲染</code>。</p>
<h4 data-id="heading-2">优点</h4>
<ul>
<li>
<p>将组件拆分成客户端组件和服务器组件，可以有效的减少<code>bundle</code>体积，因为<code>服务器组件</code>已经在服务器渲染好了，所以没必要打入<code>bundle</code>中,也就是说服务器组件所依赖的包都不会打进去，大大减少了<code>bundle</code>体积。</p>
</li>
<li>
<p>局部水合，像传统的SSR同构模式, 所有的页面都要在客户端进行水合，而<code>RSC</code>将组件拆分出来，只会把客户端组件进行水合，避免了全量水合带来的性能损耗。</p>
</li>
<li>
<p>流式加载，我们的HTML页面本来就支持流式加载，所以服务器组件可以边渲染边返回，提高了FCP(首次内容绘制)性能。</p>
</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/870b4c3be1224e059685d8603ee92d6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765285475&amp;x-signature=7pNR5%2FHSV3sN8iApkSVw1GOyQaI%3D" alt="1.png" loading="lazy"/></p>
<h2 data-id="heading-3">服务端组件(Server Components)</h2>
<p>在默认情况下, <code>page</code> <code>layout</code> 都是服务端组件，服务端组件可以访问<code>node.js</code> API，包括处理数据库db。</p>
<p>src/app/server/page.tsx</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs'</span> <span class="hljs-comment">//引入fs模块</span>
<span class="hljs-keyword">import</span> mysql, { <span class="hljs-title class_">RowDataPacket</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'mysql2/promise'</span> <span class="hljs-comment">//操作数据库 仅供演示 非最佳实践</span>
<span class="hljs-keyword">const</span> pool = mysql.<span class="hljs-title function_">createPool</span>({
    <span class="hljs-attr">host</span>: <span class="hljs-string">'localhost'</span>,
    <span class="hljs-attr">user</span>: <span class="hljs-string">'root'</span>,
    <span class="hljs-attr">password</span>: <span class="hljs-string">'123456'</span>,
    <span class="hljs-attr">database</span>: <span class="hljs-string">'catering'</span>,
})

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ServerPage</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> [rows] = <span class="hljs-keyword">await</span> pool.<span class="hljs-property">query</span>&lt;<span class="hljs-title class_">RowDataPacket</span>[]&gt;(<span class="hljs-string">'SELECT * FROM goods'</span>)
    <span class="hljs-keyword">const</span> data = fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">'data.json'</span>, <span class="hljs-string">'utf-8'</span>)
    <span class="hljs-keyword">const</span> json = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(data)
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Server Page<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            {json.age}///{json.name}///{json.city}
            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
            {rows.map((item: any) =&gt; (
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span>&gt;</span>{item.name}-{item.goodsPrice}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            ))}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>data.json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"John"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"age"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">30</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"city"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"New York"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f097ff47c2d4f7f8be1dae013509597~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765285475&amp;x-signature=DEGpzB5upnv7oFFFLHrslmS1u7E%3D" alt="server.png" loading="lazy"/></p>
<p>因为是在服务端渲染的所以日志会出现在控制台，那为什么控制台也会出现，是因为<code>Next.js</code>在本地开发模式方便我们调试进行的输出，后续生产环境就看不到了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0db6aa23499f48b9a56849f256ecdea8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765285475&amp;x-signature=hdoJuK8fqXEECyTtIWqgwPb44sk%3D" alt="log.png" loading="lazy"/></p>
<h4 data-id="heading-4">服务端组件的优点</h4>
<ul>
<li>安全性: 我们在服务端组件中访问一些API秘钥，令牌等其他机密，不会暴露给客户端。</li>
<li>体积: 因为服务端组件在服务器渲染，所以不会被打包到客户端，所以体积更小。</li>
<li>全栈：可以在服务端组件访问数据库，文件系统等其他API，实现全栈开发。</li>
<li>FCP(首次内容绘制): 因为服务端组件是流式传输，所以边渲染边返回，提高了FCP(首次内容绘制)性能。</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f72515d00ef4630bb4060be0566fbf0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765285475&amp;x-signature=xD5vrfztsOQluVrbZ6ECbjSs28w%3D" alt="fcp.png" loading="lazy"/></p>
<h4 data-id="heading-5">服务端组件的缺点</h4>
<ul>
<li>交互性: 因为服务端组件在服务器渲染，所以无法访问浏览器API，所以无法进行交互。</li>
<li>hooks: <code>useEffect</code> <code>useState</code> 等hooks在服务端组件中无法使用。</li>
</ul>
<p>JavaScript: 是由三部分组成的(ECMAScript,DOM,BOM)，在服务端组件只能使用<code>ECMAScript</code>部分，无法访问<code>DOM</code>和<code>BOM</code>。</p>
<p>ECMAScript: 就是我们常用的对象，数组，es6+等这些东西是通用的在客户端和服务端都能用。</p>
<blockquote>
<p>如果要使用以下有交互性的功能，我们需要使用客户端组件。</p>
</blockquote>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { useEffect,useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ServerPage</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">document</span>,<span class="hljs-variable language_">window</span>)
    }, [])
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Server Page<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;点击<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<h2 data-id="heading-6">客户端组件(Client Components)</h2>
<p>声明客户端组件需要在文件的顶部编写 <code>'use client'</code> 声明这是客户端组件，但是注意客户端组件会在服务端进行一次<code>预渲染</code>，所以访问<code>document</code> <code>window</code> 等API需要在<code>useEffect</code>中访问。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-string">'use client'</span>
<span class="hljs-keyword">import</span> { useEffect,useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'client'</span>)
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">ServerPage</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'client X'</span>)
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">document</span>,<span class="hljs-variable language_">window</span>)
    }, [])
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Server Page<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;点击<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>所以我们可以看到他把<code>useState</code>的0预渲染了出来这样可以让用户先看到页面。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1409846d614481ba872306eb658b213~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765285475&amp;x-signature=MEc7kjsLADFsp%2BfHmc81ynWiivU%3D" alt="pre-render.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd7f7fc934dd4dd39c692e6876d9e2ef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765285475&amp;x-signature=mjz6PE429g9ajMX0bnBmYHn2izU%3D" alt="pre-render2.png" loading="lazy"/></p>
<h4 data-id="heading-7">组件嵌套</h4>
<blockquote>
<p>服务端组件可以嵌套客户端组件，客户端只能嵌套不能嵌套服务端组件</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ec8e052a2ef4921ab0dcc6d5bcf4ed3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765285475&amp;x-signature=Vo0WZkK5bifA%2Bd5bxRperz%2FAc9Q%3D" alt="error.png" loading="lazy"/></p>
<p>why:因为客户端会把他所有的模块以及子组件认为是客户端组件，那此时如果服务端组件用了<code>node.js</code>的API，或者其他服务端操作，那就会报错，因为客户端组件无法访问这些API，故此客户端组件不能嵌套服务端组件。</p>
<h4 data-id="heading-8">server-only</h4>
<p>随着Nodejs的发展，很多API已经可以跟浏览器共用了例如<code>fetch</code>,<code>webSocket</code>,未来Nodejs25支持<code>localStorage</code>等API,所以就会出现这种情况</p>
<p>下面这个函数可以在服务端组件使用，也可以在客户端组件使用，但有时候我们只想让他在服务端使用</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useTest</span>(<span class="hljs-params"><span class="hljs-keyword">type</span>:<span class="hljs-number">0</span> | <span class="hljs-number">1</span></span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> === <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.github.com'</span>)
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">'wss://api.github.com'</span>)
    }
}
</code></pre>
<pre><code class="hljs language-bash" lang="bash">npm install server-only
or
yarn add server-only
or
pnpm add server-only
</code></pre>
<p>安装完成这个包之后，只需要在文件的顶部编写 <code>import 'server-only'</code> 声明即可，这样他就会在服务端执行，在客户端执行会报错。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-string">'server-only'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useTest</span>(<span class="hljs-params"><span class="hljs-keyword">type</span>:<span class="hljs-number">0</span> | <span class="hljs-number">1</span></span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> === <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'https://api.github.com'</span>)
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebSocket</span>(<span class="hljs-string">'wss://api.github.com'</span>)
    }
}
</code></pre>
<p>客户端使用报错:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af8f17bb04774340bf18806bc25f402f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765285475&amp;x-signature=RZLeOQiqJi%2BmRMOx59zb9RvsCr4%3D" alt="error2.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>